--- a/LibreNMS/Alert/Transport/Discord.php
+++ b/LibreNMS/Alert/Transport/Discord.php
@@ -25,130 +25,73 @@
  * @contributer f0o, sdef2
  * Thanks to F0o <f0o@devilcode.org> for creating the Slack transport which is the majority of this code.
  * Thanks to sdef2 for figuring out the differences needed to make Discord work.
  */
 namespace LibreNMS\Alert\Transport;
 use LibreNMS\Alert\Transport;
 use LibreNMS\Exceptions\AlertTransportDeliveryException;
 use LibreNMS\Util\Http;
 class Discord extends Transport
 {
+    public const DEFAULT_EMBEDS = 'hostname,name,timestamp,severity';
     private array $embedFieldTranslations = [
         'name' => 'Rule Name',
     ];
-    private array $discord_message = [];
-    /**
-     * Composes a Discord JSON message and delivers it using HTTP POST
-     * https://discord.com/developers/docs/resources/message#create-message
-     *
-     * @param  array  $alert_data
-     * @return bool
-     */
     public function deliverAlert(array $alert_data): bool
     {
-        $this->discord_message = [
+        $added_fields = $this->parseUserOptions($this->config['options']);
+        $discord_title = '#' . $alert_data['uid'] . ' ' . $alert_data['title'];
+        $discord_msg = $alert_data['msg'];
+        $color = hexdec(preg_replace('/[^\dA-Fa-f]/', '', self::getColorForState($alert_data['state'])));
+        $footer_text = $alert_data['elapsed'] ? 'alert took ' . $alert_data['elapsed'] : '';
+        $data = [
             'embeds' => [
                 [
-                    'title' => $this->getTitle($alert_data),
-                    'color' => $this->getColorOfAlertState($alert_data),
-                    'description' => $this->getDescription($alert_data),
-                    'fields' => $this->getEmbedFields($alert_data),
+                    'title' => $discord_title,
+                    'color' => $color,
+                    'description' => $discord_msg,
+                    'fields' => $this->createDiscordFields($alert_data),
                     'footer' => [
-                        'text' => $this->getFooter($alert_data),
+                        'text' => $footer_text,
                     ],
                 ],
             ],
         ];
-        $this->includeINIFields();
-        $this->embedGraphs();
-        $this->stripHTMLTagsFromDescription();
-        $res = Http::client()->post($this->config['url'], $this->discord_message);
+        if (! empty($added_fields)) {
+            $data = array_merge($data, $added_fields);
+        }
+        $data = $this->embedGraphs($data);
+        $data['embeds'][0]['description'] = strip_tags($data['embeds'][0]['description']);
+        $res = Http::client()->post($this->config['url'], $data);
         if ($res->successful()) {
             return true;
         }
-        throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $alert_data['msg'], $this->discord_message);
+        throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $discord_msg, $data);
     }
-    private function getTitle(array $alert_data): string
+    private function embedGraphs(array $data): array
     {
-        return '#' . $alert_data['uid'] . ' ' . $alert_data['title'];
-    }
-    private function stripHTMLTagsFromDescription(): array
-    {
-        $this->discord_message['embeds'][0]['description'] = strip_tags($this->discord_message['embeds'][0]['description']);
-        return $this->discord_message;
-    }
-    private function getColorOfAlertState(array $alert_data): int
-    {
-        $hexColor = self::getColorForState($alert_data['state']);
-        $sanitized = preg_replace('/[^\dA-Fa-f]/', '', $hexColor);
-        return hexdec($sanitized);
-    }
-    private function getDescription(array $alert_data): string
-    {
-        return $alert_data['msg'];
-    }
-    private function getFooter(array $alert_data): string
-    {
-        return $alert_data['elapsed'] ? 'alert took ' . $alert_data['elapsed'] : '';
-    }
-    private function includeINIFields(): array
-    {
-        $ini_fileds = $this->parseUserOptions($this->config['options']);
-        if (! empty($ini_fileds)) {
-            $this->discord_message = array_merge($this->discord_message, $ini_fileds);
-        }
-        return $this->discord_message;
-    }
-    /**
-     * Convert an html <img src=""> tag to a json Discord message Embed Image Structure
-     * https://discord.com/developers/docs/resources/message#embed-object-embed-image-structure
-     *
-     * @return array
-     */
-    private function embedGraphs(): array
-    {
-        $regex = '#<img class="librenms-graph" src="(.*?)"\s*/>#';
         $count = 1;
-        $this->discord_message['embeds'][0]['description'] = preg_replace_callback($regex, function ($match) use (&$count) {
-            $this->discord_message['embeds'][] = [
+        $data['embeds'][0]['description'] = preg_replace_callback('#<img class="librenms-graph" src="(.*?)" />#', function ($match) use (&$data, &$count) {
+            $data['embeds'][] = [
                 'image' => [
                     'url' => $match[1],
                 ],
             ];
             return '[Image ' . ($count++) . ']';
-        }, $this->discord_message['embeds'][0]['description']);
-        return $this->discord_message;
+        }, $data['embeds'][0]['description']);
+        return $data;
     }
-    /**
-     * Converts comma-separated values into an array of name-value pairs.
-     * https://discord.com/developers/docs/resources/message#embed-object-embed-field-structure
-     *
-     * * @param  array  $alert_data  Array containing the values.
-     * @return array An array of name-value pairs.
-     *
-     * @example
-     * Example with 'hostname,sysDescr' as fields:
-     * $result will be:
-     * [
-     *     ['name' => 'Hostname', 'value' => 'server1'],
-     *     ['name' => 'SysDescr', 'value' => 'Linux server description'],
-     * ]
-     */
-    public function getEmbedFields(array $alert_data): array
+    public function createDiscordFields(array $alert_data): array
     {
         $result = [];
-        if (empty($this->config['discord-embed-fields'])) {
-            return $result;
-        }
-        $fields = explode(',', $this->config['discord-embed-fields']);
+        $fields = explode(',', $this->config['discord-embed-fields'] ?? self::DEFAULT_EMBEDS);
         foreach ($fields as $field) {
-            $field = trim($field);
             $result[] = [
                 'name' => $this->embedFieldTranslations[$field] ?? ucfirst($field),
                 'value' => $alert_data[$field] ?? 'Error: Invalid Field',
             ];
         }
         return $result;
     }
     public static function configTemplate(): array
     {
         return [
@@ -161,20 +104,21 @@
                 ],
                 [
                     'title' => 'Options',
                     'name' => 'options',
                     'descr' => 'Enter the config options (format: option=value separated by new lines)',
                     'type' => 'textarea',
                 ],
                 [
                     'title' => 'Fields to embed in the alert',
                     'name' => 'discord-embed-fields',
-                    'descr' => 'Comma seperated list from the alert to embed i.e. hostname,name,timestamp,severity',
+                    'descr' => 'Comma seperated list of fields from the alert to attach to the Discord message',
                     'type' => 'text',
+                    'default' => self::DEFAULT_EMBEDS,
                 ],
             ],
             'validation' => [
                 'url' => 'required|url',
             ],
         ];
     }
 }

--- a/LibreNMS/Alert/Transport/Gotify.php
+++ b//dev/null
@@ -1,128 +0,0 @@
-<?php
-/**
- * LibreNMS Gotify alerting transport
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program. If not, see <https://www.gnu.org/licenses/>.
- *
- * @link        https://www.librenms.org
- *
- * @author      netravnen (https://github.com/netravnen/)
- * @copyright   2024 netravnen
- * @license     GPL
- */
-namespace LibreNMS\Alert\Transport;
-use LibreNMS\Alert\Transport;
-use LibreNMS\Exceptions\AlertTransportDeliveryException;
-use LibreNMS\Util\Http;
-class Gotify extends Transport
-{
-    public function deliverAlert(array $alert_data): bool
-    {
-        $url = "{$this->config['gotify-server-url']}/message";
-        $token = "{$this->config['gotify-token']}";
-        /**
-         * Maps severity levels in LibreNMS to Gotify values.
-         *
-         * 0-3 Notifiction  = OK
-         * 4-7 + Sound      = Warning
-         * 8-10 + Vibration = Critical
-         */
-        switch ($alert_data['severity']) {
-            case 'critical':
-                $priority = 8;
-                break;
-            case 'warning':
-                $priority = 4;
-                break;
-            default:
-                $priority = 0;
-        }
-        $data = [
-            'title' => $alert_data['title'],
-            'message' => preg_replace('/([a-z0-9]+)_([a-z0-9]+)/', "$1\_$2", $alert_data['msg']),
-            'priority' => $priority,
-            'extras' => [
-                'client::display' => [
-                    'contentType' => 'text/markdown',
-                ],
-                'monitoring::librenms' => [
-                    'device_id' => $alert_data['device_id'],
-                    'hostname' => $alert_data['hostname'],
-                    'sysName' => $alert_data['sysName'],
-                    'sysDescr' => $alert_data['sysDescr'],
-                    'display' => $alert_data['display'],
-                    'sysContact' => $alert_data['sysContact'],
-                    'os' => $alert_data['os'],
-                    'type' => $alert_data['type'],
-                    'ip' => $alert_data['ip'],
-                    'version' => $alert_data['version'],
-                    'hardware' => $alert_data['hardware'],
-                    'features' => $alert_data['features'],
-                    'serial' => $alert_data['serial'],
-                    'location' => $alert_data['location'],
-                    'uptime' => $alert_data['uptime'],
-                    'uptime_short' => $alert_data['uptime_short'],
-                    'uptime_long' => $alert_data['uptime_long'],
-                    'description' => $alert_data['description'],
-                    'notes' => $alert_data['notes'],
-                    'alert_notes' => $alert_data['alert_notes'],
-                    'id' => $alert_data['id'],
-                    'uid' => $alert_data['uid'],
-                    'state' => $alert_data['state'],
-                    'severity' => $alert_data['severity'],
-                    'rule' => $alert_data['rule'],
-                    'name' => $alert_data['name'],
-                    'proc' => $alert_data['proc'],
-                    'timestamp' => $alert_data['timestamp'],
-                ],
-            ],
-        ];
-        $res = Http::client()
-            ->withHeaders(
-                [
-                    'X-Gotify-Key' => $token,
-                    'Content-Type' => 'application/json',
-                ]
-            )
-            ->acceptJson()
-            ->post($url, $data);
-        if ($res->successful()) {
-            return true;
-        }
-        throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $alert_data['msg'], $data);
-    }
-    public static function configTemplate(): array
-    {
-        return [
-            'config' => [
-                [
-                    'title' => 'Server (URL)',
-                    'name' => 'gotify-server-url',
-                    'descr' => 'Gotify Server Address',
-                    'type' => 'text',
-                ],
-                [
-                    'title' => 'Token',
-                    'name' => 'gotify-token',
-                    'descr' => 'Gotify Token',
-                    'type' => 'password',
-                ],
-            ],
-            'validation' => [
-                'gotify-server-url' => 'required|string',
-                'gotify-token' => 'required|string',
-            ],
-        ];
-    }
-}

--- a/LibreNMS/Alert/Transport/Ibmocm.php
+++ b//dev/null
@@ -1,54 +0,0 @@
-<?php
-/* Copyright (C) 2024 Jayna Rogers <rokinchikie@gmail.com>
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
-/**
- * IBM On Call Manager API Transport
- *
- * @author Jayna Rogers <rokinchikie@gmail.com>
- * @copyright Jayna Rogers 2024, LibreNMS
- * @license GPL
- */
-namespace LibreNMS\Alert\Transport;
-use LibreNMS\Alert\Transport;
-use LibreNMS\Exceptions\AlertTransportDeliveryException;
-use LibreNMS\Util\Http;
-class Ibmocm extends Transport
-{
-    protected string $name = 'IBM On Call Manager';
-    public function deliverAlert(array $alert_data): bool
-    {
-        $url = $this->config['ocm-url'];
-        $res = Http::client()->post($url, $alert_data);
-        if ($res->successful()) {
-            return true;
-        }
-        throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), '', $alert_data);
-    }
-    public static function configTemplate(): array
-    {
-        return [
-            'config' => [
-                [
-                    'title' => 'Webhook URL',
-                    'name' => 'ocm-url',
-                    'descr' => 'IBM On Call Manager Webhook URL',
-                    'type' => 'text',
-                ],
-            ],
-            'validation' => [
-                'ocm-url' => 'required|url',
-            ],
-        ];
-    }
-}

--- a/LibreNMS/Alert/Transport/Mail.php
+++ b/LibreNMS/Alert/Transport/Mail.php
@@ -13,46 +13,40 @@
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 /**
  * Mail Transport
  *
  * @author f0o <f0o@devilcode.org>
  * @copyright 2014 f0o, LibreNMS
  * @license GPL
  */
 namespace LibreNMS\Alert\Transport;
-use Exception;
 use LibreNMS\Alert\AlertUtil;
 use LibreNMS\Alert\Transport;
 use LibreNMS\Config;
-use LibreNMS\Exceptions\AlertTransportDeliveryException;
 class Mail extends Transport
 {
     public function deliverAlert(array $alert_data): bool
     {
         $emails = match ($this->config['mail-contact'] ?? '') {
             'sysContact' => AlertUtil::findContactsSysContact($alert_data['faults']),
             'owners' => AlertUtil::findContactsOwners($alert_data['faults']),
             'role' => AlertUtil::findContactsRoles([$this->config['role']]),
             default => $this->config['email'],
         };
         $html = Config::get('email_html');
         if ($html && ! $this->isHtmlContent($alert_data['msg'])) {
             $msg = preg_replace("/\r?\n/", "<br />\n", $alert_data['msg']);
         } else {
             $msg = preg_replace("/(?<!\r)\n/", "\r\n", $alert_data['msg']);
         }
-        try {
-            return \LibreNMS\Util\Mail::send($emails, $alert_data['title'], $msg, $html, $this->config['bcc'] ?? false, $this->config['attach-graph'] ?? null);
-        } catch (Exception $e) {
-            throw new AlertTransportDeliveryException($alert_data, 0, $e->getMessage());
-        }
+        return \LibreNMS\Util\Mail::send($emails, $alert_data['title'], $msg, $html, $this->config['bcc'] ?? false, $this->config['attach-graph'] ?? null);
     }
     public static function configTemplate(): array
     {
         $roles = array_merge(['None' => ''], \Bouncer::role()->pluck('name', 'title')->all());
         return [
             'config' => [
                 [
                     'title' => 'Contact Type',
                     'name' => 'mail-contact',
                     'descr' => 'Method for selecting contacts',

--- a/LibreNMS/Alert/Transport/Msteams.php
+++ b/LibreNMS/Alert/Transport/Msteams.php
@@ -20,21 +20,21 @@
     {
         $data = [
             'title' => $alert_data['title'],
             'themeColor' => self::getColorForState($alert_data['state']),
             'text' => strip_tags($alert_data['msg'], '<strong><em><h1><h2><h3><strike><ul><ol><li><pre><blockquote><a><img><p>'),
             'summary' => $alert_data['title'],
         ];
         $client = Http::client();
         if ($this->config['use-json'] === 'on') {
             $msg = $alert_data['uid'] === '000'
-                ? $this->testJsonMessage() // use pre-made JSON for tests
+                ? $this->messageCard() // use pre-made MessageCard for tests
                 : $alert_data['msg'];
             $client->withBody($msg, 'application/json');
         }
         $res = $client->post($this->config['msteam-url'], $data);
         if ($res->successful()) {
             return true;
         }
         throw new AlertTransportDeliveryException($alert_data, $res->status(), $res->body(), $data['text'], $data);
     }
     public static function configTemplate(): array
@@ -53,47 +53,54 @@
                     'descr' => 'Compose MessageCard with JSON rather than Markdown. Your template must be valid MessageCard JSON',
                     'type' => 'checkbox',
                     'default' => false,
                 ],
             ],
             'validation' => [
                 'msteam-url' => 'required|url',
             ],
         ];
     }
-    private function testJsonMessage(): string
+    private function messageCard(): string
     {
         return '{
-    "type": "message",
-    "attachments": [
+    "@context": "https://schema.org/extensions",
+    "@type": "MessageCard",
+    "potentialAction": [
         {
-            "contentType": "application/vnd.microsoft.card.adaptive",
-            "contentUrl": null,
-            "content": {
-                "type": "AdaptiveCard",
-                "body": [
-                    {
-                        "type": "TextBlock",
-                        "size": "Medium",
-                        "weight": "Bolder",
-                        "text": "LibreNMS Test Adaptive Card"
-                    },
-                    {
-                        "type": "TextBlock",
-                        "text": "You have successfully sent a pre-formatted AdaptiveCard message to Teams.",
-                        "wrap": true
-                    },
-                    {
-                        "type": "TextBlock",
-                        "text": "This does not test if your alert template is valid AdaptiveCard JSON.",
-                        "isSubtle": true,
-                        "wrap": true
-                    }
-                ],
-                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
-                "version": "1.4"
-            }
+            "@type": "OpenUri",
+            "name": "View MessageCard Reference",
+            "targets": [
+                {
+                    "os": "default",
+                    "uri": "https://learn.microsoft.com/en-us/outlook/actionable-messages/message-card-reference"
+                }
+            ]
+        },
+        {
+            "@type": "OpenUri",
+            "name": "View LibreNMS Website",
+            "targets": [
+                {
+                    "os": "default",
+                    "uri": "https://www.librenms.org/"
+                }
+            ]
         }
-    ]
+    ],
+    "sections": [
+        {
+            "facts": [
+                {
+                    "name": "Next Action:",
+                    "value": "Make your alert template emit valid MessageCard Json"
+                }
+            ],
+            "text": "You have successfully sent a pre-formatted MessageCard message to teams."
+        }
+    ],
+    "summary": "Test Successful",
+    "themeColor": "0072C6",
+    "title": "Test MessageCard"
 }';
     }
 }

--- a/LibreNMS/DB/Schema.php
+++ b/LibreNMS/DB/Schema.php
@@ -263,21 +263,21 @@
      * Each entry in the Indexes array contains these keys: Name, Columns(array), Unique
      *
      * @param  string  $connection  use a specific connection
      * @return array
      */
     public static function dump($connection = null)
     {
         $output = [];
         $db_name = DB::connection($connection)->getDatabaseName();
         DB::statement("SET TIME_ZONE='+00:00'"); // set timezone to UTC to avoid timezone issues
-        foreach (DB::connection($connection)->select(DB::raw("SELECT TABLE_NAME FROM information_schema.TABLES WHERE TABLE_SCHEMA = '$db_name' AND TABLE_TYPE = 'BASE TABLE' ORDER BY TABLE_NAME;")->getValue(DB::connection($connection)->getQueryGrammar())) as $table) {
+        foreach (DB::connection($connection)->select(DB::raw("SELECT TABLE_NAME FROM information_schema.TABLES WHERE TABLE_SCHEMA = '$db_name' ORDER BY TABLE_NAME;")->getValue(DB::connection($connection)->getQueryGrammar())) as $table) {
             $table = $table->TABLE_NAME;
             foreach (DB::connection($connection)->select(DB::raw("SELECT COLUMN_NAME, COLUMN_TYPE, IS_NULLABLE, COLUMN_DEFAULT, EXTRA FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = '$db_name' AND TABLE_NAME='$table' ORDER BY ORDINAL_POSITION")->getValue(DB::connection($connection)->getQueryGrammar())) as $data) {
                 $def = [
                     'Field' => $data->COLUMN_NAME,
                     'Type' => preg_replace('/int\([0-9]+\)/', 'int', $data->COLUMN_TYPE),
                     'Null' => $data->IS_NULLABLE === 'YES',
                     'Extra' => str_replace('current_timestamp()', 'CURRENT_TIMESTAMP', $data->EXTRA),
                 ];
                 if (isset($data->COLUMN_DEFAULT) && $data->COLUMN_DEFAULT != 'NULL') {
                     $default = trim($data->COLUMN_DEFAULT, "'");

--- a/LibreNMS/Data/Store/Rrd.php
+++ b/LibreNMS/Data/Store/Rrd.php
@@ -17,21 +17,20 @@
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Data\Store;
 use App\Polling\Measure\Measurement;
-use Illuminate\Support\Str;
 use LibreNMS\Config;
 use LibreNMS\Enum\ImageFormat;
 use LibreNMS\Exceptions\FileExistsException;
 use LibreNMS\Exceptions\RrdGraphException;
 use LibreNMS\Proc;
 use LibreNMS\Util\Debug;
 use LibreNMS\Util\Rewrite;
 use Log;
 use Symfony\Component\Process\Process;
 class Rrd extends BaseDatastore
@@ -90,33 +89,28 @@
      */
     public function init($dual_process = true): bool
     {
         $command = $this->rrdtool_executable . ' -';
         $descriptor_spec = [
             0 => ['pipe', 'r'], // stdin  is a pipe that the child will read from
             1 => ['pipe', 'w'], // stdout is a pipe that the child will write to
             2 => ['pipe', 'w'], // stderr is a pipe that the child will write to
         ];
         $cwd = $this->rrd_dir;
-        try {
-            if (! $this->isSyncRunning()) {
-                $this->sync_process = new Proc($command, $descriptor_spec, $cwd);
-            }
-            if ($dual_process && ! $this->isAsyncRunning()) {
-                $this->async_process = new Proc($command, $descriptor_spec, $cwd);
-                $this->async_process->setSynchronous(false);
-            }
-            return $this->isSyncRunning() && ($dual_process ? $this->isAsyncRunning() : true);
-        } catch (\Exception $e) {
-            Log::error('Failed to start RRD datastore: ' . $e->getMessage());
-            return false;
-        }
+        if (! $this->isSyncRunning()) {
+            $this->sync_process = new Proc($command, $descriptor_spec, $cwd);
+        }
+        if ($dual_process && ! $this->isAsyncRunning()) {
+            $this->async_process = new Proc($command, $descriptor_spec, $cwd);
+            $this->async_process->setSynchronous(false);
+        }
+        return $this->isSyncRunning() && ($dual_process ? $this->isAsyncRunning() : true);
     }
     public function isSyncRunning()
     {
         return isset($this->sync_process) && $this->sync_process->isRunning();
     }
     public function isAsyncRunning()
     {
         return isset($this->async_process) && $this->async_process->isRunning();
     }
     /**
@@ -319,22 +313,22 @@
         return implode('/', [$this->dirFromHost($host), $filename . $extension]);
     }
     /**
      * Generates a path based on the hostname (or IP)
      *
      * @param  string  $host  Host name
      * @return string the name of the rrd directory for $host
      */
     public function dirFromHost($host)
     {
-        $host = self::safeName(trim($host, '[]'));
-        return Str::finish($this->rrd_dir, '/') . $host;
+        $host = str_replace(':', '_', trim($host, '[]'));
+        return implode('/', [$this->rrd_dir, $host]);
     }
     /**
      * Generates and pipes a command to rrdtool
      *
      * @internal
      *
      * @param  string  $command  create, update, updatev, graph, graphv, dump, restore, fetch, tune, first, last, lastupdate, info, resize, xport, flushcached
      * @param  string  $filename  The full patth to the rrd file
      * @param  string  $options  rrdtool command options
      * @return array the output of stdout and stderr in an array

--- a/LibreNMS/IRCBot.php
+++ b/LibreNMS/IRCBot.php
@@ -530,25 +530,24 @@
             }
         } else {
             $user = User::firstWhere('username', $params[0]);
             if ($user->email && $user->username == $params[0]) {
                 $token = hash('gost', openssl_random_pseudo_bytes(1024));
                 $this->tokens[$this->getUser($this->data)] = $token;
                 $this->user['user'] = $user;
                 if ($this->debug) {
                     $this->log("Auth for '" . $params[0] . "', ID: '" . $user->user_id . "', Token: '" . $token . "', Mail: '" . $user->email . "'");
                 }
-                try {
-                    Mail::send($user->email, 'LibreNMS IRC-Bot Authtoken', "Your Authtoken for the IRC-Bot:\r\n\r\n" . $token . "\r\n\r\n");
+                if (Mail::send($user->email, 'LibreNMS IRC-Bot Authtoken', "Your Authtoken for the IRC-Bot:\r\n\r\n" . $token . "\r\n\r\n", false) === true) {
                     return $this->respond('Token sent!');
-                } catch (\Exception $e) {
-                    return $this->respond('Sorry, seems like mail doesnt like us. ' . $e->getMessage());
+                } else {
+                    return $this->respond('Sorry, seems like mail doesnt like us.');
                 }
             } else {
                 return $this->respond('Who are you again?');
             }
         }//end if
     }
     private function _reload($params)
     {
         if ($this->user['user']->can('irc.reload')) {
             if ($params == 'external') {

--- a/LibreNMS/OS/Ocnos.php
+++ b/LibreNMS/OS/Ocnos.php
@@ -2,21 +2,21 @@
 namespace LibreNMS\OS;
 use App\Models\EntPhysical;
 use App\Models\Transceiver;
 use Illuminate\Support\Collection;
 use LibreNMS\Interfaces\Discovery\EntityPhysicalDiscovery;
 use LibreNMS\Interfaces\Discovery\TransceiverDiscovery;
 use LibreNMS\OS;
 use SnmpQuery;
 class Ocnos extends OS implements EntityPhysicalDiscovery, TransceiverDiscovery
 {
-    private ?bool $portBreakoutEnabled = null;
+    private bool $sfpSeen = false;
     private ?Collection $ifNamePortIdMap = null;
     public function discoverEntityPhysical(): Collection
     {
         $inventory = new Collection;
         $stacks = SnmpQuery::walk('IPI-CMM-CHASSIS-MIB::cmmStackUnitTable')->table(1);
         SnmpQuery::walk('IPI-CMM-CHASSIS-MIB::cmmSysSwModuleTable')->table(1, $stacks); // software version
         foreach ($stacks as $cmmStackUnitIndex => $stack) {
             $inventory->push(new EntPhysical([
                 'entPhysicalIndex' => $cmmStackUnitIndex,
                 'entPhysicalDescr' => $this->describeChassis($stack),
@@ -140,22 +140,25 @@
         }
         return $description;
     }
     public function guessIfName($cmmTransIndex, $cmmTransType): ?string
     {
         $prefix = match ($cmmTransType) {
             'sfp' => 'xe',
             'qsfp' => 'ce',
             default => 'ge',
         };
+        if ($cmmTransType == 'sfp') {
+            $this->sfpSeen = true;
+        }
         return match ($this->getDevice()->hardware) {
-            'Ufi Space S9600-32X-R' => $prefix . ($this->portBreakoutEnabled() ? ($cmmTransType == 'qsfp' ? $cmmTransIndex - 5 : $cmmTransIndex - 2) : $cmmTransIndex - 1),
+            'Ufi Space S9600-32X-R' => $prefix . ($this->sfpSeen ? ($cmmTransType == 'qsfp' ? $cmmTransIndex - 5 : $cmmTransIndex - 2) : $cmmTransIndex - 1),
             'Ufi Space S9510-28DC-B' => $prefix . ($cmmTransIndex - 1),
             'Ufi Space S9500-30XS-P' => $prefix . ($cmmTransType == 'qsfp' ? $cmmTransIndex - 29 : $cmmTransIndex - 1),
             'Edgecore 7316-26XB-O-48V-F' => $prefix . ($cmmTransType == 'qsfp' ? $cmmTransIndex - 1 : $cmmTransIndex - 3),
             'Edgecore 5912-54X-O-AC-F' => $prefix . $cmmTransIndex,
             'Edgecore 7712-32X-O-AC-F' => $prefix . $cmmTransIndex . '/1',
             default => null, // no port map, so we can't guess
         };
     }
     public function discoverTransceivers(): Collection
     {
@@ -218,20 +221,11 @@
                 'ddm' => isset($data['IPI-CMM-CHASSIS-MIB::cmmTransDDMSupport']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransDDMSupport'] == 'yes',
                 'encoding' => $data['IPI-CMM-CHASSIS-MIB::cmmTransEncoding'] ?? 'missing',
                 'distance' => $distance,
                 'wavelength' => isset($data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength']) && $data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength'] !== '-100002' ? $data['IPI-CMM-CHASSIS-MIB::cmmTransWavelength'] : null,
                 'connector' => $connector,
                 'channels' => $data['IPI-CMM-CHASSIS-MIB::cmmTransNoOfChannels'] ?? 0,
                 'entity_physical_index' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
             ]);
         });
     }
-    private function portBreakoutEnabled(): bool
-    {
-        if ($this->portBreakoutEnabled === null) {
-            $this->portBreakoutEnabled = $this->getDevice()->ports()->exists()
-                ? $this->getDevice()->ports()->where('ifName', 'LIKE', 'xe%')->exists() // ports module has run
-                : str_contains(SnmpQuery::cache()->walk('IF-MIB::ifName')->raw, 'xe'); // no ports in db
-        }
-        return $this->portBreakoutEnabled;
-    }
 }

--- a/LibreNMS/OS/Windows.php
+++ b/LibreNMS/OS/Windows.php
@@ -54,21 +54,20 @@
             'x86' => 'Generic x86',
             'ia64' => 'Intel Itanium IA64',
         ];
         return $generic[$matches['generic']] ?? null;
     }
     private function getClientVersion($build, $version)
     {
         $default = $build > 10000 ? '10 (NT 6.3)' : null;
         $default = $build > 22000 ? '11 Insider (NT 6.3)' : null;
         $builds = [
-            '26100' => '11 (24H2)',
             '22631' => '11 (23H2)',
             '22621' => '11 (22H2)',
             '22000' => '11 (21H2)',
             '19045' => '10 (22H2)',
             '19044' => '10 (21H2)',
             '19043' => '10 (21H1)',
             '19042' => '10 (20H2)',
             '19041' => '10 (2004)',
             '18363' => '10 (1909)',
             '18362' => '10 (1903)',

--- a/LibreNMS/Util/DynamicConfigItem.php
+++ b/LibreNMS/Util/DynamicConfigItem.php
@@ -83,25 +83,23 @@
                 if (! is_array($v)) {
                     return false;
                 }
             }
             return true;
         } elseif ($this->type == 'color') {
             return (bool) preg_match('/^#?[0-9a-fA-F]{6}([0-9a-fA-F]{2})?$/', $value);
         } elseif (in_array($this->type, ['text', 'password'])) {
             return ! is_array($value);
         } elseif ($this->type === 'executable') {
-            $value == $this->sanitizePath($value);
-            return $value !== false && is_file($value) && is_executable($value);
+            return is_file($value) && is_executable($value);
         } elseif ($this->type === 'directory') {
-            $value == $this->sanitizePath($value);
-            return $value !== false && is_dir($value);
+            return is_dir($value);
         }
         return false;
     }
     public function getGroup()
     {
         return $this->group;
     }
     public function getSection()
     {
         return $this->section;
@@ -214,18 +212,11 @@
         return "settings.settings.$this->name.help";
     }
     private function optionTranslationKey($option)
     {
         return "settings.settings.$this->name.options.$option";
     }
     private function buildValidator($value)
     {
         return Validator::make(['value' => $value], $this->validate);
     }
-    private function sanitizePath(string $path): string|false
-    {
-        if (preg_match('/[`;#$|&\'"><(]/', $path)) {
-            return false;
-        }
-        return realpath($path); // avoid path redirection shenanigans
-    }
 }

--- a/LibreNMS/Util/Mail.php
+++ b/LibreNMS/Util/Mail.php
@@ -16,20 +16,21 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  *
  * @package    LibreNMS
  * @link       http://librenms.org
  * @copyright  2021 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace LibreNMS\Util;
+use Exception;
 use LibreNMS\Config;
 use LibreNMS\Exceptions\RrdGraphException;
 use PHPMailer\PHPMailer\PHPMailer;
 class Mail
 {
     /**
      * Parse string with emails. Return array with email (as key) and name (as value)
      *
      * @param  string  $emails
      * @return array|false
@@ -54,74 +55,76 @@
         }
         return false;
     }
     /**
      * Send email with PHPMailer
      *
      * @param  string  $emails
      * @param  string  $subject
      * @param  string  $message
      * @param  bool  $html
-     * @param  bool  $bcc
-     * @param  bool|null  $embedGraphs
-     * @return bool
-     *
-     * @throws \PHPMailer\PHPMailer\Exception if delivery fails
+     * @return bool|string
      */
-    public static function send($emails, $subject, $message, bool $html = false, bool $bcc = false, ?bool $embedGraphs = null): bool
+    public static function send($emails, $subject, $message, bool $html = false, bool $bcc = false, ?bool $embedGraphs = null)
     {
         if (is_array($emails) || ($emails = self::parseEmails($emails))) {
             d_echo("Attempting to email $subject to: " . implode('; ', array_keys($emails)) . PHP_EOL);
             $mail = new PHPMailer(true);
-            $mail->Hostname = php_uname('n');
-            foreach (self::parseEmails(Config::get('email_from')) as $from => $from_name) {
-                $mail->setFrom($from, $from_name);
+            try {
+                $mail->Hostname = php_uname('n');
+                foreach (self::parseEmails(Config::get('email_from')) as $from => $from_name) {
+                    $mail->setFrom($from, $from_name);
+                }
+                $addMethod = $bcc ? 'addBcc' : 'addAddress';
+                foreach ($emails as $email => $email_name) {
+                    $mail->$addMethod($email, $email_name);
+                }
+                $mail->Subject = $subject;
+                $mail->XMailer = Config::get('project_name');
+                $mail->CharSet = 'utf-8';
+                $mail->WordWrap = 76;
+                $mail->Body = $message;
+                if ($embedGraphs ?? Config::get('email_attach_graphs')) {
+                    self::embedGraphs($mail, $html);
+                }
+                if ($html) {
+                    $mail->isHTML();
+                }
+                switch (strtolower(trim(Config::get('email_backend')))) {
+                    case 'sendmail':
+                        $mail->Mailer = 'sendmail';
+                        $mail->Sendmail = Config::get('email_sendmail_path');
+                        break;
+                    case 'smtp':
+                        $mail->isSMTP();
+                        $mail->Host = Config::get('email_smtp_host');
+                        $mail->Timeout = Config::get('email_smtp_timeout');
+                        $mail->SMTPAuth = Config::get('email_smtp_auth');
+                        $mail->SMTPSecure = Config::get('email_smtp_secure');
+                        $mail->Port = Config::get('email_smtp_port');
+                        $mail->Username = Config::get('email_smtp_username');
+                        $mail->Password = Config::get('email_smtp_password');
+                        $mail->SMTPAutoTLS = Config::get('email_auto_tls');
+                        $mail->SMTPDebug = 0;
+                        break;
+                    default:
+                        $mail->Mailer = 'mail';
+                        break;
+                }
+                return $mail->send();
+            } catch (\PHPMailer\PHPMailer\Exception $e) {
+                return $e->errorMessage();
+            } catch (Exception $e) {
+                return $e->getMessage();
             }
-            $addMethod = $bcc ? 'addBcc' : 'addAddress';
-            foreach ($emails as $email => $email_name) {
-                $mail->$addMethod($email, $email_name);
-            }
-            $mail->Subject = $subject;
-            $mail->XMailer = Config::get('project_name');
-            $mail->CharSet = 'utf-8';
-            $mail->WordWrap = 76;
-            $mail->Body = $message;
-            if ($embedGraphs ?? Config::get('email_attach_graphs')) {
-                self::embedGraphs($mail, $html);
-            }
-            if ($html) {
-                $mail->isHTML();
-            }
-            switch (strtolower(trim(Config::get('email_backend')))) {
-                case 'sendmail':
-                    $mail->Mailer = 'sendmail';
-                    $mail->Sendmail = Config::get('email_sendmail_path');
-                    break;
-                case 'smtp':
-                    $mail->isSMTP();
-                    $mail->Host = Config::get('email_smtp_host');
-                    $mail->Timeout = Config::get('email_smtp_timeout');
-                    $mail->SMTPAuth = Config::get('email_smtp_auth');
-                    $mail->SMTPSecure = Config::get('email_smtp_secure');
-                    $mail->Port = Config::get('email_smtp_port');
-                    $mail->Username = Config::get('email_smtp_username');
-                    $mail->Password = Config::get('email_smtp_password');
-                    $mail->SMTPAutoTLS = Config::get('email_auto_tls');
-                    $mail->SMTPDebug = 0;
-                    break;
-                default:
-                    $mail->Mailer = 'mail';
-                    break;
-            }
-            return $mail->send();
         }
-        throw new \PHPMailer\PHPMailer\Exception('No contacts found');
+        return 'No contacts found';
     }
     /**
      * Search for generated graph links, generate them, attach them to the email and update the url to a cid link
      */
     private static function embedGraphs(PHPMailer $mail, bool $html = false): void
     {
         $body = $mail->Body;
         preg_match_all('#<img class=\"librenms-graph\" src=\"(.*?)\" ?/?>#', $body, $matches);
         $count = 0;
         foreach (array_combine($matches[1], $matches[0]) as $url => $tag) {

--- a/LibreNMS/Util/Snmpsim.php
+++ b/LibreNMS/Util/Snmpsim.php
@@ -57,21 +57,21 @@
     }
     public function isVenvSetUp(): bool
     {
         return is_executable($this->getVenvPath('bin/snmpsim-command-responder-lite'));
     }
     public function setupVenv($print_output = false): void
     {
         $snmpsim_venv_path = $this->getVenvPath();
         if (! $this->isVenvSetUp()) {
             Log::info('Setting up snmpsim virtual env in ' . $snmpsim_venv_path);
-            $setupProcess = new Process(['/usr/bin/env', 'python3', '-m', 'venv', $snmpsim_venv_path]);
+            $setupProcess = new Process(['python', '-m', 'venv', $snmpsim_venv_path]);
             $setupProcess->setTty($print_output);
             $setupProcess->run();
             if (! $setupProcess->isSuccessful()) {
                 Log::info($setupProcess->getOutput());
                 Log::error($setupProcess->getErrorOutput());
             }
             $installProcess = new Process([$snmpsim_venv_path . '/bin/pip', 'install', 'snmpsim']);
             $installProcess->setTty($print_output);
             $installProcess->run();
             if (! $installProcess->isSuccessful()) {

--- a/LibreNMS/Util/StringHelpers.php
+++ b/LibreNMS/Util/StringHelpers.php
@@ -46,21 +46,20 @@
             'cape' => 'CAPEv2',
             'dbm' => 'dBm',
             'dhcp-stats' => 'DHCP Stats',
             'entropy' => 'Random entropy',
             'exim-stats' => 'EXIM Stats',
             'fbsd-nfs-client' => 'FreeBSD NFS Client',
             'fbsd-nfs-server' => 'FreeBSD NFS Server',
             'freeradius' => 'FreeRADIUS',
             'gpsd' => 'GPSD',
             'hv-monitor' => 'HV Monitor',
-            'http_access_log_combined' => 'HTTP Access Log Combined',
             'mojo_cape_submit' => 'Mojo CAPE Submit',
             'mailcow-postfix' => 'mailcow-dockerized postfix',
             'mysql' => 'MySQL',
             'nfs' => 'NFS',
             'nfs-server' => 'NFS Server',
             'nfs-stats' => 'NFS Stats',
             'nfs-v3-stats' => 'NFS v3 Stats',
             'ntp' => 'NTP',
             'ntp-client' => 'NTP Client',
             'ntp-server' => 'NTP Server',

--- a/LibreNMS/Util/Url.php
+++ b/LibreNMS/Util/Url.php
@@ -41,59 +41,59 @@
      * @param  array  $vars
      * @param  int  $start
      * @param  int  $end
      * @param  int  $escape_text
      * @param  int  $overlib
      * @return string
      */
     public static function deviceLink($device, $text = '', $vars = [], $start = 0, $end = 0, $escape_text = 1, $overlib = 1)
     {
         if (! $device instanceof Device || ! $device->hostname) {
-            return $escape_text ? htmlentities($text) : (string) $text;
+            return (string) $text;
         }
         if (! $device->canAccess(Auth::user())) {
-            return $escape_text ? htmlentities($device->displayName()) : $device->displayName();
+            return $device->displayName();
         }
         if (! $start) {
             $start = Carbon::now()->subDay()->timestamp;
         }
         if (! $end) {
             $end = Carbon::now()->timestamp;
         }
         if (! $text) {
             $text = $device->displayName();
         }
         if ($escape_text) {
             $text = htmlentities($text);
         }
         $class = self::deviceLinkDisplayClass($device);
         $graphs = Graph::getOverviewGraphsForDevice($device);
         $url = Url::deviceUrl($device, $vars);
-        $contents = '<div><span class="list-large">' . htmlentities(strip_tags($device->displayName())) . '</span>';
+        $contents = '<div><span class="list-large">' . $device->displayName() . '</span>';
         $devinfo = '';
         if ($device->hardware) {
-            $devinfo .= $device->hardware;
+            $devinfo .= htmlentities($device->hardware);
         }
         if ($device->os) {
-            $devinfo .= ($devinfo ? ' - ' : '') . Config::getOsSetting($device->os, 'text');
+            $devinfo .= ($devinfo ? ' - ' : '') . htmlentities(Config::getOsSetting($device->os, 'text'));
         }
         if ($device->version) {
-            $devinfo .= ($devinfo ? ' - ' : '') . $device->version;
+            $devinfo .= ($devinfo ? ' - ' : '') . htmlentities($device->version);
         }
         if ($device->features) {
-            $devinfo .= ' (' . $device->features . ')';
+            $devinfo .= ' (' . htmlentities($device->features) . ')';
         }
         if ($devinfo) {
-            $contents .= '<br />' . htmlentities(strip_tags($devinfo));
+            $contents .= '<br />' . $devinfo;
         }
         if ($device->location_id) {
-            $contents .= '<br />' . htmlentities(strip_tags($device->location ?? ''));
+            $contents .= '<br />' . htmlentities($device->location ?? '');
         }
         $contents .= '</div><br />';
         foreach ((array) $graphs as $entry) {
             $graph = isset($entry['graph']) ? $entry['graph'] : 'unknown';
             $graphhead = isset($entry['text']) ? $entry['text'] : 'unknown';
             $contents .= '<div class="overlib-box">';
             $contents .= '<span class="overlib-title">' . $graphhead . '</span><br />';
             $contents .= Url::minigraphImage($device, $start, $end, $graph);
             $contents .= Url::minigraphImage($device, Carbon::now()->subWeek()->timestamp, $end, $graph);
             $contents .= '</div>';

--- a/LibreNMS/Util/UserFuncHelper.php
+++ b/LibreNMS/Util/UserFuncHelper.php
@@ -34,13 +34,13 @@
     {
         throw new UserFunctionExistException("Invalid user function: $name");
     }
     public function dateToDays(): int
     {
         return \LibreNMS\Util\Time::dateToDays($this->value_raw);
     }
     public function fsParseChannelValue(): float
     {
         $channel = Str::afterLast($this->sensor['sensor_index'], '.');
-        return Number::cast(explode(',', $this->value_raw)[$channel] ?? '') * $this->sensor['sensor_multiplier'] / $this->sensor['sensor_divisor'];
+        return Number::cast(explode(',', $this->value_raw)[$channel] ?? '');
     }
 }

--- a/LibreNMS/Util/Version.php
+++ b/LibreNMS/Util/Version.php
@@ -24,21 +24,21 @@
  */
 namespace LibreNMS\Util;
 use Illuminate\Support\Arr;
 use Illuminate\Support\Facades\DB;
 use LibreNMS\Config;
 use LibreNMS\DB\Eloquent;
 use Symfony\Component\Process\Process;
 class Version
 {
     /** @var string Update this on release */
-    public const VERSION = '24.10.0';
+    public const VERSION = '24.9.0';
     /** @var Git convenience instance */
     public $git;
     public function __construct()
     {
         $this->git = Git::make();
     }
     public static function get(): Version
     {
         return new static;
     }

--- a/LibreNMS/Validations/Mail.php
+++ b/LibreNMS/Validations/Mail.php
@@ -60,20 +60,19 @@
                 }
                 if (Config::get('email_smtp_auth')
                     && (! Config::has('email_smtp_username') || ! Config::has('email_smtp_password'))
                 ) {
                     $validator->fail('You have selected SMTP auth but have not configured both username and password');
                     $run_test = 0;
                 }
             }//end if
             if ($run_test == 1) {
                 $email = Config::get('alert.default_mail');
-                try {
-                    \LibreNMS\Util\Mail::send($email, 'Test email', 'Testing email from NMS');
+                if ($err = \LibreNMS\Util\Mail::send($email, 'Test email', 'Testing email from NMS', false)) {
                     $validator->ok('Email has been sent');
-                } catch (\Exception $e) {
-                    $validator->fail("Issue sending email to $email with error " . $e->getMessage());
+                } else {
+                    $validator->fail("Issue sending email to $email with error $err");
                 }
             }
         }//end if
     }
 }

--- a/app/Http/Controllers/Auth/LoginController.php
+++ b/app/Http/Controllers/Auth/LoginController.php
@@ -36,21 +36,21 @@
     }
     public function username(): string
     {
         return 'username';
     }
     /**
      * @return \Illuminate\View\View|\Illuminate\Http\RedirectResponse|\Symfony\Component\HttpFoundation\Response
      */
     public function showLoginForm(Request $request)
     {
-        if (! $request->has('redirect') && ! $request->session()->has('block_auto_redirect') && Config::get('auth.socialite.redirect') && array_key_first(Config::get('auth.socialite.configs', []))) {
+        if (! $request->has('redirect') && Config::get('auth.socialite.redirect') && array_key_first(Config::get('auth.socialite.configs', []))) {
             return (new SocialiteController)->redirect($request, array_key_first(Config::get('auth.socialite.configs', [])));
         }
         if (Config::get('public_status')) {
             $devices = Device::isActive()->with('location')->get();
             return view('auth.public-status')->with('devices', $devices);
         }
         return view('auth.login');
     }
     protected function loggedOut(Request $request): \Illuminate\Http\RedirectResponse
     {

--- a/app/Http/Controllers/Auth/SocialiteController.php
+++ b/app/Http/Controllers/Auth/SocialiteController.php
@@ -57,21 +57,21 @@
         }
         return $driver->redirect();
     }
     public function callback(Request $request, string $provider): RedirectResponse
     {
         /* If we get an error in the callback then attempt to handle nicely  */
         if (array_key_exists('error', $request->query())) {
             $error = $request->query('error');
             $error_description = $request->query('error_description');
             toast()->error($error . ': ' . $error_description);
-            return redirect()->route('login')->with('block_auto_redirect', true);
+            return redirect()->route('login');
         }
         $this->socialite_user = Socialite::driver($provider)->user();
         if (Auth::user()) {
             return $this->pairUser($provider);
         }
         $this->register($provider);
         return $this->login($provider);
     }
     /**
      * Metadata endpoint used in SAML
@@ -91,22 +91,22 @@
             ->first();
         try {
             if (! $user) {
                 throw new AuthenticationException();
             }
             Auth::login($user);
             $this->setRolesFromClaim($provider, $user);
             return redirect()->intended();
         } catch (AuthenticationException $e) {
             toast()->error($e->getMessage());
-            return redirect()->route('login')->with('block_auto_redirect', true);
-        }
+        }
+        return redirect()->route('login');
     }
     private function register(string $provider): void
     {
         if (! LibreNMSConfig::get('auth.socialite.register', false)) {
             return;
         }
         $user = User::firstOrNew([
             'auth_type' => "socialite_$provider",
             'auth_id' => $this->socialite_user->getId(),
         ]);

--- a/app/Http/Controllers/DashboardController.php
+++ b/app/Http/Controllers/DashboardController.php
@@ -34,21 +34,20 @@
 use LibreNMS\Config;
 class DashboardController extends Controller
 {
     /** @var string[] */
     public static $widgets = [
         'alerts',
         'alertlog',
         'alertlog-stats',
         'availability-map',
         'component-status',
-        'custom-map',
         'device-summary-horiz',
         'device-summary-vert',
         'device-types',
         'eventlog',
         'globe',
         'generic-graph',
         'graylog',
         'generic-image',
         'notes',
         'server-stats',

--- a/app/Http/Controllers/Device/Tabs/NeighboursController.php
+++ b/app/Http/Controllers/Device/Tabs/NeighboursController.php
@@ -19,75 +19,36 @@
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2020 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace App\Http\Controllers\Device\Tabs;
 use App\Models\Device;
 use App\Models\Link;
 use Illuminate\Http\Request;
-use LibreNMS\Config;
 use LibreNMS\Interfaces\UI\DeviceTab;
-use LibreNMS\Util\Url;
 class NeighboursController implements DeviceTab
 {
     public function visible(Device $device): bool
     {
-        return Link::where('local_device_id', $device->device_id)->exists();
+        return Link::where('local_device_id', $device->device_id)
+            ->orWhere('remote_device_id', $device->device_id)
+            ->exists();
     }
     public function slug(): string
     {
         return 'neighbours';
     }
     public function icon(): string
     {
         return 'fa-sitemap';
     }
     public function name(): string
     {
         return __('Neighbours');
     }
     public function data(Device $device, Request $request): array
     {
-        $selection = Url::parseOptions('selection', 'list');
-        $links = [];
-        $devices[$device->device_id] = [
-            'url' => Url::deviceLink($device, null, [], 0, 0, 0, 1),
-            'hw' => $device->hardware,
-            'name' => $device->shortDisplayName(),
-        ];
-        if ($selection == 'list') {
-            $linksQuery = $device->links()->with('port', 'remoteDevice', 'remotePort');
-            foreach ($linksQuery->get()->sortBy('port.ifName') as $link) {
-                $links[] = [
-                    'local_url' => Url::portLink($link->port, null, null, true, false),
-                    'ldev_id' => $device->device_id,
-                    'local_portname' => $link->port->ifAlias,
-                    'rport_url' => $link->remotePort ? Url::portLink($link->remotePort, null, null, true, false) : '',
-                    'rdev_url' => $link->remoteDevice ? Url::deviceLink($link->remoteDevice, null, [], 0, 0, 0, 1) : null,
-                    'rdev_name' => $link->remoteDevice ? $link->remoteDevice->shortDisplayName() : $link->remote_hostname,
-                    'rdev_info' => $link->remoteDevice ? $link->remoteDevice->hardware : $link->remote_platform,
-                    'rport_name' => $link->remotePort ? $link->remotePort->ifAlias : $link->remote_port,
-                    'protocol' => strtoupper($link->protocol),
-                ];
-            }
-        }
-        return [
-            'selections' => [
-                'list' => [
-                    'text' => 'List',
-                    'link' => Url::deviceUrl($device, ['tab' => 'neighbours', 'selection' => 'list']),
-                ],
-                'map' => [
-                    'text' => 'Map',
-                    'link' => Url::deviceUrl($device, ['tab' => 'neighbours', 'selection' => 'map']),
-                ],
-            ],
-            'selection' => $selection,
-            'device_id' => $device->device_id,
-            'links' => $links,
-            'link_types' => Config::get('network_map_items', ['xdp', 'mac']),
-            'visoptions' => Config::get('network_map_vis_options'),
-        ];
+        return [];
     }
 }

--- a/app/Http/Controllers/Device/Tabs/PortsController.php
+++ b/app/Http/Controllers/Device/Tabs/PortsController.php
@@ -101,21 +101,20 @@
             'perPage' => $this->settings['perPage'],
             'sort' => $this->settings['sort'],
             'next_order' => $this->settings['order'] == 'asc' ? 'desc' : 'asc',
         ], $data);
     }
     private function portData(Device $device, Request $request): array
     {
         $relationships = ['groups', 'ipv4', 'ipv6', 'vlans', 'adsl', 'vdsl'];
         if ($this->detail) {
             $relationships[] = 'links';
-            $relationships[] = 'transceivers';
             $relationships[] = 'pseudowires.endpoints';
             $relationships[] = 'ipv4Networks.ipv4';
             $relationships[] = 'ipv6Networks.ipv6';
             $relationships['stackParent'] = fn ($q) => $q->select('port_id');
             $relationships['stackChildren'] = fn ($q) => $q->select('port_id');
         }
         /** @var Collection<Port>|LengthAwarePaginator<Port> $ports */
         $ports = $this->getFilteredPortsQuery($device, $relationships)
             ->paginate(fn ($total) => $this->settings['perPage'] == 'all' ? $total : (int) $this->settings['perPage']) // @phpstan-ignore-line missing closure type
             ->appends('perPage', $this->settings['perPage']);

--- a/app/Http/Controllers/Maps/AvailabilityMapController.php
+++ b//dev/null
@@ -1,47 +0,0 @@
-<?php
-/**
- * AvailabilityMapController.php
- *
- * Controller for availability maps
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2023 Steven Wilton
- * @author     Steven Wilton <swilton@fluentit.com.au>
- */
-namespace App\Http\Controllers\Maps;
-use App\Http\Controllers\Controller;
-use App\Models\DeviceGroup;
-use Illuminate\Http\Request;
-use Illuminate\View\View;
-use LibreNMS\Config;
-class AvailabilityMapController extends Controller
-{
-    public function availabilityMap(Request $request): View
-    {
-        $data = [
-            'page_refresh' => Config::get('page_refresh', 300),
-            'compact' => Config::get('webui.availability_map_compact'),
-            'box_size' => Config::get('webui.availability_map_box_size'),
-            'sort' => Config::get('webui.availability_map_sort_status') ? 'status' : 'hostname',
-            'use_groups' => Config::get('webui.availability_map_use_device_groups'),
-            'services' => Config::get('show_services'),
-            'uptime_warn' => Config::get('uptime_warning'),
-            'devicegroups' => Config::get('webui.availability_map_use_device_groups') ? DeviceGroup::hasAccess($request->user())->orderBy('name')->get(['id', 'name']) : [],
-        ];
-        return view('map.availability', $data);
-    }
-}

--- a/app/Http/Controllers/Maps/CustomMapController.php
+++ b/app/Http/Controllers/Maps/CustomMapController.php
@@ -43,47 +43,38 @@
         return view('map.custom-manage', [
             'maps' => CustomMap::orderBy('name')->get(['custom_map_id', 'name', 'menu_group'])->groupBy('menu_group')->sortKeys(),
             'name' => 'New Map',
             'menu_group' => null,
             'node_align' => Config::get('custom_map.node_align', 10),
             'edge_separation' => Config::get('custom_map.edge_seperation', 10),
             'reverse_arrows' => Config::get('custom_map.reverse_arrows', false) ? 'true' : 'false',
             'legend' => [
                 'x' => -1,
                 'y' => -1,
+                'steps' => 7,
+                'hide_invalid' => 0,
+                'hide_overspeed' => 0,
+                'font_size' => 14,
             ],
             'background_type' => Config::get('custom_map.background_type', 'none'),
             'background_data' => Config::get('custom_map.background_data'),
             'map_conf' => [
                 'width' => Config::get('custom_map.width', '1800px'),
                 'height' => Config::get('custom_map.height', '800px'),
                 'interaction' => [
                     'dragNodes' => true,
                     'dragView' => false,
                     'zoomView' => false,
                 ],
                 'manipulation' => [
                     'enabled' => true,
                     'initiallyActive' => true,
-                ],
-                'physics' => [
-                    'enabled' => false,
-                ],
-            ],
-            'map_options' => [
-                'interaction' => [
-                    'dragNodes' => false,
-                    'dragView' => false,
-                    'zoomView' => false,
-                ],
-                'manipulation' => [
-                    'enabled' => false,
                 ],
                 'physics' => [
                     'enabled' => false,
                 ],
             ],
         ]);
     }
     public function destroy(CustomMap $map): Response
     {
         $map->delete();
@@ -124,21 +115,20 @@
             'map_id' => $map->custom_map_id,
             'name' => $map->name,
             'menu_group' => $map->menu_group,
             'node_align' => $map->node_align,
             'edge_separation' => $map->edge_separation,
             'reverse_arrows' => $map->reverse_arrows,
             'legend' => $this->legendConfig($map),
             'newedge_conf' => $map->newedgeconfig,
             'newnode_conf' => $map->newnodeconfig,
             'map_conf' => $map->options,
-            'map_options' => $map->options,
             'background_type' => $map->background_type,
             'background_config' => $map->getBackgroundConfig(),
             'edit' => true,
             'vmargin' => 20,
             'hmargin' => 20,
             'base_url' => Config::get('base_url'),
             'images' => $this->listNodeImages(),
             'maps' => CustomMap::orderBy('name')->where('custom_map_id', '<>', $map->custom_map_id)->get(['custom_map_id', 'name']),
         ];
         $data['map_conf']['width'] = $map->width;
@@ -191,40 +181,34 @@
             ],
             'font' => [
                 'color' => Config::get('custom_map.edge_font_color', '#343434'),
                 'size' => Config::get('custom_map.edge_font_size', 12),
                 'face' => Config::get('custom_map.edge_font_face', 'arial'),
             ],
             'label' => true,
         ];
         $map->background_type = Config::get('custom_map.background_type', 'none');
         $map->background_data = Config::get('custom_map.background_data');
-        $map->legend_colours = $this->getDefaultLegendColours();
-        if ($map->legend_colours) {
-            $map->legend_steps = count($map->legend_colours) - 2;
-        }
         return $this->update($request, $map);
     }
     public function update(CustomMapSettingsRequest $request, CustomMap $map): JsonResponse
     {
         $map->fill($request->validated());
-        $map->options = json_decode($request->options);
         $map->save(); // save to get ID
         return response()->json([
             'id' => $map->custom_map_id,
             'name' => $map->name,
             'menu_group' => $map->menu_group,
             'width' => $map->width,
             'height' => $map->height,
             'reverse_arrows' => $map->reverse_arrows,
             'edge_separation' => $map->edge_separation,
-            'options' => $map->options,
         ]);
     }
     /**
      * Get a list of all available node images with a label.
      */
     private function listNodeImages(): array
     {
         $images = [];
         $image_translations = __('map.custom.edit.node.image_options');
         foreach (Storage::disk('base')->files('html/images/custommap/icons') as $image) {
@@ -241,42 +225,14 @@
      */
     private function legendConfig(CustomMap $map): array
     {
         $legend = [
             'x' => $map->legend_x,
             'y' => $map->legend_y,
             'steps' => $map->legend_steps,
             'hide_invalid' => $map->legend_hide_invalid,
             'hide_overspeed' => $map->legend_hide_overspeed,
             'font_size' => $map->legend_font_size,
-            'colours' => $map->legend_colours,
         ];
         return $legend;
     }
-    /**
-     * Return the default legend colours
-     */
-    private function getDefaultLegendColours(): array|null
-    {
-        $ret = Config::get('custom_map.legend_colours', null);
-        if (! $ret) {
-            return null;
-        }
-        foreach (array_keys($ret) as $key) {
-            if (! is_numeric($key)) {
-                unset($ret[$key]);
-            } elseif (! preg_match('/^#[A-Fa-f0-0]{6}$/', $ret[$key])) {
-                unset($ret[$key]);
-            }
-        }
-        if (! array_key_exists('-2', $ret)) {
-            $ret['-2'] = '#8B0000';
-        }
-        if (! array_key_exists('-1', $ret)) {
-            $ret['-1'] = '#000000';
-        }
-        if (! array_key_exists('0', $ret)) {
-            $ret['0'] = '#00FF00';
-        }
-        return $ret;
-    }
 }

--- a/app/Http/Controllers/Maps/CustomMapDataController.php
+++ b/app/Http/Controllers/Maps/CustomMapDataController.php
@@ -32,40 +32,34 @@
 use Illuminate\Support\Facades\DB;
 use Illuminate\Support\Facades\Log;
 use LibreNMS\Config;
 use LibreNMS\Util\Number;
 use LibreNMS\Util\Url;
 class CustomMapDataController extends Controller
 {
     public function get(Request $request, CustomMap $map): JsonResponse
     {
         $this->authorize('view', $map);
-        $map->load(['nodes.device', 'nodes.device.location', 'nodes.linked_map']);
         $edges = [];
         $nodes = [];
-        if ($map->legend_colours) {
-            $sorted_colours = $map->legend_colours;
-            ksort($sorted_colours, SORT_NUMERIC);
-        }
         foreach ($map->edges as $edge) {
             $edgeid = $edge->custom_map_edge_id;
             $edges[$edgeid] = [
                 'custom_map_edge_id' => $edge->custom_map_edge_id,
                 'custom_map_node1_id' => $edge->custom_map_node1_id,
                 'custom_map_node2_id' => $edge->custom_map_node2_id,
                 'port_id' => $edge->port_id,
                 'reverse' => $edge->reverse,
                 'style' => $edge->style,
                 'showpct' => $edge->showpct,
                 'showbps' => $edge->showbps,
                 'label' => $edge->label,
-                'fixed_width' => $edge->fixed_width,
                 'text_face' => $edge->text_face,
                 'text_size' => $edge->text_size,
                 'text_colour' => $edge->text_colour,
                 'mid_x' => $edge->mid_x,
                 'mid_y' => $edge->mid_y,
             ];
             if ($edge->port) {
                 $edges[$edgeid]['device_id'] = $edge->port->device_id;
                 $edges[$edgeid]['port_name'] = $edge->port->device->displayName() . ' - ' . $edge->port->getLabel();
                 $edges[$edgeid]['port_info'] = Url::portLink($edge->port, null, null, false, true);
@@ -101,54 +95,35 @@
                     $ratefrom = $edge->port->ifOutOctets_rate * 8;
                     $rateto = $edge->port->ifInOctets_rate * 8;
                 }
                 if ($speedto == 0) {
                     $edges[$edgeid]['port_topct'] = -1.0;
                     $edges[$edgeid]['port_frompct'] = -1.0;
                 } else {
                     $edges[$edgeid]['port_topct'] = $rateto / $speedto * 100.0;
                     $edges[$edgeid]['port_frompct'] = $ratefrom / $speedfrom * 100.0;
                 }
-                if (! $edge->port->device->status) {
-                    if ($map->legend_colours) {
-                        $edges[$edgeid]['colour_to'] = $map->legend_colours['-2'];
-                        $edges[$edgeid]['colour_from'] = $map->legend_colours['-2'];
-                    } else {
-                        $edges[$edgeid]['colour_to'] = 'darkred';
-                        $edges[$edgeid]['colour_from'] = 'darkred';
-                    }
-                } elseif ($edge->port->ifOperStatus != 'up') {
-                    if ($map->legend_colours) {
-                        $edges[$edgeid]['colour_to'] = $map->legend_colours['-1'];
-                        $edges[$edgeid]['colour_from'] = $map->legend_colours['-1'];
-                    } else {
-                        $edges[$edgeid]['colour_to'] = $this->speedColour(-1.0);
-                        $edges[$edgeid]['colour_from'] = $this->speedColour(-1.0);
-                    }
-                } else {
-                    if ($map->legend_colours) {
-                        $edges[$edgeid]['colour_to'] = $this->fixedColour($sorted_colours, $edges[$edgeid]['port_topct']);
-                        $edges[$edgeid]['colour_from'] = $this->fixedColour($sorted_colours, $edges[$edgeid]['port_frompct']);
-                    } else {
-                        $edges[$edgeid]['colour_to'] = $this->speedColour($edges[$edgeid]['port_topct']);
-                        $edges[$edgeid]['colour_from'] = $this->speedColour($edges[$edgeid]['port_frompct']);
-                    }
+                if ($edge->port->ifOperStatus != 'up') {
+                    $edges[$edgeid]['colour_to'] = $this->speedColour(-1.0);
+                    $edges[$edgeid]['colour_from'] = $this->speedColour(-1.0);
+                } else {
+                    $edges[$edgeid]['colour_to'] = $this->speedColour($edges[$edgeid]['port_topct']);
+                    $edges[$edgeid]['colour_from'] = $this->speedColour($edges[$edgeid]['port_frompct']);
                 }
                 $edges[$edgeid]['port_topct'] = round($edges[$edgeid]['port_topct'], 2);
                 $edges[$edgeid]['port_frompct'] = round($edges[$edgeid]['port_frompct'], 2);
                 $edges[$edgeid]['port_tobps'] = $this->rateString($rateto);
                 $edges[$edgeid]['port_frombps'] = $this->rateString($ratefrom);
                 $edges[$edgeid]['width_to'] = $this->speedWidth($speedto);
                 $edges[$edgeid]['width_from'] = $this->speedWidth($speedfrom);
             }
         }
-        /** @var CustomMapNode $node */
         foreach ($map->nodes as $node) {
             $nodeid = $node->custom_map_node_id;
             $nodes[$nodeid] = [
                 'custom_map_node_id' => $node->custom_map_node_id,
                 'device_id' => $node->device_id,
                 'linked_map_id' => $node->linked_custom_map_id,
                 'linked_map_name' => $node->linked_map ? $node->linked_map->name : null,
                 'label' => $node->label,
                 'style' => $node->style,
                 'icon' => $node->icon,
@@ -158,62 +133,59 @@
                 'text_face' => $node->text_face,
                 'text_size' => $node->text_size,
                 'text_colour' => $node->text_colour,
                 'colour_bg' => $node->colour_bg,
                 'colour_bdr' => $node->colour_bdr,
                 'colour_bg_view' => $node->colour_bg,
                 'colour_bdr_view' => $node->colour_bdr,
                 'x_pos' => $node->x_pos,
                 'y_pos' => $node->y_pos,
             ];
-            if ($node->linkedMapIsDown()) {
-                $this->setNodeDownStyle($nodes[$nodeid], $request);
-            }
             if ($node->device) {
                 $nodes[$nodeid]['device_name'] = $node->device->hostname . '(' . $node->device->sysName . ')';
                 $nodes[$nodeid]['device_image'] = $node->device->icon;
                 $nodes[$nodeid]['device_info'] = Url::deviceLink($node->device, null, [], 0, 0, 0, 0);
                 if ($node->device->disabled) {
-                    $this->setNodeDisabledStyle($nodes[$nodeid]);
+                    $device_style = $this->nodeDisabledStyle();
                 } elseif (! $node->device->status) {
-                    $this->setNodeDownStyle($nodes[$nodeid], $request);
+                    $device_style = $this->nodeDownStyle();
+                } else {
+                    $device_style = $this->nodeUpStyle();
+                }
+                if ($device_style['background']) {
+                    $nodes[$nodeid]['colour_bg_view'] = $device_style['background'];
+                }
+                if ($device_style['border']) {
+                    $nodes[$nodeid]['colour_bdr_view'] = $device_style['border'];
                 }
             }
         }
         return response()->json(['nodes' => $nodes, 'edges' => $edges]);
     }
     public function save(Request $request, CustomMap $map): JsonResponse
     {
         $this->authorize('update', $map);
         $data = $this->validate($request, [
             'newnodeconf' => 'array',
             'newedgeconf' => 'array',
             'nodes' => 'array',
             'edges' => 'array',
             'legend_x' => 'integer',
             'legend_y' => 'integer',
-            'legend_steps' => 'integer',
-            'legend_font_size' => 'integer',
-            'legend_hide_invalid' => 'boolean',
-            'legend_hide_overspeed' => 'boolean',
-            'legend_colours' => 'nullable|array',
         ]);
         $map->load(['nodes', 'edges']);
         DB::transaction(function () use ($map, $data) {
-            $map->legend_x = $data['legend_x'];
-            $map->legend_y = $data['legend_y'];
-            $map->legend_steps = $data['legend_steps'];
-            $map->legend_font_size = $data['legend_font_size'];
-            $map->legend_hide_invalid = $data['legend_hide_invalid'];
-            $map->legend_hide_overspeed = $data['legend_hide_overspeed'];
-            $map->legend_colours = $data['legend_colours'];
-            $map->save();
+            if ($map->legend_x != $data['legend_x'] || $map->legend_y != $data['legend_y']) {
+                $map->legend_x = $data['legend_x'];
+                $map->legend_y = $data['legend_y'];
+                $map->save();
+            }
             $dbnodes = $map->nodes->keyBy('custom_map_node_id')->all();
             $dbedges = $map->edges->keyBy('custom_map_edge_id')->all();
             $nodesProcessed = [];
             $edgesProcessed = [];
             $newNodes = [];
             $map->newnodeconfig = $data['newnodeconf'];
             $map->newedgeconfig = $data['newedgeconf'];
             $map->save();
             foreach ($data['nodes'] as $nodeid => $node) {
                 if (strpos($nodeid, 'new') === 0) {
@@ -256,21 +228,20 @@
                         abort(404);
                     }
                 }
                 $dbedge->custom_map_node1_id = strpos($edge['from'], 'new') == 0 ? $newNodes[$edge['from']]->custom_map_node_id : $edge['from'];
                 $dbedge->custom_map_node2_id = strpos($edge['to'], 'new') == 0 ? $newNodes[$edge['to']]->custom_map_node_id : $edge['to'];
                 $dbedge->port_id = $edge['port_id'] ? $edge['port_id'] : null;
                 $dbedge->reverse = filter_var($edge['reverse'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
                 $dbedge->showpct = filter_var($edge['showpct'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
                 $dbedge->showbps = filter_var($edge['showbps'], FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
                 $dbedge->label = $edge['label'] ? $edge['label'] : '';
-                $dbedge->fixed_width = $edge['fixed_width'];
                 $dbedge->style = $edge['style'];
                 $dbedge->text_face = $edge['text_face'];
                 $dbedge->text_size = $edge['text_size'];
                 $dbedge->text_colour = $edge['text_colour'];
                 $dbedge->mid_x = intval($edge['mid_x']);
                 $dbedge->mid_y = intval($edge['mid_y']);
                 $dbedge->save();
                 $edgesProcessed[$dbedge->custom_map_edge_id] = true;
             }
             foreach ($map->edges as $edge) {
@@ -286,31 +257,20 @@
         });
         return response()->json(['id' => $map->custom_map_id]);
     }
     private function rateString(int $rate): string
     {
         return Number::formatSi($rate, 2, 3, 'bps');
     }
     private function snmpSpeed(string $speeds): int
     {
         return (int) Number::toBytes($speeds);
-    }
-    private function fixedColour(array $colours, float $pct): string
-    {
-        $last_colour = 'black';
-        foreach ($colours as $colour_pct => $colour) {
-            if ($colour_pct > $pct) {
-                break;
-            }
-            $last_colour = $colour;
-        }
-        return $last_colour;
     }
     private function speedColour(float $pct): string
     {
         if ($pct <= 0) {
             return '#000000';
         } elseif ($pct < 50) {
             return sprintf('#%02XFF00', (int) (5.1 * $pct));
         } elseif ($pct < 100) {
             return sprintf('#FF%02X00', (int) (5.1 * (100.0 - $pct)));
         } elseif ($pct < 150) {
@@ -318,29 +278,32 @@
         }
         return '#FF00FF';
     }
     private function speedWidth(int $speed): float
     {
         if ($speed < 1000000) {
             return 1.0;
         }
         return (strlen((string) $speed) - 5) / 2.0;
     }
-    protected function setNodeDisabledStyle(array &$node_data_array): void
-    {
-        $node_data_array['colour_bg_view'] = Config::get('network_map_legend.di.border');
-        $node_data_array['colour_bdr_view'] = Config::get('network_map_legend.di.node');
-    }
-    protected function setNodeDownStyle(array &$node_data_array, Request $request): void
-    {
-        $node_data_array['colour_bg_view'] = Config::get('network_map_legend.dn.node');
-        $node_data_array['colour_bdr_view'] = Config::get('network_map_legend.dn.border');
-        if ($request->headers->get('referer') && ! str_ends_with(parse_url($request->headers->get('referer'), PHP_URL_PATH), '/edit')) {
-            $node_data_array['text_colour'] = 'darkred';
-        }
-    }
-    protected function setNodeUpStyle(array &$node_data_array, CustomMapNode $node): void
-    {
-        $node_data_array['colour_bg_view'] = $node->colour_bg;
-        $node_data_array['colour_bdr_view'] = $node->colour_bdr;
+    protected function nodeDisabledStyle(): array
+    {
+        return [
+            'border' => Config::get('network_map_legend.di.border'),
+            'background' => Config::get('network_map_legend.di.node'),
+        ];
+    }
+    protected function nodeDownStyle(): array
+    {
+        return [
+            'border' => Config::get('network_map_legend.dn.border'),
+            'background' => Config::get('network_map_legend.dn.node'),
+        ];
+    }
+    protected function nodeUpStyle(): array
+    {
+        return [
+            'border' => null,
+            'background' => null,
+        ];
     }
 }

--- a/app/Http/Controllers/Maps/DeviceDependencyController.php
+++ b/app/Http/Controllers/Maps/DeviceDependencyController.php
@@ -16,33 +16,135 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2019 Thomas Berberich
  * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
  */
 namespace App\Http\Controllers\Maps;
-use App\Http\Controllers\Controller;
+use App\Models\Device;
 use App\Models\DeviceGroup;
 use Illuminate\Http\Request;
-use Illuminate\View\View;
-use LibreNMS\Config;
-class DeviceDependencyController extends Controller
+use LibreNMS\Util\Url;
+class DeviceDependencyController extends MapController
 {
-    public function dependencyMap(Request $request): View
+    protected $isolatedDeviceId = -1;
+    protected $deviceIdAll = [];
+    private $parentDeviceIds = [];
+    protected static function deviceList($request)
     {
         $group_id = $request->get('group');
+        if (! $group_id) {
+            return Device::hasAccess($request->user())->with('parents', 'location')->get();
+        }
+        $devices = Device::inDeviceGroup($group_id)
+            ->hasAccess($request->user())
+            ->with([
+                'location',
+                'parents' => function ($query) use ($request) {
+                    $query->hasAccess($request->user());
+                },
+                'children' => function ($query) use ($request) {
+                    $query->hasAccess($request->user());
+                }, ])
+            ->get();
+        return $devices->merge($devices->map->only('children', 'parents')->flatten())->loadMissing('parents', 'location');
+    }
+    protected function highlightDevices($devices_by_id, $device_id_list)
+    {
+        $new_device_list = [];
+        foreach ($devices_by_id as $device) {
+            if (in_array($device['id'], $device_id_list)) {
+                $new_device_list[] = array_merge($device, $this->nodeHighlightStyle());
+                continue;
+            }
+            $new_device_list[] = $device;
+        }
+        return $new_device_list;
+    }
+    protected function getParentDevices($device)
+    {
+        foreach ($device->parents as $parent) {
+            if (! in_array($parent->device_id, $this->deviceIdAll)) {
+                continue;
+            }
+            if (in_array($parent->device_id, $this->parentDeviceIds)) {
+                continue;
+            }
+            $this->parentDeviceIds[] = $parent->device_id;
+            if ($parent) {
+                $this->getParentDevices($parent);
+            }
+        }
+    }
+    public function dependencyMap(Request $request)
+    {
+        $group_id = $request->get('group');
+        $highlight_node = $request->get('highlight_node');
+        $show_device_path = $request->get('showparentdevicepath');
+        $dependencies = [];
+        $devices_by_id = [];
+        $device_list = [];
+        $device_associations = [];
+        foreach (self::deviceList($request) as $device) {
+            $device_list[] = ['id' => $device->device_id, 'label' => $device->hostname];
+            $this->deviceIdAll[] = $device->device_id;
+            $devices_by_id[] = array_merge(
+                [
+                    'id' => $device->device_id,
+                    'label' => $device->shortDisplayName(),
+                    'title' => Url::deviceLink($device, null, [], 0, 0, 0, 0),
+                    'shape' => 'box',
+                ],
+                $this->deviceStyle($device, $highlight_node)
+            );
+            $children = $device->children;
+            foreach ($children as $child) {
+                $device_associations[] = $child->device_id;
+            }
+            $parents = $device->parents;
+            foreach ($parents as $parent) {
+                $device_associations[] = $parent->device_id;
+                $dependencies[] = [
+                    'from' => $device->device_id,
+                    'to' => $parent->device_id,
+                    'width' => 2,
+                ];
+            }
+        }
+        if ($highlight_node == $this->isolatedDeviceId) {
+            $device_associations = array_unique($device_associations);
+            $isolated_device_ids = array_diff($this->deviceIdAll, $device_associations);
+            $devices_by_id = $this->highlightDevices($devices_by_id, $isolated_device_ids);
+        } elseif ($show_device_path && ($highlight_node > 0)) {
+            foreach (self::deviceList($request) as $device) {
+                if ($device->device_id != $highlight_node) {
+                    continue;
+                }
+                $this->getParentDevices($device);
+                break;
+            }
+            $devices_by_id = $this->highlightDevices($devices_by_id, $this->parentDeviceIds);
+        }
+        $device_list_labels = array_column($device_list, 'label');
+        array_multisort($device_list_labels, SORT_ASC, $device_list);
         $group_name = DeviceGroup::where('id', '=', $group_id)->first('name');
         if (! empty($group_name)) {
             $group_name = $group_name->name;
         }
         $data = [
-            'page_refresh' => Config::get('page_refresh', 300),
+            'showparentdevicepath' => $show_device_path,
+            'isolated_device_id' => $this->isolatedDeviceId,
+            'device_list' => $device_list,
             'group_id' => $group_id,
-            'options' => Config::get('network_map_vis_options'),
+            'highlight_node' => $highlight_node,
+            'node_count' => count($devices_by_id),
+            'options' => $this->visOptions(),
+            'nodes' => json_encode(array_values($devices_by_id)),
+            'edges' => json_encode($dependencies),
             'group_name' => $group_name,
         ];
         return view('map.device-dependency', $data);
     }
 }

--- a/app/Http/Controllers/Maps/FullscreenMapController.php
+++ b//dev/null
@@ -1,83 +0,0 @@
-<?php
-/**
- * FullscreenMapController.php
- *
- * Controller for full screen map
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2023 Steven Wilton
- * @author     Steven Wilton <swilton@fluentit.com.au>
- */
-namespace App\Http\Controllers\Maps;
-use App\Http\Controllers\Controller;
-use App\Models\DeviceGroup;
-use Illuminate\Http\RedirectResponse;
-use Illuminate\Http\Request;
-use Illuminate\Support\Facades\Validator;
-use Illuminate\View\View;
-use LibreNMS\Config;
-class FullscreenMapController extends Controller
-{
-    protected function fullscreenMap(Request $request): View|RedirectResponse
-    {
-        $validator = Validator::make($request->all(), [
-            'group' => 'int',
-            'lat' => 'numeric',
-            'lng' => 'numeric',
-            'zoom' => 'numeric',
-        ]);
-        if ($validator->fails()) {
-            return redirect('fullscreenmap');
-        }
-        $group_name = null;
-        if ($request->get('group')) {
-            $group_name = DeviceGroup::where('id', '=', $request->get('group'))->first('name');
-            if (! empty($group_name)) {
-                $group_name = $group_name->name;
-            }
-        }
-        $init_lat = $request->get('lat');
-        if (! $init_lat) {
-            $init_lat = Config::get('leaflet.default_lat', 51.48);
-        }
-        $init_lng = $request->get('lng');
-        if (! $init_lng) {
-            $init_lng = Config::get('leaflet.default_lng', 0);
-        }
-        $init_zoom = $request->get('zoom');
-        if (! $init_zoom) {
-            $init_zoom = Config::get('leaflet.default_zoom', 5);
-        }
-        $data = [
-            'map_engine' => Config::get('map.engine', 'leaflet'),
-            'map_provider' => Config::get('geoloc.engine', 'openstreetmap'),
-            'map_api_key' => Config::get('geoloc.api_key', ''),
-            'show_netmap' => Config::get('network_map_show_on_worldmap', false),
-            'netmap_source' => Config::get('network_map_worldmap_link_type', 'xdp'),
-            'netmap_include_disabled_alerts' => Config::get('network_map_worldmap_show_disabled_alerts', true) ? 'null' : 0,
-            'page_refresh' => Config::get('page_refresh', 300),
-            'init_lat' => $init_lat,
-            'init_lng' => $init_lng,
-            'init_zoom' => $init_zoom,
-            'group_radius' => Config::get('leaflet.group_radius', 80),
-            'tile_url' => Config::get('leaflet.tile_url', '{s}.tile.openstreetmap.org'),
-            'group_id' => $request->get('group'),
-            'group_name' => $group_name,
-        ];
-        return view('map.fullscreen', $data);
-    }
-}

--- a//dev/null
+++ b/app/Http/Controllers/Maps/MapController.php
@@ -0,0 +1,86 @@
+<?php
+/**
+ * DependencyController.php
+ *
+ * Controller for graphing Relationships
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation, either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <https://www.gnu.org/licenses/>.
+ *
+ * @link       https://www.librenms.org
+ *
+ * @copyright  2019 Thomas Berberich
+ * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
+ */
+namespace App\Http\Controllers\Maps;
+use App\Http\Controllers\Controller;
+use LibreNMS\Config;
+class MapController extends Controller
+{
+    protected function visOptions()
+    {
+        return Config::get('network_map_vis_options');
+    }
+    protected function nodeDisabledStyle()
+    {
+        return ['color' => [
+            'highlight' => [
+                'background' => Config::get('network_map_legend.di.node'),
+            ],
+            'border' => Config::get('network_map_legend.di.border'),
+            'background' => Config::get('network_map_legend.di.node'),
+        ],
+        ];
+    }
+    protected function nodeHighlightStyle()
+    {
+        return ['color' => [
+            'highlight' => [
+                'border' => Config::get('network_map_legend.highlight.border'),
+            ],
+            'border' => Config::get('network_map_legend.highlight.border'),
+        ],
+            'borderWidth' => Config::get('network_map_legend.highlight.borderWidth'),
+        ];
+    }
+    protected function nodeDownStyle()
+    {
+        return ['color' => [
+            'highlight' => [
+                'background' => Config::get('network_map_legend.dn.node'),
+                'border' => Config::get('network_map_legend.dn.border'),
+            ],
+            'border' => Config::get('network_map_legend.dn.border'),
+            'background' => Config::get('network_map_legend.dn.node'),
+        ],
+        ];
+    }
+    protected function nodeUpStyle()
+    {
+        return [];
+    }
+    protected function deviceStyle($device, $highlight_node = 0)
+    {
+        if ($device->disabled) {
+            $device_style = $this->nodeDisabledStyle();
+        } elseif (! $device->status) {
+            $device_style = $this->nodeDownStyle();
+        } else {
+            $device_style = $this->nodeUpStyle();
+        }
+        if ($device->device_id == $highlight_node) {
+            $device_style = array_merge($device_style, $this->nodeHighlightStyle());
+        }
+        return $device_style;
+    }
+}

--- a/app/Http/Controllers/Maps/MapDataController.php
+++ b//dev/null
@@ -1,676 +0,0 @@
-<?php
-/**
- * MapDataController.php
- *
- * Controller for getting data for maps
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2019 Thomas Berberich
- * @author     Thomas Berberich <sourcehhdoctor@gmail.com>
- * @author     Steven Wilton <swilton@fluentit.com.au>
- */
-namespace App\Http\Controllers\Maps;
-use App\Http\Controllers\Controller;
-use App\Models\AlertSchedule;
-use App\Models\Device;
-use App\Models\Link;
-use App\Models\Port;
-use App\Models\Service;
-use Illuminate\Database\Eloquent\Builder;
-use Illuminate\Http\JsonResponse;
-use Illuminate\Http\Request;
-use Illuminate\Support\Facades\Log;
-use LibreNMS\Config;
-use LibreNMS\Util\Url;
-class MapDataController extends Controller
-{
-    protected static function geoLinks(Request $request)
-    {
-        $user = $request->user();
-        if ($request->link_type != 'xdp') {
-            return collect();
-        }
-        $linkQuery = Link::with('port', 'device', 'remoteDevice', 'device.location', 'remoteDevice.location')
-            ->whereHas('device', function (Builder $q) use ($user) {
-                $q->whereIn('status', [0, 1])
-                    ->where('disabled', 0)
-                    ->where('ignore', 0);
-                if (! $user->hasGlobalRead()) {
-                    $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
-                }
-            })
-            ->whereHas('device.location', function (Builder $q) {
-                $q->whereNotNull('lat')
-                    ->whereNotNull('lng');
-            })
-            ->whereHas('remoteDevice', function (Builder $q) use ($user) {
-                $q->whereIn('status', [0, 1])
-                    ->where('disabled', 0)
-                    ->where('ignore', 0);
-                if (! $user->hasGlobalRead()) {
-                    $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
-                }
-            })
-            ->whereHas('remoteDevice.location', function (Builder $q) {
-                $q->whereNotNull('lat')
-                    ->whereNotNull('lng');
-            })
-            ->whereHas('port', function (Builder $q) {
-                $q->where('ifOperStatus', 'up');
-            });
-        $group_id = $request->group;
-        if ($group_id) {
-            $linkQuery->whereHas('remoteDevice', function ($q) use ($group_id) {
-                $q->whereIn('device_id', function ($q) use ($group_id) {
-                    $q->select('device_id')
-                    ->from('device_group_device')
-                    ->where('device_group_id', $group_id);
-                });
-            })
-            ->whereHas('device', function ($q) use ($group_id) {
-                $q->whereIn('device_id', function ($q) use ($group_id) {
-                    $q->select('device_id')
-                    ->from('device_group_device')
-                    ->where('device_group_id', $group_id);
-                });
-            });
-        }
-        return $linkQuery->get()
-            ->groupBy(function (Link $i) {
-                return $i->device->location->lat . '.' . $i->device->location->lng . '.' . $i->remoteDevice->location->lat . '.' . $i->remoteDevice->location->lng;
-            });
-    }
-    protected static function portsWithLinks(Request $request, string $remote_port_attr)
-    {
-        $user = $request->user();
-        $disabled = $request->disabled;
-        $disabled_alerts = $request->disabled_alerts;
-        $group_id = $request->group;
-        $device_id = $request->device;
-        if (is_null($disabled) && is_null($disabled_alerts) && ! $group_id && $user->hasGlobalRead()) {
-            $device_filter = false;
-        } else {
-            $device_filter = true;
-        }
-        $linkQuery = Port::hasAccess($request->user())
-            ->with([
-                $remote_port_attr,
-                'device' => function ($q) use ($user, $disabled, $disabled_alerts, $group_id) {
-                    if (! $user->hasGlobalRead()) {
-                        $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
-                    }
-                    if (! is_null($disabled)) {
-                        if ($disabled) {
-                            $q->where('disabled', '<>', '0');
-                        } else {
-                            $q->where('disabled', '=', '0');
-                        }
-                    }
-                    if (! is_null($disabled_alerts)) {
-                        if ($disabled_alerts) {
-                            $q->where('disable_notify', '<>', '0');
-                        } else {
-                            $q->where('disable_notify', '=', '0');
-                        }
-                    }
-                    if ($group_id) {
-                        $q->whereIn(
-                            $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
-                                $q->select('device_id')
-                                ->from('device_group_device')
-                                ->where('device_group_id', $group_id);
-                            }
-                        );
-                    }
-                },
-                "$remote_port_attr.device" => function ($q) use ($user, $disabled, $disabled_alerts, $group_id) {
-                    if (! $user->hasGlobalRead()) {
-                        $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
-                    }
-                    if (! is_null($disabled)) {
-                        if ($disabled) {
-                            $q->where('disabled', '<>', '0');
-                        } else {
-                            $q->where('disabled', '=', '0');
-                        }
-                    }
-                    if (! is_null($disabled_alerts)) {
-                        if ($disabled_alerts) {
-                            $q->where('disable_notify', '<>', '0');
-                        } else {
-                            $q->where('disable_notify', '=', '0');
-                        }
-                    }
-                    if ($group_id) {
-                        $q->whereIn(
-                            $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
-                                $q->select('device_id')
-                                ->from('device_group_device')
-                                ->where('device_group_id', $group_id);
-                            }
-                        );
-                    }
-                }])
-            ->whereHas($remote_port_attr);
-        if ($device_filter) {
-            $linkQuery->whereHas('device', function (Builder $q) use ($user, $disabled, $disabled_alerts, $group_id) {
-                if (! $user->hasGlobalRead()) {
-                    $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
-                }
-                if (! is_null($disabled)) {
-                    if ($disabled) {
-                        $q->where('disabled', '<>', '0');
-                    } else {
-                        $q->where('disabled', '=', '0');
-                    }
-                }
-                if (! is_null($disabled_alerts)) {
-                    if ($disabled_alerts) {
-                        $q->where('disable_notify', '<>', '0');
-                    } else {
-                        $q->where('disable_notify', '=', '0');
-                    }
-                }
-                if ($group_id) {
-                    $q->whereIn(
-                        $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
-                            $q->select('device_id')
-                            ->from('device_group_device')
-                            ->where('device_group_id', $group_id);
-                        }
-                    );
-                }
-            });
-            $linkQuery->whereHas("$remote_port_attr.device", function (Builder $q) use ($user, $disabled, $disabled_alerts, $group_id) {
-                if (! $user->hasGlobalRead()) {
-                    $q->whereIntegerInRaw('device_id', \Permissions::devicesForUser($user));
-                }
-                if (! is_null($disabled)) {
-                    if ($disabled) {
-                        $q->where('disabled', '<>', '0');
-                    } else {
-                        $q->where('disabled', '=', '0');
-                    }
-                }
-                if (! is_null($disabled_alerts)) {
-                    if ($disabled_alerts) {
-                        $q->where('disable_notify', '<>', '0');
-                    } else {
-                        $q->where('disable_notify', '=', '0');
-                    }
-                }
-                if ($group_id) {
-                    $q->whereIn(
-                        $q->qualifyColumn('device_id'), function ($q) use ($group_id) {
-                            $q->select('device_id')
-                            ->from('device_group_device')
-                            ->where('device_group_id', $group_id);
-                        }
-                    );
-                }
-            });
-        }
-        if ($device_id) {
-            $linkQuery->where(function ($q) use ($device_id, $remote_port_attr) {
-                $q->whereHas($remote_port_attr, function ($q) use ($device_id) {
-                    $q->where('device_id', $device_id);
-                })
-                    ->orWhereHas('device', function ($q) use ($device_id) {
-                        $q->where('device_id', $device_id);
-                    });
-            });
-        }
-        return $linkQuery->get();
-    }
-    protected static function deviceList(Request $request)
-    {
-        $group_id = $request->group;
-        $devices = $request->devices;
-        $valid_loc = $request->location_valid;
-        $disabled = $request->disabled;
-        $ignore = $request->ignore;
-        $disabled_alerts = $request->disabled_alerts;
-        $linkType = $request->link_type;
-        $statuses = $request->statuses;
-        $deviceQuery = Device::hasAccess($request->user())->with('location');
-        if ($group_id) {
-            $deviceQuery->inDeviceGroup($group_id);
-        }
-        if ($devices) {
-            $deviceQuery->whereIntegerInRaw('device_id', $devices);
-        }
-        if ($statuses && count($statuses) > 0) {
-            $deviceQuery->whereIn('status', $statuses);
-        }
-        if (! is_null($disabled)) {
-            if ($disabled) {
-                $deviceQuery->where('disabled', '<>', '0');
-            } else {
-                $deviceQuery->where('disabled', '=', '0');
-            }
-        }
-        if (! is_null($ignore)) {
-            if ($ignore) {
-                $deviceQuery->where('ignore', '<>', '0');
-            } else {
-                $deviceQuery->where('ignore', '=', '0');
-            }
-        }
-        if (! is_null($disabled_alerts)) {
-            if ($disabled_alerts) {
-                $deviceQuery->where('disable_notify', '<>', '0');
-            } else {
-                $deviceQuery->where('disable_notify', '=', '0');
-            }
-        }
-        if ($valid_loc) {
-            $deviceQuery->whereHas('location', function ($q) {
-                $q->whereNotNull('lng')
-                    ->whereNotNull('lat')
-                    ->where('lng', '<>', '')
-                    ->where('lat', '<>', '');
-            });
-        }
-        if (! $group_id) {
-            if ($linkType == 'depends') {
-                return $deviceQuery->with([
-                    'parents' => function ($q) use ($request) {
-                        $q->hasAccess($request->user());
-                    },
-                    'children' => function ($q) use ($request) {
-                        $q->hasAccess($request->user());
-                    }, ])
-                ->get();
-            } else {
-                return $deviceQuery->get();
-            }
-        }
-        if ($linkType == 'depends') {
-            return $deviceQuery->with([
-                'parents' => function ($q) use ($request, $group_id) {
-                    $q->hasAccess($request->user())
-                        ->inDeviceGroup($group_id);
-                },
-                'children' => function ($q) use ($request, $group_id) {
-                    $q->hasAccess($request->user())
-                        ->inDeviceGroup($group_id);
-                }, ])
-            ->get();
-        } else {
-            return $deviceQuery->get();
-        }
-    }
-    protected function linkSpeedWidth(int|null $speed): int
-    {
-        $speed /= 10000000;
-        if (is_nan($speed)) {
-            return 1;
-        }
-        if ($speed < 1) {
-            return 1;
-        }
-        return strlen(strval(round($speed))) * 2;
-    }
-    protected function linkUseColour(float $link_pct): string
-    {
-        $link_pct = round(2 * $link_pct, -1) / 2;
-        if ($link_pct > 100) {
-            $link_pct = 100;
-        }
-        if (is_nan($link_pct)) {
-            $link_pct = 0;
-        }
-        return Config::get("network_map_legend.$link_pct", '#000000');
-    }
-    protected function nodeDisabledStyle(): array
-    {
-        return [
-            'color' => [
-                'highlight' => [
-                    'background' => Config::get('network_map_legend.di.node'),
-                ],
-                'border' => Config::get('network_map_legend.di.border'),
-                'background' => Config::get('network_map_legend.di.node'),
-            ],
-            'borderWidth' => null,
-        ];
-    }
-    protected function nodeHighlightStyle(): array
-    {
-        return [
-            'color' => [
-                'highlight' => [
-                    'border' => Config::get('network_map_legend.highlight.border'),
-                ],
-                'border' => Config::get('network_map_legend.highlight.border'),
-            ],
-            'borderWidth' => Config::get('network_map_legend.highlight.borderWidth'),
-        ];
-    }
-    protected function nodeDownStyle(): array
-    {
-        return [
-            'color' => [
-                'highlight' => [
-                    'background' => Config::get('network_map_legend.dn.node'),
-                    'border' => Config::get('network_map_legend.dn.border'),
-                ],
-                'border' => Config::get('network_map_legend.dn.border'),
-                'background' => Config::get('network_map_legend.dn.node'),
-            ],
-            'borderWidth' => null,
-        ];
-    }
-    protected function nodeUpStyle(): array
-    {
-        return [
-            'color' => null,
-            'border' => null,
-            'background' => null,
-            'borderWidth' => null,
-        ];
-    }
-    protected function deviceStyle($device, $highlight_node = 0): array
-    {
-        if ($device->disabled) {
-            $device_style = $this->nodeDisabledStyle();
-        } elseif (! $device->status) {
-            $device_style = $device->disable_notify ? $this->nodeDisabledStyle() : $this->nodeDownStyle();
-        } else {
-            $device_style = $this->nodeUpStyle();
-        }
-        if ($device->device_id == $highlight_node) {
-            $device_style = array_merge($device_style, $this->nodeHighlightStyle());
-        }
-        return $device_style;
-    }
-    public function getDevices(Request $request): JsonResponse
-    {
-        $deviceIdsUnderMaintenance = AlertSchedule::isActive()
-            ->with([
-                'devices:device_id',
-                'locations.devices:location_id,device_id',
-                'deviceGroups.devices:device_id',
-            ])->get()
-            ->map(function ($schedule) {
-                return $schedule->devices->pluck('device_id')
-                    ->merge($schedule->locations->pluck('devices.*.device_id'))
-                    ->merge($schedule->deviceGroups->pluck('devices.*.device_id'));
-            })->flatten();
-        $no_parent_devices = collect();
-        $parent_peer_devices = collect();
-        $processed_devices = [];
-        $device_list = [];
-        foreach (self::deviceList($request) as $device) {
-            if ($device->status) {
-                $updowntime = \LibreNMS\Util\Time::formatInterval($device->uptime);
-            } elseif ($device->last_polled) {
-                $updowntime = \LibreNMS\Util\Time::formatInterval(time() - strtotime($device->last_polled));
-            } else {
-                $updowntime = '';
-            }
-            $device_list[$device->device_id] = [
-                'id' => $device->device_id,
-                'icon' => $device->icon,
-                'icontitle' => $device->icon ? str_replace(['.svg', '.png'], '', basename($device->icon)) : $device->os,
-                'sname' => $device->shortDisplayName(),
-                'status' => $device->status,
-                'uptime' => $device->uptime,
-                'updowntime' => $updowntime,
-                'last_polled' => $device->last_polled,
-                'disabled' => $device->disabled,
-                'no_alerts' => $device->disable_notify,
-                'url' => $request->url_type == 'links' ? Url::deviceLink($device, null, [], 0, 0, 0, 0) : Url::deviceUrl($device->device_id),
-                'style' => self::deviceStyle($device, $request->highlight_node),
-                'lat' => $device->location ? $device->location->lat : null,
-                'lng' => $device->location ? $device->location->lng : null,
-                'parents' => ($request->link_type == 'depends') ? $device->parents->pluck('device_id', 'device_id') : collect(),
-                'children' => ($request->link_type == 'depends') ? $device->children->pluck('device_id', 'device_id') : collect(),
-                'maintenance' => $deviceIdsUnderMaintenance->contains($device->device_id) ? 1 : 0,
-            ];
-            $parent_ids = $device_list[$device->device_id]['parents'];
-            if (! $parent_ids->count()) {
-                $no_parent_devices->put($device->device_id, $device->device_id);
-            } else {
-                $parent_only_ids = $parent_ids;
-                if ($device->children->count()) {
-                    $child_ids = $device_list[$device->device_id]['children'];
-                    $parent_only_ids = $parent_only_ids->filter(function (int $parent_id, int $k) use ($child_ids) {
-                        return ! $child_ids->has($parent_id);
-                    });
-                }
-                if (! $parent_only_ids->count()) {
-                    $parent_peer_devices->put($device->device_id, $device->device_id);
-                }
-            }
-        }
-        if ($request->link_type == 'depends') {
-            $top_level_check = [$no_parent_devices, $parent_peer_devices];
-            foreach ($top_level_check as $next_level_devices) {
-                $this_level = 0;
-                while ($next_level_devices->count()) {
-                    $this_level_devices = $next_level_devices;
-                    $next_level_devices = collect();
-                    foreach ($this_level_devices->keys() as $device_id) {
-                        if (! array_key_exists($device_id, $device_list)) {
-                            continue;
-                        }
-                        if (array_key_exists($device_id, $processed_devices)) {
-                            continue;
-                        }
-                        $device_record = $device_list[$device_id];
-                        if ($request->highlight_node == -1 && $device_record['children']->count() === 0 && $device_record['parents']->count() == 0) {
-                            $device_list[$device_id]['style'] = array_merge($device_list[$device_id]['style'], $this->nodeHighlightStyle());
-                        }
-                        $device_list[$device_id]['level'] = $this_level;
-                        $processed_devices[$device_id] = true;
-                        $next_level_devices = $next_level_devices->union($device_list[$device_id]['children']);
-                    }
-                    $this_level++;
-                }
-            }
-            foreach (array_keys($device_list) as $device_id) {
-                if (! array_key_exists('level', $device_list[$device_id])) {
-                    $device_list[$device_id]['level'] = 0;
-                }
-            }
-            if ($request->showpath > 0 && $request->highlight_node > 0) {
-                $processed_parents = [];
-                $this_parents = $device_list[$request->highlight_node]['parents'];
-                while ($this_parents->count() > 0) {
-                    $next_parents = collect();
-                    foreach ($this_parents as $parent_id) {
-                        if (array_key_exists($parent_id, $processed_parents)) {
-                            continue;
-                        }
-                        $processed_parents[$parent_id] = true;
-                        $device_list[$parent_id]['style'] = array_merge($device_list[$parent_id]['style'], $this->nodeHighlightStyle());
-                        $next_parents = $next_parents->union($device_list[$parent_id]['parents']);
-                    }
-                    $this_parents = $next_parents;
-                }
-            } elseif ($request->showpath < 0 && $request->highlight_node > 0) {
-                $processed_children = [];
-                $this_children = $device_list[$request->highlight_node]['children'];
-                while ($this_children->count() > 0) {
-                    $next_children = collect();
-                    foreach ($this_children as $child_id) {
-                        if (! array_key_exists($child_id, $device_list)) {
-                            continue;
-                        }
-                        if (array_key_exists($child_id, $processed_children)) {
-                            continue;
-                        }
-                        $processed_children[$child_id] = true;
-                        $device_list[$child_id]['style'] = array_merge($device_list[$child_id]['style'], $this->nodeHighlightStyle());
-                        $next_children = $next_children->union($device_list[$child_id]['children']);
-                    }
-                    $this_children = $next_children;
-                }
-            }
-        }
-        return response()->json($device_list);
-    }
-    public function getDeviceLinks(Request $request): JsonResponse
-    {
-        $link_list = [];
-        $port_assoc_seen = [];
-        $link_types = $request->link_types;
-        foreach ($link_types as $link_type) {
-            if ($link_type == 'mac') {
-                $remote_port_attr = 'macLinkedPorts';
-            } elseif ($link_type == 'xdp') {
-                $remote_port_attr = 'xdpLinkedPorts';
-            } else {
-                Log::error("Link types of $link_type are not supported");
-                abort(500);
-            }
-            foreach (self::portsWithLinks($request, $remote_port_attr) as $port) {
-                if (! $port->device) {
-                    continue;
-                }
-                foreach ($port->{$remote_port_attr} as $remote_port) {
-                    if (! $remote_port->device) {
-                        continue;
-                    }
-                    if ($port->port_id < $remote_port->port_id) {
-                        $port_ids = $port->port_id . '.' . $remote_port->port_id;
-                    } else {
-                        $port_ids = $remote_port->port_id . '.' . $port->port_id;
-                    }
-                    if (array_key_exists($port_ids, $port_assoc_seen)) {
-                        continue;
-                    }
-                    $port_assoc_seen[$port_ids] = true;
-                    $width = $this->linkSpeedWidth($port->ifSpeed);
-                    if ($port->device->status == 0 && $remote_port->device->status == 0) {
-                        $link_style = [
-                            'dashes' => [8, 12],
-                            'width' => $width,
-                            'color' => [
-                                'border' => Config::get('network_map_legend.dn.border'),
-                                'highlight' => Config::get('network_map_legend.dn.edge'),
-                                'color' => Config::get('network_map_legend.dn.edge'),
-                            ],
-                        ];
-                    } elseif ($port->ifOperStatus == 'down' || $remote_port->ifOperStatus == 'down') {
-                        $link_style = [
-                            'dashes' => [8, 12],
-                            'width' => $width,
-                            'color' => [
-                                'border' => Config::get('network_map_legend.dn.border'),
-                                'highlight' => Config::get('network_map_legend.dn.edge'),
-                                'color' => Config::get('network_map_legend.dn.edge'),
-                            ],
-                        ];
-                    } else {
-                        if ($port->ifSpeed > 0) {
-                            $link_in_usage_pct = $port->ifInOctets_rate * 8 / $port->ifSpeed * 100;
-                            $link_out_usage_pct = $port->ifOutOctets_rate * 8 / $port->ifSpeed * 100;
-                            $link_used = max($link_out_usage_pct, $link_in_usage_pct);
-                        } else {
-                            $link_used = 0;
-                        }
-                        $link_color = $this->linkUseColour($link_used);
-                        $link_style = [
-                            'width' => $width,
-                            'color' => [
-                                'border' => $link_color,
-                                'highlight' => $link_color,
-                                'color' => $link_color,
-                            ],
-                        ];
-                    }
-                    $link_list[$port->port_id . '.' . $remote_port->port_id] = [
-                        'ldev' => $port->device_id,
-                        'rdev' => $remote_port->device_id,
-                        'ifnames' => $port->ifName . ' <> ' . $remote_port->ifName,
-                        'url' => Url::portLink($port, null, null, false, true),
-                        'style' => $link_style,
-                    ];
-                }
-            }
-        }
-        return response()->json($link_list);
-    }
-    public function getGeographicLinks(Request $request): JsonResponse
-    {
-        $link_list = [];
-        foreach (self::geoLinks($request) as $location) {
-            $link = $location[0];
-            $capacity = $location->sum(function (Link $l) {
-                return $l->port->ifSpeed;
-            });
-            $inRate = $location->sum(function (Link $l) {
-                return $l->port->ifInOctets_rate * 8;
-            });
-            $outRate = $location->sum(function (Link $l) {
-                return $l->port->ifOutOctets_rate * 8;
-            });
-            if ($capacity > 0) {
-                $link_used = max($inRate / $capacity * 100, $outRate / $capacity * 100);
-            } elseif ($inRate > 0 || $outRate > 0) {
-                $link_used = 100;
-            } else {
-                $link_used = 0;
-            }
-            $width = $this->linkSpeedWidth($capacity);
-            $link_color = $this->linkUseColour($link_used);
-            $link_list[$link->device->location_id . '.' . $link->remoteDevice->location_id] = [
-                'local_lat' => $link->device->location->lat,
-                'local_lng' => $link->device->location->lng,
-                'remote_lat' => $link->remoteDevice->location->lat,
-                'remote_lng' => $link->remoteDevice->location->lng,
-                'color' => $link_color,
-                'width' => $width,
-            ];
-        }
-        return response()->json($link_list);
-    }
-    public function getServices(Request $request): JsonResponse
-    {
-        $group_id = $request->device_group;
-        $services = Service::hasAccess($request->user())->with('device');
-        if ($group_id) {
-            $services->inDeviceGroup($group_id);
-        }
-        $service_list = [];
-        foreach ($services->get() as $service) {
-            if ($service->device->status) {
-                $updowntime = \LibreNMS\Util\Time::formatInterval($service->device->uptime);
-            } elseif ($service->device->last_polled) {
-                $updowntime = \LibreNMS\Util\Time::formatInterval(time() - strtotime($service->device->last_polled));
-            } else {
-                $updowntime = '';
-            }
-            $service_list[] = [
-                'id' => $service->service_id,
-                'name' => $service->service_name,
-                'type' => $service->service_type,
-                'status' => $service->service_status,
-                'icon' => $service->device->icon,
-                'icontitle' => $service->device->icon ? str_replace(['.svg', '.png'], '', basename($service->device->icon)) : $service->device->os,
-                'device_name' => $service->device->shortDisplayName(),
-                'url' => Url::deviceUrl($service->device_id),
-                'updowntime' => $updowntime,
-                'compact' => Config::get('webui.availability_map_compact'),
-                'box_size' => Config::get('webui.availability_map_box_size'),
-            ];
-        }
-        return response()->json($service_list);
-    }
-}

--- a/app/Http/Controllers/Maps/NetMapController.php
+++ b//dev/null
@@ -1,50 +0,0 @@
-<?php
-/**
- * NetMapController.php
- *
- * Controller for dynamic network map base page
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2023 Steven Wilton
- * @author     Steven Wilton <swilton@fluentit.com.au>
- */
-namespace App\Http\Controllers\Maps;
-use App\Http\Controllers\Controller;
-use App\Models\DeviceGroup;
-use Illuminate\Http\Request;
-use Illuminate\View\View;
-use LibreNMS\Config;
-use LibreNMS\Util\Url;
-class NetMapController extends Controller
-{
-    public function netMap(Request $request, $vars = ''): View
-    {
-        $group_id = Url::parseOptions('group');
-        $group_name = DeviceGroup::where('id', '=', $group_id)->first('name');
-        if (! empty($group_name)) {
-            $group_name = $group_name->name;
-        }
-        $data = [
-            'page_refresh' => Config::get('page_refresh', 300),
-            'group_id' => $group_id,
-            'options' => Config::get('network_map_vis_options'),
-            'group_name' => $group_name,
-            'link_types' => Config::get('network_map_items', ['xdp', 'mac']),
-        ];
-        return view('map.netmap', $data);
-    }
-}

--- a/app/Http/Controllers/Select/CustomMapController.php
+++ b//dev/null
@@ -1,41 +0,0 @@
-<?php
-/*
- * CustomMapController.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- * @package    LibreNMS
- * @link       http://librenms.org
- * @copyright  2024 Steven Wilton
- * @author     Steven Wilton <swilton@fluentit.com.au>
- */
-namespace App\Http\Controllers\Select;
-use App\Models\CustomMap;
-use Illuminate\Database\Eloquent\Builder;
-use Illuminate\Http\Request;
-class CustomMapController extends SelectController
-{
-    protected function searchFields($request): array
-    {
-        return ['custom_map_id', 'name'];
-    }
-    protected function baseQuery(Request $request): Builder
-    {
-        return CustomMap::query()->hasAccess($request->user())
-            ->select('custom_map_id', 'name')
-            ->orderBy('name');
-    }
-}

--- a/app/Http/Controllers/Table/DeviceController.php
+++ b/app/Http/Controllers/Table/DeviceController.php
@@ -78,23 +78,21 @@
     }
     /**
      * Defines the base query for this resource
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Database\Eloquent\Builder|\Illuminate\Database\Query\Builder
      */
     protected function baseQuery($request)
     {
         /** @var Builder $query */
-        $query = Device::hasAccess($request->user())
-            ->with(['location', 'groups'])
-            ->withCount(['ports', 'sensors', 'wirelessSensors']);
+        $query = Device::hasAccess($request->user())->with('location')->withCount(['ports', 'sensors', 'wirelessSensors']);
         if ($request->get('searchPhrase') || in_array('location', array_keys($request->get('sort', [])))) {
             $query->leftJoin('locations', 'locations.id', 'devices.location_id');
         }
         if ($group = $request->get('group')) {
             if ($group == 'none') {
                 $query->whereDoesntHave('groups');
             } else {
                 $query->whereHas('groups', function ($query) use ($group) {
                     $query->where('id', $group);
                 });

--- a/app/Http/Controllers/Table/EditPortsController.php
+++ b/app/Http/Controllers/Table/EditPortsController.php
@@ -52,28 +52,28 @@
      */
     public function formatItem($port)
     {
         $is_port_bad = $port->ifAdminStatus != 'down' && $port->ifOperStatus != 'up';
         $do_we_care = ($port->ignore || $port->disabled) ? false : $is_port_bad;
         $out_of_sync = $do_we_care ? "class='red'" : '';
         $tune = $port->device->getAttrib('ifName_tune:' . $port->ifName) == 'true' ? 'checked' : '';
         $port_group_options = '';
         foreach ($port->groups as $group) {
             /** @var \App\Models\PortGroup $group */
-            $port_group_options .= '<option value="' . $group->id . '" selected>' . htmlentities($group->name) . '</option>';
+            $port_group_options .= '<option value="' . $group->id . '" selected>' . $group->name . '</option>';
         }
         return [
             'ifIndex' => $port->ifIndex,
-            'ifName' => htmlentities($port->getLabel()),
-            'ifAdminStatus' => htmlentities($port->ifAdminStatus),
-            'ifOperStatus' => '<span id="operstatus_' . $port->port_id . '" ' . $out_of_sync . '>' . htmlentities($port->ifOperStatus) . '</span>',
+            'ifName' => $port->getLabel(),
+            'ifAdminStatus' => $port->ifAdminStatus,
+            'ifOperStatus' => '<span id="operstatus_' . $port->port_id . '" ' . $out_of_sync . '>' . $port->ifOperStatus . '</span>',
             'disabled' => '<input type="checkbox" class="disable-check" data-size="small" name="disabled_' . $port->port_id . '"' . ($port->disabled ? 'checked' : '') . '>
                                <input type="hidden" name="olddis_' . $port->port_id . '" value="' . ($port->disabled ? 1 : 0) . '"">',
             'ignore' => '<input type="checkbox" class="ignore-check" data-size="small" name="ignore_' . $port->port_id . '"' . ($port->ignore ? 'checked' : '') . '>
                                <input type="hidden" name="oldign_' . $port->port_id . '" value="' . ($port->ignore ? 1 : 0) . '"">',
-            'port_tune' => '<input type="checkbox" name="override_config" data-attrib="ifName_tune:' . htmlentities($port->ifName) . '" data-device_id="' . $port->device_id . '" data-size="small" ' . $tune . '>',
-            'ifAlias' => '<div class="form-group"><input class="form-control input-sm" name="if-alias" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . htmlentities($port->ifName) . '" value="' . htmlentities($port->ifAlias) . '"><span class="form-control-feedback"><i class="fa" aria-hidden="true"></i></span></div>',
-            'ifSpeed' => '<div class="form-group has-feedback"><input type="text" pattern="[0-9]*" inputmode="numeric" class="form-control input-sm" name="if-speed" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . htmlentities($port->ifName) . '" value="' . $port->ifSpeed . '"><span class="form-control-feedback"><i class="fas" aria-hidden="true"></i></span></div>',
+            'port_tune' => '<input type="checkbox" name="override_config" data-attrib="ifName_tune:' . $port->ifName . '" data-device_id="' . $port->device_id . '" data-size="small" ' . $tune . '>',
+            'ifAlias' => '<div class="form-group"><input class="form-control input-sm" name="if-alias" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . $port->ifName . '" value="' . $port->ifAlias . '"><span class="form-control-feedback"><i class="fa" aria-hidden="true"></i></span></div>',
+            'ifSpeed' => '<div class="form-group has-feedback"><input type="text" pattern="[0-9]*" inputmode="numeric" class="form-control input-sm" name="if-speed" data-device_id="' . $port->device_id . '" data-port_id="' . $port->port_id . '" data-ifName="' . $port->ifName . '" value="' . $port->ifSpeed . '"><span class="form-control-feedback"><i class="fas" aria-hidden="true"></i></span></div>',
             'portGroup' => '<div class="form-group has-feedback"><select class="input-sm port_group_select" name="port_group_' . $port->port_id . '[]"  data-port_id="' . $port->port_id . '" multiple>' . $port_group_options . '</select></div>',
         ];
     }
 }

--- a/app/Http/Controllers/Table/GraylogController.php
+++ b/app/Http/Controllers/Table/GraylogController.php
@@ -64,26 +64,25 @@
         $query = $api->buildSimpleQuery($search, $device) .
             ($loglevel !== null ? ' AND level: <=' . $loglevel : '');
         $sort = null;
         foreach ($request->get('sort', []) as $field => $direction) {
             $sort = "$field:$direction";
         }
         $stream = $request->get('stream');
         $filter = $stream ? "streams:$stream" : null;
         try {
             $data = $api->query($query, $range, $limit, $offset, $sort, $filter);
-            $messages = $data['messages'] ?? [];
             return $this->formatResponse(
-                array_map([$this, 'formatMessage'], $messages),
+                array_map([$this, 'formatMessage'], $data['messages']),
                 $page,
-                count($messages),
-                $data['total_results'] ?? 0,
+                count($data['messages']),
+                $data['total_results']
             );
         } catch (\Exception $se) {
             $error = $se->getMessage();
         }
         return response()->json([
             'error' => $error,
         ], 500);
     }
     private function formatMessage($message)
     {

--- a/app/Http/Controllers/Table/MempoolsController.php
+++ b/app/Http/Controllers/Table/MempoolsController.php
@@ -41,22 +41,21 @@
         return ['mempool_descr', 'mempool_perc', 'mempool_used', 'hostname'];
     }
     /**
      * @inheritdoc
      */
     protected function baseQuery($request)
     {
         if ($request->get('view') == 'graphs') {
             return Device::hasAccess($request->user())->has('mempools')->with('mempools');
         }
-        $query = Mempool::hasAccess($request->user())
-            ->with(['device', 'device.location']);
+        $query = Mempool::hasAccess($request->user())->with('device');
         if (array_key_exists('hostname', $request->get('sort', $this->default_sort)) || $request->get('searchPhrase')) {
             $query->join('devices', 'mempools.device_id', 'devices.device_id')
                 ->select('mempools.*');
         }
         return $query;
     }
     /**
      * @param  Device|Mempool  $mempool
      */
     public function formatItem($mempool)

--- a/app/Http/Controllers/Table/PortsController.php
+++ b/app/Http/Controllers/Table/PortsController.php
@@ -91,21 +91,21 @@
             'ifOutUcastPkts_rate',
             'ifType',
             'ifAlias',
             'ifMtu',
             'ifSpeed',
         ];
     }
     protected function baseQuery($request)
     {
         $query = Port::hasAccess($request->user())
-            ->with(['device', 'device.location'])
+            ->with('device')
             ->leftJoin('devices', 'ports.device_id', 'devices.device_id')
             ->where('deleted', $request->get('deleted', 0)) // always filter deleted
             ->when($request->get('hostname'), function (Builder $query, $hostname) {
                 $query->where(function (Builder $query) use ($hostname) {
                     $query->where('devices.hostname', 'like', "%$hostname%")
                         ->orWhere('devices.sysName', 'like', "%$hostname%");
                 });
             })
             ->when($request->get('ifAlias'), function (Builder $query, $ifAlias) {
                 return $query->where('ifAlias', 'like', "%$ifAlias%");

--- a/app/Http/Controllers/Table/VlanDevicesController.php
+++ b/app/Http/Controllers/Table/VlanDevicesController.php
@@ -16,21 +16,20 @@
             'type' => 'vlans.vlan_type',
             'mtu' => 'vlans.vlan_mtu',
         ];
     }
     private int $vlanId;
     protected function baseQuery(Request $request)
     {
         $this->validate($request, ['vlan' => 'integer']);
         $this->vlanId = $request->get('vlan', 1);
         return Device::distinct()
-            ->with('location')
             ->select([
                 'devices.*',
                 'vlans.vlan_name',
                 'vlans.vlan_type',
                 'vlans.vlan_mtu',
             ])
             ->withCount(['ports' => function ($query) {
                 $query->distinct()->where('ifVlan', $this->vlanId)
                     ->orWhereHas('vlans', fn ($q) => $q->where('vlan', $this->vlanId));
             }])

--- a/app/Http/Controllers/Table/VlanPortsController.php
+++ b/app/Http/Controllers/Table/VlanPortsController.php
@@ -1,46 +1,38 @@
 <?php
 namespace App\Http\Controllers\Table;
 use App\Models\Port;
 use Illuminate\Database\Eloquent\Builder;
 use Illuminate\Http\Request;
 use Illuminate\Support\Facades\DB;
 use LibreNMS\Util\Url;
 class VlanPortsController extends TableController
 {
-    protected function searchFields(Request $request): array
-    {
-        return [
-            'ifName',
-            'ifDescr',
-            'ifAlias',
-        ];
-    }
     protected function sortFields($request): array
     {
         return [
             'device' => 'device_id',
             'port' => 'port_id',
             'untagged',
             'state' => 'ports_vlans.state',
             'cost' => 'ports_vlans.cost',
         ];
     }
     private int $vlanId;
     protected function baseQuery(Request $request): Builder
     {
         $this->validate($request, ['vlan' => 'integer']);
         $this->vlanId = $request->get('vlan', 1);
-        return Port::with(['device', 'device.location'])
+        return Port::with('device')
             ->leftJoin('ports_vlans', 'ports.port_id', 'ports_vlans.port_id')
             ->where(function ($query) {
-                $query->where(fn ($q) => $q->where('ifVlan', $this->vlanId)->whereNull('ports_vlans.vlan'))
+                $query->where('ifVlan', $this->vlanId)
                     ->orWhere('ports_vlans.vlan', $this->vlanId);
             })
             ->select([
                 'ports.port_id',
                 'ports.device_id',
                 'ports.ifName',
                 'ports.ifIndex',
                 'ports.ifDescr',
                 'ports.ifAlias',
                 'ports.ifVlan',
@@ -52,17 +44,17 @@
                 DB::raw("CASE WHEN ports.ifVlan = $this->vlanId or ports_vlans.untagged <> 0 THEN \"yes\" ELSE \"no\" END as untagged"),
             ]);
     }
     /**
      * @param  Port  $model
      */
     public function formatItem($model): array
     {
         return [
             'device' => Url::deviceLink($model->device),
-            'port' => Url::portLink($model, $model->getFullLabel()),
+            'port' => Url::portLink($model),
             'untagged' => $model['untagged'],
             'state' => $model['state'],
             'cost' => $model['cost'],
         ];
     }
 }

--- a/app/Http/Controllers/Widgets/CustomMapController.php
+++ b//dev/null
@@ -1,61 +0,0 @@
-<?php
-/**
- * CustomMapController.php
- *
- * -Description-
- *
- * This program is free software: you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation, either version 3 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <https://www.gnu.org/licenses/>.
- *
- * @link       https://www.librenms.org
- *
- * @copyright  2024 Steven Wilton
- * @author     Steven Wilton <swilton@fluentit.com.au>
- */
-namespace App\Http\Controllers\Widgets;
-use App\Models\CustomMap;
-use Illuminate\Http\Request;
-use LibreNMS\Config;
-class CustomMapController extends WidgetController
-{
-    protected $title = 'Custom Map';
-    protected $defaults = [
-        'title' => null,
-        'custom_map' => null,
-    ];
-    public function __construct()
-    {
-        $this->authorizeResource(CustomMap::class, 'map');
-    }
-    public function getView(Request $request)
-    {
-        $data = $this->getSettings(true);
-        $data['map'] = CustomMap::find($data['custom_map']);
-        if (! $data['map']) {
-            return __('map.custom.widget.not_found');
-        }
-        $data['base_url'] = Config::get('base_url');
-        $data['background_config'] = $data['map']->getBackgroundConfig();
-        $data['map_conf'] = $data['map']->options;
-        $scalex = (float) $request->dimensions['x'] / (float) $data['map']->width;
-        $scaley = (float) $request->dimensions['y'] / (float) $data['map']->height;
-        $data['scale'] = min($scalex, $scaley);
-        return view('widgets.custom-map', $data);
-    }
-    public function getSettingsView(Request $request)
-    {
-        $data = $this->getSettings(true);
-        $data['map'] = CustomMap::find($data['custom_map']);
-        return view('widgets.settings.custom-map', $data);
-    }
-}

--- a/app/Http/Controllers/Widgets/WorldMapController.php
+++ b/app/Http/Controllers/Widgets/WorldMapController.php
@@ -16,22 +16,25 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program.  If not, see <https://www.gnu.org/licenses/>.
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2018 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace App\Http\Controllers\Widgets;
+use App\Models\Device;
+use Illuminate\Http\JsonResponse;
 use Illuminate\Http\Request;
 use LibreNMS\Config;
+use LibreNMS\Util\Url;
 class WorldMapController extends WidgetController
 {
     protected $title = 'World Map';
     public function __construct()
     {
         $this->defaults = [
             'title' => null,
             'init_lat' => Config::get('leaflet.default_lat'),
             'init_lng' => Config::get('leaflet.default_lng'),
             'init_zoom' => Config::get('leaflet.default_zoom'),
@@ -50,15 +53,52 @@
             'engine' => Config::get('geoloc.engine'),
             'api_key' => Config::get('geoloc.api_key'),
             'tile_url' => Config::get('leaflet.tile_url'),
             'lat' => $settings['init_lat'],
             'lng' => $settings['init_lng'],
             'zoom' => $settings['init_zoom'],
             'layer' => $settings['init_layer'],
         ];
         return view('widgets.worldmap', $settings);
     }
+    public function getData(Request $request): JsonResponse
+    {
+        $this->validate($request, [
+            'status' => 'array',
+            'status.*' => 'int',
+            'device_group' => 'int',
+        ]);
+        return response()->json($this->getMarkerData($request, $request->status ?? [0, 1], $request->device_group ?? 0));
+    }
+    public function getMarkerData(Request $request, array $status, int $device_group_id): array
+    {
+        return Device::hasAccess($request->user())
+            ->with('location')
+            ->isActive()
+            ->whereIn('status', $status)
+            ->when($device_group_id, fn ($q) => $q->inDeviceGroup($device_group_id))
+            ->get()
+            ->filter(function ($device) use ($status) {
+                /** @var Device $device */
+                if (! ($device->location_id && $device->location && $device->location->coordinatesValid())) {
+                    return false;
+                }
+                if ($status == [0] && $device->isUnderMaintenance()) {
+                    return false;
+                }
+                return true;
+            })->map(function (Device $device) {
+                return [
+                    'name' => $device->displayName(),
+                    'lat' => $device->location->lat,
+                    'lng' => $device->location->lng,
+                    'icon' => $device->icon,
+                    'url' => Url::deviceUrl($device),
+                    'status' => (int) ($device->status ?: ($device->isUnderMaintenance() ? 3 : 0)),
+                ];
+            })->values()->all();
+    }
     public function getSettingsView(Request $request)
     {
         return view('widgets.settings.worldmap', $this->getSettings(true));
     }
 }

--- a/app/Http/Requests/CustomMapSettingsRequest.php
+++ b/app/Http/Requests/CustomMapSettingsRequest.php
@@ -41,13 +41,19 @@
                 function (string $attribute, mixed $value, Closure $fail) {
                     if (! preg_match('/^(\d+)(px|%)$/', $value, $matches)) {
                         $fail(__('map.custom.edit.validate.height_format'));
                     } elseif ($matches[2] == 'px' && $matches[1] < 200) {
                         $fail(__('map.custom.edit.validate.height_pixels'));
                     } elseif ($matches[2] == '%' && ($matches[1] < 10 || $matches[1] > 100)) {
                         $fail(__('map.custom.edit.validate.height_percent'));
                     }
                 },
             ],
+            'legend_x' => 'integer',
+            'legend_y' => 'integer',
+            'legend_steps' => 'integer',
+            'legend_font_size' => 'integer',
+            'legend_hide_invalid' => 'boolean',
+            'legend_hide_overspeed' => 'boolean',
         ];
     }
 }

--- a/app/Http/ViewComposers/MenuComposer.php
+++ b/app/Http/ViewComposers/MenuComposer.php
@@ -62,21 +62,20 @@
         $user = Auth::user();
         $site_style = Config::get('applied_site_style');
         $vars['hide_dashboard_editor'] = UserPref::getPref($user, 'hide_dashboard_editor');
         $vars['navbar'] = in_array($site_style, ['mono']) ? 'navbar-inverse' : '';
         $vars['project_name'] = Config::get('project_name', 'LibreNMS');
         $vars['title_image'] = Config::get('title_image', "images/librenms_logo_$site_style.svg");
         $vars['dashboards'] = Dashboard::select('dashboard_id', 'dashboard_name')->allAvailable($user)->orderBy('dashboard_name')->get();
         $vars['device_groups'] = DeviceGroup::hasAccess($user)->orderBy('name')->get(['device_groups.id', 'name', 'desc']);
         $vars['package_count'] = Package::hasAccess($user)->count();
         $vars['device_types'] = Device::hasAccess($user)->select('type')->distinct()->where('type', '!=', '')->orderBy('type')->pluck('type');
-        $vars['no_devices_added'] = ! Device::hasAccess($user)->exists();
         $vars['locations'] = (Config::get('show_locations') && Config::get('show_locations_dropdown')) ?
             Location::hasAccess($user)->where('location', '!=', '')->orderBy('location')->get(['location', 'id']) :
             new Collection();
         $vars['show_vmwinfo'] = Vminfo::hasAccess($user)->exists();
         $vars['links'] = Link::exists();
         $vars['device_dependencies'] = \DB::table('device_relationships')->exists();
         $vars['device_group_dependencies'] = $vars['device_groups']->isNotEmpty() && \DB::table('device_group_device')->exists();
         $vars['custommaps'] = CustomMap::select(['custom_map_id', 'name', 'menu_group'])->hasAccess($user)->orderBy('name')->get()->groupBy('menu_group')->sortKeys();
         if (Config::get('show_services')) {
             $vars['service_counts'] = ObjectCache::serviceCounts(['warning', 'critical']);

--- a/app/Jobs/PingCheck.php
+++ b/app/Jobs/PingCheck.php
@@ -23,185 +23,173 @@
  * @author     Tony Murray <murraytony@gmail.com>
  */
 namespace App\Jobs;
 use App\Models\Device;
 use Illuminate\Bus\Queueable;
 use Illuminate\Contracts\Queue\ShouldQueue;
 use Illuminate\Foundation\Bus\Dispatchable;
 use Illuminate\Queue\InteractsWithQueue;
 use Illuminate\Queue\SerializesModels;
 use Illuminate\Support\Collection;
-use Illuminate\Support\Facades\Log;
 use LibreNMS\Alert\AlertRules;
 use LibreNMS\Data\Source\Fping;
 use LibreNMS\Data\Source\FpingResponse;
+use LibreNMS\Util\Debug;
 class PingCheck implements ShouldQueue
 {
     use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;
-    /** @var Collection<string, Device> List of devices keyed by hostname */
-    private Collection $devices;
+    /** @var \Illuminate\Database\Eloquent\Collection<string, Device>|null List of devices keyed by hostname */
+    private $devices;
     /** @var array List of device group ids to check */
-    private array $groups = [];
+    private $groups = [];
     /** @var Collection */
-    private Collection $deferred;
-    /** @var Collection<int, Collection<int, bool>> device id, parent devices */
-    private Collection $waiting_on;
-    /** @var Collection<int, bool> */
-    private Collection $processed;
+    private $tiered;
+    /** @var Collection */
+    private $current;
+    private $current_tier;
+    /** @var Collection */
+    private $deferred;
     /**
      * Create a new job instance.
      *
      * @param  array  $groups  List of distributed poller groups to check
      */
-    public function __construct(array $groups = [])
+    public function __construct($groups = [])
     {
-        $this->groups = $groups;
-        $this->deferred = new Collection;
-        $this->waiting_on = new Collection;
-        $this->processed = new Collection;
+        if (is_array($groups)) {
+            $this->groups = $groups;
+        }
     }
     /**
      * Execute the job.
      *
      * @return void
      */
     public function handle(): void
     {
         $ping_start = microtime(true);
-        $ordered_hostname_list = $this->orderHostnames($this->fetchDevices());
-        Log::info('Processing hosts in this order : ' . implode(', ', $ordered_hostname_list));
-        app()->make(Fping::class)->bulkPing($ordered_hostname_list, [$this, 'handleResponse']);
+        $this->fetchDevices();
+        $ordered_device_list = $this->tiered->get(1, collect())->keys()// root nodes before standalone nodes
+        ->merge($this->devices->keys())
+            ->unique()->all();
+        app()->make(Fping::class)->bulkPing($ordered_device_list, [$this, 'handleResponse']);
         if ($this->deferred->isNotEmpty()) {
-            Log::debug("Leftover deferred devices, this shouldn't happen: " . $this->deferred->keys()->implode(', '));
-        }
-        if ($this->waiting_on->isNotEmpty()) {
-            Log::debug("Leftover waiting on devices, this shouldn't happen: " . $this->waiting_on->keys()->implode(', '));
+            d_echo("Leftover devices, this shouldn't happen: " . $this->deferred->flatten(1)->implode('hostname', ', ') . PHP_EOL);
+            d_echo('Devices left in tier: ' . collect($this->current)->implode('hostname', ', ') . PHP_EOL);
         }
         if (\App::runningInConsole()) {
             printf("Pinged %s devices in %.2fs\n", $this->devices->count(), microtime(true) - $ping_start);
         }
     }
-    /**
-     * Get an ordered list of hostnames that we need to ping starting from devices with no parents
-     */
-    private function orderHostnames(Collection $devices): array
-    {
-        $ordered_device_list = new Collection;
-        [$current_tier_devices, $pending_children] = $devices->keyBy('device_id')->partition(fn (Device $d) => $d->parents_count === 0);
-        while ($current_tier_devices->isNotEmpty()) {
-            $ordered_device_list = $ordered_device_list->merge($current_tier_devices);
-            $current_tier_devices = $current_tier_devices
-                ->pluck('children.*.device_id')->flatten() // get all direct child ids
-                ->map(fn ($child_id) => $pending_children->pull($child_id)) // fetch and remove the device from pending if it exists
-                ->filter(); // filter out children that are already in the list
-        }
-        $ordered_device_list = $ordered_device_list->merge($pending_children);
-        return $ordered_device_list->map(fn (Device $device) => $device->overwrite_ip ?: $device->hostname)->all();
-    }
-    /**
-     * Fetch and cache all devices that we need to process
-     */
-    private function fetchDevices(): Collection
+    private function fetchDevices()
     {
         if (isset($this->devices)) {
             return $this->devices;
         }
         $query = Device::canPing()
-            ->select(['devices.device_id', 'hostname', 'overwrite_ip', 'status', 'status_reason', 'last_ping', 'last_ping_timetaken'])
-            ->with([
-                'parents' => function ($q) {
-                    $q->canPing()->select('devices.device_id');
-                },
-                'children' => function ($q) {
-                    $q->canPing()->select('devices.device_id');
-                },
-            ])
-            ->withCount('parents');
+            ->select(['devices.device_id', 'hostname', 'overwrite_ip', 'status', 'status_reason', 'last_ping', 'last_ping_timetaken', 'max_depth'])
+            ->orderBy('max_depth');
         if ($this->groups) {
             $query->whereIntegerInRaw('poller_group', $this->groups);
         }
         $this->devices = $query->get()->keyBy(function ($device) {
             return $device->overwrite_ip ?: $device->hostname;
         });
+        $this->tiered = $this->devices->groupBy('max_depth', true);
+        $this->deferred = new Collection();
+        $this->current_tier = 1;
+        $this->current = $this->tiered->get($this->current_tier, collect());
+        if (Debug::isVerbose()) {
+            $this->tiered->each(function (Collection $tier, $index) {
+                echo "Tier $index (" . $tier->count() . '): ';
+                echo $tier->implode('hostname', ', ');
+                echo PHP_EOL;
+            });
+        }
         return $this->devices;
     }
     /**
-     * Record the data and run alerts if all parents have been processed
+     * Check if this tier is complete and move to the next tier
+     * If we moved to the next tier, check if we can report any of our deferred results
+     */
+    private function processTier()
+    {
+        if ($this->current->isNotEmpty()) {
+            return;
+        }
+        $this->current_tier++;  // next tier
+        if (! $this->tiered->has($this->current_tier)) {
+            return;
+        }
+        if (Debug::isVerbose()) {
+            echo "Out of devices at this tier, moving to tier $this->current_tier\n";
+        }
+        $this->current = $this->tiered->get($this->current_tier);
+        foreach ($this->deferred->pull($this->current_tier, []) as $fpingResponse) {
+            $this->handleResponse($fpingResponse);
+        }
+        $this->processTier();
+    }
+    /**
+     * If the device is on the current tier, record the data and remove it
+     * $data should have keys: hostname, status, and conditionally rtt
      */
     public function handleResponse(FpingResponse $response): void
     {
-        Log::debug("Attempting to record data for $response->host");
+        if (Debug::isVerbose()) {
+            echo "Attempting to record data for $response->host... ";
+        }
         $device = $this->devices->get($response->host);
-        if ($device === null) {
-            Log::error("Ping host from response not found $response->host");
-            return;
+        if ($device->max_depth === 0 || $this->current->has($device->hostname)) {
+            if (Debug::isVerbose()) {
+                echo "Success\n";
+            }
+            $device->status = ($response->success() && $device->status_reason != 'snmp');
+            if ($device->isDirty('status')) {
+                $device->status_reason = $device->status ? '' : 'icmp';
+                $type = $device->status ? 'up' : 'down';
+            }
+            $response->saveStats($device);
+            if (isset($type)) { // only run alert rules if status changed
+                echo "Device $device->hostname changed status to $type, running alerts\n";
+                $rules = new AlertRules;
+                $rules->runRules($device->device_id);
+            }
+            $this->complete($device->hostname);
+            d_echo("Recorded data for $device->hostname (tier $device->max_depth)\n");
+        } else {
+            if (Debug::isVerbose()) {
+                echo "Deferred\n";
+            }
+            $this->defer($response);
         }
-        $waiting_on = [];
-        foreach ($device->parents ?? [] as $parent) {
-            if (! $this->processed->has($parent->device_id)) {
-                $waiting_on[] = $parent->device_id;
-            }
-        }
-        $device->status = ($response->success() && $device->status_reason != 'snmp');
-        if ($device->isDirty('status')) {
-            $device->status_reason = $device->status ? '' : 'icmp';
-            $type = $device->status ? 'up' : 'down';
-        }
-        $response->saveStats($device);
-        $this->processed->put($device->device_id, true);
-        Log::debug("Recorded data for $device->hostname");
-        if (isset($type)) { // only run alert rules if status changed
-            Log::debug("Device $device->hostname changed status to $type, running alerts");
-            if (count($waiting_on) === 0) {
-                $this->runAlerts($device->device_id);
-            } else {
-                Log::debug('Alerts Deferred');
-                $this->deferred->put($device->device_id, $device->parents);
-                foreach ($waiting_on as $parent_id) {
-                    Log::debug("Adding $device->device_id to list waiting for $parent_id");
-                    if ($this->waiting_on->has($parent_id)) {
-                        $child_list = $this->waiting_on->get($parent_id);
-                        $child_list->put($device->device_id, true);
-                    } else {
-                        $this->waiting_on->put($parent_id, collect([$device->device_id => true]));
-                    }
-                }
-            }
-        }
-        $this->runDeferredAlerts($device->device_id);
+        $this->processTier();
     }
     /**
-     * Run any deferred alerts
+     * Done processing $hostname, remove it from our active data
+     *
+     * @param  string  $hostname
      */
-    private function runDeferredAlerts(int $device_id): void
+    private function complete($hostname)
     {
-        if ($this->waiting_on->has($device_id)) {
-            $children = $this->waiting_on->get($device_id)->keys();
-            foreach ($children as $child_id) {
-                if ($this->deferred->has($child_id)) {
-                    $alert_child = true;
-                    $parents = $this->deferred->get($child_id);
-                    foreach ($parents as $parent) {
-                        if (! $this->processed->has($parent->device_id)) {
-                            Log::debug("Deferring device $child_id triggered by $device_id still waiting for $parent->device_id");
-                            $alert_child = false;
-                        }
-                    }
-                    if ($alert_child) {
-                        Log::debug("Deferred device $child_id triggered by $device_id");
-                        $this->runAlerts($child_id);
-                        $this->deferred->pull($child_id);
-                    }
-                }
-            }
-        }
-        $this->waiting_on->pull($device_id);
+        $this->current->offsetUnset($hostname);
+        $this->deferred->each->offsetUnset($hostname);
     }
     /**
-     * run alerts for a device
+     * Defer this data processing until all parent devices are complete
      */
-    private function runAlerts(int $device_id): void
+    private function defer(FpingResponse $response): void
     {
-        $rules = new AlertRules;
-        $rules->runRules($device_id);
+        $device = $this->devices->get($response->host);
+        if ($device == null) {
+            dd("could not find $response->host");
+        }
+        if ($this->deferred->has($device->max_depth)) {
+            $tier = $this->deferred->get($device->max_depth);
+            if (! $tier->has($device->hostname)) {
+                $tier->put($device->hostname, $response);
+            }
+        } else {
+            $this->deferred->put($device->max_depth, collect([$device->hostname => $response]));
+        }
     }
 }

--- a/app/Models/CustomMap.php
+++ b/app/Models/CustomMap.php
@@ -27,21 +27,20 @@
 use Illuminate\Database\Eloquent\Factories\HasFactory;
 use Illuminate\Database\Eloquent\Relations\HasMany;
 use Illuminate\Database\Eloquent\Relations\HasOne;
 use Permissions;
 class CustomMap extends BaseModel
 {
     use HasFactory;
     protected $primaryKey = 'custom_map_id';
     protected $casts = [
         'options' => 'array',
-        'legend_colours' => 'array',
         'newnodeconfig' => 'array',
         'newedgeconfig' => 'array',
         'background_data' => 'array',
     ];
     protected $fillable = [
         'name',
         'menu_group',
         'width',
         'height',
         'node_align',

--- a/app/Models/CustomMapNode.php
+++ b/app/Models/CustomMapNode.php
@@ -23,26 +23,20 @@
  * @author     Steven Wilton <swilton@fluentit.com.au>
  */
 namespace App\Models;
 use Illuminate\Database\Eloquent\Factories\HasFactory;
 use Illuminate\Database\Eloquent\Relations\BelongsTo;
 use Illuminate\Database\Eloquent\Relations\HasMany;
 class CustomMapNode extends BaseModel
 {
     use HasFactory;
     protected $primaryKey = 'custom_map_node_id';
-    public function linkedMapIsDown(): bool
-    {
-        return $this->linked_custom_map_id &&
-            CustomMapNode::where('custom_map_id', $this->linked_custom_map_id)
-                ->whereRelation('device', fn ($q) => $q->isDown())->exists();
-    }
     public function scopeHasAccess($query, User $user)
     {
         if ($user->hasGlobalRead()) {
             return $query;
         }
         return $this->hasDeviceAccess($query, $user);
     }
     public function map(): BelongsTo
     {
         return $this->belongsTo(CustomMap::class, 'custom_map_id');

--- a/app/Models/Ipv4Mac.php
+++ b/app/Models/Ipv4Mac.php
@@ -1,21 +1,12 @@
 <?php
 namespace App\Models;
 use Illuminate\Database\Eloquent\Relations\BelongsTo;
-use Illuminate\Database\Eloquent\Relations\BelongsToMany;
 class Ipv4Mac extends PortRelatedModel
 {
     protected $table = 'ipv4_mac';
     public $timestamps = false;
     public function device(): BelongsTo
     {
         return $this->belongsTo(\App\Models\Device::class, 'device_id');
     }
-    public function port(): BelongsTo
-    {
-        return $this->belongsTo(Port::class, 'port_id');
-    }
-    public function remote_ports_maybe(): BelongsToMany
-    {
-        return $this->belongsToMany(Port::class, 'view_port_mac_links', 'ipv4_mac_id', 'remote_port_id');
-    }
 }

--- a/app/Models/Port.php
+++ b/app/Models/Port.php
@@ -77,31 +77,20 @@
     /**
      * Get the shortened label for this device.  Replaces things like GigabitEthernet with GE.
      *
      * @return string
      */
     public function getShortLabel()
     {
         return Rewrite::shortenIfName(Rewrite::normalizeIfName($this->ifName ?: $this->ifDescr));
     }
     /**
-     * Get a label containing both the ifName and ifAlias if they differ.
-     */
-    public function getFullLabel(): string
-    {
-        $label = $this->getLabel();
-        if ($label == $this->ifAlias || empty($this->ifAlias)) {
-            return $label;
-        }
-        return "$label - $this->ifAlias";
-    }
-    /**
      * Get the description of this port
      */
     public function getDescription(): string
     {
         return (string) $this->ifAlias;
     }
     /**
      * Check if user can access this port.
      *
      * @param  User|int  $user
@@ -286,28 +275,20 @@
         return $this->hasMany(\App\Models\Link::class, 'local_port_id');
     }
     public function remoteLinks(): HasMany
     {
         return $this->hasMany(\App\Models\Link::class, 'remote_port_id');
     }
     public function allLinks(): \Illuminate\Support\Collection
     {
         return $this->links->merge($this->remoteLinks);
     }
-    public function xdpLinkedPorts(): BelongsToMany
-    {
-        return $this->belongsToMany(Port::class, 'links', 'local_port_id', 'remote_port_id');
-    }
-    public function macLinkedPorts(): BelongsToMany
-    {
-        return $this->belongsToMany(Port::class, 'view_port_mac_links', 'port_id', 'remote_port_id');
-    }
     public function macAccounting(): HasMany
     {
         return $this->hasMany(MacAccounting::class, 'port_id');
     }
     public function macs(): HasMany
     {
         return $this->hasMany(Ipv4Mac::class, 'port_id');
     }
     public function nac(): HasMany
     {

--- a/app/Notifications/AlertNotification.php
+++ b/app/Notifications/AlertNotification.php
@@ -30,21 +30,21 @@
 {
     /**
      * @var \NotificationChannels\WebPush\WebPushMessage
      */
     public $message;
     public function __construct(int $alert_id, string $title, string $body)
     {
         $this->message = (new WebPushMessage)
             ->title($title)
             ->icon(asset('/images/mstile-144x144.png'))
-            ->body(substr($body, 0, 3500))
+            ->body($body)
             ->action('Acknowledge', 'alert.acknowledge')
             ->action('View', 'alert.view')
             ->options(['TTL' => 2000])
             ->data(['id' => $alert_id]);
     }
     /**
      * @param  mixed  $notifiable
      * @return string[]
      */
     public function via($notifiable): array

--- a/app/Observers/DeviceObserver.php
+++ b/app/Observers/DeviceObserver.php
@@ -22,20 +22,23 @@
         (new Oxidized)->reloadNodes();
     }
     /**
      * Handle the device "updated" event.
      *
      * @param  \App\Models\Device  $device
      * @return void
      */
     public function updated(Device $device): void
     {
+        if ($device->isDirty('max_depth')) {
+            $device->children->each->updateMaxDepth();
+        }
         if ($device->isDirty(['status', 'status_reason'])) {
             $type = $device->status ? 'up' : 'down';
             $reason = $device->status ? $device->getOriginal('status_reason') : $device->status_reason;
             $polled_by = Config::get('distributed_poller') ? (' by ' . \config('librenms.node_id')) : '';
             Eventlog::log(sprintf('Device status changed to %s from %s check%s.', ucfirst($type), $reason, $polled_by), $device, $type);
         }
         foreach (['os', 'sysName', 'version', 'hardware', 'features', 'serial', 'icon', 'type', 'ip'] as $attribute) {
             if ($device->isDirty($attribute)) {
                 Eventlog::log(self::attributeChangedMessage($attribute, $device->$attribute, $device->getOriginal($attribute)), $device, 'system', Severity::Notice);
             }

--- a/app/Plugins/ExamplePlugin/resources/views/device-overview.blade.php
+++ b/app/Plugins/ExamplePlugin/resources/views/device-overview.blade.php
@@ -1,16 +1,18 @@
 <div class="row">
     <div class="col-md-12">
         <div class="panel panel-default panel-condensed">
             <div class="panel-heading">
                 <strong>{{ $title }}</strong> <a href="{{ $url }}">[EDIT]</a>
             </div>
             <div class="panel-body">
                 <div class="row">
                     <div class="col-sm-12">
-                        {!! Str::markdown($device->notes ?? '', ['html_input' => 'strip', 'allow_unsafe_links' => false]) !!}
+                        {{-- This is a comment.  Below we output the markdown output unescaped because we want the raw html
+                         to be output to the page.  Be careful with unescaped output as it can lead to security issues. --}}
+                        {!! Str::markdown($device->notes ?? '') !!}
                     </div>
         </div>
         </div>
     </div>
     </div>
 </div>

--- a/app/View/Components/Graph.php
+++ b/app/View/Components/Graph.php
@@ -119,30 +119,25 @@
         ];
         return view($view, $data);
     }
     /**
      * @param  mixed  $value
      * @param  int|string  $key
      * @return bool
      */
     public function filterAttributes($value, $key): bool
     {
-        $filtered = [
+        return ! in_array($key, [
             'legend',
             'height',
             'loading',
-        ];
-        if ($this->link) {
-            $filtered[] = 'class';
-            $filtered[] = 'style';
-        }
-        return ! in_array($key, $filtered);
+        ]);
     }
     private function getSrc(): string
     {
         return url('graph.php') . '?' . http_build_query($this->vars + [
             'type' => $this->type,
             'legend' => $this->legend,
             'absolute_size' => $this->absolute_size,
             'width' => $this->width,
             'height' => $this->height,
             'from' => $this->from,

--- a/app/View/Components/PortLink.php
+++ b/app/View/Components/PortLink.php
@@ -30,25 +30,25 @@
     /**
      * @var string
      */
     public $status;
     public bool $basic;
     /**
      * Create a new component instance.
      *
      * @return void
      */
-    public function __construct(Port $port, ?array $graphs = null, bool $basic = false, array $vars = [])
+    public function __construct(Port $port, ?array $graphs = null, bool $basic = false)
     {
         $this->basic = $basic;
         $this->port = $port;
-        $this->link = Url::portUrl($port, $vars);
+        $this->link = Url::portUrl($port);
         $this->label = Rewrite::normalizeIfName($port->getLabel());
         $this->description = $port->getDescription();
         $this->status = $this->status();
         $this->graphs = $graphs === null ? [
             ['type' => 'port_bits', 'title' => trans('Traffic'), 'vars' => [['from' => '-1d'], ['from' => '-7d'], ['from' => '-30d'], ['from' => '-1y']]],
         ] : Arr::wrap($graphs);
         if ($this->description == $this->label) {
             $this->description = '';
         }
     }

--- a/check-services.php
+++ b/check-services.php
@@ -38,21 +38,21 @@
             $params[] = $options['h'];
         }
     }
 }
 $sql = 'SELECT D.*,S.*,attrib_value  FROM `devices` AS D'
        . ' INNER JOIN `services` AS S ON S.device_id = D.device_id AND D.disabled = 0 ' . $where
        . ' LEFT JOIN `devices_attribs` as A ON D.device_id = A.device_id AND A.attrib_type = "override_icmp_disable"'
        . ' ORDER by D.device_id DESC;';
 foreach (dbFetchRows($sql, $params) as $service) {
     if (! $service['service_disabled'] && ($service['status'] == 1 || ($service['status'] == 0 && $service['status_reason'] === 'snmp') ||
-        $service['attrib_value'] === 'true' || (! is_null($service['service_ip']) && $service['service_ip'] !== $service['hostname'] &&
+        $service['attrib_value'] === 'true' || ($service['service_ip'] !== $service['hostname'] &&
         $service['service_ip'] !== inet6_ntop($service['ip'])))) {
         poll_service($service);
         $polled_services++;
     } else {
         if (! $service['service_disabled']) {
             d_echo("\nService check - " . $service['service_id'] . "\nSkipping service check because device "
                 . $service['hostname'] . " is down due to icmp.\n");
             \App\Models\Eventlog::log(
                 "Service check - {$service['service_desc']} ({$service['service_id']}) -
                 Skipping service check because device {$service['hostname']} is down due to icmp",

--- a/daily.php
+++ b/daily.php
@@ -285,48 +285,39 @@
                 /** @var DeviceGroup $deviceGroup */
                 $deviceGroup->rules = $deviceGroup->getParser()->generateJoins()->toArray();
                 $deviceGroup->save();
             }
         });
         $lock->release();
     }
 }
 if ($options['f'] === 'notify') {
     if (\LibreNMS\Config::has('alert.default_mail')) {
-        try {
-            \LibreNMS\Util\Mail::send(\LibreNMS\Config::get('alert.default_mail'), '[LibreNMS] Auto update has failed for ' . Config::get('distributed_poller_name'), "We just attempted to update your install but failed. The information below should help you fix this.\r\n\r\n" . $options['o'], false);
-        } catch (Exception $e) {
-            echo 'Failed to send update failed email. ' . $e->getMessage();
-        }
+        \LibreNMS\Util\Mail::send(\LibreNMS\Config::get('alert.default_mail'), '[LibreNMS] Auto update has failed for ' . Config::get('distributed_poller_name'), "We just attempted to update your install but failed. The information below should help you fix this.\r\n\r\n" . $options['o'], false);
     }
 }
 if ($options['f'] === 'peeringdb') {
     $lock = Cache::lock('peeringdb', 86000);
     if ($lock->get()) {
         cache_peeringdb();
         $lock->release();
     }
 }
 if ($options['f'] === 'refresh_os_cache') {
     echo 'Clearing OS cache' . PHP_EOL;
     if (is_file(Config::get('install_dir') . '/cache/os_defs.cache')) {
         unlink(Config::get('install_dir') . '/cache/os_defs.cache');
     }
 }
 if ($options['f'] === 'recalculate_device_dependencies') {
     $lock = Cache::lock('recalculate_device_dependencies', 86000);
     if ($lock->get()) {
         Device::doesntHave('parents')->with('children')->chunkById(100, function (Collection $devices) {
-            $processed = [];
-            $recurse = function (Device $device) use (&$recurse, &$processed) {
-                if (array_key_exists($device->device_id, $processed)) {
-                    return;
-                }
-                $processed[$device->device_id] = true;
+            $recurse = function (Device $device) use (&$recurse) {
                 $device->updateMaxDepth();
                 $device->children->each($recurse);
             };
             $devices->each($recurse);
         });
         $lock->release();
     }
 }

--- a/database/migrations/2023_12_21_085427_create_view_port_mac_link.php
+++ b//dev/null
@@ -1,44 +0,0 @@
-<?php
-use Illuminate\Database\Migrations\Migration;
-use Illuminate\Support\Facades\DB;
-return new class extends Migration
-{
-    /**
-     * Run the migrations.
-     */
-    public function up(): void
-    {
-        DB::statement('DROP VIEW IF EXISTS view_port_mac_links;');
-        DB::statement("
-            CREATE VIEW view_port_mac_links
-            AS
-            -- Gets a list of port IDs for devices linked by MAC address
-            SELECT
-              p.port_id
-              ,arp.id as ipv4_mac_id
-              ,rp.port_id as remote_port_id
-            FROM
-              ports p
-              -- Find all ARP entries for this port, excluding the static entries for the local IP
-              JOIN ipv4_mac arp
-                ON p.port_id=arp.port_id
-                  AND arp.mac_address <> p.ifPhysAddress
-              -- Find all IPv4 addresses on other devices that have the same IP as the ARP entry
-              JOIN ipv4_addresses a
-                ON a.ipv4_address=arp.ipv4_address
-              -- Find the matching port if the MAC address matches
-              JOIN
-                ports rp ON a.port_id=rp.port_id
-                  AND arp.mac_address=rp.ifPhysAddress
-              WHERE
-                arp.mac_address NOT IN ('000000000000', 'ffffffffffff');
-        ");
-    }
-    /**
-     * Reverse the migrations.
-     */
-    public function down(): void
-    {
-        DB::statement('DROP VIEW IF EXISTS view_port_mac_links;');
-    }
-};

--- a/database/migrations/2024_10_06_002633_ports_vlans_table_add_port_id_index.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-use Illuminate\Database\Migrations\Migration;
-use Illuminate\Database\Schema\Blueprint;
-use Illuminate\Support\Facades\Schema;
-return new class extends Migration
-{
-    /**
-     * Run the migrations.
-     */
-    public function up(): void
-    {
-        Schema::table('ports_vlans', function (Blueprint $table) {
-            $table->index('port_id');
-        });
-    }
-    /**
-     * Reverse the migrations.
-     */
-    public function down(): void
-    {
-        Schema::table('ports_vlans', function (Blueprint $table) {
-            $table->dropIndex('ports_vlans_port_id_index');
-        });
-    }
-};

--- a/database/migrations/2024_10_12_164214_custom_map_edge_width.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-use Illuminate\Database\Migrations\Migration;
-use Illuminate\Database\Schema\Blueprint;
-use Illuminate\Support\Facades\Schema;
-return new class extends Migration
-{
-    /**
-     * Run the migrations.
-     */
-    public function up(): void
-    {
-        Schema::table('custom_map_edges', function (Blueprint $table) {
-            $table->decimal('fixed_width', total: 3, places: 1)->nullable()->after('label');
-        });
-    }
-    /**
-     * Reverse the migrations.
-     */
-    public function down(): void
-    {
-        Schema::table('custom_map_edges', function (Blueprint $table) {
-            $table->dropColumn(['fixed_width']);
-        });
-    }
-};

--- a/database/migrations/2024_10_12_210114_custom_map_legend_colours.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-use Illuminate\Database\Migrations\Migration;
-use Illuminate\Database\Schema\Blueprint;
-use Illuminate\Support\Facades\Schema;
-return new class extends Migration
-{
-    /**
-     * Run the migrations.
-     */
-    public function up(): void
-    {
-        Schema::table('custom_maps', function (Blueprint $table) {
-            $table->longText('legend_colours')->nullable()->after('legend_hide_overspeed');
-        });
-    }
-    /**
-     * Reverse the migrations.
-     */
-    public function down(): void
-    {
-        Schema::table('custom_maps', function (Blueprint $table) {
-            $table->dropColumn(['legend_colours']);
-        });
-    }
-};

--- a/html/js/librenms.js
+++ b/html/js/librenms.js
@@ -151,20 +151,40 @@
     var list = caller.find('.neighbors-interface-list');
     var continued = caller.find('.neighbors-list-continued');
     if(button.hasClass("fa-plus")) {
         button.addClass('fa-minus').removeClass('fa-plus');
     }
     else {
         button.addClass('fa-plus').removeClass('fa-minus');
     }
     list.toggle();
     continued.toggle();
+});
+$(document).on("change", '#mode', function() {
+    $.post('ajax/set_map_view',
+        {
+            map_view: $(this).val()
+        },
+        function(data) {
+                location.reload();
+        },'json'
+    );
+});
+$(document).on("change", '#group', function() {
+    $.post('ajax/set_map_group',
+        {
+            group_view: $(this).val()
+        },
+        function(data){
+            location.reload();
+        },'json'
+    );
 });
 $(document).ready(function() {
     var lines = 'on';
     $("#linenumbers").button().on("click", function() {
         if (lines == 'on') {
             $($('.config').find('ol').get().reverse()).each(function(){
                 $(this).replaceWith($('<ul>'+$(this).html()+'</ul>'))
                 lines = 'off';
                 $('#linenumbers').val('Show line numbers');
             });
@@ -360,20 +380,91 @@
 }
 function destroy_map(id) {
     const leaflet = get_map(id);
     if(id in window.maps) {
         leaflet.off();
         leaflet._container.classList.remove('leaflet-container', 'leaflet-touch', 'leaflet-retina', 'leaflet-fade-anim');
         leaflet.remove();
         delete window.maps[id];
     }
 }
+function populate_map_markers(map_id, group_radius = 10, status = [0,1], device_group = 0) {
+    $.ajax({
+        type: "GET",
+        url: ajax_url + '/dash/worldmap',
+        dataType: "json",
+        data: { status: status, device_group: device_group },
+        success: function (data) {
+            var redMarker = L.AwesomeMarkers.icon({
+                icon: 'server',
+                markerColor: 'red', prefix: 'fa', iconColor: 'white'
+            });
+            var blueMarker = L.AwesomeMarkers.icon({
+                icon: 'server',
+                markerColor: 'blue', prefix: 'fa', iconColor: 'white'
+            });
+            var greenMarker = L.AwesomeMarkers.icon({
+                icon: 'server',
+                markerColor: 'green', prefix: 'fa', iconColor: 'white'
+            });
+            var markers = data.map((device) => {
+                var markerData = {title: device.name};
+                switch (device.status) {
+                    case 0: // down
+                        markerData.icon = redMarker;
+                        markerData.zIndexOffset = 5000;
+                        break;
+                    case 3: // down + maintenance
+                        markerData.icon = blueMarker;
+                        markerData.zIndexOffset = 10000;
+                        break;
+                    default: // up
+                        markerData.icon = greenMarker;
+                        markerData.zIndexOffset = 0;
+                }
+                var marker = L.marker(new L.LatLng(device.lat, device.lng), markerData);
+                marker.bindPopup(`<a href="${device.url}"><img src="${device.icon}" width="32" height="32" alt=""> ${device.name}</a>`);
+                return marker;
+            });
+            var map = get_map(map_id);
+            if (! map.markerCluster) {
+                map.markerCluster = L.markerClusterGroup({
+                    maxClusterRadius: group_radius,
+                    iconCreateFunction: function (cluster) {
+                        var markers = cluster.getAllChildMarkers();
+                        var color = "green";
+                        var newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
+                        for (var i = 0; i < markers.length; i++) {
+                            if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
+                                color = "blue";
+                            }
+                            if (markers[i].options.icon.options.markerColor == "red") {
+                                color = "red";
+                            }
+                        }
+                        return L.divIcon({
+                            html: cluster.getChildCount(),
+                            className: color + newClass,
+                            iconSize: L.point(40, 40)
+                        });
+                    }
+                });
+                map.addLayer(map.markerCluster);
+            }
+            map.markerCluster.clearLayers();
+            map.markerCluster.addLayers(markers);
+        },
+        error: function(error){
+            toastr.error(error.statusText);
+        }
+    });
+}
 function disable_map_interaction(leaflet) {
     leaflet.zoomControl?.remove();
     delete leaflet.zoomControl;
     leaflet.locateControl?.stop();
     leaflet.locateControl?.remove();
     delete leaflet.locateControl;
     if (leaflet.layerControl) {
         leaflet.layerControl._container.style.display = 'none';
     }
     leaflet.dragging.disable();

--- a//dev/null
+++ b/html/network-map.php
@@ -0,0 +1,192 @@
+<?php
+/**
+ * LibreNMS
+ *
+ *   This file is part of LibreNMS.
+ *
+ * @copyright  (C) 2006 - 2012 Adam Armstrong
+ */
+use LibreNMS\Config;
+use LibreNMS\Util\Debug;
+$links = 1;
+$init_modules = ['web', 'auth'];
+require realpath(__DIR__ . '/..') . '/includes/init.php';
+if (! Auth::check()) {
+    exit('Unauthorized');
+}
+$options = getopt('d::');
+if (Debug::set(isset($options['d']), false)) {
+    echo "DEBUG!\n";
+}
+if (strpos($_SERVER['REQUEST_URI'], 'anon')) {
+    $anon = 1;
+}
+if (is_array(Config::get('branding'))) {
+    Config::set('branding', array_replace_recursive(Config::get('branding'), Config::get('branding.' . $_SERVER['SERVER_NAME']) ?: Config::get('branding.default')));
+}
+$where = '';
+$param = [];
+if (isset($_GET['device']) && is_numeric($_GET['device'])) {
+    $where = '&& device_id = ?';
+    $param[] = $_GET['device'];
+}
+if (isset($_GET['format']) && preg_match('/^[a-z]*$/', $_GET['format'])) {
+    $map = '
+            digraph G { bgcolor=transparent; splines=true; overlap=scale; concentrate=0; epsilon=0.001; rankdir=LR;
+            node [ fontname="helvetica", fontstyle=bold, style=filled, color=white, fillcolor=lightgrey, overlap=false];
+            edge [ bgcolor=white, fontname="helvetica", fontstyle=bold, arrowhead=dot, arrowtail=dot];
+            graph [bgcolor=transparent];
+';
+    if (! Auth::check()) {
+        $map .= "\"Not authenticated\" [fontsize=20 fillcolor=\"lightblue\", URL=\"/\" shape=box3d]\n";
+    } else {
+        $locations = getlocations();
+        $loc_count = 1;
+        foreach (dbFetchRows('SELECT *, locations.location FROM devices LEFT JOIN locations ON devices.location_id = locations.id WHERE 1 ' . $where, $param) as $device) {
+            if ($device) {
+                $links = dbFetchRows('SELECT * from ports AS I, links AS L WHERE I.device_id = ? AND L.local_port_id = I.port_id ORDER BY L.remote_hostname', [$device['device_id']]);
+                if (count($links)) {
+                    if ($anon) {
+                        $device['hostname'] = md5($device['hostname']);
+                    }
+                    if (! isset($locations[$device['location']])) {
+                        $locations[$device['location']] = $loc_count;
+                        $loc_count++;
+                    }
+                    $loc_id = $locations[$device['location']];
+                    $map .= '"' . $device['hostname'] . '" [fontsize=20, fillcolor="lightblue", group=' . $loc_id . ' URL="' . Config::get('base_url') . 'device/device=' . $device['device_id'] . "/tab=neighbours/selection=map/\" shape=box3d]\n";
+                }
+                foreach ($links as $link) {
+                    $local_port_id = $link['local_port_id'];
+                    $remote_port_id = $link['remote_port_id'];
+                    $i = 0;
+                    $done = 0;
+                    if ($linkdone[$remote_port_id][$local_port_id]) {
+                        $done = 1;
+                    }
+                    if (! $done) {
+                        $linkdone[$local_port_id][$remote_port_id] = true;
+                        $links++;
+                        if ($link['ifSpeed'] >= '10000000000') {
+                            $info = 'color=red3 style="setlinewidth(6)"';
+                        } elseif ($link['ifSpeed'] >= '1000000000') {
+                            $info = 'color=lightblue style="setlinewidth(4)"';
+                        } elseif ($link['ifSpeed'] >= '100000000') {
+                            $info = 'color=lightgrey style="setlinewidth(2)"';
+                        } elseif ($link['ifSpeed'] >= '10000000') {
+                            $info = 'style="setlinewidth(1)"';
+                        } else {
+                            $info = 'style="setlinewidth(1)"';
+                        }
+                        $src = $device['hostname'];
+                        if ($anon) {
+                            $src = md5($src);
+                        }
+                        if ($remote_port_id) {
+                            $dst = dbFetchCell('SELECT `hostname` FROM `devices` AS D, `ports` AS I WHERE I.port_id = ? AND D.device_id = I.device_id', [$remote_port_id]);
+                            $dst_host = dbFetchCell('SELECT D.device_id FROM `devices` AS D, `ports` AS I WHERE I.port_id = ?  AND D.device_id = I.device_id', [$remote_port_id]);
+                        } else {
+                            unset($dst_host);
+                            $dst = $link['remote_hostname'];
+                        }
+                        if ($anon) {
+                            $dst = md5($dst);
+                            $src = md5($src);
+                        }
+                        $sif = cleanPort(dbFetchRow('SELECT * FROM ports WHERE `port_id` = ?', [$link['local_port_id']]), $device);
+                        if ($remote_port_id) {
+                            $dif = cleanPort(dbFetchRow('SELECT * FROM ports WHERE `port_id` = ?', [$link['remote_port_id']]));
+                        } else {
+                            $dif['label'] = $link['remote_port'];
+                            $dif['port_id'] = $link['remote_hostname'] . '/' . $link['remote_port'];
+                        }
+                        if ($where == '') {
+                            if (! $ifdone[$dst][$dif['port_id']] && ! $ifdone[$src][$sif['port_id']]) {
+                                $map .= "\"$src\" -> \"" . $dst . "\" [weight=500000, arrowsize=0, len=0];\n";
+                            }
+                            $ifdone[$src][$sif['port_id']] = 1;
+                        } else {
+                            $map .= '"' . $sif['port_id'] . '" [label="' . $sif['label'] . '", fontsize=12, fillcolor=lightblue, URL="' . Config::get('base_url') . 'device/device=' . $device['device_id'] . "/tab=port/port=$local_port_id/\"]\n";
+                            if (! $ifdone[$src][$sif['port_id']]) {
+                                $map .= "\"$src\" -> \"" . $sif['port_id'] . "\" [weight=500000, arrowsize=0, len=0];\n";
+                                $ifdone[$src][$sif['port_id']] = 1;
+                            }
+                            if ($dst_host) {
+                                $map .= "\"$dst\" [URL=\"" . Config::get('base_url') . "device/device=$dst_host/tab=neighbours/selection=map/\", fontsize=20, shape=box3d]\n";
+                            } else {
+                                $map .= "\"$dst\" [ fontsize=20 shape=box3d]\n";
+                            }
+                            if ($dst_host == $device['device_id'] || $where == '') {
+                                $map .= '"' . $dif['port_id'] . '" [label="' . $dif['label'] . '", fontsize=12, fillcolor=lightblue, URL="' . Config::get('base_url') . "device/device=$dst_host/tab=port/port=$remote_port_id/\"]\n";
+                            } else {
+                                $map .= '"' . $dif['port_id'] . '" [label="' . $dif['label'] . ' ", fontsize=12, fillcolor=lightgray';
+                                if ($dst_host) {
+                                    $map .= ', URL="' . Config::get('base_url') . "device/device=$dst_host/tab=port/port=$remote_port_id/\"";
+                                }
+                                $map .= "]\n";
+                            }
+                            if (! $ifdone[$dst][$dif['port_id']]) {
+                                $map .= '"' . $dif['port_id'] . "\" -> \"$dst\" [weight=500000, arrowsize=0, len=0];\n";
+                                $ifdone[$dst][$dif['port_id']] = 1;
+                            }
+                            $map .= '"' . $sif['port_id'] . '" -> "' . $dif['port_id'] . "\" [weight=1, arrowhead=normal, arrowtail=normal, len=2, $info] \n";
+                        }
+                    }
+                }
+                $done = 0;
+            }
+        }
+    }
+    $map .= "\n};";
+    if ($_GET['debug'] == 1) {
+        echo '<pre>$map</pre>';
+        exit;
+    }
+    switch ($_GET['format']) {
+        case 'svg':
+            break;
+        case 'png':
+            $_GET['format'] = 'png:gd';
+            break;
+        case 'dot':
+            echo $map;
+            exit;
+        default:
+            $_GET['format'] = 'png:gd';
+    }
+    if ($links > 30) {
+        $maptool = Config::get('dot');
+    } else {
+        $maptool = Config::get('dot');
+    }
+    if ($where == '') {
+        $maptool = Config::get('sfdp') . ' -Gpack -Goverlap=prism -Gcharset=latin1 -Gsize=20,20';
+        $maptool = Config::get('dot');
+    }
+    $descriptorspec = [0 => ['pipe', 'r'], 1 => ['pipe', 'w']];
+    $mapfile = Config::get('temp_dir') . '/' . strgen() . '.png';
+    $process = proc_open($maptool . ' -T' . $_GET['format'], $descriptorspec, $pipes);
+    if (is_resource($process)) {
+        fwrite($pipes[0], "$map");
+        fclose($pipes[0]);
+        while (! feof($pipes[1])) {
+            $img .= fgets($pipes[1]);
+        }
+        fclose($pipes[1]);
+        $return_value = proc_close($process);
+    }
+    if ($_GET['format'] == 'png:gd') {
+        header('Content-type: image/png');
+    } elseif ($_GET['format'] == 'svg') {
+        header('Content-type: image/svg+xml');
+        $img = str_replace('<a ', '<a target="_parent" ', $img);
+    }
+    echo $img;
+} else {
+    if (Auth::check()) {
+        echo '<center>
+                  <object width=1200 height=1000 data="' . Config::get('base_url') . 'network-map.php?format=svg" type="image/svg+xml"></object>
+              </center>
+        ';
+    }
+}

--- a/includes/discovery/bgp-peers.inc.php
+++ b/includes/discovery/bgp-peers.inc.php
@@ -75,21 +75,21 @@
                 $safis[2] = 'multicast';
                 $safis[3] = 'unicastAndMulticast';
                 $safis[4] = 'labeledUnicast';
                 $safis[5] = 'mvpn';
                 $safis[65] = 'vpls';
                 $safis[70] = 'evpn';
                 $safis[128] = 'vpn';
                 $safis[132] = 'rtfilter';
                 $safis[133] = 'flow';
                 if (! isset($j_peerIndexes)) {
-                    $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos', '-OQUbs');
+                    $j_bgp = snmpwalk_cache_multi_oid($device, 'jnxBgpM2PeerTable', [], 'BGP4-V2-MIB-JUNIPER', 'junos');
                     d_echo($j_bgp);
                     $j_peerIndexes = [];
                     foreach ($j_bgp as $index => $entry) {
                         $peer_index = $entry['jnxBgpM2PeerIndex'];
                         try {
                             $ip = IP::fromHexString($entry['jnxBgpM2PeerRemoteAddr']);
                             d_echo('peerindex for ' . $ip->getFamily() . " $ip is $peer_index\n");
                             $j_peerIndexes[(string) $ip] = $peer_index;
                         } catch (InvalidIpException $e) {
                             d_echo("Unable to parse IP for peer $peer_index: " . $entry['jnxBgpM2PeerRemoteAddr'] . PHP_EOL);

--- a/includes/discovery/loadbalancers.inc.php
+++ b/includes/discovery/loadbalancers.inc.php
@@ -2,17 +2,13 @@
 /*
  * LibreNMS module to capture details from various Load Balancers
  *
  * This program is free software: you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 if ($device['os'] == 'f5') {
-    if (file_exists(Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-ltm.inc.php')) {
-        include Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-ltm.inc.php';
-    }
-    if (file_exists(Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-gtm.inc.php')) {
-        include Config::get('install_dir') . 'includes/discovery/loadbalancers/f5-gtm.inc.php';
-    }
+    include 'includes/discovery/loadbalancers/f5-ltm.inc.php';
+    include 'includes/discovery/loadbalancers/f5-gtm.inc.php';
 }

--- a/includes/discovery/sensors/current/ocnos.inc.php
+++ b/includes/discovery/sensors/current/ocnos.inc.php
@@ -17,21 +17,21 @@
                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.12.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
                         'sensor_index' => "$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
                         'sensor_type' => 'ocnos',
                         'sensor_descr' => "$ifName$channelDescr xcvr bias",
                         'sensor_divisor' => $divisor,
                         'sensor_multiplier' => 1,
                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMax'] / $divisor : null,
                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMax'] / $divisor : null,
                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrCriticalThresholdMin'] / $divisor : null,
                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrAlertThresholdMin'] / $divisor : null,
-                        'sensor_current' => $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent'] / $divisor,
+                        'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransLaserBiasCurrent'] / $divisor : null,
                         'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
                         'entPhysicalIndex_measured' => 'port',
                         'user_func' => null,
                         'group' => 'transceiver',
                     ]));
                 }
             }
         }
     }
 }

--- a/includes/discovery/sensors/dbm/infinera-groove.inc.php
+++ b/includes/discovery/sensors/dbm/infinera-groove.inc.php
@@ -22,17 +22,11 @@
  * @copyright  2019 Nick Hilliard
  * @author     Nick Hilliard <nick@foobar.org>
  */
 foreach ($pre_cache['infineragroove_portTable'] as $index => $data) {
     if (is_numeric($data['portRxOpticalPower']) && $data['portRxOpticalPower'] != -99) {
         $descr = $data['portAlias'] . ' Receive Power';
         $oid = '.1.3.6.1.4.1.42229.1.2.3.6.1.1.4.' . $index;
         $value = $data['portRxOpticalPower'];
         discover_sensor(null, 'dbm', $device, $oid, 'portRxOpticalPower.' . $index, 'infinera-groove', $descr, null, '1', null, null, null, null, $value);
     }
-    if (is_numeric($data['portTxOpticalPower']) && $data['portTxOpticalPower'] != -99) {
-        $descr = $data['portAlias'] . ' Transmit Power';
-        $oid = '.1.3.6.1.4.1.42229.1.2.3.6.1.1.5.' . $index;
-        $value = $data['portTxOpticalPower'];
-        discover_sensor(null, 'dbm', $device, $oid, 'portTxOpticalPower.' . $index, 'infinera-groove', $descr, null, '1', null, null, null, null, $value);
-    }
 }

--- a/includes/discovery/sensors/dbm/ocnos.inc.php
+++ b/includes/discovery/sensors/dbm/ocnos.inc.php
@@ -18,21 +18,21 @@
                         'sensor_index' => "tx-$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",
                         'sensor_type' => 'ocnos',
                         'sensor_descr' => "$ifName$channelDescr xcvr TX power",
                         'sensor_divisor' => $divisor,
                         'sensor_multiplier' => 1,
                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMax'] / $divisor : null,
                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMax'] / $divisor : null,
                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerCriticalThresholdMin'] / $divisor : null,
                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPowerAlertThresholdMin'] / $divisor : null,
                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPower']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTxPower'] / $divisor : null,
-                        'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
+                        'entPhysicalIndex' => null, // TODO
                         'entPhysicalIndex_measured' => 'port',
                         'user_func' => null,
                         'group' => 'transceiver',
                     ]));
                 }
                 if (isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerSupported']) && $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransRxPowerSupported'] == 'supported') {
                     app('sensor-discovery')->discover(new \App\Models\Sensor([
                         'poller_type' => 'snmp',
                         'sensor_class' => 'dbm',
                         'sensor_oid' => ".1.3.6.1.4.1.36673.100.1.2.3.1.22.$cmmStackUnitIndex.$cmmTransIndex.$cmmTransChannelIndex",

--- a/includes/discovery/sensors/entity-sensor.inc.php
+++ b/includes/discovery/sensors/entity-sensor.inc.php
@@ -96,34 +96,54 @@
                                  );
                     }
                     if (preg_match('/(temp|temperature) sensor$/i', $descr)) {
                         $descr = preg_replace('/(temp|temperature) sensor$/i', '', $descr);
                     }
                 }
                 $descr = rewrite_entity_descr($descr);
             }
             $valid_sensor = check_entity_sensor($descr, $device);
             $type = $entitysensor[$entry['entPhySensorType']];
-            [$divisor, $multiplier] = match ($entry['entPhySensorScale']) {
-                'zepto' => [1000000000000000000, 1],
-                'nano' => [1000000000, 1],
-                'micro' => [1000000, 1],
-                'milli' => [1000, 1],
-                'units' => [1, 1],
-                'kilo' => [1, 1000],
-                'mega' => [1, 1000000],
-                'giga' => [1, 1000000000],
-                'yocto' => [1, 1],
-                default => [1, 1],
-            };
-            if (is_numeric($entry['entPhySensorPrecision']) && $entry['entPhySensorPrecision'] > 0) {
-                $divisor .= str_pad('', $entry['entPhySensorPrecision'], '0');
+            if ($entry['entPhySensorScale'] == 'nano') {
+                $divisor = '1000000000';
+                $multiplier = '1';
+            }
+            if ($entry['entPhySensorScale'] == 'micro') {
+                $divisor = '1000000';
+                $multiplier = '1';
+            }
+            if ($entry['entPhySensorScale'] == 'milli') {
+                $divisor = '1000';
+                $multiplier = '1';
+            }
+            if ($entry['entPhySensorScale'] == 'units') {
+                $divisor = '1';
+                $multiplier = '1';
+            }
+            if ($entry['entPhySensorScale'] == 'kilo') {
+                $divisor = '1';
+                $multiplier = '1000';
+            }
+            if ($entry['entPhySensorScale'] == 'mega') {
+                $divisor = '1';
+                $multiplier = '1000000';
+            }
+            if ($entry['entPhySensorScale'] == 'giga') {
+                $divisor = '1';
+                $multiplier = '1000000000';
+            }
+            if ($entry['entPhySensorScale'] == 'yocto') {
+                $divisor = '1';
+                $multiplier = '1';
+            }
+            if (is_numeric($entry['entPhySensorPrecision']) && $entry['entPhySensorPrecision'] > '0') {
+                $divisor = $divisor . str_pad('', $entry['entPhySensorPrecision'], '0');
             }
             $current = ($current * $multiplier / $divisor);
             if ($type == 'temperature') {
                 if ($current > '200') {
                     $valid_sensor = false;
                 }
                 $descr = preg_replace('/[T|t]emperature[|s]/', '', $descr);
             }
             if ($device['os'] == 'fortiswitch' && $entry['entPhySensorType'] == 'rpm') {
                 $type = 'percent';

--- a/includes/discovery/sensors/fanspeed/dell.inc.php
+++ b/includes/discovery/sensors/fanspeed/dell.inc.php
@@ -7,26 +7,18 @@
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 $temp = snmpwalk_cache_multi_oid($device, 'coolingDeviceTable', [], 'MIB-Dell-10892', 'dell');
 $cur_oid = '.1.3.6.1.4.1.674.10892.1.700.12.1.6.';
 if (is_array($temp)) {
     foreach ($temp as $index => $entry) {
         $descr = $temp[$index]['coolingDeviceLocationName'];
-        (isset($temp[$index]['coolingDeviceReading'])) ? $value = $temp[$index]['coolingDeviceReading'] : $value = null;
-        (isset($temp[$index]['coolingDeviceLowerCriticalThreshold'])) ? $lowlimit = $temp[$index]['coolingDeviceLowerCriticalThreshold'] : $lowlimit = null;
-        (isset($temp[$index]['coolingDeviceLowerNonCriticalThreshold'])) ? $low_warn_limit = $temp[$index]['coolingDeviceLowerNonCriticalThreshold'] : $low_warn_limit = null;
-        (isset($temp[$index]['coolingDeviceUpperNonCriticalThreshold'])) ? $warnlimit = $temp[$index]['coolingDeviceUpperNonCriticalThreshold'] : $warnlimit = null;
-        (isset($temp[$index]['coolingDeviceUpperCriticalThreshold'])) ? $limit = $temp[$index]['coolingDeviceUpperCriticalThreshold'] : $limit = null;
+        $value = $temp[$index]['coolingDeviceReading'];
+        $lowlimit = $temp[$index]['coolingDeviceLowerCriticalThreshold'];
+        $low_warn_limit = $temp[$index]['coolingDeviceLowerNonCriticalThreshold'];
+        $warnlimit = $temp[$index]['coolingDeviceUpperNonCriticalThreshold'];
+        $limit = $temp[$index]['coolingDeviceUpperCriticalThreshold'];
         discover_sensor(null, 'fanspeed', $device, $cur_oid . $index, $index, 'dell', $descr, '0', '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
-        unset(
-            $descr,
-            $value,
-            $lowlimit,
-            $low_warn_limit,
-            $warnlimit,
-            $limit
-        );
     }
 }

--- a/includes/discovery/sensors/humidity/serverscheck.inc.php
+++ b/includes/discovery/sensors/humidity/serverscheck.inc.php
@@ -22,23 +22,20 @@
  * @copyright  2017 Neil Lathwood
  * @author     Neil Lathwood <gh+n@laf.io>
  */
 use Illuminate\Support\Str;
 $serverscheck_oids = [
     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
-    'sensor6Value.0' => '.1.3.6.1.4.1.17095.3.22.0',
-    'sensor7Value.0' => '.1.3.6.1.4.1.17095.3.26.0',
-    'sensor8Value.0' => '.1.3.6.1.4.1.17095.3.30.0',
 ];
 $temp_x = 1;
 foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
     if (Str::contains($oid_name, 'name')) {
         $tmp_oid = 'sensor' . $temp_x . 'Value.0';
         $current = $pre_cache['serverscheck_control'][$tmp_oid];
         if (Str::contains($oid_value, 'Humid')) {
             if (is_numeric($current)) {
                 $index = str_replace('.0', '', $oid_name);
                 $descr = $oid_value;

--- a/includes/discovery/sensors/humidity/teracom.inc.php
+++ b//dev/null
@@ -1,70 +0,0 @@
-<?php
-/*
- * LibreNMS
- *
- * Copyright (c) 2024 Config Services <team@configuration.co.uk>
- * This program is free software: you can redistribute it and/or modify it
- * under the terms of the GNU General Public License as published by the
- * Free Software Foundation, either version 3 of the License, or (at your
- * option) any later version.  Please see LICENSE.txt at the top level of
- * the source code distribution for details.
- *
- * @author     Config Services <team@configuration.co.uk>
-*/
-use Illuminate\Support\Arr;
-use Illuminate\Support\Str;
-$teracom_devices = [
-    'TCW220' => [
-        's11Int' => '.1.3.6.1.4.1.38783.2.3.1.1.1.0',
-        's21Int' => '.1.3.6.1.4.1.38783.2.3.1.2.1.0',
-        's31Int' => '.1.3.6.1.4.1.38783.2.3.1.3.1.0',
-        's41Int' => '.1.3.6.1.4.1.38783.2.3.1.4.1.0',
-        's51Int' => '.1.3.6.1.4.1.38783.2.3.1.5.1.0',
-        's61Int' => '.1.3.6.1.4.1.38783.2.3.1.6.1.0',
-        's71Int' => '.1.3.6.1.4.1.38783.2.3.1.7.1.0',
-        's81Int' => '.1.3.6.1.4.1.38783.2.3.1.8.1.0',
-    ],
-    'TCW241' => [
-        's11Int' => '.1.3.6.1.4.1.38783.3.3.1.1.1.0',
-        's21Int' => '.1.3.6.1.4.1.38783.3.3.1.2.1.0',
-        's31Int' => '.1.3.6.1.4.1.38783.3.3.1.3.1.0',
-        's41Int' => '.1.3.6.1.4.1.38783.3.3.1.4.1.0',
-        's51Int' => '.1.3.6.1.4.1.38783.3.3.1.5.1.0',
-        's61Int' => '.1.3.6.1.4.1.38783.3.3.1.6.1.0',
-        's71Int' => '.1.3.6.1.4.1.38783.3.3.1.7.1.0',
-        's81Int' => '.1.3.6.1.4.1.38783.3.3.1.8.1.0',
-    ],
-];
-if (Arr::exists($teracom_devices, $device['hardware'])) {
-    $teracom_mib = 'TERACOM-' . strtoupper($device['hardware']) . '-MIB';
-    $teracom_sensorsSetup = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensorsSetup")->table(1);
-    $teracom_sensors = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensors")->table(1);
-    $teracom_temps = array_merge($teracom_sensors[0], $teracom_sensorsSetup[0]);
-    foreach ($teracom_temps as $t_k => $t_v) {
-        preg_match("/(s[\d])([\d]*)(.*)/", $t_k, $t_d);
-        if ($t_d[2] == '') {
-            $teracom_data[$t_d[1]][$t_d[3]] = $t_v;
-        } else {
-            $teracom_data[$t_d[1]][$t_d[2]][$t_d[3]] = $t_v;
-        }
-    }
-    foreach ($teracom_data as $t_sensor => $t_data) {
-        if (Str::contains($t_data['description'], [':TSH2'])) {
-            $divisor = 1000;
-            $oid = $teracom_devices[$device['hardware']][$t_sensor . '2Int'];
-            $index = $device['hardware'] . $t_sensor . '2Int';
-            $high_limit = $t_data[1]['MAXInt'];
-            $low_limit = $t_data[1]['MINInt'];
-            $current = $t_data[1]['Int'];
-            discover_sensor(null, 'humidity', $device, $oid, $index, 'teracom', $t_data['description'], $divisor, '1', $low_limit, null, null, $high_limit, $current);
-        }
-    }
-}
-unset(
-    $teracom_mib,
-    $teracom_temp_value,
-    $teracom_sensorsSetup,
-    $teracom_sensors,
-    $teracom_temps,
-    $teracom_data,
-);

--- a/includes/discovery/sensors/power/dell.inc.php
+++ b/includes/discovery/sensors/power/dell.inc.php
@@ -21,32 +21,24 @@
  *
  * @copyright  2017 Neil Lathwood
  * @author     Neil Lathwood <neil@lathwood.co.uk>
  */
 $temp = snmpwalk_cache_multi_oid($device, 'amperageProbeTableEntry', [], 'MIB-Dell-10892', 'dell');
 $cur_oid = '.1.3.6.1.4.1.674.10892.1.600.30.1.6.';
 foreach ((array) $temp as $index => $entry) {
     $descr = $entry['amperageProbeLocationName'];
     if ($entry['amperageProbeType'] === 'amperageProbeTypeIsSystemWatts') {
         $divisor = 1;
-        (isset($entry['amperageProbeReading'])) ? $value = $entry['amperageProbeReading'] : $value = null;
-        (isset($entry['amperageProbeLowerCriticalThreshold'])) ? $lowlimit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor : $lowlimit = null;
-        (isset($entry['amperageProbeLowerCriticalThreshold'])) ? $low_warn_limit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor : $low_warn_limit = null;
-        (isset($entry['amperageProbeUpperNonCriticalThreshold'])) ? $warnlimit = $entry['amperageProbeUpperNonCriticalThreshold'] / $divisor : $warnlimit = null;
-        (isset($entry['amperageProbeUpperCriticalThreshold'])) ? $limit = $entry['amperageProbeUpperCriticalThreshold'] / $divisor : $limit = null;
+        $value = $entry['amperageProbeReading'];
+        $lowlimit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor;
+        $low_warn_limit = $entry['amperageProbeLowerCriticalThreshold'] / $divisor;
+        $warnlimit = $entry['amperageProbeUpperNonCriticalThreshold'] / $divisor;
+        $limit = $entry['amperageProbeUpperCriticalThreshold'] / $divisor;
         discover_sensor(null, 'power', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
     }
-    unset(
-        $descr,
-        $value,
-        $lowlimit,
-        $low_warn_limit,
-        $warnlimit,
-        $limit
-    );
 }
 unset(
     $temp,
     $cur_oid,
     $index,
     $entry
 );

--- a/includes/discovery/sensors/state/serverscheck.inc.php
+++ b/includes/discovery/sensors/state/serverscheck.inc.php
@@ -22,23 +22,20 @@
  * @copyright  2018 Marcus Pink
  * @author     Marcus Pink <mpink@avantgarde-labs.de>
  */
 use Illuminate\Support\Str;
 $serverscheck_oids = [
     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
-    'sensor6Value.0' => '.1.3.6.1.4.1.17095.3.22.0',
-    'sensor7Value.0' => '.1.3.6.1.4.1.17095.3.26.0',
-    'sensor8Value.0' => '.1.3.6.1.4.1.17095.3.30.0',
 ];
 foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
     if (Str::contains($oid_name, 'name') && Str::contains($oid_value, ['Flooding', 'Leckage'])) {
         preg_match("/(\d+)/", $oid_name, $temp_x);
         $tmp_oid = 'sensor' . $temp_x[0] . 'Value.0';
         $current = $pre_cache['serverscheck_control'][$tmp_oid];
         $state_name = 'Serverscheck_FloodSensor';
         if ($current) {
             $index = str_replace('.0', '', $oid_name);
             $descr = $oid_value;

--- a/includes/discovery/sensors/temperature/dell.inc.php
+++ b/includes/discovery/sensors/temperature/dell.inc.php
@@ -8,26 +8,18 @@
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 $temp = snmpwalk_cache_multi_oid($device, 'temperatureProbeTable', [], 'MIB-Dell-10892', 'dell');
 $cur_oid = '.1.3.6.1.4.1.674.10892.1.700.20.1.6.';
 $divisor = '10';
 if (is_array($temp)) {
     foreach ($temp as $index => $entry) {
         $descr = $temp[$index]['temperatureProbeLocationName'];
-        (isset($temp[$index]['temperatureProbeReading'])) ? $value = $temp[$index]['temperatureProbeReading'] / $divisor : $value = null;
-        (isset($temp[$index]['temperatureProbeLowerCriticalThreshold'])) ? $lowlimit = $temp[$index]['temperatureProbeLowerCriticalThreshold'] / $divisor : $lowlimit = null;
-        (isset($temp[$index]['temperatureProbeLowerNonCriticalThreshold'])) ? $low_warn_limit = $temp[$index]['temperatureProbeLowerNonCriticalThreshold'] / $divisor : $low_warn_limit = null;
-        (isset($temp[$index]['temperatureProbeUpperNonCriticalThreshold'])) ? $warnlimit = $temp[$index]['temperatureProbeUpperNonCriticalThreshold'] / $divisor : $warnlimit = null;
-        (isset($temp[$index]['temperatureProbeUpperCriticalThreshold'])) ? $limit = $temp[$index]['temperatureProbeUpperCriticalThreshold'] / $divisor : $limit = null;
+        $value = $temp[$index]['temperatureProbeReading'] / $divisor;
+        $lowlimit = $temp[$index]['temperatureProbeLowerCriticalThreshold'] / $divisor;
+        $low_warn_limit = $temp[$index]['temperatureProbeLowerNonCriticalThreshold'] / $divisor;
+        $warnlimit = $temp[$index]['temperatureProbeUpperNonCriticalThreshold'] / $divisor;
+        $limit = $temp[$index]['temperatureProbeUpperCriticalThreshold'] / $divisor;
         discover_sensor(null, 'temperature', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
-        unset(
-            $descr,
-            $value,
-            $lowlimit,
-            $low_warn_limit,
-            $warnlimit,
-            $limit
-        );
     }
 }

--- a/includes/discovery/sensors/temperature/fs-centec.inc.php
+++ b/includes/discovery/sensors/temperature/fs-centec.inc.php
@@ -16,17 +16,17 @@
                 'sensor_divisor' => 1,
                 'sensor_multiplier' => 1,
                 'sensor_limit_low' => $current['FS-SWITCH-V2-MIB::temperLowAlarmThreshold'] ?? null,
                 'sensor_limit_low_warn' => $current['FS-SWITCH-V2-MIB::temperLowWarnThreshold'] ?? null,
                 'sensor_limit_warn' => $current['FS-SWITCH-V2-MIB::temperHighWarnThreshold'] ?? null,
                 'sensor_limit' => $current['FS-SWITCH-V2-MIB::temperHighAlarmThreshold'] ?? null,
                 'sensor_current' => Number::cast($value),
                 'entPhysicalIndex' => $ifIndex,
                 'entPhysicalIndex_measured' => 'port',
                 'user_func' => 'fsParseChannelValue',
-                'group' => 'transceiver',
+                'group' => $ifName,
             ]));
             break; // only discover one sensor
         }
     }
 }
 unset($tempTable, $current);

--- a/includes/discovery/sensors/temperature/ocnos.inc.php
+++ b/includes/discovery/sensors/temperature/ocnos.inc.php
@@ -20,18 +20,18 @@
                         'sensor_divisor' => $divisor,
                         'sensor_multiplier' => 1,
                         'sensor_limit' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMax'] / $divisor : null,
                         'sensor_limit_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMax']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMax'] / $divisor : null,
                         'sensor_limit_low' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempCriticalThresholdMin'] / $divisor : null,
                         'sensor_limit_low_warn' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMin']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTempAlertThresholdMin'] / $divisor : null,
                         'sensor_current' => isset($channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature']) ? $channel_data['IPI-CMM-CHASSIS-MIB::cmmTransTemperature'] / $divisor : null,
                         'entPhysicalIndex' => $cmmStackUnitIndex * 10000 + $cmmTransIndex,
                         'entPhysicalIndex_measured' => 'port',
                         'user_func' => null,
-                        'group' => 'transceiver',
+                        'group' => $ifName,
                     ]));
                     continue 2; // common across channels
                 }
             }
         }
     }
 }

--- a/includes/discovery/sensors/temperature/serverscheck.inc.php
+++ b/includes/discovery/sensors/temperature/serverscheck.inc.php
@@ -22,29 +22,26 @@
  * @copyright  2017 Neil Lathwood
  * @author     Neil Lathwood <gh+n@laf.io>
  */
 use Illuminate\Support\Str;
 $serverscheck_oids = [
     'sensor1Value.0' => '.1.3.6.1.4.1.17095.3.2.0',
     'sensor2Value.0' => '.1.3.6.1.4.1.17095.3.6.0',
     'sensor3Value.0' => '.1.3.6.1.4.1.17095.3.10.0',
     'sensor4Value.0' => '.1.3.6.1.4.1.17095.3.14.0',
     'sensor5Value.0' => '.1.3.6.1.4.1.17095.3.18.0',
-    'sensor6Value.0' => '.1.3.6.1.4.1.17095.3.22.0',
-    'sensor7Value.0' => '.1.3.6.1.4.1.17095.3.26.0',
-    'sensor8Value.0' => '.1.3.6.1.4.1.17095.3.30.0',
 ];
 $temp_x = 1;
 foreach ($pre_cache['serverscheck_control'] as $oid_name => $oid_value) {
     if (Str::contains($oid_name, 'name')) {
         $tmp_oid = 'sensor' . $temp_x . 'Value.0';
         $current = $pre_cache['serverscheck_control'][$tmp_oid];
-        if (Str::contains($oid_value, ['Temp', 'BR'], ignoreCase: true)) {
+        if (Str::contains($oid_value, ['Temp', 'BR'])) {
             if (is_numeric($current)) {
                 $index = str_replace('.0', '', $oid_name);
                 $descr = $oid_value;
                 discover_sensor(null, 'temperature', $device, $serverscheck_oids[$tmp_oid], $index, 'serverscheck', $descr, 1, 1, null, null, null, null, $current);
             }
         }
         $temp_x++;
     }
 }

--- a/includes/discovery/sensors/temperature/teracom.inc.php
+++ b//dev/null
@@ -1,72 +0,0 @@
-<?php
-/*
- * LibreNMS
- *
- * Copyright (c) 2024 Config Services <team@configuration.co.uk>
- * This program is free software: you can redistribute it and/or modify it
- * under the terms of the GNU General Public License as published by the
- * Free Software Foundation, either version 3 of the License, or (at your
- * option) any later version.  Please see LICENSE.txt at the top level of
- * the source code distribution for details.
- *
- * @author     Config Services <team@configuration.co.uk>
-*/
-use Illuminate\Support\Arr;
-use Illuminate\Support\Str;
-$teracom_devices = [
-    'TCW220' => [
-        's11Int' => '.1.3.6.1.4.1.38783.2.3.1.1.1.0',
-        's21Int' => '.1.3.6.1.4.1.38783.2.3.1.2.1.0',
-        's31Int' => '.1.3.6.1.4.1.38783.2.3.1.3.1.0',
-        's41Int' => '.1.3.6.1.4.1.38783.2.3.1.4.1.0',
-        's51Int' => '.1.3.6.1.4.1.38783.2.3.1.5.1.0',
-        's61Int' => '.1.3.6.1.4.1.38783.2.3.1.6.1.0',
-        's71Int' => '.1.3.6.1.4.1.38783.2.3.1.7.1.0',
-        's81Int' => '.1.3.6.1.4.1.38783.2.3.1.8.1.0',
-    ],
-    'TCW241' => [
-        's11Int' => '.1.3.6.1.4.1.38783.3.3.1.1.1.0',
-        's21Int' => '.1.3.6.1.4.1.38783.3.3.1.2.1.0',
-        's31Int' => '.1.3.6.1.4.1.38783.3.3.1.3.1.0',
-        's41Int' => '.1.3.6.1.4.1.38783.3.3.1.4.1.0',
-        's51Int' => '.1.3.6.1.4.1.38783.3.3.1.5.1.0',
-        's61Int' => '.1.3.6.1.4.1.38783.3.3.1.6.1.0',
-        's71Int' => '.1.3.6.1.4.1.38783.3.3.1.7.1.0',
-        's81Int' => '.1.3.6.1.4.1.38783.3.3.1.8.1.0',
-    ],
-];
-if (Arr::exists($teracom_devices, $device['hardware'])) {
-    $teracom_mib = 'TERACOM-' . strtoupper($device['hardware']) . '-MIB';
-    $teracom_temp_value = SnmpQuery::cache()->hideMib()->get("$teracom_mib::temperatureUnit.0")->value();
-    $teracom_sensorsSetup = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensorsSetup")->table(1);
-    $teracom_sensors = SnmpQuery::cache()->hideMib()->walk("$teracom_mib::sensors")->table(1);
-    $teracom_temps = array_merge($teracom_sensors[0], $teracom_sensorsSetup[0]);
-    foreach ($teracom_temps as $t_k => $t_v) {
-        preg_match("/(s[\d])([\d]*)(.*)/", $t_k, $t_d);
-        if ($t_d[2] == '') {
-            $teracom_data[$t_d[1]][$t_d[3]] = $t_v;
-        } else {
-            $teracom_data[$t_d[1]][$t_d[2]][$t_d[3]] = $t_v;
-        }
-    }
-    foreach ($teracom_data as $t_sensor => $t_data) {
-        if (Str::contains($t_data['description'], [':TST1', ':TSH2'])) {
-            $divisor = 1000;
-            $oid = $teracom_devices[$device['hardware']][$t_sensor . '1Int'];
-            $index = $device['hardware'] . $t_sensor . '1Int';
-            $high_limit = ($teracom_temp_value == 1) ? fahrenheit_to_celsius($t_data[1]['MAXInt']) : $t_data[1]['MAXInt'];
-            $low_limit = ($teracom_temp_value == 1) ? fahrenheit_to_celsius($t_data[1]['MINInt']) : $t_data[1]['MINInt'];
-            $current = $t_data[1]['Int'];
-            $temp_func = ($teracom_temp_value == 1) ? 'fahrenheit_to_celsius' : null;
-            discover_sensor(null, 'temperature', $device, $oid, $index, 'teracom', $t_data['description'], $divisor, '1', $low_limit, null, null, $high_limit, $current, 'snmp', null, null, $temp_func);
-        }
-    }
-}
-unset(
-    $teracom_mib,
-    $teracom_temp_value,
-    $teracom_sensorsSetup,
-    $teracom_sensors,
-    $teracom_temps,
-    $teracom_data,
-);

--- a/includes/discovery/sensors/voltage/dell.inc.php
+++ b/includes/discovery/sensors/voltage/dell.inc.php
@@ -21,32 +21,24 @@
  *
  * @copyright  2017 Neil Lathwood
  * @author     Neil Lathwood <neil@lathwood.co.uk>
  */
 $temp = snmpwalk_cache_multi_oid($device, 'voltageProbeTable', [], 'MIB-Dell-10892', 'dell');
 $cur_oid = '.1.3.6.1.4.1.674.10892.1.600.20.1.6.';
 foreach ((array) $temp as $index => $entry) {
     $descr = $entry['voltageProbeLocationName'];
     if ($entry['voltageProbeType'] != 'voltageProbeTypeIsDiscrete') {
         $divisor = 1000;
-        (isset($entry['voltageProbeReading'])) ? $value = $entry['voltageProbeReading'] : $value = null;
-        (isset($entry['voltageProbeLowerCriticalThreshold'])) ? $lowlimit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor : $lowlimit = null;
-        (isset($entry['voltageProbeLowerCriticalThreshold'])) ? $low_warn_limit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor : $low_warn_limit = null;
-        (isset($entry['voltageProbeUpperNonCriticalThreshold'])) ? $warnlimit = $entry['voltageProbeUpperNonCriticalThreshold'] / $divisor : $warnlimit = null;
-        (isset($entry['voltageProbeUpperCriticalThreshold'])) ? $limit = $entry['voltageProbeUpperCriticalThreshold'] / $divisor : $limit = null;
+        $value = $entry['voltageProbeReading'];
+        $lowlimit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor;
+        $low_warn_limit = $entry['voltageProbeLowerCriticalThreshold'] / $divisor;
+        $warnlimit = $entry['voltageProbeUpperNonCriticalThreshold'] / $divisor;
+        $limit = $entry['voltageProbeUpperCriticalThreshold'] / $divisor;
         discover_sensor(null, 'voltage', $device, $cur_oid . $index, $index, 'dell', $descr, $divisor, '1', $lowlimit, $low_warn_limit, $warnlimit, $limit, $value, 'snmp', $index);
     }
-    unset(
-        $descr,
-        $value,
-        $lowlimit,
-        $low_warn_limit,
-        $warnlimit,
-        $limit
-    );
 }
 unset(
     $temp,
     $cur_oid,
     $index,
     $entry
 );

--- a/includes/functions.php
+++ b/includes/functions.php
@@ -241,21 +241,21 @@
         }
     }
     foreach (Config::getCombined($device['os'], 'bad_ifname_regexp') as $bnr) {
         if (preg_match($bnr . 'i', $ifName)) {
             d_echo("ignored by ifName: $ifName (matched: $bnr)\n");
             return false;
         }
     }
     foreach (Config::getCombined($device['os'], 'bad_ifalias_regexp') as $bar) {
         if (preg_match($bar . 'i', $ifAlias)) {
-            d_echo("ignored by ifAlias: $ifAlias (matched: $bar)\n");
+            d_echo("ignored by ifName: $ifAlias (matched: $bar)\n");
             return false;
         }
     }
     foreach (Config::getCombined($device['os'], 'bad_iftype') as $bt) {
         if (Str::contains($ifType, $bt)) {
             d_echo("ignored by ifType: $ifType (matched: $bt )\n");
             return false;
         }
     }
     foreach (Config::getCombined($device['os'], 'bad_ifoperstatus') as $bos) {
@@ -410,21 +410,21 @@
 }
 function create_sensor_to_state_index($device, $state_name, $index)
 {
 }
 function delta_to_bits($delta, $period)
 {
     return round($delta * 8 / $period, 2);
 }
 function report_this($message)
 {
-    return '<h2>' . htmlentities($message) . ' Please <a href="' . htmlentities(Config::get('project_issues')) . '">report this</a> to the ' . htmlentities(Config::get('project_name')) . ' developers.</h2>';
+    return '<h2>' . $message . ' Please <a href="' . Config::get('project_issues') . '">report this</a> to the ' . Config::get('project_name') . ' developers.</h2>';
 }//end report_this()
 function hytera_h2f($number, $nd)
 {
     if (strlen(str_replace(' ', '', $number)) == 4) {
         $number = \LibreNMS\Util\StringHelpers::asciiToHex($number, ' ');
     }
     $r = '';
     $y = explode(' ', $number);
     foreach ($y as $z) {
         $r = $z . '' . $r;

--- a/includes/html/api_functions.inc.php
+++ b/includes/html/api_functions.inc.php
@@ -897,31 +897,20 @@
     return check_port_permission($port_id, null, function ($port_id) {
         $ipv4 = dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `port_id` = ?', [$port_id]);
         $ipv6 = dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `port_id` = ?', [$port_id]);
         $ip_addresses_count = count(array_merge($ipv4, $ipv6));
         if ($ip_addresses_count == 0) {
             return api_error(404, "Port $port_id does not have any IP addresses");
         }
         return api_success(array_merge($ipv4, $ipv6), 'addresses');
     });
 }
-function get_port_fdb(Illuminate\Http\Request $request)
-{
-    $port_id = $request->route('portid');
-    return check_port_permission($port_id, null, function ($port_id) {
-        $fdb = PortsFdb::where('port_id', $port_id)->get();
-        if ($fdb->isEmpty()) {
-            return api_error(404, "Port {$port_id} does not have any MAC addresses in fdb");
-        }
-        return api_success($fdb, 'macs');
-    });
-}
 function get_network_ip_addresses(Illuminate\Http\Request $request)
 {
     $network_id = $request->route('id');
     $ipv4 = dbFetchRows('SELECT * FROM `ipv4_addresses` WHERE `ipv4_network_id` = ?', [$network_id]);
     $ipv6 = dbFetchRows('SELECT * FROM `ipv6_addresses` WHERE `ipv6_network_id` = ?', [$network_id]);
     $ip_addresses_count = count(array_merge($ipv4, $ipv6));
     if ($ip_addresses_count == 0) {
         return api_error(404, "IP network $network_id does not exist or is empty");
     }
     return api_success(array_merge($ipv4, $ipv6), 'addresses');

--- a//dev/null
+++ b/includes/html/common/availability-map.inc.php
@@ -0,0 +1,372 @@
+<?php
+/*
+ * LibreNMS
+ *
+ * Copyright (c) 2015 Sren Friis Rosiak <sorenrosiak@gmail.com>
+ * Copyright (c) 2016 Jens Langhammer <jens@beryju.org>
+ * Copyright (c) 2016 Cercel Valentin <crc@nuamchefazi.ro>
+ * This program is free software: you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License as published by the
+ * Free Software Foundation, either version 3 of the License, or (at your
+ * option) any later version.  Please see LICENSE.txt at the top level of
+ * the source code distribution for details.
+ */
+use LibreNMS\Alert\AlertUtil;
+use LibreNMS\Config;
+$mode = Session::get('map_view', 0);
+if (isset($settings['mode_select']) && $settings['mode_select'] !== '') {
+    $mode = $settings['mode_select'];
+}
+$select_modes = [
+    '0' => 'only devices',
+    '1' => 'only services',
+    '2' => 'devices and services',
+];
+if (Config::get('webui.availability_map_compact') == 1) {
+    $compact_tile = $settings['tile_size'];
+}
+$show_disabled_ignored = $settings['show_disabled_and_ignored'] ?? false;
+if (defined('SHOW_SETTINGS')) {
+    $common_output[] = '
+    <form class="form" onsubmit="widget_settings(this); return false;">
+        ' . csrf_field() . '
+        <div class="form-group">
+            <div class="col-sm-4">
+                <label for="title" class="control-label availability-map-widget-header">Widget title</label>
+            </div>
+            <div class="col-sm-6">
+                <input type="text" class="form-control" name="title" placeholder="Custom title for widget" value="' . htmlspecialchars($settings['title']) . '">
+            </div>
+        </div>';
+    if (Config::get('webui.availability_map_compact') === false) {
+        $common_output[] = '
+    <div class="form-group">
+        <div class="col-sm-4">
+            <label for="color_only_select" class="control-label availability-map-widget-header">Uniform Tiles</label>
+        </div>
+        <div class="col-sm-6">
+            <select class="form-control" name="color_only_select">
+                <option value="1"' . ($settings['color_only_select'] == 1 ? ' selected' : '') . ' >yes</option>
+                <option value="0"' . ($settings['color_only_select'] == 1 ? '' : ' selected') . ' >no</option>
+            </select>
+        </div>
+    </div>
+';
+    }
+    if (Config::get('webui.availability_map_compact') == 1) {
+        $common_output[] = '
+        <div class="form-group">
+            <div class="col-sm-4">
+                <label for="tile_size" class="control-label availability-map-widget-header">Tile size</label>
+            </div>
+            <div class="col-sm-6">
+                <input type="text" class="form-control" name="tile_size" value="' . $compact_tile . '">
+            </div>
+        </div>';
+    }
+    if ($show_disabled_ignored == 1) {
+        $selected_yes = 'selected';
+        $selected_no = '';
+    } else {
+        $selected_yes = '';
+        $selected_no = 'selected';
+    }
+    $common_output[] = '
+    <div class="form-group">
+        <div class="col-sm-4">
+            <label for="show_disabled_and_ignored" class="control-label availability-map-widget-header">Disabled polling/alerting</label>
+        </div>
+        <div class="col-sm-6">
+            <select class="form-control" name="show_disabled_and_ignored">
+                <option value="1" ' . $selected_yes . '>yes</option>
+                <option value="0" ' . $selected_no . '>no</option>
+            </select>
+        </div>
+    </div>';
+    $common_output[] = '
+    <div class ="form-group">
+        <div class="col-sm-4">
+            <label for="mode_select" class="control-lable availability-map-widget-header">Mode</label>
+        </div>
+        <div class="col-sm-6">
+            <select name="mode_select" class="form-control">';
+    if (Config::get('show_services') == 0) {
+        $common_output[] = '<option value="0" selected>only devices</option>';
+    } else {
+        foreach ($select_modes as $mode_select => $option) {
+            if ($mode_select == $settings['mode_select']) {
+                $selected = 'selected';
+            } else {
+                $selected = '';
+            }
+            $common_output[] = '<option value="' . $mode_select . '" ' . $selected . '>' . $option . '</option>';
+        }
+    }
+    $common_output[] = '
+            </select>
+        </div>
+    </div>';
+    if (Config::get('webui.availability_map_compact') == 1) {
+        $common_outputp[] = '
+        <div class="form-group">
+            <div class="col-sm-4">
+                <label for="tile_size" class="control-label availability-map-widget-header">Tile width</label>
+            </div>
+            <div class="col-sm-6">
+                <input class="form-control" type="text" onkeypress="return (event.charCode == 8 || event.charCode == 0) ? null : event.charCode >= 48 && event.charCode <= 57" name="tile_size" placeholder="Tile side in px" value="' . $compact_tile . '">
+            </div>
+        </div>
+        ';
+    }
+    $common_output[] = '
+        <br style="clear:both;">
+        <div class="form-group">
+            <div class="col-sm-2">
+                <button type="submit" class="btn btn-default">Set</button>
+            </div>
+        </div>
+    </form>';
+} else {
+    require_once 'includes/html/object-cache.inc.php';
+    $host_up_count = 0;
+    $host_warn_count = 0;
+    $host_down_count = 0;
+    $host_maintenance_count = 0;
+    $host_disable_notify_count = 0;
+    $host_disabled_count = 0;
+    $service_up_count = 0;
+    $service_warn_count = 0;
+    $service_down_count = 0;
+    $service_ignored_count = 0;
+    $service_disabled_count = 0;
+    if (Config::get('webui.availability_map_sort_status') == 1) {
+        $deviceOrderBy = 'status';
+        $serviceOrderBy = '`S`.`service_status` DESC';
+    } else {
+        $deviceOrderBy = 'hostname';
+        $serviceOrderBy = '`D`.`hostname`';
+    }
+    if ($mode == 0 || $mode == 2) {
+        if (Config::get('webui.availability_map_use_device_groups') != 0) {
+            $device_group = 'SELECT `D`.`device_id` FROM `device_group_device` AS `D` WHERE `device_group_id` = ?';
+            $in_devices = dbFetchColumn($device_group, [Session::get('group_view')]);
+        }
+        $sql = 'SELECT `D`.`hostname`, `D`.`sysName`, `D`.`display`, `D`.`device_id`, `D`.`status`, `D`.`uptime`, `D`.`last_polled`, `D`.`os`, `D`.`icon`, `D`.`disable_notify`, `D`.`disabled` FROM `devices` AS `D`';
+        if (! Auth::user()->hasGlobalRead()) {
+            $sql .= ' , `devices_perms` AS P WHERE D.`device_id` = P.`device_id` AND P.`user_id` = ? AND ';
+            $param = [Auth::id()];
+        } else {
+            $sql .= ' WHERE ';
+            $param = [];
+        }
+        if ($show_disabled_ignored != 1) {
+            $sql .= '`D`.`disable_notify` = 0 AND `D`.`disabled` = 0 ';
+        } else {
+            $sql .= '(`D`.`status` IN (0,1,2) OR `D`.`disable_notify` = 1 OR `D`.`disabled` = 1)';
+        }
+        if (Config::get('webui.availability_map_use_device_groups') != 0 && ! empty($in_devices)) {
+            $sql .= ' AND `D`.`device_id` IN ' . dbGenPlaceholders(count($in_devices));
+            $param = array_merge($param, $in_devices);
+        }
+        $sql .= ' ORDER BY `' . $deviceOrderBy . '`';
+        $temp_output = [];
+        foreach (dbFetchRows($sql, $param) as $device) {
+            $updowntime = '';
+            if ($device['disabled'] == '1') {
+                $deviceState = 'disabled';
+                $deviceLabel = 'blackbg';
+                $host_disabled_count++;
+            } elseif ($device['disable_notify'] == '1') {
+                $deviceState = 'alert-disabled';
+                $deviceLabel = 'label-default';
+                $host_disable_notify_count++;
+            } elseif ($device['status'] == '1') {
+                if (($device['uptime'] < Config::get('uptime_warning')) && ($device['uptime'] != 0)) {
+                    $deviceState = 'warn';
+                    $deviceLabel = 'label-warning';
+                    $deviceLabelOld = 'availability-map-oldview-box-warn';
+                    $host_warn_count++;
+                } else {
+                    $deviceState = 'up';
+                    $deviceLabel = 'label-success';
+                    $deviceLabelOld = 'availability-map-oldview-box-up';
+                    $host_up_count++;
+                }
+                $updowntime = ($device['uptime'] ? ' - ' : '') . \LibreNMS\Util\Time::formatInterval($device['uptime']);
+            } else {
+                $deviceState = 'down';
+                $deviceLabel = 'label-danger';
+                $deviceLabelOld = 'availability-map-oldview-box-down';
+                $host_down_count++;
+                $updowntime = ($device['last_polled'] ? ' - ' . \LibreNMS\Util\Time::formatInterval(time() - strtotime($device['last_polled'])) : '');
+            }
+            if (AlertUtil::isMaintenance($device['device_id'])) {
+                $deviceLabel = 'label-default';
+                $host_maintenance_count++;
+            }
+            $device_system_name = format_hostname($device);
+            if (Config::get('webui.availability_map_compact') == 0) {
+                if ($directpage == 'yes') {
+                    $deviceIcon = getIconTag($device);
+                    $temp_output[] = '
+                    <a href="' . \LibreNMS\Util\Url::deviceUrl((int) $device['device_id']) . '" title="' . $device_system_name . $updowntime . '">
+                    <div class="device-availability ' . $deviceState . '" style="width:' . Config::get('webui.availability_map_box_size') . 'px;">
+                        <span class="availability-label label ' . $deviceLabel . ' label-font-border">' . $deviceState . '</span>
+                        <span class="device-icon">' . $deviceIcon . '</span><br>
+                        <span class="small">' . shorthost($device_system_name) . '</span>
+                    </div>
+                    </a>';
+                } else {
+                    if ($settings['color_only_select'] == 1) {
+                        $deviceState = ' ';
+                        $deviceLabel .= ' widget-availability-fixed';
+                    }
+                    $temp_output[] = '
+                    <a href="' . \LibreNMS\Util\Url::deviceUrl((int) $device['device_id']) . '" title="' . $device_system_name . $updowntime . '">
+                        <span class="label ' . $deviceLabel . ' widget-availability label-font-border">' . $deviceState . '</span>
+                    </a>';
+                }
+            } else {
+                $temp_output[] = "<a href='" . \LibreNMS\Util\Url::deviceUrl((int) $device['device_id']) . "' title='" . $device_system_name . $updowntime . "'><div class='" . $deviceLabelOld . "' style='width:${compact_tile}px;height:${compact_tile}px;'></div></a>";
+            }
+        }
+    }
+    if (($mode == 1 || $mode == 2) && (Config::get('show_services') != 0)) {
+        if (Auth::user()->hasGlobalRead()) {
+            $service_query = 'select `S`.`service_type`, `S`.`service_id`, `S`.`service_desc`, `S`.`service_status`, `D`.`hostname`, `D`.`sysName`, `D`.`device_id`, `D`.`os`, `D`.`icon` from services S, devices D where `S`.`device_id` = `D`.`device_id` ORDER BY ' . $serviceOrderBy . ';';
+            $service_par = [];
+        } else {
+            $service_query = 'select `S`.`service_type`, `S`.`service_id`, `S`.`service_desc`, `S`.`service_status`, `D`.`hostname`, `D`.`sysName`, `D`.`device_id`, `D`.`os`, `D`.`icon` from services S, devices D, devices_perms P where `S`.`device_id` = `D`.`device_id` AND D.device_id = P.device_id AND P.user_id = ? ORDER BY ' . $serviceOrderBy . ';';
+            $service_par = [Auth::id()];
+        }
+        $services = dbFetchRows($service_query, $service_par);
+        if (count($services) > 0) {
+            foreach ($services as $service) {
+                if ($service['service_status'] == '0') {
+                    $serviceLabel = 'label-success';
+                    $serviceLabelOld = 'availability-map-oldview-box-up';
+                    $serviceState = 'up';
+                    $service_up_count++;
+                } elseif ($service['service_status'] == '1') {
+                    $serviceLabel = 'label-warning';
+                    $serviceLabelOld = 'availability-map-oldview-box-warn';
+                    $serviceState = 'warn';
+                    $service_warn_count++;
+                } else {
+                    $serviceLabel = 'label-danger';
+                    $serviceLabelOld = 'availability-map-oldview-box-down';
+                    $serviceState = 'down';
+                    $service_down_count++;
+                }
+                $service_system_name = format_hostname($service);
+                if (Config::get('webui.availability_map_compact') == 0) {
+                    if ($directpage == 'yes') {
+                        $deviceIcon = getIconTag($service);
+                        $temp_output[] = '
+                        <a href="' . \LibreNMS\Util\Url::generate(['page' => 'device', 'device' => $service['device_id'], 'tab' => 'services']) . '" title="' . $service_system_name . ' - ' . $service['service_type'] . ' - ' . $service['service_desc'] . '">
+                            <div class="service-availability ' . $serviceState . '" style="width:' . Config::get('webui.availability_map_box_size') . 'px;">
+                                <span class="service-name-label label ' . $serviceLabel . ' label-font-border">' . $service['service_type'] . '</span>
+                                <span class="availability-label label ' . $serviceLabel . ' label-font-border">' . $serviceState . '</span>
+                                <span class="device-icon">' . $deviceIcon . '</span><br>
+                                <span class="small">' . shorthost($service_system_name) . '</span>
+                            </div>
+                        </a>';
+                    } else {
+                        $serviceText = $service['service_type'] . ' - ' . $serviceState;
+                        if ($settings['color_only_select'] == 1) {
+                            $serviceText = ' ';
+                            $serviceLabel .= ' widget-availability-fixed';
+                        }
+                        $temp_output[] = '
+                        <a href="' . \LibreNMS\Util\Url::generate(['page' => 'device', 'device' => $service['device_id'], 'tab' => 'services']) . '" title="' . shorthost($service_system_name) . ' - ' . $service['service_type'] . ' - ' . $service['service_desc'] . '">
+                            <span class="label ' . $serviceLabel . ' widget-availability label-font-border">' . $serviceText . '</span>
+                        </a>';
+                    }
+                } else {
+                    $temp_output[] = "<a href='" . \LibreNMS\Util\Url::generate(['page' => 'device', 'device' => $service['device_id'], 'tab' => 'services']) . "' title='${service_system_name} - ${service['service_type']} - ${service['service_desc']}'><div class='" . $serviceLabelOld . "' style='width:${compact_tile}px;height:${compact_tile}px;'></div></a>";
+                }
+            }
+        } else {
+            $temp_output[] = '';
+        }
+    }
+    if ($directpage == 'yes') {
+        $temp_header[] = '
+        <div class="page-availability-title-left">
+            <span class="page-availability-title">Availability map for</span>
+            <select id="mode" class="page-availability-report-select" name="mode">';
+        if (Config::get('show_services') == 0) {
+            $temp_header[] = '<option value="0" selected>only devices</option>';
+        } else {
+            foreach ($select_modes as $mode_select => $option) {
+                if ($mode_select == $mode) {
+                    $selected = 'selected';
+                } else {
+                    $selected = '';
+                }
+                $temp_header[] = '<option value="' . $mode_select . '" ' . $selected . '>' . $option . '</option>';
+            }
+        }
+        $temp_header[] =
+            '</select>
+        </div>
+        <div class="page-availability-title-right">';
+        if ((Config::get('webui.availability_map_use_device_groups') != 0) && ($mode == 0 || $mode == 2)) {
+            $sql = 'SELECT `G`.`id`, `G`.`name` FROM `device_groups` AS `G`';
+            $dev_groups = dbFetchRows($sql);
+            if (Session::get('group_view') == 0) {
+                $selected = 'selected';
+            } else {
+                $selected = '';
+            }
+            $temp_header[] = '
+            <span class="page-availability-title">Device group</span>
+            <select id="group" class="page-availability-report-select" name="group">
+                <option value="0" ' . $selected . '>show all devices</option>';
+            foreach ($dev_groups as $dev_group) {
+                if (Session::get('group_view') == $dev_group['id']) {
+                    $selected = 'selected';
+                } else {
+                    $selected = '';
+                }
+                $temp_header[] = '<option value="' . $dev_group['id'] . '" ' . $selected . '>' . $dev_group['name'] . '</option>';
+            }
+            $temp_header[] = '</select>';
+        }
+    }
+    if ($directpage == 'yes') {
+        $deviceClass = 'page-availability-report-host';
+        $serviceClass = 'page-availability-report-host';
+    } else {
+        $deviceClass = 'widget-availability-host';
+        $serviceClass = 'widget-availability-service';
+    }
+    $disabled_ignored_header = $show_disabled_ignored == 1 ? '
+            <span class="label label-default label-font-border label-border">alert-disabled: ' . $host_disable_notify_count . '</span>
+            <span class="label blackbg label-font-border label-border">disabled: ' . $host_disabled_count . '</span>' : '';
+    if ($mode == 0 || $mode == 2) {
+        $temp_header[] = '
+            <div class="' . $deviceClass . '">
+                <span>Total hosts</span>
+                <span class="label label-success label-font-border label-border">up: ' . $host_up_count . '</span>
+                <span class="label label-warning label-font-border label-border">warn: ' . $host_warn_count . '</span>
+                <span class="label label-danger label-font-border label-border">down: ' . $host_down_count . '</span>';
+        if ($host_maintenance_count) {
+            $temp_header[] = '<span class="label label-default label-font-border label-border">maintenance: ' . $host_maintenance_count . '</span>';
+        }
+        $temp_header[] = $disabled_ignored_header . '
+            </div>';
+    }
+    if (($mode == 1 || $mode == 2) && (Config::get('show_services') != 0)) {
+        $temp_header[] = '
+            <div class="' . $serviceClass . '">
+                <span>Total services</span>
+                <span class="label label-success label-font-border label-border">up: ' . $service_up_count . '</span>
+                <span class="label label-warning label-font-border label-border">warn: ' . $service_warn_count . '</span>
+                <span class="label label-danger label-font-border label-border">down: ' . $service_down_count . '</span>
+            </div>';
+    }
+    $temp_header[] = '</div>';
+    $temp_header[] = '<br style="clear:both;">';
+    $common_output = array_merge($temp_header, $temp_output);
+}

--- a//dev/null
+++ b/includes/html/common/worldmap.inc.php
@@ -0,0 +1,261 @@
+<?php
+/* Copyright (C) 2014 Daniel Preussker <f0o@devilcode.org>
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation, either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+/**
+ * Custom Frontpage
+ *
+ * @author f0o <f0o@devilcode.org>
+ * @copyright 2014 f0o, LibreNMS
+ * @license GPL
+ */
+use Illuminate\Support\Facades\Auth;
+use LibreNMS\Alert\AlertUtil;
+use LibreNMS\Config;
+$install_dir = Config::get('install_dir');
+if (Config::get('map.engine', 'leaflet') == 'leaflet') {
+    $temp_output = '
+<script src="js/leaflet.js"></script>
+<script src="js/leaflet.markercluster.js"></script>
+<script src="js/leaflet.awesome-markers.min.js"></script>
+<div id="leaflet-map"></div>
+<script>
+        ';
+    $init_lat = Config::get('leaflet.default_lat', 51.48);
+    $init_lng = Config::get('leaflet.default_lng', 0);
+    $init_zoom = Config::get('leaflet.default_zoom', 5);
+    $group_radius = Config::get('leaflet.group_radius', 80);
+    $tile_url = Config::get('leaflet.tile_url', '{s}.tile.openstreetmap.org');
+    $show_status = [0, 1];
+    $map_init = '[' . $init_lat . ', ' . $init_lng . '], ' . sprintf('%01.1f', $init_zoom);
+    $temp_output .= 'var map = L.map(\'leaflet-map\', { zoomSnap: 0.1 } ).setView(' . $map_init . ');
+L.tileLayer(\'//' . $tile_url . '/{z}/{x}/{y}.png\', {
+    attribution: \'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors\'
+}).addTo(map);
+var markers = L.markerClusterGroup({
+    maxClusterRadius: ' . $group_radius . ',
+    iconCreateFunction: function (cluster) {
+        var markers = cluster.getAllChildMarkers();
+        var n = 0;
+        color = "green"
+        newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
+        for (var i = 0; i < markers.length; i++) {
+            if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
+                color = "blue";
+            }
+            if (markers[i].options.icon.options.markerColor == "red") {
+                color = "red";
+            }
+        }
+        return L.divIcon({ html: cluster.getChildCount(), className: color+newClass, iconSize: L.point(40, 40) });
+    },
+  });
+var redMarker = L.AwesomeMarkers.icon({
+    icon: \'server\',
+    markerColor: \'red\', prefix: \'fa\', iconColor: \'white\'
+  });
+var blueMarker = L.AwesomeMarkers.icon({
+      icon: \'server\',
+      markerColor: \'blue\', prefix: \'fa\', iconColor: \'white\'
+    });
+var greenMarker = L.AwesomeMarkers.icon({
+    icon: \'server\',
+    markerColor: \'green\', prefix: \'fa\', iconColor: \'white\'
+  });
+        ';
+    if (Auth::user()->hasGlobalRead()) {
+        $sql = "SELECT DISTINCT(`device_id`),`location`,`sysName`,`hostname`,`os`,`status`,`lat`,`lng` FROM `devices`
+                LEFT JOIN `locations` ON `devices`.`location_id`=`locations`.`id`
+                WHERE `disabled`=0 AND `ignore`=0 AND ((`lat` != '' AND `lng` != '') OR (`location` REGEXP '\[[0-9\.\, ]+\]'))
+                AND (`lat` IS NOT NULL AND `lng` IS NOT NULL)
+                AND `status` IN " . dbGenPlaceholders(count($show_status)) .
+                ' ORDER BY `status` ASC, `hostname`';
+        $param = $show_status;
+    } else {
+        $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
+        $sql = "SELECT DISTINCT(`devices`.`device_id`) as `device_id`,`location`,`sysName`,`hostname`,`os`,`status`,`lat`,`lng`
+                FROM `devices`
+                LEFT JOIN `locations` ON `devices`.location_id=`locations`.`id`
+                WHERE `disabled`=0 AND `ignore`=0 AND ((`lat` != '' AND `lng` != '') OR (`location` REGEXP '\[[0-9\.\, ]+\]'))
+                AND (`lat` IS NOT NULL AND `lng` IS NOT NULL)
+                AND `devices`.`device_id` IN " . dbGenPlaceholders(count($device_ids)) .
+                ' AND `status` IN ' . dbGenPlaceholders(count($show_status)) .
+                ' ORDER BY `status` ASC, `hostname`';
+        $param = array_merge($device_ids, $show_status);
+    }
+    foreach (dbFetchRows($sql, $param) as $map_devices) {
+        $icon = 'greenMarker';
+        $z_offset = 0;
+        $tmp_loc = parse_location($map_devices['location']);
+        if (is_numeric($tmp_loc['lat']) && is_numeric($tmp_loc['lng'])) {
+            $map_devices['lat'] = $tmp_loc['lat'];
+            $map_devices['lng'] = $tmp_loc['lng'];
+        }
+        if ($map_devices['status'] == 0) {
+            if (AlertUtil::isMaintenance($map_devices['device_id'])) {
+                if ($show_status == 0) { // Don't show icon if only down devices should be shown
+                    continue;
+                } else {
+                    $icon = 'blueMarker';
+                    $z_offset = 5000;
+                }
+            } else {
+                $icon = 'redMarker';
+                $z_offset = 10000;  // move marker to foreground
+            }
+        }
+        $temp_output .= "var title = '<a href=\"" . \LibreNMS\Util\Url::deviceUrl((int) $map_devices['device_id']) . '"><img src="' . getIcon($map_devices) . '" width="32" height="32" alt=""> ' . format_hostname($map_devices) . "</a>';
+var tooltip = '" . format_hostname($map_devices) . "';
+var marker = L.marker(new L.LatLng(" . $map_devices['lat'] . ', ' . $map_devices['lng'] . "), {title: tooltip, icon: $icon, zIndexOffset: $z_offset});
+marker.bindPopup(title);
+    markers.addLayer(marker);\n";
+    }
+    if (Config::get('network_map_show_on_worldmap')) {
+        if (Auth::user()->hasGlobalRead()) {
+            $sql = "
+            SELECT
+              ll.id AS left_id,
+              ll.lat AS left_lat,
+              ll.lng AS left_lng,
+              rl.id AS right_id,
+              rl.lat AS right_lat,
+              rl.lng AS right_lng,
+              sum(lp.ifSpeed) AS link_capacity,
+              sum(lp.ifOutOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_out_usage_pct,
+              sum(lp.ifInOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_in_usage_pct
+            FROM
+              devices AS ld,
+              devices AS rd,
+              links AS l,
+              locations AS ll,
+              locations AS rl,
+              ports as lp
+            WHERE
+              l.local_device_id = ld.device_id
+              AND l.remote_device_id = rd.device_id
+              AND ld.location_id != rd.location_id
+              AND ld.location_id = ll.id
+              AND rd.location_id = rl.id
+              AND lp.device_id = ld.device_id
+              AND lp.port_id = l.local_port_id
+              AND lp.ifType = 'ethernetCsmacd'
+              AND ld.disabled = 0
+              AND ld.ignore = 0
+              AND rd.disabled = 0
+              AND rd.ignore = 0
+              AND lp.ifOutOctets_rate != 0
+              AND lp.ifInOctets_rate != 0
+              AND lp.ifOperStatus = 'up'
+              AND ll.lat IS NOT NULL
+              AND ll.lng IS NOT NULL
+              AND rl.lat IS NOT NULL
+              AND rl.lng IS NOT NULL
+              AND ld.status IN " . dbGenPlaceholders(count($show_status)) . '
+              AND rd.status IN ' . dbGenPlaceholders(count($show_status)) . '
+            GROUP BY
+              left_id, right_id, ll.lat, ll.lng, rl.lat, rl.lng
+                  ';
+            $param = array_merge($show_status, $show_status);
+        } else {
+            $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
+            $sql = "
+            SELECT
+              ll.id AS left_id,
+              ll.lat AS left_lat,
+              ll.lng AS left_lng,
+              rl.id AS right_id,
+              rl.lat AS right_lat,
+              rl.lng AS right_lng,
+              sum(lp.ifSpeed) AS link_capacity,
+              sum(lp.ifOutOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_out_usage_pct,
+              sum(lp.ifInOctets_rate) * 8 / sum(lp.ifSpeed) * 100 as link_in_usage_pct
+            FROM
+              devices AS ld,
+              devices AS rd,
+              links AS l,
+              locations AS ll,
+              locations AS rl,
+              ports as lp
+            WHERE
+              l.local_device_id = ld.device_id
+              AND l.remote_device_id = rd.device_id
+              AND ld.location_id != rd.location_id
+              AND ld.location_id = ll.id
+              AND rd.location_id = rl.id
+              AND lp.device_id = ld.device_id
+              AND lp.port_id = l.local_port_id
+              AND lp.ifType = 'ethernetCsmacd'
+              AND ld.disabled = 0
+              AND ld.ignore = 0
+              AND rd.disabled = 0
+              AND rd.ignore = 0
+              AND lp.ifOutOctets_rate != 0
+              AND lp.ifInOctets_rate != 0
+              AND lp.ifOperStatus = 'up'
+              AND ll.lat IS NOT NULL
+              AND ll.lng IS NOT NULL
+              AND rl.lat IS NOT NULL
+              AND rl.lng IS NOT NULL
+              AND ld.status IN " . dbGenPlaceholders(count($show_status)) . '
+              AND rd.status IN ' . dbGenPlaceholders(count($show_status)) . '
+              AND ld.device_id IN ' . dbGenPlaceholders(count($device_ids)) . '
+              AND rd.device_id IN ' . dbGenPlaceholders(count($device_ids)) . '
+            GROUP BY
+              left_id, right_id, ll.lat, ll.lng, rl.lat, rl.lng
+                  ';
+            $param = array_merge($show_status, $show_status, $device_ids, $device_ids);
+        }
+        foreach (dbFetchRows($sql, $param) as $link) {
+            $icon = 'greenMarker';
+            $z_offset = 0;
+            $speed = $link['link_capacity'] / 1000000000;
+            if ($speed > 500000) {
+                $width = 20;
+            } else {
+                $width = round(0.77 * pow($speed, 0.25));
+            }
+            $link_used = max($link['link_out_usage_pct'], $link['link_in_usage_pct']);
+            $link_used = round(2 * $link_used, -1) / 2;
+            if ($link_used > 100) {
+                $link_used = 100;
+            }
+            if (is_nan($link_used)) {
+                $link_used = 0;
+            }
+            $link_color = Config::get("network_map_legend.$link_used");
+            $temp_output .= 'var marker = new L.Polyline([new L.LatLng(' . $link['left_lat'] . ', ' . $link['left_lng'] . '), new L.LatLng(' . $link['right_lat'] . ', ' . $link['right_lng'] . ")], {
+                color: '" . $link_color . "',
+                weight: " . $width . ',
+                opacity: 0.8,
+                smoothFactor: 1
+            });
+            markers.addLayer(marker);
+            ';
+        }
+    }
+    $temp_output .= 'map.addLayer(markers);
+map.scrollWheelZoom.disable();
+$(document).ready(function(){
+    $("#leaflet-map").on("click", function(event) {
+        map.scrollWheelZoom.enable();
+    });
+    $("#leaflet-map").on("mouseleave", function(event) {
+        map.scrollWheelZoom.disable();
+    });
+});
+</script>';
+} else {
+    $temp_output = 'Mapael engine not supported here';
+}
+unset($common_output);
+$common_output[] = $temp_output;

--- a/includes/html/dev-overview-data.inc.php
+++ b/includes/html/dev-overview-data.inc.php
@@ -10,42 +10,40 @@
           <div class='panel panel-default panel-condensed device-overview'>
             <div class='panel-heading'>";
 if (Config::get('overview_show_sysDescr')) {
     echo '<i class="fa fa-id-card fa-lg icon-theme" aria-hidden="true"></i> <strong>';
     echo Config::get('overview_show_sysDescr', true) ? Clean::html($device['sysDescr'], []) : 'System';
     echo '</strong>';
 }
 echo '</div><div class="panel-body">';
 echo '<script src="js/leaflet.js"></script>';
 echo '<script src="js/L.Control.Locate.min.js"></script>';
-echo '<script src="js/leaflet.markercluster.js"></script>';
-echo '<script src="js/leaflet.awesome-markers.min.js"></script>';
 if ($device['os'] == 'ios' || $device['os'] == 'iosxe') {
     \LibreNMS\Util\Rewrite::ciscoHardware($device, false);
 }
 if ($device['features']) {
     $device['features'] = '(' . $device['features'] . ')';
 }
 $device['os_text'] = Config::getOsSetting($device['os'], 'text');
 echo '<div class="row">
         <div class="col-sm-4">System Name</div>
         <div class="col-sm-8">' . Clean::html($device['sysName'], []) . ' </div>
       </div>';
 if (! empty($device['overwrite_ip'])) {
-    echo "<div class='row'><div class='col-sm-4'>Assigned IP</div><div class='col-sm-8'>" . htmlentities($device['overwrite_ip']) . '</div></div>';
+    echo "<div class='row'><div class='col-sm-4'>Assigned IP</div><div class='col-sm-8'>{$device['overwrite_ip']}</div></div>";
 } elseif (! empty($device['ip'])) {
-    echo "<div class='row'><div class='col-sm-4'>Resolved IP</div><div class='col-sm-8'>" . htmlentities($device['ip']) . '</div></div>';
+    echo "<div class='row'><div class='col-sm-4'>Resolved IP</div><div class='col-sm-8'>{$device['ip']}</div></div>";
 } else {
     try {
         $ip = (string) IP::parse($device['hostname']);
         if ($ip !== format_hostname($device)) {
-            echo "<div class='row'><div class='col-sm-4'>IP Address</div><div class='col-sm-8'>" . htmlentities($ip) . '</div></div>';
+            echo "<div class='row'><div class='col-sm-4'>IP Address</div><div class='col-sm-8'>$ip</div></div>";
         }
     } catch (InvalidIpException $e) {
     }
 }
 if ($device['purpose']) {
     echo '<div class="row">
         <div class="col-sm-4">Description</div>
         <div class="col-sm-8">' . Clean::html($device['purpose'], []) . '</div>
       </div>';
 }
@@ -123,142 +121,45 @@
         <div class="col-sm-8"><span id="coordinates-text">' . $location_coords . '</span><div class="pull-right">';
     echo '<button type="button" id="toggle-map-button" class="btn btn-primary btn-xs" data-toggle="collapse" data-target="#toggle-map"><i class="fa fa-map" style="color:white" aria-hidden="true"></i> <span>View</span></button>';
     if ($location_valid) {
         echo ' <a id="map-it-button" href="https://maps.google.com/?q=' . $location->lat . ',' . $location->lng . '" target="_blank" class="btn btn-success btn-xs" role="button"><i class="fa fa-map-marker" style="color:white" aria-hidden="true"></i> Map</a>';
     }
     echo '</div>
         </div>
     </div>
     <div id="toggle-map" class="row collapse"><div id="location-map"></div></div>
     <script>
-        var device_map, device_marker_cluster;
-        L.Control.Fullscreen = L.Control.extend({
-            onAdd: function(map) {
-                var fsdiv = L.DomUtil.create("div");
-                var a = document.createElement("a");
-                a.title = "Go to fullscreen map";
-                a.href = "#";
-                a.style.textDecoration = "none";
-                a.classList.add("fa-solid","fa-expand","fa-2xl");
-                a.onclick = function() {
-                    var zoom = device_map.getZoom();
-                    var coords = device_map.getCenter();
-                    window.location.href = "fullscreenmap?lat=" + coords.lat + "&lng=" + coords.lng + "&zoom=" + zoom;
-                    return false
-                };
-                fsdiv.appendChild(a);
-                return fsdiv;
-            }
-        });
-        L.control.fullscreen = function(opts) {
-            return new L.Control.Fullscreen(opts);
-        }
+        var device_marker, device_location, device_map;
         $("#toggle-map").on("shown.bs.collapse", function () {
-             var device_marker, device_location;
-             if (device_map == null) {
+             if (device_marker == null) {
                 device_location = new L.LatLng(' . (float) $location->lat . ', ' . (float) $location->lng . ');
                 config = {"tile_url": "' . Config::get('leaflet.tile_url', '{s}.tile.openstreetmap.org') . '"};
                 device_map = init_map("location-map", "' . $maps_engine . '", "' . $maps_api . '", config);
                 device_marker = L.marker(device_location).addTo(device_map);
                 let zoom = (device_location.lat === 0 && device_location.lng === 0) ? 2 : 17;
                 device_map.setView(device_location, zoom);
                 device_marker.dragging.enable();
-                L.control.fullscreen({ position: "topright" }).addTo(device_map);
                 ';
-    if (Config::get('device_location_map_show_devices')) {
-        echo'
-                device_marker_cluster = L.markerClusterGroup({
-                    maxClusterRadius: ' . Config::get('leaflet.group_radius', 80) . ',
-                    iconCreateFunction: function (cluster) {
-                        var markers = cluster.getAllChildMarkers();
-                        var n = 0;
-                        color = "green"
-                        newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
-                        for (var i = 0; i < markers.length; i++) {
-                            if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
-                                color = "blue";
-                            }
-                            if (markers[i].options.icon.options.markerColor == "red") {
-                                color = "red";
-                            }
-                        }
-                        return L.divIcon({ html: cluster.getChildCount(), className: color+newClass, iconSize: L.point(40, 40) });
-                    },
-                  });
-                var redMarker = L.AwesomeMarkers.icon({
-                    icon: \'server\',
-                    markerColor: \'red\', prefix: \'fa\', iconColor: \'white\'
-                  });
-                var blueMarker = L.AwesomeMarkers.icon({
-                    icon: \'server\',
-                    markerColor: \'blue\', prefix: \'fa\', iconColor: \'white\'
-                  });
-                var greenMarker = L.AwesomeMarkers.icon({
-                    icon: \'server\',
-                    markerColor: \'green\', prefix: \'fa\', iconColor: \'white\'
-                  });
-                $.post( "' . route('maps.getdevices') . '", {disabled_alerts: 0, disabled: 0, location_valid: 1, link_type: "depends"})
-                  .done(function( data ) {
-                      $.each( data, function( device_id, device ) {
-                        var icon = greenMarker;
-                        var z_offset = 0;
-                        if (device["status"] == 0) {
-                            if (device["maintenance"] != 0) {
-                                icon = blueMarker;
-                                z_offset = 5000;
-                            } else {
-                                icon = redMarker;
-                                z_offset = 10000;
-                            }
-                        }
-                        var marker = L.marker(new L.LatLng(device["lat"],device["lng"]), {title: device["sname"], icon: icon, zIndexOffset: z_offset});
-                        marker.bindPopup("<a href=\"" + device["url"] + "\"><img src=\"" + device["icon"] + "\" width=\"32\" height=\"32\" alt=\"\"> " + device["sname"] + "</a>");
-                        device_marker_cluster.addLayer(marker);
-        ';
-        if (Config::get('device_location_map_show_device_dependencies')) {
-            echo'
-                        $.each( device["parents"], function( parent_idx, parent_id ) {
-                            if (parent_id in data && (data[parent_id]["lat"] != device["lat"] || data[parent_id]["lng"] != device["lng"])) {
-                                var line = new L.Polyline([new L.LatLng(device["lat"],device["lng"]), new L.LatLng(data[parent_id]["lat"],data[parent_id]["lng"])], {
-                                    color: "blue",
-                                    weight: 2,
-                                    opacity: 0.8,
-                                    smoothFactor: 1
-                                });
-                                device_marker_cluster.addLayer(line);
-                            }
-                        });
-            ';
-        }
-        echo'
-                      })
-                  })
-                  .fail(function() {
-                      alert( "error fetching devices" );
-                  });
-                device_map.addLayer(device_marker_cluster);
-        ';
-    } elseif (Auth::user()->isAdmin()) {
-        echo '
-                device_marker = L.marker(device_location).addTo(device_map);
-                device_marker.dragging.enable();
-                device_marker.on("dragend", function () {
+    if (Auth::user()->isAdmin()) {
+        echo '  device_marker.on("dragend", function () {
                     var new_location = device_marker.getLatLng();
                     if (confirm("Update location to " + new_location + "? This will update this location for all devices!")) {
                         update_location(' . $location->id . ', new_location, function(success) {
                             if (success) {
                                 $("#coordinates-text").text(new_location.lat.toFixed(5) + ", " + new_location.lng.toFixed(5));
                                 $("#map-it-button").attr("href", "https://maps.google.com/?q=" + new_location.lat + "," + new_location.lng );
                             }
                         });
                     }
                 });';
+    } else {
+        echo 'device_map.dragging.disable();';
     }
     echo '
         }
             $("#toggle-map-button").find(".fa").removeClass("fa-map").addClass("fa-map-o");
             $("#toggle-map-button span").text("Hide")
         }).on("hidden.bs.collapse", function () {
             $("#toggle-map-button").find(".fa").removeClass("fa-map-o").addClass("fa-map");
             $("#toggle-map-button span").text("View")
         });';
     if (Config::get('device_location_map_open')) {

--- a/includes/html/forms/token-item-create.inc.php
+++ b/includes/html/forms/token-item-create.inc.php
@@ -7,25 +7,30 @@
  * This program is free software: you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 header('Content-type: text/plain');
 if (! Auth::user()->hasGlobalAdmin()) {
     exit('ERROR: You need to be admin');
 }
-$token = bin2hex(openssl_random_pseudo_bytes(16));
-if (! is_numeric($_POST['user_id'])) {
+if (! is_numeric($_POST['user_id']) || ! isset($_POST['token'])) {
     echo 'ERROR: error with data, please ensure a valid user and token have been specified.';
     exit;
+} elseif (strlen($_POST['token']) > 32) {
+    echo 'ERROR: The token is more than 32 characters';
+    exit;
+} elseif (strlen($_POST['token']) < 16) {
+    echo 'ERROR: The token is less than 16 characters';
+    exit;
 } else {
-    $create = dbInsert(['user_id' => $_POST['user_id'], 'token_hash' => $token, 'description' => $_POST['description']], 'api_tokens');
+    $create = dbInsert(['user_id' => $_POST['user_id'], 'token_hash' => $_POST['token'], 'description' => $_POST['description']], 'api_tokens');
     if ($create > '0') {
         echo 'API token has been created';
         Session::put('api_token', true);
         exit;
     } else {
         echo 'ERROR: An error occurred creating the API token';
         exit;
     }
 }//end if

--- a/includes/html/functions.inc.php
+++ b/includes/html/functions.inc.php
@@ -786,29 +786,25 @@
         'http' => [
             'header' => 'Accept: application/json',
         ],
     ]);
     $data = json_decode(file_get_contents(Config::get('oxidized.url') . '/nodes?format=json', false, $context), true);
     foreach ($data as $object) {
         $device = device_by_name($object['name']);
         if (! device_permitted($device['device_id'])) {
             continue;
         }
-        try {
-            $utc_time = $object['time'];
-            $utc_date = new DateTime($utc_time, new DateTimeZone('UTC'));
-            $local_timezone = new DateTimeZone(date_default_timezone_get());
-            $local_date = $utc_date->setTimezone($local_timezone);
-            $formatted_local_time = $local_date->format('Y-m-d H:i:s T');
-        } catch (Exception $e) {
-            $formatted_local_time = $object['time'];
-        }
+        $utc_time = $object['time'];
+        $utc_date = new DateTime($utc_time, new DateTimeZone('UTC'));
+        $local_timezone = new DateTimeZone(date_default_timezone_get());
+        $local_date = $utc_date->setTimezone($local_timezone);
+        $formatted_local_time = $local_date->format('Y-m-d H:i:s T');
         echo '<tr>
         <td>' . $device['device_id'] . '</td>
         <td>' . $object['name'] . '</td>
         <td>' . $device['sysName'] . '</td>
         <td>' . $object['status'] . '</td>
         <td>' . $formatted_local_time . '</td>
         <td>' . $object['model'] . '</td>
         <td>' . $object['group'] . '</td>
         <td></td>
         </tr>';

--- a/includes/html/graphs/application/http_access_log_combined-common.inc.php
+++ b//dev/null
@@ -1,26 +0,0 @@
-<?php
-$name = 'http_access_log_combined';
-if (! isset($colours)) {
-    $colours = 'psychedelic';
-}
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$scale_min = 0;
-$rrd_list = [];
-foreach ($stats_list as $stat_to_add) {
-    if (isset($vars['log'])) {
-        $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'logs___' . $vars['log'] . '___' . $stat_to_add['stat']]);
-    } else {
-        $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'totals_' . $stat_to_add['stat']]);
-    }
-    if (Rrd::checkRrdExists($rrd_filename)) {
-        $rrd_list[] = [
-            'filename' => $rrd_filename,
-            'descr' => $stat_to_add['descr'],
-            'ds' => 'data',
-        ];
-    }
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_bytes.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'Bytes';
-$stats_list = [
-    'bytes' => [
-        'stat' => 'bytes',
-        'descr' => 'Bytes',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_bytes_stats.inc.php
+++ b//dev/null
@@ -1,29 +0,0 @@
-<?php
-$unit_text = 'Bytes';
-$stats_list = [
-    'bytes_max' => [
-        'stat' => 'bytes_max',
-        'descr' => 'Max',
-    ],
-    'bytes_mean' => [
-        'stat' => 'bytes_mean',
-        'descr' => 'Mean',
-    ],
-    'bytes_median' => [
-        'stat' => 'bytes_median',
-        'descr' => 'Median',
-    ],
-    'bytes_mode' => [
-        'stat' => 'bytes_mode',
-        'descr' => 'Mode',
-    ],
-    'bytes_max' => [
-        'stat' => 'bytes_max',
-        'descr' => 'Max',
-    ],
-    'bytes_min' => [
-        'stat' => 'bytes_min',
-        'descr' => 'Min',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_codes_1xx.inc.php
+++ b//dev/null
@@ -1,21 +0,0 @@
-<?php
-$unit_text = 'Count';
-$stats_list = [
-    '100' => [
-        'stat' => '100',
-        'descr' => '100',
-    ],
-    '101' => [
-        'stat' => '101',
-        'descr' => '101',
-    ],
-    '102' => [
-        'stat' => '102',
-        'descr' => '102',
-    ],
-    '103' => [
-        'stat' => '103',
-        'descr' => '103',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_codes_2xx.inc.php
+++ b//dev/null
@@ -1,50 +0,0 @@
-<?php
-$unit_text = 'Count';
-$colours = 'rainbow';
-$stats_list = [
-    '200' => [
-        'stat' => '200',
-        'descr' => '200',
-    ],
-    '201' => [
-        'stat' => '201',
-        'descr' => '201',
-    ],
-    '202' => [
-        'stat' => '202',
-        'descr' => '202',
-    ],
-    '203' => [
-        'stat' => '203',
-        'descr' => '203',
-    ],
-    '204' => [
-        'stat' => '204',
-        'descr' => '204',
-    ],
-    '205' => [
-        'stat' => '205',
-        'descr' => '205',
-    ],
-    '206' => [
-        'stat' => '206',
-        'descr' => '206',
-    ],
-    '207' => [
-        'stat' => '207',
-        'descr' => '207',
-    ],
-    '208' => [
-        'stat' => '208',
-        'descr' => '208',
-    ],
-    '218' => [
-        'stat' => '218',
-        'descr' => '218',
-    ],
-    '226' => [
-        'stat' => '226',
-        'descr' => '226',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_codes_3xx.inc.php
+++ b//dev/null
@@ -1,42 +0,0 @@
-<?php
-$unit_text = 'Count';
-$colours = 'rainbow';
-$stats_list = [
-    '300' => [
-        'stat' => '300',
-        'descr' => '300',
-    ],
-    '301' => [
-        'stat' => '301',
-        'descr' => '301',
-    ],
-    '302' => [
-        'stat' => '302',
-        'descr' => '302',
-    ],
-    '303' => [
-        'stat' => '303',
-        'descr' => '303',
-    ],
-    '304' => [
-        'stat' => '304',
-        'descr' => '304',
-    ],
-    '305' => [
-        'stat' => '305',
-        'descr' => '305',
-    ],
-    '306' => [
-        'stat' => '306',
-        'descr' => '306',
-    ],
-    '307' => [
-        'stat' => '307',
-        'descr' => '307',
-    ],
-    '308' => [
-        'stat' => '308',
-        'descr' => '308',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_codes_4xx.inc.php
+++ b//dev/null
@@ -1,149 +0,0 @@
-<?php
-$unit_text = 'Count';
-$stats_list = [
-    '400' => [
-        'stat' => '400',
-        'descr' => '400',
-    ],
-    '401' => [
-        'stat' => '401',
-        'descr' => '401',
-    ],
-    '402' => [
-        'stat' => '402',
-        'descr' => '402',
-    ],
-    '403' => [
-        'stat' => '403',
-        'descr' => '403',
-    ],
-    '404' => [
-        'stat' => '404',
-        'descr' => '404',
-    ],
-    '405' => [
-        'stat' => '405',
-        'descr' => '405',
-    ],
-    '406' => [
-        'stat' => '406',
-        'descr' => '406',
-    ],
-    '407' => [
-        'stat' => '407',
-        'descr' => '407',
-    ],
-    '408' => [
-        'stat' => '408',
-        'descr' => '408',
-    ],
-    '409' => [
-        'stat' => '409',
-        'descr' => '409',
-    ],
-    '410' => [
-        'stat' => '410',
-        'descr' => '410',
-    ],
-    '411' => [
-        'stat' => '411',
-        'descr' => '411',
-    ],
-    '412' => [
-        'stat' => '412',
-        'descr' => '412',
-    ],
-    '413' => [
-        'stat' => '413',
-        'descr' => '413',
-    ],
-    '414' => [
-        'stat' => '414',
-        'descr' => '414',
-    ],
-    '415' => [
-        'stat' => '415',
-        'descr' => '415',
-    ],
-    '416' => [
-        'stat' => '416',
-        'descr' => '416',
-    ],
-    '417' => [
-        'stat' => '417',
-        'descr' => '417',
-    ],
-    '419' => [
-        'stat' => '419',
-        'descr' => '419',
-    ],
-    '420' => [
-        'stat' => '420',
-        'descr' => '420',
-    ],
-    '421' => [
-        'stat' => '421',
-        'descr' => '421',
-    ],
-    '422' => [
-        'stat' => '422',
-        'descr' => '422',
-    ],
-    '423' => [
-        'stat' => '423',
-        'descr' => '423',
-    ],
-    '424' => [
-        'stat' => '424',
-        'descr' => '424',
-    ],
-    '425' => [
-        'stat' => '425',
-        'descr' => '425',
-    ],
-    '426' => [
-        'stat' => '426',
-        'descr' => '426',
-    ],
-    '428' => [
-        'stat' => '428',
-        'descr' => '428',
-    ],
-    '429' => [
-        'stat' => '429',
-        'descr' => '429',
-    ],
-    '431' => [
-        'stat' => '431',
-        'descr' => '431',
-    ],
-    '444' => [
-        'stat' => '444',
-        'descr' => '444',
-    ],
-    '451' => [
-        'stat' => '451',
-        'descr' => '451',
-    ],
-    '494' => [
-        'stat' => '494',
-        'descr' => '494',
-    ],
-    '495' => [
-        'stat' => '495',
-        'descr' => '495',
-    ],
-    '496' => [
-        'stat' => '496',
-        'descr' => '496',
-    ],
-    '497' => [
-        'stat' => '497',
-        'descr' => '497',
-    ],
-    '499' => [
-        'stat' => '499',
-        'descr' => '499',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_codes_5xx.inc.php
+++ b//dev/null
@@ -1,54 +0,0 @@
-<?php
-$unit_text = 'Count';
-$colours = 'rainbow';
-$stats_list = [
-    '500' => [
-        'stat' => '500',
-        'descr' => '500',
-    ],
-    '501' => [
-        'stat' => '501',
-        'descr' => '501',
-    ],
-    '502' => [
-        'stat' => '502',
-        'descr' => '502',
-    ],
-    '503' => [
-        'stat' => '503',
-        'descr' => '503',
-    ],
-    '504' => [
-        'stat' => '504',
-        'descr' => '504',
-    ],
-    '505' => [
-        'stat' => '505',
-        'descr' => '505',
-    ],
-    '506' => [
-        'stat' => '506',
-        'descr' => '506',
-    ],
-    '507' => [
-        'stat' => '507',
-        'descr' => '507',
-    ],
-    '508' => [
-        'stat' => '508',
-        'descr' => '508',
-    ],
-    '509' => [
-        'stat' => '509',
-        'descr' => '509',
-    ],
-    '510' => [
-        'stat' => '510',
-        'descr' => '510',
-    ],
-    '511' => [
-        'stat' => '511',
-        'descr' => '511',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_codes_general.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$unit_text = 'Count';
-$stats_list = [
-    '1xx' => [
-        'stat' => '1xx',
-        'descr' => '1xx',
-    ],
-    '2xx' => [
-        'stat' => '2xx',
-        'descr' => '2xx',
-    ],
-    '3xx' => [
-        'stat' => '3xx',
-        'descr' => '3xx',
-    ],
-    '4xx' => [
-        'stat' => '4xx',
-        'descr' => '4xx',
-    ],
-    '5xx' => [
-        'stat' => '5xx',
-        'descr' => '5xx',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_error_size.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'Bytes';
-$stats_list = [
-    'error_size' => [
-        'stat' => 'error_size',
-        'descr' => 'Err Log Size',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_log_size.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'Bytes';
-$stats_list = [
-    'size' => [
-        'stat' => 'size',
-        'descr' => 'Log Size',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_methods.inc.php
+++ b//dev/null
@@ -1,37 +0,0 @@
-<?php
-$unit_text = 'Count';
-$stats_list = [
-    'CONNECT' => [
-        'stat' => 'CONNECT',
-        'descr' => 'CONNECT',
-    ],
-    'DELETE' => [
-        'stat' => 'DELETE',
-        'descr' => 'DELETE',
-    ],
-    'GET' => [
-        'stat' => 'GET',
-        'descr' => 'GET',
-    ],
-    'HEAD' => [
-        'stat' => 'HEAD',
-        'descr' => 'HEAD',
-    ],
-    'OPTIONS' => [
-        'stat' => 'OPTIONS',
-        'descr' => 'OPTIONS',
-    ],
-    'PATCH' => [
-        'stat' => 'PATCH',
-        'descr' => 'PATCH',
-    ],
-    'POST' => [
-        'stat' => 'POST',
-        'descr' => 'POST',
-    ],
-    'PUT' => [
-        'stat' => 'PUT',
-        'descr' => 'PUT',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_refer.inc.php
+++ b//dev/null
@@ -1,13 +0,0 @@
-<?php
-$unit_text = 'Count';
-$stats_list = [
-    'refer' => [
-        'stat' => 'refer',
-        'descr' => 'Refer Present',
-    ],
-    'no_refer' => [
-        'stat' => 'no_refer',
-        'descr' => 'Refer!Present',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_stat.inc.php
+++ b//dev/null
@@ -1,42 +0,0 @@
-<?php
-$name = 'http_access_log_combined';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$scale_min = 0;
-$logs = $app->data['logs'];
-$descr_len = 12;
-if (! isset($vars['log_stat'])) {
-    d_echo('$vars["log_stat"] undef');
-    return;
-} elseif ($vars['log_stat'] == 'bytes'
-          || $vars['log_stat'] == 'bytes_max'
-          || $vars['log_stat'] == 'bytes_mean'
-          || $vars['log_stat'] == 'bytes_median'
-          || $vars['log_stat'] == 'bytes_min'
-          || $vars['log_stat'] == 'bytes_mode'
-          || $vars['log_stat'] == 'bytes_range'
-          || $vars['log_stat'] == 'size'
-          || $vars['log_stat'] == 'error_size') {
-    $unit_text = $vars['log_stat'] . ' Bytes';
-} else {
-    $unit_text = $vars['log_stat'] . ' Count';
-}
-$rrd_list = [];
-foreach ($logs as $log) {
-    $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'logs___' . $log . '___' . $vars['log_stat']]);
-    if (Rrd::checkRrdExists($rrd_filename)) {
-        $log_len = strlen($log);
-        if ($descr_len < $log_len) {
-            $descr_len = $log_len;
-        }
-        $rrd_list[] = [
-            'filename' => $rrd_filename,
-            'descr' => $log,
-            'ds' => 'data',
-        ];
-    }
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_user.inc.php
+++ b//dev/null
@@ -1,13 +0,0 @@
-<?php
-$unit_text = 'Count';
-$stats_list = [
-    'user' => [
-        'stat' => 'user',
-        'descr' => 'UserPresent',
-    ],
-    'no_user' => [
-        'stat' => 'no_user',
-        'descr' => 'User!Present',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/http_access_log_combined_version.inc.php
+++ b//dev/null
@@ -1,21 +0,0 @@
-<?php
-$unit_text = 'Count';
-$stats_list = [
-    'http1_0' => [
-        'stat' => 'http1_0',
-        'descr' => '1.0',
-    ],
-    'http1_1' => [
-        'stat' => 'http1_1',
-        'descr' => '1.1',
-    ],
-    'http2' => [
-        'stat' => 'http2',
-        'descr' => '2',
-    ],
-    'http3' => [
-        'stat' => 'http3',
-        'descr' => '3',
-    ],
-];
-require 'http_access_log_combined-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor-common.inc.php
+++ b//dev/null
@@ -1,26 +0,0 @@
-<?php
-$name = 'oslv_monitor';
-if (! isset($colours)) {
-    $colours = 'psychedelic';
-}
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$scale_min = 0;
-$rrd_list = [];
-foreach ($stats_list as $stat_to_add) {
-    if (isset($vars['oslvm'])) {
-        $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'oslvm___' . $vars['oslvm'] . '___' . $stat_to_add['stat']]);
-    } else {
-        $rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, 'totals_' . $stat_to_add['stat']]);
-    }
-    if (Rrd::checkRrdExists($rrd_filename)) {
-        $rrd_list[] = [
-            'filename' => $rrd_filename,
-            'descr' => $stat_to_add['descr'],
-            'ds' => 'data',
-        ];
-    }
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_blocks.inc.php
+++ b//dev/null
@@ -1,13 +0,0 @@
-<?php
-$unit_text = 'blocks/sec';
-$stats_list = [
-    'read-blocks' => [
-        'stat' => 'read-blocks',
-        'descr' => 'Read',
-    ],
-    'written-blocks' => [
-        'stat' => 'written-blocks',
-        'descr' => 'Written',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_burst_count.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'events/sec';
-$stats_list = [
-    'nr_bursts' => [
-        'stat' => 'nr_bursts',
-        'descr' => 'Bursts',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_burst_time.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'secs/sec';
-$stats_list = [
-    'burst-time' => [
-        'stat' => 'burst-time',
-        'descr' => 'Burst Time',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_bytes_rwd.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$unit_text = 'bytes/sec';
-$stats_list = [
-    'rbytes' => [
-        'stat' => 'rbytes',
-        'descr' => 'Read',
-    ],
-    'wbytes' => [
-        'stat' => 'wbytes',
-        'descr' => 'Write',
-    ],
-    'dbytes' => [
-        'stat' => 'dbytes',
-        'descr' => 'Discard',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cgroups_mem_misc.inc.php
+++ b//dev/null
@@ -1,89 +0,0 @@
-<?php
-$unit_text = 'bytes';
-$stats_list = [
-    'anon' => [
-        'stat' => 'anon',
-        'descr' => 'anon',
-    ],
-    'file' => [
-        'stat' => 'file',
-        'descr' => 'file',
-    ],
-    'kernel' => [
-        'stat' => 'kernel',
-        'descr' => 'kernel',
-    ],
-    'kernel_stack' => [
-        'stat' => 'kernel_stack',
-        'descr' => 'kernel_stack',
-    ],
-    'pagetables' => [
-        'stat' => 'pagetables',
-        'descr' => 'pagetables',
-    ],
-    'sec_pagetables' => [
-        'stat' => 'sec_pagetables',
-        'descr' => 'sec_pagetables',
-    ],
-    'percpu' => [
-        'stat' => 'percpu',
-        'descr' => 'percpu',
-    ],
-    'vmalloc' => [
-        'stat' => 'vmalloc',
-        'descr' => 'vmalloc',
-    ],
-    'shmem' => [
-        'stat' => 'shmem',
-        'descr' => 'shmem',
-    ],
-    'file_mapped' => [
-        'stat' => 'file_mapped',
-        'descr' => 'file_mapped',
-    ],
-    'file_dirty' => [
-        'stat' => 'file_dirty',
-        'descr' => 'file_dirty',
-    ],
-    'file_writeback' => [
-        'stat' => 'file_writeback',
-        'descr' => 'file_writeback',
-    ],
-    'swapcached' => [
-        'stat' => 'swapcached',
-        'descr' => 'swapcached',
-    ],
-    'anon_thp' => [
-        'stat' => 'anon_thp',
-        'descr' => 'anon_thp',
-    ],
-    'file_thp' => [
-        'stat' => 'file_thp',
-        'descr' => 'file_thp',
-    ],
-    'shmem_thp' => [
-        'stat' => 'shmem_thp',
-        'descr' => 'shmem_thp',
-    ],
-    'inactive_anon' => [
-        'stat' => 'inactive_anon',
-        'descr' => 'inactive_anon',
-    ],
-    'active_anon' => [
-        'stat' => 'active_anon',
-        'descr' => 'active_anon',
-    ],
-    'slab_reclaimable' => [
-        'stat' => 'slab_reclaimable',
-        'descr' => 'slab_reclaimable',
-    ],
-    'slab_unreclaimable' => [
-        'stat' => 'slab_unreclaimable',
-        'descr' => 'slab_unreclaimable',
-    ],
-    'slab' => [
-        'stat' => 'slab',
-        'descr' => 'slab',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cgroups_pg.inc.php
+++ b//dev/null
@@ -1,57 +0,0 @@
-<?php
-$unit_text = 'per second';
-$stats_list = [
-    'pgactivate' => [
-        'stat' => 'pgactivate',
-        'descr' => 'pgactivate',
-    ],
-    'pgdeactivate' => [
-        'stat' => 'pgdeactivate',
-        'descr' => 'pgdeactivate',
-    ],
-    'pglazyfree' => [
-        'stat' => 'pglazyfree',
-        'descr' => 'pglazyfree',
-    ],
-    'pglazyfreed' => [
-        'stat' => 'pglazyfreed',
-        'descr' => 'pglazyfreed',
-    ],
-    'pgrefill' => [
-        'stat' => 'pgrefill',
-        'descr' => 'pgrefill',
-    ],
-    'pgscan' => [
-        'stat' => 'pgscan',
-        'descr' => 'pgscan',
-    ],
-    'pgscan_direct' => [
-        'stat' => 'pgscan_direct',
-        'descr' => 'pgscan_direct',
-    ],
-    'pgscan_khugepaged' => [
-        'stat' => 'pgscan_khugepaged',
-        'descr' => 'pgscan_khugepaged',
-    ],
-    'pgscan_kswapd' => [
-        'stat' => 'pgscan_kswapd',
-        'descr' => 'pgscan_kswapd',
-    ],
-    'pgsteal' => [
-        'stat' => 'pgsteal',
-        'descr' => 'pgsteal',
-    ],
-    'pgsteal_direct' => [
-        'stat' => 'pgsteal_direct',
-        'descr' => 'pgsteal_direct',
-    ],
-    'pgsteal_khugepaged' => [
-        'stat' => 'pgsteal_khugepaged',
-        'descr' => 'pgsteal_khugepaged',
-    ],
-    'pgsteal_kswapd' => [
-        'stat' => 'pgsteal_kswapd',
-        'descr' => 'pgsteal_kswapd',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cgroups_thp_activity.inc.php
+++ b//dev/null
@@ -1,21 +0,0 @@
-<?php
-$unit_text = 'per second';
-$stats_list = [
-    'thp_fault_alloc' => [
-        'stat' => 'thp_fault_alloc',
-        'descr' => 'thp_fault_alloc',
-    ],
-    'thp_collapse_alloc' => [
-        'stat' => 'thp_collapse_alloc',
-        'descr' => 'thp_collapse_alloc',
-    ],
-    'thp_swpout' => [
-        'stat' => 'thp_swpout',
-        'descr' => 'thp_swpout',
-    ],
-    'thp_swpout_fallback' => [
-        'stat' => 'thp_swpout_fallback',
-        'descr' => 'thp_swpout_fallback',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cgroups_workingset.inc.php
+++ b//dev/null
@@ -1,33 +0,0 @@
-<?php
-$unit_text = 'per second';
-$stats_list = [
-    'refault_anon' => [
-        'stat' => 'workingset_refault_anon',
-        'descr' => 'refault_anon',
-    ],
-    'refault_file' => [
-        'stat' => 'workingset_refault_file',
-        'descr' => 'refault_file',
-    ],
-    'workingset_activate_anon' => [
-        'stat' => 'workingset_activate_anon',
-        'descr' => 'activate_anon',
-    ],
-    'workingset_activate_file' => [
-        'stat' => 'workingset_activate_file',
-        'descr' => 'activate_file',
-    ],
-    'workingset_restore_anon' => [
-        'stat' => 'workingset_restore_anon',
-        'descr' => 'restore_anon',
-    ],
-    'workingset_restore_file' => [
-        'stat' => 'workingset_restore_file',
-        'descr' => 'restore_file',
-    ],
-    'workingset_nodereclaim' => [
-        'stat' => 'workingset_nodereclaim',
-        'descr' => 'nodereclaim',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cgroups_zswap.inc.php
+++ b//dev/null
@@ -1,13 +0,0 @@
-<?php
-$unit_text = 'bytes';
-$stats_list = [
-    'zswap' => [
-        'stat' => 'zswap',
-        'descr' => 'zswap size',
-    ],
-    'zswapped' => [
-        'stat' => 'zswapped',
-        'descr' => 'zswapped size',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cgroups_zswap_activity.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$unit_text = 'Kbytes';
-$stats_list = [
-    'zswpin' => [
-        'stat' => 'zswpin',
-        'descr' => 'zswpin',
-    ],
-    'zswpout' => [
-        'stat' => 'zswpout',
-        'descr' => 'zswpout',
-    ],
-    'zswpwb' => [
-        'stat' => 'zswpwb',
-        'descr' => 'zswpwb',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cows.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'COWs/sec';
-$stats_list = [
-    'copy-on-write-faults' => [
-        'stat' => 'copy-on-write-faults',
-        'descr' => 'COW Faults',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_cpu_percent.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = '';
-$stats_list = [
-    'bytes' => [
-        'stat' => 'percent-cpu',
-        'descr' => 'CPU%',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_etimes.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'seconds';
-$stats_list = [
-    'elapsed-times' => [
-        'stat' => 'elapsed-times',
-        'descr' => 'Elapsed Time',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_faults.inc.php
+++ b//dev/null
@@ -1,13 +0,0 @@
-<?php
-$unit_text = 'faults/sec';
-$stats_list = [
-    'minor-faults' => [
-        'stat' => 'minor-faults',
-        'descr' => 'Minor',
-    ],
-    'major-faults' => [
-        'stat' => 'major-faults',
-        'descr' => 'Major',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_mem_percent.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = '';
-$stats_list = [
-    'bytes' => [
-        'stat' => 'percent-memory',
-        'descr' => 'Memory%',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_ops_rwd.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$unit_text = 'ops/sec';
-$stats_list = [
-    'rios' => [
-        'stat' => 'rios',
-        'descr' => 'Read',
-    ],
-    'wios' => [
-        'stat' => 'wios',
-        'descr' => 'Write',
-    ],
-    'dios' => [
-        'stat' => 'dios',
-        'descr' => 'Discard',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_procs.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'count';
-$stats_list = [
-    'procs' => [
-        'stat' => 'procs',
-        'descr' => 'Processes',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_recv_sent_msgs.inc.php
+++ b//dev/null
@@ -1,13 +0,0 @@
-<?php
-$unit_text = 'msgs/sec';
-$stats_list = [
-    'received-messages' => [
-        'stat' => 'received-messages',
-        'descr' => 'Received',
-    ],
-    'sent-messages' => [
-        'stat' => 'sent-messages',
-        'descr' => 'Sent',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_rss.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'Kbytes';
-$stats_list = [
-    'bytes' => [
-        'stat' => 'rss',
-        'descr' => 'RSS',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_rwd_amount.inc.php
+++ b//dev/null
@@ -1,28 +0,0 @@
-<?php
-$unit_text = 'blocks/sec';
-if (isset($app->data['backend']) && $app->data['backend'] == 'cgroups') {
-    $unit_text = 'bytes/sec';
-}
-$stats_list = [
-    'rbytes' => [
-        'stat' => 'rbytes',
-        'descr' => 'Read',
-    ],
-    'wbytes' => [
-        'stat' => 'wbytes',
-        'descr' => 'Write',
-    ],
-    'dbytes' => [
-        'stat' => 'dbytes',
-        'descr' => 'Discard',
-    ],
-    'read-blocks' => [
-        'stat' => 'read-blocks',
-        'descr' => 'Read',
-    ],
-    'written-blocks' => [
-        'stat' => 'written-blocks',
-        'descr' => 'Written',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_signals_taken.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'signals/sec';
-$stats_list = [
-    'signals-taken' => [
-        'stat' => 'signals-taken',
-        'descr' => 'Signals',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_sizes.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$unit_text = 'Kbytes';
-$stats_list = [
-    'data-size' => [
-        'stat' => 'data-size',
-        'descr' => 'Data',
-    ],
-    'stack-size' => [
-        'stat' => 'stack-size',
-        'descr' => 'Stack',
-    ],
-    'text-size' => [
-        'stat' => 'text-size',
-        'descr' => 'Text',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_sock.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'bytes';
-$stats_list = [
-    'sock' => [
-        'stat' => 'sock',
-        'descr' => 'sock',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_swaps.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'swaps/sec';
-$stats_list = [
-    'swaps' => [
-        'stat' => 'swaps',
-        'descr' => 'Swaps',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_switches.inc.php
+++ b//dev/null
@@ -1,13 +0,0 @@
-<?php
-$unit_text = 'switches/sec';
-$stats_list = [
-    'voluntary-context-switches' => [
-        'stat' => 'voluntary-context-switches',
-        'descr' => 'Voluntary',
-    ],
-    'involuntary-context-switches' => [
-        'stat' => 'involuntary-context-switches',
-        'descr' => 'Involuntary',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_throttled_count.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'events/sec';
-$stats_list = [
-    'bytes' => [
-        'stat' => 'nr_throttled',
-        'descr' => 'Throttled',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_throttled_time.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'secs/sec';
-$stats_list = [
-    'bytes' => [
-        'stat' => 'throttled-time',
-        'descr' => 'Throttled Time',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_time.inc.php
+++ b//dev/null
@@ -1,17 +0,0 @@
-<?php
-$unit_text = 'secs/sec';
-$stats_list = [
-    'cpu-time' => [
-        'stat' => 'cpu-time',
-        'descr' => 'CPU',
-    ],
-    'system-time' => [
-        'stat' => 'system-time',
-        'descr' => 'System',
-    ],
-    'user-time' => [
-        'stat' => 'user-time',
-        'descr' => 'User',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/oslv_monitor_vsz.inc.php
+++ b//dev/null
@@ -1,9 +0,0 @@
-<?php
-$unit_text = 'Kbytes';
-$stats_list = [
-    'virtual-size' => [
-        'stat' => 'virtual-size',
-        'descr' => 'VSZ',
-    ],
-];
-require 'oslv_monitor-common.inc.php';

--- a/includes/html/graphs/application/zfs_pool_asyncq_read.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ops';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_read_a']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Active',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_read_p']),
-        'descr' => 'Pending',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_asyncq_wait.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ms';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_wait_w']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Write',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_wait_r']),
-        'descr' => 'Read',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_asyncq_write.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ops';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_write_a']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Active',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____asyncq_write_p']),
-        'descr' => 'Pending',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_bandwidth.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'bandwidth';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____bandwidth_r']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Read',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____bandwidth_w']),
-        'descr' => 'Write',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_disk_wait.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ms';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____disk_wait_r']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Read',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____disk_wait_r']),
-        'descr' => 'Write',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_errors.inc.php
+++ b//dev/null
@@ -1,30 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'errors';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____checksum_errors']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Checksum',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____read_errors']),
-        'descr' => 'Read',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____write_errors']),
-        'descr' => 'Write',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_operations.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ops';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____operations_r']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Read',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____operations_w']),
-        'descr' => 'Write',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_scrub_wait.inc.php
+++ b//dev/null
@@ -1,20 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ms';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____scrub_wait']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Scrub',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_scrubq_read.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ops';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____scrubq_read_a']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Active',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____scrubq_read_p']),
-        'descr' => 'Pending',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_syncq_read.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ops';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_read_a']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Active',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_read_p']),
-        'descr' => 'Pending',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_syncq_wait.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ms';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_wait_r']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Read',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_wait_w']),
-        'descr' => 'Write',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_syncq_write.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ops';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_write_a']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Active',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____syncq_write_p']),
-        'descr' => 'Pending',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_total_wait.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ms';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____total_wait_r']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Read',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____total_wait_r']),
-        'descr' => 'Write',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_trim_wait.inc.php
+++ b//dev/null
@@ -1,20 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ms';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____trim_wait']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Trim Wait',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/graphs/application/zfs_pool_trimq_write.inc.php
+++ b//dev/null
@@ -1,25 +0,0 @@
-<?php
-$name = 'zfs';
-$unit_text = 'ops';
-$colours = 'psychedelic';
-$dostack = 0;
-$printtotal = 0;
-$addarea = 1;
-$transparency = 15;
-$rrd_filename = Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____trimq_write_a']);
-$rrd_list = [];
-if (Rrd::checkRrdExists($rrd_filename)) {
-    $rrd_list[] = [
-        'filename' => $rrd_filename,
-        'descr' => 'Active',
-        'ds' => 'data',
-    ];
-    $rrd_list[] = [
-        'filename' => Rrd::name($device['hostname'], ['app', $name, $app->app_id, $vars['pool'] . '____trimq_write_p']),
-        'descr' => 'Pending',
-        'ds' => 'data',
-    ];
-} else {
-    d_echo('RRD "' . $rrd_filename . '" not found');
-}
-require 'includes/html/graphs/generic_multi_line.inc.php';

--- a/includes/html/pages/addhost.inc.php
+++ b/includes/html/pages/addhost.inc.php
@@ -11,75 +11,74 @@
 }
 echo '<div class="row">
             <div class="col-sm-3">
             </div>
             <div class="col-sm-6">';
 $snmp_enabled = ! isset($_POST['hostname']) || isset($_POST['snmp']);
 if (! empty($_POST['hostname'])) {
     $hostname = strip_tags($_POST['hostname']);
     if (! \LibreNMS\Util\Validate::hostname($hostname) && ! IP::isValid($hostname)) {
         print_error("Invalid hostname or IP: $hostname");
+    }
+    $new_device = new \App\Models\Device(['hostname' => $hostname]);
+    if (Auth::user()->hasGlobalRead()) {
+        if ($_POST['port']) {
+            $new_device->port = strip_tags($_POST['port']);
+        }
+        if ($_POST['transport']) {
+            $new_device->transport = strip_tags($_POST['transport']);
+        }
+        $additional = [];
+        if (! $snmp_enabled) {
+            $new_device->snmp_disable = 1;
+            $new_device->os = $_POST['os'] ? strip_tags($_POST['os_id']) : 'ping';
+            $new_device->hardware = strip_tags($_POST['hardware']);
+            $new_device->sysName = strip_tags($_POST['sysName']);
+        } elseif ($_POST['snmpver'] === 'v2c' || $_POST['snmpver'] === 'v1') {
+            $new_device->snmpver = strip_tags($_POST['snmpver']);
+            $communities = Config::get('snmp.community');
+            if ($_POST['community']) {
+                $new_device->community = $_POST['community'];
+                $communities = [$_POST['community']];
+            }
+            print_message("Adding host $hostname communit" . (count($communities) == 1 ? 'y' : 'ies') . ' ' . implode(', ', array_map('htmlspecialchars', $communities)) . " port $new_device->port using $new_device->transport");
+        } elseif ($_POST['snmpver'] === 'v3') {
+            $new_device->snmpver = 'v3';
+            $new_device->authlevel = strip_tags($_POST['authlevel']);
+            $new_device->authname = $_POST['authname'];
+            $new_device->authpass = $_POST['authpass'];
+            $new_device->authalgo = strip_tags($_POST['authalgo']);
+            $new_device->cryptopass = $_POST['cryptopass'];
+            $new_device->cryptoalgo = $_POST['cryptoalgo'];
+            print_message("Adding SNMPv3 host: $hostname port: $port");
+        } else {
+            print_error('Unsupported SNMP Version. There was a dropdown menu, how did you reach this error ?');
+        }//end if
+        try {
+            $new_device->poller_group = strip_tags($_POST['poller_group'] ?? '');
+            $new_device->port_association_mode = PortAssociationMode::getId($_POST['port_assoc_mode']);
+            $force_add = (isset($_POST['force_add']) && $_POST['force_add'] == 'on');
+            $result = (new ValidateDeviceAndCreate($new_device, $force_add))->execute();
+            if ($result) {
+                $link = \LibreNMS\Util\Url::deviceUrl($new_device->device_id);
+                print_message("Device added <a href='$link'>$hostname ($new_device->device_id)</a>");
+            }
+        } catch (HostUnreachableException $e) {
+            print_error($e->getMessage());
+            foreach ($e->getReasons() as $reason) {
+                print_error($reason);
+            }
+        } catch (Exception $e) {
+            print_error($e->getMessage());
+        }
     } else {
-        $new_device = new \App\Models\Device(['hostname' => $hostname]);
-        if (Auth::user()->hasGlobalRead()) {
-            if ($_POST['port']) {
-                $new_device->port = strip_tags($_POST['port']);
-            }
-            if ($_POST['transport']) {
-                $new_device->transport = strip_tags($_POST['transport']);
-            }
-            $additional = [];
-            if (! $snmp_enabled) {
-                $new_device->snmp_disable = 1;
-                $new_device->os = $_POST['os'] ? strip_tags($_POST['os_id']) : 'ping';
-                $new_device->hardware = strip_tags($_POST['hardware']);
-                $new_device->sysName = strip_tags($_POST['sysName']);
-            } elseif ($_POST['snmpver'] === 'v2c' || $_POST['snmpver'] === 'v1') {
-                $new_device->snmpver = strip_tags($_POST['snmpver']);
-                $communities = Config::get('snmp.community');
-                if ($_POST['community']) {
-                    $new_device->community = $_POST['community'];
-                    $communities = [$_POST['community']];
-                }
-                print_message("Adding host $hostname communit" . (count($communities) == 1 ? 'y' : 'ies') . ' ' . implode(', ', array_map('htmlspecialchars', $communities)) . " port $new_device->port using $new_device->transport");
-            } elseif ($_POST['snmpver'] === 'v3') {
-                $new_device->snmpver = 'v3';
-                $new_device->authlevel = strip_tags($_POST['authlevel']);
-                $new_device->authname = $_POST['authname'];
-                $new_device->authpass = $_POST['authpass'];
-                $new_device->authalgo = strip_tags($_POST['authalgo']);
-                $new_device->cryptopass = $_POST['cryptopass'];
-                $new_device->cryptoalgo = $_POST['cryptoalgo'];
-                print_message("Adding SNMPv3 host: $hostname port: $port");
-            } else {
-                print_error('Unsupported SNMP Version. There was a dropdown menu, how did you reach this error ?');
-            }//end if
-            try {
-                $new_device->poller_group = strip_tags($_POST['poller_group'] ?? '');
-                $new_device->port_association_mode = PortAssociationMode::getId($_POST['port_assoc_mode']);
-                $force_add = (isset($_POST['force_add']) && $_POST['force_add'] == 'on');
-                $result = (new ValidateDeviceAndCreate($new_device, $force_add))->execute();
-                if ($result) {
-                    $link = \LibreNMS\Util\Url::deviceUrl($new_device->device_id);
-                    print_message("Device added <a href='$link'>$hostname ($new_device->device_id)</a>");
-                }
-            } catch (HostUnreachableException $e) {
-                print_error($e->getMessage());
-                foreach ($e->getReasons() as $reason) {
-                    print_error($reason);
-                }
-            } catch (Exception $e) {
-                print_error($e->getMessage());
-            }
-        } else {
-            print_error("You don't have the necessary privileges to add hosts.");
-        }
+        print_error("You don't have the necessary privileges to add hosts.");
     }
 }
 echo '    </div>
         <div class="col-sm-3">
         </div>
     </div>';
 $pagetitle[] = 'Add host';
 ?>
 <div class="row">
   <div class="col-sm-3">

--- a/includes/html/pages/api-access.inc.php
+++ b/includes/html/pages/api-access.inc.php
@@ -7,21 +7,23 @@
  * This program is free software: you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 use App\Models\ApiToken;
 use App\Models\User;
 use LibreNMS\Authentication\LegacyAuth;
 if (Auth::user()->hasGlobalAdmin()) {
-?>
+    if (empty($_POST['token'])) {
+        $_POST['token'] = bin2hex(openssl_random_pseudo_bytes(16));
+    } ?>
   <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="Delete" aria-hidden="true">
     <div class="modal-dialog modal-sm">
       <div class="modal-content">
         <div class="modal-header">
           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
           <h5 class="modal-title" id="Delete">Confirm Delete</h5>
         </div>
         <div class="modal-body">
           <p>If you would like to remove the API token then please click Delete.</p>
         </div>
@@ -50,20 +52,28 @@
             <?php echo csrf_field() ?>
             <div class="form-group">
               <label for="user_id" class="col-sm-2 control-label">User: </label>
               <div class="col-sm-4">
                 <select class="form-control" id="user_id" name="user_id">
     <?php
     foreach ($userlist = User::all() as $user) {
         echo '<option value="' . $user->user_id . '">' . htmlentities($user->username) . ' (' . htmlentities($user->auth_type) . ')</option>';
     } ?>
                 </select>
+              </div>
+            </div>
+            <div class="form-group">
+              <label for="token" class="col-sm-2 control-label">Token: </label>
+              <div class="col-sm-8">
+                <input type="text" class="form-control" id="token" name="token" value="<?php echo htmlspecialchars($_POST['token']); ?>" readonly>
+              </div>
+              <div class="col-sm-2">
               </div>
             </div>
             <div class="form-group">
               <label for="description" class="col-sm-2 control-label">Descr: </label>
               <div class="col-sm-10">
                 <input type="text" class="form-control" id="description" name="description" value="<?php echo htmlspecialchars($_POST['description']); ?>">
               </div>
             </div>
         </div>
         <div class="modal-footer">
@@ -123,24 +133,24 @@
           <th>Disabled</th>
           <th>Remove</th>
         </tr>
 ';
     foreach (ApiToken::all() as $api) {
         $user_details = $userlist->where('user_id', $api->user_id)->first();
         $api_disabled = $api->disabled == 1 ? 'checked' : '';
         $color = $user_details->auth_type == LegacyAuth::getType() ? '' : 'bgcolor="lightgrey"';
         echo '
         <tr id="' . $api->id . '" ' . $color . '>
-          <td>' . htmlentities($user_details->username) . '</td>
-          <td>' . htmlentities($user_details->auth_type) . '</td>
-          <td>' . htmlentities($api->token_hash) . '</td>
-          <td><button class="btn btn-info btn-xs" data-toggle="modal" data-target="#display-qr" data-token_hash="' . htmlentities($api->token_hash) . '"><i class="fa fa-qrcode" ></i></button></td>
+          <td>' . $user_details->username . '</td>
+          <td>' . $user_details->auth_type . '</td>
+          <td>' . $api->token_hash . '</td>
+          <td><button class="btn btn-info btn-xs" data-toggle="modal" data-target="#display-qr" data-token_hash="' . $api->token_hash . '"><i class="fa fa-qrcode" ></i></button></td>
           <td>' . htmlspecialchars($api->description) . '</td>
           <td><input type="checkbox" name="token-status" data-token_id="' . $api->id . '" data-off-text="No" data-on-text="Yes" data-on-color="danger" ' . $api_disabled . ' data-size="mini"></td>
           <td><button type="button" class="btn btn-danger btn-xs" id="' . $api->id . '" data-token_id="' . $api->id . '" data-toggle="modal" data-target="#confirm-delete">Delete</button></td>
         </tr>
 ';
     }
     echo '
       </table>
       <center>
           <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#create-token">Create API access token</button>

--- a/includes/html/pages/apps.inc.php
+++ b/includes/html/pages/apps.inc.php
@@ -425,39 +425,20 @@
     'f_dropped',
     'f_total',
     'ignore',
     'match',
     'max_bytes_log_line',
     'threshold',
     'total',
     'uptime',
     'alert',
 ];
-$graphs['oslv_monitor'] = [
-    'cpu_percent',
-    'mem_percent',
-    'time',
-    'procs',
-    'sizes',
-    'rss',
-    'vsz',
-    'faults',
-    'rwd_amount',
-    'ops_rwd',
-    'cows',
-    'sock',
-    'recv_sent_msgs',
-    'etime',
-    'swaps',
-    'signals_taken',
-    'switches',
-];
 $graphs['hv-monitor'] = [
     'status',
     'memory',
     'pmem',
     'time',
     'pcpu',
     'flt',
     'csw',
     'cow',
     'etimes',
@@ -553,91 +534,50 @@
     'netlink',
     'raw',
     'sctp',
     'tcp',
     'tipc',
     'udp',
     'unix',
     'vsock',
     'xdp',
 ];
-$graphs['http_access_log_combined'] = [
-    'bytes',
-    'codes_general',
-    'codes_1xx',
-    'codes_2xx',
-    'codes_3xx',
-    'codes_4xx',
-    'codes_5xx',
-    'methods',
-    'version',
-    'refer',
-    'user',
-    'log_size',
-    'error_size',
-];
 $graphs['borgbackup'] = [
     'unique_csize',
     'total_csize',
     'total_size',
     'total_chunks',
     'total_unique_chunks',
     'unique_size',
     'time_since_last_modified',
     'errored',
     'locked',
     'locked_for',
 ];
 $graphs['nfs'] = [
     'server_rpc',
     'server_cache',
     'client_rpc',
     'client_cache',
 ];
-$graphs['poudriere'] = [
-    'status',
-    'phase',
-    'time',
-    'log_size',
-    'package_size',
-    'cpu_perc',
-    'mem_perc',
-    'time_comparison',
-    'user_time',
-    'system_time',
-    'rss',
-    'threads',
-    'major_faults',
-    'minor_faults',
-    'swaps',
-    'size_comparison',
-    'stack_size',
-    'data_size',
-    'text_size',
-    'read_blocks',
-    'copy_on_write_faults',
-    'context_switches_comparison',
-    'voluntary_context_switches',
-    'involuntary_context_switches',
-];
 echo '<div class="panel panel-default">';
 echo '<div class="panel-heading">';
 echo "<span style='font-weight: bold;'>Apps</span> &#187; ";
 unset($sep);
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
 ];
-$apps = LibreNMS\Util\ObjectCache::applications()->flatten();
+$apps = \LibreNMS\Util\ObjectCache::applications()->flatten();
 foreach ($apps as $app) {
-    $app_state = LibreNMS\Util\Html::appStateIcon($app->app_state);
+    $app_state = \LibreNMS\Util\Html::appStateIcon($app->app_state);
     if (! empty($app_state['icon'])) {
         $app_state_info = '<font color="' . $app_state['color'] . '"><i title="' . $app_state['hover_text'] . '" class="fa ' . $app_state['icon'] . ' fa-fw fa-lg" aria-hidden="true"></i></font>';
     } else {
         $app_state_info = '';
     }
     echo $sep;
     if ($vars['app'] == $app->app_type) {
         echo "<span class='pagemenu-selected'>";
     }
     echo $app_state_info;

--- a//dev/null
+++ b/includes/html/pages/availability-map.inc.php
@@ -0,0 +1,5 @@
+<?php
+$directpage = 'yes';
+$pagetitle[] = 'Availability Map';
+include_once 'includes/html/common/availability-map.inc.php';
+echo implode('', $common_output);

--- a/includes/html/pages/device/apps/cape.inc.php
+++ b/includes/html/pages/device/apps/cape.inc.php
@@ -12,35 +12,32 @@
 ];
 foreach ($vars_to_check as $index => $value) {
     if (isset($vars[$value])) {
         if ($vars[$value] != 'on' and $vars[$value] != 'off') {
             $vars[$value] = 'off';
         }
     } else {
         $vars[$value] = 'off';
     }
 }
-if (isset($vars['package'])) {
-    $vars['package'] = htmlspecialchars($vars['package']);
-}
 if (sizeof($packages) > 0) {
     print_optionbar_start();
     if (isset($vars['package'])) {
         echo generate_link('General', $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]);
     } else {
         $label = '<span class="pagemenu-selected">General</span>';
         echo generate_link($label, $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]);
     }
     echo ' | <b>Packages:</b> ';
     $packages_int = 0;
     while (isset($packages[$packages_int])) {
-        $package = htmlspecialchars($packages[$packages_int]);
+        $package = $packages[$packages_int];
         $label = $package;
         if ($vars['package'] == $package) {
             $label = '<span class="pagemenu-selected">' . $package . '</span>';
         }
         $packages_int++;
         $append = '';
         if (isset($packages[$packages_int])) {
             $append = ', ';
         }
         echo generate_link($label, $link_array, ['app' => 'cape', 'stddev' => $vars['stddev'], 'bypkg' => $vars['bypkg'], 'bytimeslot' => $vars['bytimeslot'], 'package' => $package, 'statsavg' => $vars['statsavg'], 'runstats' => $vars['runstats']]) . $append;

--- a/includes/html/pages/device/apps/chronyd.inc.php
+++ b/includes/html/pages/device/apps/chronyd.inc.php
@@ -4,34 +4,30 @@
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'chronyd',
 ];
 print_optionbar_start();
 echo generate_link('Tracking', $link_array);
 echo ' | Sources: ';
 $sources = $app->data['sources'] ?? [];
 sort($sources);
 foreach ($sources as $index => $source) {
-    $source = htmlspecialchars($source);
     $label = $vars['source'] == $source
         ? '<span class="pagemenu-selected">' . $source . '</span>'
         : $source;
     echo generate_link($label, $link_array, ['source' => $source]);
     if ($index < (count($sources) - 1)) {
         echo ', ';
     }
 }
 print_optionbar_end();
 if (! isset($vars['source'])) {
-    if (isset($vars['source'])) {
-        $vars['source'] = htmlspecialchars($vars['source']);
-    }
     $graphs = [
         'chronyd_time' => 'System time',
         'chronyd_frequency' => 'System clock frequency',
         'chronyd_root' => 'Root stratum',
         'chronyd_stratum' => 'Stratum level',
     ];
 } else {
     $graphs = [
         'chronyd_source_sampling' => 'Clock sampling offsets',
         'chronyd_source_frequency' => 'Clock residual frequency',

--- a/includes/html/pages/device/apps/fail2ban.inc.php
+++ b/includes/html/pages/device/apps/fail2ban.inc.php
@@ -16,21 +16,20 @@
     <div class="panel-body">
     <div class="row">';
     include 'includes/html/print-graphrow.inc.php';
     echo '</div>';
     echo '</div>';
     echo '</div>';
 }
 $jails = $app->data['jails'] ?? [];
 sort($jails);
 foreach ($jails as $jail) {
-    $jail = htmlspecialchars($jail);
     $graph_type = 'fail2ban_jail';
     $graph_array['height'] = '100';
     $graph_array['width'] = '215';
     $graph_array['to'] = \LibreNMS\Config::get('time.now');
     $graph_array['id'] = $app->app_id;
     $graph_array['type'] = 'application_fail2ban_jail';
     $graph_array['jail'] = $jail;
     echo '<div class="panel panel-default">
     <div class="panel-heading">
         <h3 class="panel-title">Jail: ' . $jail . '</h3>

--- a/includes/html/pages/device/apps/http_access_log_combined.inc.php
+++ b//dev/null
@@ -1,383 +0,0 @@
-<?php
-$name = 'http_access_log_combined';
-$link_array = [
-    'page' => 'device',
-    'device' => $device['device_id'],
-    'tab' => 'apps',
-    'app' => 'http_access_log_combined',
-];
-$app_data = $app->data;
-if (isset($vars['access_log_page'])) {
-    $vars['access_log_page'] = htmlspecialchars($vars['access_log_page']);
-}
-print_optionbar_start();
-$label = (isset($vars['access_log_page']) || isset($vars['log']))
-    ? 'Totals'
-    : '<span class="pagemenu-selected">Totals</span>';
-echo generate_link($label, $link_array);
-echo ' | Details(';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'bytes')
-    ? 'Bytes'
-    : '<span class="pagemenu-selected">Bytes</span>';
-echo generate_link($label, $link_array, ['access_log_page' => 'bytes']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'method')
-    ? 'Method'
-    : '<span class="pagemenu-selected">Method</span>';
-echo generate_link($label, $link_array, ['access_log_page' => 'method']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'version')
-    ? 'Version'
-    : '<span class="pagemenu-selected">Version</span>';
-echo generate_link($label, $link_array, ['access_log_page' => 'version']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'log_size')
-    ? 'Log Size'
-    : '<span class="pagemenu-selected">Log Size</span>';
-echo generate_link($label, $link_array, ['access_log_page' => 'log_size']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'refer')
-    ? 'Refer'
-    : '<span class="pagemenu-selected">Refer</span>';
-echo generate_link($label, $link_array, ['access_log_page' => 'refer']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != 'user')
-    ? 'User'
-    : '<span class="pagemenu-selected">User</span>';
-echo generate_link($label, $link_array, ['access_log_page' => 'user']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '1xx')
-    ? '1xx'
-    : '<span class="pagemenu-selected">1xx</span>';
-echo generate_link($label, $link_array, ['access_log_page' => '1xx']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '2xx')
-    ? '2xx'
-    : '<span class="pagemenu-selected">2xx</span>';
-echo generate_link($label, $link_array, ['access_log_page' => '2xx']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '3xx')
-    ? '3xx'
-    : '<span class="pagemenu-selected">2xx</span>';
-echo generate_link($label, $link_array, ['access_log_page' => '3xx']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '4xx')
-    ? '4xx'
-    : '<span class="pagemenu-selected">4xx</span>';
-echo generate_link($label, $link_array, ['access_log_page' => '4xx']) . ',';
-$label = (! isset($vars['access_log_page']) || $vars['access_log_page'] != '5xx')
-    ? '5xx'
-    : '<span class="pagemenu-selected">5xx</span>';
-echo generate_link($label, $link_array, ['access_log_page' => '5xx']);
-echo ') | Sets: ';
-$index_int = 0;
-foreach ($app_data['logs'] as $index => $log_name) {
-    $log_name = htmlspecialchars($log_name);
-    $label = (isset($vars['access_log_page']) || $vars['log'] != $log_name)
-        ? $log_name
-        : '<span class="pagemenu-selected">' . $log_name . '</span>';
-    $index_int++;
-    echo generate_link($label, $link_array, ['log' => $log_name]);
-    if (isset($app_data['logs'][$index_int])) {
-        echo ', ';
-    }
-}
-print_optionbar_end();
-if (isset($vars['access_log_page']) && $vars['access_log_page'] == 'bytes') {
-    $graphs = [];
-    $stats = [
-        'bytes' => 'Bytes',
-        'bytes_max' => 'Bytes, Max',
-        'bytes_mean' => 'Bytes, Mean',
-        'bytes_median' => 'Bytes, Median',
-        'bytes_mode' => 'Bytes, Mode',
-        'bytes_min' => 'Bytes, Min',
-        'bytes_range' => 'Bytes, Range',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'method') {
-    $graphs = [];
-    $stats = [
-        'CONNECT',
-        'DELETE',
-        'GET',
-        'HEAD',
-        'OPTIONS',
-        'PATCH',
-        'POST',
-        'PUT',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $val,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'version') {
-    $graphs = [];
-    $stats = [
-        'http1_0' => 'HTTP/1.0',
-        'http1_1' => 'HTTP/1.1',
-        'http2' => 'HTTP/2',
-        'http3' => 'HTTP/3',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'log_size') {
-    $graphs = [];
-    $stats = [
-        'size' => 'Log Size',
-        'error_size' => 'Error Log Size',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'refer') {
-    $graphs = [];
-    $stats = [
-        'refer' => 'Refer Set, not "-"',
-        'no_refer' => 'No Refer Set, "-"',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == 'user') {
-    $graphs = [];
-    $stats = [
-        'user' => 'User Set, not "-"',
-        'no_user' => 'No User Set, "-"',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '1xx') {
-    $graphs = [];
-    $stats = [
-        '1xx' => 'Any 1xx Response Code',
-        '100' => '100: Continue',
-        '101' => '101: Switching Protocols',
-        '102' => '102: Processing (WebDAV; RFC 2518)',
-        '103' => '103: Early Hints (RFC 8297)',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '2xx') {
-    $graphs = [];
-    $stats = [
-        '2xx' => 'Any 2xx Response Code',
-        '200' => '200: OK',
-        '201' => '201: Created',
-        '202' => '202: Accepted',
-        '203' => '203: Non-Authoritative Information (since HTTP/1.1)',
-        '204' => '204: No Content',
-        '205' => '205: Reset Content',
-        '206' => '206: Partial Content',
-        '207' => '207: Multi-Status (WebDAV; RFC 4918)',
-        '208' => '208: Already Reported (WebDAV; RFC 5842)',
-        '218' => '218: This is fine (Apache HTTP Server)',
-        '226' => '226 IM Used (RFC 3229)',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '3xx') {
-    $graphs = [];
-    $stats = [
-        '3xx' => 'Any 3xx Response Code',
-        '300' => '300: Multiple Choices',
-        '301' => '301: Moved Permanently',
-        '302' => '302: Found (Previously "Moved temporarily")',
-        '303' => '303: See Other (since HTTP/1.1)',
-        '304' => '304: Not Modified',
-        '305' => '305: Use Proxy (since HTTP/1.1)',
-        '306' => '306 Switch Proxy',
-        '307' => '307 Temporary Redirect (since HTTP/1.1)',
-        '308' => '308 Permanent Redirect',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '4xx') {
-    $graphs = [];
-    $stats = [
-        '4xx' => 'Any 4xx Response Code',
-        '400' => '400: Bad Request',
-        '401' => '401: Unauthorized',
-        '402' => '402: Payment Required',
-        '403' => '403: Forbidden',
-        '404' => '404: Not Found',
-        '405' => '405: Method Not Allowed',
-        '406' => '406: Not Acceptable',
-        '407' => '407: Proxy Authentication Required',
-        '408' => '408: Request Timeout',
-        '409' => '409: Conflict',
-        '410' => '410: Gone',
-        '411' => '411: Length Required',
-        '412' => '412: Precondition Failed',
-        '413' => '413: Payload Too Large',
-        '414' => '414: URI Too Long',
-        '415' => '415: Unsupported Media Type',
-        '416' => '416: Range Not Satisfiable',
-        '417' => '417: Expectation Failed',
-        '419' => '419: Page Expired (Laravel Framework)',
-        '420' => '420: Method Failure (Spring Framework)',
-        '421' => '421: Misdirected Request',
-        '422' => '422: Unprocessable Content',
-        '423' => '423: Locked (WebDAV; RFC 4918)',
-        '424' => '424: Failed Dependency (WebDAV; RFC 4918)',
-        '425' => '425: Too Early (RFC 8470)',
-        '426' => '426: Upgrade Required',
-        '428' => '428: Precondition Required (RFC 6585)                    ',
-        '429' => '429: Too Many Requests (RFC 6585)',
-        '431' => '431: Request Header Fields Too Large (RFC 6585)',
-        '444' => '444: nginx No Response',
-        '451' => '451: Unavailable For Legal Reasons (RFC 7725)',
-        '494' => '494: nginx Request header too large',
-        '495' => '495: nginx SSL Certificate Error',
-        '496' => '496: nginx SSL Certificate Required',
-        '497' => '497: nginx HTTP Request Sent to HTTPS Port',
-        '499' => '499: nginx Client Closed Request',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} elseif (isset($vars['access_log_page']) && $vars['access_log_page'] == '5xx') {
-    $graphs = [];
-    $stats = [
-        '5xx' => 'Any 5xx Response Code',
-        '500' => '500: Internal Server Error',
-        '501' => '501: Not Implemented',
-        '502' => '502: Bad Gateway',
-        '503' => '503: Service Unavailable',
-        '504' => '504: Gateway Timeout',
-        '505' => '505: HTTP Version Not Supported',
-        '506' => '506: Variant Also Negotiates (RFC 2295)',
-        '507' => '507: Insufficient Storage (WebDAV; RFC 4918)',
-        '508' => '508: Loop Detected (WebDAV; RFC 5842)',
-        '509' => '509: Bandwidth Limit Exceeded (Apache Web Server/cPanel)',
-        '510' => '510: Not Extended (RFC 2774)',
-        '511' => '511: Network Authentication Required (RFC 6585)',
-    ];
-    foreach ($stats as $key => $val) {
-        $graphs[] = [
-            'type' => 'stat',
-            'description' => $val,
-            'stat' => $key,
-        ];
-    }
-} else {
-    $graphs = [
-        [
-            'type' => 'bytes',
-            'description' => 'Bytes, Total',
-        ],
-        [
-            'type' => 'bytes_stats',
-            'description' => 'Bytes, Stats',
-        ],
-        [
-            'type' => 'codes_general',
-            'description' => 'Response Status Codes, General',
-        ],
-        [
-            'type' => 'codes_1xx',
-            'description' => 'Response Status Codes, 1xx',
-        ],
-        [
-            'type' => 'codes_2xx',
-            'description' => 'Response Status Codes, 2xx',
-        ],
-        [
-            'type' => 'codes_3xx',
-            'description' => 'Response Status Codes, 3xx',
-        ],
-        [
-            'type' => 'codes_4xx',
-            'description' => 'Response Status Codes, 4xx',
-        ],
-        [
-            'type' => 'codes_5xx',
-            'description' => 'Response Status Codes, 5xx',
-        ],
-        [
-            'type' => 'methods',
-            'description' => 'Request Methods',
-        ],
-        [
-            'type' => 'version',
-            'description' => 'HTTP Version',
-        ],
-        [
-            'type' => 'refer',
-            'description' => 'Refer Present/Not Present',
-        ],
-        [
-            'type' => 'user',
-            'description' => 'User Present/Not Present',
-        ],
-        [
-            'type' => 'log_size',
-            'description' => 'Access Log File Size',
-        ],
-        [
-            'type' => 'error_size',
-            'description' => 'Error Log File Size',
-        ],
-    ];
-}
-foreach ($graphs as $key => $graph_info) {
-    $graph_type = $graph_info['type'];
-    $graph_array['height'] = '100';
-    $graph_array['width'] = '215';
-    $graph_array['to'] = time();
-    $graph_array['id'] = $app['app_id'];
-    $graph_array['type'] = 'application_' . $name . '_' . $graph_info['type'];
-    if (isset($vars['log'])) {
-        $graph_array['log'] = $vars['log'];
-    }
-    if (isset($graph_info['stat'])) {
-        $graph_array['log_stat'] = $graph_info['stat'];
-    }
-    echo '<div class="panel panel-default">
-    <div class="panel-heading">
-        <h3 class="panel-title">' . $graph_info['description'] . '</h3>
-    </div>
-    <div class="panel-body">
-    <div class="row">';
-    include 'includes/html/print-graphrow.inc.php';
-    echo '</div>';
-    echo '</div>';
-    echo '</div>';
-}

--- a/includes/html/pages/device/apps/hv-monitor.inc.php
+++ b/includes/html/pages/device/apps/hv-monitor.inc.php
@@ -3,44 +3,35 @@
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'hv-monitor',
 ];
 print_optionbar_start();
 if (! isset($vars['vm'])) {
     echo generate_link('<span class="pagemenu-selected"><b>Totals</b></span>', $link_array);
 } else {
-    $vars['vm'] = htmlspecialchars($vars['vm']);
     echo generate_link('<b>Totals</b>', $link_array);
 }
 echo '<b> | VMs: </b>';
 $vm_links = [];
 foreach ($app->data['VMs'] as $vm) {
-    $vm = htmlspecialchars($vm);
     $label = $vm;
     if ($vars['vm'] == $vm) {
         $label = '<span class="pagemenu-selected">' . $vm . '</span>';
     }
     $vm_links[] = generate_link($label, $link_array, ['vm' => $vm]);
 }
 echo implode(', ', $vm_links);
 if (! isset($vars['vmif']) && ! isset($vars['vmdisk'])) {
     if (! isset($vars['vmpage'])) {
         $vars['vmpage'] = 'general';
-    }
-} else {
-    if (isset($vars['vmif'])) {
-        $vars['vmif'] = htmlspecialchars($vars['vmif']);
-    }
-    if (isset($vars['vmdisk'])) {
-        $vars['vmdisk'] = htmlspecialchars($vars['vmdisk']);
     }
 }
 echo '<br><b>Pages: </b>';
 if ($vars['vmpage'] == 'general') {
     $page_links[] = '<span class="pagemenu-selected">General</span>';
 } else {
     $page_links[] = generate_link('General', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'general']);
 }
 if ($vars['vmpage'] == 'disk') {
     $page_links[] = '<span class="pagemenu-selected">Disk</span>';
@@ -55,21 +46,20 @@
 if ($vars['vmpage'] == 'Snapshots') {
     $page_links[] = '<span class="pagemenu-selected">Network</span>';
 } else {
     $page_links[] = generate_link('Snapshots', $link_array, ['vm' => $vars['vm'], 'vmpage' => 'snapshots']);
 }
 echo implode(', ', $page_links);
 if (isset($vars['vm'])) {
     echo '<br><b>Disks:</b> ';
     $disk_links = [];
     foreach ($app->data['VMdisks'][$vars['vm']] as $index => $disk) {
-        $disk = htmlspecialchars($disk);
         $label = $disk;
         if ($vars['vmdisk'] == $disk) {
             $label = '<span class="pagemenu-selected">' . $disk . '</span>';
         }
         if ($vars['vmdisk'] == $disk) {
             $disk_links[] = $label;
         } else {
             $disk_links[] = generate_link($label, $link_array, ['vm' => $vars['vm'], 'vmdisk' => $disk]);
         }
     }
@@ -80,40 +70,40 @@
         $label = $vmif;
         if ($vars['vmif'] == $vmif) {
             $if_links[] = '<span class="pagemenu-selected">' . $vmif . '</span>';
         } else {
             $if_links[] = generate_link($label, $link_array, ['vm' => $vars['vm'], 'vmif' => $vmif]);
         }
     }
     echo implode(', ', $if_links);
 }
 if (isset($vars['vmif']) and isset($vars['vm'])) {
-    $mac = htmlspecialchars($app->data['VMifs'][$vars['vm']][$vars['vmif']]['mac']);
+    $mac = $app->data['VMifs'][$vars['vm']][$vars['vmif']]['mac'];
     $port = Port::with('device')->firstWhere(['ifPhysAddress' => str_replace(':', '', $mac)]);
     echo "\n<br>\n" .
         '<b>MAC:</b> ' . $mac;
     if (isset($port) && isset($mac) && $mac != '') {
         echo ' (' .
                generate_device_link(['device_id' => $port->device_id]) .
                ', ' .
                generate_port_link([
                    'label' => $port->label,
                    'port_id' => $port->port_id,
                    'ifName' => $port->ifName,
                    'device_id' => $port->device_id,
                ]) .
             ')';
     }
     echo "<br>\n";
     $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $app->data['VMifs'][$vars['vm']][$vars['vmif']]['if']]);
     if (! isset($port)) {
-        echo '<b>HV if:</b> ' . htmlspecialchars($app->data['VMifs'][$vars['vm']][$vars['vmif']]['if']) . "\n";
+        echo '<b>HV if:</b> ' . $app->data['VMifs'][$vars['vm']][$vars['vmif']]['if'] . "\n";
     } else {
         echo '<b>HV if:</b> ' .
             generate_port_link([
                 'label' => $port->label,
                 'port_id' => $port->port_id,
                 'ifName' => $port->ifName,
                 'device_id' => $port->device_id,
             ]);
     }
     if ($app->data['VMifs'][$vars['vm']][$vars['vmif']]['parent'] != '') {

--- a/includes/html/pages/device/apps/mojo_cape_submit.inc.php
+++ b/includes/html/pages/device/apps/mojo_cape_submit.inc.php
@@ -3,32 +3,30 @@
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'mojo_cape_submit',
 ];
 print_optionbar_start();
 echo generate_link('General', $link_array);
 echo ' | Slugs: ';
 $slugs = $app->data['slugs'];
 foreach (array_keys($slugs) as $index => $slug) {
-    $slug = htmlspecialchars($slug);
     $label = $vars['slug'] == $slug
         ? '<span class="pagemenu-selected">' . $slug . '</span>'
         : $slug;
     echo generate_link($label, $link_array, ['slug' => $slug]);
     if ($index < (count($slugs) - 1)) {
         echo ', ';
     }
 }
 print_optionbar_end();
 if (isset($vars['slug'])) {
-    $vars['slug'] = htmlspecialchars($vars['slug']);
     $graphs = [
         'mojo_cape_submit_subs' => 'Submissions',
         'mojo_cape_submit_hash_changed' => 'Submissions where the hashes changed',
         'mojo_cape_submit_app_protos' => 'App protocols seen',
         'mojo_cape_submit_size_sum' => 'Size in bytes of submissions',
         'mojo_cape_submit_size_stats' => 'Size stats of submissions',
         'mojo_cape_submit_size_max' => 'Size max of any submissions',
         'mojo_cape_submit_size_mean' => 'Size mean of submissions',
         'mojo_cape_submit_size_mode' => 'Size mode of submissions',
         'mojo_cape_submit_size_median' => 'Size median of submissions',

--- a/includes/html/pages/device/apps/opensearch.inc.php
+++ b/includes/html/pages/device/apps/opensearch.inc.php
@@ -1,19 +1,19 @@
 <?php
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'opensearch',
 ];
 print_optionbar_start();
-echo '<b>Cluster Name:</b> ' . htmlspecialchars($app->data['cluster']) . '<br>';
+echo '<b>Cluster Name:</b> ' . $app->data['cluster'] . '<br>';
 echo '<b>Graph Sets:</b> ';
 echo generate_link('Cluster, ', $link_array);
 $link_array['set'] = 'translog';
 echo generate_link('Translog, ', $link_array);
 $link_array['set'] = 'indexing';
 echo generate_link('Indexing, ', $link_array);
 $link_array['set'] = 'search';
 echo generate_link('Search, ', $link_array);
 $link_array['set'] = 'refresh';
 echo generate_link('Refresh, ', $link_array);

--- a/includes/html/pages/device/apps/oslv_monitor.inc.php
+++ b//dev/null
@@ -1,654 +0,0 @@
-<?php
-use App\Models\Port;
-use App\Models\Storage;
-$name = 'oslv_monitor';
-$device_obj = DeviceCache::get($device['device_id']);
-$link_array = [
-    'page' => 'device',
-    'device' => $device['device_id'],
-    'tab' => 'apps',
-    'app' => 'oslv_monitor',
-];
-if (isset($vars['oslvm'])) {
-    $vars['oslvm'] = htmlspecialchars($vars['oslvm']);
-}
-$app_data = $app->data;
-if (! isset($app_data['has']) || ! is_array($app_data['has'])) {
-    $app_data['has'] = [];
-}
-print_optionbar_start();
-$label = isset($vars['oslvm'])
-    ? 'Totals'
-    : '<span class="pagemenu-selected">Totals</span>';
-echo generate_link($label, $link_array);
-if (isset($app_data['backend']) && $app_data['backend'] != 'cgroups') {
-    $oslvm_name = 'Jails';
-    if ($app_data['backend'] != 'FreeBSD') {
-        $oslvm_name = 'OSLVMs';
-    }
-    if (! isset($app_data['inactive']) || ! isset($app_data['inactive'][0])) {
-        echo "<br>\n" . $oslvm_name . ": \n";
-    } else {
-        echo "\n<br>Current " . $oslvm_name . ": \n";
-    }
-    $index_int = 0;
-    foreach ($app_data['oslvms'] as $index => $oslvm) {
-        $oslvm = htmlspecialchars($oslvm);
-        $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-            ? $oslvm
-            : '<span class="pagemenu-selected">' . $oslvm . '</span>';
-        $index_int++;
-        echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-        if (isset($app_data['oslvms'][$index_int])) {
-            echo ', ';
-        }
-    }
-    if (isset($app_data['inactive']) && isset($app_data['inactive'][0])) {
-        echo "\n<br>Old " . $oslvm_name . ': ';
-        sort($app_data['inactive']);
-        $index_int = 0;
-        foreach ($app_data['inactive'] as $index => $oslvm) {
-            $oslvm = htmlspecialchars($oslvm);
-            $label = (! isset($vars['inactive']) || $vars['oslvm'] != $oslvm)
-                ? $oslvm
-                : '<span class="pagemenu-selected">' . $oslvm . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($app_data['inactive'][$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-}
-if (isset($app_data['backend']) && $app_data['backend'] == 'cgroups') {
-    $podman_containers = [];
-    $docker_containers = [];
-    $systemd_containers = [];
-    $other_containers = [];
-    $user_containers = [];
-    foreach ($app_data['oslvms'] as $index => $oslvm) {
-        $oslvm = htmlspecialchars($oslvm);
-        if (preg_match('/^d_.*/', $oslvm)) {
-            $docker_containers[] = $oslvm;
-        } elseif (preg_match('/^s_.*/', $oslvm)) {
-            $systemd_containers[] = $oslvm;
-        } elseif (preg_match('/^u_.*/', $oslvm)) {
-            $user_containers[] = $oslvm;
-        } elseif (preg_match('/^p_.*/', $oslvm) || preg_match('/^libpod.*/', $oslvm)) {
-            $podman_containers[] = $oslvm;
-        } else {
-            $other_containers[] = $oslvm;
-        }
-    }
-    $seen_podman_containers = [];
-    $seen_docker_containers = [];
-    $seen_systemd_containers = [];
-    $seen_other_containers = [];
-    $seen_user_containers = [];
-    foreach ($app_data['inactive'] as $index => $oslvm) {
-        $oslvm = htmlspecialchars($oslvm);
-        if (preg_match('/^d_.*/', $oslvm)) {
-            $seen_docker_containers[] = $oslvm;
-        } elseif (preg_match('/^s_.*/', $oslvm)) {
-            $seen_systemd_containers[] = $oslvm;
-        } elseif (preg_match('/^u_.*/', $oslvm)) {
-            $seen_user_containers[] = $oslvm;
-        } elseif (preg_match('/^p_.*/', $oslvm) || preg_match('/^libpod.*/', $oslvm)) {
-            $seen_podman_containers[] = $oslvm;
-        } else {
-            $seen_other_containers[] = $oslvm;
-        }
-    }
-    sort($seen_podman_containers);
-    sort($seen_docker_containers);
-    sort($seen_systemd_containers);
-    sort($seen_other_containers);
-    sort($seen_user_containers);
-    if (isset($podman_containers[0])) {
-        if (! isset($seen_podman_containers[0])) {
-            echo "\n<br>Podman Containers<b>:</b> \n";
-        } else {
-            echo "\n<br>Current Podman Containers<b>:</b> \n";
-        }
-        $index_int = 0;
-        foreach ($podman_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^p\_/', '', $oslvm_name);
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-            ? $oslvm_name
-            : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($podman_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($seen_podman_containers[0])) {
-        echo "\n<br>Previous Podman Containers<b>:</b> \n";
-        $index_int = 0;
-        foreach ($seen_podman_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^p\_/', '', $oslvm_name);
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-            ? $oslvm_name
-            : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($seen_podman_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($docker_containers[0])) {
-        if (! isset($seen_docker_containers[0])) {
-            echo "\n<br>Docker Containers<b>:</b> \n";
-        } else {
-            echo "\n<br>Current Docker Containers<b>:</b> \n";
-        }
-        $index_int = 0;
-        foreach ($docker_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^d\_/', '', $oslvm_name);
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-                ? $oslvm_name
-                : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($docker_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($seen_docker_containers[0])) {
-        echo "\n<br>Previous Docker Containers<b>:</b> \n";
-        $index_int = 0;
-        foreach ($seen_docker_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^d\_/', '', $oslvm_name);
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-            ? $oslvm_name
-            : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($seen_docker_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($systemd_containers[0])) {
-        if (! isset($seen_systemd_containers[0])) {
-            echo "\n<br>SystemD Containers<b>:</b> \n";
-        } else {
-            echo "\n<br>Current SystemD Containers<b>:</b> \n";
-        }
-        $index_int = 0;
-        foreach ($systemd_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^s\_/', '', $oslvm_name);
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-                ? $oslvm_name
-                : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($systemd_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($seen_systemd_containers[0])) {
-        echo "\n<br>Previous SystemD Containers<b>:</b> \n";
-        $index_int = 0;
-        foreach ($seen_systemd_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^s\_/', '', $oslvm_name);
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-            ? $oslvm_name
-            : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($seen_systemd_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($user_containers[0])) {
-        if (! isset($seen_user_containers[0])) {
-            echo "\n<br>User Containers<b>:</b> \n";
-        } else {
-            echo "\n<br>Current User Containers<b>:</b> \n";
-        }
-        $index_int = 0;
-        foreach ($user_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^u\_/', '', $oslvm_name);
-            if (isset($app_data['uid_mapping'][$oslvm_name])) {
-                $oslvm_name = $oslvm_name . '(' . $app_data['uid_mapping'][$oslvm_name]['name'] . ')';
-            }
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-                ? $oslvm_name
-                : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($user_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($seen_user_containers[0])) {
-        echo "\n<br>Previous User Containers<b>:</b> \n";
-        $index_int = 0;
-        foreach ($seen_user_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^u\_/', '', $oslvm_name);
-            if (isset($app_data['uid_mapping'][$oslvm_name])) {
-                $oslvm_name = $oslvm_name . '(' . $app_data['uid_mapping'][$oslvm_name]['name'] . ')';
-            }
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-            ? $oslvm_name
-            : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($seen_user_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($other_containers[0])) {
-        if (! isset($seen_other_containers[0])) {
-            echo "\n<br>Other Containers<b>:</b> \n";
-        } else {
-            echo "\n<br>Current Other Containers<b>:</b> \n";
-        }
-        $index_int = 0;
-        foreach ($other_containers as $index => $oslvm) {
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-                ? $oslvm
-                : '<span class="pagemenu-selected">' . $oslvm . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($other_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-    if (isset($seen_other_containers[0])) {
-        echo "\n<br>Previous Other Containers<b>:</b> \n";
-        $index_int = 0;
-        foreach ($seen_other_containers as $index => $oslvm) {
-            $oslvm_name = $oslvm;
-            $oslvm_name = preg_replace('/^d\_/', '', $oslvm_name);
-            $label = (! isset($vars['oslvm']) || $vars['oslvm'] != $oslvm)
-            ? $oslvm_name
-            : '<span class="pagemenu-selected">' . $oslvm_name . '</span>';
-            $index_int++;
-            echo generate_link($label, $link_array, ['oslvm' => $oslvm]);
-            if (isset($seen_other_containers[$index_int])) {
-                echo ', ';
-            }
-        }
-    }
-}
-if (isset($vars['oslvm']) && isset($app_data['oslvm_data'][$vars['oslvm']])) {
-    if (isset($app_data['oslvm_data'][$vars['oslvm']]['path'][0])) {
-        $table_info = [
-            'headers' => [
-                'Path',
-                'Mount Point',
-                'Usage',
-                '',
-            ],
-            'rows' => [],
-        ];
-        foreach ($app_data['oslvm_data'][$vars['oslvm']]['path'] as $index => $path) {
-            $path = htmlspecialchars($path);
-            $path = preg_replace('/\/$/', '', $path);
-            $mount_path = $path;
-            $mount_path_raw = false;
-            $mount_path_usage = '';
-            $mount_path_usage_raw = false;
-            $mount_path_usage_graph = '';
-            $mount_path_usage_graph_raw = false;
-            $storage_info = Storage::firstWhere(
-                ['storage_descr' => $mount_path],
-                ['device_id' => $device['device_id']]
-            );
-            if (! isset($storage_info) && ! preg_match('/^\/+$/', $mount_path)) {
-                $mount_path = preg_replace('/\/[^\/]+$/', '', $mount_path);
-                while ($mount_path != '' && ! isset($storage_info)) {
-                    $storage_info = Storage::firstWhere(
-                        ['storage_descr' => $mount_path],
-                        ['device_id' => $device['device_id']]
-                    );
-                    if (! isset($storage_info)) {
-                        $mount_path = preg_replace('/\/[^\/]+$/', '', $mount_path);
-                    }
-                }
-            }
-            if (isset($storage_info)) {
-                $mount_path_raw = true;
-                $mount_path_usage_raw = true;
-                $mount_path_usage_graph_raw = true;
-                $path_graph_array = [];
-                $path_graph_array['height'] = '100';
-                $path_graph_array['width'] = '210';
-                $path_graph_array['to'] = LibreNMS\Config::get('time.now');
-                $path_graph_array['id'] = $storage_info['storage_id'];
-                $path_graph_array['type'] = 'storage_usage';
-                $path_graph_array['from'] = LibreNMS\Config::get('time.day');
-                $path_graph_array['legend'] = 'no';
-                $path_link_array = $path_graph_array;
-                $path_link_array['page'] = 'graphs';
-                unset($rpath_link_array['height'], $path_link_array['width'], $path_link_array['legend']);
-                $path_link = LibreNMS\Util\Url::generate($path_link_array);
-                $path_overlib_content = generate_overlib_content($path_graph_array, $device['hostname'] . ' - ' . $storage_info['storage_descr']);
-                $path_graph_array['width'] = 80;
-                $path_graph_array['height'] = 20;
-                $path_graph_array['bg'] = 'ffffff00';
-                $path_minigraph = LibreNMS\Util\Url::lazyGraphTag($path_graph_array);
-                $mount_path = LibreNMS\Util\Url::overlibLink($path_link, $mount_path, $path_overlib_content);
-                $mount_path_usage = round($storage_info['storage_perc']) . '% ';
-                $mount_path_usage_graph = LibreNMS\Util\Url::overlibLink($path_link, $path_minigraph, $path_overlib_content);
-            }
-        }
-        $table_info['rows'][] = [
-            [
-                'data' => $path,
-            ],
-            [
-                'data' => $mount_path,
-                'raw' => $mount_path_raw,
-            ],
-            [
-                'data' => $mount_path_usage,
-                'raw' => $mount_path_usage_raw,
-            ],
-            [
-                'data' => $mount_path_usage_graph,
-                'raw' => $mount_path_usage_graph_raw,
-            ],
-        ];
-        echo view('widgets/sortable_table', $table_info);
-    }
-    if (isset($app_data['oslvm_data'][$vars['oslvm']]['ip'][0])) {
-        $table_info = [
-            'headers' => [
-                'IP',
-                'Interface',
-                'Speed',
-                'Pkts/Sec In',
-                'Pkts/Sec Out',
-                'Bytes/Sec In',
-                'Bytes/Sec Out',
-                'Errors/Sec In',
-                'Errors/Sec Out',
-                'Gateway',
-                'GW If',
-            ],
-            'rows' => [],
-        ];
-        foreach ($app_data['oslvm_data'][$vars['oslvm']]['ip'] as $index => $ip_data) {
-            $ip = '';
-            $interface = '';
-            $interface_raw = false;
-            $gw_ip = '';
-            $gw_interface = '';
-            $gw_interface_raw = false;
-            $if_speed = '';
-            $ifInUcastPkts_rate = '';
-            $ifOutUcastPkts_rate = '';
-            $ifInErrors_rate = '';
-            $ifOutErrors_rate = '';
-            $ifOutErrors_rate = '';
-            $ifInOctets_rate = '';
-            $ifOutOctets_rate = '';
-            if (isset($ip_data) && ! is_null($ip_data)) {
-                if (is_array($ip_data)) {
-                    if (isset($ip_data['ip']) && ! is_null($ip_data['ip'])) {
-                        $ip = $ip_data['ip'];
-                        $ip = htmlspecialchars($ip);
-                    }
-                    if (isset($ip_data['gw']) && ! is_null($ip_data['gw'])) {
-                        $gw_ip = $ip_data['gw'];
-                        $gw_ip = htmlspecialchars($gw_ip);
-                    }
-                    if (isset($ip_data['if']) && ! is_null($ip_data['if'])) {
-                        $interface = $ip_data['if'];
-                        $interface = htmlspecialchars($interface);
-                        $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $interface]);
-                        if (isset($port)) {
-                            $interface_raw = true;
-                            $interface = generate_port_link([
-                                'label' => $port->label,
-                                'port_id' => $port->port_id,
-                                'ifName' => $port->ifName,
-                                'device_id' => $port->device_id,
-                            ]);
-                        }
-                        $if_speed = $port->ifSpeed;
-                        $ifInUcastPkts_rate = $port->ifInUcastPkts_rate;
-                        $ifOutUcastPkts_rate = $port->ifOutUcastPkts_rate;
-                        $ifInErrors_rate = $port->ifInErrors_rate;
-                        $ifOutErrors_rate = $port->ifOutErrors_rate;
-                        $ifInOctets_rate = $port->ifInOctets_rate;
-                        $ifOutOctets_rate = $port->ifOutOctets_rate;
-                    }
-                    if (isset($ip_data['gw_if']) && ! is_null($ip_data['gw_if'])) {
-                        $gw_interface = $ip_data['gw_if'];
-                        $gw_interface = htmlspecialchars($gw_interface);
-                        $port = Port::with('device')->firstWhere(['device_id' => $app->device_id, 'ifName' => $gw_interface]);
-                        if (isset($port)) {
-                            $gw_interface_raw = true;
-                            $gw_interface = generate_port_link([
-                                'label' => $port->label,
-                                'port_id' => $port->port_id,
-                                'ifName' => $port->ifName,
-                                'device_id' => $port->device_id,
-                            ]);
-                        }
-                    }
-                } else {
-                    $ip = $ip_data;
-                }
-            }
-            if ($ip != '') {
-                $table_info['rows'][] = [
-                    [
-                        'data' => $ip,
-                    ],
-                    [
-                        'data' => $interface,
-                        'raw' => $interface_raw,
-                    ],
-                    [
-                        'data' => $if_speed,
-                    ],
-                    [
-                        'data' => $ifInUcastPkts_rate,
-                    ],
-                    [
-                        'data' => $ifOutUcastPkts_rate,
-                    ],
-                    [
-                        'data' => $ifInOctets_rate,
-                    ],
-                    [
-                        'data' => $ifOutOctets_rate,
-                    ],
-                    [
-                        'data' => $ifInErrors_rate,
-                    ],
-                    [
-                        'data' => $ifOutErrors_rate,
-                    ],
-                    [
-                        'data' => $gw_ip,
-                    ],
-                    [
-                        'data' => $gw_interface,
-                        'raw' => $gw_interface_raw,
-                    ],
-                ];
-            }
-        }
-        echo view('widgets/sortable_table', $table_info);
-    }
-}
-print_optionbar_end();
-$graphs = [
-    [
-        'type' => 'cpu_percent',
-        'description' => 'CPU Usage Percent',
-    ],
-    [
-        'type' => 'mem_percent',
-        'description' => 'Memory Usage Percent',
-    ],
-    [
-        'type' => 'time',
-        'description' => 'CPU/System/User Time in secs/sec',
-    ],
-    [
-        'type' => 'procs',
-        'description' => 'Processes',
-    ],
-    [
-        'type' => 'sizes',
-        'description' => 'Size, Data, Text in kbytes',
-    ],
-    [
-        'type' => 'rss',
-        'description' => 'Real Memory(Resident Set Size) in kbytes',
-    ],
-    [
-        'type' => 'vsz',
-        'description' => 'Virtual Size in kbytes',
-    ],
-    [
-        'type' => 'faults',
-        'description' => 'Minor/Major Faults Per Second',
-    ],
-    [
-        'type' => 'switches',
-        'description' => 'Context Switches Per Second',
-    ],
-    [
-        'type' => 'etimes',
-        'description' => 'Elapsed Time',
-    ],
-];
-if ($app_data['has']['rwdblocks']) {
-    $graphs[] = [
-        'type' => 'blocks',
-        'description' => 'Read/Write Blocks Per Second',
-    ];
-}
-if ($app_data['has']['rwdops']) {
-    $graphs[] = [
-        'type' => 'ops_rwd',
-        'description' => 'Read/Write Ops Per Second',
-    ];
-}
-if ($app_data['has']['rwdbytes']) {
-    $graphs[] = [
-        'type' => 'ops_rwd',
-        'description' => 'Read/Write Bytes Per Second',
-    ];
-}
-if ($app_data['has']['signals-taken']) {
-    $graphs[] = [
-        'type' => 'signals_taken',
-        'description' => 'Signals Taken Per Second',
-    ];
-}
-if ($app_data['has']['recv_sent_msgs']) {
-    $graphs[] = [
-        'type' => 'recv_sent_msgs',
-        'description' => 'Signals Taken Per Second',
-    ];
-}
-if ($app_data['has']['cows']) {
-    $graphs[] = [
-        'type' => 'cows',
-        'description' => 'COWs Per Second',
-    ];
-}
-if ($app_data['has']['swaps']) {
-    $graphs[] = [
-        'type' => 'swaps',
-        'description' => 'Swaps Per Second',
-    ];
-}
-if ($app_data['has']['sock']) {
-    $graphs[] = [
-        'type' => 'sock',
-        'description' => 'Socket Buffer Size In Bytes',
-    ];
-}
-if ($app_data['has']['linux_mem_stats']) {
-    $graphs[] = [
-        'type' => 'cgroups_pg',
-        'description' => 'Linux Pg Memory Stats',
-    ];
-    $graphs[] = [
-        'type' => 'cgroups_mem_misc',
-        'description' => 'Misc Linux Memory Stats',
-    ];
-    $graphs[] = [
-        'type' => 'cgroups_zswap',
-        'description' => 'Zswap Size',
-    ];
-    $graphs[] = [
-        'type' => 'cgroups_zswap_activity',
-        'description' => 'Zswap Activity',
-    ];
-    $graphs[] = [
-        'type' => 'cgroups_workingset',
-        'description' => 'Workingset Stats',
-    ];
-}
-if ($app_data['has']['throttled_time']) {
-    $graphs[] = [
-        'type' => 'throttled_time',
-        'description' => 'CPU Throttled Time Seconds Per Second',
-    ];
-}
-if ($app_data['has']['throttled_count']) {
-    $graphs[] = [
-        'type' => 'throttled_count',
-        'description' => 'CPU Throttled Events Per Second',
-    ];
-}
-if ($app_data['has']['burst_time']) {
-    $graphs[] = [
-        'type' => 'burst_time',
-        'description' => 'CPU Burst Time Seconds Per Second',
-    ];
-}
-if ($app_data['has']['burst_count']) {
-    $graphs[] = [
-        'type' => 'burst_count',
-        'description' => 'CPU Burst Events Per Second',
-    ];
-}
-foreach ($graphs as $key => $graph_info) {
-    $graph_type = $graph_info['type'];
-    $graph_array['height'] = '100';
-    $graph_array['width'] = '215';
-    $graph_array['to'] = time();
-    $graph_array['id'] = $app['app_id'];
-    $graph_array['type'] = 'application_' . $name . '_' . $graph_info['type'];
-    if (isset($vars['oslvm'])) {
-        $graph_array['oslvm'] = $vars['oslvm'];
-    }
-    echo '<div class="panel panel-default">
-    <div class="panel-heading">
-        <h3 class="panel-title">' . $graph_info['description'] . '</h3>
-    </div>
-    <div class="panel-body">
-    <div class="row">';
-    include 'includes/html/print-graphrow.inc.php';
-    echo '</div>';
-    echo '</div>';
-    echo '</div>';
-}

--- a/includes/html/pages/device/apps/postgres.inc.php
+++ b/includes/html/pages/device/apps/postgres.inc.php
@@ -1,27 +1,23 @@
 <?php
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'postgres',
 ];
-if (isset($vars['database'])) {
-    $vars['database'] = htmlspecialchars($vars['database']);
-}
 print_optionbar_start();
 echo generate_link('Total', $link_array);
 echo '| DBs:';
 $databases = $app->data['databases'] ?? [];
 sort($databases);
 foreach ($databases as $index => $db) {
-    $db = htmlspecialchars($db);
     $label = $vars['database'] == $db
         ? '<span class="pagemenu-selected">' . $db . '</span>'
         : $db;
     echo generate_link($label, $link_array, ['database' => $db]);
     if ($index < (count($databases) - 1)) {
         echo ', ';
     }
 }
 print_optionbar_end();
 $graphs = [

--- a/includes/html/pages/device/apps/poudriere.inc.php
+++ b/includes/html/pages/device/apps/poudriere.inc.php
@@ -1,36 +1,32 @@
 <?php
 $name = 'poudriere';
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'poudriere',
 ];
-if (isset($vars['poudriere_set'])) {
-    $vars['poudriere_set'] = htmlspecialchars($vars['poudriere_set']);
-}
 $app_data = $app->data;
 print_optionbar_start();
 $label = (isset($vars['poudriere_page']) || isset($vars['poudriere_set']))
     ? 'Totals'
     : '<span class="pagemenu-selected">Totals</span>';
 echo generate_link($label, $link_array);
 echo ' | ';
 $label = (! isset($vars['poudriere_page']) && $vars['poudriere_page'] != 'details')
     ? 'Details'
     : '<span class="pagemenu-selected">Details</span>';
 echo generate_link($label, $link_array, ['poudriere_page' => 'details']);
 echo ' | Sets: ';
 $index_int = 0;
 foreach ($app_data['sets'] as $index => $set_name) {
-    $set_name = htmlspecialchars($set_name);
     $label = (! isset($vars['poudriere_set']) || $vars['poudriere_set'] != $set_name)
         ? $set_name
         : '<span class="pagemenu-selected">' . $set_name . '</span>';
     $index_int++;
     echo generate_link($label, $link_array, ['poudriere_set' => $set_name]);
     if (isset($app_data['sets'][$index_int])) {
         echo ', ';
     }
 }
 print_optionbar_end();

--- a/includes/html/pages/device/apps/sneck.inc.php
+++ b/includes/html/pages/device/apps/sneck.inc.php
@@ -31,15 +31,15 @@
     include 'includes/html/print-graphrow.inc.php';
     echo '</div>';
     echo '</div>';
     echo '</div>';
 }
 $sneck_data = $app->app_id;
 if (isset($sneck_data)) {
     print_optionbar_start();
     echo 'Last Return...<br>';
     echo "<b>Alert(s):</b><br>\n";
-    echo str_replace("\n", "<br>\n", htmlspecialchars($app->data['data']['alertString'])) . "<br><br>\n";
+    echo str_replace("\n", "<br>\n", $app->data['data']['alertString']) . "<br><br>\n";
     echo "<b>Raw JSON:</b><br>\n";
-    echo "<pre>\n" . htmlspecialchars(json_encode($app->data, JSON_PRETTY_PRINT)) . "</pre>\n";
+    echo "<pre>\n" . json_encode($app->data, JSON_PRETTY_PRINT) . "</pre>\n";
     print_optionbar_end();
 }

--- a/includes/html/pages/device/apps/suricata.inc.php
+++ b/includes/html/pages/device/apps/suricata.inc.php
@@ -1,39 +1,35 @@
 <?php
 $name = 'suricata';
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'suricata',
 ];
-if (isset($vars['sinstance'])) {
-    $vars['sinstance'] = htmlspecialchars($vars['sinstance']);
-}
 $app_data = $app->data;
 print_optionbar_start();
 if (! isset($vars['suricata_graph_set'])) {
     $vars['suricata_graph_set'] = 'general';
 }
 $total_label = isset($vars['sinstance'])
     ? 'Totals'
     : '<span class="pagemenu-selected">Totals</span>';
 if (isset($vars['suricata_graph_set'])) {
     echo generate_link($total_label, $link_array, ['suricata_graph_set' => $vars['suricata_graph_set']]);
 } else {
     echo generate_link($total_label, $link_array);
 }
 echo ' | Instances: ';
 $suricata_instances = $app->data['instances'] ?? [];
 sort($suricata_instances);
 foreach ($suricata_instances as $index => $sinstance) {
-    $sinstance = htmlspecialchars($sinstance);
     $label = $vars['sinstance'] == $sinstance
         ? '<span class="pagemenu-selected">' . $sinstance . '</span>'
         : $sinstance;
     echo generate_link($label, $link_array, ['sinstance' => $sinstance, 'suricata_graph_set' => $vars['suricata_graph_set']]);
     if ($index < (count($suricata_instances) - 1)) {
         echo ', ';
     }
 }
 if ($app_data['version'] == 2) {
     echo "<br>\nPages: ";

--- a/includes/html/pages/device/apps/wireguard.inc.php
+++ b/includes/html/pages/device/apps/wireguard.inc.php
@@ -2,47 +2,40 @@
 use App\Models\Device;
 use App\Models\Ipv4Address;
 use App\Models\Ipv6Address;
 use App\Models\Port;
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'wireguard',
 ];
-if (isset($vars['interface'])) {
-    $vars['interface'] = htmlspecialchars($vars['interface']);
-}
-if (isset($vars['client'])) {
-    $vars['client'] = htmlspecialchars($vars['client']);
-}
 $interface_client_map = $app->data['mappings'] ?? [];
 $returned_data = $app->data['data'] ?? [];
 ksort($interface_client_map);
 print_optionbar_start();
 $label =
     (! isset($vars['wg_page']) && ! isset($vars['interface']))
             ? '<span class="pagemenu-selected">All Interfaces</span>'
             : 'All Interfaces';
 echo generate_link($label, $link_array);
 if (count($returned_data) > 0) {
     echo ' | ';
     $label =
         $vars['wg_page'] == 'details'
         ? '<span class="pagemenu-selected">Details</span>'
         : 'Details';
     echo generate_link($label, $link_array, ['wg_page' => 'details']);
 }
 echo ' | Interfaces: ';
 $i = 0;
 foreach ($interface_client_map as $interface => $client_list) {
-    $interface = htmlspecialchars($interface);
     $label =
         ($vars['interface'] == $interface && ! isset($vars['wg_page']))
             ? '<span class="pagemenu-selected">' . $interface . '</span>'
             : $interface;
     echo generate_link($label, $link_array, ['interface' => $interface]);
     echo '(';
     $label =
         ($vars['interface'] == $interface && $vars['wg_page'] == 'peer_bw')
             ? '<span class="pagemenu-selected">' . 'BW' . '</span>'
             : 'BW';
@@ -57,21 +50,20 @@
     if ($i < count(array_keys($interface_client_map)) - 1) {
         echo ', ';
     }
     $i++;
 }
 if (isset($vars['interface']) && isset($interface_client_map[$vars['interface']])) {
     asort($interface_client_map[$vars['interface']]);
     $i = 0;
     echo '<br>Peers: ';
     foreach ($interface_client_map[$vars['interface']] as $peer_key => $peer) {
-        $peer = htmlspecialchars($peer);
         $label =
             $vars['client'] == $peer
             ? '<span class="pagemenu-selected">' . $peer . '</span>'
             : $peer;
         echo generate_link($label, $link_array, ['interface' => $interface, 'client' => $peer]);
         if ($i < count(array_keys($interface_client_map[$vars['interface']])) - 1) {
             echo ', ';
         }
         $i++;
     }

--- a/includes/html/pages/device/apps/zfs.inc.php
+++ b/includes/html/pages/device/apps/zfs.inc.php
@@ -1,65 +1,39 @@
 <?php
 $link_array = [
     'page' => 'device',
     'device' => $device['device_id'],
     'tab' => 'apps',
     'app' => 'zfs',
 ];
-if (isset($vars['pool'])) {
-    $vars['pool'] = htmlspecialchars($vars['pool']);
-}
 print_optionbar_start();
 echo generate_link('ARC', $link_array);
 echo ' | ' . generate_link('L2', $link_array, ['zfs_page' => 'l2']);
 echo ' | Pools: ';
 $pools = $app->data['pools'] ?? [];
-$status_info = $app->data['status_info'] ?? [];
-$version = $app->data['version'] ?? 2;
 sort($pools);
 foreach ($pools as $index => $pool) {
-    $pool = htmlspecialchars($pool);
     $label = $vars['pool'] == $pool
         ? '<span class="pagemenu-selected">' . $pool . '</span>'
         : $pool;
     echo generate_link($label, $link_array, ['pool' => $pool]);
     if ($index < (count($pools) - 1)) {
         echo ', ';
     }
 }
-if (isset($vars['pool']) && isset($status_info[$vars['pool']])) {
-    echo '<hr><tt>' . str_replace(' ', '&nbsp;', str_replace("\n", '<br>', htmlspecialchars($status_info[$vars['pool']]))) . "</tt>\n";
-}
 print_optionbar_end();
 if (isset($vars['pool'])) {
     $graphs = [
         'zfs_pool_space' => 'Pool Space',
         'zfs_pool_cap' => 'Pool Capacity',
         'zfs_pool_frag' => 'Pool Fragmentation',
     ];
-    if ($version >= 2) {
-        $graphs['zfs_pool_errors'] = 'Pool Errors';
-        $graphs['zfs_pool_operations'] = 'Pool Operations';
-        $graphs['zfs_pool_bandwidth'] = 'Pool Bandwidth';
-        $graphs['zfs_pool_total_wait'] = 'Pool Total Wait';
-        $graphs['zfs_pool_disk_wait'] = 'Pool Disk Wait';
-        $graphs['zfs_pool_syncq_wait'] = 'Pool SyncQ Wait';
-        $graphs['zfs_pool_asyncq_wait'] = 'Pool AsyncQ Wait';
-        $graphs['zfs_pool_scrub_wait'] = 'Pool Scrub Wait';
-        $graphs['zfs_pool_trim_wait'] = 'Pool Trim Wait';
-        $graphs['zfs_pool_syncq_read'] = 'Pool SyncQ Read';
-        $graphs['zfs_pool_syncq_write'] = 'Pool SyncQ Write';
-        $graphs['zfs_pool_asyncq_read'] = 'Pool AsyncQ Read';
-        $graphs['zfs_pool_asyncq_write'] = 'Pool AsyncQ Write';
-        $graphs['zfs_pool_scrubq_read'] = 'Pool ScrubQ Read';
-        $graphs['zfs_pool_trimq_write'] = 'Pool TrimQ Write';
-    }
 } elseif (isset($vars['zfs_page']) && $vars['zfs_page'] == 'l2') {
     $graphs = [
         'zfs_l2_size' => 'L2 size in bytes',
         'zfs_l2_rw_bytes' => 'L2 Read And Writes Bytes Per Second',
         'zfs_l2_d_to_m_ratio' => 'L2 Data To Meta Ratio',
         'zfs_l2_access_total' => 'L2 Total Hits And Misses Per Second',
         'zfs_l2_errors' => 'L2 Errors Per Second',
         'zfs_l2_errors' => 'L2 Error Types Per Second',
         'zfs_l2_sizes' => 'L2 Sizes',
         'zfs_l2_asize' => 'L2 Asize',
@@ -84,21 +58,21 @@
         'zfs_arc_cache_hits_by_type' => 'ARC cache hits by type',
         'zfs_arc_cache_misses_by_type' => 'ARC cache misses by type',
         'zfs_arc_cache_hits' => 'ARC cache hits',
         'zfs_arc_cache_miss' => 'ARC cache misses',
     ];
 }
 foreach ($graphs as $key => $text) {
     $graph_type = $key;
     $graph_array['height'] = '100';
     $graph_array['width'] = '215';
-    $graph_array['to'] = LibreNMS\Config::get('time.now');
+    $graph_array['to'] = \LibreNMS\Config::get('time.now');
     $graph_array['id'] = $app['app_id'];
     $graph_array['type'] = 'application_' . $key;
     if (isset($vars['pool'])) {
         $graph_array['pool'] = $vars['pool'];
     }
     echo '<div class="panel panel-default">
     <div class="panel-heading">
         <h3 class="panel-title">' . $text . '</h3>
     </div>
     <div class="panel-body">

--- a/includes/html/pages/device/capture.inc.php
+++ b/includes/html/pages/device/capture.inc.php
@@ -31,24 +31,24 @@
     <h2>Capture Debug Information</h2>
     <ul class="nav nav-tabs">
         <li role="presentation" class="active"><a data-toggle="tab" href="#discovery">Discovery</a></li>
         <li role="presentation"><a data-toggle="tab" href="#poller">Poller</a></li>
         <li role="presentation"><a data-toggle="tab" href="#snmp">SNMP</a></li>
         <li role="presentation"><a data-toggle="tab" href="#alerts">Alerts</a></li>
     </ul>
     <div class="tab-content">
     <?php
     $tabs = [
-        'discovery' => 'ajax_output.php?id=capture&format=text&type=discovery&hostname=' . htmlentities($device['hostname']),
-        'poller'    => 'ajax_output.php?id=capture&format=text&type=poller&hostname=' . htmlentities($device['hostname']),
-        'snmp'      => 'ajax_output.php?id=capture&format=text&type=snmpwalk&hostname=' . htmlentities($device['hostname']),
-        'alerts'    => 'ajax_output.php?id=query&format=text&type=alerts&hostname=' . htmlentities($device['hostname']),
+        'discovery' => 'ajax_output.php?id=capture&format=text&type=discovery&hostname=' . $device['hostname'],
+        'poller'    => 'ajax_output.php?id=capture&format=text&type=poller&hostname=' . $device['hostname'],
+        'snmp'      => 'ajax_output.php?id=capture&format=text&type=snmpwalk&hostname=' . $device['hostname'],
+        'alerts'    => 'ajax_output.php?id=query&format=text&type=alerts&hostname=' . $device['hostname'],
     ];
     foreach ($tabs as $tab => $url) {
         ?>
         <div id="<?php echo $tab ?>" class="tab-pane fade <?php echo $tab == 'discovery' ? ' in active' : '' ?>">
         <div class="row"><div class="col-md-12">
         <div class="btn-toolbar" role="toolbar" style="margin:5px 0 5px 0">
         <button type="button" class="btn btn-success" id="run-<?php echo $tab ?>"><i class="fa fa-play fa-lg"></i> Run</button>
         <button type="button" class="btn btn-primary" id="copy-<?php echo $tab ?>"><i class="fa fa-clipboard fa-lg"></i> Copy</button>
         <a class="btn btn-warning" href="<?php echo str_replace('text', 'download', $url) ?>"><i class="fa fa-download fa-lg"></i> Download</a>
         </div></div></div>

--- a//dev/null
+++ b/includes/html/pages/device/neighbours.inc.php
@@ -0,0 +1,31 @@
+<?php
+unset($datas);
+$datas[] = 'list';
+$datas[] = 'map';
+$page_text['list'] = 'List';
+$page_text['map'] = 'Map';
+$link_array = [
+    'page' => 'device',
+    'device' => $device['device_id'],
+    'tab' => 'neighbours',
+];
+print_optionbar_start();
+echo "<span style='font-weight: bold;'>Neighbours</span> &#187; ";
+$selection = basename($vars['selection'] ?? 'list');
+$sep = '';
+foreach ($datas as $type) {
+    echo $sep;
+    if ($selection == $type) {
+        echo '<span class="pagemenu-selected">';
+    }
+    echo generate_link($page_text[$type], $link_array, [
+        'selection' => $type,
+    ]);
+    if ($selection == $type) {
+        echo '</span>';
+    }
+    $sep = ' | ';
+}
+print_optionbar_end();
+include "includes/html/pages/device/neighbours/$selection.inc.php";
+$pagetitle[] = 'Neighbours';

--- a//dev/null
+++ b/includes/html/pages/device/neighbours/list.inc.php
@@ -0,0 +1,7 @@
+<?php
+DeviceCache::get($device['device_id'])->load(['links.port', 'links.remoteDevice', 'links.remotePort']);
+echo view('device.tabs.ports.links', [
+    'data' => [
+        'links' => DeviceCache::get($device['device_id'])->links,
+    ],
+]);

--- a//dev/null
+++ b/includes/html/pages/device/neighbours/map.inc.php
@@ -0,0 +1,22 @@
+<?php
+/*
+ * LibreNMS
+ *
+ * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
+ *
+ * This program is free software: you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License as published by the
+ * Free Software Foundation, either version 3 of the License, or (at your
+ * option) any later version.  Please see LICENSE.txt at the top level of
+ * the source code distribution for details.
+ */
+$pagetitle[] = 'Map';
+if (\LibreNMS\Config::get('gui.network-map.style') == 'old') {
+    echo '
+<center style="height:100%">
+    <object data="network-map.php?device=' . $device['device_id'] . '&format=svg" type="image/svg+xml" style="width: 100%; height:100%"></object>
+</center>
+    ';
+} else {
+    require_once 'includes/html/print-map.inc.php';
+}

--- a/includes/html/pages/device/overview/services.inc.php
+++ b/includes/html/pages/device/overview/services.inc.php
@@ -1,23 +1,23 @@
 <?php
 use LibreNMS\Util\ObjectCache;
 if (ObjectCache::serviceCounts(['total'], $device['device_id'])['total'] > 0) {
     $colors = new \Illuminate\Support\Collection(['green', 'yellow', 'red']);
     $output = \App\Models\Service::query()
         ->where('device_id', $device['device_id'])
         ->orderBy('service_type')
         ->get(['service_type', 'service_status', 'service_message', 'service_name'])
         ->map(function ($service) use ($colors) {
-            $message = htmlentities(str_replace(' ', '&nbsp;', $service->service_message));
+            $message = str_replace(' ', '&nbsp;', $service->service_message);
             $color = $colors->get($service->service_status, 'grey');
-            $type = htmlentities(strtolower($service->service_type));
-            $name = htmlentities($service->service_name);
+            $type = strtolower($service->service_type);
+            $name = $service->service_name;
             $name_type = ($name == '' || $name == $type) ? $type : $name . ' (' . $type . ')';
             return "<span title='$message' class='$color'>$name_type</span>";
         })->implode(', ');
     $services = ObjectCache::serviceCounts(['total', 'ok', 'warning', 'critical'], $device['device_id']); ?>
         <div class="row">
             <div class="col-md-12">
                 <div class="panel panel-default panel-condensed">
                     <div class="panel-heading">
                     <?php echo '<a href="device/device=' . $device['device_id'] . '/tab=services">'?><i class="fa fa-cogs fa-lg icon-theme" aria-hidden="true"></i> <strong>Services</strong><?php echo '</a>'?>
                     </div>

--- a/includes/html/pages/device/services.inc.php
+++ b/includes/html/pages/device/services.inc.php
@@ -48,34 +48,34 @@
 unset($sep);
 if (Auth::user()->hasGlobalAdmin()) {
     echo '<div class="pull-right"><a data-toggle="modal" href="#create-service"><i class="fa fa-cog" style="color:green" aria-hidden="true"></i> Add Service</a></div>';
 }
 echo '</div><div>';
 if (count($services) > '0') {
     echo '<table class="table table-hover table-condensed">';
     foreach ($services as $service) {
         $service['service_ds'] = htmlspecialchars_decode($service['service_ds']);
         if ($service['service_status'] == '2') {
-            $status = '<span class="alert-status label-danger"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
+            $status = '<span class="alert-status label-danger"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
         } elseif ($service['service_status'] == '1') {
-            $status = '<span class="alert-status label-warning"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
+            $status = '<span class="alert-status label-warning"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
         } elseif ($service['service_status'] == '0') {
-            $status = '<span class="alert-status label-success"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
+            $status = '<span class="alert-status label-success"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
         } else {
-            $status = '<span class="alert-status label-info"><span class="device-services-page">' . htmlentities($service['service_type']) . '</span></span>';
+            $status = '<span class="alert-status label-info"><span class="device-services-page">' . $service['service_type'] . '</span></span>';
         }
         echo '<tr id="row_' . $service['service_id'] . '">';
         echo '<td class="col-sm-12">';
         echo '<div class="col-sm-1">' . $status . '</div>';
         echo '<div class="col-sm-2 text-muted">' . \LibreNMS\Util\Time::formatInterval(time() - $service['service_changed']) . '</div>';
-        echo '<div class="col-sm-2 text-muted">' . htmlentities($service['service_desc']) . '</div>';
-        echo '<div class="col-sm-5">' . nl2br(htmlentities(trim($service['service_message']))) . '</div>';
+        echo '<div class="col-sm-2 text-muted">' . $service['service_desc'] . '</div>';
+        echo '<div class="col-sm-5">' . nl2br(trim($service['service_message'])) . '</div>';
         echo '<div class="col-sm-2">';
         echo '<div class="pull-right">';
         if (Auth::user()->hasGlobalAdmin()) {
             echo "<button type='button' class='btn btn-primary btn-sm' aria-label='Edit' data-toggle='modal' data-target='#create-service' data-service_id='{$service['service_id']}' name='edit-service'><i class='fa fa-pencil' aria-hidden='true'></i></button>
         <button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#confirm-delete' data-service_id='{$service['service_id']}' name='delete-service'><i class='fa fa-trash' aria-hidden='true'></i></button";
         }
         echo '</div>';
         echo '</div>';
         if ($vars['view'] == 'details') {
             $check_ds = null;

--- a/includes/html/pages/edituser.inc.php
+++ b/includes/html/pages/edituser.inc.php
@@ -53,21 +53,21 @@
            <div class="col-md-4">';
         echo '<h3>Device Access</h3>';
         echo "<div class='panel panel-default panel-condensed'>
             <table class='table table-hover table-condensed table-striped'>
               <tr>
                 <th>Device</th>
                 <th>Action</th>
               </tr>";
         $device_perms = dbFetchRows('SELECT * from devices_perms as P, devices as D WHERE `user_id` = ? AND D.device_id = P.device_id', [$user_data['user_id']]);
         foreach ($device_perms as $device_perm) {
-            echo '<tr><td><strong>' . htmlentities(format_hostname($device_perm)) . "</td><td> <a href='edituser/action=deldevperm/user_id=" . $vars['user_id'] . '/device_id=' . $device_perm['device_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a></strong></td></tr>";
+            echo '<tr><td><strong>' . format_hostname($device_perm) . "</td><td> <a href='edituser/action=deldevperm/user_id=" . $vars['user_id'] . '/device_id=' . $device_perm['device_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a></strong></td></tr>";
             $access_list[] = $device_perm['device_id'];
             $permdone = 'yes';
         }
         echo '</table>
           </div>';
         if (! $permdone) {
             echo 'None Configured';
         }
         echo '<h4>Grant access to new device</h4>';
         echo "<form class='form-inline' role='form' method='post' action=''>
@@ -207,21 +207,21 @@
         $bill_perms = dbFetchRows('SELECT * from bills AS B, bill_perms AS P WHERE P.user_id = ? AND P.bill_id = B.bill_id', [$user_data['user_id']]);
         echo "<div class='panel panel-default panel-condensed'>
             <table class='table table-hover table-condensed table-striped'>
             <tr>
               <th>Bill name</th>
               <th>Action</th>
             </tr>";
         foreach ($bill_perms as $bill_perm) {
             echo '<tr>
               <td>
-                <strong>' . htmlentities($bill_perm['bill_name']) . "</strong></td><td width=50>&nbsp;&nbsp;<a href='edituser/action=delbillperm/user_id=" . $vars['user_id'] . '/bill_id=' . $bill_perm['bill_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a>
+                <strong>' . $bill_perm['bill_name'] . "</strong></td><td width=50>&nbsp;&nbsp;<a href='edituser/action=delbillperm/user_id=" . $vars['user_id'] . '/bill_id=' . $bill_perm['bill_id'] . "'><i class='fa fa-trash fa-lg icon-theme' aria-hidden='true'></i></a>
               </td>
             </tr>";
             $bill_access_list[] = $bill_perm['bill_id'];
             $bpermdone = 'yes';
         }
         echo '</table>
           </div>';
         if (! $bpermdone) {
             echo 'None Configured';
         }
@@ -236,21 +236,21 @@
               <select name='bill_id' class='form-control' id='bill_id'>";
         $bills = dbFetchRows('SELECT * FROM `bills` ORDER BY `bill_name`');
         foreach ($bills as $bill) {
             unset($done);
             foreach ($bill_access_list as $ac) {
                 if ($ac == $bill['bill_id']) {
                     $done = 1;
                 }
             }
             if (! $done) {
-                echo "<option value='" . $bill['bill_id'] . "'>" . htmlentities($bill['bill_name']) . '</option>';
+                echo "<option value='" . $bill['bill_id'] . "'>" . $bill['bill_name'] . '</option>';
             }
         }
         echo "</select>
           </div>
           <button type='submit' class='btn btn-default' name='Submit' value='Add'>Add</button>
         </form>
         </div>";
     } else {
         echo '<script>window.location.replace("' . url('users') . '");</script>';
     }//end if

--- a//dev/null
+++ b/includes/html/pages/fullscreenmap.inc.php
@@ -0,0 +1,91 @@
+<?php
+/* Copyright (C) 2014 Daniel Preussker <f0o@devilcode.org>
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation, either version 3 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+/**
+ * Custom Frontpage
+ *
+ * @author f0o <f0o@devilcode.org>
+ * @copyright 2014 f0o, LibreNMS
+ * @license GPL
+ */
+/**
+ * Fullscreen variant
+ * I have mostly axed a lot of stuff and added a tiny bit of CSS
+ * To make use of this, your config.php needs to contain
+ * something like this:
+ * $config['front_page'] = "includes/html/pages/front/fullscreenmap.php";
+ * $config['map']['engine'] = 'leaflet';
+ * $config['leaflet']['default_zoom'] = 5;
+ * $config['leaflet']['default_lat'] = 65.3258792;
+ * $config['leaflet']['default_lng'] = 14.1115485;
+ * Dag B <dag@bakke.com>
+ */
+$pagetitle[] = 'Geographical Map';
+if (\LibreNMS\Config::get('map.engine') == 'leaflet') {
+    require_once 'includes/html/common/worldmap.inc.php';
+    echo implode('', $common_output);
+}
+/* Yes, this code requires the leaflet map engine  */
+?>
+<link href="css/fullscreenmap.css" rel="stylesheet" type="text/css" />
+<script type="text/javascript">
+     var isFullscreen = false;
+     window.addEventListener('resize', function () {
+         if (window.innerHeight > (screen.height - 10)) {
+             isFullscreen = true;
+             setStyle();
+         } else {
+             isFullscreen = false;
+             setStyle();
+         };
+    }, false);
+    function setStyle() {
+        if(isFullscreen) {
+            document.getElementsByClassName('navbar-fixed-top')[0].style.display = "none";
+            document.getElementsByTagName('body')[0].style.paddingTop = 0;
+        } else {
+            document.getElementsByClassName('navbar-fixed-top')[0].style.removeProperty("display");
+            document.getElementsByTagName('body')[0].style.paddingTop = "50px";
+        };
+    };
+    window.dispatchEvent(new Event('resize'));
+</script>
+<script src='js/jquery.mousewheel.min.js'></script>
+<?php
+$x = 0;
+foreach (dbFetchRows("SELECT `hostname`,`location`,`status`, COUNT(`status`) AS `total`,`lat`,`lng` FROM `devices` LEFT JOIN `locations` ON `devices`.`location_id`=`locations`.`id` WHERE `disabled`=0 AND `ignore`=0 AND `lat` != '' AND `lng` != '' GROUP BY `status`,`lat`,`lng` ORDER BY `status` ASC, `hostname`") as $map_devices) {
+    $color = '#29FF3B';
+    $size = 15;
+    $status = 'Up';
+    if ($map_devices['status'] == 0) {
+        $color = '#FF0000';
+        $size = 30;
+        $status = 'Down';
+    }
+    $data .= "\"$x\": {
+                        value: \"" . $map_devices['total'] . '",
+                        latitude: ' . $map_devices['lat'] . ',
+                        longitude: ' . $map_devices['lng'] . ',
+                        size: ' . $size . ',
+                        attrs: {
+                            fill: "' . $color . '",
+                            opacity: 0.8
+                        },
+                        tooltip: {
+                            content: "Devices ' . $status . ': ' . $map_devices['total'] . "\"
+                        }
+                    },\n";
+    $x++;
+}
+?>

--- a/includes/html/pages/health.inc.php
+++ b/includes/html/pages/health.inc.php
@@ -52,21 +52,21 @@
     'cooling' => 'Cooling',
     'toner' => 'Toner',
     'delay' => 'Delay',
     'quality_factor' => 'Quality factor',
     'chromatic_dispersion' => 'Chromatic Dispersion',
     'ber' => 'Bit Error Rate',
     'eer' => 'Energy Efficiency Ratio',
     'waterflow' => 'Water Flow Rate',
     'percent' => 'Percent',
 ];
-$active_metric = basename(array_key_exists($vars['metric'], $type_text) ? $vars['metric'] : 'processor');
+$active_metric = basename($vars['metric'] ?? 'processor');
 $vars['view'] = $vars['view'] ?? 'detail';
 $link_array = ['page' => 'health'];
 $navbar = '<span style="font-weight: bold;">Health</span> &#187; ';
 $sep = '';
 foreach ($datas as $texttype) {
     $metric = strtolower($texttype);
     $navbar .= $sep;
     if ($active_metric == $metric) {
         $navbar .= '<span class="pagemenu-selected">';
     }

--- a//dev/null
+++ b/includes/html/pages/map.inc.php
@@ -0,0 +1,18 @@
+<?php
+/*
+ * LibreNMS
+ *
+ * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
+ *
+ * This program is free software: you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License as published by the
+ * Free Software Foundation, either version 3 of the License, or (at your
+ * option) any later version.  Please see LICENSE.txt at the top level of
+ * the source code distribution for details.
+ */
+$pagetitle[] = 'Map';
+if (\LibreNMS\Config::get('gui.network-map.style') == 'old') {
+    print_error('You are using the old style network map, a global map is not available');
+} else {
+    require_once 'includes/html/print-map.inc.php';
+}

--- a/includes/html/pages/wireless.inc.php
+++ b/includes/html/pages/wireless.inc.php
@@ -19,21 +19,21 @@
  *
  * @link       https://www.librenms.org
  *
  * @copyright  2017 Tony Murray
  * @author     Tony Murray <murraytony@gmail.com>
  */
 $pagetitle[] = 'Wireless';
 use LibreNMS\Device\WirelessSensor;
 $sensors = dbFetchColumn('SELECT `sensor_class` FROM `wireless_sensors` GROUP BY `sensor_class`');
 $valid_wireless_types = array_intersect_key(WirelessSensor::getTypes(), array_flip($sensors));
-$class = basename(array_key_exists($vars['metric'], $valid_wireless_types) ? $vars['metric'] : key($valid_wireless_types));
+$class = basename($vars['metric'] ?? key($valid_wireless_types));
 $vars['view'] = basename($vars['view'] ?? 'nographs');
 $link_array = ['page' => 'wireless'];
 $linkoptions = '<span style="font-weight: bold;">Wireless</span> &#187; ';
 $sep = '';
 foreach ($valid_wireless_types as $type => $details) {
     $linkoptions .= $sep;
     if ($class == $type) {
         $linkoptions .= '<span class="pagemenu-selected">';
     }
     $linkoptions .= generate_link(__("wireless.$type.short"), $link_array, ['metric' => $type, 'view' => $vars['view']]);

--- a/includes/html/print-alert-templates.php
+++ b/includes/html/print-alert-templates.php
@@ -12,21 +12,21 @@
           <tr>
             <th data-column-id="id" data-searchable="false" data-identifier="true" data-type="numeric">#</th>
             <th data-column-id="templatename">Name</th>
             <th data-column-id="alert_rules" data-searchable="false" data-formatter="alert_rules">Alert Rules</th>
             <th data-column-id="actions" data-searchable="false" data-formatter="commands">Action</th>
             <th data-column-id="old_template" data-searchable="false" data-visible="false">Old template</th>
           </tr>
       </thead>
       <tbody>
 <?php
-$full_query = AlertTemplate::with('alert_rules')->select(['id', 'name', 'template'])->get();
+$full_query = AlertTemplate::select('id', 'name', 'template')->get();
 $templates = [];
 foreach ($full_query as $template) {
     $single_template = ['name' => $template->name,
         'template' => $template->template,
     ];
     if ($template->name == 'Default Alert Template') {
         $default_tplid = $template->id;
         $single_template['id'] = 0;
         $single_template['alert_rules'] = AlertRule::whereNotIn('id', AlertTemplateMap::pluck('alert_rule_id'))
                                                      ->select('id', 'name')

--- a/includes/html/print-alert-transports.php
+++ b/includes/html/print-alert-transports.php
@@ -28,23 +28,23 @@
 foreach (\App\Models\AlertTransport::orderBy('transport_name', 'asc')->get() as $transport) {
     $instance = $transport->instance();
     echo "<tr id=\"alert-transport-{$transport->transport_id}\">";
     echo '<td>' . htmlentities($transport->transport_name) . '</td>';
     echo '<td>' . htmlentities($instance->name()) . '</td>';
     echo $transport->is_default ? '<td>Yes</td>' : '<td>No</td>';
     echo '<td class="col-sm-4"><i>' . nl2br(htmlentities($instance->displayDetails())) . '</i></td>';
     echo '<td>';
     if (Auth::user()->hasGlobalAdmin()) {
         echo "<div class='btn-group btn-group-sm' role='group'>";
-        echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-popover='popover' data-target='#edit-alert-transport' data-transport_id='" . $transport->transport_id . "' name='edit-alert-rule' data-content='Edit transport'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
-        echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#delete-alert-transport' data-transport_id='" . $transport->transport_id . "' name='delete-alert-transport' data-popover='popover' data-content='Delete transport'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
-        echo "<button type='button' class='btn btn-warning btn-sm' data-transport_id='" . $transport->transport_id . "' data-transport='{$transport->transport_type}' name='test-transport' id='test-transport' data-popover='popover' data-content='Test transport'><i class='fa fa-lg fa-check' aria-hidden='true'></i></button> ";
+        echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-target='#edit-alert-transport' data-transport_id='" . $transport->transport_id . "' name='edit-alert-rule' data-container='body' data-toggle='popover' data-content='Edit transport'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
+        echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#delete-alert-transport' data-transport_id='" . $transport->transport_id . "' name='delete-alert-transport' data-container='body' data-toggle='popover' data-content='Delete transport'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
+        echo "<button type='button' class='btn btn-warning btn-sm' data-transport_id='" . $transport->transport_id . "' data-transport='{$transport->transport_type}' name='test-transport' id='test-transport' data-toggle='popover' data-content='Test transport'><i class='fa fa-lg fa-check' aria-hidden='true'></i></button> ";
         echo '</div>';
     }
     echo '</td>';
     echo "</tr>\r\n";
 }
 ?>
     </table>
 </div>
 <br>
 <?php
@@ -69,22 +69,22 @@
     $query = 'SELECT `transport_type`, `transport_name` FROM `transport_group_transport` AS `a` LEFT JOIN `alert_transports` AS `b` ON `a`.`transport_id`=`b`.`transport_id` WHERE `transport_group_id`=? order by `transport_name`';
     $members = dbFetchRows($query, [$group['id']]);
     echo '<td>';
     foreach ($members as $member) {
         echo '<i>' . htmlentities(ucfirst($member['transport_type'])) . ': ' . htmlentities($member['transport_name']) . '<br /></i>';
     }
     echo '</td>';
     echo '<td>';
     if (Auth::user()->hasGlobalAdmin()) {
         echo "<div class='btn-group btn-group-sm' role='group'>";
-        echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-popover='popover' data-target='#edit-transport-group' data-group_id='" . $group['id'] . "' data-content='Edit transport group'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
-        echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-popover='popover' data-target='#delete-transport-group' data-group_id='" . $group['id'] . "' data-content='Delete transport group'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
+        echo "<button type='button' class='btn btn-primary btn-sm' data-toggle='modal' data-target='#edit-transport-group' data-group_id='" . $group['id'] . "' data-container='body' data-toggle='popover' data-content='Edit transport group'><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button> ";
+        echo "<button type='button' class='btn btn-danger btn-sm' aria-label='Delete' data-toggle='modal' data-target='#delete-transport-group' data-group_id='" . $group['id'] . "' data-container='body' data-toggle='popover' data-content='Delete transport group'><i class='fa fa-lg fa-trash' aria-hidden='true'></i></button>";
         echo '</div>';
     }
     echo '</td>';
     echo '</tr>';
 }
 ?>
     </table>
 </div>
 <script>
     $("button#test-transport").on("click", function() {
@@ -101,16 +101,15 @@
                     toastr.success('Test to ' + transport + ' ok');
                 } else {
                     toastr.error('Test to ' + transport + ' failed<br />' + data.message);
                 }
             },
             error: function(){
                 toastr.error('Test to ' + transport + ' failed - general error');
             }
         });
     });
-    $("[data-popover='popover']").popover({
+    $("[data-toggle='popover']").popover({
         trigger: 'hover',
-        placement: 'top',
-        container: 'body'
+        placement: 'top'
     });
 </script>

--- a/includes/html/print-customoid.php
+++ b/includes/html/print-customoid.php
@@ -63,28 +63,28 @@
 $count = dbFetchCell("SELECT COUNT(*) $query $where", $param);
 if (isset($_POST['page_num']) && $_POST['page_num'] > 0 && $_POST['page_num'] <= $count) {
     $page_num = intval($_POST['page_num']);
 } else {
     $page_num = 1;
 }
 $start = (($page_num - 1) * $rows);
 $full_query = "SELECT * $query $where ORDER BY customoid_descr ASC LIMIT $start,$rows";
 foreach (dbFetchRows($full_query, $param) as $oid) {
     echo "<tr class='" . $oid['customoid_id'] . "' id='row_" . $oid['customoid_id'] . "'>";
-    echo '<td>' . htmlentities($oid['customoid_descr']) . '</td>';
-    echo '<td>' . htmlentities($oid['customoid_oid']) . '</td>';
-    echo '<td>' . htmlentities($oid['customoid_current']) . '</td>';
-    echo '<td>' . htmlentities($oid['customoid_unit']) . '</td>';
-    echo '<td>' . htmlentities($oid['customoid_limit']) . '</td>';
-    echo '<td>' . htmlentities($oid['customoid_limit_low']) . '</td>';
-    echo '<td>' . htmlentities($oid['customoid_limit_warn']) . '</td>';
-    echo '<td>' . htmlentities($oid['customoid_limit_low_warn']) . '</td>';
+    echo '<td>' . $oid['customoid_descr'] . '</td>';
+    echo '<td>' . $oid['customoid_oid'] . '</td>';
+    echo '<td>' . $oid['customoid_current'] . '</td>';
+    echo '<td>' . $oid['customoid_unit'] . '</td>';
+    echo '<td>' . $oid['customoid_limit'] . '</td>';
+    echo '<td>' . $oid['customoid_limit_low'] . '</td>';
+    echo '<td>' . $oid['customoid_limit_warn'] . '</td>';
+    echo '<td>' . $oid['customoid_limit_low_warn'] . '</td>';
     echo "<td><input id='" . $oid['customoid_id'] . "' type='checkbox' name='alert'" . ($oid['customoid_alert'] ? ' checked' : '') . ' disabled></td>';
     echo "<td><input id='" . $oid['customoid_id'] . "' type='checkbox' name='passed'" . ($oid['customoid_passed'] ? ' checked' : '') . ' disabled></td>';
     echo '<td>';
     echo "<div class='btn-group btn-group-sm' role='group'>";
     echo "<button type='button' class='btn btn-primary' data-toggle='modal' data-target='#create-oid-form' data-customoid_id='" . $oid['customoid_id'] . "' name='edit-oid' data-content='' data-container='body'" . (Auth::user()->hasGlobalAdmin() ? '' : ' disabled') . "><i class='fa fa-lg fa-pencil' aria-hidden='true'></i></button>";
     echo "<button type='button' class='btn btn-danger' aria-label='Delete' data-toggle='modal' data-target='#delete-oid-form' data-customoid_id='" . $oid['customoid_id'] . "' name='delete-oid' data-content='' data-container='body'><i class='fa fa-lg fa-trash' aria-hidden='true'" . (Auth::user()->hasGlobalAdmin() ? '' : ' disabled') . '></i></button>';
     echo '</div>';
     echo '</td>';
     echo "</tr>\r\n";
 }//end foreach

--- a//dev/null
+++ b/includes/html/print-map.inc.php
@@ -0,0 +1,373 @@
+<?php
+/*
+ * LibreNMS
+ *
+ * Copyright (c) 2014 Neil Lathwood <https://github.com/laf/ http://www.lathwood.co.uk/fa>
+ *
+ * This program is free software: you can redistribute it and/or modify it
+ * under the terms of the GNU General Public License as published by the
+ * Free Software Foundation, either version 3 of the License, or (at your
+ * option) any later version.  Please see LICENSE.txt at the top level of
+ * the source code distribution for details.
+ */
+use LibreNMS\Config;
+use LibreNMS\Util\Number;
+$highlight_node = $vars['highlight_node'] ?? 0;
+$group = $vars['group'] ?? 0;
+$row_colour = '#ffffff';
+$sql_array = [];
+if (! empty($device['hostname'])) {
+    $sql = ' AND (`D1`.`hostname`=? OR `D2`.`hostname`=?)';
+    $sql_array = [$device['hostname'], $device['hostname']];
+    $mac_sql = ' AND `D`.`hostname` = ?';
+    $mac_array = [$device['hostname']];
+} else {
+    $sql = ' ';
+}
+if (! Auth::user()->hasGlobalRead()) {
+    $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
+    $sql .= ' AND `D1`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
+    $sql .= ' AND `D2`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
+    $sql_array = array_merge($sql_array, $device_ids, $device_ids);
+}
+$devices_by_id = [];
+$links = [];
+$link_assoc_seen = [];
+$device_assoc_seen = [];
+$ports = [];
+$devices = [];
+$group_name = '';
+$where = '';
+if (is_numeric($group) && $group) {
+    $group_name = dbFetchCell('SELECT `name` from `device_groups` WHERE `id` = ?', [$group]);
+    $where .= ' AND D1.device_id IN (SELECT `device_id` FROM `device_group_device` WHERE `device_group_id` = ?)';
+    $sql_array[] = $group;
+    $where .= ' OR D2.device_id IN (SELECT `device_id` FROM `device_group_device` WHERE `device_group_id` = ?)';
+    $sql_array[] = $group;
+}
+if (in_array('mac', Config::get('network_map_items'))) {
+    $ports = dbFetchRows("SELECT
+                             `D1`.`status` AS `local_status`,
+                             `D1`.`device_id` AS `local_device_id`,
+                             `D1`.`disabled` AS `local_disabled`,
+                             `D1`.`os` AS `local_os`,
+                             `D1`.`hostname` AS `local_hostname`,
+                             `D1`.`sysName` AS `local_sysName`,
+                             `D1`.`display` AS `local_display`,
+                             `D2`.`status` AS `remote_status`,
+                             `D2`.`device_id` AS `remote_device_id`,
+                             `D2`.`disabled` AS `remote_disabled`,
+                             `D2`.`os` AS `remote_os`,
+                             `D2`.`hostname` AS `remote_hostname`,
+                             `D2`.`sysName` AS `remote_sysName`,
+                             `D2`.`display` AS `remote_display`,
+                             `P1`.`port_id` AS `local_port_id`,
+                             `P1`.`device_id` AS `local_port_device_id`,
+                             `P1`.`ifName` AS `local_ifname`,
+                             `P1`.`ifSpeed` AS `local_ifspeed`,
+                             `P1`.`ifOperStatus` AS `local_ifoperstatus`,
+                             `P1`.`ifAdminStatus` AS `local_ifadminstatus`,
+                             `P1`.`ifInOctets_rate` AS `local_ifinoctets_rate`,
+                             `P1`.`ifOutOctets_rate` AS `local_ifoutoctets_rate`,
+                             `P2`.`port_id` AS `remote_port_id`,
+                             `P2`.`device_id` AS `remote_port_device_id`,
+                             `P2`.`ifName` AS `remote_ifname`,
+                             `P2`.`ifSpeed` AS `remote_ifspeed`,
+                             `P2`.`ifOperStatus` AS `remote_ifoperstatus`,
+                             `P2`.`ifAdminStatus` AS `remote_ifadminstatus`,
+                             `P2`.`ifInOctets_rate` AS `remote_ifinoctets_rate`,
+                             `P2`.`ifOutOctets_rate` AS `remote_ifoutoctets_rate`,
+                             SUM(IF(`P2_ip`.`ipv4_address` = `M`.`ipv4_address`, 1, 0))
+                                 AS `remote_matching_ips`
+                      FROM `ipv4_mac` AS `M`
+                             INNER JOIN `ports` AS `P1` ON `P1`.`port_id`=`M`.`port_id`
+                             INNER JOIN `ports` AS `P2` ON `P2`.`ifPhysAddress`=`M`.`mac_address`
+                             INNER JOIN `devices` AS `D1` ON `P1`.`device_id`=`D1`.`device_id`
+                             INNER JOIN `devices` AS `D2` ON `P2`.`device_id`=`D2`.`device_id`
+                             INNER JOIN `ipv4_addresses` AS `P2_ip` ON `P2_ip`.`port_id` = `P2`.`port_id`
+                             $join_sql
+                      WHERE
+                             `M`.`mac_address` NOT IN ('000000000000','ffffffffffff') AND
+                             `D1`.`device_id` != `D2`.`device_id`
+                             $where
+                             $sql
+                      GROUP BY `P1`.`port_id`,`P2`.`port_id`,`D1`.`device_id`, `D1`.`os`, `D1`.`hostname`, `D2`.`device_id`, `D2`.`os`, `D2`.`hostname`, `P1`.`port_id`, `P1`.`device_id`, `P1`.`ifName`, `P1`.`ifSpeed`, `P1`.`ifOperStatus`, `P1`.`ifAdminStatus`, `P1`.`ifInOctets_rate`, `P1`.`ifOutOctets_rate`, `P2`.`port_id`, `P2`.`device_id`, `P2`.`ifName`, `P2`.`ifSpeed`, `P2`.`ifOperStatus`, `P2`.`ifAdminStatus`, `P2`.`ifInOctets_rate`, `P2`.`ifOutOctets_rate`
+                      ORDER BY `remote_matching_ips` DESC, `local_ifname`, `remote_ifname`
+                     ", $sql_array);
+}
+if (in_array('xdp', Config::get('network_map_items'))) {
+    $devices = dbFetchRows("SELECT
+                             `D1`.`status` AS `local_status`,
+                             `D1`.`device_id` AS `local_device_id`,
+                             `D1`.`os` AS `local_os`,
+                             `D1`.`disabled` AS `local_disabled`,
+                             `D1`.`hostname` AS `local_hostname`,
+                             `D1`.`sysName` AS `local_sysName`,
+                             `D1`.`display` AS `local_display`,
+                             `D2`.`status` AS `remote_status`,
+                             `D2`.`device_id` AS `remote_device_id`,
+                             `D2`.`disabled` AS `remote_disabled`,
+                             `D2`.`os` AS `remote_os`,
+                             `D2`.`hostname` AS `remote_hostname`,
+                             `D2`.`sysName` AS `remote_sysName`,
+                             `D2`.`display` AS `remote_display`,
+                             `P1`.`port_id` AS `local_port_id`,
+                             `P1`.`device_id` AS `local_port_device_id`,
+                             `P1`.`ifName` AS `local_ifname`,
+                             `P1`.`ifSpeed` AS `local_ifspeed`,
+                             `P1`.`ifOperStatus` AS `local_ifoperstatus`,
+                             `P1`.`ifAdminStatus` AS `local_ifadminstatus`,
+                             `P1`.`ifInOctets_rate` AS `local_ifinoctets_rate`,
+                             `P1`.`ifOutOctets_rate` AS `local_ifoutoctets_rate`,
+                             `P2`.`port_id` AS `remote_port_id`,
+                             `P2`.`device_id` AS `remote_port_device_id`,
+                             `P2`.`ifName` AS `remote_ifname`,
+                             `P2`.`ifSpeed` AS `remote_ifspeed`,
+                             `P2`.`ifOperStatus` AS `remote_ifoperstatus`,
+                             `P2`.`ifAdminStatus` AS `remote_ifadminstatus`,
+                             `P2`.`ifInOctets_rate` AS `remote_ifinoctets_rate`,
+                             `P2`.`ifOutOctets_rate` AS `remote_ifoutoctets_rate`
+                      FROM `links`
+                             INNER JOIN `devices` AS `D1` ON `D1`.`device_id`=`links`.`local_device_id`
+                             INNER JOIN `devices` AS `D2` ON `D2`.`device_id`=`links`.`remote_device_id`
+                             INNER JOIN `ports` AS `P1` ON `P1`.`port_id`=`links`.`local_port_id`
+                             INNER JOIN `ports` AS `P2` ON `P2`.`port_id`=`links`.`remote_port_id`
+                             $join_sql
+                      WHERE
+                             `active`=1 AND
+                             `local_device_id` != 0 AND
+                             `remote_device_id` != 0
+                             $where
+                             $sql
+                      GROUP BY `P1`.`port_id`,`P2`.`port_id`,`D1`.`device_id`, `D1`.`os`, `D1`.`hostname`, `D2`.`device_id`, `D2`.`os`, `D2`.`hostname`, `P1`.`port_id`, `P1`.`device_id`, `P1`.`ifName`, `P1`.`ifSpeed`, `P1`.`ifOperStatus`, `P1`.`ifAdminStatus`, `P1`.`ifInOctets_rate`, `P1`.`ifOutOctets_rate`, `P2`.`port_id`, `P2`.`device_id`, `P2`.`ifName`, `P2`.`ifSpeed`, `P2`.`ifOperStatus`, `P2`.`ifAdminStatus`, `P2`.`ifInOctets_rate`, `P2`.`ifOutOctets_rate`
+                      ORDER BY `local_ifname`, `remote_ifname`
+                      ", $sql_array);
+}
+$list = array_merge($ports, $devices);
+$node_disabled_style = [
+    'color' => [
+        'highlight' => [
+            'background' => Config::get('network_map_legend.di.node'),
+        ],
+        'border' => Config::get('network_map_legend.di.border'),
+        'background' => Config::get('network_map_legend.di.node'),
+    ],
+];
+$node_down_style = [
+    'color' => [
+        'highlight' => [
+            'background' => Config::get('network_map_legend.dn.node'),
+            'border' => Config::get('network_map_legend.dn.border'),
+        ],
+        'border' => Config::get('network_map_legend.dn.border'),
+        'background' => Config::get('network_map_legend.dn.node'),
+    ],
+];
+$node_highlight_style = [
+    'color' => [
+        'highlight' => [
+            'border' => Config::get('network_map_legend.highlight.border'),
+        ],
+        'border' => Config::get('network_map_legend.highlight.border'),
+    ],
+    'borderWidth' => Config::get('network_map_legend.highlight.borderWidth'),
+];
+$edge_disabled_style = [
+    'dashes' => [8, 12],
+    'color' => [
+        'color' => Config::get('network_map_legend.di.edge'),
+        'highlight' => Config::get('network_map_legend.di.edge'),
+    ],
+];
+$edge_down_style = [
+    'dashes' => [8, 12],
+    'color' => [
+        'border' => Config::get('network_map_legend.dn.border'),
+        'highlight' => Config::get('network_map_legend.dn.edge'),
+        'color' => Config::get('network_map_legend.dn.edge'),
+    ],
+];
+foreach ($list as $items) {
+    $local_device = [
+        'device_id'=>$items['local_device_id'],
+        'os'=>$items['local_os'],
+        'hostname'=>$items['local_hostname'],
+        'sysName' => $items['local_sysName'],
+        'display' => $items['local_display'],
+    ];
+    $remote_device = [
+        'device_id'=>$items['remote_device_id'],
+        'os'=>$items['remote_os'],
+        'hostname'=>$items['remote_hostname'],
+        'sysName' => $items['remote_sysName'],
+        'display' => $items['remote_display'],
+    ];
+    $local_port = [
+        'port_id'=>$items['local_port_id'],
+        'device_id'=>$items['local_port_device_id'],
+        'ifName'=>$items['local_ifname'],
+        'ifSpeed'=>$items['local_ifspeed'],
+        'ifOperStatus'=>$items['local_ifoperstatus'],
+        'ifAdminStatus'=>$items['local_adminstatus'],
+    ];
+    $remote_port = [
+        'port_id'=>$items['remote_port_id'],
+        'device_id'=>$items['remote_port_device_id'],
+        'ifName'=>$items['remote_ifname'],
+        'ifSpeed'=>$items['remote_ifspeed'],
+        'ifOperStatus'=>$items['remote_ifoperstatus'],
+        'ifAdminStatus'=>$items['remote_adminstatus'],
+    ];
+    $local_device_id = $items['local_device_id'];
+    if (! array_key_exists($local_device_id, $devices_by_id)) {
+        $devices_by_id[$local_device_id] = [
+            'id'=>$local_device_id,
+            'label'=>shorthost(format_hostname($local_device), 1),
+            'title'=>generate_device_link($local_device, '', [], '', '', '', 0),
+            'shape'=>'box',
+        ];
+        if ($items['local_disabled'] != '0') {
+            $devices_by_id[$local_device_id] = array_merge($devices_by_id[$local_device_id], $node_disabled_style);
+        } elseif ($items['local_status'] == '0') {
+            $devices_by_id[$local_device_id] = array_merge($devices_by_id[$local_device_id], $node_down_style);
+        }
+        if ((empty($device['hostname'])) && ($local_device_id == $highlight_node)) {
+            $devices_by_id[$local_device_id] = array_merge($devices_by_id[$local_device_id], $node_highlight_style);
+        }
+    }
+    $remote_device_id = $items['remote_device_id'];
+    if (! array_key_exists($remote_device_id, $devices_by_id)) {
+        $devices_by_id[$remote_device_id] = ['id'=>$remote_device_id, 'label'=>shorthost(format_hostname($remote_device), 1), 'title'=>generate_device_link($remote_device, '', [], '', '', '', 0), 'shape'=>'box'];
+        if ($items['remote_disabled'] != '0') {
+            $devices_by_id[$remote_device_id] = array_merge($devices_by_id[$remote_device_id], $node_disabled_style);
+        } elseif ($items['remote_status'] == '0') {
+            $devices_by_id[$remote_device_id] = array_merge($devices_by_id[$remote_device_id], $node_down_style);
+        }
+        if ((empty($device['hostname'])) && ($remote_device_id == $highlight_node)) {
+            $devices_by_id[$remote_device_id] = array_merge($devices_by_id[$remote_device_id], $node_highlight_style);
+        }
+    }
+    $speed = $items['local_ifspeed'] / 1000 / 1000;
+    if ($speed > 500000) {
+        $width = 20;
+    } else {
+        $width = round(0.77 * pow($speed, 0.25));
+    }
+    $link_in_used = Number::calculatePercent($items['local_ifinoctets_rate'], $items['local_ifspeed']);
+    $link_out_used = Number::calculatePercent($items['local_ifoutoctets_rate'], $items['local_ifspeed']);
+    if ($link_in_used > $link_out_used) {
+        $link_used = $link_in_used;
+    } else {
+        $link_used = $link_out_used;
+    }
+    $link_used = round(2 * $link_used, -1) / 2;
+    if ($link_used > 100) {
+        $link_used = 100;
+    }
+    if (is_nan($link_used)) {
+        $link_used = 0;
+    }
+    $link_style = [
+        'color' => [
+            'border' => Config::get("network_map_legend.$link_used"),
+            'highlight' => Config::get("network_map_legend.$link_used"),
+            'color' => Config::get("network_map_legend.$link_used"),
+        ],
+    ];
+    if (($items['remote_ifoperstatus'] == 'down') || ($items['local_ifoperstatus'] == 'down')) {
+        $link_style = $edge_down_style;
+    }
+    if (($items['remote_disabled'] != '0') && ($items['local_disabled'] != '0')) {
+        $link_style = $edge_disabled_style;
+    } elseif (($items['remote_status'] == '0') && ($items['local_status'] == '0')) {
+        $link_style = $edge_down_style;
+    } elseif (($items['remote_status'] == '1' && $items['remote_ifoperstatus'] == 'down') || ($items['local_status'] == '1' && $items['local_ifoperstatus'] == 'down')) {
+        $link_style = $edge_down_style;
+    }
+    $link_id1 = $items['local_port_id'] . ':' . $items['remote_port_id'];
+    $link_id2 = $items['remote_port_id'] . ':' . $items['local_port_id'];
+    $device_id1 = $items['local_device_id'] . ':' . $items['remote_device_id'];
+    $device_id2 = $items['remote_device_id'] . ':' . $items['local_device_id'];
+    if (! array_key_exists($link_id1, $link_assoc_seen) &&
+        ! array_key_exists($link_id2, $link_assoc_seen) &&
+        (! in_array('mac', Config::get('network_map_items')) ||
+        (! array_key_exists($device_id1, $device_assoc_seen) &&
+        ! array_key_exists($device_id2, $device_assoc_seen)))) {
+        $local_port = cleanPort($local_port);
+        $remote_port = cleanPort($remote_port);
+        $links[] = array_merge(
+            [
+                'from'=>$items['local_device_id'],
+                'to'=>$items['remote_device_id'],
+                'label'=> \LibreNMS\Util\Rewrite::shortenIfType($local_port['ifName']) . ' > ' . \LibreNMS\Util\Rewrite::shortenIfType($remote_port['ifName']),
+                'title' => generate_port_link($local_port, "<img src='graph.php?type=port_bits&amp;id=" . $items['local_port_id'] . '&amp;from=' . Config::get('time.day') . '&amp;to=' . Config::get('time.now') . '&amp;width=100&amp;height=20&amp;legend=no&amp;bg=' . str_replace('#', '', $row_colour) . "'>\n", '', 0, 1),
+                'width'=>$width,
+            ],
+            $link_style
+        );
+    }
+    $link_assoc_seen[$link_id1] = 1;
+    $link_assoc_seen[$link_id2] = 1;
+    $device_assoc_seen[$device_id1] = 1;
+    $device_assoc_seen[$device_id2] = 1;
+}
+$nodes = json_encode(array_values($devices_by_id));
+$edges = json_encode($links);
+array_multisort(array_column($devices_by_id, 'label'), SORT_ASC, $devices_by_id);
+if (count($devices_by_id) > 1 && count($links) > 0) {
+    ?>
+<form name="printmapform" method="get" action="" class="form-horizontal" role="form">
+    <?php if (empty($device['hostname'])) { ?>
+<big><b><?=$group_name?></b></big>
+<div class="pull-right">
+<select name="highlight_node" id="highlight_node" class="input-sm" onChange="highlightNode()";>
+<option value="0">None</option>
+        <?php foreach ($devices_by_id as $dev) { ?>
+<option value="<?=$dev['id']?>"><?=$dev['label']?></option>
+        <?php } ?>
+</select>
+</div>
+    <?php } ?>
+<div id="visualization"></div>
+</form>
+<script src="js/vis.min.js"></script>
+<script type="text/javascript">
+var height = $(window).height() - 100;
+$('#visualization').height(height + 'px');
+    var nodes =
+    <?php
+    echo $nodes; ?>
+    ;
+    var edges =
+    <?php
+    echo $edges; ?>
+    ;
+    var container = document.getElementById('visualization');
+    var data = {
+        nodes: nodes,
+        edges: edges,
+        stabilize: true
+    };
+    var options =  <?php echo Config::get('network_map_vis_options'); ?>;
+var network = new vis.Network(container, data, options);
+    network.on('click', function (properties) {
+        if (properties.nodes > 0) {
+            window.location.href = "device/device="+properties.nodes+"/tab=neighbours/selection=map/"
+        }
+    });
+function highlightNode(e) {
+    highlight_node = document.getElementById("highlight_node").value;
+    <?php
+    if ($group) {
+        echo "window.location.pathname = 'map/group=" . $group . "/highlight_node=' + highlight_node;";
+    } else {
+        echo "window.location.pathname = 'map/highlight_node=' + highlight_node;";
+    } ?>
+}
+$('#highlight_node option[value="<?=$highlight_node?>"]').prop('selected', true);
+</script>
+    <?php
+} else {
+        print_message("No map to display, this may be because you aren't running autodiscovery or no devices are linked by mac address.");
+    }
+$pagetitle[] = 'Map';

--- a/includes/html/table/arp-search.inc.php
+++ b/includes/html/table/arp-search.inc.php
@@ -1,86 +1,97 @@
 <?php
-use App\Models\Ipv4Mac;
 use LibreNMS\Util\Mac;
-use LibreNMS\Util\Rewrite;
-use LibreNMS\Util\Url;
 $param = [];
-if (! isset($sort) || empty($sort)) {
-    $sort = 'hostname ASC';
+$sql = ' FROM `ipv4_mac` AS M, `ports` AS P, `devices` AS D ';
+$where = '';
+if (! Auth::user()->hasGlobalRead()) {
+    $device_ids = Permissions::devicesForUser()->toArray() ?: [0];
+    $where .= ' AND `D`.`device_id` IN ' . dbGenPlaceholders(count($device_ids));
+    $param = array_merge($param, $device_ids);
 }
-$sort_arr = explode(' ', trim($sort));
-if ($sort_arr[0] === 'interface') {
-    $sort_arr[0] = 'port_if_descr';
-} elseif ($sort_arr[0] === 'hostname') {
-    $sort_arr[0] = 'device_hostname';
-}
-if (isset($current)) {
-    $page = $current;
-} else {
-    $page = 1;
-}
-$query = Ipv4Mac::hasAccess(Auth::user())
-    ->with('port', 'device', 'remote_ports_maybe', 'remote_ports_maybe.device')
-    ->withAggregate('port', 'ifDescr')
-    ->withAggregate('device', 'hostname')
-    ->orderBy(...$sort_arr);
+$sql .= " WHERE M.port_id = P.port_id AND P.device_id = D.device_id $where ";
 if (is_numeric($vars['device_id'])) {
-    $query->where('device_id', $vars['device_id']);
+    $sql .= ' AND P.device_id = ?';
+    $param[] = $vars['device_id'];
 }
 if (isset($vars['port_id']) && is_numeric($vars['port_id'])) {
-    $query->where('port_id', $vars['port_id']);
+    $sql .= ' AND P.port_id = ?';
+    $param[] = $vars['port_id'];
 }
 if (isset($vars['searchPhrase']) && ! empty($vars['searchPhrase'])) {
     $ip_search = '%' . trim($vars['searchPhrase']) . '%';
-    $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', trim($vars['searchPhrase'])) . '%';
+    $mac_search = '%' . str_replace([':', ' ', '-', '.', '0x'], '', $vars['searchPhrase']) . '%';
     if (isset($vars['searchby']) && $vars['searchby'] == 'ip') {
-        $query->where('ipv4_address', 'like', $ip_search);
+        $sql .= ' AND `ipv4_address` LIKE ?';
+        $param[] = $ip_search;
     } elseif (isset($vars['searchby']) && $vars['searchby'] == 'mac') {
-        $query->where('mac_address', 'like', $mac_search);
+        $sql .= ' AND `mac_address` LIKE ?';
+        $param[] = $mac_search;
     } else {
-        $query->where(function ($q) use ($ip_search, $mac_search) {
-            $q->where('ipv4_address', 'like', $ip_search)
-                ->orWhere('mac_address', 'like', $mac_search);
-        });
+        $sql .= ' AND (`ipv4_address` LIKE ? OR `mac_address` LIKE ?)';
+        $param[] = $ip_search;
+        $param[] = $mac_search;
     }
 }
-$pag = $query->paginate($rowCount);
-foreach ($pag->items() as $arp) {
-    if ($arp->port->ifInErrors > 0 || $arp->port->ifOutErrors > 0) {
-        $error_img = generate_port_link($arp->port, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
-    } else {
-        $error_img = '';
-    }
-    if ($arp->remote_ports_maybe) {
-        $remote_port = $arp->remote_ports_maybe->first();
-        if ($remote_port->port_id != $arp->port_id) {
-            $arp_name = Url::deviceLink($remote_port->device);
-            $arp_if = Url::portLink($remote_port);
+$count_sql = "SELECT COUNT(`M`.`port_id`) $sql";
+$total = dbFetchCell($count_sql, $param);
+if (empty($total)) {
+    $total = 0;
+}
+if (! isset($sort) || empty($sort)) {
+    $sort = '`hostname` ASC';
+}
+$sql .= " ORDER BY $sort";
+if (isset($current)) {
+    $limit_low = (($current * $rowCount) - $rowCount);
+    $limit_high = $rowCount;
+}
+if ($rowCount != -1) {
+    $sql .= " LIMIT $limit_low,$limit_high";
+}
+$sql = "SELECT *,`P`.`ifDescr` AS `interface` $sql";
+foreach (dbFetchRows($sql, $param) as $entry) {
+    $entry = cleanPort($entry);
+    if (empty($ignore)) {
+        if ($entry['ifInErrors'] > 0 || $entry['ifOutErrors'] > 0) {
+            $error_img = generate_port_link($entry, "<i class='fa fa-flag fa-lg' style='color:red' aria-hidden='true'></i>", 'port_errors');
         } else {
+            $error_img = '';
+        }
+        $arp_host = dbFetchRow('SELECT * FROM ipv4_addresses AS A, ports AS I, devices AS D WHERE A.ipv4_address = ? AND I.port_id = A.port_id AND D.device_id = I.device_id', [$entry['ipv4_address']]);
+        if ($arp_host) {
+            $arp_name = generate_device_link($arp_host);
+        } else {
+            unset($arp_name);
+        }
+        if ($arp_host) {
+            $arp_host = cleanPort($arp_host);
+            $arp_if = generate_port_link($arp_host);
+        } else {
+            unset($arp_if);
+        }
+        if ($arp_host['device_id'] == $entry['device_id']) {
             $arp_name = 'Localhost';
+        }
+        if ($arp_host['port_id'] == $entry['port_id']) {
             $arp_if = 'Local port';
         }
-    } elseif ($arp->mac_address == $arp->port->ifPhysAddress) {
-        $arp_name = 'Localhost';
-        $arp_if = 'Local port';
-    } else {
-        unset($arp_name);
-        unset($arp_if);
-    }
-    $mac = Mac::parse($arp->mac_address);
-    $response[] = [
-        'mac_address' => $mac->readable(),
-        'mac_oui' => $mac->vendor(),
-        'ipv4_address' => $arp->ipv4_address,
-        'hostname' => Url::deviceLink($arp->device),
-        'interface' => Url::portLink($arp->port, Rewrite::shortenIfName($arp->label)) . ' ' . $error_img,
-        'remote_device' => $arp_name,
-        'remote_interface' => $arp_if,
-    ];
+        $mac = Mac::parse($entry['mac_address']);
+        $response[] = [
+            'mac_address' => $mac->readable(),
+            'mac_oui' => $mac->vendor(),
+            'ipv4_address' => $entry['ipv4_address'],
+            'hostname' => generate_device_link($entry),
+            'interface' => generate_port_link($entry, makeshortif($entry['label'])) . ' ' . $error_img,
+            'remote_device' => $arp_name,
+            'remote_interface' => $arp_if,
+        ];
+    }//end if
+    unset($ignore);
 }//end foreach
 $output = [
     'current' => $current,
     'rowCount' => $rowCount,
     'rows' => $response,
-    'total' => $pag->total(),
+    'total' => $total,
 ];
 echo json_encode($output, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);

--- a/includes/polling/applications/chronyd.inc.php
+++ b/includes/polling/applications/chronyd.inc.php
@@ -78,14 +78,14 @@
         $metrics['source_' . $source['source_name'] . '_' . $field] = $value;
     }
 }
 $old_sources = $app->data['sources'] ?? [];
 $added_sources = array_diff($sources, $old_sources);
 $removed_sources = array_diff($old_sources, $sources);
 if (count($added_sources) > 0 || count($removed_sources) > 0) {
     $app->data = ['sources' => $sources]; // save sources
     $log_message = 'Chronyd Source Change:';
     $log_message .= count($added_sources) > 0 ? ' Added ' . implode(',', $added_sources) : '';
-    $log_message .= count($removed_sources) > 0 ? ' Removed ' . implode(',', $removed_sources) : '';
+    $log_message .= count($removed_sources) > 0 ? ' Removed ' . implode(',', $added_sources) : '';
     log_event($log_message, $device, 'application');
 }
 update_application($app, 'OK', $metrics);

--- a/includes/polling/applications/http_access_log_combined.inc.php
+++ b//dev/null
@@ -1,156 +0,0 @@
-<?php
-use LibreNMS\Exceptions\JsonAppException;
-use LibreNMS\RRD\RrdDefinition;
-$name = 'http_access_log_combined';
-try {
-    $returned = json_app_get($device, $name, 1);
-} catch (JsonAppException $e) {
-    echo PHP_EOL . $name . ':' . $e->getCode() . ':' . $e->getMessage() . PHP_EOL;
-    update_application($app, $e->getCode() . ':' . $e->getMessage(), []); // Set empty metrics and error message
-    return;
-}
-$stat_vars = [
-    '100',
-    '101',
-    '102',
-    '103',
-    '1xx',
-    '200',
-    '201',
-    '202',
-    '203',
-    '204',
-    '205',
-    '206',
-    '207',
-    '208',
-    '218',
-    '226',
-    '2xx',
-    '300',
-    '301',
-    '302',
-    '303',
-    '304',
-    '305',
-    '306',
-    '307',
-    '308',
-    '3xx',
-    '400',
-    '401',
-    '402',
-    '403',
-    '404',
-    '405',
-    '406',
-    '407',
-    '408',
-    '409',
-    '410',
-    '411',
-    '412',
-    '413',
-    '414',
-    '415',
-    '416',
-    '417',
-    '419',
-    '420',
-    '421',
-    '422',
-    '423',
-    '424',
-    '425',
-    '426',
-    '428',
-    '429',
-    '431',
-    '444',
-    '451',
-    '494',
-    '495',
-    '496',
-    '497',
-    '499',
-    '4xx',
-    '500',
-    '501',
-    '502',
-    '503',
-    '504',
-    '505',
-    '506',
-    '507',
-    '508',
-    '509',
-    '510',
-    '511',
-    '5xx',
-    'CONNECT',
-    'DELETE',
-    'GET',
-    'HEAD',
-    'OPTIONS',
-    'PATCH',
-    'POST',
-    'PUT',
-    'bytes',
-    'bytes_max',
-    'bytes_mean',
-    'bytes_median',
-    'bytes_min',
-    'bytes_mode',
-    'bytes_range',
-    'error_size',
-    'http1_0',
-    'http1_1',
-    'http2',
-    'http3',
-    'no_refer',
-    'no_user',
-    'refer',
-    'size',
-    'user',
-];
-$metrics = [];
-$old_data = $app->data;
-$new_data = [];
-$data = $returned['data'];
-$gauge_rrd_def = RrdDefinition::make()
-    ->addDataset('data', 'GAUGE', 0);
-foreach ($stat_vars as $key => $stat) {
-    $var_name = 'totals_' . $stat;
-    $value = $data['totals'][$stat];
-    $rrd_name = ['app', $name, $app->app_id, $var_name];
-    $fields = ['data' => $value];
-    $metrics[$var_name] = $value;
-    $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
-    data_update($device, 'app', $tags, $fields);
-}
-$logs = [];
-foreach ($data['logs'] as $logs_key => $log_stats) {
-    $logs[] = $logs_key;
-    foreach ($stat_vars as $key => $stat) {
-        $var_name = 'logs___' . $logs_key . '___' . $stat;
-        $value = $log_stats[$stat];
-        $rrd_name = ['app', $name, $app->app_id, $var_name];
-        $fields = ['data' => $value];
-        $metrics[$var_name] = $value;
-        $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
-        data_update($device, 'app', $tags, $fields);
-    }
-}
-sort($logs);
-$old_logs = $old_data['logs'] ?? [];
-$added_logs = array_diff($logs, $old_logs);
-$removed_logs = array_diff($old_logs, $logs);
-$new_data['logs'] = $logs;
-$app->data = $new_data;
-if (count($added_logs) > 0 || count($removed_logs) > 0) {
-    $log_message = 'HTTP Access Log Set Change:';
-    $log_message .= count($added_logs) > 0 ? ' Added ' . implode(',', $added_logs) : '';
-    $log_message .= count($removed_logs) > 0 ? ' Removed ' . implode(',', $added_logs) : '';
-    log_event($log_message, $device, 'application');
-}
-update_application($app, 'OK', $metrics);

--- a/includes/polling/applications/oslv_monitor.inc.php
+++ b//dev/null
@@ -1,173 +0,0 @@
-<?php
-use LibreNMS\Exceptions\JsonAppException;
-use LibreNMS\RRD\RrdDefinition;
-$name = 'oslv_monitor';
-try {
-    $returned = json_app_get($device, $name, 1);
-} catch (JsonAppException $e) {
-    echo PHP_EOL . $name . ':' . $e->getCode() . ':' . $e->getMessage() . PHP_EOL;
-    update_application($app, $e->getCode() . ':' . $e->getMessage(), []); // Set empty metrics and error message
-    return;
-}
-$stat_vars = [
-    'active_anon',
-    'active_file',
-    'anon',
-    'anon_thp',
-    'burst-time',
-    'copy-on-write-faults',
-    'core_sched.force_idle-time',
-    'cpu-time',
-    'data-size',
-    'dbytes',
-    'dios',
-    'elapsed-times',
-    'file',
-    'file_dirty',
-    'file_mapped',
-    'file_thp',
-    'file_writeback',
-    'inactive_anon',
-    'inactive_file',
-    'involuntary-context-switches',
-    'kernel',
-    'kernel_stack',
-    'major-faults',
-    'minor-faults',
-    'nr_bursts',
-    'nr_periods',
-    'nr_throttled',
-    'pagetables',
-    'percent-cpu',
-    'percent-memory',
-    'percpu',
-    'pgactivate',
-    'pgdeactivate',
-    'pglazyfree',
-    'pglazyfreed',
-    'pgrefill',
-    'pgscan',
-    'pgscan_direct',
-    'pgscan_khugepaged',
-    'pgscan_kswapd',
-    'pgsteal',
-    'pgsteal_direct',
-    'pgsteal_khugepaged',
-    'pgsteal_kswapd',
-    'procs',
-    'rbytes',
-    'read-blocks',
-    'received-messages',
-    'rios',
-    'rss',
-    'sec_pagetables',
-    'sent-messages',
-    'shmem',
-    'shmem_thp',
-    'signals-taken',
-    'slab',
-    'slab_reclaimable',
-    'slab_unreclaimable',
-    'sock',
-    'stack-size',
-    'swapcached',
-    'swaps',
-    'system-time',
-    'text-size',
-    'thp_collapse_alloc',
-    'thp_fault_alloc',
-    'thp_swpout',
-    'thp_swpout_fallback',
-    'throttled-time',
-    'unevictable',
-    'user-time',
-    'virtual-size',
-    'vmalloc',
-    'voluntary-context-switches',
-    'wbytes',
-    'wios',
-    'workingset_activate_anon',
-    'workingset_activate_file',
-    'workingset_nodereclaim',
-    'workingset_refault_anon',
-    'workingset_refault_file',
-    'workingset_restore_anon',
-    'workingset_restore_file',
-    'written-blocks',
-    'zswap',
-    'zswapped',
-    'zswpin',
-    'zswpout',
-    'zswpwb',
-    'size',
-];
-$gauge_rrd_def = RrdDefinition::make()
-    ->addDataset('data', 'GAUGE', 0);
-$data = $returned['data'];
-$metrics = [];
-$old_data = $app->data;
-$new_data = [
-    'backend' => $data['backend'],
-    'uid_mapping' => $data['uid_mapping'],
-    'oslvm_data' => [],
-    'inactive' => [],
-    'has' => [],
-];
-if (isset($data['has']) && is_array($data['has'])) {
-    $new_data['has'] = $data['has'];
-}
-foreach ($stat_vars as $key => $stat) {
-    if (isset($data['totals'][$stat])) {
-        $var_name = 'totals_' . $stat;
-        $value = $data['totals'][$stat];
-        $rrd_name = ['app', $name, $app->app_id, $var_name];
-        $fields = ['data' => $value];
-        $metrics[$var_name] = $value;
-        $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
-        data_update($device, 'app', $tags, $fields);
-    }
-}
-$oslvms = [];
-$current_time = now()->format('U');
-foreach ($data['oslvms'] as $oslvms_key => $oslvms_stats) {
-    $new_data['oslvm_data'][$oslvms_key] = [
-        'ip' => $oslvms_stats['ip'],
-        'path' => $oslvms_stats['path'],
-        'seen' => $current_time,
-    ];
-    $metrics['running_' . $oslvms_key] = 1;
-    $oslvms[] = $oslvms_key;
-    foreach ($stat_vars as $key => $stat) {
-        if (isset($oslvms_stats[$stat])) {
-            $var_name = 'oslvm___' . $oslvms_key . '___' . $stat;
-            $value = $oslvms_stats[$stat];
-            $rrd_name = ['app', $name, $app->app_id, $var_name];
-            $fields = ['data' => $value];
-            $metrics[$var_name] = $value;
-            $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $gauge_rrd_def, 'rrd_name' => $rrd_name];
-            data_update($device, 'app', $tags, $fields);
-        }
-    }
-}
-sort($oslvms);
-$old_oslvms = $old_data['oslvms'] ?? [];
-$added_oslvms = array_diff($oslvms, $old_oslvms);
-$removed_oslvms = array_diff($old_oslvms, $oslvms);
-$new_data['oslvms'] = $oslvms;
-$back_till = $current_time - LibreNMS\Config::get('apps.oslv_monitor.seen_age', 604800);
-foreach ($old_data['oslvm_data'] as $key => $oslvm) {
-    if (! isset($new_data['oslvm_data'][$key]) && isset($old_data['oslvm_data'][$key]['seen']) &&
-        $back_till <= $old_data['oslvm_data'][$key]['seen']) {
-        $new_data['oslvm_data'][$key] = $old_data['oslvm_data'][$key];
-        $new_data['inactive'][] = $key;
-        $metrics['running_' . $key] = 0;
-    }
-}
-$app->data = $new_data;
-if (count($added_oslvms) > 0 || count($removed_oslvms) > 0) {
-    $log_message = 'OSLV Change:';
-    $log_message .= count($added_oslvms) > 0 ? ' Added ' . implode(',', $added_oslvms) : '';
-    $log_message .= count($removed_oslvms) > 0 ? ' Removed ' . implode(',', $removed_oslvms) : '';
-    log_event($log_message, $device, 'application');
-}
-update_application($app, 'OK', $metrics);

--- a/includes/polling/applications/zfs.inc.php
+++ b/includes/polling/applications/zfs.inc.php
@@ -1,19 +1,18 @@
 <?php
 use LibreNMS\Exceptions\JsonAppException;
 use LibreNMS\Exceptions\JsonAppMissingKeysException;
 use LibreNMS\RRD\RrdDefinition;
 $name = 'zfs';
 $not_legacy = 1;
 try {
-    $all_return = json_app_get($device, $name, 1);
-    $zfs = $all_return['data'];
+    $zfs = json_app_get($device, $name, 1)['data'];
 } catch (JsonAppMissingKeysException $e) {
     $zfs = $e->getParsedJson();
 } catch (JsonAppException $e) {
     echo PHP_EOL . $name . ':' . $e->getCode() . ':' . $e->getMessage() . PHP_EOL;
     update_application($app, $e->getCode() . ':' . $e->getMessage(), []); // Set empty metrics and error message
     return;
 }
 $rrd_name = ['app', $name, $app->app_id];
 $rrd_def = RrdDefinition::make()
     ->addDataset('deleted', 'DERIVE', 0)
@@ -209,98 +208,50 @@
     'l2_rb_success' => $zfs['l2_rebuild_success'],
     'l2_rb_unsup' => $zfs['l2_rebuild_unsupported'],
     'l2_rw_clash' => $zfs['l2_rw_clash'],
     'l2_size' => $zfs['l2_size'],
     'l2_write_bytes' => $zfs['l2_write_bytes'],
     'l2_writes_done' => $zfs['l2_writes_done'],
     'l2_writes_error' => $zfs['l2_writes_error'],
     'l2_writes_l_retry' => $zfs['l2_writes_lock_retry'],
     'l2_writes_sent' => $zfs['l2_writes_sent'],
 ];
-$rrd_def_gauge = RrdDefinition::make()
-    ->addDataset('data', 'GAUGE', 0);
-$gauges_to_check_for = [
-    'asyncq_read_a',
-    'asyncq_read_p',
-    'asyncq_wait_r',
-    'asyncq_wait_w',
-    'asyncq_write_a',
-    'asyncq_write_p',
-    'bandwidth_r',
-    'bandwidth_w',
-    'disk_wait_r',
-    'disk_wait_w',
-    'operations_r',
-    'operations_w',
-    'read_errors',
-    'checksum_errors',
-    'write_errors',
-    'scrub_wait',
-    'scrubq_read_a',
-    'scrubq_read_p',
-    'syncq_read_a',
-    'syncq_read_p',
-    'syncq_wait_r',
-    'syncq_wait_w',
-    'syncq_write_a',
-    'syncq_write_p',
-    'total_wait_r',
-    'total_wait_w',
-    'trim_wait',
-    'trimq_write_a',
-    'trimq_write_p',
-];
 $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $rrd_def, 'rrd_name' => $rrd_name];
 data_update($device, 'app', $tags, $fields);
 $pools = [];
 $pool_rrd_def = RrdDefinition::make()
     ->addDataset('size', 'GAUGE', 0)
     ->addDataset('alloc', 'GAUGE', 0)
     ->addDataset('free', 'GAUGE', 0)
     ->addDataset('expandsz', 'GAUGE', 0)
     ->addDataset('frag', 'GAUGE', 0)
     ->addDataset('cap', 'GAUGE', 0)
     ->addDataset('dedup', 'GAUGE', 0);
 $metrics = $zfs; // copy $zfs data to $metrics
 unset($metrics['pools']); // remove pools it is an array, re-add data below
-$zpool_status = $app->data['status_info'] ?? [];
 foreach ($zfs['pools'] as $pool) {
     $pools[] = $pool['name'];
     $rrd_name = ['app', $name, $app->app_id, $pool['name']];
     $fields = [
         'alloc' => $pool['alloc'],
         'size' => $pool['size'],
         'free' => $pool['free'],
         'expandsz' => $pool['expandsz'],
         'frag' => set_numeric($pool['frag'], -1),
         'cap' => $pool['cap'],
         'dedup' => $pool['dedup'],
     ];
     $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $pool_rrd_def, 'rrd_name' => $rrd_name];
     data_update($device, 'app', $tags, $fields);
     foreach ($fields as $field => $value) {
         $metrics['pool_' . $pool['name'] . '_' . $field] = $value;
     }
-    foreach ($gauges_to_check_for as $gauge_var) {
-        if (isset($pool[$gauge_var])) {
-            $metrics['pool_' . $pool['name'] . '_' . $gauge_var] = $pool[$gauge_var];
-            $rrd_name = ['app', $name, $app->app_id, $pool['name'] . '____' . $gauge_var];
-            $fields = [
-                'data' => $pool[$gauge_var],
-            ];
-            $tags = ['name' => $name, 'app_id' => $app->app_id, 'rrd_def' => $rrd_def_gauge, 'rrd_name' => $rrd_name];
-            data_update($device, 'app', $tags, $fields);
-        }
-    }
-    if (isset($pool['status'])) {
-        $zpool_status[$pool['name']] = $pool['status'];
-    }
 }
 $old_health = $app->data['health'] ?? 1;
 if (isset($zfs['health'])) {
     $health = $zfs['health'];
     if ($old_health != $zfs['health']) {
         if ($zfs['health'] == 1) {
             log_event('ZFS pool(s) now healthy', $device, 'application', 1);
         } else {
             log_event('ZFS pool(s) DEGRADED, FAULTED, UNAVAIL, REMOVED, or unknown', $device, 'application', 5);
         }
@@ -316,18 +267,12 @@
 }
 $old_pools = $app->data['pools'] ?? [];
 $added_pools = array_diff($pools, $old_pools);
 $removed_pools = array_diff($old_pools, $pools);
 if (count($added_pools) > 0 || count($removed_pools) > 0) {
     $log_message = 'ZFS Pool Change:';
     $log_message .= count($added_pools) > 0 ? ' Added ' . implode(',', $added_pools) : '';
     $log_message .= count($removed_pools) > 0 ? ' Removed ' . implode(',', $added_pools) : '';
     log_event($log_message, $device, 'application');
 }
-$app->data = [
-    'pools' => $pools,
-    'health' => $health,
-    'version' => $all_return['version'],
-    'l2_errors' => $zfs['l2_errors'],
-    'status_info' => $zpool_status,
-];
+$app->data = ['pools' => $pools, 'health' => $health, 'l2_errors' => $zfs['l2_errors']];
 update_application($app, 'OK', $metrics);

--- a/includes/polling/loadbalancers.inc.php
+++ b/includes/polling/loadbalancers.inc.php
@@ -2,20 +2,14 @@
 /*
  * LibreNMS module to capture details from various Load Balancers
  *
  * This program is free software: you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
  * Free Software Foundation, either version 3 of the License, or (at your
  * option) any later version.  Please see LICENSE.txt at the top level of
  * the source code distribution for details.
  */
 if ($device['os'] == 'f5') {
-    if (file_exists(Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm.inc.php')) {
-        include Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm.inc.php';
-    }
-    if (file_exists(Config::get('install_dir') . 'includes/polling/loadbalancers/f5-gtm.inc.php')) {
-        include Config::get('install_dir') . 'includes/polling/loadbalancers/f5-gtm.inc.php';
-    }
-    if (file_exists(Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm-currconns.inc.php')) {
-        include Config::get('install_dir') . 'includes/polling/loadbalancers/f5-ltm-currconns.inc.php';
-    }
+    include 'includes/polling/loadbalancers/f5-ltm.inc.php';
+    include 'includes/polling/loadbalancers/f5-gtm.inc.php';
+    include 'includes/polling/loadbalancers/f5-ltm-currconns.inc.php';
 }

--- a/lang/en/map.php
+++ b/lang/en/map.php
@@ -43,45 +43,36 @@
             'map' => [
                 'settings_title' => 'Map Settings',
                 'name' => 'Name',
                 'menu_group' => 'Menu Group',
                 'no_group' => 'No Group',
                 'width' => 'Width',
                 'height' => 'Height',
                 'alignment' => 'Node Alignment',
                 'edgeseparation' => 'Link Separation',
                 'reverse' => 'Reverse Arrows',
+                'enable_legend' => 'Enable Legend',
                 'saving' => 'Saving...',
                 'save_errors' => 'Save failed due to the following errors:',
                 'save_error' => 'Save failed.  Server returned error response code: :code',
                 'delete' => 'Delete :name?',
                 'list' => 'Return to map list',
                 'unsavedchanges' => 'You have unsaved changes.  Press confirm to discard changes and return to the map list, or cancel to return to the editor.',
                 'edit' => 'Edit Map Settings',
                 'rerender' => 'Re-Render Map',
                 'save' => 'Save Map',
                 'legend' => [
-                    'customcolours' => 'Custom Colours',
-                    'colour' => 'Colour',
-                    'colour_lower_pct' => 'Start Percent',
-                    'colour_down' => 'Device Down Colour',
-                    'colour_invalid' => 'Unknown Percent Colour',
                     'font_size' => 'Legend Text Size',
                     'steps' => 'Legend Steps',
                     'hideinvalid' => 'Hide Invalid',
                     'hideoverspeed' => 'Hide 100%+',
                 ],
-                'legend_title' => 'Legend Settings',
-                'legend_toggle' => 'Toggle Legend',
-                'zoom' => 'Pan and Zoom',
-                'dragnodes' => 'Move Nodes',
-                'physics' => 'Physics Engine',
             ],
             'node' => [
                 'new' => 'New Node',
                 'add' => 'Add Node',
                 'edit' => 'Edit Node',
                 'defaults_title' => 'Node Default Config',
                 'label' => 'Label',
                 'name' => 'Node Name',
                 'device_select' => 'Select Device',
                 'edit_defaults' => 'Edit Node Defaults',
@@ -129,24 +120,21 @@
                     'switch-l2' => 'Switch - L2',
                     'switch-l3' => 'Switch - L3',
                 ],
                 'size' => 'Node Size',
                 'bg_color' => 'Background Color',
                 'border_color' => 'Border Color',
             ],
             'edge' => [
                 'new' => 'New Edge',
                 'add' => 'Add Edge',
-                'edit' => 'Edit Edge',
                 'defaults_title' => 'Edge Default Config',
-                'dynamic_width' => 'Dynamic Width',
-                'fixed_width' => 'Fixed Width',
                 'from' => 'From',
                 'to' => 'To',
                 'port_select' => 'Select Port',
                 'reverse' => 'Reverse Port Direction',
                 'edit_defaults' => 'Edit Edge Defaults',
                 'style' => 'Line Style',
                 'style_options' => [
                     'dynamic' => 'Dynamic',
                     'continuous' => 'Continuous',
                     'discrete' => 'Discrete',
@@ -165,15 +153,12 @@
             ],
             'validate' => [
                 'width_format' => 'Width must be a number followed by px or %',
                 'width_percent' => 'Width percent must be between 10 and 100',
                 'width_pixels' => 'Width in pixels must be at least 200',
                 'height_format' => 'Height must be a number followed by px or %',
                 'height_percent' => 'Height percent must be between 10 and 100',
                 'height_pixels' => 'Height in pixels must be at least 200',
             ],
         ],
-        'widget' => [
-            'not_found' => 'No map selected.  Edit widget to select map.',
-        ],
     ],
 ];

--- a/lang/en/settings.php
+++ b/lang/en/settings.php
@@ -1091,28 +1091,20 @@
             'description' => 'Path to mtr',
         ],
         'mydomain' => [
             'description' => 'Primary Domain',
             'help' => 'This domain is used for network auto-discovery and other processes. LibreNMS will attempt to append it to unqualified hostnames.',
         ],
         'network_map_show_on_worldmap' => [
             'description' => 'Display network links on the map',
             'help' => 'Show the networks links between the different location on the worldmap (weathermap-like)',
         ],
-        'network_map_worldmap_show_disabled_alerts' => [
-            'description' => 'Show devices with alerts disabled',
-            'help' => 'Show devices on the network map that have alerts disabled',
-        ],
-        'network_map_worldmap_link_type' => [
-            'description' => 'Network map source',
-            'help' => 'Choose the source of data for the network map links',
-        ],
         'nfsen_enable' => [
             'description' => 'Enable NfSen',
             'help' => 'Enable Integration with NfSen',
         ],
         'nfsen_rrds' => [
             'description' => 'NfSen RRD Directories',
             'help' => 'This value specifies where your NFSen RRD files are located.',
         ],
         'nfsen_subdirlayout' => [
             'description' => 'Set NfSen subdir layout',
@@ -1827,28 +1819,20 @@
             'options' => [
                 'hostname' => 'Hostname / IP',
                 'sysName_fallback' => 'Hostname, fallback to sysName for IPs',
                 'sysName' => 'sysName',
                 'ip' => 'IP (from hostname IP or resolved)',
             ],
         ],
         'device_location_map_open' => [
             'description' => 'Location Map open',
             'help' => 'Location Map is shown by default',
-        ],
-        'device_location_map_show_devices' => [
-            'description' => 'Show devices on location map',
-            'help' => 'Show all devices on the location map when it is visible',
-        ],
-        'device_location_map_show_device_dependencies' => [
-            'description' => 'Show devices dependecies on location map',
-            'help' => 'Show links between devices on the location map based on parent dependencies',
         ],
         'whois' => [
             'description' => 'Path to whois',
         ],
         'smokeping.integration' => [
             'description' => 'Enable',
             'help' => 'Enable smokeping integration',
         ],
         'smokeping.dir' => [
             'description' => 'Path to rrds',

--- a/lang/en/widgets.php
+++ b/lang/en/widgets.php
@@ -7,23 +7,20 @@
         'title' => 'Alert History',
     ],
     'alertlog-stats' => [
         'title' => 'Alert History Stats',
     ],
     'availability-map' => [
         'title' => 'Availability Map',
     ],
     'component-status' => [
         'title' => 'Component Status',
-    ],
-    'custom-map' => [
-        'title' => 'Custom Map',
     ],
     'device-summary-horiz' => [
         'title' => 'Device Summary Horizontal',
     ],
     'device-summary-vert' => [
         'title' => 'Device Summary Vertical',
     ],
     'device-types' => [
         'title' => 'Device Types',
     ],

--- a/resources/views/components/graph.blade.php
+++ b/resources/views/components/graph.blade.php
@@ -1 +1 @@
-<img width="{{ $width }}" height="{{ $height }}" src="{{ $src }}" alt="{{ $type }}" {{ $attributes->filter($filterAttributes)->merge(['class' => 'graph-image']) }} {{ $attributes->only('loading') }}>
+<img width="{{ $width }}" height="{{ $height }}" src="{{ $src }}" alt="{{ $type }}" {{ $attributes->merge(['class' => 'graph-image'])->filter($filterAttributes) }} {{ $attributes->only('loading') }}>

--- a/resources/views/components/linked-graph.blade.php
+++ b/resources/views/components/linked-graph.blade.php
@@ -1 +1 @@
-<a href="{{ $link }}" {{ $attributes->only(['class', 'style']) }}>@include('components.graph')</a>
+<a href="{{ $link }}" {{ $attributes->filter($filterAttributes) }}>@include('components.graph')</a>

--- a/resources/views/components/refresh-timer.blade.php
+++ b//dev/null
@@ -1,65 +0,0 @@
-@props(['refresh' => 0, 'callback' => 'location.reload'])
-<script>
-    var no_refresh = false;
-    var Countdown = {
-        sec: {{ max($refresh, 30) }},
-        Start: function () {
-            $("#countdown_timer_pause").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i> {{ __('Pause') }}");
-            this.interval = setInterval(() => {
-                this.sec -= 1;
-                if (this.sec <= 0) {
-                    {{ $callback }}();
-                    this.Reset();
-                }
-                $("#countdown_timer").text("{{ __('Refresh in :sec') }}".replace(":sec", this.sec));
-            }, 1000);
-        },
-        Pause: function () {
-            clearInterval(this.interval);
-            delete this.interval;
-            $("#countdown_timer_pause").html("<i class=\"fa fa-play fa-fw fa-lg\"></i> {{ __('Resume') }}");
-            $("#countdown_timer").text(" {{ __('Refresh paused') }}");
-        },
-        Resume: function () {
-        @if($refresh)
-            if (!this.interval) this.Start();
-        @endif
-        },
-        Reset: function () {
-            this.sec = {{ max($refresh, 30) }};
-        },
-    };
-    $(document).ready(function () {
-@if($refresh)
-        $("#countdown_timer_menu").show();
-        $("#countdown_timer_divider").show();
-        Countdown.Start();
-@elseif($refresh === 0)
-        no_refresh = true;
-        $("#countdown_timer_menu").show();
-        $("#countdown_timer_divider").show();
-        $("#countdown_timer").text("{{ __('Refresh disabled') }}");
-        $("#countdown_timer_pause").closest("li").hide();
-@else
-        no_refresh = true;
-        $("#countdown_timer_menu").hide();
-        $("#countdown_timer_divider").hide();
-@endif
-        $("#countdown_timer_pause").on("click", function (event) {
-            event.preventDefault();
-            if (Countdown.interval) {
-                Countdown.Pause();
-            } else {
-                Countdown.Resume();
-            }
-        });
-        $("#countdown_timer_refresh").on("click", function (event) {
-            event.preventDefault();
-            {{ $callback }}();
-            Countdown.Reset();
-        });
-        $("#countdown_timer").closest("a").on("click", function (event) {
-            event.preventDefault();
-        });
-    });
-</script>

--- a/resources/views/device/index.blade.php
+++ b/resources/views/device/index.blade.php
@@ -14,21 +14,21 @@
                     </li>
                 @endif
             @endforeach
             <div class="btn-group pull-right" role="group">
                 <a href="{{ $primary_device_link['url'] }}"
                    class="btn btn-default"
                    type="button"
                    @if(isset($primary_device_link['onclick']))onclick="{{ $primary_device_link['onclick'] }}" @endif
                    @if($primary_device_link['external'])target="_blank" rel="noopener" @endif
                    title="{{ $primary_device_link['title'] }}"
-                >&nbsp;<i class="fa {{ $primary_device_link['icon'] }} fa-lg icon-theme"></i>
+                > <i class="fa {{ $primary_device_link['icon'] }} fa-lg icon-theme"></i>
                 </a>
                 <div class="btn-group" role="group">
                     <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                         &nbsp;<i class="fa fa-ellipsis-v fa-lg icon-theme"></i>&nbsp;
                     </button>
                     <ul class="dropdown-menu dropdown-menu-right">
                         @foreach($device_links as $link)
                             <li><a href="{{ $link['url'] }}"
                                    @if(isset($link['onclick']))onclick="{{ $link['onclick'] }}" @endif
                                    @if($link['external'])target="_blank" rel="noopener" @endif

--- a/resources/views/device/overview/transceivers.blade.php
+++ b/resources/views/device/overview/transceivers.blade.php
@@ -2,21 +2,21 @@
     <div class="col-md-12">
         <x-panel class="device-overview panel-condensed">
             <x-slot name="heading" class="tw-mb-6">
                 <x-icons.transceiver></x-icons.transceiver>
                 <strong><a href="{{ $transceivers_link }}">{{ __('port.tabs.transceivers') }}</a></strong>
             </x-slot>
             @foreach($transceivers as $transceiver)
                 <x-panel body-class="!tw-p-0">
                     <x-slot name="heading">
                         @if($transceiver->port)
-                        <x-port-link :port="$transceiver->port" :vars="['view' => 'transceiver']"></x-port-link>
+                        <x-port-link :port="$transceiver->port"></x-port-link>
                         @endif
                         <x-icons.transceiver></x-icons.transceiver> {{ $transceiver->vendor }} {{ $transceiver->type }}
                     </x-slot>
                     <table class="table table-hover table-condensed table-striped !tw-mb-0">
                         @foreach($sensors as $sensor)
                             @if($sensor->entPhysicalIndex !== null && $sensor->entPhysicalIndex == $transceiver->entity_physical_index && $filterSensors($sensor))
                             <tr>
                                 <td>
                                     <div style="display: grid; grid-gap: 10px; grid-template-columns: 3fr 1fr 1fr;">
                                         <div>{{ $sensor->sensor_descr }}</div>

--- a/resources/views/device/tabs/neighbours.blade.php
+++ b//dev/null
@@ -1,88 +0,0 @@
-@extends('device.index')
-@section('tab')
-    <x-option-bar name="Neighbours" :options="$data['selections']" :selected="$data['selection']"></x-option-bar>
-@if($data['selection'] == 'list')
-    <table class="table table-hover table-condensed" id="neighbour-table">
-        <thead>
-            <tr>
-                <th>Local Port</th>
-                <th>Remote Device</th>
-                <th>Remote Port</th>
-                <th>Protocol</th>
-            </tr>
-        </thead>
-        <tbody>
-@foreach($data['links'] as $link)
-@if($link['rdev_url'])
-            <tr>
-                <td>{!! $link['local_url'] !!}<br />{{ $link['local_portname'] }}</td>
-                <td>{!! $link['rdev_url'] !!}<br />{{ $link['rdev_info'] }}</td>
-                <td>{!! $link['rport_url'] !!}<br />{{ $link['rport_name'] }}</td>
-                <td>{{ $link['protocol'] }}</td>
-            </tr>
-@else
-            <tr>
-                <td>{!! $link['local_url'] !!}<br />{{ $link['local_portname'] }}</td>
-                <td>{{ $link['rdev_name'] }}<br />{{ $link['rdev_info'] }}</td>
-                <td>{{ $link['rport_name'] }}</td>
-                <td>{{ $link['protocol'] }}</td>
-            </tr>
-@endif
-@endforeach
-        </tbody>
-    </table>
-@elseif($data['selection'] == 'map')
-    <div id="netmap"></div>
-@push('scripts')
-<script>
-var network_nodes = new vis.DataSet({queue: {delay: 100}});
-var network_edges = new vis.DataSet({queue: {delay: 100}});
-$.post( '{{ route('maps.getdevicelinks') }}', {device: {{$data['device_id']}}, link_types: @json($data['link_types'])})
-    .done(function( data ) {
-        var devices = [];
-        $.each(data, function( link_id, link ) {
-            var this_edge = link['style'];
-            this_edge['from'] = link['ldev'];
-            this_edge['to'] = link['rdev'];
-            this_edge['label'] = link['ifnames'];
-            network_edges.add(this_edge);
-            devices[link['ldev']] = true;
-            devices[link['rdev']] = true;
-        });
-        $.post( '{{ route('maps.getdevices') }}', {devices: Object.keys(devices), url_type: 'links'})
-            .done(function( data ) {
-                $.each(data, function( dev_id, dev ) {
-                    var this_dev = {id: dev_id, label: dev["sname"], title: dev["url"], shape: "box"};
-                    if (dev["style"]) {
-                        this_dev = Object.assign(dev["style"], this_dev);
-                    }
-                    network_nodes.add(this_dev);
-                });
-                network_nodes.flush();
-            });
-        network_edges.flush();
-    });
-var height = $(window).height() - 100;
-$('#netmap').height(height + 'px');
-var container = document.getElementById('netmap');
-var options = {!! $data['visoptions'] !!};
-var data = {
-    nodes: network_nodes,
-    edges: network_edges,
-    stabilize: true
-};
-var network = new vis.Network(container, data, options);
-network.on('click', function (properties) {
-    if (properties.nodes > 0) {
-       window.location.href = "{{ @url('device') }}/device="+properties.nodes+"/tab=neighbours/selection=map/"
-    }
-});
-</script>
-@endpush
-@endif
-@endsection
-@section('javascript')
-@if($data['selection'] == 'map')
-    <script src="{{ url('js/vis.min.js') }}"></script>
-@endif
-@endsection

--- a/resources/views/layouts/legacy_page.blade.php
+++ b/resources/views/layouts/legacy_page.blade.php
@@ -1,20 +1,74 @@
 @extends('layouts.librenmsv1')
 @section('content')
     <div class="container-fluid">
         <div class="row">
             <div class="col-md-12">
                 {!! $content !!}
             </div>
         </div>
     </div>
-    <x-refresh-timer :refresh="$refresh"></x-refresh-timer>
+    @if($refresh)
+        <script type="text/javascript">
+            $(document).ready(function () {
+                $("#countdown_timer_status").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i> Pause");
+                var Countdown = {
+                    sec: {{ (int)$refresh }},
+                    Start: function () {
+                        var cur = this;
+                        this.interval = setInterval(function () {
+                            $("#countdown_timer_status").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i> Pause");
+                            cur.sec -= 1;
+                            display_time = cur.sec;
+                            if (display_time == 0) {
+                                location.reload();
+                            }
+                            if (display_time % 1 === 0 && display_time <= 300) {
+                                $("#countdown_timer").html("<i class=\"fa fa-clock-o fa-fw fa-lg\"></i> Refresh in " + display_time);
+                            }
+                        }, 1000);
+                    },
+                    Pause: function () {
+                        clearInterval(this.interval);
+                        $("#countdown_timer_status").html("<i class=\"fa fa-play fa-fw fa-lg\"></i> Resume");
+                        delete this.interval;
+                    },
+                    Resume: function () {
+                        if (!this.interval) this.Start();
+                    }
+                };
+                Countdown.Start();
+                $("#countdown_timer_status").on("click", function (event) {
+                    event.preventDefault();
+                    if (Countdown.interval) {
+                        Countdown.Pause();
+                    } else {
+                        Countdown.Resume();
+                    }
+                });
+                $("#countdown_timer").on("click", function (event) {
+                    event.preventDefault();
+                });
+            });
+        </script>
+    @else
+        <script type="text/javascript">
+            var no_refresh = true;
+            $(document).ready(function () {
+                $("#countdown_timer").html("Refresh disabled");
+                $("#countdown_timer_status").html("<i class=\"fa fa-pause fa-fw fa-lg\"></i>");
+                $("#countdown_timer_status").on("click", function (event) {
+                    event.preventDefault();
+                });
+            });
+        </script>
+    @endif
     @config('enable_footer')
     <nav class="navbar navbar-default {{ $navbar }} navbar-fixed-bottom">
         <div class="container">
             <div class="row">
                 <div class="col-md-12 text-center">
                     <h5>Powered by <a href="{{ \LibreNMS\Config::get('project_home') }}" target="_blank" rel="noopener" class="red">{{ \LibreNMS\Config::get('project_name') }}</a>.</h5>
                 </div>
             </div>
         </div>
     </nav>

--- a/resources/views/layouts/menu.blade.php
+++ b/resources/views/layouts/menu.blade.php
@@ -117,32 +117,31 @@
                                                                         aria-hidden="true"></i> {{ __('FDB Tables') }}</a>
                         </li>
                     </ul>
                 </li>
 {{-- Devices --}}
                 <li class="dropdown">
                     <a href="{{ url('devices/') }}" class="dropdown-toggle" data-hover="dropdown"
                        data-toggle="dropdown"><i class="fa fa-server fa-fw fa-lg fa-nav-icons hidden-md"
                                                  aria-hidden="true"></i> <span class="hidden-sm">{{ __('Devices') }}</span></a>
                     <ul class="dropdown-menu">
-                    @if($no_devices_added)
-                    <li><a href="#"><i class="fa fa-server fa-fw fa-lg" aria-hidden="true"></i> {{ __('No Devices') }}</a>
+                    @if($device_types->isNotEmpty())
+                        <li class="dropdown-submenu">
+                            <a href="{{ url('devices') }}"><i class="fa fa-server fa-fw fa-lg"
+                                                              aria-hidden="true"></i> {{ __('All Devices') }}</a>
+                            <ul class="dropdown-menu scrollable-menu">
+                            @foreach($device_types as $type)
+                                <li><a href="{{ url("devices/type=$type") }}"><i class="fa fa-angle-double-right fa-fw fa-lg" aria-hidden="true"></i> {{ ucfirst($type) }}</a></li>
+                            @endforeach
+                        </ul></li>
                     @else
-                    <li @class(['dropdown-submenu' => $device_types->isNotEmpty()])><a href="{{ url('devices') }}"><i class="fa fa-server fa-fw fa-lg" aria-hidden="true"></i> {{ __('All Devices') }}</a>
-                        @if($device_types->isNotEmpty())
-                        <ul class="dropdown-menu scrollable-menu">
-                        @foreach($device_types as $type)
-                            <li><a href="{{ url("devices/type=$type") }}"><i class="fa fa-angle-double-right fa-fw fa-lg" aria-hidden="true"></i> {{ ucfirst($type) }}</a></li>
-                        @endforeach
-                        </ul>
-                        @endif
-                    </li>
+                            <li class="dropdown-submenu"><a href="#">{{ __('No devices') }}</a></li>
                     @endif
                     @if($device_groups->isNotEmpty())
                             <li class="dropdown-submenu"><a><i class="fa fa-th fa-fw fa-lg"
                                                                         aria-hidden="true"></i> {{ __('Device Groups') }}
                                 </a>
                             <ul class="dropdown-menu scrollable-menu">
                             @foreach($device_groups as $group)
                                 <li><a href="{{ url("devices/group=$group->id") }}" title="{{ $group->desc }}"><i class="fa fa-th fa-fw fa-lg" aria-hidden="true"></i> {{ ucfirst($group->name) }}</a></li>
                             @endforeach
                             </ul>
@@ -232,22 +231,23 @@
                                         <li class="dropdown-submenu">
                                         <a><i class="fa fa-map-marked fa-fw fa-lg"aria-hidden="true"></i> {{ $map_group  }}
                                         </a>
                                             <ul class="dropdown-menu scrollable-menu">
                                         @endif
                                         @foreach($group_maps as $map)
                                         <li><a href="{{ route('maps.custom.show', ['map' => $map->custom_map_id]) }}"><i class="fa fa-map-marked fa-fw fa-lg" aria-hidden="true"></i>
                                                 {{ ucfirst($map->name) }}
                                             </a></li>
                                         @endforeach
-                                        @if($map_group)</ul></li>@endif
+                                        @if($map_group)</ul>@endif
                                     @endforeach
+                            </li>
                         @endif
                         @admin
                         <li role="presentation" class="divider"></li>
                         <li><a href="{{ route('maps.custom.index') }}">
                             <i class="fa fa-pen fa-fw fa-lg" aria-hidden="true"></i> {{ __('Custom Map Editor') }}
                         </a></li>
                         @if(Route::is('maps.custom.show'))
                         <li><a href="{{ route('maps.custom.edit', ['map' => Route::current()->parameter('map')]) }}">
                             <i class="fa fa-pen-to-square fa-fw fa-lg" aria-hidden="true"></i> {{ __('Edit Current Map') }}
                         </a></li>
@@ -599,28 +599,29 @@
                                 <li><a href="{{ url('api-access') }}"><i class="fa fa-cog fa-fw fa-lg"
                                                                          aria-hidden="true"></i> {{ __('API Settings') }}
                                     </a></li>
                                 <li><a href="https://docs.librenms.org/API/" target="_blank" rel="noopener"><i
                                             class="fa fa-book fa-fw fa-lg" aria-hidden="true"></i> {{ __('API Docs') }}</a>
                                 </li>
                             </ul>
                         </li>
                         <li role="presentation" class="divider"></li>
                         @endadmin
-                        <li class="dropdown-submenu" id="countdown_timer_menu" style="display: none">
-                            <a href="#"><i class="fa fa-clock-o fa-fw fa-lg"></i> <span id="countdown_timer"></span></a>
+                        @if (isset($refresh))
+                        <li class="dropdown-submenu">
+                            <a href="#"><span class="countdown_timer" id="countdown_timer"></span></a>
                             <ul class="dropdown-menu">
-                                <li><a href="#" id="countdown_timer_pause"><i class="fa fa-pause fa-fw fa-lg"></i> {{ __('Pause') }}</a></li>
-                                <li><a href="#" id="countdown_timer_refresh"><i class="fa fa-arrows-rotate fa-fw fa-lg"></i> {{ __('Refresh') }}</a></li>
+                                <li><a href="#"><span class="countdown_timer_status" id="countdown_timer_status"></span></a></li>
                             </ul>
                         </li>
-                        <li role="presentation" class="divider" id="countdown_timer_divider" style="display: none"></li>
+                        <li role="presentation" class="divider"></li>
+                        @endif
                         <li><a href="{{ url('about') }}"><i class="fa-solid fa-circle-info fa-fw fa-lg"
                                                             aria-hidden="true"></i> {{ __('About :project_name', ['project_name' => \LibreNMS\Config::get('project_name')]) }}
                             </a></li>
                     </ul>
                 </li>
             </ul>
         </div>
     </div>
 </nav>
 <script>

--- a/resources/views/map/availability.blade.php
+++ b//dev/null
@@ -1,242 +0,0 @@
-@extends('layouts.librenmsv1')
-@section('title', __('Availability Map'))
-@section('content')
-    <div class="container-fluid">
-        <div class="row">
-            <div class="col-md-12">
-                <div class="page-availability-title-left">
-                    <span class="page-availability-title">Availability map for</span>
-                    <select id="show_items" class="page-availability-report-select" name="show_items" onchange="refreshMap()">
-                        <option value="0" selected>only devices</option>
-@if($services)
-                        <option value="1" >only services</option>
-                        <option value="2" >devices and services</option>
-@endif
-                    </select>
-                </div>
-@if($use_groups)
-                <div class="page-availability-title-right">
-                    <span class="page-availability-title">Device group</span>
-                    <select id="show_group" class="page-availability-report-select" name="show_group" onchange="refreshMap()">
-                        <option value="0" selected>show all devices</option>
-@foreach($devicegroups as $g)
-                        <option value="{{$g['id']}}">{{$g['name']}}</option>
-@endforeach
-                    </select>
-                </div>
-@endif
-            </div>
-        </div>
-        <div class="row">
-            <div class="col-md-12">
-                <div class="page-availability-title-right" style="float: right">
-                    <div class="page-availability-report-host" id="devices-summary" style="display:none">
-                        <span>Total hosts</span>
-                        <span class="label label-success label-font-border label-border" id="devices-up"></span>
-                        <span class="label label-warning label-font-border label-border" id="devices-warn"></span>
-                        <span class="label label-danger label-font-border label-border" id="devices-down"></span>
-                    </div>
-                    <div class="page-availability-report-host" id="services-summary" style="display:none">
-                        <span>Total services</span>
-                        <span class="label label-success label-font-border label-border" id="services-up"></span>
-                        <span class="label label-warning label-font-border label-border" id="services-warn"></span>
-                        <span class="label label-danger label-font-border label-border" id="services-down"></span>
-                    </div>
-                </div>
-            </div>
-        </div>
-        <div class="row">
-            <div class="col-md-12">
-                <div id="device-list"></div>
-            </div>
-        </div>
-        <div class="row">
-            <div class="col-md-12">
-                <div id="service-list"></div>
-            </div>
-        </div>
-    </div>
-@endsection
-@section('javascript')
-@endsection
-@section('scripts')
-<script>
-    function refreshMap() {
-        group = null;
-        if ($("#show_group").val()) {
-            group = $("#show_group").val();
-        }
-        if ($("#show_items").val() == 0 || $("#show_items").val() == 2) {
-            $.post( '{{ route('maps.getdevices') }}', {disabled: 0, disabled_alerts: null, group: group})
-                .done(function( data ) {
-                    var host_warn_count = 0;
-                    var host_up_count = 0;
-                    var host_down_count = 0;
-                    var host_maintenance_count = 0;
-                    function deviceSort(a,b) {
-@if($sort == 'hostname')
-                        return (data[a]["sname"] > data[b]["sname"]) ? 1 : -1;
-@elseif($sort == 'status')
-                        return (data[a]["status"] > data[b]["status"]) ? 1 : -1;
-@else
-                        return 0;
-@endif
-                    }
-                    var keys = Object.keys(data).sort(deviceSort);
-                    var devicelist = document.createElement("div");
-                    $.each( keys, function( key_idx, device_id ) {
-                        var device = data[device_id];
-                        var state, fullclass, compactclass;
-                        if (device['status']) {
-                            if (device['uptime'] && (device['uptime'] < {{$uptime_warn}})) {
-                                state = 'warn';
-                                fullclass = 'label-warning';
-                                compactclass = 'availability-map-oldview-box-warn';
-                                host_warn_count++;
-                            } else {
-                                state = 'up';
-                                fullclass = 'label-success';
-                                compactclass = 'availability-map-oldview-box-up';
-                                host_up_count++;
-                            }
-                        } else if (device['maintenance']) {
-                            state = 'alert-disabled';
-                            fullclass = 'label-default';
-                            compactclass = 'availability-map-oldview-box-ignored';
-                            host_maintenance_count++;
-                        } else {
-                            state = 'down';
-                            fullclass = 'label-danger';
-                            compactclass = 'availability-map-oldview-box-down';
-                            host_down_count++;
-                        }
-                        var devhtml = document.createElement("a");
-                        devhtml.href = device["url"];
-                        devhtml.title = device["sname"] + ' - ' + device["updowntime"];
-                    @if($compact)
-                        var devcompact = document.createElement("div");
-                        devcompact.classList.add(compactclass);
-                        devhtml.appendChild(devcompact);
-                    @else
-                        var devfull = document.createElement("div");
-                        devfull.style.overflow = "hidden";
-                        devfull.classList.add("device-availability", state);
-                        devfull.style.width = "{{ $box_size }}px";
-                        var devstatelabel = document.createElement("span");
-                        devstatelabel.classList.add("availability-label", "label", fullclass, "label-font-border");
-                        devstatelabel.textContent = state;
-                        devfull.appendChild(devstatelabel);
-                        var devicon = document.createElement("span");
-                        devicon.classList.add("device-icon");
-                        devicon.title = device["icontitle"];
-                        devfull.appendChild(devicon);
-                        var deviconimage = document.createElement("img");
-                        deviconimage.src = device["icon"];
-                        devicon.appendChild(deviconimage);
-                        devfull.appendChild(document.createElement("br"));
-                        var devname = document.createElement("span");
-                        devname.classList.add("small");
-                        devname.textContent = device["sname"];
-                        devfull.appendChild(devname);
-                        devhtml.appendChild(devfull);
-                    @endif
-                        devicelist.appendChild(devhtml);
-                    });
-                    document.getElementById("device-list").innerHTML = devicelist.innerHTML;
-                    $("#devices-up").text('up: ' + host_up_count);
-                    $("#devices-warn").text('warn: ' + host_warn_count);
-                    $("#devices-down").text('down: ' + host_down_count);
-                    $("#devices-summary").show();
-                });
-        } else {
-            $("#device-list").html("");
-            $("#devices-summary").hide();
-        }
-        if ($("#show_items").val() == 1 || $("#show_items").val() == 2) {
-            $.post( '{{ route('maps.getservices') }}', {disabled: 0, disabled_alerts: null, device_group: group})
-                .done(function( data ) {
-                    var service_warn_count = 0;
-                    var service_up_count = 0;
-                    var service_down_count = 0;
-                    function serviceSort(a,b) {
-@if($sort == 'hostname')
-                        return (a["device_name"] > b["device_name"]) ? 1 : -1;
-@elseif($sort == 'status')
-                        return (a["status"] > b["status"]) ? 1 : -1;
-@else
-                        return 0;
-@endif
-                    }
-                    var services = data.sort(serviceSort);
-                    var servicelist = document.createElement("div");
-                    $.each( services, function( svc_idx, service ) {
-                        var fullclass,compactclass,state;
-                        if (service['status'] == 0) {
-                            fullclass = 'label-success';
-                            compactclass = 'availability-map-oldview-box-up';
-                            state = 'up';
-                            service_up_count++;
-                        } else if (service['status'] == 1) {
-                            fullclass = 'label-warning';
-                            compactclass = 'availability-map-oldview-box-warn';
-                            state = 'warn';
-                            service_warn_count++;
-                        } else {
-                            fullclass = 'label-danger';
-                            compactclass = 'availability-map-oldview-box-down';
-                            state = 'down';
-                            service_down_count++;
-                        }
-                        var svchtml = document.createElement("a");
-                        svchtml.href = service["url"];
-                        svchtml.title = service["device_name"] + ' - ' + service["updowntime"];
-                    @if($compact)
-                        var svccompact = document.createElement("div");
-                        svccompact.classList.add(compactclass);
-                        svchtml.appendChild(svccompact);
-                    @else
-                        var svcfull = document.createElement("div");
-                        svcfull.style.overflow = "hidden";
-                        svcfull.classList.add("service-availability", state);
-                        svcfull.style.width = "{{ $box_size }}px";
-                        var svctypelabel = document.createElement("span");
-                        svctypelabel.classList.add("service-name-label", "label", fullclass, "label-font-border");
-                        svctypelabel.textContent = service["type"];
-                        svcfull.appendChild(svctypelabel);
-                        var svcstatelabel = document.createElement("span");
-                        svcstatelabel.classList.add("availability-label", "label", fullclass, "label-font-border");
-                        svcstatelabel.textContent = state;
-                        svcfull.appendChild(svcstatelabel);
-                        var svcicon = document.createElement("span");
-                        svcicon.classList.add("device-icon");
-                        svcfull.appendChild(svcicon);
-                        var svciconimage = document.createElement("img");
-                        svciconimage.src = service["icon"];
-                        svciconimage.title = service["icontitle"];
-                        svcicon.appendChild(svciconimage);
-                        svcfull.appendChild(document.createElement("br"));
-                        var svcname = document.createElement("span");
-                        svcname.classList.add("small");
-                        svcname.textContent = service["device_name"];
-                        svcfull.appendChild(svcname);
-                        svchtml.appendChild(svcfull);
-                    @endif
-                        servicelist.appendChild(svchtml);
-                    });
-                    document.getElementById("service-list").innerHTML = servicelist.innerHTML;
-                    $("#services-up").text('up: ' + service_up_count);
-                    $("#services-warn").text('warn: ' + service_warn_count);
-                    $("#services-down").text('down: ' + service_down_count);
-                    $("#services-summary").show();
-                });
-        } else {
-            $("#service-list").html("");
-            $("#service-summary").hide();
-        }
-    }
-    $(document).ready(function () {
-        refreshMap();
-    });
-</script>
-<x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
-@endsection

--- a/resources/views/map/custom-background-modal.blade.php
+++ b/resources/views/map/custom-background-modal.blade.php
@@ -174,25 +174,11 @@
                 });
                 startBackgroundMapAdjust();
                 $('#bgModal').modal('hide');
             },
             closeBackgroundModal() {
                 $('#bgModal').modal('hide');
                 this.resetBackground();
             }
         }
     }
-    function startBackgroundMapAdjust() {
-        $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').hide();
-        $('#map-bgEndAdjustButton').show();
-    }
-    function endBackgroundMapAdjust() {
-        $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').show();
-        $('#map-bgEndAdjustButton').hide();
-        document.getElementById('custom-map-bg-geo-map').style.zIndex = '1';
-        const leaflet = get_map('custom-map-bg-geo-map');
-        if (leaflet) {
-            disable_map_interaction(leaflet)
-        }
-        editMapBackground();
-    }
 </script>

--- a/resources/views/map/custom-edge-modal.blade.php
+++ b/resources/views/map/custom-edge-modal.blade.php
@@ -1,52 +1,52 @@
 <div class="modal fade" id="edgeModal" tabindex="-1" role="dialog" aria-labelledby="edgeModalLabel" aria-hidden="true">
     <div class="modal-dialog" role="document">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title" id="edgeModalLabel">{{ __('map.custom.edit.edge.new') }}</h5>
             </div>
             <div class="modal-body">
                 <div class="row">
                     <div class="col-md-12">
                         <div class="well well-lg">
-                            <div class="form-group row existing-edge" id="divEdgeFrom">
+                            <div class="form-group row" id="divEdgeFrom">
                                 <label for="edgefrom" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.from') }}</label>
                                 <div class="col-sm-9">
                                     <select id="edgefrom" class="form-control input-sm">
                                     </select>
                                 </div>
                             </div>
-                            <div class="form-group row existing-edge" id="divEdgeTo">
+                            <div class="form-group row" id="divEdgeTo">
                                 <label for="edgeto" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.to') }}</label>
                                 <div class="col-sm-9">
                                     <select id="edgeto" class="form-control input-sm">
                                     </select>
                                 </div>
                             </div>
-                            <div class="form-group row existing-edge" id="edgePortSearchRow" style="display:none">
+                            <div class="form-group row single-node" id="edgePortSearchRow" style="display:none">
                                 <label for="portsearch" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.port_select') }}</label>
                                 <div class="col-sm-9">
                                     <select name="portsearch" id="portsearch" class="form-control"></select>
                                 </div>
                             </div>
-                            <div class="form-group row existing-edge" id="edgePortRow" style="display:none">
+                            <div class="form-group row" id="edgePortRow" style="display:none">
                                 <label for="portclear" class="col-sm-3 control-label">{{ __('Port') }}</label>
                                 <div class="col-sm-7">
                                     <div id="port_name">
                                     </div>
                                     <input type="hidden" id="port_id">
                                 </div>
                                 <div class="col-sm-2">
                                     <button type=button class="btn btn-primary" value="save" id="portclear" onclick="edgePortClear();">{{ __('Clear') }}</button>
                                 </div>
                             </div>
-                            <div class="form-group row existing-edge" id="edgePortReverseRow" style="display:none">
+                            <div class="form-group row" id="edgePortReverseRow" style="display:none">
                                 <label for="portreverse" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.reverse') }}</label>
                                 <div class="col-sm-9">
                                     <input class="form-check-input" type="checkbox" role="switch" id="portreverse">
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="edgestyle" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.style') }}</label>
                                 <div class="col-sm-9">
                                     <select id="edgestyle" class="form-control input-sm">
                                         <option value="dynamic">{{ __('map.custom.edit.edge.style_options.dynamic') }}</option>
@@ -55,42 +55,36 @@
                                         <option value="diagonalCross">{{ __('map.custom.edit.edge.style_options.diagonalCross') }}</option>
                                         <option value="straightCross">{{ __('map.custom.edit.edge.style_options.straightCross') }}</option>
                                         <option value="horizontal">{{ __('map.custom.edit.edge.style_options.horizontal') }}</option>
                                         <option value="vertical">{{ __('map.custom.edit.edge.style_options.vertical') }}</option>
                                         <option value="curvedCW">{{ __('map.custom.edit.edge.style_options.curvedCW') }}</option>
                                         <option value="curvedCCW">{{ __('map.custom.edit.edge.style_options.curvedCCW') }}</option>
                                         <option value="cubicBezier">{{ __('map.custom.edit.edge.style_options.cubicBezier') }}</option>
                                     </select>
                                 </div>
                             </div>
-                            <div class="form-group row">
+                            <div class="form-group row single-node">
                                 <label for="edgetextshow" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.show_usage_percent') }}</label>
                                 <div class="col-sm-9">
                                     <input class="form-check-input" type="checkbox" role="switch" id="edgetextshow">
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="edgebpsshow" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.show_usage_bps') }}</label>
                                 <div class="col-sm-9">
                                     <input class="form-check-input" type="checkbox" role="switch" id="edgebpsshow">
                                 </div>
                             </div>
-                            <div class="form-group row existing-edge">
+                            <div class="form-group row">
                                 <label for="edgelabel" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.label') }}</label>
                                 <div class="col-sm-9">
                                     <input type=text id="edgelabel" class="form-control input-sm" value="" />
-                                </div>
-                            </div>
-                            <div class="form-group row">
-                                <label for="edgefixedwidth" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.fixed_width') }}</label>
-                                <div class="col-sm-9">
-                                    <input type=number id="edgefixedwidth" class="form-control input-sm" placeholder="{{ __('map.custom.edit.edge.dynamic_width')  }}" step="0.1" />
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="edgetextface" class="col-sm-3 control-label">{{ __('map.custom.edit.text_font') }}</label>
                                 <div class="col-sm-9">
                                     <input type=text id="edgetextface" class="form-control input-sm" value="arial" />
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="edgetextsize" class="col-sm-3 control-label">{{ __('map.custom.edit.text_size') }}</label>
@@ -102,225 +96,34 @@
                                 <label for="edgetextcolour" class="col-sm-3 control-label">{{ __('map.custom.edit.text_color') }}</label>
                                 <div class="col-sm-2">
                                     <input type=color id="edgetextcolour" class="form-control input-sm" value="#343434" onchange="$('#edgecolourtextreset').removeAttr('disabled');" />
                                 </div>
                                 <div class="col-sm-5">
                                 </div>
                                 <div class="col-sm-2">
                                     <button type=button class="btn btn-primary" value="reset" id="edgecolourtextreset" onclick="$('#edgetextcolour').val(newedgeconf.font.color); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
                                 </div>
                             </div>
-                            <div class="form-group row existing-edge" id="edgeRecenterRow">
+                            <div class="form-group row" id="edgeRecenterRow">
                                 <label for="edgerecenter" class="col-sm-3 control-label">{{ __('map.custom.edit.edge.recenter') }}</label>
                                 <div class="col-sm-9">
                                     <input type=checkbox class="form-check-input" value="recenter" id="edgerecenter">
                                 </div>
                             </div>
                             <div class="row">
                                 <div class="col-sm-12" id="saveedge-alert">
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <center>
-                    <button type=button class="btn btn-primary new-edge" value="savedefaults" id="edge-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="edgeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
-                    <button type=button class="btn btn-primary existing-edge" value="save" id="edge-saveButton" data-dismiss="modal">{{ __('Save') }}</button>
-                    <button type=button class="btn btn-primary" value="cancel" id="edge-cancelButton" data-dismiss="modal" onclick="edgeCancel();">{{ __('Cancel') }}</button>
+                    <button type=button class="btn btn-primary" value="savedefaults" id="edge-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="editEdgeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
+                    <button type=button class="btn btn-primary" value="save" id="edge-saveButton" data-dismiss="modal">{{ __('Save') }}</button>
+                    <button type=button class="btn btn-primary" value="cancel" id="edge-cancelButton" data-dismiss="modal" onclick="editEdgeCancel();">{{ __('Cancel') }}</button>
                 </center>
             </div>
         </div>
     </div>
 </div>
-<script>
-    var port_search_device_id_1 = 0;
-    var port_search_device_id_2 = 0;
-    function edgeCheckColourReset(itemColour, defaultColour, resetControlId) {
-        if(!itemColour || itemColour.toLowerCase() == defaultColour.toLowerCase()) {
-            $("#" + resetControlId).attr('disabled','disabled');
-        } else {
-            $("#" + resetControlId).removeAttr('disabled');
-        }
-    }
-    function edgePortClear() {
-        $("#portsearch").val('');
-        $("#portsearch").trigger('change');
-        $("#port_id").val("");
-        $("#port_name").text("");
-        $("#edgePortSearchRow").show();
-        $("#edgePortRow").hide();
-        $("#edgePortReverseRow").hide();
-    }
-    function edgePortSelect(e) {
-        var id = e.params.data.id;
-        var name = e.params.data.text;
-        var reverse = e.params.data.device_id != port_search_device_id_1;
-        $("#port_id").val(id);
-        $("#port_name").text(name);
-        $("#portreverse").bootstrapSwitch('state', reverse);
-        $("#edgePortSearchRow").hide();
-        $("#edgePortRow").show();
-        $("#edgePortReverseRow").show();
-    }
-    function edgeSave(event) {
-        edgedata = event.data.data;
-        edgeNodesUpdate(edgedata.id, $("#edgefrom").val(), $("#edgeto").val(), edgedata.edge1.from, edgedata.edge2.from);
-        $("#edge-saveButton").off("click");
-        edgedata.edge1.smooth.type = $("#edgestyle").val();
-        edgedata.edge2.smooth.type = $("#edgestyle").val();
-        edgedata.edge1.from = $("#edgefrom").val();
-        edgedata.edge2.from = $("#edgeto").val();
-        edgedata.edge1.font.face = edgedata.edge2.font.face = $("#edgetextface").val();
-        edgedata.edge1.font.size = edgedata.edge2.font.size = $("#edgetextsize").val();
-        edgedata.edge1.font.color = edgedata.edge2.font.color = $("#edgetextcolour").val();
-        edgedata.edge1.label = edgedata.edge2.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), null);
-        edgedata.edge1.width = edgedata.edge2.width = parseFloat($("#edgefixedwidth").val()) || null;
-        edgedata.edge1.title = edgedata.edge2.title = $("#port_id").val();
-        let newlabel = $("#edgelabel").val() || '';
-        if (newlabel == '' && edgedata.mid.label != '') {
-            $("#map-renderButton").show();
-        }
-        edgedata.mid.label = newlabel;
-        if(edgedata.id) {
-            if($("#port_id").val()) {
-                edge_port_map[edgedata.id] = {port_id: $("#port_id").val(), port_name: $("#port_name").text(), reverse: $("#portreverse")[0].checked}
-            } else {
-                delete edge_port_map[edgedata.id];
-            }
-        }
-        if(edgedata.edge2.smooth.type == "curvedCW") {
-            edgedata.edge2.smooth.type = "curvedCCW";
-        } else if (edgedata.edge2.smooth.type == "curvedCCW") {
-            edgedata.edge2.smooth.type = "curvedCW";
-        }
-        if(edgedata.add) {
-            network_nodes.add([edgedata.mid]);
-            network_nodes.flush();
-            network_edges.add([edgedata.edge1, edgedata.edge2]);
-            network_edges.flush();
-        } else {
-            network_edges.update([edgedata.edge1, edgedata.edge2]);
-            network_nodes.update([edgedata.mid]);
-            if($("#edgerecenter").is(":checked")) {
-                var pos = network.getPositions([edgedata.edge1.from, edgedata.edge2.from]);
-                const mid_pos = getMidPos(edgedata.id, edgedata.edge1.from, edgedata.edge2.from);
-                edgedata.mid.x = mid_pos.x;
-                edgedata.mid.y = mid_pos.y;
-                network_nodes.update([edgedata.mid]);
-                $("#map-renderButton").show();
-            }
-            if(! edgedata.edge1.label) {
-                network_edges.flush();
-                network.selectEdges([edgedata.edge2.id]);
-                network.redraw();
-                network.selectEdges([edgedata.edge1.id]);
-            }
-        }
-        $("#edgerecenter").prop( "checked", false );
-        $("#map-saveDataButton").show();
-    }
-    function edgeEditDefaults() {
-        $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.defaults_title') }}');
-        $("#edgestyle").val(newedgeconf.smooth.type);
-        $("#edgefixedwidth").val(newedgeconf.width);
-        $("#edgetextface").val(newedgeconf.font.face);
-        $("#edgetextsize").val(newedgeconf.font.size);
-        $("#edgetextcolour").val(newedgeconf.font.color);
-        $("#edgetextshow").bootstrapSwitch('state', (newedgeconf.label.includes('xx%') || newedgeconf.label.includes('true')));
-        $("#edgebpsshow").bootstrapSwitch('state', (newedgeconf.label.includes('bps')));
-        $('#edgecolourtextreset').attr('disabled', 'disabled');
-        $(".existing-edge").hide();
-        $(".new-edge").show();
-        $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
-    }
-    function edgeEdit(edgedata) {
-        if(edgedata.add) {
-            $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.add') }}');
-        } else {
-            $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.edit') }}');
-        }
-        $("#portsearch").val('');
-        $("#portsearch").trigger('change');
-        var nodes = network_nodes.get({
-          fields: ['id', 'label'],
-          filter: function (item) {
-            return (!item.id.endsWith("_mid"));
-          },
-        });
-        $("#edgefrom").find('option').remove().end();
-        $("#edgeto").find('option').remove().end();
-        $.each( nodes, function( node_idx, node ) {
-            if (! node.id.endsWith('_mid') && ! node.id.startsWith("legend_")) {
-                $("#edgefrom").append('<option value="' + node.id + '">' + node.label+ '</option>');
-                $("#edgeto").append('<option value="' + node.id + '">' + node.label+ '</option>');
-            }
-        });
-        $("#edgefrom").val(edgedata.edge1.from);
-        $("#edgeto").val(edgedata.edge2.from);
-        edgePortSearchUpdate($("#edgefrom").val(), $("#edgeto").val(), edgedata.id);
-        edgeCheckColourReset(edgedata.edge1.font.color, newedgeconf.font.color, "edgecolourtextreset");
-        $("#edgestyle").val(edgedata.edge1.smooth.type);
-        $("#edgetextface").val(edgedata.edge1.font.face);
-        $("#edgetextsize").val(edgedata.edge1.font.size);
-        $("#edgetextcolour").val(edgedata.edge1.font.color);
-        $("#edgetextshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('xx%')));
-        $("#edgebpsshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('bps')));
-        $("#edgelabel").val('label' in edgedata.mid ? edgedata.mid.label : '');
-        $("#edgefixedwidth").val(edgedata.edge1.width);
-        $(".existing-edge").show();
-        $(".new-edge").hide();
-        $("#edge-saveButton").on("click", {data: edgedata}, edgeSave);
-        $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
-    }
-    function edgePortSearchUpdate(node1_id, node2_id, edge_id) {
-        node1 = network_nodes.get(node1_id);
-        node2 = network_nodes.get(node2_id);
-        if(isNaN(node1.title) && isNaN(node2.title)) {
-            $("#port_id").val("");
-            $("#edgePortRow").hide();
-            $("#edgePortReverseRow").hide();
-            $("#edgePortSearchRow").hide();
-            return;
-        }
-        if(edge_id in edge_port_map) {
-            $("#port_id").val(edge_port_map[edge_id].port_id);
-            $("#port_name").text(edge_port_map[edge_id].port_name);
-            $("#portreverse").bootstrapSwitch('state', edge_port_map[edge_id].reverse);
-            $("#edgePortRow").show();
-            $("#edgePortReverseRow").show();
-            $("#edgePortSearchRow").hide();
-        } else {
-            $("#port_id").val("");
-            $("#portreverse").bootstrapSwitch('state', false);
-            $("#edgePortRow").hide();
-            $("#edgePortReverseRow").hide();
-            $("#edgePortSearchRow").show();
-        }
-        port_search_device_id_1 = (node1.id in node_device_map) ? node_device_map[node1.id].device_id : 0;
-        port_search_device_id_2 = (node2.id in node_device_map) ? node_device_map[node2.id].device_id : 0;
-    }
-    function edgeCancel(event) {
-        $("#edge-saveButton").off("click");
-    }
-    function edgeDefaultsSave() {
-        newedgeconf.smooth.type = $("#edgestyle").val();
-        newedgeconf.font.face = $("#edgetextface").val();
-        newedgeconf.font.size = $("#edgetextsize").val();
-        newedgeconf.font.color = $("#edgetextcolour").val();
-        newedgeconf.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), '');
-        newedgeconf.width = parseFloat($("#edgefixedwidth").val()) || null;
-        $("#map-saveDataButton").show();
-    }
-    $(document).ready(function () {
-        init_select2('#portsearch', 'port', function(params) {
-            return {
-                limit: 100,
-                devices: [port_search_device_id_1, port_search_device_id_2],
-                term: params.term,
-                page: params.page || 1
-            }
-        }, '', '{{ __('map.custom.edit.edge.port_select') }}', {dropdownParent: $('#edgeModal')});
-        $("#portsearch").on("select2:select", edgePortSelect);
-   });
-</script>

--- a/resources/views/map/custom-edit.blade.php
+++ b/resources/views/map/custom-edit.blade.php
@@ -1,28 +1,26 @@
 @extends('layouts.librenmsv1')
 @section('title', __('map.custom.title.edit'))
 @section('content')
 @include('map.custom-background-modal')
 @include('map.custom-node-modal')
 @include('map.custom-edge-modal')
 @include('map.custom-map-modal')
-@include('map.custom-legend-modal')
 @include('map.custom-map-list-modal')
 <div class="container-fluid">
   <div class="row" id="control-row">
     <div class="col-md-5">
       <button type=button value="mapedit" id="map-editButton" class="btn btn-primary" onclick="editMapSettings()">{{ __('map.custom.edit.map.edit') }}</button>
       <button type=button value="mapbg" id="map-bgButton" class="btn btn-primary" onclick="editMapBackground()">{{ __('map.custom.edit.bg.title') }}</button>
       <button type=button value="mapbg" id="map-bgEndAdjustButton" class="btn btn-primary" onclick="endBackgroundMapAdjust()" style="display:none">{{ __('map.custom.edit.bg.adjust_map_finish') }}</button>
-      <button type=button value="editnodedefaults" id="map-nodeDefaultsButton" class="btn btn-primary" onclick="nodeEdit(newnodeconf)">{{ __('map.custom.edit.node.edit_defaults') }}</button>
-      <button type=button value="editedgedefaults" id="map-edgeDefaultsButton" class="btn btn-primary" onclick="edgeEditDefaults()">{{ __('map.custom.edit.edge.edit_defaults') }}</button>
-      <button type=button value="togglelegend" id="map-legendToggleButton" class="btn btn-primary" onclick="toggleLegend()">{{ __('map.custom.edit.map.legend_toggle') }}</button>
+      <button type=button value="editnodedefaults" id="map-nodeDefaultsButton" class="btn btn-primary" onclick="editNodeDefaults()">{{ __('map.custom.edit.node.edit_defaults') }}</button>
+      <button type=button value="editedgedefaults" id="map-edgeDefaultsButton" class="btn btn-primary" onclick="editEdgeDefaults()">{{ __('map.custom.edit.edge.edit_defaults') }}</button>
     </div>
     <div class="col-md-2">
       <center>
           <h4><a id="title" href="{{ route('maps.custom.show', $map_id) }}">{{ $name }}</a></h4>
       </center>
     </div>
     <div class="col-md-5 text-right">
       <button type=button value="maprender" id="map-renderButton" class="btn btn-primary" style="display: none" onclick="CreateNetwork();">{{ __('map.custom.edit.map.rerender') }}</button>
       <button type=button value="mapsave" id="map-saveDataButton" class="btn btn-primary" style="display: none" onclick="saveMapData();">{{ __('map.custom.edit.map.save') }}</button>
       <button type=button value="maplist" id="map-listButton" class="btn btn-primary" onclick="mapList();">{{ __('map.custom.edit.map.list') }}</button>
@@ -80,21 +78,21 @@
     var bgtype = {{ Js::from($background_type) }};
     var bgdata = {{ Js::from($background_config) }};
     var network;
     var network_height;
     var network_width;
     var network_nodes = new vis.DataSet({queue: {delay: 100}});
     var network_edges = new vis.DataSet({queue: {delay: 100}});
     var edge_nodes_map = [];
     var node_device_map = {};
     var custom_image_base = "{{ $base_url }}images/custommap/icons/";
-    var network_options = {{ Js::from($map_conf) }};
+    var network_options = {{ Js::from($map_conf) }}
     function edgeNodesRemove(nm_id, edgeid) {
         if (nm_id in edge_nodes_map) {
             const edge_idx = edge_nodes_map[nm_id].indexOf(edgeid);
             if (edge_idx >= 0) {
                 edge_nodes_map[nm_id].splice(edge_idx, 1);
             }
         }
     }
     function edgeNodesUpdate(edgeid, node1_id, node2_id, old_node1_id, old_node2_id) {
         var nm_id = node1_id < node2_id ? node1_id + '.' + node2_id : node2_id + '.' + node1_id;
@@ -182,31 +180,35 @@
         }
         return move;
     }
     function CreateNetwork() {
         network_nodes.flush();
         network_edges.flush();
         var container = document.getElementById('custom-map');
         var options = network_options;
         options['manipulation']['addNode'] = function (data, callback) {
                 callback(null);
+                $("#nodeModalLabel").text('{{ __('map.custom.edit.node.add') }}');
                 var node = structuredClone(newnodeconf);
                 node.id = "new" + newcount++;
                 node.label = "New Node";
                 node.x = node_align ? Math.round(data.x / node_align) * node_align : data.x;
                 node.y = node_align ? Math.round(data.y / node_align) * node_align : data.y;
                 node.add = true;
-                nodeEdit(node);
+                $(".single-node").show();
+                editNode(node, editNodeSave);
             }
         options['manipulation']['editNode'] = function (data, callback) {
                 callback(null);
-                checkEditNode(data);
+                $("#nodeModalLabel").text('{{ __('map.custom.edit.node.edit') }}');
+                $(".single-node").show();
+                editNode(data, editNodeSave);
             }
         options['manipulation']['deleteNode'] = function (data, callback) {
                 callback(null);
                 $.each( data.edges, function( edge_idx, edgeid ) {
                     edgeid = edgeid.split("_")[0];
                     deleteEdge(edgeid);
                 });
                 $.each( data.nodes, function( node_idx, nodeid ) {
                     network_nodes.remove(nodeid);
                     network_nodes.flush();
@@ -232,21 +234,22 @@
                 var mid = {id: edgeid + "_mid", shape: "dot", size: 3, x: mid_x, y: mid_y, label: ''};
                 var edge1 = structuredClone(newedgeconf);
                 edge1.id = edgeid + "_from";
                 edge1.from = data.from;
                 edge1.to = edgeid + "_mid";
                 var edge2 = structuredClone(newedgeconf);
                 edge2.id = edgeid + "_to";
                 edge2.from = data.to;
                 edge2.to = edgeid + "_mid";
                 var edgedata = {id: edgeid, mid: mid, edge1: edge1, edge2: edge2, add: true}
-                edgeEdit(edgedata);
+                $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.add') }}');
+                editEdge(edgedata, editEdgeSave);
             }
         options['manipulation']['editEdge'] = { editWithoutDrag: editExistingEdge };
         options['manipulation']['deleteEdge'] = function (data, callback) {
             callback(null);
             $.each( data.edges, function( edge_idx, edgeid ) {
                 edgeid = edgeid.split("_")[0];
                 deleteEdge(edgeid);
             });
         };
         network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, options);
@@ -256,21 +259,21 @@
         var centreX = Math.round(network_width / 2);
         network.moveTo({position: {x: centreX, y: centreY}, scale: 1});
         setCustomMapBackground('custom-map', bgtype, bgdata);
         network.on('doubleClick', function (properties) {
             edge_id = null;
             if (properties.nodes.length > 0) {
                 node_id = properties.nodes[0];
                 node = network_nodes.get(node_id);
                 $("#nodeModalLabel").text('{{ __('map.custom.edit.node.edit') }}');
                 $(".single-node").show();
-                checkEditNode(node);
+                editNode(node, editNodeSave);
             } else if (properties.edges.length > 0) {
                 edge_id = properties.edges[0].split("_")[0];
                 edge = network_edges.get(edge_id + "_to");
                 editExistingEdge(edge, null);
             }
         });
         network.on('dragEnd', function (data) {
             if(data.edges.length > 0 || data.nodes.length > 0) {
                 nodepos = network.getPositions(data.nodes);
                 $.each( nodepos, function( nodeid, node ) {
@@ -294,20 +297,22 @@
             }
         });
         $("#map-renderButton").hide();
     }
     function editMapSettings() {
         $('#mapModal').modal({backdrop: 'static', keyboard: false}, 'show');
     }
     var newedgeconf = @json($newedge_conf);
     var newnodeconf = @json($newnode_conf);
     var newcount = 1;
+    var port_search_device_id_1 = 0;
+    var port_search_device_id_2 = 0;
     if (!("label" in newedgeconf)) {
         newedgeconf.label = "xx%";
     } else if (newedgeconf.label == null) {
         newedgeconf.label = "xx%";
     } else if (typeof(newedgeconf.label) == 'boolean') {
         newedgeconf.label = newedgeconf.label ? "xx%" : "";
     }
     var edge_port_map = {};
     function mapList() {
         if($("#map-saveDataButton").is(":visible")) {
@@ -336,120 +341,83 @@
         if (pct < 0) {
             return "black";
         } else if (pct < 50) {
             return '#' + parseInt(5.1 * pct).toString(16).padStart(2, 0) + 'ff00';
         } else if (pct < 100) {
             return '#ff' + parseInt(5.1 * (100.0 - pct)).toString(16).padStart(2, 0) + '00';
         } else if (pct < 150) {
             return '#ff00' + parseInt(5.1 * (pct - 100.0)).toString(16).padStart(2, 0);
         }
         return '#ff00ff';
-    }
-    function toggleLegend() {
-        var width = $("#mapwidth").val();
-        var mapwdith = 100;
-        if (!isNaN(width)) {
-            mapwidth = width;
-        } else if (width.includes("px")) {
-            mapwidth = width.replace("px", "");
-        } else if (width.includes("%")) {
-            mapwidth = window.innerWidth * width.replace("%", "") / 100;
-        }
-        if (legend.x < 0) {
-            legend.x = mapwidth - 50;
-            legend.y = 100;
-        } else {
-            legend.x = -1;
-            legend.y = -1;
-        }
-        redrawLegend();
     }
     function redrawLegend() {
         old_nodes = network_nodes.get({filter: function(node) { return node.id.startsWith("legend_") }});
         old_nodes.forEach((node) => {
             network_nodes.remove(node.id);
         });
         if (legend.x >= 0) {
             let y_pos = legend.y;
             let y_inc = legend.font_size + 10;
             let legend_header = {id: "legend_header", label: "<b>Legend</b>", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {multi: 'html', size: legend.font_size}, color: {background: "white"}};
             network_nodes.add(legend_header);
             y_pos += y_inc;
             if (!(Boolean(legend.hide_invalid))) {
-                let this_colour = 'black';
-                if(legend.colours) {
-                    this_colour = legend.colours['-1'];
-                }
-                let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "white"}, color: {background: this_colour}};
+                let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "white"}, color: {background: "black"}};
                 y_pos += y_inc;
                 network_nodes.add(legend_invalid);
             }
-            if(legend.colours) {
-                let i = 0;
-                Object.keys(legend.colours).sort((a,b) => parseInt(a) > parseInt(b)).forEach((pct_key) => {
-                    let this_pct = parseFloat(pct_key);
-                    if(!isNaN(this_pct) && this_pct >= 0.0) {
-                        let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "black"}, color: {background: legend.colours[pct_key]}};
-                        network_nodes.add(legend_step);
-                        y_pos += y_inc;
-                        i++;
-                    }
-                });
+            let pct_step;
+            if (Boolean(legend.hide_overspeed)) {
+                pct_step = 100.0 / (legend.steps - 1);
             } else {
-                let pct_step;
-                if (Boolean(legend.hide_overspeed)) {
-                    pct_step = 100.0 / (legend.steps - 1);
-                } else {
-                    pct_step = 150.0 / (legend.steps - 1);
-                }
-                for (let i=0; i < legend.steps; i++) {
-                    let this_pct = Math.round(pct_step * i);
-                    let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size:
- legend.font_size, color: "black"}, color: {background: legendPctColour(this_pct)}};
-                    network_nodes.add(legend_step);
-                    y_pos += y_inc;
-                }
+                pct_step = 150.0 / (legend.steps - 1);
+            }
+            for (let i=0; i < legend.steps; i++) {
+                let this_pct = Math.round(pct_step * i);
+                let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "black"}, color: {background: legendPctColour(this_pct)}};
+                network_nodes.add(legend_step);
+                y_pos += y_inc;
             }
             network_nodes.flush();
         }
     }
     function editMapSuccess(data) {
         $("#title").text(data.name);
         $("#savemap-alert").attr("class", "col-sm-12");
         $("#savemap-alert").text("");
         edge_sep = data.edge_separation;
         if(reverse_arrows != parseInt(data.reverse_arrows)) {
             swapArrows(Boolean(parseInt(data.reverse_arrows)));
         }
         reverse_arrows = parseInt(data.reverse_arrows);
+        redrawLegend();
         network_options.width = data.width;
         network_options.height = data.height;
         $("#custom-map-bg-geo-map").css('width', data.width).css('height', data.height);
         CreateNetwork();
-        $('#mapModal').modal('hide');
+        editMapCancel();
     }
     function editMapCancel() {
-        mapSettingsReset();
         $('#mapModal').modal('hide');
     }
     function saveMapData() {
         $("#map-saveDataButton").attr('disabled', 'disabled');
         var nodes = {};
         var edges = {};
         $.each(network_nodes.get(), function (node_idx, node) {
             if(node.id.startsWith("legend_")) {
                 return;
             } else if(node.id.endsWith("_mid")) {
                 edgeid = node.id.split("_")[0];
                 edge1 = network_edges.get(edgeid + "_from");
                 edge2 = network_edges.get(edgeid + "_to");
-                edges[edgeid] = {id: edgeid, text_colour: edge1.font.color, text_size: edge1.font.size, text_face: edge1.font.face, from: edge1.from, to: edge2.from, showpct: (edge1.label != null && edge1.label.includes("xx%")), showbps: (edge1.label != null && edge1.label.includes("bps")), label: (node.label || ''), fixed_width: (edge1.width || null), port_id: edge1.title, style: edge1.smooth.type, mid_x: node.x, mid_y: node.y, reverse: (edgeid in edge_port_map ? edge_port_map[edgeid].reverse : false)};
+                edges[edgeid] = {id: edgeid, text_colour: edge1.font.color, text_size: edge1.font.size, text_face: edge1.font.face, from: edge1.from, to: edge2.from, showpct: (edge1.label != null && edge1.label.includes("xx%")), showbps: (edge1.label != null && edge1.label.includes("bps")), label: (node.label || ''), port_id: edge1.title, style: edge1.smooth.type, mid_x: node.x, mid_y: node.y, reverse: (edgeid in edge_port_map ? edge_port_map[edgeid].reverse : false)};
             } else {
                 if(node.icon.code) {
                     node.icon = node.icon.code.charCodeAt(0).toString(16);
                 } else {
                     node.icon = null;
                 }
                 if("unselected" in node.image) {
                     if(node.image.unselected.indexOf(custom_image_base) == 0) {
                         node.image.unselected = node.image.unselected.replace(custom_image_base, "");
                     } else {
@@ -461,25 +429,20 @@
         });
         $.ajax({
             url: '{{ route('maps.custom.data.save', ['map' => $map_id]) }}',
             data: JSON.stringify({
                 newnodeconf: newnodeconf,
                 newedgeconf: newedgeconf,
                 nodes: nodes,
                 edges: edges,
                 legend_x: legend.x,
                 legend_y: legend.y,
-                legend_steps: legend.steps,
-                legend_font_size: legend.font_size,
-                legend_hide_invalid: legend.hide_invalid,
-                legend_hide_overspeed: legend.hide_overspeed,
-                legend_colours: legend.colours,
             }),
             contentType: "application/json",
             dataType: 'json',
             type: 'POST'
         }).done(function (data, status, resp) {
             $("#map-saveDataButton").hide();
             $("#alert-row").hide();
             refreshMap();
         }).fail(function (resp, status, error) {
             var data = resp.responseJSON;
@@ -492,65 +455,449 @@
                 alert_content.text('{{ __('map.custom.edit.map.save_error', ['code' => '?']) }}'.replace('?', resp.status));
                 alert_content.attr("class", "col-sm-12 alert alert-danger");
             }
         }).always(function (resp, status, error) {
             $("#map-saveDataButton").removeAttr('disabled');
         });
     }
     function editMapBackground() {
         $('#bgModal').modal('show');
     }
-    function checkEditNode(data) {
+    function nodeStyleChange() {
+        var nodestyle = $("#nodestyle").val();
+        if(nodestyle == 'icon') {
+            $("#nodeIconRow").show();
+        } else {
+            $("#nodeIconRow").hide();
+        }
+        if(nodestyle == 'image' || nodestyle == 'circularImage') {
+            $("#nodeImageRow").show();
+        } else {
+            $("#nodeImageRow").hide();
+        }
+    }
+    function nodeDeviceSelect(e) {
+        var id = e.params.data.id;
+        var name = e.params.data.text;
+        $("#device_id").val(id);
+        $("#device_name").text(name);
+        $("#nodelabel").val(name.split(".")[0].split(" ")[0]);
+        $("#device_image").val(e.params.data.icon);
+        $("#nodeDeviceSearchRow").hide();
+        $("#nodeMapLinkRow").hide();
+        $("#deviceiconimage").show();
+        $("#nodeDeviceRow").show();
+    }
+    function nodeDeviceClear() {
+        $("#devicesearch").val('');
+        $("#devicesearch").trigger('change');
+        $("#device_id").val("");
+        $("#device_name").text("");
+        $("#device_image").val("");
+        $("#nodeDeviceRow").hide();
+        $("#deviceiconimage").hide();
+        $("#nodeDeviceSearchRow").show();
+        $("#nodeMapLinkRow").show();
+        if(($("#nodestyle").val() == "image" || $("#nodestyle").val() == "circularImage") && !$("#nodeimage").val()){
+            $("#nodestyle").val(newnodeconf.shape);
+            $("#nodeImageRow").hide();
+            setNodeImage();
+        }
+    }
+    function nodeMapLinkChange() {
+        if($("#maplink").val()) {
+            $("#nodeDeviceSearchRow").hide();
+        } else {
+            $("#nodeDeviceSearchRow").show();
+        }
+    }
+    function setNodeImage() {
+        if($("#nodeimage option:selected").css('display') == 'none') {
+            $("#nodeimage").val($("#nodeimage option:eq(1)").val());
+        }
+        if($("#nodeimage").val()) {
+            $("#nodeimagepreview").attr("src", custom_image_base + $("#nodeimage").val());
+        } else {
+            $("#nodeimagepreview").attr("src", $("#device_image").val());
+        }
+    }
+    function setNodeIcon() {
+        var newcode = $("#nodeicon").val();
+        $("#nodeiconpreview").text(String.fromCharCode(parseInt(newcode, 16)));
+    }
+    function editNodeDefaults() {
+        $("#nodeModalLabel").text('{{ __('map.custom.edit.node.defaults_title') }}');
+        $(".single-node").hide();
+        var node = structuredClone(newnodeconf);
+        editNode(node, editNodeDefaultsSave);
+    }
+    function editNodeDefaultsSave() {
+        newnodeconf.shape = $("#nodestyle").val();
+        newnodeconf.font.face = $("#nodetextface").val();
+        newnodeconf.font.size = $("#nodetextsize").val();
+        newnodeconf.font.color = $("#nodetextcolour").val();
+        newnodeconf.color.background = $("#nodecolourbg").val();
+        newnodeconf.color.border = $("#nodecolourbdr").val();
+        if(newnodeconf.shape == "icon") {
+            newnodeconf.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: newnodeconf.color.border};
+        } else {
+            newnodeconf.icon = {};
+        }
+        if(newnodeconf.shape == "image" || newnodeconf.shape == "circularImage") {
+            newnodeconf.image = {unselected: custom_image_base + $("#nodeimage").val()};
+        } else {
+            delete newnodeconf.image;
+        }
+        $("#map-saveDataButton").show();
+    }
+    function checkColourReset(itemColour, defaultColour, resetControlId) {
+        if(!itemColour || itemColour.toLowerCase() == defaultColour.toLowerCase()) {
+            $("#" + resetControlId).attr('disabled','disabled');
+        } else {
+            $("#" + resetControlId).removeAttr('disabled');
+        }
+    }
+    function editNode(data, callback) {
+        $("#devicesearch").val('');
+        $("#devicesearch").trigger('change');
         if(data.id && isNaN(data.id)) {
             if(data.id.endsWith("_mid")) {
                 edge = network_edges.get((data.id.split("_")[0]) + "_to");
                 editExistingEdge(edge, null);
                 return;
             }
             if (data.id.startsWith("legend_") ) {
-                $('#mapLegendModal').modal({backdrop: 'static', keyboard: false}, 'show');
                 return;
             }
         }
-        nodeEdit(data);
+        if(data.id in node_device_map) {
+            $("#device_id").val(node_device_map[data.id].device_id);
+            $("#device_name").text(node_device_map[data.id].device_name);
+            $("#nodeDeviceSearchRow").hide();
+            $("#nodeMapLinkRow").hide();
+            $("#deviceiconimage").show();
+            $("#device_image").val(node_device_map[data.id].device_image);
+        } else {
+            $("#device_id").val("");
+            $("#device_name").text("");
+            $("#nodeDeviceRow").hide();
+            $("#deviceiconimage").hide();
+            $("#device_image").val("");
+        }
+        if(data.title && data.title.toString().startsWith("map:")) {
+            $("#nodeDeviceSearchRow").hide();
+            $("#maplink").val(data.title.replace("map:",""));
+        }
+        $("#nodelabel").val(data.label);
+        $("#nodestyle").val(data.shape);
+        if(data.shape == "image" || data.shape == "circularImage") {
+            $("#nodeImageRow").show();
+            if(data.image.unselected.indexOf(custom_image_base) == 0) {
+                $("#nodeimage").val(data.image.unselected.replace(custom_image_base, ""));
+            } else {
+                $("#nodeimage").val("");
+            }
+        } else {
+            $("#nodeImageRow").hide();
+            $("#nodeimage").val("");
+        }
+        setNodeImage();
+        if(data.shape == "icon") {
+            $("#nodeicon").val(data.icon.code.charCodeAt(0).toString(16));
+            $("#nodeIconRow").show();
+        } else {
+            $("#nodeIconRow").hide();
+        }
+        $("#nodesize").val(data.size);
+        $("#nodetextface").val(data.font.face);
+        $("#nodetextsize").val(data.font.size);
+        $("#nodetextcolour").val(data.font.color);
+        if(data.color && data.color.background) {
+            $("#nodecolourbg").val(data.color.background);
+            $("#nodecolourbdr").val(data.color.border);
+        } else {
+            $("#nodecolourbg").val(newnodeconf.color.background);
+            $("#nodecolourbdr").val(newnodeconf.color.border);
+        }
+        checkColourReset(data.font.color, newnodeconf.font.color, "nodecolourtextreset");
+        checkColourReset(data.color.background, newnodeconf.color.background, "nodecolourbgreset");
+        checkColourReset(data.color.border, newnodeconf.color.border, "nodecolourbdrreset");
+        if(data.id) {
+            $("#node-saveButton").on("click", {data: data}, callback);
+            $("#node-saveButton").show();
+            $("#node-saveDefaultsButton").hide();
+        } else {
+            $("#node-saveButton").hide();
+            $("#node-saveDefaultsButton").show();
+        }
+        $('#nodeModal').modal({backdrop: 'static', keyboard: false}, 'show');
+    }
+    function editNodeSave(event) {
+        node = event.data.data;
+        editNodeHide();
+        if($("#device_id").val()) {
+            node.title = $("#device_id").val();
+        } else if($("#maplink").val()) {
+            node.title = "map:" + $("#maplink").val();
+        } else {
+            node.title = '';
+        }
+        node.label = $("#nodelabel").val();
+        node.shape = $("#nodestyle").val();
+        node.font.face = $("#nodetextface").val();
+        node.font.size = parseInt($("#nodetextsize").val());
+        node.font.color = $("#nodetextcolour").val();
+        node.color = {highlight: {}, hover: {}};
+        node.color.background = node.color.highlight.background = node.color.hover.background = $("#nodecolourbg").val();
+        node.color.border = node.color.highlight.border = node.color.hover.border = $("#nodecolourbdr").val();
+        node.size = $("#nodesize").val();
+        if(node.shape == "image" || node.shape == "circularImage") {
+            if($("#nodeimage").val()) {
+                node.image = {unselected: custom_image_base + $("#nodeimage").val()};
+            } else {
+                node.image = {unselected: $("#device_image").val()};
+            }
+        } else {
+            node.image = {};
+        }
+        if(node.shape == "icon") {
+            node.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: node.color.border};
+        } else {
+            node.icon = {};
+        }
+        if(node.add) {
+            delete node.add;
+            network_nodes.add(node);
+        } else {
+            network_nodes.update(node);
+        }
+        if(node.id) {
+            if($("#device_id").val()) {
+                node_device_map[node.id] = {device_id: $("#device_id").val(), device_name: $("#device_name").text(), device_image: $("#device_image").val()}
+            } else {
+                delete node_device_map[node.id];
+            }
+        }
+        $("#map-saveDataButton").show();
+        $("#map-renderButton").show();
+    }
+    function editNodeCancel(event) {
+        editNodeHide();
+    }
+    function editNodeHide() {
+        $("#node-saveButton").off("click");
+    }
+    function updateEdgePortSearch(node1_id, node2_id, edge_id) {
+        node1 = network_nodes.get(node1_id);
+        node2 = network_nodes.get(node2_id);
+        if(isNaN(node1.title) && isNaN(node2.title)) {
+            $("#port_id").val("");
+            $("#edgePortRow").hide();
+            $("#edgePortReverseRow").hide();
+            $("#edgePortSearchRow").hide();
+            return;
+        }
+        if(edge_id in edge_port_map) {
+            $("#port_id").val(edge_port_map[edge_id].port_id);
+            $("#port_name").text(edge_port_map[edge_id].port_name);
+            $("#portreverse").bootstrapSwitch('state', edge_port_map[edge_id].reverse);
+            $("#edgePortRow").show();
+            $("#edgePortReverseRow").show();
+            $("#edgePortSearchRow").hide();
+        } else {
+            $("#port_id").val("");
+            $("#portreverse").bootstrapSwitch('state', false);
+            $("#edgePortRow").hide();
+            $("#edgePortReverseRow").hide();
+            $("#edgePortSearchRow").show();
+        }
+        port_search_device_id_1 = (node1.id in node_device_map) ? node_device_map[node1.id].device_id : 0;
+        port_search_device_id_2 = (node2.id in node_device_map) ? node_device_map[node2.id].device_id : 0;
+    }
+    function edgePortSelect(e) {
+        var id = e.params.data.id;
+        var name = e.params.data.text;
+        var reverse = e.params.data.device_id != port_search_device_id_1;
+        $("#port_id").val(id);
+        $("#port_name").text(name);
+        $("#portreverse").bootstrapSwitch('state', reverse);
+        $("#edgePortSearchRow").hide();
+        $("#edgePortRow").show();
+        $("#edgePortReverseRow").show();
+    }
+    function edgePortClear() {
+        $("#portsearch").val('');
+        $("#portsearch").trigger('change');
+        $("#port_id").val("");
+        $("#port_name").text("");
+        $("#edgePortSearchRow").show();
+        $("#edgePortRow").hide();
+        $("#edgePortReverseRow").hide();
+    }
+    function editEdgeDefaults() {
+        $("#edgeModalLabel").text('{{ __('map.custom.edit.edge.defaults_title') }}');
+        $("#divEdgeFrom").hide();
+        $("#divEdgeTo").hide();
+        $("#edgePortRow").hide();
+        $("#edgePortReverseRow").hide();
+        $("#edgePortSearchRow").hide();
+        $("#edgeRecenterRow").hide();
+        $("#edgelabel").hide();
+        $("#edgestyle").val(newedgeconf.smooth.type);
+        $("#edgetextface").val(newedgeconf.font.face);
+        $("#edgetextsize").val(newedgeconf.font.size);
+        $("#edgetextcolour").val(newedgeconf.font.color);
+        $("#edgetextshow").bootstrapSwitch('state', (newedgeconf.label.includes('xx%') || newedgeconf.label.includes('true')));
+        $("#edgebpsshow").bootstrapSwitch('state', (newedgeconf.label.includes('bps')));
+        $('#edgecolourtextreset').attr('disabled', 'disabled');
+        $("#edge-saveButton").hide();
+        $("#edge-saveDefaultsButton").show();
+        $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
     }
     function edgeLabel(show_pct, show_bps, default_val) {
         var label = '';
         if(show_pct) {
             label = 'xx%';
         }
         if(show_bps) {
             if(Boolean(label.length)) {
                 label += "\n";
             }
             label += 'xx bps';
         }
         if(Boolean(label.length)) {
             return label;
         }
         return default_val;
     }
+    function editEdgeDefaultsSave() {
+        editEdgeHide();
+        newedgeconf.smooth.type = $("#edgestyle").val();
+        newedgeconf.font.face = $("#edgetextface").val();
+        newedgeconf.font.size = $("#edgetextsize").val();
+        newedgeconf.font.color = $("#edgetextcolour").val();
+        newedgeconf.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), '');
+        $("#map-saveDataButton").show();
+    }
+    function editEdge(edgedata, callback) {
+        $("#portsearch").val('');
+        $("#portsearch").trigger('change');
+        var nodes = network_nodes.get({
+          fields: ['id', 'label'],
+          filter: function (item) {
+            return (!item.id.endsWith("_mid"));
+          },
+        });
+        $("#edgefrom").find('option').remove().end();
+        $("#edgeto").find('option').remove().end();
+        $.each( nodes, function( node_idx, node ) {
+            $("#edgefrom").append('<option value="' + node.id + '">' + node.label+ '</option>');
+            $("#edgeto").append('<option value="' + node.id + '">' + node.label+ '</option>');
+        });
+        $("#edgefrom").val(edgedata.edge1.from);
+        $("#edgeto").val(edgedata.edge2.from);
+        updateEdgePortSearch($("#edgefrom").val(), $("#edgeto").val(), edgedata.id);
+        checkColourReset(edgedata.edge1.font.color, newedgeconf.font.color, "edgecolourtextreset");
+        $("#edgestyle").val(edgedata.edge1.smooth.type);
+        $("#edgetextface").val(edgedata.edge1.font.face);
+        $("#edgetextsize").val(edgedata.edge1.font.size);
+        $("#edgetextcolour").val(edgedata.edge1.font.color);
+        $("#edgetextshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('xx%')));
+        $("#edgebpsshow").bootstrapSwitch('state', (edgedata.edge1.label != null && edgedata.edge1.label.includes('bps')));
+        $("#edgelabel").val('label' in edgedata.mid ? edgedata.mid.label : '');
+        $("#edgeRecenterRow").show();
+        $("#divEdgeFrom").show();
+        $("#divEdgeTo").show();
+        $("#edgelabel").show();
+        $("#edge-saveButton").show();
+        $("#edge-saveDefaultsButton").hide();
+        $("#edge-saveButton").on("click", {data: edgedata}, callback);
+        $('#edgeModal').modal({backdrop: 'static', keyboard: false}, 'show');
+    }
+    function editEdgeSave(event) {
+        edgedata = event.data.data;
+        edgeNodesUpdate(edgedata.id, $("#edgefrom").val(), $("#edgeto").val(), edgedata.edge1.from, edgedata.edge2.from);
+        editEdgeHide();
+        edgedata.edge1.smooth.type = $("#edgestyle").val();
+        edgedata.edge2.smooth.type = $("#edgestyle").val();
+        edgedata.edge1.from = $("#edgefrom").val();
+        edgedata.edge2.from = $("#edgeto").val();
+        edgedata.edge1.font.face = edgedata.edge2.font.face = $("#edgetextface").val();
+        edgedata.edge1.font.size = edgedata.edge2.font.size = $("#edgetextsize").val();
+        edgedata.edge1.font.color = edgedata.edge2.font.color = $("#edgetextcolour").val();
+        edgedata.edge1.label = edgedata.edge2.label = edgeLabel($("#edgetextshow").prop('checked'), $("#edgebpsshow").prop('checked'), null);
+        edgedata.edge1.title = edgedata.edge2.title = $("#port_id").val();
+	let newlabel = $("#edgelabel").val() || '';
+	if (newlabel == '' && edgedata.mid.label != '') {
+            $("#map-renderButton").show();
+	}
+        edgedata.mid.label = newlabel;
+        if(edgedata.id) {
+            if($("#port_id").val()) {
+                edge_port_map[edgedata.id] = {port_id: $("#port_id").val(), port_name: $("#port_name").text(), reverse: $("#portreverse")[0].checked}
+            } else {
+                delete edge_port_map[edgedata.id];
+            }
+        }
+        if(edgedata.edge2.smooth.type == "curvedCW") {
+            edgedata.edge2.smooth.type = "curvedCCW";
+        } else if (edgedata.edge2.smooth.type == "curvedCCW") {
+            edgedata.edge2.smooth.type = "curvedCW";
+        }
+        if(edgedata.add) {
+            network_nodes.add([edgedata.mid]);
+            network_nodes.flush();
+            network_edges.add([edgedata.edge1, edgedata.edge2]);
+            network_edges.flush();
+        } else {
+            network_edges.update([edgedata.edge1, edgedata.edge2]);
+            network_nodes.update([edgedata.mid]);
+            if($("#edgerecenter").is(":checked")) {
+                var pos = network.getPositions([edgedata.edge1.from, edgedata.edge2.from]);
+                const mid_pos = getMidPos(edgedata.id, edgedata.edge1.from, edgedata.edge2.from);
+                edgedata.mid.x = mid_pos.x;
+                edgedata.mid.y = mid_pos.y;
+                network_nodes.update([edgedata.mid]);
+                $("#map-renderButton").show();
+            }
+            if(! edgedata.edge1.label) {
+                network_edges.flush();
+                network.selectEdges([edgedata.edge2.id]);
+                network.redraw();
+                network.selectEdges([edgedata.edge1.id]);
+            }
+        }
+        $("#edgerecenter").prop( "checked", false );
+        $("#map-saveDataButton").show();
+    }
+    function editEdgeCancel(event) {
+        editEdgeHide();
+    }
+    function editEdgeHide() {
+        $("#edge-saveButton").off("click");
+    }
     function editExistingEdge (edge, callback) {
         if(callback) {
             callback(null);
         }
         var edgeinfo = edge.id.split("_");
         if(edgeinfo[1] == "to") {
             edge1 = network_edges.get(edgeinfo[0] + "_from");
             edge2 = network_edges.get(edge.id);
         } else {
             edge1 = network_edges.get(edge.id);
             edge2 = network_edges.get(edgeinfo[0] + "_to");
         }
         var mid = network_nodes.get(edgeinfo[0] + "_mid");
         var edgedata = {id: edgeinfo[0], mid: mid, edge1: edge1, edge2: edge2}
-        edgeEdit(edgedata);
+        $("#edgeModalLabel").text("Edit Edge");
+        editEdge(edgedata, editEdgeSave);
     }
     function deleteEdge(edgeid) {
         const edge1 = network_edges.get(edgeid + "_from");
         const edge2 = network_edges.get(edgeid + "_to");
         var nm_id = edge1.from < edge2.from ? edge1.from + '.' + edge2.from : edge2.from + '.' + edge1.from;
         edgeNodesRemove(nm_id, edgeid);
         network_edges.remove(edgeid + "_to");
         network_edges.remove(edgeid + "_from");
         network_edges.flush();
         network_nodes.remove(edgeid + "_mid");
@@ -611,23 +958,20 @@
                     var mid = {id: edgeid + "_mid", shape: "dot", size: 0, x: mid_x, y: mid_y, label: edge.label};
                     mid.size = 3;
                     var arrows;
                     if (Boolean(reverse_arrows)) {
                         arrows = {from: {enabled: true, scaleFactor: 0.6}, to: {enabled: false}};
                     } else {
                         arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
                     }
                     var edge1 = {id: edgeid + "_from", from: edge.custom_map_node1_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
                     var edge2 = {id: edgeid + "_to", from: edge.custom_map_node2_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
-                    if(edge.fixed_width) {
-                        edge1.width = edge2.width = parseFloat(edge.fixed_width) || null;
-                    }
                     if(edge2.smooth.type == "curvedCW") {
                         edge2.smooth.type = "curvedCCW";
                     } else if (edge2.smooth.type == "curvedCCW") {
                         edge2.smooth.type = "curvedCW";
                     }
                     if(edge.port_id) {
                         edge_port_map[edgeid] = {port_id: edge.port_id, port_name: edge.port_name, reverse: edge.reverse};
                         edge1.title = edge2.title = edge.port_id;
                     } else {
                         edge1.title = edge2.title = '';
@@ -675,16 +1019,40 @@
                         document.getElementById("custom-map").classList.add("tw-cursor-crosshair")
                     }
                 } else if (mutation.removedNodes.length) {
                     if(Array.from(mutation.removedNodes).some(({classList}) => classList.contains("vis-back"))) {
                         document.getElementById("custom-map").classList.remove("tw-cursor-crosshair")
                     }
                 }
             }
         }).observe(targetNode, {attributes: false, childList: true, subtree: false});
     }
+    function startBackgroundMapAdjust() {
+        $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').hide();
+        $('#map-bgEndAdjustButton').show();
+    }
+    function endBackgroundMapAdjust() {
+        $('#map-editButton,#map-nodeDefaultsButton,#map-edgeDefaultsButton,#map-bgButton').show();
+        $('#map-bgEndAdjustButton').hide();
+        document.getElementById('custom-map-bg-geo-map').style.zIndex = '1';
+        const leaflet = get_map('custom-map-bg-geo-map');
+        if (leaflet) {
+            disable_map_interaction(leaflet)
+        }
+        editMapBackground();
+    }
     $(document).ready(function () {
+        init_select2('#devicesearch', 'device', {limit: 100}, '', '{{ __('map.custom.edit.node.device_select') }}', {dropdownParent: $('#nodeModal')});
+        $("#devicesearch").on("select2:select", nodeDeviceSelect);
+        init_select2('#portsearch', 'port', function(params) {
+            return {
+                limit: 100,
+                devices: [port_search_device_id_1, port_search_device_id_2],
+                term: params.term,
+                page: params.page || 1
+            }
+        }, '', '{{ __('map.custom.edit.edge.port_select') }}', {dropdownParent: $('#edgeModal')});
+        $("#portsearch").on("select2:select", edgePortSelect);
         refreshMap();
-        observeEditMode();
-   });
+        observeEditMode();    });
 </script>
 @endsection

--- a/resources/views/map/custom-js.blade.php
+++ b//dev/null
@@ -1,177 +0,0 @@
-<script type="text/javascript" src="{{ asset('js/vis.min.js') }}"></script>
-<script type="text/javascript">
-    var custommap = {
-        legendPctDefaultColour: function (pct) {
-            if (pct < 0) {
-                return "black";
-            } else if (pct < 50) {
-                return '#' + parseInt(5.1 * pct).toString(16).padStart(2, 0) + 'ff00';
-            } else if (pct < 100) {
-                return '#ff' + parseInt(5.1 * (100.0 - pct)).toString(16).padStart(2, 0) + '00';
-            } else if (pct < 150) {
-                return '#ff00' + parseInt(5.1 * (pct - 100.0)).toString(16).padStart(2, 0);
-            }
-            return '#ff00ff';
-        },
-        redrawDefaultLegend: function (nodes, num_steps, x_pos, y_pos, font_size, hide_invalid, hide_overspeed, colours) {
-            old_nodes = nodes.get({filter: function(node) { return node.id.startsWith("legend_") }});
-            old_nodes.forEach((node) => {
-                nodes.remove(node.id);
-            });
-            if (x_pos >= 0) {
-                font_size =  font_size;
-                y_pos =  y_pos;
-                x_pos =  x_pos;
-                let y_inc = font_size + 10;
-                let legend_header = {id: "legend_header", label: "<b>Legend</b>", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {multi: 'html', size: font_size}, color: {background: "white"}};
-                nodes.add(legend_header);
-                y_pos += y_inc;
-                if (!(Boolean(hide_invalid))) {
-                    let this_colour = "black";
-                    if(colours) {
-                        this_colour = colours['-1'];
-                    }
-                    let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {face: 'courier new', size: font_size, color: "white"}, color: {background: this_colour}};
-                    y_pos += y_inc;
-                    nodes.add(legend_invalid);
-                }
-                if(colours) {
-                    let i = 0;
-                    Object.keys(colours).sort((a,b) => parseInt(a) > parseInt(b)).forEach((pct_key) => {
-                        let this_pct = parseFloat(pct_key);
-                        if(!isNaN(this_pct) && this_pct >= 0.0) {
-                            let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {face: 'courier new', size: font_size, color: "black"}, color: {background: colours[pct_key]}};
-                            nodes.add(legend_step);
-                            y_pos += y_inc;
-                            i++;
-                        }
-                    });
-                } else {
-                    let pct_step;
-                    if (Boolean(hide_overspeed)) {
-                        pct_step = 100.0 / (num_steps - 1);
-                    } else {
-                        pct_step = 150.0 / (num_steps - 1);
-                    }
-                    for (let i=0; i < num_steps; i++) {
-                        let this_pct = Math.round(pct_step * i);
-                        let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: x_pos, y: y_pos, font: {face: 'courier new', size: font_size, color: "black"}, color: {background: custommap.legendPctDefaultColour(this_pct)}};
-                        nodes.add(legend_step);
-                        y_pos += y_inc;
-                    }
-                }
-                nodes.flush();
-            }
-        },
-        createNetwork: function (elementId, scale, nodes, edges, options, bgtype, bgdata) {
-            nodes.flush();
-            edges.flush();
-            var container = document.getElementById(elementId);
-            var network = new vis.Network(container, {nodes: nodes, edges: edges, stabilize: true}, options);
-            network_height = $($(container).children(".vis-network")[0]).height();
-            network_width = $($(container).children(".vis-network")[0]).width();
-            var centreY = Math.round(network_height / (2 * scale));
-            var centreX = Math.round(network_width / (2 * scale));
-            network.moveTo({position: {x: centreX, y: centreY}, scale: scale});
-            setCustomMapBackground(elementId, bgtype, bgdata);
-            network.on('zoom', function (data) {
-                if(data.scale < scale) {
-                    network.moveTo({position: {x: centreX, y: centreY}, scale: scale});
-                }
-            });
-            return network;
-        },
-        getNodeCfg: function (nodeid, node, screenshot, custom_image_base) {
-            var node_cfg = {};
-            node_cfg.id = nodeid;
-            if(node.device_id) {
-                node_cfg.title = node.device_info;
-            } else if(node.linked_map_name) {
-                node_cfg.title = "Go to " + node.linked_map_name;
-            } else {
-                node_cfg.title = null;
-            }
-            node_cfg.label = screenshot ? node.label.replace(/./g, ' ') : node.label;
-            node_cfg.shape = node.style;
-            node_cfg.borderWidth = node.border_width;
-            node_cfg.x = node.x_pos;
-            node_cfg.y = node.y_pos;
-            node_cfg.font = {face: node.text_face, size: node.text_size, color: node.text_colour};
-            node_cfg.size = node.size;
-            node_cfg.color = {background: node.colour_bg_view, border: node.colour_bdr_view};
-            if(node.style == "icon") {
-                node_cfg.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt(node.icon, 16)), size: node.size, color: node.colour_bdr};
-            } else {
-                node_cfg.icon = {};
-            }
-            if(node.style == "image" || node.style == "circularImage") {
-                if(node.image) {
-                    node_cfg.image = {unselected: custom_image_base + node.image};
-                } else if (node.device_image) {
-                    node_cfg.image = {unselected: node.device_image};
-                } else {
-                    node_cfg.shape = newnodeconf.shape;
-                    node_cfg.icon = newnodeconf.icon;
-                    node_cfg.image = newnodeconf.image;
-                }
-            } else {
-                node_cfg.image = {};
-            }
-            if(! ["ellipse", "circle", "database", "box", "text"].includes(node.style)) {
-                node_cfg.font.background = "#FFFFFF";
-            }
-            return node_cfg;
-        },
-        getEdgeCfg: function (edgeid, edge, fromto, reverse_arrows) {
-            if (Boolean(reverse_arrows)) {
-                arrows = {from: {enabled: true, scaleFactor: 0.6}, to: {enabled: false}};
-            } else {
-                arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
-            }
-            var edge_cfg = {id: edgeid + "_" + fromto, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour, background: "#FFFFFF"}, smooth: {type: edge.style}};
-            if (fromto == "from") {
-                edge_cfg.from = edge.custom_map_node1_id;
-                var port_pct = Boolean(reverse_arrows) ? edge.port_topct : edge.port_frompct;
-                var port_bps = Boolean(reverse_arrows) ? edge.port_tobps : edge.port_frombps;
-                var port_colour = Boolean(reverse_arrows) ? edge.colour_to : edge.colour_from;
-                var port_width = Boolean(reverse_arrows) ? edge.width_to : edge.width_from;
-            } else if (fromto == "to") {
-                edge_cfg.from = edge.custom_map_node2_id;
-                var port_pct = Boolean(reverse_arrows) ? edge.port_frompct : edge.port_topct;
-                var port_bps = Boolean(reverse_arrows) ? edge.port_frombps : edge.port_tobps;
-                var port_colour = Boolean(reverse_arrows) ? edge.colour_from : edge.colour_to;
-                var port_width = Boolean(reverse_arrows) ? edge.width_from : edge.width_to;
-                if(edge_cfg.smooth.type == "curvedCW") {
-                    edge_cfg.smooth.type = "curvedCCW";
-                } else if (edge_cfg.smooth.type == "curvedCCW") {
-                    edge_cfg.smooth.type = "curvedCW";
-                }
-            } else {
-                console.log("custommapGetEdgeCfg got an invalid value in fromto:" + fromto);
-                return {};
-            }
-            if(edge.port_id) {
-                edge_cfg.title = edge.port_info;
-                if(edge.showpct) {
-                    edge_cfg.label = port_pct + "%";
-                }
-                if(edge.showbps) {
-                    if(edge_cfg.label == null) {
-                        edge_cfg.label = '';
-                    } else {
-                        edge_cfg.label += "\n";
-                    }
-                    edge_cfg.label += port_bps;
-                }
-                edge_cfg.color = {color: port_colour};
-                edge_cfg.width = parseFloat(edge.fixed_width) || port_width;
-            }
-            return edge_cfg;
-        },
-        getEdgeMidCfg: function (edgeid, edge, screenshot) {
-            var mid_x =  edge.mid_x;
-            var mid_y =  edge.mid_y;
-            return {id: edgeid + "_mid", shape: "dot", size: 0, x: mid_x, y: mid_y, label: screenshot ? '' : edge.label, font: {face: edge.text_face, size:  edge.text_size, color: edge.text_colour}};
-        },
-    }
-</script>

--- a/resources/views/map/custom-legend-modal.blade.php
+++ b//dev/null
@@ -1,223 +0,0 @@
-<div class="modal fade" id="mapLegendModal" role="dialog" aria-labelledby="mapLegendModalLabel" aria-hidden="true">
-    <div class="modal-dialog" role="document">
-        <div class="modal-content">
-            <div class="modal-header">
-                <h5 class="modal-title" id="mapLegendModalLabel">{{ __('map.custom.edit.map.legend_title') }}</h5>
-            </div>
-            <div class="modal-body">
-                <div class="row">
-                    <div class="col-md-12">
-                        <div class="well well-lg">
-                            <div class="form-group row">
-                                <label for="maplegendfontsize" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.font_size') }}</label>
-                                <div class="col-sm-8">
-                                    <input type=number id="maplegendfontsize" class="form-control input-sm" />
-                                </div>
-                            </div>
-                            <div class="form-group row">
-                                <label for="maplegendsteps" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.steps') }}</label>
-                                <div class="col-sm-8">
-                                    <input type=number id="maplegendsteps" class="form-control input-sm" onChange=mapLegendChangeSteps() />
-                                </div>
-                            </div>
-                            <div class="form-group row">
-                                <label for="maplegendhideinvalid" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideinvalid') }}</label>
-                                <div class="col-sm-8">
-                                    <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideinvalid">
-                                </div>
-                            </div>
-                            <div class="form-group row">
-                                <label for="maplegendhideoverspeed" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideoverspeed') }}</label>
-                                <div class="col-sm-8">
-                                    <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideoverspeed">
-                                </div>
-                            </div>
-                            <div class="form-group row">
-                                <label for="maplegendcustomcolours" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.customcolours') }}</label>
-                                <div class="col-sm-8">
-                                    <input class="form-check-input" type="checkbox" role="switch" id="maplegendcustomcolours" onChange="mapLegendCustomColourToggle();">
-                                </div>
-                            </div>
-                            <hr>
-                            <div class="form-group row customcolours">
-                                <label for="maplegendcolourinvalid" class="col-sm-8 control-label">{{ __('map.custom.edit.map.legend.colour_invalid') }}</label>
-                                <div class="col-sm-2">
-                                    <input type=color class="form-control input-sm" id="maplegendcolourinvalid">
-                                </div>
-                                <div class="col-sm-2">
-                                </div>
-                            </div>
-                            <div class="form-group row customcolours">
-                                <label for="maplegendcolourdown" class="col-sm-8 control-label">{{ __('map.custom.edit.map.legend.colour_down') }}</label>
-                                <div class="col-sm-2">
-                                    <input type=color class="form-control input-sm" id="maplegendcolourdown">
-                                </div>
-                                <div class="col-sm-2">
-                                </div>
-                            </div>
-                            <div class="form-group row customcolours" id="customcolourrow0">
-                                <label for="maplegendcolourpct0" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.colour_lower_pct') }} 1</label>
-                                <div class="col-sm-2">
-                                    <input type=number disabled class="form-control input-sm" id="maplegendcolourpct0" value="0">
-                                </div>
-                                <label for="maplegendcolour0" class="col-sm-2 control-label">{{ __('map.custom.edit.map.legend.colour') }} 1</label>
-                                <div class="col-sm-2">
-                                    <input type=color class="form-control input-sm" id="maplegendcolour0" value="#00FF00">
-                                </div>
-                                <div class="col-sm-4">
-                                </div>
-                            </div>
-                            <div class="form-group row customcolours">
-                                <div class="col-md-12" id="maplegendcolours">
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                </div>
-            </div>
-            <div class="modal-footer">
-                <center>
-                    <button type=button value="save" id="mapLegend-saveButton" class="btn btn-primary" onclick="saveMapLegend()">{{ __('Save') }}</button>
-                    <button type=button value="cancel" id="mapLegend-cancelButton" class="btn btn-primary" onclick="cancelMapLegend()">{{ __('Cancel') }}</button>
-                </center>
-            </div>
-        </div>
-    </div>
-</div>
-<script>
-    var legend = @json($legend);
-    function saveMapLegend() {
-        legend.font_size = parseInt($("#maplegendfontsize").val());
-        legend.steps = parseInt($("#maplegendsteps").val());
-        legend.hide_invalid = $("#maplegendhideinvalid").prop('checked') ? 1 : 0;
-        legend.hide_overspeed = $("#maplegendhideoverspeed").prop('checked') ? 1 : 0;
-        if($("#maplegendcustomcolours").prop('checked')) {
-            legend.colours = {};
-            legend.colours["-1"] = $("#maplegendcolourinvalid").val();
-            legend.colours["-2"] = $("#maplegendcolourdown").val();
-            if(legend.steps > 0) {
-                for(let i = 0; i < legend.steps; i++) {
-                    let this_pct = parseFloat($("#maplegendcolourpct" + i).val());
-                    let this_colour = $("#maplegendcolour" + i).val();
-                    if(!isNaN(this_pct) && this_colour) {
-                        legend.colours[this_pct] = this_colour;
-                    }
-                }
-            }
-        } else {
-            legend.colours = null;
-        }
-        redrawLegend();
-        mapLegendResetColours();
-        $("#mapLegendModal").modal('hide');
-        $("#map-saveDataButton").show();
-    }
-    function cancelMapLegend() {
-        mapLegendSettingsReset();
-        $("#mapLegendModal").modal('hide');
-    }
-    function mapLegendDefaultColours() {
-        let ret = {"-1": '#000000', "-2": '#8B0000'};
-        for(let i = 0; i < legend.steps; i++) {
-            let this_node = network_nodes.get("legend_" + i);
-            if(this_node) {
-                let pct = parseInt(this_node.label.replace('%', ''));
-                ret[pct] = this_node.color.background;
-            } else {
-                ret[maxpct+=10] = "#000000";
-            }
-        }
-        return ret;
-    }
-    function mapLegendAddColour(rownum, pct, colour) {
-        $("#maplegendcolours").append('' +
-'                            <div class="form-group row customcolours" id="customcolourrow' + rownum + '">' +
-'                                <label for="maplegendcolourpct' + rownum + '" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.colour_lower_pct') }} ' + (rownum + 1) + '</label>' +
-'                                <div class="col-sm-2">' +
-'                                    <input type=number step="0.01" class="form-control input-sm" id="maplegendcolourpct' + rownum + '" value="' + pct + '">' +
-'                                </div>' +
-'                                <label for="maplegendcolour' + rownum + '" class="col-sm-2 control-label">{{ __('map.custom.edit.map.legend.colour') }} ' + (rownum + 1) + '</label>' +
-'                                <div class="col-sm-2">' +
-'                                    <input type=color class="form-control input-sm" id="maplegendcolour' + rownum + '" value="' + colour + '">' +
-'                                </div>' +
-'                                <div class="col-sm-4">' +
-'                                </div>' +
-'                            </div>' +
-        '');
-    }
-    function mapLegendResetColours() {
-        let colours = legend.colours || mapLegendDefaultColours();
-        $("#maplegendcolours").html('');
-        $("#maplegendcolourinvalid").val(colours["-1"]);
-        $("#maplegendcolourdown").val(colours["-2"]);
-        $("#maplegendcolour0").val(colours["0"]);
-        let colournum = 1;
-        let max_pct = 0;
-        Object.keys(colours).sort((a,b) => parseInt(a) > parseInt(b)).forEach((pct_key) => {
-            let pct = parseFloat(pct_key);
-            if(!isNaN(pct) && pct > 0.0) {
-                mapLegendAddColour(colournum++, pct, colours[pct_key]);
-                max_pct = pct;
-            }
-        });
-        while(colournum < legend.steps) {
-            mapLegendAddColour(colournum++, max_pct+=10, "#000000");
-        }
-    }
-    function mapLegendChangeSteps() {
-        let steps = parseInt($("#maplegendsteps").val());
-        if(steps < 1) {
-            $("#maplegendsteps").val(1);
-            steps = 1;
-        }
-        let i = 0;
-        let maxpct = 0;
-        for(i = 1; i < steps; i++) {
-            let this_pct = $("#maplegendcolourpct" + i);
-            if(this_pct.length) {
-                maxpct = parseFloat(this_pct.val());
-            } else {
-                let this_node = network_nodes.get("legend_" + i);
-                if(this_node) {
-                    let pct = parseFloat(this_node.label.replace('%', ''));
-                    mapLegendAddColour(i, pct, this_node.color.background);
-                    maxpct = pct;
-                } else {
-                    maxpct+=10;
-                    mapLegendAddColour(i, maxpct, legendPctColour(maxpct));
-                }
-            }
-        }
-        let this_row = $("#customcolourrow" + i);
-        while(this_row.length) {
-            this_row.remove();
-            this_row = $("#customcolourrow" + ++i);
-        }
-    }
-    function mapLegendSettingsReset() {
-        $("#maplegendcustomcolours").bootstrapSwitch('state', Boolean(legend.colours));
-        $("#maplegendhideinvalid").bootstrapSwitch('state', Boolean(legend.hide_invalid));
-        $("#maplegendhideoverspeed").bootstrapSwitch('state', Boolean(legend.hide_overspeed));
-        $("#maplegendfontsize").val(legend.font_size);
-        $("#maplegendsteps").val(legend.steps);
-        if(legend.colours) {
-            mapLegendResetColours();
-            $(".customcolours").show();
-        } else {
-            $(".customcolours").hide();
-        }
-    }
-    function mapLegendCustomColourToggle() {
-        if($("#maplegendcustomcolours").prop('checked')) {
-            if($("#maplegendcolours").children().length == 0) {
-                mapLegendResetColours();
-            }
-            $(".customcolours").show();
-        } else {
-            $(".customcolours").hide();
-        }
-    }
-    $(document).ready(function () {
-        mapLegendSettingsReset();
-    });
-</script>

--- a/resources/views/map/custom-manage.blade.php
+++ b/resources/views/map/custom-manage.blade.php
@@ -47,22 +47,20 @@
                     </div>
                 @endforeach
             </x-panel>
         @endforeach
     </x-panel>
 </div>
 @endsection
 @section('scripts')
     @routes
 <script type="text/javascript">
-    var network_options = {{ Js::from($map_conf) }};
-    var legend = {{ Js::from($legend) }};
     $('#mapDeleteModal').on('show.bs.modal', () => {
         let $mapDeleteModalLabel = $('#mapDeleteModalLabel');
         $mapDeleteModalLabel.text($mapDeleteModalLabel.data('text').replace(':name', pendingMapToDelete.name));
     });
     function editMapSuccess(data) {
         $('#mapModal').modal('hide');
         window.location.href = "{{ @route('maps.custom.edit', ['map' => '?']) }}".replace('?', data['id']);
     }
     function editMapCancel() {
         $('#mapModal').modal('hide');

--- a/resources/views/map/custom-map-modal.blade.php
+++ b/resources/views/map/custom-map-modal.blade.php
@@ -5,75 +5,87 @@
                 <h5 class="modal-title" id="mapModalLabel">{{ __('map.custom.edit.map.settings_title') }}</h5>
             </div>
             <div class="modal-body">
                 <div class="row">
                     <div class="col-md-12">
                         <div class="well well-lg">
                             <input type="hidden" id="mapid" name="mapid" />
                             <div class="form-group row">
                                 <label for="mapname" class="col-sm-3 control-label">{{ __('map.custom.edit.map.name') }}</label>
                                 <div class="col-sm-9">
-                                    <input type="text" id="mapname" name="mapname" class="form-control input-sm">
+                                    <input type="text" id="mapname" name="mapname" class="form-control input-sm" value="{{ $name ?? '' }}">
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="mapmenugroup" class="col-sm-3 control-label">{{ __('map.custom.edit.map.menu_group') }}</label>
                                 <div class="col-sm-9">
                                     <select id="mapmenugroup" name="mapmenugroup" class="form-control input-sm"></select>
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="mapwidth" class="col-sm-3 control-label">{{ __('map.custom.edit.map.width') }}</label>
                                 <div class="col-sm-9">
-                                    <input type="text" id="mapwidth" name="mapwidth" class="form-control input-sm">
+                                    <input type="text" id="mapwidth" name="mapwidth" class="form-control input-sm" value="{{ $map_conf['width'] ?? '1800px' }}">
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="mapheight" class="col-sm-3 control-label">{{ __('map.custom.edit.map.height') }}</label>
                                 <div class="col-sm-9">
-                                    <input type="text" id="mapheight" name="mapheight" class="form-control input-sm">
+                                    <input type="text" id="mapheight" name="mapheight" class="form-control input-sm" value="{{ $map_conf['height'] ?? '800px' }}">
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="mapnodealign" class="col-sm-3 control-label">{{ __('map.custom.edit.map.alignment') }}</label>
                                 <div class="col-sm-9">
-                                    <input type="number" id="mapnodealign" name="mapnodealign" class="form-control input-sm">
+                                    <input type="number" id="mapnodealign" name="mapnodealign" class="form-control input-sm" value="{{ $node_align ?? 10 }}">
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="mapedgesep" class="col-sm-3 control-label">{{ __('map.custom.edit.map.edgeseparation') }}</label>
                                 <div class="col-sm-9">
-                                    <input type="number" id="mapedgesep" name="mapedgesep" class="form-control input-sm">
+                                    <input type="number" id="mapedgesep" name="mapedgesep" class="form-control input-sm" value="{{ $edge_separation ?? 10 }}">
                                 </div>
                             </div>
                             <div class="form-group row">
                                 <label for="mapreversearrows" class="col-sm-3 control-label">{{ __('map.custom.edit.map.reverse') }}</label>
                                 <div class="col-sm-9">
                                     <input class="form-check-input" type="checkbox" role="switch" id="mapreversearrows">
                                 </div>
                             </div>
                             <div class="form-group row">
-                                <label for="mapopt-zoom" class="col-sm-3 control-label">{{ __('map.custom.edit.map.zoom') }}</label>
-                                <div class="col-sm-9">
-                                    <input class="form-check-input" type="checkbox" role="switch" id="mapopt-zoom">
-                                </div>
-                            </div>
-                            <div class="form-group row">
-                                <label for="mapopt-dragnodes" class="col-sm-3 control-label">{{ __('map.custom.edit.map.dragnodes') }}</label>
-                                <div class="col-sm-9">
-                                    <input class="form-check-input" type="checkbox" role="switch" id="mapopt-dragnodes">
-                                </div>
-                            </div>
-                            <div class="form-group row">
-                                <label for="mapopt-physics" class="col-sm-3 control-label">{{ __('map.custom.edit.map.physics') }}</label>
-                                <div class="col-sm-9">
-                                    <input class="form-check-input" type="checkbox" role="switch" id="mapopt-physics">
+                                <label for="maplegend" class="col-sm-3 control-label">{{ __('map.custom.edit.map.enable_legend') }}</label>
+                                <div class="col-sm-9">
+                                    <input class="form-check-input" type="checkbox" role="switch" id="maplegend" onChange="toggleMapLegend()">
+                                </div>
+                            </div>
+                            <div class="form-group row maplegend">
+                                <label for="maplegendfontsize" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.font_size') }}</label>
+                                <div class="col-sm-8">
+                                    <input type=number id="maplegendfontsize" class="form-control input-sm" value={{ $legend['font_size'] }} />
+                                </div>
+                            </div>
+                            <div class="form-group row maplegend">
+                                <label for="maplegendsteps" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.steps') }}</label>
+                                <div class="col-sm-8">
+                                    <input type=number id="maplegendsteps" class="form-control input-sm" value={{ $legend['steps'] }} />
+                                </div>
+                            </div>
+                            <div class="form-group row maplegend">
+                                <label for="maplegendhideinvalid" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideinvalid') }}</label>
+                                <div class="col-sm-8">
+                                    <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideinvalid">
+                                </div>
+                            </div>
+                            <div class="form-group row maplegend">
+                                <label for="maplegendhideoverspeed" class="col-sm-4 control-label">{{ __('map.custom.edit.map.legend.hideoverspeed') }}</label>
+                                <div class="col-sm-8">
+                                    <input class="form-check-input" type="checkbox" role="switch" id="maplegendhideoverspeed">
                                 </div>
                             </div>
                             <hr>
                             <div class="row">
                                 <div class="col-sm-12" id="savemap-alert">
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
@@ -85,43 +97,50 @@
                 </center>
             </div>
         </div>
     </div>
 </div>
 <script>
     var node_align = {{$node_align}};
     var edge_sep = {{$edge_separation}};
     var reverse_arrows = {{$reverse_arrows}};
     var legend = @json($legend);
-    var map_name = "{{ $name ?? '' }}";
-    var map_node_align = {{ $node_align ?? 10 }};
-    var map_edge_separation = {{ $edge_separation ?? 10 }};
-    var map_options = {{ Js::from($map_options) }};
     function saveMapSettings() {
         $("#map-saveButton").attr('disabled','disabled');
         $("#savemap-alert").text('{{ __('map.custom.edit.map.saving') }}');
         $("#savemap-alert").attr("class", "col-sm-12 alert alert-info");
         var name = $("#mapname").val();
         var group = $("#mapmenugroup").val();
         var width = $("#mapwidth").val();
         var height = $("#mapheight").val();
         var node_align = $("#mapnodealign").val();
-        var post_options = structuredClone(map_options);
-        if (Array.isArray(post_options.physics)) {
-            post_options.physics = {};
-        }
-        if (Array.isArray(post_options.interaction)) {
-            post_options.interaction = {};
-        }
-        post_options.interaction.zoomView = post_options.interaction.dragView = $("#mapopt-zoom").prop('checked');
-        post_options.interaction.dragNodes = $("#mapopt-dragnodes").prop('checked');
-        post_options.physics.enabled = $("#mapopt-physics").prop('checked');
+        var mapwdith = 100;
+        if (!isNaN(width)) {
+            mapwidth = width;
+        } else if (width.includes("px")) {
+            mapwidth = width.replace("px", "");
+        } else if (width.includes("%")) {
+            mapwidth = window.innerWidth * width.replace("%", "") / 100;
+        }
+        if ($("#maplegend").prop('checked')) {
+            if (legend.x < 0) {
+                legend.x = mapwidth - 50;
+                legend.y = 100;
+            }
+        } else {
+            legend.x = -1;
+            legend.y = -1;
+        }
+        legend.font_size = parseInt($("#maplegendfontsize").val());
+        legend.steps = parseInt($("#maplegendsteps").val());
+        legend.hide_invalid = $("#maplegendhideinvalid").prop('checked') ? 1 : 0;
+        legend.hide_overspeed = $("#maplegendhideoverspeed").prop('checked') ? 1 : 0;
         var map_reverse_arrows = $("#mapreversearrows").prop('checked') ? 1 : 0;
         var map_edge_sep = $("#mapedgesep").val();
         if(!isNaN(width)) {
             width = width + "px";
         }
         if(!isNaN(height)) {
             height = height + "px";
         }
         @if(isset($map_id))
             var url = '{{ route('maps.custom.update', ['map' => $map_id]) }}';
@@ -133,54 +152,61 @@
         $.ajax({
             url: url,
             data: {
                 name: name,
                 menu_group: group,
                 width: width,
                 height: height,
                 node_align: node_align,
                 reverse_arrows: map_reverse_arrows,
                 edge_separation: map_edge_sep,
-                options: JSON.stringify(post_options),
+                legend_x: legend.x,
+                legend_y: legend.y,
+                legend_steps: legend.steps,
+                legend_font_size: legend.font_size,
+                legend_hide_invalid: legend.hide_invalid,
+                legend_hide_overspeed: legend.hide_overspeed,
             },
             dataType: 'json',
             type: method
         }).done(function (data, status, resp) {
             editMapSuccess(data);
         }).fail(function (resp, status, error) {
             var data = resp.responseJSON;
             if (data['message']) {
                 let alert_content = $("#savemap-alert");
                 alert_content.text(data['message']);
                 alert_content.attr("class", "col-sm-12 alert alert-danger");
             } else {
                 let alert_content = $("#savemap-alert");
                 alert_content.text('{{ __('map.custom.edit.map.save_error', ['code' => '?']) }}'.replace('?', resp.status));
                 alert_content.attr("class", "col-sm-12 alert alert-danger");
             }
         }).always(function (resp, status, error) {
             $("#map-saveButton").removeAttr('disabled');
         });
     }
-    function mapSettingsReset() {
-        $("#mapreversearrows").bootstrapSwitch('state', Boolean(reverse_arrows));
-        $("#mapopt-zoom").bootstrapSwitch('state', Boolean(map_options.interaction.zoomView));
-        $("#mapopt-dragnodes").bootstrapSwitch('state', Boolean(map_options.interaction.dragNodes));
-        $("#mapopt-physics").bootstrapSwitch('state', Boolean(map_options.physics.enabled));
-        $("#mapname").val(map_name);
-        $("#mapwidth").val(network_options.width);
-        $("#mapheight").val(network_options.height);
-        $("#mapnodealign").val(map_node_align);
-        $("#mapedgesep").val(map_edge_separation);
+    function toggleMapLegend() {
+        if($("#maplegend").prop('checked')) {
+            $(".maplegend").show();
+        } else {
+            $(".maplegend").hide();
+        }
     }
     $(document).ready(function () {
-        mapSettingsReset();
+        if(legend.x < 0 || legend.y < 0) {
+            $(".maplegend").hide();
+        }
+        $("#mapreversearrows").bootstrapSwitch('state', Boolean(reverse_arrows));
+        $("#maplegend").bootstrapSwitch('state', (legend.x >= 0 && legend.y >= 0));
+        $("#maplegendhideinvalid").bootstrapSwitch('state', Boolean(legend.hide_invalid));
+        $("#maplegendhideoverspeed").bootstrapSwitch('state', Boolean(legend.hide_overspeed));
         init_select2("#mapmenugroup", "custom-map-menu-group", {}, @json($menu_group ?? null), "{{ __('map.custom.edit.map.no_group') }}", {
             tags: true,
             createTag: function (params) {
                 var term = $.trim(params.term);
                 if (term === '') {
                     return null;
                 }
                 return {
                     id: term,
                     text: term

--- a/resources/views/map/custom-node-modal.blade.php
+++ b/resources/views/map/custom-node-modal.blade.php
@@ -61,35 +61,35 @@
                                         <option value="hexagon">{{ __('map.custom.edit.node.style_options.hexagon') }}</option>
                                         <option value="square">{{ __('map.custom.edit.node.style_options.square') }}</option>
                                         <option value="icon">{{ __('map.custom.edit.node.style_options.icon') }}</option>
                                     </select>
                                     <input type="hidden" id="device_image">
                                 </div>
                             </div>
                             <div class="form-group row" id="nodeImageRow">
                                 <label for="nodeimage" class="col-sm-3 control-label">{{ __('map.custom.edit.node.image') }}</label>
                                 <div class="col-sm-6">
-                                    <select id="nodeimage" class="form-control input-sm" onchange="nodeSetImage();">
+                                    <select id="nodeimage" class="form-control input-sm" onchange="setNodeImage();">
                                         <option value="" id="deviceiconimage">{{ __('map.custom.edit.node.style_options.device_image') }}</option>
                                         @foreach($images as $imgfile => $imglabel)
                                             <option value="{{$imgfile}}">{{$imglabel}}</option>
                                         @endforeach
                                     </select>
                                 </div>
                                 <div class="col-sm-3">
                                     <img id="nodeimagepreview" width=28 height=28>
                                 </div>
                             </div>
                             <div class="form-group row" id="nodeIconRow">
                                 <label for="nodeicon" class="col-sm-3 control-label">{{ __('map.custom.edit.node.icon') }}</label>
                                 <div class="col-sm-6">
-                                    <select id="nodeicon" class="form-control input-sm" onchange="nodeSetIcon();">
+                                    <select id="nodeicon" class="form-control input-sm" onchange="setNodeIcon();">
                                         <option value="f233">{{ __('map.custom.edit.node.icon_options.server')  }}</option>
                                         <option value="f390">{{ __('map.custom.edit.node.icon_options.desktop')  }}</option>
                                         <option value="f7c0">{{ __('map.custom.edit.node.icon_options.dish')  }}</option>
                                         <option value="f7bf">{{ __('map.custom.edit.node.icon_options.satellite')  }}</option>
                                         <option value="f1eb">{{ __('map.custom.edit.node.icon_options.wifi')  }}</option>
                                         <option value="f0c2">{{ __('map.custom.edit.node.icon_options.cloud')  }}</option>
                                         <option value="f0ac">{{ __('map.custom.edit.node.icon_options.globe')  }}</option>
                                         <option value="f519">{{ __('map.custom.edit.node.icon_options.tower')  }}</option>
                                         <option value="f061">{{ __('map.custom.edit.node.icon_options.arrow_right')  }}</option>
                                         <option value="f060">{{ __('map.custom.edit.node.icon_options.arrow_left')  }}</option>
@@ -151,243 +151,18 @@
                                 <div class="col-sm-2">
                                     <button type=button class="btn btn-primary" value="reset" id="nodecolourbdrreset" onclick="$('#nodecolourbdr').val(newnodeconf.color.border); $(this).attr('disabled','disabled');">{{ __('Reset') }}</button>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <center>
-                    <button type=button class="btn btn-primary" value="savedefaults" id="node-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="nodeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
+                    <button type=button class="btn btn-primary" value="savedefaults" id="node-saveDefaultsButton" data-dismiss="modal" style="display:none" onclick="editNodeDefaultsSave();">{{ __('map.custom.edit.defaults') }}</button>
                     <button type=button class="btn btn-primary" value="save" id="node-saveButton" data-dismiss="modal">{{ __('Save') }}</button>
-                    <button type=button class="btn btn-primary" value="cancel" id="node-cancelButton" data-dismiss="modal" onclick="nodeCancel();">{{ __('Cancel') }}</button>
+                    <button type=button class="btn btn-primary" value="cancel" id="node-cancelButton" data-dismiss="modal" onclick="editNodeCancel();">{{ __('Cancel') }}</button>
                 </center>
             </div>
         </div>
     </div>
 </div>
-<script>
-    function nodeCheckColourReset(itemColour, defaultColour, resetControlId) {
-        if(!itemColour || itemColour.toLowerCase() == defaultColour.toLowerCase()) {
-            $("#" + resetControlId).attr('disabled','disabled');
-        } else {
-            $("#" + resetControlId).removeAttr('disabled');
-        }
-    }
-    function nodeMapLinkChange() {
-        if($("#maplink").val()) {
-            $("#nodeDeviceSearchRow").hide();
-        } else {
-            $("#nodeDeviceSearchRow").show();
-        }
-    }
-    function nodeSetIcon() {
-        var newcode = $("#nodeicon").val();
-        $("#nodeiconpreview").text(String.fromCharCode(parseInt(newcode, 16)));
-    }
-    function nodeSetImage() {
-        if($("#nodeimage option:selected").css('display') == 'none') {
-            $("#nodeimage").val($("#nodeimage option:eq(1)").val());
-        }
-        if($("#nodeimage").val()) {
-            $("#nodeimagepreview").attr("src", custom_image_base + $("#nodeimage").val());
-        } else {
-            $("#nodeimagepreview").attr("src", $("#device_image").val());
-        }
-    }
-    function nodeStyleChange() {
-        var nodestyle = $("#nodestyle").val();
-        if(nodestyle == 'icon') {
-            $("#nodeIconRow").show();
-        } else {
-            $("#nodeIconRow").hide();
-        }
-        if(nodestyle == 'image' || nodestyle == 'circularImage') {
-            $("#nodeImageRow").show();
-        } else {
-            $("#nodeImageRow").hide();
-        }
-    }
-    function nodeDeviceSelect(e) {
-        var id = e.params.data.id;
-        var name = e.params.data.text;
-        $("#device_id").val(id);
-        $("#device_name").text(name);
-        $("#nodelabel").val(name.split(".")[0].split(" ")[0]);
-        $("#device_image").val(e.params.data.icon);
-        $("#nodeDeviceSearchRow").hide();
-        $("#nodeMapLinkRow").hide();
-        $("#deviceiconimage").show();
-        $("#nodeDeviceRow").show();
-    }
-    function nodeDeviceClear() {
-        $("#devicesearch").val('');
-        $("#devicesearch").trigger('change');
-        $("#device_id").val("");
-        $("#device_name").text("");
-        $("#device_image").val("");
-        $("#nodeDeviceRow").hide();
-        $("#deviceiconimage").hide();
-        $("#nodeDeviceSearchRow").show();
-        $("#nodeMapLinkRow").show();
-        if(($("#nodestyle").val() == "image" || $("#nodestyle").val() == "circularImage") && !$("#nodeimage").val()){
-            $("#nodestyle").val(newnodeconf.shape);
-            $("#nodeImageRow").hide();
-            nodeSetImage();
-        }
-    }
-    function nodeCancel(event) {
-        $("#node-saveButton").off("click");
-    }
-    function nodeSave(event) {
-        node = event.data.data;
-        $("#node-saveButton").off("click");
-        if($("#device_id").val()) {
-            node.title = $("#device_id").val();
-        } else if($("#maplink").val()) {
-            node.title = "map:" + $("#maplink").val();
-        } else {
-            node.title = '';
-        }
-        node.label = $("#nodelabel").val();
-        node.shape = $("#nodestyle").val();
-        node.font.face = $("#nodetextface").val();
-        node.font.size = parseInt($("#nodetextsize").val());
-        node.font.color = $("#nodetextcolour").val();
-        node.color = {highlight: {}, hover: {}};
-        node.color.background = node.color.highlight.background = node.color.hover.background = $("#nodecolourbg").val();
-        node.color.border = node.color.highlight.border = node.color.hover.border = $("#nodecolourbdr").val();
-        node.size = $("#nodesize").val();
-        if(node.shape == "image" || node.shape == "circularImage") {
-            if($("#nodeimage").val()) {
-                node.image = {unselected: custom_image_base + $("#nodeimage").val()};
-            } else {
-                node.image = {unselected: $("#device_image").val()};
-            }
-        } else {
-            node.image = {};
-        }
-        if(node.shape == "icon") {
-            node.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: node.color.border};
-        } else {
-            node.icon = {};
-        }
-        if(node.add) {
-            delete node.add;
-            network_nodes.add(node);
-        } else {
-            network_nodes.update(node);
-        }
-        if(node.id) {
-            if($("#device_id").val()) {
-                node_device_map[node.id] = {device_id: $("#device_id").val(), device_name: $("#device_name").text(), device_image: $("#device_image").val()}
-            } else {
-                delete node_device_map[node.id];
-            }
-        }
-        $("#map-saveDataButton").show();
-        $("#map-renderButton").show();
-    }
-    function nodeEdit(nodeconf) {
-        if (!nodeconf.id) {
-            $("#nodeModalLabel").text('{{ __('map.custom.edit.node.defaults_title') }}');
-            $(".single-node").hide();
-        } else if(nodeconf.add) {
-            $("#nodeModalLabel").text('{{ __('map.custom.edit.node.add') }}');
-            $(".single-node").show();
-        } else {
-            $("#nodeModalLabel").text('{{ __('map.custom.edit.node.edit') }}');
-            $(".single-node").show();
-        }
-        $("#devicesearch").val('');
-        $("#devicesearch").trigger('change');
-        if(nodeconf.id in node_device_map) {
-            $("#device_id").val(node_device_map[nodeconf.id].device_id);
-            $("#device_name").text(node_device_map[nodeconf.id].device_name);
-            $("#nodeDeviceSearchRow").hide();
-            $("#nodeMapLinkRow").hide();
-            $("#deviceiconimage").show();
-            $("#device_image").val(node_device_map[nodeconf.id].device_image);
-        } else {
-            $("#device_id").val("");
-            $("#device_name").text("");
-            $("#nodeDeviceRow").hide();
-            $("#deviceiconimage").hide();
-            $("#device_image").val("");
-        }
-        if(nodeconf.title && nodeconf.title.toString().startsWith("map:")) {
-            $("#nodeDeviceSearchRow").hide();
-            $("#maplink").val(nodeconf.title.replace("map:",""));
-        } else {
-            $("#maplink").val("");
-        }
-        $("#nodelabel").val(nodeconf.label);
-        $("#nodestyle").val(nodeconf.shape);
-        if(nodeconf.shape == "image" || nodeconf.shape == "circularImage") {
-            $("#nodeImageRow").show();
-            if(nodeconf.image.unselected.indexOf(custom_image_base) == 0) {
-                $("#nodeimage").val(nodeconf.image.unselected.replace(custom_image_base, ""));
-            } else {
-                $("#nodeimage").val("");
-            }
-        } else {
-            $("#nodeImageRow").hide();
-            $("#nodeimage").val("");
-        }
-        nodeSetImage();
-        if(nodeconf.shape == "icon") {
-            $("#nodeicon").val(nodeconf.icon.code.charCodeAt(0).toString(16));
-            $("#nodeIconRow").show();
-        } else {
-            $("#nodeIconRow").hide();
-        }
-        nodeSetIcon();
-        $("#nodesize").val(nodeconf.size);
-        $("#nodetextface").val(nodeconf.font.face);
-        $("#nodetextsize").val(nodeconf.font.size);
-        $("#nodetextcolour").val(nodeconf.font.color);
-        if(nodeconf.color && nodeconf.color.background) {
-            $("#nodecolourbg").val(nodeconf.color.background);
-            $("#nodecolourbdr").val(nodeconf.color.border);
-        } else {
-            $("#nodecolourbg").val(newnodeconf.color.background);
-            $("#nodecolourbdr").val(newnodeconf.color.border);
-        }
-        nodeCheckColourReset(nodeconf.font.color, newnodeconf.font.color, "nodecolourtextreset");
-        nodeCheckColourReset(nodeconf.color.background, newnodeconf.color.background, "nodecolourbgreset");
-        nodeCheckColourReset(nodeconf.color.border, newnodeconf.color.border, "nodecolourbdrreset");
-        if(nodeconf.id) {
-            $("#node-saveButton").on("click", {data: nodeconf}, nodeSave);
-            $("#node-saveButton").show();
-            $("#node-saveDefaultsButton").hide();
-        } else {
-            $("#node-saveButton").hide();
-            $("#node-saveDefaultsButton").show();
-        }
-        $('#nodeModal').modal({backdrop: 'static', keyboard: false}, 'show');
-    }
-    function nodeDefaultsSave() {
-        newnodeconf.shape = $("#nodestyle").val();
-        newnodeconf.size = $("#nodesize").val();
-        newnodeconf.font.face = $("#nodetextface").val();
-        newnodeconf.font.size = $("#nodetextsize").val();
-        newnodeconf.font.color = $("#nodetextcolour").val();
-        newnodeconf.color.background = $("#nodecolourbg").val();
-        newnodeconf.color.border = $("#nodecolourbdr").val();
-        if(newnodeconf.shape == "icon") {
-            newnodeconf.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt($("#nodeicon").val(), 16)), size: $("#nodesize").val(), color: newnodeconf.color.border};
-        } else {
-            newnodeconf.icon = {};
-        }
-        if(newnodeconf.shape == "image" || newnodeconf.shape == "circularImage") {
-            newnodeconf.image = {unselected: custom_image_base + $("#nodeimage").val()};
-        } else {
-            delete newnodeconf.image;
-        }
-        $("#map-saveDataButton").show();
-    }
-    $(document).ready(function () {
-        init_select2('#devicesearch', 'device', {limit: 100}, '', '{{ __('map.custom.edit.node.device_select') }}', {dropdownParent: $('#nodeModal')});
-        $("#devicesearch").on("select2:select", nodeDeviceSelect);
-    });
-</script>

--- a/resources/views/map/custom-view.blade.php
+++ b/resources/views/map/custom-view.blade.php
@@ -38,62 +38,204 @@
         grid-row: 1 / 1;
         z-index: 2;
     }
         grid-column: 1 / 1;
         grid-row: 1 / 1;
         z-index: 1;
     }
 </style>
 @endpush
 @section('scripts')
-@include('map.custom-js')
 <script type="text/javascript">
     var bgtype = {{ Js::from($background_type) }};
     var bgdata = {{ Js::from($background_config) }};
     var screenshot = {{ $screenshot ? "true" : "false" }};
     var reverse_arrows = {{$reverse_arrows}};
     var legend = @json($legend);
     var network;
+    var network_height;
+    var network_width;
     var network_nodes = new vis.DataSet({queue: {delay: 100}});
     var network_edges = new vis.DataSet({queue: {delay: 100}});
     var edge_port_map = {};
     var node_device_map = {};
     var node_link_map = {};
     var custom_image_base = "{{ $base_url }}images/custommap/icons/";
     var network_options = {{ Js::from($map_conf) }};
+    function legendPctColour(pct) {
+        if (pct < 0) {
+            return "black";
+        } else if (pct < 50) {
+            return '#' + parseInt(5.1 * pct).toString(16).padStart(2, 0) + 'ff00';
+        } else if (pct < 100) {
+            return '#ff' + parseInt(5.1 * (100.0 - pct)).toString(16).padStart(2, 0) + '00';
+        } else if (pct < 150) {
+            return '#ff00' + parseInt(5.1 * (pct - 100.0)).toString(16).padStart(2, 0);
+        }
+        return '#ff00ff';
+    }
+    function redrawLegend() {
+        old_nodes = network_nodes.get({filter: function(node) { return node.id.startsWith("legend_") }});
+        old_nodes.forEach((node) => {
+            network_nodes.remove(node.id);
+        });
+        if (legend.x >= 0) {
+            let y_pos = legend.y;
+            let y_inc = legend.font_size + 10;
+            let legend_header = {id: "legend_header", label: "<b>Legend</b>", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {multi: 'html', size: legend.font_size}, color: {background: "white"}};
+            network_nodes.add(legend_header);
+            y_pos += y_inc;
+            if (!(Boolean(legend.hide_invalid))) {
+                let legend_invalid = {id: "legend_invalid", label: "???", title: "Link is down or link speed is not defined", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "white"}, color: {background: "black"}};
+                y_pos += y_inc;
+                network_nodes.add(legend_invalid);
+            }
+            let pct_step;
+            if (Boolean(legend.hide_overspeed)) {
+                pct_step = 100.0 / (legend.steps - 1);
+            } else {
+                pct_step = 150.0 / (legend.steps - 1);
+            }
+            for (let i=0; i < legend.steps; i++) {
+                let this_pct = Math.round(pct_step * i);
+                let legend_step = {id: "legend_" + i.toString(), label: this_pct.toString().padStart(3, " ") + "%", shape: "box", borderWidth: 0, x: legend.x, y: y_pos, font: {face: 'courier new', size: legend.font_size, color: "black"}, color: {background: legendPctColour(this_pct)}};
+                network_nodes.add(legend_step);
+                y_pos += y_inc;
+            }
+            network_nodes.flush();
+        }
+    }
+    function CreateNetwork() {
+        network_nodes.flush();
+        network_edges.flush();
+        var container = document.getElementById('custom-map');
+        network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, network_options);
+        network_height = $($(container).children(".vis-network")[0]).height();
+        network_width = $($(container).children(".vis-network")[0]).width();
+        var centreY = Math.round(network_height / 2);
+        var centreX = Math.round(network_width / 2);
+        network.moveTo({position: {x: centreX, y: centreY}, scale: 1});
+        setCustomMapBackground('custom-map', bgtype, bgdata);
+        network.on('doubleClick', function (properties) {
+            edge_id = null;
+            if (properties.nodes.length > 0) {
+                if(properties.nodes[0] in node_device_map) {
+                    window.location.href = "device/"+node_device_map[properties.nodes[0]].device_id;
+                } else if (properties.nodes[0] in node_link_map) {
+                    window.location.href = '{{ route('maps.custom.show', ['map' => '?']) }}'.replace('?', node_link_map[properties.nodes[0]]);
+                } else if (properties.nodes[0].endsWith('_mid')) {
+                    edge_id = properties.nodes[0].split("_")[0];
+                }
+            } else if (properties.edges.length > 0) {
+                edge_id = properties.edges[0].split("_")[0];
+            }
+            if (edge_id && (edge_id in edge_port_map)) {
+               window.location.href = 'device/device=' + edge_port_map[edge_id].device_id + '/tab=port/port=' + edge_port_map[edge_id].port_id + '/';
+            }
+        });
+    }
     var Countdown;
     function refreshMap() {
         $.get( '{{ route('maps.custom.data', ['map' => $map_id]) }}')
             .done(function( data ) {
                 $.each( data.nodes, function( nodeid, node) {
-                    var node_cfg = custommap.getNodeCfg(nodeid, node, screenshot, custom_image_base);
+                    var node_cfg = {};
+                    node_cfg.id = nodeid;
                     if(node.device_id) {
                         node_device_map[nodeid] = {device_id: node.device_id, device_name: node.device_name};
                         delete node_link_map[nodeid];
+                        node_cfg.title = node.device_info;
                     } else if(node.linked_map_name) {
                         delete node_device_map[nodeid];
                         node_link_map[nodeid] = node.linked_map_id;
-                    } else {
-                        delete node_device_map[nodeid];
-                        delete node_link_map[nodeid];
+                        node_cfg.title = "Go to " + node.linked_map_name;
+                    } else {
+                        node_cfg.title = null;
+                    }
+                    node_cfg.label = screenshot ? node.label.replace(/./g, ' ') : node.label;
+                    node_cfg.shape = node.style;
+                    node_cfg.borderWidth = node.border_width;
+                    node_cfg.x = node.x_pos;
+                    node_cfg.y = node.y_pos;
+                    node_cfg.font = {face: node.text_face, size: node.text_size, color: node.text_colour};
+                    node_cfg.size = node.size;
+                    node_cfg.color = {background: node.colour_bg_view, border: node.colour_bdr_view};
+                    if(node.style == "icon") {
+                        node_cfg.icon = {face: 'FontAwesome', code: String.fromCharCode(parseInt(node.icon, 16)), size: node.size, color: node.colour_bdr};
+                    } else {
+                        node_cfg.icon = {};
+                    }
+                    if(node.style == "image" || node.style == "circularImage") {
+                        if(node.image) {
+                            node_cfg.image = {unselected: custom_image_base + node.image};
+                        } else if (node.device_image) {
+                            node_cfg.image = {unselected: node.device_image};
+                        } else {
+                            node_cfg.shape = newnodeconf.shape;
+                            node_cfg.icon = newnodeconf.icon;
+                            node_cfg.image = newnodeconf.image;
+                        }
+                    } else {
+                        node_cfg.image = {};
                     }
                     if (network_nodes.get(nodeid)) {
                         network_nodes.update(node_cfg);
                     } else {
                         network_nodes.add([node_cfg]);
                     }
                 });
                 $.each( data.edges, function( edgeid, edge) {
-                    var mid = custommap.getEdgeMidCfg(edgeid, edge, screenshot);
-                    var edge1 = custommap.getEdgeCfg(edgeid, edge, "from", reverse_arrows);
-                    var edge2 = custommap.getEdgeCfg(edgeid, edge, "to", reverse_arrows);
+                    var mid_x = edge.mid_x;
+                    var mid_y = edge.mid_y;
+                    var mid = {id: edgeid + "_mid", shape: "dot", size: 0, x: mid_x, y: mid_y, label: screenshot ? '' : edge.label};
+                    if (Boolean(reverse_arrows)) {
+                        arrows = {from: {enabled: true, scaleFactor: 0.6}, to: {enabled: false}};
+                    } else {
+                        arrows = {to: {enabled: true, scaleFactor: 0.6}, from: {enabled: false}};
+                    }
+                    var edge1 = {id: edgeid + "_from", from: edge.custom_map_node1_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
+                    var edge2 = {id: edgeid + "_to", from: edge.custom_map_node2_id, to: edgeid + "_mid", arrows: arrows, font: {face: edge.text_face, size: edge.text_size, color: edge.text_colour}, smooth: {type: edge.style}};
+                    if(edge2.smooth.type == "curvedCW") {
+                        edge2.smooth.type = "curvedCCW";
+                    } else if (edge2.smooth.type == "curvedCCW") {
+                        edge2.smooth.type = "curvedCW";
+                    }
                     if(edge.port_id) {
+                        var edge_port_from;
+                        var edge_port_to;
+                        if (Boolean(reverse_arrows)) {
+                            port_from = edge2;
+                            port_to = edge1;
+                        } else {
+                            port_from = edge1;
+                            port_to = edge2;
+                        }
+                        port_from.title = port_to.title = edge.port_info;
+                        if(edge.showpct) {
+                            port_from.label = edge.port_frompct + "%";
+                            port_to.label = edge.port_topct + "%";
+                        }
+                        if(edge.showbps) {
+                            if(port_from.label == null) {
+                                port_from.label = '';
+                                port_to.label = '';
+                            } else {
+                                port_from.label += "\n";
+                                port_to.label += "\n";
+                            }
+                            port_from.label += edge.port_frombps;
+                            port_to.label += edge.port_tobps;
+                        }
+                        port_from.color = {color: edge.colour_from};
+                        port_from.width = edge.width_from;
+                        port_to.color = {color: edge.colour_to};
+                        port_to.width = edge.width_to;
                         edge_port_map[edgeid] = {device_id: edge.device_id, port_id: edge.port_id};
                     } else {
                         delete edge_port_map[edgeid];
                     }
                     if (network_nodes.get(mid.id)) {
                         network_nodes.update(mid);
                         network_edges.update(edge1);
                         network_edges.update(edge2);
                     } else {
                         network_nodes.add([mid]);
@@ -107,50 +249,33 @@
                             network_nodes.remove(edgeid + "_mid");
                             network_edges.remove(edgeid + "_to");
                             network_edges.remove(edgeid + "_from");
                         }
                     } else {
                         if(! (nodeid in data.nodes)) {
                             network_nodes.remove(nodeid);
                         }
                     }
                 });
-                custommap.redrawDefaultLegend(network_nodes, legend.steps, legend.x, legend.y, legend.font_size, legend.hide_invalid, legend.hide_overspeed, legend.colours);
+                redrawLegend();
                 network_nodes.flush();
                 network_edges.flush();
                 if (Object.keys(data).length == 0) {
                     $("#alert").text('{{ __('map.custom.view.no_devices') }}');
                     $("#alert-row").show();
                 } else {
                     $("#alert").text("");
                     $("#alert-row").hide();
                 }
             });
         if (! network) {
-            network = custommap.createNetwork("custom-map", 1, network_nodes, network_edges, network_options, bgtype, bgdata);
-            network.on('doubleClick', function (properties) {
-                edge_id = null;
-                if (properties.nodes.length > 0) {
-                    if(properties.nodes[0] in node_device_map) {
-                        window.location.href = "device/"+node_device_map[properties.nodes[0]].device_id;
-                    } else if (properties.nodes[0] in node_link_map) {
-                        window.location.href = '{{ route('maps.custom.show', ['map' => '?']) }}'.replace('?', node_link_map[properties.nodes[0]]);
-                    } else if (properties.nodes[0].endsWith('_mid')) {
-                        edge_id = properties.nodes[0].split("_")[0];
-                    }
-                } else if (properties.edges.length > 0) {
-                    edge_id = properties.edges[0].split("_")[0];
-                }
-                if (edge_id && (edge_id in edge_port_map)) {
-                   window.location.href = 'device/device=' + edge_port_map[edge_id].device_id + '/tab=port/port=' + edge_port_map[edge_id].port_id + '/';
-                }
-            });
+            CreateNetwork();
         }
     }
     $(document).ready(function () {
         Countdown = {
             sec: {{$page_refresh}},
             Start: function () {
                 var cur = this;
                 this.interval = setInterval(function () {
                     cur.sec -= 1;
                     if (cur.sec <= 0) {

--- a/resources/views/map/device-dependency.blade.php
+++ b/resources/views/map/device-dependency.blade.php
@@ -1,148 +1,51 @@
 @extends('layouts.librenmsv1')
 @section('title', __('Device Dependency Map'))
 @section('content')
-<div class="container-fluid">
-<div class="row">
-<div class="col-md-12">
-@if($group_name)
+@if($node_count)
 &nbsp;<big><b>{{ $group_name }}</b></big>
+<div class="pull-right">
+<input type="checkbox" class="custom-control-input" id="showparentdevicepath" onChange="highlightNode()" @if($showparentdevicepath) checked @endif>
+<label class="custom-control-label" for="showparentdevicepath">{{ __('Highlight Dependencies to Root Device') }}</label>
+<select name="highlight_node" id="highlight_node" class="input-sm" onChange="highlightNode()";>
+<option value="0">None</option>
+<option value="{{ $isolated_device_id }}">{{ __('Isolated Devices') }}</option>
+@foreach($device_list as $device)
+<option value="{{ $device['id'] }}">{{ $device['label'] }}</option>
+@endforeach
+</select>
+</div>
+<div id="visualization"></div>
+@else
+<div class="alert alert-success" role="alert">{{ __('No devices found') }}</div>
 @endif
-<div class="pull-right">
-    Highlight Node
-    <select name="highlight_node" id="highlight_node" class="input-sm" onChange="refreshMap()";>
-        <option value="0">None</option>
-        <option value="-1">Isolated Devices</option>
-    </select>
-    <input type="checkbox" class="custom-control-input" id="showparentdevicepath" onChange="updateHighlight(this)">
-    <label class="custom-control-label" for="showparentdevicepath">{{ __('Highlight Dependencies to Root Device') }}</label>
-    <input type="checkbox" class="custom-control-input" id="showchilddevicepath" onChange="updateHighlight(this)">
-    <label class="custom-control-label" for="showchilddevicepath">{{ __('Highlight All Child Devices') }}</label>
-</div>
-</div>
-</div>
-<div class="row" id="alert-row">
-<div class="col-md-12">
-<div class="alert alert-warning" role="alert" id="alert">Loading data</div>
-</div>
-</div>
-<div class="row" id="alert">
-<div class="col-md-12">
-<div id="visualization"></div>
-</div>
-</div>
-</div>
 @endsection
 @section('javascript')
 <script type="text/javascript" src="{{ asset('js/vis.min.js') }}"></script>
 @endsection
 @section('scripts')
 <script type="text/javascript">
     var height = $(window).height() - 100;
     $('#visualization').height(height + 'px');
-    var network_nodes = new vis.DataSet({queue: {delay: 100}});
-    var network_edges = new vis.DataSet({queue: {delay: 100}});
-    var network;
-    var Countdown;
-    function updateHighlight(hlcb) {
-        if (hlcb.id == 'showchilddevicepath') {
-            $("#showparentdevicepath").prop( "checked", false );
-        } else if (hlcb.id == 'showparentdevicepath') {
-            $("#showchilddevicepath").prop( "checked", false );
+    var nodes = {!! $nodes !!};
+    var edges = {!! $edges !!};
+    var container = document.getElementById('visualization');
+    var data = {
+        nodes: nodes,
+        edges: edges,
+        stabilize: true
+    };
+    var options = {!! $options !!};
+    var network = new vis.Network(container, data, options);
+    network.on('click', function (properties) {
+        if (properties.nodes > 0) {
+            window.location.href = "device/device="+properties.nodes+"/"
         }
-        refreshMap();
+    });
+    function highlightNode(e) {
+        highlight_node = document.getElementById("highlight_node").value;
+        showparentdevicepath = document.getElementById("showparentdevicepath").checked ? 1: 0;
+        window.location.href = 'maps/devicedependency?group={{ $group_id }}&highlight_node=' + highlight_node + '&showparentdevicepath=' + showparentdevicepath;
     }
-    function refreshMap() {
-        var highlight = $("#highlight_node").val();
-        var showpath = 0;
-        if ($("#showparentdevicepath")[0].checked) {
-            showpath = 1;
-        } else if ($("#showchilddevicepath")[0].checked) {
-            showpath = -1;
-        }
-@if($group_id)
-        var group = {{ $group_id }};
-@else
-        var group = null;
-@endif
-        $.post( '{{ route('maps.getdevices') }}', {disabled: 0, disabled_alerts: null, link_type: "depends", url_type: "links", group: group, highlight_node: highlight, showpath: showpath})
-            .done(function( data ) {
-                let device_count = Object.keys(data).length;
-                if (device_count === 0) {
-                    $("#alert").text("No devices found");
-                    $("#alert-row").show();
-                } else if (device_count > 500) {
-                    $("#alert").text("The initial render will be slow due to the number of devices.  Auto refresh has been paused.");
-                    $("#alert-row").show();
-                } else {
-                    $("#alert").text("");
-                    $("#alert-row").hide();
-                }
-                function deviceSort(a,b) {
-                    return (data[a]["sname"] > data[b]["sname"]) ? 1 : -1;
-                }
-                var keys = Object.keys(data).sort(deviceSort);
-                $.each( keys, function( dev_idx, device_id ) {
-                    var device = data[device_id];
-                    var this_dev = {id: device_id, label: device["sname"], title: device["url"], shape: "box", level: device["level"]}
-                    if (device["style"]) {
-                        this_dev = Object.assign(device["style"], this_dev);
-                    }
-                    if (network_nodes.get(device_id)) {
-                        network_nodes.update(this_dev);
-                    } else {
-                        network_nodes.add([this_dev]);
-                        var highlight_option = document.createElement("option");
-                        highlight_option.value = device_id;
-                        highlight_option.id = "highlight-device-" + device_id;
-                        highlight_option.textContent = device["sname"];
-                        document.getElementById("highlight_node").appendChild(highlight_option);
-                    }
-                    $.each( device["parents"], function( parent_idx, parent_id ) {
-                        link_id = device_id + "." + parent_id;
-                        if (!network_edges.get(link_id)) {
-                            network_edges.add([{from: device_id, to: parent_id, width: 2}]);
-                        }
-                    })
-                })
-                if (! network) {
-                    network_nodes.flush();
-                    network_edges.flush();
-                    var container = document.getElementById('visualization');
-                    var options = {!! $options !!};
-                    network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, options);
-                    network.on('click', function (properties) {
-                        if (properties.nodes > 0) {
-                            let cur_highlighted = $('#highlight_node').val();
-                            if (cur_highlighted == properties.nodes) {
-                                $('#highlight_node').val(0).trigger('change');
-                            } else {
-                                $('#highlight_node').val(properties.nodes).trigger('change');
-                            }
-                        }
-                    });
-                    network.on('doubleClick', function (properties) {
-                        if (properties.nodes > 0) {
-                            window.location.href = "device/device="+properties.nodes+"/"
-                        }
-                    });
-                } else {
-                    $.each( network_nodes.getIds(), function( dev_idx, device_id ) {
-                        if (!(device_id in data)) {
-                            network_nodes.remove(device_id);
-                            var option_id = "#highlight-device-" + device_id;
-                            $(option_id).remove();
-                        }
-                    });
-                }
-                $("#alert").text("");
-                $("#alert-row").hide();
-            });
-    }
-    $(document).ready(function () {
-        Countdown.Pause();
-        refreshMap();
-        Countdown.Resume();
-    });
+    $('#highlight_node option[value="{{$highlight_node}}"]').prop('selected', true);
 </script>
-<x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
 @endsection

--- a/resources/views/map/fullscreen.blade.php
+++ b//dev/null
@@ -1,206 +0,0 @@
-@extends('layouts.librenmsv1')
-@section('title', __('Geographical Map'))
-@section('content')
-@if($map_engine != 'leaflet')
-<div class="container-fluid">
-<div class="row">
-<div class="col-md-12">
-Only leaflet map engine is currently supported
-</div>
-</div>
-</div>
-@else
-@if($group_name)
-<div class="container-fluid">
-<div class="row" id="controls-row">
-<div class="col-md-12">
-&nbsp;
-<big><b>{{ $group_name }}</b></big>
-</div>
-</div>
-</div>
-@endif
-<div class="container" id="fullscreen-map"></div>
-@endif
-@endsection
-@section('css')
-<style>
-html, body, #fullscreen-map {
-   height: 100%;
-   width: 100%;
-   padding-bottom: 0;
-   margin-bottom: 0;
-}
-</style>
-@endsection
-@section('javascript')
-@if($map_engine == "leaflet")
-<script src="js/leaflet.js"></script>
-<script src="js/L.Control.Locate.min.js"></script>
-<script src="js/leaflet.markercluster.js"></script>
-<script src="js/leaflet.awesome-markers.min.js"></script>
-@endif
-@endsection
-@section('scripts')
-<script type="text/javascript">
-    function checkMapSize() {
-        var mapheight = $(window).height() - $("#fullscreen-map").offset().top;
-        if(mapheight < 200) {
-            mapheight = 200;
-        }
-        $("#fullscreen-map").height(mapheight);
-    };
-    window.addEventListener('resize', checkMapSize);
-    checkMapSize();
-    var device_map = init_map("fullscreen-map", {engine: "{{$map_provider}}", api_key: "{{$map_api_key}}", "tile_url": "{{$tile_url}}", lat: {{$init_lat}}, lng: {{$init_lng}}, zoom: {{$init_zoom}}});
-    var device_marker_cluster = L.markerClusterGroup({
-        maxClusterRadius: {{$group_radius}},
-        iconCreateFunction: function (cluster) {
-            var markers = cluster.getAllChildMarkers();
-            var n = 0;
-            color = "green"
-            newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
-            for (var i = 0; i < markers.length; i++) {
-                if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
-                    color = "blue";
-                }
-                if (markers[i].options.icon.options.markerColor == "red") {
-                    color = "red";
-                }
-            }
-            return L.divIcon({ html: cluster.getChildCount(), className: color+newClass, iconSize: L.point(40, 40) });
-        },
-    });
-    device_map.addLayer(device_marker_cluster);
-    var redMarker = L.AwesomeMarkers.icon({
-        icon: 'server',
-        markerColor: 'red', prefix: 'fa', iconColor: 'white'
-    });
-    var blueMarker = L.AwesomeMarkers.icon({
-        icon: 'server',
-        markerColor: 'blue', prefix: 'fa', iconColor: 'white'
-    });
-    var greenMarker = L.AwesomeMarkers.icon({
-        icon: 'server',
-        markerColor: 'green', prefix: 'fa', iconColor: 'white'
-    });
-    var device_markers = {};
-    var link_markers = {};
-    function checkParentLink(device, parent) {
-        line_id = "dev." + device["id"] + "." + parent["id"];
-        if(line_id in link_markers) {
-            link_markers[line_id].setLatLngs([new L.LatLng(device["lat"],device["lng"]), new L.LatLng(parent["lat"],parent["lng"])]);
-        } else {
-            var line = new L.Polyline([new L.LatLng(device["lat"],device["lng"]), new L.LatLng(parent["lat"],parent["lng"])], {
-                color: "blue",
-                weight: 2,
-                opacity: 0.8,
-                smoothFactor: 1
-            });
-            link_markers[line_id] = line;
-            device_marker_cluster.addLayer(line);
-        }
-        return line_id;
-    }
-    function refreshMap() {
-        var devices = {};
-        var links = {};
-        var device_group = {{ $group_id ? $group_id : 'null' }};
-@if($show_netmap && $netmap_source == 'depends')
-        $.post( '{{ route('maps.getdevices') }}', {disabled: 0, location_valid: 1, disabled_alerts: {{$netmap_include_disabled_alerts}}, group: device_group, link_type: '{{$netmap_source}}'})
-@else
-        $.post( '{{ route('maps.getdevices') }}', {disabled: 0, location_valid: 1, disabled_alerts: {{$netmap_include_disabled_alerts}}, group: device_group})
-@endif
-            .done(function( data ) {
-                $.each( data, function( device_id, device ) {
-                    var icon = greenMarker;
-                    var z_offset = 0;
-                    if (device["status"] == 0) {
-                        if (device["maintenance"] != 0) {
-                            icon = blueMarker;
-                            z_offset = 5000;
-                        } else {
-                            icon = redMarker;
-                            z_offset = 10000;
-                        }
-                    }
-                    if(device_id in device_markers) {
-                        device_markers[device_id].setLatLng(new L.LatLng(device["lat"], device["lng"]));
-                        device_markers[device_id].setZIndexOffset(z_offset);
-                        device_markers[device_id].setIcon(icon);
-                        $.each( device["parents"], function( parent_idx, parent_id ) {
-                            if (parent_id in data && (data[parent_id]["lat"] != device["lat"] || data[parent_id]["lng"] != device["lng"])) {
-                                var line_id = checkParentLink(device, data[parent_id]);
-                                links[line_id] = true;
-                            }
-                        });
-                    } else {
-                        var marker = L.marker(new L.LatLng(device["lat"],device["lng"]), {title: device["sname"], icon: icon, zIndexOffset: z_offset});
-                        marker.bindPopup("<a href=\"" + device["url"] + "\"><img src=\"" + device["icon"] + "\" width=\"32\" height=\"32\" alt=\"\"> " + device["sname"] + "</a>");
-                        device_marker_cluster.addLayer(marker);
-                        device_markers[device_id] = marker;
-                        $.each( device["parents"], function( parent_idx, parent_id ) {
-                            if (parent_id in data && (data[parent_id]["lat"] != device["lat"] || data[parent_id]["lng"] != device["lng"])) {
-                                var line_id = checkParentLink(device, data[parent_id]);
-                                links[line_id] = true;
-                            }
-                        });
-                    }
-                    devices[device_id] = true;
-                })
-                $("#countdown").css("border", "1px solid green");
-                $.each( device_markers, function( device_id, marker ) {
-                    if(! (device_id in devices)) {
-                        device_marker_cluster.removeLayer(marker);
-                    }
-                });
-@if($show_netmap && $netmap_source == 'depends')
-                $.each( link_markers, function( link_id, line ) {
-                    if(! (link_id in links)) {
-                        device_marker_cluster.removeLayer(line);
-                    }
-                });
-@endif
-            })
-            .fail(function() {
-                $("#countdown").css("border", "1px solid red");
-            });
-@if($show_netmap && $netmap_source == 'xdp')
-        $.post( '{{ route('maps.getgeolinks') }}', {link_type: '{{$netmap_source}}', group: device_group})
-            .done(function( data ) {
-                $.each( data, function( link_id, link) {
-                    if(link_id in link_markers) {
-                        link_markers[link_id].setStyle({color: link['color'], weight: link['width']}).setLatLngs([new L.LatLng(link['local_lat'], link['local_lng']), new L.LatLng(link['remote_lat'], link['remote_lng'])]);
-                        links[link_id] = true;
-                    } else {
-                        var line = new L.Polyline([new L.LatLng(link['local_lat'], link['local_lng']), new L.LatLng(link['remote_lat'], link['remote_lng'])], { color: link['color'], weight: link['width'], opacity: 0.8, smoothFactor: 1});
-                        device_marker_cluster.addLayer(line);
-                        link_markers[link_id] = line;
-                        links[link_id] = true;
-                   }
-                })
-                $("#countdown").css("border", "1px solid green");
-                $.each( link_markers, function( link_id, line ) {
-                    if(! (link_id in links)) {
-                        device_marker_cluster.removeLayer(line);
-                    }
-                });
-            })
-            .fail(function() {
-                $("#countdown").css("border", "1px solid red");
-            });
-@endif
-    }
-    device_map.scrollWheelZoom.disable();
-    $(document).ready(function(){
-        $("#fullscreen-map").on("click", function(event) {
-            device_map.scrollWheelZoom.enable();
-        });
-        $("#fullscreen-map").on("mouseleave", function(event) {
-            device_map.scrollWheelZoom.disable();
-        });
-        refreshMap();
-    });
-</script>
-<x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
-@endsection

--- a/resources/views/map/netmap.blade.php
+++ b//dev/null
@@ -1,159 +0,0 @@
-@extends('layouts.librenmsv1')
-@section('title', __('Network Map'))
-@section('content')
-<div class="container-fluid">
-<div class="row">
-<div class="col-md-12">
-@if($group_name)
-&nbsp;<big><b>{{ $group_name }}</b></big>
-@endif
-<div class="pull-right">
-    Highlight Node
-    <select name="highlight_node" id="highlight_node" class="input-sm" onChange="refreshMap()";>
-        <option value="0">None</option>
-        <option value="-1">Isolated Devices</option>
-    </select>
-</div>
-</div>
-</div>
-<div class="row" id="alert-row">
-<div class="col-md-12">
-<div class="alert alert-warning" role="alert" id="alert">Loading data</div>
-</div>
-</div>
-<div class="row" id="alert">
-<div class="col-md-12">
-<div id="visualization"></div>
-</div>
-</div>
-</div>
-@endsection
-@section('javascript')
-<script type="text/javascript" src="{{ asset('js/vis.min.js') }}"></script>
-@endsection
-@section('scripts')
-<script type="text/javascript">
-    var height = $(window).height() - 100;
-    $('#visualization').height(height + 'px');
-    var network_nodes = new vis.DataSet({queue: {delay: 100}});
-    var network_edges = new vis.DataSet({queue: {delay: 100}});
-    var network;
-    async function refreshMap() {
-        var highlight = $("#highlight_node").val();
-@if($group_id)
-        var group = {{$group_id}};
-@else
-        var group = null;
-@endif
-        var hide_devices = new Map();
-        await $.ajax({
-            type: 'POST',
-            url: '{{ route('maps.getdevices') }}',
-            data: {disabled: 0, disabled_alerts: null, url_type: "links", group: group, highlight_node: highlight},
-            dataType: 'json',
-            success: function (data) {
-                if (Object.keys(data).length === 0) {
-                    $("#alert").text("No devices found");
-                    $("#alert-row").show();
-                } else if (Object.keys(data).length > 500) {
-                    $("#alert").text("The initial render will be slow due to the number of devices.  Auto refresh has been paused.");
-                    $("#alert-row").show();
-                } else {
-                    $("#alert").text("");
-                    $("#alert-row").hide();
-                }
-                var keys = Object.keys(data).sort(function (a, b) {
-                    return (data[a]["sname"] > data[b]["sname"]) ? 1 : -1; // sort by display name
-                });
-                $.each( keys, function( dev_idx, device_id ) {
-                    var device = data[device_id];
-                    var this_dev = {id: device_id, label: device["sname"], title: device["url"], shape: "box"}
-                    if (device["style"]) {
-                        this_dev = Object.assign(device["style"], this_dev);
-                    }
-                    if (network_nodes.get(device_id)) {
-                        network_nodes.update(this_dev);
-                    } else {
-                        network_nodes.add([this_dev]);
-                        var highlight_option = document.createElement("option");
-                        highlight_option.value = device_id;
-                        highlight_option.id = "highlight-device-" + device_id;
-                        highlight_option.textContent = device["sname"];
-                        document.getElementById('highlight_node').appendChild(highlight_option);
-                    }
-                    hide_devices.set(device_id.toString(), null);
-                })
-                $.each( network_nodes.getIds(), function( dev_idx, device_id ) {
-                    if (!(device_id in data)) {
-                        network_nodes.remove(device_id);
-                        var option_id = "#highlight-device-" + device_id;
-                        $(option_id).remove();
-                    }
-                });
-            }
-        });
-        await $.ajax({
-            type: 'POST',
-            url: '{{ route('maps.getdevicelinks') }}',
-            data: {disabled: 0, disabled_alerts: null, group: group, link_types: @json($link_types)},
-            dataType: 'json',
-            success: function (data) {
-                $.each( data, function( link_id, link ) {
-                    var this_edge = link['style'];
-                    this_edge['from'] = link['ldev'];
-                    this_edge['to'] = link['rdev'];
-                    this_edge['label'] = link['ifnames'];
-                    this_edge['title'] = link['url'];
-                    if (!network_edges.get(link_id)) {
-                        network_edges.add([this_edge]);
-                    }
-                    hide_devices.delete(link['ldev'].toString());
-                    hide_devices.delete(link['rdev'].toString());
-                })
-                $.each( network_edges.getIds(), function( link_idx, link_id ) {
-                    if (!(link_id in data)) {
-                        network_edges.remove(link_id);
-                    }
-                });
-            },
-        });
-        network_nodes.flush();
-        network_edges.flush();
-        network_nodes.forEach(function (item) {
-            oldval = item.hidden;
-            item.hidden = hide_devices.has(item.id.toString());
-            if (oldval != item.hidden) {
-                network_nodes.update(item);
-            }
-        });
-        if (! network) {
-            var container = document.getElementById('visualization');
-            var options = {!! $options !!};
-            network = new vis.Network(container, {nodes: network_nodes, edges: network_edges, stabilize: true}, options);
-            network.on('click', function (properties) {
-                if (properties.nodes > 0) {
-                    let cur_highlighted = $('#highlight_node').val();
-                    if (cur_highlighted == properties.nodes) {
-                        $('#highlight_node').val(-1).trigger('change');
-                    } else {
-                        $('#highlight_node').val(properties.nodes).trigger('change');
-                    }
-                }
-            });
-            network.on('doubleClick', function (properties) {
-                if (properties.nodes > 0) {
-                    window.location.href = "device/device="+properties.nodes+"/"
-                }
-            });
-        }
-    }
-    $(document).ready(async function () {
-        Countdown.Pause();
-        await refreshMap();
-        Countdown.Resume();
-        $("#alert").text("");
-        $("#alert-row").hide();
-    });
-</script>
-<x-refresh-timer :refresh="$page_refresh" callback="refreshMap"></x-refresh-timer>
-@endsection

--- a/resources/views/overview/default.blade.php
+++ b/resources/views/overview/default.blade.php
@@ -160,21 +160,20 @@
     <ul></ul>
 </div>
 </div>
 @endsection
 @section('javascript')
 <script src="{{ asset('js/jquery.gridster.min.js?ver=05072021') }}"></script>
 <script src="{{ asset('js/raphael.min.js?ver=05072021') }}"></script>
 <script src="{{ asset('js/justgage.min.js?ver=05072021') }}"></script>
 @endsection
 @push('scripts')
-@include('map.custom-js')
 <script type="text/javascript">
     var gridster;
     var serialization = @json($dash_config);
     serialization = Gridster.sort_by_row_and_col_asc(serialization);
     var gridster_state = 0;
     @if ($dashboard->dashboard_id > 0)
         var dashboard_id = {{ $dashboard->dashboard_id }};
     @else
         var dashboard_id = 0;
     @endif

--- a/resources/views/widgets/custom-map.blade.php
+++ b//dev/null
@@ -1,81 +0,0 @@
-<style>
-        display: grid;
-        grid-template: 1fr / 1fr;
-        place-items: center;
-    }
-        grid-column: 1 / 1;
-        grid-row: 1 / 1;
-        z-index: 2;
-    }
-        grid-column: 1 / 1;
-        grid-row: 1 / 1;
-        z-index: 1;
-    }
-</style>
-<div id="map-container-{{ $id }}" style="width: 100%; height: 100%">
-  <div id="custom-map-{{ $id }}" style="width: 99%; height: 99%"></div>
-  <x-geo-map id="custom-map-bg-geo-map-{{ $id }}"
-    :init="$map->background_type == 'map'"
-    :config="$background_config"
-    width="99%"
-    height="99%"
-    readonly
-  />
-</div>
-<script type="application/javascript">
-    (function () {
-        var bgtype = {{ Js::from($map->background_type) }};
-        var bgdata = {{ Js::from($background_config) }};
-        var reverse_arrows = {{$map->reverse_arrows}};
-        var legend = @json($map->legend);
-        var custom_image_base = "{{ $base_url }}images/custommap/icons/";
-        var network_nodes = new vis.DataSet({queue: {delay: 100}});
-        var network_edges = new vis.DataSet({queue: {delay: 100}});
-        var node_device_map = {};
-        var edge_port_map = {};
-        var node_link_map = {};
-        var network_options = {{ Js::from($map_conf) }};
-        var scale = {{ $scale }}
-        $.get( '{{ route('maps.custom.data', ['map' => $map->custom_map_id]) }}')
-            .done(function( data ) {
-                $.each( data.nodes, function( nodeid, node) {
-                    var node_cfg = custommap.getNodeCfg(nodeid, node, false, custom_image_base);
-                    if(node.device_id) {
-                        node_device_map[nodeid] = {device_id: node.device_id, device_name: node.device_name};
-                    } else if(node.linked_map_name) {
-                        node_link_map[nodeid] = node.linked_map_id;
-                    }
-                    network_nodes.add([node_cfg]);
-                });
-                $.each( data.edges, function( edgeid, edge) {
-                    var mid = custommap.getEdgeMidCfg(edgeid, edge, false);
-                    var edge1 = custommap.getEdgeCfg(edgeid, edge, "from", reverse_arrows);
-                    var edge2 = custommap.getEdgeCfg(edgeid, edge, "to", reverse_arrows);
-                    if(edge.port_id) {
-                        edge_port_map[edgeid] = {device_id: edge.device_id, port_id: edge.port_id};
-                    }
-                    network_nodes.add([mid]);
-                    network_edges.add([edge1, edge2]);
-                });
-                custommap.redrawDefaultLegend(network_nodes, {{ $map->legend_steps }}, {{ $map->legend_x }}, {{ $map->legend_y }}, {{ $map->legend_font_size }}, {{ $map->legend_hide_invalid }}, {{ $map->legend_hide_overspeed }}, {{ Js::from($map->legend_colours) }});
-                network = custommap.createNetwork('custom-map-{{ $id }}', scale, network_nodes, network_edges, network_options, bgtype, bgdata);
-                network.on('doubleClick', function (properties) {
-                    edge_id = null;
-                    if (properties.nodes.length > 0) {
-                        if(properties.nodes[0] in node_device_map) {
-                            window.location.href = "device/"+node_device_map[properties.nodes[0]].device_id;
-                        } else if (properties.nodes[0] in node_link_map) {
-                            window.location.href = '{{ route('maps.custom.show', ['map' => '?']) }}'.replace('?', node_link_map[properties.nodes[0]]);
-                        } else if (properties.nodes[0].endsWith('_mid')) {
-                            edge_id = properties.nodes[0].split("_")[0];
-                        }
-                    } else if (properties.edges.length > 0) {
-                        edge_id = properties.edges[0].split("_")[0];
-                    }
-                    if (edge_id && (edge_id in edge_port_map)) {
-                       window.location.href = 'device/device=' + edge_port_map[edge_id].device_id + '/tab=port/port=' + edge_port_map[edge_id].port_id + '/';
-                    }
-                });
-        });
-    })();
-</script>

--- a/resources/views/widgets/settings/custom-map.blade.php
+++ b//dev/null
@@ -1,20 +0,0 @@
-@extends('widgets.settings.base')
-@section('form')
-    <div class="form-group">
-        <label for="title-{{ $id }}" class="control-label">{{ __('Widget title') }}</label>
-        <input type="text" class="form-control" name="title" id="title-{{ $id }}" placeholder="{{ __('Custom title') }}" value="{{ $title }}">
-    </div>
-    <div class="form-group">
-        <label for="custom-map-{{ $id }}" class="control-label">{{ __('Custom Map') }}</label>
-        <select class="form-control" name="custom_map" id="custom_map-{{ $id }}" data-placeholder="{{ __('Select Map') }}">
-            @if($map)
-                <option value="{{ $map->custom_map_id }}" selected>{{ $map->name }}</option>
-            @endif
-        </select>
-    </div>
-@endsection
-@section('javascript')
-    <script type="text/javascript">
-        init_select2('#custom_map-{{ $id }}', 'custom-map', {});
-    </script>
-@endsection

--- a/resources/views/widgets/worldmap.blade.php
+++ b/resources/views/widgets/worldmap.blade.php
@@ -1,86 +1,18 @@
 <div id="worldmap_widget-{{ $id }}" class="worldmap_widget" data-reload="false"></div>
 <script type="application/javascript">
     (function () {
         const map_id = 'worldmap_widget-{{ $id }}';
         const status = {{ Js::from($status) }};
         const device_group = {{ (int) $device_group }};
         const map_config = {{ Js::from($map_config) }};
         const group_radius = {{ (int) $group_radius }};
-        function populate_map_markers(map_id, group_radius = 10, status = [0,1], device_group = 0) {
-            $.ajax({
-                type: "POST",
-                url: '{{ route('maps.getdevices') }}',
-                dataType: "json",
-                data: { location_valid: 1, disabled: 0, disabled_alerts: 0, statuses: status, group: device_group },
-                success: function (data) {
-                    var redMarker = L.AwesomeMarkers.icon({
-                        icon: 'server',
-                        markerColor: 'red', prefix: 'fa', iconColor: 'white'
-                    });
-                    var blueMarker = L.AwesomeMarkers.icon({
-                        icon: 'server',
-                        markerColor: 'blue', prefix: 'fa', iconColor: 'white'
-                    });
-                    var greenMarker = L.AwesomeMarkers.icon({
-                        icon: 'server',
-                        markerColor: 'green', prefix: 'fa', iconColor: 'white'
-                    });
-                    var markers = Object.values(data).map((device) => {
-                        var markerData = {title: device.sname};
-                        if (device.status) { // up
-                            markerData.icon = greenMarker;
-                            markerData.zIndexOffset = 0;
-                        } else if (device.maintenance == 1) { // down + maintenance
-                            markerData.icon = blueMarker;
-                            markerData.zIndexOffset = 10000;
-                        } else { // down
-                            markerData.icon = redMarker;
-                            markerData.zIndexOffset = 5000;
-                        }
-                        var marker = L.marker(new L.LatLng(device.lat, device.lng), markerData);
-                        marker.bindPopup(`<a href="${device.url}"><img src="${device.icon}" width="32" height="32" alt=""> ${device.sname}</a>`);
-                        return marker;
-                    });
-                    var map = get_map(map_id);
-                    if (! map.markerCluster) {
-                        map.markerCluster = L.markerClusterGroup({
-                            maxClusterRadius: group_radius,
-                            iconCreateFunction: function (cluster) {
-                                var markers = cluster.getAllChildMarkers();
-                                var color = "green";
-                                var newClass = "Cluster marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-clickable";
-                                for (var i = 0; i < markers.length; i++) {
-                                    if (markers[i].options.icon.options.markerColor == "blue" && color != "red") {
-                                        color = "blue";
-                                    }
-                                    if (markers[i].options.icon.options.markerColor == "red") {
-                                        color = "red";
-                                    }
-                                }
-                                return L.divIcon({
-                                    html: cluster.getChildCount(),
-                                    className: color + newClass,
-                                    iconSize: L.point(40, 40)
-                                });
-                            }
-                        });
-                        map.addLayer(map.markerCluster);
-                    }
-                    map.markerCluster.clearLayers();
-                    map.markerCluster.addLayers(markers);
-                },
-                error: function(error){
-                    toastr.error(error.statusText);
-                }
-            });
-        }
         loadjs('js/leaflet.js', function () {
             loadjs('js/leaflet.markercluster.js', function () {
                 loadjs('js/leaflet.awesome-markers.min.js', function () {
                     loadjs('js/L.Control.Locate.min.js', function () {
                         init_map(map_id, map_config).scrollWheelZoom.disable();
                         populate_map_markers(map_id, group_radius, status, device_group);
                         $('#' + map_id).on('click', function (event) {
                             get_map(map_id).scrollWheelZoom.enable();
                         }).on('mouseleave', function (event) {
                             get_map(map_id).scrollWheelZoom.disable();

--- a/routes/api.php
+++ b/routes/api.php
@@ -113,21 +113,20 @@
         Route::get('{hostname}/groups', 'LegacyApiController@get_device_groups')->name('get_device_groups_device');
         Route::get('{hostname}/maintenance', 'LegacyApiController@device_under_maintenance')->name('device_under_maintenance');
         Route::get('{hostname}/ports/{ifname}', 'LegacyApiController@get_port_stats_by_port_hostname')->name('get_port_stats_by_port_hostname')->where('ifname', '.*');
         Route::get('{hostname}/ports/{ifname}/{type}', 'LegacyApiController@get_graph_by_port_hostname')->name('get_graph_by_port_hostname');
         Route::get('{hostname}/services/{id}/graphs/{datasource}', 'LegacyApiController@get_graph_by_service')->name('get_graph_by_service');
         Route::get('{hostname}/{type}', 'LegacyApiController@get_graph_generic_by_hostname')->name('get_graph_generic_by_hostname');
         Route::get('', 'LegacyApiController@list_devices')->name('list_devices');
     });
     Route::prefix('ports')->group(function () {
         Route::get('{portid}', 'LegacyApiController@get_port_info')->name('get_port_info');
-        Route::get('{portid}/fdb', 'LegacyApiController@get_port_fdb')->name('get_port_fdb');
         Route::get('{portid}/ip', 'LegacyApiController@get_port_ip_addresses')->name('get_port_ip_info');
         Route::get('{portid}/transceiver', 'LegacyApiController@get_port_transceiver')->name('get_port_transceiver');
         Route::patch('transceiver/metric/{metric}', 'LegacyApiController@update_transceiver_metric_thresholds')->name('update_transceiver_metric_thresholds');
         Route::get('search/{field}/{search?}', 'LegacyApiController@search_ports')->name('search_ports')->where('search', '.*');
         Route::get('mac/{search}', 'LegacyApiController@search_by_mac')->name('search_mac');
         Route::get('', 'LegacyApiController@get_all_ports')->name('get_all_ports');
         Route::get('{portid}/description', 'LegacyApiController@get_port_description')->name('get_port_description');
         Route::patch('{portid}/description', 'LegacyApiController@update_port_description')->name('update_port_description');
     });
     Route::prefix('bills')->group(function () {

--- a/routes/console.php
+++ b/routes/console.php
@@ -1,12 +1,11 @@
 <?php
-use App\Jobs\PingCheck;
 use Illuminate\Support\Facades\Artisan;
 use Symfony\Component\Process\Process;
 /*
 |--------------------------------------------------------------------------
 | Console Routes
 |--------------------------------------------------------------------------
 |
 | This file is where you may define all of your Closure based console
 | commands. Each Closure is bound to a command instance allowing a
 | simple approach to interacting with each command's IO methods.
@@ -31,21 +30,32 @@
         base_path('delhost.php'),
         $this->argument('device spec'),
     ]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
 })->purpose('Remove a device');
 Artisan::command('update', function () {
     (new Process([base_path('daily.sh')]))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
 })->purpose(__('Update LibreNMS and run maintenance routines'));
 Artisan::command('poller:ping
     {groups?* : ' . __('Optional List of distributed poller groups to poll') . '}
 ', function () {
-    PingCheck::dispatch($this->argument('groups', []));
+    $command = [base_path('ping.php')];
+    if ($this->argument('groups')) {
+        $command[] = '-g';
+        $command[] = implode(',', $this->argument('groups'));
+    }
+    if (($verbosity = $this->getOutput()->getVerbosity()) >= 128) {
+        $command[] = '-d';
+        if ($verbosity >= 256) {
+            $command[] = '-v';
+        }
+    }
+    (new Process($command))->setTimeout(null)->setIdleTimeout(null)->setTty(true)->run();
 })->purpose(__('Check if devices are up or down via icmp'));
 Artisan::command('poller:discovery
     {device spec : ' . __('Device spec to discover: device_id, hostname, wildcard, odd, even, all, new') . '}
     {--o|os= : ' . __('Only devices with the specified operating system') . '}
     {--t|type= : ' . __('Only devices with the specified type') . '}
     {--m|modules= : ' . __('Specify single module to be run. Comma separate modules, submodules may be added with /') . '}
 ', function () {
     $command = [base_path('discovery.php'), '-h', $this->argument('device spec')];
     if ($this->option('os')) {
         $command[] = '-o';

--- a/routes/web.php
+++ b/routes/web.php
@@ -61,35 +61,27 @@
     Route::get('/', 'OverviewController@index')->name('home');
     Route::view('vminfo', 'vminfo');
     Route::get('nac', 'NacController@index');
     Route::prefix('device/{device}')->namespace('Device\Tabs')->name('device.')->group(function () {
         Route::put('notes', 'NotesController@update')->name('notes.update');
         Route::put('module/{module}', [\App\Http\Controllers\Device\Tabs\ModuleController::class, 'update'])->name('module.update');
         Route::delete('module/{module}', [\App\Http\Controllers\Device\Tabs\ModuleController::class, 'delete'])->name('module.delete');
     });
     Route::match(['get', 'post'], 'device/{device}/{tab?}/{vars?}', 'DeviceController@index')
         ->name('device')->where('vars', '.*');
-    Route::get('fullscreenmap', 'Maps\FullscreenMapController@fullscreenMap');
-    Route::get('availability-map', 'Maps\AvailabilityMapController@availabilityMap');
-    Route::get('map/{vars?}', 'Maps\NetMapController@netMap');
-    Route::prefix('maps')->namespace('Maps')->group(function () {
+    Route::prefix('maps')->group(function () {
         Route::resource('custom', CustomMapController::class, ['as' => 'maps'])
             ->parameters(['custom' => 'map'])->except('create');
         Route::get('custom/{map}/background', [CustomMapBackgroundController::class, 'get'])->name('maps.custom.background');
         Route::post('custom/{map}/background', [CustomMapBackgroundController::class, 'save'])->name('maps.custom.background.save');
         Route::get('custom/{map}/data', [CustomMapDataController::class, 'get'])->name('maps.custom.data');
         Route::post('custom/{map}/data', [CustomMapDataController::class, 'save'])->name('maps.custom.data.save');
-        Route::get('devicedependency', 'DeviceDependencyController@dependencyMap');
-        Route::post('getdevices', 'MapDataController@getDevices')->name('maps.getdevices');
-        Route::post('getdevicelinks', 'MapDataController@getDeviceLinks')->name('maps.getdevicelinks');
-        Route::post('getgeolinks', 'MapDataController@getGeographicLinks')->name('maps.getgeolinks');
-        Route::post('getservices', 'MapDataController@getServices')->name('maps.getservices');
     });
     Route::get('maps/devicedependency', [DeviceDependencyController::class, 'dependencyMap']);
     Route::resource('dashboard', 'DashboardController')->except(['create', 'edit']);
     Route::post('dashboard/{dashboard}/copy', 'DashboardController@copy')->name('dashboard.copy');
     Route::post('dashboard/{dashboard}/widgets', 'DashboardWidgetController@add')->name('dashboard.widget.add');
     Route::delete('dashboard/{dashboard}/widgets', 'DashboardWidgetController@clear')->name('dashboard.widget.clear');
     Route::put('dashboard/{dashboard}/widgets', 'DashboardWidgetController@update')->name('dashboard.widget.update');
     Route::delete('dashboard/widgets/{widget}', 'DashboardWidgetController@remove')->name('dashboard.widget.remove');
     Route::put('dashboard/widgets/{widget}', 'WidgetSettingsController@update')->name('dashboard.widget.settings');
     Route::prefix('push')->group(function () {
@@ -137,21 +129,20 @@
             Route::post('set_map_view', 'AvailabilityMapController@setView');
             Route::post('set_resolution', 'ResolutionController@set');
             Route::get('netcmd', 'NetCommand@run');
             Route::post('ripe/raw', 'RipeNccApiController@raw');
             Route::get('snmp/capabilities', 'SnmpCapabilities')->name('snmp.capabilities');
         });
         Route::get('settings/list', 'SettingsController@listAll')->name('settings.list');
         Route::prefix('select')->namespace('Select')->group(function () {
             Route::get('application', 'ApplicationController')->name('ajax.select.application');
             Route::get('bill', 'BillController')->name('ajax.select.bill');
-            Route::get('custom-map', 'CustomMapController')->name('ajax.select.custom-map');
             Route::get('custom-map-menu-group', 'CustomMapMenuGroupController')->name('ajax.select.custom-map-menu-group');
             Route::get('dashboard', 'DashboardController')->name('ajax.select.dashboard');
             Route::get('device', 'DeviceController')->name('ajax.select.device');
             Route::get('device-field', 'DeviceFieldController')->name('ajax.select.device-field');
             Route::get('device-group', 'DeviceGroupController')->name('ajax.select.device-group');
             Route::get('port-group', 'PortGroupController')->name('ajax.select.port-group');
             Route::get('role', 'RoleController')->name('ajax.select.role');
             Route::get('eventlog', 'EventlogController')->name('ajax.select.eventlog');
             Route::get('graph', 'GraphController')->name('ajax.select.graph');
             Route::get('graph-aggregate', 'GraphAggregateController')->name('ajax.select.graph-aggregate');
@@ -187,37 +178,37 @@
             Route::post('tnmsne', 'TnmsneController')->name('table.tnmsne');
             Route::post('vlan-ports', 'VlanPortsController')->name('table.vlan-ports');
             Route::post('vlan-devices', 'VlanDevicesController')->name('table.vlan-devices');
             Route::post('vminfo', 'VminfoController');
         });
         Route::prefix('dash')->namespace('Widgets')->group(function () {
             Route::post('alerts', 'AlertsController');
             Route::post('alertlog', 'AlertlogController');
             Route::post('availability-map', 'AvailabilityMapController');
             Route::post('component-status', 'ComponentStatusController');
-            Route::post('custom-map', 'CustomMapController');
             Route::post('device-summary-horiz', 'DeviceSummaryHorizController');
             Route::post('device-summary-vert', 'DeviceSummaryVertController');
             Route::post('device-types', 'DeviceTypeController');
             Route::post('eventlog', 'EventlogController');
             Route::post('generic-graph', 'GraphController');
             Route::post('generic-image', 'ImageController');
             Route::post('globe', 'GlobeController');
             Route::post('graylog', 'GraylogController');
             Route::post('placeholder', 'PlaceholderController');
             Route::post('notes', 'NotesController');
             Route::post('server-stats', 'ServerStatsController');
             Route::post('syslog', 'SyslogController');
             Route::post('top-devices', 'TopDevicesController');
             Route::post('top-interfaces', 'TopInterfacesController');
             Route::post('top-errors', 'TopErrorsController');
             Route::post('worldmap', 'WorldMapController')->name('widget.worldmap');
+            Route::get('worldmap', 'WorldMapController@getData')->name('widget.worldmap.data');
             Route::post('alertlog-stats', 'AlertlogStatsController');
         });
     });
     Route::permanentRedirect('demo', '/');
 });
 Route::group(['prefix' => 'ajax', 'namespace' => 'Ajax'], function () {
     Route::post('set_timezone', 'TimezoneController@set');
 });
 Route::prefix('install')->namespace('Install')->group(function () {
     Route::get('/', 'InstallationController@redirectToFirst')->name('install');
