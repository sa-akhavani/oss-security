# ====================================================================
# FILE: app/bundles/AssetBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 45-107 ---
    45|             ],
    46|         ],
    47|     ],
    48|     'categories' => [
    49|         'asset' => null,
    50|     ],
    51|     'services' => [
    52|         'permissions' => [
    53|             'mautic.asset.permissions' => [
    54|                 'class'     => Mautic\AssetBundle\Security\Permissions\AssetPermissions::class,
    55|                 'arguments' => [
    56|                     'mautic.helper.core_parameters',
    57|                 ],
    58|             ],
    59|         ],
    60|         'others' => [
    61|             'mautic.asset.upload.error.handler' => [
    62|                 'class'     => Mautic\AssetBundle\ErrorHandler\DropzoneErrorHandler::class,
    63|                 'arguments' => 'mautic.factory',
    64|             ],
    65|             'oneup_uploader.controller.dropzone.class' => [
    66|                 'class'     => Mautic\AssetBundle\Controller\UploadController::class,
    67|             ],
    68|         ],
    69|         'fixtures' => [
    70|             'mautic.asset.fixture.asset' => [
    71|                 'class'     => Mautic\AssetBundle\DataFixtures\ORM\LoadAssetData::class,
    72|                 'tag'       => Doctrine\Bundle\FixturesBundle\DependencyInjection\CompilerPass\FixturesCompilerPass::FIXTURE_TAG,
    73|             ],
    74|         ],
    75|     ],
    76|     'parameters' => [
    77|         'upload_dir'          => '%mautic.application_dir%/media/files',
    78|         'max_size'            => '6',
    79|         'allowed_extensions'  => ['csv', 'doc', 'docx', 'epub', 'gif', 'jpg', 'jpeg', 'mpg', 'mpeg', 'mp3', 'odt', 'odp', 'ods', 'pdf', 'png', 'ppt', 'pptx', 'tif', 'tiff', 'txt', 'xls', 'xlsx', 'wav'],
    80|         'streamed_extensions' => ['gif', 'jpg', 'jpeg', 'mpg', 'mpeg', 'mp3', 'pdf', 'png', 'wav'],
    81|         'allowed_mimetypes'   => [
    82|             'csv'  => 'text/csv',
    83|             'doc'  => 'application/msword',
    84|             'docx' => 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    85|             'epub' => 'application/epub+zip',
    86|             'gif'  => 'image/gif',
    87|             'jpg'  => 'image/jpeg',
    88|             'jpeg' => 'image/jpeg',
    89|             'mpg'  => 'video/mpeg',
    90|             'mpeg' => 'video/mpeg',
    91|             'mp3'  => 'audio/mpeg',
    92|             'odt'  => 'application/vnd.oasis.opendocument.text',
    93|             'odp'  => 'application/vnd.oasis.opendocument.presentation',
    94|             'ods'  => 'application/vnd.oasis.opendocument.spreadsheet',
    95|             'pdf'  => 'application/pdf',
    96|             'png'  => 'image/png',
    97|             'ppt'  => 'application/vnd.ms-powerpoint',
    98|             'pptx' => 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
    99|             'tif'  => 'image/tiff',
   100|             'tiff' => 'image/tiff',
   101|             'txt'  => 'text/plain',
   102|             'xls'  => 'application/vnd.ms-excel',
   103|             'xlsx' => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
   104|             'wav'  => 'audio/wav',
   105|         ],
   106|     ],
   107| ];


# ====================================================================
# FILE: app/bundles/AssetBundle/Controller/UploadController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Controller;
     3| use Oneup\UploaderBundle\Controller\DropzoneController;
     4| use Oneup\UploaderBundle\Uploader\Response\EmptyResponse;
     5| use Symfony\Component\HttpFoundation\File\Exception\UploadException;
     6| use Symfony\Component\HttpFoundation\JsonResponse;
     7| use Symfony\Contracts\Translation\TranslatorInterface;
     8| class UploadController extends DropzoneController
     9| {
    10|     private TranslatorInterface $translator;
    11|     public function upload(): JsonResponse
    12|     {
    13|         $request  = $this->getRequest();
    14|         $response = new EmptyResponse();
    15|         $files    = $this->getFiles($request->files);
    16|         $this->setTranslator($this->container->get('translator'));
    17|         if (!empty($files)) {
    18|             foreach ($files as $file) {
    19|                 try {
    20|                     $this->handleUpload($file, $response, $request);
    21|                 } catch (UploadException $e) {
    22|                     $this->errorHandler->addException($response, $e);
    23|                 } catch (\Exception $e) {
    24|                     error_log($e);
    25|                     $error = new UploadException($this->translator->trans('mautic.asset.error.file.failed'));
    26|                     $this->errorHandler->addException($response, $error);
    27|                 }
    28|             }
    29|         } else {
    30|             $error = new UploadException($this->translator->trans('mautic.asset.error.file.failed'));
    31|             $this->errorHandler->addException($response, $error);
    32|         }
    33|         return $this->createSupportedJsonResponse($response->assemble());
    34|     }
    35|     public function setTranslator(TranslatorInterface $translator): void
    36|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/Entity/Asset.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Entity;
     3| use Doctrine\DBAL\Types\Types;
     4| use Doctrine\ORM\Mapping as ORM;
     5| use Mautic\ApiBundle\Serializer\Driver\ApiMetadataDriver;
     6| use Mautic\CoreBundle\Doctrine\Mapping\ClassMetadataBuilder;
     7| use Mautic\CoreBundle\Entity\FormEntity;
     8| use Mautic\CoreBundle\Helper\FileHelper;
     9| use Mautic\CoreBundle\Loader\ParameterLoader;
    10| use Symfony\Component\Filesystem\Filesystem;
    11| use Symfony\Component\HttpFoundation\File\Exception\FileNotFoundException;
    12| use Symfony\Component\HttpFoundation\File\File;
    13| use Symfony\Component\HttpFoundation\File\UploadedFile;
    14| use Symfony\Component\Validator\Constraints as Assert;
    15| use Symfony\Component\Validator\Context\ExecutionContextInterface;
    16| use Symfony\Component\Validator\Mapping\ClassMetadata;
    17| class Asset extends FormEntity
    18| {
    19|     /**
    20|      * @var int
    21|      */
    22|     private $id;
    23|     /**
    24|      * @var string
    25|      */
    26|     private $title;
    27|     /**
    28|      * @var string|null
    29|      */

# --- HUNK 2: Lines 957-1017 ---
   957|      * @param Asset                     $object  Entity object to validate
   958|      * @param ExecutionContextInterface $context Context object
   959|      */
   960|     public static function validateFile($object, ExecutionContextInterface $context): void
   961|     {
   962|         if ($object->isLocal()) {
   963|             $tempName = $object->getTempName();
   964|             $path     = $object->getPath();
   965|             if ($object->isNew() && null === $tempName && null === $path) {
   966|                 $context->buildViolation('mautic.asset.asset.error.missing.file')
   967|                     ->atPath('tempName')
   968|                     ->setTranslationDomain('validators')
   969|                     ->addViolation();
   970|             }
   971|             if (null === $object->getTitle()) {
   972|                 $context->buildViolation('mautic.asset.asset.error.missing.title')
   973|                     ->atPath('title')
   974|                     ->setTranslationDomain('validators')
   975|                     ->addViolation();
   976|             }
   977|             $loader           = new ParameterLoader();
   978|             $parameters       = $loader->getParameterBag();
   979|             $mimeTypesAllowed = $parameters->get('allowed_mimetypes');
   980|             if (!empty($object->getFileMimeType()) && !in_array($object->getFileMimeType(), $mimeTypesAllowed)) {
   981|                 $context->buildViolation('mautic.asset.asset.error.invalid.mimetype', [
   982|                     '%fileMimetype%'=> $object->getFileMimeType(),
   983|                     '%mimetypes%'   => implode(', ', $mimeTypesAllowed),
   984|                 ])->atPath('file')
   985|                     ->setTranslationDomain('validators')
   986|                     ->addViolation();
   987|             }
   988|             $extensionsAllowed = array_keys($mimeTypesAllowed);
   989|             $fileType          = $object->getExtension();
   990|             if (null !== $object->getExtension() && !in_array($fileType, $extensionsAllowed)) {
   991|                 $context->buildViolation('mautic.asset.asset.error.file.extension', [
   992|                     '%fileExtension%'=> $object->getExtension(),
   993|                     '%extensions%'   => implode(', ', $extensionsAllowed),
   994|                 ])->atPath('file')
   995|                     ->setTranslationDomain('validators')
   996|                     ->addViolation();
   997|             }
   998|             $object->setRemotePath(null);
   999|         } elseif ($object->isRemote()) {
  1000|             if (null === $object->getRemotePath()) {
  1001|                 $context->buildViolation('mautic.asset.asset.error.missing.remote.path')
  1002|                     ->atPath('remotePath')
  1003|                     ->setTranslationDomain('validators')
  1004|                     ->addViolation();
  1005|             }
  1006|             $object->setPath(null);
  1007|         }
  1008|     }
  1009|     /**
  1010|      * Set temporary ID.
  1011|      *
  1012|      * @param string $tempId
  1013|      *
  1014|      * @return Asset
  1015|      */
  1016|     public function setTempId($tempId)
  1017|     {


# ====================================================================
# FILE: app/bundles/AssetBundle/EventListener/UploadSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-89 ---
     1| <?php
     2| namespace Mautic\AssetBundle\EventListener;
     3| use Mautic\AssetBundle\Model\AssetModel;
     4| use Mautic\CoreBundle\Exception\FileInvalidException;
     5| use Mautic\CoreBundle\Helper\CoreParametersHelper;
     6| use Mautic\CoreBundle\Translation\Translator;
     7| use Mautic\CoreBundle\Validator\FileUploadValidator;
     8| use Oneup\UploaderBundle\Event\PostUploadEvent;
     9| use Oneup\UploaderBundle\Event\ValidationEvent;
    10| use Oneup\UploaderBundle\Uploader\Exception\ValidationException;
    11| use Oneup\UploaderBundle\UploadEvents;
    12| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    13| class UploadSubscriber implements EventSubscriberInterface
    14| {
    15|     public function __construct(
    16|         private CoreParametersHelper $coreParametersHelper,
    17|         private AssetModel $assetModel,
    18|         private FileUploadValidator $fileUploadValidator,
    19|         protected Translator $translator,
    20|     ) {
    21|     }
    22|     public static function getSubscribedEvents(): array
    23|     {
    24|         return [
    25|             UploadEvents::POST_UPLOAD => ['onPostUpload', 0],
    26|             UploadEvents::VALIDATION  => ['onUploadValidation', 0],
    27|         ];
    28|     }
    29|     /**
    30|      * Moves upladed file to temporary directory where it can be found later
    31|      * and all uploaded files in there cleared. Also sets file name to the response.
    32|      */
    33|     public function onPostUpload(PostUploadEvent $event): void
    34|     {
    35|         $request   = $event->getRequest()->request;
    36|         $response  = $event->getResponse();
    37|         $tempId    = basename($request->get('tempId'));
    38|         $file      = $event->getFile();
    39|         $config    = $event->getConfig();
    40|         $uploadDir = $config['storage']['directory'];
    41|         $tmpDir    = $uploadDir.'/tmp/'.$tempId;
    42|         $file->move($tmpDir);
    43|         $response['state']       = 1;
    44|         $response['tmpFileName'] = $file->getBasename();
    45|     }
    46|     /**
    47|      * Validates file before upload.
    48|      *
    49|      * @throws ValidationException
    50|      */
    51|     public function onUploadValidation(ValidationEvent $event): void
    52|     {
    53|         $file       = $event->getFile();
    54|         $mimetypes  = $this->coreParametersHelper->get('allowed_mimetypes');
    55|         $extensions = array_keys($mimetypes);
    56|         $maxSize    = $this->assetModel->getMaxUploadSize('B');
    57|         if (null === $file) {
    58|             return;
    59|         }
    60|         try {
    61|             $this->fileUploadValidator->checkFileSize($file->getSize(), $maxSize, 'mautic.asset.asset.error.file.size');
    62|         } catch (FileInvalidException $e) {
    63|             throw new ValidationException($e->getMessage());
    64|         }
    65|         try {
    66|             $this->fileUploadValidator->checkExtension($file->getExtension(), $extensions, 'mautic.asset.asset.error.file.extension');
    67|         } catch (FileInvalidException $e) {
    68|             throw new ValidationException($e->getMessage());
    69|         }
    70|         try {
    71|             $this->checkMimeType($file->getMimeType(), $mimetypes, 'mautic.asset.asset.error.file.mimetype');
    72|         } catch (FileInvalidException $e) {
    73|             throw new ValidationException($e->getMessage());
    74|         }
    75|     }
    76|     /**
    77|      * @param array<string,string> $allowedMimeTypes
    78|      */
    79|     private function checkMimeType(string $mimeType, array $allowedMimeTypes, string $extensionErrorMsg): void
    80|     {
    81|         if (!in_array(strtolower($mimeType), array_map('strtolower', $allowedMimeTypes), true)) {
    82|             $error = $this->translator->trans($extensionErrorMsg, [
    83|                 '%fileMimetype%' => $mimeType,
    84|                 '%mimetypes%'    => implode(', ', $allowedMimeTypes),
    85|             ], 'validators');
    86|             throw new FileInvalidException($error);
    87|         }
    88|     }
    89| }


# ====================================================================
# FILE: app/bundles/AssetBundle/Form/Type/AssetType.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-91 ---
     1| <?php
     2| namespace Mautic\AssetBundle\Form\Type;
     3| use Mautic\AssetBundle\Entity\Asset;
     4| use Mautic\AssetBundle\Model\AssetModel;
     5| use Mautic\CategoryBundle\Form\Type\CategoryListType;
     6| use Mautic\CoreBundle\Form\EventListener\CleanFormSubscriber;
     7| use Mautic\CoreBundle\Form\EventListener\FormExitSubscriber;
     8| use Mautic\CoreBundle\Form\Type\ButtonGroupType;
     9| use Mautic\CoreBundle\Form\Type\FormButtonsType;
    10| use Mautic\CoreBundle\Form\Type\PublishDownDateType;
    11| use Mautic\CoreBundle\Form\Type\PublishUpDateType;
    12| use Mautic\CoreBundle\Form\Type\YesNoButtonGroupType;
    13| use Mautic\CoreBundle\Loader\ParameterLoader;
    14| use Symfony\Component\Form\AbstractType;
    15| use Symfony\Component\Form\Extension\Core\Type\HiddenType;
    16| use Symfony\Component\Form\Extension\Core\Type\LocaleType;
    17| use Symfony\Component\Form\Extension\Core\Type\TextareaType;
    18| use Symfony\Component\Form\Extension\Core\Type\TextType;
    19| use Symfony\Component\Form\FormBuilderInterface;
    20| use Symfony\Component\OptionsResolver\OptionsResolver;
    21| use Symfony\Component\Validator\Constraints\Callback;
    22| use Symfony\Component\Validator\Constraints\NotBlank;
    23| use Symfony\Component\Validator\Constraints\Url;
    24| use Symfony\Component\Validator\Context\ExecutionContextInterface;
    25| use Symfony\Contracts\Translation\TranslatorInterface;
    26| /**
    27|  * @extends AbstractType<Asset>
    28|  */
    29| class AssetType extends AbstractType
    30| {
    31|     public function __construct(
    32|         private TranslatorInterface $translator,
    33|         private AssetModel $assetModel
    34|     ) {
    35|     }
    36|     public function buildForm(FormBuilderInterface $builder, array $options): void
    37|     {
    38|         $builder->addEventSubscriber(new CleanFormSubscriber(['description' => 'html']));
    39|         $builder->addEventSubscriber(new FormExitSubscriber('asset.asset', $options));
    40|         $builder->add('storageLocation', ButtonGroupType::class, [
    41|             'label'   => 'mautic.asset.asset.form.storageLocation',
    42|             'choices' => [
    43|                 'mautic.asset.asset.form.storageLocation.local'  => 'local',
    44|                 'mautic.asset.asset.form.storageLocation.remote' => 'remote',
    45|             ],
    46|             'attr'              => [
    47|                 'onchange' => 'Mautic.changeAssetStorageLocation();',
    48|             ],
    49|         ]);
    50|         $maxUploadSize = $this->assetModel->getMaxUploadSize('', true);
    51|         $builder->add(
    52|             'tempName',
    53|             HiddenType::class,
    54|             [
    55|                 'label'       => $this->translator->trans('mautic.asset.asset.form.file.upload', ['%max%' => $maxUploadSize]),
    56|                 'label_attr'  => ['class' => 'control-label'],
    57|                 'required'    => false,
    58|                 'constraints' => [
    59|                     new Callback([$this, 'validateExtension']),
    60|                 ],
    61|             ]
    62|         );
    63|         $builder->add(
    64|             'originalFileName',
    65|             HiddenType::class,
    66|             [
    67|                 'required'    => false,
    68|                 'constraints' => [
    69|                     new Callback([$this, 'validateExtension']),
    70|                 ],
    71|             ],
    72|         );
    73|         $builder->add(
    74|             'disallow',
    75|             YesNoButtonGroupType::class,
    76|             [
    77|                 'label' => 'mautic.asset.asset.form.disallow.crawlers',
    78|                 'attr'  => [
    79|                     'tooltip'      => 'mautic.asset.asset.form.disallow.crawlers.descr',
    80|                     'data-show-on' => '{"asset_storageLocation_0":"checked"}',
    81|                 ],
    82|                 'data'=> empty($options['data']->getDisallow()) ? false : true,
    83|             ]
    84|         );
    85|         $builder->add(
    86|             'remotePath',
    87|             TextType::class,
    88|             [
    89|                 'label'       => 'mautic.asset.asset.form.remotePath',
    90|                 'label_attr'  => ['class' => 'control-label'],
    91|                 'attr'        => ['class' => 'form-control'],

# --- HUNK 2: Lines 154-204 ---
   154|                 ),
   155|             ],
   156|         ]);
   157|         $builder->add('isPublished', YesNoButtonGroupType::class, [
   158|             'label' => 'mautic.core.form.available',
   159|         ]);
   160|         $builder->add('publishUp', PublishUpDateType::class);
   161|         $builder->add('publishDown', PublishDownDateType::class);
   162|         $builder->add(
   163|             'tempId',
   164|             HiddenType::class,
   165|             [
   166|                 'required' => false,
   167|             ]
   168|         );
   169|         $builder->add('buttons', FormButtonsType::class, []);
   170|         if (!empty($options['action'])) {
   171|             $builder->setAction($options['action']);
   172|         }
   173|     }
   174|     /**
   175|      * @param Asset|string|null $object
   176|      */
   177|     public function validateExtension($object, ExecutionContextInterface $context): void
   178|     {
   179|         if (empty($object)) {
   180|             return;
   181|         }
   182|         $parameters       = (new ParameterLoader())->getParameterBag();
   183|         $mimeTypesAllowed = $parameters->get('allowed_mimetypes');
   184|         $extensions       = array_keys($mimeTypesAllowed);
   185|         $fileName         = $object;
   186|         if (!is_string($object) && $object instanceof Asset) {
   187|             $fileName = $object->getOriginalFileName();
   188|         }
   189|         $fileExtension    = pathinfo($fileName, PATHINFO_EXTENSION);
   190|         if (!in_array($fileExtension, $extensions, true)) {
   191|             $context->buildViolation('mautic.asset.asset.error.file.extension', [
   192|                 '%fileExtension%'=> $fileExtension,
   193|                 '%extensions%'   => implode(', ', $extensions),
   194|             ])
   195|                 ->atPath('file')
   196|                 ->setTranslationDomain('validators')
   197|                 ->addViolation();
   198|         }
   199|     }
   200|     public function configureOptions(OptionsResolver $resolver): void
   201|     {
   202|         $resolver->setDefaults(['data_class' => Asset::class]);
   203|     }
   204| }


# ====================================================================
# FILE: app/bundles/ChannelBundle/Model/MessageQueueModel.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 146-188 ---
   146|             $messageQueue->setPriority($priority);
   147|             $messageQueue->setScheduledDate($scheduledDate);
   148|             $messageQueue->setOptions($options);
   149|             $messageQueues[] = $messageQueue;
   150|         }
   151|         if ($messageQueues) {
   152|             $this->saveEntities($messageQueues);
   153|             $messageQueueRepository = $this->getRepository();
   154|             $messageQueueRepository->detachEntities($messageQueues);
   155|         }
   156|         return true;
   157|     }
   158|     public function sendMessages($channel = null, $channelId = null): int
   159|     {
   160|         $processStarted = new \DateTime();
   161|         $limit          = 50;
   162|         $counter        = 0;
   163|         foreach ($this->getRepository()->getQueuedMessages($limit, $processStarted, $channel, $channelId) as $queue) {
   164|             $counter += $this->processMessageQueue($queue);
   165|             $event   = $queue->getEvent();
   166|             if ($event) {
   167|                 $this->em->detach($event);
   168|             }
   169|             $this->em->detach($queue);
   170|         }
   171|         return $counter;
   172|     }
   173|     public function processMessageQueue($queue): int
   174|     {
   175|         if (!is_array($queue)) {
   176|             if (!$queue instanceof MessageQueue) {
   177|                 throw new \InvalidArgumentException('$queue must be an instance of '.MessageQueue::class);
   178|             }
   179|             $queue = [$queue->getId() => $queue];
   180|         }
   181|         $counter   = 0;
   182|         $contacts  = [];
   183|         $byChannel = [];
   184|         /** @var MessageQueue $message */
   185|         foreach ($queue as $message) {
   186|             if ($message->getLead()) {
   187|                 $contacts[$message->getId()] = $message->getLead()->getId();
   188|             }


# ====================================================================
# FILE: app/bundles/CoreBundle/Assets/js/11.editor.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 220-261 ---
   220|                 Mautic.configureDynamicContentAtWhoTokens();
   221|                 mQuery.extend(Mautic.builderTokens, Mautic.dynamicContentTokens);
   222|                 Mautic.builderTokensForCkEditor = mQuery.map(Mautic.builderTokens, function(value, i) {
   223|                     return {'id':i, 'name':value};
   224|                 });
   225|             }
   226|         },
   227|         error: function (request, textStatus, errorThrown) {
   228|             Mautic.processAjaxError(request, textStatus, errorThrown);
   229|         },
   230|         complete: function() {
   231|             Mautic.builderTokensRequestInProgress = false;
   232|         }
   233|     });
   234|     return Mautic.builderTokensForCkEditor;
   235| };
   236| Mautic.getCKEditorFonts = function(fonts) {
   237|     fonts = Array.isArray(fonts) ? fonts : [];
   238|     const CKEditorFonts = [];
   239|     for (let i = 0; i < fonts.length; i++) {
   240|         if ('undefined' != typeof fonts[i].font) {
   241|             CKEditorFonts.push(fonts[i].font);
   242|         }
   243|     }
   244|     return CKEditorFonts;
   245| }
   246| Mautic.ConvertFieldToCkeditor  = function(textarea, ckEditorToolbarOptions) {
   247|     if (ckEditors.has( textarea[0] ))
   248|     {
   249|         ckEditors.get( textarea[0] ).destroy();
   250|         ckEditors.delete( textarea[0] )
   251|     }
   252|     const tokenCallback = textarea.attr('data-token-callback');
   253|     Mautic.InitCkEditor(textarea, Mautic.GetCkEditorConfigOptions(ckEditorToolbarOptions, tokenCallback));
   254| }
   255| Mautic.GetCkEditorConfigOptions  = function(ckEditorToolbarOptions, tokenCallback) {
   256|     const defaultOptions = ['undo', 'redo', '|', 'bold', 'italic', 'underline', 'heading', 'fontfamily', 'fontsize', 'fontColor', 'fontBackgroundColor', 'alignment', 'numberedList', 'bulletedList', 'blockQuote', 'removeFormat', 'link', 'ckfinder', 'mediaEmbed', 'insertTable', 'sourceEditing'];
   257|     const ckEditorToolbar = typeof ckEditorToolbarOptions != "undefined" && ckEditorToolbarOptions.length > 0 ? ckEditorToolbarOptions : defaultOptions;
   258|     const ckEditorColors = [
   259|         { color: '#000000', label: 'Black' },
   260|         { color: '#4d4d4d', label: 'Dim grey' },
   261|         { color: '#999999', label: 'Grey' },


# ====================================================================
# FILE: app/bundles/EmailBundle/Config/config.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 243-283 ---
   243|                 'arguments' => [
   244|                     'mautic.validator.email',
   245|                     'mautic.lead.validator.custom_field',
   246|                 ],
   247|                 'tag' => 'validator.constraint_validator',
   248|             ],
   249|         ],
   250|         'fixtures' => [
   251|             'mautic.email.fixture.email' => [
   252|                 'class'     => Mautic\EmailBundle\DataFixtures\ORM\LoadEmailData::class,
   253|                 'tag'       => Doctrine\Bundle\FixturesBundle\DependencyInjection\CompilerPass\FixturesCompilerPass::FIXTURE_TAG,
   254|                 'arguments' => ['mautic.email.model.email'],
   255|             ],
   256|         ],
   257|     ],
   258|     'parameters' => [
   259|         'mailer_from_name'               => 'Mautic',
   260|         'mailer_from_email'              => 'email@yoursite.com',
   261|         'mailer_reply_to_email'          => null,
   262|         'mailer_return_path'             => null,
   263|         'mailer_address_length_limit'    => 320,
   264|         'mailer_append_tracking_pixel'   => true,
   265|         'mailer_convert_embed_images'    => false,
   266|         'mailer_custom_headers'          => [],
   267|         'mailer_dsn'                     => 'smtp://localhost:25',
   268|         'unsubscribe_text'               => null,
   269|         'webview_text'                   => null,
   270|         'unsubscribe_message'            => null,
   271|         'resubscribe_message'            => null,
   272|         'monitored_email'                => [
   273|             'general' => [
   274|                 'address'         => null,
   275|                 'host'            => null,
   276|                 'port'            => '993',
   277|                 'encryption'      => '/ssl',
   278|                 'user'            => null,
   279|                 'password'        => null,
   280|                 'use_attachments' => false,
   281|             ],
   282|             'EmailBundle_bounces' => [
   283|                 'address'           => null,


# ====================================================================
# FILE: app/bundles/EmailBundle/Controller/EmailController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 780-820 ---
   780|         ];
   781|         if (null === $entity) {
   782|             return $this->postActionRedirect(
   783|                 array_merge(
   784|                     $postActionVars,
   785|                     [
   786|                         'flashes' => [
   787|                             [
   788|                                 'type'    => 'error',
   789|                                 'msg'     => 'mautic.email.error.notfound',
   790|                                 'msgVars' => ['%id%' => $objectId],
   791|                             ],
   792|                         ],
   793|                     ]
   794|                 )
   795|             );
   796|         } elseif (!$this->security->isGranted('email:emails:create')
   797|             || !$this->security->hasEntityAccess(
   798|                 'email:emails:viewown',
   799|                 'email:emails:viewother',
   800|                 $emailEntity->getCreatedBy()
   801|             )
   802|         ) {
   803|             return $this->accessDenied();
   804|         } elseif ($model->isLocked($entity)) {
   805|             return $this->isLocked($postActionVars, $entity, 'email');
   806|         }
   807|         $action = $this->generateUrl('mautic_email_action', ['objectAction' => 'clone', 'objectId' => $objectId]);
   808|         /** @var Form $form */
   809|         $form = $model->createForm($entity, $this->formFactory, $action);
   810|         if ('POST' === $method) {
   811|             $valid = false;
   812|             if (!$cancelled = $this->isFormCancelled($form)) {
   813|                 $formData = $request->request->get('emailform');
   814|                 if ($valid = $this->isFormValid($form)) {
   815|                     $content = $entity->getCustomHtml();
   816|                     $entity->setCustomHtml($content);
   817|                     $model->saveEntity($entity);
   818|                     $this->addFlashMessage(
   819|                         'mautic.core.notice.created',
   820|                         [


# ====================================================================
# FILE: app/bundles/EmailBundle/Controller/PublicController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 373-413 ---
   373|         return $event->getResponse() ?? new Response('No email transport that could process this callback was found', Response::HTTP_NOT_FOUND);
   374|     }
   375|     /**
   376|      * Preview email.
   377|      *
   378|      * @return Response
   379|      */
   380|     public function previewAction(AnalyticsHelper $analyticsHelper, EmailConfig $emailConfig, EmailModel $model, Request $request, string $objectId, string $objectType = null)
   381|     {
   382|         $contactId   = (int) $request->query->get('contactId');
   383|         $emailEntity = $model->getEntity($objectId);
   384|         if (null === $emailEntity) {
   385|             return $this->notFound();
   386|         }
   387|         $publicPreview = $emailEntity->isPublicPreview();
   388|         $draftEnabled  = $emailConfig->isDraftEnabled();
   389|         if ('draft' === $objectType && $draftEnabled && $emailEntity->hasDraft()) {
   390|             $publicPreview = $emailEntity->getDraft()->isPublicPreview();
   391|         }
   392|         if (
   393|             ($this->security->isAnonymous() && !$publicPreview)
   394|             || (!$this->security->isAnonymous()
   395|                 && !$this->security->hasEntityAccess(
   396|                     'email:emails:viewown',
   397|                     'email:emails:viewother',
   398|                     $emailEntity->getCreatedBy()
   399|                 ))
   400|         ) {
   401|             return $this->accessDenied();
   402|         }
   403|         if ($contactId && (
   404|             !$this->security->isAdmin()
   405|             && !$this->security->hasEntityAccess('lead:leads:viewown', 'lead:leads:viewother')
   406|         )
   407|         ) {
   408|             $contactId = null;
   409|         }
   410|         $idHash = 'xxxxxxxxxxxxxx';
   411|         $BCcontent = $emailEntity->getContent();
   412|         $content   = $emailEntity->getCustomHtml();
   413|         if ('draft' === $objectType && $draftEnabled && $emailEntity->hasDraft()) {


# ====================================================================
# FILE: app/bundles/EmailBundle/EventListener/TrackingSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-39 ---
     3| use Mautic\EmailBundle\Entity\Stat;
     4| use Mautic\EmailBundle\Entity\StatRepository;
     5| use Mautic\LeadBundle\Event\ContactIdentificationEvent;
     6| use Mautic\LeadBundle\LeadEvents;
     7| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
     8| class TrackingSubscriber implements EventSubscriberInterface
     9| {
    10|     public function __construct(
    11|         private StatRepository $statRepository
    12|     ) {
    13|     }
    14|     public static function getSubscribedEvents(): array
    15|     {
    16|         return [
    17|             LeadEvents::ON_CLICKTHROUGH_IDENTIFICATION => ['onIdentifyContact', 0],
    18|         ];
    19|     }
    20|     public function onIdentifyContact(ContactIdentificationEvent $event): void
    21|     {
    22|         $clickthrough = $event->getClickthrough();
    23|         if (empty($clickthrough['stat'])) {
    24|             return;
    25|         }
    26|         /** @var Stat $stat */
    27|         $stat = $this->statRepository->findOneBy(['trackingHash' => $clickthrough['stat']]);
    28|         if (!$stat) {
    29|             return;
    30|         }
    31|         if (isset($clickthrough['channel']['email']) && $stat->getEmail() && (int) $stat->getEmail()->getId() !== (int) $clickthrough['channel']['email']) {
    32|             return;
    33|         }
    34|         if (!$contact = $stat->getLead()) {
    35|             return;
    36|         }
    37|         $event->setIdentifiedContact($contact, 'email');
    38|     }
    39| }


# ====================================================================
# FILE: app/bundles/EmailBundle/Form/Type/ConfigType.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 231-284 ---
   231|                         ]
   232|                     ),
   233|                 ],
   234|             ]
   235|         );
   236|         $builder->add(
   237|             'mailer_return_path',
   238|             TextType::class,
   239|             [
   240|                 'label'      => 'mautic.email.config.mailer.return.path',
   241|                 'label_attr' => ['class' => 'control-label'],
   242|                 'attr'       => [
   243|                     'class'    => 'form-control',
   244|                     'tooltip'  => 'mautic.email.config.mailer.return.path.tooltip',
   245|                     'onchange' => 'Mautic.disableSendTestEmailButton(this)',
   246|                 ],
   247|                 'required'   => false,
   248|             ]
   249|         );
   250|         $builder->add(
   251|             'mailer_address_length_limit',
   252|             NumberType::class,
   253|             [
   254|                 'scale'      => 0,
   255|                 'label'      => 'mautic.email.config.mailer.address.length.limit',
   256|                 'label_attr' => ['class' => 'control-label'],
   257|                 'attr'       => [
   258|                     'class'    => 'form-control',
   259|                     'tooltip'  => 'mautic.email.config.mailer.address.length.limit.tooltip',
   260|                 ],
   261|                 'required'   => true,
   262|             ]
   263|         );
   264|         $builder->add(
   265|             'mailer_dsn',
   266|             DsnType::class,
   267|             [
   268|                 'constraints' => [new Dsn()],
   269|                 'test_button' => [
   270|                     'action' => 'email:sendTestEmail',
   271|                     'label'  => $this->translator->trans('mautic.email.config.mailer.transport.test_send'),
   272|                 ],
   273|             ]
   274|         );
   275|         $builder->add(
   276|             'mailer_convert_embed_images',
   277|             YesNoButtonGroupType::class,
   278|             [
   279|                 'label'      => 'mautic.email.config.mailer.convert.embed.images',
   280|                 'label_attr' => ['class' => 'control-label'],
   281|                 'attr'       => [
   282|                     'class'   => 'form-control',
   283|                     'tooltip' => 'mautic.email.config.mailer.convert.embed.images.tooltip',
   284|                 ],


# ====================================================================
# FILE: app/bundles/EmailBundle/Helper/MailHelper.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 10-86 ---
    10| use Mautic\EmailBundle\Entity\Email;
    11| use Mautic\EmailBundle\Entity\Stat;
    12| use Mautic\EmailBundle\Event\EmailSendEvent;
    13| use Mautic\EmailBundle\Exception\InvalidEmailException;
    14| use Mautic\EmailBundle\Form\Type\ConfigType;
    15| use Mautic\EmailBundle\Helper\DTO\AddressDTO;
    16| use Mautic\EmailBundle\Helper\Exception\OwnerNotFoundException;
    17| use Mautic\EmailBundle\Mailer\Exception\BatchQueueMaxException;
    18| use Mautic\EmailBundle\Mailer\Message\MauticMessage;
    19| use Mautic\EmailBundle\Mailer\Transport\TokenTransportInterface;
    20| use Mautic\EmailBundle\MonitoredEmail\Mailbox;
    21| use Mautic\LeadBundle\Entity\Lead;
    22| use Psr\Log\LoggerInterface;
    23| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    24| use Symfony\Component\Mailer\Exception\TransportExceptionInterface;
    25| use Symfony\Component\Mailer\MailerInterface;
    26| use Symfony\Component\Mailer\Transport\TransportInterface;
    27| use Symfony\Component\Mime\Address;
    28| use Symfony\Component\Mime\Exception\RfcComplianceException;
    29| use Symfony\Component\Mime\Header\HeaderInterface;
    30| use Symfony\Component\Mime\Header\MailboxListHeader;
    31| use Symfony\Component\Mime\Header\UnstructuredHeader;
    32| use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
    33| use Symfony\Component\Routing\RouterInterface;
    34| use Twig\Environment;
    35| class MailHelper
    36| {
    37|     public const QUEUE_RESET_TO           = 'RESET_TO';
    38|     public const QUEUE_FULL_RESET         = 'FULL_RESET';
    39|     public const QUEUE_DO_NOTHING         = 'DO_NOTHING';
    40|     public const QUEUE_NOTHING_IF_FAILED  = 'IF_FAILED';
    41|     public const QUEUE_RETURN_ERRORS      = 'RETURN_ERRORS';
    42|     public const EMAIL_TYPE_TRANSACTIONAL = 'transactional';
    43|     public const EMAIL_TYPE_MARKETING     = 'marketing';
    44|     private const DEFAULT_BODY            = [
    45|         'content'     => '',
    46|         'contentType' => 'text/html',
    47|         'charset'     => null,
    48|     ];
    49|     /**
    50|      * @var TransportInterface
    51|      */
    52|     protected $transport;
    53|     /**
    54|      * @var Environment
    55|      */
    56|     protected $twig;
    57|     protected ?EventDispatcherInterface $dispatcher = null;
    58|     /**
    59|      * @var bool|MauticMessage
    60|      */
    61|     public $message;
    62|     protected ?AddressDTO $from = null;
    63|     protected ?AddressDTO $systemFrom = null;
    64|     protected ?string $replyTo = null;
    65|     protected ?string $systemReplyTo = null;
    66|     protected int $addressLengthLimit;
    67|     /**
    68|      * @var string
    69|      */
    70|     protected $returnPath;
    71|     /**
    72|      * @var array
    73|      */
    74|     protected $errors = [];
    75|     /**
    76|      * @var array|Lead
    77|      */
    78|     protected $lead;
    79|     /**
    80|      * @var bool
    81|      */
    82|     protected $internalSend = false;
    83|     /**
    84|      * @var null
    85|      */
    86|     protected $idHash;

# --- HUNK 2: Lines 184-224 ---
   184|     private ?string $contentHash = null;
   185|     private array $copies = [];
   186|     private array $embedImagesReplaces = [];
   187|     public function __construct(
   188|         private MauticFactory $factory,
   189|         private MailerInterface $mailer,
   190|         private FromEmailHelper $fromEmailHelper,
   191|         private CoreParametersHelper $coreParametersHelper,
   192|         private Mailbox $mailbox,
   193|         private LoggerInterface $logger,
   194|         private MailHashHelper $mailHashHelper,
   195|         private RouterInterface $router
   196|     ) {
   197|         $this->transport  = $this->getTransport();
   198|         $this->returnPath = $coreParametersHelper->get('mailer_return_path');
   199|         $systemFromEmail    = (string) $coreParametersHelper->get('mailer_from_email');
   200|         $systemReplyToEmail = $coreParametersHelper->get('mailer_reply_to_email');
   201|         $systemFromName     = $this->cleanName(
   202|             $coreParametersHelper->get('mailer_from_name')
   203|         );
   204|         $this->addressLengthLimit = (int) $coreParametersHelper->get('mailer_address_length_limit');
   205|         $this->setDefaultFrom(false, new AddressDTO($systemFromEmail, $systemFromName));
   206|         $this->setDefaultReplyTo($systemReplyToEmail, $this->from);
   207|         if ($this->transport instanceof TokenTransportInterface) {
   208|             $this->tokenizationEnabled = true;
   209|         }
   210|         $this->message = $this->getMessageInstance();
   211|     }
   212|     /**
   213|      * Mirrors previous MauticFactory functionality.
   214|      *
   215|      * @param bool $cleanSlate
   216|      *
   217|      * @return $this
   218|      */
   219|     public function getMailer($cleanSlate = true)
   220|     {
   221|         $this->reset($cleanSlate);
   222|         return $this;
   223|     }
   224|     /**

# --- HUNK 3: Lines 705-752 ---
   705|             $this->message->to(...$toAddresses);
   706|             $this->queuedRecipients = array_merge($this->queuedRecipients, $addresses);
   707|             return true;
   708|         } catch (\Exception $e) {
   709|             $this->logError($e, 'to');
   710|             return false;
   711|         }
   712|     }
   713|     /**
   714|      * Add to address.
   715|      *
   716|      * @param string      $address
   717|      * @param string|null $name
   718|      *
   719|      * @return bool
   720|      */
   721|     public function addTo($address, $name = null)
   722|     {
   723|         $this->checkBatchMaxRecipients();
   724|         try {
   725|             $fullAddress          = (new AddressDTO($address, $name))->toMailerAddress();
   726|             $encodedAddressLength = strlen((new MailboxListHeader('To', [$fullAddress]))->getBodyAsString());
   727|             if ($encodedAddressLength > $this->addressLengthLimit) {
   728|                 $shortAddress = (new AddressDTO($address))->toMailerAddress();
   729|                 $this->message->addTo($shortAddress);
   730|             } else {
   731|                 $this->message->addTo($fullAddress);
   732|             }
   733|             $this->queuedRecipients[$address] = $name;
   734|             return true;
   735|         } catch (\Exception $e) {
   736|             $this->logError($e, 'to');
   737|             return false;
   738|         }
   739|     }
   740|     /**
   741|      * Set CC address(es).
   742|      *
   743|      * @param array<string,?string> $addresses
   744|      * @param ?string               $name
   745|      *
   746|      * //TODO: there is a bug here, the name is not passed in CC nor in the array of addresses, we do not handle names for CC
   747|      *
   748|      * @return bool
   749|      */
   750|     public function setCc($addresses, $name = null)
   751|     {
   752|         $this->checkBatchMaxRecipients(count($addresses), 'cc');


# ====================================================================
# FILE: app/bundles/LeadBundle/Segment/Decorator/Date/TimezoneResolver.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-31 ---
     7|     public function __construct(
     8|         private CoreParametersHelper $coreParametersHelper
     9|     ) {
    10|     }
    11|     /**
    12|      * @param bool $hasTimePart
    13|      */
    14|     public function getDefaultDate($hasTimePart): DateTimeHelper
    15|     {
    16|         /**
    17|          * $hasTimePart tells us if field in a database is date or datetime
    18|          * All datetime fields are stored in UTC
    19|          * Date field, however, is always stored in a local time (there is no time information, so it cannot be converted to UTC).
    20|          *
    21|          * We will generate default date according to this. We need midnight as a default date (for relative intervals like "today" or "-1 day"
    22|          *  1) in UTC for datetime fields
    23|          *  2) in the local timezone for date fields
    24|          *
    25|          * Later we use toLocalString() method - it gives us midnight in UTC for first condition and midnight in local timezone for second option.
    26|          */
    27|         $timezone = $hasTimePart ? 'UTC' : $this->coreParametersHelper->get('default_timezone', 'UTC') ?? 'UTC';
    28|         $date = new \DateTime('midnight today', new \DateTimeZone($timezone));
    29|         return new DateTimeHelper($date, null, $timezone);
    30|     }
    31| }


# ====================================================================
# FILE: app/bundles/ReportBundle/Controller/Api/ReportApiController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| <?php
     2| namespace Mautic\ReportBundle\Controller\Api;
     3| use Doctrine\Persistence\ManagerRegistry;
     4| use Mautic\ApiBundle\Controller\CommonApiController;
     5| use Mautic\ApiBundle\Helper\EntityResultHelper;
     6| use Mautic\CoreBundle\Factory\MauticFactory;
     7| use Mautic\CoreBundle\Factory\ModelFactory;
     8| use Mautic\CoreBundle\Helper\AppVersion;
     9| use Mautic\CoreBundle\Helper\CoreParametersHelper;
    10| use Mautic\CoreBundle\Helper\UserHelper;
    11| use Mautic\CoreBundle\Security\Exception\PermissionException;
    12| use Mautic\CoreBundle\Security\Permissions\CorePermissions;
    13| use Mautic\CoreBundle\Translation\Translator;
    14| use Mautic\ReportBundle\Entity\Report;
    15| use Mautic\ReportBundle\Model\ReportModel;
    16| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    17| use Symfony\Component\Form\FormFactoryInterface;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\HttpFoundation\RequestStack;
    20| use Symfony\Component\HttpFoundation\Response;
    21| use Symfony\Component\Routing\RouterInterface;
    22| /**
    23|  * @extends CommonApiController<Report>
    24|  */
    25| class ReportApiController extends CommonApiController
    26| {
    27|     /**
    28|      * @var ReportModel|null
    29|      */
    30|     protected $model;
    31|     public function __construct(CorePermissions $security, Translator $translator, EntityResultHelper $entityResultHelper, RouterInterface $router, FormFactoryInterface $formFactory, AppVersion $appVersion, RequestStack $requestStack, ManagerRegistry $doctrine, ModelFactory $modelFactory, EventDispatcherInterface $dispatcher, CoreParametersHelper $coreParametersHelper, MauticFactory $factory, protected UserHelper $userHelper)
    32|     {
    33|         $reportModel = $modelFactory->getModel('report');
    34|         \assert($reportModel instanceof ReportModel);
    35|         $this->model            = $reportModel;
    36|         $this->entityClass      = Report::class;
    37|         $this->entityNameOne    = 'report';
    38|         $this->entityNameMulti  = 'reports';
    39|         $this->serializerGroups = ['reportList', 'reportDetails'];
    40|         parent::__construct($security, $translator, $entityResultHelper, $router, $formFactory, $appVersion, $requestStack, $doctrine, $modelFactory, $dispatcher, $coreParametersHelper, $factory);
    41|     }
    42|     /**
    43|      * Obtains a compiled report.
    44|      *
    45|      * @param int $id Report ID
    46|      */
    47|     public function getEntityAction(Request $request, $id): Response
    48|     {
    49|         try {
    50|             if (!$this->security->isGranted($this->permissionBase.':view')) {
    51|                 return $this->accessDenied();
    52|             }
    53|         } catch (PermissionException $e) {
    54|             return $this->accessDenied($e->getMessage());
    55|         }
    56|         $entity        = $this->model->getEntity($id);
    57|         if (!$entity instanceof $this->entityClass) {
    58|             return $this->notFound();
    59|         }
    60|         if (
    61|             $this->security->checkPermissionExists($this->permissionBase.':viewother')
    62|             && !$this->security->isGranted($this->permissionBase.':viewother')
    63|             && $entity->getCreatedBy() !== $this->userHelper->getUser()->getId()
    64|         ) {
    65|             return $this->accessDenied();
    66|         }
    67|         $reportData = $this->model->getReportData($entity, $this->formFactory, $this->getOptionsFromRequest($request));
    68|         foreach (['graphs', 'contentTemplate', 'columns'] as $key) {
    69|             unset($reportData[$key]);
    70|         }
    71|         $reportData[$this->entityNameOne] = $entity;
    72|         return $this->handleView(
    73|             $this->view($reportData, Response::HTTP_OK)
    74|         );
    75|     }
    76|     public function getReportAction(Request $request, int $id): Response
    77|     {
    78|         return $this->getEntityAction($request, $id);
    79|     }
    80|     /**
    81|      * This method is careful to add new options from the request to keep BC.
    82|      * It originally loaded all rows without any filter or pagination applied.
    83|      */
    84|     private function getOptionsFromRequest(Request $request): array
    85|     {

