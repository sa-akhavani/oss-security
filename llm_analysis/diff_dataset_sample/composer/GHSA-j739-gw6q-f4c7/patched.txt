# ====================================================================
# FILE: customer_email.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 111-152 ---
   111| 			WHERE `customerid`= :cid AND `isemaildomain` = '1'
   112| 		");
   113| 		$result2 = Database::pexecute_first($result_stmt, array(
   114| 			"cid" => $userinfo['customerid']
   115| 		));
   116| 		$emaildomains_count = $result2['emaildomains'];
   117| 		eval("echo \"" . \Froxlor\UI\Template::getTemplate("email/emails") . "\";");
   118| 	} elseif ($action == 'delete' && $id != 0) {
   119| 		try {
   120| 			$json_result = Emails::getLocal($userinfo, array(
   121| 				'id' => $id
   122| 			))->get();
   123| 		} catch (Exception $e) {
   124| 			\Froxlor\UI\Response::dynamic_error($e->getMessage());
   125| 		}
   126| 		$result = json_decode($json_result, true)['data'];
   127| 		if (isset($result['email']) && $result['email'] != '') {
   128| 			if (isset($_POST['send']) && $_POST['send'] == 'send') {
   129| 				try {
   130| 					Emails::getLocal($userinfo, array(
   131| 						'id' => $id,
   132| 						'delete_userfiles' => ($_POST['delete_userfiles'] ?? 0)
   133| 					))->delete();
   134| 				} catch (Exception $e) {
   135| 					\Froxlor\UI\Response::dynamic_error($e->getMessage());
   136| 				}
   137| 				\Froxlor\UI\Response::redirectTo($filename, array(
   138| 					'page' => $page,
   139| 					's' => $s
   140| 				));
   141| 			} else {
   142| 				if ($result['popaccountid'] != '0') {
   143| 					$show_checkbox = true;
   144| 				} else {
   145| 					$show_checkbox = false;
   146| 				}
   147| 				\Froxlor\UI\HTML::askYesNoWithCheckbox('email_reallydelete', 'admin_customer_alsoremovemail', $filename, array(
   148| 					'id' => $id,
   149| 					'page' => $page,
   150| 					'action' => $action
   151| 				), $idna_convert->decode($result['email_full']), $show_checkbox);
   152| 			}


# ====================================================================
# FILE: install/lib/class.FroxlorInstall.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 408-463 ---
   408| 			$this->_updateSetting($upd_stmt, 'apache2', 'system', 'webserver');
   409| 			$this->_updateSetting($upd_stmt, '1', 'system', 'apache24');
   410| 		} elseif ($this->_data['webserver'] == "lighttpd") {
   411| 			$this->_updateSetting($upd_stmt, '/etc/lighttpd/conf-enabled/', 'system', 'apacheconf_vhost');
   412| 			$this->_updateSetting($upd_stmt, '/etc/lighttpd/froxlor-diroptions/', 'system', 'apacheconf_diroptions');
   413| 			$this->_updateSetting($upd_stmt, '/etc/lighttpd/froxlor-htpasswd/', 'system', 'apacheconf_htpasswddir');
   414| 			$this->_updateSetting($upd_stmt, '/etc/init.d/lighttpd reload', 'system', 'apachereload_command');
   415| 			$this->_updateSetting($upd_stmt, '/etc/lighttpd/lighttpd.pem', 'system', 'ssl_cert_file');
   416| 			$this->_updateSetting($upd_stmt, '/var/run/lighttpd/', 'phpfpm', 'fastcgi_ipcdir');
   417| 		} elseif ($this->_data['webserver'] == "nginx") {
   418| 			$this->_updateSetting($upd_stmt, '/etc/nginx/sites-enabled/', 'system', 'apacheconf_vhost');
   419| 			$this->_updateSetting($upd_stmt, '/etc/nginx/sites-enabled/', 'system', 'apacheconf_diroptions');
   420| 			$this->_updateSetting($upd_stmt, '/etc/nginx/froxlor-htpasswd/', 'system', 'apacheconf_htpasswddir');
   421| 			$this->_updateSetting($upd_stmt, '/etc/init.d/nginx reload', 'system', 'apachereload_command');
   422| 			$this->_updateSetting($upd_stmt, '/etc/nginx/nginx.pem', 'system', 'ssl_cert_file');
   423| 			$this->_updateSetting($upd_stmt, '/var/run/', 'phpfpm', 'fastcgi_ipcdir');
   424| 			$this->_updateSetting($upd_stmt, 'error', 'system', 'errorlog_level');
   425| 		}
   426| 		$distros = glob(\Froxlor\FileDir::makeCorrectDir(\Froxlor\Froxlor::getInstallDir() . '/lib/configfiles/') . '*.xml');
   427| 		foreach ($distros as $_distribution) {
   428| 			if ($this->_data['distribution'] == str_replace(".xml", "", strtolower(basename($_distribution)))) {
   429| 				$dist = new \Froxlor\Config\ConfigParser($_distribution);
   430| 				$defaults = $dist->getDefaults();
   431| 				foreach ($defaults->property as $property) {
   432| 					$this->_updateSetting($upd_stmt, $property->value, $property->settinggroup, $property->varname);
   433| 				}
   434| 			}
   435| 		}
   436| 		$this->_updateSetting($upd_stmt, $this->_data['activate_newsfeed'], 'admin', 'show_news_feed');
   437| 		$this->_updateSetting($upd_stmt, dirname(dirname(dirname(__FILE__))), 'system', 'letsencryptchallengepath');
   438| 		$this->_updateSetting($upd_stmt, time(), 'system', 'lastcronrun');
   439| 		if (defined('PHP_MAJOR_VERSION') && defined('PHP_MINOR_VERSION')) {
   440| 			$reload = "service php" . PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION . "-fpm restart";
   441| 			$config_dir = "/etc/php/" . PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION . "/fpm/pool.d/";
   442| 			$db->query("UPDATE `" . TABLE_PANEL_FPMDAEMONS . "` SET `reload_cmd` = '" . $reload . "', `config_dir` = '" . $config_dir . "' WHERE `id` ='1';");
   443| 		}
   444| 		$ts = mktime(0, 0, 0, date('m', time()), date('d', time()), date('Y', time()));
   445| 		$db->query("UPDATE `" . TABLE_PANEL_CRONRUNS . "` SET `lastrun` = '" . $ts . "' WHERE `cronfile` ='cron_traffic';");
   446| 		$db->query("INSERT INTO `" . TABLE_PANEL_TASKS . "` SET `type` = '99';");
   447| 		$content .= $this->_status_message('green', 'OK');
   448| 		return $content;
   449| 	}
   450| 	/**
   451| 	 * Import froxlor.sql into database
   452| 	 *
   453| 	 * @param object $db_root
   454| 	 *
   455| 	 * @return string status messages
   456| 	 */
   457| 	private function _importDatabaseData()
   458| 	{
   459| 		$content = "";
   460| 		$content .= $this->_status_message('begin', $this->_lng['install']['testing_new_db']);
   461| 		$options = array(
   462| 			'PDO::MYSQL_ATTR_INIT_COMMAND' => 'SET names utf8'
   463| 		);

# --- HUNK 2: Lines 696-736 ---
   696| 		if (! empty($_POST['installstep']) && ($this->_data['admin_pass2'] == '' || $this->_data['admin_pass1'] != $this->_data['admin_pass2'])) {
   697| 			$style = 'color:red;';
   698| 		} else {
   699| 			$style = '';
   700| 		}
   701| 		$formdata .= $this->_getSectionItemString('admin_pass2', true, $style, 'password');
   702| 		$formdata .= $this->_getSectionItemYesNo('activate_newsfeed', true);
   703| 		/**
   704| 		 * Server data
   705| 		 */
   706| 		$section = $this->_lng['install']['serversettings'];
   707| 		eval("\$formdata .= \"" . $this->_getTemplate("datasection") . "\";");
   708| 		if (! empty($_POST['installstep']) && $this->_data['distribution'] == '') {
   709| 			$diststyle = 'color:red;';
   710| 		} else {
   711| 			$diststyle = '';
   712| 		}
   713| 		$distros = glob(\Froxlor\FileDir::makeCorrectDir(\Froxlor\Froxlor::getInstallDir() . '/lib/configfiles/') . '*.xml');
   714| 		foreach ($distros as $_distribution) {
   715| 			$dist = new \Froxlor\Config\ConfigParser($_distribution);
   716| 			$dist_display = $dist->distributionName . " " . $dist->distributionCodename . " (" . $dist->distributionVersion . ")";
   717| 			$distributions_select_data[$dist_display] .= str_replace(".xml", "", strtolower(basename($_distribution)));
   718| 		}
   719| 		ksort($distributions_select_data);
   720| 		foreach ($distributions_select_data as $dist_display => $dist_index) {
   721| 			$distributions_select .= \Froxlor\UI\HTML::makeoption($dist_display, $dist_index, $this->_data['distribution']);
   722| 		}
   723| 		$formdata .= $this->_getSectionItemSelectbox('distribution', $distributions_select, $diststyle);
   724| 		if (! empty($_POST['installstep']) && $this->_data['servername'] == '') {
   725| 			$style = 'color:red;';
   726| 		} else {
   727| 			$style = '';
   728| 		}
   729| 		$formdata .= $this->_getSectionItemString('servername', true, $style);
   730| 		if (! empty($_POST['installstep']) && ($this->_data['serverip'] == '' || $this->_validate_ip($this->_data['serverip']) == false)) {
   731| 			$style = 'color:red;';
   732| 		} else {
   733| 			$style = '';
   734| 		}
   735| 		$formdata .= $this->_getSectionItemString('serverip', true, $style);
   736| 		if (! empty($_POST['installstep']) && $this->_data['webserver'] == '') {

# --- HUNK 3: Lines 769-809 ---
   769| 	 * @param boolean $required
   770| 	 * @param string $style
   771| 	 *        	optional css
   772| 	 * @param string $type
   773| 	 *        	optional type of input-box (default: text)
   774| 	 *        	
   775| 	 * @return string
   776| 	 */
   777| 	private function _getSectionItemString($fieldname = null, $required = false, $style = "", $type = 'text')
   778| 	{
   779| 		$fieldlabel = $this->_lng['install'][$fieldname];
   780| 		$fieldvalue = htmlspecialchars($this->_data[$fieldname]);
   781| 		if ($required) {
   782| 			$required = ' required="required"';
   783| 		}
   784| 		$sectionitem = "";
   785| 		eval("\$sectionitem .= \"" . $this->_getTemplate("dataitem") . "\";");
   786| 		return $sectionitem;
   787| 	}
   788| 	/**
   789| 	 * generate form radio field
   790| 	 *
   791| 	 * @param string $fieldname
   792| 	 * @param boolean $checked
   793| 	 * @param string $style
   794| 	 *
   795| 	 * @return string
   796| 	 */
   797| 	private function _getSectionItemCheckbox($groupname = null, $fieldname = null, $checked = false, $style = "")
   798| 	{
   799| 		$groupname = $this->_lng['install'][$groupname];
   800| 		$fieldlabel = $this->_lng['install'][$fieldname];
   801| 		if ($checked) {
   802| 			$checked = 'checked="checked"';
   803| 		}
   804| 		$sectionitem = "";
   805| 		eval("\$sectionitem .= \"" . $this->_getTemplate("dataitemchk") . "\";");
   806| 		return $sectionitem;
   807| 	}
   808| 	/**
   809| 	 * generate form selectbox

# --- HUNK 4: Lines 1068-1117 ---
  1068| 		} else {
  1069| 			if (strtoupper(@php_sapi_name()) == "APACHE2HANDLER" || stristr($_SERVER['SERVER_SOFTWARE'], "apache/2")) {
  1070| 				$this->_data['webserver'] = 'apache24';
  1071| 			} elseif (substr(strtoupper(@php_sapi_name()), 0, 8) == "LIGHTTPD" || stristr($_SERVER['SERVER_SOFTWARE'], "lighttpd")) {
  1072| 				$this->_data['webserver'] = 'lighttpd';
  1073| 			} elseif (substr(strtoupper(@php_sapi_name()), 0, 8) == "NGINX" || stristr($_SERVER['SERVER_SOFTWARE'], "nginx")) {
  1074| 				$this->_data['webserver'] = 'nginx';
  1075| 			} else {
  1076| 				$this->_data['webserver'] = 'unknown';
  1077| 			}
  1078| 		}
  1079| 	}
  1080| 	/**
  1081| 	 * get/guess linux distribution
  1082| 	 */
  1083| 	private function _guessDistribution()
  1084| 	{
  1085| 		if (! empty($_POST['distribution'])) {
  1086| 			$this->_data['distribution'] = $_POST['distribution'];
  1087| 		} else {
  1088| 			$os_dist = array(
  1089| 				'ID' => 'buster'
  1090| 			);
  1091| 			$os_version = array(
  1092| 				'0' => '10'
  1093| 			);
  1094| 			if (file_exists('/etc/os-release')) {
  1095| 				$os_dist = parse_ini_file('/etc/os-release', false);
  1096| 				if (is_array($os_dist) && array_key_exists('ID', $os_dist) && array_key_exists('VERSION_ID', $os_dist)) {
  1097| 					$os_version = explode('.', $os_dist['VERSION_ID'])[0];
  1098| 				}
  1099| 			}
  1100| 			$distros = glob(\Froxlor\FileDir::makeCorrectDir(\Froxlor\Froxlor::getInstallDir() . '/lib/configfiles/') . '*.xml');
  1101| 			foreach ($distros as $_distribution) {
  1102| 				$dist = new \Froxlor\Config\ConfigParser($_distribution);
  1103| 				$ver = explode('.', $dist->distributionVersion)[0];
  1104| 				if (strtolower($os_dist['ID']) == strtolower($dist->distributionName) && $os_version == $ver) {
  1105| 					$this->_data['distribution'] = str_replace(".xml", "", strtolower(basename($_distribution)));
  1106| 				}
  1107| 			}
  1108| 		}
  1109| 	}
  1110| 	/**
  1111| 	 * check if POST field is set and get value for the
  1112| 	 * internal data array, if not set use either '' or $default if != null
  1113| 	 *
  1114| 	 * @param string $fieldname
  1115| 	 * @param string $default
  1116| 	 *
  1117| 	 */


# ====================================================================
# FILE: install/lib/updateFunctions.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 11-77 ---
    11|  * @author     Froxlor team <team@froxlor.org> (2010-)
    12|  * @license    GPLv2 http://files.froxlor.org/misc/COPYING.txt
    13|  * @package    Functions
    14|  *
    15|  */
    16| /**
    17|  * Function showUpdateStep
    18|  *
    19|  * outputs and logs the current
    20|  * update progress
    21|  *
    22|  * @param
    23|  *        	string task/status
    24|  * @param
    25|  *        	bool needs_status (if false, a linebreak will be added)
    26|  *        	
    27|  * @return string formatted output and log-entry
    28|  */
    29| function showUpdateStep($task = null, $needs_status = true)
    30| {
    31| 	set_time_limit(30);
    32| 	if (! $needs_status)
    33| 		echo "<b>";
    34| 	echo $task;
    35| 	if (! $needs_status) {
    36| 		echo "</b><br />";
    37| 	}
    38| 	\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::ADM_ACTION, LOG_WARNING, $task);
    39| }
    40| /**
    41|  * Function lastStepStatus
    42|  *
    43|  * outputs [OK] (success), [??] (warning) or [!!] (failure)
    44|  * of the last update-step
    45|  *
    46|  * @param
    47|  *        	int status (0 = success, 1 = warning, 2 = failure)
    48|  *        	
    49|  * @return string formatted output and log-entry
    50|  */
    51| function lastStepStatus($status = -1, $message = '')
    52| {
    53| 	switch ($status) {
    54| 		case 0:
    55| 			$status_sign = ($message != '') ? '[' . $message . ']' : '[OK]';
    56| 			$status_color = 'ok';
    57| 			break;
    58| 		case 1:
    59| 			$status_sign = ($message != '') ? '[' . $message . ']' : '[??]';
    60| 			$status_color = 'warn';
    61| 			break;
    62| 		case 2:
    63| 			$status_sign = ($message != '') ? '[' . $message . ']' : '[!!]';
    64| 			$status_color = 'err';
    65| 			break;
    66| 		default:
    67| 			$status_sign = '[unknown]';
    68| 			$status_color = 'unknown';
    69| 			break;
    70| 	}
    71| 	echo "<span class=\"update-step update-step-" . $status_color . "\">" . $status_sign . "</span><br />";
    72| 	if ($status == - 1 || $status == 2) {
    73| 		\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::ADM_ACTION, LOG_WARNING, 'Attention - last update task failed!!!');
    74| 	} elseif ($status == 0 || $status == 1) {
    75| 		\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::ADM_ACTION, LOG_WARNING, 'Success');
    76| 	}
    77| }


# ====================================================================
# FILE: install/updates/froxlor/0.10/update_0.10.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 542-565 ---
   542| 	showUpdateStep("Updating from 0.10.19 to 0.10.20", false);
   543| 	\Froxlor\Froxlor::updateToVersion('0.10.20');
   544| }
   545| if (\Froxlor\Froxlor::isDatabaseVersion('202007240')) {
   546| 	showUpdateStep("Removing old unused table", true);
   547| 	Database::query("DROP TABLE IF EXISTS `panel_diskspace_admins`;");
   548| 	lastStepStatus(0);
   549| 	\Froxlor\Froxlor::updateToDbVersion('202009070');
   550| }
   551| if (\Froxlor\Froxlor::isFroxlorVersion('0.10.20')) {
   552| 	showUpdateStep("Updating from 0.10.20 to 0.10.21", false);
   553| 	\Froxlor\Froxlor::updateToVersion('0.10.21');
   554| }
   555| if (\Froxlor\Froxlor::isFroxlorVersion('0.10.21')) {
   556| 	showUpdateStep("Adding settings for ssl-vhost default content if not updated from db-version 201910110", true);
   557| 	Settings::AddNew("system.default_sslvhostconf", '');
   558| 	lastStepStatus(0);
   559| 	showUpdateStep("Updating from 0.10.21 to 0.10.22", false);
   560| 	\Froxlor\Froxlor::updateToVersion('0.10.22');
   561| }
   562| if (\Froxlor\Froxlor::isFroxlorVersion('0.10.22')) {
   563| 	showUpdateStep("Updating from 0.10.22 to 0.10.23", false);
   564| 	\Froxlor\Froxlor::updateToVersion('0.10.23');
   565| }


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Customers.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 896-936 ---
   896| 					Database::pexecute($upd_stmt, array(
   897| 						'domainid' => $domainid,
   898| 						'customerid' => $result['customerid']
   899| 					), true, true);
   900| 					$this->logger()->logAction(\Froxlor\FroxlorLogger::ADM_ACTION, LOG_NOTICE, "[API] automatically added standardsubdomain for user '" . $result['loginname'] . "'");
   901| 					\Froxlor\System\Cronjob::inserttask('1');
   902| 				}
   903| 			}
   904| 			if ($createstdsubdomain == '0' && $result['standardsubdomain'] != '0') {
   905| 				try {
   906| 					$std_domain = $this->apiCall('Domains.delete', array(
   907| 						'id' => $result['standardsubdomain'],
   908| 						'is_stdsubdomain' => 1
   909| 					));
   910| 				} catch (\Exception $e) {
   911| 					$this->logger()->logAction(\Froxlor\FroxlorLogger::ADM_ACTION, LOG_ERR, "[API] Unable to delete standard-subdomain: " . $e->getMessage());
   912| 				}
   913| 				$this->logger()->logAction(\Froxlor\FroxlorLogger::ADM_ACTION, LOG_NOTICE, "[API] automatically deleted standardsubdomain for user '" . $result['loginname'] . "'");
   914| 				\Froxlor\System\Cronjob::inserttask('1');
   915| 			}
   916| 			if ($phpenabled != $result['phpenabled'] || $perlenabled != $result['perlenabled'] || $email != $result['email']) {
   917| 				\Froxlor\System\Cronjob::inserttask('1');
   918| 			}
   919| 			if ($deactivated != $result['deactivated']) {
   920| 				$yesno = ($deactivated ? 'N' : 'Y');
   921| 				$pop3 = ($deactivated ? '0' : (int) $result['pop3']);
   922| 				$imap = ($deactivated ? '0' : (int) $result['imap']);
   923| 				$upd_stmt = Database::prepare("
   924| 					UPDATE `" . TABLE_MAIL_USERS . "` SET `postfix`= :yesno, `pop3` = :pop3, `imap` = :imap WHERE `customerid` = :customerid
   925| 				");
   926| 				Database::pexecute($upd_stmt, array(
   927| 					'yesno' => $yesno,
   928| 					'pop3' => $pop3,
   929| 					'imap' => $imap,
   930| 					'customerid' => $id
   931| 				));
   932| 				$upd_stmt = Database::prepare("
   933| 					UPDATE `" . TABLE_FTP_USERS . "` SET `login_enabled` = :yesno WHERE `customerid` = :customerid
   934| 				");
   935| 				Database::pexecute($upd_stmt, array(
   936| 					'yesno' => $yesno,


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/DomainZones.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 232-272 ---
   232| 		if (empty($errors)) {
   233| 			$ins_stmt = Database::prepare("
   234| 				INSERT INTO `" . TABLE_DOMAIN_DNS . "` SET
   235| 				`record` = :record,
   236| 				`type` = :type,
   237| 				`prio` = :prio,
   238| 				`content` = :content,
   239| 				`ttl` = :ttl,
   240| 				`domain_id` = :domain_id
   241| 			");
   242| 			Database::pexecute($ins_stmt, $new_entry, true, true);
   243| 			$new_entry_id = Database::lastInsertId();
   244| 			$new_entry['id'] = $new_entry_id;
   245| 			$dom_entries[] = $new_entry;
   246| 			\Froxlor\System\Cronjob::inserttask('4');
   247| 			$result = $this->apiCall('DomainZones.get', array(
   248| 				'id' => $id
   249| 			));
   250| 			return $this->response(200, "successful", $result);
   251| 		}
   252| 		throw new \Exception(implode("\n", $errors), 406);
   253| 	}
   254| 	/**
   255| 	 * return a domain-dns entry by either id or domainname
   256| 	 *
   257| 	 * @param int $id
   258| 	 *        	optional, the domain id
   259| 	 * @param string $domainname
   260| 	 *        	optional, the domain name
   261| 	 *        	
   262| 	 * @access admin, customer
   263| 	 * @throws \Exception
   264| 	 * @return string json-encoded array
   265| 	 */
   266| 	public function get()
   267| 	{
   268| 		if (Settings::Get('system.dnsenabled') != '1') {
   269| 			throw new \Exception("DNS service not enabled on this system", 405);
   270| 		}
   271| 		if ($this->isAdmin() == false && $this->getUserDetail('dnsenabled') != '1') {
   272| 			throw new \Exception("You cannot access this resource", 405);


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Traffic.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-138 ---
    37| 		throw new \Exception('To get specific traffic details use year, month and/or day parameter for Traffic.listing()', 303);
    38| 	}
    39| 	/**
    40| 	 * You cannot update traffic data
    41| 	 *
    42| 	 * @throws \Exception
    43| 	 */
    44| 	public function update()
    45| 	{
    46| 		throw new \Exception('You cannot update traffic data', 303);
    47| 	}
    48| 	/**
    49| 	 * list traffic information
    50| 	 *
    51| 	 * @param int $year
    52| 	 *        	optional, default empty
    53| 	 * @param int $month
    54| 	 *        	optional, default empty
    55| 	 * @param int $day
    56| 	 *        	optional, default empty
    57| 	 * @param int $date_from
    58| 	 *        	optional timestamp, default empty, if specified, $year, $month and $day will be ignored
    59| 	 * @param int $date_until
    60| 	 *        	optional timestamp, default empty, if specified, $year, $month and $day will be ignored
    61| 	 * @param bool $customer_traffic
    62| 	 *        	optional, admin-only, whether to output ones own traffic or all of ones customers, default is 0 (false)
    63| 	 * @param int $customerid
    64| 	 *        	optional, admin-only, select traffic of a specific customer by id
    65| 	 * @param string $loginname
    66| 	 *        	optional, admin-only, select traffic of a specific customer by loginname
    67| 	 *        	
    68| 	 * @access admin, customer
    69| 	 * @throws \Exception
    70| 	 * @return string json-encoded array count|list
    71| 	 */
    72| 	public function listing()
    73| 	{
    74| 		$year = $this->getParam('year', true, "");
    75| 		$month = $this->getParam('month', true, "");
    76| 		$day = $this->getParam('day', true, "");
    77| 		$date_from = $this->getParam('date_from', true, - 1);
    78| 		$date_until = $this->getParam('date_until', true, - 1);
    79| 		$customer_traffic = $this->getBoolParam('customer_traffic', true, 0);
    80| 		$customer_ids = $this->getAllowedCustomerIds();
    81| 		$result = array();
    82| 		$params = array();
    83| 		if ($date_from >= 0 || $date_until >= 0) {
    84| 			$year = "";
    85| 			$month = "";
    86| 			$day = "";
    87| 			if ($date_from == $date_until) {
    88| 				$date_until = -1;
    89| 			}
    90| 			if ($date_from >= 0 && $date_until >= 0 && $date_until < $date_from) {
    91| 				$temp_ts = $date_from;
    92| 				$date_from = $date_until;
    93| 				$date_until = $temp_ts;
    94| 			}
    95| 		}
    96| 		$where_str = "";
    97| 		if (! empty($year) && is_numeric($year)) {
    98| 			$where_str .= " AND `year` = :year";
    99| 			$params['year'] = $year;
   100| 		}
   101| 		if (! empty($month) && is_numeric($month)) {
   102| 			$where_str .= " AND `month` = :month";
   103| 			$params['month'] = $month;
   104| 		}
   105| 		if (! empty($day) && is_numeric($day)) {
   106| 			$where_str .= " AND `day` = :day";
   107| 			$params['day'] = $day;
   108| 		}
   109| 		if ($date_from >= 0 && $date_until >= 0) {
   110| 			$where_str .= " AND `stamp` BETWEEN :df AND :du";
   111| 			$params['df'] = $date_from;
   112| 			$params['du'] = $date_until;
   113| 		} elseif ($date_from >= 0 && $date_until < 0) {
   114| 			$where_str .= " AND `stamp` > :df";
   115| 			$params['df'] = $date_from;
   116| 		} elseif ($date_from < 0 && $date_until >= 0) {
   117| 			$where_str .= " AND `stamp` < :du";
   118| 			$params['du'] = $date_until;
   119| 		}
   120| 		if (! $this->isAdmin() || ($this->isAdmin() && $customer_traffic)) {
   121| 			$result_stmt = Database::prepare("
   122| 				SELECT * FROM `" . TABLE_PANEL_TRAFFIC . "`
   123| 				WHERE `customerid` IN (" . implode(", ", $customer_ids) . ")" . $where_str);
   124| 		} else {
   125| 			$params['adminid'] = $this->getUserDetail('adminid');
   126| 			$result_stmt = Database::prepare("
   127| 				SELECT * FROM `" . TABLE_PANEL_TRAFFIC_ADMINS . "`
   128| 				WHERE `adminid` = :adminid" . $where_str);
   129| 		}
   130| 		Database::pexecute($result_stmt, $params, true, true);
   131| 		while ($row = $result_stmt->fetch(\PDO::FETCH_ASSOC)) {
   132| 			$result[] = $row;
   133| 		}
   134| 		$this->logger()->logAction($this->isAdmin() ? \Froxlor\FroxlorLogger::ADM_ACTION : \Froxlor\FroxlorLogger::USR_ACTION, LOG_NOTICE, "[API] list traffic");
   135| 		return $this->response(200, "successful", array(
   136| 			'count' => count($result),
   137| 			'list' => $result
   138| 		));


# ====================================================================
# FILE: lib/Froxlor/Cron/Http/Apache.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 339-382 ---
   339| 				 *       $this->virtualhosts_data[$vhosts_filename] .= "\t\tDeny from All\n";
   340| 				 *       $this->virtualhosts_data[$vhosts_filename] .= "\t</Directory>\n";
   341| 				 *       end of dirprotection
   342| 				 */
   343| 				if ($row_ipsandports['specialsettings'] != '' && ($row_ipsandports['ssl'] == '0' || ($row_ipsandports['ssl'] == '1' && Settings::Get('system.use_ssl') == '1' && $row_ipsandports['include_specialsettings'] == '1'))) {
   344| 					$this->virtualhosts_data[$vhosts_filename] .= $this->processSpecialConfigTemplate($row_ipsandports['specialsettings'], $domain, $row_ipsandports['ip'], $row_ipsandports['port'], $row_ipsandports['ssl'] == '1') . "\n";
   345| 				}
   346| 				if ($row_ipsandports['ssl'] == '1' && Settings::Get('system.use_ssl') == '1') {
   347| 					if ($row_ipsandports['ssl_specialsettings'] != '') {
   348| 						$this->virtualhosts_data[$vhosts_filename] .= $this->processSpecialConfigTemplate($row_ipsandports['ssl_specialsettings'], $domain, $row_ipsandports['ip'], $row_ipsandports['port'], $row_ipsandports['ssl'] == '1') . "\n";
   349| 					}
   350| 					if (($row_ipsandports['ssl_cert_file'] == '' || ! file_exists($row_ipsandports['ssl_cert_file'])) && (Settings::Get('system.le_froxlor_enabled') == '0' || $this->froxlorVhostHasLetsEncryptCert() == false)) {
   351| 						$row_ipsandports['ssl_cert_file'] = Settings::Get('system.ssl_cert_file');
   352| 						if (! file_exists($row_ipsandports['ssl_cert_file'])) {
   353| 							$row_ipsandports['ssl_cert_file'] = "";
   354| 							\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate file "' . Settings::Get('system.ssl_cert_file') . '" does not seem to exist. Disabling SSL-vhost for "' . Settings::Get('system.hostname') . '"');
   355| 						}
   356| 					}
   357| 					if ($row_ipsandports['ssl_key_file'] == '') {
   358| 						$row_ipsandports['ssl_key_file'] = Settings::Get('system.ssl_key_file');
   359| 						if (! file_exists($row_ipsandports['ssl_key_file'])) {
   360| 							$row_ipsandports['ssl_cert_file'] = "";
   361| 							\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate key-file "' . Settings::Get('system.ssl_key_file') . '" does not seem to exist. Disabling SSL-vhost for "' . Settings::Get('system.hostname') . '"');
   362| 						}
   363| 					}
   364| 					if ($row_ipsandports['ssl_ca_file'] == '') {
   365| 						$row_ipsandports['ssl_ca_file'] = Settings::Get('system.ssl_ca_file');
   366| 					}
   367| 					if ($row_ipsandports['ssl_cert_chainfile'] == '') {
   368| 						$row_ipsandports['ssl_cert_chainfile'] = Settings::Get('system.ssl_cert_chainfile');
   369| 					}
   370| 					$domain = array(
   371| 						'id' => 0,
   372| 						'domain' => Settings::Get('system.hostname'),
   373| 						'adminid' => 1, /* first admin-user (superadmin) */
   374| 						'loginname' => 'froxlor.panel',
   375| 						'documentroot' => $mypath,
   376| 						'customerroot' => $mypath,
   377| 						'parentdomainid' => 0,
   378| 						'ssl_honorcipherorder' => Settings::Get('system.honorcipherorder'),
   379| 						'ssl_sessiontickets' => Settings::Get('system.sessiontickets')
   380| 					);
   381| 					$domain['ssl_cert_file'] = $row_ipsandports['ssl_cert_file'];
   382| 					$domain['ssl_key_file'] = $row_ipsandports['ssl_key_file'];

# --- HUNK 2: Lines 768-813 ---
   768| 				AND `ip`.`ssl` = '1'  AND `ip`.`port` != 443
   769| 				ORDER BY `ip`.`ssl_cert_file` DESC, `ip`.`port` LIMIT 1;
   770| 			");
   771| 			$ssldestport = Database::pexecute_first($ssldestport_stmt, array(
   772| 				'domainid' => $domain['id']
   773| 			));
   774| 			if ($ssldestport && $ssldestport['port'] != '') {
   775| 				$_sslport = ":" . $ssldestport['port'];
   776| 			}
   777| 			$domain['documentroot'] = 'https://%{HTTP_HOST}' . $_sslport . '/';
   778| 			$domain['documentroot_norewrite'] = 'https://' . $domain['domain'] . $_sslport . '/';
   779| 		}
   780| 		if ($ssl_vhost === true && $domain['ssl'] == '1' && Settings::Get('system.use_ssl') == '1') {
   781| 			if ($domain['ssl_cert_file'] == '' || ! file_exists($domain['ssl_cert_file'])) {
   782| 				$domain['ssl_cert_file'] = Settings::Get('system.ssl_cert_file');
   783| 				if (! file_exists($domain['ssl_cert_file'])) {
   784| 					$domain['ssl_cert_file'] = "";
   785| 					\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate file "' . Settings::Get('system.ssl_cert_file') . '" does not seem to exist. Disabling SSL-vhost for "' . $domain['domain'] . '"');
   786| 				}
   787| 			}
   788| 			if ($domain['ssl_key_file'] == '' || ! file_exists($domain['ssl_key_file'])) {
   789| 				$domain['ssl_key_file'] = Settings::Get('system.ssl_key_file');
   790| 				if (! file_exists($domain['ssl_key_file'])) {
   791| 					$domain['ssl_cert_file'] = "";
   792| 					\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate key-file "' . Settings::Get('system.ssl_key_file') . '" does not seem to exist. Disabling SSL-vhost for "' . $domain['domain'] . '"');
   793| 				}
   794| 			}
   795| 			if ($domain['ssl_ca_file'] == '') {
   796| 				$domain['ssl_ca_file'] = Settings::Get('system.ssl_ca_file');
   797| 			}
   798| 			if ($domain['ssl_cert_chainfile'] == '') {
   799| 				$domain['ssl_cert_chainfile'] = Settings::Get('system.ssl_cert_chainfile');
   800| 			}
   801| 			if ($domain['ssl_cert_file'] != '') {
   802| 				$ssl_protocols = ($domain['override_tls'] == '1' && ! empty($domain['ssl_protocols'])) ? $domain['ssl_protocols'] : Settings::Get('system.ssl_protocols');
   803| 				$ssl_cipher_list = ($domain['override_tls'] == '1' && ! empty($domain['ssl_cipher_list'])) ? $domain['ssl_cipher_list'] : Settings::Get('system.ssl_cipher_list');
   804| 				$tlsv13_cipher_list = ($domain['override_tls'] == '1' && ! empty($domain['tlsv13_cipher_list'])) ? $domain['tlsv13_cipher_list'] : Settings::Get('system.tlsv13_cipher_list');
   805| 				$vhost_content .= '  SSLEngine On' . "\n";
   806| 				$vhost_content .= '  SSLProtocol -ALL +' . str_replace(",", " +", $ssl_protocols) . "\n";
   807| 				if (Settings::Get('system.apache24') == '1') {
   808| 					if (isset($domain['http2']) && $domain['http2'] == '1' && Settings::Get('system.http2_support') == '1') {
   809| 						$vhost_content .= '  Protocols h2 http/1.1' . "\n";
   810| 					}
   811| 					if (! empty(Settings::Get('system.dhparams_file'))) {
   812| 						$dhparams = \Froxlor\FileDir::makeCorrectFile(Settings::Get('system.dhparams_file'));
   813| 						if (! file_exists($dhparams)) {


# ====================================================================
# FILE: lib/Froxlor/Cron/Http/DomainSSL.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 68-106 ---
    68| 			$ssl_files['ssl_cert_chainfile'] = '';
    69| 			if ($dom_certs['ssl_ca_file'] != '') {
    70| 				$ssl_files['ssl_ca_file'] = \Froxlor\FileDir::makeCorrectFile($sslcertpath . '/' . $domain['domain'] . '_CA.pem');
    71| 			}
    72| 			if ($dom_certs['ssl_cert_chainfile'] != '') {
    73| 				if (Settings::Get('system.webserver') == 'nginx') {
    74| 					$dom_certs['ssl_cert_file'] = trim($dom_certs['ssl_cert_file']) . "\n" . trim($dom_certs['ssl_cert_chainfile']) . "\n";
    75| 				} else {
    76| 					$ssl_files['ssl_cert_chainfile'] = \Froxlor\FileDir::makeCorrectFile($sslcertpath . '/' . $domain['domain'] . '_chain.pem');
    77| 				}
    78| 			}
    79| 			if ($dom_certs['ssl_fullchain_file'] != '') {
    80| 				$ssl_files['ssl_fullchain_file'] = \Froxlor\FileDir::makeCorrectFile($sslcertpath . '/' . $domain['domain'] . '_fullchain.pem');
    81| 			}
    82| 			foreach ($ssl_files as $type => $filename) {
    83| 				if ($filename != '') {
    84| 					touch($filename);
    85| 					$_fh = fopen($filename, 'w');
    86| 					fwrite($_fh, $dom_certs[$type]);
    87| 					fclose($_fh);
    88| 					if ($type == 'ssl_key_file') {
    89| 						chmod($filename, 0600);
    90| 					} else {
    91| 						chmod($filename, 0644);
    92| 					}
    93| 				}
    94| 			}
    95| 			$domain['ssl_cert_file'] = $ssl_files['ssl_cert_file'];
    96| 			$domain['ssl_key_file'] = $ssl_files['ssl_key_file'];
    97| 			$domain['ssl_ca_file'] = $ssl_files['ssl_ca_file'];
    98| 			$domain['ssl_cert_chainfile'] = $ssl_files['ssl_cert_chainfile'];
    99| 		}
   100| 		return;
   101| 	}
   102| 	private function validateCertificate($dom_certs = array())
   103| 	{
   104| 		return openssl_x509_check_private_key($dom_certs['ssl_cert_file'], $dom_certs['ssl_key_file']);
   105| 	}
   106| }


# ====================================================================
# FILE: lib/Froxlor/Cron/Http/LetsEncrypt/AcmeSh.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 202-257 ---
   202| 						if ($aliasdomain['wwwserveralias'] == 1) {
   203| 							$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, "Adding SAN entry: www." . $aliasdomain['domain']);
   204| 							$domains[] = strtolower('www.' . $aliasdomain['domain']);
   205| 						}
   206| 					}
   207| 				}
   208| 				self::validateDns($domains, $certrow['domainid'], $cronlog);
   209| 				self::runAcmeSh($certrow, $domains, $cronlog, $do_force);
   210| 			} else {
   211| 				$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_WARNING, "Skipping Let's Encrypt generation for " . $certrow['domain'] . " due to an enabled ssl_redirect");
   212| 			}
   213| 		}
   214| 	}
   215| 	/**
   216| 	 * validate dns (A / AAAA record) of domain against known system ips
   217| 	 *
   218| 	 * @param array $domains
   219| 	 * @param int $domain_id
   220| 	 * @param FroxlorLogger $cronlog
   221| 	 */
   222| 	private static function validateDns(array &$domains, $domain_id, &$cronlog)
   223| 	{
   224| 		if (Settings::Get('system.le_domain_dnscheck') == '1' && ! empty($domains)) {
   225| 			$loop_domains = $domains;
   226| 			$our_ips = Domain::getIpsOfDomain($domain_id);
   227| 			foreach ($loop_domains as $idx => $domain) {
   228| 				$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, "Validating DNS of " . $domain);
   229| 				$domain_ips = PhpHelper::gethostbynamel6($domain);
   230| 				if ($domain_ips == false || count(array_intersect($our_ips, $domain_ips)) <= 0) {
   231| 					$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_WARNING, "Skipping Let's Encrypt generation for " . $domain . " due to no system known IP address via DNS check");
   232| 					unset($domains[$idx]);
   233| 				}
   234| 			}
   235| 		}
   236| 	}
   237| 	private static function runAcmeSh(array $certrow, array $domains, &$cronlog = null, $force = false)
   238| 	{
   239| 		if (! empty($domains)) {
   240| 			$acmesh_cmd = self::$acmesh . " --server " . self::$apiserver . " --issue -d " . implode(" -d ", $domains);
   241| 			$acmesh_cmd .= " -w " . Settings::Get('system.letsencryptchallengepath');
   242| 			if (Settings::Get('system.leecc') > 0) {
   243| 				$acmesh_cmd .= " --keylength ec-" . Settings::Get('system.leecc');
   244| 			} else {
   245| 				$acmesh_cmd .= " --keylength " . Settings::Get('system.letsencryptkeysize');
   246| 			}
   247| 			if (Settings::Get('system.letsencryptreuseold') != '1') {
   248| 				$acmesh_cmd .= " --always-force-new-domain-key";
   249| 			}
   250| 			if (Settings::Get('system.letsencryptca') == 'testing') {
   251| 				$acmesh_cmd .= " --staging";
   252| 			}
   253| 			if ($force) {
   254| 				$acmesh_cmd .= " --force";
   255| 			}
   256| 			if (defined('CRON_DEBUG_FLAG')) {
   257| 				$acmesh_cmd .= " --debug";


# ====================================================================
# FILE: lib/Froxlor/Cron/Http/Nginx.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 112-155 ---
   112| 			$port = $row_ipsandports['port'];
   113| 			\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_INFO, 'nginx::createIpPort: creating ip/port settings for  ' . $ip . ":" . $port);
   114| 			$vhost_filename = \Froxlor\FileDir::makeCorrectFile(Settings::Get('system.apacheconf_vhost') . '/10_froxlor_ipandport_' . trim(str_replace(':', '.', $row_ipsandports['ip']), '.') . '.' . $row_ipsandports['port'] . '.conf');
   115| 			if (! isset($this->nginx_data[$vhost_filename])) {
   116| 				$this->nginx_data[$vhost_filename] = '';
   117| 			}
   118| 			if ($row_ipsandports['vhostcontainer'] == '1') {
   119| 				$this->nginx_data[$vhost_filename] .= 'server { ' . "\n";
   120| 				$mypath = $this->getMyPath($row_ipsandports);
   121| 				$ssl_vhost = false;
   122| 				if ($row_ipsandports['ssl'] == '1') {
   123| 					if (($row_ipsandports['ssl_cert_file'] == '' || ! file_exists($row_ipsandports['ssl_cert_file'])) && (Settings::Get('system.le_froxlor_enabled') == '0' || $this->froxlorVhostHasLetsEncryptCert() == false)) {
   124| 						$row_ipsandports['ssl_cert_file'] = Settings::Get('system.ssl_cert_file');
   125| 						if (! file_exists($row_ipsandports['ssl_cert_file'])) {
   126| 							$row_ipsandports['ssl_cert_file'] = "";
   127| 							\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate file "' . Settings::Get('system.ssl_cert_file') . '" does not seem to exist. Disabling SSL-vhost for "' . Settings::Get('system.hostname') . '"');
   128| 						}
   129| 					}
   130| 					if ($row_ipsandports['ssl_key_file'] == '') {
   131| 						$row_ipsandports['ssl_key_file'] = Settings::Get('system.ssl_key_file');
   132| 						if (! file_exists($row_ipsandports['ssl_key_file'])) {
   133| 							$row_ipsandports['ssl_cert_file'] = "";
   134| 							\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate key-file "' . Settings::Get('system.ssl_key_file') . '" does not seem to exist. Disabling SSL-vhost for "' . Settings::Get('system.hostname') . '"');
   135| 						}
   136| 					}
   137| 					if ($row_ipsandports['ssl_ca_file'] == '') {
   138| 						$row_ipsandports['ssl_ca_file'] = Settings::Get('system.ssl_ca_file');
   139| 					}
   140| 					if ($row_ipsandports['ssl_cert_file'] != '' && file_exists($row_ipsandports['ssl_cert_file'])) {
   141| 						$ssl_vhost = true;
   142| 					}
   143| 					$domain = array(
   144| 						'id' => 0,
   145| 						'domain' => Settings::Get('system.hostname'),
   146| 						'adminid' => 1, /* first admin-user (superadmin) */
   147| 						'loginname' => 'froxlor.panel',
   148| 						'documentroot' => $mypath,
   149| 						'customerroot' => $mypath,
   150| 						'parentdomainid' => 0
   151| 					);
   152| 					$domain['ssl_cert_file'] = $row_ipsandports['ssl_cert_file'];
   153| 					$domain['ssl_key_file'] = $row_ipsandports['ssl_key_file'];
   154| 					$domain['ssl_ca_file'] = $row_ipsandports['ssl_ca_file'];
   155| 					$domain['ssl_cert_chainfile'] = $row_ipsandports['ssl_cert_chainfile'];

# --- HUNK 2: Lines 499-544 ---
   499| 				for ($j = 0; $j < $nextLevel; $j ++) {
   500| 					$vhost_frx[$i] = "	" . $vhost_frx[$i];
   501| 				}
   502| 			}
   503| 			if (substr_count($vhost_frx[$i], "{") != 0 && substr_count($vhost_frx[$i], "}") == 0) {
   504| 				$nextLevel += 1;
   505| 			}
   506| 		}
   507| 		return implode("\n", $vhost_frx);
   508| 	}
   509| 	protected function composeSslSettings($domain_or_ip)
   510| 	{
   511| 		$sslsettings = '';
   512| 		if ($domain_or_ip['ssl_cert_file'] == '' || ! file_exists($domain_or_ip['ssl_cert_file'])) {
   513| 			$domain_or_ip['ssl_cert_file'] = Settings::Get('system.ssl_cert_file');
   514| 			if (! file_exists($domain_or_ip['ssl_cert_file'])) {
   515| 				$domain_or_ip['ssl_cert_file'] = "";
   516| 				\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate file "' . Settings::Get('system.ssl_cert_file') . '" does not seem to exist. Disabling SSL-vhost for "' . $domain_or_ip['domain'] . '"');
   517| 			}
   518| 		}
   519| 		if ($domain_or_ip['ssl_key_file'] == '' || ! file_exists($domain_or_ip['ssl_key_file'])) {
   520| 			$domain_or_ip['ssl_key_file'] = Settings::Get('system.ssl_key_file');
   521| 			if (! file_exists($domain_or_ip['ssl_key_file'])) {
   522| 				$domain_or_ip['ssl_cert_file'] = "";
   523| 				\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_DEBUG, 'System certificate key-file "' . Settings::Get('system.ssl_key_file') . '" does not seem to exist. Disabling SSL-vhost for "' . $domain_or_ip['domain'] . '"');
   524| 			}
   525| 		}
   526| 		if ($domain_or_ip['ssl_ca_file'] == '') {
   527| 			$domain_or_ip['ssl_ca_file'] = Settings::Get('system.ssl_ca_file');
   528| 		}
   529| 		if ($domain_or_ip['ssl_cert_chainfile'] == '') {
   530| 			$domain_or_ip['ssl_cert_chainfile'] = Settings::Get('system.ssl_cert_chainfile');
   531| 		}
   532| 		if ($domain_or_ip['ssl_cert_file'] != '') {
   533| 			if (! file_exists($domain_or_ip['ssl_cert_file'])) {
   534| 				\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_ERR, $domain_or_ip['domain'] . ' :: certificate file "' . $domain_or_ip['ssl_cert_file'] . '" does not exist! Cannot create ssl-directives');
   535| 			} else {
   536| 				$ssl_protocols = (isset($domain_or_ip['override_tls']) && $domain_or_ip['override_tls'] == '1' && ! empty($domain_or_ip['ssl_protocols'])) ? $domain_or_ip['ssl_protocols'] : Settings::Get('system.ssl_protocols');
   537| 				$ssl_cipher_list = (isset($domain_or_ip['override_tls']) && $domain_or_ip['override_tls'] == '1' && ! empty($domain_or_ip['ssl_cipher_list'])) ? $domain_or_ip['ssl_cipher_list'] : Settings::Get('system.ssl_cipher_list');
   538| 				$sslsettings .= "\t" . 'ssl_protocols ' . str_replace(",", " ", $ssl_protocols) . ';' . "\n";
   539| 				$sslsettings .= "\t" . 'ssl_ciphers ' . $ssl_cipher_list . ';' . "\n";
   540| 				if (! empty(Settings::Get('system.dhparams_file'))) {
   541| 					$dhparams = \Froxlor\FileDir::makeCorrectFile(Settings::Get('system.dhparams_file'));
   542| 					if (! file_exists($dhparams)) {
   543| 						\Froxlor\FileDir::safe_exec('openssl dhparam -out ' . escapeshellarg($dhparams) . ' 4096');
   544| 					}


# ====================================================================
# FILE: lib/Froxlor/Cron/Traffic/TrafficCron.php
# Total hunks: 9
# ====================================================================
# --- HUNK 1: Lines 113-222 ---
   113| 				if ($mysql_usage_row) {
   114| 					$mysqlusage_all[$row_database['customerid']] += floatval($mysql_usage_row['customerusage']);
   115| 				} else {
   116| 					\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_WARNING, "Cannot get usage for database " . $row_database['databasename'] . ".");
   117| 				}
   118| 			} else {
   119| 				\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_WARNING, "Seems like the database " . $row_database['databasename'] . " had been removed manually.");
   120| 			}
   121| 		}
   122| 		Database::needRoot(false);
   123| 		if (Settings::Get('system.diskquota_enabled')) {
   124| 			$usedquota = \Froxlor\FileDir::getFilesystemQuota();
   125| 		}
   126| 		/**
   127| 		 * MAIL-Traffic
   128| 		 */
   129| 		if (Settings::Get("system.mailtraffic_enabled")) {
   130| 			$mailTrafficCalc = new \Froxlor\MailLogParser(Settings::Get("system.last_traffic_run"));
   131| 		}
   132| 		$result_stmt = Database::query("SELECT * FROM `" . TABLE_PANEL_CUSTOMERS . "` ORDER BY `customerid` ASC");
   133| 		$currentDate = date("Y-m-d");
   134| 		$current_stamp = time();
   135| 		$current_year = date('Y', $current_stamp);
   136| 		$current_month = date('m', $current_stamp);
   137| 		$current_day = date('d', $current_stamp);
   138| 		while ($row = $result_stmt->fetch(\PDO::FETCH_ASSOC)) {
   139| 			/**
   140| 			 * HTTP-Traffic
   141| 			 */
   142| 			\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_INFO, 'http traffic for ' . $row['loginname'] . ' started...');
   143| 			$httptraffic = 0;
   144| 			if (isset($domainlist[$row['customerid']]) && is_array($domainlist[$row['customerid']]) && count($domainlist[$row['customerid']]) != 0) {
   145| 				if ($row['standardsubdomain'] != '0') {
   146| 					$caption = $domainlist[$row['customerid']][$row['standardsubdomain']];
   147| 				} else {
   148| 					$caption = $row['loginname'];
   149| 					foreach ($domainlist[$row['customerid']] as $domainid => $domain) {
   150| 						if (! isset($speciallogfile_domainlist[$row['customerid']]) || ! isset($speciallogfile_domainlist[$row['customerid']][$domainid])) {
   151| 							$caption = $domain;
   152| 							break;
   153| 						}
   154| 					}
   155| 				}
   156| 				$httptraffic = 0;
   157| 				reset($domainlist[$row['customerid']]);
   158| 				if (isset($speciallogfile_domainlist[$row['customerid']]) && is_array($speciallogfile_domainlist[$row['customerid']]) && count($speciallogfile_domainlist[$row['customerid']]) != 0) {
   159| 					reset($speciallogfile_domainlist[$row['customerid']]);
   160| 					if (Settings::Get('system.awstats_enabled') == '0') {
   161| 						foreach ($speciallogfile_domainlist[$row['customerid']] as $domainid => $domain) {
   162| 							$httptraffic += floatval(self::callWebalizerGetTraffic($row['loginname'] . '-' . $domain, $row['documentroot'] . '/webalizer/' . $domain . '/', $domain, $domainlist[$row['customerid']]));
   163| 						}
   164| 					}
   165| 				}
   166| 				reset($domainlist[$row['customerid']]);
   167| 				if (Settings::Get('system.awstats_enabled') == '1') {
   168| 					$httptraffic += floatval(self::callAwstatsGetTraffic($row['customerid'], $row['documentroot'] . '/awstats/', $domainlist[$row['customerid']]), $current_stamp);
   169| 				} else {
   170| 					$httptraffic += floatval(self::callWebalizerGetTraffic($row['loginname'], $row['documentroot'] . '/webalizer/', $caption, $domainlist[$row['customerid']]));
   171| 				}
   172| 				\Froxlor\Http\Statistics::makeChownWithNewStats($row);
   173| 			}
   174| 			/**
   175| 			 * FTP-Traffic
   176| 			 */
   177| 			\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_INFO, 'ftp traffic for ' . $row['loginname'] . ' started...');
   178| 			$ftptraffic_stmt = Database::prepare("
   179| 				SELECT SUM(`up_bytes`) AS `up_bytes_sum`, SUM(`down_bytes`) AS `down_bytes_sum`
   180| 				FROM `" . TABLE_FTP_USERS . "` WHERE `customerid` = :customerid
   181| 			");
   182| 			$ftptraffic = Database::pexecute_first($ftptraffic_stmt, array(
   183| 				'customerid' => $row['customerid']
   184| 			));
   185| 			if (! is_array($ftptraffic)) {
   186| 				$ftptraffic = array(
   187| 					'up_bytes_sum' => 0,
   188| 					'down_bytes_sum' => 0
   189| 				);
   190| 			}
   191| 			$upd_stmt = Database::prepare("
   192| 				UPDATE `" . TABLE_FTP_USERS . "` SET `up_bytes` = '0', `down_bytes` = '0' WHERE `customerid` = :customerid
   193| 			");
   194| 			Database::pexecute($upd_stmt, array(
   195| 				'customerid' => $row['customerid']
   196| 			));
   197| 			/**
   198| 			 * Mail-Traffic
   199| 			 */
   200| 			$mailtraffic = 0;
   201| 			if (Settings::Get("system.mailtraffic_enabled")) {
   202| 				\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_INFO, 'mail traffic usage for ' . $row['loginname'] . " started...");
   203| 				$domains_stmt = Database::prepare("SELECT domain FROM `" . TABLE_PANEL_DOMAINS . "` WHERE `customerid` = :cid");
   204| 				Database::pexecute($domains_stmt, array(
   205| 					"cid" => $row['customerid']
   206| 				));
   207| 				while ($domainRow = $domains_stmt->fetch(\PDO::FETCH_ASSOC)) {
   208| 					$domainMailTraffic = $mailTrafficCalc->getDomainTraffic($domainRow["domain"]);
   209| 					if (! is_array($domainMailTraffic)) {
   210| 						continue;
   211| 					}
   212| 					foreach ($domainMailTraffic as $dateTraffic => $dayTraffic) {
   213| 						$dayTraffic = floatval($dayTraffic / 1024);
   214| 						list ($year, $month, $day) = explode("-", $dateTraffic);
   215| 						if ($dateTraffic == $currentDate) {
   216| 							$mailtraffic = $dayTraffic;
   217| 						} else {
   218| 							$stmt = Database::prepare("SELECT * FROM `" . TABLE_PANEL_TRAFFIC . "`
   219| 								WHERE `customerid` = :cid
   220| 								AND `year` = :year
   221| 								AND `month` = :month
   222| 								AND `day` = :day

# --- HUNK 2: Lines 238-306 ---
   238| 									"mail" => $updRow['mail'] + $dayTraffic,
   239| 									"id" => $updRow['id']
   240| 								));
   241| 							}
   242| 						}
   243| 					}
   244| 				}
   245| 			}
   246| 			/**
   247| 			 * Total Traffic
   248| 			 */
   249| 			\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_INFO, 'total traffic for ' . $row['loginname'] . ' started');
   250| 			$current_traffic = array();
   251| 			$current_traffic['http'] = floatval($httptraffic);
   252| 			$current_traffic['ftp_up'] = floatval(($ftptraffic['up_bytes_sum'] / 1024));
   253| 			$current_traffic['ftp_down'] = floatval(($ftptraffic['down_bytes_sum'] / 1024));
   254| 			$current_traffic['mail'] = floatval($mailtraffic);
   255| 			$current_traffic['all'] = $current_traffic['http'] + $current_traffic['ftp_up'] + $current_traffic['ftp_down'] + $current_traffic['mail'];
   256| 			$ins_data = array(
   257| 				'customerid' => $row['customerid'],
   258| 				'year' => $current_year,
   259| 				'month' => $current_month,
   260| 				'day' => $current_day,
   261| 				'stamp' => $current_stamp,
   262| 				'http' => $current_traffic['http'],
   263| 				'ftp_up' => $current_traffic['ftp_up'],
   264| 				'ftp_down' => $current_traffic['ftp_down'],
   265| 				'mail' => $current_traffic['mail']
   266| 			);
   267| 			$ins_stmt = Database::prepare("
   268| 				INSERT INTO `" . TABLE_PANEL_TRAFFIC . "` SET
   269| 				`customerid` = :customerid,
   270| 				`year` = :year,
   271| 				`month` = :month,
   272| 				`day` = :day,
   273| 				`stamp` = :stamp,
   274| 				`http` = :http,
   275| 				`ftp_up` = :ftp_up,
   276| 				`ftp_down` = :ftp_down,
   277| 				`mail` = :mail
   278| 			");
   279| 			Database::pexecute($ins_stmt, $ins_data);
   280| 			$sum_month_traffic_stmt = Database::prepare("
   281| 				SELECT SUM(`http`) AS `http`, SUM(`ftp_up`) AS `ftp_up`, SUM(`ftp_down`) AS `ftp_down`, SUM(`mail`) AS `mail`
   282| 				FROM `" . TABLE_PANEL_TRAFFIC . "` WHERE `year` = :year AND `month` = :month AND `customerid` = :customerid
   283| 			");
   284| 			$sum_month_traffic = Database::pexecute_first($sum_month_traffic_stmt, array(
   285| 				'year' => $current_year,
   286| 				'month' => $current_month,
   287| 				'customerid' => $row['customerid']
   288| 			));
   289| 			$sum_month_traffic['all'] = $sum_month_traffic['http'] + $sum_month_traffic['ftp_up'] + $sum_month_traffic['ftp_down'] + $sum_month_traffic['mail'];
   290| 			if (! isset($admin_traffic[$row['adminid']]) || ! is_array($admin_traffic[$row['adminid']])) {
   291| 				$admin_traffic[$row['adminid']]['http'] = 0;
   292| 				$admin_traffic[$row['adminid']]['ftp_up'] = 0;
   293| 				$admin_traffic[$row['adminid']]['ftp_down'] = 0;
   294| 				$admin_traffic[$row['adminid']]['mail'] = 0;
   295| 				$admin_traffic[$row['adminid']]['all'] = 0;
   296| 				$admin_traffic[$row['adminid']]['sum_month'] = 0;
   297| 			}
   298| 			$admin_traffic[$row['adminid']]['http'] += $current_traffic['http'];
   299| 			$admin_traffic[$row['adminid']]['ftp_up'] += $current_traffic['ftp_up'];
   300| 			$admin_traffic[$row['adminid']]['ftp_down'] += $current_traffic['ftp_down'];
   301| 			$admin_traffic[$row['adminid']]['mail'] += $current_traffic['mail'];
   302| 			$admin_traffic[$row['adminid']]['all'] += $current_traffic['all'];
   303| 			$admin_traffic[$row['adminid']]['sum_month'] += $sum_month_traffic['all'];
   304| 			/**
   305| 			 * WebSpace-Usage
   306| 			 */

# --- HUNK 3: Lines 334-377 ---
   334| 				$emailusage = floatval($emailusage['0']);
   335| 				unset($back);
   336| 			} else {
   337| 				\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_WARNING, 'maildir ' . $maildir . ' does not exist');
   338| 			}
   339| 			/**
   340| 			 * MySQLSpace-Usage
   341| 			 */
   342| 			\Froxlor\FroxlorLogger::getInstanceOf()->logAction(\Froxlor\FroxlorLogger::CRON_ACTION, LOG_INFO, 'calculating mysqlspace usage for ' . $row['loginname']);
   343| 			$mysqlusage = 0;
   344| 			if (isset($mysqlusage_all[$row['customerid']])) {
   345| 				$mysqlusage = floatval($mysqlusage_all[$row['customerid']] / 1024);
   346| 			}
   347| 			$current_diskspace = array();
   348| 			$current_diskspace['webspace'] = floatval($webspaceusage);
   349| 			$current_diskspace['mail'] = floatval($emailusage);
   350| 			$current_diskspace['mysql'] = floatval($mysqlusage);
   351| 			$current_diskspace['all'] = $current_diskspace['webspace'] + $current_diskspace['mail'] + $current_diskspace['mysql'];
   352| 			$ins_data = array(
   353| 				'customerid' => $row['customerid'],
   354| 				'year' => $current_year,
   355| 				'month' => $current_month,
   356| 				'day' => $current_day,
   357| 				'stamp' => $current_stamp,
   358| 				'webspace' => $current_diskspace['webspace'],
   359| 				'mail' => $current_diskspace['mail'],
   360| 				'mysql' => $current_diskspace['mysql']
   361| 			);
   362| 			$ins_stmt = Database::prepare("
   363| 				INSERT INTO `" . TABLE_PANEL_DISKSPACE . "` SET
   364| 				`customerid` = :customerid,
   365| 				`year` = :year,
   366| 				`month` = :month,
   367| 				`day` = :day,
   368| 				`stamp` = :stamp,
   369| 				`webspace` = :webspace,
   370| 				`mail` = :mail,
   371| 				`mysql` = :mysql
   372| 			");
   373| 			Database::pexecute($ins_stmt, $ins_data);
   374| 			if (! isset($admin_diskspace[$row['adminid']]) || ! is_array($admin_diskspace[$row['adminid']])) {
   375| 				$admin_diskspace[$row['adminid']] = array();
   376| 				$admin_diskspace[$row['adminid']]['webspace'] = 0;
   377| 				$admin_diskspace[$row['adminid']]['mail'] = 0;

# --- HUNK 4: Lines 429-472 ---
   429| 					$group = $row['guid'];
   430| 				}
   431| 				while ($row_quota = $result_quota_stmt->fetch(\PDO::FETCH_ASSOC)) {
   432| 					$quotafile = "" . $row_quota['homedir'] . ".ftpquota";
   433| 					$fh = fopen($quotafile, 'w');
   434| 					$stringdata = "0 " . $current_diskspace['all'] * 1024 . "";
   435| 					fwrite($fh, $stringdata);
   436| 					fclose($fh);
   437| 					\Froxlor\FileDir::safe_exec('chown ' . $user . ':' . $group . ' ' . escapeshellarg($quotafile) . '');
   438| 				}
   439| 			}
   440| 		}
   441| 		/**
   442| 		 * Admin Usage
   443| 		 */
   444| 		$result_stmt = Database::query("SELECT `adminid` FROM `" . TABLE_PANEL_ADMINS . "` ORDER BY `adminid` ASC");
   445| 		while ($row = $result_stmt->fetch(\PDO::FETCH_ASSOC)) {
   446| 			if (isset($admin_traffic[$row['adminid']])) {
   447| 				$ins_data = array(
   448| 					'adminid' => $row['adminid'],
   449| 					'year' => $current_year,
   450| 					'month' => $current_month,
   451| 					'day' => $current_day,
   452| 					'stamp' => $current_stamp,
   453| 					'http' => $admin_traffic[$row['adminid']]['http'],
   454| 					'ftp_up' => $admin_traffic[$row['adminid']]['ftp_up'],
   455| 					'ftp_down' => $admin_traffic[$row['adminid']]['ftp_down'],
   456| 					'mail' => $admin_traffic[$row['adminid']]['mail']
   457| 				);
   458| 				$ins_stmt = Database::prepare("
   459| 					INSERT INTO `" . TABLE_PANEL_TRAFFIC_ADMINS . "` SET
   460| 					`adminid` = :adminid,
   461| 					`year` = :year,
   462| 					`month` = :month,
   463| 					`day` = :day,
   464| 					`stamp` = :stamp,
   465| 					`http` = :http,
   466| 					`ftp_up` = :ftp_up,
   467| 					`ftp_down` = :ftp_down,
   468| 					`mail` = :mail
   469| 				");
   470| 				Database::pexecute($ins_stmt, $ins_data);
   471| 				$upd_data = array(
   472| 					'traffic' => $admin_traffic[$row['adminid']]['sum_month'],

# --- HUNK 5: Lines 576-642 ---
   576| 		fwrite($awstats_index_file, $header);
   577| 		while (($line = fgets($awstats_index_tpl, 4096)) !== false) {
   578| 			if (! preg_match('/^#/', $line) && trim($line) != '') {
   579| 				fwrite($awstats_index_file, preg_replace($regex, $replace, $line));
   580| 			}
   581| 		}
   582| 		fclose($awstats_index_file);
   583| 		fclose($awstats_index_tpl);
   584| 		$awstats_nav_file = fopen(\Froxlor\FileDir::makeCorrectFile($outputdir . '/' . 'nav.html'), 'w');
   585| 		$awstats_nav_tpl = fopen($nav_file, 'r');
   586| 		fwrite($awstats_nav_file, $header);
   587| 		while (($line = fgets($awstats_nav_tpl, 4096)) !== false) {
   588| 			if (! preg_match('/^#/', $line) && trim($line) != '') {
   589| 				fwrite($awstats_nav_file, preg_replace($regex, $replace, $line));
   590| 			}
   591| 		}
   592| 		fclose($awstats_nav_file);
   593| 		fclose($awstats_nav_tpl);
   594| 		return;
   595| 	}
   596| 	private static function callAwstatsGetTraffic($customerid, $outputdir, $usersdomainlist, $current_stamp)
   597| 	{
   598| 		$returnval = 0;
   599| 		foreach ($usersdomainlist as $singledomain) {
   600| 			$returnval += self::awstatsDoSingleDomain($singledomain, $outputdir);
   601| 		}
   602| 		/**
   603| 		 * as of #124, awstats traffic is saved in bytes instead
   604| 		 * of kilobytes (like webalizer does)
   605| 		 */
   606| 		$returnval = floatval($returnval / 1024);
   607| 		/**
   608| 		 * now, because this traffic is being saved daily, we have to
   609| 		 * subtract the values from all the month's values to return
   610| 		 * a sane value for our panel_traffic and to remain the whole stats
   611| 		 * (awstats overwrites the customers .html stats-files)
   612| 		 */
   613| 		if ($customerid !== false) {
   614| 			$result_stmt = Database::prepare("
   615| 				SELECT SUM(`http`) as `trafficmonth` FROM `" . TABLE_PANEL_TRAFFIC . "`
   616| 				WHERE `customerid` = :customerid
   617| 				AND `year` = :year AND `month` = :month
   618| 			");
   619| 			$result_data = array(
   620| 				'customerid' => $customerid,
   621| 				'year' => date('Y', $current_stamp),
   622| 				'month' => date('m', $current_stamp)
   623| 			);
   624| 			$result = Database::pexecute_first($result_stmt, $result_data);
   625| 			if (is_array($result) && isset($result['trafficmonth'])) {
   626| 				$returnval = ($returnval - floatval($result['trafficmonth']));
   627| 			}
   628| 		}
   629| 		return floatval($returnval);
   630| 	}
   631| 	/**
   632| 	 * Function which make webalizer statistics and returns used traffic since last run
   633| 	 *
   634| 	 * @param
   635| 	 *        	string Name of logfile
   636| 	 * @param
   637| 	 *        	string Place where stats should be build
   638| 	 * @param
   639| 	 *        	string Caption for webalizer output
   640| 	 * @return int Used traffic
   641| 	 * @author Florian Lippert <flo@syscp.org>
   642| 	 */


# ====================================================================
# FILE: lib/Froxlor/Froxlor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| <?php
     2| namespace Froxlor;
     3| use Froxlor\Database\Database;
     4| final class Froxlor
     5| {
     6| 	const VERSION = '0.10.23';
     7| 	const DBVERSION = '202009070';
     8| 	const BRANDING = '';
     9| 	/**
    10| 	 * return path to where froxlor is installed, e.g.
    11| 	 * /var/www/froxlor/
    12| 	 *
    13| 	 * @return string
    14| 	 */
    15| 	public static function getInstallDir()
    16| 	{
    17| 		return dirname(dirname(__DIR__)) . '/';
    18| 	}
    19| 	/**
    20| 	 * return basic version
    21| 	 *
    22| 	 * @return string
    23| 	 */
    24| 	public static function getVersion()
    25| 	{
    26| 		return self::VERSION;


# ====================================================================
# FILE: lib/Froxlor/PhpHelper.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 83-123 ---
    83| 				if ((! is_array($fields) || empty($fields)) || (is_array($fields) && ! empty($fields) && in_array($field, $fields))) {
    84| 					$subject[$field] = str_replace($search, $replace, $subject[$field]);
    85| 				}
    86| 			}
    87| 		} else {
    88| 			$subject = str_replace($search, $replace, $subject);
    89| 		}
    90| 		return $subject;
    91| 	}
    92| 	/**
    93| 	 * froxlor php error handler
    94| 	 *
    95| 	 * @param int $errno
    96| 	 * @param string $errstr
    97| 	 * @param string $errfile
    98| 	 * @param int $errline
    99| 	 * @param array $errcontext
   100| 	 *
   101| 	 * @return void|boolean
   102| 	 */
   103| 	public static function phpErrHandler($errno, $errstr, $errfile, $errline, $errcontext = array())
   104| 	{
   105| 		if (! (error_reporting() & $errno)) {
   106| 			return;
   107| 		}
   108| 		if (! isset($_SERVER['SHELL']) || (isset($_SERVER['SHELL']) && $_SERVER['SHELL'] == '')) {
   109| 			global $theme;
   110| 			if (empty($theme)) {
   111| 				$theme = "Sparkle";
   112| 			}
   113| 			$errfile = str_replace(\Froxlor\Froxlor::getInstallDir(), "", $errfile);
   114| 			$err_hint = file_get_contents(\Froxlor\Froxlor::getInstallDir() . '/templates/' . $theme . '/misc/phperrornice.tpl');
   115| 			$err_hint = str_replace("<TEXT>", '#' . $errno . ' ' . $errstr, $err_hint);
   116| 			$err_hint = str_replace("<DEBUG>", $errfile . ':' . $errline, $err_hint);
   117| 			echo $err_hint;
   118| 			return true;
   119| 		}
   120| 		return false;
   121| 	}
   122| 	public static function loadConfigArrayDir()
   123| 	{

# --- HUNK 2: Lines 321-350 ---
   321| 	public static function arrayTrim($source)
   322| 	{
   323| 		$returnval = array();
   324| 		if (is_array($source)) {
   325| 			$source = array_map('trim', $source);
   326| 			$returnval = array_filter($source, function ($value) {
   327| 				return $value !== '';
   328| 			});
   329| 		} else {
   330| 			$returnval = $source;
   331| 		}
   332| 		return $returnval;
   333| 	}
   334| 	/**
   335| 	 * function to check a super-global passed by reference
   336| 	 * so it gets automatically updated
   337| 	 *
   338| 	 * @param array $global
   339| 	 * @param \voku\helper\AntiXSS $antiXss
   340| 	 */
   341| 	public static function cleanGlobal(&$global, &$antiXss)
   342| 	{
   343| 		if (isset($global) && ! empty($global)) {
   344| 			$tmp = $global;
   345| 			foreach ($tmp as $index => $value) {
   346| 				$global[$index] = $antiXss->xss_clean($value);
   347| 			}
   348| 		}
   349| 	}
   350| }


# ====================================================================
# FILE: lib/Froxlor/System/Mailer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-44 ---
    10| 	 *        	whether to throw exceptions or not
    11| 	 *        	
    12| 	 */
    13| 	public function __construct($exceptions = false)
    14| 	{
    15| 		parent::__construct($exceptions);
    16| 		$this->CharSet = "UTF-8";
    17| 		if (Settings::Get('system.mail_use_smtp')) {
    18| 			$this->isSMTP();
    19| 			$this->Host = Settings::Get('system.mail_smtp_host');
    20| 			$this->SMTPAuth = Settings::Get('system.mail_smtp_auth') == '1' ? true : false;
    21| 			$this->Username = Settings::Get('system.mail_smtp_user');
    22| 			$this->Password = Settings::Get('system.mail_smtp_passwd');
    23| 			if (Settings::Get('system.mail_smtp_usetls')) {
    24| 				$this->SMTPSecure = 'tls';
    25| 			} else {
    26| 				$this->SMTPAutoTLS = false;
    27| 			}
    28| 			$this->Port = Settings::Get('system.mail_smtp_port');
    29| 		}
    30| 		/**
    31| 		 * use froxlor's email-validation
    32| 		 */
    33| 		self::$validator = [
    34| 			'\Froxlor\\Validate\\Validate',
    35| 			'validateEmail'
    36| 		];
    37| 		if (self::ValidateAddress(Settings::Get('panel.adminmail')) !== false) {
    38| 			$this->SetFrom(Settings::Get('panel.adminmail'), Settings::Get('panel.adminmail_defname'));
    39| 			if (Settings::Get('panel.adminmail_return') != '') {
    40| 				$this->AddReplyTo(Settings::Get('panel.adminmail_return'), Settings::Get('panel.adminmail_defname'));
    41| 			}
    42| 		}
    43| 	}
    44| }


# ====================================================================
# FILE: lib/Froxlor/Validate/Form/Data.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 9-49 ---
     9| 			unset($fielddata['string_delimiter']);
    10| 			$returnvalue = true;
    11| 			foreach ($newfieldvalues as $single_newfieldvalue) {
    12| 				/**
    13| 				 * don't use tabs in value-fields, #81
    14| 				 */
    15| 				$single_newfieldvalue = str_replace("\t", " ", $single_newfieldvalue);
    16| 				$single_returnvalue = self::validateFormFieldString($fieldname, $fielddata, $single_newfieldvalue);
    17| 				if ($single_returnvalue !== true) {
    18| 					$returnvalue = $single_returnvalue;
    19| 					break;
    20| 				}
    21| 			}
    22| 		} else {
    23| 			$returnvalue = false;
    24| 			/**
    25| 			 * don't use tabs in value-fields, #81
    26| 			 */
    27| 			$newfieldvalue = str_replace("\t", " ", $newfieldvalue);
    28| 			if (isset($fielddata['string_type']) && $fielddata['string_type'] == 'mail') {
    29| 				$returnvalue = \Froxlor\Validate\Validate::validateEmail($newfieldvalue);
    30| 			} elseif (isset($fielddata['string_type']) && $fielddata['string_type'] == 'url') {
    31| 				$returnvalue = \Froxlor\Validate\Validate::validateUrl($newfieldvalue);
    32| 			} elseif (isset($fielddata['string_type']) && $fielddata['string_type'] == 'dir') {
    33| 				if (trim($newfieldvalue) == '') {
    34| 					$newfieldvalue = '';
    35| 					$returnvalue = 'stringmustntbeempty';
    36| 				} else {
    37| 					if (substr($newfieldvalue, - 1) != '/') {
    38| 						$newfieldvalue .= '/';
    39| 					}
    40| 					$returnvalue = ($newfieldvalue == \Froxlor\FileDir::makeCorrectDir($newfieldvalue));
    41| 				}
    42| 			} elseif (isset($fielddata['string_type']) && $fielddata['string_type'] == 'confdir') {
    43| 				if (trim($newfieldvalue) == '') {
    44| 					$newfieldvalue = '';
    45| 					$returnvalue = 'stringmustntbeempty';
    46| 				} else {
    47| 					if (substr($newfieldvalue, - 1) != '/') {
    48| 						$newfieldvalue .= '/';
    49| 					}

# --- HUNK 2: Lines 149-189 ---
   149| 			unset($fielddata['string_delimiter']);
   150| 			$returnvalue = true;
   151| 			foreach ($newfieldvalues as $single_newfieldvalue) {
   152| 				/**
   153| 				 * don't use tabs in value-fields, #81
   154| 				 */
   155| 				$single_newfieldvalue = str_replace("\t", " ", $single_newfieldvalue);
   156| 				$single_returnvalue = \Froxlor\Validate\Form\Data::validateFormFieldString($fieldname, $fielddata, $single_newfieldvalue);
   157| 				if ($single_returnvalue !== true) {
   158| 					$returnvalue = $single_returnvalue;
   159| 					break;
   160| 				}
   161| 			}
   162| 		} else {
   163| 			$returnvalue = false;
   164| 			/**
   165| 			 * don't use tabs in value-fields, #81
   166| 			 */
   167| 			$newfieldvalue = str_replace("\t", " ", $newfieldvalue);
   168| 			if (isset($fielddata['string_type']) && $fielddata['string_type'] == 'mail') {
   169| 				$returnvalue = \Froxlor\Validate\Validate::validateEmail($newfieldvalue);
   170| 			} elseif (isset($fielddata['string_type']) && $fielddata['string_type'] == 'url') {
   171| 				$returnvalue = \Froxlor\Validate\Validate::validateUrl($newfieldvalue);
   172| 			} elseif (isset($fielddata['string_type']) && $fielddata['string_type'] == 'dir') {
   173| 				if (substr($newfieldvalue, - 1) != '/') {
   174| 					$newfieldvalue .= '/';
   175| 				}
   176| 				$returnvalue = ($newfieldvalue == \Froxlor\FileDir::makeCorrectDir($newfieldvalue));
   177| 			} elseif (isset($fielddata['string_type']) && $fielddata['string_type'] == 'file') {
   178| 				$returnvalue = ($newfieldvalue == \Froxlor\FileDir::makeCorrectFile($newfieldvalue));
   179| 			} elseif (isset($fielddata['string_type']) && $fielddata['string_type'] == 'filedir') {
   180| 				$returnvalue = (($newfieldvalue == \Froxlor\FileDir::makeCorrectDir($newfieldvalue)) || ($newfieldvalue == \Froxlor\FileDir::makeCorrectFile($newfieldvalue)));
   181| 			} elseif (preg_match('/^[^\r\n\t\f\0]*$/D', $newfieldvalue)) {
   182| 				$returnvalue = true;
   183| 			}
   184| 			if (isset($fielddata['string_regexp']) && $fielddata['string_regexp'] != '') {
   185| 				if (preg_match($fielddata['string_regexp'], $newfieldvalue)) {
   186| 					$returnvalue = true;
   187| 				} else {
   188| 					$returnvalue = false;
   189| 				}


# ====================================================================
# FILE: lib/Froxlor/Validate/Validate.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 168-245 ---
   168| 		}
   169| 		$pattern = '%^(?:(?:https?)://)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\x{00a1}-\x{ffff}0-9]+-?)*[a-z\x{00a1}-\x{ffff}0-9]+)(?:\.(?:[a-z\x{00a1}-\x{ffff}0-9]+-?)*[a-z\x{00a1}-\x{ffff}0-9]+)*(?:\.(?:[a-z\x{00a1}-\x{ffff}]{2,})))(?::\d{2,5})?(?:/[^\s]*)?$%iuS';
   170| 		if (preg_match($pattern, $url)) {
   171| 			return true;
   172| 		}
   173| 		return false;
   174| 	}
   175| 	/**
   176| 	 * Check if the submitted string is a valid domainname
   177| 	 *
   178| 	 * @param string $domainname
   179| 	 *        	The domainname which should be checked.
   180| 	 * @param bool $allow_underscore
   181| 	 *        	optional if true, allowes the underscore character in a domain label (DKIM etc.)
   182| 	 *        	
   183| 	 * @return string|boolean the domain-name if the domain is valid, false otherwise
   184| 	 */
   185| 	public static function validateDomain($domainname, $allow_underscore = false)
   186| 	{
   187| 		if (is_string($domainname)) {
   188| 			$char_validation = '([a-z\d](-*[a-z\d])*)(\.?([a-z\d](-*[a-z\d])*))*\.(xn\-\-)?([a-z\d])+';
   189| 			if ($allow_underscore) {
   190| 				$char_validation = '([a-z\d\_](-*[a-z\d\_])*)(\.([a-z\d\_](-*[a-z\d])*))*(\.?([a-z\d](-*[a-z\d])*))+\.(xn\-\-)?([a-z\d])+';
   191| 			}
   192| 			if (preg_match("/^" . $char_validation . "$/i", $domainname) && preg_match("/^.{1,253}$/", $domainname) && preg_match("/^[^\.]{1,63}(\.[^\.]{1,63})*$/", $domainname)) {
   193| 				return $domainname;
   194| 			}
   195| 		}
   196| 		return false;
   197| 	}
   198| 	/**
   199| 	 * validate a local-hostname by regex
   200| 	 *
   201| 	 * @param string $hostname
   202| 	 *
   203| 	 * @return string|boolean hostname on success, else false
   204| 	 */
   205| 	public static function validateLocalHostname($hostname)
   206| 	{
   207| 		$pattern = '/^[a-z0-9][a-z0-9\-]{0,62}$/i';
   208| 		if (preg_match($pattern, $hostname)) {
   209| 			return $hostname;
   210| 		}
   211| 		return false;
   212| 	}
   213| 	/**
   214| 	 * Returns if an emailaddress is in correct format or not
   215| 	 *
   216| 	 * @param string $email
   217| 	 *        	The email address to check
   218| 	 * @return bool Correct or not
   219| 	 */
   220| 	public static function validateEmail($email)
   221| 	{
   222| 		$email = strtolower($email);
   223| 		if (defined('FILTER_FLAG_EMAIL_UNICODE')) {
   224| 			return filter_var($email, FILTER_VALIDATE_EMAIL, FILTER_FLAG_EMAIL_UNICODE);
   225| 		}
   226| 		return filter_var($email, FILTER_VALIDATE_EMAIL);
   227| 	}
   228| 	/**
   229| 	 * Returns if an username is in correct format or not.
   230| 	 *
   231| 	 * @param string $username
   232| 	 *        	The username to check
   233| 	 * @param bool $unix_names
   234| 	 *        	optional, default true, checks whether it must be UNIX compatible
   235| 	 * @param int $mysql_max
   236| 	 *        	optional, number of max mysql username characters, default empty
   237| 	 *        	
   238| 	 * @return bool
   239| 	 */
   240| 	public static function validateUsername($username, $unix_names = 1, $mysql_max = '')
   241| 	{
   242| 		if (empty($mysql_max) || ! is_numeric($mysql_max) || $mysql_max <= 0) {
   243| 			$mysql_max = \Froxlor\Database\Database::getSqlUsernameLength() - 1;
   244| 		} else {
   245| 			$mysql_max --;


# ====================================================================
# FILE: lng/english.lng.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1714-1754 ---
  1714| $lng['admin']['notryfiles']['description'] = 'Say yes here if you want to specify a custom try_files directive in specialsettings (needed for some wordpress plugins for example).';
  1715| $lng['serversettings']['phpfpm_settings']['override_fpmconfig'] = 'Override FPM-daemon settings (pm, max_children, etc.)';
  1716| $lng['serversettings']['phpfpm_settings']['override_fpmconfig_addinfo'] = '<br /><span class="red">Only used if "Override FPM-daemon settings" is set to "Yes"</span>';
  1717| $lng['panel']['backuppath']['title'] = 'Destination path for the backup';
  1718| $lng['panel']['backuppath']['description'] = 'This is the path where the backups will be stored. If backup of web-data is selected, all files from the homedir are stored excluding the backup-folder specified here.';
  1719| $lng['panel']['none_value'] = 'None';
  1720| $lng['menue']['main']['apihelp'] = 'API help';
  1721| $lng['menue']['main']['apikeys'] = 'API keys';
  1722| $lng['apikeys']['no_api_keys'] = 'No API keys found';
  1723| $lng['apikeys']['key_add'] = 'Add new key';
  1724| $lng['apikeys']['apikey_removed'] = 'The api key with the id #%s has been removed successfully';
  1725| $lng['apikeys']['apikey_added'] = 'A new api key has been generated successfully';
  1726| $lng['apikeys']['clicktoview'] = 'Click to view';
  1727| $lng['apikeys']['allowed_from'] = 'Allowed from';
  1728| $lng['apikeys']['allowed_from_help'] = 'Comma separated list of ip addresses. Default empty.<br>Specifying a subnet e.g. 192.168.1.1/24 is currently not supported.';
  1729| $lng['apikeys']['valid_until'] = 'Valid until';
  1730| $lng['apikeys']['valid_until_help'] = 'Date until valid, format YYYY-MM-DD';
  1731| $lng['serversettings']['enable_api']['title'] = 'Enable external API usage';
  1732| $lng['serversettings']['enable_api']['description'] = 'In order to use the froxlor API you need to activate this option. For more detailed information see <a href="https://api.froxlor.org/" target="_new">https://api.froxlor.org/</a>';
  1733| $lng['serversettings']['dhparams_file']['title'] = 'DHParams file (DiffieHellman key exchange)';
  1734| $lng['serversettings']['dhparams_file']['description'] = 'If a dhparams.pem file is specified here it will be included in the webserver configuration. Leave empty to disable.<br>Example: /etc/ssl/webserver/dhparams.pem<br><br>If the file does not exist, it will be created automatically with the following command: <em>openssl dhparam -out /etc/ssl/webserver/dhparams.pem 4096<em>. It is recommended to create the file prior to specifying it here as the creation takes quite a while and blocks the cronjob.';
  1735| $lng['2fa']['2fa'] = '2FA options';
  1736| $lng['2fa']['2fa_enabled'] = 'Activate Two-factor authentication (2FA)';
  1737| $lng['login']['2fa'] = 'Two-factor authentication (2FA)';
  1738| $lng['login']['2facode'] = 'Please enter 2FA code';
  1739| $lng['2fa']['2fa_removed'] = '2FA removed successfully';
  1740| $lng['2fa']['2fa_added'] = '2FA activated successfully<br><a href="%s?s=%s&page=2fa">View 2FA details</a>';
  1741| $lng['2fa']['2fa_add'] = 'Activate 2FA';
  1742| $lng['2fa']['2fa_delete'] = 'Deactivate 2FA';
  1743| $lng['2fa']['2fa_verify'] = 'Verify code';
  1744| $lng['mails']['2fa']['mailbody'] = 'Hello,\n\nyour 2FA login-code is: {CODE}.\n\nThis is an automatically created\ne-mail, please do not answer!\n\nYours sincerely, your administrator';
  1745| $lng['mails']['2fa']['subject'] = 'Froxlor - 2FA Code';
  1746| $lng['2fa']['2fa_overview_desc'] = 'Here you can activate a two-factor authentication for your account.<br><br>You can either use an authenticator-app (time-based one-time password / TOTP) or let froxlor send you an email to your account-address after each successful login with a one-time password.';
  1747| $lng['2fa']['2fa_email_desc'] = 'Your account is set up to use one-time passwords via e-mail. To deactivate, click on "' . $lng['2fa']['2fa_delete'] . '"';
  1748| $lng['2fa']['2fa_ga_desc'] = 'Your account is set up to use time-based one-time passwords via authenticator-app. Please scan the QR code below with your desired authenticator app to generate the codes. To deactivate, click on "' . $lng['2fa']['2fa_delete'] . '"';
  1749| $lng['admin']['logviewenabled'] = 'Enable access to access/error-logs';
  1750| $lng['panel']['viewlogs'] = 'View logfiles';
  1751| $lng['panel']['not_configured'] = 'System not configured yet. Click here to go to configurations.';
  1752| $lng['panel']['done_configuring'] = 'When you are done configuring all required / desired services,<br>click the link below';
  1753| $lng['panel']['ihave_configured'] = 'I have configured the services';
  1754| $lng['panel']['system_is_configured'] = 'System is already set as configured';


# ====================================================================
# FILE: lng/german.lng.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1379-1419 ---
  1379| $lng['question']['plan_reallydelete'] = 'Wollen Sie den Hosting-Plan "%s" wirklich lschen?';
  1380| $lng['admin']['notryfiles']['title'] = 'Keine generierte try_files Anweisung';
  1381| $lng['admin']['notryfiles']['description'] = 'Whlen Sie "Ja", wenn eine eigene try_files Direktive in den "eigenen Vhost Einstellungen" angegeben werden soll (z.B. ntig fr manche Wordpress Plugins).';
  1382| $lng['serversettings']['phpfpm_settings']['override_fpmconfig'] = 'berschreibe FPM-Daemon Einstellungen (pm, max_children, etc.)';
  1383| $lng['serversettings']['phpfpm_settings']['override_fpmconfig_addinfo'] = '<br /><span class="red">Nur verwendet wenn "berschreibe FPM-Daemon Einstellungen" auf "Ja" gestellt ist</span>';
  1384| $lng['panel']['backuppath']['title'] = 'Pfad zur Ablage der Backups';
  1385| $lng['panel']['backuppath']['description'] = 'In diesem Ordner werden die Backups abgelegt. Wenn das Sichern von Web-Daten aktiviert ist, werden alle Dateien aus dem Heimatverzeichnis gesichert, exklusive des hier angegebenen Backup-Ordners.';
  1386| $lng['panel']['none_value'] = 'Keine';
  1387| $lng['menue']['main']['apihelp'] = 'API Hilfe';
  1388| $lng['menue']['main']['apikeys'] = 'API Keys';
  1389| $lng['apikeys']['no_api_keys'] = 'Keine API Keys gefunden';
  1390| $lng['apikeys']['key_add'] = 'API Key hinzufgen';
  1391| $lng['apikeys']['apikey_removed'] = 'Der API Key mit der ID #%s wurde erfolgreich gelscht.';
  1392| $lng['apikeys']['allowed_from'] = 'Erlaube Zugriff von';
  1393| $lng['apikeys']['allowed_from_help'] = 'Komma getrennte Liste von IPs. Standard ist leer.<br>Angabe von Subnetzen z.B. 192.168.1.1/24 wird derzeit nicht untersttzt.';
  1394| $lng['apikeys']['valid_until'] = 'Gltig bis';
  1395| $lng['apikeys']['valid_until_help'] = 'Datum Gltigkeitsende, Format JJJJ-MM-TT';
  1396| $lng['serversettings']['enable_api']['title'] = 'Aktiviere externe API Nutzung';
  1397| $lng['serversettings']['enable_api']['description'] = 'Um die froxlor API nutzen zu knnen, muss diese Option aktiviert sein. Fr detaillierte Informationen siehe <a href="https://api.froxlor.org/" target="_new">https://api.froxlor.org/</a>';
  1398| $lng['serversettings']['dhparams_file']['title'] = 'DHParams Datei (DiffieHellman key exchange)';
  1399| $lng['serversettings']['dhparams_file']['description'] = 'Wird eine dhparams.pem Datei hier angegeben, wir sie in die Webserver Konfiguration mit eingefgt.<br>Beispiel: /etc/ssl/webserver/dhparams.pem<br><br>Existiert die Datei nicht, wird sie wie folgt erstellt: <em>openssl dhparam -out /etc/ssl/webserver/dhparams.pem 4096<em>. Es wird empfohlen die Datei zu erstellen, bevor sie hier angegeben wird, da die Erstellung lngere Zeit in Anspruch nimmt und den Cronjob blockiert.';
  1400| $lng['2fa']['2fa'] = '2FA Optionen';
  1401| $lng['2fa']['2fa_enabled'] = 'Aktiviere Zwei-Faktor Authentifizierung (2FA)';
  1402| $lng['login']['2fa'] = 'Zwei-Faktor Authentifizierung (2FA)';
  1403| $lng['login']['2facode'] = 'Bitte 2FA Code angeben';
  1404| $lng['2fa']['2fa_removed'] = '2FA erfolgreich gelscht';
  1405| $lng['2fa']['2fa_added'] = '2FA erfolgreich aktiviert<br><a href="%s?s=%s&page=2fa">2FA Details ffnen</a>';
  1406| $lng['2fa']['2fa_add'] = '2FA aktivieren';
  1407| $lng['2fa']['2fa_delete'] = '2FA deaktivieren';
  1408| $lng['2fa']['2fa_verify'] = 'Code verifizieren';
  1409| $lng['mails']['2fa']['mailbody'] = 'Hallo,\n\nihr 2FA-Login Code lautet: {CODE}\n\nDies ist eine automatisch generierte\neMail, bitte antworten Sie nicht auf\ndiese Mitteilung.\n\nIhr Administrator';
  1410| $lng['mails']['2fa']['subject'] = 'Froxlor - 2FA Code';
  1411| $lng['2fa']['2fa_overview_desc'] = 'Hier kann fr das Konto eine Zwei-Faktor-Authentisierung aktiviert werden.<br><br>Es kann entweder eine Authenticator-App (time-based one-time password / TOTP) genutzt werden oder ein Einmalpasswort, welches nach erfolgreichem Login an die hinterlegte E-Mail Adresse gesendet wird.';
  1412| $lng['2fa']['2fa_email_desc'] = 'Das Konto ist eingerichtet, um Einmalpasswrter per E-Mail zu erhalten. Zum Deaktivieren, klicke auf "' . $lng['2fa']['2fa_delete'] . '"';
  1413| $lng['2fa']['2fa_ga_desc'] = 'Das Konto ist eingerichtet, um zeitbasierte Einmalpasswrter via Authenticator-App zu erhalten. Um die gewnschte Authenticator-App einzurichten, scanne bitte den untenstehenden QR-Code. Zum Deaktivieren, klicke auf "' . $lng['2fa']['2fa_delete'] . '"';
  1414| $lng['admin']['logviewenabled'] = 'Zugriff auf access/error-Logdateien';
  1415| $lng['panel']['viewlogs'] = 'Logdateien einsehen';
  1416| $lng['panel']['not_configured'] = 'Das System wurde noch nicht konfiguriert. Hier klicken fr Konfiguration.';
  1417| $lng['panel']['done_configuring'] = 'Nach Abschluss der Konfiguration der Dienste,<br>untenstehenden Link klicken';
  1418| $lng['panel']['ihave_configured'] = 'Ich habe die Dienste konfiguriert';
  1419| $lng['panel']['system_is_configured'] = 'Das System ist bereits konfiguriert';

