# ====================================================================
# FILE: build/makepack-dolibarr.pl
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 346-389 ---
   346| 			$ret=`cp -pr "$SOURCE" "$BUILDROOT/$PROJECT"`;
   347| 		}
   348| 		print "Clean $BUILDROOT\n";
   349| 		$ret=`rm -f  $BUILDROOT/$PROJECT/.buildpath`;
   350| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.cache`;
   351| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.editorconfig`;
   352| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.externalToolBuilders`;
   353| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.git*`;
   354| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.project`;
   355| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.settings`;
   356| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.scrutinizer.yml`;
   357| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.travis.yml`;
   358| 		$ret=`rm -fr $BUILDROOT/$PROJECT/.tx`;
   359| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build.xml`;
   360| 		$ret=`rm -f  $BUILDROOT/$PROJECT/pom.xml`;
   361| 		$ret=`rm -fr $BUILDROOT/$PROJECT/build/html`;
   362| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/Doli*-*`;
   363| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr_*.deb`;
   364| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr_*.dsc`;
   365| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr_*.tar.gz`;
   366| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.deb`;
   367| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.rpm`;
   368| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.tar`;
   369| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.tar.gz`;
   370| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.tgz`;
   371| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.xz`;
   372| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.zip`;
   373| 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/doxygen/doxygen_warnings.log`;
   374| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/cache.manifest`;
   375| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php`;
   376| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php.mysql`;
   377| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php.old`;
   378| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php.postgres`;
   379| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf*sav*`;
   380| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/install/mssql/README`;
   381| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/install/mysql/README`;
   382| 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/install/pgsql/README`;
   383| 		$ret=`rm -fr  $BUILDROOT/$PROJECT/htdocs/install/mssql`;
   384| 		$ret=`rm -fr $BUILDROOT/$PROJECT/dev/ansible`;
   385| 		$ret=`rm -fr $BUILDROOT/$PROJECT/dev/codesniffer`;
   386| 		$ret=`rm -fr $BUILDROOT/$PROJECT/dev/codetemplates`;
   387| 		$ret=`rm -fr $BUILDROOT/$PROJECT/dev/dbmodel`;
   388| 		$ret=`rm -fr $BUILDROOT/$PROJECT/dev/initdata`;
   389| 		$ret=`rm -fr $BUILDROOT/$PROJECT/dev/initdemo`;

# --- HUNK 2: Lines 656-695 ---
   656| 		}
   657| 		if ($target eq 'DEB') 
   658| 		{
   659| 			$NEWDESTI=$DESTI;
   660| 			if ($NEWDESTI =~ /stable/)
   661| 			{
   662| 				mkdir($DESTI.'/package_debian-ubuntu');
   663| 				if (-d $DESTI.'/package_debian-ubuntu') { $NEWDESTI=$DESTI.'/package_debian-ubuntu'; }
   664| 			} 
   665| 			$olddir=getcwd();
   666| 			print "Remove target ${FILENAMEDEB}_all.deb...\n";
   667| 			unlink("$NEWDESTI/${FILENAMEDEB}_all.deb");
   668| 			print "Remove target ${FILENAMEDEB}.dsc...\n";
   669| 			unlink("$NEWDESTI/${FILENAMEDEB}.dsc");
   670| 			print "Remove target ${FILENAMEDEB}.tar.gz...\n";
   671| 			unlink("$NEWDESTI/${FILENAMEDEB}.tar.gz");
   672| 			print "Remove target ${FILENAMEDEB}.changes...\n";
   673| 			unlink("$NEWDESTI/${FILENAMEDEB}.changes");
   674| 			print "Remove target ${FILENAMEDEB}.debian.tar.gz...\n";
   675| 			unlink("$NEWDESTI/${FILENAMEDEB}.debian.tar.gz");
   676| 			print "Remove target ${FILENAMEDEBNATIVE}.orig.tar.gz...\n";
   677| 			unlink("$NEWDESTI/${FILENAMEDEBNATIVE}.orig.tar.gz");
   678| 			$ret=`rm -fr $BUILDROOT/$PROJECT.tmp`;
   679| 			$ret=`rm -fr $BUILDROOT/$PROJECT-$MAJOR.$MINOR.$build`;
   680| 			print "Copy $BUILDROOT/$PROJECT to $BUILDROOT/$PROJECT.tmp\n";
   681| 			$cmd="cp -pr \"$BUILDROOT/$PROJECT\" \"$BUILDROOT/$PROJECT.tmp\"";
   682| 			$ret=`$cmd`;
   683| 			$cmd="cp -pr \"$BUILDROOT/$PROJECT/build/debian/apache/.htaccess\" \"$BUILDROOT/$PROJECT.tmp/build/debian/apache/.htaccess\"";
   684| 			$ret=`$cmd`;
   685| 			print "Remove other files\n";
   686| 			$ret=`rm -f  $BUILDROOT/$PROJECT.tmp/README-FR.md`;
   687| 			$ret=`rm -f  $BUILDROOT/$PROJECT.tmp/build/README`;
   688| 			$ret=`rm -f  $BUILDROOT/$PROJECT.tmp/build/README-FR`;
   689| 			$ret=`rm -fr $BUILDROOT/$PROJECT.tmp/build/aps`;
   690| 			$ret=`rm -fr $BUILDROOT/$PROJECT.tmp/build/dmg`;
   691| 			$ret=`rm -f  $BUILDROOT/$PROJECT.tmp/build/pad/README`;
   692| 			$ret=`rm -f  $BUILDROOT/$PROJECT.tmp/build/tgz/README`;
   693| 			$ret=`rm -fr $BUILDROOT/$PROJECT.tmp/build/debian/po`;
   694| 			$ret=`rm -fr $BUILDROOT/$PROJECT.tmp/build/debian/source`;
   695| 			$ret=`rm -f  $BUILDROOT/$PROJECT.tmp/build/debian/changelog`;

# --- HUNK 3: Lines 797-837 ---
   797| 			$ret=`$cmd`;
   798| 			print "Go into directory $BUILDROOT\n";
   799| 			chdir("$BUILDROOT");
   800| 			print "Compress $BUILDROOT/$PROJECT-$MAJOR.$MINOR.$build into $BUILDROOT/$FILENAMEDEBNATIVE.orig.tar.gz...\n";
   801| 			$cmd="tar --exclude-vcs --exclude-from \"$BUILDROOT/$PROJECT/build/tgz/tar_exclude.txt\" --directory \"$BUILDROOT\" --mode=go-w --group=500 --owner=500 -czvf \"$BUILDROOT/$FILENAMEDEBNATIVE.orig.tar.gz\" $PROJECT-$MAJOR.$MINOR.$build";
   802| 			print $cmd."\n";
   803| 			$ret=`$cmd`;
   804| 			print "Go into directory $BUILDROOT/$PROJECT-$MAJOR.$MINOR.$build\n";
   805| 			chdir("$BUILDROOT/$PROJECT-$MAJOR.$MINOR.$build");
   806| 			$cmd="dpkg-buildpackage -us -uc";
   807| 			print "Launch DEB build ($cmd)\n";
   808| 			$ret=`$cmd 2>&1 3>&1`;
   809| 			print $ret."\n";
   810| 			chdir("$olddir");
   811| 			print "You can check bin package with lintian --pedantic -E -I \"$NEWDESTI/${FILENAMEDEB}_all.deb\"\n";
   812| 			print "You can check src package with lintian --pedantic -E -I \"$NEWDESTI/${FILENAMEDEB}.dsc\"\n";
   813| 			print "Move *_all.deb *.dsc *.orig.tar.gz *.changes to $NEWDESTI\n";
   814| 			$ret=`mv $BUILDROOT/*_all.deb "$NEWDESTI/"`;
   815| 			$ret=`mv $BUILDROOT/*.dsc "$NEWDESTI/"`;
   816| 			$ret=`mv $BUILDROOT/*.orig.tar.gz "$NEWDESTI/"`;
   817| 			$ret=`mv $BUILDROOT/*.debian.tar.gz "$NEWDESTI/"`;
   818| 			$ret=`mv $BUILDROOT/*.changes "$NEWDESTI/"`;
   819| 			next;
   820| 		}
   821| 		if ($target eq 'APS') 
   822| 		{
   823| 			$NEWDESTI=$DESTI;
   824| 			if ($NEWDESTI =~ /stable/)
   825| 			{
   826| 				mkdir($DESTI.'/package_aps');
   827| 				if (-d $DESTI.'/package_aps') { $NEWDESTI=$DESTI.'/package_aps'; }
   828| 			} 
   829| 			$newbuild = $BUILD;
   830| 			$newbuild =~ s/(dev|alpha)/0/gi;                # dev
   831| 			$newbuild =~ s/beta/1/gi;                       # beta
   832| 			$newbuild =~ s/rc./2/gi;                        # rc
   833| 			if ($newbuild !~ /-/) { $newbuild.='-3'; }      # finale
   834| 			$REL1 = $newbuild; $REL1 =~ s/-.*$//gi;
   835| 			if ($RPMSUBVERSION eq 'auto') { $RPMSUBVERSION = $newbuild; $RPMSUBVERSION =~ s/^.*-//gi; }
   836| 			print "Version is $MAJOR.$MINOR.$REL1-$RPMSUBVERSION\n";
   837| 			print "Remove target $FILENAMEAPS.zip...\n";

# --- HUNK 4: Lines 911-965 ---
   911| 			print "Move \"$SOURCE\\build\\$FILENAMEEXEDOLIWAMP.exe\" to $NEWDESTI/$FILENAMEEXEDOLIWAMP.exe\n";
   912|     		rename("$SOURCE/build/$FILENAMEEXEDOLIWAMP.exe","$NEWDESTI/$FILENAMEEXEDOLIWAMP.exe");
   913|             print "Move $SOURCE/build/$FILENAMEEXEDOLIWAMP.exe to $NEWDESTI/$FILENAMEEXEDOLIWAMP.exe\n";
   914|             $ret=`mv "$SOURCE/build/$FILENAMEEXEDOLIWAMP.exe" "$NEWDESTI/$FILENAMEEXEDOLIWAMP.exe"`;
   915|             print "Remove tmp file $SOURCE/build/exe/doliwamp/doliwamp.tmp.iss\n";
   916|             $ret=`rm "$SOURCE/build/exe/doliwamp/doliwamp.tmp.iss"`;
   917|     		next;
   918|     	}
   919|     }
   920| 	foreach my $target (sort keys %CHOOSEDPUBLISH) 
   921| 	{
   922| 		if ($CHOOSEDPUBLISH{$target} < 0) { next; }
   923| 		print "\nList of files to publish (BUILD=$BUILD)\n";
   924| 		%filestoscansf=(
   925| 			"$DESTI/signatures/filelist-$MAJOR.$MINOR.$BUILD.xml"=>'none',				# none means it won't be published on SF
   926| 			"$DESTI/package_rpm_generic/$FILENAMERPM"=>'Dolibarr installer for Fedora-Redhat-Mandriva-Opensuse (DoliRpm)',
   927| 			"$DESTI/package_rpm_generic/$FILENAMERPMSRC"=>'none',						# none means it won't be published on SF
   928| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_all.deb"=>'Dolibarr installer for Debian-Ubuntu (DoliDeb)',
   929| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_amd64.changes"=>'none',		# none means it won't be published on SF
   930| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.dsc"=>'none',					# none means it won't be published on SF
   931| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.debian.tar.gz"=>'none',		# none means it won't be published on SF
   932| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEBSHORT}.orig.tar.gz"=>'none',		# none means it won't be published on SF
   933| 			"$DESTI/package_windows/$FILENAMEEXEDOLIWAMP.exe"=>'Dolibarr installer for Windows (DoliWamp)',
   934| 			"$DESTI/standard/$FILENAMETGZ.tgz"=>'Dolibarr ERP-CRM',
   935| 			"$DESTI/standard/$FILENAMETGZ.zip"=>'Dolibarr ERP-CRM'
   936| 		);
   937| 		%filestoscanstableasso=(
   938| 			"$DESTI/signatures/filelist-$MAJOR.$MINOR.$BUILD.xml"=>'signatures',
   939| 			"$DESTI/package_rpm_generic/$FILENAMERPM"=>'package_rpm_generic',
   940| 			"$DESTI/package_rpm_generic/$FILENAMERPMSRC"=>'package_rpm_generic',
   941| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_all.deb"=>'package_debian-ubuntu',
   942| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_amd64.changes"=>'package_debian-ubuntu',
   943| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.dsc"=>'package_debian-ubuntu',
   944| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.debian.tar.gz"=>'package_debian-ubuntu',
   945| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEBSHORT}.orig.tar.gz"=>'package_debian-ubuntu',
   946| 			"$DESTI/package_debian-ubuntu/${FILENAMEDEBSHORT}.orig.tar.gz"=>'package_debian-ubuntu',
   947| 			"$DESTI/package_windows/$FILENAMEEXEDOLIWAMP.exe"=>'package_windows',
   948| 			"$DESTI/standard/$FILENAMETGZ.tgz"=>'standard',
   949| 			"$DESTI/standard/$FILENAMETGZ.zip"=>'standard'
   950| 		);
   951| 		if ($target eq 'ASSO' && $BUILD =~ /[a-z]/i)   { 	# Not stable
   952| 			%filestoscansf=(
   953| 				"$DESTI/$FILENAMERPM"=>'Dolibarr installer for Fedora-Redhat-Mandriva-Opensuse (DoliRpm)',
   954| 				"$DESTI/${FILENAMEDEB}_all.deb"=>'Dolibarr installer for Debian-Ubuntu (DoliDeb)',
   955| 				"$DESTI/$FILENAMEEXEDOLIWAMP.exe"=>'Dolibarr installer for Windows (DoliWamp)',
   956| 				"$DESTI/$FILENAMETGZ.tgz"=>'Dolibarr ERP-CRM',
   957| 				"$DESTI/$FILENAMETGZ.zip"=>'Dolibarr ERP-CRM'
   958| 			);
   959| 			%filestoscanstableasso=(
   960| 				"$DESTI/$FILENAMERPM"=>'',
   961| 				"$DESTI/${FILENAMEDEB}_all.deb"=>'',
   962| 				"$DESTI/$FILENAMEEXEDOLIWAMP.exe"=>'',
   963| 				"$DESTI/$FILENAMETGZ.tgz"=>'',
   964| 				"$DESTI/$FILENAMETGZ.zip"=>''
   965| 			);


# ====================================================================
# FILE: htdocs/accountancy/admin/account.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 123-165 ---
   123|     	}
   124|     	$action = 'update';
   125|     	if ($result < 0) {
   126|     		setEventMessages($accounting->error, $accounting->errors, 'errors');
   127|     	}
   128|     }
   129| }
   130| /*
   131|  * View
   132|  */
   133| $form=new Form($db);
   134| llxHeader('', $langs->trans("ListAccounts"));
   135| if ($action == 'delete') {
   136| 	$formconfirm = $html->formconfirm($_SERVER["PHP_SELF"] . '?id=' . $id, $langs->trans('DeleteAccount'), $langs->trans('ConfirmDeleteAccount'), 'confirm_delete', '', 0, 1);
   137| 	print $formconfirm;
   138| }
   139| $pcgver = $conf->global->CHARTOFACCOUNTS;
   140| $sql = "SELECT aa.rowid, aa.fk_pcg_version, aa.pcg_type, aa.pcg_subtype, aa.account_number, aa.account_parent , aa.label, aa.active, ";
   141| $sql .= " a2.rowid as rowid2, a2.label as label2, a2.account_number as account_number2";
   142| $sql .= " FROM " . MAIN_DB_PREFIX . "accounting_account as aa";
   143| $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_system as asy ON aa.fk_pcg_version = asy.pcg_version";
   144| if ($db->type == 'pgsql') $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_account as a2 ON a2.rowid = CAST(aa.account_parent AS INTEGER)";
   145| else $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_account as a2 ON a2.rowid = CAST(aa.account_parent AS UNSIGNED)";
   146| $sql .= " WHERE asy.rowid = " . $pcgver;
   147| if (strlen(trim($search_account)))			$sql .= natural_search("aa.account_number", $search_account);
   148| if (strlen(trim($search_label)))			$sql .= natural_search("aa.label", $search_label);
   149| if (strlen(trim($search_accountparent)))	$sql .= natural_search("aa.account_parent", $search_accountparent);
   150| if (strlen(trim($search_pcgtype)))			$sql .= natural_search("aa.pcg_type", $search_pcgtype);
   151| if (strlen(trim($search_pcgsubtype)))		$sql .= natural_search("aa.pcg_subtype", $search_pcgsubtype);
   152| $sql .= $db->order($sortfield, $sortorder);
   153| $nbtotalofrecords = '';
   154| if (empty($conf->global->MAIN_DISABLE_FULL_SCANLIST))
   155| {
   156| 	$resql = $db->query($sql);
   157| 	$nbtotalofrecords = $db->num_rows($resql);
   158| }
   159| $sql .= $db->plimit($limit + 1, $offset);
   160| dol_syslog('accountancy/admin/account.php:: $sql=' . $sql);
   161| $resql = $db->query($sql);
   162| if ($resql)
   163| {
   164| 	$num = $db->num_rows($resql);
   165|     $param='';


# ====================================================================
# FILE: htdocs/accountancy/admin/accountmodel.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 24-117 ---
    24|  *
    25|  * You should have received a copy of the GNU General Public License
    26|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    27|  */
    28| /**
    29|  *	    \file       htdocs/accountancy/admin/accountmodel.php
    30|  *		\ingroup    Advanced accountancy
    31|  *		\brief      Page to administer model of chart of accounts
    32|  */
    33| require '../../main.inc.php';
    34| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formadmin.class.php';
    35| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';
    36| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    37| require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
    38| require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';
    39| require_once DOL_DOCUMENT_ROOT.'/core/lib/accounting.lib.php';
    40| if (! empty($conf->accounting->enabled)) require_once DOL_DOCUMENT_ROOT . '/core/class/html.formaccounting.class.php';
    41| $langs->loadLangs(array("errors","admin","companies","resource","holiday","compta","accountancy","hrm"));
    42| $action=GETPOST('action','alpha')?GETPOST('action','alpha'):'view';
    43| $confirm=GETPOST('confirm','alpha');
    44| $id=GETPOST('id','int');
    45| $rowid=GETPOST('rowid','alpha');
    46| $code=GETPOST('code','alpha');
    47| $acts[0] = "activate";
    48| $acts[1] = "disable";
    49| $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
    50| $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
    51| $listoffset=GETPOST('listoffset');
    52| $listlimit=GETPOST('listlimit')>0?GETPOST('listlimit'):1000;
    53| $active = 1;
    54| $sortfield = GETPOST("sortfield",'alpha');
    55| $sortorder = GETPOST("sortorder",'alpha');
    56| $page = GETPOST("page",'int');
    57| if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
    58| $offset = $listlimit * $page ;
    59| $pageprev = $page - 1;
    60| $pagenext = $page + 1;
    61| $search_country_id = GETPOST('search_country_id','int');
    62| if ($user->societe_id > 0) accessforbidden();
    63| if (! $user->rights->accounting->chartofaccount) accessforbidden();
    64| $hookmanager->initHooks(array('admin'));
    65| $tabname=array();
    66| $tabname[31]= MAIN_DB_PREFIX."accounting_system";
    67| $tabname[32]= MAIN_DB_PREFIX."c_accounting_category";
    68| $tablib=array();
    69| $tablib[31]= "Pcg_version";
    70| $tablib[32]= "DictionaryAccountancyCategory";
    71| $tabsql=array();
    72| $tabsql[31]= "SELECT s.rowid as rowid, pcg_version, s.label, s.fk_country as country_id, c.code as country_code, c.label as country, s.active FROM ".MAIN_DB_PREFIX."accounting_system as s, ".MAIN_DB_PREFIX."c_country as c WHERE s.fk_country=c.rowid and c.active=1";
    73| $tabsql[32]= "SELECT a.rowid as rowid, a.code as code, a.label, a.range_account, a.sens, a.category_type, a.formula, a.position as position, a.fk_country as country_id, c.code as country_code, c.label as country, a.active FROM ".MAIN_DB_PREFIX."c_accounting_category as a, ".MAIN_DB_PREFIX."c_country as c WHERE a.fk_country=c.rowid and c.active=1";
    74| $tabsqlsort=array();
    75| $tabsqlsort[31]="pcg_version ASC";
    76| $tabsqlsort[32]="position ASC";
    77| $tabfield=array();
    78| $tabfield[31]= "pcg_version,label,country_id,country";
    79| $tabfield[32]= "code,label,range_account,sens,category_type,formula,position,country_id,country";
    80| $tabfieldvalue=array();
    81| $tabfieldvalue[31]= "pcg_version,label,country";
    82| $tabfieldvalue[32]= "code,label,range_account,sens,category_type,formula,position,country";
    83| $tabfieldinsert=array();
    84| $tabfieldinsert[31]= "pcg_version,label,fk_country";
    85| $tabfieldinsert[32]= "code,label,range_account,sens,category_type,formula,position,fk_country";
    86| $tabrowid=array();
    87| $tabrowid[31]= "";
    88| $tabrowid[32]= "";
    89| $tabcond=array();
    90| $tabcond[31]= ! empty($conf->accounting->enabled);
    91| $tabcond[32]= ! empty($conf->accounting->enabled);
    92| $tabhelp=array();
    93| $tabhelp[31] = array('pcg_version'=>$langs->trans("EnterAnyCode"));
    94| $tabhelp[32] = array('code'=>$langs->trans("EnterAnyCode"));
    95| $tabfieldcheck=array();
    96| $tabfieldcheck[31] = array();
    97| $tabfieldcheck[32] = array();
    98| $elementList = array();
    99| $sourceList=array();
   100| /*
   101|  * Actions
   102|  */
   103| if (GETPOST('button_removefilter') || GETPOST('button_removefilter.x') || GETPOST('button_removefilter_x'))
   104| {
   105| 	$search_country_id = '';
   106| }
   107| if (GETPOST('actionadd') || GETPOST('actionmodify'))
   108| {
   109| 	$listfield=explode(',', str_replace(' ', '',$tabfield[$id]));
   110| 	$listfieldinsert=explode(',',$tabfieldinsert[$id]);
   111| 	$listfieldmodify=explode(',',$tabfieldinsert[$id]);
   112| 	$listfieldvalue=explode(',',$tabfieldvalue[$id]);
   113| 	$ok=1;
   114| 	foreach ($listfield as $f => $value)
   115| 	{
   116| 		if ($value == 'country_id' && in_array($tablib[$id],array('DictionaryVAT','DictionaryRegion','DictionaryCompanyType','DictionaryHolidayTypes','DictionaryRevenueStamp','DictionaryAccountancyCategory','Pcg_version'))) continue;		// For some pages, country is not mandatory
   117| 		if ($value == 'country' && in_array($tablib[$id],array('DictionaryCanton','DictionaryCompanyType','DictionaryRevenueStamp'))) continue;		// For some pages, country is not mandatory

# --- HUNK 2: Lines 359-428 ---
   359| 		dol_print_error($db);
   360| 	}
   361| }
   362| /*
   363|  * View
   364|  */
   365| $form = new Form($db);
   366| $formadmin=new FormAdmin($db);
   367| llxHeader();
   368| $titre=$langs->trans($tablib[$id]);
   369| $linkback='';
   370| print load_fiche_titre($titre,$linkback,'title_accountancy');
   371| if (empty($id))
   372| {
   373| 	print $langs->trans("DictionaryDesc");
   374| 	print " ".$langs->trans("OnlyActiveElementsAreShown")."<br>\n";
   375| }
   376| print "<br>\n";
   377| if ($action == 'delete')
   378| {
   379| 	print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid.'&code='.$code.'&id='.$id, $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
   380| }
   381| /*
   382|  * Show a dictionary
   383|  */
   384| if ($id)
   385| {
   386| 	$sql=$tabsql[$id];
   387| 	if ($search_country_id > 0)
   388| 	{
   389| 		if (preg_match('/ WHERE /',$sql)) $sql.= " AND ";
   390| 		else $sql.=" WHERE ";
   391| 		$sql.= " c.rowid = ".$search_country_id;
   392| 	}
   393| 	if ($sortfield)
   394| 	{
   395| 		if ($sortfield == 'country') $sortfield='country_code';
   396| 		$sql.= " ORDER BY ".$sortfield;
   397| 		if ($sortorder)
   398| 		{
   399| 			$sql.=" ".strtoupper($sortorder);
   400| 		}
   401| 		$sql.=", ";
   402| 		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
   403| 		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
   404| 	}
   405| 	else {
   406| 		$sql.=" ORDER BY ";
   407| 	}
   408| 	$sql.=$tabsqlsort[$id];
   409| 	$sql.=$db->plimit($listlimit+1,$offset);
   410| 	$fieldlist=explode(',',$tabfield[$id]);
   411| 	print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
   412| 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   413| 	print '<div class="div-table-responsive">';
   414| 	print '<table class="noborder" width="100%">';
   415| 	if ($tabname[$id])
   416| 	{
   417| 		$alabelisused=0;
   418| 		$var=false;
   419| 		$fieldlist=explode(',',$tabfield[$id]);
   420| 		print '<tr class="liste_titre">';
   421| 		foreach ($fieldlist as $field => $value)
   422| 		{
   423| 			$valuetoshow=ucfirst($fieldlist[$field]);   // Par defaut
   424| 			$valuetoshow=$langs->trans($valuetoshow);   // try to translate
   425| 			$align="left";
   426| 			if ($fieldlist[$field]=='source')          { $valuetoshow=$langs->trans("Contact"); }
   427| 			if ($fieldlist[$field]=='price')           { $valuetoshow=$langs->trans("PriceUHT"); }
   428| 			if ($fieldlist[$field]=='taux')            {


# ====================================================================
# FILE: htdocs/accountancy/admin/categories.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 54-94 ---
    54| 		setEventMessages($langs->trans('errors'), $accountingcategory->errors, 'errors');
    55| 	} else {
    56| 		setEventMessages($langs->trans('Saved'), null, 'mesgs');
    57| 	}
    58| }
    59| if ($action == 'delete') {
    60| 	if ($cpt_id) {
    61| 		if ($accountingcategory->deleteCptCat($cpt_id)) {
    62| 			setEventMessages($langs->trans('CategoryDeleted'), null, 'mesgs');
    63| 		} else {
    64| 			setEventMessages($langs->trans('errors'), null, 'errors');
    65| 		}
    66| 	}
    67| }
    68| /*
    69|  * View
    70|  */
    71| $form = new Form($db);
    72| $formaccounting = new FormAccounting($db);
    73| llxheader('', $langs->trans('AccountingCategory'));
    74| $linkback = '<a href="'.DOL_URL_ROOT.'/accountancy/admin/categories_list.php?search_country_id='.$mysoc->country_id.'">'.$langs->trans("BackToList").'</a>';
    75| print load_fiche_titre($langs->trans('AccountingCategory'), $linkback);
    76| print '<form name="add" action="' . $_SERVER["PHP_SELF"] . '" method="POST">' . "\n";
    77| print '<input type="hidden" name="token" value="' . $_SESSION['newtoken'] . '">';
    78| print '<input type="hidden" name="action" value="display">';
    79| dol_fiche_head();
    80| print '<table class="border" width="100%">';
    81| print '<tr><td class="titlefield">' . $langs->trans("AccountingCategory") . '</td>';
    82| print '<td>';
    83| $formaccounting->select_accounting_category($cat_id, 'account_category', 1, 0, 0, 1);
    84| print '<input class="button" type="submit" value="' . $langs->trans("Select") . '">';
    85| print '</td></tr>';
    86| if (! empty($cat_id))
    87| {
    88| 	$return = $accountingcategory->getAccountsWithNoCategory($cat_id);
    89| 	if ($return < 0) {
    90| 		setEventMessages(null, $accountingcategory->errors, 'errors');
    91| 	}
    92| 	print '<tr><td>' . $langs->trans("AddAccountFromBookKeepingWithNoCategories") . '</td>';
    93| 	print '<td>';
    94| 	$arraykeyvalue=array();


# ====================================================================
# FILE: htdocs/accountancy/admin/categories_list.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 28-69 ---
    28| require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';
    29| require_once DOL_DOCUMENT_ROOT.'/core/lib/accounting.lib.php';
    30| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formaccounting.class.php';
    31| $langs->loadLangs(array("errors","admin","companies","resource","holiday","accountancy","hrm"));
    32| $action=GETPOST('action','alpha')?GETPOST('action','alpha'):'view';
    33| $confirm=GETPOST('confirm','alpha');
    34| $id=32;
    35| $rowid=GETPOST('rowid','alpha');
    36| $code=GETPOST('code','alpha');
    37| if (empty($user->rights->accounting->chartofaccount))
    38| {
    39| 	accessforbidden();
    40| }
    41| $acts[0] = "activate";
    42| $acts[1] = "disable";
    43| $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
    44| $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
    45| $listoffset=GETPOST('listoffset');
    46| $listlimit=GETPOST('listlimit')>0?GETPOST('listlimit'):1000;
    47| $active = 1;
    48| $sortfield = GETPOST("sortfield",'alpha');
    49| $sortorder = GETPOST("sortorder",'alpha');
    50| $page = GETPOST("page",'int');
    51| if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
    52| $offset = $listlimit * $page ;
    53| $pageprev = $page - 1;
    54| $pagenext = $page + 1;
    55| $search_country_id = GETPOST('search_country_id','int');
    56| $hookmanager->initHooks(array('admin'));
    57| $taborder=array(32);
    58| $tabname=array();
    59| $tabname[32]= MAIN_DB_PREFIX."c_accounting_category";
    60| $tablib=array();
    61| $tablib[32]= "DictionaryAccountancyCategory";
    62| $tabsql=array();
    63| $tabsql[32]= "SELECT a.rowid as rowid, a.code as code, a.label, a.range_account, a.category_type, a.formula, a.position as position, a.fk_country as country_id, c.code as country_code, c.label as country, a.active FROM ".MAIN_DB_PREFIX."c_accounting_category as a, ".MAIN_DB_PREFIX."c_country as c WHERE a.fk_country=c.rowid and c.active=1";
    64| $tabsqlsort=array();
    65| $tabsqlsort[32]="position ASC";
    66| $tabfield=array();
    67| $tabfield[32]= "code,label,range_account,category_type,formula,position,country";
    68| $tabfieldvalue=array();
    69| $tabfieldvalue[32]= "code,label,range_account,category_type,formula,position,country_id";

# --- HUNK 2: Lines 203-364 ---
   203|             if ($_POST[$listfieldvalue[$i]] == '' && ! $listfieldvalue[$i] == 'range_account') $sql.="null";  // For range_account, we want/accept code = ''
   204|             else $sql.="'".$db->escape($_POST[$listfieldvalue[$i]])."'";
   205|             $i++;
   206|         }
   207|         $sql.= " WHERE ".$rowidcol." = '".$rowid."'";
   208|         dol_syslog("actionmodify", LOG_DEBUG);
   209|         $resql = $db->query($sql);
   210|         if (! $resql)
   211|         {
   212|             setEventMessages($db->error(), null, 'errors');
   213|         }
   214|     }
   215| }
   216| if (GETPOST('actioncancel'))
   217| {
   218| }
   219| if ($action == 'confirm_delete' && $confirm == 'yes')       // delete
   220| {
   221|     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
   222|     else { $rowidcol="rowid"; }
   223|     $sql = "DELETE from ".$tabname[$id]." WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
   224|     dol_syslog("delete", LOG_DEBUG);
   225|     $result = $db->query($sql);
   226|     if (! $result)
   227|     {
   228|         if ($db->errno() == 'DB_ERROR_CHILD_EXISTS')
   229|         {
   230|             setEventMessages($langs->transnoentities("ErrorRecordIsUsedByChild"), null, 'errors');
   231|         }
   232|         else
   233|         {
   234|             dol_print_error($db);
   235|         }
   236|     }
   237| }
   238| if ($action == $acts[0])
   239| {
   240|     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
   241|     else { $rowidcol="rowid"; }
   242|     if ($rowid) {
   243|         $sql = "UPDATE ".$tabname[$id]." SET active = 1 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
   244|     }
   245|     elseif ($code) {
   246|     	$sql = "UPDATE ".$tabname[$id]." SET active = 1 WHERE code = '".$this->db->escape($code)."'";
   247|     }
   248|     $result = $db->query($sql);
   249|     if (!$result)
   250|     {
   251|         dol_print_error($db);
   252|     }
   253| }
   254| if ($action == $acts[1])
   255| {
   256|     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
   257|     else { $rowidcol="rowid"; }
   258|     if ($rowid) {
   259|     	$sql = "UPDATE ".$tabname[$id]." SET active = 0 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
   260|     }
   261|     elseif ($code) {
   262|     	$sql = "UPDATE ".$tabname[$id]." SET active = 0 WHERE code = '".$this->db->escape($code)."'";
   263|     }
   264|     $result = $db->query($sql);
   265|     if (!$result)
   266|     {
   267|         dol_print_error($db);
   268|     }
   269| }
   270| if ($action == 'activate_favorite')
   271| {
   272|     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
   273|     else { $rowidcol="rowid"; }
   274|     if ($rowid) {
   275|     	$sql = "UPDATE ".$tabname[$id]." SET favorite = 1 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
   276|     }
   277|     elseif ($code) {
   278|     	$sql = "UPDATE ".$tabname[$id]." SET favorite = 1 WHERE code = '".$this->db->escape($code)."'";
   279|     }
   280|     $result = $db->query($sql);
   281|     if (!$result)
   282|     {
   283|         dol_print_error($db);
   284|     }
   285| }
   286| if ($action == 'disable_favorite')
   287| {
   288|     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
   289|     else { $rowidcol="rowid"; }
   290|     if ($rowid) {
   291|     	$sql = "UPDATE ".$tabname[$id]." SET favorite = 0 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
   292|     }
   293|     elseif ($code) {
   294|     	$sql = "UPDATE ".$tabname[$id]." SET favorite = 0 WHERE code = '".$this->db->escape($code)."'";
   295|     }
   296|     $result = $db->query($sql);
   297|     if (!$result)
   298|     {
   299|         dol_print_error($db);
   300|     }
   301| }
   302| /*
   303|  * View
   304|  */
   305| $form = new Form($db);
   306| $formadmin=new FormAdmin($db);
   307| llxHeader('', $langs->trans('DictionaryAccountancyCategory'));
   308| $titre=$langs->trans($tablib[$id]);
   309| $linkback='';
   310| $titlepicto='title_setup';
   311| print load_fiche_titre($titre, $linkback, $titlepicto);
   312| print $langs->trans("AccountingAccountGroupsDesc", $langs->transnoentitiesnoconv("ByPersonalizedAccountGroups")).'<br><br>';
   313| if ($action == 'delete')
   314| {
   315|     print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid.'&code='.$code.'&id='.$id.($search_country_id>0?'&search_country_id='.$search_country_id:''), $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
   316| }
   317| /*
   318|  * Show a dictionary
   319|  */
   320| if ($id)
   321| {
   322|     $sql=$tabsql[$id];
   323|     if ($search_country_id > 0)
   324|     {
   325|         if (preg_match('/ WHERE /',$sql)) $sql.= " AND ";
   326|         else $sql.=" WHERE ";
   327|         $sql.= " (a.fk_country = ".$search_country_id." OR a.fk_country = 0)";
   328|     }
   329|     if ($sortfield)
   330|     {
   331|     	if ($sortfield == 'country') $sortfield='country_code';
   332|         $sql.= " ORDER BY ".$sortfield;
   333|         if ($sortorder)
   334|         {
   335|             $sql.=" ".strtoupper($sortorder);
   336|         }
   337|         $sql.=", ";
   338|         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
   339|         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
   340|     }
   341|     else {
   342|         $sql.=" ORDER BY ";
   343|     }
   344|     $sql.=$tabsqlsort[$id];
   345|     $sql.=$db->plimit($listlimit+1,$offset);
   346|     $fieldlist=explode(',',$tabfield[$id]);
   347|     print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
   348|     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   349|     print '<input type="hidden" name="from" value="'.dol_escape_htmltag(GETPOST('from','alpha')).'">';
   350| 	print '<div class="div-table-responsive">';
   351|     print '<table class="noborder" width="100%">';
   352|     if ($tabname[$id])
   353|     {
   354|         $alabelisused=0;
   355|         $var=false;
   356|         $fieldlist=explode(',',$tabfield[$id]);
   357|         print '<tr class="liste_titre">';
   358|         foreach ($fieldlist as $field => $value)
   359|         {
   360|             $valuetoshow=ucfirst($fieldlist[$field]);   // Par defaut
   361|             $valuetoshow=$langs->trans($valuetoshow);   // try to translate
   362|             $align="left";
   363|             if ($fieldlist[$field]=='type')            {
   364| 				if ($tabname[$id] == MAIN_DB_PREFIX."c_paiement") $valuetoshow=$form->textwithtooltip($langs->trans("Type"),$langs->trans("TypePaymentDesc"),2,1,img_help(1,''));

# --- HUNK 3: Lines 603-643 ---
   603|                     $url.='&';
   604|                     print '<td align="center" class="nowrap">';
   605|                     if ($canbedisabled) print '<a href="'.$url.'action='.$acts[$obj->active].'">'.$actl[$obj->active].'</a>';
   606|                     else
   607|                  	{
   608|                     	print $langs->trans("AlwaysActive");
   609|                     }
   610|                     print "</td>";
   611|                     if ($canbemodified) print '<td align="center"><a class="reposition" href="'.$url.'action=edit">'.img_edit().'</a></td>';
   612|                     else print '<td>&nbsp;</td>';
   613|                     if ($iserasable)
   614|                     {
   615|                         print '<td align="center">';
   616|                         if ($user->admin) print '<a href="'.$url.'action=delete">'.img_delete().'</a>';
   617|                         print '</td>';
   618|                     }
   619|                     else print '<td>&nbsp;</td>';
   620|                     print '<td class="center">';
   621|                     if (empty($obj->formula))
   622|                     {
   623|                         print '<a href="'.DOL_URL_ROOT.'/accountancy/admin/categories.php?action=display&account_category='.$obj->rowid.'">';
   624|                         print $langs->trans("ListOfAccounts");
   625|                         print '</a>';
   626|                     }
   627|                     print '</td>';
   628|                 }
   629|                 print "</tr>\n";
   630|                 $i++;
   631|             }
   632|         }
   633|     }
   634|     else {
   635|         dol_print_error($db);
   636|     }
   637|     print '</table>';
   638| 	print '</div>';
   639|     print '</form>';
   640| }
   641| print '<br>';
   642| llxFooter();
   643| $db->close();


# ====================================================================
# FILE: htdocs/accountancy/admin/index.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-96 ---
    31| require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
    32| $langs->load("compta");
    33| $langs->load("bills");
    34| $langs->load("admin");
    35| $langs->load("accountancy");
    36| if (empty($user->rights->accounting->chartofaccount))
    37| {
    38| 	accessforbidden();
    39| }
    40| $action = GETPOST('action', 'alpha');
    41| $list = array (
    42|     'ACCOUNTING_LENGTH_GACCOUNT',
    43|     'ACCOUNTING_LENGTH_AACCOUNT' ,
    44| );
    45| /*
    46|  * Actions
    47|  */
    48| $accounting_mode = empty($conf->global->ACCOUNTING_MODE) ? 'RECETTES-DEPENSES' : $conf->global->ACCOUNTING_MODE;
    49| if ($action == 'update') {
    50| 	$error = 0;
    51| 	$accounting_modes = array (
    52| 			'RECETTES-DEPENSES',
    53| 			'CREANCES-DETTES'
    54| 	);
    55| 	$accounting_mode = GETPOST('accounting_mode', 'alpha');
    56| 	if (in_array($accounting_mode, $accounting_modes)) {
    57| 		if (! dolibarr_set_const($db, 'ACCOUNTING_MODE', $accounting_mode, 'chaine', 0, '', $conf->entity)) {
    58| 			$error ++;
    59| 		}
    60| 	} else {
    61| 		$error ++;
    62| 	}
    63| 	if ($error) {
    64| 		setEventMessages($langs->trans("Error"), null, 'errors');
    65| 	}
    66|     foreach ($list as $constname)
    67|     {
    68|         $constvalue = GETPOST($constname, 'alpha');
    69|         if (! dolibarr_set_const($db, $constname, $constvalue, 'chaine', 0, '', $conf->entity)) {
    70|             $error ++;
    71|         }
    72|     }
    73|     if (! $error) {
    74|         setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
    75|     } else {
    76|         setEventMessages($langs->trans("Error"), null, 'errors');
    77|     }
    78| }
    79| if ($action == 'setlistsorttodo') {
    80|     $setlistsorttodo = GETPOST('value', 'int');
    81|     $res = dolibarr_set_const($db, "ACCOUNTING_LIST_SORT_VENTILATION_TODO", $setlistsorttodo, 'yesno', 0, '', $conf->entity);
    82|     if (! $res > 0)
    83|         $error ++;
    84|         if (! $error) {
    85|             setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
    86|         } else {
    87|             setEventMessages($langs->trans("Error"), null, 'mesgs');
    88|         }
    89| }
    90| if ($action == 'setlistsortdone') {
    91|     $setlistsortdone = GETPOST('value', 'int');
    92|     $res = dolibarr_set_const($db, "ACCOUNTING_LIST_SORT_VENTILATION_DONE", $setlistsortdone, 'yesno', 0, '', $conf->entity);
    93|     if (! $res > 0)
    94|         $error ++;
    95|         if (! $error) {
    96|             setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');


# ====================================================================
# FILE: htdocs/accountancy/admin/journals_list.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 16-95 ---
    16|  *
    17|  */
    18| /**
    19|  * \file		htdocs/accountancy/admin/journals_list.php
    20|  * \ingroup		Advanced accountancy
    21|  * \brief		Setup page to configure journals
    22|  */
    23| require '../../main.inc.php';
    24| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formadmin.class.php';
    25| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';
    26| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    27| require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
    28| require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';
    29| require_once DOL_DOCUMENT_ROOT.'/core/lib/accounting.lib.php';
    30| require_once DOL_DOCUMENT_ROOT.'/accountancy/class/accountingjournal.class.php';
    31| $langs->load("admin");
    32| $langs->load("compta");
    33| $langs->load("accountancy");
    34| $action=GETPOST('action','alpha')?GETPOST('action','alpha'):'view';
    35| $confirm=GETPOST('confirm','alpha');
    36| $id=GETPOST('id','int');
    37| $rowid=GETPOST('rowid','alpha');
    38| $code=GETPOST('code','alpha');
    39| if (empty($user->rights->accounting->chartofaccount))
    40| {
    41| 	accessforbidden();
    42| }
    43| $acts[0] = "activate";
    44| $acts[1] = "disable";
    45| $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
    46| $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
    47| $listoffset=GETPOST('listoffset');
    48| $listlimit=GETPOST('listlimit')>0?GETPOST('listlimit'):1000;
    49| $active = 1;
    50| $sortfield = GETPOST("sortfield",'alpha');
    51| $sortorder = GETPOST("sortorder",'alpha');
    52| $page = GETPOST("page",'int');
    53| if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
    54| $offset = $listlimit * $page ;
    55| $pageprev = $page - 1;
    56| $pagenext = $page + 1;
    57| if (empty($sortfield)) $sortfield='code';
    58| if (empty($sortorder)) $sortorder='ASC';
    59| $error = 0;
    60| $hookmanager->initHooks(array('admin'));
    61| $taborder=array(35);
    62| $tabname=array();
    63| $tabname[35]= MAIN_DB_PREFIX."accounting_journal";
    64| $tablib=array();
    65| $tablib[35]= "DictionaryAccountancyJournal";
    66| $tabsql=array();
    67| $tabsql[35]= "SELECT a.rowid as rowid, a.code as code, a.label, a.nature, a.active FROM ".MAIN_DB_PREFIX."accounting_journal as a";
    68| $tabsqlsort=array();
    69| $tabsqlsort[35]="code ASC";
    70| $tabfield=array();
    71| $tabfield[35]= "code,label,nature";
    72| $tabfieldvalue=array();
    73| $tabfieldvalue[35]= "code,label,nature";
    74| $tabfieldinsert=array();
    75| $tabfieldinsert[35]= "code,label,nature";
    76| $tabrowid=array();
    77| $tabrowid[35]= "";
    78| $tabcond=array();
    79| $tabcond[35]= ! empty($conf->accounting->enabled);
    80| $tabhelp=array();
    81| $tabhelp[35] = array('code'=>$langs->trans("EnterAnyCode"));
    82| $tabfieldcheck=array();
    83| $tabfieldcheck[35] = array();
    84| complete_dictionary_with_modules($taborder,$tabname,$tablib,$tabsql,$tabsqlsort,$tabfield,$tabfieldvalue,$tabfieldinsert,$tabrowid,$tabcond,$tabhelp,$tabfieldcheck);
    85| $elementList = array();
    86| 	$sourceList = array(
    87| 			'1' => $langs->trans('AccountingJournalType1'),
    88| 			'2' => $langs->trans('AccountingJournalType2'),
    89| 			'3' => $langs->trans('AccountingJournalType3'),
    90| 			'4' => $langs->trans('AccountingJournalType4'),
    91| 			'5' => $langs->trans('AccountingJournalType5'),
    92| 			'9' => $langs->trans('AccountingJournalType9')
    93| 	);
    94| /*
    95|  * Actions

# --- HUNK 2: Lines 284-339 ---
   284| llxHeader();
   285| $titre=$langs->trans("DictionarySetup");
   286| $linkback='';
   287| if ($id)
   288| {
   289| 	$titre.=' - '.$langs->trans($tablib[$id]);
   290| 	$titlepicto='title_accountancy';
   291| }
   292| print load_fiche_titre($titre,$linkback,$titlepicto);
   293| if ($action == 'delete')
   294| {
   295| 	print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid.'&code='.$code.'&id='.$id, $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
   296| }
   297| /*
   298|  * Show a dictionary
   299|  */
   300| if ($id)
   301| {
   302| 	$sql=$tabsql[$id];
   303| 	$sql.= " WHERE a.entity = ".$conf->entity;
   304| 	if ($sortfield)
   305| 	{
   306| 		if ($sortfield == 'country') $sortfield='country_code';
   307| 		$sql.= " ORDER BY ".$sortfield;
   308| 		if ($sortorder)
   309| 		{
   310| 			$sql.=" ".strtoupper($sortorder);
   311| 		}
   312| 		$sql.=", ";
   313| 		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
   314| 		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
   315| 	}
   316| 	else {
   317| 		$sql.=" ORDER BY ";
   318| 	}
   319| 	$sql.=$tabsqlsort[$id];
   320| 	$sql.=$db->plimit($listlimit+1,$offset);
   321| 	$fieldlist=explode(',',$tabfield[$id]);
   322| 	print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
   323| 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   324| 	print '<input type="hidden" name="from" value="'.dol_escape_htmltag(GETPOST('from','alpha')).'">';
   325| 	print '<div class="div-table-responsive">';
   326| 	print '<table class="noborder" width="100%">';
   327| 	if ($tabname[$id])
   328| 	{
   329| 		$alabelisused=0;
   330| 		$var=false;
   331| 		$fieldlist=explode(',',$tabfield[$id]);
   332| 		print '<tr class="liste_titre">';
   333| 		foreach ($fieldlist as $field => $value)
   334| 		{
   335| 			$valuetoshow=ucfirst($fieldlist[$field]);   // Par defaut
   336| 			$valuetoshow=$langs->trans($valuetoshow);   // try to translate
   337| 			$align="left";
   338| 			if ($fieldlist[$field]=='code')            { $valuetoshow=$langs->trans("Code"); }
   339| 			if ($fieldlist[$field]=='libelle' || $fieldlist[$field]=='label')


# ====================================================================
# FILE: htdocs/accountancy/bookkeeping/card.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 15-71 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    19|  */
    20| /**
    21|  * \file		htdocs/accountancy/bookkeeping/card.php
    22|  * \ingroup		Advanced accountancy
    23|  * \brief		Page to show book-entry
    24|  */
    25| require '../../main.inc.php';
    26| require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
    27| require_once DOL_DOCUMENT_ROOT . '/accountancy/class/bookkeeping.class.php';
    28| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formaccounting.class.php';
    29| require_once DOL_DOCUMENT_ROOT . '/compta/facture/class/facture.class.php';
    30| require_once DOL_DOCUMENT_ROOT . '/fourn/class/fournisseur.facture.class.php';
    31| require_once DOL_DOCUMENT_ROOT . '/accountancy/class/accountingjournal.class.php';
    32| $langs->load("accountancy");
    33| $langs->load("bills");
    34| $langs->load("compta");
    35| $id = GETPOST('id', 'int');
    36| if ($user->societe_id > 0) {
    37| 	accessforbidden();
    38| }
    39| $action = GETPOST('action','aZ09');
    40| $mode = GETPOST('mode','aZ09');		 // '' or 'tmp'
    41| $piece_num = GETPOST("piece_num");
    42| $mesg = '';
    43| $account_number = GETPOST('account_number');
    44| $subledger_account = GETPOST('subledger_account');
    45| if ($subledger_account == - 1) {
    46| 	$subledger_account = null;
    47| }
    48| $label_compte = GETPOST('label_compte');
    49| $label_operation= GETPOST('label_operation');
    50| $debit = price2num(GETPOST('debit'));
    51| $credit = price2num(GETPOST('credit'));
    52| $save = GETPOST('save','alpha');
    53| if (! empty($save)) $action = 'add';
    54| $update = GETPOST('update','alpha');
    55| if (! empty($update)) $action = 'confirm_update';
    56| $object = new BookKeeping($db);
    57| /*
    58|  * Actions
    59|  */
    60| if ($action == "confirm_update") {
    61| 	$error = 0;
    62| 	if ((floatval($debit) != 0.0) && (floatval($credit) != 0.0)) {
    63| 		$error++;
    64| 		setEventMessages($langs->trans('ErrorDebitCredit'), null, 'errors');
    65| 		$action='update';
    66| 	}
    67| 	if (empty($account_number) || $account_number == '-1')
    68| 	{
    69| 		$error++;
    70| 		setEventMessages($langs->trans('ErrorFieldRequired', $langs->transnoentitiesnoconv("AccountAccountingShort")), null, 'errors');
    71| 		$action='update';

# --- HUNK 2: Lines 269-349 ---
   269| llxHeader('', $langs->trans("CreateMvts"));
   270| if ($action == 'delete') {
   271| 	$formconfirm = $html->formconfirm($_SERVER["PHP_SELF"] . '?id=' . $id.'&mode='. $mode, $langs->trans('DeleteMvt'), $langs->trans('ConfirmDeleteMvt'), 'confirm_delete', '', 0, 1);
   272| 	print $formconfirm;
   273| }
   274| if ($action == 'create')
   275| {
   276| 	print load_fiche_titre($langs->trans("CreateMvts"));
   277| 	$book = new BookKeeping($db);
   278| 	$next_num_mvt = $book->getNextNumMvt('_tmp');
   279| 	if (empty($next_num_mvt))
   280| 	{
   281| 		dol_print_error('', 'Failed to get next piece number');
   282| 	}
   283| 	print '<form action="' . $_SERVER["PHP_SELF"] . '" name="create_mvt" method="POST">';
   284| 	print '<input type="hidden" name="action" value="confirm_create">' . "\n";
   285| 	print '<input type="hidden" name="next_num_mvt" value="' . $next_num_mvt . '">' . "\n";
   286| 	print '<input type="hidden" name="mode" value="_tmp">' . "\n";
   287| 	dol_fiche_head();
   288| 	print '<table class="border" width="100%">';
   289| 	print '<tr>';
   290| 	print '<td class="titlefieldcreate fieldrequired">' . $langs->trans("NumPiece") . '</td>';
   291| 	print '<td>' . $next_num_mvt . '</td>';
   292| 	print '</tr>';
   293| 	print '<tr>';
   294| 	print '<td class="fieldrequired">' . $langs->trans("Docdate") . '</td>';
   295| 	print '<td>';
   296| 	print $html->select_date('', 'doc_date', '', '', '', "create_mvt", 1, 1);
   297| 	print '</td>';
   298| 	print '</tr>';
   299| 	print '<tr>';
   300| 	print '<td class="fieldrequired">' . $langs->trans("Codejournal") . '</td>';
   301| 	print '<td>' . $formaccounting->select_journal(GETPOST('code_journal'),'code_journal',0,1,array(),1,1) . '</td>';
   302| 	print '</tr>';
   303| 	print '<tr>';
   304| 	print '<td>' . $langs->trans("Docref") . '</td>';
   305| 	print '<td><input type="text" class="minwidth200" name="doc_ref" value=""/></td>';
   306| 	print '</tr>';
   307| 	/*
   308| 	print '<tr>';
   309| 	print '<td>' . $langs->trans("Doctype") . '</td>';
   310| 	print '<td><input type="text" class="minwidth200 name="doc_type" value=""/></td>';
   311| 	print '</tr>';
   312| 	*/
   313| 	print '</table>';
   314| 	dol_fiche_end();
   315| 	print '<div class="center">';
   316| 	print '<input type="submit" class="button" value="' . $langs->trans("Create") . '">';
   317| 	print '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
   318| 	print '<input type="button" value="' . $langs->trans("Cancel") . '" class="button" onclick="history.go(-1)" />';
   319| 	print '</div>';
   320| 	print '</form>';
   321| } else {
   322| 	$book = new BookKeeping($db);
   323| 	$result = $book->fetchPerMvt($piece_num, $mode);
   324| 	if ($result < 0) {
   325| 		setEventMessages($book->error, $book->errors, 'errors');
   326| 	}
   327| 	if (! empty($book->piece_num))
   328| 	{
   329| 		$backlink = '<a href="'.DOL_URL_ROOT.'/accountancy/bookkeeping/list.php">' . $langs->trans('BackToList') . '</a>';
   330| 		print load_fiche_titre($langs->trans("UpdateMvts"), $backlink);
   331| 		$head=array();
   332| 		$h=0;
   333| 		$head[$h][0] = $_SERVER['PHP_SELF'].'?piece_num='.$book->piece_num.($mode?'&mode='.$mode:'');
   334| 		$head[$h][1] = $langs->trans("Transaction");
   335| 		$head[$h][2] = 'transaction';
   336| 		$h++;
   337| 		dol_fiche_head($head, 'transaction', '', -1);
   338| 		print '<div class="fichecenter">';
   339| 		print '<div class="fichehalfleft">';
   340| 		print '<div class="underbanner clearboth"></div>';
   341| 		print '<table class="border tableforfield" width="100%">';
   342| 		print '<tr>';
   343| 		print '<td class="titlefield">' . $langs->trans("NumMvts") . '</td>';
   344| 		print '<td>' . $book->piece_num . '</td>';
   345| 		print '</tr>';
   346| 		print '<tr><td>';
   347| 		print '<table class="nobordernopadding" width="100%"><tr><td>';
   348| 		print $langs->trans('Docdate');
   349| 		print '</td>';

# --- HUNK 3: Lines 475-515 ---
   475| 			print '<input type="hidden" name="doc_date" value="' . $book->doc_date . '">' . "\n";
   476| 			print '<input type="hidden" name="doc_type" value="' . $book->doc_type . '">' . "\n";
   477| 			print '<input type="hidden" name="doc_ref" value="' . $book->doc_ref . '">' . "\n";
   478| 			print '<input type="hidden" name="code_journal" value="' . $book->code_journal . '">' . "\n";
   479| 			print '<input type="hidden" name="fk_doc" value="' . $book->fk_doc . '">' . "\n";
   480| 			print '<input type="hidden" name="fk_docdet" value="' . $book->fk_docdet . '">' . "\n";
   481| 			print '<input type="hidden" name="mode" value="' . $mode . '">' . "\n";
   482| 			print "<table class=\"noborder\" width=\"100%\">";
   483| 			if (count($book->linesmvt) > 0) {
   484| 				$total_debit = 0;
   485| 				$total_credit = 0;
   486| 				print '<tr class="liste_titre">';
   487| 				print_liste_field_titre("AccountAccountingShort");
   488| 				print_liste_field_titre("SubledgerAccount");
   489| 				print_liste_field_titre("LabelAccount");
   490| 				print_liste_field_titre("LabelOperation");
   491| 				print_liste_field_titre("Debit", "", "", "", "", 'align="right"');
   492| 				print_liste_field_titre("Credit", "", "", "", "", 'align="right"');
   493| 				print_liste_field_titre("Action", "", "", "", "", 'width="60" align="center"');
   494| 				print "</tr>\n";
   495| 				foreach ( $book->linesmvt as $line ) {
   496| 					print '<tr class="oddeven">';
   497| 					$total_debit += $line->debit;
   498| 					$total_credit += $line->credit;
   499| 					if ($action == 'update' && $line->id == $id) {
   500| 						print '<td>';
   501| 						print $formaccounting->select_account($line->numero_compte, 'account_number', 1, array (), 1, 1, '');
   502| 						print '</td>';
   503| 						print '<td>';
   504| 						if (! empty($conf->global->ACCOUNTANCY_COMBO_FOR_AUX))
   505| 						{
   506| 							print $formaccounting->select_auxaccount($line->subledger_account, 'subledger_account', 1);
   507| 						}
   508| 						else
   509| 						{
   510| 							print '<input type="text" name="subledger_account" value="'.$line->subledger_account.'">';
   511| 						}
   512| 						print '</td>';
   513| 						print '<td><input type="text" class="minwidth100" name="label_compte" value="' . $line->label_compte . '"/></td>';
   514| 						print '<td><input type="text" class="minwidth300" name="label_operation" value="' . $line->label_operation. '"/></td>';
   515| 						print '<td align="right"><input type="text" size="6" class="right" name="debit" value="' . price($line->debit) . '"/></td>';

# --- HUNK 4: Lines 542-583 ---
   542| 				$total_credit = price2num($total_credit);
   543| 				if ($total_debit != $total_credit)
   544| 				{
   545| 					setEventMessages(null, array($langs->trans('MvtNotCorrectlyBalanced', $total_credit, $total_debit)), 'warnings');
   546| 				}
   547| 				if ($action == "" || $action == 'add') {
   548| 					print '<tr class="oddeven">';
   549| 					print '<td>';
   550| 					print $formaccounting->select_account($account_number, 'account_number', 1, array (), 1, 1, '');
   551| 					print '</td>';
   552| 					print '<td>';
   553| 					if (! empty($conf->global->ACCOUNTANCY_COMBO_FOR_AUX))
   554| 					{
   555| 						print $formaccounting->select_auxaccount($subledger_account, 'subledger_account', 1);
   556| 					}
   557| 					else
   558| 					{
   559| 						print '<input type="text" name="subledger_account" value="">';
   560| 					}
   561| 					print '</td>';
   562| 					print '<td><input type="text" class="minwidth100" name="label_compte" value="' . $line->label_compte . '"/></td>';
   563| 					print '<td><input type="text" class="minwidth300" name="label_operation" value="' . $line->label_operation. '"/></td>';
   564| 					print '<td align="right"><input type="text" size="6" class="right" name="debit" value="' . ($debit ? price($debit) : '') . '"/></td>';
   565| 					print '<td align="right"><input type="text" size="6" class="right" name="credit" value="' . ($credit ? price($credit) : '') . '"/></td>';
   566| 					print '<td><input type="submit" class="button" name="save" value="' . $langs->trans("Add") . '"></td>';
   567| 					print '</tr>';
   568| 				}
   569| 				print '</table>';
   570| 				if ($mode=='_tmp' && $action=='')
   571| 				{
   572| 					print '<br>';
   573| 					print '<div class="center">';
   574| 					if ($total_debit == $total_credit)
   575| 					{
   576| 						print '<a class="button" href="' . $_SERVER["PHP_SELF"] . '?piece_num=' . $book->piece_num . '&action=valid">'.$langs->trans("ValidTransaction").'</a>';
   577| 					}
   578| 					else
   579| 					{
   580| 						print '<input type="submit" class="button" disabled="disabled" href="#" title="'.dol_escape_htmltag($langs->trans("MvtNotCorrectlyBalanced", $credit, $debit)).'" value="'.dol_escape_htmltag($langs->trans("ValidTransaction")).'">';
   581| 					}
   582| 					print ' &nbsp; ';
   583| 					print '<a class="button" href="' . DOL_URL_ROOT.'/accountancy/bookkeeping/list.php">'.$langs->trans("Cancel").'</a>';


# ====================================================================
# FILE: htdocs/accountancy/bookkeeping/list.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 18-108 ---
    18|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    19|  */
    20| /**
    21|  * \file		htdocs/accountancy/bookkeeping/list.php
    22|  * \ingroup		Advanced accountancy
    23|  * \brief 		List operation of book keeping
    24|  */
    25| require '../../main.inc.php';
    26| require_once DOL_DOCUMENT_ROOT . '/accountancy/class/accountancyexport.class.php';
    27| require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
    28| require_once DOL_DOCUMENT_ROOT . '/accountancy/class/bookkeeping.class.php';
    29| require_once DOL_DOCUMENT_ROOT . '/accountancy/class/accountingjournal.class.php';
    30| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formother.class.php';
    31| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formaccounting.class.php';
    32| require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
    33| $langs->load("accountancy");
    34| $action = GETPOST('action', 'alpha');
    35| $search_mvt_num = GETPOST('search_mvt_num', 'int');
    36| $search_doc_type = GETPOST("search_doc_type");
    37| $search_doc_ref = GETPOST("search_doc_ref");
    38| $search_date_start = dol_mktime(0, 0, 0, GETPOST('date_startmonth', 'int'), GETPOST('date_startday', 'int'), GETPOST('date_startyear', 'int'));
    39| $search_date_end = dol_mktime(0, 0, 0, GETPOST('date_endmonth', 'int'), GETPOST('date_endday', 'int'), GETPOST('date_endyear', 'int'));
    40| $search_doc_date = dol_mktime(0, 0, 0, GETPOST('doc_datemonth', 'int'), GETPOST('doc_dateday', 'int'), GETPOST('doc_dateyear', 'int'));
    41| $search_date_creation_start = dol_mktime(0, 0, 0, GETPOST('date_creation_startmonth', 'int'), GETPOST('date_creation_startday', 'int'), GETPOST('date_creation_startyear', 'int'));
    42| $search_date_creation_end = dol_mktime(0, 0, 0, GETPOST('date_creation_endmonth', 'int'), GETPOST('date_creation_endday', 'int'), GETPOST('date_creation_endyear', 'int'));
    43| $search_date_modification_start = dol_mktime(0, 0, 0, GETPOST('date_modification_startmonth', 'int'), GETPOST('date_modification_startday', 'int'), GETPOST('date_modification_startyear', 'int'));
    44| $search_date_modification_end = dol_mktime(0, 0, 0, GETPOST('date_modification_endmonth', 'int'), GETPOST('date_modification_endday', 'int'), GETPOST('date_modification_endyear', 'int'));
    45| if (GETPOST("button_delmvt_x") || GETPOST("button_delmvt.x") || GETPOST("button_delmvt")) {
    46| 	$action = 'delbookkeepingyear';
    47| }
    48| if (GETPOST("button_export_file_x") || GETPOST("button_export_file.x") || GETPOST("button_export_file")) {
    49| 	$action = 'export_file';
    50| }
    51| $search_accountancy_code = GETPOST("search_accountancy_code");
    52| $search_accountancy_code_start = GETPOST('search_accountancy_code_start', 'alpha');
    53| if ($search_accountancy_code_start == - 1) {
    54| 	$search_accountancy_code_start = '';
    55| }
    56| $search_accountancy_code_end = GETPOST('search_accountancy_code_end', 'alpha');
    57| if ($search_accountancy_code_end == - 1) {
    58| 	$search_accountancy_code_end = '';
    59| }
    60| $search_accountancy_aux_code = GETPOST("search_accountancy_aux_code");
    61| $search_accountancy_aux_code_start = GETPOST('search_accountancy_aux_code_start', 'alpha');
    62| if ($search_accountancy_aux_code_start == - 1) {
    63| 	$search_accountancy_aux_code_start = '';
    64| }
    65| $search_accountancy_aux_code_end = GETPOST('search_accountancy_aux_code_end', 'alpha');
    66| if ($search_accountancy_aux_code_end == - 1) {
    67| 	$search_accountancy_aux_code_end = '';
    68| }
    69| $search_mvt_label = GETPOST('search_mvt_label', 'alpha');
    70| $search_direction = GETPOST('search_direction', 'alpha');
    71| $search_ledger_code = GETPOST('search_ledger_code', 'alpha');
    72| $limit = GETPOST('limit','int')?GETPOST('limit', 'int'):(empty($conf->global->ACCOUNTING_LIMIT_LIST_VENTILATION)?$conf->liste_limit:$conf->global->ACCOUNTING_LIMIT_LIST_VENTILATION);
    73| $sortfield = GETPOST('sortfield', 'alpha');
    74| $sortorder = GETPOST('sortorder', 'alpha');
    75| $page = GETPOST('page','int');
    76| if (empty($page) || $page < 0) { $page = 0; }
    77| $offset = $limit * $page;
    78| $pageprev = $page - 1;
    79| $pagenext = $page + 1;
    80| if ($sortorder == "") $sortorder = "ASC";
    81| if ($sortfield == "") $sortfield = "t.piece_num,t.rowid";
    82| $object = new BookKeeping($db);
    83| $formaccounting = new FormAccounting($db);
    84| $formother = new FormOther($db);
    85| $form = new Form($db);
    86| if (! in_array($action, array('export_file', 'delmouv', 'delmouvconfirm')) && ! isset($_POST['begin']) && ! isset($_GET['begin']) && ! isset($_POST['formfilteraction']) && GETPOST('page','int') == '' && ! GETPOST('noreset','int'))
    87| {
    88| 	if (empty($search_date_start) && empty($search_date_end))
    89| 	{
    90| 		$query = "SELECT date_start, date_end from ".MAIN_DB_PREFIX."accounting_fiscalyear ";
    91| 		$query.= " where date_start < '".$db->idate(dol_now())."' and date_end > '".$db->idate(dol_now())."' limit 1";
    92| 		$res = $db->query($query);
    93| 		if ($res->num_rows > 0) {
    94| 			$fiscalYear = $db->fetch_object($res);
    95| 			$search_date_start = strtotime($fiscalYear->date_start);
    96| 			$search_date_end = strtotime($fiscalYear->date_end);
    97| 		} else {
    98| 			$month_start= ($conf->global->SOCIETE_FISCAL_MONTH_START?($conf->global->SOCIETE_FISCAL_MONTH_START):1);
    99| 			$year_start = dol_print_date(dol_now(), '%Y');
   100| 			if (dol_print_date(dol_now(), '%m') < $month_start) $year_start--;	// If current month is lower that starting fiscal month, we start last year
   101| 			$year_end = $year_start + 1;
   102| 			$month_end = $month_start - 1;
   103| 			if ($month_end < 1)
   104| 			{
   105| 				$month_end = 12;
   106| 				$year_end--;
   107| 			}
   108| 			$search_date_start = dol_mktime(0, 0, 0, $month_start, 1, $year_start);

# --- HUNK 2: Lines 141-267 ---
   141| 	$search_accountancy_aux_code = '';
   142| 	$search_accountancy_aux_code_start = '';
   143| 	$search_accountancy_aux_code_end = '';
   144| 	$search_mvt_label = '';
   145| 	$search_direction = '';
   146| 	$search_ledger_code = '';
   147| 	$search_date_start = '';
   148| 	$search_date_end = '';
   149| 	$search_date_creation_start = '';
   150| 	$search_date_creation_end = '';
   151| 	$search_date_modification_start = '';
   152| 	$search_date_modification_end = '';
   153| 	$search_debit = '';
   154| 	$search_credit = '';
   155| }
   156| $param = '';
   157| $filter = array ();
   158| if (! empty($search_date_start)) {
   159| 	$filter['t.doc_date>='] = $search_date_start;
   160| 	$tmp=dol_getdate($search_date_start);
   161| 	$param .= '&date_startmonth=' . $tmp['mon'] . '&date_startday=' . $tmp['mday'] . '&date_startyear=' . $tmp['year'];
   162| }
   163| if (! empty($search_date_end)) {
   164| 	$filter['t.doc_date<='] = $search_date_end;
   165| 	$tmp=dol_getdate($search_date_end);
   166| 	$param .= '&date_endmonth=' . $tmp['mon'] . '&date_endday=' . $tmp['mday'] . '&date_endyear=' . $tmp['year'];
   167| }
   168| if (! empty($search_doc_date)) {
   169| 	$filter['t.doc_date'] = $search_doc_date;
   170| 	$tmp=dol_getdate($search_doc_date);
   171| 	$param .= '&doc_datemonth=' . $tmp['mon'] . '&doc_dateday=' . $tmp['mday'] . '&doc_dateyear=' . $tmp['year'];
   172| }
   173| if (! empty($search_doc_type)) {
   174| 	$filter['t.doc_type'] = $search_doc_type;
   175| 	$param .= '&search_doc_type=' . $search_doc_type;
   176| }
   177| if (! empty($search_doc_ref)) {
   178| 	$filter['t.doc_ref'] = $search_doc_ref;
   179| 	$param .= '&search_doc_ref=' . $search_doc_ref;
   180| }
   181| if (! empty($search_accountancy_code)) {
   182| 	$filter['t.numero_compte'] = $search_accountancy_code;
   183| 	$param .= '&search_accountancy_code=' . $search_accountancy_code;
   184| }
   185| if (! empty($search_accountancy_code_start)) {
   186| 	$filter['t.numero_compte>='] = $search_accountancy_code_start;
   187| 	$param .= '&search_accountancy_code_start=' . $search_accountancy_code_start;
   188| }
   189| if (! empty($search_accountancy_code_end)) {
   190| 	$filter['t.numero_compte<='] = $search_accountancy_code_end;
   191| 	$param .= '&search_accountancy_code_end=' . $search_accountancy_code_end;
   192| }
   193| if (! empty($search_accountancy_aux_code)) {
   194| 	$filter['t.subledger_account'] = $search_accountancy_aux_code;
   195| 	$param .= '&search_accountancy_aux_code=' . $search_accountancy_aux_code;
   196| }
   197| if (! empty($search_accountancy_aux_code_start)) {
   198| 	$filter['t.subledger_account>='] = $search_accountancy_aux_code_start;
   199| 	$param .= '&search_accountancy_aux_code_start=' . $search_accountancy_aux_code_start;
   200| }
   201| if (! empty($search_accountancy_aux_code_end)) {
   202| 	$filter['t.subledger_account<='] = $search_accountancy_aux_code_end;
   203| 	$param .= '&search_accountancy_aux_code_end=' . $search_accountancy_aux_code_end;
   204| }
   205| if (! empty($search_mvt_label)) {
   206| 	$filter['t.label_operation'] = $search_mvt_label;
   207| 	$param .= '&search_mvt_label=' . $search_mvt_label;
   208| }
   209| if (! empty($search_direction)) {
   210| 	$filter['t.sens'] = $search_direction;
   211| 	$param .= '&search_direction=' . $search_direction;
   212| }
   213| if (! empty($search_ledger_code)) {
   214| 	$filter['t.code_journal'] = $search_ledger_code;
   215| 	$param .= '&search_ledger_code=' . $search_ledger_code;
   216| }
   217| if (! empty($search_mvt_num)) {
   218| 	$filter['t.piece_num'] = $search_mvt_num;
   219| 	$param .= '&search_mvt_num=' . $search_mvt_num;
   220| }
   221| if (! empty($search_date_creation_start)) {
   222| 	$filter['t.date_creation>='] = $search_date_creation_start;
   223| 	$tmp=dol_getdate($search_date_creation_start);
   224| 	$param .= '&date_creation_startmonth=' . $tmp['mon'] . '&date_creation_startday=' . $tmp['mday'] . '&date_creation_startyear=' . $tmp['year'];
   225| }
   226| if (! empty($search_date_creation_end)) {
   227| 	$filter['t.date_creation<='] = $search_date_creation_end;
   228| 	$tmp=dol_getdate($search_date_creation_end);
   229| 	$param .= '&date_creation_endmonth=' . $tmp['mon'] . '&date_creation_endday=' . $tmp['mday'] . '&date_creation_endyear=' . $tmp['year'];
   230| }
   231| if (! empty($search_date_modification_start)) {
   232| 	$filter['t.tms>='] = $search_date_modification_start;
   233| 	$tmp=dol_getdate($search_date_modification_start);
   234| 	$param .= '&date_modification_startmonth=' . $tmp['mon'] . '&date_modification_startday=' . $tmp['mday'] . '&date_modification_startyear=' . $tmp['year'];
   235| }
   236| if (! empty($search_date_modification_end)) {
   237| 	$filter['t.tms<='] = $search_date_modification_end;
   238| 	$tmp=dol_getdate($search_date_modification_end);
   239| 	$param .= '&date_modification_endmonth=' . $tmp['mon'] . '&date_modification_endday=' . $tmp['mday'] . '&date_modification_endyear=' . $tmp['year'];
   240| }
   241| if (! empty($search_debit)) {
   242| 	$filter['t.debit'] = $search_debit;
   243| 	$param .= '&search_debit=' . $search_debit;
   244| }
   245| if (! empty($search_credit)) {
   246| 	$filter['t.credit'] = $search_credit;
   247| 	$param .= '&search_credit=' . $search_credit;
   248| }
   249| if ($action == 'delbookkeeping') {
   250| 	$import_key = GETPOST('importkey', 'alpha');
   251| 	if (! empty($import_key)) {
   252| 		$result = $object->deleteByImportkey($import_key);
   253| 		if ($result < 0) {
   254| 			setEventMessages($object->error, $object->errors, 'errors');
   255| 		}
   256| 		Header("Location: list.php");
   257| 		exit();
   258| 	}
   259| }
   260| if ($action == 'delbookkeepingyearconfirm') {
   261| 	$delyear = GETPOST('delyear', 'int');
   262| 	if ($delyear==-1) {
   263| 		$delyear=0;
   264| 	}
   265| 	$deljournal = GETPOST('deljournal','alpha');
   266| 	if ($deljournal==-1) {
   267| 		$deljournal=0;

# --- HUNK 3: Lines 380-424 ---
   380| else $button.= $langs->trans("ExportList");
   381| $button.= '</a>';
   382| $groupby = ' <a class="nohover" href="'.DOL_URL_ROOT.'/accountancy/bookkeeping/listbyaccount.php?'.$param.'">' . $langs->trans("GroupByAccountAccounting") . '</a>';
   383| $addbutton = '<a class="butAction" href="./card.php?action=create">' . $langs->trans("NewAccountingMvt") . '</a>';
   384| print_barre_liste($title_page, $page, $_SERVER["PHP_SELF"], $param, $sortfield, $sortorder, $button, $result, $nbtotalofrecords, 'title_accountancy', 0, $groupby.$addbutton, '', $limit);
   385| $varpage=empty($contextpage)?$_SERVER["PHP_SELF"]:$contextpage;
   386| $selectedfields=$form->multiSelectArrayWithCheckbox('selectedfields', $arrayfields, $varpage);	// This also change content of $arrayfields
   387| if ($massactionbutton) $selectedfields.=$form->showCheckAddButtons('checkforselect', 1);
   388| print '<div class="div-table-responsive">';
   389| print '<table class="tagtable liste" width="100%">';
   390| print '<tr class="liste_titre_filter">';
   391| if (! empty($arrayfields['t.piece_num']['checked']))
   392| {
   393| 	print '<td class="liste_titre"><input type="text" name="search_mvt_num" size="6" value="' . dol_escape_htmltag($search_mvt_num) . '"></td>';
   394| }
   395| if (! empty($arrayfields['t.doc_date']['checked']))
   396| {
   397| 	print '<td class="liste_titre center">';
   398| 	print '<div class="nowrap">';
   399| 	print $langs->trans('From') . ' ';
   400| 	print $form->select_date($search_date_start?$search_date_start:-1, 'date_start', 0, 0, 1);
   401| 	print '</div>';
   402| 	print '<div class="nowrap">';
   403| 	print $langs->trans('to') . ' ';
   404| 	print $form->select_date($search_date_end?$search_date_end:-1, 'date_end', 0, 0, 1);
   405| 	print '</div>';
   406| 	print '</td>';
   407| }
   408| if (! empty($arrayfields['t.doc_ref']['checked']))
   409| {
   410| 	print '<td class="liste_titre"><input type="text" name="search_doc_ref" size="8" value="' . dol_escape_htmltag($search_doc_ref) . '"></td>';
   411| }
   412| if (! empty($arrayfields['t.numero_compte']['checked']))
   413| {
   414| 	print '<td class="liste_titre">';
   415| 	print '<div class="nowrap">';
   416| 	print $langs->trans('From').' ';
   417| 	print $formaccounting->select_account($search_accountancy_code_start, 'search_accountancy_code_start', 1, array (), 1, 1, 'maxwidth200');
   418| 	print '</div>';
   419| 	print '<div class="nowrap">';
   420| 	print $langs->trans('to').' ';
   421| 	print $formaccounting->select_account($search_accountancy_code_end, 'search_accountancy_code_end', 1, array (), 1, 1, 'maxwidth200');
   422| 	print '</div>';
   423| 	print '</td>';
   424| }

# --- HUNK 4: Lines 511-551 ---
   511| if (! empty($arrayfields['t.label_operation']['checked']))		print_liste_field_titre($arrayfields['t.label_operation']['label'], $_SERVER['PHP_SELF'], "t.label_operation", "", $param, "", $sortfield, $sortorder);
   512| if (! empty($arrayfields['t.debit']['checked']))				print_liste_field_titre($arrayfields['t.debit']['label'], $_SERVER['PHP_SELF'], "t.debit", "", $param, 'align="right"', $sortfield, $sortorder);
   513| if (! empty($arrayfields['t.credit']['checked']))				print_liste_field_titre($arrayfields['t.credit']['label'], $_SERVER['PHP_SELF'], "t.credit", "", $param, 'align="right"', $sortfield, $sortorder);
   514| if (! empty($arrayfields['t.code_journal']['checked']))			print_liste_field_titre($arrayfields['t.code_journal']['label'], $_SERVER['PHP_SELF'], "t.code_journal", "", $param, 'align="center"', $sortfield, $sortorder);
   515| if (! empty($arrayfields['t.date_creation']['checked']))		print_liste_field_titre($arrayfields['t.date_creation']['label'], $_SERVER['PHP_SELF'], "t.date_creation", "", $param, 'align="center"', $sortfield, $sortorder);
   516| if (! empty($arrayfields['t.tms']['checked']))					print_liste_field_titre($arrayfields['t.tms']['label'], $_SERVER['PHP_SELF'], "t.tms", "", $param, 'align="center"', $sortfield, $sortorder);
   517| print_liste_field_titre($selectedfields, $_SERVER["PHP_SELF"],"",'','','align="center"',$sortfield,$sortorder,'maxwidthsearch ');
   518| print "</tr>\n";
   519| if ($num > 0)
   520| {
   521| 	$i=0;
   522| 	$totalarray=array();
   523| 	while ($i < min($num, $limit))
   524| 	{
   525| 		$line = $object->lines[$i];
   526| 		$total_debit += $line->debit;
   527| 		$total_credit += $line->credit;
   528| 		print '<tr class="oddeven">';
   529| 		if (! empty($arrayfields['t.piece_num']['checked']))
   530| 		{
   531| 			print '<td><a href="./card.php?piece_num=' . $line->piece_num . '">' . $line->piece_num . '</a></td>';
   532| 			if (! $i) $totalarray['nbfield']++;
   533| 		}
   534| 		if (! empty($arrayfields['t.doc_date']['checked']))
   535| 		{
   536| 			print '<td align="center">' . dol_print_date($line->doc_date, 'day') . '</td>';
   537| 			if (! $i) $totalarray['nbfield']++;
   538| 		}
   539| 		if (! empty($arrayfields['t.doc_ref']['checked']))
   540| 		{
   541| 			print '<td class="nowrap">' . $line->doc_ref . '</td>';
   542| 			if (! $i) $totalarray['nbfield']++;
   543| 		}
   544| 		if (! empty($arrayfields['t.numero_compte']['checked']))
   545| 		{
   546| 			print '<td>' . length_accountg($line->numero_compte) . '</td>';
   547| 			if (! $i) $totalarray['nbfield']++;
   548| 		}
   549| 		if (! empty($arrayfields['t.subledger_account']['checked']))
   550| 		{
   551| 			print '<td>' . length_accounta($line->subledger_account) . '</td>';


# ====================================================================
# FILE: htdocs/accountancy/class/bookkeeping.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 291-330 ---
   291| 			}
   292| 		} else {
   293| 			$result = -5;
   294| 			$error ++;
   295| 			$this->errors[] = 'Error ' . $this->db->lasterror();
   296| 			dol_syslog(__METHOD__ . ' ' . join(',', $this->errors), LOG_ERR);
   297| 		}
   298| 		if (! $error) {
   299| 			if (! $notrigger) {
   300| 			}
   301| 		}
   302| 		if ($error) {
   303| 			$this->db->rollback();
   304| 			return -1 * $error;
   305| 		} else {
   306| 			$this->db->commit();
   307| 			return $result;
   308| 		}
   309| 	}
   310| 	/**
   311| 	 * Create object into database
   312| 	 *
   313| 	 * @param  User	$user	   User that creates
   314| 	 * @param  bool	$notrigger  false=launch triggers after, true=disable triggers
   315| 	 * @param  string  $mode 	   Mode
   316| 	 * @return int				 <0 if KO, Id of created object if OK
   317| 	 */
   318| 	public function createStd(User $user, $notrigger = false, $mode='') {
   319| 		global $conf;
   320| 		dol_syslog(__METHOD__, LOG_DEBUG);
   321| 		$error = 0;
   322| 		if (isset($this->doc_type)) {
   323| 			$this->doc_type = trim($this->doc_type);
   324| 		}
   325| 		if (isset($this->doc_ref)) {
   326| 			$this->doc_ref = trim($this->doc_ref);
   327| 		}
   328| 		if (isset($this->fk_doc)) {
   329| 			$this->fk_doc = trim($this->fk_doc);
   330| 		}

# --- HUNK 2: Lines 687-733 ---
   687| 		$sql .= " t.date_creation,";
   688| 		$sql .= " t.tms as date_modification";
   689| 		$sql .= ' FROM ' . MAIN_DB_PREFIX . $this->table_element . ' as t';
   690| 		$sqlwhere = array ();
   691| 		if (count($filter) > 0) {
   692| 			foreach ( $filter as $key => $value ) {
   693| 				if ($key == 't.doc_date') {
   694| 					$sqlwhere[] = $key . '=\'' . $this->db->idate($value) . '\'';
   695| 				} elseif ($key == 't.doc_date>=' || $key == 't.doc_date<=') {
   696| 					$sqlwhere[] = $key . '\'' . $this->db->idate($value) . '\'';
   697| 				} elseif ($key == 't.numero_compte>=' || $key == 't.numero_compte<=' || $key == 't.subledger_account>=' || $key == 't.subledger_account<=') {
   698| 					$sqlwhere[] = $key . '\'' . $this->db->escape($value) . '\'';
   699| 				} elseif ($key == 't.fk_doc' || $key == 't.fk_docdet' || $key == 't.piece_num') {
   700| 					$sqlwhere[] = $key . '=' . $value;
   701| 				} elseif ($key == 't.subledger_account' || $key == 't.numero_compte') {
   702| 					$sqlwhere[] = $key . ' LIKE \'' . $this->db->escape($value) . '%\'';
   703| 				} elseif ($key == 't.date_creation>=' || $key == 't.date_creation<=') {
   704| 					$sqlwhere[] = $key . '\'' . $this->db->idate($value) . '\'';
   705| 				} elseif ($key == 't.tms>=' || $key == 't.tms<=') {
   706| 					$sqlwhere[] = $key . '\'' . $this->db->idate($value) . '\'';
   707| 				} else {
   708| 					$sqlwhere[] = $key . ' LIKE \'%' . $this->db->escape($value) . '%\'';
   709| 				}
   710| 			}
   711| 		}
   712| 		$sql.= ' WHERE 1 = 1';
   713| 		$sql .= " AND entity IN (" . getEntity('accountancy') . ")";
   714| 		if (count($sqlwhere) > 0) {
   715| 			$sql .= ' AND ' . implode(' ' . $filtermode . ' ', $sqlwhere);
   716| 		}
   717| 		if (! empty($sortfield)) {
   718| 			$sql .= $this->db->order($sortfield, $sortorder);
   719| 		}
   720| 		if (! empty($limit)) {
   721| 			$sql .= ' ' . $this->db->plimit($limit + 1, $offset);
   722| 		}
   723| 		$this->lines = array();
   724| 		$resql = $this->db->query($sql);
   725| 		if ($resql) {
   726| 			$num = $this->db->num_rows($resql);
   727| 			while ( $obj = $this->db->fetch_object($resql) ) {
   728| 				$line = new BookKeepingLine();
   729| 				$line->id = $obj->rowid;
   730| 				$line->doc_date = $this->db->jdate($obj->doc_date);
   731| 				$line->doc_type = $obj->doc_type;
   732| 				$line->doc_ref = $obj->doc_ref;
   733| 				$line->fk_doc = $obj->fk_doc;


# ====================================================================
# FILE: htdocs/accountancy/customer/index.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 23-198 ---
    23|  * \file 	htdocs/accountancy/customer/index.php
    24|  * \ingroup Advanced accountancy
    25|  * \brief 	Home customer journalization page
    26|  */
    27| require '../../main.inc.php';
    28| require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
    29| require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
    30| require_once DOL_DOCUMENT_ROOT . '/compta/facture/class/facture.class.php';
    31| $langs->load("compta");
    32| $langs->load("bills");
    33| $langs->load("other");
    34| $langs->load("main");
    35| $langs->load("accountancy");
    36| if (empty($conf->accounting->enabled)) {
    37| 	accessforbidden();
    38| }
    39| if ($user->societe_id > 0)
    40| 	accessforbidden();
    41| if (! $user->rights->accounting->bind->write)
    42| 	accessforbidden();
    43| $year = GETPOST("year",'int');
    44| if ($year == 0) {
    45| 	$year_current = strftime("%Y", time());
    46| 	$year_start = $year_current;
    47| } else {
    48| 	$year_current = $year;
    49| 	$year_start = $year;
    50| }
    51| $action = GETPOST('action','aZ09');
    52| /*
    53|  * Actions
    54|  */
    55| if ($action == 'validatehistory') {
    56| 	$error = 0;
    57| 	$db->begin();
    58| 	$sqlclean = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
    59| 	$sqlclean .= " SET fk_code_ventilation = 0";
    60| 	$sqlclean .= ' WHERE fd.fk_code_ventilation NOT IN ';
    61| 	$sqlclean .= '	(SELECT accnt.rowid ';
    62| 	$sqlclean .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
    63| 	$sqlclean .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
    64| 	$sqlclean .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
    65| 	$resql = $db->query($sqlclean);
    66| 	if ($db->type == 'pgsql') {
    67| 		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet";
    68| 		$sql1 .= " SET fk_code_ventilation = accnt.rowid";
    69| 		$sql1 .= " FROM " . MAIN_DB_PREFIX . "product as p, " . MAIN_DB_PREFIX . "accounting_account as accnt , " . MAIN_DB_PREFIX . "accounting_system as syst";
    70| 		$sql1 .= " WHERE " . MAIN_DB_PREFIX . "facturedet.fk_product = p.rowid  AND accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=" . $conf->global->CHARTOFACCOUNTS;
    71| 		$sql1 .= " AND accnt.active = 1 AND p.accountancy_code_sell=accnt.account_number";
    72| 		$sql1 .= " AND " . MAIN_DB_PREFIX . "facturedet.fk_code_ventilation = 0";
    73| 	} else {
    74| 		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd, " . MAIN_DB_PREFIX . "product as p, " . MAIN_DB_PREFIX . "accounting_account as accnt , " . MAIN_DB_PREFIX . "accounting_system as syst";
    75| 		$sql1 .= " SET fk_code_ventilation = accnt.rowid";
    76| 		$sql1 .= " WHERE fd.fk_product = p.rowid  AND accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=" . $conf->global->CHARTOFACCOUNTS;
    77| 		$sql1 .= " AND accnt.active = 1 AND p.accountancy_code_sell=accnt.account_number";
    78| 		$sql1 .= " AND fd.fk_code_ventilation = 0";
    79| 	}
    80| 	dol_syslog('htdocs/accountancy/customer/index.php');
    81| 	$resql1 = $db->query($sql1);
    82| 	if (! $resql1) {
    83| 		$error ++;
    84| 		$db->rollback();
    85| 		setEventMessages($db->lasterror(), null, 'errors');
    86| 	} else {
    87| 		$db->commit();
    88| 		setEventMessages($langs->trans('AutomaticBindingDone'), null, 'mesgs');
    89| 	}
    90| } elseif ($action == 'cleanaccountancycode') {
    91| 	$error = 0;
    92| 	$db->begin();
    93| 	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
    94| 	$sql1.= " SET fk_code_ventilation = 0";
    95| 	$sql1.= " WHERE fd.fk_facture IN ( SELECT f.rowid FROM " . MAIN_DB_PREFIX . "facture as f";
    96| 	$sql1.= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($year_current, 1, false)) . "'";
    97| 	$sql1.= " AND f.datef <= '" . $db->idate(dol_get_last_day($year_current, 12, false)) . "'";
    98| 	$sql1.= " AND f.entity IN (" . getEntity('accountancy') . ")";
    99| 	$sql1.=")";
   100| 	dol_syslog("htdocs/accountancy/customer/index.php cleanaccountancycode", LOG_DEBUG);
   101| 	$resql1 = $db->query($sql1);
   102| 	if (! $resql1) {
   103| 		$error ++;
   104| 		$db->rollback();
   105| 		setEventMessage($db->lasterror(), 'errors');
   106| 	} else {
   107| 		$db->commit();
   108| 		setEventMessage($langs->trans('Done'), 'mesgs');
   109| 	}
   110| }
   111| /*
   112|  * View
   113|  */
   114| llxHeader('', $langs->trans("CustomersVentilation"));
   115| $textprevyear = '<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current - 1) . '">' . img_previous() . '</a>';
   116| $textnextyear = '&nbsp;<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current + 1) . '">' . img_next() . '</a>';
   117| print load_fiche_titre($langs->trans("CustomersVentilation") . " " . $textprevyear . " " . $langs->trans("Year") . " " . $year_start . " " . $textnextyear, '', 'title_accountancy');
   118| $db->begin();
   119| $sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
   120| $sql1 .= " SET fk_code_ventilation = 0";
   121| $sql1 .= ' WHERE fd.fk_code_ventilation NOT IN ';
   122| $sql1 .= '	(SELECT accnt.rowid ';
   123| $sql1 .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
   124| $sql1 .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
   125| $sql1 .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
   126| dol_syslog("htdocs/accountancy/customer/index.php fixaccountancycode", LOG_DEBUG);
   127| $resql1 = $db->query($sql1);
   128| if (! $resql1) {
   129| 	$error ++;
   130| 	$db->rollback();
   131| 	setEventMessage($db->lasterror(), 'errors');
   132| } else {
   133| 	$db->commit();
   134| }
   135| print $langs->trans("DescVentilCustomer") . '<br>';
   136| print $langs->trans("DescVentilMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
   137| print '<br>';
   138| $sql = "SELECT count(*) FROM " . MAIN_DB_PREFIX . "facturedet as fd";
   139| $sql .= " , " . MAIN_DB_PREFIX . "facture as f";
   140| $sql .= " WHERE fd.fk_code_ventilation = 0";
   141| $sql .= " AND f.rowid = fd.fk_facture";
   142| $sql .= " AND f.fk_statut > 0";
   143| if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
   144| 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
   145| } else {
   146| 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
   147| }
   148| $sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";	// We don't share object for accountancy
   149| dol_syslog('htdocs/accountancy/customer/index.php');
   150| $result = $db->query($sql);
   151| if ($result) {
   152| 	$row = $db->fetch_row($result);
   153| 	$nbfac = $row[0];
   154| 	$db->free($result);
   155| }
   156| $y = $year_current;
   157| $buttonbind = '<a class="butAction" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=validatehistory">' . $langs->trans("ValidateHistory") . '</a>';
   158| $buttonreset = '<a class="butActionDelete" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=cleanaccountancycode">' . $langs->trans("CleanHistory", $year_current) . '</a>';
   159| print_fiche_titre($langs->trans("OverviewOfAmountOfLinesNotBound"), $buttonbind, '');
   160| print '<div class="div-table-responsive-no-min">';
   161| print '<table class="noborder" width="100%">';
   162| print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
   163| print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
   164| for($i = 1; $i <= 12; $i ++) {
   165| 	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   166| }
   167| print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   168| $sql = "SELECT " . $db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') . " AS codecomptable,";
   169| $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
   170| for($i = 1; $i <= 12; $i ++) {
   171| 	$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, 'fd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   172| }
   173| $sql .= "  SUM(fd.total_ht) as total";
   174| $sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
   175| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
   176| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = fd.fk_code_ventilation";
   177| $sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   178| $sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   179| $sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";   // We don't share object for accountancy
   180| $sql .= " AND aa.account_number IS NULL";
   181| if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
   182| 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
   183| } else {
   184| 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
   185| }
   186| $sql .= " GROUP BY fd.fk_code_ventilation,aa.account_number,aa.label";
   187| dol_syslog('htdocs/accountancy/customer/index.php sql=' . $sql, LOG_DEBUG);
   188| $resql = $db->query($sql);
   189| if ($resql) {
   190| 	$num = $db->num_rows($resql);
   191| 	while ( $row = $db->fetch_row($resql)) {
   192| 		print '<tr class="oddeven"><td>';
   193| 		if ($row[0] == 'tobind')
   194| 		{
   195| 			print $langs->trans("Unknown");
   196| 		}
   197| 		else print length_accountg($row[0]);
   198| 		print '</td>';

# --- HUNK 2: Lines 200-363 ---
   200| 		if ($row[0] == 'tobind')
   201| 		{
   202| 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/customer/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
   203| 		}
   204| 		else print $row[1];
   205| 		print '</td>';
   206| 		for($i = 2; $i <= 12; $i ++) {
   207| 			print '<td align="right">' . price($row[$i]) . '</td>';
   208| 		}
   209| 		print '<td align="right">' . price($row[13]) . '</td>';
   210| 		print '<td align="right"><b>' . price($row[14]) . '</b></td>';
   211| 		print '</tr>';
   212| 	}
   213| 	$db->free($resql);
   214| } else {
   215| 	print $db->lasterror(); // Show last sql error
   216| }
   217| print "</table>\n";
   218| print '</div>';
   219| print '<br>';
   220| print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), $buttonreset, '');
   221| print '<div class="div-table-responsive-no-min">';
   222| print '<table class="noborder" width="100%">';
   223| print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
   224| print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
   225| for($i = 1; $i <= 12; $i ++) {
   226| 	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   227| }
   228| print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   229| $sql = "SELECT " . $db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') . " AS codecomptable,";
   230| $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
   231| for($i = 1; $i <= 12; $i ++) {
   232| 	$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, 'fd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   233| }
   234| $sql .= "  SUM(fd.total_ht) as total";
   235| $sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
   236| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
   237| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = fd.fk_code_ventilation";
   238| $sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   239| $sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   240| $sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";   // We don't share object for accountancy
   241| if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
   242| 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
   243| } else {
   244| 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
   245| }
   246| $sql .= " AND aa.account_number IS NOT NULL";
   247| $sql .= " GROUP BY fd.fk_code_ventilation,aa.account_number,aa.label";
   248| dol_syslog('htdocs/accountancy/customer/index.php');
   249| $resql = $db->query($sql);
   250| if ($resql) {
   251| 	$num = $db->num_rows($resql);
   252| 	while ( $row = $db->fetch_row($resql)) {
   253| 		print '<tr class="oddeven"><td>';
   254| 		if ($row[0] == 'tobind')
   255| 		{
   256| 			print $langs->trans("Unknown");
   257| 		}
   258| 		else print length_accountg($row[0]);
   259| 		print '</td>';
   260| 		print '<td align="left">';
   261| 		if ($row[0] == 'tobind')
   262| 		{
   263| 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/customer/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
   264| 		}
   265| 		else print $row[1];
   266| 		print '</td>';
   267| 		for($i = 2; $i <= 12; $i ++) {
   268| 			print '<td align="right">' . price($row[$i]) . '</td>';
   269| 		}
   270| 		print '<td align="right">' . price($row[13]) . '</td>';
   271| 		print '<td align="right"><b>' . price($row[14]) . '</b></td>';
   272| 		print '</tr>';
   273| 	}
   274| 	$db->free($resql);
   275| } else {
   276| 	print $db->lasterror(); // Show last sql error
   277| }
   278| print "</table>\n";
   279| print '</div>';
   280| if ($conf->global->MAIN_FEATURES_LEVEL > 0) // This part of code looks strange. Why showing a report that should rely on result of this step ?
   281| {
   282| 	print '<br>';
   283| 	print '<br>';
   284| 	print_fiche_titre($langs->trans("OtherInfo"), '', '');
   285| 	print '<div class="div-table-responsive-no-min">';
   286| 	print '<table class="noborder" width="100%">';
   287| 	print '<tr class="liste_titre"><td width="400" align="left">' . $langs->trans("TotalVente") . '</td>';
   288| 	for($i = 1; $i <= 12; $i ++) {
   289| 		print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   290| 	}
   291| 	print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   292| 	$sql = "SELECT '" . $langs->trans("TotalVente") . "' AS total,";
   293| 	for($i = 1; $i <= 12; $i ++) {
   294| 		$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, 'fd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   295| 	}
   296| 	$sql .= "  SUM(fd.total_ht) as total";
   297| 	$sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
   298| 	$sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
   299| 	$sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   300| 	$sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   301| 	$sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")"; // We don't share object for accountancy
   302| 	if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
   303| 		$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
   304| 	} else {
   305| 		$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
   306| 	}
   307| 	dol_syslog('htdocs/accountancy/customer/index.php');
   308| 	$resql = $db->query($sql);
   309| 	if ($resql) {
   310| 		$num = $db->num_rows($resql);
   311| 		while ($row = $db->fetch_row($resql)) {
   312| 			print '<tr><td>' . $row[0] . '</td>';
   313| 			for($i = 1; $i <= 12; $i ++) {
   314| 				print '<td align="right">' . price($row[$i]) . '</td>';
   315| 			}
   316| 			print '<td align="right"><b>' . price($row[13]) . '</b></td>';
   317| 			print '</tr>';
   318| 		}
   319| 		$db->free($resql);
   320| 	} else {
   321| 		print $db->lasterror(); // Show last sql error
   322| 	}
   323| 	print "</table>\n";
   324| 	print '</div>';
   325| 	if (! empty($conf->margin->enabled)) {
   326| 		print "<br>\n";
   327| 		print '<div class="div-table-responsive-no-min">';
   328| 		print '<table class="noborder" width="100%">';
   329| 		print '<tr class="liste_titre"><td width="400">' . $langs->trans("TotalMarge") . '</td>';
   330| 		for($i = 1; $i <= 12; $i ++) {
   331| 			print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   332| 		}
   333| 		print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   334| 		$sql = "SELECT '" . $langs->trans("Vide") . "' AS marge,";
   335| 		for($i = 1; $i <= 12; $i ++) {
   336| 			$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, '(fd.total_ht-(fd.qty * fd.buy_price_ht))', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   337| 		}
   338| 		$sql .= "  SUM((fd.total_ht-(fd.qty * fd.buy_price_ht))) as total";
   339| 		$sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
   340| 		$sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
   341| 		$sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   342| 		$sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   343| 		$sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";   // We don't share object for accountancy
   344| 		if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
   345| 			$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
   346| 		} else {
   347| 			$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
   348| 		}
   349| 		dol_syslog('htdocs/accountancy/customer/index.php');
   350| 		$resql = $db->query($sql);
   351| 		if ($resql) {
   352| 			$num = $db->num_rows($resql);
   353| 			while ($row = $db->fetch_row($resql)) {
   354| 				print '<tr><td>' . $row[0] . '</td>';
   355| 				for($i = 1; $i <= 12; $i ++) {
   356| 					print '<td align="right">' . price(price2num($row[$i])) . '</td>';
   357| 				}
   358| 				print '<td align="right"><b>' . price(price2num($row[13])) . '</b></td>';
   359| 				print '</tr>';
   360| 			}
   361| 			$db->free($resql);
   362| 		} else {
   363| 			print $db->lasterror(); // Show last sql error


# ====================================================================
# FILE: htdocs/accountancy/customer/lines.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 75-132 ---
    75|  * Actions
    76|  */
    77| if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') || GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
    78| {
    79|     $search_lineid = '';
    80| 	$search_ref = '';
    81| 	$search_invoice = '';
    82| 	$search_label = '';
    83| 	$search_desc = '';
    84| 	$search_amount = '';
    85| 	$search_account = '';
    86| 	$search_vat = '';
    87| 	$search_day = '';
    88| 	$search_month = '';
    89| 	$search_year = '';
    90| 	$search_country = '';
    91| 	$search_tvaintra = '';
    92| }
    93| if (is_array($changeaccount) && count($changeaccount) > 0) {
    94| 	$error = 0;
    95| 	$db->begin();
    96| 	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as l";
    97| 	$sql1 .= " SET l.fk_code_ventilation=" . GETPOST('account_parent','int');
    98| 	$sql1 .= ' WHERE l.rowid IN (' . implode(',', $changeaccount) . ')';
    99| 	dol_syslog('accountancy/customer/lines.php::changeaccount sql= ' . $sql1);
   100| 	$resql1 = $db->query($sql1);
   101| 	if (! $resql1) {
   102| 		$error ++;
   103| 		setEventMessages($db->lasterror(), null, 'errors');
   104| 	}
   105| 	if (! $error) {
   106| 		$db->commit();
   107| 		setEventMessages($langs->trans('Save'), null, 'mesgs');
   108| 	} else {
   109| 		$db->rollback();
   110| 		setEventMessages($db->lasterror(), null, 'errors');
   111| 	}
   112| 	$account_parent = '';   // Protection to avoid to mass apply it a second time
   113| }
   114| /*
   115|  * View
   116|  */
   117| $form = new Form($db);
   118| $formother = new FormOther($db);
   119| llxHeader('', $langs->trans("CustomersVentilation") . ' - ' . $langs->trans("Dispatched"));
   120| print '<script type="text/javascript">
   121| 			$(function () {
   122| 				$(\'#select-all\').click(function(event) {
   123| 				    $(\':checkbox\').each(function() {
   124| 				    	this.checked = true;
   125| 				    });
   126| 			    });
   127| 			    $(\'#unselect-all\').click(function(event) {
   128| 				    $(\':checkbox\').each(function() {
   129| 				    	this.checked = false;
   130| 				    });
   131| 			    });
   132| 			});

# --- HUNK 2: Lines 218-258 ---
   218| 	if ($search_label)		$param .= "&search_label=" . urlencode($search_label);
   219| 	if ($search_desc)		$param .= "&search_desc=" . urlencode($search_desc);
   220| 	if ($search_account)	$param .= "&search_account=" . urlencode($search_account);
   221| 	if ($search_vat)		$param .= "&search_vat=" . urlencode($search_vat);
   222| 	if ($search_day)        $param .= '&search_day='.urlencode($search_day);
   223| 	if ($search_month)      $param .= '&search_month='.urlencode($search_month);
   224| 	if ($search_year)       $param .= '&search_year='.urlencode($search_year);
   225| 	if ($search_country)  	$param .= "&search_country=" . urlencode($search_country);
   226| 	if ($search_tvaintra)	$param .= "&search_tvaintra=" . urlencode($search_tvaintra);
   227| 	print '<form action="' . $_SERVER["PHP_SELF"] . '" method="post">' . "\n";
   228| 	print '<input type="hidden" name="action" value="ventil">';
   229| 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
   230| 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   231| 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
   232| 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
   233| 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
   234| 	print '<input type="hidden" name="page" value="'.$page.'">';
   235| 	print_barre_liste($langs->trans("InvoiceLinesDone"), $page, $_SERVER["PHP_SELF"], $param, $sortfield, $sortorder, '', $num_lines, $nbtotalofrecords, 'title_accountancy', 0, '', '', $limit);
   236| 	print $langs->trans("DescVentilDoneCustomer") . '<br>';
   237| 	print '<br><div class="inline-block divButAction">' . $langs->trans("ChangeAccount") . '<br>';
   238| 	print $formaccounting->select_account($account_parent, 'account_parent', 1);
   239| 	print '<input type="submit" class="button valignmiddle" value="' . $langs->trans("ChangeBinding") . '"/></div>';
   240| 	$moreforfilter = '';
   241| 	print '<div class="div-table-responsive">';
   242| 	print '<table class="tagtable liste'.($moreforfilter?" listwithfilterbefore":"").'">'."\n";
   243| 	print '<tr class="liste_titre_filter">';
   244| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_lineid" value="' . dol_escape_htmltag($search_lineid) . '""></td>';
   245| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_invoice" value="' . dol_escape_htmltag($search_invoice) . '"></td>';
   246| 	print '<td class="liste_titre center">';
   247|    	if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day" value="'.$search_day.'">';
   248|    	print '<input class="flat" type="text" size="1" maxlength="2" name="search_month" value="'.$search_month.'">';
   249|    	$formother->select_year($search_year,'search_year',1, 20, 5);
   250| 	print '</td>';
   251| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_ref" value="' . dol_escape_htmltag($search_ref) . '"></td>';
   252| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_desc" value="' . dol_escape_htmltag($search_desc) . '"></td>';
   253| 	print '<td class="liste_titre" align="right"><input type="text" class="right flat maxwidth50" name="search_amount" value="' . dol_escape_htmltag($search_amount) . '"></td>';
   254| 	print '<td class="liste_titre" align="right"><input type="text" class="right flat maxwidth50" placeholder="%" name="search_vat" size="1" value="' . dol_escape_htmltag($search_vat) . '"></td>';
   255| 	print '<td class="liste_titre" align="center"><input type="text" class="flat maxwidth50" name="search_account" value="' . dol_escape_htmltag($search_account) . '"></td>';
   256| 	print '<td class="liste_titre" align="center"><input type="text" class="flat maxwidth50" name="search_country" value="' . dol_escape_htmltag($search_country) . '"></td>';
   257| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_tavintra" value="' . dol_escape_htmltag($search_tavintra) . '"></td>';
   258| 	print '<td class="liste_titre" align="center">';


# ====================================================================
# FILE: htdocs/accountancy/expensereport/index.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 8-294 ---
     8|  * it under the terms of the GNU General Public License as published by
     9|  * the Free Software Foundation; either version 3 of the License, or
    10|  * (at your option) any later version.
    11|  *
    12|  * This program is distributed in the hope that it will be useful,
    13|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    14|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    19|  */
    20| /**
    21|  * \file		htdocs/accountancy/expensereport/index.php
    22|  * \ingroup		Advanced accountancy
    23|  * \brief		Home expense report ventilation
    24|  */
    25| require '../../main.inc.php';
    26| require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
    27| require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
    28| $langs->load("compta");
    29| $langs->load("bills");
    30| $langs->load("other");
    31| $langs->load("main");
    32| $langs->load("accountancy");
    33| if (empty($conf->accounting->enabled)) {
    34|     accessforbidden();
    35| }
    36| if ($user->societe_id > 0)
    37| 	accessforbidden();
    38| if (! $user->rights->accounting->bind->write)
    39| 	accessforbidden();
    40| $year = GETPOST('year', 'int');
    41| if ($year == 0) {
    42| 	$year_current = strftime("%Y", time());
    43| 	$year_start = $year_current;
    44| } else {
    45| 	$year_current = $year;
    46| 	$year_start = $year;
    47| }
    48| $action = GETPOST('action','aZ09');
    49| /*
    50|  * Actions
    51|  */
    52| if ($action == 'validatehistory') {
    53| 	$error = 0;
    54| 	$db->begin();
    55| 	$sqlclean = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
    56| 	$sqlclean .= " SET fk_code_ventilation = 0";
    57| 	$sqlclean .= ' WHERE erd.fk_code_ventilation NOT IN ';
    58| 	$sqlclean .= '	(SELECT accnt.rowid ';
    59| 	$sqlclean .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
    60| 	$sqlclean .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
    61| 	$sqlclean .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
    62| 	$resql = $db->query($sqlclean);
    63| 	if ($db->type == 'pgsql') {
    64| 		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det";
    65| 		$sql1 .= " SET fk_code_ventilation = accnt.rowid";
    66| 		$sql1 .= " FROM " . MAIN_DB_PREFIX . "c_type_fees as t, " . MAIN_DB_PREFIX . "accounting_account as accnt , " . MAIN_DB_PREFIX . "accounting_system as syst";
    67| 		$sql1 .= " WHERE " . MAIN_DB_PREFIX . "expensereport_det.fk_c_type_fees = t.id  AND accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=" . $conf->global->CHARTOFACCOUNTS;
    68| 		$sql1 .= " AND accnt.active = 1 AND t.accountancy_code = accnt.account_number";
    69| 		$sql1 .= " AND " . MAIN_DB_PREFIX . "expensereport_det.fk_code_ventilation = 0";
    70| 	} else {
    71| 		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd, " . MAIN_DB_PREFIX . "c_type_fees as t, " . MAIN_DB_PREFIX . "accounting_account as accnt , " . MAIN_DB_PREFIX . "accounting_system as syst";
    72| 		$sql1 .= " SET erd.fk_code_ventilation = accnt.rowid";
    73| 		$sql1 .= " WHERE erd.fk_c_type_fees = t.id AND accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=" . $conf->global->CHARTOFACCOUNTS;
    74| 		$sql1 .= " AND accnt.active = 1 AND t.accountancy_code=accnt.account_number";
    75| 		$sql1 .= " AND erd.fk_code_ventilation = 0";
    76| 	}
    77| 	dol_syslog('htdocs/accountancy/expensereport/index.php');
    78| 	$resql1 = $db->query($sql1);
    79| 	if (! $resql1) {
    80| 		$error ++;
    81| 		$db->rollback();
    82| 		setEventMessages($db->lasterror(), null, 'errors');
    83| 	} else {
    84| 		$db->commit();
    85| 		setEventMessages($langs->trans('AutomaticBindingDone'), null, 'mesgs');
    86| 	}
    87| } elseif ($action == 'cleanaccountancycode') {
    88| 	$error = 0;
    89| 	$db->begin();
    90| 	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
    91| 	$sql1.= " SET fk_code_ventilation = 0";
    92| 	$sql1.= " WHERE erd.fk_expensereport IN ( SELECT er.rowid FROM " . MAIN_DB_PREFIX . "expensereport as er";
    93| 	$sql1.= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($year_current, 1, false)) . "'";
    94| 	$sql1.= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($year_current, 12, false)) . "'";
    95| 	$sql1.= " AND er.entity IN (" . getEntity('accountancy') . ")";
    96| 	$sql1.=")";
    97| 	dol_syslog("htdocs/accountancy/customer/index.php cleanaccountancycode", LOG_DEBUG);
    98| 	$resql1 = $db->query($sql1);
    99| 	if (! $resql1) {
   100| 		$error ++;
   101| 		$db->rollback();
   102| 		setEventMessage($db->lasterror(), 'errors');
   103| 	} else {
   104| 		$db->commit();
   105| 		setEventMessage($langs->trans('Done'), 'mesgs');
   106| 	}
   107| }
   108| /*
   109|  * View
   110|  */
   111| llxHeader('', $langs->trans("ExpenseReportsVentilation"));
   112| $textprevyear = '<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current - 1) . '">' . img_previous() . '</a>';
   113| $textnextyear = '&nbsp;<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current + 1) . '">' . img_next() . '</a>';
   114| print load_fiche_titre($langs->trans("ExpenseReportsVentilation") . "&nbsp;" . $textprevyear . "&nbsp;" . $langs->trans("Year") . "&nbsp;" . $year_start . "&nbsp;" . $textnextyear, '', 'title_accountancy');
   115| print $langs->trans("DescVentilExpenseReport") . '<br>';
   116| print $langs->trans("DescVentilExpenseReportMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
   117| print '<br>';
   118| $db->begin();
   119| $sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
   120| $sql1 .= " SET fk_code_ventilation = 0";
   121| $sql1 .= ' WHERE erd.fk_code_ventilation NOT IN ';
   122| $sql1 .= '	(SELECT accnt.rowid ';
   123| $sql1 .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
   124| $sql1 .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
   125| $sql1 .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
   126| dol_syslog("htdocs/accountancy/customer/index.php fixaccountancycode", LOG_DEBUG);
   127| $resql1 = $db->query($sql1);
   128| if (! $resql1) {
   129| 	$error ++;
   130| 	$db->rollback();
   131| 	setEventMessage($db->lasterror(), 'errors');
   132| } else {
   133| 	$db->commit();
   134| }
   135| $y = $year_current;
   136| $buttonbind = '<a class="butAction" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=validatehistory">' . $langs->trans("ValidateHistory") . '</a>';
   137| $buttonreset = '<a class="butActionDelete" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=cleanaccountancycode">' . $langs->trans("CleanHistory", $year_current) . '</a>';
   138| print_fiche_titre($langs->trans("OverviewOfAmountOfLinesNotBound"), $buttonbind, '');
   139| print '<div class="div-table-responsive-no-min">';
   140| print '<table class="noborder" width="100%">';
   141| print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
   142| print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
   143| for($i = 1; $i <= 12; $i ++) {
   144|     print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   145| }
   146| print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   147| $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
   148| $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
   149| for($i = 1; $i <= 12; $i ++) {
   150|     $sql .= "  SUM(" . $db->ifsql('MONTH(er.date_debut)=' . $i, 'erd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   151| }
   152| $sql .= " SUM(erd.total_ht) as total";
   153| $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport_det as erd";
   154| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "expensereport as er ON er.rowid = erd.fk_expensereport";
   155| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = erd.fk_code_ventilation";
   156| $sql .= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   157| $sql .= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   158| $sql .= " AND er.fk_statut > 0 ";
   159| $sql .= " AND er.entity IN (" . getEntity('expensereport', 0) . ")";     // We don't share object for accountancy
   160| $sql .= " AND aa.account_number IS NULL";
   161| $sql .= " GROUP BY erd.fk_code_ventilation,aa.account_number,aa.label";
   162| dol_syslog('/accountancy/expensereport/index.php:: sql=' . $sql);
   163| $resql = $db->query($sql);
   164| if ($resql) {
   165|     $num = $db->num_rows($resql);
   166|     while ( $row = $db->fetch_row($resql)) {
   167| 		print '<tr class="oddeven"><td>';
   168| 		if ($row[0] == 'tobind')
   169| 		{
   170| 			print $langs->trans("Unknown");
   171| 		}
   172| 		else print length_accountg($row[0]);
   173| 		print '</td>';
   174| 		print '<td align="left">';
   175| 		if ($row[0] == 'tobind')
   176| 		{
   177| 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/expensereport/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
   178| 		}
   179| 		else print $row[1];
   180| 		print '</td>';
   181|     	for($i = 2; $i <= 12; $i ++) {
   182|             print '<td align="right">' . price($row[$i]) . '</td>';
   183|         }
   184|         print '<td align="right">' . price($row[13]) . '</td>';
   185|         print '<td align="right"><b>' . price($row[14]) . '</b></td>';
   186|         print '</tr>';
   187|     }
   188|     $db->free($resql);
   189| } else {
   190|     print $db->lasterror(); // Show last sql error
   191| }
   192| print "</table>\n";
   193| print '</div>';
   194| print '<br>';
   195| print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), $buttonreset, '');
   196| print '<div class="div-table-responsive-no-min">';
   197| print '<table class="noborder" width="100%">';
   198| print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
   199| print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
   200| for($i = 1; $i <= 12; $i ++) {
   201|     print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   202| }
   203| print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   204| $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
   205| $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
   206| for($i = 1; $i <= 12; $i ++) {
   207|     $sql .= "  SUM(" . $db->ifsql('MONTH(er.date_debut)=' . $i, 'erd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   208| }
   209| $sql .= " ROUND(SUM(erd.total_ht),2) as total";
   210| $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport_det as erd";
   211| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "expensereport as er ON er.rowid = erd.fk_expensereport";
   212| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = erd.fk_code_ventilation";
   213| $sql .= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   214| $sql .= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   215| $sql .= " AND er.fk_statut > 0 ";
   216| $sql .= " AND er.entity IN (" . getEntity('expensereport', 0) . ")";     // We don't share object for accountancy
   217| $sql .= " AND aa.account_number IS NOT NULL";
   218| $sql .= " GROUP BY erd.fk_code_ventilation,aa.account_number,aa.label";
   219| dol_syslog('htdocs/accountancy/expensereport/index.php');
   220| $resql = $db->query($sql);
   221| if ($resql) {
   222|     $num = $db->num_rows($resql);
   223|     while ( $row = $db->fetch_row($resql)) {
   224| 		print '<tr class="oddeven"><td>';
   225| 		if ($row[0] == 'tobind')
   226| 		{
   227| 			print $langs->trans("Unknown");
   228| 		}
   229| 		else print length_accountg($row[0]);
   230| 		print '</td>';
   231| 		print '<td align="left">';
   232| 		if ($row[0] == 'tobind')
   233| 		{
   234| 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/expensereport/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
   235| 		}
   236| 		else print $row[1];
   237| 		print '</td>';
   238|     	for($i = 2; $i <= 12; $i ++) {
   239|             print '<td align="right">' . price($row[$i]) . '</td>';
   240|         }
   241|         print '<td align="right">' . price($row[13]) . '</td>';
   242|         print '<td align="right"><b>' . price($row[14]) . '</b></td>';
   243|         print '</tr>';
   244|     }
   245|     $db->free($resql);
   246| } else {
   247|     print $db->lasterror(); // Show last sql error
   248| }
   249| print "</table>\n";
   250| print '</div>';
   251| if ($conf->global->MAIN_FEATURES_LEVEL > 0) // This part of code looks strange. Why showing a report that should rely on result of this step ?
   252| {
   253|     print '<br>';
   254|     print '<br>';
   255|     print_fiche_titre($langs->trans("OtherInfo"), '', '');
   256| 	print '<div class="div-table-responsive-no-min">';
   257|     print '<table class="noborder" width="100%">';
   258|     print '<tr class="liste_titre"><td width="400" align="left">' . $langs->trans("Total") . '</td>';
   259|     for($i = 1; $i <= 12; $i ++) {
   260|     	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   261|     }
   262|     print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   263|     $sql = "SELECT '" . $langs->trans("TotalExpenseReport") . "' AS label,";
   264|     for($i = 1; $i <= 12; $i ++) {
   265|     	$sql .= " SUM(" . $db->ifsql('MONTH(er.date_create)=' . $i, 'erd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   266|     }
   267|     $sql .= " SUM(erd.total_ht) as total";
   268|     $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport_det as erd";
   269|     $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "expensereport as er ON er.rowid = erd.fk_expensereport";
   270|     $sql .= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   271|     $sql .= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   272|     $sql .= " AND er.fk_statut > 0 ";
   273|     $sql .= " AND er.entity IN (" . getEntity('expensereport', 0) . ")";     // We don't share object for accountancy
   274|     dol_syslog('htdocs/accountancy/expensereport/index.php');
   275|     $resql = $db->query($sql);
   276|     if ($resql) {
   277|     	$num = $db->num_rows($resql);
   278|     	while ( $row = $db->fetch_row($resql)) {
   279|     		print '<tr><td>' . $row[0] . '</td>';
   280|     			for($i = 1; $i <= 12; $i ++) {
   281|     			print '<td align="right">' . price($row[$i]) . '</td>';
   282|     		}
   283|     		print '<td align="right"><b>' . price($row[13]) . '</b></td>';
   284|     		print '</tr>';
   285|     	}
   286|     	$db->free($resql);
   287|     } else {
   288|     	print $db->lasterror(); // Show last sql error
   289|     }
   290|     print "</table>\n";
   291|     print '</div>';
   292| }
   293| llxFooter();
   294| $db->close();


# ====================================================================
# FILE: htdocs/accountancy/expensereport/lines.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 20-60 ---
    20|  */
    21| /**
    22|  * \file 		htdocs/accountancy/expensereport/lines.php
    23|  * \ingroup 	Advanced accountancy
    24|  * \brief 		Page of detail of the lines of ventilation of expense reports
    25|  */
    26| require '../../main.inc.php';
    27| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formaccounting.class.php';
    28| require_once DOL_DOCUMENT_ROOT . '/expensereport/class/expensereport.class.php';
    29| require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
    30| require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
    31| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formother.class.php';
    32| require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
    33| $langs->load("compta");
    34| $langs->load("bills");
    35| $langs->load("other");
    36| $langs->load("main");
    37| $langs->load("accountancy");
    38| $langs->load("trips");
    39| $langs->load("productbatch");
    40| $account_parent = GETPOST('account_parent');
    41| $changeaccount = GETPOST('changeaccount');
    42| $search_expensereport = GETPOST('search_expensereport', 'alpha');
    43| $search_label = GETPOST('search_label', 'alpha');
    44| $search_desc = GETPOST('search_desc', 'alpha');
    45| $search_amount = GETPOST('search_amount', 'alpha');
    46| $search_account = GETPOST('search_account', 'alpha');
    47| $search_vat = GETPOST('search_vat', 'alpha');
    48| $search_day=GETPOST("search_day","int");
    49| $search_month=GETPOST("search_month","int");
    50| $search_year=GETPOST("search_year","int");
    51| $limit = GETPOST('limit','int')?GETPOST('limit', 'int'):(empty($conf->global->ACCOUNTING_LIMIT_LIST_VENTILATION)?$conf->liste_limit:$conf->global->ACCOUNTING_LIMIT_LIST_VENTILATION);
    52| $sortfield = GETPOST('sortfield', 'alpha');
    53| $sortorder = GETPOST('sortorder', 'alpha');
    54| $page = GETPOST('page', 'int');
    55| if (empty($page) || $page < 0) $page = 0;
    56| $pageprev = $page - 1;
    57| $pagenext = $page + 1;
    58| $offset = $limit * $page;
    59| if (! $sortfield)
    60| 	$sortfield = "erd.date, erd.rowid";

# --- HUNK 2: Lines 68-161 ---
    68| if (! $user->rights->accounting->bind->write)
    69| 	accessforbidden();
    70| $formaccounting = new FormAccounting($db);
    71| /*
    72|  * Actions
    73|  */
    74| if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') || GETPOST('button_removefilter','alpha')) // Both test are required to be compatible with all browsers
    75| {
    76| 	$search_expensereport = '';
    77| 	$search_label = '';
    78| 	$search_desc = '';
    79| 	$search_amount = '';
    80| 	$search_account = '';
    81| 	$search_vat = '';
    82| 	$search_day = '';
    83| 	$search_month = '';
    84| 	$search_year = '';
    85| }
    86| if (is_array($changeaccount) && count($changeaccount) > 0) {
    87| 	$error = 0;
    88| 	$db->begin();
    89| 	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
    90| 	$sql1 .= " SET erd.fk_code_ventilation=" . GETPOST('account_parent','int');
    91| 	$sql1 .= ' WHERE erd.rowid IN (' . implode(',', $changeaccount) . ')';
    92| 	dol_syslog('accountancy/expensereport/lines.php::changeaccount sql= ' . $sql1);
    93| 	$resql1 = $db->query($sql1);
    94| 	if (! $resql1) {
    95| 		$error ++;
    96| 		setEventMessages($db->lasterror(), null, 'errors');
    97| 	}
    98| 	if (! $error) {
    99| 		$db->commit();
   100| 		setEventMessages($langs->trans('Save'), null, 'mesgs');
   101| 	} else {
   102| 		$db->rollback();
   103| 		setEventMessages($db->lasterror(), null, 'errors');
   104| 	}
   105| 	$account_parent = '';   // Protection to avoid to mass apply it a second time
   106| }
   107| /*
   108|  * View
   109|  */
   110| $form = new Form($db);
   111| $formother = new FormOther($db);
   112| llxHeader('', $langs->trans("ExpenseReportsVentilation") . ' - ' . $langs->trans("Dispatched"));
   113| print '<script type="text/javascript">
   114| 			$(function () {
   115| 				$(\'#select-all\').click(function(event) {
   116| 				    $(\':checkbox\').each(function() {
   117| 				    	this.checked = true;
   118| 				    });
   119| 			    });
   120| 			    $(\'#unselect-all\').click(function(event) {
   121| 				    $(\':checkbox\').each(function() {
   122| 				    	this.checked = false;
   123| 				    });
   124| 			    });
   125| 			});
   126| 			 </script>';
   127| /*
   128|  * Expense reports lines
   129|  */
   130| $sql = "SELECT er.ref, er.rowid as erid,";
   131| $sql .= " erd.rowid, erd.fk_c_type_fees, erd.comments, erd.total_ht, erd.fk_code_ventilation, erd.tva_tx, erd.vat_src_code, erd.date,";
   132| $sql .= " aa.label, aa.account_number,";
   133| $sql .= " f.id as type_fees_id, f.code as type_fees_code, f.label as type_fees_label";
   134| $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport as er";
   135| $sql .= " , " . MAIN_DB_PREFIX . "accounting_account as aa";
   136| $sql .= " , " . MAIN_DB_PREFIX . "expensereport_det as erd";
   137| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "c_type_fees as f ON f.id = erd.fk_c_type_fees";
   138| $sql .= " WHERE er.rowid = erd.fk_expensereport and er.fk_statut >= 5 AND erd.fk_code_ventilation <> 0 ";
   139| $sql .= " AND aa.rowid = erd.fk_code_ventilation";
   140| if (strlen(trim($search_expensereport))) {
   141| 	$sql .= " AND er.ref like '%" . $search_expensereport . "%'";
   142| }
   143| if (strlen(trim($search_label))) {
   144| 	$sql .= natural_search("f.label", $search_label);
   145| }
   146| if (strlen(trim($search_desc))) {
   147| 	$sql .= natural_search("er.comments", $search_desc);
   148| }
   149| if (strlen(trim($search_amount))) {
   150| 	$sql .= natural_search("erd.total_ht", $search_amount, 1);
   151| }
   152| if (strlen(trim($search_account))) {
   153| 	$sql .= natural_search("aa.account_number", $search_account);
   154| }
   155| if (strlen(trim($search_vat))) {
   156| 	$sql .= natural_search("erd.tva_tx", price2num($search_vat), 1);
   157| }
   158| if ($search_month > 0)
   159| {
   160| 	if ($search_year > 0 && empty($search_day))
   161| 		$sql.= " AND erd.date BETWEEN '".$db->idate(dol_get_first_day($search_year,$search_month,false))."' AND '".$db->idate(dol_get_last_day($search_year,$search_month,false))."'";

# --- HUNK 3: Lines 189-229 ---
   189| 	if ($search_label)		$param .= "&search_label=" . urlencode($search_label);
   190| 	if ($search_desc)		$param .= "&search_desc=" . urlencode($search_desc);
   191| 	if ($search_account)	$param .= "&search_account=" . urlencode($search_account);
   192| 	if ($search_vat)		$param .= "&search_vat=" . urlencode($search_vat);
   193| 	if ($search_day)        $param .= '&search_day='.urlencode($search_day);
   194| 	if ($search_month)      $param .= '&search_month='.urlencode($search_month);
   195| 	if ($search_year)       $param .= '&search_year='.urlencode($search_year);
   196| 	if ($search_country)	$param .= "&search_country=" . urlencode($search_country);
   197| 	if ($search_tvaintra)	$param .= "&search_tvaintra=" . urlencode($search_tvaintra);
   198| 	print '<form action="' . $_SERVER["PHP_SELF"] . '" method="post">' . "\n";
   199| 	print '<input type="hidden" name="action" value="ventil">';
   200| 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
   201| 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   202| 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
   203| 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
   204| 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
   205| 	print '<input type="hidden" name="page" value="'.$page.'">';
   206| 	print_barre_liste($langs->trans("ExpenseReportLinesDone"), $page, $_SERVER["PHP_SELF"], $param, $sortfield, $sortorder, '', $num_lines, $nbtotalofrecords, 'title_accountancy', 0, '', '', $limit);
   207| 	print $langs->trans("DescVentilDoneExpenseReport") . '<br>';
   208| 	print '<br><div class="inline-block divButAction">' . $langs->trans("ChangeAccount") . '<br>';
   209| 	print $formaccounting->select_account(GETPOST('account_parent'), 'account_parent', 1);
   210| 	print '<input type="submit" class="button valignmiddle" value="' . $langs->trans("ChangeBinding") . '" /></div>';
   211| 	$moreforfilter = '';
   212|     print '<div class="div-table-responsive">';
   213| 	print '<table class="tagtable liste'.($moreforfilter?" listwithfilterbefore":"").'">'."\n";
   214| 	print '<tr class="liste_titre_filter">';
   215| 	print '<td class="liste_titre"></td>';
   216| 	print '<td><input type="text" class="flat maxwidth50" name="search_expensereport" value="' . dol_escape_htmltag($search_expensereport) . '"></td>';
   217| 	print '<td class="liste_titre center">';
   218|    	if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day" value="'.$search_day.'">';
   219|    	print '<input class="flat" type="text" size="1" maxlength="2" name="search_month" value="'.$search_month.'">';
   220|    	$formother->select_year($search_year,'search_year',1, 20, 5);
   221| 	print '</td>';
   222| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_label" value="' . dol_escape_htmltag($search_label) . '"></td>';
   223| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_desc" value="' . dol_escape_htmltag($search_desc) . '"></td>';
   224| 	print '<td class="liste_titre" align="right"><input type="text" class="flat maxwidth50" name="search_amount" value="' . dol_escape_htmltag($search_amount) . '"></td>';
   225| 	print '<td class="liste_titre" align="center"><input type="text" class="flat maxwidth50" name="search_vat" size="1" placeholder="%" value="' . dol_escape_htmltag($search_vat) . '"></td>';
   226| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_account" value="' . dol_escape_htmltag($search_account) . '"></td>';
   227|     print '<td class="liste_titre" align="right"></td>';
   228|     print '<td class="liste_titre" align="right">';
   229|     $searchpicto=$form->showFilterButtons();


# ====================================================================
# FILE: htdocs/accountancy/expensereport/list.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 143-183 ---
   143|  * View
   144|  */
   145| $form = new Form($db);
   146| $formother = new FormOther($db);
   147| llxHeader('', $langs->trans("ExpenseReportsVentilation"));
   148| if (empty($chartaccountcode))
   149| {
   150| 	print $langs->trans("ErrorChartOfAccountSystemNotSelected");
   151| 	llxFooter();
   152| 	$db->close();
   153| 	exit;
   154| }
   155| $sql = "SELECT er.ref, er.rowid as erid, er.date_debut,";
   156| $sql.= " erd.rowid, erd.fk_c_type_fees, erd.comments, erd.total_ht as price, erd.fk_code_ventilation, erd.tva_tx as tva_tx_line, erd.vat_src_code, erd.date,";
   157| $sql.= " f.id as type_fees_id, f.code as type_fees_code, f.label as type_fees_label, f.accountancy_code as code_buy,";
   158| $sql.= " aa.rowid as aarowid";
   159| $sql.= " FROM " . MAIN_DB_PREFIX . "expensereport as er";
   160| $sql.= " INNER JOIN " . MAIN_DB_PREFIX . "expensereport_det as erd ON er.rowid = erd.fk_expensereport";
   161| $sql.= " LEFT JOIN " . MAIN_DB_PREFIX . "c_type_fees as f ON f.id = erd.fk_c_type_fees";
   162| $sql.= " LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON f.accountancy_code = aa.account_number AND aa.fk_pcg_version = '" . $chartaccountcode."'";
   163| $sql.= " WHERE er.fk_statut > 4 AND erd.fk_code_ventilation <= 0";
   164| if (strlen(trim($search_expensereport))) {
   165|     $sql .= natural_search("er.ref",$search_expensereport);
   166| }
   167| if (strlen(trim($search_label))) {
   168|     $sql .= natural_search("f.label",$search_label);
   169| }
   170| if (strlen(trim($search_desc))) {
   171|     $sql .= natural_search("erd.comments",$search_desc);
   172| }
   173| if (strlen(trim($search_amount))) {
   174|     $sql .= natural_search("erd.total_ht",$search_amount,1);
   175| }
   176| if (strlen(trim($search_account))) {
   177|     $sql .= natural_search("aa.account_number",$search_account);
   178| }
   179| if (strlen(trim($search_vat))) {
   180|     $sql .= natural_search("erd.tva_tx",$search_vat,1);
   181| }
   182| if ($search_month > 0)
   183| {


# ====================================================================
# FILE: htdocs/accountancy/index.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 29-136 ---
    29| $langs->load("main");
    30| $langs->load("accountancy");
    31| if ($user->societe_id > 0)
    32| 	accessforbidden();
    33| $langs->load("admin");
    34| $langs->load("dict");
    35| $langs->load("bills");
    36| $langs->load("accountancy");
    37| $langs->load("compta");
    38| $langs->load("banks");
    39| $langs->load("loans");
    40| /*
    41|  * Actions
    42|  */
    43| /*
    44|  * View
    45|  */
    46| llxHeader('', $langs->trans("AccountancyArea"));
    47| print load_fiche_titre($langs->trans("AccountancyArea"), '', 'title_accountancy');
    48| $step = 0;
    49| print $langs->trans("AccountancyAreaDescIntro")."<br>\n";
    50| print "<br>\n";print "<br>\n";
    51| print_fiche_titre('<span class="fa fa-calendar-check-o"></span> '.$langs->trans("AccountancyAreaDescActionOnce"), '', '')."<br>\n";
    52| print '<hr>';
    53| print "<br>\n";
    54| $step++;
    55| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescJournalSetup", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("AccountingJournals").'</strong>');
    56| print "<br>\n";
    57| $step++;
    58| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescChartModel", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("Pcg_version").'</strong>');
    59| print "<br>\n";
    60| $step++;
    61| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescChart", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("Chartofaccounts").'</strong>');
    62| print "<br>\n";
    63| print "<br>\n";
    64| print $langs->trans("AccountancyAreaDescActionOnceBis");
    65| print "<br>\n";
    66| print "<br>\n";
    67| $step++;
    68| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescProd", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
    69| print "<br>\n";
    70| $step++;
    71| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBank", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuBankAccounts").'</strong>')."\n";
    72| print "<br>\n";
    73| $step++;
    74| $textlink = '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup").'-'.$langs->transnoentitiesnoconv("MenuVatAccounts").'</strong>';
    75| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescVat", $step, $textlink);
    76| print "<br>\n";
    77| if (! empty($conf->tax->enabled))
    78| {
    79|     $textlink = '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup").'-'.$langs->transnoentitiesnoconv("MenuTaxAccounts").'</strong>';
    80|     $step++;
    81|     print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescContrib", $step, $textlink);
    82|     print "<br>\n";
    83| }
    84| /*if (! empty($conf->salaries->enabled))
    85| {
    86|     $step++;
    87|     print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescSal", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuFinancial").'-'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
    88|     print "<br>\n";
    89|     print "<br>\n";
    90| }*/
    91| if (! empty($conf->expensereport->enabled))  // TODO Move this in the default account page because this is only one accounting account per purpose, not several.
    92| {
    93|     $step++;
    94|     print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescExpenseReport", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuExpenseReportAccounts").'</strong>');
    95|     print "<br>\n";
    96| }
    97| /*
    98| if (! empty($conf->loan->enabled))
    99| {
   100|     $step++;
   101|     print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescLoan", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuSpecialExpenses").'-'.$langs->transnoentitiesnoconv("Loans").'</strong> '.$langs->transnoentitiesnoconv("or").' <strong>'.$langs->transnoentitiesnoconv("MenuFinancial").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
   102|     print "<br>\n";
   103| }
   104| if (! empty($conf->don->enabled))
   105| {
   106|     $step++;
   107|     print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescDonation", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDonationAccounts").'</strong>');
   108|     print "<br>\n";
   109| }*/
   110| $step++;
   111| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescProd", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("ProductsBinding").'</strong>');
   112| print "<br>\n";
   113| print '<br>';
   114| print "<br>\n";
   115| print_fiche_titre('<span class="fa fa-calendar"></span> '.$langs->trans("AccountancyAreaDescActionFreq"), '', '');
   116| print '<hr>';
   117| print "<br>\n";
   118| $step = 0;
   119| $langs->loadLangs(array('bills', 'trips'));
   120| $step++;
   121| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("BillsCustomers"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("CustomersVentilation").'</strong>')."\n";
   122| print "<br>\n";
   123| $step++;
   124| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("BillsSuppliers"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("SuppliersVentilation").'</strong>')."\n";
   125| print "<br>\n";
   126| $step++;
   127| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("ExpenseReports"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("ExpenseReportsVentilation").'</strong>')."\n";
   128| print "<br>\n";
   129| $step++;
   130| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescWriteRecords", chr(64+$step), $langs->transnoentitiesnoconv("Journalization"), $langs->transnoentitiesnoconv("WriteBookKeeping"))."\n";
   131| print "<br>\n";
   132| $step++;
   133| print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescAnalyze", chr(64+$step))."<br>\n";
   134| print "<br>\n";
   135| llxFooter();
   136| $db->close();


# ====================================================================
# FILE: htdocs/accountancy/journal/bankjournal.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 70-111 ---
    70|  * Actions
    71|  */
    72| $error = 0;
    73| $year_current = strftime("%Y", dol_now());
    74| $pastmonth = strftime("%m", dol_now()) - 1;
    75| $pastmonthyear = $year_current;
    76| if ($pastmonth == 0) {
    77| 	$pastmonth = 12;
    78| 	$pastmonthyear --;
    79| }
    80| $date_start = dol_mktime(0, 0, 0, $date_startmonth, $date_startday, $date_startyear);
    81| $date_end = dol_mktime(23, 59, 59, $date_endmonth, $date_endday, $date_endyear);
    82| if (! GETPOSTISSET('date_startmonth') && (empty($date_start) || empty($date_end))) // We define date_start and date_end, only if we did not submit the form
    83| {
    84| 	$date_start = dol_get_first_day($pastmonthyear, $pastmonth, false);
    85| 	$date_end = dol_get_last_day($pastmonthyear, $pastmonth, false);
    86| }
    87| $idpays = $mysoc->country_id;
    88| $sql  = "SELECT b.rowid, b.dateo as do, b.datev as dv, b.amount, b.label, b.rappro, b.num_releve, b.num_chq, b.fk_type, b.fk_account,";
    89| $sql .= " ba.courant, ba.ref as baref, ba.account_number, ba.fk_accountancy_journal,";
    90| $sql .= " soc.code_compta, soc.code_compta_fournisseur, soc.rowid as socid, soc.nom as name, bu1.type as typeop_company,";
    91| $sql .= " u.accountancy_code, u.rowid as userid, u.lastname as lastname, u.firstname as firstname, bu2.type as typeop_user,";
    92| $sql .= " bu3.type as typeop_payment, bu4.type as typeop_payment_supplier";
    93| $sql .= " FROM " . MAIN_DB_PREFIX . "bank as b";
    94| $sql .= " JOIN " . MAIN_DB_PREFIX . "bank_account as ba on b.fk_account=ba.rowid";
    95| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu1 ON bu1.fk_bank = b.rowid AND bu1.type='company'";
    96| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu2 ON bu2.fk_bank = b.rowid AND bu2.type='user'";
    97| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu3 ON bu3.fk_bank = b.rowid AND bu3.type='payment'";
    98| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu4 ON bu4.fk_bank = b.rowid AND bu4.type='payment_supplier'";
    99| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "societe as soc on bu1.url_id=soc.rowid";
   100| $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "user as u on bu2.url_id=u.rowid";
   101| $sql .= " WHERE ba.fk_accountancy_journal=" . $id_journal;
   102| $sql .= ' AND b.amount != 0 AND ba.entity IN ('.getEntity('bank_account', 0).')';		// We don't share object for accountancy
   103| if ($date_start && $date_end)
   104| 	$sql .= " AND b.dateo >= '" . $db->idate($date_start) . "' AND b.dateo <= '" . $db->idate($date_end) . "'";
   105| if ($in_bookkeeping == 'already')
   106| {
   107| 	$sql .= " AND (b.rowid IN (SELECT fk_doc FROM " . MAIN_DB_PREFIX . "accounting_bookkeeping as ab  WHERE ab.doc_type='bank') )";
   108| }
   109| if ($in_bookkeeping == 'notyet')
   110| {
   111| 	$sql .= " AND (b.rowid NOT IN (SELECT fk_doc FROM " . MAIN_DB_PREFIX . "accounting_bookkeeping as ab  WHERE ab.doc_type='bank') )";

# --- HUNK 2: Lines 152-245 ---
   152| 		if ($obj->label == '(SupplierInvoicePayment)' || $obj->label == '(SupplierInvoicePaymentBack)') $lineisapurchase=1;
   153| 		if ($obj->label == '(CustomerInvoicePayment)' || $obj->label == '(CustomerInvoicePaymentBack)') $lineisasale=1;
   154| 		if ($lineisapurchase < 0)
   155| 		{
   156| 			if ($obj->typeop_payment_supplier == 'payment_supplier') $lineisapurchase = 1;
   157| 		}
   158| 		if ($lineisasale < 0)
   159| 		{
   160| 			if ($obj->typeop_payment == 'payment') $lineisasale = 1;
   161| 		}
   162| 		$compta_bank = $obj->account_number;
   163| 		$compta_soc = 'NotDefined';
   164| 		if ($lineisapurchase > 0)
   165| 			$compta_soc = (! empty($obj->code_compta_fournisseur) ? $obj->code_compta_fournisseur : $account_supplier);
   166| 		if ($lineisasale > 0)
   167| 			$compta_soc = (! empty($obj->code_compta) ? $obj->code_compta : $account_customer);
   168| 		$tabcompany[$obj->rowid] = array (
   169| 				'id' => $obj->socid,
   170| 				'name' => $obj->name,
   171| 				'code_compta' => $compta_soc,
   172| 		);
   173| 		$compta_user = (! empty($obj->accountancy_code) ? $obj->accountancy_code : $account_employee);
   174| 		$tabuser[$obj->rowid] = array (
   175| 				'id' => $obj->userid,
   176| 				'name' => dolGetFirstLastname($obj->firstname, $obj->lastname),
   177| 				'lastname' => $obj->lastname,
   178| 				'firstname' => $obj->firstname,
   179| 				'accountancy_code' => $compta_user,
   180| 		);
   181| 		$tabpay[$obj->rowid]["date"] = $obj->do;
   182| 		$tabpay[$obj->rowid]["type_payment"] = $obj->fk_type;		// CHQ, VIR, LIQ, CB, ...
   183| 		$tabpay[$obj->rowid]["ref"] = $obj->label;					// By default. Not unique. May be changed later
   184| 		$tabpay[$obj->rowid]["fk_bank"] = $obj->rowid;
   185| 		$tabpay[$obj->rowid]["bank_account_ref"] = $obj->baref;
   186| 		$tabpay[$obj->rowid]["fk_bank_account"] = $obj->fk_account;
   187| 		if (preg_match('/^\((.*)\)$/i', $obj->label, $reg)) {
   188| 			$tabpay[$obj->rowid]["lib"] = $langs->trans($reg[1]);
   189| 		} else {
   190| 			$tabpay[$obj->rowid]["lib"] = dol_trunc($obj->label, 60);
   191| 		}
   192| 		$links = $object->get_url($obj->rowid);
   193| 		$tabpay[$obj->rowid]['type'] = 'unknown';	// Can be SOLD, miscellaneous entry, payment of patient, or any old record with no links in bank_url.
   194| 		$tabtype[$obj->rowid] = 'unknown';
   195| 		if (is_array($links) && count($links) > 0) {
   196| 			foreach ($links as $key => $val) {
   197| 				if (in_array($links[$key]['type'], array('sc', 'payment_sc', 'payment', 'payment_supplier', 'payment_vat', 'payment_expensereport', 'banktransfert', 'payment_donation', 'payment_salary', 'payment_various')))
   198| 				{
   199| 					$tabpay[$obj->rowid]['type'] = $links[$key]['type'];
   200| 					$tabtype[$obj->rowid] = $links[$key]['type'];
   201| 				}
   202| 				elseif (in_array($links[$key]['type'], array('company', 'user')))
   203| 				{
   204| 					if ($tabpay[$obj->rowid]['type'] == 'unknown')
   205| 					{
   206| 					}
   207| 				}
   208| 				if ($links[$key]['type'] == 'payment') {
   209| 					$paymentstatic->id = $links[$key]['url_id'];
   210| 					$paymentstatic->ref = $links[$key]['url_id'];
   211| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentstatic->getNomUrl(2, '', '');		// TODO Do not include list of invoice in tooltip, the dol_string_nohtmltag is ko with this
   212| 					$tabpay[$obj->rowid]["paymentid"] = $paymentstatic->id;
   213| 				} else if ($links[$key]['type'] == 'payment_supplier') {
   214| 					$paymentsupplierstatic->id = $links[$key]['url_id'];
   215| 					$paymentsupplierstatic->ref = $links[$key]['url_id'];
   216| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentsupplierstatic->getNomUrl(2);
   217| 					$tabpay[$obj->rowid]["paymentsupplierid"] = $paymentsupplierstatic->id;
   218| 				} else if ($links[$key]['type'] == 'company') {
   219| 					$societestatic->id = $links[$key]['url_id'];
   220| 					$societestatic->name = $links[$key]['label'];
   221| 					$tabpay[$obj->rowid]["soclib"] = $societestatic->getNomUrl(1, '', 30);
   222| 					if ($compta_soc) $tabtp[$obj->rowid][$compta_soc] += $obj->amount;
   223| 				} else if ($links[$key]['type'] == 'user') {
   224| 					$userstatic->id = $links[$key]['url_id'];
   225| 					$userstatic->name = $links[$key]['label'];
   226| 					if ($userstatic->id > 0) $tabpay[$obj->rowid]["soclib"] = $userstatic->getNomUrl(1, '', 30);
   227| 					else $tabpay[$obj->rowid]["soclib"] = '???';	// Should not happen, but happens with old data when id of user was not saved on expense report payment.
   228| 					if ($compta_user) $tabtp[$obj->rowid][$compta_user] += $obj->amount;
   229| 				} else if ($links[$key]['type'] == 'sc') {
   230| 					$chargestatic->id = $links[$key]['url_id'];
   231| 					$chargestatic->ref = $links[$key]['url_id'];
   232| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $chargestatic->getNomUrl(2);
   233| 					if (preg_match('/^\((.*)\)$/i', $links[$key]['label'], $reg)) {
   234| 						if ($reg[1] == 'socialcontribution')
   235| 							$reg[1] = 'SocialContribution';
   236| 						$chargestatic->lib = $langs->trans($reg[1]);
   237| 					} else {
   238| 						$chargestatic->lib = $links[$key]['label'];
   239| 					}
   240| 					$chargestatic->ref = $chargestatic->lib;
   241| 					$tabpay[$obj->rowid]["soclib"] = $chargestatic->getNomUrl(1, 30);
   242| 					$tabpay[$obj->rowid]["paymentscid"] = $chargestatic->id;
   243| 					$sqlmid = 'SELECT cchgsoc.accountancy_code';
   244| 					$sqlmid .= " FROM " . MAIN_DB_PREFIX . "c_chargesociales cchgsoc ";
   245| 					$sqlmid .= " INNER JOIN " . MAIN_DB_PREFIX . "chargesociales as chgsoc ON chgsoc.fk_type=cchgsoc.id";

# --- HUNK 3: Lines 257-297 ---
   257| 					$paymentdonstatic->ref = $links[$key]['url_id'];
   258| 					$paymentdonstatic->fk_donation = $links[$key]['url_id'];
   259| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentdonstatic->getNomUrl(2);
   260| 					$tabpay[$obj->rowid]["paymentdonationid"] = $paymentdonstatic->id;
   261| 					$tabtp[$obj->rowid][$account_pay_donation] += $obj->amount;
   262| 				} else if ($links[$key]['type'] == 'payment_vat') {				// Payment VAT
   263| 					$paymentvatstatic->id = $links[$key]['url_id'];
   264| 					$paymentvatstatic->ref = $links[$key]['url_id'];
   265| 					$paymentvatstatic->label = $links[$key]['label'];
   266| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentvatstatic->getNomUrl(2);
   267| 					$tabpay[$obj->rowid]["paymentvatid"] = $paymentvatstatic->id;
   268| 					$tabtp[$obj->rowid][$account_pay_vat] += $obj->amount;
   269| 				} else if ($links[$key]['type'] == 'payment_salary') {
   270| 					$paymentsalstatic->id = $links[$key]['url_id'];
   271| 					$paymentsalstatic->ref = $links[$key]['url_id'];
   272| 					$paymentsalstatic->label = $links[$key]['label'];
   273| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentsalstatic->getNomUrl(2);
   274| 					$tabpay[$obj->rowid]["paymentsalid"] = $paymentsalstatic->id;
   275| 				} else if ($links[$key]['type'] == 'payment_expensereport') {
   276| 					$paymentexpensereportstatic->id = $links[$key]['url_id'];
   277| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentexpensereportstatic->getNomUrl(2);
   278| 					$tabpay[$obj->rowid]["paymentexpensereport"] = $paymentexpensereportstatic->id;
   279| 				} else if ($links[$key]['type'] == 'payment_various') {
   280| 					$paymentvariousstatic->id = $links[$key]['url_id'];
   281| 					$paymentvariousstatic->ref = $links[$key]['url_id'];
   282| 					$paymentvariousstatic->label = $links[$key]['label'];
   283| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentvariousstatic->getNomUrl(2);
   284| 					$tabpay[$obj->rowid]["paymentvariousid"] = $paymentvariousstatic->id;
   285| 					$paymentvariousstatic->fetch($paymentvariousstatic->id);
   286| 					$account_various = (! empty($paymentvariousstatic->accountancy_code) ? $paymentvariousstatic->accountancy_code : 'NotDefined');	// NotDefined is a reserved word
   287| 					$tabtp[$obj->rowid][$account_various] += $obj->amount;
   288| 				} else if ($links[$key]['type'] == 'banktransfert') {
   289| 					$tabpay[$obj->rowid]["lib"] .= ' ' . $langs->trans("BankTransfer");
   290| 					$tabtp[$obj->rowid][$account_transfer] += $obj->amount;
   291| 					$bankaccountstatic->fetch($tabpay[$obj->rowid]['fk_bank_account']);
   292| 					$tabpay[$obj->rowid]["soclib"] = $bankaccountstatic->getNomUrl(2);
   293| 				}
   294| 			}
   295| 		}
   296| 		$tabbq[$obj->rowid][$compta_bank] += $obj->amount;
   297| 		if (empty($tabtp[$obj->rowid])) $tabtp[$obj->rowid]['NotDefined']= $tabbq[$obj->rowid][$compta_bank];

# --- HUNK 4: Lines 671-711 ---
   671| 			}
   672| 		}
   673| 	}
   674| }
   675| /*
   676|  * View
   677|  */
   678| $form = new Form($db);
   679| if (empty($action) || $action == 'view') {
   680| 	$invoicestatic = new Facture($db);
   681| 	$invoicesupplierstatic = new FactureFournisseur($db);
   682| 	$expensereportstatic = new ExpenseReport($db);
   683| 	$vatstatic = new Tva($db);
   684| 	$donationstatic = new Don($db);
   685| 	$salarystatic = new PaymentSalary($db);
   686| 	$variousstatic = new PaymentVarious($db);
   687| 	llxHeader('', $langs->trans("FinanceJournal"));
   688| 	$nom = $langs->trans("FinanceJournal") . ' - ' . $accountingjournalstatic->getNomUrl(1);
   689| 	$builddate=dol_now();
   690| 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
   691| 	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
   692| 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
   693| 	$varlink = 'id_journal=' . $id_journal;
   694| 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
   695| 	$sql = 'SELECT COUNT(rowid) as nb FROM '.MAIN_DB_PREFIX.'bank_account WHERE fk_accountancy_journal IS NULL';
   696| 	$resql = $db->query($sql);
   697| 	if ($resql)
   698| 	{
   699| 		$obj = $db->fetch_object($resql);
   700| 		if ($obj->nb > 0)
   701| 		{
   702| 			print '<br>'.img_warning().' '.$langs->trans("TheJournalCodeIsNotDefinedOnSomeBankAccount");
   703| 			print ' : '.$langs->trans("AccountancyAreaDescBank", 9, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("BankAccounts").'</strong>');
   704| 		}
   705| 	}
   706| 	else dol_print_error($db);
   707| 	if (empty($conf->global->ACCOUNTING_ACCOUNT_CUSTOMER) || $conf->global->ACCOUNTING_ACCOUNT_CUSTOMER == '-1'
   708| 		|| empty($conf->global->ACCOUNTING_ACCOUNT_SUPPLIER) || $conf->global->ACCOUNTING_ACCOUNT_SUPPLIER == '-1'
   709| 		|| empty($conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT) || $conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT == '-1') {
   710| 		print '<br>'.img_warning().' '.$langs->trans("SomeMandatoryStepsOfSetupWereNotDone");
   711| 		print ' : '.$langs->trans("AccountancyAreaDescMisc", 4, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');


# ====================================================================
# FILE: htdocs/accountancy/journal/expensereportsjournal.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 422-462 ---
   422| 				print '"' . $date . '"' . $sep;
   423| 				print '"' . $val["ref"] . '"' . $sep;
   424| 				print '"' . length_accounta(html_entity_decode($k)) . '"' . $sep;
   425| 				print '"' . dol_trunc($userstatic->name) . '"' . $sep;
   426| 				print '"' . ($mt < 0 ? price(- $mt) : '') . '"' . $sep;
   427| 				print '"' . ($mt >= 0 ? price($mt) : '') . '"';
   428| 			}
   429| 			print "\n";
   430| 		}
   431| 	}
   432| }
   433| */
   434| if (empty($action) || $action == 'view') {
   435| 	llxHeader('', $langs->trans("ExpenseReportsJournal"));
   436| 	$nom = $langs->trans("ExpenseReportsJournal") . ' - ' . $accountingjournalstatic->getNomUrl(1);
   437| 	$nomlink = '';
   438| 	$periodlink = '';
   439| 	$exportlink = '';
   440| 	$builddate=dol_now();
   441| 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
   442| 	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
   443| 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
   444| 	$varlink = 'id_journal=' . $id_journal;
   445| 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
   446| 	if (empty($conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT) || $conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT == '-1') {
   447| 		print '<br>'.img_warning().' '.$langs->trans("SomeMandatoryStepsOfSetupWereNotDone");
   448| 		print ' : '.$langs->trans("AccountancyAreaDescMisc", 4, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
   449| 	}
   450| 	print '<div class="tabsAction tabsActionNoBottom">';
   451| 	if (empty($conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT) || $conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT == '-1') {
   452| 		print '<input type="button" class="butActionRefused" title="'.dol_escape_htmltag($langs->trans("SomeMandatoryStepsOfSetupWereNotDone")).'" value="' . $langs->trans("WriteBookKeeping") . '" />';
   453| 	}
   454| 	else {
   455| 		if ($in_bookkeeping == 'notyet') print '<input type="button" class="butAction" name="writebookkeeping" value="' . $langs->trans("WriteBookKeeping") . '" onclick="writebookkeeping();" />';
   456| 		else print '<a href="#" class="butActionRefused" name="writebookkeeping">' . $langs->trans("WriteBookKeeping") . '</a>';
   457| 	}
   458| 	print '</div>';
   459| 	print '
   460| 	<script type="text/javascript">
   461| 		function launch_export() {
   462| 			$("div.fiche form input[name=\"action\"]").val("exportcsv");


# ====================================================================
# FILE: htdocs/accountancy/journal/purchasesjournal.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 580-620 ---
   580| 						print "\n";
   581| 					}
   582| 				}
   583| 			}
   584| 		}
   585| 	}
   586| }
   587| if (empty($action) || $action == 'view') {
   588| 	llxHeader('', $langs->trans("PurchasesJournal"));
   589| 	$nom = $langs->trans("PurchasesJournal") . ' - ' . $accountingjournalstatic->getNomUrl(1);
   590| 	$nomlink = '';
   591| 	$periodlink = '';
   592| 	$exportlink = '';
   593| 	$builddate=dol_now();
   594| 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
   595| 	if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
   596| 		$description .= $langs->trans("DepositsAreNotIncluded");
   597| 	} else {
   598| 		$description .= $langs->trans("DepositsAreIncluded");
   599| 	}
   600| 	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
   601| 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
   602| 	$varlink = 'id_journal=' . $id_journal;
   603| 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
   604| 	if (empty($conf->global->ACCOUNTING_ACCOUNT_SUPPLIER) || $conf->global->ACCOUNTING_ACCOUNT_SUPPLIER == '-1') {
   605| 		print img_warning().' '.$langs->trans("SomeMandatoryStepsOfSetupWereNotDone");
   606| 		print ' : '.$langs->trans("AccountancyAreaDescMisc", 4, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
   607| 	}
   608| 	print '<div class="tabsAction tabsActionNoBottom">';
   609| 	print '<input type="button" class="butAction" name="exportcsv" value="' . $langs->trans("ExportDraftJournal") . '" onclick="launch_export();" />';
   610| 	if (empty($conf->global->ACCOUNTING_ACCOUNT_CUSTOMER) || $conf->global->ACCOUNTING_ACCOUNT_CUSTOMER == '-1') {
   611| 		print '<input type="button" class="butActionRefused" title="'.dol_escape_htmltag($langs->trans("SomeMandatoryStepsOfSetupWereNotDone")).'" value="' . $langs->trans("WriteBookKeeping") . '" />';
   612| 	}
   613| 	else {
   614| 		if ($in_bookkeeping == 'notyet') print '<input type="button" class="butAction" name="writebookkeeping" value="' . $langs->trans("WriteBookKeeping") . '" onclick="writebookkeeping();" />';
   615| 		else print '<a href="#" class="butActionRefused" name="writebookkeeping">' . $langs->trans("WriteBookKeeping") . '</a>';
   616| 	}
   617| 	print '</div>';
   618| 	print '
   619| 	<script type="text/javascript">
   620| 		function launch_export() {


# ====================================================================
# FILE: htdocs/accountancy/journal/sellsjournal.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 119-159 ---
   119| 	while ( $i < $num ) {
   120| 		$obj = $db->fetch_object($result);
   121| 		$compta_soc = (! empty($obj->code_compta)) ? $obj->code_compta : $cptcli;
   122| 		$compta_prod = $obj->compte;
   123| 		if (empty($compta_prod)) {
   124| 			if ($obj->product_type == 0)
   125| 				$compta_prod = (! empty($conf->global->ACCOUNTING_PRODUCT_SOLD_ACCOUNT)) ? $conf->global->ACCOUNTING_PRODUCT_SOLD_ACCOUNT : 'NotDefined';
   126| 			else
   127| 				$compta_prod = (! empty($conf->global->ACCOUNTING_SERVICE_SOLD_ACCOUNT)) ? $conf->global->ACCOUNTING_SERVICE_SOLD_ACCOUNT : 'NotDefined';
   128| 		}
   129| 		$vatdata = getTaxesFromId($obj->tva_tx.($obj->vat_src_code?' ('.$obj->vat_src_code.')':''), $mysoc, $mysoc, 0);
   130| 		$compta_tva = (! empty($vatdata['accountancy_code_sell']) ? $vatdata['accountancy_code_sell'] : $cpttva);
   131| 		$compta_localtax1 = (! empty($vatdata['accountancy_code_sell']) ? $vatdata['accountancy_code_sell'] : $cpttva);
   132| 		$compta_localtax2 = (! empty($vatdata['accountancy_code_sell']) ? $vatdata['accountancy_code_sell'] : $cpttva);
   133| 		if (price2num($obj->tva_tx) || ! empty($obj->vat_src_code))
   134| 		{
   135| 			$def_tva[$obj->rowid][$compta_tva][vatrate($obj->tva_tx).($obj->vat_src_code?' ('.$obj->vat_src_code.')':'')]=(vatrate($obj->tva_tx).($obj->vat_src_code?' ('.$obj->vat_src_code.')':''));
   136| 		}
   137| 		$line = new FactureLigne($db);
   138| 		$line->fetch($obj->fdid);
   139| 		$prev_progress = $line->get_prev_progress($obj->fdid);
   140| 		if ($obj->type == Facture::TYPE_SITUATION) {
   141| 			if ($obj->situation_percent == 0) {
   142| 				$situation_ratio = 0;
   143| 			} else {
   144| 				$situation_ratio = ($obj->situation_percent - $prev_progress) / $obj->situation_percent;
   145| 			}
   146| 		} else {
   147| 			$situation_ratio = 1;
   148| 		}
   149| 		$tabfac[$obj->rowid]["date"] = $db->jdate($obj->df);
   150| 		$tabfac[$obj->rowid]["datereg"] = $db->jdate($obj->dlr);
   151| 		$tabfac[$obj->rowid]["ref"] = $obj->facnumber;
   152| 		$tabfac[$obj->rowid]["type"] = $obj->type;
   153| 		$tabfac[$obj->rowid]["description"] = $obj->label_compte;
   154| 		$tabfac[$obj->rowid]["close_code"] = $obj->close_code;		// close_code = 'replaced' for replacement invoices (not used in most european countries)
   155| 		if (! isset($tabttc[$obj->rowid][$compta_soc])) $tabttc[$obj->rowid][$compta_soc] = 0;
   156| 		if (! isset($tabht[$obj->rowid][$compta_prod])) $tabht[$obj->rowid][$compta_prod] = 0;
   157| 		if (! isset($tabtva[$obj->rowid][$compta_tva])) $tabtva[$obj->rowid][$compta_tva] = 0;
   158| 		if (! isset($tablocaltax1[$obj->rowid][$compta_localtax1])) $tablocaltax1[$obj->rowid][$compta_localtax1] = 0;
   159| 		if (! isset($tablocaltax2[$obj->rowid][$compta_localtax2])) $tablocaltax2[$obj->rowid][$compta_localtax2] = 0;

# --- HUNK 2: Lines 508-548 ---
   508| 					print '"' . ($mt >= 0 ? price($mt) : '') . '"' . $sep;
   509| 					print '"' . $journal . '"';
   510| 					print "\n";
   511| 				}
   512| 			}
   513| 		}
   514| 	}
   515| }
   516| if (empty($action) || $action == 'view') {
   517| 	llxHeader('', $langs->trans("SellsJournal"));
   518| 	$nom = $langs->trans("SellsJournal") . ' - ' . $accountingjournalstatic->getNomUrl(1);
   519| 	$nomlink = '';
   520| 	$periodlink = '';
   521| 	$exportlink = '';
   522| 	$builddate=dol_now();
   523| 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
   524| 	if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS))
   525| 		$description .= $langs->trans("DepositsAreNotIncluded");
   526| 	else
   527| 		$description .= $langs->trans("DepositsAreIncluded");
   528| 	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
   529| 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
   530| 	$varlink = 'id_journal=' . $id_journal;
   531| 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
   532| 	if (empty($conf->global->ACCOUNTING_ACCOUNT_CUSTOMER) || $conf->global->ACCOUNTING_ACCOUNT_CUSTOMER == '-1') {
   533| 		print img_warning().' '.$langs->trans("SomeMandatoryStepsOfSetupWereNotDone");
   534| 		print ' : '.$langs->trans("AccountancyAreaDescMisc", 4, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
   535| 	}
   536| 	print '<div class="tabsAction tabsActionNoBottom">';
   537| 	print '<input type="button" class="butAction" name="exportcsv" value="' . $langs->trans("ExportDraftJournal") . '" onclick="launch_export();" />';
   538| 	if (empty($conf->global->ACCOUNTING_ACCOUNT_CUSTOMER) || $conf->global->ACCOUNTING_ACCOUNT_CUSTOMER == '-1') {
   539| 		print '<input type="button" class="butActionRefused" title="'.dol_escape_htmltag($langs->trans("SomeMandatoryStepsOfSetupWereNotDone")).'" value="' . $langs->trans("WriteBookKeeping") . '" />';
   540| 	}
   541| 	else {
   542| 		if ($in_bookkeeping == 'notyet') print '<input type="button" class="butAction" name="writebookkeeping" value="' . $langs->trans("WriteBookKeeping") . '" onclick="writebookkeeping();" />';
   543| 		else print '<a href="#" class="butActionRefused" name="writebookkeeping">' . $langs->trans("WriteBookKeeping") . '</a>';
   544| 	}
   545| 	print '</div>';
   546| 	print '
   547| 	<script type="text/javascript">
   548| 		function launch_export() {


# ====================================================================
# FILE: htdocs/accountancy/supplier/index.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 15-295 ---
    15|  * GNU General Public License for more details.
    16|  *
    17|  * You should have received a copy of the GNU General Public License
    18|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    19|  */
    20| /**
    21|  * \file		htdocs/accountancy/supplier/index.php
    22|  * \ingroup		Advanced accountancy
    23|  * \brief		Home supplier journalization page
    24|  */
    25| require '../../main.inc.php';
    26| require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
    27| require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
    28| require_once DOL_DOCUMENT_ROOT . '/fourn/class/fournisseur.facture.class.php';
    29| $langs->load("compta");
    30| $langs->load("bills");
    31| $langs->load("other");
    32| $langs->load("main");
    33| $langs->load("accountancy");
    34| if (empty($conf->accounting->enabled)) {
    35|     accessforbidden();
    36| }
    37| if ($user->societe_id > 0)
    38| 	accessforbidden();
    39| if (! $user->rights->accounting->bind->write)
    40| 	accessforbidden();
    41| $year = GETPOST("year",'int');
    42| if ($year == 0) {
    43| 	$year_current = strftime("%Y", time());
    44| 	$year_start = $year_current;
    45| } else {
    46| 	$year_current = $year;
    47| 	$year_start = $year;
    48| }
    49| $action = GETPOST('action', 'aZ09');
    50| /*
    51|  * Actions
    52|  */
    53| if ($action == 'validatehistory') {
    54| 	$error = 0;
    55| 	$db->begin();
    56| 	$sqlclean = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
    57| 	$sqlclean .= " SET fk_code_ventilation = 0";
    58| 	$sqlclean .= ' WHERE fd.fk_code_ventilation NOT IN ';
    59| 	$sqlclean .= '	(SELECT accnt.rowid ';
    60| 	$sqlclean .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
    61| 	$sqlclean .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
    62| 	$sqlclean .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
    63| 	$resql = $db->query($sqlclean);
    64| 	if ($db->type == 'pgsql') {
    65| 		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det";
    66| 		$sql1 .= " SET fk_code_ventilation = accnt.rowid";
    67| 		$sql1 .= " FROM " . MAIN_DB_PREFIX . "product as p, " . MAIN_DB_PREFIX . "accounting_account as accnt , " . MAIN_DB_PREFIX . "accounting_system as syst";
    68| 		$sql1 .= " WHERE " . MAIN_DB_PREFIX . "facture_fourn_det.fk_product = p.rowid  AND accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=" . $conf->global->CHARTOFACCOUNTS;
    69| 		$sql1 .= " AND accnt.active = 1 AND p.accountancy_code_buy=accnt.account_number";
    70| 		$sql1 .= " AND " . MAIN_DB_PREFIX . "facture_fourn_det.fk_code_ventilation = 0";
    71| 	} else {
    72| 		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as fd, " . MAIN_DB_PREFIX . "product as p, " . MAIN_DB_PREFIX . "accounting_account as accnt , " . MAIN_DB_PREFIX . "accounting_system as syst";
    73| 		$sql1 .= " SET fk_code_ventilation = accnt.rowid";
    74| 		$sql1 .= " WHERE fd.fk_product = p.rowid AND accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=" . $conf->global->CHARTOFACCOUNTS;
    75| 		$sql1 .= " AND accnt.active = 1 AND p.accountancy_code_buy=accnt.account_number";
    76| 		$sql1 .= " AND fd.fk_code_ventilation = 0";
    77| 	}
    78| 	dol_syslog('htdocs/accountancy/supplier/index.php');
    79| 	$resql1 = $db->query($sql1);
    80| 	if (! $resql1) {
    81| 		$error ++;
    82| 		$db->rollback();
    83| 		setEventMessages($db->lasterror(), null, 'errors');
    84| 	} else {
    85| 		$db->commit();
    86| 		setEventMessages($langs->trans('AutomaticBindingDone'), null, 'mesgs');
    87| 	}
    88| } elseif ($action == 'cleanaccountancycode') {
    89| 	$error = 0;
    90| 	$db->begin();
    91| 	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as fd";
    92| 	$sql1.= " SET fk_code_ventilation = 0";
    93| 	$sql1.= " WHERE fd.fk_facture_fourn IN ( SELECT f.rowid FROM " . MAIN_DB_PREFIX . "facture_fourn as f";
    94| 	$sql1.= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($year_current, 1, false)) . "'";
    95| 	$sql1.= " AND f.datef <= '" . $db->idate(dol_get_last_day($year_current, 12, false)) . "'";
    96| 	$sql1.= " AND f.entity IN (" . getEntity('accountancy') . ")";
    97| 	$sql1.= ")";
    98| 	dol_syslog("htdocs/accountancy/customer/index.php cleanaccountancycode", LOG_DEBUG);
    99| 	$resql1 = $db->query($sql1);
   100| 	if (! $resql1) {
   101| 		$error ++;
   102| 		$db->rollback();
   103| 		setEventMessage($db->lasterror(), 'errors');
   104| 	} else {
   105| 		$db->commit();
   106| 		setEventMessage($langs->trans('Done'), 'mesgs');
   107| 	}
   108| }
   109| /*
   110|  * View
   111|  */
   112| llxHeader('', $langs->trans("SuppliersVentilation"));
   113| $textprevyear = '<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current - 1) . '">' . img_previous() . '</a>';
   114| $textnextyear = '&nbsp;<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current + 1) . '">' . img_next() . '</a>';
   115| print load_fiche_titre($langs->trans("SuppliersVentilation") . " " . $textprevyear . "&nbsp;" . $langs->trans("Year") . "&nbsp;" . $year_start . "&nbsp;" . $textnextyear, '', 'title_accountancy');
   116| print $langs->trans("DescVentilSupplier") . '<br>';
   117| print $langs->trans("DescVentilMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
   118| print '<br>';
   119| $db->begin();
   120| $sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as fd";
   121| $sql1 .= " SET fk_code_ventilation = 0";
   122| $sql1 .= ' WHERE fd.fk_code_ventilation NOT IN ';
   123| $sql1 .= '	(SELECT accnt.rowid ';
   124| $sql1 .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
   125| $sql1 .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
   126| $sql1 .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
   127| dol_syslog("htdocs/accountancy/customer/index.php fixaccountancycode", LOG_DEBUG);
   128| $resql1 = $db->query($sql1);
   129| if (! $resql1) {
   130| 	$error ++;
   131| 	$db->rollback();
   132| 	setEventMessage($db->lasterror(), 'errors');
   133| } else {
   134| 	$db->commit();
   135| }
   136| $y = $year_current;
   137| $buttonbind = '<a class="butAction" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=validatehistory">' . $langs->trans("ValidateHistory") . '</a>';
   138| $buttonreset = '<a class="butActionDelete" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=cleanaccountancycode">' . $langs->trans("CleanHistory", $year_current) . '</a>';
   139| print_fiche_titre($langs->trans("OverviewOfAmountOfLinesNotBound"), $buttonbind, '');
   140| print '<div class="div-table-responsive-no-min">';
   141| print '<table class="noborder" width="100%">';
   142| print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
   143| print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
   144| for($i = 1; $i <= 12; $i ++) {
   145| 	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   146| }
   147| print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   148| $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
   149| $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
   150| for($i = 1; $i <= 12; $i ++) {
   151| 	$sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $i, 'ffd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   152| }
   153| $sql .= "  SUM(ffd.total_ht) as total";
   154| $sql .= " FROM " . MAIN_DB_PREFIX . "facture_fourn_det as ffd";
   155| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture_fourn as ff ON ff.rowid = ffd.fk_facture_fourn";
   156| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = ffd.fk_code_ventilation";
   157| $sql .= " WHERE ff.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   158| $sql .= "  AND ff.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   159| $sql .= "  AND ff.fk_statut > 0 ";
   160| $sql .= " AND ff.entity IN (" . getEntity('facture_fourn', 0) . ")";     // We don't share object for accountancy
   161| $sql .= " AND aa.account_number IS NULL";
   162| $sql .= " GROUP BY ffd.fk_code_ventilation,aa.account_number,aa.label";
   163| dol_syslog('htdocs/accountancy/supplier/index.php');
   164| $resql = $db->query($sql);
   165| if ($resql) {
   166| 	$num = $db->num_rows($resql);
   167| 	while ( $row = $db->fetch_row($resql)) {
   168| 		print '<tr class="oddeven"><td>';
   169| 		if ($row[0] == 'tobind')
   170| 		{
   171| 			print $langs->trans("Unknown");
   172| 		}
   173| 		else print length_accountg($row[0]);
   174| 		print '</td>';
   175| 		print '<td align="left">';
   176| 		if ($row[0] == 'tobind')
   177| 		{
   178| 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/supplier/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
   179| 		}
   180| 		else print $row[1];
   181| 		print '</td>';
   182| 		for($i = 2; $i <= 12; $i ++) {
   183| 			print '<td align="right">' . price($row[$i]) . '</td>';
   184| 		}
   185| 		print '<td align="right">' . price($row[13]) . '</td>';
   186| 		print '<td align="right"><b>' . price($row[14]) . '</b></td>';
   187| 		print '</tr>';
   188| 	}
   189| 	$db->free($resql);
   190| } else {
   191| 	print $db->lasterror(); // Show last sql error
   192| }
   193| print "</table>\n";
   194| print '</div>';
   195| print '<br>';
   196| print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), $buttonreset, '');
   197| print '<div class="div-table-responsive-no-min">';
   198| print '<table class="noborder" width="100%">';
   199| print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
   200| print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
   201| for($i = 1; $i <= 12; $i ++) {
   202|     print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   203| }
   204| print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   205| $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
   206| $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
   207| for($i = 1; $i <= 12; $i ++) {
   208|     $sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $i, 'ffd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   209| }
   210| $sql .= "  SUM(ffd.total_ht) as total";
   211| $sql .= " FROM " . MAIN_DB_PREFIX . "facture_fourn_det as ffd";
   212| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture_fourn as ff ON ff.rowid = ffd.fk_facture_fourn";
   213| $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = ffd.fk_code_ventilation";
   214| $sql .= " WHERE ff.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   215| $sql .= "  AND ff.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   216| $sql .= "  AND ff.fk_statut > 0 ";
   217| $sql .= " AND ff.entity IN (" . getEntity('facture_fourn', 0) . ")";     // We don't share object for accountancy
   218| $sql .= " AND aa.account_number IS NOT NULL";
   219| $sql .= " GROUP BY ffd.fk_code_ventilation,aa.account_number,aa.label";
   220| dol_syslog('htdocs/accountancy/supplier/index.php');
   221| $resql = $db->query($sql);
   222| if ($resql) {
   223|     $num = $db->num_rows($resql);
   224|     while ( $row = $db->fetch_row($resql)) {
   225| 		print '<tr class="oddeven"><td>';
   226| 		if ($row[0] == 'tobind')
   227| 		{
   228| 			print $langs->trans("Unknown");
   229| 		}
   230| 		else print length_accountg($row[0]);
   231| 		print '</td>';
   232| 		print '<td align="left">';
   233| 		if ($row[0] == 'tobind')
   234| 		{
   235| 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/supplier/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
   236| 		}
   237| 		else print $row[1];
   238| 		print '</td>';
   239|     	for($i = 2; $i <= 12; $i ++) {
   240|             print '<td align="right">' . price($row[$i]) . '</td>';
   241|         }
   242|         print '<td align="right">' . price($row[13]) . '</td>';
   243|         print '<td align="right"><b>' . price($row[14]) . '</b></td>';
   244|         print '</tr>';
   245|     }
   246|     $db->free($resql);
   247| } else {
   248|     print $db->lasterror(); // Show last sql error
   249| }
   250| print "</table>\n";
   251| print '</div>';
   252| if ($conf->global->MAIN_FEATURES_LEVEL > 0) // This part of code looks strange. Why showing a report that should rely on result of this step ?
   253| {
   254|     print '<br>';
   255|     print '<br>';
   256|     print_fiche_titre($langs->trans("OtherInfo"), '', '');
   257| 	print '<div class="div-table-responsive-no-min">';
   258|     print '<table class="noborder" width="100%">';
   259|     print '<tr class="liste_titre"><td width="400" align="left">' . $langs->trans("Total") . '</td>';
   260|     for($i = 1; $i <= 12; $i ++) {
   261|     	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
   262|     }
   263|     print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
   264|     $sql = "SELECT '" . $langs->trans("CAHTF") . "' AS label,";
   265|     for($i = 1; $i <= 12; $i ++) {
   266|     	$sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $i, 'ffd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
   267|     }
   268|     $sql .= "  SUM(ffd.total_ht) as total";
   269|     $sql .= " FROM " . MAIN_DB_PREFIX . "facture_fourn_det as ffd";
   270|     $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture_fourn as ff ON ff.rowid = ffd.fk_facture_fourn";
   271|     $sql .= " WHERE ff.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
   272|     $sql .= "  AND ff.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
   273|     $sql .= "  AND ff.fk_statut > 0 ";
   274|     $sql .= " AND ff.entity IN (" . getEntity('facture_fourn', 0) . ")";     // We don't share object for accountancy
   275|     dol_syslog('htdocs/accountancy/supplier/index.php');
   276|     $resql = $db->query($sql);
   277|     if ($resql) {
   278|     	$num = $db->num_rows($resql);
   279|     	while ( $row = $db->fetch_row($resql)) {
   280|     		print '<tr><td>' . $row[0] . '</td>';
   281|     			for($i = 1; $i <= 12; $i ++) {
   282|     			print '<td align="right">' . price($row[$i]) . '</td>';
   283|     		}
   284|     		print '<td align="right"><b>' . price($row[13]) . '</b></td>';
   285|     		print '</tr>';
   286|     	}
   287|     	$db->free($resql);
   288|     } else {
   289|     	print $db->lasterror(); // Show last sql error
   290|     }
   291|     print "</table>\n";
   292|     print '</div>';
   293| }
   294| llxFooter();
   295| $db->close();


# ====================================================================
# FILE: htdocs/accountancy/supplier/lines.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 76-133 ---
    76|  * Actions
    77|  */
    78| if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') || GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
    79| {
    80|     $search_lineid = '';
    81| 	$search_ref = '';
    82| 	$search_invoice = '';
    83| 	$search_label = '';
    84| 	$search_desc = '';
    85| 	$search_amount = '';
    86| 	$search_account = '';
    87| 	$search_vat = '';
    88| 	$search_day = '';
    89| 	$search_month = '';
    90| 	$search_year = '';
    91| 	$search_country = '';
    92| 	$search_tvaintra = '';
    93| }
    94| if (is_array($changeaccount) && count($changeaccount) > 0) {
    95| 	$error = 0;
    96| 	$db->begin();
    97| 	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as l";
    98| 	$sql1 .= " SET l.fk_code_ventilation=" . GETPOST('account_parent','int');
    99| 	$sql1 .= ' WHERE l.rowid IN (' . implode(',', $changeaccount) . ')';
   100| 	dol_syslog('accountancy/supplier/lines.php::changeaccount sql= ' . $sql1);
   101| 	$resql1 = $db->query($sql1);
   102| 	if (! $resql1) {
   103| 		$error ++;
   104| 		setEventMessages($db->lasterror(), null, 'errors');
   105| 	}
   106| 	if (! $error) {
   107| 		$db->commit();
   108| 		setEventMessages($langs->trans('Save'), null, 'mesgs');
   109| 	} else {
   110| 		$db->rollback();
   111| 		setEventMessages($db->lasterror(), null, 'errors');
   112| 	}
   113| 	$account_parent = '';   // Protection to avoid to mass apply it a second time
   114| }
   115| /*
   116|  * View
   117|  */
   118| $form = new Form($db);
   119| $formother = new FormOther($db);
   120| llxHeader('', $langs->trans("SuppliersVentilation") . ' - ' . $langs->trans("Dispatched"));
   121| print '<script type="text/javascript">
   122| 			$(function () {
   123| 				$(\'#select-all\').click(function(event) {
   124| 				    $(\':checkbox\').each(function() {
   125| 				    	this.checked = true;
   126| 				    });
   127| 			    });
   128| 			    $(\'#unselect-all\').click(function(event) {
   129| 				    $(\':checkbox\').each(function() {
   130| 				    	this.checked = false;
   131| 				    });
   132| 			    });
   133| 			});

# --- HUNK 2: Lines 212-252 ---
   212| 	if ($search_label)		$param .= "&search_label=" . urlencode($search_label);
   213| 	if ($search_desc)		$param .= "&search_desc=" . urlencode($search_desc);
   214| 	if ($search_account)	$param .= "&search_account=" . urlencode($search_account);
   215| 	if ($search_vat)		$param .= "&search_vat=" . urlencode($search_vat);
   216| 	if ($search_day)        $param .= '&search_day='.urlencode($search_day);
   217| 	if ($search_month)      $param .= '&search_month='.urlencode($search_month);
   218| 	if ($search_year)       $param .= '&search_year='.urlencode($search_year);
   219| 	if ($search_country) 	$param .= "&search_country=" . urlencode($search_country);
   220| 	if ($search_tvaintra)	$param .= "&search_tvaintra=" . urlencode($search_tvaintra);
   221| 	print '<form action="' . $_SERVER["PHP_SELF"] . '" method="post">' . "\n";
   222| 	print '<input type="hidden" name="action" value="ventil">';
   223| 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
   224| 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   225| 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
   226| 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
   227| 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
   228| 	print '<input type="hidden" name="page" value="'.$page.'">';
   229| 	print_barre_liste($langs->trans("InvoiceLinesDone"), $page, $_SERVER["PHP_SELF"], $param, $sortfield, $sortorder, '', $num_lines, $nbtotalofrecords, 'title_accountancy', 0, '', '', $limit);
   230| 	print $langs->trans("DescVentilDoneSupplier") . '<br>';
   231| 	print '<br><div class="inline-block divButAction">' . $langs->trans("ChangeAccount") . '<br>';
   232| 	print $formaccounting->select_account($account_parent, 'account_parent', 1);
   233| 	print '<input type="submit" class="button valignmiddle" value="' . $langs->trans("ChangeBinding") . '" /></div>';
   234| 	$moreforfilter = '';
   235|     print '<div class="div-table-responsive">';
   236| 	print '<table class="tagtable liste'.($moreforfilter?" listwithfilterbefore":"").'">'."\n";
   237| 	print '<tr class="liste_titre_filter">';
   238| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_lineid" value="' . dol_escape_htmltag($search_lineid) . '""></td>';
   239| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_invoice" value="' . dol_escape_htmltag($search_invoice) . '"></td>';
   240| 	print '<td class="liste_titre"></td>';
   241| 	print '<td class="liste_titre center">';
   242|    	if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day" value="'.$search_day.'">';
   243|    	print '<input class="flat" type="text" size="1" maxlength="2" name="search_month" value="'.$search_month.'">';
   244|    	$formother->select_year($search_year,'search_year',1, 20, 5);
   245| 	print '</td>';
   246| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_ref" value="' . dol_escape_htmltag($search_ref) . '"></td>';
   247| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_desc" value="' . dol_escape_htmltag($search_desc) . '"></td>';
   248| 	print '<td class="liste_titre" align="right"><input type="text" class="right flat maxwidth50" name="search_amount" value="' . dol_escape_htmltag($search_amount) . '"></td>';
   249| 	print '<td class="liste_titre" align="right"><input type="text" class="right flat maxwidth50" name="search_vat" placeholder="%" size="1" value="' . dol_escape_htmltag($search_vat) . '"></td>';
   250| 	print '<td class="liste_titre" align="center"><input type="text" class="flat maxwidth50" name="search_account" value="' . dol_escape_htmltag($search_account) . '"></td>';
   251| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_country" value="' . dol_escape_htmltag($search_country) . '"></td>';
   252| 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_tavintra" value="' . dol_escape_htmltag($search_tavintra) . '"></td>';


# ====================================================================
# FILE: htdocs/adherents/cartes/carte.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-60 ---
    10|  *
    11|  * This program is distributed in the hope that it will be useful,
    12|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    18|  */
    19| /**
    20|  *	\file 		htdocs/adherents/cartes/carte.php
    21|  *	\ingroup    member
    22|  *	\brief      Page to output members business cards
    23|  */
    24| require '../../main.inc.php';
    25| require_once DOL_DOCUMENT_ROOT.'/core/lib/format_cards.lib.php';
    26| require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
    27| require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';
    28| require_once DOL_DOCUMENT_ROOT.'/core/modules/member/modules_cards.php';
    29| require_once DOL_DOCUMENT_ROOT.'/core/modules/printsheet/modules_labels.php';
    30| $langs->load("members");
    31| $langs->load("errors");
    32| $now = dol_now();
    33| $year=dol_print_date($now,'%Y');
    34| $month=dol_print_date($now,'%m');
    35| $day=dol_print_date($now,'%d');
    36| $foruserid=GETPOST('foruserid');
    37| $foruserlogin=GETPOST('foruserlogin');
    38| $mode=GETPOST('mode');
    39| $model=GETPOST("model");			// Doc template to use for business cards
    40| $modellabel=GETPOST("modellabel");	// Doc template to use for address sheet
    41| $mesg='';
    42| $adherentstatic=new Adherent($db);
    43| $extrafields = new ExtraFields($db);
    44| $extralabels = $extrafields->fetch_name_optionals_label('adherent');
    45| /*
    46|  * Actions
    47|  */
    48| if ($mode == 'cardlogin' && empty($foruserlogin))
    49| {
    50|     $mesg=$langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("Login"));
    51| }
    52| if ((! empty($foruserid) || ! empty($foruserlogin) || ! empty($mode)) && ! $mesg)
    53| {
    54|     $arrayofmembers=array();
    55|     $sql = "SELECT d.rowid, d.firstname, d.lastname, d.login, d.societe as company, d.datefin,";
    56|     $sql.= " d.address, d.zip, d.town, d.country, d.birth, d.email, d.photo,";
    57|     $sql.= " t.libelle as type,";
    58|     $sql.= " c.code as country_code, c.label as country";
    59|     foreach ($extrafields->attribute_label as $key => $val)
    60|         $sql.=($extrafields->attribute_type[$key] != 'separate' ? ",ef.".$key.' as options_'.$key : '');


# ====================================================================
# FILE: htdocs/adherents/list.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 19-59 ---
    19|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    20|  */
    21| /**
    22|  *      \file       htdocs/adherents/list.php
    23|  *      \ingroup    member
    24|  *		\brief      Page to list all members of foundation
    25|  */
    26| require '../main.inc.php';
    27| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formother.class.php';
    28| require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';
    29| require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent_type.class.php';
    30| require_once DOL_DOCUMENT_ROOT.'/core/lib/company.lib.php';
    31| $langs->loadLangs(array("members","companies"));
    32| $action=GETPOST('action','aZ09');
    33| $massaction=GETPOST('massaction','alpha');
    34| $show_files=GETPOST('show_files','int');
    35| $confirm=GETPOST('confirm','alpha');
    36| $toselect = GETPOST('toselect', 'array');
    37| $result=restrictedArea($user,'adherent');
    38| $filter=GETPOST("filter",'alpha');
    39| $statut=GETPOST("statut",'alpha');
    40| $search=GETPOST("search",'alpha');
    41| $search_ref=GETPOST("search_ref",'alpha');
    42| $search_lastname=GETPOST("search_lastname",'alpha');
    43| $search_firstname=GETPOST("search_firstname",'alpha');
    44| $search_login=GETPOST("search_login",'alpha');
    45| $search_address=GETPOST("search_address",'alpha');
    46| $search_zip=GETPOST("search_zip",'alpha');
    47| $search_town=GETPOST("search_town",'alpha');
    48| $search_state=GETPOST("search_state",'alpha');
    49| $search_country=GETPOST("search_country",'alpha');
    50| $search_phone=GETPOST("search_phone",'alpha');
    51| $search_phone_perso=GETPOST("search_phone_perso",'alpha');
    52| $search_phone_mobile=GETPOST("search_phone_mobile",'alpha');
    53| $search_type=GETPOST("search_type",'alpha');
    54| $search_email=GETPOST("search_email",'alpha');
    55| $search_categ = GETPOST("search_categ",'int');
    56| $catid        = GETPOST("catid",'int');
    57| $optioncss = GETPOST('optioncss','alpha');
    58| $sall=trim((GETPOST('search_all', 'alphanohtml')!='')?GETPOST('search_all', 'alphanohtml'):GETPOST('sall', 'alphanohtml'));
    59| if ($statut < -1) $statut = '';


# ====================================================================
# FILE: htdocs/admin/agenda.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 45-135 ---
    45| 	{
    46| 		$obj = $db->fetch_object($resql);
    47| 		$triggers[$i]['rowid'] 		= $obj->rowid;
    48| 		$triggers[$i]['code'] 		= $obj->code;
    49| 		$triggers[$i]['element'] 	= $obj->elementtype;
    50| 		$triggers[$i]['label']		= ($langs->trans("Notify_".$obj->code)!="Notify_".$obj->code?$langs->trans("Notify_".$obj->code):$obj->label);
    51| 		$i++;
    52| 	}
    53| 	$db->free($resql);
    54| }
    55| else
    56| {
    57| 	dol_print_error($db);
    58| }
    59| /*
    60|  *	Actions
    61|  */
    62| if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') ||GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
    63| {
    64| 	$search_event = '';
    65| }
    66| if ($action == "save" && empty($cancel))
    67| {
    68|     $i=0;
    69|     $db->begin();
    70| 	foreach ($triggers as $trigger)
    71| 	{
    72| 		$keyparam='MAIN_AGENDA_ACTIONAUTO_'.$trigger['code'];
    73| 		if ($search_event === '' || preg_match('/'.preg_quote($search_event,'/').'/i', $keyparam))
    74| 		{
    75| 			$res = dolibarr_set_const($db,$keyparam,(GETPOST($keyparam,'alpha')?GETPOST($keyparam,'alpha'):''),'chaine',0,'',$conf->entity);
    76| 			if (! $res > 0) $error++;
    77| 		}
    78| 	}
    79|  	if (! $error)
    80|     {
    81|         setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
    82|         $db->commit();
    83|     }
    84|     else
    85|     {
    86|         setEventMessages($langs->trans("Error"),null, 'errors');
    87|         $db->rollback();
    88|     }
    89| }
    90| if (preg_match('/set_(.*)/',$action,$reg))
    91| {
    92| 	$code=$reg[1];
    93| 	$value=(GETPOST($code) ? GETPOST($code) : 1);
    94| 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
    95| 	{
    96| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    97| 		exit;
    98| 	}
    99| 	else
   100| 	{
   101| 		dol_print_error($db);
   102| 	}
   103| }
   104| if (preg_match('/del_(.*)/',$action,$reg))
   105| {
   106| 	$code=$reg[1];
   107| 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
   108| 	{
   109| 		Header("Location: ".$_SERVER["PHP_SELF"]);
   110| 		exit;
   111| 	}
   112| 	else
   113| 	{
   114| 		dol_print_error($db);
   115| 	}
   116| }
   117| /**
   118|  * View
   119|  */
   120| $wikihelp='EN:Module_Agenda_En|FR:Module_Agenda|ES:Mdulo_Agenda';
   121| llxHeader('', $langs->trans("AgendaSetup"), $wikihelp);
   122| $linkback='<a href="'.DOL_URL_ROOT.'/admin/modules.php?restore_lastsearch_values=1">'.$langs->trans("BackToModuleList").'</a>';
   123| print load_fiche_titre($langs->trans("AgendaSetup"),$linkback,'title_setup');
   124| print '<form action="'.$_SERVER["PHP_SELF"].'" method="POST">';
   125| print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   126| print '<input type="hidden" name="action" value="save">';
   127| $param = '';
   128| $param.= '&search_event='.urlencode($search_event);
   129| $head=agenda_prepare_head();
   130| dol_fiche_head($head, 'autoactions', $langs->trans("Agenda"), -1, 'action');
   131| print $langs->trans("AgendaAutoActionDesc")."<br>\n";
   132| print $langs->trans("OnlyActiveElementsAreShown", 'modules.php').'<br>';
   133| print "<br>\n";
   134| print '<div class="div-table-responsive">';		// You can use div-table-responsive-no-min if you dont need reserved height for your table
   135| print '<table class="noborder" width="100%">';


# ====================================================================
# FILE: htdocs/admin/agenda_other.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-80 ---
    26|  */
    27| require '../main.inc.php';
    28| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    29| require_once DOL_DOCUMENT_ROOT.'/core/lib/agenda.lib.php';
    30| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formactions.class.php';
    31| if (!$user->admin)
    32|     accessforbidden();
    33| $langs->load("admin");
    34| $langs->load("other");
    35| $langs->load("agenda");
    36| $action = GETPOST('action','alpha');
    37| $value = GETPOST('value','alpha');
    38| $param = GETPOST('param','alpha');
    39| $cancel = GETPOST('cancel','alpha');
    40| $scandir = GETPOST('scan_dir','alpha');
    41| $type = 'action';
    42| /*
    43|  *	Actions
    44|  */
    45| include DOL_DOCUMENT_ROOT.'/core/actions_setmoduleoptions.inc.php';
    46| if (preg_match('/set_(.*)/',$action,$reg))
    47| {
    48| 	$code=$reg[1];
    49| 	$value=(GETPOST($code) ? GETPOST($code) : 1);
    50| 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
    51| 	{
    52| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    53| 		exit;
    54| 	}
    55| 	else
    56| 	{
    57| 		dol_print_error($db);
    58| 	}
    59| }
    60| if (preg_match('/del_(.*)/',$action,$reg))
    61| {
    62| 	$code=$reg[1];
    63| 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    64| 	{
    65| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    66| 		exit;
    67| 	}
    68| 	else
    69| 	{
    70| 		dol_print_error($db);
    71| 	}
    72| }
    73| if ($action == 'set')
    74| {
    75| 	dolibarr_set_const($db, 'AGENDA_USE_EVENT_TYPE_DEFAULT', GETPOST('AGENDA_USE_EVENT_TYPE_DEFAULT'), 'chaine', 0, '', $conf->entity);
    76|     dolibarr_set_const($db, 'AGENDA_DEFAULT_FILTER_TYPE', GETPOST('AGENDA_DEFAULT_FILTER_TYPE'), 'chaine', 0, '', $conf->entity);
    77|     dolibarr_set_const($db, 'AGENDA_DEFAULT_FILTER_STATUS', GETPOST('AGENDA_DEFAULT_FILTER_STATUS'), 'chaine', 0, '', $conf->entity);
    78| 	dolibarr_set_const($db, 'AGENDA_DEFAULT_VIEW', GETPOST('AGENDA_DEFAULT_VIEW'), 'chaine', 0, '', $conf->entity);
    79| }
    80| else if ($action == 'specimen')  // For orders


# ====================================================================
# FILE: htdocs/admin/agenda_reminder.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 21-75 ---
    21|  */
    22| require '../main.inc.php';
    23| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    24| require_once DOL_DOCUMENT_ROOT.'/core/lib/agenda.lib.php';
    25| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formactions.class.php';
    26| if (!$user->admin)
    27|     accessforbidden();
    28| $langs->load("admin");
    29| $langs->load("other");
    30| $langs->load("agenda");
    31| $action = GETPOST('action','alpha');
    32| $value = GETPOST('value','alpha');
    33| $param = GETPOST('param','alpha');
    34| $cancel = GETPOST('cancel','alpha');
    35| $scandir = GETPOST('scandir','alpha');
    36| $type = 'action';
    37| /*
    38|  *	Actions
    39|  */
    40| include DOL_DOCUMENT_ROOT.'/core/actions_setmoduleoptions.inc.php';
    41| if (preg_match('/set_(.*)/',$action,$reg))
    42| {
    43| 	$code=$reg[1];
    44| 	$value=(GETPOST($code) ? GETPOST($code) : 1);
    45| 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
    46| 	{
    47| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    48| 		exit;
    49| 	}
    50| 	else
    51| 	{
    52| 		dol_print_error($db);
    53| 	}
    54| }
    55| if (preg_match('/del_(.*)/',$action,$reg))
    56| {
    57| 	$code=$reg[1];
    58| 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    59| 	{
    60| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    61| 		exit;
    62| 	}
    63| 	else
    64| 	{
    65| 		dol_print_error($db);
    66| 	}
    67| }
    68| if ($action == 'set')
    69| {
    70| 	dolibarr_set_const($db, 'AGENDA_USE_EVENT_TYPE_DEFAULT', GETPOST('AGENDA_USE_EVENT_TYPE_DEFAULT'), 'chaine', 0, '', $conf->entity);
    71|     dolibarr_set_const($db, 'AGENDA_DEFAULT_FILTER_TYPE', GETPOST('AGENDA_DEFAULT_FILTER_TYPE'), 'chaine', 0, '', $conf->entity);
    72|     dolibarr_set_const($db, 'AGENDA_DEFAULT_FILTER_STATUS', GETPOST('AGENDA_DEFAULT_FILTER_STATUS'), 'chaine', 0, '', $conf->entity);
    73| 	dolibarr_set_const($db, 'AGENDA_DEFAULT_VIEW', GETPOST('AGENDA_DEFAULT_VIEW'), 'chaine', 0, '', $conf->entity);
    74| }
    75| else if ($action == 'specimen')  // For orders


# ====================================================================
# FILE: htdocs/admin/company.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 47-87 ---
    47| $reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
    48| if ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');
    49| if ( ($action == 'update' && ! GETPOST("cancel",'alpha'))
    50| || ($action == 'updateedit') )
    51| {
    52| 	$tmparray=getCountry(GETPOST('country_id','int'),'all',$db,$langs,0);
    53| 	if (! empty($tmparray['id']))
    54| 	{
    55| 		$mysoc->country_id   =$tmparray['id'];
    56| 		$mysoc->country_code =$tmparray['code'];
    57| 		$mysoc->country_label=$tmparray['label'];
    58| 		$s=$mysoc->country_id.':'.$mysoc->country_code.':'.$mysoc->country_label;
    59| 		dolibarr_set_const($db, "MAIN_INFO_SOCIETE_COUNTRY", $s,'chaine',0,'',$conf->entity);
    60| 		activateModulesRequiredByCountry($mysoc->country_code);
    61| 	}
    62| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_NOM", GETPOST("nom",'nohtml'),'chaine',0,'',$conf->entity);
    63| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_ADDRESS", GETPOST("address",'nohtml'),'chaine',0,'',$conf->entity);
    64| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_TOWN", GETPOST("town",'nohtml'),'chaine',0,'',$conf->entity);
    65| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_ZIP", GETPOST("zipcode",'alpha'),'chaine',0,'',$conf->entity);
    66| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_STATE", GETPOST("state_id",'alpha'),'chaine',0,'',$conf->entity);
    67| 	dolibarr_set_const($db, "MAIN_MONNAIE", GETPOST("currency",'alpha'),'chaine',0,'',$conf->entity);
    68| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_TEL", GETPOST("tel",'alpha'),'chaine',0,'',$conf->entity);
    69| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_FAX", GETPOST("fax",'alpha'),'chaine',0,'',$conf->entity);
    70| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_MAIL", GETPOST("mail",'alpha'),'chaine',0,'',$conf->entity);
    71| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_WEB", GETPOST("web",'alpha'),'chaine',0,'',$conf->entity);
    72| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_NOTE", GETPOST("note",'none'),'chaine',0,'',$conf->entity);
    73| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_GENCOD", GETPOST("barcode",'alpha'),'chaine',0,'',$conf->entity);
    74| 	$varforimage='logo'; $dirforimage=$conf->mycompany->dir_output.'/logos/';
    75| 	if ($_FILES[$varforimage]["tmp_name"])
    76| 	{
    77| 		if (preg_match('/([^\\/:]+)$/i',$_FILES[$varforimage]["name"],$reg))
    78| 		{
    79| 			$original_file=$reg[1];
    80| 			$isimage=image_format_supported($original_file);
    81| 			if ($isimage >= 0)
    82| 			{
    83| 				dol_syslog("Move file ".$_FILES[$varforimage]["tmp_name"]." to ".$dirforimage.$original_file);
    84| 				if (! is_dir($dirforimage))
    85| 				{
    86| 					dol_mkdir($dirforimage);
    87| 				}

# --- HUNK 2: Lines 112-189 ---
   112| 				{
   113| 					$error++;
   114| 					$langs->load("errors");
   115| 					$tmparray=explode(':',$result);
   116| 					setEventMessages($langs->trans('ErrorFileIsInfectedWithAVirus',$tmparray[1]), null, 'errors');
   117| 				}
   118| 				else
   119| 				{
   120| 					$error++;
   121| 					setEventMessages($langs->trans("ErrorFailedToSaveFile"), null, 'errors');
   122| 				}
   123| 			}
   124| 			else
   125| 			{
   126| 				$error++;
   127| 				$langs->load("errors");
   128| 				setEventMessages($langs->trans("ErrorBadImageFormat"), null, 'errors');
   129| 			}
   130| 		}
   131| 	}
   132| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_MANAGERS", GETPOST("MAIN_INFO_SOCIETE_MANAGERS",'alpha'),'chaine',0,'',$conf->entity);
   133| 	dolibarr_set_const($db, "MAIN_INFO_CAPITAL", GETPOST("capital",'alpha'),'chaine',0,'',$conf->entity);
   134| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_FORME_JURIDIQUE", GETPOST("forme_juridique_code",'alpha'),'chaine',0,'',$conf->entity);
   135| 	dolibarr_set_const($db, "MAIN_INFO_SIREN", GETPOST("siren",'alpha'),'chaine',0,'',$conf->entity);
   136| 	dolibarr_set_const($db, "MAIN_INFO_SIRET", GETPOST("siret",'alpha'),'chaine',0,'',$conf->entity);
   137| 	dolibarr_set_const($db, "MAIN_INFO_APE", GETPOST("ape",'alpha'),'chaine',0,'',$conf->entity);
   138| 	dolibarr_set_const($db, "MAIN_INFO_RCS", GETPOST("rcs",'alpha'),'chaine',0,'',$conf->entity);
   139| 	dolibarr_set_const($db, "MAIN_INFO_PROFID5", GETPOST("MAIN_INFO_PROFID5",'alpha'),'chaine',0,'',$conf->entity);
   140| 	dolibarr_set_const($db, "MAIN_INFO_PROFID6", GETPOST("MAIN_INFO_PROFID6",'alpha'),'chaine',0,'',$conf->entity);
   141| 	dolibarr_set_const($db, "MAIN_INFO_TVAINTRA", GETPOST("tva",'alpha'),'chaine',0,'',$conf->entity);
   142| 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_OBJECT", GETPOST("object",'nohtml'),'chaine',0,'',$conf->entity);
   143| 	dolibarr_set_const($db, "SOCIETE_FISCAL_MONTH_START", GETPOST("SOCIETE_FISCAL_MONTH_START",'alpha'),'chaine',0,'',$conf->entity);
   144| 	dolibarr_set_const($db, "FACTURE_TVAOPTION", GETPOST("optiontva",'alpha'),'chaine',0,'',$conf->entity);
   145| 	dolibarr_set_const($db, "FACTURE_LOCAL_TAX1_OPTION", GETPOST("optionlocaltax1",'alpha'),'chaine',0,'',$conf->entity);
   146| 	dolibarr_set_const($db, "FACTURE_LOCAL_TAX2_OPTION", GETPOST("optionlocaltax2",'alpha'),'chaine',0,'',$conf->entity);
   147| 	if($_POST["optionlocaltax1"]=="localtax1on")
   148| 	{
   149| 		if(!isset($_REQUEST['lt1']))
   150| 		{
   151| 			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX1", 0,'chaine',0,'',$conf->entity);
   152| 		}
   153| 		else
   154| 		{
   155| 			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX1", GETPOST('lt1','alpha'),'chaine',0,'',$conf->entity);
   156| 		}
   157| 		dolibarr_set_const($db,"MAIN_INFO_LOCALTAX_CALC1",  GETPOST("clt1",'alpha'),'chaine',0,'',$conf->entity);
   158| 	}
   159| 	if($_POST["optionlocaltax2"]=="localtax2on")
   160| 	{
   161| 		if(!isset($_REQUEST['lt2']))
   162| 		{
   163| 			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX2", 0,'chaine',0,'',$conf->entity);
   164| 		}
   165| 		else
   166| 		{
   167| 			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX2", GETPOST('lt2','alpha'),'chaine',0,'',$conf->entity);
   168| 		}
   169| 		dolibarr_set_const($db,"MAIN_INFO_LOCALTAX_CALC2",  GETPOST("clt2",'alpha'),'chaine',0,'',$conf->entity);
   170| 	}
   171| 	if ($action != 'updateedit' && ! $error)
   172| 	{
   173| 		header("Location: ".$_SERVER["PHP_SELF"]);
   174| 		exit;
   175| 	}
   176| }
   177| if ($action == 'addthumb')  // Regenerate thumbs
   178| {
   179| 	if (file_exists($conf->mycompany->dir_output.'/logos/'.$_GET["file"]))
   180| 	{
   181| 		$isimage=image_format_supported($_GET["file"]);
   182| 		if ($isimage > 0)
   183| 		{
   184| 			$imgThumbSmall = vignette($conf->mycompany->dir_output.'/logos/'.$_GET["file"], $maxwidthsmall, $maxheightsmall, '_small',$quality);
   185| 			if (image_format_supported($imgThumbSmall) >= 0 && preg_match('/([^\\/:]+)$/i',$imgThumbSmall,$reg))
   186| 			{
   187| 				$imgThumbSmall = $reg[1];   // Save only basename
   188| 				dolibarr_set_const($db, "MAIN_INFO_SOCIETE_LOGO_SMALL",$imgThumbSmall,'chaine',0,'',$conf->entity);
   189| 			}

# --- HUNK 3: Lines 299-339 ---
   299| 	print '<table width="100%" class="nobordernopadding"><tr class="nocellnopadd"><td valign="middle" class="nocellnopadd">';
   300| 	print '<input type="file" class="flat class=minwidth200" name="logo" id="logo">';
   301| 	print '</td><td class="nocellnopadd" valign="middle" align="right">';
   302| 	if (! empty($mysoc->logo_mini)) {
   303| 		print '<a href="'.$_SERVER["PHP_SELF"].'?action=removelogo">'.img_delete($langs->trans("Delete")).'</a>';
   304| 		if (file_exists($conf->mycompany->dir_output.'/logos/thumbs/'.$mysoc->logo_mini)) {
   305| 			print ' &nbsp; ';
   306| 			print '<img src="'.DOL_URL_ROOT.'/viewimage.php?modulepart=mycompany&amp;file='.urlencode('/thumbs/'.$mysoc->logo_mini).'">';
   307| 		}
   308| 	} else {
   309| 		print '<img height="30" src="'.DOL_URL_ROOT.'/public/theme/common/nophoto.png">';
   310| 	}
   311| 	print '</td></tr></table>';
   312| 	print '</td></tr>';
   313| 	print '<tr class="oddeven"><td class="tdtop"><label for="note">'.$langs->trans("Note").'</label></td><td>';
   314| 	print '<textarea class="flat quatrevingtpercent" name="note" id="note" rows="'.ROWS_5.'">'.(GETPOST('note','none') ? GETPOST('note','none') : $conf->global->MAIN_INFO_SOCIETE_NOTE).'</textarea></td></tr>';
   315| 	print '</td></tr>';
   316| 	print '</table>';
   317| 	print '<br>';
   318| 	print '<table class="noborder" width="100%">';
   319| 	print '<tr class="liste_titre"><td>'.$langs->trans("CompanyIds").'</td><td>'.$langs->trans("Value").'</td></tr>';
   320| 	$langs->load("companies");
   321| 	print '<tr class="oddeven"><td><label for="director">'.$langs->trans("ManagingDirectors").'</label></td><td>';
   322| 	print '<input name="MAIN_INFO_SOCIETE_MANAGERS" id="director" class="minwidth200" value="' . $conf->global->MAIN_INFO_SOCIETE_MANAGERS . '"></td></tr>';
   323| 	print '<tr class="oddeven"><td><label for="capital">'.$langs->trans("Capital").'</label></td><td>';
   324| 	print '<input name="capital" id="capital" class="minwidth100" value="' . $conf->global->MAIN_INFO_CAPITAL . '"></td></tr>';
   325| 	print '<tr class="oddeven"><td><label for="forme_juridique_code">'.$langs->trans("JuridicalStatus").'</label></td><td>';
   326| 	if ($mysoc->country_code) {
   327| 		print $formcompany->select_juridicalstatus($conf->global->MAIN_INFO_SOCIETE_FORME_JURIDIQUE, $mysoc->country_code, '', 'forme_juridique_code');
   328| 	} else {
   329| 		print $countrynotdefined;
   330| 	}
   331| 	print '</td></tr>';
   332| 	if ($langs->transcountry("ProfId1",$mysoc->country_code) != '-')
   333| 	{
   334| 		print '<tr class="oddeven"><td><label for="profid1">'.$langs->transcountry("ProfId1",$mysoc->country_code).'</label></td><td>';
   335| 		if (! empty($mysoc->country_code))
   336| 		{
   337| 			print '<input name="siren" id="profid1" class="minwidth200" value="' . (! empty($conf->global->MAIN_INFO_SIREN) ? $conf->global->MAIN_INFO_SIREN : '') . '">';
   338| 		}
   339| 		else

# --- HUNK 4: Lines 408-474 ---
   408| 		print '</td></tr>';
   409| 	}
   410| 	print '<tr class="oddeven"><td><label for="intra_vat">'.$langs->trans("VATIntra").'</label></td><td>';
   411| 	print '<input name="tva" id="intra_vat" class="minwidth200" value="' . (! empty($conf->global->MAIN_INFO_TVAINTRA) ? $conf->global->MAIN_INFO_TVAINTRA : '') . '">';
   412| 	print '</td></tr>';
   413| 	print '<tr class="oddeven"><td><label for="object">'.$langs->trans("CompanyObject").'</label></td><td>';
   414| 	print '<textarea class="flat quatrevingtpercent" name="object" id="object" rows="'.ROWS_5.'">'.(! empty($conf->global->MAIN_INFO_SOCIETE_OBJECT) ? $conf->global->MAIN_INFO_SOCIETE_OBJECT : '').'</textarea></td></tr>';
   415| 	print '</td></tr>';
   416| 	print '</table>';
   417| 	print '<br>';
   418| 	print '<table class="noborder" width="100%">';
   419| 	print '<tr class="liste_titre">';
   420| 	print '<td class="titlefield">'.$langs->trans("FiscalYearInformation").'</td><td>'.$langs->trans("Value").'</td>';
   421| 	print "</tr>\n";
   422| 	print '<tr class="oddeven"><td><label for="SOCIETE_FISCAL_MONTH_START">'.$langs->trans("FiscalMonthStart").'</label></td><td>';
   423| 	print $formother->select_month($conf->global->SOCIETE_FISCAL_MONTH_START,'SOCIETE_FISCAL_MONTH_START',0,1) . '</td></tr>';
   424| 	print "</table>";
   425| 	print '<br>';
   426| 	print '<table class="noborder" width="100%">';
   427| 	print '<tr class="liste_titre">';
   428| 	print '<td class="titlefield">'.$langs->trans("VATManagement").'</td><td>'.$langs->trans("Description").'</td>';
   429| 	print '<td align="right">&nbsp;</td>';
   430| 	print "</tr>\n";
   431| 	print "<tr class=\"oddeven\"><td width=\"140\"><label><input type=\"radio\" name=\"optiontva\" id=\"use_vat\" value=\"1\"".(empty($conf->global->FACTURE_TVAOPTION)?"":" checked")."> ".$langs->trans("VATIsUsed")."</label></td>";
   432| 	print '<td colspan="2">';
   433| 	print "<table>";
   434| 	print "<tr><td><label for=\"use_vat\">".$langs->trans("VATIsUsedDesc")."</label></td></tr>";
   435| 	print "<tr><td><i>".$langs->trans("Example").': '.$langs->trans("VATIsUsedExampleFR")."</i></td></tr>\n";
   436| 	print "</table>";
   437| 	print "</td></tr>\n";
   438| 	print "<tr class=\"oddeven\"><td width=\"140\"><label><input type=\"radio\" name=\"optiontva\" id=\"no_vat\" value=\"0\"".(empty($conf->global->FACTURE_TVAOPTION)?" checked":"")."> ".$langs->trans("VATIsNotUsed")."</label></td>";
   439| 	print '<td colspan="2">';
   440| 	print "<table>";
   441| 	print "<tr><td><label for=\"no_vat\">".$langs->trans("VATIsNotUsedDesc")."</label></td></tr>";
   442| 	print "<tr><td><i>".$langs->trans("Example").': '.$langs->trans("VATIsNotUsedExampleFR")."</i></td></tr>\n";
   443| 	print "</table>";
   444| 	print "</td></tr>\n";
   445| 	print "</table>";
   446| 	/*
   447| 	 *  Local Taxes
   448| 	 */
   449| 	if ($mysoc->useLocalTax(1))
   450| 	{
   451| 		print '<br>';
   452| 		print '<table class="noborder" width="100%">';
   453| 		print '<tr class="liste_titre">';
   454| 		print '<td>'.$langs->transcountry("LocalTax1Management",$mysoc->country_code).'</td><td>'.$langs->trans("Description").'</td>';
   455| 		print '<td align="right">&nbsp;</td>';
   456| 		print "</tr>\n";
   457| 		print "<tr class=\"oddeven\"><td width=\"140\"><input type=\"radio\" name=\"optionlocaltax1\" id=\"lt1\" value=\"localtax1on\"".(($conf->global->FACTURE_LOCAL_TAX1_OPTION == '1' || $conf->global->FACTURE_LOCAL_TAX1_OPTION == "localtax1on")?" checked":"")."> ".$langs->transcountry("LocalTax1IsUsed",$mysoc->country_code)."</td>";
   458| 		print '<td colspan="2">';
   459| 		print '<table class="nobordernopadding">';
   460| 		print "<tr><td><label for=\"lt1\">".$langs->transcountry("LocalTax1IsUsedDesc",$mysoc->country_code)."</label></td></tr>";
   461| 		$example=$langs->transcountry("LocalTax1IsUsedExample",$mysoc->country_code);
   462| 		print ($example!="LocalTax1IsUsedExample"?"<tr><td><i>".$langs->trans("Example").': '.$langs->transcountry("LocalTax1IsUsedExample",$mysoc->country_code)."</i></td></tr>\n":"");
   463| 		if(! isOnlyOneLocalTax(1))
   464| 		{
   465| 			print '<tr><td align="left"><label for="lt1">'.$langs->trans("LTRate").'</label>: ';
   466| 			$formcompany->select_localtax(1,$conf->global->MAIN_INFO_VALUE_LOCALTAX1, "lt1");
   467| 		    print '</td></tr>';
   468| 		}
   469| 		$opcions=array($langs->trans("CalcLocaltax1").' '.$langs->trans("CalcLocaltax1Desc"),$langs->trans("CalcLocaltax2").' - '.$langs->trans("CalcLocaltax2Desc"),$langs->trans("CalcLocaltax3").' - '.$langs->trans("CalcLocaltax3Desc"));
   470| 		print '<tr><td align="left"></label for="clt1">'.$langs->trans("CalcLocaltax").'</label>: ';
   471| 		print $form->selectarray("clt1", $opcions, $conf->global->MAIN_INFO_LOCALTAX_CALC1);
   472| 		print '</td></tr>';
   473| 		print "</table>";
   474| 		print "</td></tr>\n";


# ====================================================================
# FILE: htdocs/admin/dict.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 796-864 ---
   796|     $linkback='<a href="'.$_SERVER['PHP_SELF'].'">'.$langs->trans("BackToDictionaryList").'</a>';
   797| }
   798| $titlepicto='title_setup';
   799| if ($id == 10 && GETPOST('from') == 'accountancy')
   800| {
   801|     $titre=$langs->trans("MenuVatAccounts");
   802|     $titlepicto='title_accountancy';
   803| }
   804| if ($id == 7 && GETPOST('from') == 'accountancy')
   805| {
   806|     $titre=$langs->trans("MenuTaxAccounts");
   807|     $titlepicto='title_accountancy';
   808| }
   809| print load_fiche_titre($titre,$linkback,$titlepicto);
   810| if (empty($id))
   811| {
   812|     print $langs->trans("DictionaryDesc");
   813|     print " ".$langs->trans("OnlyActiveElementsAreShown")."<br>\n";
   814| }
   815| print "<br>\n";
   816| $param = '&id='.$id;
   817| if ($search_country_id > 0) $param.= '&search_country_id='.$search_country_id;
   818| if ($search_code != '')     $param.= '&search_code='.urlencode($search_country_id);
   819| if ($entity != '') $param.= '&entity=' . (int) $entity;
   820| $paramwithsearch = $param;
   821| if ($sortorder) $paramwithsearch.= '&sortorder='.$sortorder;
   822| if ($sortfield) $paramwithsearch.= '&sortfield='.$sortfield;
   823| if (GETPOST('from')) $paramwithsearch.= '&from='.GETPOST('from','alpha');
   824| if ($action == 'delete')
   825| {
   826|     print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'rowid='.$rowid.'&code='.urlencode($code).$paramwithsearch, $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
   827| }
   828| /*
   829|  * Show a dictionary
   830|  */
   831| if ($id)
   832| {
   833|     $sql=$tabsql[$id];
   834|     if (! preg_match('/ WHERE /',$sql)) $sql.= " WHERE 1 = 1";
   835|     if ($search_country_id > 0) $sql.= " AND c.rowid = ".$search_country_id;
   836|     if ($search_code != '' && $id != 9)     $sql.= natural_search("code", $search_code);
   837|     if ($search_code != '' && $id == 9)     $sql.= natural_search("code_iso", $search_code);
   838|     if ($sortfield)
   839|     {
   840|     	if ($sortfield == 'country') $sortfield='country_code';
   841|         $sql.= " ORDER BY ".$sortfield;
   842|         if ($sortorder)
   843|         {
   844|             $sql.=" ".strtoupper($sortorder);
   845|         }
   846|         $sql.=", ";
   847|         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
   848|         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
   849|     }
   850|     else {
   851|         $sql.=" ORDER BY ";
   852|     }
   853|     $sql.=$tabsqlsort[$id];
   854|     $sql.=$db->plimit($listlimit+1,$offset);
   855|     if (empty($tabfield[$id]))
   856|     {
   857|     	dol_print_error($db, 'The table with id '.$id.' has no array tabfield defined');
   858|     	exit;
   859|     }
   860|     $fieldlist=explode(',',$tabfield[$id]);
   861|     print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
   862|     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   863|     print '<input type="hidden" name="from" value="'.dol_escape_htmltag(GETPOST('from','alpha')).'">';
   864|     if ($tabname[$id])


# ====================================================================
# FILE: htdocs/admin/ecm.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-63 ---
    10|  * This program is distributed in the hope that it will be useful,
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    17|  */
    18| /**
    19|  *   	\file       htdocs/admin/ecm.php
    20|  *		\ingroup    core
    21|  *		\brief      Page to setup ECM (GED) module
    22|  */
    23| require '../main.inc.php';
    24| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    25| $langs->load("admin");
    26| if (! $user->admin) accessforbidden();
    27| /*
    28|  * Action
    29|  */
    30| if (preg_match('/set_(.*)/',$action,$reg))
    31| {
    32|     $code=$reg[1];
    33|     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
    34|     {
    35|         header("Location: ".$_SERVER["PHP_SELF"]);
    36|         exit;
    37|     }
    38|     else
    39|     {
    40|         dol_print_error($db);
    41|     }
    42| }
    43| if (preg_match('/del_(.*)/',$action,$reg))
    44| {
    45|     $code=$reg[1];
    46|     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    47|     {
    48|         header("Location: ".$_SERVER["PHP_SELF"]);
    49|         exit;
    50|     }
    51|     else
    52|     {
    53|         dol_print_error($db);
    54|     }
    55| }
    56| /*
    57|  * View
    58|  */
    59| $help_url='';
    60| llxHeader('',$langs->trans("ECMSetup"),$help_url);
    61| $linkback='<a href="'.DOL_URL_ROOT.'/admin/modules.php?restore_lastsearch_values=1">'.$langs->trans("BackToModuleList").'</a>';
    62| print load_fiche_titre($langs->trans("ECMSetup"),$linkback,'title_setup');
    63| print '<br>';


# ====================================================================
# FILE: htdocs/admin/mails_templates.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 31-72 ---
    31|  *		\brief      Page to administer emails templates
    32|  */
    33| require '../main.inc.php';
    34| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formadmin.class.php';
    35| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';
    36| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    37| require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
    38| require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';
    39| require_once DOL_DOCUMENT_ROOT.'/core/lib/accounting.lib.php';
    40| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formaccounting.class.php';
    41| $langs->loadLangs(array("errors","admin","mails","languages"));
    42| $action     = GETPOST('action','alpha')?GETPOST('action','alpha'):'view';
    43| $confirm    = GETPOST('confirm','alpha');												// Result of a confirmation
    44| $id			= GETPOST('id','int');
    45| $rowid		= GETPOST('rowid','alpha');
    46| $search_label=GETPOST('search_label','alpha');
    47| $search_type_template=GETPOST('search_type_template','alpha');
    48| $search_lang=GETPOST('search_lang','alpha');
    49| $search_fk_user=GETPOST('search_fk_user','intcomma');
    50| $search_topic=GETPOST('search_topic','alpha');
    51| $allowed=1;
    52| if (! $allowed) accessforbidden();
    53| $acts[0] = "activate";
    54| $acts[1] = "disable";
    55| $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
    56| $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
    57| $listoffset=GETPOST('listoffset','alpha');
    58| $listlimit =GETPOST('listlimit','alpha')>0?GETPOST('listlimit','alpha'):1000;
    59| $active = 1;
    60| $sortfield = GETPOST("sortfield",'alpha');
    61| $sortorder = GETPOST("sortorder",'alpha');
    62| $page = GETPOST("page",'int');
    63| if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
    64| $offset = $listlimit * $page ;
    65| $pageprev = $page - 1;
    66| $pagenext = $page + 1;
    67| if (empty($sortfield)) $sortfield='label, lang, position';
    68| if (empty($sortorder)) $sortorder='ASC';
    69| $hookmanager->initHooks(array('emailtemplates'));
    70| $tabname=array();
    71| $tabname[25]= MAIN_DB_PREFIX."c_email_templates";
    72| $tabsqlsort=array();

# --- HUNK 2: Lines 319-374 ---
   319| {
   320|     print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid.'&code='.$code.'&id='.$id, $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
   321| }
   322| $sql="SELECT rowid as rowid, label, type_template, lang, fk_user, private, position, topic, joinfiles, content_lines, content, active";
   323| $sql.=" FROM ".MAIN_DB_PREFIX."c_email_templates";
   324| $sql.=" WHERE entity IN (".getEntity('email_template').")";
   325| if (! $user->admin)
   326| {
   327| 	$sql.=" AND (private = 0 OR (private = 1 AND fk_user = ".$user->id."))";	// Show only public and private to me
   328| 	$sql.=" AND (active = 1 OR fk_user = ".$user->id.")";						// Show only active or owned by me
   329| }
   330| if (empty($conf->global->MAIN_MULTILANGS))
   331| {
   332| 	$sql.= " AND (lang = '".$langs->defaultlang."' OR lang IS NULL OR lang = '')";
   333| }
   334| if ($search_label) $sql.=natural_search('label', $search_label);
   335| if ($search_type_template != '' && $search_type_template != '-1') $sql.=natural_search('type_template', $search_type_template);
   336| if ($search_lang) $sql.=natural_search('lang', $search_lang);
   337| if ($search_fk_user != '' && $search_fk_user != '-1') $sql.=natural_search('fk_user', $search_fk_user, 2);
   338| if ($search_topic) $sql.=natural_search('topic', $search_topic);
   339| if ($sortfield)
   340| {
   341| 	if ($sortfield == 'country') $sortfield='country_code';
   342|     $sql.= " ORDER BY ".$sortfield;
   343|     if ($sortorder)
   344|     {
   345|         $sql.=" ".strtoupper($sortorder);
   346|     }
   347|     $sql.=", ";
   348|     $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
   349|     $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
   350| }
   351| else {
   352|     $sql.=" ORDER BY ";
   353| }
   354| $sql.=$tabsqlsort[$id];
   355| $sql.=$db->plimit($listlimit+1,$offset);
   356| $fieldlist=explode(',',$tabfield[$id]);
   357| $alabelisused=0;
   358| $var=false;
   359| print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
   360| print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   361| print '<input type="hidden" name="from" value="'.dol_escape_htmltag(GETPOST('from','alpha')).'">';
   362| print '<div class="div-table-responsive-no-min">';
   363| print '<table class="noborder" width="100%">';
   364| print '<tr class="liste_titre">';
   365| foreach ($fieldlist as $field => $value)
   366| {
   367|         $valuetoshow=ucfirst($fieldlist[$field]);   // Par defaut
   368|         $valuetoshow=$langs->trans($valuetoshow);   // try to translate
   369|         $align="left";
   370|         if ($fieldlist[$field]=='fk_user')         { $valuetoshow=$langs->trans("Owner");}
   371|         if ($fieldlist[$field]=='lang')            { $valuetoshow=(empty($conf->global->MAIN_MULTILANGS) ? '&nbsp;' : $langs->trans("Language")); }
   372|         if ($fieldlist[$field]=='type')            { $valuetoshow=$langs->trans("Type"); }
   373|         if ($fieldlist[$field]=='code')            { $valuetoshow=$langs->trans("Code"); }
   374|         if ($fieldlist[$field]=='libelle' || $fieldlist[$field]=='label') { $valuetoshow=$langs->trans("Label"); }


# ====================================================================
# FILE: htdocs/admin/modules.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 50-92 ---
    50| $dolistore            = new Dolistore();
    51| if (! $user->admin)
    52| 	accessforbidden();
    53| $specialtostring=array(0=>'common', 1=>'interfaces', 2=>'other', 3=>'functional', 4=>'marketplace');
    54| $familyinfo=array(
    55| 	'hr'=>array('position'=>'001', 'label'=>$langs->trans("ModuleFamilyHr")),
    56| 	'crm'=>array('position'=>'006', 'label'=>$langs->trans("ModuleFamilyCrm")),
    57| 	'srm'=>array('position'=>'007', 'label'=>$langs->trans("ModuleFamilySrm")),
    58|     'financial'=>array('position'=>'009', 'label'=>$langs->trans("ModuleFamilyFinancial")),
    59| 	'products'=>array('position'=>'012', 'label'=>$langs->trans("ModuleFamilyProducts")),
    60| 	'projects'=>array('position'=>'015', 'label'=>$langs->trans("ModuleFamilyProjects")),
    61| 	'ecm'=>array('position'=>'018', 'label'=>$langs->trans("ModuleFamilyECM")),
    62| 	'technic'=>array('position'=>'021', 'label'=>$langs->trans("ModuleFamilyTechnic")),
    63| 	'portal'=>array('position'=>'040', 'label'=>$langs->trans("ModuleFamilyPortal")),
    64| 	'interface'=>array('position'=>'050', 'label'=>$langs->trans("ModuleFamilyInterface")),
    65| 	'base'=>array('position'=>'060', 'label'=>$langs->trans("ModuleFamilyBase")),
    66| 	'other'=>array('position'=>'100', 'label'=>$langs->trans("ModuleFamilyOther")),
    67| );
    68| $param='';
    69| if ($search_keyword) $param.='&search_keyword='.urlencode($search_keyword);
    70| if ($search_status > -1)  $param.='&search_status='.urlencode($search_status);
    71| if ($search_nature > -1)  $param.='&search_nature='.urlencode($search_nature);
    72| if ($search_version > -1) $param.='&search_version='.urlencode($search_version);
    73| $dirins=DOL_DOCUMENT_ROOT.'/custom';
    74| $urldolibarrmodules='https://www.dolistore.com/';
    75| $hookmanager->initHooks(array('adminmodules','globaladmin'));
    76| /*
    77|  * Actions
    78|  */
    79| $formconfirm = '';
    80| $parameters=array();
    81| $reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
    82| if ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');
    83| if (GETPOST('buttonreset','alpha'))
    84| {
    85|     $search_keyword='';
    86|     $search_status='';
    87|     $search_nature='';
    88|     $search_version='';
    89| }
    90| if ($action=='install')
    91| {
    92|     $error=0;

# --- HUNK 2: Lines 354-394 ---
   354| 		if(!empty($objMod->langfiles)) $langs->loadLangs($objMod->langfiles);
   355| 		$form = new Form($db);
   356| 		$formconfirm = $form->formconfirm($_SERVER["PHP_SELF"] . '?value='.$value.'&mode='.$mode.$param, $langs->trans('ConfirmUnactivation'), $langs->trans(GETPOST('confirm_message_code')), 'reset', '', 'no', 1);
   357| 	}
   358| }
   359| print $formconfirm;
   360| asort($orders);
   361| $nbofactivatedmodules=count($conf->modules);
   362| $moreinfo=$langs->trans("TotalNumberOfActivatedModules",($nbofactivatedmodules-1), count($modules));
   363| if ($nbofactivatedmodules <= 1) $moreinfo .= ' '.img_warning($langs->trans("YouMustEnableOneModule"));
   364| print load_fiche_titre($langs->trans("ModulesSetup"),$moreinfo,'title_setup');
   365| if ($mode=='common')      print '<span class="opacitymedium">'.$langs->trans("ModulesDesc")."</span><br>\n";
   366| if ($mode=='marketplace') print '<span class="opacitymedium">'.$langs->trans("ModulesMarketPlaceDesc")."</span><br>\n";
   367| if ($mode=='deploy')      print '<span class="opacitymedium">'.$langs->trans("ModulesDeployDesc", $langs->transnoentitiesnoconv("AvailableModules"))."</span><br>\n";
   368| if ($mode=='develop')     print '<span class="opacitymedium">'.$langs->trans("ModulesDevelopDesc")."</span><br>\n";
   369| $head = modules_prepare_head();
   370| print "<br>\n";
   371| if ($mode == 'common')
   372| {
   373|     dol_set_focus('#search_keyword');
   374|     print '<form method="GET" id="searchFormList" action="'.$_SERVER["PHP_SELF"].'">';
   375|     if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
   376|     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   377|     print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
   378|     print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
   379|     print '<input type="hidden" name="page" value="'.$page.'">';
   380|     dol_fiche_head($head, $mode, '', -1);
   381|     $moreforfilter = '';
   382|     $moreforfilter.='<div class="divsearchfield">';
   383|     $moreforfilter.= $langs->trans('Keyword') . ': <input type="text" id="search_keyword" name="search_keyword" value="'.dol_escape_htmltag($search_keyword).'">';
   384|     $moreforfilter.= '</div>';
   385|     $moreforfilter.='<div class="divsearchfield">';
   386|     $moreforfilter.= $langs->trans('Origin') . ': '.$form->selectarray('search_nature', $arrayofnatures, dol_escape_htmltag($search_nature), 1);
   387|     $moreforfilter.= '</div>';
   388|     if (! empty($conf->global->MAIN_FEATURES_LEVEL))
   389|     {
   390|         $array_version = array('stable'=>$langs->transnoentitiesnoconv("Stable"));
   391|         if ($conf->global->MAIN_FEATURES_LEVEL < 0) $array_version['deprecated']=$langs->trans("Deprecated");
   392|         if ($conf->global->MAIN_FEATURES_LEVEL > 0) $array_version['experimental']=$langs->trans("Experimental");
   393|         if ($conf->global->MAIN_FEATURES_LEVEL > 1) $array_version['development']=$langs->trans("Development");
   394|         $moreforfilter.='<div class="divsearchfield">';


# ====================================================================
# FILE: htdocs/admin/multicurrency.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-70 ---
    17|  */
    18| /**
    19|  * 	\file		admin/multicurrency.php
    20|  * 	\ingroup	multicurrency
    21|  * 	\brief		This file is an example module setup page
    22|  * 				Put some comments here
    23|  */
    24| require '../main.inc.php';
    25| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    26| require_once DOL_DOCUMENT_ROOT.'/core/lib/multicurrency.lib.php';
    27| require_once DOL_DOCUMENT_ROOT.'/multicurrency/class/multicurrency.class.php';
    28| $langs->load("admin");
    29| $langs->load("multicurrency");
    30| if (! $user->admin) {
    31|     accessforbidden();
    32| }
    33| $action = GETPOST('action', 'alpha');
    34| /*
    35|  * Actions
    36|  */
    37| if (preg_match('/set_(.*)/',$action,$reg))
    38| {
    39| 	$code=$reg[1];
    40| 	if (dolibarr_set_const($db, $code, GETPOST($code), 'chaine', 0, '', $conf->entity) > 0)
    41| 	{
    42| 		header("Location: ".$_SERVER["PHP_SELF"]);
    43| 		exit;
    44| 	}
    45| 	else
    46| 	{
    47| 		dol_print_error($db);
    48| 	}
    49| }
    50| if (preg_match('/del_(.*)/',$action,$reg))
    51| {
    52| 	$code=$reg[1];
    53| 	if (dolibarr_del_const($db, $code, 0) > 0)
    54| 	{
    55| 		header("Location: ".$_SERVER["PHP_SELF"]);
    56| 		exit;
    57| 	}
    58| 	else
    59| 	{
    60| 		dol_print_error($db);
    61| 	}
    62| }
    63| if ($action == 'add_currency')
    64| {
    65| 	$error=0;
    66| 	$langs->loadCacheCurrencies('');
    67| 	$code = GETPOST('code', 'alpha');
    68| 	$rate = price2num(GETPOST('rate', 'alpha'));
    69| 	$currency = new MultiCurrency($db);
    70| 	$currency->code = $code;


# ====================================================================
# FILE: htdocs/admin/payment.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 179-215 ---
   179| }
   180| print '</table>';
   181| print "<br>";
   182| print load_fiche_titre($langs->trans("OtherOptions"),'','');
   183| print '<form action="'.$_SERVER["PHP_SELF"].'" method="POST">';
   184| print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'" />';
   185| print '<input type="hidden" name="action" value="setparams" />';
   186| print '<table class="noborder" width="100%">';
   187| print '<tr class="liste_titre">';
   188| print '<td>'.$langs->trans("Parameter").'</td>';
   189| print '<td align="center" width="60">'.$langs->trans("Value").'</td>';
   190| print '<td width="80">&nbsp;</td>';
   191| print "</tr>\n";
   192| $var=! $var;
   193| print '<tr class="oddeven"><td>';
   194| print $langs->trans("PaymentOnDifferentThirdBills");
   195| print '</td><td width="60" align="center">';
   196| print $form->selectyesno("FACTURE_PAYMENTS_ON_DIFFERENT_THIRDPARTIES_BILLS",$conf->global->FACTURE_PAYMENTS_ON_DIFFERENT_THIRDPARTIES_BILLS,1);
   197| print '</td><td align="right">';
   198| print "</td></tr>\n";
   199| /* always on now
   200| $var=! $var;
   201| print '<tr class="oddeven"><td>';
   202| print $langs->trans("JSOnPaimentBill");
   203| print '</td><td width="60" align="center">';
   204| print $form->selectyesno("INVOICE_AUTO_FILLJS",$conf->global->INVOICE_AUTO_FILLJS,1);
   205| print '</td><td align="right">';
   206| print "</td></tr>\n";
   207| */
   208| print '</table>';
   209| print '<center>';
   210| print '<input type="submit" class="button" value="'.$langs->trans("Modify").'" />';
   211| print '</center>';
   212| print '</form>';
   213| dol_fiche_end();
   214| llxFooter();
   215| $db->close();


# ====================================================================
# FILE: htdocs/admin/security_file.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-104 ---
    23|  */
    24| require '../main.inc.php';
    25| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    26| require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
    27| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';
    28| $langs->load("users");
    29| $langs->load("admin");
    30| $langs->load("other");
    31| if (! $user->admin)
    32| 	accessforbidden();
    33| $action=GETPOST('action','alpha');
    34| $upload_dir=$conf->admin->dir_temp;
    35| /*
    36|  * Actions
    37|  */
    38| if (GETPOST('sendit') && ! empty($conf->global->MAIN_UPLOAD_DOC))
    39| {
    40|     require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
    41|     dol_add_file_process($upload_dir, 0, 0, 'userfile');
    42| }
    43| if (preg_match('/set_(.*)/',$action,$reg))
    44| {
    45| 	$code=$reg[1];
    46| 	$value=(GETPOST($code, 'alpha') ? GETPOST($code, 'alpha') : 1);
    47| 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
    48| 	{
    49| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    50| 		exit;
    51| 	}
    52| 	else
    53| 	{
    54| 		dol_print_error($db);
    55| 	}
    56| }
    57| else if (preg_match('/del_(.*)/',$action,$reg))
    58| {
    59| 	$code=$reg[1];
    60| 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    61| 	{
    62| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    63| 		exit;
    64| 	}
    65| 	else
    66| 	{
    67| 		dol_print_error($db);
    68| 	}
    69| }
    70| else if ($action == 'updateform')
    71| {
    72| 	$res3=dolibarr_set_const($db, 'MAIN_UPLOAD_DOC',GETPOST('MAIN_UPLOAD_DOC','alpha'),'chaine',0,'',$conf->entity);
    73| 	$res4=dolibarr_set_const($db, "MAIN_UMASK", GETPOST('MAIN_UMASK','alpha'),'chaine',0,'',$conf->entity);
    74| 	$res5=dolibarr_set_const($db, "MAIN_ANTIVIRUS_COMMAND", trim(GETPOST('MAIN_ANTIVIRUS_COMMAND','none')),'chaine',0,'',$conf->entity);    // Use GETPOST none because we must accept "
    75| 	$res6=dolibarr_set_const($db, "MAIN_ANTIVIRUS_PARAM", trim(GETPOST('MAIN_ANTIVIRUS_PARAM','none')),'chaine',0,'',$conf->entity);	// Use GETPOST none because we must accept "
    76| 	if ($res3 && $res4 && $res5 && $res6) setEventMessages($langs->trans("RecordModifiedSuccessfully"), null, 'mesgs');
    77| }
    78| else if ($action == 'delete')
    79| {
    80| 	$langs->load("other");
    81| 	$file = $conf->admin->dir_temp . '/' . GETPOST('urlfile');	// Do not use urldecode here ($_GET and $_REQUEST are already decoded by PHP).
    82| 	$ret=dol_delete_file($file);
    83| 	if ($ret) setEventMessages($langs->trans("FileWasRemoved", GETPOST('urlfile')), null, 'mesgs');
    84| 	else setEventMessages($langs->trans("ErrorFailToDeleteFile", GETPOST('urlfile')), null, 'errors');
    85| 	Header('Location: '.$_SERVER["PHP_SELF"]);
    86| 	exit;
    87| }
    88| /*
    89|  * View
    90|  */
    91| $form = new Form($db);
    92| $wikihelp='EN:Setup_Security|FR:Paramtrage_Scurit|ES:Configuracin_Seguridad';
    93| llxHeader('',$langs->trans("Files"),$wikihelp);
    94| print load_fiche_titre($langs->trans("SecuritySetup"),'','title_setup');
    95| print $langs->trans("SecurityFilesDesc")."<br>\n";
    96| print "<br>\n";
    97| print '<form action="'.$_SERVER["PHP_SELF"].'" method="POST">';
    98| print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
    99| print '<input type="hidden" name="action" value="updateform">';
   100| $head=security_prepare_head();
   101| dol_fiche_head($head, 'file', $langs->trans("Security"), -1);
   102| $var=false;
   103| print '<div class="div-table-responsive-no-min">';
   104| print '<table class="noborder" width="100%">';


# ====================================================================
# FILE: htdocs/admin/security_other.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-71 ---
    17|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    18|  */
    19| /**
    20|  *	    \file       htdocs/admin/security_other.php
    21|  *      \ingroup    core
    22|  *      \brief      Security options setup
    23|  */
    24| require '../main.inc.php';
    25| require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
    26| require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
    27| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';
    28| $langs->load("users");
    29| $langs->load("admin");
    30| $langs->load("other");
    31| if (! $user->admin)
    32| 	accessforbidden();
    33| $action=GETPOST('action','alpha');
    34| /*
    35|  * Actions
    36|  */
    37| if (preg_match('/set_(.*)/',$action,$reg))
    38| {
    39| 	$code=$reg[1];
    40| 	$value=(GETPOST($code) ? GETPOST($code) : 1);
    41| 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
    42| 	{
    43| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    44| 		exit;
    45| 	}
    46| 	else
    47| 	{
    48| 		dol_print_error($db);
    49| 	}
    50| }
    51| else if (preg_match('/del_(.*)/',$action,$reg))
    52| {
    53| 	$code=$reg[1];
    54| 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    55| 	{
    56| 		Header("Location: ".$_SERVER["PHP_SELF"]);
    57| 		exit;
    58| 	}
    59| 	else
    60| 	{
    61| 		dol_print_error($db);
    62| 	}
    63| }
    64| else if ($action == 'updateform')
    65| {
    66| 	$res1=dolibarr_set_const($db, "MAIN_APPLICATION_TITLE", $_POST["MAIN_APPLICATION_TITLE"],'chaine',0,'',$conf->entity);
    67|     $res2=dolibarr_set_const($db, "MAIN_SESSION_TIMEOUT", $_POST["MAIN_SESSION_TIMEOUT"],'chaine',0,'',$conf->entity);
    68| 	if ($res1 && $res2) setEventMessages($langs->trans("RecordModifiedSuccessfully"), null, 'mesgs');
    69| }
    70| /*
    71|  * View


# ====================================================================
# FILE: htdocs/admin/user.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 52-105 ---
    52| 	$ret = delDocumentModel($value, $type);
    53| 	if ($ret > 0)
    54| 	{
    55|         if ($conf->global->USER_ADDON_PDF_ODT == "$value") dolibarr_del_const($db, 'USER_ADDON_PDF_ODT',$conf->entity);
    56| 	}
    57| 	$res = true;
    58| }
    59| elseif ($action == 'setdoc')
    60| {
    61| 	if (dolibarr_set_const($db, "USER_ADDON_PDF_ODT",$value,'chaine',0,'',$conf->entity))
    62| 	{
    63| 		$conf->global->USER_ADDON_PDF_ODT = $value;
    64| 	}
    65| 	$ret = delDocumentModel($value, $type);
    66| 	if ($ret > 0)
    67| 	{
    68| 		$ret = addDocumentModel($value, $type, $label, $scandir);
    69| 	}
    70| 	$res = true;
    71| }
    72| elseif (preg_match('/set_(.*)/',$action,$reg))
    73| {
    74|     $code=$reg[1];
    75|     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
    76|     {
    77|         header("Location: ".$_SERVER["PHP_SELF"]);
    78|         exit;
    79|     }
    80|     else
    81|     {
    82|         dol_print_error($db);
    83|     }
    84| }
    85| elseif (preg_match('/del_(.*)/',$action,$reg))
    86| {
    87|     $code=$reg[1];
    88|     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    89|     {
    90|         header("Location: ".$_SERVER["PHP_SELF"]);
    91|         exit;
    92|     }
    93|     else
    94|     {
    95|         dol_print_error($db);
    96|     }
    97| }
    98| elseif ($action == 'sethideinactiveuser')
    99| {
   100| 	$status = GETPOST('status','alpha');
   101| 	if (dolibarr_set_const($db, "USER_HIDE_INACTIVE_IN_COMBOBOX",$status,'chaine',0,'',$conf->entity) > 0)
   102| 	{
   103| 		header("Location: ".$_SERVER["PHP_SELF"]);
   104| 		exit;
   105| 	}


# ====================================================================
# FILE: htdocs/admin/usergroup.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 51-104 ---
    51| 	$ret = delDocumentModel($value, $type);
    52| 	if ($ret > 0)
    53| 	{
    54|         if ($conf->global->USERGROUP_ADDON_PDF_ODT == "$value") dolibarr_del_const($db, 'USERGROUP_ADDON_PDF_ODT',$conf->entity);
    55| 	}
    56| 	$res = true;
    57| }
    58| elseif ($action == 'setdoc')
    59| {
    60| 	if (dolibarr_set_const($db, "USERGROUP_ADDON_PDF_ODT",$value,'chaine',0,'',$conf->entity))
    61| 	{
    62| 		$conf->global->USERGROUP_ADDON_PDF_ODT = $value;
    63| 	}
    64| 	$ret = delDocumentModel($value, $type);
    65| 	if ($ret > 0)
    66| 	{
    67| 		$ret = addDocumentModel($value, $type, $label, $scandir);
    68| 	}
    69| 	$res = true;
    70| }
    71| elseif (preg_match('/set_(.*)/',$action,$reg))
    72| {
    73|     $code=$reg[1];
    74|     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
    75|     {
    76|         header("Location: ".$_SERVER["PHP_SELF"]);
    77|         exit;
    78|     }
    79|     else
    80|     {
    81|         dol_print_error($db);
    82|     }
    83| }
    84| elseif (preg_match('/del_(.*)/',$action,$reg))
    85| {
    86|     $code=$reg[1];
    87|     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    88|     {
    89|         header("Location: ".$_SERVER["PHP_SELF"]);
    90|         exit;
    91|     }
    92|     else
    93|     {
    94|         dol_print_error($db);
    95|     }
    96| }
    97| /*
    98|  * View
    99|  */
   100| $help_url='EN:Module_Users|FR:Module_Utilisateurs|ES:M&oacute;dulo_Usuarios';
   101| llxHeader('',$langs->trans("UsersSetup"),$help_url);
   102| $linkback='<a href="'.DOL_URL_ROOT.'/admin/modules.php?restore_lastsearch_values=1">'.$langs->trans("BackToModuleList").'</a>';
   103| print load_fiche_titre($langs->trans("UsersSetup"),$linkback,'title_setup');
   104| $head=user_admin_prepare_head();


# ====================================================================
# FILE: htdocs/admin/website.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 301-355 ---
   301|  * View
   302|  */
   303| $form = new Form($db);
   304| $formadmin=new FormAdmin($db);
   305| llxHeader('', $langs->trans("WebsiteSetup"));
   306| $titre=$langs->trans("WebsiteSetup");
   307| $linkback='<a href="'.($backtopage?$backtopage:DOL_URL_ROOT.'/admin/modules.php').'">'.$langs->trans("BackToModuleList").'</a>';
   308| print load_fiche_titre($titre,$linkback,'title_setup');
   309| print $langs->trans("WebsiteSetupDesc").'<br>';
   310| print "<br>\n";
   311| if ($action == 'delete')
   312| {
   313|     print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid, $langs->trans('DeleteWebsite'), $langs->trans('ConfirmDeleteWebsite'), 'confirm_delete','',0,1);
   314| }
   315| /*
   316|  * Show website list
   317|  */
   318| if ($id)
   319| {
   320|     $sql=$tabsql[$id];
   321|     if ($sortfield)
   322|     {
   323|         $sql.= " ORDER BY ".$sortfield;
   324|         if ($sortorder)
   325|         {
   326|             $sql.=" ".strtoupper($sortorder);
   327|         }
   328|         $sql.=", ";
   329|         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
   330|         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
   331|     }
   332|     else {
   333|         $sql.=" ORDER BY ";
   334|     }
   335|     $sql.=$tabsqlsort[$id];
   336|     $sql.=$db->plimit($limit+1, $offset);
   337|     $fieldlist=explode(',',$tabfield[$id]);
   338|     print '<form action="'.$_SERVER['PHP_SELF'].'" method="POST">';
   339|     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   340|     print '<table class="noborder" width="100%">';
   341|     if ($tabname[$id])
   342|     {
   343|         $alabelisused=0;
   344|         $var=false;
   345|         $fieldlist=explode(',',$tabfield[$id]);
   346|         print '<tr class="liste_titre">';
   347|         foreach ($fieldlist as $field => $value)
   348|         {
   349|             $valuetoshow=ucfirst($fieldlist[$field]);   // Par defaut
   350|             $valuetoshow=$langs->trans($valuetoshow);   // try to translate
   351|             $align='';
   352|             if ($fieldlist[$field]=='lang')            { $valuetoshow=$langs->trans("Language"); }
   353|             if ($valuetoshow != '')
   354|             {
   355|                 print '<td class="'.$align.'">';


# ====================================================================
# FILE: htdocs/blockedlog/class/blockedlog.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 238-282 ---
   238| 	{
   239| 		global $langs, $cachedUser;
   240| 		if(empty($cachedUser))$cachedUser=array();
   241| 		if(empty($cachedUser[$this->fk_user])) {
   242| 			$u=new User($this->db);
   243| 			if($u->fetch($this->fk_user)>0) {
   244| 				$cachedUser[$this->fk_user] = $u;
   245| 			}
   246| 		}
   247| 		if(!empty($cachedUser[$this->fk_user])) {
   248| 			return $cachedUser[$this->fk_user]->getNomUrl(1);
   249| 		}
   250| 		return $langs->trans('ImpossibleToRetrieveUser', $this->fk_user);
   251| 	}
   252| 	/**
   253| 	 *      Populate properties of log from object data
   254| 	 *
   255| 	 *      @param		Object		$object     object to store
   256| 	 *      @param		string		$action     action
   257| 	 *      @param		string		$amounts    amounts
   258| 	 *      @return		int						>0 if OK, <0 if KO
   259| 	 */
   260| 	public function setObjectData(&$object, $action, $amounts)
   261| 	{
   262| 		global $langs, $user, $mysoc;
   263| 		$this->action = $action;
   264| 		$this->amounts= $amounts;
   265| 		if ($object->element == 'payment' || $object->element == 'payment_supplier')
   266| 		{
   267| 			$this->date_object = $object->datepaye;
   268| 		}
   269| 		elseif ($object->element=='payment_salary')
   270| 		{
   271| 			$this->date_object = $object->datev;
   272| 		}
   273| 		elseif ($object->element == 'payment_donation' || $object->element == 'payment_various')
   274| 		{
   275| 			$this->date_object = $object->datepaid?$object->datepaid:$object->datep;
   276| 		}
   277| 		elseif ($object->element=='subscription')
   278| 		{
   279| 			$this->date_object = $object->dateh;
   280| 		}
   281| 		else {
   282| 			$this->date_object = $object->date;


# ====================================================================
# FILE: htdocs/cashdesk/tpl/facturation1.tpl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 140-188 ---
   140| <?php print genkeypad("txtEncaisse", "frmDifference");?>
   141| 			</td>
   142| 			<!-- Affichage du montant rendu -->
   143| 			<td><input class="texte2_off maxwidth100onsmartphone" type="text" name="txtRendu" value="0" disabled /></td>
   144| 			</tr>
   145| 			<tr>
   146| 		</table>
   147| </fieldset>
   148| <fieldset class="cadre_facturation"><legend class="titre1"><?php echo $langs->trans("PaymentMode"); ?></legend>
   149| 		<div class="inline-block">
   150| 			<?php
   151| 			print '<div class="inline-block" style="margin: 6px;">';
   152| 			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CASH']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CASH'] < 0)
   153| 			{
   154| 				$langs->load("errors");
   155| 				print '<input class="bouton_mode_reglement_disabled" type="button" name="btnModeReglement" value="'.$langs->trans("Cash").'" title="'.dol_escape_htmltag($langs->trans("ErrorModuleSetupNotComplete")).'" />';
   156| 			}
   157| 			else print '<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="'.$langs->trans("Cash").'" onclick="javascript: verifClic(\'ESP\');" />';
   158| 			print '</div>';
   159| 			print '<div class="inline-block" style="margin: 6px;">';
   160| 			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CHEQUE']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CHEQUE'] < 0)
   161| 			{
   162| 				$langs->load("errors");
   163| 				print '<input class="bouton_mode_reglement_disabled" type="button" name="btnModeReglement" value="'.$langs->trans("CreditCard").'" title="'.dol_escape_htmltag($langs->trans("ErrorModuleSetupNotComplete")).'" />';
   164| 			}
   165| 			else print '<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="'.$langs->trans("CreditCard").'" onclick="javascript: verifClic(\'CB\');" />';
   166| 			print '</div>';
   167| 			print '<div class="inline-block" style="margin: 6px;">';
   168| 			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CB']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CB'] < 0)
   169| 			{
   170| 				$langs->load("errors");
   171| 				print '<input class="bouton_mode_reglement_disabled" type="button" name="btnModeReglement" value="'.$langs->trans("CheckBank").'" title="'.dol_escape_htmltag($langs->trans("ErrorModuleSetupNotComplete")).'" />';
   172| 			}
   173| 			else print '<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="'.$langs->trans("CheckBank").'" onclick="javascript: verifClic(\'CHQ\');" />';
   174| 			print '</div>';
   175| 			print '<div class="clearboth">';
   176| 			print '<div class="inline-block" style="margin: 6px;">';
   177| 			?>
   178| 				<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="<?php echo $langs->trans("Reported"); ?>" onclick="javascript: verifClic('DIF');" />
   179| 			<?php
   180| 			print $langs->trans("DateDue").' :';
   181| 			print $form->select_date(-1,'txtDatePaiement',0,0,0,'paymentmode',1,0,1);
   182| 			print '</div>';
   183| 			?>
   184| 		</div>
   185| </fieldset>
   186| </form>
   187| <script type="text/javascript">
   188| /*	Calendar.setup ({


# ====================================================================
# FILE: htdocs/categories/admin/categorie.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 13-66 ---
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    18|  */
    19| /**
    20|  *	    \file       htdocs/categories/admin/categorie.php
    21|  *      \ingroup    categories
    22|  *      \brief      Categorie admin pages
    23|  */
    24| require '../../main.inc.php';
    25| require_once DOL_DOCUMENT_ROOT.'/core/lib/categories.lib.php';
    26| if (!$user->admin)
    27| accessforbidden();
    28| $langs->load("categories");
    29| $action=GETPOST('action','aZ09');
    30| /*
    31|  *	Actions
    32|  */
    33| if (preg_match('/set_(.*)/',$action,$reg))
    34| {
    35|     $code=$reg[1];
    36|     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
    37|     {
    38|         header("Location: ".$_SERVER["PHP_SELF"]);
    39|         exit;
    40|     }
    41|     else
    42|     {
    43|         setEventMessages($db->lasterror(), null, 'errors');
    44|     }
    45| }
    46| if (preg_match('/del_(.*)/',$action,$reg))
    47| {
    48|     $code=$reg[1];
    49|     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
    50|     {
    51|         header("Location: ".$_SERVER["PHP_SELF"]);
    52|         exit;
    53|     }
    54|     else
    55|     {
    56|          setEventMessages($db->lasterror(), null, 'errors');
    57|     }
    58| }
    59| /*
    60|  * View
    61|  */
    62| $help_url='EN:Module Categories|FR:Module Catgories|ES:Mdulo Categoras';
    63| $linkback='<a href="'.DOL_URL_ROOT.'/admin/modules.php?restore_lastsearch_values=1">'.$langs->trans("BackToModuleList").'</a>';
    64| llxHeader('',$langs->trans("Categories"),$help_url);
    65| $linkback='<a href="'.DOL_URL_ROOT.'/admin/modules.php?restore_lastsearch_values=1">'.$langs->trans("BackToModuleList").'</a>';
    66| print load_fiche_titre($langs->trans("CategoriesSetup"),$linkback,'title_setup');


# ====================================================================
# FILE: htdocs/categories/viewcat.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 561-601 ---
   561| }
   562| if ($type == Categorie::TYPE_PROJECT)
   563| {
   564| 	require_once DOL_DOCUMENT_ROOT.'/projet/class/project.class.php';
   565| 	$projects = $object->getObjectsInCateg("project");
   566| 	if ($projects < 0)
   567| 	{
   568| 		dol_print_error($db, $object->error, $object->errors);
   569| 	}
   570| 	else
   571| 	{
   572| 		print "<br>";
   573| 		print "<table class='noborder' width='100%'>\n";
   574| 		print '<tr class="liste_titre"><td colspan="4">'.$langs->trans("Project")."</td></tr>\n";
   575| 		if (count($projects) > 0)
   576| 		{
   577| 			foreach ($projects as $key => $project)
   578| 			{
   579| 				print "\t".'<tr class="oddeven">'."\n";
   580| 				print '<td class="nowrap" valign="top">';
   581| 				print $project->getNomUrl(1,0);
   582| 				print "</td>\n";
   583| 				print '<td class="tdtop">'.$project->ref."</td>\n";
   584| 				print '<td class="tdtop">'.$project->title."</td>\n";
   585| 				print '<td align="right">';
   586| 				$typeid=$object->type;
   587| 				$permission=0;
   588| 				if ($typeid == Categorie::TYPE_PRODUCT)     $permission=($user->rights->produit->creer || $user->rights->service->creer);
   589| 				if ($typeid == Categorie::TYPE_SUPPLIER)    $permission=$user->rights->societe->creer;
   590| 				if ($typeid == Categorie::TYPE_CUSTOMER)    $permission=$user->rights->societe->creer;
   591| 				if ($typeid == Categorie::TYPE_MEMBER)      $permission=$user->rights->adherent->creer;
   592| 				if ($typeid == Categorie::TYPE_ACCOUNT)      $permission=$user->rights->banque->configurer;
   593| 				if ($typeid == Categorie::TYPE_PROJECT)     $permission=$user->rights->projet->creer;
   594| 				if ($permission)
   595| 				{
   596| 					print "<a href= '".$_SERVER['PHP_SELF']."?".(empty($socid)?'id':'socid')."=".$object->id."&amp;type=".$typeid."&amp;removeelem=".$project->id."'>";
   597| 					print img_delete($langs->trans("DeleteFromCat")).' ';
   598| 					print $langs->trans("DeleteFromCat")."</a>";
   599| 				}
   600| 				print "</tr>\n";
   601| 			}


# ====================================================================
# FILE: htdocs/comm/action/class/api_agendaevents.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 78-123 ---
    78|      * Get a list of Agenda Events
    79|      *
    80|      * @param string	$sortfield	Sort field
    81|      * @param string	$sortorder	Sort order
    82|      * @param int		$limit		Limit for list
    83|      * @param int		$page		Page number
    84|      * @param string   	$user_ids   User ids filter field (owners of event). Example: '1' or '1,2,3'          {@pattern /^[0-9,]*$/i}
    85|      * @param string    $sqlfilters Other criteria to filter answers separated by a comma. Syntax example "(t.label:like:'%dol%') and (t.datec:<:'20160101')"
    86|      * @return  array               Array of Agenda Events objects
    87|      */
    88|     function index($sortfield = "t.id", $sortorder = 'ASC', $limit = 100, $page = 0, $user_ids = 0, $sqlfilters = '') {
    89|         global $db, $conf;
    90|         $obj_ret = array();
    91|         if (! DolibarrApiAccess::$user->rights->agenda->myactions->read) {
    92|         	throw new RestException(401, "Insuffisant rights to read events");
    93|         }
    94|         $socid = 0;
    95|         if (! empty(DolibarrApiAccess::$user->socid)) $socid = DolibarrApiAccess::$user->socid;
    96|         $search_sale = 0;
    97|         if (! DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) $search_sale = DolibarrApiAccess::$user->id;
    98|         $sql = "SELECT t.id as rowid";
    99|         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql .= ", sc.fk_soc, sc.fk_user"; // We need these fields in order to filter by sale (including the case where the user can only see his prospects)
   100|         $sql.= " FROM ".MAIN_DB_PREFIX."actioncomm as t";
   101|         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc"; // We need this table joined to the select in order to filter by sale
   102|         $sql.= ' WHERE t.entity IN ('.getEntity('agenda').')';
   103|         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql.= " AND t.fk_soc = sc.fk_soc";
   104|         if ($user_ids) $sql.=" AND t.fk_user_action IN (".$user_ids.")";
   105|         if ($socid > 0) $sql.= " AND t.fk_soc = ".$socid;
   106|         if ($search_sale > 0)
   107|         {
   108|             $sql .= " AND sc.fk_user = ".$search_sale;
   109|         }
   110|         if ($sqlfilters)
   111|         {
   112|             if (! DolibarrApi::_checkFilters($sqlfilters))
   113|             {
   114|                 throw new RestException(503, 'Error when validating parameter sqlfilters '.$sqlfilters);
   115|             }
   116| 	        $regexstring='\(([^:\'\(\)]+:[^:\'\(\)]+:[^:\(\)]+)\)';
   117|             $sql.=" AND (".preg_replace_callback('/'.$regexstring.'/', 'DolibarrApi::_forge_criteria_callback', $sqlfilters).")";
   118|         }
   119|         $sql.= $db->order($sortfield, $sortorder);
   120|         if ($limit)	{
   121|             if ($page < 0)
   122|             {
   123|                 $page = 0;


# ====================================================================
# FILE: htdocs/comm/action/list.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 23-63 ---
    23|  *      \ingroup    agenda
    24|  *		\brief      Page to list actions
    25|  */
    26| require '../../main.inc.php';
    27| require_once DOL_DOCUMENT_ROOT.'/contact/class/contact.class.php';
    28| require_once DOL_DOCUMENT_ROOT.'/comm/action/class/actioncomm.class.php';
    29| require_once DOL_DOCUMENT_ROOT.'/core/lib/date.lib.php';
    30| require_once DOL_DOCUMENT_ROOT.'/core/lib/agenda.lib.php';
    31| include_once DOL_DOCUMENT_ROOT.'/core/class/html.formactions.class.php';
    32| $langs->load("users");
    33| $langs->load("companies");
    34| $langs->load("agenda");
    35| $langs->load("commercial");
    36| $action=GETPOST('action','alpha');
    37| $resourceid=GETPOST("resourceid","int");
    38| $year=GETPOST("year",'int');
    39| $month=GETPOST("month",'int');
    40| $day=GETPOST("day",'int');
    41| $pid=GETPOST("projectid",'int',3);
    42| $status=GETPOST("status",'alpha');
    43| $type=GETPOST('type');
    44| $optioncss = GETPOST('optioncss','alpha');
    45| if (GETPOST('actioncode','array'))
    46| {
    47|     $actioncode=GETPOST('actioncode','array',3);
    48|     if (! count($actioncode)) $actioncode='0';
    49| }
    50| else
    51| {
    52|     $actioncode=GETPOST("actioncode","alpha",3)?GETPOST("actioncode","alpha",3):(GETPOST("actioncode")=='0'?'0':(empty($conf->global->AGENDA_DEFAULT_FILTER_TYPE)?'':$conf->global->AGENDA_DEFAULT_FILTER_TYPE));
    53| }
    54| if ($actioncode == '' && empty($actioncodearray)) $actioncode=(empty($conf->global->AGENDA_DEFAULT_FILTER_TYPE)?'':$conf->global->AGENDA_DEFAULT_FILTER_TYPE);
    55| $search_title=GETPOST('search_title','alpha');
    56| $dateselect=dol_mktime(0, 0, 0, GETPOST('dateselectmonth','int'), GETPOST('dateselectday','int'), GETPOST('dateselectyear','int'));
    57| $datestart=dol_mktime(0, 0, 0, GETPOST('datestartmonth','int'), GETPOST('datestartday','int'), GETPOST('datestartyear','int'));
    58| $dateend=dol_mktime(0, 0, 0, GETPOST('dateendmonth','int'), GETPOST('dateendday','int'), GETPOST('dateendyear','int'));
    59| if ($status == ''   && ! isset($_GET['status']) && ! isset($_POST['status'])) $status=(empty($conf->global->AGENDA_DEFAULT_FILTER_STATUS)?'':$conf->global->AGENDA_DEFAULT_FILTER_STATUS);
    60| if (empty($action) && ! isset($_GET['action']) && ! isset($_POST['action'])) $action=(empty($conf->global->AGENDA_DEFAULT_VIEW)?'show_month':$conf->global->AGENDA_DEFAULT_VIEW);
    61| $filter = GETPOST("filter",'',3);
    62| $filtert = GETPOST("filtert","int",3);
    63| $usergroup = GETPOST("usergroup","int",3);

# --- HUNK 2: Lines 175-215 ---
   175| if ($pid) $param.="&projectid=".$pid;
   176| if ($type) $param.="&type=".$type;
   177| if ($usergroup) $param.="&usergroup=".$usergroup;
   178| if ($optioncss != '') $param.='&optioncss='.$optioncss;
   179| if ($search_title != '') $param.='&search_title='.$search_title;
   180| if (GETPOST('datestartday','int')) $param.='&datestartday='.GETPOST('datestartday','int');
   181| if (GETPOST('datestartmonth','int')) $param.='&datestartmonth='.GETPOST('datestartmonth','int');
   182| if (GETPOST('datestartyear','int')) $param.='&datestartyear='.GETPOST('datestartyear','int');
   183| if (GETPOST('dateendday','int')) $param.='&dateendday='.GETPOST('dateendday','int');
   184| if (GETPOST('dateendmonth','int')) $param.='&dateendmonth='.GETPOST('dateendmonth','int');
   185| if (GETPOST('dateendyear','int')) $param.='&dateendyear='.GETPOST('dateendyear','int');
   186| include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
   187| $sql = "SELECT";
   188| if ($usergroup > 0) $sql.=" DISTINCT";
   189| $sql.= " s.nom as societe, s.rowid as socid, s.client,";
   190| $sql.= " a.id, a.label, a.datep as dp, a.datep2 as dp2,";
   191| $sql.= ' a.fk_user_author,a.fk_user_action,';
   192| $sql.= " a.fk_contact, a.note, a.percent as percent,";
   193| $sql.= " a.fk_element, a.elementtype,";
   194| $sql.= " c.code as type_code, c.libelle as type_label,";
   195| $sql.= " sp.lastname, sp.firstname";
   196| foreach ($extrafields->attribute_label as $key => $val) $sql.=($extrafields->attribute_type[$key] != 'separate' ? ",ef.".$key.' as options_'.$key : '');
   197| $sql.= " FROM ".MAIN_DB_PREFIX."actioncomm as a";
   198| $sql.=" LEFT JOIN ".MAIN_DB_PREFIX."actioncomm_extrafields as ef ON (a.id = ef.fk_object) ";
   199| if (! $user->rights->societe->client->voir && ! $socid) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe_commerciaux as sc ON a.fk_soc = sc.fk_soc";
   200| $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe as s ON a.fk_soc = s.rowid";
   201| $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."socpeople as sp ON a.fk_contact = sp.rowid";
   202| $sql.=" ,".MAIN_DB_PREFIX."c_actioncomm as c";
   203| if ($resourceid > 0) $sql.=", ".MAIN_DB_PREFIX."element_resources as r";
   204| if ($filtert > 0 || $usergroup > 0) $sql.=", ".MAIN_DB_PREFIX."actioncomm_resources as ar";
   205| if ($usergroup > 0) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."usergroup_user as ugu ON ugu.fk_user = ar.fk_element";
   206| $sql.= " WHERE c.id = a.fk_action";
   207| $sql.= ' AND a.entity IN ('.getEntity('agenda').')';
   208| if (! empty($actioncode))
   209| {
   210|     if (empty($conf->global->AGENDA_USE_EVENT_TYPE))
   211|     {
   212|         if ($actioncode == 'AC_NON_AUTO') $sql.= " AND c.type != 'systemauto'";
   213|         elseif ($actioncode == 'AC_ALL_AUTO') $sql.= " AND c.type = 'systemauto'";
   214|         else
   215|         {

# --- HUNK 3: Lines 275-315 ---
   275| 	$num = $db->num_rows($resql);
   276| 	/*$title=$langs->trans("DoneAndToDoActions");
   277| 	if ($status == 'done') $title=$langs->trans("DoneActions");
   278| 	if ($status == 'todo') $title=$langs->trans("ToDoActions");
   279| 	*/
   280| 	$title=$langs->trans("ListOfEvents");
   281| 	$newtitle=$langs->trans($title);
   282| 	$tabactive='cardlist';
   283| 	$head = calendars_prepare_head($param);
   284| 	print '<form method="POST" id="searchFormList" class="listactionsfilter" action="'.$_SERVER["PHP_SELF"].'">'."\n";
   285| 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
   286| 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   287| 	print '<input type="hidden" name="action" value="list">';
   288| 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
   289| 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
   290| 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
   291| 	print '<input type="hidden" name="page" value="'.$page.'">';
   292| 	print '<input type="hidden" name="type" value="'.$type.'">';
   293| 	$nav='';
   294| 	if ($filter)          $nav.='<input type="hidden" name="filter" value="'.$filter.'">';
   295| 	if ($filtert)         $nav.='<input type="hidden" name="filtert" value="'.$filtert.'">';
   296| 	if ($showbirthday)    $nav.='<input type="hidden" name="showbirthday" value="1">';
   297| 	print $nav;
   298|     dol_fiche_head($head, $tabactive, $langs->trans('Agenda'), 0, 'action');
   299|     print_actions_filter($form,$canedit,$status,$year,$month,$day,$showbirthday,0,$filtert,0,$pid,$socid,$action,-1,$actioncode,$usergroup,'',$resourceid);
   300|     dol_fiche_end();
   301|     $link='';
   302|     /*
   303|     if (empty($conf->use_javascript_ajax))
   304|     {
   305|         $newparam=$param;   // newparam is for birthday links
   306|         $newparam=preg_replace('/showbirthday=[0-1]/i','showbirthday='.(empty($showbirthday)?1:0),$newparam);
   307|         if (! preg_match('/showbirthday=/i',$newparam)) $newparam.='&showbirthday=1';
   308|         $link='<a href="'.$_SERVER['PHP_SELF'];
   309|         $link.='?'.$newparam;
   310|         $link.='">';
   311|         if (empty($showbirthday)) $link.=$langs->trans("AgendaShowBirthdayEvents");
   312|         else $link.=$langs->trans("AgendaHideBirthdayEvents");
   313|         $link.='</a>';
   314|     }
   315|     */

# --- HUNK 4: Lines 470-512 ---
   470| 			print '<td align="center">';
   471| 			print dol_print_date($db->jdate($obj->dp2),"dayhour");
   472| 			print '</td>';
   473| 		}
   474| 		if (! empty($arrayfields['s.nom']['checked'])) {
   475| 			print '<td class="tdoverflowmax100">';
   476| 			if ($obj->socid)
   477| 			{
   478| 				$societestatic->id=$obj->socid;
   479| 				$societestatic->client=$obj->client;
   480| 				$societestatic->name=$obj->societe;
   481| 				print $societestatic->getNomUrl(1,'',28);
   482| 			}
   483| 			else print '&nbsp;';
   484| 			print '</td>';
   485| 		}
   486| 		if (! empty($arrayfields['a.fk_contact']['checked'])) {
   487| 			print '<td>';
   488| 			if ($obj->fk_contact > 0)
   489| 			{
   490| 				$contactstatic->lastname=$obj->lastname;
   491| 				$contactstatic->firstname=$obj->firstname;
   492| 				$contactstatic->id=$obj->fk_contact;
   493| 				print $contactstatic->getNomUrl(1,'',28);
   494| 			}
   495| 			else
   496| 			{
   497| 				print "&nbsp;";
   498| 			}
   499| 			print '</td>';
   500| 		}
   501| 		if (! empty($arrayfields['a.fk_element']['checked'])) {
   502| 		        print '<td>';
   503| 		        if ($obj->fk_element > 0 && ! empty($obj->elementtype)) {
   504|               		include_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
   505| 		            print dolGetElementUrl($obj->fk_element,$obj->elementtype,1);
   506| 		        } else {
   507|               		print "&nbsp;";
   508| 		        }
   509| 		        print '</td>';
   510| 		}
   511| 		include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_print_fields.tpl.php';
   512| 		$parameters=array('arrayfields'=>$arrayfields, 'obj'=>$obj);


# ====================================================================
# FILE: htdocs/comm/propal/card.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 486-526 ---
   486| 				else
   487| 				{
   488| 					setEventMessages($object->error, $object->errors, 'errors');
   489| 					$db->rollback();
   490| 					$action='create';
   491| 				}
   492| 			}
   493| 		}
   494| 	}
   495| 	else if ($action == 'classifybilled' && $user->rights->propal->cloturer)
   496| 	{
   497| 		$result=$object->cloture($user, 4, '');
   498| 		if ($result < 0)
   499| 		{
   500| 			setEventMessages($object->error, $object->errors, 'errors');
   501| 			$error++;
   502| 		}
   503| 	}
   504| 	else if ($action == 'setstatut' && $user->rights->propal->cloturer && ! GETPOST('cancel','alpha'))
   505| 	{
   506| 		if (! GETPOST('statut','int')) {
   507| 			setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("CloseAs")), null, 'errors');
   508| 			$action = 'statut';
   509| 		} else {
   510| 			if ($object->statut == Propal::STATUS_VALIDATED)
   511| 			{
   512| 				$result=$object->cloture($user, GETPOST('statut','int'), GETPOST('note_private','none'));
   513| 				if ($result < 0)
   514| 				{
   515| 					setEventMessages($object->error, $object->errors, 'errors');
   516| 					$error++;
   517| 				}
   518| 			}
   519| 		}
   520| 	}
   521| 	else if ($action == 'confirm_reopen' && $user->rights->propal->cloturer && ! GETPOST('cancel','alpha'))
   522| 	{
   523| 		if ($object->statut == Propal::STATUS_SIGNED || $object->statut == Propal::STATUS_NOTSIGNED || $object->statut == Propal::STATUS_BILLED)
   524| 		{
   525| 			$result=$object->reopen($user, 1);
   526| 			if ($result < 0)


# ====================================================================
# FILE: htdocs/commande/card.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 10-92 ---
    10|  * Copyright (C) 2012-2016	Marcos Garca			<marcosgdf@gmail.com>
    11|  * Copyright (C) 2012       Cedric Salvador      	<csalvador@gpcsolutions.fr>
    12|  * Copyright (C) 2013		Florian Henry			<florian.henry@open-concept.pro>
    13|  * Copyright (C) 2014       Ferran Marcet			<fmarcet@2byte.es>
    14|  * Copyright (C) 2015       Jean-Franois Ferry		<jfefe@aternatik.fr>
    15|  *
    16|  * This program is free software; you can redistribute it and/or modify
    17|  * it under the terms of the GNU General Public License as published by
    18|  * the Free Software Foundation; either version 3 of the License, or
    19|  * (at your option) any later version.
    20|  *
    21|  * This program is distributed in the hope that it will be useful,
    22|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    23|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    24|  *  GNU General Public License for more details.
    25|  *
    26|  * You should have received a copy of the GNU General Public License
    27|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    28|  */
    29| /**
    30|  * \file htdocs/commande/card.php
    31|  * \ingroup commande
    32|  * \brief Page to show customer order
    33|  */
    34| require '../main.inc.php';
    35| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formfile.class.php';
    36| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formorder.class.php';
    37| require_once DOL_DOCUMENT_ROOT . '/core/class/html.formmargin.class.php';
    38| require_once DOL_DOCUMENT_ROOT . '/core/modules/commande/modules_commande.php';
    39| require_once DOL_DOCUMENT_ROOT . '/commande/class/commande.class.php';
    40| require_once DOL_DOCUMENT_ROOT . '/comm/action/class/actioncomm.class.php';
    41| require_once DOL_DOCUMENT_ROOT . '/core/lib/order.lib.php';
    42| require_once DOL_DOCUMENT_ROOT . '/core/lib/functions2.lib.php';
    43| require_once DOL_DOCUMENT_ROOT . '/core/class/extrafields.class.php';
    44| if (! empty($conf->propal->enabled))
    45| 	require_once DOL_DOCUMENT_ROOT . '/comm/propal/class/propal.class.php';
    46| if (! empty($conf->projet->enabled)) {
    47| 	require_once DOL_DOCUMENT_ROOT . '/projet/class/project.class.php';
    48| 	require_once DOL_DOCUMENT_ROOT . '/core/class/html.formprojet.class.php';
    49| }
    50| require_once DOL_DOCUMENT_ROOT . '/core/class/doleditor.class.php';
    51| if (!empty($conf->variants->enabled)) {
    52| 	require_once DOL_DOCUMENT_ROOT.'/variants/class/ProductCombination.class.php';
    53| }
    54| $langs->load('orders');
    55| $langs->load('sendings');
    56| $langs->load('companies');
    57| $langs->load('bills');
    58| $langs->load('propal');
    59| $langs->load('deliveries');
    60| $langs->load('sendings');
    61| $langs->load('products');
    62| $langs->load('other');
    63| if (!empty($conf->incoterm->enabled)) $langs->load('incoterm');
    64| if (! empty($conf->margin->enabled)) $langs->load('margins');
    65| if (! empty($conf->productbatch->enabled)) $langs->load("productbatch");
    66| $id = (GETPOST('id', 'int') ? GETPOST('id', 'int') : GETPOST('orderid', 'int'));
    67| $ref = GETPOST('ref', 'alpha');
    68| $socid = GETPOST('socid', 'int');
    69| $action = GETPOST('action', 'alpha');
    70| $cancel = GETPOST('cancel', 'alpha');
    71| $confirm = GETPOST('confirm', 'alpha');
    72| $lineid = GETPOST('lineid', 'int');
    73| $origin = GETPOST('origin', 'alpha');
    74| $originid = (GETPOST('originid', 'int') ? GETPOST('originid', 'int') : GETPOST('origin_id', 'int')); // For backward compatibility
    75| $hidedetails = (GETPOST('hidedetails', 'int') ? GETPOST('hidedetails', 'int') : (! empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DETAILS) ? 1 : 0));
    76| $hidedesc = (GETPOST('hidedesc', 'int') ? GETPOST('hidedesc', 'int') : (! empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DESC) ? 1 : 0));
    77| $hideref = (GETPOST('hideref', 'int') ? GETPOST('hideref', 'int') : (! empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_REF) ? 1 : 0));
    78| if (! empty($user->societe_id))
    79| 	$socid = $user->societe_id;
    80| $result = restrictedArea($user, 'commande', $id);
    81| $object = new Commande($db);
    82| $extrafields = new ExtraFields($db);
    83| $extralabels = $extrafields->fetch_name_optionals_label($object->table_element);
    84| include DOL_DOCUMENT_ROOT.'/core/actions_fetchobject.inc.php';  // Must be include, not include_once
    85| $hookmanager->initHooks(array('ordercard','globalcard'));
    86| $permissionnote = $user->rights->commande->creer; 		// Used by the include of actions_setnotes.inc.php
    87| $permissiondellink = $user->rights->commande->creer; 	// Used by the include of actions_dellink.inc.php
    88| $permissionedit = $user->rights->commande->creer; 		// Used by the include of actions_lineupdown.inc.php
    89| /*
    90|  * Actions
    91|  */
    92| $parameters = array('socid' => $socid);

# --- HUNK 2: Lines 172-237 ---
   172| 			if ($conf->global->MAIN_MULTILANGS && empty($newlang))
   173| 				$newlang = $object->thirdparty->default_lang;
   174| 			if (! empty($newlang)) {
   175| 				$outputlangs = new Translate("", $conf);
   176| 				$outputlangs->setDefaultLang($newlang);
   177| 			}
   178| 			if (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE)) {
   179| 				$ret = $object->fetch($object->id); // Reload to get new records
   180| 				$object->generateDocument($object->modelpdf, $outputlangs, $hidedetails, $hidedesc, $hideref);
   181| 			}
   182| 			header('Location: '.$_SERVER["PHP_SELF"].'?id='.$object->id);
   183| 			exit;
   184| 		}
   185| 		else
   186| 		{
   187| 			setEventMessages($object->error, $object->errors, 'errors');
   188| 		}
   189| 	}
   190| 	else if ($action == 'classin' && $user->rights->commande->creer)
   191| 	{
   192| 		$object->setProject(GETPOST('projectid'));
   193| 	}
   194| 	else if ($action == 'add' && $user->rights->commande->creer)
   195| 	{
   196| 		$datecommande = dol_mktime(12, 0, 0, GETPOST('remonth'), GETPOST('reday'), GETPOST('reyear'));
   197| 		$datelivraison = dol_mktime(12, 0, 0, GETPOST('liv_month'), GETPOST('liv_day'), GETPOST('liv_year'));
   198| 		if ($datecommande == '') {
   199| 			setEventMessages($langs->trans('ErrorFieldRequired', $langs->transnoentities('Date')), null, 'errors');
   200| 			$action = 'create';
   201| 			$error++;
   202| 		}
   203| 		if ($socid < 1) {
   204| 			setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Customer")), null, 'errors');
   205| 			$action = 'create';
   206| 			$error++;
   207| 		}
   208| 		if (! $error) {
   209| 			$object->socid = $socid;
   210| 			$object->fetch_thirdparty();
   211| 			$db->begin();
   212| 			$object->date_commande = $datecommande;
   213| 			$object->note_private = GETPOST('note_private','none');
   214| 			$object->note_public = GETPOST('note_public','none');
   215| 			$object->source = GETPOST('source_id');
   216| 			$object->fk_project = GETPOST('projectid');
   217| 			$object->ref_client = GETPOST('ref_client');
   218| 			$object->modelpdf = GETPOST('model');
   219| 			$object->cond_reglement_id = GETPOST('cond_reglement_id');
   220| 			$object->mode_reglement_id = GETPOST('mode_reglement_id');
   221| 			$object->fk_account = GETPOST('fk_account', 'int');
   222| 			$object->availability_id = GETPOST('availability_id');
   223| 			$object->demand_reason_id = GETPOST('demand_reason_id');
   224| 			$object->date_livraison = $datelivraison;
   225| 			$object->shipping_method_id = GETPOST('shipping_method_id', 'int');
   226| 			$object->warehouse_id = GETPOST('warehouse_id', 'int');
   227| 			$object->fk_delivery_address = GETPOST('fk_address');
   228| 			$object->contactid = GETPOST('contactid');
   229| 			$object->fk_incoterms = GETPOST('incoterm_id', 'int');
   230| 			$object->location_incoterms = GETPOST('location_incoterms', 'alpha');
   231| 			$object->multicurrency_code = GETPOST('multicurrency_code', 'alpha');
   232| 			$object->multicurrency_tx = GETPOST('originmulticurrency_tx', 'int');
   233| 			if (! $error)
   234| 			{
   235| 				$ret = $extrafields->setOptionalsFromPost($extralabels, $object);
   236| 				if ($ret < 0) $error++;
   237| 			}

# --- HUNK 3: Lines 1102-1142 ---
  1102| 				dol_print_error($db);
  1103| 			}
  1104| 		}
  1105| 	}
  1106| }
  1107| /*
  1108|  *	View
  1109|  */
  1110| llxHeader('', $langs->trans('Order'), 'EN:Customers_Orders|FR:Commandes_Clients|ES:Pedidos de clientes');
  1111| $form = new Form($db);
  1112| $formfile = new FormFile($db);
  1113| $formorder = new FormOrder($db);
  1114| $formmargin = new FormMargin($db);
  1115| if (! empty($conf->projet->enabled)) { $formproject = new FormProjets($db); }
  1116| if ($action == 'create' && $user->rights->commande->creer)
  1117| {
  1118| 	print load_fiche_titre($langs->trans('CreateOrder'),'','title_commercial.png');
  1119| 	$soc = new Societe($db);
  1120| 	if ($socid > 0)
  1121| 		$res = $soc->fetch($socid);
  1122| 	$projectid = 0;
  1123| 	$remise_absolue = 0;
  1124| 	$currency_code = $conf->currency;
  1125| 	if (! empty($origin) && ! empty($originid)) {
  1126| 		$element = $subelement = $origin;
  1127| 		if (preg_match('/^([^_]+)_([^_]+)/i', $origin, $regs)) {
  1128| 			$element = $regs [1];
  1129| 			$subelement = $regs [2];
  1130| 		}
  1131| 		if ($element == 'project') {
  1132| 			$projectid = $originid;
  1133| 			if (!$cond_reglement_id) {
  1134| 				$cond_reglement_id = $soc->cond_reglement_id;
  1135| 			}
  1136| 			if (!$mode_reglement_id) {
  1137| 				$mode_reglement_id = $soc->mode_reglement_id;
  1138| 			}
  1139| 			if (!$remise_percent) {
  1140| 				$remise_percent = $soc->remise_percent;
  1141| 			}
  1142| 			if (!$dateorder) {

# --- HUNK 4: Lines 1181-1221 ---
  1181| 				if (!empty($objectsrc->multicurrency_code)) $currency_code = $objectsrc->multicurrency_code;
  1182| 				if (!empty($conf->global->MULTICURRENCY_USE_ORIGIN_TX) && !empty($objectsrc->multicurrency_tx))	$currency_tx = $objectsrc->multicurrency_tx;
  1183| 			}
  1184| 			$note_private = $object->getDefaultCreateValueFor('note_private', (! empty($objectsrc->note_private) ? $objectsrc->note_private : null));
  1185| 			$note_public = $object->getDefaultCreateValueFor('note_public', (! empty($objectsrc->note_public) ? $objectsrc->note_public : null));
  1186| 			$srccontactslist = $objectsrc->liste_contact(- 1, 'external', 1);
  1187| 		}
  1188| 	}
  1189| 	else
  1190| 	{
  1191| 		$cond_reglement_id  = $soc->cond_reglement_id;
  1192| 		$mode_reglement_id  = $soc->mode_reglement_id;
  1193| 		$fk_account         = $soc->fk_account;
  1194| 		$availability_id    = $soc->availability_id;
  1195| 		$shipping_method_id = $soc->shipping_method_id;
  1196| 		$warehouse_id       = $soc->warehouse_id;
  1197| 		$demand_reason_id   = $soc->demand_reason_id;
  1198| 		$remise_percent     = $soc->remise_percent;
  1199| 		$remise_absolue     = 0;
  1200| 		$dateorder          = empty($conf->global->MAIN_AUTOFILL_DATE_ORDER)?-1:'';
  1201| 		$projectid          = 0;
  1202| 		if (!empty($conf->multicurrency->enabled) && !empty($soc->multicurrency_code)) $currency_code = $soc->multicurrency_code;
  1203| 		$note_private = $object->getDefaultCreateValueFor('note_private');
  1204| 		$note_public = $object->getDefaultCreateValueFor('note_public');
  1205| 	}
  1206| 	print '<form name="crea_commande" action="' . $_SERVER["PHP_SELF"] . '" method="POST">';
  1207| 	print '<input type="hidden" name="token" value="' . $_SESSION ['newtoken'] . '">';
  1208| 	print '<input type="hidden" name="action" value="add">';
  1209| 	print '<input type="hidden" name="socid" value="' . $soc->id . '">' . "\n";
  1210| 	print '<input type="hidden" name="remise_percent" value="' . $soc->remise_percent . '">';
  1211| 	print '<input type="hidden" name="origin" value="' . $origin . '">';
  1212| 	print '<input type="hidden" name="originid" value="' . $originid . '">';
  1213| 	if (!empty($currency_tx)) print '<input type="hidden" name="originmulticurrency_tx" value="' . $currency_tx . '">';
  1214| 	dol_fiche_head('');
  1215| 	print '<table class="border" width="100%">';
  1216| 	print '<tr><td class="titlefieldcreate fieldrequired">' . $langs->trans('Ref') . '</td><td>' . $langs->trans("Draft") . '</td></tr>';
  1217| 	print '<tr><td>' . $langs->trans('RefCustomer') . '</td><td>';
  1218| 	if (!empty($conf->global->MAIN_USE_PROPAL_REFCLIENT_FOR_ORDER) && ! empty($origin) && ! empty($originid))
  1219| 		print '<input type="text" name="ref_client" value="'.$ref_client.'"></td>';
  1220| 	else
  1221| 		print '<input type="text" name="ref_client" value="'.GETPOST('ref_client').'"></td>';


# ====================================================================
# FILE: htdocs/compta/bank/bankentries_list.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 312-400 ---
   312| if (! empty($contextpage) && $contextpage != $_SERVER["PHP_SELF"]) $param.='&contextpage='.urlencode($contextpage);
   313| if ($limit > 0 && $limit != $conf->liste_limit) $param.='&limit='.urlencode($limit);
   314| if ($id > 0) $param.='&id='.urlencode($id);
   315| if (!empty($ref)) $param.='&ref='.urlencode($ref);
   316| if (!empty($search_ref)) $param.='&search_ref='.urlencode($search_ref);
   317| if (!empty($description)) $param.='&description='.urlencode($description);
   318| if (!empty($search_type)) $param.='&type='.urlencode($search_type);
   319| if (!empty($search_thirdparty)) $param.='&search_thirdparty='.urlencode($search_thirdparty);
   320| if (!empty($debit)) $param.='&debit='.urlencode($debit);
   321| if (!empty($credit)) $param.='&credit='.urlencode($credit);
   322| if (!empty($search_account)) $param.='&search_account='.urlencode($search_account);
   323| if (!empty($search_num_releve)) $param.='&search_num_releve='.urlencode($search_num_releve);
   324| if ($search_conciliated != '' && $search_conciliated != '-1')  $param.='&search_conciliated='.urlencode($search_conciliated);
   325| if ($search_bid > 0)  $param.='&search_bid='.urlencode($search_bid);
   326| if (dol_strlen($search_dt_start) > 0) $param .= '&search_start_dtmonth=' . GETPOST('search_start_dtmonth', 'int') . '&search_start_dtday=' . GETPOST('search_start_dtday', 'int') . '&search_start_dtyear=' . GETPOST('search_start_dtyear', 'int');
   327| if (dol_strlen($search_dt_end) > 0)   $param .= '&search_end_dtmonth=' . GETPOST('search_end_dtmonth', 'int') . '&search_end_dtday=' . GETPOST('search_end_dtday', 'int') . '&search_end_dtyear=' . GETPOST('search_end_dtyear', 'int');
   328| if (dol_strlen($search_dv_start) > 0) $param .= '&search_start_dvmonth=' . GETPOST('search_start_dvmonth', 'int') . '&search_start_dvday=' . GETPOST('search_start_dvday', 'int') . '&search_start_dvyear=' . GETPOST('search_start_dvyear', 'int');
   329| if (dol_strlen($search_dv_end) > 0)   $param .= '&search_end_dvmonth=' . GETPOST('search_end_dvmonth', 'int') . '&search_end_dvday=' . GETPOST('search_end_dvday', 'int') . '&search_end_dvyear=' . GETPOST('search_end_dvyear', 'int');
   330| if ($search_req_nb) $param.='&req_nb='.urlencode($search_req_nb);
   331| if (GETPOST("search_thirdparty",'int')) $param.='&thirdparty='.urlencode(GETPOST("search_thirdparty",'int'));
   332| if ($optioncss != '')      $param.='&optioncss='.urlencode($optioncss);
   333| include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
   334| $options = array();
   335| $buttonreconcile = '';
   336| if ($id > 0 || ! empty($ref))
   337| {
   338| 	$title = $langs->trans("FinancialAccount").' - '.$langs->trans("Transactions");
   339| 	$helpurl = "";
   340| 	llxHeader('',$title,$helpurl);
   341|     require_once DOL_DOCUMENT_ROOT.'/compta/bank/class/bankcateg.class.php';
   342|     $bankcateg = new BankCateg($db);
   343|     foreach ($bankcateg->fetchAll() as $bankcategory) {
   344|         $options[$bankcategory->id] = $bankcategory->label;
   345|     }
   346|     $head=bank_prepare_head($object);
   347|     dol_fiche_head($head,'journal',$langs->trans("FinancialAccount"),0,'account');
   348|     $linkback = '<a href="'.DOL_URL_ROOT.'/compta/bank/list.php?restore_lastsearch_values=1">'.$langs->trans("BackToList").'</a>';
   349|     dol_banner_tab($object, 'ref', $linkback, 1, 'ref', 'ref', $morehtmlref, '', 0, '', '', 1);
   350|     dol_fiche_end();
   351|     /*
   352|      * Buttons actions
   353|      */
   354|     if ($action != 'reconcile')
   355|     {
   356|         if ($object->canBeConciliated() > 0)
   357|         {
   358|             if ($user->rights->banque->consolidate) {
   359|             	$buttonreconcile = '<a class="butAction" style="margin-bottom: 5px !important; margin-top: 5px !important" href="'.DOL_URL_ROOT.'/compta/bank/bankentries_list.php?action=reconcile&search_conciliated=0'.$param.'">'.$langs->trans("Conciliate").'</a>';
   360|             } else {
   361|             	$buttonreconcile = '<a class="butActionRefused" style="margin-bottom: 5px !important; margin-top: 5px !important" title="'.$langs->trans("NotEnoughPermissions").'" href="#">'.$langs->trans("Conciliate").'</a>';
   362|             }
   363|         }
   364|     }
   365| }
   366| else
   367| {
   368| 	llxHeader('', $langs->trans("BankTransactions"), '', '', 0, 0, array(), array(), $param);
   369| }
   370| $sql = "SELECT b.rowid, b.dateo as do, b.datev as dv, b.amount, b.label, b.rappro as conciliated, b.num_releve, b.num_chq,";
   371| $sql.= " b.fk_account, b.fk_type,";
   372| $sql.= " ba.rowid as bankid, ba.ref as bankref,";
   373| $sql.= " bu.url_id,";
   374| $sql.= " s.nom, s.name_alias, s.client, s.fournisseur, s.code_client, s.code_fournisseur, s.code_compta, s.code_compta_fournisseur";
   375| foreach ($extrafields->attribute_label as $key => $val) $sql.=($extrafields->attribute_type[$key] != 'separate' ? ",ef.".$key.' as options_'.$key : '');
   376| $parameters=array();
   377| $reshook=$hookmanager->executeHooks('printFieldListSelect',$parameters);    // Note that $action and $object may have been modified by hook
   378| $sql.=$hookmanager->resPrint;
   379| $sql.= " FROM ";
   380| if ($search_bid) $sql.= MAIN_DB_PREFIX."bank_class as l,";
   381| $sql.= " ".MAIN_DB_PREFIX."bank_account as ba,";
   382| $sql.= " ".MAIN_DB_PREFIX."bank as b";
   383| if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label)) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."bank_extrafields as ef on (b.rowid = ef.fk_object)";
   384| $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."bank_url as bu ON bu.fk_bank = b.rowid AND type = 'company'";
   385| $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe as s ON bu.url_id = s.rowid";
   386| $sql.= " WHERE b.fk_account = ba.rowid";
   387| $sql.= " AND ba.entity IN (".getEntity('bank_account').")";
   388| if ($search_account > 0) $sql.=" AND b.fk_account = ".$search_account;
   389| if (dol_strlen($search_dt_start)>0) $sql .= " AND b.dateo >= '" . $db->idate($search_dt_start) . "'";
   390| if (dol_strlen($search_dt_end)>0) $sql .= " AND b.dateo <= '" . $db->idate($search_dt_end) . "'";
   391| if (dol_strlen($search_dv_start)>0) $sql .= " AND b.datev >= '" . $db->idate($search_dv_start) . "'";
   392| if (dol_strlen($search_dv_end)>0) $sql .= " AND b.datev <= '" . $db->idate($search_dv_end) . "'";
   393| if ($search_ref) $sql.=natural_search("b.rowid", $search_ref, 1);
   394| if ($search_req_nb) $sql.= natural_search("b.num_chq", $search_req_nb);
   395| if ($search_num_releve) $sql.= natural_search("b.num_releve", $search_num_releve);
   396| if ($search_conciliated != '' && $search_conciliated != '-1') $sql.= " AND b.rappro = ".$search_conciliated;
   397| if ($search_thirdparty) $sql.= natural_search("s.nom", $search_thirdparty);
   398| if ($description) $sql.= natural_search("b.label", $description);       // Warning some text are just translation keys, not translated strings
   399| if ($search_bid > 0) $sql.= " AND b.rowid=l.lineid AND l.fk_categ=".$search_bid;
   400| if (! empty($search_type)) $sql.= " AND b.fk_type = '".$db->escape($search_type)."' ";

# --- HUNK 2: Lines 805-882 ---
   805|             $sqlforbalance.= " ".MAIN_DB_PREFIX."bank as b";
   806|             $sqlforbalance.= " WHERE b.fk_account = ba.rowid";
   807|             $sqlforbalance.= " AND ba.entity IN (".getEntity('bank_account').")";
   808|             $sqlforbalance.= " AND b.fk_account = ".$search_account;
   809|             $sqlforbalance.= " AND (b.datev < '" . $db->idate($db->jdate($objp->dv)) . "' OR (b.datev = '" . $db->idate($db->jdate($objp->dv)) . "' AND (b.dateo < '".$db->idate($db->jdate($objp->do))."' OR (b.dateo = '".$db->idate($db->jdate($objp->do))."' AND b.rowid < ".$objp->rowid."))))";
   810|             $resqlforbalance = $db->query($sqlforbalance);
   811|             if ($resqlforbalance)
   812|             {
   813|                 $objforbalance = $db->fetch_object($resqlforbalance);
   814|                 if ($objforbalance)
   815|                 {
   816|                     $balance = $objforbalance->balance;
   817|                 }
   818|             }
   819|             else dol_print_error($db);
   820|             $balancecalculated=true;
   821|             if ($user->rights->banque->consolidate && $action == 'reconcile')
   822|             {
   823|             	$tmpnbfieldbeforebalance=0;
   824|             	$tmpnbfieldafterbalance=0;
   825|             	$balancefieldfound=false;
   826|             	foreach($arrayfields as $key => $val)
   827|             	{
   828|             		if ($key == 'balancebefore' || $key == 'balance')
   829|             		{
   830|             			$balancefieldfound=true;
   831|             			continue;
   832|             		}
   833|            			if (! empty($arrayfields[$key]['checked']))
   834|            			{
   835|            				if (! $balancefieldfound) $tmpnbfieldbeforebalance++;
   836|            				else $tmpnbfieldafterbalance++;
   837|            			}
   838|             	}
   839|             	if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label))
   840|             	{
   841|             		foreach($extrafields->attribute_label as $key => $val)
   842|             		{
   843|             			if (! empty($arrayfields["ef.".$key]['checked']))
   844|             			{
   845| 		           			if (! empty($arrayfields[$key]['checked']))
   846| 		           			{
   847| 		           				if (! $balancefieldfound) $tmpnbfieldbeforebalance++;
   848| 		           				else $tmpnbfieldafterbalance++;
   849| 		           			}
   850|             			}
   851|             		}
   852|             	}
   853|             	print '<tr class="oddeven trforbreak">';
   854|             	if ($tmpnbfieldbeforebalance)
   855|             	{
   856|             		print '<td colspan="'.$tmpnbfieldbeforebalance.'">';
   857|             		print '</td>';
   858|             	}
   859| 				print '<td align="right">';
   860|             	print price(price2num($balance, 'MT'), 1, $langs);
   861| 				print '</td>';
   862| 				print '<td colspan="'.($tmpnbfieldafterbalance+3).'">';
   863| 				print '</td>';
   864|             	print '</tr>';
   865|             }
   866|         }
   867|         $balance = price2num($balance + ($sign * $objp->amount),'MT');
   868|         if (empty($cachebankaccount[$objp->bankid]))
   869|         {
   870|             $bankaccounttmp = new Account($db);
   871|             $bankaccounttmp->fetch($objp->bankid);
   872|             $cachebankaccount[$objp->bankid]=$bankaccounttmp;
   873|             $bankaccount = $bankaccounttmp;
   874|         }
   875|         else
   876|         {
   877|             $bankaccount = $cachebankaccount[$objp->bankid];
   878|         }
   879|         print '<tr class="oddeven">';
   880|     	if (! empty($arrayfields['b.rowid']['checked']))
   881|     	{
   882|                 print '<td align="left" class="nowrap">';

# --- HUNK 3: Lines 1215-1255 ---
  1215|     	if (! $i) $totalarray['nbfield']++;
  1216| 		print "</tr>";
  1217| 		$i++;
  1218| 	}
  1219| 	if (isset($totalarray['totaldebfield']) || isset($totalarray['totalcredfield']))
  1220| 	{
  1221| 	    print '<tr class="liste_total">';
  1222| 	    $i=0;
  1223| 	    while ($i < $totalarray['nbfield'])
  1224| 	    {
  1225| 	        $i++;
  1226| 	        if ($i == 1)
  1227| 	        {
  1228| 	            if ($num < $limit && empty($offset)) print '<td align="left">'.$langs->trans("Total").'</td>';
  1229| 	            else print '<td align="left">'.$langs->trans("Totalforthispage").'</td>';
  1230| 	        }
  1231| 	        elseif ($totalarray['totaldebfield'] == $i) print '<td align="right">'.price(-1 * $totalarray['totaldeb']).'</td>';
  1232| 	        elseif ($totalarray['totalcredfield'] == $i) print '<td align="right">'.price($totalarray['totalcred']).'</td>';
  1233| 	        elseif ($i == $posconciliatecol)
  1234| 	        {
  1235| 	        	print '<td>';
  1236| 	        	if ($user->rights->banque->consolidate && $action == 'reconcile') print '<input class="button" name="confirm_reconcile" type="submit" value="' . $langs->trans("Conciliate") . '">';
  1237| 	        	print '</td>';
  1238| 	        }
  1239| 	        else print '<td></td>';
  1240| 	    }
  1241| 	    print '</tr>';
  1242| 	}
  1243| 	print "</table>";
  1244| 	print "</div>";
  1245|     print '</form>';
  1246| 	$db->free($resql);
  1247| }
  1248| else
  1249| {
  1250| 	dol_print_error($db);
  1251| }
  1252| if ($_POST["action"] == "search" && ! $num)
  1253| {
  1254| 	print '<div class="opacitymedium">'.$langs->trans("NoRecordFound").'</div>';
  1255| }


# ====================================================================
# FILE: htdocs/compta/bank/card.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 599-641 ---
   599|                             document.formsoc.action.value="edit";
   600|                             document.formsoc.submit();
   601|                         });
   602|                    })'."\n";
   603| 			print 'jQuery(document).ready(function () {
   604|                         jQuery("#selectaccount_country_id").change(function() {
   605|                             document.formsoc.action.value="edit";
   606|                             document.formsoc.submit();
   607|                         });
   608|                    })';
   609| 			print '</script>'."\n";
   610| 		}
   611| 		print '<form action="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'" method="post" name="formsoc">';
   612| 		print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   613| 		print '<input type="hidden" name="action" value="update">';
   614| 		print '<input type="hidden" name="id" value="'.$_REQUEST["id"].'">'."\n\n";
   615| 		dol_fiche_head('');
   616| 		print '<div class="underbanner clearboth"></div>';
   617| 		print '<table class="border" width="100%">';
   618| 		print '<tr><td class="fieldrequired titlefieldcreate">'.$langs->trans("Ref").'</td>';
   619| 		print '<td><input size="8" type="text" class="flat" name="ref" value="'.(isset($_POST["ref"])?GETPOST("ref"):$object->ref).'"></td></tr>';
   620| 		print '<tr><td class="fieldrequired">'.$langs->trans("Label").'</td>';
   621| 		print '<td><input type="text" class="flat minwidth300" name="label" value="'.(isset($_POST["label"])?GETPOST("label"):$object->label).'"></td></tr>';
   622| 		print '<tr><td class="fieldrequired">'.$langs->trans("AccountType").'</td>';
   623| 		print '<td class="maxwidth200onsmartphone">';
   624| 		$formbank->selectTypeOfBankAccount((isset($_POST["type"])?$_POST["type"]:$object->type),"type");
   625| 		print '</td></tr>';
   626| 		print '<tr><td class="fieldrequired">'.$langs->trans("Currency");
   627| 		print '<input type="hidden" value="'.$object->currency_code.'">';
   628| 		print '</td>';
   629| 		print '<td class="maxwidth200onsmartphone">';
   630| 		$selectedcode=$object->currency_code;
   631| 		if (! $selectedcode) $selectedcode=$conf->currency;
   632| 		print $form->selectCurrency((isset($_POST["account_currency_code"])?$_POST["account_currency_code"]:$selectedcode), 'account_currency_code');
   633| 		print '</td></tr>';
   634| 		print '<tr><td class="fieldrequired">'.$langs->trans("Status").'</td>';
   635| 		print '<td class="maxwidth200onsmartphone">';
   636| 		print $form->selectarray("clos", $object->status, (isset($_POST["clos"])?$_POST["clos"]:$object->clos));
   637| 		print '</td></tr>';
   638| 		$object->country_id=$object->country_id?$object->country_id:$mysoc->country_id;
   639| 		$selectedcode=$object->country_code;
   640| 		if (isset($_POST["account_country_id"])) $selectedcode=$_POST["account_country_id"];
   641| 		else if (empty($selectedcode)) $selectedcode=$mysoc->country_code;


# ====================================================================
# FILE: htdocs/compta/bank/class/account.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 268-308 ---
   268| 		$sql.= ")";
   269| 		dol_syslog(get_class($this)."::add_url_line", LOG_DEBUG);
   270| 		if ($this->db->query($sql))
   271| 		{
   272| 			$rowid = $this->db->last_insert_id(MAIN_DB_PREFIX."bank_url");
   273| 			return $rowid;
   274| 		}
   275| 		else
   276| 		{
   277| 			$this->error=$this->db->lasterror();
   278| 			return -1;
   279| 		}
   280| 	}
   281| 	/**
   282| 	 * 		TODO Move this into AccountLine
   283| 	 *      Return array with links from llx_bank_url
   284| 	 *
   285| 	 *      @param  int         $fk_bank    To search using bank transaction id
   286| 	 *      @param  int         $url_id     To search using link to
   287| 	 *      @param  string      $type       To search using type
   288| 	 *      @return array|-1                Array of links or -1 on error
   289| 	 */
   290| 	function get_url($fk_bank='', $url_id='', $type='')
   291| 	{
   292| 		$lines = array();
   293| 		if (! empty($fk_bank) && (! empty($url_id) || ! empty($type)))
   294| 		{
   295| 			$this->error="ErrorBadParameter";
   296| 			return -1;
   297| 		}
   298| 		$sql = "SELECT fk_bank, url_id, url, label, type";
   299| 		$sql.= " FROM ".MAIN_DB_PREFIX."bank_url";
   300| 		if ($fk_bank > 0) {
   301| 			$sql.= " WHERE fk_bank = ".$fk_bank;
   302| 		}
   303| 		else { $sql.= " WHERE url_id = ".$url_id." AND type = '".$type."'";
   304| 		}
   305| 		$sql.= " ORDER BY type, label";
   306| 		dol_syslog(get_class($this)."::get_url", LOG_DEBUG);
   307| 		$result = $this->db->query($sql);
   308| 		if ($result)


# ====================================================================
# FILE: htdocs/compta/bank/ligne.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 352-433 ---
   352|                     print img_object($langs->trans('ShowUser'),'user').' ';
   353|                     print $langs->trans("User");
   354|                     print '</a>';
   355|                 }
   356| 				else if ($links[$key]['type']=='payment_various') {
   357|                     print '<a href="'.DOL_URL_ROOT.'/compta/bank/various_payment/card.php?id='.$links[$key]['url_id'].'">';
   358|                     print img_object($langs->trans('ShowVariousPayment'),'payment').' ';
   359|                     print $langs->trans("VariousPayment");
   360|                     print '</a>';
   361|                 }
   362|                 else {
   363|                     print '<a href="'.$links[$key]['url'].$links[$key]['url_id'].'">';
   364|                     print img_object('','generic').' ';
   365|                     print $links[$key]['label'];
   366|                     print '</a>';
   367|                 }
   368|             }
   369|             print '</td></tr>';
   370|         }
   371|         print "<tr><td>".$langs->trans("Type")." / ".$langs->trans("Numero");
   372|         print "</td>";
   373|         if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
   374|         {
   375|             print '<td>';
   376|             $form->select_types_paiements($objp->fk_type,"value",'',2);
   377|             print '<input type="text" class="flat" name="num_chq" value="'.(empty($objp->num_chq) ? '' : $objp->num_chq).'">';
   378|             if ($objp->receiptid)
   379|             {
   380|                 include_once DOL_DOCUMENT_ROOT.'/compta/paiement/cheque/class/remisecheque.class.php';
   381|                 $receipt=new RemiseCheque($db);
   382|                 $receipt->fetch($objp->receiptid);
   383|                 print ' &nbsp; &nbsp; '.$langs->trans("CheckReceipt").': '.$receipt->getNomUrl(2);
   384|             }
   385|             print '</td>';
   386|         }
   387|         else
   388|         {
   389|             print '<td>'.$objp->fk_type.' '.$objp->num_chq.'</td>';
   390|         }
   391|         print "</tr>";
   392|         print "<tr><td>".$langs->trans("Bank")."</td>";
   393|         if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
   394|         {
   395|             print '<td>';
   396|             print '<input type="text" class="flat minwidth200" name="banque" value="'.(empty($objp->banque) ? '' : $objp->banque).'">';
   397|             print '</td>';
   398|         }
   399|         else
   400|         {
   401|             print '<td>'.$objp->banque.'</td>';
   402|         }
   403|         print "</tr>";
   404|         print "<tr><td>".$langs->trans("CheckTransmitter")."</td>";
   405|         if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
   406|         {
   407|             print '<td>';
   408|             print '<input type="text" class="flat minwidth200" name="emetteur" value="'.(empty($objp->emetteur) ? '' : stripslashes($objp->emetteur)).'">';
   409|             print '</td>';
   410|         }
   411|         else
   412|         {
   413|             print '<td>'.$objp->emetteur.'</td>';
   414|         }
   415|         print "</tr>";
   416|         print '<tr><td>'.$langs->trans("DateOperation").'</td>';
   417|         if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
   418|         {
   419|             print '<td>';
   420|             print $form->select_date($db->jdate($objp->do),'dateo','','','','update',1,0,1,$objp->rappro);
   421|             if (! $objp->rappro)
   422|             {
   423|                 print ' &nbsp; ';
   424|                 print '<a href="'.$_SERVER['PHP_SELF'].'?action=doprev&amp;id='.$id.'&amp;rowid='.$objp->rowid.'">';
   425|                 print img_edit_remove() . "</a> ";
   426|                 print '<a href="'.$_SERVER['PHP_SELF'].'?action=donext&amp;id='.$id.'&amp;rowid='.$objp->rowid.'">';
   427|                 print img_edit_add() ."</a>";
   428|             }
   429|             print '</td>';
   430|         }
   431|         else
   432|         {
   433|             print '<td>';


# ====================================================================
# FILE: htdocs/compta/bank/transfer.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 23-64 ---
    23|  *		\file       htdocs/compta/bank/transfer.php
    24|  *		\ingroup    banque
    25|  *		\brief      Page de saisie d'un virement
    26|  */
    27| require('../../main.inc.php');
    28| require_once DOL_DOCUMENT_ROOT.'/core/lib/bank.lib.php';
    29| require_once DOL_DOCUMENT_ROOT.'/compta/bank/class/account.class.php';
    30| $langs->loadLangs(array("banks", "categories", "multicurrency"));
    31| if (! $user->rights->banque->transfer)
    32|   accessforbidden();
    33| $action = GETPOST('action','alpha');
    34| $error = 0;
    35| /*
    36|  * Actions
    37|  */
    38| if ($action == 'add')
    39| {
    40| 	$langs->load("errors");
    41| 	$dateo = dol_mktime(12,0,0,GETPOST('remonth','int'),GETPOST('reday','int'),GETPOST('reyear','int'));
    42| 	$label = GETPOST('label','alpha');
    43| 	$amount= GETPOST('amount');
    44| 	$amountto= GETPOST('amountto');
    45| 	if (! $label)
    46| 	{
    47| 		$error++;
    48| 		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentities("Description")), null, 'errors');
    49| 	}
    50| 	if (! $amount)
    51| 	{
    52| 		$error++;
    53| 		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentities("Amount")), null, 'errors');
    54| 	}
    55| 	if (! GETPOST('account_from','int'))
    56| 	{
    57| 		$error++;
    58| 		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentities("TransferFrom")), null, 'errors');
    59| 	}
    60| 	if (! GETPOST('account_to','int'))
    61| 	{
    62| 		$error++;
    63| 		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentities("TransferTo")), null, 'errors');
    64| 	}

# --- HUNK 2: Lines 87-150 ---
    87| 			$bank_line_id_from=0;
    88| 			$bank_line_id_to=0;
    89| 			$result=0;
    90| 			$typefrom='PRE';
    91| 			$typeto='VIR';
    92| 			if ($accountto->courant == Account::TYPE_CASH || $accountfrom->courant == Account::TYPE_CASH)
    93| 			{
    94| 				$typefrom='LIQ';
    95| 				$typeto='LIQ';
    96| 			}
    97| 			if (! $error) $bank_line_id_from = $accountfrom->addline($dateo, $typefrom, $label, -1*price2num($amount), '', '', $user);
    98| 			if (! ($bank_line_id_from > 0)) $error++;
    99| 			if (! $error) $bank_line_id_to = $accountto->addline($dateo, $typeto, $label, price2num($amountto), '', '', $user);
   100| 			if (! ($bank_line_id_to > 0)) $error++;
   101| 		    if (! $error) $result=$accountfrom->add_url_line($bank_line_id_from, $bank_line_id_to, DOL_URL_ROOT.'/compta/bank/ligne.php?rowid=', '(banktransfert)', 'banktransfert');
   102| 			if (! ($result > 0)) $error++;
   103| 		    if (! $error) $result=$accountto->add_url_line($bank_line_id_to, $bank_line_id_from, DOL_URL_ROOT.'/compta/bank/ligne.php?rowid=', '(banktransfert)', 'banktransfert');
   104| 			if (! ($result > 0)) $error++;
   105| 			if (! $error)
   106| 			{
   107| 				$mesgs = $langs->trans("TransferFromToDone",'<a href="bankentries_list.php?id='.$accountfrom->id.'&sortfield=b.datev,b.dateo,b.rowid&sortorder=desc">'.$accountfrom->label."</a>",'<a href="bankentries_list.php?id='.$accountto->id.'">'.$accountto->label."</a>",$amount,$langs->transnoentities("Currency".$conf->currency));
   108| 				setEventMessages($mesgs, null, 'mesgs');
   109| 				$db->commit();
   110| 			}
   111| 			else
   112| 			{
   113| 				setEventMessages($accountfrom->error.' '.$accountto->error, null, 'errors');
   114| 				$db->rollback();
   115| 			}
   116| 		}
   117| 		else
   118| 		{
   119| 		    $error++;
   120| 			setEventMessages($langs->trans("ErrorFromToAccountsMustDiffers"), null, 'errors');
   121| 		}
   122| 	}
   123| }
   124| /*
   125|  * View
   126|  */
   127| llxHeader();
   128| print '		<script type="text/javascript">
   129|         	$(document).ready(function () {
   130|     	  		$(".selectbankaccount").change(function() {
   131|         			var account1 = $("#selectaccount_from").val();
   132|         			var account2 = $("#selectaccount_to").val();
   133|         			var currencycode1="";
   134|         			var currencycode2="";
   135| 					$.get("'.DOL_URL_ROOT.'/core/ajax/getaccountcurrency.php", {id: account1})
   136| 						.done(function( data ) {
   137| 							if (data != null)
   138| 							{
   139| 								var item= $.parseJSON(data);
   140| 								if (item.num==-1) {
   141| 									console.error("Error: "+item.error);
   142| 								} else if (item.num!==0) {
   143| 									currencycode1 = item.value;
   144| 								}
   145| 								$.get("'.DOL_URL_ROOT.'/core/ajax/getaccountcurrency.php", {id: account2})
   146| 									.done(function( data ) {
   147| 										if (data != null)
   148| 										{
   149| 											var item=$.parseJSON(data);
   150| 											if (item.num==-1) {

# --- HUNK 3: Lines 154-217 ---
   154| 											}
   155| 											if (currencycode2!==currencycode1 && currencycode2!=="" && currencycode1!=="") {
   156| 						        				$(".multicurrency").show();
   157| 						        			} else {
   158| 												$(".multicurrency").hide();
   159| 											}
   160| 										}
   161| 									else {
   162| 										console.error("Error: Ajax url has returned an empty page. Should be an empty json array.");
   163| 									}
   164| 			        			}).fail(function( data ) {
   165| 									console.error("Error: has returned an empty page. Should be an empty json array.");
   166| 								});
   167| 							}
   168| 							else {
   169| 								console.error("Error: has returned an empty page. Should be an empty json array.");
   170| 							}
   171|     	        	}).fail(function( data ) {
   172| 						console.error("Error: has returned an empty page. Should be an empty json array.");
   173| 					});
   174|         		});
   175|         	});
   176|     		</script>';
   177| $form=new Form($db);
   178| $account_from='';
   179| $account_to='';
   180| $label='';
   181| $amount='';
   182| if($error)
   183| {
   184| 	$account_from =	GETPOST('account_from','int');
   185| 	$account_to	= GETPOST('account_to','int');
   186| 	$label = GETPOST('label','alpha');
   187| 	$amount = GETPOST('amount','int');
   188| }
   189| print load_fiche_titre($langs->trans("MenuBankInternalTransfer"), '', 'title_bank.png');
   190| print $langs->trans("TransferDesc");
   191| print "<br><br>";
   192| print '<form name="add" method="post" action="'.$_SERVER["PHP_SELF"].'">';
   193| print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   194| print '<input type="hidden" name="action" value="add">';
   195| print '<table class="noborder" width="100%">';
   196| print '<tr class="liste_titre">';
   197| print '<td>'.$langs->trans("TransferFrom").'</td><td>'.$langs->trans("TransferTo").'</td><td>'.$langs->trans("Date").'</td><td>'.$langs->trans("Description").'</td><td>'.$langs->trans("Amount").'</td>';
   198| print '<td style="display:none" class="multicurrency">'.$langs->trans("AmountToOthercurrency").'</td>';
   199| print '</tr>';
   200| $var=false;
   201| print '<tr class="oddeven"><td>';
   202| $form->select_comptes($account_from, 'account_from', 0, '', 1, '', empty($conf->multicurrency->enabled)?0:1);
   203| print "</td>";
   204| print "<td>\n";
   205| $form->select_comptes($account_to, 'account_to', 0, '', 1, '', empty($conf->multicurrency->enabled)?0:1);
   206| print "</td>\n";
   207| print "<td>";
   208| $form->select_date((! empty($dateo)?$dateo:''),'','','','','add');
   209| print "</td>\n";
   210| print '<td><input name="label" class="flat quatrevingtpercent" type="text" value="'.$label.'"></td>';
   211| print '<td><input name="amount" class="flat" type="text" size="6" value="'.$amount.'"></td>';
   212| print '<td style="display:none" class="multicurrency"><input name="amountto" class="flat" type="text" size="6" value="'.$amountto.'"></td>';
   213| print "</table>";
   214| print '<br><div class="center"><input type="submit" class="button" value="'.$langs->trans("Add").'"></div>';
   215| print "</form>";
   216| llxFooter();
   217| $db->close();


# ====================================================================
# FILE: htdocs/compta/bank/various_payment/card.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 263-303 ---
   263| 		print '<tr><td>'.$langs->trans("AccountAccounting").'</td>';
   264| 		print '<td class="maxwidthonsmartphone"><input class="minwidth100" name="accountancy_code" value="'.$accountancy_code.'">';
   265| 		print '</td></tr>';
   266| 	}
   267| 	if (! empty($conf->projet->enabled))
   268| 	{
   269| 		$formproject=new FormProjets($db);
   270| 		$langs->load("projects");
   271| 		print '<tr><td>'.$langs->trans("Project").'</td><td>';
   272| 		$numproject=$formproject->select_projects(-1, $projectid,'fk_project',0,0,1,1);
   273| 		print '</td></tr>';
   274| 	}
   275| 	$parameters=array();
   276| 	$reshook=$hookmanager->executeHooks('formObjectOptions',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook
   277| 	print $hookmanager->resPrint;
   278| 	print '</table>';
   279| 	dol_fiche_end();
   280| 	print '<div class="center">';
   281| 	print '<input type="submit" class="button" value="'.$langs->trans("Save").'">';
   282| 	print ' &nbsp; ';
   283| 	print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
   284| 	print '</div>';
   285| 	print '</form>';
   286| }
   287| /* ************************************************************************** */
   288| /*                                                                            */
   289| /* View mode                                                                  */
   290| /*                                                                            */
   291| /* ************************************************************************** */
   292| if ($id)
   293| {
   294| 	$head=various_payment_prepare_head($object);
   295| 	dol_fiche_head($head, 'card', $langs->trans("VariousPayment"), -1, 'payment');
   296| 	$morehtmlref='<div class="refidno">';
   297| 	if (! empty($conf->projet->enabled))
   298| 	{
   299| 		$langs->load("projects");
   300| 		$morehtmlref.=$langs->trans('Project') . ' ';
   301| 		if ($user->rights->tax->charges->creer)
   302| 		{
   303| 			if ($action != 'classify')


# ====================================================================
# FILE: htdocs/compta/facture/class/facture-rec.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 822-913 ---
   822| 	 *  A result may also be provided into this->output.
   823| 	 *
   824| 	 *  WARNING: This method change context $conf->entity to be in correct context for each recurring invoice found.
   825| 	 *
   826| 	 *  @return	int						0 if OK, < 0 if KO (this function is used also by cron so only 0 is OK)
   827| 	 */
   828| 	function createRecurringInvoices()
   829| 	{
   830| 		global $conf, $langs, $db, $user;
   831| 		$langs->load("bills");
   832| 		$nb_create=0;
   833| 		$now = dol_now();
   834| 		$tmparray=dol_getdate($now);
   835| 		$today = dol_mktime(23,59,59,$tmparray['mon'],$tmparray['mday'],$tmparray['year']);   // Today is last second of current day
   836| 		dol_syslog("createRecurringInvoices");
   837| 		$sql = 'SELECT rowid FROM '.MAIN_DB_PREFIX.'facture_rec';
   838| 		$sql.= ' WHERE frequency > 0';      // A recurring invoice is an invoice with a frequency
   839| 		$sql.= " AND (date_when IS NULL OR date_when <= '".$db->idate($today)."')";
   840| 		$sql.= ' AND (nb_gen_done < nb_gen_max OR nb_gen_max = 0)';
   841| 		$sql.= ' AND suspended = 0';
   842| 		$sql.= $db->order('entity', 'ASC');
   843| 		$resql = $db->query($sql);
   844| 		if ($resql)
   845| 		{
   846| 		    $i=0;
   847| 		    $num = $db->num_rows($resql);
   848| 		    if ($num) $this->output.=$langs->trans("FoundXQualifiedRecurringInvoiceTemplate", $num)."\n";
   849| 		    else $this->output.=$langs->trans("NoQualifiedRecurringInvoiceTemplateFound");
   850| 		    $saventity = $conf->entity;
   851| 		    while ($i < $num)     // Loop on each template invoice
   852| 			{
   853| 			    $line = $db->fetch_object($resql);
   854| 			    $db->begin();
   855| 				$facturerec = new FactureRec($db);
   856| 				$facturerec->fetch($line->rowid);
   857| 				$conf->entity = $facturerec->entity;
   858| 				dol_syslog("createRecurringInvoices Process invoice template id=".$facturerec->id.", ref=".$facturerec->ref.", entity=".$facturerec->entity);
   859| 			    $error=0;
   860| 			    $facture = new Facture($db);
   861| 				$facture->fac_rec = $facturerec->id;    // We will create $facture from this recurring invoice
   862| 				$facture->fk_fac_rec_source = $facturerec->id;    // We will create $facture from this recurring invoice
   863| 			    $facture->type = self::TYPE_STANDARD;
   864| 			    $facture->brouillon = 1;
   865| 			    $facture->date = (empty($facturerec->date_when)?$now:$facturerec->date_when);	// We could also use dol_now here but we prefer date_when so invoice has real date when we would like even if we generate later.
   866| 			    $facture->socid = $facturerec->socid;
   867| 			    $invoiceidgenerated = $facture->create($user);
   868| 			    if ($invoiceidgenerated <= 0)
   869| 			    {
   870| 			        $this->errors = $facture->errors;
   871| 			        $this->error = $facture->error;
   872| 			        $error++;
   873| 			    }
   874| 			    if (! $error && $facturerec->auto_validate)
   875| 			    {
   876| 			        $result = $facture->validate($user);
   877| 			        if ($result <= 0)
   878| 			        {
   879|     			        $this->errors = $facture->errors;
   880|     			        $this->error = $facture->error;
   881| 			            $error++;
   882|                     }
   883| 			    }
   884|                 if (! $error && $facturerec->generate_pdf)
   885|                 {
   886|                     $result = $facture->generateDocument($facturerec->modelpdf, $langs);
   887|                     if ($result <= 0)
   888|                     {
   889|                         $this->errors = $facture->errors;
   890|                         $this->error = $facture->error;
   891|                         $error++;
   892|                     }
   893|                 }
   894| 				if (! $error && $invoiceidgenerated >= 0)
   895| 				{
   896| 					$db->commit("createRecurringInvoices Process invoice template id=".$facturerec->id.", ref=".$facturerec->ref);
   897| 					dol_syslog("createRecurringInvoices Process invoice template ".$facturerec->ref." is finished with a success generation");
   898| 					$nb_create++;
   899| 					$this->output.=$langs->trans("InvoiceGeneratedFromTemplate", $facture->ref, $facturerec->ref)."\n";
   900| 				}
   901| 				else
   902| 				{
   903| 				    $db->rollback("createRecurringInvoices Process invoice template id=".$facturerec->id.", ref=".$facturerec->ref);
   904| 				}
   905| 				$i++;
   906| 			}
   907| 			$conf->entity = $saventity;      // Restore entity context
   908| 		}
   909| 		else dol_print_error($db);
   910| 		$this->output=trim($this->output);
   911| 		return $error?$error:0;
   912| 	}
   913| 	/**


# ====================================================================
# FILE: htdocs/compta/facture/class/facture.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 600-641 ---
   600| 				$result=$this->update_price(1);
   601| 				if ($result > 0)
   602| 				{
   603| 					$action='create';
   604| 					/*
   605| 					$hookmanager->initHooks(array('invoicedao'));
   606| 					$parameters=array('invoiceid'=>$this->id);
   607| 					$reshook=$hookmanager->executeHooks('insertExtraFields',$parameters,$this,$action); // Note that $action and $object may have been modified by some hooks
   608| 					if (empty($reshook))
   609| 					{
   610| 						if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) // For avoid conflicts if trigger used
   611| 						{*/
   612| 					if (! $error)
   613| 					{
   614| 					    $result=$this->insertExtraFields();
   615| 					    if ($result < 0) $error++;
   616| 					}
   617| 						/*}
   618| 					}
   619| 					else if ($reshook < 0) $error++;*/
   620|                     $result=$this->call_trigger('BILL_CREATE',$user);
   621|                     if ($result < 0) $error++;
   622| 					if (! $error)
   623| 					{
   624| 						$this->db->commit();
   625| 						return $this->id;
   626| 					}
   627| 					else
   628| 					{
   629| 						$this->db->rollback();
   630| 						return -4;
   631| 					}
   632| 				}
   633| 				else
   634| 				{
   635| 					$this->error=$langs->trans('FailedToUpdatePrice');
   636| 					$this->db->rollback();
   637| 					return -3;
   638| 				}
   639| 			}
   640| 			else
   641| 			{


# ====================================================================
# FILE: htdocs/compta/facture/fiche-rec.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1195-1235 ---
  1195| 				else
  1196| 				{
  1197| 					print $langs->trans("NotARecurringInvoiceTemplate");
  1198| 			}
  1199| 		}
  1200| 		print '</td></tr>';
  1201| 		print '<tr><td>';
  1202| 		if ($action == 'date_when' || $object->frequency > 0)
  1203| 		{
  1204| 			print $form->editfieldkey($langs->trans("NextDateToExecution"), 'date_when', $object->date_when, $object, $user->rights->facture->creer, 'day');
  1205| 		}
  1206| 		else
  1207| 		{
  1208| 			print $langs->trans("NextDateToExecution");
  1209| 		}
  1210| 		print '</td><td>';
  1211| 		if ($action == 'date_when' || $object->frequency > 0)
  1212| 		{
  1213| 			print $form->editfieldval($langs->trans("NextDateToExecution"), 'date_when', $object->date_when, $object, $user->rights->facture->creer, 'day', $object->date_when, null, '', '', 0, 'strikeIfMaxNbGenReached');
  1214| 		}
  1215| 		if ($action != 'editdate_when' && $object->frequency > 0 && $object->date_when && $object->date_when < $now) print img_warning($langs->trans("Late"));
  1216| 		print '</td>';
  1217| 		print '</tr>';
  1218| 		print '<tr><td>';
  1219| 		if ($action == 'nb_gen_max' || $object->frequency > 0)
  1220| 		{
  1221| 			print $form->editfieldkey($langs->trans("MaxPeriodNumber"), 'nb_gen_max', $object->nb_gen_max, $object, $user->rights->facture->creer);
  1222| 		}
  1223| 		else
  1224| 		{
  1225| 			print $langs->trans("MaxPeriodNumber");
  1226| 		}
  1227| 		print '</td><td>';
  1228| 		if ($action == 'nb_gen_max' || $object->frequency > 0)
  1229| 		{
  1230| 			  print $form->editfieldval($langs->trans("MaxPeriodNumber"), 'nb_gen_max', $object->nb_gen_max?$object->nb_gen_max:'', $object, $user->rights->facture->creer);
  1231| 		}
  1232| 		else
  1233| 		{
  1234| 			print '';
  1235| 		}


# ====================================================================
# FILE: htdocs/compta/facture/invoicetemplate_list.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 499-569 ---
   499| 			{
   500| 			   print '<td align="center">'.($objp->frequency > 0 ? $objp->unit_frequency : '').'</td>';
   501| 			   if (! $i) $totalarray['nbfield']++;
   502| 			}
   503| 			if (! empty($arrayfields['f.nb_gen_done']['checked']))
   504| 			{
   505| 				print '<td align="center">';
   506| 				print ($objp->frequency > 0 ? $objp->nb_gen_done.($objp->nb_gen_max>0?' / '. $objp->nb_gen_max:'') : '<span class="opacitymedium">'.$langs->trans('NA').'</span>');
   507| 				print '</td>';
   508| 				if (! $i) $totalarray['nbfield']++;
   509| 			}
   510| 			if (! empty($arrayfields['f.date_last_gen']['checked']))
   511| 			{
   512| 			   print '<td align="center">';
   513| 			   print ($objp->frequency > 0 ? dol_print_date($db->jdate($objp->date_last_gen),'day') : '<span class="opacitymedium">'.$langs->trans('NA').'</span>');
   514| 			   print '</td>';
   515| 			   if (! $i) $totalarray['nbfield']++;
   516| 			}
   517| 			if (! empty($arrayfields['f.date_when']['checked']))
   518| 			{
   519| 			   print '<td align="center">';
   520| 			   print ($objp->frequency ? ($invoicerectmp->isMaxNbGenReached()?'<strike>':'').dol_print_date($db->jdate($objp->date_when),'day').($invoicerectmp->isMaxNbGenReached()?'</strike>':'') : '<span class="opacitymedium">'.$langs->trans('NA').'</span>');
   521| 			   if ($objp->frequency > 0 && $db->jdate($objp->date_when) && $db->jdate($objp->date_when) < $now) print img_warning($langs->trans("Late"));
   522| 			   print '</td>';
   523| 			   if (! $i) $totalarray['nbfield']++;
   524| 			}
   525| 			if (! empty($arrayfields['f.datec']['checked']))
   526| 			{
   527| 			   print '<td align="center">';
   528| 			   print dol_print_date($db->jdate($objp->datec),'dayhour');
   529| 			   print '</td>';
   530| 			   if (! $i) $totalarray['nbfield']++;
   531| 			}
   532| 			if (! empty($arrayfields['f.tms']['checked']))
   533| 			{
   534| 			   print '<td align="center">';
   535| 			   print dol_print_date($db->jdate($objp->tms),'dayhour');
   536| 			   print '</td>';
   537| 			   if (! $i) $totalarray['nbfield']++;
   538| 			}
   539| 			if (! empty($arrayfields['status']['checked']))
   540| 			{
   541| 			   print '<td align="center">';
   542| 			   print $invoicerectmp->getLibStatut(3,0);
   543| 			   print '</td>';
   544| 			   if (! $i) $totalarray['nbfield']++;
   545| 			}
   546| 			print '<td align="center">';
   547| 			if ($user->rights->facture->creer && empty($invoicerectmp->suspended))
   548| 			{
   549| 				if (empty($objp->frequency) || $db->jdate($objp->date_when) <= $today)
   550| 				{
   551| 					print '<a href="'.DOL_URL_ROOT.'/compta/facture/card.php?action=create&amp;socid='.$objp->socid.'&amp;fac_rec='.$objp->facid.'">';
   552| 					print $langs->trans("CreateBill").'</a>';
   553| 				}
   554| 				else
   555| 				{
   556| 					print $langs->trans("DateIsNotEnough");
   557| 				}
   558| 			}
   559| 			else
   560| 			{
   561| 				print "&nbsp;";
   562| 			}
   563| 			if (! $i) $totalarray['nbfield']++;
   564| 			print "</td>";
   565| 			print "</tr>\n";
   566| 			$i++;
   567| 		}
   568| 	}
   569| 	else


# ====================================================================
# FILE: htdocs/compta/facture/list.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 64-109 ---
    64| $search_product_category=GETPOST('search_product_category','int');
    65| $search_ref=GETPOST('sf_ref')?GETPOST('sf_ref','alpha'):GETPOST('search_ref','alpha');
    66| $search_refcustomer=GETPOST('search_refcustomer','alpha');
    67| $search_type=GETPOST('search_type','int');
    68| $search_project=GETPOST('search_project','alpha');
    69| $search_societe=GETPOST('search_societe','alpha');
    70| $search_montant_ht=GETPOST('search_montant_ht','alpha');
    71| $search_montant_vat=GETPOST('search_montant_vat','alpha');
    72| $search_montant_localtax1=GETPOST('search_montant_localtax1','alpha');
    73| $search_montant_localtax2=GETPOST('search_montant_localtax2','alpha');
    74| $search_montant_ttc=GETPOST('search_montant_ttc','alpha');
    75| $search_status=GETPOST('search_status','int');
    76| $search_paymentmode=GETPOST('search_paymentmode','int');
    77| $search_town=GETPOST('search_town','alpha');
    78| $search_zip=GETPOST('search_zip','alpha');
    79| $search_state=trim(GETPOST("search_state"));
    80| $search_country=GETPOST("search_country",'int');
    81| $search_type_thirdparty=GETPOST("search_type_thirdparty",'int');
    82| $search_user = GETPOST('search_user','int');
    83| $search_sale = GETPOST('search_sale','int');
    84| $day	= GETPOST('day','int');
    85| $month	= GETPOST('month','int');
    86| $year	= GETPOST('year','int');
    87| $day_lim	= GETPOST('day_lim','int');
    88| $month_lim	= GETPOST('month_lim','int');
    89| $year_lim	= GETPOST('year_lim','int');
    90| $option = GETPOST('option');
    91| if ($option == 'late') {
    92| 	$search_status = '1';
    93| }
    94| $filtre	= GETPOST('filtre','alpha');
    95| $limit = GETPOST('limit')?GETPOST('limit','int'):$conf->liste_limit;
    96| $sortfield = GETPOST("sortfield",'alpha');
    97| $sortorder = GETPOST("sortorder",'alpha');
    98| $page = GETPOST("page",'int');
    99| if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
   100| $offset = $limit * $page;
   101| if (! $sortorder && ! empty($conf->global->INVOICE_DEFAULT_UNPAYED_SORT_ORDER) && $search_status == 1) $sortorder=$conf->global->INVOICE_DEFAULT_UNPAYED_SORT_ORDER;
   102| if (! $sortorder) $sortorder='DESC';
   103| if (! $sortfield) $sortfield='f.datef';
   104| $pageprev = $page - 1;
   105| $pagenext = $page + 1;
   106| $contextpage=GETPOST('contextpage','aZ')?GETPOST('contextpage','aZ'):'invoicelist';
   107| $fieldid = (! empty($ref)?'facnumber':'rowid');
   108| if (! empty($user->societe_id)) $socid=$user->societe_id;
   109| $result = restrictedArea($user, 'facture', $id,'','','fk_soc',$fieldid);

# --- HUNK 2: Lines 170-217 ---
   170| 	$search_sale='';
   171| 	$search_product_category='';
   172| 	$search_ref='';
   173| 	$search_refcustomer='';
   174| 	$search_type='';
   175| 	$search_project='';
   176| 	$search_societe='';
   177| 	$search_montant_ht='';
   178| 	$search_montant_vat='';
   179| 	$search_montant_localtax1='';
   180| 	$search_montant_localtax2='';
   181| 	$search_montant_ttc='';
   182| 	$search_status='';
   183| 	$search_paymentmode='';
   184| 	$search_town='';
   185| 	$search_zip="";
   186| 	$search_state="";
   187| 	$search_type='';
   188| 	$search_country='';
   189| 	$search_type_thirdparty='';
   190| 	$day='';
   191| 	$year='';
   192| 	$month='';
   193| 	$option='';
   194| 	$filter='';
   195| 	$day_lim='';
   196| 	$year_lim='';
   197| 	$month_lim='';
   198| 	$toselect='';
   199| 	$search_array_options=array();
   200| }
   201| if (empty($reshook))
   202| {
   203| 	$objectclass='Facture';
   204| 	$objectlabel='Invoices';
   205| 	$permtoread = $user->rights->facture->lire;
   206| 	$permtocreate = $user->rights->facture->creer;
   207| 	$permtodelete = $user->rights->facture->supprimer;
   208| 	$uploaddir = $conf->facture->dir_output;
   209| 	include DOL_DOCUMENT_ROOT.'/core/actions_massactions.inc.php';
   210| }
   211| if ($massaction == 'withdrawrequest')
   212| {
   213| 	$langs->load("withdrawals");
   214| 	if (!$user->rights->prelevement->bons->creer)
   215| 	{
   216| 		$error++;
   217| 		setEventMessages($langs->trans("NotEnoughPermissions"), null, 'errors');

# --- HUNK 3: Lines 371-435 ---
   371| if ($search_societe) $sql .= natural_search('s.nom', $search_societe);
   372| if ($search_town)  $sql.= natural_search('s.town', $search_town);
   373| if ($search_zip)   $sql.= natural_search("s.zip",$search_zip);
   374| if ($search_state) $sql.= natural_search("state.nom",$search_state);
   375| if ($search_country) $sql .= " AND s.fk_pays IN (".$search_country.')';
   376| if ($search_type_thirdparty) $sql .= " AND s.fk_typent IN (".$search_type_thirdparty.')';
   377| if ($search_company) $sql .= natural_search('s.nom', $search_company);
   378| if ($search_montant_ht != '') $sql.= natural_search('f.total', $search_montant_ht, 1);
   379| if ($search_montant_vat != '') $sql.= natural_search('f.tva', $search_montant_vat, 1);
   380| if ($search_montant_localtax1 != '') $sql.= natural_search('f.localtax1', $search_montant_localtax1, 1);
   381| if ($search_montant_localtax2 != '') $sql.= natural_search('f.localtax2', $search_montant_localtax2, 1);
   382| if ($search_montant_ttc != '') $sql.= natural_search('f.total_ttc', $search_montant_ttc, 1);
   383| if ($search_status != '' && $search_status >= 0)
   384| {
   385| 	if ($search_status == '0') $sql.=" AND f.fk_statut = 0";  // draft
   386| 	if ($search_status == '1') $sql.=" AND f.fk_statut = 1";  // unpayed
   387| 	if ($search_status == '2') $sql.=" AND f.fk_statut = 2";  // payed     Not that some corrupted data may contains f.fk_statut = 1 AND f.paye = 1 (it means payed too but should not happend. If yes, reopen and reclassify billed)
   388| 	if ($search_status == '3') $sql.=" AND f.fk_statut = 3";  // abandonned
   389| }
   390| if ($search_paymentmode > 0) $sql .= " AND f.fk_mode_reglement = ".$db->escape($search_paymentmode);
   391| if ($month > 0)
   392| {
   393| 	if ($year > 0 && empty($day))
   394| 	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_get_first_day($year,$month,false))."' AND '".$db->idate(dol_get_last_day($year,$month,false))."'";
   395| 	else if ($year > 0 && ! empty($day))
   396| 	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $month, $day, $year))."' AND '".$db->idate(dol_mktime(23, 59, 59, $month, $day, $year))."'";
   397| 	else
   398| 	$sql.= " AND date_format(f.datef, '%m') = '".$month."'";
   399| }
   400| else if ($year > 0)
   401| {
   402| 	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_get_first_day($year,1,false))."' AND '".$db->idate(dol_get_last_day($year,12,false))."'";
   403| }
   404| if ($month_lim > 0)
   405| {
   406| 	if ($year_lim > 0 && empty($day_lim))
   407| 		$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_get_first_day($year_lim,$month_lim,false))."' AND '".$db->idate(dol_get_last_day($year_lim,$month_lim,false))."'";
   408| 	else if ($year_lim > 0 && ! empty($day_lim))
   409| 		$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $month_lim, $day_lim, $year_lim))."' AND '".$db->idate(dol_mktime(23, 59, 59, $month_lim, $day_lim, $year_lim))."'";
   410| 	else
   411| 		$sql.= " AND date_format(f.date_lim_reglement, '%m') = '".$db->escape($month_lim)."'";
   412| }
   413| else if ($year_lim > 0)
   414| {
   415| 	$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_get_first_day($year_lim,1,false))."' AND '".$db->idate(dol_get_last_day($year_lim,12,false))."'";
   416| }
   417| if ($option == 'late') $sql.=" AND f.date_lim_reglement < '".$db->idate(dol_now() - $conf->facture->client->warning_delay)."'";
   418| if ($search_sale > 0) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$search_sale;
   419| if ($search_user > 0)
   420| {
   421| 	$sql.= " AND ec.fk_c_type_contact = tc.rowid AND tc.element='facture' AND tc.source='internal' AND ec.element_id = f.rowid AND ec.fk_socpeople = ".$search_user;
   422| }
   423| include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_sql.tpl.php';
   424| $parameters=array();
   425| $reshook=$hookmanager->executeHooks('printFieldListWhere',$parameters);    // Note that $action and $object may have been modified by hook
   426| $sql.=$hookmanager->resPrint;
   427| if (! $sall)
   428| {
   429| 	$sql.= ' GROUP BY f.rowid, f.facnumber, ref_client, f.type, f.note_private, f.note_public, f.increment, f.fk_mode_reglement, f.total, f.tva, f.total_ttc,';
   430| 	$sql.= ' f.localtax1, f.localtax2,';
   431| 	$sql.= ' f.datef, f.date_lim_reglement,';
   432| 	$sql.= ' f.paye, f.fk_statut,';
   433| 	$sql.= ' f.datec, f.tms,';
   434| 	$sql.= ' s.rowid, s.nom, s.email, s.town, s.zip, s.fk_pays, s.client, s.fournisseur, s.code_client, s.code_fournisseur, s.code_compta, s.code_compta_fournisseur,';
   435| 	$sql.= ' typent.code,';

# --- HUNK 4: Lines 454-516 ---
   454| {
   455| 	$result = $db->query($sql);
   456| 	$nbtotalofrecords = $db->num_rows($result);
   457| }
   458| $sql.= $db->plimit($limit+1,$offset);
   459| $resql = $db->query($sql);
   460| if ($resql)
   461| {
   462| 	$num = $db->num_rows($resql);
   463| 	$arrayofselected=is_array($toselect)?$toselect:array();
   464| 	if ($socid)
   465| 	{
   466| 		$soc = new Societe($db);
   467| 		$soc->fetch($socid);
   468| 		if (empty($search_societe)) $search_societe = $soc->name;
   469| 	}
   470| 	$param='&socid='.$socid;
   471| 	if (! empty($contextpage) && $contextpage != $_SERVER["PHP_SELF"]) $param.='&contextpage='.$contextpage;
   472| 	if ($limit > 0 && $limit != $conf->liste_limit) $param.='&limit='.$limit;
   473| 	if ($sall)				 $param.='&sall='.urlencode($sall);
   474| 	if ($day)                $param.='&day='.urlencode($day);
   475| 	if ($month)              $param.='&month='.urlencode($month);
   476| 	if ($year)               $param.='&year=' .urlencode($year);
   477| 	if ($day_lim)            $param.='&day_lim='.urlencode($day_lim);
   478| 	if ($month_lim)          $param.='&month_lim='.urlencode($month_lim);
   479| 	if ($year_lim)           $param.='&year_lim=' .urlencode($year_lim);
   480| 	if ($search_ref)         $param.='&search_ref=' .urlencode($search_ref);
   481| 	if ($search_refcustomer) $param.='&search_refcustomer=' .urlencode($search_refcustomer);
   482| 	if ($search_type != '')  $param.='&search_type='.urlencode($search_type);
   483| 	if ($search_societe)     $param.='&search_societe=' .urlencode($search_societe);
   484| 	if ($search_sale > 0)    $param.='&search_sale=' .urlencode($search_sale);
   485| 	if ($search_user > 0)    $param.='&search_user=' .urlencode($search_user);
   486| 	if ($search_product_category > 0)   $param.='$search_product_category=' .urlencode($search_product_category);
   487| 	if ($search_montant_ht != '')  $param.='&search_montant_ht='.urlencode($search_montant_ht);
   488| 	if ($search_montant_vat != '')  $param.='&search_montant_vat='.urlencode($search_montant_vat);
   489| 	if ($search_montant_localtax1 != '')  $param.='&search_montant_localtax1='.urlencode($search_montant_localtax1);
   490| 	if ($search_montant_localtax2 != '')  $param.='&search_montant_localtax2='.urlencode($search_montant_localtax2);
   491| 	if ($search_montant_ttc != '') $param.='&search_montant_ttc='.urlencode($search_montant_ttc);
   492| 	if ($search_status != '') $param.='&search_status='.urlencode($search_status);
   493| 	if ($search_paymentmode > 0) $param.='search_paymentmode='.urlencode($search_paymentmode);
   494| 	if ($show_files)         $param.='&show_files=' .$show_files;
   495| 	if ($option)             $param.="&option=".$option;
   496| 	if ($optioncss != '')    $param.='&optioncss='.$optioncss;
   497| 	include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
   498| 	$arrayofmassactions=array(
   499| 		'validate'=>$langs->trans("Validate"),
   500| 		'presend'=>$langs->trans("SendByMail"),
   501| 		'builddoc'=>$langs->trans("PDFMerge"),
   502| 	);
   503| 	if ($conf->prelevement->enabled)
   504| 	{
   505| 	   $langs->load("withdrawals");
   506| 	   $arrayofmassactions['withdrawrequest']=$langs->trans("MakeWithdrawRequest");
   507| 	}
   508| 	if ($user->rights->facture->supprimer)
   509| 	{
   510| 		if (empty($conf->global->INVOICE_CAN_ALWAYS_BE_REMOVED))
   511| 		{
   512| 		}
   513| 		else
   514| 		{
   515| 		   $arrayofmassactions['predelete']=$langs->trans("Delete");
   516| 		}

# --- HUNK 5: Lines 594-644 ---
   594| 	}
   595| 	if (! empty($arrayfields['f.type']['checked']))
   596| 	{
   597| 		print '<td class="liste_titre maxwidthonsmartphone">';
   598| 		$listtype=array(
   599| 			Facture::TYPE_STANDARD=>$langs->trans("InvoiceStandard"),
   600| 			Facture::TYPE_REPLACEMENT=>$langs->trans("InvoiceReplacement"),
   601| 			Facture::TYPE_CREDIT_NOTE=>$langs->trans("InvoiceAvoir"),
   602| 			Facture::TYPE_DEPOSIT=>$langs->trans("InvoiceDeposit"),
   603| 		);
   604| 		if (! empty($conf->global->INVOICE_USE_SITUATION))
   605| 		{
   606| 			$listtype[Facture::TYPE_SITUATION] = $langs->trans("InvoiceSituation");
   607| 		}
   608| 		print $form->selectarray('search_type', $listtype, $search_type, 1, 0, 0, '', 0, 0, 0, 'ASC', 'maxwidth100');
   609| 		print '</td>';
   610| 	}
   611| 	if (! empty($arrayfields['f.date']['checked']))
   612| 	{
   613| 		print '<td class="liste_titre nowraponall" align="center">';
   614| 		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="day" value="'.dol_escape_htmltag($day).'">';
   615| 		print '<input class="flat" type="text" size="1" maxlength="2" name="month" value="'.dol_escape_htmltag($month).'">';
   616| 		$formother->select_year($year?$year:-1,'year',1, 20, 5, 0, 0, '', 'width75');
   617| 		print '</td>';
   618| 	}
   619| 	if (! empty($arrayfields['f.date_lim_reglement']['checked']))
   620| 	{
   621| 		print '<td class="liste_titre nowraponall" align="center">';
   622| 		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="day_lim" value="'.dol_escape_htmltag($day_lim).'">';
   623| 		print '<input class="flat" type="text" size="1" maxlength="2" name="month_lim" value="'.dol_escape_htmltag($month_lim).'">';
   624| 		$formother->select_year($year_lim?$year_lim:-1,'year_lim',1, 20, 5, 0, 0, '', 'width75');
   625| 		print '<br><input type="checkbox" name="option" value="late"'.($option == 'late'?' checked':'').'> '.$langs->trans("Late");
   626| 		print '</td>';
   627| 	}
   628| 	if (! empty($arrayfields['p.ref']['checked']))
   629| 	{
   630| 		print '<td class="liste_titre"><input class="flat" type="text" size="6" name="search_project" value="'.$search_project.'"></td>';
   631| 	}
   632| 	if (! empty($arrayfields['s.nom']['checked']))
   633| 	{
   634| 		print '<td class="liste_titre"><input class="flat" type="text" size="6" name="search_societe" value="'.$search_societe.'"></td>';
   635| 	}
   636| 	if (! empty($arrayfields['s.town']['checked'])) print '<td class="liste_titre"><input class="flat" type="text" size="6" name="search_town" value="'.dol_escape_htmltag($search_town).'"></td>';
   637| 	if (! empty($arrayfields['s.zip']['checked'])) print '<td class="liste_titre"><input class="flat" type="text" size="4" name="search_zip" value="'.dol_escape_htmltag($search_zip).'"></td>';
   638| 	if (! empty($arrayfields['state.nom']['checked']))
   639| 	{
   640| 		print '<td class="liste_titre">';
   641| 		print '<input class="flat" size="4" type="text" name="search_state" value="'.dol_escape_htmltag($search_state).'">';
   642| 		print '</td>';
   643| 	}
   644| 	if (! empty($arrayfields['country.code_iso']['checked']))


# ====================================================================
# FILE: htdocs/compta/localtax/index.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 22-66 ---
    22|  */
    23| require '../../main.inc.php';
    24| require_once DOL_DOCUMENT_ROOT.'/core/lib/tax.lib.php';
    25| require_once DOL_DOCUMENT_ROOT.'/compta/tva/class/tva.class.php';
    26| require_once DOL_DOCUMENT_ROOT.'/core/lib/date.lib.php';
    27| $langs->load("other");
    28| $langs->load("compta");
    29| $langs->load("banks");
    30| $langs->load("bills");
    31| $localTaxType=GETPOST('localTaxType', 'int');
    32| $year=GETPOST("year","int");
    33| if ($year == 0)
    34| {
    35|     $year_current = strftime("%Y",time());
    36|     $year_start = $year_current;
    37| } else {
    38|     $year_current = $year;
    39|     $year_start = $year;
    40| }
    41| $socid = isset($_GET["socid"])?$_GET["socid"]:'';
    42| if ($user->societe_id) 
    43|     $socid=$user->societe_id;
    44| $result = restrictedArea($user, 'tax', '', '', 'charges');
    45| $modetax = $conf->global->TAX_MODE;
    46| if (isset($_GET["modetax"])) 
    47|     $modetax=$_GET["modetax"];
    48| /**
    49|  * print function
    50|  *
    51|  * @param   DoliDB $db          Database
    52|  * @param   string $sql     sql
    53|  * @param   string $date    date
    54|  * @return  void
    55|  */
    56| function pt ($db, $sql, $date)
    57| {
    58|     global $conf, $bc,$langs;
    59|     $result = $db->query($sql);
    60|     if ($result) {
    61|         $num = $db->num_rows($result);
    62|         $i = 0;
    63|         $total = 0;
    64|         print '<table class="noborder" width="100%">';
    65|         print '<tr class="liste_titre">';
    66|         print '<td class="nowrap" width="60%">'.$date.'</td>';

# --- HUNK 2: Lines 120-161 ---
   120| print '<tr class="liste_titre">';
   121| print '<td width="30%">'.$langs->trans("Year")." ".$y."</td>";
   122| if($CalcLT==0) {
   123|     print "<td align=\"right\">".$langs->transcountry($LTCustomer,$mysoc->country_code)."</td>";
   124|     print "<td align=\"right\">".$langs->transcountry($LTSupplier,$mysoc->country_code)."</td>";
   125| }
   126| if($CalcLT==1) {
   127|     print "<td align=\"right\">".$langs->transcountry($LTSupplier,$mysoc->country_code)."</td><td></td>";
   128| }
   129| if($CalcLT==2) {
   130|     print "<td align=\"right\">".$langs->transcountry($LTCustomer,$mysoc->country_code)."</td><td></td>";
   131| }
   132| print "<td align=\"right\">".$langs->trans("TotalToPay")."</td>";
   133| print "<td>&nbsp;</td>\n";
   134| print "</tr>\n";
   135| $y = $year_current ;
   136| $var=True;
   137| $total=0; $subtotalcoll=0; $subtotalpaye=0; $subtotal=0;
   138| $i=0;
   139| for ($m = 1 ; $m < 13 ; $m++ ) {
   140|     $coll_listsell = vat_by_date($db, $y, 0, 0, 0, $modetax, 'sell', $m);
   141|     $coll_listbuy = vat_by_date($db, $y, 0, 0, 0, $modetax, 'buy', $m);
   142|     $action = "tva";
   143|     $object = array(&$coll_listsell, &$coll_listbuy);
   144|     $parameters["mode"] = $modetax;
   145|     $parameters["year"] = $y;
   146|     $parameters["month"] = $m;
   147|     $parameters["type"] = 'localtax'.$localTaxType;
   148|     $hookmanager->initHooks(array('externalbalance'));
   149|     $reshook=$hookmanager->executeHooks('addVatLine',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
   150|     if (! is_array($coll_listbuy) && $coll_listbuy == -1) {
   151|         $langs->load("errors");
   152|         print '<tr><td colspan="5">'.$langs->trans("ErrorNoAccountancyModuleLoaded").'</td></tr>';
   153|         break;
   154|     }
   155|     if (! is_array($coll_listbuy) && $coll_listbuy == -2) {
   156|         print '<tr><td colspan="5">'.$langs->trans("FeatureNotYetAvailable").'</td></tr>';
   157|         break;
   158|     }
   159|     print '<tr class="oddeven">';
   160|     print '<td class="nowrap">'.dol_print_date(dol_mktime(0,0,0,$m,1,$y),"%b %Y").'</td>';
   161|     if($CalcLT==0) {


# ====================================================================
# FILE: htdocs/compta/paiement/cheque/index.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 57-128 ---
    57|   $var=false;
    58|   if ($row = $db->fetch_row($resql) )
    59|     {
    60|       $num = $row[0];
    61|     }
    62|   print '<tr class="oddeven">';
    63|   print '<td>'.$langs->trans("BankChecksToReceipt").'</td>';
    64|   print '<td align="right">';
    65|   print '<a href="'.DOL_URL_ROOT.'/compta/paiement/cheque/card.php?leftmenu=customers_bills_checks&action=new">'.$num.'</a>';
    66|   print '</td></tr>';
    67|   print "</table>\n";
    68| }
    69| else
    70| {
    71|   dol_print_error($db);
    72| }
    73| print '</div><div class="fichetwothirdright"><div class="ficheaddleft">';
    74| $max=10;
    75| $sql = "SELECT bc.rowid, bc.date_bordereau as db, bc.amount, bc.ref as ref,";
    76| $sql.= " bc.statut, bc.nbcheque,";
    77| $sql.= " ba.ref, ba.label, ba.rowid as bid, ba.number, ba.currency_code, ba.account_number, ba.accountancy_journal,";
    78| $sql.= " aj.code";
    79| $sql.= " FROM ".MAIN_DB_PREFIX."bordereau_cheque as bc, ".MAIN_DB_PREFIX."bank_account as ba";
    80| $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_journal as aj ON aj.rowid = ba.fk_accountancy_journal";
    81| $sql.= " WHERE ba.rowid = bc.fk_bank_account";
    82| $sql.= " AND bc.entity = ".$conf->entity;
    83| $sql.= " ORDER BY bc.date_bordereau DESC, rowid DESC";
    84| $sql.= $db->plimit($max);
    85| $resql = $db->query($sql);
    86| if ($resql)
    87| {
    88| 	print '<table class="noborder" width="100%">';
    89| 	print '<tr class="liste_titre">';
    90| 	print '<th>'.$langs->trans("LastCheckReceiptShort",$max).'</th>';
    91| 	print '<th>'.$langs->trans("Date")."</th>";
    92| 	print '<th>'.$langs->trans("Account").'</th>';
    93| 	print '<th align="right">'.$langs->trans("NbOfCheques").'</th>';
    94| 	print '<th align="right">'.$langs->trans("Amount").'</th>';
    95| 	print '<th align="right">'.$langs->trans("Status").'</th>';
    96| 	print "</tr>\n";
    97| 	$var=true;
    98| 	while ( $objp = $db->fetch_object($resql) )
    99| 	{
   100|         $checkdepositstatic->id=$objp->rowid;
   101|         $checkdepositstatic->ref=($objp->ref?$objp->ref:$objp->rowid);
   102| 	    $checkdepositstatic->statut=$objp->statut;
   103| 		$accountstatic->id=$objp->bid;
   104| 		$accountstatic->ref=$objp->ref;
   105| 		$accountstatic->label=$objp->label;
   106| 		$accountstatic->number=$objp->number;
   107| 		$accountstatic->currency_code=$objp->currency_code;
   108| 		$accountstatic->account_number=$objp->account_number;
   109| 		$accountstatic->accountancy_journal=$objp->code;
   110| 		print '<tr class="oddeven">'."\n";
   111| 		print '<td>'.$checkdepositstatic->getNomUrl(1).'</td>';
   112| 		print '<td>'.dol_print_date($db->jdate($objp->db),'day').'</td>';
   113| 		print '<td>'.$accountstatic->getNomUrl(1).'</td>';
   114| 		print '<td align="right">'.$objp->nbcheque.'</td>';
   115| 		print '<td align="right">'.price($objp->amount).'</td>';
   116| 		print '<td align="right">'.$checkdepositstatic->LibStatut($objp->statut,3).'</td>';
   117| 		print '</tr>';
   118| 	}
   119| 	print "</table>";
   120| 	$db->free($resql);
   121| }
   122| else
   123| {
   124|     dol_print_error($db);
   125| }
   126| print '</div></div></div>';
   127| llxFooter();
   128| $db->close();


# ====================================================================
# FILE: htdocs/compta/resultat/clientfourn.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 77-117 ---
    77|         if (! GETPOST('month'))
    78|         {
    79|             if (! GETPOST("year") &&  $month_start > $month_current)
    80|             {
    81|                 $year_start--;
    82|                 $year_end--;
    83|             }
    84|             $month_end=$month_start-1;
    85|             if ($month_end < 1) $month_end=12;
    86|             else $year_end++;
    87|         }
    88|         else $month_end=$month_start;
    89|         $date_start=dol_get_first_day($year_start,$month_start,false); $date_end=dol_get_last_day($year_end,$month_end,false);
    90|     }
    91|     if ($q==1) { $date_start=dol_get_first_day($year_start,1,false); $date_end=dol_get_last_day($year_start,3,false); }
    92|     if ($q==2) { $date_start=dol_get_first_day($year_start,4,false); $date_end=dol_get_last_day($year_start,6,false); }
    93|     if ($q==3) { $date_start=dol_get_first_day($year_start,7,false); $date_end=dol_get_last_day($year_start,9,false); }
    94|     if ($q==4) { $date_start=dol_get_first_day($year_start,10,false); $date_end=dol_get_last_day($year_start,12,false); }
    95| }
    96| $tmps=dol_getdate($date_start);
    97| $start_year = $tmps['year'];
    98| $tmpe=dol_getdate($date_end);
    99| $year_end = $tmpe['year'];
   100| $nbofyear = ($year_end - $start_year) + 1;
   101| $modecompta = $conf->global->ACCOUNTING_MODE;
   102| if (! empty($conf->accounting->enabled)) $modecompta='BOOKKEEPING';
   103| if (GETPOST("modecompta",'alpha')) $modecompta=GETPOST("modecompta",'alpha');
   104| $AccCat = new AccountancyCategory($db);
   105| /*
   106|  * View
   107|  */
   108| $months = array(
   109| 	$langs->trans("JanuaryMin"),
   110| 	$langs->trans("FebruaryMin"),
   111| 	$langs->trans("MarchMin"),
   112| 	$langs->trans("AprilMin"),
   113| 	$langs->trans("MayMin"),
   114| 	$langs->trans("JuneMin"),
   115| 	$langs->trans("JulyMin"),
   116| 	$langs->trans("AugustMin"),
   117| 	$langs->trans("SeptemberMin"),

# --- HUNK 2: Lines 190-273 ---
   190| 	{
   191| 		print_liste_field_titre("AmountHT", $_SERVER["PHP_SELF"],'amount_ht','',$param,'align="right"',$sortfield,$sortorder);
   192| 	}
   193| 	print_liste_field_titre("AmountTTC", $_SERVER["PHP_SELF"],'amount_ttc','',$param,'align="right"',$sortfield,$sortorder);
   194| }
   195| print "</tr>\n";
   196| if ($modecompta == 'BOOKKEEPING')
   197| {
   198| 	$predefinedgroupwhere = "(";
   199| 	$predefinedgroupwhere.= " (pcg_type = 'EXPENSE')";
   200| 	$predefinedgroupwhere.= " OR ";
   201| 	$predefinedgroupwhere.= " (pcg_type = 'INCOME')";
   202| 	$predefinedgroupwhere.= ")";
   203| 	$charofaccountstring = $conf->global->CHARTOFACCOUNTS;
   204| 	$charofaccountstring=dol_getIdFromCode($db, $conf->global->CHARTOFACCOUNTS, 'accounting_system', 'rowid', 'pcg_version');
   205| 	$sql = "SELECT f.thirdparty_code as name, -1 as socid, aa.pcg_type, aa.pcg_subtype, sum(f.credit - f.debit) as amount";
   206| 	$sql.= " FROM ".MAIN_DB_PREFIX."accounting_bookkeeping as f";
   207| 	$sql.= ", ".MAIN_DB_PREFIX."accounting_account as aa";
   208| 	$sql.= " WHERE f.numero_compte = aa.account_number";
   209| 	$sql.= " AND ".$predefinedgroupwhere;
   210| 	$sql.= " AND f.entity = ".$conf->entity;
   211| 	if (! empty($date_start) && ! empty($date_end))
   212| 		$sql.= " AND f.doc_date >= '".$db->idate($date_start)."' AND f.doc_date <= '".$db->idate($date_end)."'";
   213| 	$sql.= " GROUP BY pcg_type, pcg_subtype, name, socid";
   214| 	$sql.= $db->order($sortfield, $sortorder);
   215| 	$oldpcgtype = '';
   216| 	$oldpcgsubtype = '';
   217| 	dol_syslog("get bookkeeping entries", LOG_DEBUG);
   218| 	$result = $db->query($sql);
   219| 	if ($result) {
   220| 		$num = $db->num_rows($result);
   221| 		$i = 0;
   222| 		if ($num > 0)
   223| 		{
   224| 			while ($i < $num)
   225| 			{
   226| 				$objp = $db->fetch_object($result);
   227| 				if ($objp->pcg_type != $oldpcgtype)
   228| 				{
   229| 					print '<tr><td colspan="4">'.$objp->pcg_type.'</td></tr>';
   230| 					$oldpcgtype = $objp->pcg_type;
   231| 				}
   232| 				print '<tr class="oddeven">';
   233| 				print '<td>&nbsp;</td>';
   234| 				print '<td>'.$objp->pcg_type.($objp->pcg_subtype != 'XXXXXX'?' - '.$objp->pcg_subtype:'').($objp->name?' ('.$objp->name.')':'')."</td>\n";
   235| 				print '<td align="right">'.price($objp->amount)."</td>\n";
   236| 				print "</tr>\n";
   237| 				$total_ht += (isset($objp->amount)?$objp->amount:0);
   238| 				$total_ttc +=  (isset($objp->amount)?$objp->amount:0);
   239| 				if ($showaccountdetail != 'no')
   240| 				{
   241| 					$tmppredefinedgroupwhere="pcg_type = '".$db->escape($objp->pcg_type)."' AND pcg_subtype = '".$db->escape($objp->pcg_subtype)."'";
   242| 					$tmppredefinedgroupwhere.= " AND fk_pcg_version = '".$charofaccountstring."'";
   243| 					$cpts = $AccCat->getCptsCat(0, $tmppredefinedgroupwhere);
   244| 					foreach($cpts as $i => $cpt)
   245| 					{
   246| 						$return = $AccCat->getResult($cpt['account_number'], 0, $date_start, $date_end, $cpt['dc']);
   247| 						if ($return < 0) {
   248| 							setEventMessages(null, $AccCat->errors, 'errors');
   249| 							$resultN=0;
   250| 						} else {
   251| 							$resultN=$AccCat->sdc;
   252| 						}
   253| 						if ($showaccountdetail == 'all' || $resultN > 0)
   254| 						{
   255| 							print '<tr>';
   256| 							print '<td></td>';
   257| 							print '<td class="tdoverflowmax200"> &nbsp; &nbsp; ' . length_accountg($cpt['account_number']) . ' - ' . $cpt['account_label'] . '</td>';
   258| 							print '<td align="right">' . price($resultN) . '</td>';
   259| 							print "</tr>\n";
   260| 						}
   261| 					}
   262| 				}
   263| 				$i++;
   264| 			}
   265| 		}
   266| 		else
   267| 		{
   268| 			print '<tr><td colspan="4" class="opacitymedium">'.$langs->trans("NoRecordFound").'</td></tr>';
   269| 		}
   270| 	}
   271| 	else dol_print_error($db);
   272| }
   273| else


# ====================================================================
# FILE: htdocs/compta/resultat/index.php
# Total hunks: 11
# ====================================================================
# --- HUNK 1: Lines 58-98 ---
    58| 		if (! GETPOST('month'))
    59| 		{
    60| 			if (! GETPOST("year") &&  $month_start > $month_current)
    61| 			{
    62| 				$year_start--;
    63| 				$year_end--;
    64| 			}
    65| 			$month_end=$month_start-1;
    66| 			if ($month_end < 1) $month_end=12;
    67| 			else $year_end++;
    68| 		}
    69| 		else $month_end=$month_start;
    70| 		$date_start=dol_get_first_day($year_start,$month_start,false); $date_end=dol_get_last_day($year_end,$month_end,false);
    71| 	}
    72| 	if ($q==1) { $date_start=dol_get_first_day($year_start,1,false); $date_end=dol_get_last_day($year_start,3,false); }
    73| 	if ($q==2) { $date_start=dol_get_first_day($year_start,4,false); $date_end=dol_get_last_day($year_start,6,false); }
    74| 	if ($q==3) { $date_start=dol_get_first_day($year_start,7,false); $date_end=dol_get_last_day($year_start,9,false); }
    75| 	if ($q==4) { $date_start=dol_get_first_day($year_start,10,false); $date_end=dol_get_last_day($year_start,12,false); }
    76| }
    77| $tmps=dol_getdate($date_start);
    78| $start_year = $tmps['year'];
    79| $tmpe=dol_getdate($date_end);
    80| $year_end = $tmpe['year'];
    81| $nbofyear = ($year_end - $start_year) + 1;
    82| $socid = GETPOST('socid','int');
    83| if ($user->societe_id > 0) $socid = $user->societe_id;
    84| if (! empty($conf->comptabilite->enabled)) $result=restrictedArea($user,'compta','','','resultat');
    85| if (! empty($conf->accounting->enabled)) $result=restrictedArea($user,'accounting','','','comptarapport');
    86| $modecompta = $conf->global->ACCOUNTING_MODE;
    87| if (! empty($conf->accounting->enabled)) $modecompta='BOOKKEEPING';
    88| if (GETPOST("modecompta",'alpha')) $modecompta=GETPOST("modecompta",'alpha');
    89| /*
    90|  * View
    91|  */
    92| llxHeader();
    93| $form=new Form($db);
    94| $exportlink='';
    95| if ($modecompta == 'CREANCES-DETTES')
    96| {
    97| 	$name = $langs->trans("ReportInOut").', '.$langs->trans("ByYear");
    98| 	$calcmode=$langs->trans("CalcModeDebt");

# --- HUNK 2: Lines 298-421 ---
   298|  */
   299| $subtotal_ht = 0;
   300| $subtotal_ttc = 0;
   301| if (! empty($conf->tax->enabled) && ($modecompta == 'CREANCES-DETTES' || $modecompta=="RECETTES-DEPENSES"))
   302| {
   303| 	if ($modecompta == 'CREANCES-DETTES')
   304| 	{
   305| 		$sql = "SELECT sum(f.tva) as amount, date_format(f.datef,'%Y-%m') as dm";
   306| 		$sql.= " FROM ".MAIN_DB_PREFIX."facture as f";
   307| 		$sql.= " WHERE f.fk_statut IN (1,2)";
   308| 		if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) $sql.= " AND f.type IN (0,1,2,5)";
   309| 		else $sql.= " AND f.type IN (0,1,2,3,5)";
   310| 		$sql.= " AND f.entity = ".$conf->entity;
   311|     	if (! empty($date_start) && ! empty($date_end))
   312|     		$sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
   313| 		$sql.= " GROUP BY dm";
   314| 		dol_syslog("get vat to pay", LOG_DEBUG);
   315| 		$result=$db->query($sql);
   316| 		if ($result) {
   317| 			$num = $db->num_rows($result);
   318| 			$var=false;
   319| 			$i = 0;
   320| 			if ($num) {
   321| 				while ($i < $num) {
   322| 					$obj = $db->fetch_object($result);
   323| 					if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
   324| 					$decaiss[$obj->dm] += $obj->amount;
   325| 					if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
   326| 					$decaiss_ttc[$obj->dm] += $obj->amount;
   327| 					$i++;
   328| 				}
   329| 			}
   330| 		} else {
   331| 			dol_print_error($db);
   332| 		}
   333| 		$sql = "SELECT sum(f.total_tva) as amount, date_format(f.datef,'%Y-%m') as dm";
   334| 		$sql.= " FROM ".MAIN_DB_PREFIX."facture_fourn as f";
   335| 		$sql.= " WHERE f.fk_statut IN (1,2)";
   336| 		if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) $sql.= " AND f.type IN (0,1,2)";
   337| 		else $sql.= " AND f.type IN (0,1,2,3)";
   338| 		$sql.= " AND f.entity = ".$conf->entity;
   339|     	if (! empty($date_start) && ! empty($date_end))
   340|     		$sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
   341| 		$sql.= " GROUP BY dm";
   342| 		dol_syslog("get vat to receive back", LOG_DEBUG);
   343| 		$result=$db->query($sql);
   344| 		if ($result) {
   345| 			$num = $db->num_rows($result);
   346| 			$var=false;
   347| 			$i = 0;
   348| 			if ($num) {
   349| 				while ($i < $num) {
   350| 					$obj = $db->fetch_object($result);
   351| 					if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
   352| 					$encaiss[$obj->dm] += $obj->amount;
   353| 					if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
   354| 					$encaiss_ttc[$obj->dm] += $obj->amount;
   355| 					$i++;
   356| 				}
   357| 			}
   358| 		} else {
   359| 			dol_print_error($db);
   360| 		}
   361| 	}
   362| 	else if ($modecompta=="RECETTES-DEPENSES")
   363| 	{
   364| 		$sql = "SELECT sum(t.amount) as amount, date_format(t.datev,'%Y-%m') as dm";
   365| 		$sql.= " FROM ".MAIN_DB_PREFIX."tva as t";
   366| 		$sql.= " WHERE amount > 0";
   367| 		$sql.= " AND t.entity = ".$conf->entity;
   368|     	if (! empty($date_start) && ! empty($date_end))
   369|     		$sql.= " AND t.datev >= '".$db->idate($date_start)."' AND t.datev <= '".$db->idate($date_end)."'";
   370| 		$sql.= " GROUP BY dm";
   371| 		dol_syslog("get vat really paid", LOG_DEBUG);
   372| 		$result=$db->query($sql);
   373| 		if ($result) {
   374| 			$num = $db->num_rows($result);
   375| 			$var=false;
   376| 			$i = 0;
   377| 			if ($num) {
   378| 				while ($i < $num) {
   379| 					$obj = $db->fetch_object($result);
   380| 					if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
   381| 					$decaiss[$obj->dm] += $obj->amount;
   382| 					if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
   383| 					$decaiss_ttc[$obj->dm] += $obj->amount;
   384| 					$i++;
   385| 				}
   386| 			}
   387| 		} else {
   388| 			dol_print_error($db);
   389| 		}
   390| 		$sql = "SELECT sum(t.amount) as amount, date_format(t.datev,'%Y-%m') as dm";
   391| 		$sql.= " FROM ".MAIN_DB_PREFIX."tva as t";
   392| 		$sql.= " WHERE amount < 0";
   393| 		$sql.= " AND t.entity = ".$conf->entity;
   394|     	if (! empty($date_start) && ! empty($date_end))
   395|     		$sql.= " AND t.datev >= '".$db->idate($date_start)."' AND t.datev <= '".$db->idate($date_end)."'";
   396| 		$sql.= " GROUP BY dm";
   397| 		dol_syslog("get vat really received back", LOG_DEBUG);
   398| 		$result=$db->query($sql);
   399| 		if ($result) {
   400| 			$num = $db->num_rows($result);
   401| 			$var=false;
   402| 			$i = 0;
   403| 			if ($num) {
   404| 				while ($i < $num) {
   405| 					$obj = $db->fetch_object($result);
   406| 					if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
   407| 					$encaiss[$obj->dm] += $obj->amount;
   408| 					if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
   409| 					$encaiss_ttc[$obj->dm] += $obj->amount;
   410| 					$i++;
   411| 				}
   412| 			}
   413| 		} else {
   414| 			dol_print_error($db);
   415| 		}
   416| 	}
   417| }
   418| else if ($modecompta=="BOOKKEEPING")
   419| {
   420| }
   421| /*

# --- HUNK 3: Lines 436-476 ---
   436|     		$sql.= " AND cs.date_ech >= '".$db->idate($date_start)."' AND cs.date_ech <= '".$db->idate($date_end)."'";
   437| 	}
   438| 	else if ($modecompta=="RECETTES-DEPENSES")
   439| 	{
   440| 		$sql = "SELECT c.libelle as nom, date_format(p.datep,'%Y-%m') as dm, sum(p.amount) as amount";
   441| 		$sql.= " FROM ".MAIN_DB_PREFIX."c_chargesociales as c";
   442| 		$sql.= ", ".MAIN_DB_PREFIX."chargesociales as cs";
   443| 		$sql.= ", ".MAIN_DB_PREFIX."paiementcharge as p";
   444| 		$sql.= " WHERE p.fk_charge = cs.rowid";
   445| 		$sql.= " AND cs.fk_type = c.id";
   446| 		$sql.= " AND c.deductible = 0";
   447|     	if (! empty($date_start) && ! empty($date_end))
   448|     		$sql.= " AND p.datep >= '".$db->idate($date_start)."' AND p.datep <= '".$db->idate($date_end)."'";
   449| 	}
   450| 	$sql.= " AND cs.entity = ".$conf->entity;
   451| 	$sql.= " GROUP BY c.libelle, dm";
   452| 	dol_syslog("get social contributions deductible=0 ", LOG_DEBUG);
   453| 	$result=$db->query($sql);
   454| 	if ($result) {
   455| 		$num = $db->num_rows($result);
   456| 		$var=false;
   457| 		$i = 0;
   458| 		if ($num) {
   459| 			while ($i < $num) {
   460| 				$obj = $db->fetch_object($result);
   461| 				if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
   462| 				$decaiss[$obj->dm] += $obj->amount;
   463| 				if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
   464| 				$decaiss_ttc[$obj->dm] += $obj->amount;
   465| 				$i++;
   466| 			}
   467| 		}
   468| 	} else {
   469| 		dol_print_error($db);
   470| 	}
   471| }
   472| else if ($modecompta=="BOOKKEEPING")
   473| {
   474| }
   475| /*
   476|  * Charges sociales deductibles

# --- HUNK 4: Lines 490-568 ---
   490|     		$sql.= " AND cs.date_ech >= '".$db->idate($date_start)."' AND cs.date_ech <= '".$db->idate($date_end)."'";
   491| 	}
   492| 	else if ($modecompta=="RECETTES-DEPENSES")
   493| 	{
   494| 		$sql = "SELECT c.libelle as nom, date_format(p.datep,'%Y-%m') as dm, sum(p.amount) as amount";
   495| 		$sql.= " FROM ".MAIN_DB_PREFIX."c_chargesociales as c";
   496| 		$sql.= ", ".MAIN_DB_PREFIX."chargesociales as cs";
   497| 		$sql.= ", ".MAIN_DB_PREFIX."paiementcharge as p";
   498| 		$sql.= " WHERE p.fk_charge = cs.rowid";
   499| 		$sql.= " AND cs.fk_type = c.id";
   500| 		$sql.= " AND c.deductible = 1";
   501|     	if (! empty($date_start) && ! empty($date_end))
   502|     		$sql.= " AND p.datep >= '".$db->idate($date_start)."' AND p.datep <= '".$db->idate($date_end)."'";
   503| 	}
   504| 	$sql.= " AND cs.entity = ".$conf->entity;
   505| 	$sql.= " GROUP BY c.libelle, dm";
   506| 	dol_syslog("get social contributions paid deductible=1", LOG_DEBUG);
   507| 	$result=$db->query($sql);
   508| 	if ($result) {
   509| 		$num = $db->num_rows($result);
   510| 		$var=false;
   511| 		$i = 0;
   512| 		if ($num) {
   513| 			while ($i < $num) {
   514| 				$obj = $db->fetch_object($result);
   515| 				if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
   516| 				$decaiss[$obj->dm] += $obj->amount;
   517| 				if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
   518| 				$decaiss_ttc[$obj->dm] += $obj->amount;
   519| 				$i++;
   520| 			}
   521| 		}
   522| 	} else {
   523| 		dol_print_error($db);
   524| 	}
   525| }
   526| else if ($modecompta=="BOOKKEEPING")
   527| {
   528| }
   529| /*
   530|  * Salaries
   531|  */
   532| if (! empty($conf->salaries->enabled) && ($modecompta == 'CREANCES-DETTES' || $modecompta=="RECETTES-DEPENSES"))
   533| {
   534| 	if ($modecompta == 'CREANCES-DETTES')   $column = 'p.datev';
   535| 	if ($modecompta == "RECETTES-DEPENSES")	$column = 'p.datep';
   536| 	$subtotal_ht = 0;
   537| 	$subtotal_ttc = 0;
   538| 	$sql = "SELECT p.label as nom, date_format(".$column.",'%Y-%m') as dm, sum(p.amount) as amount";
   539| 	$sql .= " FROM " . MAIN_DB_PREFIX . "payment_salary as p";
   540| 	$sql .= " WHERE p.entity IN (".getEntity('payment_salary').")";
   541| 	if (! empty($date_start) && ! empty($date_end))
   542| 		$sql.= " AND ".$column." >= '".$db->idate($date_start)."' AND ".$column." <= '".$db->idate($date_end)."'";
   543| 	$sql .= " GROUP BY p.label, dm";
   544| 	dol_syslog("get social salaries payments");
   545| 	$result = $db->query($sql);
   546| 	if ($result) {
   547| 		$num = $db->num_rows($result);
   548| 		$var = false;
   549| 		$i = 0;
   550| 		if ($num) {
   551| 			while ($i < $num) {
   552| 				$obj = $db->fetch_object($result);
   553| 				if (! isset($decaiss[$obj->dm]))
   554| 					$decaiss[$obj->dm] = 0;
   555| 				$decaiss[$obj->dm] += $obj->amount;
   556| 				if (! isset($decaiss_ttc[$obj->dm]))
   557| 					$decaiss_ttc[$obj->dm] = 0;
   558| 				$decaiss_ttc[$obj->dm] += $obj->amount;
   559| 				$i ++;
   560| 			}
   561| 		}
   562| 	} else {
   563| 		dol_print_error($db);
   564| 	}
   565| }
   566| elseif ($modecompta == "BOOKKEEPING")
   567| {
   568| }

# --- HUNK 5: Lines 633-728 ---
   633|         $sql.= " AND fk_statut in (1,2)";
   634| 		if (! empty($date_start) && ! empty($date_end))
   635| 			$sql.= " AND p.datedon >= '".$db->idate($date_start)."' AND p.datedon <= '".$db->idate($date_end)."'";
   636|     }
   637|      elseif ($modecompta == 'RECETTES-DEPENSES') {
   638|         $sql = "SELECT p.societe as nom, p.firstname, p.lastname, date_format(pe.datep,'%Y-%m') as dm, sum(p.amount) as amount";
   639|         $sql.= " FROM ".MAIN_DB_PREFIX."don as p";
   640| 		$sql.= " INNER JOIN ".MAIN_DB_PREFIX."payment_donation as pe ON pe.fk_donation = p.rowid";
   641| 		$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."c_paiement as c ON pe.fk_typepayment = c.id AND c.entity IN (".getEntity('c_paiement').")";
   642| 		$sql.= " WHERE p.entity IN (".getEntity('donation').")";
   643|    	    $sql.= " AND fk_statut >= 2";
   644| 		if (! empty($date_start) && ! empty($date_end))
   645| 			$sql.= " AND pe.datep >= '".$db->idate($date_start)."' AND pe.datep <= '".$db->idate($date_end)."'";
   646|      }
   647|     $sql.= " GROUP BY p.societe, p.firstname, p.lastname, dm";
   648|     dol_syslog("get donation payments");
   649|     $result=$db->query($sql);
   650|     if ($result)
   651|     {
   652|     	$num = $db->num_rows($result);
   653|     	$var=false;
   654|     	$i = 0;
   655|     	if ($num)
   656|     	{
   657|     		while ($i < $num)
   658|     		{
   659|     			$obj = $db->fetch_object($result);
   660|     			if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
   661|     			$encaiss[$obj->dm] += $obj->amount;
   662|     			if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
   663|     			$encaiss_ttc[$obj->dm] += $obj->amount;
   664|     			$i++;
   665|     		}
   666|     	}
   667|     }
   668|     else
   669|     {
   670|     	dol_print_error($db);
   671|     }
   672| }
   673| elseif ($modecompta == 'BOOKKEEPING') {
   674| }
   675| /*
   676|  * Request in mode BOOKKEEPING
   677|  */
   678| if (! empty($conf->accounting->enabled) && ($modecompta == 'BOOKKEEPING'))
   679| {
   680| 	$subtotal_ht = 0;
   681| 	$subtotal_ttc = 0;
   682| 	$sql = "SELECT b.doc_ref, b.numero_compte, b.subledger_account, b.subledger_label, pcg_type, date_format(b.doc_date,'%Y-%m') as dm, sum(b.debit) as debit, sum(b.credit) as credit, sum(b.montant) as amount";
   683| 	$sql.= " FROM ".MAIN_DB_PREFIX."accounting_bookkeeping as b, ".MAIN_DB_PREFIX."accounting_account as aa";
   684| 	$sql.= " WHERE b.numero_compte = aa.account_number AND b.entity = ".$conf->entity;
   685| 	$sql.= " AND (";
   686| 	$sql.= " (pcg_type = 'EXPENSE')";
   687| 	$sql.= " OR ";
   688| 	$sql.= " (pcg_type = 'INCOME')";
   689| 	$sql.= ")";
   690| 	if (! empty($date_start) && ! empty($date_end))
   691| 		$sql.= " AND b.doc_date >= '".$db->idate($date_start)."' AND b.doc_date <= '".$db->idate($date_end)."'";
   692| 	$sql.= " GROUP BY b.doc_ref, b.numero_compte, b.subledger_account, b.subledger_label, pcg_type, dm";
   693| 	dol_syslog("get bookkeeping record");
   694| 	$result=$db->query($sql);
   695| 	if ($result)
   696| 	{
   697| 		$num = $db->num_rows($result);
   698| 		$var=false;
   699| 		$i = 0;
   700| 		if ($num)
   701| 		{
   702| 			while ($i < $num)
   703| 			{
   704| 				$obj = $db->fetch_object($result);
   705| 				if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
   706| 				$encaiss[$obj->dm] += $obj->debit;
   707| 				if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
   708| 				$encaiss_ttc[$obj->dm] += $obj->credit;
   709| 				$i++;
   710| 			}
   711| 		}
   712| 	}
   713| 	else
   714| 	{
   715| 		dol_print_error($db);
   716| 	}
   717| }
   718| $action = "balance";
   719| $object = array(&$encaiss, &$encaiss_ttc, &$decaiss, &$decaiss_ttc);
   720| $parameters["mode"] = $modecompta;
   721| $hookmanager->initHooks(array('externalbalance'));
   722| $reshook=$hookmanager->executeHooks('addReportInfo',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
   723| /*
   724|  * Show result array
   725|  */
   726| $totentrees=array();
   727| $totsorties=array();
   728| print '<div class="div-table-responsive">';

# --- HUNK 6: Lines 733-806 ---
   733| 	print '<td align="center" colspan="2" class="liste_titre borderrightlight">';
   734| 	print '<a href="clientfourn.php?year='.$annee.'">';
   735| 	print $annee;
   736| 	if ($conf->global->SOCIETE_FISCAL_MONTH_START > 1) print '-'.($annee+1);
   737| 	print '</a></td>';
   738| }
   739| print '</tr>';
   740| print '<tr class="liste_titre"><td class="liste_titre">'.$langs->trans("Month").'</td>';
   741| for ($annee = $year_start ; $annee <= $year_end ; $annee++)
   742| {
   743| 	print '<td class="liste_titre" align="center">';
   744| 	$htmlhelp='';
   745| 	print $form->textwithpicto($langs->trans("Outcome"), $htmlhelp);
   746| 	print '</td>';
   747| 	print '<td class="liste_titre" align="center" class="borderrightlight">';
   748| 	$htmlhelp='';
   749| 	print $form->textwithpicto($langs->trans("Income"), $htmlhelp);
   750| 	print '</td>';
   751| }
   752| print '</tr>';
   753| $var=True;
   754| $nb_mois_decalage = $conf->global->SOCIETE_FISCAL_MONTH_START?($conf->global->SOCIETE_FISCAL_MONTH_START-1):0;
   755| for ($mois = 1+$nb_mois_decalage ; $mois <= 12+$nb_mois_decalage ; $mois++)
   756| {
   757| 	$mois_modulo = $mois;
   758| 	if($mois>12) {$mois_modulo = $mois-12;}
   759| 	print '<tr class="oddeven">';
   760| 	print "<td>".dol_print_date(dol_mktime(12,0,0,$mois_modulo,1,$annee),"%B")."</td>";
   761| 	for ($annee = $year_start ; $annee <= $year_end ; $annee++)
   762| 	{
   763| 		$annee_decalage=$annee;
   764| 		if($mois>12) {$annee_decalage=$annee+1;}
   765| 		$case = strftime("%Y-%m",dol_mktime(12,0,0,$mois_modulo,1,$annee_decalage));
   766| 		print '<td align="right">&nbsp;';
   767| 		if (isset($decaiss_ttc[$case]) && $decaiss_ttc[$case] != 0)
   768| 		{
   769| 			print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($decaiss_ttc[$case],'MT')).'</a>';
   770| 			if (! isset($totsorties[$annee])) $totsorties[$annee]=0;
   771| 			$totsorties[$annee]+=$decaiss_ttc[$case];
   772| 		}
   773| 		print "</td>";
   774| 		print '<td align="right" class="borderrightlight">&nbsp;';
   775| 		if (isset($encaiss_ttc[$case]))
   776| 		{
   777| 			print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($encaiss_ttc[$case],'MT')).'</a>';
   778| 			if (! isset($totentrees[$annee])) $totentrees[$annee]=0;
   779| 			$totentrees[$annee]+=$encaiss_ttc[$case];
   780| 		}
   781| 		print "</td>";
   782| 	}
   783| 	print '</tr>';
   784| }
   785| $nbcols=0;
   786| print '<tr class="liste_total impair"><td>'.$langs->trans("TotalTTC").'</td>';
   787| for ($annee = $year_start ; $annee <= $year_end ; $annee++)
   788| {
   789| 	$nbcols+=2;
   790| 	print '<td align="right">'.(isset($totsorties[$annee])?price(price2num($totsorties[$annee],'MT')):'&nbsp;').'</td>';
   791| 	print '<td align="right" style="border-right: 1px solid #DDD">'.(isset($totentrees[$annee])?price(price2num($totentrees[$annee],'MT')):'&nbsp;').'</td>';
   792| }
   793| print "</tr>\n";
   794| print '<tr class="impair"><td>&nbsp;</td>';
   795| print '<td colspan="'.$nbcols.'">&nbsp;</td>';
   796| print "</tr>\n";
   797| print '<tr class="liste_total"><td>'.$langs->trans("AccountingResult").'</td>';
   798| for ($annee = $year_start ; $annee <= $year_end ; $annee++)
   799| {
   800| 	print '<td align="right" colspan="2" class="borderrightlight"> ';
   801| 	if (isset($totentrees[$annee]) || isset($totsorties[$annee]))
   802| 	{
   803| 		$in=(isset($totentrees[$annee])?price2num($totentrees[$annee], 'MT'):0);
   804| 		$out=(isset($totsorties[$annee])?price2num($totsorties[$annee],'MT'):0);
   805| 		print price(price2num($in-$out, 'MT')).'</td>';
   806| 	}


# ====================================================================
# FILE: htdocs/compta/tva/index.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 97-138 ---
    97| print load_fiche_titre($langs->transcountry("VAT", $mysoc->country_code), $textprevyear." ".$langs->trans("Year")." ".$year_start." ".$textnextyear, 'title_accountancy.png');
    98| print $langs->trans("VATReportBuildWithOptionDefinedInModule").'<br>';
    99| print '('.$langs->trans("TaxModuleSetupToModifyRules",DOL_URL_ROOT.'/admin/taxes.php').')<br>';
   100| print '<br>';
   101| print '<div class="fichecenter"><div class="fichethirdleft">';
   102| print load_fiche_titre($langs->trans("VATSummary"), '', '');
   103| print '<table class="noborder" width="100%">';
   104| print '<tr class="liste_titre">';
   105| print '<td width="30%">'.$langs->trans("Year")." ".$y.'</td>';
   106| print '<td align="right">'.$langs->trans("VATToPay").'</td>';
   107| print '<td align="right">'.$langs->trans("VATToCollect").'</td>';
   108| print '<td align="right">'.$langs->trans("TotalToPay").'</td>';
   109| print '<td>&nbsp;</td>'."\n";
   110| print '</tr>'."\n";
   111| $y = $year_current ;
   112| $var=True;
   113| $total=0; $subtotalcoll=0; $subtotalpaye=0; $subtotal=0;
   114| $i=0;
   115| for ($m = 1 ; $m < 13 ; $m++ )
   116| {
   117|     $coll_listsell = vat_by_date($db, $y, 0, 0, 0, $modetax, 'sell', $m);
   118|     $coll_listbuy = vat_by_date($db, $y, 0, 0, 0, $modetax, 'buy', $m);
   119|     $action = "tva";
   120|     $object = array(&$coll_listsell, &$coll_listbuy);
   121|     $parameters["mode"] = $modetax;
   122|     $parameters["year"] = $y;
   123|     $parameters["month"] = $m;
   124|     $parameters["type"] = 'vat';
   125|     $hookmanager->initHooks(array('externalbalance'));
   126|     $reshook=$hookmanager->executeHooks('addVatLine',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
   127|     if (! is_array($coll_listbuy) && $coll_listbuy == -1)
   128|     {
   129|         $langs->load("errors");
   130|         print '<tr><td colspan="5">'.$langs->trans("ErrorNoAccountancyModuleLoaded").'</td></tr>';
   131|         break;
   132|     }
   133|     if (! is_array($coll_listbuy) && $coll_listbuy == -2)
   134|     {
   135|         print '<tr><td colspan="5">'.$langs->trans("FeatureNotYetAvailable").'</td></tr>';
   136|         break;
   137|     }
   138|     print '<tr class="oddeven">';


# ====================================================================
# FILE: htdocs/compta/tva/quadri_detail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 155-196 ---
   155| 	$builddate=dol_now();
   156| 	$elementcust=$langs->trans("CustomersInvoices");
   157| 	$productcust=$langs->trans("ProductOrService");
   158| 	$amountcust=$langs->trans("AmountHT");
   159| 	$vatcust=$langs->trans("VATReceived");
   160| 	if ($mysoc->tva_assuj) $vatcust.=' ('.$langs->trans("ToPay").')';
   161| 	$elementsup=$langs->trans("SuppliersInvoices");
   162| 	$productsup=$langs->trans("ProductOrService");
   163| 	$amountsup=$langs->trans("AmountHT");
   164| 	$vatsup=$langs->trans("VATPaid");
   165| 	if ($mysoc->tva_assuj) $vatsup.=' ('.$langs->trans("ToGetBack").')';
   166| }
   167| report_header($name,'',$period,$periodlink,$description,$builddate,$exportlink,array(),$calcmode);
   168| $vatcust=$langs->trans("VATReceived");
   169| $vatsup=$langs->trans("VATPaid");
   170| $vatexpensereport=$langs->trans("VATPaid");
   171| print '<table class="noborder" width="100%">';
   172| $y = $year_current;
   173| $total = 0;
   174| $i=0;
   175| $x_coll = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'sell');
   176| $x_paye = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'buy');
   177| if (! is_array($x_coll) || ! is_array($x_paye))
   178| {
   179| 	$langs->load("errors");
   180| 	if ($x_coll == -1)
   181| 		print '<tr><td colspan="5">'.$langs->trans("ErrorNoAccountancyModuleLoaded").'</td></tr>';
   182| 	else if ($x_coll == -2)
   183| 		print '<tr><td colspan="5">'.$langs->trans("FeatureNotYetAvailable").'</td></tr>';
   184| 	else
   185| 		print '<tr><td colspan="5">'.$langs->trans("Error").'</td></tr>';
   186| }
   187| else
   188| {
   189| 	$x_both = array();
   190| 	foreach(array_keys($x_coll) as $my_coll_rate)
   191| 	{
   192| 		$x_both[$my_coll_rate]['coll']['totalht'] = $x_coll[$my_coll_rate]['totalht'];
   193| 		$x_both[$my_coll_rate]['coll']['vat']     = $x_coll[$my_coll_rate]['vat'];
   194| 		$x_both[$my_coll_rate]['paye']['totalht'] = 0;
   195| 		$x_both[$my_coll_rate]['paye']['vat'] = 0;
   196| 		$x_both[$my_coll_rate]['coll']['links'] = '';


# ====================================================================
# FILE: htdocs/compta/tva/quarter_report.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 197-238 ---
   197| 	if ($mysoc->tva_assuj) {
   198| 		$vatcust.=' ('.$langs->trans("ToPay").')';
   199| 	}
   200| 	$elementsup=$langs->trans("SuppliersInvoices");
   201| 	$productsup=$productcust;
   202| 	$amountsup=$amountcust;
   203| 	$vatsup=$langs->trans("VATPaid");
   204| 	$namesup=$namecust;
   205| 	if ($mysoc->tva_assuj) {
   206| 		$vatsup.=' ('.$langs->trans("ToGetBack").')';
   207| 	}
   208| }
   209| report_header($name,'',$period,$periodlink,$description,$builddate,$exportlink,array(),$calcmode);
   210| $vatcust=$langs->trans("VATReceived");
   211| $vatsup=$langs->trans("VATPaid");
   212| print '<table class="noborder" width="100%">';
   213| $y = $year_current;
   214| $total = 0;
   215| $i=0;
   216| $columns = 6;
   217| $x_coll = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'sell');
   218| $x_paye = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'buy');
   219| if (!is_array($x_coll) || !is_array($x_paye)) {
   220| 	$langs->load("errors");
   221| 	if ($x_coll == -1) {
   222| 		print '<tr><td colspan="' . $columns . '">' . $langs->trans("ErrorNoAccountancyModuleLoaded") . '</td></tr>';
   223| 	} else if ($x_coll == -2) {
   224| 		print '<tr><td colspan="' . $columns . '">' . $langs->trans("FeatureNotYetAvailable") . '</td></tr>';
   225| 	} else {
   226| 		print '<tr><td colspan="' . $columns . '">' . $langs->trans("Error") . '</td></tr>';
   227| 	}
   228| } else {
   229| 	$x_both = array();
   230| 	foreach(array_keys($x_coll) as $my_coll_rate) {
   231| 		$x_both[$my_coll_rate]['coll']['totalht'] = $x_coll[$my_coll_rate]['totalht'];
   232| 		$x_both[$my_coll_rate]['coll']['vat']	 = $x_coll[$my_coll_rate]['vat'];
   233| 		$x_both[$my_coll_rate]['paye']['totalht'] = 0;
   234| 		$x_both[$my_coll_rate]['paye']['vat'] = 0;
   235| 		$x_both[$my_coll_rate]['coll']['links'] = '';
   236| 		$x_both[$my_coll_rate]['coll']['detail'] = array();
   237| 		foreach($x_coll[$my_coll_rate]['facid'] as $id=>$dummy) {
   238| 			$invoice_customer->id=$x_coll[$my_coll_rate]['facid'][$id];


# ====================================================================
# FILE: htdocs/contact/card.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 125-184 ---
   125| 	}
   126| 	if ($action == 'enable')
   127| 	{
   128| 		$object->fetch($id);
   129| 		if ($object->setstatus(1)<0)
   130| 		{
   131| 			setEventMessages($object->error, $object->errors, 'errors');
   132| 		}
   133| 		else
   134| 		{
   135| 			header("Location: ".$_SERVER['PHP_SELF'].'?id='.$id);
   136| 			exit;
   137| 		}
   138| 	}
   139| 	if ($action == 'add' && $user->rights->societe->contact->creer)
   140| 	{
   141| 		$db->begin();
   142|         if ($canvas) $object->canvas=$canvas;
   143|         $object->entity			= (GETPOSTISSET('entity')?GETPOST('entity', 'int'):$conf->entity);
   144|         $object->socid			= GETPOST("socid",'int');
   145|         $object->lastname		= GETPOST("lastname");
   146|         $object->firstname		= GETPOST("firstname");
   147|         $object->civility_id		= GETPOST("civility_id",'alpha');
   148|         $object->poste			= GETPOST("poste");
   149|         $object->address			= GETPOST("address");
   150|         $object->zip				= GETPOST("zipcode");
   151|         $object->town			= GETPOST("town");
   152|         $object->country_id		= GETPOST("country_id",'int');
   153|         $object->state_id		= GETPOST("state_id",'int');
   154|         $object->skype			= GETPOST("skype");
   155|         $object->email			= GETPOST("email",'alpha');
   156|         $object->phone_pro		= GETPOST("phone_pro");
   157|         $object->phone_perso		= GETPOST("phone_perso");
   158|         $object->phone_mobile	= GETPOST("phone_mobile");
   159|         $object->fax				= GETPOST("fax");
   160|         $object->jabberid		= GETPOST("jabberid",'alpha');
   161| 		$object->no_email		= GETPOST("no_email",'int');
   162|         $object->priv			= GETPOST("priv",'int');
   163|         $object->note_public		= GETPOST("note_public");
   164|         $object->note_private	= GETPOST("note_private");
   165|         $object->statut			= 1; //Defult status to Actif
   166|         $object->birthday = dol_mktime(0,0,0,GETPOST("birthdaymonth",'int'),GETPOST("birthdayday",'int'),GETPOST("birthdayyear",'int'));
   167|         $object->birthday_alert = GETPOST("birthday_alert",'alpha');
   168| 		$ret = $extrafields->setOptionalsFromPost($extralabels,$object);
   169| 		if ($ret < 0)
   170| 		{
   171| 			$error++;
   172| 			$action = 'create';
   173| 		}
   174|         if (! GETPOST("lastname"))
   175|         {
   176|             $error++; $errors[]=$langs->trans("ErrorFieldRequired",$langs->transnoentities("Lastname").' / '.$langs->transnoentities("Label"));
   177|             $action = 'create';
   178|         }
   179|         if (! $error)
   180|         {
   181|             $id =  $object->create($user);
   182|             if ($id <= 0)
   183|             {
   184|                 $error++; $errors=array_merge($errors,($object->error?array($object->error):$object->errors));

# --- HUNK 2: Lines 268-331 ---
   268|                 }
   269|                 else
   270|                 {
   271|                     $errors[] = "ErrorBadImageFormat";
   272|                 }
   273|             }
   274|             else
   275|             {
   276|                 switch($_FILES['photo']['error'])
   277|                 {
   278|                     case 1: //uploaded file exceeds the upload_max_filesize directive in php.ini
   279|                     case 2: //uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the html form
   280|                         $errors[] = "ErrorFileSizeTooLarge";
   281|                         break;
   282|                     case 3: //uploaded file was only partially uploaded
   283|                         $errors[] = "ErrorFilePartiallyUploaded";
   284|                         break;
   285|                 }
   286|             }
   287| 			$object->oldcopy = clone $object;
   288|             $object->old_lastname	= GETPOST("old_lastname");
   289|             $object->old_firstname	= GETPOST("old_firstname");
   290|             $object->socid			= GETPOST("socid",'int');
   291|             $object->lastname		= GETPOST("lastname");
   292|             $object->firstname		= GETPOST("firstname");
   293|             $object->civility_id		= GETPOST("civility_id",'alpha');
   294|             $object->poste			= GETPOST("poste");
   295|             $object->address			= GETPOST("address");
   296|             $object->zip				= GETPOST("zipcode");
   297|             $object->town			= GETPOST("town");
   298|             $object->state_id   		= GETPOST("state_id",'int');
   299|             $object->fk_departement	= GETPOST("state_id",'int');	// For backward compatibility
   300|             $object->country_id		= GETPOST("country_id",'int');
   301|             $object->email			= GETPOST("email",'alpha');
   302|             $object->skype			= GETPOST("skype",'alpha');
   303|             $object->phone_pro		= GETPOST("phone_pro");
   304|             $object->phone_perso		= GETPOST("phone_perso");
   305|             $object->phone_mobile	= GETPOST("phone_mobile");
   306|             $object->fax				= GETPOST("fax");
   307|             $object->jabberid		= GETPOST("jabberid",'alpha');
   308| 			$object->no_email		= GETPOST("no_email",'int');
   309|             $object->priv			= GETPOST("priv",'int');
   310|             	$object->note_public		= GETPOST("note_public");
   311|        		$object->note_private	= GETPOST("note_private");
   312| 			$ret = $extrafields->setOptionalsFromPost($extralabels,$object);
   313| 			if ($ret < 0) $error++;
   314|             $result = $object->update($contactid, $user);
   315| 			if ($result > 0) {
   316| 				$sql = 'DELETE FROM ' . MAIN_DB_PREFIX . 'categorie_contact';
   317| 				$sql .= ' WHERE fk_socpeople = ' . $object->id;
   318| 				$db->query( $sql );
   319| 				$categories = GETPOST( 'contcats', 'array');
   320| 				$object->setCategories($categories);
   321|                 $object->old_lastname='';
   322|                 $object->old_firstname='';
   323|                 $action = 'view';
   324|             }
   325|             else
   326|             {
   327|                 setEventMessages($object->error, $object->errors, 'errors');
   328|                 $action = 'edit';
   329|             }
   330|         }
   331|         if (! $error && empty($errors))

# --- HUNK 3: Lines 420-550 ---
   420| 								$(\'input[name="town"]\').val("'.dol_escape_js($objsoc->town).'");
   421| 								console.log("Set state_id to '.dol_escape_js($objsoc->state_id).'");
   422| 								$(\'select[name="state_id"]\').val("'.dol_escape_js($objsoc->state_id).'").trigger("change");
   423| 								/* set country at end because it will trigger page refresh */
   424| 								console.log("Set country id to '.dol_escape_js($objsoc->country_id).'");
   425| 								$(\'select[name="country_id"]\').val("'.dol_escape_js($objsoc->country_id).'").trigger("change");   /* trigger required to update select2 components */
   426|                             });
   427| 						})'."\n";
   428| 				print '</script>'."\n";
   429|             }
   430|             print '<form method="post" name="formsoc" action="'.$_SERVER["PHP_SELF"].'">';
   431|             print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
   432|             print '<input type="hidden" name="action" value="add">';
   433|             print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
   434| 			if (! empty($objsoc)) {
   435| 				print '<input type="hidden" name="entity" value="'.$objsoc->entity.'">';
   436|             }
   437|             dol_fiche_head($head, 'card', '', 0, '');
   438|             print '<table class="border" width="100%">';
   439|             print '<tr><td class="titlefieldcreate fieldrequired"><label for="lastname">'.$langs->trans("Lastname").' / '.$langs->trans("Label").'</label></td>';
   440| 	        print '<td><input name="lastname" id="lastname" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("lastname")?GETPOST("lastname"):$object->lastname).'" autofocus="autofocus"></td>';
   441|             print '<td><label for="firstname">'.$langs->trans("Firstname").'</label></td>';
   442| 	        print '<td><input name="firstname" id="firstname"type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("firstname")?GETPOST("firstname"):$object->firstname).'"></td></tr>';
   443|             if (empty($conf->global->SOCIETE_DISABLE_CONTACTS))
   444|             {
   445|                 if ($socid > 0)
   446|                 {
   447|                     print '<tr><td><label for="socid">'.$langs->trans("ThirdParty").'</label></td>';
   448|                     print '<td colspan="3" class="maxwidthonsmartphone">';
   449|                     print $objsoc->getNomUrl(1, 'contact');
   450|                     print '</td>';
   451|                     print '<input type="hidden" name="socid" id="socid" value="'.$objsoc->id.'">';
   452|                     print '</td></tr>';
   453|                 }
   454|                 else {
   455|                     print '<tr><td><label for="socid">'.$langs->trans("ThirdParty").'</label></td><td colspan="3" class="maxwidthonsmartphone">';
   456|                     print $form->select_company($socid,'socid','','SelectThirdParty');
   457|                     print '</td></tr>';
   458|                 }
   459|             }
   460|             print '<tr><td><label for="civility_id">'.$langs->trans("UserTitle").'</label></td><td colspan="3">';
   461|             print $formcompany->select_civility(GETPOST("civility_id",'alpha')?GETPOST("civility_id",'alpha'):$object->civility_id);
   462|             print '</td></tr>';
   463|             print '<tr><td><label for="title">'.$langs->trans("PostOrFunction").'</label></td>';
   464| 	        print '<td colspan="3"><input name="poste" id="title" type="text" class="minwidth100" maxlength="80" value="'.dol_escape_htmltag(GETPOST("poste",'alpha')?GETPOST("poste",'alpha'):$object->poste).'"></td>';
   465|             $colspan=3;
   466|             if ($conf->use_javascript_ajax && $socid > 0) $colspan=2;
   467|             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->address)) == 0) $object->address = $objsoc->address;	// Predefined with third party
   468|             print '<tr><td><label for="address">'.$langs->trans("Address").'</label></td>';
   469|             print '<td colspan="'.$colspan.'"><textarea class="flat quatrevingtpercent" name="address" id="address" rows="'.ROWS_2.'">'.(GETPOST("address",'alpha')?GETPOST("address",'alpha'):$object->address).'</textarea></td>';
   470|             if ($conf->use_javascript_ajax && $socid > 0)
   471|             {
   472| 	            $rowspan=3;
   473| 	    		if (empty($conf->global->SOCIETE_DISABLE_STATE)) $rowspan++;
   474| 	            print '<td valign="middle" align="center" rowspan="'.$rowspan.'">';
   475| 		        print '<a href="#" id="copyaddressfromsoc">'.$langs->trans('CopyAddressFromSoc').'</a>';
   476| 	            print '</td>';
   477|             }
   478|             print '</tr>';
   479|             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->zip)) == 0) $object->zip = $objsoc->zip;			// Predefined with third party
   480|             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->town)) == 0) $object->town = $objsoc->town;	// Predefined with third party
   481|             print '<tr><td><label for="zipcode">'.$langs->trans("Zip").'</label> / <label for="town">'.$langs->trans("Town").'</label></td><td colspan="'.$colspan.'" class="maxwidthonsmartphone">';
   482|             print $formcompany->select_ziptown((GETPOST("zipcode")?GETPOST("zipcode"):$object->zip),'zipcode',array('town','selectcountry_id','state_id'),6).'&nbsp;';
   483|             print $formcompany->select_ziptown((GETPOST("town")?GETPOST("town"):$object->town),'town',array('zipcode','selectcountry_id','state_id'));
   484|             print '</td></tr>';
   485|             print '<tr><td><label for="selectcountry_id">'.$langs->trans("Country").'</label></td><td colspan="'.$colspan.'" class="maxwidthonsmartphone">';
   486|             print $form->select_country((GETPOST("country_id",'alpha')?GETPOST("country_id",'alpha'):$object->country_id),'country_id');
   487|             if ($user->admin) print info_admin($langs->trans("YouCanChangeValuesForThisListFromDictionarySetup"),1);
   488|             print '</td></tr>';
   489|             if (empty($conf->global->SOCIETE_DISABLE_STATE))
   490|             {
   491|                 print '<tr><td><label for="state_id">'.$langs->trans('State').'</label></td><td colspan="'.$colspan.'" class="maxwidthonsmartphone">';
   492|                 if ($object->country_id)
   493|                 {
   494|                     print $formcompany->select_state(GETPOST("state_id",'alpha')?GETPOST("state_id",'alpha'):$object->state_id,$object->country_code,'state_id');
   495|                 }
   496|                 else
   497|               {
   498|                     print $countrynotdefined;
   499|                 }
   500|                 print '</td></tr>';
   501|             }
   502|             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->phone_pro)) == 0) $object->phone_pro = $objsoc->phone;	// Predefined with third party
   503|             print '<tr><td><label for="phone_pro">'.$langs->trans("PhonePro").'</label></td>';
   504| 	        print '<td><input name="phone_pro" id="phone_pro" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("phone_pro")?GETPOST("phone_pro"):$object->phone_pro).'"></td>';
   505|             print '<td><label for="phone_perso">'.$langs->trans("PhonePerso").'</label></td>';
   506| 	        print '<td><input name="phone_perso" id="phone_perso" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("phone_perso")?GETPOST("phone_perso"):$object->phone_perso).'"></td></tr>';
   507|             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->fax)) == 0) $object->fax = $objsoc->fax;	// Predefined with third party
   508|             print '<tr><td><label for="phone_mobile">'.$langs->trans("PhoneMobile").'</label></td>';
   509| 	        print '<td><input name="phone_mobile" id="phone_mobile" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("phone_mobile")?GETPOST("phone_mobile"):$object->phone_mobile).'"></td>';
   510|             print '<td><label for="fax">'.$langs->trans("Fax").'</label></td>';
   511| 	        print '<td><input name="fax" id="fax" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("fax",'alpha')?GETPOST("fax",'alpha'):$object->fax).'"></td></tr>';
   512|             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->email)) == 0) $object->email = $objsoc->email;	// Predefined with third party
   513|             print '<tr><td><label for="email">'.$langs->trans("Email").'</label></td>';
   514| 	        print '<td><input name="email" id="email" type="text" class="maxwidth100onsmartphone" value="'.(GETPOST("email",'alpha')?GETPOST("email",'alpha'):$object->email).'"></td>';
   515|             if (! empty($conf->mailing->enabled))
   516|             {
   517|             	print '<td><label for="no_email">'.$langs->trans("No_Email").'</label></td>';
   518| 	            print '<td>'.$form->selectyesno('no_email',(GETPOST("no_email",'alpha')?GETPOST("no_email",'alpha'):$object->no_email), 1).'</td>';
   519|             }
   520|             else
   521| 			      {
   522|           		print '<td colspan="2">&nbsp;</td>';
   523|             }
   524|             print '</tr>';
   525|             print '<tr><td><label for="jabberid">'.$langs->trans("IM").'</label></td>';
   526| 	        print '<td colspan="3"><input name="jabberid" id="jabberid" type="text" class="minwidth100" maxlength="80" value="'.(GETPOST("jabberid",'alpha')?GETPOST("jabberid",'alpha'):$object->jabberid).'"></td></tr>';
   527|             if (! empty($conf->skype->enabled))
   528|             {
   529|                 print '<tr><td><label for="skype">'.$langs->trans("Skype").'</label></td>';
   530| 	            print '<td colspan="3"><input name="skype" id="skype" type="text" class="minwidth100" maxlength="80" value="'.(GETPOST("skype",'alpha')?GETPOST("skype",'alpha'):$object->skype).'"></td></tr>';
   531|             }
   532|             print '<tr><td><label for="priv">'.$langs->trans("ContactVisibility").'</label></td><td colspan="3">';
   533|             $selectarray=array('0'=>$langs->trans("ContactPublic"),'1'=>$langs->trans("ContactPrivate"));
   534|             print $form->selectarray('priv',$selectarray,(GETPOST("priv",'alpha')?GETPOST("priv",'alpha'):$object->priv),0);
   535|             print '</td></tr>';
   536| 			if (! empty($conf->categorie->enabled)  && ! empty($user->rights->categorie->lire)) {
   537| 				print '<tr><td>' . fieldLabel( 'Categories', 'contcats' ) . '</td><td colspan="3">';
   538| 				$cate_arbo = $form->select_all_categories( Categorie::TYPE_CONTACT, null, 'parent', null, null, 1 );
   539| 				print $form->multiselectarray( 'contcats', $cate_arbo, GETPOST( 'contcats', 'array' ), null, null, null,
   540| 					null, '90%' );
   541| 				print "</td></tr>";
   542| 			}
   543|             $parameters=array('socid' => $socid, 'objsoc' => $objsoc, 'colspan' => ' colspan="3"', 'cols' => 3);
   544|             $reshook=$hookmanager->executeHooks('formObjectOptions',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook
   545|             print $hookmanager->resPrint;
   546|             if (empty($reshook) && ! empty($extrafields->attribute_label))
   547|             {
   548|             	print $object->showOptionals($extrafields,'edit');
   549|             }
   550|             print "</table><br>";


# ====================================================================
# FILE: htdocs/contact/class/contact.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 273-312 ---
   273| 		$this->country_id=($this->country_id > 0?$this->country_id:$this->country_id);
   274| 		$this->state_id=($this->state_id > 0?$this->state_id:$this->fk_departement);
   275| 		if (empty($this->statut)) $this->statut = 0;
   276| 		$this->db->begin();
   277| 		$sql = "UPDATE ".MAIN_DB_PREFIX."socpeople SET ";
   278| 		if ($this->socid > 0) $sql .= " fk_soc='".$this->db->escape($this->socid)."',";
   279| 		else if ($this->socid == -1) $sql .= " fk_soc=null,";
   280| 		$sql .= "  civility='".$this->db->escape($this->civility_id)."'";
   281| 		$sql .= ", lastname='".$this->db->escape($this->lastname)."'";
   282| 		$sql .= ", firstname='".$this->db->escape($this->firstname)."'";
   283| 		$sql .= ", address='".$this->db->escape($this->address)."'";
   284| 		$sql .= ", zip='".$this->db->escape($this->zip)."'";
   285| 		$sql .= ", town='".$this->db->escape($this->town)."'";
   286| 		$sql .= ", fk_pays=".($this->country_id>0?$this->country_id:'NULL');
   287| 		$sql .= ", fk_departement=".($this->state_id>0?$this->state_id:'NULL');
   288| 		$sql .= ", poste='".$this->db->escape($this->poste)."'";
   289| 		$sql .= ", fax='".$this->db->escape($this->fax)."'";
   290| 		$sql .= ", email='".$this->db->escape($this->email)."'";
   291| 		$sql .= ", skype='".$this->db->escape($this->skype)."'";
   292| 		$sql .= ", photo='".$this->db->escape($this->photo)."'";
   293| 		$sql .= ", note_private = ".(isset($this->note_private)?"'".$this->db->escape($this->note_private)."'":"null");
   294| 		$sql .= ", note_public = ".(isset($this->note_public)?"'".$this->db->escape($this->note_public)."'":"null");
   295| 		$sql .= ", phone = ".(isset($this->phone_pro)?"'".$this->db->escape($this->phone_pro)."'":"null");
   296| 		$sql .= ", phone_perso = ".(isset($this->phone_perso)?"'".$this->db->escape($this->phone_perso)."'":"null");
   297| 		$sql .= ", phone_mobile = ".(isset($this->phone_mobile)?"'".$this->db->escape($this->phone_mobile)."'":"null");
   298| 		$sql .= ", jabberid = ".(isset($this->jabberid)?"'".$this->db->escape($this->jabberid)."'":"null");
   299| 		$sql .= ", priv = '".$this->db->escape($this->priv)."'";
   300| 		$sql .= ", statut = ".$this->statut;
   301| 		$sql .= ", fk_user_modif=".($user->id > 0 ? "'".$this->db->escape($user->id)."'":"NULL");
   302| 		$sql .= ", default_lang=".($this->default_lang?"'".$this->db->escape($this->default_lang)."'":"NULL");
   303| 		$sql .= ", no_email=".($this->no_email?"'".$this->db->escape($this->no_email)."'":"0");
   304| 		$sql .= " WHERE rowid=".$this->db->escape($id);
   305| 		dol_syslog(get_class($this)."::update", LOG_DEBUG);
   306| 		$result = $this->db->query($sql);
   307| 		if ($result)
   308| 		{
   309| 		    unset($this->country_code);
   310| 		    unset($this->country);
   311| 		    unset($this->state_code);
   312| 		    unset($this->state);

# --- HUNK 2: Lines 484-525 ---
   484| 	 *
   485| 	 *  @param      int			$id         Id of contact
   486| 	 *  @param      User		$user		User asking to change alert or birthday
   487| 	 *  @param      int		    $notrigger	0=no, 1=yes
   488|      *  @return     int         			<0 if KO, >=0 if OK
   489| 	 */
   490| 	function update_perso($id, $user=null, $notrigger=0)
   491| 	{
   492| 	    $error=0;
   493| 	    $result=false;
   494| 	    $this->db->begin();
   495| 		$sql = "UPDATE ".MAIN_DB_PREFIX."socpeople SET";
   496| 		$sql.= " birthday=".($this->birthday ? "'".$this->db->idate($this->birthday)."'" : "null");
   497| 		$sql.= ", photo = ".($this->photo? "'".$this->db->escape($this->photo)."'" : "null");
   498| 		if ($user) $sql .= ", fk_user_modif=".$user->id;
   499| 		$sql.= " WHERE rowid=".$this->db->escape($id);
   500| 		dol_syslog(get_class($this)."::update_perso this->birthday=".$this->birthday." -", LOG_DEBUG);
   501| 		$resql = $this->db->query($sql);
   502| 		if (! $resql)
   503| 		{
   504|             $error++;
   505| 		    $this->error=$this->db->lasterror();
   506| 		}
   507| 		if ($this->birthday_alert)
   508| 		{
   509| 			$sql_check = "SELECT * FROM ".MAIN_DB_PREFIX."user_alert WHERE type=1 AND fk_contact=".$this->db->escape($id)." AND fk_user=".$user->id;
   510| 			$result_check = $this->db->query($sql_check);
   511| 			if (! $result_check || ($this->db->num_rows($result_check)<1))
   512| 			{
   513| 				$sql = "INSERT INTO ".MAIN_DB_PREFIX."user_alert(type,fk_contact,fk_user) ";
   514| 				$sql.= "VALUES (1,".$this->db->escape($id).",".$user->id.")";
   515| 				$result = $this->db->query($sql);
   516| 				if (! $result)
   517| 				{
   518|                     $error++;
   519|                     $this->error=$this->db->lasterror();
   520| 				}
   521| 			}
   522| 			else
   523| 			{
   524| 				$result = true;
   525| 			}


# ====================================================================
# FILE: htdocs/contact/list.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /* Copyright (C) 2001-2004  Rodolphe Quiedeville    <rodolphe@quiedeville.org>
     3|  * Copyright (C) 2003       Eric Seigne             <erics@rycks.com>
     4|  * Copyright (C) 2004-2012  Laurent Destailleur     <eldy@users.sourceforge.net>
     5|  * Copyright (C) 2005-2012  Regis Houssin           <regis.houssin@capnetworks.com>
     6|  * Copyright (C) 2013-2015  Raphal Doursenaud      <rdoursenaud@gpcsolutions.fr>
     7|  * Copyright (C) 2013       Cdric Salvador         <csalvador@gpcsolutions.fr>
     8|  * Copyright (C) 2013       Alexandre Spangaro      <aspangaro.dolibarr@gmail.com>
     9|  * Copyright (C) 2015       Jean-Franois Ferry     <jfefe@aternatik.fr>
    10|  *
    11|  * This program is free software; you can redistribute it and/or modify
    12|  * it under the terms of the GNU General Public License as published by
    13|  * the Free Software Foundation; either version 3 of the License, or
    14|  * (at your option) any later version.
    15|  *
    16|  * This program is distributed in the hope that it will be useful,
    17|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    18|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    19|  * GNU General Public License for more details.
    20|  *
    21|  * You should have received a copy of the GNU General Public License
    22|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    23|  */
    24| /**
    25|  *	    \file       htdocs/contact/list.php
    26|  *      \ingroup    societe
    27|  *		\brief      Page to list all contacts
    28|  */
    29| require '../main.inc.php';

# --- HUNK 2: Lines 236-275 ---
   236| if ($search_categ == -2) $sql.= " AND cc.fk_categorie IS NULL";
   237| if ($search_categ_thirdparty > 0)   $sql.= " AND cs.fk_categorie = ".$db->escape($search_categ_thirdparty);
   238| if ($search_categ_thirdparty == -2) $sql.= " AND cs.fk_categorie IS NULL";
   239| if ($search_categ_supplier > 0)     $sql.= " AND cs2.fk_categorie = ".$db->escape($search_categ_supplier);
   240| if ($search_categ_supplier == -2)   $sql.= " AND cs2.fk_categorie IS NULL";
   241| if ($sall)                          $sql.= natural_search(array_keys($fieldstosearchall), $sall);
   242| if (strlen($search_phone))          $sql.= natural_search(array('p.phone', 'p.phone_perso', 'p.phone_mobile'), $search_phone);
   243| if (strlen($search_cti))            $sql.= natural_search(array('p.phone', 'p.phone_perso', 'p.phone_mobile'), $search_cti);
   244| if (strlen($search_firstlast_only)) $sql.= natural_search(array('p.lastname', 'p.firstname'), $search_firstlast_only);
   245| if ($search_id > 0)                 $sql.= natural_search("p.rowid",$search_id,1);
   246| if ($search_lastname)               $sql.= natural_search('p.lastname', $search_lastname);
   247| if ($search_firstname)              $sql.= natural_search('p.firstname', $search_firstname);
   248| if ($search_societe)                $sql.= natural_search('s.nom', $search_societe);
   249| if (strlen($search_poste))          $sql.= natural_search('p.poste', $search_poste);
   250| if (strlen($search_phone_perso))    $sql.= natural_search('p.phone_perso', $search_phone_perso);
   251| if (strlen($search_phone_pro))      $sql.= natural_search('p.phone', $search_phone);
   252| if (strlen($search_phone_mobile))   $sql.= natural_search('p.phone_mobile', $search_phone_mobile);
   253| if (strlen($search_fax))            $sql.= natural_search('p.fax', $search_fax);
   254| if (strlen($search_skype))          $sql.= natural_search('p.skype', $search_skype);
   255| if (strlen($search_email))          $sql.= natural_search('p.email', $search_email);
   256| if ($search_status != '' && $search_status >= 0) $sql.= " AND p.statut = ".$db->escape($search_status);
   257| if ($search_import_key)             $sql.= natural_search("p.import_key",$search_import_key);
   258| if ($type == "o")        // filtre sur type
   259| {
   260| 	$sql .= " AND p.fk_soc IS NULL";
   261| }
   262| else if ($type == "f")        // filtre sur type
   263| {
   264| 	$sql .= " AND s.fournisseur = 1";
   265| }
   266| else if ($type == "c")        // filtre sur type
   267| {
   268| 	$sql .= " AND s.client IN (1, 3)";
   269| }
   270| else if ($type == "p")        // filtre sur type
   271| {
   272| 	$sql .= " AND s.client IN (2, 3)";
   273| }
   274| if (! empty($socid))
   275| {


# ====================================================================
# FILE: htdocs/contrat/class/contrat.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 183-236 ---
   183| 		}
   184| 		else
   185| 		{
   186| 			$langs->load("errors");
   187| 			print $langs->trans("Error")." ".$langs->trans("ErrorModuleSetupNotComplete");
   188| 			return "";
   189| 		}
   190| 	}
   191| 	/**
   192| 	 *  Activate a contract line
   193| 	 *
   194| 	 *  @param	User		$user       Objet User who activate contract
   195| 	 *  @param  int			$line_id    Id of line to activate
   196| 	 *  @param  int			$date       Date d'ouverture
   197| 	 *  @param  int|string	$date_end   Date fin prevue
   198| 	 * 	@param	string		$comment	A comment typed by user
   199| 	 *  @return int         			<0 if KO, >0 if OK
   200| 	 */
   201| 	function active_line($user, $line_id, $date, $date_end='', $comment='')
   202| 	{
   203| 		return $this->lines[$this->lines_id_index_mapper[$line_id]]->active_line($user, $date, $date_end, $comment);
   204| 	}
   205| 	/**
   206| 	 *  Close a contract line
   207| 	 *
   208| 	 *  @param	User		$user       Objet User who close contract
   209| 	 *  @param  int			$line_id    Id of line to close
   210| 	 *  @param  int			$date_end	Date end
   211| 	 * 	@param	string		$comment	A comment typed by user
   212| 	 *  @return int         			<0 if KO, >0 if OK
   213| 	 */
   214| 	function close_line($user, $line_id, $date_end, $comment='')
   215| 	{
   216| 		return $this->lines[$this->lines_id_index_mapper[$line_id]]->close_line($user, $date_end, $comment);
   217| 	}
   218| 	/**
   219| 	 *  Open all lines of a contract
   220| 	 *
   221| 	 *  @param	User		$user      		Object User making action
   222| 	 *  @param	int|string	$date_start		Date start (now if empty)
   223|      *  @param	int			$notrigger		1=Does not execute triggers, 0=Execute triggers
   224|      *  @param	string		$comment		Comment
   225| 	 *	@return	int							<0 if KO, >0 if OK
   226| 	 */
   227| 	function activateAll($user, $date_start='', $notrigger=0, $comment='')
   228| 	{
   229| 		if (empty($date_start)) $date_start = dol_now();
   230| 		$this->db->begin();
   231| 		$this->fetch_lines();
   232| 		$ok=true;
   233| 		foreach($this->lines as $contratline)
   234| 		{
   235| 			if ($contratline->statut != 4)
   236| 			{


# ====================================================================
# FILE: htdocs/core/actions_addupdatedelete.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 16-107 ---
    16|  * or see http://www.gnu.org/
    17|  */
    18| /**
    19|  *	\file			htdocs/core/actions_addupdatedelete.inc.php
    20|  *  \brief			Code for common actions cancel / add / update / delete
    21|  */
    22| if ($cancel)
    23| {
    24| 	if (! empty($backtopage))
    25| 	{
    26| 		header("Location: ".$backtopage);
    27| 		exit;
    28| 	}
    29| 	$action='';
    30| }
    31| if ($action == 'add' && ! empty($permissiontoadd))
    32| {
    33| 	foreach ($object->fields as $key => $val)
    34| 	{
    35| 		if (in_array($key, array('rowid', 'entity', 'date_creation', 'tms', 'fk_user_creat', 'fk_user_modif', 'import_key'))) continue;	// Ignore special fields
    36| 		if (in_array($object->fields[$key]['type'], array('text', 'html'))) $value = GETPOST($key,'none');
    37| 		else $value = GETPOST($key,'alpha');
    38| 		if (preg_match('/^integer:/i', $object->fields[$key]['type']) && $value == '-1') $value='';		// This is an implicit foreign key field
    39| 		if (! empty($object->fields[$key]['foreignkey']) && $value == '-1') $value='';					// This is an explicit foreign key field
    40| 		$object->$key=$value;
    41| 		if ($val['notnull'] > 0 && $object->$key == '')
    42| 		{
    43| 			$error++;
    44| 			setEventMessages($langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv($val['label'])), null, 'errors');
    45| 		}
    46| 	}
    47| 	if (! $error)
    48| 	{
    49| 		$result=$object->createCommon($user);
    50| 		if ($result > 0)
    51| 		{
    52| 			$urltogo=$backtopage?$backtopage:$backurlforlist;
    53| 			header("Location: ".$urltogo);
    54| 			exit;
    55| 		}
    56| 		else
    57| 		{
    58| 			if (! empty($object->errors)) setEventMessages(null, $object->errors, 'errors');
    59| 			else  setEventMessages($object->error, null, 'errors');
    60| 			$action='create';
    61| 		}
    62| 	}
    63| 	else
    64| 	{
    65| 		$action='create';
    66| 	}
    67| }
    68| if ($action == 'update' && ! empty($permissiontoadd))
    69| {
    70| 	foreach ($object->fields as $key => $val)
    71| 	{
    72| 		if (! GETPOSTISSET($key)) continue;		// The field was not submited to be edited
    73| 		if (in_array($key, array('rowid', 'entity', 'date_creation', 'tms', 'fk_user_creat', 'fk_user_modif', 'import_key'))) continue;	// Ignore special fields
    74| 		if (in_array($object->fields[$key]['type'], array('text', 'html'))) {
    75| 			$value = GETPOST($key,'none');
    76| 		}
    77| 		elseif ($object->fields[$key]['type']=='date') {
    78| 			$value = dol_mktime(12, 0, 0, GETPOST($key.'month'), GETPOST($key.'day'), GETPOST($key.'year'));
    79| 		} elseif ($object->fields[$key]['type']=='datetime') {
    80| 			$value = dol_mktime(GETPOST($key.'hour'), GETPOST($key.'min'), 0, GETPOST($key.'month'), GETPOST($key.'day'), GETPOST($key.'year'));
    81| 		} else {
    82| 			$value = GETPOST($key,'alpha');
    83| 		}
    84| 		if (preg_match('/^integer:/i', $object->fields[$key]['type']) && $value == '-1') $value='';		// This is an implicit foreign key field
    85| 		if (! empty($object->fields[$key]['foreignkey']) && $value == '-1') $value='';					// This is an explicit foreign key field
    86| 		$object->$key=$value;
    87| 		if ($val['notnull'] > 0 && $object->$key == '')
    88| 		{
    89| 			$error++;
    90| 			setEventMessages($langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv($val['label'])), null, 'errors');
    91| 		}
    92| 	}
    93| 	if (! $error)
    94| 	{
    95| 		$result=$object->updateCommon($user);
    96| 		if ($result > 0)
    97| 		{
    98| 			$action='view';
    99| 		}
   100| 		else
   101| 		{
   102| 			if (! empty($object->errors)) setEventMessages(null, $object->errors, 'errors');
   103| 			else setEventMessages($object->error, null, 'errors');
   104| 			$action='edit';
   105| 		}
   106| 	}
   107| 	else


# ====================================================================
# FILE: htdocs/core/actions_linkedfiles.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| <?php
     2| /* Copyright (C)    2013    Cdric Salvador    <csalvador@gpcsolutions.fr>
     3|  * Copyright (C)    2015    Marcos Garca      <marcosgdf@gmail.com>
     4|  * Copyright (C)    2015    Ferran Marcet      <fmarcet@2byte.es>
     5|  *
     6|  * This program is free software; you can redistribute it and/or modify
     7|  * it under the terms of the GNU General Public License as published by
     8|  * the Free Software Foundation; either version 3 of the License, or
     9|  * (at your option) any later version.
    10|  *
    11|  * This program is distributed in the hope that it will be useful,
    12|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    18|  * or see http://www.gnu.org/
    19|  */
    20| if (GETPOST('sendit','none') && ! empty($conf->global->MAIN_UPLOAD_DOC))
    21| {
    22| 	if (! empty($_FILES))
    23| 	{
    24| 		if (is_array($_FILES['userfile']['tmp_name'])) $userfiles=$_FILES['userfile']['tmp_name'];
    25| 		else $userfiles=array($_FILES['userfile']['tmp_name']);
    26| 		foreach($userfiles as $key => $userfile)
    27| 		{
    28| 			if (empty($_FILES['userfile']['tmp_name'][$key]))
    29| 			{
    30| 				$error++;
    31| 				if ($_FILES['userfile']['error'][$key] == 1 || $_FILES['userfile']['error'][$key] == 2){
    32| 					setEventMessages($langs->trans('ErrorFileSizeTooLarge'), null, 'errors');
    33| 				}
    34| 				else {
    35| 					setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("File")), null, 'errors');
    36| 				}
    37| 			}
    38| 		}
    39| 		if (! $error)
    40| 		{


# ====================================================================
# FILE: htdocs/core/actions_sendmails.inc.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 287-327 ---
   287| 						}
   288| 					}
   289| 				}
   290| 			}
   291| 			$substitutionarray=getCommonSubstitutionArray($langs, 0, null, $object);
   292| 			$substitutionarray['__EMAIL__'] = $sendto;
   293| 			$substitutionarray['__CHECK_READ__'] = (is_object($object) && is_object($object->thirdparty))?'<img src="'.DOL_MAIN_URL_ROOT.'/public/emailing/mailing-read.php?tag='.$object->thirdparty->tag.'&securitykey='.urlencode($conf->global->MAILING_EMAIL_UNSUBSCRIBE_KEY).'" width="1" height="1" style="width:1px;height:1px" border="0"/>':'';
   294| 			$parameters=array('mode'=>'formemail');
   295| 			complete_substitutions_array($substitutionarray, $langs, $object, $parameters);
   296| 			$subject=make_substitutions($subject, $substitutionarray);
   297| 			$message=make_substitutions($message, $substitutionarray);
   298| 			if (method_exists($object, 'makeSubstitution'))
   299| 			{
   300| 				$subject = $object->makeSubstitution($subject);
   301| 				$message = $object->makeSubstitution($message);
   302| 			}
   303| 			if (empty($sendcontext)) $sendcontext = 'standard';
   304| 			$mailfile = new CMailFile($subject,$sendto,$from,$message,$filepath,$mimetype,$filename,$sendtocc,$sendtobcc,$deliveryreceipt,-1,'','',$trackid,'', $sendcontext);
   305| 			if ($mailfile->error)
   306| 			{
   307| 				setEventMessage($mailfile->error, 'errors');
   308| 				$action='presend';
   309| 			}
   310| 			else
   311| 			{
   312| 				$result=$mailfile->sendfile();
   313| 				if ($result)
   314| 				{
   315| 					if (! empty($conf->dolimail->enabled))
   316| 					{
   317| 						$mid = (GETPOST('mid','int') ? GETPOST('mid','int') : 0);	// Original mail id is set ?
   318| 						if ($mid)
   319| 						{
   320| 							$dolimail=new DoliMail($db);
   321| 							$dolimail->id = $mid;
   322| 							$res=$dolimail->set_prop($user, 'answered',1);
   323| 						}
   324| 						if ($imap==1)
   325| 						{
   326| 							$movemail = $mailboxconfig->putMail($subject,$sendto,$from,$message,$filepath,$mimetype,$filename,$sendtocc,$folder,$deliveryreceipt,$mailfile);
   327| 							if ($movemail) setEventMessages($langs->trans("MailMovedToImapFolder",$folder), null, 'mesgs');


# ====================================================================
# FILE: htdocs/core/boxes/box_supplier_orders.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 52-116 ---
    52|      *  Load data into info_box_contents array to show array later.
    53|      *
    54|      *  @param	int		$max        Maximum number of records to load
    55|      *  @return	void
    56|      */
    57|     function loadBox($max = 5)
    58|     {
    59|         global $conf, $user, $langs, $db;
    60|         $langs->load("boxes");
    61|         $this->max = $max;
    62|         include_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.commande.class.php';
    63|         $supplierorderstatic=new CommandeFournisseur($db);
    64|         include_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.class.php';
    65|         $thirdpartytmp = new Fournisseur($db);
    66|         $this->info_box_head = array('text' => $langs->trans("BoxTitleLatest".($conf->global->MAIN_LASTBOX_ON_OBJECT_DATE?"":"Modified")."SupplierOrders", $max));
    67|         if ($user->rights->fournisseur->commande->lire)
    68|         {
    69|             $sql = "SELECT s.nom as name, s.rowid as socid,";
    70|             $sql.= " s.code_client, s.code_fournisseur,";
    71|             $sql.= " s.logo,";
    72|             $sql.= " c.ref, c.tms, c.rowid, c.date_commande,";
    73|             $sql.= " c.total_ht,";
    74|             $sql.= " c.tva as total_tva,";
    75|             $sql.= " c.total_ttc,";
    76|             $sql.= " c.fk_statut";
    77|             $sql.= " FROM ".MAIN_DB_PREFIX."societe as s";
    78|             $sql.= ", ".MAIN_DB_PREFIX."commande_fournisseur as c";
    79|             if (!$user->rights->societe->client->voir && !$user->societe_id) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
    80|             $sql.= " WHERE c.fk_soc = s.rowid";
    81|             $sql.= " AND c.entity = ".$conf->entity;
    82|             if (!$user->rights->societe->client->voir && !$user->societe_id) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
    83|             if ($user->societe_id) $sql.= " AND s.rowid = ".$user->societe_id;
    84|             if ($conf->global->MAIN_LASTBOX_ON_OBJECT_DATE) $sql.= " ORDER BY c.date_commande DESC, c.ref DESC ";
    85|             else $sql.= " ORDER BY c.tms DESC, c.ref DESC ";
    86|             $sql.= $db->plimit($max, 0);
    87|             $result = $db->query($sql);
    88|             if ($result)
    89|             {
    90|                 $num = $db->num_rows($result);
    91|                 $line = 0;
    92|                 while ($line < $num) {
    93|                     $objp = $db->fetch_object($result);
    94|                     $date=$db->jdate($objp->date_commande);
    95| 					$datem=$db->jdate($objp->tms);
    96| 					$supplierorderstatic->id = $objp->id;
    97| 					$supplierorderstatic->ref = $objp->ref;
    98| 					$thirdpartytmp->id = $objp->socid;
    99|                     $thirdpartytmp->name = $objp->name;
   100|                     $thirdpartytmp->fournisseur = 1;
   101|                     $thirdpartytmp->code_fournisseur = $objp->code_fournisseur;
   102|                     $thirdpartytmp->logo = $objp->logo;
   103|                     $this->info_box_contents[$line][] = array(
   104|                         'td' => '',
   105|                         'text' => $supplierorderstatic->getNomUrl(1),
   106|                     	'asis' => 1
   107|                     );
   108|                     $this->info_box_contents[$line][] = array(
   109|                         'td' => '',
   110|                         'text' => $thirdpartytmp->getNomUrl(1, 'supplier'),
   111|                         'asis' => 1,
   112|                     );
   113|                     $this->info_box_contents[$line][] = array(
   114|                         'td' => 'class="right"',
   115|                         'text' => price($objp->total_ht, 0, $langs, 0, -1, -1, $conf->currency),
   116|                     );


# ====================================================================
# FILE: htdocs/core/class/CMailFile.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 840-880 ---
   840| 	function write_files($filename_list,$mimetype_list,$mimefilename_list)
   841| 	{
   842| 		$out = '';
   843| 		$filename_list_size=count($filename_list);
   844| 		for($i=0;$i < $filename_list_size;$i++)
   845| 		{
   846| 			if ($filename_list[$i])
   847| 			{
   848| 				dol_syslog("CMailFile::write_files: i=$i");
   849| 				$encoded = $this->_encode_file($filename_list[$i]);
   850| 				if ($encoded >= 0)
   851| 				{
   852| 					if ($mimefilename_list[$i]) $filename_list[$i] = $mimefilename_list[$i];
   853| 					if (! $mimetype_list[$i]) {
   854| 						$mimetype_list[$i] = "application/octet-stream";
   855| 					}
   856| 					$out.= "--" . $this->mixed_boundary . $this->eol;
   857| 					$out.= "Content-Disposition: attachment; filename=\"".$filename_list[$i]."\"".$this->eol;
   858| 					$out.= "Content-Type: " . $mimetype_list[$i] . "; name=\"".$filename_list[$i]."\"".$this->eol;
   859| 					$out.= "Content-Transfer-Encoding: base64".$this->eol;
   860| 					$out.= "Content-Description: File Attachment".$this->eol;
   861| 					$out.= $this->eol;
   862| 					$out.= $encoded;
   863| 					$out.= $this->eol;
   864| 				}
   865| 				else
   866| 				{
   867| 					return $encoded;
   868| 				}
   869| 			}
   870| 		}
   871| 		return $out;
   872| 	}
   873| 	/**
   874| 	 * Attach an image to email (mode = 'mail')
   875| 	 *
   876| 	 * @param	array	$images_list	Tableau
   877| 	 * @return	string					Chaine images encodees
   878| 	 */
   879| 	function write_images($images_list)
   880| 	{


# ====================================================================
# FILE: htdocs/core/class/commondocgenerator.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 310-350 ---
   310| 		$resarray=array(
   311| 		$array_key.'_id'=>$object->id,
   312| 		$array_key.'_ref'=>$object->ref,
   313| 		$array_key.'_ref_ext'=>$object->ref_ext,
   314| 		$array_key.'_ref_customer'=>$object->ref_client,
   315| 		$array_key.'_ref_supplier'=>(! empty($object->ref_fournisseur)?$object->ref_fournisseur:''),
   316| 		$array_key.'_source_invoice_ref'=>$invoice_source->ref,
   317|         $array_key.'_hour'=>dol_print_date($object->date,'hour'),
   318| 		$array_key.'_date'=>dol_print_date($object->date,'day'),
   319| 		$array_key.'_date_rfc'=>dol_print_date($object->date,'dayrfc'),
   320| 		$array_key.'_date_limit'=>(! empty($object->date_lim_reglement)?dol_print_date($object->date_lim_reglement,'day'):''),
   321| 	    $array_key.'_date_end'=>(! empty($object->fin_validite)?dol_print_date($object->fin_validite,'day'):''),
   322| 		$array_key.'_date_creation'=>dol_print_date($object->date_creation,'day'),
   323| 		$array_key.'_date_modification'=>(! empty($object->date_modification)?dol_print_date($object->date_modification,'day'):''),
   324| 		$array_key.'_date_validation'=>(! empty($object->date_validation)?dol_print_date($object->date_validation,'dayhour'):''),
   325| 		$array_key.'_date_delivery_planed'=>(! empty($object->date_livraison)?dol_print_date($object->date_livraison,'day'):''),
   326| 		$array_key.'_date_close'=>(! empty($object->date_cloture)?dol_print_date($object->date_cloture,'dayhour'):''),
   327| 		$array_key.'_payment_mode_code'=>$object->mode_reglement_code,
   328| 		$array_key.'_payment_mode'=>($outputlangs->transnoentitiesnoconv('PaymentType'.$object->mode_reglement_code)!='PaymentType'.$object->mode_reglement_code?$outputlangs->transnoentitiesnoconv('PaymentType'.$object->mode_reglement_code):$object->mode_reglement),
   329| 		$array_key.'_payment_term_code'=>$object->cond_reglement_code,
   330| 		$array_key.'_payment_term'=>($outputlangs->transnoentitiesnoconv('PaymentCondition'.$object->cond_reglement_code)!='PaymentCondition'.$object->cond_reglement_code?$outputlangs->transnoentitiesnoconv('PaymentCondition'.$object->cond_reglement_code):$object->cond_reglement),
   331| 		$array_key.'_total_ht_locale'=>price($object->total_ht, 0, $outputlangs),
   332| 		$array_key.'_total_vat_locale'=>(! empty($object->total_vat)?price($object->total_vat, 0, $outputlangs):price($object->total_tva, 0, $outputlangs)),
   333| 		$array_key.'_total_localtax1_locale'=>price($object->total_localtax1, 0, $outputlangs),
   334| 		$array_key.'_total_localtax2_locale'=>price($object->total_localtax2, 0, $outputlangs),
   335| 		$array_key.'_total_ttc_locale'=>price($object->total_ttc, 0, $outputlangs),
   336| 		$array_key.'_total_ht'=>price2num($object->total_ht),
   337| 		$array_key.'_total_vat'=>(! empty($object->total_vat)?price2num($object->total_vat):price2num($object->total_tva)),
   338| 		$array_key.'_total_localtax1'=>price2num($object->total_localtax1),
   339| 		$array_key.'_total_localtax2'=>price2num($object->total_localtax2),
   340| 		$array_key.'_total_ttc'=>price2num($object->total_ttc),
   341| 		$array_key.'_multicurrency_code' => price2num($object->multicurrency_code),
   342| 		$array_key.'_multicurrency_tx' => price2num($object->multicurrency_tx),
   343| 	    $array_key.'_multicurrency_total_ht' => price2num($object->multicurrency_total_ht),
   344| 	    $array_key.'_multicurrency_total_tva' => price2num($object->multicurrency_total_tva),
   345| 		$array_key.'_multicurrency_total_ttc' => price2num($object->multicurrency_total_ttc),
   346| 		$array_key.'_multicurrency_total_ht_locale' => price($object->multicurrency_total_ht, 0, $outputlangs),
   347| 		$array_key.'_multicurrency_total_tva_locale' => price($object->multicurrency_total_tva, 0, $outputlangs),
   348| 		$array_key.'_multicurrency_total_ttc_locale' => price($object->multicurrency_total_ttc, 0, $outputlangs),
   349| 		$array_key.'_note_private'=>$object->note,
   350| 		$array_key.'_note_public'=>$object->note_public,


# ====================================================================
# FILE: htdocs/core/class/commonobject.class.php
# Total hunks: 13
# ====================================================================
# --- HUNK 1: Lines 1166-1214 ---
  1166| 	 *	Setter generic. Update a specific field into database.
  1167| 	 *  Warning: Trigger is run only if param trigkey is provided.
  1168| 	 *
  1169| 	 *	@param	string		$field		Field to update
  1170| 	 *	@param	mixed		$value		New value
  1171| 	 *	@param	string		$table		To force other table element or element line (should not be used)
  1172| 	 *	@param	int			$id			To force other object id (should not be used)
  1173| 	 *	@param	string		$format		Data format ('text', 'date'). 'text' is used if not defined
  1174| 	 *	@param	string		$id_field	To force rowid field name. 'rowid' is used if not defined
  1175| 	 *	@param	User|string	$fuser		Update the user of last update field with this user. If not provided, current user is used except if value is 'none'
  1176| 	 *  @param  string      $trigkey    Trigger key to run (in most cases something like 'XXX_MODIFY')
  1177| 	 *	@return	int						<0 if KO, >0 if OK
  1178| 	 */
  1179| 	function setValueFrom($field, $value, $table='', $id=null, $format='', $id_field='', $fuser=null, $trigkey='')
  1180| 	{
  1181| 		global $user,$langs,$conf;
  1182| 		if (empty($table)) 	  $table=$this->table_element;
  1183| 		if (empty($id))    	  $id=$this->id;
  1184| 		if (empty($format))   $format='text';
  1185| 		if (empty($id_field)) $id_field='rowid';
  1186| 		$error=0;
  1187| 		$this->db->begin();
  1188| 		if ($table == 'product' && $field == 'note_private') $field='note';
  1189| 		$sql = "UPDATE ".MAIN_DB_PREFIX.$table." SET ";
  1190| 		if ($format == 'text') $sql.= $field." = '".$this->db->escape($value)."'";
  1191| 		else if ($format == 'int') $sql.= $field." = ".$this->db->escape($value);
  1192| 		else if ($format == 'date') $sql.= $field." = ".($value ? "'".$this->db->idate($value)."'" : "null");
  1193| 		if (! empty($fuser) && is_object($fuser)) $sql.=", fk_user_modif = ".$fuser->id;
  1194| 		elseif (empty($fuser) || $fuser != 'none') $sql.=", fk_user_modif = ".$user->id;
  1195| 		$sql.= " WHERE ".$id_field." = ".$id;
  1196| 		dol_syslog(get_class($this)."::".__FUNCTION__."", LOG_DEBUG);
  1197| 		$resql = $this->db->query($sql);
  1198| 		if ($resql)
  1199| 		{
  1200| 			if ($trigkey)
  1201| 			{
  1202| 				$result=$this->call_trigger($trigkey, (! empty($fuser) && is_object($fuser)) ? $fuser : $user);   // This may set this->errors
  1203| 				if ($result < 0) $error++;
  1204| 			}
  1205| 			if (! $error)
  1206| 			{
  1207| 				if (property_exists($this, $field)) $this->$field = $value;
  1208| 				$this->db->commit();
  1209| 				return 1;
  1210| 			}
  1211| 			else
  1212| 			{
  1213| 				$this->db->rollback();
  1214| 				return -2;

# --- HUNK 2: Lines 1994-2038 ---
  1994| 			return 1;
  1995| 		}
  1996| 		else
  1997| 		{
  1998| 			$this->error=$this->db->error();
  1999| 			return -1;
  2000| 		}
  2001| 	}
  2002| 	/**
  2003| 	 *  Update note of element
  2004| 	 *
  2005| 	 *  @param      string		$note		New value for note
  2006| 	 *  @param		string		$suffix		'', '_public' or '_private'
  2007| 	 *  @return     int      		   		<0 if KO, >0 if OK
  2008| 	 */
  2009| 	function update_note($note,$suffix='')
  2010| 	{
  2011| 		global $user;
  2012| 		if (! $this->table_element)
  2013| 		{
  2014| 			dol_syslog(get_class($this)."::update_note was called on objet with property table_element not defined", LOG_ERR);
  2015| 			return -1;
  2016| 		}
  2017| 		if (! in_array($suffix,array('','_public','_private')))
  2018| 		{
  2019| 			dol_syslog(get_class($this)."::update_note Parameter suffix must be empty, '_private' or '_public'", LOG_ERR);
  2020| 			return -2;
  2021| 		}
  2022| 		if ($this->table_element == 'product') $suffix='';
  2023| 		$sql = 'UPDATE '.MAIN_DB_PREFIX.$this->table_element;
  2024| 		$sql.= " SET note".$suffix." = ".(!empty($note)?("'".$this->db->escape($note)."'"):"NULL");
  2025| 		$sql.= " ,".(in_array($this->table_element, array('actioncomm', 'adherent', 'advtargetemailing', 'cronjob', 'establishment'))?"fk_user_mod":"fk_user_modif")." = ".$user->id;
  2026| 		$sql.= " WHERE rowid =". $this->id;
  2027| 		dol_syslog(get_class($this)."::update_note", LOG_DEBUG);
  2028| 		if ($this->db->query($sql))
  2029| 		{
  2030| 			if ($suffix == '_public') $this->note_public = $note;
  2031| 			else if ($suffix == '_private') $this->note_private = $note;
  2032| 			else
  2033| 			{
  2034| 				$this->note = $note;      // deprecated
  2035| 				$this->note_private = $note;
  2036| 			}
  2037| 			return 1;
  2038| 		}

# --- HUNK 3: Lines 3899-3938 ---
  3899| 			   				return -1;
  3900| 			  			}
  3901| 			   			elseif ($value=='')
  3902| 			   			{
  3903| 			   				$new_array_options[$key] = null;
  3904| 			   			}
  3905| 			 			break;
  3906| 			 		/*case 'select':	// Not required, we chosed value='0' for undefined values
  3907|              			if ($value=='-1')
  3908|              			{
  3909|              				$this->array_options[$key] = null;
  3910|              			}
  3911|              			break;*/
  3912| 					case 'price':
  3913| 						$new_array_options[$key] = price2num($this->array_options[$key]);
  3914| 						break;
  3915| 					case 'date':
  3916| 						$new_array_options[$key] = $this->db->idate($this->array_options[$key]);
  3917| 						break;
  3918| 					case 'datetime':
  3919| 						$new_array_options[$key] = $this->db->idate($this->array_options[$key]);
  3920| 						break;
  3921| 		   			case 'link':
  3922| 						$param_list=array_keys($attributeParam['options']);
  3923| 						$InfoFieldList = explode(":", $param_list[0]);
  3924| 						dol_include_once($InfoFieldList[1]);
  3925| 						if ($InfoFieldList[0] && class_exists($InfoFieldList[0]))
  3926| 						{
  3927| 							if ($value == '-1')	// -1 is key for no defined in combo list of objects
  3928| 							{
  3929| 								$new_array_options[$key]='';
  3930| 							}
  3931| 							elseif ($value)
  3932| 							{
  3933| 								$object = new $InfoFieldList[0]($this->db);
  3934| 								if (is_numeric($value)) $res=$object->fetch($value);
  3935| 								else $res=$object->fetch('',$value);
  3936| 								if ($res > 0) $new_array_options[$key]=$object->id;
  3937| 								else
  3938| 								{

# --- HUNK 4: Lines 4061-4100 ---
  4061| 					break;
  4062| 				case 'link':
  4063| 					$param_list=array_keys($attributeParam ['options']);
  4064| 					$InfoFieldList = explode(":", $param_list[0]);
  4065| 					dol_include_once($InfoFieldList[1]);
  4066| 					if ($value)
  4067| 					{
  4068| 						$object = new $InfoFieldList[0]($this->db);
  4069| 						$object->fetch(0,$value);
  4070| 						$this->array_options["options_".$key]=$object->id;
  4071| 					}
  4072| 					break;
  4073| 			}
  4074| 			$this->db->begin();
  4075| 			$sql = "UPDATE ".MAIN_DB_PREFIX.$this->table_element."_extrafields SET ".$key."='".$this->db->escape($this->array_options["options_".$key])."'";
  4076| 			$sql .= " WHERE fk_object = ".$this->id;
  4077| 			$resql = $this->db->query($sql);
  4078| 			if (! $resql)
  4079| 			{
  4080| 				$this->error=$this->db->lasterror();
  4081| 				$this->db->rollback();
  4082| 				return -1;
  4083| 			}
  4084| 			else
  4085| 			{
  4086| 				$this->db->commit();
  4087| 				return 1;
  4088| 			}
  4089| 		}
  4090| 		else return 0;
  4091| 	}
  4092| 	/**
  4093| 	 * Return HTML string to put an input field into a page
  4094| 	 * Code very similar with showInputField of extra fields
  4095| 	 *
  4096| 	 * @param  array   		$val	       Array of properties for field to show
  4097| 	 * @param  string  		$key           Key of attribute
  4098| 	 * @param  string  		$value         Preselected value to show (for date type it must be in timestamp format, for amount or price it must be a php numeric value)
  4099| 	 * @param  string  		$moreparam     To add more parametes on html input tag
  4100| 	 * @param  string  		$keysuffix     Prefix string to add into name and id of field (can be used to avoid duplicate names)

# --- HUNK 5: Lines 4102-4142 ---
  4102| 	 * @param  string|int	$showsize      Value for css to define size. May also be a numeric.
  4103| 	 * @return string
  4104| 	 */
  4105| 	function showInputField($val, $key, $value, $moreparam='', $keysuffix='', $keyprefix='', $showsize=0)
  4106| 	{
  4107| 		global $conf,$langs,$form;
  4108| 		if (! is_object($form))
  4109| 		{
  4110| 			require_once DOL_DOCUMENT_ROOT.'/core/class/html.form.class.php';
  4111| 			$form=new Form($this->db);
  4112| 		}
  4113| 		$objectid = $this->id;
  4114| 		$label= $val['label'];
  4115| 		$type = $val['type'];
  4116| 		$size = $val['css'];
  4117| 		if (preg_match('/varchar\((\d+)\)/', $type, $reg))
  4118| 		{
  4119| 			$type = 'varchar';		// convert varchar(xx) int varchar
  4120| 			$size = $reg[1];
  4121| 		}
  4122| 		elseif (preg_match('/varchar/', $type)) $type = 'varchar';		// convert varchar(xx) int varchar
  4123| 		if (is_array($val['arrayofkeyval'])) $type='select';
  4124| 		if (preg_match('/^integer:(.*):(.*)/i', $val['type'], $reg)) $type='link';
  4125| 		$default=$val['default'];
  4126| 		$computed=$val['computed'];
  4127| 		$unique=$val['unique'];
  4128| 		$required=$val['required'];
  4129| 		$param=$val['param'];
  4130| 		if (is_array($val['arrayofkeyval'])) $param['options'] = $val['arrayofkeyval'];
  4131| 		if (preg_match('/^integer:(.*):(.*)/i', $val['type'], $reg))
  4132| 		{
  4133| 			$type='link';
  4134| 			$param['options']=array($reg[1].':'.$reg[2]=>$reg[1].':'.$reg[2]);
  4135| 		}
  4136| 		$langfile=$val['langfile'];
  4137| 		$list=$val['list'];
  4138| 		$hidden=(abs($val['visible'])!=1 ? 1 : 0);
  4139| 		$help=$val['help'];
  4140| 		if ($computed)
  4141| 		{
  4142| 			if (! preg_match('/^search_/', $keyprefix)) return '<span class="opacitymedium">'.$langs->trans("AutomaticallyCalculated").'</span>';

# --- HUNK 6: Lines 4630-4674 ---
  4630| 			else
  4631| 			{
  4632| 				if (round($size) < 12)
  4633| 				{
  4634| 					$showsize = 'minwidth100';
  4635| 				}
  4636| 				else if (round($size) <= 48)
  4637| 				{
  4638| 					$showsize = 'minwidth200';
  4639| 				}
  4640| 				else
  4641| 				{
  4642| 					$showsize = 'minwidth400';
  4643| 				}
  4644| 			}
  4645| 		}
  4646| 		if ($key == 'ref' && method_exists($this, 'getNomUrl')) $value=$this->getNomUrl(1, '', 0, '', 1);
  4647| 		elseif ($key == 'status' && method_exists($this, 'getLibStatut')) $value=$this->getLibStatut(3);
  4648| 		elseif ($type == 'date')
  4649| 		{
  4650| 			$value=dol_print_date($value,'day');
  4651| 		}
  4652| 		elseif ($type == 'datetime')
  4653| 		{
  4654| 			$value=dol_print_date($value,'dayhour');
  4655| 		}
  4656| 		elseif ($type == 'double')
  4657| 		{
  4658| 			if (!empty($value)) {
  4659| 				$value=price($value);
  4660| 			}
  4661| 		}
  4662| 		elseif ($type == 'boolean')
  4663| 		{
  4664| 			$checked='';
  4665| 			if (!empty($value)) {
  4666| 				$checked=' checked ';
  4667| 			}
  4668| 			$value='<input type="checkbox" '.$checked.' '.($moreparam?$moreparam:'').' readonly disabled>';
  4669| 		}
  4670| 		elseif ($type == 'mail')
  4671| 		{
  4672| 			$value=dol_print_email($value,0,0,0,64,1,1);
  4673| 		}
  4674| 		elseif ($type == 'url')

# --- HUNK 7: Lines 4919-4963 ---
  4919| 				if ($extrafields->attribute_type[$key] == 'separate')
  4920| 				{
  4921| 					$out .= $extrafields->showSeparator($key);
  4922| 				}
  4923| 				else
  4924| 				{
  4925| 					$csstyle='';
  4926| 					$class=(!empty($extrafields->attribute_hidden[$key]) ? 'class="hideobject" ' : '');
  4927| 					if (is_array($params) && count($params)>0) {
  4928| 						if (array_key_exists('style',$params)) {
  4929| 							$csstyle=$params['style'];
  4930| 						}
  4931| 					}
  4932| 					$out .= '<tr '.$class.$csstyle.' class="'.$this->element.'_extras_'.$key.'">';
  4933| 					if (empty($onetrtd))
  4934| 					{
  4935| 						if (! empty($conf->global->MAIN_EXTRAFIELDS_USE_TWO_COLUMS) && ($e % 2) == 0) { $colspan='0'; }
  4936| 					}
  4937| 					if (in_array($extrafields->attribute_type[$key],array('date','datetime')))
  4938| 					{
  4939| 						$value = GETPOSTISSET($keyprefix.'options_'.$key.$keysuffix)?dol_mktime(GETPOST($keyprefix.'options_'.$key.$keysuffix."hour",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."min",'int',3), 0, GETPOST($keyprefix.'options_'.$key.$keysuffix."month",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."day",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."year",'int',3)):$this->db->jdate($this->array_options['options_'.$key]);
  4940| 					}
  4941| 					if (in_array($extrafields->attribute_type[$key],array('price','double')))
  4942| 					{
  4943| 						$value = GETPOSTISSET($keyprefix.'options_'.$key.$keysuffix)?price2num(GETPOST($keyprefix.'options_'.$key.$keysuffix,'int',3)):$this->array_options['options_'.$key];
  4944| 					}
  4945| 					$labeltoshow = $langs->trans($label);
  4946| 					if($extrafields->attribute_required[$key])
  4947| 					{
  4948| 						$labeltoshow = '<span'.($mode != 'view' ? ' class="fieldrequired"':'').'>'.$labeltoshow.'</span>';
  4949| 					}
  4950| 					if (empty($onetrtd)) $out .= '<td>';
  4951| 					else $out .= '<td'.($colspan?' colspan="'.($colspan+1).'"':'').'>';
  4952| 					$out .= $labeltoshow;
  4953| 					if (empty($onetrtd)) $out .= '</td><td'.($colspan?' colspan="'.($colspan).'"':'').'>';
  4954| 					else $out.=' ';
  4955| 					$html_id = !empty($this->id) ? $this->element.'_extras_'.$key.'_'.$this->id : '';
  4956| 					$out .='<span id="'.$html_id.'" class="'.$this->element.'_extras_'.$key.'">';
  4957| 					switch($mode) {
  4958| 						case "view":
  4959| 							$out .= $extrafields->showOutputField($key, $value);
  4960| 							break;
  4961| 						case "edit":
  4962| 							$out .= $extrafields->showInputField($key, $value, '', $keysuffix, '', 0, $this->id);
  4963| 							break;

# --- HUNK 8: Lines 5204-5244 ---
  5204| 	 * Function test if is indexed
  5205| 	 *
  5206| 	 * @param   array   $info   content informations of field
  5207| 	 * @return                  bool
  5208| 	 */
  5209| 	protected function isIndex($info)
  5210| 	{
  5211| 		if(is_array($info))
  5212| 		{
  5213| 			if(isset($info['index']) && $info['index']==true) return true;
  5214| 			else return false;
  5215| 		}
  5216| 		else return false;
  5217| 	}
  5218| 	/**
  5219| 	 * Function to prepare the values to insert.
  5220| 	 * Note $this->${field} are set by the page that make the createCommon or the updateCommon.
  5221| 	 *
  5222| 	 * @return array
  5223| 	 */
  5224| 	private function set_save_query()
  5225| 	{
  5226| 		global $conf;
  5227| 		$queryarray=array();
  5228| 		foreach ($this->fields as $field=>$info)	// Loop on definition of fields
  5229| 		{
  5230| 			if($this->isDate($info))
  5231| 			{
  5232| 				if(empty($this->{$field}))
  5233| 				{
  5234| 					$queryarray[$field] = NULL;
  5235| 				}
  5236| 				else
  5237| 				{
  5238| 					$queryarray[$field] = $this->db->idate($this->{$field});
  5239| 				}
  5240| 			}
  5241| 			else if($this->isArray($info))
  5242| 			{
  5243| 				$queryarray[$field] = serialize($this->{$field});
  5244| 			}

# --- HUNK 9: Lines 5253-5377 ---
  5253| 			}
  5254| 			else if($this->isFloat($info))
  5255| 			{
  5256| 				$queryarray[$field] = (double) price2num($this->{$field});
  5257| 				if (empty($queryarray[$field])) $queryarray[$field]=0;
  5258| 			}
  5259| 			else
  5260| 			{
  5261| 				$queryarray[$field] = $this->{$field};
  5262| 			}
  5263| 			if ($info['type'] == 'timestamp' && empty($queryarray[$field])) unset($queryarray[$field]);
  5264| 			if (! empty($info['notnull']) && $info['notnull'] == -1 && empty($queryarray[$field])) $queryarray[$field] = null;
  5265| 		}
  5266| 		return $queryarray;
  5267| 	}
  5268| 	/**
  5269| 	 * Function to load data from a SQL pointer into properties of current object $this
  5270| 	 *
  5271| 	 * @param   stdClass    $obj    Contain data of object from database
  5272| 	 */
  5273| 	private function setVarsFromFetchObj(&$obj)
  5274| 	{
  5275| 		foreach ($this->fields as $field => $info)
  5276| 		{
  5277| 			if($this->isDate($info))
  5278| 			{
  5279| 				if(empty($obj->{$field}) || $obj->{$field} === '0000-00-00 00:00:00' || $obj->{$field} === '1000-01-01 00:00:00') $this->{$field} = 0;
  5280| 				else $this->{$field} = strtotime($obj->{$field});
  5281| 			}
  5282| 			elseif($this->isArray($info))
  5283| 			{
  5284| 				$this->{$field} = @unserialize($obj->{$field});
  5285| 				if($this->{$field } === FALSE) @unserialize(utf8_decode($obj->{$field}));
  5286| 			}
  5287| 			elseif($this->isInt($info))
  5288| 			{
  5289| 				if ($field == 'rowid') $this->id = (int) $obj->{$field};
  5290| 				else $this->{$field} = (int) $obj->{$field};
  5291| 			}
  5292| 			elseif($this->isFloat($info))
  5293| 			{
  5294| 				$this->{$field} = (double) $obj->{$field};
  5295| 			}
  5296| 			elseif($this->isNull($info))
  5297| 			{
  5298| 				$val = $obj->{$field};
  5299| 				$this->{$field} = (is_null($val) || (empty($val) && $val!==0 && $val!=='0') ? null : $val);
  5300| 			}
  5301| 			else
  5302| 			{
  5303| 				$this->{$field} = $obj->{$field};
  5304| 			}
  5305| 		}
  5306| 		if (! isset($this->fields['ref']) && isset($this->id)) $this->ref = $this->id;
  5307| 	}
  5308| 	/**
  5309| 	 * Function to concat keys of fields
  5310| 	 *
  5311| 	 * @return string
  5312| 	 */
  5313| 	private function get_field_list()
  5314| 	{
  5315| 		$keys = array_keys($this->fields);
  5316| 		return implode(',', $keys);
  5317| 	}
  5318| 	/**
  5319| 	 * Add quote to field value if necessary
  5320| 	 *
  5321| 	 * @param 	string|int	$value			Value to protect
  5322| 	 * @param	array		$fieldsentry	Properties of field
  5323| 	 * @return 	string
  5324| 	 */
  5325| 	protected function quote($value, $fieldsentry) {
  5326| 		if (is_null($value)) return 'NULL';
  5327| 		else if (preg_match('/^(int|double|real)/i', $fieldsentry['type'])) return $this->db->escape("$value");
  5328| 		else return "'".$this->db->escape($value)."'";
  5329| 	}
  5330| 	/**
  5331| 	 * Create object into database
  5332| 	 *
  5333| 	 * @param  User $user      User that creates
  5334| 	 * @param  bool $notrigger false=launch triggers after, true=disable triggers
  5335| 	 * @return int             <0 if KO, Id of created object if OK
  5336| 	 */
  5337| 	public function createCommon(User $user, $notrigger = false)
  5338| 	{
  5339| 		global $langs;
  5340| 		$error = 0;
  5341| 		$now=dol_now();
  5342| 		$fieldvalues = $this->set_save_query();
  5343| 		if (array_key_exists('date_creation', $fieldvalues) && empty($fieldvalues['date_creation'])) $fieldvalues['date_creation']=$this->db->idate($now);
  5344| 		if (array_key_exists('fk_user_creat', $fieldvalues) && ! ($fieldvalues['fk_user_creat'] > 0)) $fieldvalues['fk_user_creat']=$user->id;
  5345| 		unset($fieldvalues['rowid']);	// The field 'rowid' is reserved field name for autoincrement field so we don't need it into insert.
  5346| 		$keys=array();
  5347| 		$values = array();
  5348| 		foreach ($fieldvalues as $k => $v) {
  5349| 			$keys[$k] = $k;
  5350| 			$value = $this->fields[$k];
  5351| 			$values[$k] = $this->quote($v, $value);
  5352| 		}
  5353| 		foreach($keys as $key)
  5354| 		{
  5355| 			if (preg_match('/^integer:/i', $this->fields[$key]['type']) && $values[$key] == '-1') $values[$key]='';
  5356| 			if (! empty($this->fields[$key]['foreignkey']) && $values[$key] == '-1') $values[$key]='';
  5357| 			if ($this->fields[$key]['notnull'] == 1 && ! isset($values[$key]))
  5358| 			{
  5359| 				$error++;
  5360| 				$this->errors[]=$langs->trans("ErrorFieldRequired", $this->fields[$key]['label']);
  5361| 			}
  5362| 			if (preg_match('/^integer:/i', $this->fields[$key]['type']) && empty($values[$key])) $values[$key]='null';
  5363| 			if (! empty($this->fields[$key]['foreignkey']) && empty($values[$key])) $values[$key]='null';
  5364| 		}
  5365| 		if ($error) return -1;
  5366| 		$this->db->begin();
  5367| 		if (! $error)
  5368| 		{
  5369| 			$sql = 'INSERT INTO '.MAIN_DB_PREFIX.$this->table_element;
  5370| 			$sql.= ' ('.implode( ", ", $keys ).')';
  5371| 			$sql.= ' VALUES ('.implode( ", ", $values ).')';
  5372| 			$res = $this->db->query($sql);
  5373| 			if ($res===false) {
  5374| 				$error++;
  5375| 				$this->errors[] = $this->db->lasterror();
  5376| 			}
  5377| 		}

# --- HUNK 10: Lines 5390-5467 ---
  5390| 			if ($result < 0) { $error++; }
  5391| 		}
  5392| 		if ($error) {
  5393| 			$this->db->rollback();
  5394| 			return -1;
  5395| 		} else {
  5396| 			$this->db->commit();
  5397| 			return $this->id;
  5398| 		}
  5399| 	}
  5400| 	/**
  5401| 	 * Load object in memory from the database
  5402| 	 *
  5403| 	 * @param int    $id   Id object
  5404| 	 * @param string $ref  Ref
  5405| 	 * @return int         <0 if KO, 0 if not found, >0 if OK
  5406| 	 */
  5407| 	public function fetchCommon($id, $ref = null)
  5408| 	{
  5409| 		if (empty($id) && empty($ref)) return false;
  5410| 		$sql = 'SELECT '.$this->get_field_list();
  5411| 		$sql.= ' FROM '.MAIN_DB_PREFIX.$this->table_element;
  5412| 		if(!empty($id)) $sql.= ' WHERE rowid = '.$id;
  5413| 		else $sql.= " WHERE ref = ".$this->quote($ref, $this->fields['ref']);
  5414| 		$res = $this->db->query($sql);
  5415| 		if ($res)
  5416| 		{
  5417| 			$obj = $this->db->fetch_object($res);
  5418| 			if ($obj)
  5419| 			{
  5420| 				$this->setVarsFromFetchObj($obj);
  5421| 				return $this->id;
  5422| 			}
  5423| 			else
  5424| 			{
  5425| 				return 0;
  5426| 			}
  5427| 		}
  5428| 		else
  5429| 		{
  5430| 			$this->error = $this->db->lasterror();
  5431| 			$this->errors[] = $this->error;
  5432| 			return -1;
  5433| 		}
  5434| 	}
  5435| 	/**
  5436| 	 * Update object into database
  5437| 	 *
  5438| 	 * @param  User $user      	User that modifies
  5439| 	 * @param  bool $notrigger 	false=launch triggers after, true=disable triggers
  5440| 	 * @return int             	<0 if KO, >0 if OK
  5441| 	 */
  5442| 	public function updateCommon(User $user, $notrigger = false)
  5443| 	{
  5444| 		global $conf, $langs;
  5445| 		$error = 0;
  5446| 		$now=dol_now();
  5447| 		$fieldvalues = $this->set_save_query();
  5448| 		if (array_key_exists('date_modification', $fieldvalues) && empty($fieldvalues['date_modification'])) $fieldvalues['date_modification']=$this->db->idate($now);
  5449| 		if (array_key_exists('fk_user_modif', $fieldvalues) && ! ($fieldvalues['fk_user_modif'] > 0)) $fieldvalues['fk_user_modif']=$user->id;
  5450| 		unset($fieldvalues['rowid']);	// The field 'rowid' is reserved field name for autoincrement field so we don't need it into update.
  5451| 		$keys=array();
  5452| 		$values = array();
  5453| 		foreach ($fieldvalues as $k => $v) {
  5454| 			$keys[$k] = $k;
  5455| 			$value = $this->fields[$k];
  5456| 			$values[$k] = $this->quote($v, $value);
  5457| 			$tmp[] = $k.'='.$this->quote($v, $this->fields[$k]);
  5458| 		}
  5459| 		foreach($keys as $key)
  5460| 		{
  5461| 			if (preg_match('/^integer:/i', $this->fields[$key]['type']) && $values[$key] == '-1') $values[$key]='';		// This is an implicit foreign key field
  5462| 			if (! empty($this->fields[$key]['foreignkey']) && $values[$key] == '-1') $values[$key]='';					// This is an explicit foreign key field
  5463| 			/*
  5464| 			if ($this->fields[$key]['notnull'] == 1 && empty($values[$key]))
  5465| 			{
  5466| 				$error++;
  5467| 				$this->errors[]=$langs->trans("ErrorFieldRequired", $this->fields[$key]['label']);


# ====================================================================
# FILE: htdocs/core/class/conf.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 233-285 ---
   233| 		$this->user->multidir_output	= array($this->entity => $rootfordata."/users");
   234| 		$this->user->multidir_temp		= array($this->entity => $rootfordata."/users/temp");
   235| 		$this->user->dir_output=$rootforuser."/users";
   236| 		$this->user->dir_temp=$rootforuser."/users/temp";
   237| 		$this->usergroup->dir_output=$rootforuser."/usergroups";
   238| 		$this->usergroup->dir_temp=$rootforuser."/usergroups/temp";
   239| 		$this->propal->dir_output=$rootfordata."/propale";
   240| 		$this->propal->dir_temp=$rootfordata."/propale/temp";
   241| 		$this->medias->multidir_output	= array($this->entity => $rootfordata."/medias");
   242| 		$this->medias->multidir_temp		= array($this->entity => $rootfordata."/medias/temp");
   243| 		$this->expedition_bon->enabled=(! empty($this->global->MAIN_SUBMODULE_EXPEDITION)?$this->global->MAIN_SUBMODULE_EXPEDITION:0);
   244| 		$this->livraison_bon->enabled=(! empty($this->global->MAIN_SUBMODULE_LIVRAISON)?$this->global->MAIN_SUBMODULE_LIVRAISON:0);
   245| 		if (! empty($this->fournisseur))
   246| 		{
   247| 			$this->fournisseur->commande=new stdClass();
   248| 			$this->fournisseur->commande->dir_output=$rootfordata."/fournisseur/commande";
   249| 			$this->fournisseur->commande->dir_temp  =$rootfordata."/fournisseur/commande/temp";
   250| 			$this->fournisseur->facture=new stdClass();
   251| 			$this->fournisseur->facture->dir_output =$rootfordata."/fournisseur/facture";
   252| 			$this->fournisseur->facture->dir_temp   =$rootfordata."/fournisseur/facture/temp";
   253| 			$this->fournisseur->payment=new stdClass();
   254| 			$this->fournisseur->payment->dir_output =$rootfordata."/fournisseur/payment";
   255| 			$this->fournisseur->payment->dir_temp   =$rootfordata."/fournisseur/payment/temp";
   256| 			if (! empty($this->fournisseur->enabled) && empty($this->global->MAIN_USE_NEW_SUPPLIERMOD))  // By default, if module supplier is on, we set new properties
   257| 			{
   258|     			$this->supplier_order=new stdClass();
   259|     			$this->supplier_order->enabled=1;
   260|     			$this->supplier_order->dir_output=$rootfordata."/fournisseur/commande";
   261|     			$this->supplier_order->dir_temp=$rootfordata."/fournisseur/commande/temp";
   262|     			$this->supplier_invoice=new stdClass();
   263|     			$this->supplier_invoice->enabled=1;
   264|     			$this->supplier_invoice->dir_output=$rootfordata."/fournisseur/facture";
   265|     			$this->supplier_invoice->dir_temp=$rootfordata."/fournisseur/facture/temp";
   266| 			}
   267| 		}
   268| 		$this->product->multidir_output=array($this->entity => $rootfordata."/produit");
   269| 		$this->product->multidir_temp  =array($this->entity => $rootfordata."/produit/temp");
   270| 		$this->service->multidir_output=array($this->entity => $rootfordata."/produit");
   271| 		$this->service->multidir_temp  =array($this->entity => $rootfordata."/produit/temp");
   272| 		$this->product->dir_output=$rootfordata."/produit";
   273| 		$this->product->dir_temp  =$rootfordata."/produit/temp";
   274| 		$this->service->dir_output=$rootfordata."/produit";
   275| 		$this->service->dir_temp  =$rootfordata."/produit/temp";
   276| 		$this->contrat->dir_output=$rootfordata."/contracts";
   277| 		$this->contrat->dir_temp  =$rootfordata."/contracts/temp";
   278| 		$this->bank->dir_output=$rootfordata."/bank";
   279| 		$this->bank->dir_temp  =$rootfordata."/bank/temp";
   280| 		$this->global->MAIN_ACTIVATE_HTML5=1;
   281|         $this->global->MAIN_MAIL_USE_MULTI_PART=1;
   282| 		if (empty($this->global->SOCIETE_CODECLIENT_ADDON))       $this->global->SOCIETE_CODECLIENT_ADDON="mod_codeclient_leopard";
   283| 		if (empty($this->global->SOCIETE_CODECOMPTA_ADDON))       $this->global->SOCIETE_CODECOMPTA_ADDON="mod_codecompta_panicum";
   284| 		if (empty($this->global->CHEQUERECEIPTS_ADDON))           $this->global->CHEQUERECEIPTS_ADDON='mod_chequereceipt_mint';
   285| 		if (empty($this->global->USER_PASSWORD_GENERATED)) $this->global->USER_PASSWORD_GENERATED='standard'; // Default password generator


# ====================================================================
# FILE: htdocs/core/class/extrafields.class.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 633-739 ---
   633| 		else
   634| 		{
   635| 			return 0;
   636| 		}
   637| 	}
   638| 	/**
   639| 	 * 	Load array this->attributes, or old this->attribute_xxx like attribute_label, attribute_type, ...
   640| 	 *
   641| 	 * 	@param	string		$elementtype		Type of element ('adherent', 'commande', 'thirdparty', 'facture', 'propal', 'product', ...).
   642| 	 * 	@param	boolean		$forceload			Force load of extra fields whatever is option MAIN_EXTRAFIELDS_DISABLED. Deprecated. Should not be required.
   643| 	 * 	@return	array							Array of attributes keys+label for all extra fields.
   644| 	 */
   645| 	function fetch_name_optionals_label($elementtype,$forceload=false)
   646| 	{
   647| 		global $conf;
   648| 		if (empty($elementtype) ) return array();
   649| 		if ($elementtype == 'thirdparty') $elementtype='societe';
   650| 		if ($elementtype == 'contact') $elementtype='socpeople';
   651| 		$array_name_label=array();
   652| 		if (!$forceload && !empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) return $array_name_label;
   653| 		dol_syslog("fetch_name_optionals_label elementtype=".$elementtype);
   654| 		$sql = "SELECT rowid,name,label,type,size,elementtype,fieldunique,fieldrequired,param,pos,alwayseditable,perms,langs,list,fielddefault,fieldcomputed";
   655| 		$sql .= ",entity";
   656| 		$sql.= " FROM ".MAIN_DB_PREFIX."extrafields";
   657| 		$sql.= " WHERE entity IN (0,".$conf->entity.")";
   658| 		if ($elementtype) $sql.= " AND elementtype = '".$elementtype."'";
   659| 		$sql.= " ORDER BY pos";
   660| 		$resql=$this->db->query($sql);
   661| 		if ($resql)
   662| 		{
   663| 			if ($this->db->num_rows($resql))
   664| 			{
   665| 				while ($tab = $this->db->fetch_object($resql))
   666| 				{
   667| 					if ($tab->type != 'separate')
   668| 					{
   669| 						$array_name_label[$tab->name]=$tab->label;
   670| 					}
   671| 					$this->attribute_type[$tab->name]=$tab->type;
   672| 					$this->attribute_label[$tab->name]=$tab->label;
   673| 					$this->attribute_size[$tab->name]=$tab->size;
   674| 					$this->attribute_elementtype[$tab->name]=$tab->elementtype;
   675| 					$this->attribute_default[$tab->name]=$tab->fielddefault;
   676| 					$this->attribute_computed[$tab->name]=$tab->fieldcomputed;
   677| 					$this->attribute_unique[$tab->name]=$tab->fieldunique;
   678| 					$this->attribute_required[$tab->name]=$tab->fieldrequired;
   679| 					$this->attribute_param[$tab->name]=($tab->param ? unserialize($tab->param) : '');
   680| 					$this->attribute_pos[$tab->name]=$tab->pos;
   681| 					$this->attribute_alwayseditable[$tab->name]=$tab->alwayseditable;
   682| 					$this->attribute_perms[$tab->name]=(strlen($tab->perms) == 0 ? 1 : $tab->perms);
   683| 					$this->attribute_langfile[$tab->name]=$tab->langs;
   684| 					$this->attribute_list[$tab->name]=$tab->list;
   685| 					$this->attribute_entityid[$tab->name]=$tab->entity;
   686| 					$this->attributes[$tab->elementtype]['type'][$tab->name]=$tab->type;
   687| 					$this->attributes[$tab->elementtype]['label'][$tab->name]=$tab->label;
   688| 					$this->attributes[$tab->elementtype]['size'][$tab->name]=$tab->size;
   689| 					$this->attributes[$tab->elementtype]['elementtype'][$tab->name]=$tab->elementtype;
   690| 					$this->attributes[$tab->elementtype]['default'][$tab->name]=$tab->fielddefault;
   691| 					$this->attributes[$tab->elementtype]['computed'][$tab->name]=$tab->fieldcomputed;
   692| 					$this->attributes[$tab->elementtype]['unique'][$tab->name]=$tab->fieldunique;
   693| 					$this->attributes[$tab->elementtype]['required'][$tab->name]=$tab->fieldrequired;
   694| 					$this->attributes[$tab->elementtype]['param'][$tab->name]=($tab->param ? unserialize($tab->param) : '');
   695| 					$this->attributes[$tab->elementtype]['pos'][$tab->name]=$tab->pos;
   696| 					$this->attributes[$tab->elementtype]['alwayseditable'][$tab->name]=$tab->alwayseditable;
   697| 					$this->attributes[$tab->elementtype]['perms'][$tab->name]=(strlen($tab->perms) == 0 ? 1 : $tab->perms);
   698| 					$this->attributes[$tab->elementtype]['langfile'][$tab->name]=$tab->langs;
   699| 					$this->attributes[$tab->elementtype]['list'][$tab->name]=$tab->list;
   700| 					$this->attributes[$tab->elementtype]['entityid'][$tab->name]=$tab->entity;
   701| 					if (!empty($conf->multicompany->enabled))
   702| 					{
   703| 						$sql_entity_name='SELECT label FROM '.MAIN_DB_PREFIX.'entity WHERE rowid='.$tab->entity;
   704| 						$resql_entity_name=$this->db->query($sql_entity_name);
   705| 						if ($resql_entity_name)
   706| 						{
   707| 							if ($this->db->num_rows($resql_entity_name))
   708| 							{
   709| 								if ($obj = $this->db->fetch_object($resql_entity_name))
   710| 								{
   711| 									$this->attribute_entitylabel[$tab->name]=$obj->label;
   712| 									$this->attributes[$tab->elementtype]['entitylabel'][$tab->name]=$obj->label;
   713| 								}
   714| 							}
   715| 						}
   716| 					}
   717| 				}
   718| 			}
   719| 			if ($elementtype) $this->attributes[$elementtype]['loaded']=1;
   720| 		}
   721| 		else
   722| 		{
   723| 			$this->error=$this->db->lasterror();
   724| 			dol_syslog(get_class($this)."::fetch_name_optionals_label ".$this->error, LOG_ERR);
   725| 		}
   726| 		return $array_name_label;
   727| 	}
   728| 	/**
   729| 	 * Return HTML string to put an input field into a page
   730| 	 * Code very similar with showInputField of common object
   731| 	 *
   732| 	 * @param  string  $key            Key of attribute
   733| 	 * @param  string  $value          Preselected value to show (for date type it must be in timestamp format, for amount or price it must be a php numeric value)
   734| 	 * @param  string  $moreparam      To add more parametes on html input tag
   735| 	 * @param  string  $keysuffix      Prefix string to add after name and id of field (can be used to avoid duplicate names)
   736| 	 * @param  string  $keyprefix      Suffix string to add before name and id of field (can be used to avoid duplicate names)
   737| 	 * @param  string  $morecss        More css (to defined size of field. Old behaviour: may also be a numeric)
   738| 	 * @param  int     $objectid       Current object id
   739| 	 * @return string

# --- HUNK 2: Lines 907-946 ---
   907| 					} else {
   908| 						$keyList=$InfoFieldList[2].' as rowid';
   909| 					}
   910| 				}
   911| 				if (count($InfoFieldList) > 3 && ! empty($InfoFieldList[3]))
   912| 				{
   913| 					list($parentName, $parentField) = explode('|', $InfoFieldList[3]);
   914| 					$keyList.= ', '.$parentField;
   915| 				}
   916| 				$fields_label = explode('|',$InfoFieldList[1]);
   917| 				if (is_array($fields_label))
   918| 				{
   919| 					$keyList .=', ';
   920| 					$keyList .= implode(', ', $fields_label);
   921| 				}
   922| 				$sqlwhere='';
   923| 				$sql = 'SELECT '.$keyList;
   924| 				$sql.= ' FROM '.MAIN_DB_PREFIX .$InfoFieldList[0];
   925| 				if (!empty($InfoFieldList[4]))
   926| 				{
   927| 					if (strpos($InfoFieldList[4], '$SEL$')!==false) {
   928| 						$InfoFieldList[4]=str_replace('$SEL$','SELECT',$InfoFieldList[4]);
   929| 					}
   930| 					if (strpos($InfoFieldList[4], '$ID$')!==false && !empty($objectid)) {
   931| 						$InfoFieldList[4]=str_replace('$ID$',$objectid,$InfoFieldList[4]);
   932| 					} else {
   933| 						$InfoFieldList[4]=str_replace('$ID$','0',$InfoFieldList[4]);
   934| 					}
   935| 					if (strpos($InfoFieldList[4], 'extra')!==false)
   936| 					{
   937| 						$sql.= ' as main, '.MAIN_DB_PREFIX .$InfoFieldList[0].'_extrafields as extra';
   938| 						$sqlwhere.= ' WHERE extra.fk_object=main.'.$InfoFieldList[2]. ' AND '.$InfoFieldList[4];
   939| 					}
   940| 					else
   941| 					{
   942| 						$sqlwhere.= ' WHERE '.$InfoFieldList[4];
   943| 					}
   944| 				}
   945| 				else
   946| 				{

# --- HUNK 3: Lines 1539-1579 ---
  1539| 				}
  1540| 				if (in_array($key_type,array('date')))
  1541| 				{
  1542| 					$value_key=dol_mktime(0, 0, 0, $_POST["options_".$key."month"], $_POST["options_".$key."day"], $_POST["options_".$key."year"]);
  1543| 				}
  1544| 				elseif (in_array($key_type,array('datetime')))
  1545| 				{
  1546| 					$value_key=dol_mktime($_POST["options_".$key."hour"], $_POST["options_".$key."min"], 0, $_POST["options_".$key."month"], $_POST["options_".$key."day"], $_POST["options_".$key."year"]);
  1547| 				}
  1548| 				else if (in_array($key_type,array('checkbox','chkbxlst')))
  1549| 				{
  1550| 					$value_arr=GETPOST("options_".$key, 'array'); // check if an array
  1551| 					if (!empty($value_arr)) {
  1552| 						$value_key=implode($value_arr,',');
  1553| 					}else {
  1554| 						$value_key='';
  1555| 					}
  1556| 				}
  1557| 				else if (in_array($key_type,array('price','double')))
  1558| 				{
  1559| 					$value_arr=GETPOST("options_".$key);
  1560| 					$value_key=price2num($value_arr);
  1561| 				}
  1562| 				else
  1563| 				{
  1564| 					$value_key=GETPOST("options_".$key);
  1565| 				}
  1566| 				$object->array_options["options_".$key]=$value_key;
  1567| 			}
  1568| 			if ($nofillrequired) {
  1569| 				$langs->load('errors');
  1570| 				setEventMessages($langs->trans('ErrorFieldsRequired').' : '.implode(', ',$error_field_required), null, 'errors');
  1571| 				return -1;
  1572| 			}
  1573| 			else {
  1574| 				return 1;
  1575| 			}
  1576| 		}
  1577| 		else {
  1578| 			return 0;
  1579| 		}


# ====================================================================
# FILE: htdocs/core/class/hookmanager.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 131-171 ---
   131| 			    'pdf_getlineref_supplier',
   132| 			    'pdf_getlinevatrate',
   133| 			    'pdf_getlineupexcltax',
   134| 			    'pdf_getlineupwithtax',
   135| 			    'pdf_getlineqty',
   136| 			    'pdf_getlineqty_asked',
   137| 			    'pdf_getlineqty_shipped',
   138| 			    'pdf_getlineqty_keeptoship',
   139| 			    'pdf_getlineunit',
   140| 			    'pdf_getlineremisepercent',
   141| 			    'pdf_getlineprogress',
   142| 			    'pdf_getlinetotalexcltax',
   143| 			    'pdf_getlinetotalwithtax',
   144| 				'paymentsupplierinvoices',
   145| 				'printAddress',
   146| 				'printSearchForm',
   147| 				'printTabsHead',
   148| 				'formatEvent',
   149|                 'printObjectLine',
   150|                 'printObjectSubLine',
   151| 				'createDictionaryFieldList',
   152| 				'editDictionaryFieldlist',
   153| 				'getFormMail',
   154| 			    'showLinkToObjectBlock'
   155| 				)
   156| 			)) $hooktype='addreplace';
   157|         if ($method == 'insertExtraFields')
   158|         {
   159|         	$hooktype='returnvalue';	// @deprecated. TODO Remove all code with "executeHooks('insertExtraFields'" as soon as there is a trigger available.
   160|         	dol_syslog("Warning: The hook 'insertExtraFields' is deprecated and must not be used. Use instead trigger on CRUD event (ask it to dev team if not implemented)", LOG_WARNING);
   161|         }
   162|         $this->resPrint=''; $this->resArray=array(); $this->resNbOfHooks=0;
   163|         $modulealreadyexecuted=array();
   164|         $resaction=0; $error=0; $result='';
   165|         foreach($this->hooks as $context => $modules)    // $this->hooks is an array with context as key and value is an array of modules that handle this context
   166|         {
   167|             if (! empty($modules))
   168|             {
   169|                 foreach($modules as $module => $actionclassinstance)
   170|                 {
   171|                     if (in_array($module,$modulealreadyexecuted)) continue;


# ====================================================================
# FILE: htdocs/core/class/html.form.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4560-4600 ---
  4560| 		global $conf, $langs, $user;
  4561| 		$prefixforautocompletemode=$objecttmp->element;
  4562| 		if ($prefixforautocompletemode == 'societe') $prefixforautocompletemode='company';
  4563| 		$confkeyforautocompletemode=strtoupper($prefixforautocompletemode).'_USE_SEARCH_TO_SELECT';	// For example COMPANY_USE_SEARCH_TO_SELECT
  4564| 		$fieldstoshow='t.ref';
  4565| 		if (! empty($objecttmp->fields))	// For object that declare it, it is better to use declared fields ( like societe, contact, ...)
  4566| 		{
  4567| 			$tmpfieldstoshow='';
  4568| 			foreach($objecttmp->fields as $key => $val)
  4569| 			{
  4570| 				if ($val['showoncombobox']) $tmpfieldstoshow.=($tmpfieldstoshow?',':'').'t.'.$key;
  4571| 			}
  4572| 			if ($tmpfieldstoshow) $fieldstoshow = $tmpfieldstoshow;
  4573| 		}
  4574| 		$out='';
  4575| 		$outarray=array();
  4576| 		$num=0;
  4577| 		$sql = "SELECT t.rowid, ".$fieldstoshow." FROM ".MAIN_DB_PREFIX .$objecttmp->table_element." as t";
  4578| 		if ($objecttmp->ismultientitymanaged == 2)
  4579| 			if (!$user->rights->societe->client->voir && !$user->societe_id) $sql .= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
  4580| 		$sql.= " WHERE t.entity IN (".getEntity($objecttmp->table_element).")";
  4581| 		if ($objecttmp->ismultientitymanaged == 1 && ! empty($user->societe_id))
  4582| 		{
  4583| 			if ($objecttmp->element == 'societe') $sql.= " AND t.rowid = ".$user->societe_id;
  4584| 				else $sql.= " AND t.fk_soc = ".$user->societe_id;
  4585| 		}
  4586| 		if ($searchkey != '') $sql.=natural_search(explode(',',$fieldstoshow), $searchkey);
  4587| 		if ($objecttmp->ismultientitymanaged == 2)
  4588| 			if (!$user->rights->societe->client->voir && !$user->societe_id) $sql.= " AND t.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
  4589| 		$sql.=$this->db->order($fieldstoshow,"ASC");
  4590| 		$resql=$this->db->query($sql);
  4591| 		if ($resql)
  4592| 		{
  4593| 			if (! $forcecombo)
  4594| 			{
  4595| 				include_once DOL_DOCUMENT_ROOT . '/core/lib/ajax.lib.php';
  4596| 				$out .= ajax_combobox($htmlname, null, $conf->global->$confkeyforautocompletemode);
  4597| 			}
  4598| 			$out.= '<select id="'.$htmlname.'" class="flat'.($morecss?' '.$morecss:'').'"'.($moreparams?' '.$moreparams:'').' name="'.$htmlname.'">'."\n";
  4599| 			$textifempty='&nbsp;';
  4600| 			if (! empty($conf->global->$confkeyforautocompletemode))


# ====================================================================
# FILE: htdocs/core/class/html.formaccounting.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 6-45 ---
     6|  * Copyright (C) 2016-2017 Alexandre Spangaro   <aspangaro@zendsi.com>
     7|  *
     8|  * This program is free software; you can redistribute it and/or modify
     9|  * it under the terms of the GNU General Public License as published by
    10|  * the Free Software Foundation; either version 3 of the License, or
    11|  * (at your option) any later version.
    12|  *
    13|  * This program is distributed in the hope that it will be useful,
    14|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    15|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    16|  * GNU General Public License for more details.
    17|  *
    18|  * You should have received a copy of the GNU General Public License
    19|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    20|  */
    21| /**
    22|  *	\file       htdocs/core/class/html.formaccounting.class.php
    23|  *  \ingroup    Advanced accountancy
    24|  *	\brief      File of class with all html predefined components
    25|  */
    26| /**
    27|  *	Class to manage generation of HTML components for accounting management
    28|  */
    29| class FormAccounting extends Form
    30| {
    31| 	private $options_cache = array();
    32| 	var $db;
    33| 	var $error;
    34| 	/**
    35| 	* Constructor
    36| 	*
    37| 	* @param		DoliDB		$db      Database handler
    38| 	*/
    39| 	public function __construct($db)
    40| 	{
    41| 	    $this->db = $db;
    42| 	}
    43| 	/**
    44| 	 * Return list of journals with label by nature
    45| 	 *

# --- HUNK 2: Lines 188-287 ---
   188| 		$sql = 'SELECT DISTINCT import_key from ' . MAIN_DB_PREFIX . 'accounting_bookkeeping';
   189| 	    $sql .= " WHERE entity IN (".getEntity('accountancy').")";
   190| 		$sql .= ' ORDER BY import_key DESC';
   191| 		dol_syslog(get_class($this) . "::select_bookkeeping_importkey", LOG_DEBUG);
   192| 		$resql = $this->db->query($sql);
   193| 		if (!$resql) {
   194| 			$this->error = "Error " . $this->db->lasterror();
   195| 			dol_syslog(get_class($this) . "::select_bookkeeping_importkey " . $this->error, LOG_ERR);
   196| 			return - 1;
   197| 		}
   198| 		while ($obj = $this->db->fetch_object($resql)) {
   199| 			$options[$obj->import_key] = dol_print_date($obj->import_key, 'dayhourtext');
   200| 		}
   201| 		return Form::selectarray($htmlname, $options, $selectedkey);
   202| 	}
   203| 	/**
   204| 	 * Return list of accounts with label by chart of accounts
   205| 	 *
   206| 	 * @param string   $selectid           Preselected id or code of accounting accounts (depends on $select_in)
   207| 	 * @param string   $htmlname           Name of HTML field id. If name start with '.', it is name of HTML css class, so several component with same name in different forms can be used.
   208| 	 * @param int      $showempty          Add an empty field
   209| 	 * @param array    $event              Event options
   210| 	 * @param int      $select_in          0=selectid value is a aa.rowid (default) or 1=selectid is aa.account_number
   211| 	 * @param int      $select_out         Set value returned by select. 0=rowid (default), 1=account_number
   212| 	 * @param string   $morecss            More css non HTML object
   213| 	 * @param string   $usecache           Key to use to store result into a cache. Next call with same key will reuse the cache.
   214| 	 * @return string                      String with HTML select
   215| 	 */
   216| 	function select_account($selectid, $htmlname = 'account', $showempty = 0, $event = array(), $select_in = 0, $select_out = 0, $morecss='maxwidth300 maxwidthonsmartphone', $usecache='')
   217| 	{
   218| 		global $conf;
   219| 		require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
   220| 		$out = '';
   221|     	$options = array();
   222| 		if ($usecache && ! empty($this->options_cache[$usecache]))
   223| 		{
   224| 		    $options = $this->options_cache[$usecache];
   225| 		    $selected=$selectid;
   226| 		}
   227| 		else
   228| 		{
   229|     		$trunclength = empty($conf->global->ACCOUNTING_LENGTH_DESCRIPTION_ACCOUNT) ? 50 : $conf->global->ACCOUNTING_LENGTH_DESCRIPTION_ACCOUNT;
   230|     		$sql = "SELECT DISTINCT aa.account_number, aa.label, aa.rowid, aa.fk_pcg_version";
   231|     		$sql .= " FROM " . MAIN_DB_PREFIX . "accounting_account as aa";
   232|     		$sql .= " INNER JOIN " . MAIN_DB_PREFIX . "accounting_system as asy ON aa.fk_pcg_version = asy.pcg_version";
   233|     		$sql .= " AND asy.rowid = " . $conf->global->CHARTOFACCOUNTS;
   234|     		$sql .= " AND aa.active = 1";
   235|     		$sql .= " ORDER BY aa.account_number";
   236|     		dol_syslog(get_class($this) . "::select_account", LOG_DEBUG);
   237|     		$resql = $this->db->query($sql);
   238|     		if (!$resql) {
   239|     			$this->error = "Error " . $this->db->lasterror();
   240|     			dol_syslog(get_class($this) . "::select_account " . $this->error, LOG_ERR);
   241|     			return -1;
   242|     		}
   243|     		$selected = 0;
   244|     		while ($obj = $this->db->fetch_object($resql))
   245|     		{
   246|     			$label = length_accountg($obj->account_number) . ' - ' . $obj->label;
   247|     			$label = dol_trunc($label, $trunclength);
   248|     			$select_value_in = $obj->rowid;
   249|     			$select_value_out = $obj->rowid;
   250|     			if ($select_in == 1) {
   251|     				$select_value_in = $obj->account_number;
   252|     			}
   253|     			if ($select_out == 1) {
   254|     				$select_value_out = $obj->account_number;
   255|     			}
   256|     			if ($selectid != '' && $selectid == $select_value_in) {
   257|     				$selected = $select_value_out;
   258|     			}
   259|     			$options[$select_value_out] = $label;
   260|     		}
   261|     		$this->db->free($resql);
   262|     		if ($usecache)
   263|     		{
   264|                 $this->options_cache[$usecache] = $options;
   265|     		}
   266| 		}
   267| 		$out .= Form::selectarray($htmlname, $options, $selected, $showempty, 0, 0, '', 0, 0, 0, '', $morecss, 1);
   268| 		return $out;
   269| 	}
   270| 	/**
   271| 	 * Return list of auxilary thirdparty accounts
   272| 	 *
   273| 	 * @param string   $selectid       Preselected pcg_type
   274| 	 * @param string   $htmlname       Name of field in html form
   275| 	 * @param int      $showempty      Add an empty field
   276| 	 * @param string   $morecss        More css
   277| 	 * @return string                  String with HTML select
   278| 	 */
   279| 	function select_auxaccount($selectid, $htmlname='account_num_aux', $showempty=0, $morecss='maxwidth200') {
   280| 		$aux_account = array();
   281| 		$sql = "SELECT DISTINCT code_compta, nom ";
   282| 		$sql .= " FROM ".MAIN_DB_PREFIX."societe";
   283| 	    $sql .= " WHERE entity IN (" . getEntity('societe') . ")";
   284| 		$sql .= " ORDER BY code_compta";
   285| 		dol_syslog(get_class($this)."::select_auxaccount", LOG_DEBUG);
   286| 		$resql = $this->db->query($sql);
   287| 		if ($resql) {


# ====================================================================
# FILE: htdocs/core/class/html.formfile.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 714-754 ---
   714| 		return $out;
   715| 	}
   716| 	/**
   717| 	 *	Show a Document icon with link(s)
   718| 	 *  You may want to call this into a div like this:
   719| 	 *  print '<div class="inline-block valignmiddle">'.$formfile->getDocumentsLink($element_doc, $filename, $filedir).'</div>';
   720| 	 *
   721| 	 *	@param	string	$modulepart		propal, facture, facture_fourn, ...
   722| 	 *	@param	string	$modulesubdir	Sub-directory to scan (Example: '0/1/10', 'FA/DD/MM/YY/9999'). Use '' if file is not into subdir of module.
   723| 	 *	@param	string	$filedir		Full path to directory to scan
   724| 	 *  @param	string	$filter			Filter filenames on this regex string (Example: '\.pdf$')
   725| 	 *	@return	string              	Output string with HTML link of documents (might be empty string). This also fill the array ->infofiles
   726| 	 */
   727| 	function getDocumentsLink($modulepart, $modulesubdir, $filedir, $filter='')
   728| 	{
   729| 		global $conf, $langs;
   730| 		include_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
   731| 		$out='';
   732| 		$this->infofiles=array('nboffiles'=>0,'extensions'=>array(),'files'=>array());
   733| 		$filterforfilesearch = preg_quote(basename($modulesubdir),'/').'[^\-]+';
   734| 		$file_list=dol_dir_list($filedir, 'files', 0, $filterforfilesearch, '\.meta$|\.png$');	// Get list of files starting with name of ref (but not followed by "-" to discard uploaded files)
   735| 		$out.= '<!-- html.formfile::getDocumentsLink -->'."\n";
   736| 		if (! empty($file_list))
   737| 		{
   738| 			$out='<dl class="dropdown inline-block">
   739|     			<dt><a data-ajax="false" href="#" onClick="return false;">'.img_picto('', 'listlight', '', 0, 0, 0, '', 'valignbottom').'</a></dt>
   740|     			<dd><div class="multichoicedoc" style="position:absolute;left:100px;" ><ul class="ulselectedfields" style="display: none;">';
   741| 			$tmpout='';
   742| 			$found=0;
   743| 			foreach($file_list as $file)
   744| 			{
   745| 				$i++;
   746| 				if ($filter && ! preg_match('/'.$filter.'/i', $file["name"])) continue;	// Discard this. It does not match provided filter.
   747| 				$found++;
   748| 				$relativepath=$file["name"];								// Cas general
   749| 				if ($modulesubdir) $relativepath=$modulesubdir."/".$file["name"];	// Cas propal, facture...
   750| 				if ($modulepart == 'donation')            {
   751| 					$relativepath = get_exdir($modulesubdir,2,0,0,null,'donation').$file["name"];
   752| 				}
   753| 				if ($modulepart == 'export')              {
   754| 					$relativepath = $file["name"];


# ====================================================================
# FILE: htdocs/core/class/smtps.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1107-1175 ---
  1107| 	/**
  1108| 	 * Retrieves the Message Content
  1109| 	 *
  1110| 	 * @return 	string			Message Content
  1111| 	 */
  1112| 	function getBodyContent()
  1113| 	{
  1114| 	    global $conf;
  1115| 		$this->_setBoundary();
  1116| 		$_types = array_keys($this->_msgContent);
  1117| 		$keyCount = count($_types);
  1118| 		if( $keyCount === 0 )
  1119| 		die ("Sorry, no content");
  1120| 		else if( $keyCount === 1 && empty($conf->global->MAIN_MAIL_USE_MULTI_PART))
  1121| 		{
  1122| 			$_msgData = $this->_msgContent;
  1123| 			$_msgData = $_msgData[$_types[0]];
  1124| 			$content = 'Content-Type: ' . $_msgData['mimeType'] . '; charset="' . $this->getCharSet() . '"' . "\r\n"
  1125| 			. 'Content-Transfer-Encoding: ' . $this->getTransEncodeType() . "\r\n"
  1126| 			. 'Content-Disposition: inline'  . "\r\n"
  1127| 			. 'Content-Description: message' . "\r\n";
  1128| 			if ( $this->getMD5flag() )
  1129| 			$content .= 'Content-MD5: ' . $_msgData['md5'] . "\r\n";
  1130| 			$content .= "\r\n"
  1131| 			.  $_msgData['data'] . "\r\n";
  1132| 		}
  1133| 		else if( $keyCount >= 1 || ! empty($conf->global->MAIN_MAIL_USE_MULTI_PART))
  1134| 		{
  1135| 			$content = 'Content-Type: multipart/mixed; boundary="' . $this->_getBoundary('mixed') . '"'   . "\r\n";
  1136| 			$content .= "Content-Transfer-Encoding: 8bit\r\n";
  1137| 			$content .= "\r\n";
  1138| 			$content .= "--" . $this->_getBoundary('mixed') . "\r\n";
  1139| 			if (key_exists('image', $this->_msgContent))     // If inline image found
  1140| 			{
  1141| 				$content.= 'Content-Type: multipart/alternative; boundary="'.$this->_getBoundary('alternative').'"' . "\r\n";
  1142| 				$content .= "\r\n";
  1143| 				$content .= "--" . $this->_getBoundary('alternative') . "\r\n";
  1144| 			}
  1145| 			foreach ($this->_msgContent as $type => $_content )
  1146| 			{
  1147| 				if ( $type == 'attachment' )
  1148| 				{
  1149| 					foreach ( $_content as $_file => $_data )
  1150| 					{
  1151| 						$content .= "--" . $this->_getBoundary('mixed') . "\r\n"
  1152| 						.  'Content-Disposition: attachment; filename="' . $_data['fileName'] . '"' . "\r\n"
  1153| 						.  'Content-Type: ' . $_data['mimeType'] . '; name="' . $_data['fileName'] . '"' . "\r\n"
  1154| 						.  'Content-Transfer-Encoding: base64' . "\r\n"
  1155| 						.  'Content-Description: File Attachment' . "\r\n";
  1156| 						if ( $this->getMD5flag() )
  1157| 						$content .= 'Content-MD5: ' . $_data['md5'] . "\r\n";
  1158| 						$content .= "\r\n" .  $_data['data'] . "\r\n\r\n";
  1159| 					}
  1160| 				}
  1161| 				else if ( $type == 'image' )
  1162| 				{
  1163| 					foreach ( $_content as $_image => $_data )
  1164| 					{
  1165| 						$content .= "--" . $this->_getBoundary('related') . "\r\n";  // always related for an inline image
  1166| 						$content .= 'Content-Type: ' . $_data['mimeType'] . '; name="' . $_data['imageName'] . '"' . "\r\n"
  1167| 						.  'Content-Transfer-Encoding: base64' . "\r\n"
  1168| 						.  'Content-Disposition: inline; filename="' . $_data['imageName'] . '"' . "\r\n"
  1169| 						.  'Content-ID: <' . $_data['cid'] . '> ' . "\r\n";
  1170| 						if ( $this->getMD5flag() )
  1171| 						$content .= 'Content-MD5: ' . $_data['md5'] . "\r\n";
  1172| 						$content .= "\r\n"
  1173| 						. $_data['data'] . "\r\n";
  1174| 					}
  1175| 					$content.= "--" . $this->_getBoundary('related') . "--" . "\r\n";


# ====================================================================
# FILE: htdocs/core/lib/ajax.lib.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 361-401 ---
   361|     $msg="\n".'<!-- JS CODE TO ENABLE '.$tmpplugin.' for id = '.$htmlname.' -->
   362|           <script type="text/javascript">
   363|         	$(document).ready(function () {
   364|         		$(\''.(preg_match('/^\./',$htmlname)?$htmlname:'#'.$htmlname).'\').'.$tmpplugin.'({
   365|         		    dir: \'ltr\',
   366|         			width: \''.$widthTypeOfAutocomplete.'\',		/* off or resolve */
   367| 					minimumInputLength: '.$minLengthToAutocomplete.',
   368| 					language: select2arrayoflanguage,
   369|     				containerCssClass: \':all:\',					/* Line to add class of origin SELECT propagated to the new <span class="select2-selection...> tag */
   370| 					templateResult: function (data, container) {	/* Format visible output into combo list */
   371| 	 					/* Code to add class of origin OPTION propagated to the new select2 <li> tag */
   372| 						if (data.element) { $(container).addClass($(data.element).attr("class")); }
   373| 						if ($(data.element).attr("data-html") != undefined) return htmlEntityDecodeJs($(data.element).attr("data-html"));		// If property html set, we decode html entities and use this
   374| 					    return data.text;
   375| 					},
   376| 					templateSelection: function (selection) {		/* Format visible output of selected value */
   377| 						return selection.text;
   378| 					},
   379| 					escapeMarkup: function(markup) {
   380| 						return markup;
   381| 					}
   382| 				})';
   383| 	if ($forcefocus) $msg.= '.select2(\'focus\')';
   384| 	$msg.= ';'."\n";
   385| 	if (is_array($events) && count($events))    // If an array of js events to do were provided.
   386| 	{
   387| 		$msg.= '
   388| 			jQuery("#'.$htmlname.'").change(function () {
   389| 				var obj = '.json_encode($events).';
   390| 		   		$.each(obj, function(key,values) {
   391| 	    			if (values.method.length) {
   392| 	    				runJsCodeForEvent'.$htmlname.'(values);
   393| 	    			}
   394| 				});
   395| 			});
   396| 			function runJsCodeForEvent'.$htmlname.'(obj) {
   397| 				var id = $("#'.$htmlname.'").val();
   398| 				var method = obj.method;
   399| 				var url = obj.url;
   400| 				var htmlname = obj.htmlname;
   401| 				var showempty = obj.showempty;


# ====================================================================
# FILE: htdocs/core/lib/company.lib.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 130-170 ---
   130| 		$head[$h][2] = 'resources';
   131| 		$h++;
   132| 	}
   133| 	if (! empty($conf->global->ACCOUNTING_ENABLE_LETTERING))
   134| 	{
   135| 		if (! empty($conf->accounting->enabled) && $object->client>0)
   136| 		{
   137| 			$head[$h][0] = DOL_URL_ROOT.'/accountancy/bookkeeping/thirdparty_lettrage.php?socid='.$object->id;
   138| 			$head[$h][1] = $langs->trans("TabAccountingCustomer");
   139| 			$head[$h][2] = 'accounting';
   140| 			$h++;
   141| 		}
   142| 		if (! empty($conf->accounting->enabled) && $object->fournisseur>0)
   143| 		{
   144| 			$head[$h][0] = DOL_URL_ROOT.'/accountancy/bookkeeping/thirdparty_lettrage_supplier.php?socid='.$object->id;
   145| 			$head[$h][1] = $langs->trans("TabAccountingSupplier");
   146| 			$head[$h][2] = 'accounting_supplier';
   147| 			$h++;
   148| 		}
   149| 	}
   150|     if (! empty($conf->commande->enabled) || ! empty($conf->propal->enabled) || ! empty($conf->facture->enabled) || ! empty($conf->fichinter->enabled) || ! empty($conf->fournisseur->enabled))
   151|     {
   152|         $head[$h][0] = DOL_URL_ROOT.'/societe/consumption.php?socid='.$object->id;
   153|         $head[$h][1] = $langs->trans("Referers");
   154|         $head[$h][2] = 'consumption';
   155|         $h++;
   156|     }
   157|     if (empty($conf->global->SOCIETE_DISABLE_BANKACCOUNT))
   158|     {
   159|         $langs->load("banks");
   160|         $nbBankAccount=0;
   161|         $head[$h][0] = DOL_URL_ROOT .'/societe/rib.php?socid='.$object->id;
   162|         $head[$h][1] = $langs->trans("BankAccounts");
   163|         $sql = "SELECT COUNT(n.rowid) as nb";
   164|         $sql.= " FROM ".MAIN_DB_PREFIX."societe_rib as n";
   165|         $sql.= " WHERE fk_soc = ".$object->id;
   166|         $resql=$db->query($sql);
   167|         if ($resql)
   168|         {
   169|             $num = $db->num_rows($resql);
   170|             $i = 0;

# --- HUNK 2: Lines 627-750 ---
   627|         print '</div>';
   628|         print "<br>\n";
   629|     }
   630|     return $i;
   631| }
   632| /**
   633|  * 		Show html area for list of contacts
   634|  *
   635|  *		@param	Conf		$conf		Object conf
   636|  * 		@param	Translate	$langs		Object langs
   637|  * 		@param	DoliDB		$db			Database handler
   638|  * 		@param	Societe		$object		Third party object
   639|  *      @param  string		$backtopage	Url to go once contact is created
   640|  *      @return	void
   641|  */
   642| function show_contacts($conf,$langs,$db,$object,$backtopage='')
   643| {
   644| 	global $user,$conf,$extrafields,$hookmanager;
   645| 	global $contextpage;
   646|     $form = new Form($db);
   647|     $sortfield = GETPOST("sortfield",'alpha');
   648|     $sortorder = GETPOST("sortorder",'alpha');
   649|     $page = GETPOST('page','int');
   650|     $search_status		= GETPOST("search_status",'int');
   651|     if ($search_status=='') $search_status=1; // always display activ customer first
   652|     $search_name = GETPOST("search_name",'alpha');
   653|     $search_addressphone = GETPOST("search_addressphone",'alpha');
   654|     if (! $sortorder) $sortorder="ASC";
   655|     if (! $sortfield) $sortfield="t.lastname";
   656|     if (! empty($conf->clicktodial->enabled))
   657|     {
   658|     	$user->fetch_clicktodial(); // lecture des infos de clicktodial du user
   659|     }
   660|     $contactstatic = new Contact($db);
   661|     $extralabels=$extrafields->fetch_name_optionals_label($contactstatic->table_element);
   662|     $contactstatic->fields=array(
   663|     'name'      =>array('type'=>'varchar(128)', 'label'=>'Name',             'enabled'=>1, 'visible'=>1,  'notnull'=>1,  'showoncombobox'=>1, 'index'=>1, 'position'=>10, 'searchall'=>1),
   664|     'poste'     =>array('type'=>'varchar(128)', 'label'=>'PostOfFunction',   'enabled'=>1, 'visible'=>1,  'notnull'=>1,  'showoncombobox'=>1, 'index'=>1, 'position'=>20),
   665|     'address'   =>array('type'=>'varchar(128)', 'label'=>'Address',          'enabled'=>1, 'visible'=>1,  'notnull'=>1,  'showoncombobox'=>1, 'index'=>1, 'position'=>30),
   666|     'statut'    =>array('type'=>'integer',      'label'=>'Status',           'enabled'=>1, 'visible'=>1,  'notnull'=>1, 'default'=>0, 'index'=>1,  'position'=>40, 'arrayofkeyval'=>array(0=>$contactstatic->LibStatut(0,1), 1=>$contactstatic->LibStatut(1,1))),
   667|     );
   668|     $arrayfields=array(
   669|     't.rowid'=>array('label'=>"TechnicalID", 'checked'=>($conf->global->MAIN_SHOW_TECHNICAL_ID?1:0), 'enabled'=>($conf->global->MAIN_SHOW_TECHNICAL_ID?1:0), 'position'=>1),
   670|     't.name'=>array('label'=>"Name", 'checked'=>1, 'position'=>10),
   671|     't.poste'=>array('label'=>"PostOrFunction", 'checked'=>1, 'position'=>20),
   672|     't.address'=>array('label'=>(empty($conf->dol_optimize_smallscreen) ? $langs->trans("Address").' / '.$langs->trans("Phone").' / '.$langs->trans("Email") : $langs->trans("Address")), 'checked'=>1, 'position'=>30),
   673|     't.statut'=>array('label'=>"Status", 'checked'=>1, 'position'=>40, 'align'=>'center'),
   674|     );
   675|     if (is_array($extrafields->attributes[$contactstatic->table_element]['label']) && count($extrafields->attributes[$contactstatic->table_element]['label']))
   676|     {
   677|     	foreach($extrafields->attributes[$contactstatic->table_element]['label'] as $key => $val)
   678|     	{
   679|     		if (! empty($extrafields->attributes[$contactstatic->table_element]['list'][$key])) $arrayfields["ef.".$key]=array('label'=>$extrafields->attributes[$contactstatic->table_element]['label'][$key], 'checked'=>(($extrafields->attributes[$contactstatic->table_element]['list'][$key]<0)?0:1), 'position'=>$extrafields->attributes[$contactstatic->table_element]['pos'][$key], 'enabled'=>(abs($extrafields->attributes[$contactstatic->table_element]['list'][$key])!=3 && $extrafields->attributes[$contactstatic->table_element]['perms'][$key]));
   680|     	}
   681|     }
   682|     $search=array();
   683|     foreach($contactstatic->fields as $key => $val)
   684|     {
   685|     	if (GETPOST('search_'.$key,'alpha')) $search[$key]=GETPOST('search_'.$key,'alpha');
   686|     }
   687|     if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') ||GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
   688|     {
   689|     	$search_status		 = '';
   690|     	$search_name         = '';
   691|     	$search_addressphone = '';
   692|     	$search_array_options=array();
   693|     	foreach($contactstatic->fields as $key => $val)
   694|    		{
   695|    			$search[$key]='';
   696|    		}
   697|    		$toselect='';
   698|     }
   699|     $contactstatic->fields = dol_sort_array($contactstatic->fields, 'position');
   700|     $arrayfields = dol_sort_array($arrayfields, 'position');
   701|     $buttoncreate='';
   702|     if ($user->rights->societe->contact->creer)
   703|     {
   704|     	$addcontact = (! empty($conf->global->SOCIETE_ADDRESSES_MANAGEMENT) ? $langs->trans("AddContact") : $langs->trans("AddContactAddress"));
   705| 		$buttoncreate='<a class="addnewrecord" href="'.DOL_URL_ROOT.'/contact/card.php?socid='.$object->id.'&amp;action=create&amp;backtopage='.urlencode($backtopage).'">'.$addcontact;
   706| 		$buttoncreate.='</a>'."\n";
   707|     }
   708|     print "\n";
   709|     $title = (! empty($conf->global->SOCIETE_ADDRESSES_MANAGEMENT) ? $langs->trans("ContactsForCompany") : $langs->trans("ContactsAddressesForCompany"));
   710|     print load_fiche_titre($title, $buttoncreate,'');
   711|     print '<form method="POST" action="'.$_SERVER["PHP_SELF"].'" name="formfilter">';
   712|     print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
   713|     print '<input type="hidden" name="socid" value="'.$object->id.'">';
   714|     print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
   715|     print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
   716|     print '<input type="hidden" name="page" value="'.$page.'">';
   717|     $varpage=empty($contextpage)?$_SERVER["PHP_SELF"]:$contextpage;
   718|     $selectedfields=$form->multiSelectArrayWithCheckbox('selectedfields', $arrayfields, $varpage);	// This also change content of $arrayfields
   719| 	print '<div class="div-table-responsive">';		// You can use div-table-responsive-no-min if you dont need reserved height for your table
   720|     print "\n".'<table class="tagtable liste">'."\n";
   721|     $param="socid=".$object->id;
   722|     if ($search_status != '') $param.='&amp;search_status='.$search_status;
   723|     if ($search_name != '') $param.='&amp;search_name='.urlencode($search_name);
   724|     $sql = "SELECT t.rowid, t.lastname, t.firstname, t.fk_pays as country_id, t.civility, t.poste, t.phone as phone_pro, t.phone_mobile, t.phone_perso, t.fax, t.email, t.skype, t.statut, t.photo,";
   725|     $sql .= " t.civility as civility_id, t.address, t.zip, t.town";
   726|     $sql .= " FROM ".MAIN_DB_PREFIX."socpeople as t";
   727|     $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."socpeople_extrafields as ef on (t.rowid = ef.fk_object)";
   728|     $sql .= " WHERE t.fk_soc = ".$object->id;
   729|     if ($search_status!='' && $search_status != '-1') $sql .= " AND t.statut = ".$db->escape($search_status);
   730|     if ($search_name)       $sql .= " AND (t.lastname LIKE '%".$db->escape($search_name)."%' OR t.firstname LIKE '%".$db->escape($search_name)."%')";
   731|     if ($sortfield == "t.name") $sql.=" ORDER BY t.lastname $sortorder, t.firstname $sortorder";
   732|     else $sql.= " ORDER BY $sortfield $sortorder";
   733|     dol_syslog('core/lib/company.lib.php :: show_contacts', LOG_DEBUG);
   734|     $result = $db->query($sql);
   735|     if (! $result) dol_print_error($db);
   736|     $num = $db->num_rows($result);
   737|     print '<tr class="liste_titre">';
   738|     foreach($contactstatic->fields as $key => $val)
   739|     {
   740|     	$align='';
   741|     	if (in_array($val['type'], array('date','datetime','timestamp'))) $align.=($align?' ':'').'center';
   742|     	if (in_array($val['type'], array('timestamp'))) $align.=($align?' ':'').'nowrap';
   743|     	if ($key == 'status' || $key == 'statut') $align.=($align?' ':'').'center';
   744|     	if (! empty($arrayfields['t.'.$key]['checked']))
   745|     	{
   746|     		print '<td class="liste_titre'.($align?' '.$align:'').'">';
   747|     		if (in_array($key, array('lastname','name'))) print '<input type="text" class="flat maxwidth75" name="search_'.$key.'" value="'.dol_escape_htmltag($search[$key]).'">';
   748|     		elseif (in_array($key, array('statut'))) print $form->selectarray('search_status', array('-1'=>'','0'=>$contactstatic->LibStatut(0,1),'1'=>$contactstatic->LibStatut(1,1)),$search_status);
   749|     		print '</td>';
   750|     	}

# --- HUNK 3: Lines 833-873 ---
   833|             {
   834|             	print '<td>';
   835| 	            print $contactstatic->getBannerAddress('contact', $object);
   836|     	        print '</td>';
   837|             }
   838|             if (! empty($arrayfields['t.statut']['checked']))
   839|             {
   840|             	print '<td align="center">'.$contactstatic->getLibStatut(5).'</td>';
   841|             }
   842|             $extrafieldsobjectkey='socpeople';
   843|             include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_print_fields.tpl.php';
   844| 			print '<td align="right">';
   845|             if (! empty($conf->agenda->enabled) && $user->rights->agenda->myactions->create)
   846|             {
   847|                 print '<a href="'.DOL_URL_ROOT.'/comm/action/card.php?action=create&actioncode=&contactid='.$obj->rowid.'&socid='.$object->id.'&backtopage='.urlencode($backtopage).'">';
   848|                 print img_object($langs->trans("Event"),"action");
   849|                 print '</a> &nbsp; ';
   850|             }
   851|             if ($user->rights->societe->contact->creer)
   852|             {
   853|                 print '<a href="'.DOL_URL_ROOT.'/contact/card.php?action=edit&amp;id='.$obj->rowid.'&amp;backtopage='.urlencode($backtopage).'">';
   854|                 print img_edit();
   855|                 print '</a>';
   856|             }
   857|             print '</td>';
   858|             print "</tr>\n";
   859|             $i++;
   860|         }
   861|     }
   862|     else
   863| 	{
   864| 		$colspan=1;
   865| 		foreach($arrayfields as $key => $val) { if (! empty($val['checked'])) $colspan++; }
   866| 		print '<tr><td colspan="'.$colspan.'" class="opacitymedium">'.$langs->trans("None").'</td></tr>';
   867|     }
   868|     print "\n</table>\n";
   869| 	print '</div>';
   870|     print '</form>'."\n";
   871|     return $i;
   872| }
   873| /**

# --- HUNK 4: Lines 1187-1227 ---
  1187|         $out.=$searchpicto;
  1188|         $out.='</td>';
  1189|         $out.='</tr>';
  1190|         $out.='<tr class="liste_titre">';
  1191| 		if ($donetodo)
  1192| 		{
  1193|             $tmp='';
  1194|             if (get_class($filterobj) == 'Societe') $tmp.='<a href="'.DOL_URL_ROOT.'/comm/action/list.php?socid='.$filterobj->id.'&amp;status=done">';
  1195|             $tmp.=($donetodo != 'done' ? $langs->trans("ActionsToDoShort") : '');
  1196|             $tmp.=($donetodo != 'done' && $donetodo != 'todo' ? ' / ' : '');
  1197|             $tmp.=($donetodo != 'todo' ? $langs->trans("ActionsDoneShort") : '');
  1198|             if (get_class($filterobj) == 'Societe') $tmp.='</a>';
  1199|             $out.=getTitleFieldOfList($tmp);
  1200| 		}
  1201| 		$out.=getTitleFieldOfList($langs->trans("Ref"), 0, $_SERVER["PHP_SELF"], 'a.id', '', $param, '', $sortfield, $sortorder);
  1202| 		$out.=getTitleFieldOfList($langs->trans("Owner"));
  1203|         $out.=getTitleFieldOfList($langs->trans("Type"));
  1204| 		$out.=getTitleFieldOfList($langs->trans("Label"), 0, $_SERVER["PHP_SELF"], '', '', $param, '', $sortfield, $sortorder);
  1205|         $out.=getTitleFieldOfList($langs->trans("Date"), 0, $_SERVER["PHP_SELF"], 'a.datep,a.id', '', $param, 'align="center"', $sortfield, $sortorder);
  1206| 		$out.=getTitleFieldOfList('');
  1207| 		$out.=getTitleFieldOfList('');
  1208| 		$out.=getTitleFieldOfList($langs->trans("Status"), 0, $_SERVER["PHP_SELF"], 'a.percent', '', $param, 'align="center"', $sortfield, $sortorder);
  1209| 		$out.=getTitleFieldOfList('', 0, $_SERVER["PHP_SELF"], '', '', $param, '', $sortfield, $sortorder, 'maxwidthsearch ');
  1210| 		$out.='</tr>';
  1211|         foreach ($histo as $key=>$value)
  1212|         {
  1213| 			$actionstatic->fetch($histo[$key]['id']);    // TODO Do we need this, we already have a lot of data of line into $histo
  1214|             $out.='<tr class="oddeven">';
  1215|             if ($donetodo)
  1216|             {
  1217|                 $out.='<td class="nowrap">';
  1218|                 $out.='</td>';
  1219|             }
  1220|             $out.='<td class="nowrap">';
  1221|             $out.=$actionstatic->getNomUrl(1, -1);
  1222|             $out.='</td>';
  1223|             $out.='<td>';
  1224|             if ($histo[$key]['userid'] > 0)
  1225|             {
  1226|             	$userstatic->fetch($histo[$key]['userid']);
  1227|             	$out.=$userstatic->getNomUrl(-1);

# --- HUNK 5: Lines 1295-1335 ---
  1295|                     if ($orderstatic->fetch($histo[$key]['fk_element'])>0) {
  1296|                         $orderstatic->type=$histo[$key]['ftype'];
  1297|                         $out.=$orderstatic->getNomUrl(1);
  1298|                     } else {
  1299|                         $out.= $langs->trans("OrderDeleted");
  1300|                     }
  1301|              	}
  1302|             	elseif (($histo[$key]['elementtype'] == 'invoice' || $histo[$key]['elementtype'] == 'facture') && ! empty($conf->facture->enabled))
  1303|             	{
  1304|                     if ($facturestatic->fetch($histo[$key]['fk_element'])>0) {
  1305|                         $facturestatic->type=$histo[$key]['ftype'];
  1306|                         $out.=$facturestatic->getNomUrl(1,'compta');
  1307|                     } else {
  1308|                         $out.= $langs->trans("InvoiceDeleted");
  1309|                     }
  1310|             	}
  1311|             	else $out.='&nbsp;';
  1312|             }
  1313|             else $out.='&nbsp;';
  1314|             $out.='</td>';
  1315|             if (! empty($objcon->id) && isset($histo[$key]['contact_id']) && $histo[$key]['contact_id'] > 0)
  1316|             {
  1317|                 $contactstatic->lastname=$histo[$key]['lastname'];
  1318|                 $contactstatic->firstname=$histo[$key]['firstname'];
  1319|                 $contactstatic->id=$histo[$key]['contact_id'];
  1320|                 $out.='<td width="120">'.$contactstatic->getNomUrl(1,'',10).'</td>';
  1321|             }
  1322|             else
  1323|             {
  1324|                 $out.='<td>&nbsp;</td>';
  1325|             }
  1326|             $out.='<td class="nowrap" align="center">'.$actionstatic->LibStatut($histo[$key]['percent'],3,0,$histo[$key]['datestart']).'</td>';
  1327|             $out.='<td></td>';
  1328|             $out.="</tr>\n";
  1329|             $i++;
  1330|         }
  1331|         $out.="</table>\n";
  1332|         $out.="</div>\n";
  1333|     }
  1334|     $out.='</form>';
  1335|     if ($noprint) return $out;


# ====================================================================
# FILE: htdocs/core/lib/functions.lib.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| /* Copyright (C) 2000-2007	Rodolphe Quiedeville			<rodolphe@quiedeville.org>
     3|  * Copyright (C) 2003		Jean-Louis Bergamo			<jlb@j1b.org>
     4|  * Copyright (C) 2004-2013	Laurent Destailleur			<eldy@users.sourceforge.net>
     5|  * Copyright (C) 2004		Sebastien Di Cintio			<sdicintio@ressource-toi.org>
     6|  * Copyright (C) 2004		Benoit Mortier				<benoit.mortier@opensides.be>
     7|  * Copyright (C) 2004		Christophe Combelles			<ccomb@free.fr>
     8|  * Copyright (C) 2005-2017	Regis Houssin				<regis.houssin@capnetworks.com>
     9|  * Copyright (C) 2008		Raphael Bertrand (Resultic)	<raphael.bertrand@resultic.fr>
    10|  * Copyright (C) 2010-2016	Juanjo Menent				<jmenent@2byte.es>
    11|  * Copyright (C) 2013		Cdric Salvador				<csalvador@gpcsolutions.fr>
    12|  * Copyright (C) 2013-2017	Alexandre Spangaro			<aspangaro@zendsi.com>
    13|  * Copyright (C) 2014		Cdric GROSS					<c.gross@kreiz-it.fr>
    14|  * Copyright (C) 2014-2015	Marcos Garca				<marcosgdf@gmail.com>
    15|  * Copyright (C) 2015		Jean-Franois Ferry			<jfefe@aternatik.fr>
    16|  *
    17|  * This program is free software; you can redistribute it and/or modify
    18|  * it under the terms of the GNU General Public License as published by
    19|  * the Free Software Foundation; either version 3 of the License, or
    20|  * (at your option) any later version.
    21|  *
    22|  * This program is distributed in the hope that it will be useful,
    23|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    24|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    25|  * GNU General Public License for more details.
    26|  *
    27|  * You should have received a copy of the GNU General Public License
    28|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    29|  * or see http://www.gnu.org/
    30|  */

# --- HUNK 2: Lines 463-524 ---
   463| 		case 'san_alpha':
   464| 			$out=filter_var($out,FILTER_SANITIZE_STRING);
   465| 			break;
   466| 		case 'aZ':
   467| 			if (! is_array($out))
   468| 			{
   469| 				$out=trim($out);
   470| 				if (preg_match('/[^a-z]+/i',$out)) $out='';
   471| 			}
   472| 			break;
   473| 		case 'aZ09':
   474| 			if (! is_array($out))
   475| 			{
   476| 				$out=trim($out);
   477| 				if (preg_match('/[^a-z0-9_\-\.]+/i',$out)) $out='';
   478| 			}
   479| 			break;
   480| 		case 'array':
   481| 			if (! is_array($out) || empty($out)) $out=array();
   482| 			break;
   483| 		case 'nohtml':
   484| 			$out=dol_string_nohtmltag($out, 0);
   485| 			break;
   486| 		case 'alphanohtml':	// Recommended for search params
   487| 			if (! is_array($out))
   488| 			{
   489| 				$out=trim($out);
   490| 				if (preg_match('/"/',$out)) $out='';
   491| 				else if (preg_match('/\.\.\//',$out)) $out='';
   492| 				$out=dol_string_nohtmltag($out);
   493| 			}
   494| 			break;
   495| 		case 'custom':
   496| 			if (empty($filter)) return 'BadFourthParameterForGETPOST';
   497| 			$out=filter_var($out, $filter, $options);
   498| 			break;
   499| 	}
   500| 	if (empty($method) || $method == 3 || $method == 4)
   501| 	{
   502| 		if (preg_match('/^search_/', $paramname) || in_array($paramname, array('sortorder','sortfield')))
   503| 		{
   504| 			if (! empty($out))
   505| 			{
   506| 				$user->lastsearch_values_tmp[$relativepathstring][$paramname]=$out;
   507| 			}
   508| 		}
   509| 	}
   510| 	return $out;
   511| }
   512| /**
   513|  *  Return a prefix to use for this Dolibarr instance, for session/cookie names or email id.
   514|  *  This prefix is valid in a web context only and is unique for instance and avoid conflict
   515|  *  between multi-instances, even when having two instances with one root dir or two instances
   516|  *  in virtual servers.
   517|  *
   518|  *  @param  string  $mode       			'' (prefix for session name) or 'email' (prefix for email id)
   519|  *  @return	string      					A calculated prefix
   520|  */
   521| if (! function_exists('dol_getprefix'))
   522| {
   523| 	function dol_getprefix($mode='')
   524| 	{

# --- HUNK 3: Lines 3580-3620 ---
  3580| 	/*if ($thirdparty_buyer->country_code != $thirdparty_seller->country_code)
  3581| 	{
  3582| 		return 0;
  3583| 	}*/
  3584| 	if ($mysoc->country_code == 'ES') // For spain localtaxes 1 and 2, tax is qualified if buyer use local tax
  3585| 	{
  3586| 		if ($local == 1)
  3587| 		{
  3588| 			if (! $mysoc->localtax1_assuj || (string) $vatratecleaned == "0") return 0;
  3589| 			if ($thirdparty_seller->id == $mysoc->id)
  3590| 			{
  3591| 				if (! $thirdparty_buyer->localtax1_assuj) return 0;
  3592| 			}
  3593| 			else
  3594| 			{
  3595| 				if (! $thirdparty_seller->localtax1_assuj) return 0;
  3596| 			}
  3597| 		}
  3598| 		if ($local == 2)
  3599| 		{
  3600| 			if (! $mysoc->localtax2_assuj || (string) $vatratecleaned == "0") return 0;
  3601| 			if ($thirdparty_seller->id == $mysoc->id)
  3602| 			{
  3603| 				if (! $thirdparty_buyer->localtax2_assuj) return 0;
  3604| 			}
  3605| 			else
  3606| 			{
  3607| 				if (! $thirdparty_seller->localtax2_assuj) return 0;
  3608| 			}
  3609| 		}
  3610| 	}
  3611| 	else
  3612| 	{
  3613| 		if ($local == 1 && ! $thirdparty_seller->localtax1_assuj) return 0;
  3614| 		if ($local == 2 && ! $thirdparty_seller->localtax2_assuj) return 0;
  3615| 	}
  3616| 	if (in_array($mysoc->country_code, array('ES')))
  3617| 	{
  3618| 		$conf->global->MAIN_GET_LOCALTAXES_VALUES_FROM_THIRDPARTY = 1;
  3619| 	}
  3620| 	if (! empty($conf->global->MAIN_GET_LOCALTAXES_VALUES_FROM_THIRDPARTY))

# --- HUNK 4: Lines 3630-3670 ---
  3630| 			}
  3631| 			else  // i am the seller
  3632| 			{
  3633| 				if (!isOnlyOneLocalTax($local))  // TODO If seller is me, why not always returning this, even if there is only one locatax vat.
  3634| 				{
  3635| 					return $conf->global->MAIN_INFO_VALUE_LOCALTAX1;
  3636| 				}
  3637| 			}
  3638| 		}
  3639| 		if ($local==2)
  3640| 		{
  3641| 			if ($thirdparty_seller != $mysoc)
  3642| 			{
  3643| 				if (!isOnlyOneLocalTax($local))  // TODO We should provide $vatrate to search on correct line and not always on line with highest vat rate
  3644| 				{
  3645| 					return $thirdparty_seller->localtax2_value;
  3646| 				}
  3647| 			}
  3648| 			else  // i am the seller
  3649| 			{
  3650| 				if (!isOnlyOneLocalTax($local))  // This is for spain only, we don't return value found into datbase even if there is only one locatax vat.
  3651| 				{
  3652| 					return $conf->global->MAIN_INFO_VALUE_LOCALTAX2;
  3653| 				}
  3654| 			}
  3655| 		}
  3656| 	}
  3657| 	$sql  = "SELECT t.localtax1, t.localtax2, t.localtax1_type, t.localtax2_type";
  3658|    	$sql .= " FROM ".MAIN_DB_PREFIX."c_tva as t, ".MAIN_DB_PREFIX."c_country as c";
  3659|    	$sql .= " WHERE t.fk_pays = c.rowid AND c.code = '".$thirdparty_seller->country_code."'";
  3660|    	$sql .= " AND t.taux = ".((float) $vatratecleaned)." AND t.active = 1";
  3661|    	if ($vatratecode) $sql.= " AND t.code ='".$vatratecode."'";		// If we have the code, we use it in priority
  3662|    	else $sql.= " AND t.recuperableonly ='".$vatnpr."'";
  3663|    	dol_syslog("get_localtax", LOG_DEBUG);
  3664|    	$resql=$db->query($sql);
  3665|    	if ($resql)
  3666|    	{
  3667|    		$obj = $db->fetch_object($resql);
  3668|    		if ($local==1) return $obj->localtax1;
  3669|    		elseif ($local==2) return $obj->localtax2;
  3670| 	}

# --- HUNK 5: Lines 3785-3868 ---
  3785| 	{
  3786| 		$vatratecleaned = $vatrate;
  3787| 		$vatratecode = '';
  3788| 		if (preg_match('/^(.*)\s*\((.*)\)$/', $vatrate, $reg))      // If vat is "xx (yy)"
  3789| 		{
  3790| 			$vatratecleaned = $reg[1];
  3791| 			$vatratecode = $reg[2];
  3792| 		}
  3793| 		$sql.=", ".MAIN_DB_PREFIX."c_country as c";
  3794| 		if ($mysoc->country_code == 'ES') $sql .= " WHERE t.fk_pays = c.rowid AND c.code = '".$buyer->country_code."'";    // local tax in spain use the buyer country ??
  3795| 		else $sql .= " WHERE t.fk_pays = c.rowid AND c.code = '".$seller->country_code."'";
  3796| 		$sql.= " AND t.taux = ".((float) $vatratecleaned)." AND t.active = 1";
  3797| 		if ($vatratecode) $sql.= " AND t.code = '".$vatratecode."'";
  3798| 	}
  3799| 	$resql=$db->query($sql);
  3800| 	if ($resql)
  3801| 	{
  3802| 		$obj = $db->fetch_object($resql);
  3803| 		if ($local == 1)
  3804| 		{
  3805| 			if (! isOnlyOneLocalTax(1))
  3806| 			{
  3807| 				return array($obj->localtax1_type, get_localtax($vatrate, $local, $buyer, $seller), $obj->accountancy_code_sell, $obj->accountancy_code_buy);
  3808| 			}
  3809| 			else
  3810| 			{
  3811| 				return array($obj->localtax1_type, $obj->localtax1,$obj->accountancy_code_sell, $obj->accountancy_code_buy);
  3812| 			}
  3813| 		}
  3814| 		elseif ($local == 2)
  3815| 		{
  3816| 			if (! isOnlyOneLocalTax(2))
  3817| 			{
  3818| 				return array($obj->localtax2_type, get_localtax($vatrate, $local, $buyer, $seller),$obj->accountancy_code_sell, $obj->accountancy_code_buy);
  3819| 			}
  3820| 			else
  3821| 			{
  3822| 				return array($obj->localtax2_type, $obj->localtax2,$obj->accountancy_code_sell, $obj->accountancy_code_buy);
  3823| 			}
  3824| 		}
  3825| 		else
  3826| 		{
  3827| 			if(! isOnlyOneLocalTax(1))
  3828| 			{
  3829| 				if(! isOnlyOneLocalTax(2))
  3830| 				{
  3831| 					return array($obj->localtax1_type, get_localtax($vatrate, 1, $buyer, $seller), $obj->localtax2_type, get_localtax($vatrate, 2, $buyer, $seller), $obj->accountancy_code_sell,$obj->accountancy_code_buy);
  3832| 				}
  3833| 				else
  3834| 				{
  3835| 					return array($obj->localtax1_type, get_localtax($vatrate, 1, $buyer, $seller), $obj->localtax2_type, $obj->localtax2, $obj->accountancy_code_sell, $obj->accountancy_code_buy);
  3836| 				}
  3837| 			}
  3838| 			else
  3839| 			{
  3840| 				if(! isOnlyOneLocalTax(2))
  3841| 				{
  3842| 					return array($obj->localtax1_type, $obj->localtax1, $obj->localtax2_type, get_localtax($vatrate, 2, $buyer, $seller), $obj->accountancy_code_sell, $obj->accountancy_code_buy);
  3843| 				}
  3844| 				else
  3845| 				{
  3846| 					return array($obj->localtax1_type, $obj->localtax1, $obj->localtax2_type, $obj->localtax2, $obj->accountancy_code_sell, $obj->accountancy_code_buy);
  3847| 				}
  3848| 			}
  3849| 		}
  3850| 	}
  3851| 	return 0;
  3852| }
  3853| /**
  3854|  *	Return vat rate of a product in a particular selling country or default country vat if product is unknown
  3855|  *  Function called by get_default_tva
  3856|  *
  3857|  *  @param	int			$idprod          	Id of product or 0 if not a predefined product
  3858|  *  @param  Societe		$thirdparty_seller  Thirdparty with a ->country_code defined (FR, US, IT, ...)
  3859|  *	@param	int			$idprodfournprice	Id product_fournisseur_price (for "supplier" order/invoice)
  3860|  *  @return float|string   				    Vat rate to use with format 5.0 or '5.0 (XXX)'
  3861|  *  @see get_product_localtax_for_country
  3862|  */
  3863| function get_product_vat_for_country($idprod, $thirdparty_seller, $idprodfournprice=0)
  3864| {
  3865| 	global $db,$conf,$mysoc;
  3866| 	require_once DOL_DOCUMENT_ROOT . '/product/class/product.class.php';
  3867| 	$ret=0;
  3868| 	$found=0;

# --- HUNK 6: Lines 4768-4809 ---
  4768| 		{
  4769| 			$substitutionarray['__SIGNATURE__'] = (string) (($signature && empty($conf->global->MAIN_MAIL_DO_NOT_USE_SIGN)) ? ($onlykey == 2 ? dol_trunc(dol_string_nohtmltag($signature), 30) : $signature) : '');
  4770| 		}
  4771| 		$substitutionarray=array_merge($substitutionarray, array(
  4772| 			'__USER_ID__' => (string) $user->id,
  4773| 			'__USER_LOGIN__' => (string) $user->login,
  4774| 			'__USER_LASTNAME__' => (string) $user->lastname,
  4775| 			'__USER_FIRSTNAME__' => (string) $user->firstname,
  4776| 			'__USER_FULLNAME__' => (string) $user->getFullName($outputlangs),
  4777| 			'__USER_SUPERVISOR_ID__' => (string) ($user->fk_user ? $user->fk_user : '0')
  4778| 			)
  4779| 		);
  4780| 	}
  4781| 	if (! empty($conf->multicompany->enabled))
  4782| 	{
  4783| 		$substitutionarray=array_merge($substitutionarray, array('__ENTITY_ID__' => $conf->entity));
  4784| 	}
  4785| 	return $substitutionarray;
  4786| }
  4787| /**
  4788|  *  Make substitution into a text string, replacing keys with vals from $substitutionarray (oldval=>newval).
  4789|  *  Texts like __(TranslationKey|langfile)__ and __[ConstantKey]__ are also replaced.
  4790|  *  Example of usage:
  4791|  *  $substitutionarray = getCommonSubstitutionArray($langs, 0, null, $thirdparty);
  4792|  *  complete_substitutions_array($substitutionarray, $langs, $thirdparty);
  4793|  *  $mesg = make_substitutions($mesg, $substitutionarray, $langs);
  4794|  *
  4795|  *  @param	string		$text	      			Source string in which we must do substitution
  4796|  *  @param  array		$substitutionarray		Array with key->val to substitute. Example: array('__MYKEY__' => 'MyVal', ...)
  4797|  *  @param	Translate	$outputlangs			Output language
  4798|  * 	@return string  		    				Output string after substitutions
  4799|  *  @see	complete_substitutions_array
  4800|  */
  4801| function make_substitutions($text, $substitutionarray, $outputlangs=null)
  4802| {
  4803| 	global $conf, $langs;
  4804| 	if (! is_array($substitutionarray)) return 'ErrorBadParameterSubstitutionArrayWhenCalling_make_substitutions';
  4805| 	if (empty($outputlangs)) $outputlangs=$langs;
  4806| 	if (is_object($outputlangs))
  4807| 	{
  4808| 		while (preg_match('/__\(([^\)]+)\)__/', $text, $reg))
  4809| 		{

# --- HUNK 7: Lines 4912-4952 ---
  4912| 		$out.= ($withparenthesis?' (':'').$outputlangs->transnoentitiesnoconv('DateFrom',dol_print_date($date_start, $format, false, $outputlangs)).($withparenthesis?')':'');
  4913| 	}
  4914| 	if (! $date_start && $date_end)
  4915| 	{
  4916| 		$out.= ($withparenthesis?' (':'').$outputlangs->transnoentitiesnoconv('DateUntil',dol_print_date($date_end, $format, false, $outputlangs)).($withparenthesis?')':'');
  4917| 	}
  4918| 	return $out;
  4919| }
  4920| /**
  4921|  * Return firstname and lastname in correct order
  4922|  *
  4923|  * @param	string	$firstname		Firstname
  4924|  * @param	string	$lastname		Lastname
  4925|  * @param	int		$nameorder		-1=Auto, 0=Lastname+Firstname, 1=Firstname+Lastname, 2=Firstname
  4926|  * @return	string					Firstname + lastname or Lastname + firstname
  4927|  */
  4928| function dolGetFirstLastname($firstname,$lastname,$nameorder=-1)
  4929| {
  4930| 	global $conf;
  4931| 	$ret='';
  4932| 	if ($nameorder < 0) $nameorder=(empty($conf->global->MAIN_FIRSTNAME_NAME_POSITION));
  4933| 	if ($nameorder && ((string) $nameorder != '2'))
  4934| 	{
  4935| 		$ret.=$firstname;
  4936| 		if ($firstname && $lastname) $ret.=' ';
  4937| 		$ret.=$lastname;
  4938| 	}
  4939| 	else if ($nameorder == 2)
  4940| 	{
  4941| 	   $ret.=$firstname;
  4942| 	}
  4943| 	else
  4944| 	{
  4945| 		$ret.=$lastname;
  4946| 		if ($firstname && $lastname) $ret.=' ';
  4947| 		$ret.=$firstname;
  4948| 	}
  4949| 	return $ret;
  4950| }
  4951| /**
  4952|  *	Set event message in dol_events session object. Will be output by calling dol_htmloutput_events.


# ====================================================================
# FILE: htdocs/core/lib/modulebuilder.lib.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 37-77 ---
    37|     global $db, $langs;
    38|     if (empty($objectname)) return -1;
    39|     if (empty($readdir)) $readdir=$destdir;
    40|     if (! empty($addfieldentry['arrayofkeyval']) && ! is_array($addfieldentry['arrayofkeyval']))
    41|     {
    42|     	dol_print_error('', 'Bad parameter addfieldentry with a property arrayofkeyval defined but that is not an array.');
    43|     	return -1;
    44|     }
    45|     if (count($addfieldentry) > 0)
    46|     {
    47|         if (empty($addfieldentry['name']))
    48|     	{
    49|     		setEventMessages($langs->trans('ErrorFieldRequired', $langs->transnoentitiesnoconv("Name")), null, 'errors');
    50|     		return -2;
    51|     	}
    52|         if (empty($addfieldentry['label']))
    53|     	{
    54|     		setEventMessages($langs->trans('ErrorFieldRequired', $langs->transnoentitiesnoconv("Label")), null, 'errors');
    55|     		return -2;
    56|     	}
    57|     	if (! preg_match('/^(integer|date|timestamp|varchar|double)/', $addfieldentry['type']))
    58|     	{
    59|     		setEventMessages($langs->trans('BadFormatForType', $objectname), null, 'errors');
    60|     		return -2;
    61|     	}
    62|     }
    63|     $pathoffiletoeditsrc=$readdir.'/class/'.strtolower($objectname).'.class.php';
    64|     $pathoffiletoedittarget=$destdir.'/class/'.strtolower($objectname).'.class.php'.($readdir != $destdir ? '.new' : '');
    65|     if (! dol_is_file($pathoffiletoeditsrc))
    66|     {
    67|     	$langs->load("errors");
    68|         setEventMessages($langs->trans("ErrorFileNotFound", $pathoffiletoeditsrc), null, 'errors');
    69|         return -3;
    70|     }
    71|     try
    72|     {
    73|         include_once $pathoffiletoeditsrc;
    74|         if (class_exists($objectname)) $object=new $objectname($db);
    75|         else return -4;
    76|         dol_copy($pathoffiletoedittarget, $pathoffiletoedittarget.'.back', $newmask, 1);
    77|         $contentclass = file_get_contents(dol_osencode($pathoffiletoeditsrc), 'r');

# --- HUNK 2: Lines 185-224 ---
   185|         	if (class_exists($objectname)) $object=new $objectname($db);
   186|         	else return -1;
   187|     	}
   188|     }
   189|     catch(Exception $e)
   190|     {
   191|         print $e->getMessage();
   192|     }
   193|     dol_copy($pathoffiletoedittarget, $pathoffiletoedittarget.'.back', $newmask, 1);
   194|     $contentsql = file_get_contents(dol_osencode($pathoffiletoeditsrc), 'r');
   195|     $i=0;
   196|     $texttoinsert = '-- BEGIN MODULEBUILDER FIELDS'."\n";
   197|     if (count($object->fields))
   198|     {
   199|         foreach($object->fields as $key => $val)
   200|         {
   201|             $i++;
   202|             $type = $val['type'];
   203|             $type = preg_replace('/:.*$/', '', $type);		// For case type = 'integer:Societe:societe/class/societe.class.php'
   204|             if ($type == 'html') $type = 'text';            // html modulebuilder type is a text type in database
   205|             $texttoinsert.= "\t".$key." ".$type;
   206|             if ($key == 'rowid')  $texttoinsert.= ' AUTO_INCREMENT PRIMARY KEY';
   207|             if ($key == 'entity') $texttoinsert.= ' DEFAULT 1';
   208|             else
   209|             {
   210|             	if ($val['default'] != '')
   211|             	{
   212|             		if (preg_match('/^null$/i', $val['default'])) $texttoinsert.= " DEFAULT NULL";
   213|             		else if (preg_match('/varchar/', $val['type'])) $texttoinsert.= " DEFAULT '".$db->escape($val['default'])."'";
   214|             		else $texttoinsert.= (($val['default'] > 0)?' DEFAULT '.$val['default']:'');
   215|             	}
   216|             }
   217|             $texttoinsert.= (($val['notnull'] > 0)?' NOT NULL':'');
   218|             if ($i < count($object->fields)) $texttoinsert.=", ";
   219|             $texttoinsert.= "\n";
   220|         }
   221|     }
   222|     $texttoinsert.= "\t".'-- END MODULEBUILDER FIELDS';
   223|     $contentsql = preg_replace('/-- BEGIN MODULEBUILDER FIELDS.*END MODULEBUILDER FIELDS/ims', $texttoinsert, $contentsql);
   224|     $result = file_put_contents($pathoffiletoedittarget, $contentsql);


# ====================================================================
# FILE: htdocs/core/lib/security.lib.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 300-340 ---
   300|  * @param int|string	$objectid		Object ID if we want to check a particular record (optional) is linked to a owned thirdparty (optional).
   301|  * @param string		$tableandshare	'TableName&SharedElement' with Tablename is table where object is stored. SharedElement is an optional key to define where to check entity for multicompany modume. Param not used if objectid is null (optional).
   302|  * @param string		$feature2		Feature to check, second level of permission (optional). Can be or check with 'level1|level2'.
   303|  * @param string		$dbt_keyfield	Field name for socid foreign key if not fk_soc. Not used if objectid is null (optional)
   304|  * @param string		$dbt_select		Field name for select if not rowid. Not used if objectid is null (optional)
   305|  * @return	bool						True if user has access, False otherwise
   306|  * @see restrictedArea
   307|  */
   308| function checkUserAccessToObject($user, $featuresarray, $objectid=0, $tableandshare='', $feature2='', $dbt_keyfield='', $dbt_select='rowid')
   309| {
   310| 	global $db, $conf;
   311| 	$params = explode('&', $tableandshare);
   312| 	$dbtablename=(! empty($params[0]) ? $params[0] : '');
   313| 	$sharedelement=(! empty($params[1]) ? $params[1] : $dbtablename);
   314| 	foreach ($featuresarray as $feature)
   315| 	{
   316| 		$sql='';
   317| 		if ($feature == 'member')  $feature='adherent';
   318| 		if ($feature == 'project') $feature='projet';
   319| 		if ($feature == 'task')    $feature='projet_task';
   320| 		$check = array('adherent','banque','don','user','usergroup','produit','service','produit|service','categorie','resource'); // Test on entity only (Objects with no link to company)
   321| 		$checksoc = array('societe');	 // Test for societe object
   322| 		$checkother = array('contact','agenda');	 // Test on entity and link to third party. Allowed if link is empty (Ex: contacts...).
   323| 		$checkproject = array('projet','project'); // Test for project object
   324| 		$checktask = array('projet_task');
   325| 		$nocheck = array('barcode','stock');	// No test
   326| 		$checkdefault = 'all other not already defined'; // Test on entity and link to third party. Not allowed if link is empty (Ex: invoice, orders...).
   327| 		if (empty($dbtablename))
   328| 		{
   329| 			$dbtablename = $feature;
   330| 			$sharedelement = (! empty($params[1]) ? $params[1] : $dbtablename);		// We change dbtablename, so we set sharedelement too.
   331| 		}
   332| 		if (in_array($feature,$check))
   333| 		{
   334| 			$sql = "SELECT COUNT(dbt.".$dbt_select.") as nb";
   335| 			$sql.= " FROM ".MAIN_DB_PREFIX.$dbtablename." as dbt";
   336| 			$sql.= " WHERE dbt.".$dbt_select." IN (".$objectid.")";
   337| 			if (($feature == 'user' || $feature == 'usergroup') && ! empty($conf->multicompany->enabled) && $conf->entity == 1 && $user->admin && ! $user->entity)
   338| 			{
   339| 				$sql.= " AND dbt.entity IS NOT NULL";
   340| 			}


# ====================================================================
# FILE: htdocs/core/lib/tax.lib.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 12-52 ---
    12|  * the Free Software Foundation; either version 3 of the License, or
    13|  * (at your option) any later version.
    14|  *
    15|  * This program is distributed in the hope that it will be useful,
    16|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    17|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    18|  * GNU General Public License for more details.
    19|  *
    20|  * You should have received a copy of the GNU General Public License
    21|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    22|  */
    23| /**
    24|  *      \file       htdocs/core/lib/tax.lib.php
    25|  *      \ingroup    tax
    26|  *      \brief      Library for tax module
    27|  */
    28| /**
    29|  * Prepare array with list of tabs
    30|  *
    31|  * @param   ChargeSociales	$object		Object related to tabs
    32|  * @return  array				Array of tabs to show
    33|  */
    34| function tax_prepare_head(ChargeSociales $object)
    35| {
    36|     global $db, $langs, $conf, $user;
    37|     $h = 0;
    38|     $head = array();
    39| 	$head[$h][0] = DOL_URL_ROOT.'/compta/sociales/card.php?id='.$object->id;
    40| 	$head[$h][1] = $langs->trans('Card');
    41| 	$head[$h][2] = 'card';
    42| 	$h++;
    43|     complete_head_from_modules($conf,$langs,$object,$head,$h,'tax');
    44| 	require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
    45|     require_once DOL_DOCUMENT_ROOT.'/core/class/link.class.php';
    46| 	$upload_dir = $conf->tax->dir_output . "/" . dol_sanitizeFileName($object->ref);
    47| 	$nbFiles = count(dol_dir_list($upload_dir,'files',0,'','(\.meta|_preview.*\.png)$'));
    48|     $nbLinks=Link::count($db, $object->element, $object->id);
    49| 	$head[$h][0] = DOL_URL_ROOT.'/compta/sociales/document.php?id='.$object->id;
    50| 	$head[$h][1] = $langs->trans("Documents");
    51| 	if (($nbFiles+$nbLinks) > 0) $head[$h][1].= ' <span class="badge">'.($nbFiles+$nbLinks).'</span>';
    52| 	$head[$h][2] = 'documents';

# --- HUNK 2: Lines 142-182 ---
   142|     $resql = $db->query($sql);
   143|     if ($resql)
   144|     {
   145|         while($assoc = $db->fetch_object($resql))
   146|         {
   147|             $list[] = $assoc;
   148|         }
   149|         $db->free($resql);
   150|         return $list;
   151|     }
   152|     else
   153|     {
   154|         dol_print_error($db);
   155|         return -3;
   156|     }
   157| }
   158| /**
   159|  *  Gets Tax to collect for the given year (and given quarter or month)
   160|  *  The function gets the Tax in split results, as the Tax declaration asks
   161|  *  to report the amounts for different Tax rates as different lines.
   162|  *  This function also accounts recurrent invoices.
   163|  *
   164|  *  @param	string	$type          	Tax type, either 'vat', 'localtax1' or 'localtax2'
   165|  *  @param	DoliDB	$db          	Database handler object
   166|  *  @param  int		$y           	Year
   167|  *  @param  int		$q           	Quarter
   168|  *  @param  string	$date_start  	Start date
   169|  *  @param  string	$date_end    	End date
   170|  *  @param  int		$modetax     	0 or 1 (option vat on debit)
   171|  *  @param  int		$direction   	'sell' (customer invoice) or 'buy' (supplier invoices)
   172|  *  @param  int		$m           	Month
   173|  *  @return array       			List of quarters with vat
   174|  */
   175| function tax_by_date($type, $db, $y, $q, $date_start, $date_end, $modetax, $direction, $m=0)
   176| {
   177|     global $conf;
   178|     $list=array();
   179|     if ($direction == 'sell')
   180|     {
   181|         $invoicetable='facture';
   182|         $invoicedettable='facturedet';

# --- HUNK 3: Lines 263-303 ---
   263|         if ($y && $m)
   264|         {
   265|             $sql.= " AND f.datef >= '".$db->idate(dol_get_first_day($y,$m,false))."'";
   266|             $sql.= " AND f.datef <= '".$db->idate(dol_get_last_day($y,$m,false))."'";
   267|         }
   268|         else if ($y)
   269|         {
   270|             $sql.= " AND f.datef >= '".$db->idate(dol_get_first_day($y,1,false))."'";
   271|             $sql.= " AND f.datef <= '".$db->idate(dol_get_last_day($y,12,false))."'";
   272|         }
   273|         if ($q) $sql.= " AND (date_format(f.datef,'%m') > ".(($q-1)*3)." AND date_format(f.datef,'%m') <= ".($q*3).")";
   274|         if ($date_start && $date_end) $sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
   275|         $sql.= " AND (d.product_type = 0";                              // Limit to products
   276|         $sql.= " AND d.date_start is null AND d.date_end IS NULL)";     // enhance detection of service
   277|         $sql.= " ORDER BY d.rowid, d.".$fk_facture;
   278|     }
   279|     if (! $sql) return -1;
   280|     if ($sql == 'TODO') return -2;
   281|     if ($sql != 'TODO')
   282|     {
   283|         dol_syslog("Tax.lib.php::vat_by_date", LOG_DEBUG);
   284|         $resql = $db->query($sql);
   285|         if ($resql)
   286|         {
   287|             $rate = -1;
   288|             $oldrowid='';
   289|             while($assoc = $db->fetch_array($resql))
   290|             {
   291|                 if (! isset($list[$assoc['rate']]['totalht']))  $list[$assoc['rate']]['totalht']=0;
   292|                 if (! isset($list[$assoc['rate']]['vat']))      $list[$assoc['rate']]['vat']=0;
   293|                 if (! isset($list[$assoc['rate']]['localtax1']))      $list[$assoc['rate']]['localtax1']=0;
   294|                 if (! isset($list[$assoc['rate']]['localtax2']))      $list[$assoc['rate']]['localtax2']=0;
   295|                 if ($assoc['rowid'] != $oldrowid)       // Si rupture sur d.rowid
   296|                 {
   297|                     $oldrowid=$assoc['rowid'];
   298|                     $list[$assoc['rate']]['totalht']  += $assoc['total_ht'];
   299|                     $list[$assoc['rate']]['vat']      += $assoc['total_vat'];
   300|                     $list[$assoc['rate']]['localtax1']      += $assoc['total_localtax1'];
   301|                     $list[$assoc['rate']]['localtax2']      += $assoc['total_localtax2'];
   302|                 }
   303|                 $list[$assoc['rate']]['dtotal_ttc'][] = $assoc['total_ttc'];

# --- HUNK 4: Lines 346-386 ---
   346|         $sql.= " WHERE f.entity = " . $conf->entity;
   347|         $sql.= " AND f.fk_statut in (1,2)"; // Validated or paid (partially or completely)
   348|         if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) $sql.= " AND f.type IN (0,1,2,5)";
   349| 		else $sql.= " AND f.type IN (0,1,2,3,5)";
   350|         $sql.= " AND f.rowid = d.".$fk_facture;
   351|         $sql.= " AND s.rowid = f.fk_soc";
   352|         if ($y && $m)
   353|         {
   354|             $sql.= " AND f.datef >= '".$db->idate(dol_get_first_day($y,$m,false))."'";
   355|             $sql.= " AND f.datef <= '".$db->idate(dol_get_last_day($y,$m,false))."'";
   356|         }
   357|         else if ($y)
   358|         {
   359|             $sql.= " AND f.datef >= '".$db->idate(dol_get_first_day($y,1,false))."'";
   360|             $sql.= " AND f.datef <= '".$db->idate(dol_get_last_day($y,12,false))."'";
   361|         }
   362|         if ($q) $sql.= " AND (date_format(f.datef,'%m') > ".(($q-1)*3)." AND date_format(f.datef,'%m') <= ".($q*3).")";
   363|         if ($date_start && $date_end) $sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
   364|         $sql.= " AND (d.product_type = 1";                              // Limit to services
   365|         $sql.= " OR d.date_start is NOT null OR d.date_end IS NOT NULL)";       // enhance detection of service
   366|         $sql.= " ORDER BY d.rowid, d.".$fk_facture; 
   367|     }
   368|     else    // Option vat on delivery for goods (payments) and payments for services
   369|     {
   370|         $sql = "SELECT d.rowid, d.product_type as dtype, d.".$fk_facture." as facid, d.$f_rate as rate, d.total_ht as total_ht, d.total_ttc as total_ttc, d.".$total_tva." as total_vat, d.description as descr,";
   371|         $sql .=" d.".$total_localtax1." as total_localtax1, d.".$total_localtax2." as total_localtax2, ";
   372|         $sql.= " d.date_start as date_start, d.date_end as date_end,";
   373|         $sql.= " f.".$invoicefieldref." as facnum, f.type, f.total_ttc as ftotal_ttc, f.datef, s.nom as company_name, s.rowid as company_id,";
   374|         $sql.= " p.rowid as pid, p.ref as pref, p.fk_product_type as ptype,";
   375|         $sql.= " pf.".$fk_payment." as payment_id, pf.amount as payment_amount";
   376|         $sql.= " FROM ".MAIN_DB_PREFIX.$invoicetable." as f,";
   377|         $sql.= " ".MAIN_DB_PREFIX.$paymentfacturetable." as pf,";
   378|         $sql.= " ".MAIN_DB_PREFIX.$paymenttable." as pa,";
   379|         $sql.= " ".MAIN_DB_PREFIX."societe as s,";
   380|         $sql.= " ".MAIN_DB_PREFIX.$invoicedettable." as d";
   381|         $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."product as p on d.fk_product = p.rowid";
   382|         $sql.= " WHERE f.entity = " . $conf->entity;
   383|         $sql.= " AND f.fk_statut in (1,2)"; // Paid (partially or completely)
   384|         if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) $sql.= " AND f.type IN (0,1,2,5)";
   385| 		else $sql.= " AND f.type IN (0,1,2,3,5)";
   386|         $sql.= " AND f.rowid = d.".$fk_facture;

# --- HUNK 5: Lines 388-434 ---
   388|         $sql.= " AND pf.".$fk_facture2." = f.rowid";
   389|         $sql.= " AND pa.rowid = pf.".$fk_payment;
   390|         if ($y && $m)
   391|         {
   392|             $sql.= " AND pa.datep >= '".$db->idate(dol_get_first_day($y,$m,false))."'";
   393|             $sql.= " AND pa.datep <= '".$db->idate(dol_get_last_day($y,$m,false))."'";
   394|         }
   395|         else if ($y)
   396|         {
   397|             $sql.= " AND pa.datep >= '".$db->idate(dol_get_first_day($y,1,false))."'";
   398|             $sql.= " AND pa.datep <= '".$db->idate(dol_get_last_day($y,12,false))."'";
   399|         }
   400|         if ($q) $sql.= " AND (date_format(pa.datep,'%m') > ".(($q-1)*3)." AND date_format(pa.datep,'%m') <= ".($q*3).")";
   401|         if ($date_start && $date_end) $sql.= " AND pa.datep >= '".$db->idate($date_start)."' AND pa.datep <= '".$db->idate($date_end)."'";
   402|         $sql.= " AND (d.product_type = 1";                              // Limit to services
   403|         $sql.= " OR d.date_start is NOT null OR d.date_end IS NOT NULL)";       // enhance detection of service
   404|         $sql.= " ORDER BY d.rowid, d.".$fk_facture.", pf.rowid";
   405|     }
   406|     if (! $sql)
   407|     {
   408|         dol_syslog("Tax.lib.php::vat_by_date no accountancy module enabled".$sql,LOG_ERR);
   409|         return -1;  // -1 = Not accountancy module enabled
   410|     }
   411|     if ($sql == 'TODO') return -2; // -2 = Feature not yet available
   412|     if ($sql != 'TODO')
   413|     {
   414|         dol_syslog("Tax.lib.php::vat_by_date", LOG_DEBUG);
   415|         $resql = $db->query($sql);
   416|         if ($resql)
   417|         {
   418|             $rate = -1;
   419|             $oldrowid='';
   420|             while($assoc = $db->fetch_array($resql))
   421|             {
   422|                 if (! isset($list[$assoc['rate']]['totalht']))  $list[$assoc['rate']]['totalht']=0;
   423|                 if (! isset($list[$assoc['rate']]['vat']))      $list[$assoc['rate']]['vat']=0;
   424| 				if (! isset($list[$assoc['rate']]['localtax1']))      $list[$assoc['rate']]['localtax1']=0;
   425|                 if (! isset($list[$assoc['rate']]['localtax2']))      $list[$assoc['rate']]['localtax2']=0;
   426|                 if ($assoc['rowid'] != $oldrowid)       // Si rupture sur d.rowid
   427|                 {
   428|                     $oldrowid=$assoc['rowid'];
   429|                     $list[$assoc['rate']]['totalht']  += $assoc['total_ht'];
   430|                     $list[$assoc['rate']]['vat']      += $assoc['total_vat'];
   431|                     $list[$assoc['rate']]['localtax1']	 += $assoc['total_localtax1'];
   432|                     $list[$assoc['rate']]['localtax2']	 += $assoc['total_localtax2'];
   433|                 }
   434|                 $list[$assoc['rate']]['dtotal_ttc'][] = $assoc['total_ttc'];

# --- HUNK 6: Lines 469-520 ---
   469| 		$sql.= " e.date_debut as date_start, e.date_fin as date_end,";
   470| 		$sql.= " e.ref as facnum, e.total_ttc as ftotal_ttc, e.date_create, d.fk_c_type_fees as type,";
   471| 		$sql.= " p.fk_bank as payment_id, p.amount as payment_amount, p.rowid as pid, e.ref as pref";
   472| 		$sql.= " FROM ".MAIN_DB_PREFIX."expensereport as e ";
   473| 		$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."expensereport_det as d ON d.fk_expensereport = e.rowid ";
   474| 		$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."payment_expensereport as p ON p.fk_expensereport = e.rowid ";
   475| 		$sql.= " WHERE e.entity = " . $conf->entity;
   476| 		$sql.= " AND e.fk_statut in (6)";
   477| 		if ($y && $m)
   478| 		{
   479| 			$sql.= " AND p.datep >= '".$db->idate(dol_get_first_day($y,$m,false))."'";
   480| 			$sql.= " AND p.datep <= '".$db->idate(dol_get_last_day($y,$m,false))."'";
   481| 		}
   482| 		else if ($y)
   483| 		{
   484| 			$sql.= " AND p.datep >= '".$db->idate(dol_get_first_day($y,1,false))."'";
   485| 			$sql.= " AND p.datep <= '".$db->idate(dol_get_last_day($y,12,false))."'";
   486| 		}
   487| 		if ($q) $sql.= " AND (date_format(p.datep,'%m') > ".(($q-1)*3)." AND date_format(p.datep,'%m') <= ".($q*3).")";
   488| 		if ($date_start && $date_end) $sql.= " AND p.datep >= '".$db->idate($date_start)."' AND p.datep <= '".$db->idate($date_end)."'";
   489| 		$sql.= " AND (d.product_type = -1";                              
   490| 		$sql.= " OR e.date_debut is NOT null OR e.date_fin IS NOT NULL)";       // enhance detection of service
   491| 		$sql.= " ORDER BY e.rowid";
   492| 		if (! $sql)
   493| 		{
   494| 			dol_syslog("Tax.lib.php::vat_by_date no accountancy module enabled".$sql,LOG_ERR);
   495| 			return -1;  // -1 = Not accountancy module enabled
   496| 		}
   497| 		if ($sql == 'TODO') return -2; // -2 = Feature not yet available
   498| 		if ($sql != 'TODO')
   499| 		{
   500| 			dol_syslog("Tax.lib.php::vat_by_date", LOG_DEBUG);
   501| 			$resql = $db->query($sql);
   502| 			if ($resql)
   503| 			{
   504| 				$rate = -1;
   505| 				$oldrowid='';
   506| 				while($assoc = $db->fetch_array($resql))
   507| 				{
   508| 					if (! isset($list[$assoc['rate']]['totalht']))  $list[$assoc['rate']]['totalht']=0;
   509| 					if (! isset($list[$assoc['rate']]['vat']))      $list[$assoc['rate']]['vat']=0;
   510| 					if (! isset($list[$assoc['rate']]['localtax1']))      $list[$assoc['rate']]['localtax1']=0;
   511| 					if (! isset($list[$assoc['rate']]['localtax2']))      $list[$assoc['rate']]['localtax2']=0;
   512| 					if ($assoc['rowid'] != $oldrowid)       // Si rupture sur d.rowid
   513| 					{
   514| 						$oldrowid=$assoc['rowid'];
   515| 						$list[$assoc['rate']]['totalht']  += $assoc['total_ht'];
   516|                         $list[$assoc['rate']]['vat'] += $assoc['total_vat'];
   517| 						$list[$assoc['rate']]['localtax1']	 += $assoc['total_localtax1'];
   518| 						$list[$assoc['rate']]['localtax2']	 += $assoc['total_localtax2'];
   519| 					}
   520| 					$list[$assoc['rate']]['dtotal_ttc'][] = $assoc['total_ttc'];

# --- HUNK 7: Lines 533-572 ---
   533| 					$list[$assoc['rate']]['vat_list'][] = $assoc['total_vat'];
   534| 					$list[$assoc['rate']]['localtax1_list'][] = $assoc['total_localtax1'];
   535| 					$list[$assoc['rate']]['localtax2_list'][] = $assoc['total_localtax2'];
   536| 					$list[$assoc['rate']]['pid'][] = $assoc['pid'];
   537| 					$list[$assoc['rate']]['pref'][] = $assoc['pref'];
   538| 					$list[$assoc['rate']]['ptype'][] = 'ExpenseReportPayment';
   539| 					$list[$assoc['rate']]['payment_id'][] = $assoc['payment_id'];
   540| 					$list[$assoc['rate']]['payment_amount'][] = $assoc['payment_amount'];
   541| 					$rate = $assoc['rate'];
   542| 				}
   543| 			}
   544| 			else
   545| 			{
   546| 				dol_print_error($db);
   547| 				return -3;
   548| 			}
   549| 		}
   550| 	}
   551| 	return $list;
   552| }
   553| /**
   554|  *  Gets VAT to collect for the given year (and given quarter or month)
   555|  *  The function gets the VAT in split results, as the VAT declaration asks
   556|  *  to report the amounts for different VAT rates as different lines.
   557|  *  This function also accounts recurrent invoices.
   558|  *
   559|  *  @param	DoliDB	$db          	Database handler object
   560|  *  @param  int		$y           	Year
   561|  *  @param  int		$q           	Quarter
   562|  *  @param  string	$date_start  	Start date
   563|  *  @param  string	$date_end    	End date
   564|  *  @param  int		$modetax     	0 or 1 (option vat on debit)
   565|  *  @param  int		$direction   	'sell' (customer invoice) or 'buy' (supplier invoices)
   566|  *  @param  int		$m           	Month
   567|  *  @return array       			List of quarters with vat
   568|  */
   569| function vat_by_date ($db, $y, $q, $date_start, $date_end, $modetax, $direction, $m=0)
   570| {
   571| 	return tax_by_date('vat', $db, $y, $q, $date_start, $date_end, $modetax, $direction, $m);
   572| }


# ====================================================================
# FILE: htdocs/core/menus/standard/auguria_menu.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 171-212 ---
   171| 					    }
   172| 					}
   173| 					$lastlevel2 = array();
   174| 					foreach($submenu->liste as $key2 => $val2)		// $val['url','titre','level','enabled'=0|1|2,'target','mainmenu','leftmenu'
   175|         			{
   176| 						$showmenu=true;
   177| 						if (! empty($conf->global->MAIN_MENU_HIDE_UNAUTHORIZED) && empty($val2['enabled'])) $showmenu=false;
   178| 						if ($val2['level'] > 0)
   179| 						{
   180| 						    $levelcursor = $val2['level']-1;
   181| 						    while ($levelcursor >= 0)
   182| 						    {
   183|                                 if ($lastlevel2[$levelcursor] != 'enabled') $showmenu=false;
   184|                                 $levelcursor--;
   185| 						    }
   186| 						}
   187| 						if ($showmenu)		// Visible (option to hide when not allowed is off or allowed)
   188|        					{
   189|        						$substitarray = array('__LOGIN__' => $user->login, '__USER_ID__' => $user->id, '__USER_SUPERVISOR_ID__' => $user->fk_user);
   190|        						$substitarray['__USERID__'] = $user->id;	// For backward compatibility
   191|        						$val2['url'] = make_substitutions($val2['url'], $substitarray);
   192| 	        				$relurl2=dol_buildpath($val2['url'],1);
   193| 	        				$canonurl2=preg_replace('/\?.*$/','',$val2['url']);
   194| 	        				if (in_array($canonurl2,array('/admin/index.php','/admin/tools/index.php','/core/tools.php'))) $relurl2='';
   195| 	        				$disabled='';
   196| 	        				if (! $val2['enabled'])
   197| 	        				{
   198| 	        				    $disabled=" vsmenudisabled";
   199| 	        				}
   200| 	        				print str_pad('',$val2['level']+1);
   201| 	        				print '<li class="lilevel'.($val2['level']+1);
   202| 	        				if ($val2['level']==0) print ' ui-btn-icon-right ui-btn';  // ui-btn to highlight on clic
   203| 	        				print $disabled.'">';	 // ui-btn to highlight on clic
   204| 	        				if ($relurl2)
   205| 	        				{
   206| 	        					if ($val2['enabled'])	// Allowed
   207| 	        					{
   208| 	        						print '<a href="'.$relurl2.'"';
   209| 		        					print '>';
   210| 		        					$lastlevel2[$val2['level']]='enabled';
   211| 	        					}
   212| 	        					else					// Not allowed but visible (greyed)


# ====================================================================
# FILE: htdocs/core/menus/standard/eldy.lib.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 977-1028 ---
   977| 			{
   978| 				$langs->load("categories");
   979| 				$newmenu->add("/categories/index.php?leftmenu=cat&amp;type=0", $langs->trans("Categories"), 0, $user->rights->categorie->lire, '', $mainmenu, 'cat');
   980| 				$newmenu->add("/categories/card.php?action=create&amp;type=0", $langs->trans("NewCategory"), 1, $user->rights->categorie->creer);
   981| 			}
   982| 			if (! empty($conf->stock->enabled))
   983| 			{
   984| 				$langs->load("stocks");
   985| 				$newmenu->add("/product/stock/index.php?leftmenu=stock", $langs->trans("Warehouses"), 0, $user->rights->stock->lire, '', $mainmenu, 'stock');
   986| 				$newmenu->add("/product/stock/card.php?action=create", $langs->trans("MenuNewWarehouse"), 1, $user->rights->stock->creer);
   987| 				$newmenu->add("/product/stock/list.php", $langs->trans("List"), 1, $user->rights->stock->lire);
   988| 				$newmenu->add("/product/stock/mouvement.php", $langs->trans("Movements"), 1, $user->rights->stock->mouvement->lire);
   989|                 $newmenu->add("/product/stock/massstockmove.php", $langs->trans("MassStockTransferShort"), 1, $user->rights->stock->mouvement->creer);
   990|                 if ($conf->supplier_order->enabled) $newmenu->add("/product/stock/replenish.php", $langs->trans("Replenishment"), 1, $user->rights->stock->mouvement->creer && $user->rights->fournisseur->lire);
   991| 			}
   992| 			if ($conf->global->MAIN_FEATURES_LEVEL >= 2)
   993| 			{
   994|     			if (! empty($conf->stock->enabled))
   995|     			{
   996|     				$langs->load("stocks");
   997| 				if (empty($conf->global->MAIN_USE_ADVANCED_PERMS))
   998| 				{
   999|     					$newmenu->add("/product/inventory/list.php?leftmenu=stock", $langs->trans("Inventory"), 0, $user->rights->stock->lire, '', $mainmenu, 'stock');
  1000|     					$newmenu->add("/product/inventory/card.php?action=create", $langs->trans("NewInventory"), 1, $user->rights->stock->creer);
  1001|     					$newmenu->add("/product/inventory/list.php", $langs->trans("List"), 1, $user->rights->stock->lire);
  1002| 				}
  1003| 				else
  1004| 				{
  1005| 					$newmenu->add("/product/inventory/list.php?leftmenu=stock", $langs->trans("Inventory"), 0, $user->rights->stock->advance_inventory->read, '', $mainmenu, 'stock');
  1006|     					$newmenu->add("/product/inventory/card.php?action=create", $langs->trans("NewInventory"), 1, $user->rights->stock->advance_inventory->write);
  1007|     					$newmenu->add("/product/inventory/list.php", $langs->trans("List"), 1, $user->rights->stock->advance_inventory->read);
  1008| 				}
  1009|     			}
  1010| 			}
  1011| 			if (! empty($conf->expedition->enabled))
  1012| 			{
  1013| 				$langs->load("sendings");
  1014| 				$newmenu->add("/expedition/index.php?leftmenu=sendings", $langs->trans("Shipments"), 0, $user->rights->expedition->lire, '', $mainmenu, 'sendings');
  1015| 				$newmenu->add("/expedition/card.php?action=create2&amp;leftmenu=sendings", $langs->trans("NewSending"), 1, $user->rights->expedition->creer);
  1016| 				$newmenu->add("/expedition/list.php?leftmenu=sendings", $langs->trans("List"), 1, $user->rights->expedition->lire);
  1017| 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="sendings") $newmenu->add("/expedition/list.php?leftmenu=sendings&viewstatut=0", $langs->trans("StatusSendingDraftShort"), 2, $user->rights->expedition->lire);
  1018| 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="sendings") $newmenu->add("/expedition/list.php?leftmenu=sendings&viewstatut=1", $langs->trans("StatusSendingValidatedShort"), 2, $user->rights->expedition->lire);
  1019| 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="sendings") $newmenu->add("/expedition/list.php?leftmenu=sendings&viewstatut=2", $langs->trans("StatusSendingProcessedShort"), 2, $user->rights->expedition->lire);
  1020| 				$newmenu->add("/expedition/stats/index.php?leftmenu=sendings", $langs->trans("Statistics"), 1, $user->rights->expedition->lire);
  1021| 			}
  1022| 		}
  1023| 		/*
  1024| 		 * Menu PROJECTS
  1025| 		 */
  1026| 		if ($mainmenu == 'project')
  1027| 		{
  1028| 			if (! empty($conf->projet->enabled))

# --- HUNK 2: Lines 1106-1147 ---
  1106| 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="expensereport") $newmenu->add("/expensereport/list.php?search_status=6&amp;leftmenu=expensereport&amp;mainmenu=hrm", $langs->trans("Paid"), 2, $user->rights->expensereport->lire);
  1107| 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="expensereport") $newmenu->add("/expensereport/list.php?search_status=4&amp;leftmenu=expensereport&amp;mainmenu=hrm", $langs->trans("Canceled"), 2, $user->rights->expensereport->lire);
  1108| 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="expensereport") $newmenu->add("/expensereport/list.php?search_status=99&amp;leftmenu=expensereport&amp;mainmenu=hrm", $langs->trans("Refused"), 2, $user->rights->expensereport->lire);
  1109| 				$newmenu->add("/expensereport/stats/index.php?leftmenu=expensereport&amp;mainmenu=hrm", $langs->trans("Statistics"), 1, $user->rights->expensereport->lire);
  1110| 			}
  1111| 			if (! empty($conf->projet->enabled))
  1112| 			{
  1113| 				if (empty($conf->global->PROJECT_HIDE_TASKS))
  1114| 				{
  1115| 					$langs->load("projects");
  1116| 					$search_project_user = GETPOST('search_project_user','int');
  1117| 					$newmenu->add("/projet/activity/perweek.php?leftmenu=tasks".($search_project_user?'&search_project_user='.$search_project_user:''), $langs->trans("NewTimeSpent"), 0, $user->rights->projet->lire);
  1118| 				}
  1119| 			}
  1120| 		}
  1121| 		/*
  1122| 		 * Menu TOOLS
  1123| 		 */
  1124| 		if ($mainmenu == 'tools')
  1125| 		{
  1126| 			$langs->load("mails");
  1127| 			$newmenu->add("/admin/mails_templates.php?leftmenu=email_templates", $langs->trans("EMailTemplates"), 0, 1, '', $mainmenu, 'email_templates');
  1128| 			if (! empty($conf->mailing->enabled))
  1129| 			{
  1130| 				$newmenu->add("/comm/mailing/index.php?leftmenu=mailing", $langs->trans("EMailings"), 0, $user->rights->mailing->lire, '', $mainmenu, 'mailing');
  1131| 				$newmenu->add("/comm/mailing/card.php?leftmenu=mailing&amp;action=create", $langs->trans("NewMailing"), 1, $user->rights->mailing->creer);
  1132| 				$newmenu->add("/comm/mailing/list.php?leftmenu=mailing", $langs->trans("List"), 1, $user->rights->mailing->lire);
  1133| 			}
  1134| 			if (! empty($conf->export->enabled))
  1135| 			{
  1136| 				$langs->load("exports");
  1137| 				$newmenu->add("/exports/index.php?leftmenu=export",$langs->trans("FormatedExport"),0, $user->rights->export->lire, '', $mainmenu, 'export');
  1138| 				$newmenu->add("/exports/export.php?leftmenu=export",$langs->trans("NewExport"),1, $user->rights->export->creer);
  1139| 			}
  1140| 			if (! empty($conf->import->enabled))
  1141| 			{
  1142| 				$langs->load("exports");
  1143| 				$newmenu->add("/imports/index.php?leftmenu=import",$langs->trans("FormatedImport"),0, $user->rights->import->run, '', $mainmenu, 'import');
  1144| 				$newmenu->add("/imports/import.php?leftmenu=import",$langs->trans("NewImport"),1, $user->rights->import->run);
  1145| 			}
  1146| 		}
  1147| 		/*


# ====================================================================
# FILE: htdocs/core/menus/standard/eldy_menu.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 178-219 ---
   178|         			    }
   179|         			}
   180|         			$lastlevel2 = array();
   181|        				foreach($submenu->liste as $key2 => $val2)		// $val['url','titre','level','enabled'=0|1|2,'target','mainmenu','leftmenu'
   182|        				{
   183| 						$showmenu=true;
   184| 						if (! empty($conf->global->MAIN_MENU_HIDE_UNAUTHORIZED) && empty($val2['enabled'])) $showmenu=false;
   185| 						if ($val2['level'] > 0)
   186| 						{
   187| 						    $levelcursor = $val2['level']-1;
   188| 						    while ($levelcursor >= 0)
   189| 						    {
   190|                                 if ($lastlevel2[$levelcursor] != 'enabled') $showmenu=false;
   191|                                 $levelcursor--;
   192| 						    }
   193| 						}
   194|        					if ($showmenu)		// Visible (option to hide when not allowed is off or allowed)
   195|        					{
   196|        						$substitarray = array('__LOGIN__' => $user->login, '__USER_ID__' => $user->id, '__USER_SUPERVISOR_ID__' => $user->fk_user);
   197|        						$substitarray['__USERID__'] = $user->id;	// For backward compatibility
   198|        						$val2['url'] = make_substitutions($val2['url'], $substitarray);
   199| 	        				$relurl2=dol_buildpath($val2['url'],1);
   200| 	        				$canonurl2=preg_replace('/\?.*$/','',$val2['url']);
   201| 	        				if (in_array($canonurl2,array('/admin/index.php','/admin/tools/index.php','/core/tools.php'))) $relurl2='';
   202| 	        				$disabled='';
   203| 	        				if (! $val2['enabled'])
   204| 	        				{
   205| 	        				    $disabled=" vsmenudisabled";
   206| 	        				}
   207| 	        				print str_pad('',$val2['level']+1);
   208| 	        				print '<li class="lilevel'.($val2['level']+1);
   209| 	        				if ($val2['level']==0) print ' ui-btn-icon-right ui-btn';  // ui-btn to highlight on clic
   210| 	        				print $disabled.'">';	 // ui-btn to highlight on clic
   211| 	        				if ($relurl2)
   212| 	        				{
   213| 	        					if ($val2['enabled'])	// Allowed
   214| 	        					{
   215| 	        						print '<a href="'.$relurl2.'"';
   216| 		        					print '>';
   217| 		        					$lastlevel2[$val2['level']]='enabled';
   218| 	        					}
   219| 	        					else					// Not allowed but visible (greyed)


# ====================================================================
# FILE: htdocs/core/modules/DolibarrModules.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1028-1121 ---
  1028| 					$err++;
  1029| 				}
  1030| 			}
  1031| 		}
  1032| 		return $err;
  1033| 	}
  1034| 	/**
  1035| 	 * Adds cronjobs
  1036| 	 *
  1037| 	 * @return  int             Error count (0 if OK)
  1038| 	 */
  1039| 	function insert_cronjobs()
  1040| 	{
  1041| 		require_once DOL_DOCUMENT_ROOT . '/core/class/infobox.class.php';
  1042| 		global $conf;
  1043| 		$err=0;
  1044| 		if (is_array($this->cronjobs))
  1045| 		{
  1046| 			foreach ($this->cronjobs as $key => $value)
  1047| 			{
  1048| 				$label  = isset($this->cronjobs[$key]['label'])?$this->cronjobs[$key]['label']:'';
  1049| 				$jobtype  = isset($this->cronjobs[$key]['jobtype'])?$this->cronjobs[$key]['jobtype']:'';
  1050| 				$class  = isset($this->cronjobs[$key]['class'])?$this->cronjobs[$key]['class']:'';
  1051| 				$objectname  = isset($this->cronjobs[$key]['objectname'])?$this->cronjobs[$key]['objectname']:'';
  1052| 				$method = isset($this->cronjobs[$key]['method'])?$this->cronjobs[$key]['method']:'';
  1053| 				$command  = isset($this->cronjobs[$key]['command'])?$this->cronjobs[$key]['command']:'';
  1054| 				$parameters  = isset($this->cronjobs[$key]['parameters'])?$this->cronjobs[$key]['parameters']:'';
  1055| 				$comment = isset($this->cronjobs[$key]['comment'])?$this->cronjobs[$key]['comment']:'';
  1056| 				$frequency = isset($this->cronjobs[$key]['frequency'])?$this->cronjobs[$key]['frequency']:'';
  1057| 				$unitfrequency = isset($this->cronjobs[$key]['unitfrequency'])?$this->cronjobs[$key]['unitfrequency']:'';
  1058| 				$status = isset($this->cronjobs[$key]['status'])?$this->cronjobs[$key]['status']:'';
  1059| 				$priority = isset($this->cronjobs[$key]['priority'])?$this->cronjobs[$key]['priority']:'';
  1060| 				$test = isset($this->cronjobs[$key]['test'])?$this->cronjobs[$key]['test']:'';                              // Line must be visible
  1061| 				$sql = "SELECT count(*) as nb FROM ".MAIN_DB_PREFIX."cronjob";
  1062| 				$sql.= " WHERE module_name = '".$this->db->escape($this->rights_class)."'";
  1063| 				if ($class) $sql.= " AND classesname = '".$this->db->escape($class)."'";
  1064| 				if ($objectname) $sql.= " AND objectname = '".$this->db->escape($objectname)."'";
  1065| 				if ($method) $sql.= " AND methodename = '".$this->db->escape($method)."'";
  1066| 				if ($command) $sql.= " AND command = '".$this->db->escape($command)."'";
  1067| 				$sql.= " AND entity = ".$conf->entity;
  1068| 				$now=dol_now();
  1069| 				dol_syslog(get_class($this)."::insert_cronjobs", LOG_DEBUG);
  1070| 				$result=$this->db->query($sql);
  1071| 				if ($result)
  1072| 				{
  1073| 					$obj = $this->db->fetch_object($result);
  1074| 					if ($obj->nb == 0)
  1075| 					{
  1076| 						$this->db->begin();
  1077| 						if (! $err)
  1078| 						{
  1079| 							$sql = "INSERT INTO ".MAIN_DB_PREFIX."cronjob (module_name, datec, datestart, label, jobtype, classesname, objectname, methodename, command, params, note,";
  1080| 							if(is_int($frequency)){ $sql.= ' frequency,'; }
  1081| 							if(is_int($unitfrequency)){ $sql.= ' unitfrequency,'; }
  1082| 							if(is_int($priority)){ $sql.= ' priority,'; }
  1083| 							if(is_int($status)){ $sql.= ' status,'; }
  1084| 							$sql.= " entity, test)";
  1085| 							$sql.= " VALUES (";
  1086| 							$sql.= "'".$this->db->escape($this->rights_class)."', ";
  1087| 							$sql.= "'".$this->db->idate($now)."', ";
  1088| 							$sql.= "'".$this->db->idate($now)."', ";
  1089| 							$sql.= "'".$this->db->escape($label)."', ";
  1090| 							$sql.= "'".$this->db->escape($jobtype)."', ";
  1091| 							$sql.= ($class?"'".$this->db->escape($class)."'":"null").",";
  1092| 							$sql.= ($objectname?"'".$this->db->escape($objectname)."'":"null").",";
  1093| 							$sql.= ($method?"'".$this->db->escape($method)."'":"null").",";
  1094| 							$sql.= ($command?"'".$this->db->escape($command)."'":"null").",";
  1095| 							$sql.= ($parameters?"'".$this->db->escape($parameters)."'":"null").",";
  1096| 							$sql.= ($comment?"'".$this->db->escape($comment)."'":"null").",";
  1097| 							if(is_int($frequency)){ $sql.= "'".$this->db->escape($frequency)."', "; }
  1098| 							if(is_int($unitfrequency)){ $sql.= "'".$this->db->escape($unitfrequency)."', "; }
  1099| 							if(is_int($priority)) {$sql.= "'".$this->db->escape($priority)."', ";}
  1100| 							if(is_int($status)){ $sql.= "'".$this->db->escape($status)."', "; }
  1101| 							$sql.= $conf->entity.",";
  1102| 							$sql.= "'".$this->db->escape($test)."'";
  1103| 							$sql.= ")";
  1104| 							dol_syslog(get_class($this)."::insert_cronjobs", LOG_DEBUG);
  1105| 							$resql=$this->db->query($sql);
  1106| 							if (! $resql) $err++;
  1107| 						}
  1108| 						if (! $err)
  1109| 						{
  1110| 							$this->db->commit();
  1111| 						}
  1112| 						else
  1113| 						{
  1114| 							$this->error=$this->db->lasterror();
  1115| 							$this->db->rollback();
  1116| 						}
  1117| 					}
  1118| 				}
  1119| 				else
  1120| 			  {
  1121| 					$this->error=$this->db->lasterror();


# ====================================================================
# FILE: htdocs/core/modules/modCron.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 48-89 ---
    48|         $this->dirs = array();
    49|         $this->config_page_url = array("cron.php@cron");
    50| 		$this->hidden = !empty($conf->global->MODULE_CRON_DISABLED); // A condition to disable module
    51| 		$this->depends = array(); // List of modules id that must be enabled if this module is enabled
    52|         $this->requiredby = array(); // List of modules id to disable if this one is disabled
    53| 		$this->conflictwith = array(); // List of modules id this module is in conflict with
    54|         $this->langfiles = array("cron");
    55|         	$this->const = array(
    56| 				0=>array(
    57| 					'CRON_KEY',
    58| 					'chaine',
    59| 					'',
    60| 					'CRON KEY',
    61| 					0,
    62| 					'main',
    63| 					0
    64| 				),);
    65|         $this->tabs = array();
    66|         $this->boxes = array();
    67| 		$this->cronjobs = array(
    68| 			0=>array('label'=>'PurgeDeleteTemporaryFilesShort', 'jobtype'=>'method', 'class'=>'core/class/utils.class.php', 'objectname'=>'Utils', 'method'=>'purgeFiles', 'parameters'=>'', 'comment'=>'PurgeDeleteTemporaryFiles', 'frequency'=>2, 'unitfrequency'=>3600 * 24 * 7, 'priority'=>50, 'status'=>1, 'test'=>true),
    69| 			1=>array('label'=>'MakeLocalDatabaseDumpShort', 'jobtype'=>'method', 'class'=>'core/class/utils.class.php', 'objectname'=>'Utils', 'method'=>'dumpDatabase', 'parameters'=>'none,auto,1,auto,10', 'comment'=>'MakeLocalDatabaseDump', 'frequency'=>1, 'unitfrequency'=>3600 * 24 * 7, 'priority'=>90, 'status'=>0, 'test'=>in_array($db->type, array('mysql', 'mysqli'))),
    70| 		);
    71| 		$this->rights = array(); // Permission array used by this module
    72| 		$this->rights_class = 'cron';
    73| 		$r = 0;
    74| 		$this->rights[$r][0] = 23001;
    75| 		$this->rights[$r][1] = 'Read cron jobs';
    76| 		$this->rights[$r][3] = 0;
    77| 		$this->rights[$r][4] = 'read';
    78| 		$r++;
    79| 		$this->rights[$r][0] = 23002;
    80| 		$this->rights[$r][1] = 'Create cron Jobs';
    81| 		$this->rights[$r][3] = 0;
    82| 		$this->rights[$r][4] = 'create';
    83| 		$r++;
    84| 		$this->rights[$r][0] = 23003;
    85| 		$this->rights[$r][1] = 'Delete cron Jobs';
    86| 		$this->rights[$r][3] = 0;
    87| 		$this->rights[$r][4] = 'delete';
    88| 		$r++;
    89| 		$this->rights[$r][0] = 23004;


# ====================================================================
# FILE: htdocs/core/modules/modResource.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 97-137 ---
    97| 			'mainmenu'=>'tools',
    98| 			'leftmenu'=> 'resource',
    99| 			'url'=> '/resource/list.php',
   100| 			'langs'=> 'resource',
   101| 			'position'=> 100,
   102| 			'enabled'=> '1',
   103| 			'perms'=> '$user->rights->resource->read',
   104| 			'user'=> 0
   105| 		);
   106| 		$r++;
   107| 		$this->menu[$r++]=array(
   108| 			'fk_menu'=>'fk_mainmenu=tools,fk_leftmenu=resource', //On utilise les ancres dfinis dans le menu parent dclar au dessus
   109| 			'type'=> 'left', // Toujours un menu gauche
   110| 			'titre'=> 'MenuResourceAdd',
   111| 			'mainmenu'=> 'tools',
   112| 			'leftmenu'=> 'resource_add',
   113| 			'url'=> '/resource/card.php?action=create',
   114| 			'langs'=> 'resource',
   115| 			'position'=> 101,
   116| 			'enabled'=> '1',
   117| 			'perms'=> '$user->rights->resource->read',
   118| 			'target'=> '',
   119| 			'user'=> 0
   120| 		);
   121| 		$this->menu[$r++]=array(
   122| 			'fk_menu'=>'fk_mainmenu=tools,fk_leftmenu=resource', //On utilise les ancres dfinis dans le menu parent dclar au dessus
   123| 			'type'=> 'left', // Toujours un menu gauche
   124| 			'titre'=> 'List',
   125| 			'mainmenu'=> 'tools',
   126| 			'leftmenu'=> 'resource_list',
   127| 			'url'=> '/resource/list.php',
   128| 			'langs'=> 'resource',
   129| 			'position'=> 102,
   130| 			'enabled'=> '1',
   131| 			'perms'=> '$user->rights->resource->read',
   132| 			'target'=> '',
   133| 			'user'=> 0
   134| 		);
   135| 		$r=0;
   136| 		$r++;
   137| 		$this->export_code[$r]=$this->rights_class.'_'.$r;


# ====================================================================
# FILE: htdocs/core/modules/modStock.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 76-136 ---
    76| 		$this->rights[2][2] = 'd';
    77| 		$this->rights[2][3] = 0;
    78| 		$this->rights[2][4] = 'supprimer';
    79| 		$this->rights[2][5] = '';
    80| 		$this->rights[3][0] = 1004;
    81| 		$this->rights[3][1] = 'Lire mouvements de stocks';
    82| 		$this->rights[3][2] = 'r';
    83| 		$this->rights[3][3] = 0;
    84| 		$this->rights[3][4] = 'mouvement';
    85| 		$this->rights[3][5] = 'lire';
    86| 		$this->rights[4][0] = 1005;
    87| 		$this->rights[4][1] = 'Creer/modifier mouvements de stocks';
    88| 		$this->rights[4][2] = 'w';
    89| 		$this->rights[4][3] = 0;
    90| 		$this->rights[4][4] = 'mouvement';
    91| 		$this->rights[4][5] = 'creer';
    92| 		if ($conf->global->MAIN_FEATURES_LEVEL >= 2) {
    93| 		$this->rights[5][0] = 1011;
    94| 		$this->rights[5][1] = 'inventoryReadPermission';	// Permission label
    95| 		$this->rights[5][3] = 0; 					// Permission by default for new user (0/1)
    96| 		$this->rights[5][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
    97| 		$this->rights[5][5] = 'read';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
    98| 		$this->rights[6][0] = 1012;
    99| 		$this->rights[6][1] = 'inventoryCreatePermission';	// Permission label
   100| 		$this->rights[6][3] = 0; 					// Permission by default for new user (0/1)
   101| 		$this->rights[6][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   102| 		$this->rights[6][5] = 'create';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   103| 		$this->rights[7][0] = 1013;
   104| 		$this->rights[7][1] = 'inventoryWritePermission';	// Permission label
   105| 		$this->rights[7][3] = 0; 					// Permission by default for new user (0/1)
   106| 		$this->rights[7][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   107| 		$this->rights[7][5] = 'write';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   108| 		$this->rights[8][0] = 1014;
   109| 		$this->rights[8][1] = 'inventoryValidatePermission';	// Permission label
   110| 		$this->rights[8][3] = 0; 					// Permission by default for new user (0/1)
   111| 		$this->rights[8][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   112| 		$this->rights[8][5] = 'validate';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   113| 		$this->rights[9][0] = 1015;
   114| 		$this->rights[9][1] = 'inventoryChangePMPPermission';	// Permission label
   115| 		$this->rights[9][3] = 0; 					// Permission by default for new user (0/1)
   116| 		$this->rights[9][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   117| 		$this->rights[9][5] = 'changePMP';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
   118| 		}
   119| 		$this->menu = array();			// List of menus to add
   120| 		$r=0;
   121| 		$this->menu = 1;        // This module add menu entries. They are coded into menu manager.
   122| 		$r=0;
   123| 		$r++;
   124| 		$this->export_code[$r]=$this->rights_class;
   125| 		$this->export_label[$r]="WarehousesAndProducts";	// Translation key (used only if key ExportDataset_xxx_z not found)
   126| 		$this->export_permission[$r]=array(array("stock","lire"));
   127| 		$this->export_fields_array[$r]=array('e.rowid'=>'IdWarehouse','e.ref'=>'LocationSummary','e.description'=>'DescWareHouse','e.lieu'=>'LieuWareHouse','e.address'=>'Address','e.zip'=>'Zip','e.town'=>'Town','p.rowid'=>"ProductId",'p.ref'=>"Ref",'p.fk_product_type'=>"Type",'p.label'=>"Label",'p.description'=>"Description",'p.note'=>"Note",'p.price'=>"Price",'p.tva_tx'=>'VAT','p.tosell'=>"OnSell",'p.tobuy'=>'OnBuy','p.duration'=>"Duration",'p.datec'=>'DateCreation','p.tms'=>'DateModification','p.pmp'=>'PMPValue','p.cost_price'=>'CostPrice','ps.reel'=>'Stock');
   128| 		$this->export_TypeFields_array[$r]=array('e.rowid'=>'List:entrepot:ref','e.ref'=>'Text','e.lieu'=>'Text','e.address'=>'Text','e.zip'=>'Text','e.town'=>'Text','p.rowid'=>"List:product:label",'p.ref'=>"Text",'p.fk_product_type'=>"Text",'p.label'=>"Text",'p.description'=>"Text",'p.note'=>"Text",'p.price'=>"Numeric",'p.tva_tx'=>'Numeric','p.tosell'=>"Boolean",'p.tobuy'=>"Boolean",'p.duration'=>"Duree",'p.datec'=>'Date','p.tms'=>'Date','p.pmp'=>'Numeric','p.cost_price'=>'Numeric','ps.reel'=>'Numeric');
   129| 		$this->export_entities_array[$r]=array('e.rowid'=>'warehouse','e.ref'=>'warehouse','e.description'=>'warehouse','e.lieu'=>'warehouse','e.address'=>'warehouse','e.zip'=>'warehouse','e.town'=>'warehouse','p.rowid'=>"product",'p.ref'=>"product",'p.fk_product_type'=>"product",'p.label'=>"product",'p.description'=>"product",'p.note'=>"product",'p.price'=>"product",'p.tva_tx'=>'product','p.tosell'=>"product",'p.tobuy'=>"product",'p.duration'=>"product",'p.datec'=>'product','p.tms'=>'product','p.pmp'=>'product','p.cost_price'=>'product','ps.reel'=>'stock');
   130| 		$this->export_aggregate_array[$r]=array('ps.reel'=>'SUM');    // TODO Not used yet
   131| 		$this->export_dependencies_array[$r]=array('stock'=>array('p.rowid','e.rowid')); // We must keep this until the aggregate_array is used. To add unique key if we ask a field of a child to avoid the DISTINCT to discard them.
   132| 		$this->export_sql_start[$r]='SELECT DISTINCT ';
   133| 		$this->export_sql_end[$r]  =' FROM '.MAIN_DB_PREFIX.'product as p, '.MAIN_DB_PREFIX.'product_stock as ps, '.MAIN_DB_PREFIX.'entrepot as e';
   134| 		$this->export_sql_end[$r] .=' WHERE p.rowid = ps.fk_product AND ps.fk_entrepot = e.rowid';
   135| 		$this->export_sql_end[$r] .=' AND e.entity IN ('.getEntity('stock').')';
   136| 		if ($conf->productbatch->enabled)


# ====================================================================
# FILE: htdocs/core/modules/supplier_invoice/pdf/pdf_canelle.modules.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 298-356 ---
   298|                     $pageposafter=$pdf->getPage();
   299| 					$pdf->setPage($pageposbefore);
   300| 					$pdf->setTopMargin($this->marge_haute);
   301| 					$pdf->setPageOrientation('', 1, 0);	// The only function to edit the bottom margin of current page to set it.
   302| 					if ($pageposafter > $pageposbefore && empty($showpricebeforepagebreak)) {
   303| 						$pdf->setPage($pageposafter); $curY = $tab_top_newpage;
   304| 					}
   305| 					$pdf->SetFont('','', $default_font_size - 1);   // On repositionne la police par defaut
   306|                     if (empty($conf->global->MAIN_GENERATE_DOCUMENTS_WITHOUT_VAT))
   307|                     {
   308|     					$vat_rate = pdf_getlinevatrate($object, $i, $outputlangs, $hidedetails);
   309|                         $pdf->SetXY($this->posxtva, $curY);
   310| 	       				$pdf->MultiCell($this->posxup-$this->posxtva-1, 3, $vat_rate, 0, 'R');
   311|                     }
   312| 					$up_excl_tax = pdf_getlineupexcltax($object, $i, $outputlangs, $hidedetails);
   313| 					$pdf->SetXY($this->posxup, $curY);
   314| 					$pdf->MultiCell($this->posxqty-$this->posxup-0.8, 3, $up_excl_tax, 0, 'R', 0);
   315| 					$up_excl_tax = pdf_getlineupexcltax($object, $i, $outputlangs, $hidedetails);
   316| 					$pdf->SetXY($this->posxup, $curY);
   317| 					$pdf->MultiCell($this->posxqty-$this->posxup-0.8, 3, $up_excl_tax, 0, 'R', 0);
   318| 					$pdf->SetXY($this->posxqty, $curY);
   319| 					if($conf->global->PRODUCT_USE_UNITS)
   320| 					{
   321| 						$pdf->MultiCell($this->posxunit-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
   322| 					}
   323| 					else
   324| 					{
   325| 						$pdf->MultiCell($this->posxdiscount-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
   326| 					}
   327| 					if($conf->global->PRODUCT_USE_UNITS)
   328| 					{
   329| 						$unit = pdf_getlineunit($object, $i, $outputlangs, $hidedetails, $hookmanager);
   330| 						$pdf->SetXY($this->posxunit, $curY);
   331| 						$pdf->MultiCell($this->posxdiscount-$this->posxunit-0.8, 4, $unit, 0, 'L');
   332| 					}
   333| 					$pdf->SetXY($this->posxdiscount, $curY);
   334| 					if ($object->lines[$i]->remise_percent)
   335| 					{
   336| 						$pdf->MultiCell($this->postotalht-$this->posxdiscount-1, 3, $object->lines[$i]->remise_percent."%", 0, 'R');
   337| 					}
   338|                     $total_excl_tax = pdf_getlinetotalexcltax($object, $i, $outputlangs);
   339|                     $pdf->SetXY($this->postotalht, $curY);
   340|                     $pdf->MultiCell($this->page_largeur-$this->marge_droite-$this->postotalht, 3, $total_excl_tax, 0, 'R', 0);
   341| 					if ($conf->multicurrency->enabled && $object->multicurrency_tx != 1) $tvaligne=$object->lines[$i]->multicurrency_total_tva;
   342| 					else $tvaligne=$object->lines[$i]->total_tva;
   343| 					$localtax1ligne=$object->lines[$i]->total_localtax1;
   344| 					$localtax2ligne=$object->lines[$i]->total_localtax2;
   345| 					if (! empty($object->remise_percent)) $tvaligne-=($tvaligne*$object->remise_percent)/100;
   346| 					$vatrate=(string) $object->lines[$i]->tva_tx;
   347| 					$localtax1rate=(string) $object->lines[$i]->localtax1_tx;
   348| 					$localtax2rate=(string) $object->lines[$i]->localtax2_tx;
   349| 					if (($object->lines[$i]->info_bits & 0x01) == 0x01) $vatrate.='*';
   350| 					if (empty($this->tva[$vatrate])) $this->tva[$vatrate]=0;
   351| 					if (empty($this->localtax1[$localtax1rate])) $this->localtax1[$localtax1rate]=0;
   352| 					if (empty($this->localtax2[$localtax2rate])) $this->localtax2[$localtax2rate]=0;
   353| 					$this->tva[$vatrate] += $tvaligne;
   354| 					$this->localtax1[$localtax1rate]+=$localtax1ligne;
   355| 					$this->localtax2[$localtax2rate]+=$localtax2ligne;
   356| 					if (! empty($conf->global->MAIN_PDF_DASH_BETWEEN_LINES) && $i < ($nblignes - 1))

# --- HUNK 2: Lines 834-874 ---
   834| 		}
   835| 		else
   836| 		{
   837| 			$posy+=4;
   838| 			$pdf->SetXY($posx,$posy);
   839| 			$pdf->SetTextColor(255,0,0);
   840| 			$pdf->MultiCell(100, 4, strtolower($outputlangs->transnoentities("OrderToProcess")), '', 'R');
   841| 		}
   842| 		if ($object->thirdparty->code_fournisseur)
   843| 		{
   844| 			$posy+=4;
   845| 			$pdf->SetXY($posx,$posy);
   846| 			$pdf->SetTextColor(0,0,60);
   847| 			$pdf->MultiCell(100, 3, $outputlangs->transnoentities("SupplierCode")." : " . $outputlangs->transnoentities($object->thirdparty->code_fournisseur), '', 'R');
   848| 		}
   849| 		$posy+=1;
   850| 		$pdf->SetTextColor(0,0,60);
   851| 		$posy = pdf_writeLinkedObjects($pdf, $object, $outputlangs, $posx, $posy, 100, 3, 'R', $default_font_size);
   852| 		if ($showaddress)
   853| 		{
   854| 			$carac_emetteur = pdf_build_address($outputlangs, $this->emetteur, $object->thirdparty);
   855| 			$posy=42;
   856| 			$posx=$this->marge_gauche;
   857| 			if (! empty($conf->global->MAIN_INVERT_SENDER_RECIPIENT)) $posx=$this->page_largeur-$this->marge_droite-80;
   858| 			$hautcadre=40;
   859| 			$pdf->SetTextColor(0,0,0);
   860| 			$pdf->SetFont('','', $default_font_size - 2);
   861| 			$pdf->SetXY($posx,$posy-5);
   862| 			$pdf->MultiCell(66,5, $outputlangs->transnoentities("BillFrom").":", 0, 'L');
   863| 			$pdf->SetXY($posx,$posy);
   864| 			$pdf->SetFillColor(230,230,230);
   865| 			$pdf->MultiCell(82, $hautcadre, "", 0, 'R', 1);
   866| 			$pdf->SetTextColor(0,0,60);
   867| 			$pdf->SetXY($posx+2,$posy+3);
   868| 			$pdf->SetFont('','B', $default_font_size);
   869| 			$pdf->MultiCell(80, 4, $outputlangs->convToOutputCharset($this->emetteur->name), 0, 'L');
   870| 			$posy=$pdf->getY();
   871| 			$pdf->SetXY($posx+2,$posy);
   872| 			$pdf->SetFont('','', $default_font_size - 1);
   873| 			$pdf->MultiCell(80, 4, $carac_emetteur, 0, 'L');
   874| 			$usecontact=false;


# ====================================================================
# FILE: htdocs/core/modules/supplier_order/pdf/pdf_muscadet.modules.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 365-423 ---
   365| 						$pdf->commitTransaction();
   366| 					}
   367| 					$nexY = $pdf->GetY();
   368|                     $pageposafter=$pdf->getPage();
   369| 					$pdf->setPage($pageposbefore);
   370| 					$pdf->setTopMargin($this->marge_haute);
   371| 					$pdf->setPageOrientation('', 1, 0);	// The only function to edit the bottom margin of current page to set it.
   372| 					if ($pageposafter > $pageposbefore && empty($showpricebeforepagebreak)) {
   373| 						$pdf->setPage($pageposafter); $curY = $tab_top_newpage;
   374| 					}
   375| 					$pdf->SetFont('','', $default_font_size - 1);   // On repositionne la police par defaut
   376| 					if (empty($conf->global->MAIN_GENERATE_DOCUMENTS_WITHOUT_VAT))
   377| 					{
   378| 						$vat_rate = pdf_getlinevatrate($object, $i, $outputlangs, $hidedetails);
   379| 						$pdf->SetXY($this->posxtva, $curY);
   380| 						$pdf->MultiCell($this->posxup-$this->posxtva-1, 3, $vat_rate, 0, 'R');
   381| 					}
   382| 					$up_excl_tax = pdf_getlineupexcltax($object, $i, $outputlangs, $hidedetails);
   383| 					$pdf->SetXY($this->posxup, $curY);
   384| 					$pdf->MultiCell($this->posxqty-$this->posxup-0.8, 3, $up_excl_tax, 0, 'R', 0);
   385| 					$pdf->SetXY($this->posxqty, $curY);
   386| 					if($conf->global->PRODUCT_USE_UNITS)
   387| 					{
   388| 						$pdf->MultiCell($this->posxunit-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
   389| 					}
   390| 					else
   391| 					{
   392| 						$pdf->MultiCell($this->posxdiscount-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
   393| 					}
   394| 					if($conf->global->PRODUCT_USE_UNITS)
   395| 					{
   396| 						$unit = pdf_getlineunit($object, $i, $outputlangs, $hidedetails, $hookmanager);
   397| 						$pdf->SetXY($this->posxunit, $curY);
   398| 						$pdf->MultiCell($this->posxdiscount-$this->posxunit-0.8, 4, $unit, 0, 'L');
   399| 					}
   400| 					$pdf->SetXY($this->posxdiscount, $curY);
   401| 					if ($object->lines[$i]->remise_percent)
   402| 					{
   403| 						$pdf->MultiCell($this->postotalht-$this->posxdiscount-1, 3, $object->lines[$i]->remise_percent."%", 0, 'R');
   404| 					}
   405|                     $total_excl_tax = pdf_getlinetotalexcltax($object, $i, $outputlangs);
   406| 					$pdf->SetXY($this->postotalht, $curY);
   407| 					$pdf->MultiCell($this->page_largeur-$this->marge_droite-$this->postotalht, 3, $total_excl_tax, 0, 'R', 0);
   408| 					if ($conf->multicurrency->enabled && $object->multicurrency_tx != 1) $tvaligne=$object->lines[$i]->multicurrency_total_tva;
   409| 					else $tvaligne=$object->lines[$i]->total_tva;
   410| 					$localtax1ligne=$object->lines[$i]->total_localtax1;
   411| 					$localtax2ligne=$object->lines[$i]->total_localtax2;
   412| 					$localtax1_rate=$object->lines[$i]->localtax1_tx;
   413| 					$localtax2_rate=$object->lines[$i]->localtax2_tx;
   414| 					$localtax1_type=$object->lines[$i]->localtax1_type;
   415| 					$localtax2_type=$object->lines[$i]->localtax2_type;
   416| 					if (! empty($object->remise_percent)) $tvaligne-=($tvaligne*$object->remise_percent)/100;
   417| 					if (! empty($object->remise_percent)) $localtax1ligne-=($localtax1ligne*$object->remise_percent)/100;
   418| 					if (! empty($object->remise_percent)) $localtax2ligne-=($localtax2ligne*$object->remise_percent)/100;
   419| 					$vatrate=(string) $object->lines[$i]->tva_tx;
   420| 					if ((! isset($localtax1_type) || $localtax1_type=='' || ! isset($localtax2_type) || $localtax2_type=='') // if tax type not defined
   421| 					&& (! empty($localtax1_rate) || ! empty($localtax2_rate))) // and there is local tax
   422| 					{
   423| 						$localtaxtmp_array=getLocalTaxesFromRate($vatrate,0,$mysoc,$object->thirdparty);

# --- HUNK 2: Lines 935-975 ---
   935| 			$pdf->MultiCell(100, 3, $outputlangs->transnoentities("SupplierCode")." : " . $outputlangs->transnoentities($object->thirdparty->code_fournisseur), '', 'R');
   936| 		}
   937| 		if (!empty($conf->global->DOC_SHOW_FIRST_SALES_REP))
   938| 		{
   939|     		$arrayidcontact=$object->getIdContact('internal','SALESREPFOLL');
   940|     		if (count($arrayidcontact) > 0)
   941|     		{
   942|     		    $usertmp=new User($this->db);
   943|     		    $usertmp->fetch($arrayidcontact[0]);
   944|                 $posy+=4;
   945|                 $pdf->SetXY($posx,$posy);
   946|     		    $pdf->SetTextColor(0,0,60);
   947|     		    $pdf->MultiCell(100, 3, $langs->trans("BuyerName")." : ".$usertmp->getFullName($langs), '', 'R');
   948|     		}
   949| 		}
   950| 		$posy+=1;
   951| 		$pdf->SetTextColor(0,0,60);
   952| 		$posy = pdf_writeLinkedObjects($pdf, $object, $outputlangs, $posx, $posy, 100, 3, 'R', $default_font_size);
   953| 		if ($showaddress)
   954| 		{
   955| 			$carac_emetteur = pdf_build_address($outputlangs, $this->emetteur, $object->thirdparty);
   956| 			$posy=42;
   957| 			$posx=$this->marge_gauche;
   958| 			if (! empty($conf->global->MAIN_INVERT_SENDER_RECIPIENT)) $posx=$this->page_largeur-$this->marge_droite-80;
   959| 			$hautcadre=40;
   960| 			$pdf->SetTextColor(0,0,0);
   961| 			$pdf->SetFont('','', $default_font_size - 2);
   962| 			$pdf->SetXY($posx,$posy-5);
   963| 			$pdf->MultiCell(66,5, $outputlangs->transnoentities("BillFrom").":", 0, 'L');
   964| 			$pdf->SetXY($posx,$posy);
   965| 			$pdf->SetFillColor(230,230,230);
   966| 			$pdf->MultiCell(82, $hautcadre, "", 0, 'R', 1);
   967| 			$pdf->SetTextColor(0,0,60);
   968| 			$pdf->SetXY($posx+2,$posy+3);
   969| 			$pdf->SetFont('','B', $default_font_size);
   970| 			$pdf->MultiCell(80, 4, $outputlangs->convToOutputCharset($this->emetteur->name), 0, 'L');
   971| 			$posy=$pdf->getY();
   972| 			$pdf->SetXY($posx+2,$posy);
   973| 			$pdf->SetFont('','', $default_font_size - 1);
   974| 			$pdf->MultiCell(80, 4, $carac_emetteur, 0, 'L');
   975| 			$usecontact=false;


# ====================================================================
# FILE: htdocs/core/tpl/admin_extrafields_view.tpl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-77 ---
    37| print '<table summary="listofattributes" class="noborder" width="100%">';
    38| print '<tr class="liste_titre">';
    39| print '<td align="left">'.$langs->trans("Position");
    40| print '<span class="nowrap"><img src="'.DOL_URL_ROOT.'/theme/'.$conf->theme.'/img/1downarrow.png" alt="" title="A-Z" class="imgdown"></span>';
    41| print '</td>';
    42| print '<td>'.$langs->trans("Label").'</td>';
    43| print '<td>'.$langs->trans("TranslationString").'</td>';
    44| print '<td>'.$langs->trans("AttributeCode").'</td>';
    45| print '<td>'.$langs->trans("Type").'</td>';
    46| print '<td align="right">'.$langs->trans("Size").'</td>';
    47| print '<td align="center">'.$langs->trans("Unique").'</td>';
    48| print '<td>'.$langs->trans("ComputedFormula").'</td>';
    49| print '<td align="center">'.$langs->trans("Required").'</td>';
    50| print '<td align="center">'.$langs->trans("AlwaysEditable").'</td>';
    51| print '<td align="center">'.$form->textwithpicto($langs->trans("Visible"), $langs->trans("VisibleDesc")).'</td>';
    52| if ($conf->multicompany->enabled)  {
    53| 	print '<td align="center">'.$langs->trans("Entities").'</td>';
    54| }
    55| print '<td width="80">&nbsp;</td>';
    56| print "</tr>\n";
    57| if (count($extrafields->attributes[$elementtype]['type']))
    58| {
    59| 	foreach($extrafields->attributes[$elementtype]['type'] as $key => $value)
    60| 	{
    61| 		if (! empty($extrafields->attributes[$elementtype]['langfile'][$key])) {
    62| 			$langs->load($extrafields->attributes[$elementtype]['langfile'][$key]);
    63| 		}
    64| 		print '<tr class="oddeven">';
    65| 		print "<td>".$extrafields->attributes[$elementtype]['pos'][$key]."</td>\n";
    66| 		print "<td>".$extrafields->attributes[$elementtype]['label'][$key]."</td>\n";	// We don't translate here, we want admin to know what is the key not translated value
    67| 		print "<td>".$langs->trans($extrafields->attributes[$elementtype]['label'][$key])."</td>\n";
    68| 		print "<td>".$key."</td>\n";
    69| 		print "<td>".$type2label[$extrafields->attributes[$elementtype]['type'][$key]]."</td>\n";
    70| 		print '<td align="right">'.$extrafields->attributes[$elementtype]['size'][$key]."</td>\n";
    71| 		print '<td align="center">'.yn($extrafields->attributes[$elementtype]['unique'][$key])."</td>\n";
    72| 		print '<td>'.dol_trunc($extrafields->attributes[$elementtype]['computed'][$key], 20)."</td>\n";
    73| 		print '<td align="center">'.yn($extrafields->attributes[$elementtype]['required'][$key])."</td>\n";
    74| 		print '<td align="center">'.yn($extrafields->attributes[$elementtype]['alwayseditable'][$key])."</td>\n";
    75| 		print '<td align="center">'.$extrafields->attributes[$elementtype]['list'][$key]."</td>\n";
    76| 		if (! empty($conf->multicompany->enabled))  {
    77| 			print '<td align="center">'.($extrafields->attributes[$elementtype]['entityid'][$key]==0?$langs->trans("All"):$extrafields->attributes[$elementtype]['entitylabel'][$key]).'</td>';


# ====================================================================
# FILE: htdocs/core/triggers/interface_50_modBlockedlog_ActionsBlockedLog.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 76-115 ---
    76| 		if ($action === 'PAYMENT_CUSTOMER_CREATE' || $action === 'PAYMENT_SUPPLIER_CREATE' || $action === 'DONATION_PAYMENT_CREATE'
    77| 			|| $action === 'PAYMENT_CUSTOMER_DELETE' || $action === 'PAYMENT_SUPPLIER_DELETE' || $action === 'DONATION_PAYMENT_DELETE')
    78| 		{
    79| 			$qualified++;
    80| 			$amounts = 0;
    81| 			if(!empty($object->amounts)) {
    82| 				foreach($object->amounts as $amount) {
    83| 					$amounts+= price2num($amount);
    84| 				}
    85| 			}
    86| 		}
    87| 		elseif (strpos($action,'PAYMENT')!==false && ! in_array($action, array('PAYMENT_ADD_TO_BANK')))
    88| 		{
    89| 			$qualified++;
    90| 			$amounts = (double) $object->amount;
    91| 		}
    92| 		if (! $qualified)
    93| 		{
    94| 			return 0; // not implemented action log
    95| 		}
    96| 		$result = $b->setObjectData($object, $action, $amounts);		// Set field date_object, ref_object, fk_object, element, object_data
    97| 		if ($result < 0)
    98| 		{
    99| 			$this->error = $b->error;
   100| 			$this->errors = $b->errors;
   101| 			return -1;
   102| 		}
   103| 		$res = $b->create($user);
   104| 		if ($res < 0)
   105| 		{
   106| 			$this->error = $b->error;
   107| 			$this->errors = $b->errors;
   108| 			return -1;
   109| 		}
   110| 		else
   111| 		{
   112| 			return 1;
   113| 		}
   114|     }
   115| }


# ====================================================================
# FILE: htdocs/cron/card.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 498-537 ---
   498| 	print '<tr class="blockmethod"><td>';
   499| 	print $langs->trans('CronObject')."</td><td>";
   500| 	print $object->objectname;
   501| 	print "</td></tr>";
   502| 	print '<tr class="blockmethod"><td>';
   503| 	print $langs->trans('CronMethod')."</td><td>";
   504| 	print $object->methodename;
   505| 	print "</td></tr>";
   506| 	print '<tr class="blockmethod"><td>';
   507| 	print $langs->trans('CronArgs')."</td><td>";
   508| 	print $object->params;
   509| 	print "</td></tr>";
   510| 	print '<tr class="blockcommand"><td>';
   511| 	print $langs->trans('CronCommand')."</td><td>";
   512| 	print $object->command;
   513| 	print "</td></tr>";
   514| 	print '<tr><td>';
   515| 	print $langs->trans('CronNote')."</td><td>";
   516| 	print $langs->trans($object->note);
   517| 	print "</td></tr>";
   518| 	print '</table>';
   519|     print '</div>';
   520| 	print '<br>';
   521| 	print '<div class="fichecenter">';
   522| 	print '<div class="underbanner clearboth"></div>';
   523| 	print '<table class="border" width="100%">';
   524| 	print '<tr><td class="titlefield">';
   525| 	print $langs->trans('CronEvery')."</td>";
   526| 	print "<td>";
   527| 	if($object->unitfrequency == "60") print $langs->trans('CronEach')." ".($object->frequency)." ".$langs->trans('Minutes');
   528| 	if($object->unitfrequency == "3600") print $langs->trans('CronEach')." ".($object->frequency)." ".$langs->trans('Hours');
   529| 	if($object->unitfrequency == "86400") print $langs->trans('CronEach')." ".($object->frequency)." ".$langs->trans('Days');
   530| 	if($object->unitfrequency == "604800") print $langs->trans('CronEach')." ".($object->frequency)." ".$langs->trans('Weeks');
   531| 	print "</td></tr>";
   532| 	print '<tr><td>';
   533| 	print $langs->trans('CronDtStart')."</td><td>";
   534| 	if(!empty($object->datestart)) {print dol_print_date($object->datestart,'dayhoursec');}
   535| 	print "</td></tr>";
   536| 	print "<tr><td>";
   537| 	print $langs->trans('CronDtEnd')."</td><td>";


# ====================================================================
# FILE: htdocs/cron/class/cronjob.class.php
# Total hunks: 13
# ====================================================================
# --- HUNK 1: Lines 11-50 ---
    11|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    12|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    13|  * GNU General Public License for more details.
    14|  *
    15|  * You should have received a copy of the GNU General Public License
    16|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    17|  */
    18| /**
    19|  *  \file       cron/class/cronjob.class.php
    20|  *  \ingroup    cron
    21|  */
    22| require_once(DOL_DOCUMENT_ROOT."/core/class/commonobject.class.php");
    23| /**
    24|  *	Crob Job class
    25|  */
    26| class Cronjob extends CommonObject
    27| {
    28| 	public $element='cronjob';			//!< Id that identify managed objects
    29| 	public $table_element='cronjob';		//!< Name of table without prefix where object is stored
    30|     public $picto = 'cron';
    31|     public $jobtype;
    32| 	public $tms='';
    33| 	public $datec='';
    34| 	public $label;
    35| 	public $command;
    36| 	public $classesname;
    37| 	public $objectname;
    38| 	public $methodename;
    39| 	public $params;
    40| 	public $md5params;
    41| 	public $module_name;
    42| 	public $priority;
    43| 	public $datelastrun='';
    44| 	public $datenextrun='';
    45| 	public $dateend='';
    46| 	public $datestart='';
    47| 	public $datelastresult='';
    48| 	public $lastresult;
    49| 	public $lastoutput;
    50| 	public $unitfrequency;

# --- HUNK 2: Lines 117-185 ---
   117| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->trans('CronCommand'));
   118| 			$error++;
   119| 		}
   120| 		if (($this->jobtype=='method') && (empty($this->classesname))) {
   121| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->trans('CronClass'));
   122| 			$error++;
   123| 		}
   124| 		if (($this->jobtype=='method' || $this->jobtype == 'function') && (empty($this->methodename))) {
   125| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->trans('CronMethod'));
   126| 			$error++;
   127| 		}
   128| 		if (($this->jobtype=='method') && (empty($this->objectname))) {
   129| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->trans('CronObject'));
   130| 			$error++;
   131| 		}
   132| 		if (($this->jobtype=='function') && (empty($this->libname))) {
   133| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->trans('CronLib'));
   134| 			$error++;
   135| 		}
   136| 		$sql = "INSERT INTO ".MAIN_DB_PREFIX."cronjob(";
   137| 		$sql.= "datec,";
   138| 		$sql.= "jobtype,";
   139| 		$sql.= "label,";
   140| 		$sql.= "command,";
   141| 		$sql.= "classesname,";
   142| 		$sql.= "objectname,";
   143| 		$sql.= "methodename,";
   144| 		$sql.= "params,";
   145| 		$sql.= "md5params,";
   146| 		$sql.= "module_name,";
   147| 		$sql.= "priority,";
   148| 		$sql.= "datelastrun,";
   149| 		$sql.= "datenextrun,";
   150| 		$sql.= "dateend,";
   151| 		$sql.= "datestart,";
   152| 		$sql.= "lastresult,";
   153| 		$sql.= "datelastresult,";
   154| 		$sql.= "lastoutput,";
   155| 		$sql.= "unitfrequency,";
   156| 		$sql.= "frequency,";
   157| 		$sql.= "status,";
   158| 		$sql.= "fk_user_author,";
   159| 		$sql.= "fk_user_mod,";
   160| 		$sql.= "note,";
   161| 		$sql.= "nbrun,";
   162| 		$sql.= "maxrun,";
   163| 		$sql.= "libname,";
   164| 		$sql.= "test";
   165| 		$sql.= ") VALUES (";
   166| 		$sql.= " '".$this->db->idate($now)."',";
   167| 		$sql.= " ".(! isset($this->jobtype)?'NULL':"'".$this->db->escape($this->jobtype)."'").",";
   168| 		$sql.= " ".(! isset($this->label)?'NULL':"'".$this->db->escape($this->label)."'").",";
   169| 		$sql.= " ".(! isset($this->command)?'NULL':"'".$this->db->escape($this->command)."'").",";
   170| 		$sql.= " ".(! isset($this->classesname)?'NULL':"'".$this->db->escape($this->classesname)."'").",";
   171| 		$sql.= " ".(! isset($this->objectname)?'NULL':"'".$this->db->escape($this->objectname)."'").",";
   172| 		$sql.= " ".(! isset($this->methodename)?'NULL':"'".$this->db->escape($this->methodename)."'").",";
   173| 		$sql.= " ".(! isset($this->params)?'NULL':"'".$this->db->escape($this->params)."'").",";
   174| 		$sql.= " ".(! isset($this->md5params)?'NULL':"'".$this->db->escape($this->md5params)."'").",";
   175| 		$sql.= " ".(! isset($this->module_name)?'NULL':"'".$this->db->escape($this->module_name)."'").",";
   176| 		$sql.= " ".(! isset($this->priority)?'0':$this->priority).",";
   177| 		$sql.= " ".(! isset($this->datelastrun) || dol_strlen($this->datelastrun)==0?'NULL':"'".$this->db->idate($this->datelastrun)."'").",";
   178| 		$sql.= " ".(! isset($this->datenextrun) || dol_strlen($this->datenextrun)==0?'NULL':"'".$this->db->idate($this->datenextrun)."'").",";
   179| 		$sql.= " ".(! isset($this->dateend) || dol_strlen($this->dateend)==0?'NULL':"'".$this->db->idate($this->dateend)."'").",";
   180| 		$sql.= " ".(! isset($this->datestart) || dol_strlen($this->datestart)==0?'NULL':"'".$this->db->idate($this->datestart)."'").",";
   181| 		$sql.= " ".(! isset($this->lastresult)?'NULL':"'".$this->db->escape($this->lastresult)."'").",";
   182| 		$sql.= " ".(! isset($this->datelastresult) || dol_strlen($this->datelastresult)==0?'NULL':"'".$this->db->idate($this->datelastresult)."'").",";
   183| 		$sql.= " ".(! isset($this->lastoutput)?'NULL':"'".$this->db->escape($this->lastoutput)."'").",";
   184| 		$sql.= " ".(! isset($this->unitfrequency)?'NULL':"'".$this->db->escape($this->unitfrequency)."'").",";
   185| 		$sql.= " ".(! isset($this->frequency)?'0':$this->frequency).",";

# --- HUNK 3: Lines 211-251 ---
   211| 	            $this->error.=($this->error?', '.$errmsg:$errmsg);
   212| 			}
   213| 			$this->db->rollback();
   214| 			return -1*$error;
   215| 		}
   216| 		else
   217| 		{
   218| 			$this->db->commit();
   219|             return $this->id;
   220| 		}
   221|     }
   222|     /**
   223|      *  Load object in memory from the database
   224|      *
   225|      *  @param	int		$id    Id object
   226|      *  @return int          	<0 if KO, >0 if OK
   227|      */
   228|     function fetch($id)
   229|     {
   230|         $sql = "SELECT";
   231| 		$sql.= " t.rowid,";
   232| 		$sql.= " t.tms,";
   233| 		$sql.= " t.datec,";
   234| 		$sql.= " t.jobtype,";
   235| 		$sql.= " t.label,";
   236| 		$sql.= " t.command,";
   237| 		$sql.= " t.classesname,";
   238| 		$sql.= " t.objectname,";
   239| 		$sql.= " t.methodename,";
   240| 		$sql.= " t.params,";
   241| 		$sql.= " t.md5params,";
   242| 		$sql.= " t.module_name,";
   243| 		$sql.= " t.priority,";
   244| 		$sql.= " t.datelastrun,";
   245| 		$sql.= " t.datenextrun,";
   246| 		$sql.= " t.dateend,";
   247| 		$sql.= " t.datestart,";
   248| 		$sql.= " t.lastresult,";
   249| 		$sql.= " t.datelastresult,";
   250| 		$sql.= " t.lastoutput,";
   251| 		$sql.= " t.unitfrequency,";

# --- HUNK 4: Lines 253-292 ---
   253| 		$sql.= " t.status,";
   254| 		$sql.= " t.processing,";
   255| 		$sql.= " t.fk_user_author,";
   256| 		$sql.= " t.fk_user_mod,";
   257| 		$sql.= " t.note,";
   258| 		$sql.= " t.nbrun,";
   259| 		$sql.= " t.maxrun,";
   260| 		$sql.= " t.libname,";
   261| 		$sql.= " t.test";
   262|         $sql.= " FROM ".MAIN_DB_PREFIX."cronjob as t";
   263|         $sql.= " WHERE t.rowid = ".$id;
   264|     	dol_syslog(get_class($this)."::fetch", LOG_DEBUG);
   265|         $resql=$this->db->query($sql);
   266|         if ($resql)
   267|         {
   268|             if ($this->db->num_rows($resql))
   269|             {
   270|                 $obj = $this->db->fetch_object($resql);
   271|                 $this->id    = $obj->rowid;
   272|                 $this->ref = $obj->rowid;
   273| 				$this->tms = $this->db->jdate($obj->tms);
   274| 				$this->datec = $this->db->jdate($obj->datec);
   275| 				$this->label = $obj->label;
   276| 				$this->jobtype = $obj->jobtype;
   277| 				$this->command = $obj->command;
   278| 				$this->classesname = $obj->classesname;
   279| 				$this->objectname = $obj->objectname;
   280| 				$this->methodename = $obj->methodename;
   281| 				$this->params = $obj->params;
   282| 				$this->md5params = $obj->md5params;
   283| 				$this->module_name = $obj->module_name;
   284| 				$this->priority = $obj->priority;
   285| 				$this->datelastrun = $this->db->jdate($obj->datelastrun);
   286| 				$this->datenextrun = $this->db->jdate($obj->datenextrun);
   287| 				$this->dateend = $this->db->jdate($obj->dateend);
   288| 				$this->datestart = $this->db->jdate($obj->datestart);
   289| 				$this->lastresult = $obj->lastresult;
   290| 				$this->lastoutput = $obj->lastoutput;
   291| 				$this->datelastresult = $this->db->jdate($obj->datelastresult);
   292| 				$this->unitfrequency = $obj->unitfrequency;

# --- HUNK 5: Lines 353-393 ---
   353|     	$sql.= " t.status,";
   354|     	$sql.= " t.processing,";
   355|     	$sql.= " t.fk_user_author,";
   356|     	$sql.= " t.fk_user_mod,";
   357|     	$sql.= " t.note,";
   358|     	$sql.= " t.nbrun,";
   359|     	$sql.= " t.libname,";
   360|     	$sql.= " t.test";
   361|     	$sql.= " FROM ".MAIN_DB_PREFIX."cronjob as t";
   362|     	$sql.= " WHERE 1 = 1";
   363|     	if ($processing >= 0) $sql.= " AND t.processing = ".(empty($processing)?'0':'1');
   364|     	if ($status >= 0 && $status < 2) $sql.= " AND t.status = ".(empty($status)?'0':'1');
   365|     	if ($status == 2) $sql.= " AND t.status = 2";
   366|     	if (is_array($filter) && count($filter)>0) {
   367|     		foreach($filter as $key => $value)
   368|     		{
   369|     		    if ($key == 't.rowid') $sql.= ' AND '.$key.' = '.$this->db->escape($value);
   370|    				else $sql.= ' AND '.$key.' LIKE \'%'.$this->db->escape($value).'%\'';
   371|     		}
   372|     	}
   373|     	$sql.= " ORDER BY $sortfield $sortorder ";
   374|     	if (!empty($limit) && !empty($offset)) {
   375|     		$sql.= $this->db->plimit($limit + 1,$offset);
   376|     	}
   377|     	$sqlwhere = array();
   378|     	if (count($sqlwhere)>0) {
   379|     		$sql.= " WHERE ".implode(' AND ',$sqlwhere);
   380|     	}
   381|     	dol_syslog(get_class($this)."::fetch_all", LOG_DEBUG);
   382|     	$resql=$this->db->query($sql);
   383|     	if ($resql)
   384|     	{
   385|     		$num=$this->db->num_rows($resql);
   386|     		$i=0;
   387|     		if ($num)
   388|     		{
   389| 	    		while ($i < $num)
   390| 	    		{
   391| 	    			$line = new Cronjobline();
   392| 	    			$obj = $this->db->fetch_object($resql);
   393| 	    			$line->id    = $obj->rowid;

# --- HUNK 6: Lines 488-527 ---
   488| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->transnoentitiesnoconv('CronCommand'));
   489| 			$error++;
   490| 		}
   491| 		if (($this->jobtype=='method') && (empty($this->classesname))) {
   492| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->transnoentitiesnoconv('CronClass'));
   493| 			$error++;
   494| 		}
   495| 		if (($this->jobtype=='method' || $this->jobtype == 'function') && (empty($this->methodename))) {
   496| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->transnoentitiesnoconv('CronMethod'));
   497| 			$error++;
   498| 		}
   499| 		if (($this->jobtype=='method') && (empty($this->objectname))) {
   500| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->transnoentitiesnoconv('CronObject'));
   501| 			$error++;
   502| 		}
   503| 		if (($this->jobtype=='function') && (empty($this->libname))) {
   504| 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->transnoentitiesnoconv('CronLib'));
   505| 			$error++;
   506| 		}
   507|         $sql = "UPDATE ".MAIN_DB_PREFIX."cronjob SET";
   508| 		$sql.= " label=".(isset($this->label)?"'".$this->db->escape($this->label)."'":"null").",";
   509| 		$sql.= " jobtype=".(isset($this->jobtype)?"'".$this->db->escape($this->jobtype)."'":"null").",";
   510| 		$sql.= " command=".(isset($this->command)?"'".$this->db->escape($this->command)."'":"null").",";
   511| 		$sql.= " classesname=".(isset($this->classesname)?"'".$this->db->escape($this->classesname)."'":"null").",";
   512| 		$sql.= " objectname=".(isset($this->objectname)?"'".$this->db->escape($this->objectname)."'":"null").",";
   513| 		$sql.= " methodename=".(isset($this->methodename)?"'".$this->db->escape($this->methodename)."'":"null").",";
   514| 		$sql.= " params=".(isset($this->params)?"'".$this->db->escape($this->params)."'":"null").",";
   515| 		$sql.= " md5params=".(isset($this->md5params)?"'".$this->db->escape($this->md5params)."'":"null").",";
   516| 		$sql.= " module_name=".(isset($this->module_name)?"'".$this->db->escape($this->module_name)."'":"null").",";
   517| 		$sql.= " priority=".(isset($this->priority)?$this->priority:"null").",";
   518| 		$sql.= " datelastrun=".(dol_strlen($this->datelastrun)!=0 ? "'".$this->db->idate($this->datelastrun)."'" : 'null').",";
   519| 		$sql.= " datenextrun=".(dol_strlen($this->datenextrun)!=0 ? "'".$this->db->idate($this->datenextrun)."'" : 'null').",";
   520| 		$sql.= " dateend=".(dol_strlen($this->dateend)!=0 ? "'".$this->db->idate($this->dateend)."'" : 'null').",";
   521| 		$sql.= " datestart=".(dol_strlen($this->datestart)!=0 ? "'".$this->db->idate($this->datestart)."'" : 'null').",";
   522| 		$sql.= " datelastresult=".(dol_strlen($this->datelastresult)!=0 ? "'".$this->db->idate($this->datelastresult)."'" : 'null').",";
   523| 		$sql.= " lastresult=".(isset($this->lastresult)?"'".$this->db->escape($this->lastresult)."'":"null").",";
   524| 		$sql.= " lastoutput=".(isset($this->lastoutput)?"'".$this->db->escape($this->lastoutput)."'":"null").",";
   525| 		$sql.= " unitfrequency=".(isset($this->unitfrequency)?$this->unitfrequency:"null").",";
   526| 		$sql.= " frequency=".(isset($this->frequency)?$this->frequency:"null").",";
   527| 		$sql.= " status=".(isset($this->status)?$this->status:"null").",";

# --- HUNK 7: Lines 621-660 ---
   621| 		{
   622| 			$this->db->commit();
   623| 			return $object->id;
   624| 		}
   625| 		else
   626| 		{
   627| 			$this->db->rollback();
   628| 			return -1;
   629| 		}
   630| 	}
   631| 	/**
   632| 	 *	Initialise object with example values
   633| 	 *	Id must be 0 if object instance is a specimen
   634| 	 *
   635| 	 *	@return	void
   636| 	 */
   637| 	function initAsSpecimen()
   638| 	{
   639| 		$this->id=0;
   640| 		$this->ref=0;
   641| 		$this->tms='';
   642| 		$this->datec='';
   643| 		$this->label='';
   644| 		$this->jobtype='';
   645| 		$this->command='';
   646| 		$this->classesname='';
   647| 		$this->objectname='';
   648| 		$this->methodename='';
   649| 		$this->params='';
   650| 		$this->md5params='';
   651| 		$this->module_name='';
   652| 		$this->priority='';
   653| 		$this->datelastrun='';
   654| 		$this->datenextrun='';
   655| 		$this->dateend='';
   656| 		$this->datestart='';
   657| 		$this->datelastresult='';
   658| 		$this->lastoutput='';
   659| 		$this->lastresult='';
   660| 		$this->unitfrequency='';

# --- HUNK 8: Lines 754-833 ---
   754| 	 * Run a job.
   755| 	 * Once job is finished, status and nb of run is updated.
   756| 	 * This function does not plan the next run. This is done by function ->reprogram_jobs
   757| 	 *
   758| 	 * @param   string		$userlogin    	User login
   759| 	 * @return	int					 		<0 if KO, >0 if OK
   760| 	 */
   761| 	function run_jobs($userlogin)
   762| 	{
   763| 		global $langs, $conf;
   764| 		$now=dol_now();
   765| 		$error = 0;
   766| 		$retval = '';
   767| 		$langs->load('cron');
   768| 		if (empty($userlogin))
   769| 		{
   770| 			$this->error="User login is mandatory";
   771| 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
   772| 			return -1;
   773| 		}
   774| 		require_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';
   775| 		$user=new User($this->db);
   776| 		$result=$user->fetch('',$userlogin);
   777| 		if ($result<0)
   778| 		{
   779| 			$this->error="User Error:".$user->error;
   780| 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
   781| 			return -1;
   782| 		}
   783| 		else
   784| 		{
   785| 			if (empty($user->id))
   786| 			{
   787| 				$this->error=" User user login:".$userlogin." do not exists";
   788| 				dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
   789| 				return -1;
   790| 			}
   791| 		}
   792| 		dol_syslog(get_class($this)."::run_jobs jobtype=".$this->jobtype." userlogin=".$userlogin, LOG_DEBUG);
   793| 		$ExecTimeLimit=600;
   794| 		if (!empty($ExecTimeLimit))
   795| 		{
   796| 			$err=error_reporting();
   797| 			error_reporting(0);     // Disable all errors
   798| 			@set_time_limit($ExecTimeLimit);   // Need more than 240 on Windows 7/64
   799| 			error_reporting($err);
   800| 		}
   801| 		if (!empty($MemoryLimit))
   802| 		{
   803| 			@ini_set('memory_limit', $MemoryLimit);
   804| 		}
   805| 		$this->datelastrun=$now;
   806| 		$this->datelastresult=null;
   807| 		$this->lastoutput='';
   808| 		$this->lastresult='';
   809| 		$this->processing = 1;                // To know job was started
   810| 		$this->nbrun=$this->nbrun + 1;
   811| 		$result = $this->update($user);       // This include begin/commit
   812| 		if ($result<0) {
   813| 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
   814| 			return -1;
   815| 		}
   816| 		if ($this->jobtype=='method')
   817| 		{
   818| 			if (! $error)
   819| 			{
   820| 				$ret=dol_include_once($this->classesname);
   821| 				if ($ret===false || (! class_exists($this->objectname)))
   822| 				{
   823| 					$this->error=$langs->trans('CronCannotLoadClass',$this->classesname,$this->objectname);
   824| 					dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
   825| 					$this->lastoutput = $this->error;
   826| 					$this->lastresult = -1;
   827| 					$retval = $this->lastresult;
   828| 					$error++;
   829| 				}
   830| 			}
   831| 			if (! $error)
   832| 			{
   833| 			    if (! method_exists($this->objectname, $this->methodename))

# --- HUNK 9: Lines 840-921 ---
   840|     				$error++;
   841| 			    }
   842| 			}
   843| 			if (! $error)
   844| 			{
   845| 				$result=$langs->load($this->module_name.'@'.$this->module_name);
   846| 				if ($result < 0)
   847| 				{
   848| 					dol_syslog(get_class($this)."::run_jobs Cannot load module lang file - ".$langs->error, LOG_ERR);
   849| 					$this->error = $langs->error;
   850| 					$this->lastoutput = $this->error;
   851| 					$this->lastresult = -1;
   852| 	                $retval = $this->lastresult;
   853| 	                $error++;
   854| 				}
   855| 			}
   856| 			if (! $error)
   857| 			{
   858| 				dol_syslog(get_class($this)."::run_jobs START ".$this->objectname."->".$this->methodename."(".$this->params.");", LOG_DEBUG);
   859| 				$object = new $this->objectname($this->db);
   860| 				$params_arr = array_map('trim', explode(",",$this->params));
   861| 				if (!is_array($params_arr))
   862| 				{
   863| 					$result = call_user_func(array($object, $this->methodename), $this->params);
   864| 				}
   865| 				else
   866| 				{
   867| 					$result = call_user_func_array(array($object, $this->methodename), $params_arr);
   868| 				}
   869| 				if ($result === false || (! is_bool($result) && $result != 0))
   870| 				{
   871| 				    $langs->load("errors");
   872| 					dol_syslog(get_class($this)."::run_jobs END result=".$result." error=".$object->error, LOG_ERR);
   873| 				    $this->error = $object->error?$object->error:$langs->trans('ErrorUnknown');
   874| 					$this->lastoutput = ($object->output?$object->output."\n":"").$this->error;
   875| 					$this->lastresult = is_numeric($result)?$result:-1;
   876| 		            $retval = $this->lastresult;
   877| 		            $error++;
   878| 				}
   879| 				else
   880| 				{
   881| 					dol_syslog(get_class($this)."::run_jobs END");
   882| 				    $this->lastoutput=$object->output;
   883| 					$this->lastresult=var_export($result,true);
   884| 					$retval = $this->lastresult;
   885| 				}
   886| 			}
   887| 		}
   888| 		if($this->jobtype == 'function')
   889| 		{
   890| 			$libpath = '/' . strtolower($this->module_name) . '/lib/' . $this->libname;
   891| 			$ret = dol_include_once($libpath);
   892| 			if ($ret === false)
   893| 			{
   894| 				$this->error = $langs->trans('CronCannotLoadLib') . ': ' . $libpath;
   895| 				dol_syslog(get_class($this) . "::run_jobs " . $this->error, LOG_ERR);
   896| 				return -1;
   897| 			}
   898| 			$result=$langs->load($this->module_name . '@' . $this->module_name);
   899| 			if ($result<0)
   900| 			{
   901| 				dol_syslog(get_class($this) . "::run_jobs Cannot load module langs" . $langs->error, LOG_ERR);
   902| 				return -1;
   903| 			}
   904| 			dol_syslog(get_class($this) . "::run_jobs " . $this->libname . "::" . $this->methodename."(" . $this->params . ");", LOG_DEBUG);
   905| 			$params_arr = explode(", ", $this->params);
   906| 			if (!is_array($params_arr))
   907| 			{
   908| 				$result = call_user_func($this->methodename, $this->params);
   909| 			}
   910| 			else
   911| 			{
   912| 				$result = call_user_func_array($this->methodename, $params_arr);
   913| 			}
   914| 			if ($result === false || (! is_bool($result) && $result != 0))
   915| 			{
   916| 			    $langs->load("errors");
   917| 			    dol_syslog(get_class($this)."::run_jobs result=".$result, LOG_ERR);
   918| 			    $this->error = $langs->trans('ErrorUnknown');
   919| 			    $this->lastoutput = $this->error;
   920| 			    $this->lastresult = is_numeric($result)?$result:-1;
   921| 			    $retval = $this->lastresult;

# --- HUNK 10: Lines 935-980 ---
   935| 			if (! empty($outputdir))
   936| 			{
   937| 				dol_mkdir($outputdir);
   938| 				$outputfile=$outputdir.'/cronjob.'.$userlogin.'.out';	// File used with popen method
   939| 				include_once DOL_DOCUMENT_ROOT.'/core/class/utils.class.php';
   940| 				$utils = new Utils($this->db);
   941| 				$arrayresult = $utils->executeCLI($this->command, $outputfile);
   942| 				$retval = $arrayresult['result'];
   943| 				$this->error      = $arrayresult['error'];
   944| 				$this->lastoutput = $arrayresult['output'];
   945| 				$this->lastresult = $arrayresult['result'];
   946| 			}
   947| 		}
   948| 		dol_syslog(get_class($this)."::run_jobs now we update job to track it is finished (with success or error)");
   949| 		$this->datelastresult=dol_now();
   950| 		$this->processing=0;
   951| 		$result = $this->update($user);       // This include begin/commit
   952| 		if ($result < 0)
   953| 		{
   954| 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
   955| 			return -1;
   956| 		}
   957| 		else
   958| 		{
   959| 			return $error?-1:1;
   960| 		}
   961| 	}
   962| 	/**
   963| 	 * Reprogram a job
   964| 	 *
   965| 	 * @param  string		$userlogin      User login
   966| 	 * @param  timestamp    $now            Date returned by dol_now()
   967| 	 * @return int					        <0 if KO, >0 if OK
   968| 	 */
   969| 	function reprogram_jobs($userlogin, $now)
   970| 	{
   971| 		dol_syslog(get_class($this)."::reprogram_jobs userlogin:$userlogin", LOG_DEBUG);
   972| 		require_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';
   973| 		$user=new User($this->db);
   974| 		$result=$user->fetch('',$userlogin);
   975| 		if ($result<0)
   976| 		{
   977| 			$this->error="User Error:".$user->error;
   978| 			dol_syslog(get_class($this)."::reprogram_jobs ".$this->error, LOG_ERR);
   979| 			return -1;
   980| 		}


# ====================================================================
# FILE: htdocs/cron/list.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 131-171 ---
   131| $sql.= " t.md5params,";
   132| $sql.= " t.module_name,";
   133| $sql.= " t.priority,";
   134| $sql.= " t.datelastrun,";
   135| $sql.= " t.datenextrun,";
   136| $sql.= " t.dateend,";
   137| $sql.= " t.datestart,";
   138| $sql.= " t.lastresult,";
   139| $sql.= " t.datelastresult,";
   140| $sql.= " t.lastoutput,";
   141| $sql.= " t.unitfrequency,";
   142| $sql.= " t.frequency,";
   143| $sql.= " t.status,";
   144| $sql.= " t.fk_user_author,";
   145| $sql.= " t.fk_user_mod,";
   146| $sql.= " t.note,";
   147| $sql.= " t.nbrun,";
   148| $sql.= " t.libname,";
   149| $sql.= " t.test";
   150| $sql.= " FROM ".MAIN_DB_PREFIX."cronjob as t";
   151| $sql.= " WHERE 1 = 1";
   152| if ($status >= 0 && $status < 2) $sql.= " AND t.status = ".(empty($status)?'0':'1');
   153| if ($status == 2) $sql.= " AND t.status = 2";
   154| if (is_array($filter) && count($filter)>0) {
   155| 	foreach($filter as $key => $value) {
   156| 		$sql.= ' AND '.$key.' LIKE \'%'.$value.'%\'';
   157| 	}
   158| }
   159| $sqlwhere = array();
   160| if (!empty($module_name)) {
   161| 	$sqlwhere[]='(t.module_name='.$module_name.')';
   162| }
   163| if (count($sqlwhere)>0) {
   164| 	$sql.= " WHERE ".implode(' AND ',$sqlwhere);
   165| }
   166| include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_sql.tpl.php';
   167| $parameters=array();
   168| $reshook=$hookmanager->executeHooks('printFieldListWhere',$parameters);    // Note that $action and $object may have been modified by hook
   169| $sql.=$hookmanager->resPrint;
   170| $sql.= $db->order($sortfield,$sortorder);
   171| $nbtotalofrecords = '';


# ====================================================================
# FILE: htdocs/expensereport/card.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 883-925 ---
   883|     	}
   884|         /* Projects are never required. To force them, check module forceproject
   885|     	if ($conf->projet->enabled)
   886|     	{
   887|     		if (empty($object_ligne->fk_projet) || $object_ligne->fk_projet==-1)
   888|     		{
   889|     			$error++;
   890|     			setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Project")), null, 'errors');
   891|     		}
   892|     	}*/
   893|     	if (empty($date) || $date=="--")
   894|     	{
   895|     		$error++;
   896|     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Date")), null, 'errors');
   897|     	}
   898|     	if ($value_unit==0)
   899|     	{
   900|     		$error++;
   901|     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("PriceUTTC")), null, 'errors');
   902|     	}
   903|     	if (! $error)
   904|     	{
   905|     		$type = 0;	// TODO What if service ?
   906| 			$result = $object->addline($qty,$value_unit,$fk_c_type_fees,$vatrate,$date,$comments,$fk_projet,$fk_c_exp_tax_cat,$type);
   907| 			if ($result > 0) {
   908| 				$ret = $object->fetch($object->id); // Reload to get new records
   909| 				if (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE)) {
   910| 					$outputlangs = $langs;
   911| 					$newlang = GETPOST('lang_id', 'alpha');
   912| 					if (! empty($conf->global->MAIN_MULTILANGS) && empty($newlang))
   913| 						$newlang = $object->thirdparty->default_lang;
   914| 					if (! empty($newlang)) {
   915| 						$outputlangs = new Translate("", $conf);
   916| 						$outputlangs->setDefaultLang($newlang);
   917| 					}
   918| 					$object->generateDocument($object->modelpdf, $outputlangs, $hidedetails, $hidedesc, $hideref);
   919| 				}
   920| 				unset($qty);
   921| 				unset($value_unit);
   922| 				unset($vatrate);
   923| 				unset($comments);
   924| 				unset($fk_c_type_fees);
   925| 				unset($fk_projet);

# --- HUNK 2: Lines 975-1040 ---
   975|     	$type_fees_id = GETPOST('fk_c_type_fees', 'int');
   976| 		$fk_c_exp_tax_cat = GETPOST('fk_c_exp_tax_cat', 'int');
   977|     	$projet_id = $fk_projet;
   978|     	$comments = GETPOST('comments', 'none');
   979|     	$qty = GETPOST('qty', 'int');
   980|     	$value_unit = price2num(GETPOST('value_unit', 'alpha'), 'MU');
   981|     	$vatrate = GETPOST('vatrate', 'alpha');
   982|         if (empty($vatrate)) $vatrate = "0.000";
   983|         $vatrate = price2num($vatrate);
   984|     	if (! GETPOST('fk_c_type_fees', 'int') > 0)
   985|     	{
   986|     		$error++;
   987|     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Type")), null, 'errors');
   988|     		$action='';
   989|     	}
   990|     	if ((int) $vatrate < 0 || $vatrate == '')
   991|     	{
   992|     		$error++;
   993|     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Vat")), null, 'errors');
   994|     		$action='';
   995|     	}
   996|     	if (! $error)
   997|     	{
   998|     		$result = $object->updateline($rowid, $type_fees_id, $projet_id, $vatrate, $comments, $qty, $value_unit, $date, $id, $fk_c_exp_tax_cat);
   999|     		if ($result >= 0)
  1000|     		{
  1001|     			if ($result > 0)
  1002|     			{
  1003|     				if (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE))
  1004|     				{
  1005|     					$outputlangs = $langs;
  1006|     					$newlang = '';
  1007|     					if ($conf->global->MAIN_MULTILANGS && empty($newlang) && GETPOST('lang_id','aZ09')) $newlang = GETPOST('lang_id','aZ09');
  1008|     					if ($conf->global->MAIN_MULTILANGS && empty($newlang))	$newlang = $object->thirdparty->default_lang;
  1009|     					if (! empty($newlang)) {
  1010|     						$outputlangs = new Translate("", $conf);
  1011|     						$outputlangs->setDefaultLang($newlang);
  1012|     					}
  1013|     					$model=$object->modelpdf;
  1014|     					$ret = $object->fetch($id); // Reload to get new records
  1015|     					$object->generateDocument($model, $outputlangs, $hidedetails, $hidedesc, $hideref);
  1016|     				}
  1017|     			}
  1018|     			$result = $object->recalculer($id);
  1019|     			header("Location: ".$_SERVER["PHP_SELF"]."?id=".$id);
  1020|     			exit;
  1021|     		}
  1022|     		else
  1023|     		{
  1024|     			setEventMessages($object->error, $object->errors, 'errors');
  1025|     		}
  1026|     	}
  1027|     }
  1028|     include DOL_DOCUMENT_ROOT.'/core/actions_printing.inc.php';
  1029|     $trigger_name='EXPENSEREPORT_SENTBYMAIL';
  1030|     $autocopy='MAIN_MAIL_AUTOCOPY_EXPENSEREPORT_TO';
  1031|     $trackid='exp'.$object->id;
  1032|     include DOL_DOCUMENT_ROOT.'/core/actions_sendmails.inc.php';
  1033|     $upload_dir = $conf->expensereport->dir_output;
  1034|     $permissioncreate = $user->rights->expensereport->creer;
  1035|     include DOL_DOCUMENT_ROOT.'/core/actions_builddoc.inc.php';
  1036| }
  1037| /*
  1038|  * View
  1039|  */
  1040| $title=$langs->trans("ExpenseReport") . " - " . $langs->trans("Card");

# --- HUNK 3: Lines 1655-1695 ---
  1655| 								print '<a href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=editline&amp;rowid='.$line->rowid.'#'.$line->rowid.'">';
  1656| 								print img_edit();
  1657| 								print '</a> &nbsp; ';
  1658| 								print '<a href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=delete_line&amp;rowid='.$line->rowid.'">';
  1659| 								print img_delete();
  1660| 								print '</a>';
  1661| 								print '</td>';
  1662| 							}
  1663| 							print '</tr>';
  1664| 						}
  1665| 						if ($action == 'editline' && $line->rowid == GETPOST('rowid', 'int'))
  1666| 						{
  1667| 								print '<tr class="oddeven">';
  1668| 								print '<td></td>';
  1669| 								print '<td class="center">';
  1670| 								$form->select_date($line->date,'date');
  1671| 								print '</td>';
  1672| 								if (! empty($conf->projet->enabled))
  1673| 								{
  1674| 									print '<td>';
  1675| 									$formproject->select_projects(-1, $line->fk_projet,'fk_projet', 0, 0, 1, 1);
  1676| 									print '</td>';
  1677| 								}
  1678| 								if (!empty($conf->global->MAIN_USE_EXPENSE_IK))
  1679| 								{
  1680| 									print '<td class="fk_c_exp_tax_cat">';
  1681| 									$params = array('fk_expense' => $object->id, 'fk_expense_det' => $line->rowid, 'date' => $line->dates);
  1682| 									print $form->selectExpenseCategories($line->fk_c_exp_tax_cat, 'fk_c_exp_tax_cat', 1, array(), 'fk_c_type_fees', $userauthor->default_c_exp_tax_cat, $params);
  1683| 									print '</td>';
  1684| 								}
  1685| 								print '<td class="center">';
  1686| 								select_type_fees_id($line->fk_c_type_fees,'fk_c_type_fees');
  1687| 								print '</td>';
  1688| 								print '<td>';
  1689| 								print '<textarea name="comments" class="flat_ndf centpercent">'.dol_escape_htmltag($line->comments).'</textarea>';
  1690| 								print '</td>';
  1691| 								print '<td style="text-align:right;">';
  1692| 								print $form->load_tva('vatrate', (isset($_POST["vatrate"])?$_POST["vatrate"]:$line->vatrate), $mysoc, '');
  1693| 								print '</td>';
  1694| 								print '<td style="text-align:right;">';
  1695| 								print '<input type="text" min="0" class="maxwidth100" name="value_unit" value="'.dol_escape_htmltag($line->value_unit).'" />';


# ====================================================================
# FILE: htdocs/expensereport/class/expensereport.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1012-1052 ---
  1012|                 $this->error=$this->db->lasterror();
  1013|                 return -1;
  1014|             }
  1015|         }
  1016|         else
  1017|         {
  1018|             dol_syslog(get_class($this)."::set_save_from_refuse expensereport already with save status", LOG_WARNING);
  1019|         }
  1020|     }
  1021|     /**
  1022|      * Set status to approved
  1023|      *
  1024|      * @param   User    $fuser      User
  1025| 	 * @param   int     $notrigger  Disable triggers
  1026|      * @return  int                 <0 if KO, 0 if nothing done, >0 if OK
  1027|      */
  1028|     function setApproved($fuser, $notrigger=0)
  1029|     {
  1030|         $now=dol_now();
  1031| 		$error = 0;
  1032|         $this->date_approve = $this->db->idate($now);
  1033|         if ($this->fk_statut != 5)
  1034|         {
  1035| 			$this->db->begin();
  1036|             $sql = 'UPDATE '.MAIN_DB_PREFIX.$this->table_element;
  1037|             $sql.= " SET ref = '".$this->db->escape($this->ref)."', fk_statut = 5, fk_user_approve = ".$fuser->id.",";
  1038|             $sql.= " date_approve='".$this->db->idate($this->date_approve)."'";
  1039|             $sql.= ' WHERE rowid = '.$this->id;
  1040|             if ($this->db->query($sql))
  1041|             {
  1042|                 if (!$notrigger)
  1043| 				{
  1044| 					$result=$this->call_trigger('EXPENSE_REPORT_APPROVE',$fuser);
  1045| 					if ($result < 0) {
  1046| 						$error++;
  1047| 					}
  1048| 				}
  1049| 				if (empty($error))
  1050| 				{
  1051| 					$this->db->commit();
  1052| 					return 1;

# --- HUNK 2: Lines 1391-1430 ---
  1391| 	 * @param    int         $type               Type line
  1392| 	 * @return   int                             <0 if KO, >0 if OK
  1393| 	 */
  1394| 	function addline($qty=0, $up=0, $fk_c_type_fees=0, $vatrate=0, $date='', $comments='', $fk_project=0, $fk_c_exp_tax_cat=0, $type=0)
  1395| 	{
  1396| 		global $conf,$langs;
  1397|         dol_syslog(get_class($this)."::addline qty=$qty, up=$up, fk_c_type_fees=$fk_c_type_fees, vatrate=$vatrate, date=$date, fk_project=$fk_project, type=$type, comments=$comments", LOG_DEBUG);
  1398| 		if (empty($qty)) $qty = 0;
  1399| 		if (empty($fk_c_type_fees) || $fk_c_type_fees < 0) $fk_c_type_fees = 0;
  1400| 		if (empty($fk_c_exp_tax_cat) || $fk_c_exp_tax_cat < 0) $fk_c_exp_tax_cat = 0;
  1401| 		if (empty($vatrate) || $vatrate < 0) $vatrate = 0;
  1402| 		if (empty($date)) $date = '';
  1403| 		if (empty($fk_project)) $fk_project = 0;
  1404| 		$qty = price2num($qty);
  1405| 		$vatrate = price2num($vatrate);
  1406| 		$up = price2num($up);
  1407| 		if ($this->fk_statut == self::STATUS_DRAFT)
  1408|         {
  1409| 			$this->db->begin();
  1410| 			$this->line = new ExpenseReportLine($this->db);
  1411| 			$seller = '';  // seller is unknown
  1412| 			$tmp = calcul_price_total($qty, $up, 0, $vatrate, 0, 0, 0, 'TTC', 0, $type, $seller);
  1413| 			$this->line->value_unit = $up;
  1414| 			$this->line->vatrate = price2num($vatrate);
  1415| 			$this->line->total_ttc = $tmp[2];
  1416| 			$this->line->total_ht = $tmp[0];
  1417| 			$this->line->total_tva = $tmp[1];
  1418| 			$this->line->fk_expensereport = $this->id;
  1419| 			$this->line->qty = $qty;
  1420| 			$this->line->date = $date;
  1421| 			$this->line->fk_c_type_fees = $fk_c_type_fees;
  1422| 			$this->line->fk_c_exp_tax_cat = $fk_c_exp_tax_cat;
  1423| 			$this->line->comments = $comments;
  1424| 			$this->line->fk_projet = $fk_project;
  1425| 			$this->applyOffset();
  1426| 			$this->checkRules($type, $seller);
  1427| 			$result=$this->line->insert(0, true);
  1428|             if ($result > 0)
  1429|             {
  1430|                 $result=$this->update_price();	// This method is designed to add line from user input so total calculation must be done using 'auto' mode.


# ====================================================================
# FILE: htdocs/expensereport/list.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 43-83 ---
    43| if ($user->societe_id) $socid=$user->societe_id;
    44| $result = restrictedArea($user, 'expensereport','','');
    45| $diroutputmassaction=$conf->expensereport->dir_output . '/temp/massgeneration/'.$user->id;
    46| $limit = GETPOST('limit','int')?GETPOST('limit','int'):$conf->liste_limit;
    47| $sortfield = GETPOST('sortfield','alpha');
    48| $sortorder = GETPOST('sortorder','alpha');
    49| $page = GETPOST('page','int');
    50| if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
    51| $offset = $limit * $page;
    52| $pageprev = $page - 1;
    53| $pagenext = $page + 1;
    54| if (!$sortorder) $sortorder="DESC";
    55| if (!$sortfield) $sortfield="d.date_debut";
    56| $id = GETPOST('id', 'int');
    57| $sall         = trim((GETPOST('search_all', 'alphanohtml')!='')?GETPOST('search_all', 'alphanohtml'):GETPOST('sall', 'alphanohtml'));
    58| $search_ref   = GETPOST('search_ref');
    59| $search_user  = GETPOST('search_user','int');
    60| $search_amount_ht = GETPOST('search_amount_ht','alpha');
    61| $search_amount_vat = GETPOST('search_amount_vat','alpha');
    62| $search_amount_ttc = GETPOST('search_amount_ttc','alpha');
    63| $search_status = (GETPOST('search_status','alpha')!=''?GETPOST('search_status','alpha'):GETPOST('statut','alpha'));
    64| $month_start  = GETPOST("month_start","int");
    65| $year_start   = GETPOST("year_start","int");
    66| $month_end    = GETPOST("month_end","int");
    67| $year_end     = GETPOST("year_end","int");
    68| $optioncss    = GETPOST('optioncss','alpha');
    69| if ($search_status == '') $search_status=-1;
    70| if ($search_user == '') $search_user=-1;
    71| $contextpage=GETPOST('contextpage','aZ')?GETPOST('contextpage','aZ'):'expensereportlist';
    72| $hookmanager->initHooks(array('expensereportlist'));
    73| $extrafields = new ExtraFields($db);
    74| $extralabels = $extrafields->fetch_name_optionals_label('expensereport');
    75| $search_array_options=$extrafields->getOptionalsFromPost($extralabels,'','search_');
    76| $fieldstosearchall = array(
    77|     'd.ref'=>'Ref',
    78|     'd.note_public'=>"NotePublic",
    79|     'u.lastname'=>'Lastname',
    80|     'u.firstname'=>"Firstname",
    81|     'u.login'=>"Login",
    82| );
    83| if (empty($user->socid)) $fieldstosearchall["d.note_private"]="NotePrivate";

# --- HUNK 2: Lines 224-268 ---
   224| else if ($year_start > 0)
   225| {
   226| 	$sql.= " AND d.date_debut BETWEEN '".$db->idate(dol_get_first_day($year_start,1,false))."' AND '".$db->idate(dol_get_last_day($year_start,12,false))."'";
   227| }
   228| if ($month_end > 0)
   229| {
   230|     if ($year_end > 0 && empty($day))
   231|     $sql.= " AND d.date_fin BETWEEN '".$db->idate(dol_get_first_day($year_end,$month_end,false))."' AND '".$db->idate(dol_get_last_day($year_end,$month_end,false))."'";
   232|     else if ($year_end > 0 && ! empty($day))
   233|     $sql.= " AND d.date_fin BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $month_end, $day, $year_end))."' AND '".$db->idate(dol_mktime(23, 59, 59, $month_end, $day, $year_end))."'";
   234|     else
   235|     $sql.= " AND date_format(d.date_fin, '%m') = '".$month_end."'";
   236| }
   237| else if ($year_end > 0)
   238| {
   239| 	$sql.= " AND d.date_fin BETWEEN '".$db->idate(dol_get_first_day($year_end,1,false))."' AND '".$db->idate(dol_get_last_day($year_end,12,false))."'";
   240| }
   241| if ($search_amount_ht != '') $sql.= natural_search('d.total_ht', $search_amount_ht, 1);
   242| if ($search_amount_ttc != '') $sql.= natural_search('d.total_ttc', $search_amount_ttc, 1);
   243| if ($search_user != '' && $search_user >= 0) $sql.= " AND u.rowid = '".$db->escape($search_user)."'";
   244| if ($search_status != '' && $search_status >= 0)
   245| {
   246| 	if (strstr($search_status, ',')) $sql.=" AND d.fk_statut IN (".$db->escape($search_status).")";
   247| 	else $sql.=" AND d.fk_statut = ".$search_status;
   248| }
   249| if (empty($user->rights->expensereport->readall) && empty($user->rights->expensereport->lire_tous)
   250|     && (empty($conf->global->MAIN_USE_ADVANCED_PERMS) || empty($user->rights->expensereport->writeall_advance)))
   251| {
   252| 	$childids = $user->getAllChildIds();
   253| 	$childids[]=$user->id;
   254| 	$sql.= " AND d.fk_user_author IN (".join(',',$childids).")\n";
   255| }
   256| include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_sql.tpl.php';
   257| $parameters=array();
   258| $reshook=$hookmanager->executeHooks('printFieldListWhere',$parameters);    // Note that $action and $object may have been modified by hook
   259| $sql.=$hookmanager->resPrint;
   260| $sql.= $db->order($sortfield,$sortorder);
   261| $nbtotalofrecords = '';
   262| if (empty($conf->global->MAIN_DISABLE_FULL_SCANLIST))
   263| {
   264|     $result = $db->query($sql);
   265|     $nbtotalofrecords = $db->num_rows($result);
   266| }
   267| $sql.= $db->plimit($limit+1, $offset);
   268| $resql = $db->query($sql);


# ====================================================================
# FILE: htdocs/expensereport/note.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 50-77 ---
    50| /*
    51|  * View
    52|  */
    53| $title=$langs->trans("ExpenseReport") . " - " . $langs->trans("Note");
    54| $helpurl="EN:Module_Expense_Reports";
    55| llxHeader("",$title,$helpurl);
    56| $form = new Form($db);
    57| if ($id > 0 || ! empty($ref))
    58| {
    59| 	$object = new ExpenseReport($db);
    60| 	$object->fetch($id, $ref);
    61| 	$object->info($object->id);
    62| 	$head = expensereport_prepare_head($object);
    63| 	dol_fiche_head($head, 'note', $langs->trans("ExpenseReport"), -1, 'trip');
    64| 	$linkback = '<a href="'.DOL_URL_ROOT.'/expensereport/list.php?restore_lastsearch_values=1'.(! empty($socid)?'&socid='.$socid:'').'">'.$langs->trans("BackToList").'</a>';
    65| 	$morehtmlref='<div class="refidno">';
    66|     $morehtmlref.='</div>';
    67| 	dol_banner_tab($object, 'ref', $linkback, 1, 'ref', 'ref', $morehtmlref);
    68|     print '<div class="fichecenter">';
    69|     print '<div class="underbanner clearboth"></div>';
    70| var_dump($value_public);
    71| 	$cssclass="titlefield";
    72| 	include DOL_DOCUMENT_ROOT.'/core/tpl/notes.tpl.php';
    73| 	print '</div>';
    74| 	dol_fiche_end();
    75| }
    76| llxFooter();
    77| $db->close();


# ====================================================================
# FILE: htdocs/fichinter/class/api_interventions.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 87-127 ---
    87|      * @param string	       $sortfield	        Sort field
    88|      * @param string	       $sortorder	        Sort order
    89|      * @param int	       $limit		        Limit for list
    90|      * @param int	       $page		        Page number
    91|      * @param string   	       $thirdparty_ids	        Thirdparty ids to filter orders of. {@example '1' or '1,2,3'} {@pattern /^[0-9,]*$/i}
    92|      * @param string           $sqlfilters              Other criteria to filter answers separated by a comma. Syntax example "(t.ref:like:'SO-%') and (t.date_creation:<:'20160101')"
    93|      * @return  array                                   Array of order objects
    94|      *
    95|      * @throws RestException
    96|      */
    97|     function index($sortfield = "t.rowid", $sortorder = 'ASC', $limit = 100, $page = 0, $thirdparty_ids = '', $sqlfilters = '') {
    98|         global $db, $conf;
    99|         $obj_ret = array();
   100|         $socids = DolibarrApiAccess::$user->societe_id ? DolibarrApiAccess::$user->societe_id : $thirdparty_ids;
   101|         $search_sale = 0;
   102|         if (! DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) $search_sale = DolibarrApiAccess::$user->id;
   103|         $sql = "SELECT t.rowid";
   104|         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) || $search_sale > 0) $sql .= ", sc.fk_soc, sc.fk_user"; // We need these fields in order to filter by sale (including the case where the user can only see his prospects)
   105|         $sql.= " FROM ".MAIN_DB_PREFIX."fichinter as t";
   106|         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) || $search_sale > 0) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc"; // We need this table joined to the select in order to filter by sale
   107|         $sql.= ' WHERE t.entity IN ('.getEntity('fichinter').')';
   108|         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) || $search_sale > 0) $sql.= " AND t.fk_soc = sc.fk_soc";
   109|         if ($socids) $sql.= " AND t.fk_soc IN (".$socids.")";
   110|         if ($search_sale > 0) $sql.= " AND t.rowid = sc.fk_soc";		// Join for the needed table to filter by sale
   111|         if ($search_sale > 0)
   112|         {
   113|             $sql .= " AND sc.fk_user = ".$search_sale;
   114|         }
   115|         if ($sqlfilters)
   116|         {
   117|             if (! DolibarrApi::_checkFilters($sqlfilters))
   118|             {
   119|                 throw new RestException(503, 'Error when validating parameter sqlfilters '.$sqlfilters);
   120|             }
   121| 	        $regexstring='\(([^:\'\(\)]+:[^:\'\(\)]+:[^:\(\)]+)\)';
   122|             $sql.=" AND (".preg_replace_callback('/'.$regexstring.'/', 'DolibarrApi::_forge_criteria_callback', $sqlfilters).")";
   123|         }
   124|         $sql.= $db->order($sortfield, $sortorder);
   125|         if ($limit)	{
   126|             if ($page < 0)
   127|             {


# ====================================================================
# FILE: htdocs/fichinter/class/fichinter.class.php
# Total hunks: 11
# ====================================================================
# --- HUNK 1: Lines 97-137 ---
    97| 	}
    98| 	/**
    99| 	 *  Load indicators into this->nb for board
   100| 	 *
   101| 	 *  @return     int         <0 if KO, >0 if OK
   102| 	 */
   103| 	function load_state_board()
   104| 	{
   105| 		global $user;
   106| 		$this->nb=array();
   107| 		$clause = "WHERE";
   108| 		$sql = "SELECT count(fi.rowid) as nb";
   109| 		$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as fi";
   110| 		$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe as s ON fi.fk_soc = s.rowid";
   111| 		if (!$user->rights->societe->client->voir && !$user->societe_id)
   112| 		{
   113| 			$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe_commerciaux as sc ON s.rowid = sc.fk_soc";
   114| 			$sql.= " WHERE sc.fk_user = " .$user->id;
   115| 			$clause = "AND";
   116| 		}
   117| 		$sql.= " ".$clause." fi.entity IN (".getEntity($this->element).")";
   118| 		$resql=$this->db->query($sql);
   119| 		if ($resql)
   120| 		{
   121| 			while ($obj=$this->db->fetch_object($resql))
   122| 			{
   123| 				$this->nb["fichinters"]=$obj->nb;
   124| 			}
   125| 			$this->db->free($resql);
   126| 			return 1;
   127| 		}
   128| 		else
   129| 		{
   130| 			dol_print_error($this->db);
   131| 			$this->error=$this->db->error();
   132| 			return -1;
   133| 		}
   134| 	}
   135| 	/**
   136| 	 *	Create an intervention into data base
   137| 	 *

# --- HUNK 2: Lines 286-326 ---
   286| 			$this->error=$this->db->error();
   287| 			$this->db->rollback();
   288| 			return -1;
   289| 		}
   290| 	}
   291| 	/**
   292| 	 *	Fetch a intervention
   293| 	 *
   294| 	 *	@param		int		$rowid		Id of intervention
   295| 	 *	@param		string	$ref		Ref of intervention
   296| 	 *	@return		int					<0 if KO, >0 if OK
   297| 	 */
   298| 	function fetch($rowid,$ref='')
   299| 	{
   300| 		$sql = "SELECT f.rowid, f.ref, f.description, f.fk_soc, f.fk_statut,";
   301| 		$sql.= " f.datec, f.dateo, f.datee, f.datet, f.fk_user_author,";
   302| 		$sql.= " f.date_valid as datev,";
   303| 		$sql.= " f.tms as datem,";
   304| 		$sql.= " f.duree, f.fk_projet, f.note_public, f.note_private, f.model_pdf, f.extraparams, fk_contrat";
   305| 		$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
   306| 		if ($ref) $sql.= " WHERE f.ref='".$this->db->escape($ref)."'";
   307| 		else $sql.= " WHERE f.rowid=".$rowid;
   308| 		dol_syslog(get_class($this)."::fetch", LOG_DEBUG);
   309| 		$resql=$this->db->query($sql);
   310| 		if ($resql)
   311| 		{
   312| 			if ($this->db->num_rows($resql))
   313| 			{
   314| 				$obj = $this->db->fetch_object($resql);
   315| 				$this->id           = $obj->rowid;
   316| 				$this->ref          = $obj->ref;
   317| 				$this->description  = $obj->description;
   318| 				$this->socid        = $obj->fk_soc;
   319| 				$this->statut       = $obj->fk_statut;
   320| 				$this->duration     = $obj->duree;
   321| 				$this->datec        = $this->db->jdate($obj->datec);
   322| 				$this->datee        = $this->db->jdate($obj->dateo);
   323| 				$this->dateo        = $this->db->jdate($obj->datee);
   324| 				$this->datet        = $this->db->jdate($obj->datet);
   325| 				$this->datev        = $this->db->jdate($obj->datev);
   326| 				$this->datem        = $this->db->jdate($obj->datem);

# --- HUNK 3: Lines 646-686 ---
   646| 		}
   647| 	}
   648| 	/**
   649| 	 * 	Load information on object
   650| 	 *
   651| 	 *	@param	int		$id      Id of object
   652| 	 *	@return	void
   653| 	 */
   654| 	function info($id)
   655| 	{
   656| 		global $conf;
   657| 		$sql = "SELECT f.rowid,";
   658| 		$sql.= " f.datec,";
   659| 		$sql.= " f.tms as date_modification,";
   660| 		$sql.= " f.date_valid as datev,";
   661| 		$sql.= " f.fk_user_author,";
   662| 		$sql.= " f.fk_user_modif as fk_user_modification,";
   663| 		$sql.= " f.fk_user_valid";
   664| 		$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
   665| 		$sql.= " WHERE f.rowid = ".$id;
   666| 		$sql.= " AND f.entity = ".$conf->entity;
   667| 		$resql = $this->db->query($sql);
   668| 		if ($resql)
   669| 		{
   670| 			if ($this->db->num_rows($resql))
   671| 			{
   672| 				$obj = $this->db->fetch_object($resql);
   673| 				$this->id                = $obj->rowid;
   674| 				$this->date_creation     = $this->db->jdate($obj->datec);
   675| 				$this->date_modification = $this->db->jdate($obj->date_modification);
   676| 				$this->date_validation   = $this->db->jdate($obj->datev);
   677| 				$cuser = new User($this->db);
   678| 				$cuser->fetch($obj->fk_user_author);
   679| 				$this->user_creation     = $cuser;
   680| 				if ($obj->fk_user_valid)
   681| 				{
   682| 					$vuser = new User($this->db);
   683| 					$vuser->fetch($obj->fk_user_valid);
   684| 					$this->user_validation     = $vuser;
   685| 				}
   686| 				if ($obj->fk_user_modification)

# --- HUNK 4: Lines 728-768 ---
   728| 				$this->error='ErrorFailToDeleteLinkedContact';
   729| 				$error++;
   730| 			}
   731| 		}
   732| 		if (! $error)
   733| 		{
   734| 			$sql = "DELETE FROM ".MAIN_DB_PREFIX."fichinterdet";
   735| 			$sql.= " WHERE fk_fichinter = ".$this->id;
   736| 			$resql = $this->db->query($sql);
   737| 			if (! $resql) $error++;
   738| 		}
   739| 		if ((! $error) && (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED))) // For avoid conflicts if trigger used
   740| 		{
   741| 			$res = $this->deleteExtraFields();
   742| 			if ($res < 0) $error++;
   743| 		}
   744| 		if (! $error)
   745| 		{
   746| 			$sql = "DELETE FROM ".MAIN_DB_PREFIX."fichinter";
   747| 			$sql.= " WHERE rowid = ".$this->id;
   748| 			$sql.= " AND entity = ".$conf->entity;
   749| 			dol_syslog("Fichinter::delete", LOG_DEBUG);
   750| 			$resql = $this->db->query($sql);
   751| 			if (! $resql) $error++;
   752| 		}
   753| 		if (! $error)
   754| 		{
   755| 			$fichinterref = dol_sanitizeFileName($this->ref);
   756| 			if ($conf->ficheinter->dir_output)
   757| 			{
   758| 				$dir = $conf->ficheinter->dir_output . "/" . $fichinterref ;
   759| 				$file = $conf->ficheinter->dir_output . "/" . $fichinterref . "/" . $fichinterref . ".pdf";
   760| 				if (file_exists($file))
   761| 				{
   762| 					dol_delete_preview($this);
   763| 					if (! dol_delete_file($file,0,0,0,$this)) // For triggers
   764| 					{
   765| 						$this->error=$langs->trans("ErrorCanNotDeleteFile",$file);
   766| 						return 0;
   767| 					}
   768| 				}

# --- HUNK 5: Lines 785-885 ---
   785| 		{
   786| 			$this->db->rollback();
   787| 			return -1;
   788| 		}
   789| 	}
   790| 	/**
   791| 	 *	Defines a delivery date of intervention
   792| 	 *
   793| 	 *	@param      User	$user				Object user who define
   794| 	 *	@param      date	$date_delivery   	date of delivery
   795| 	 *	@return     int							<0 if ko, >0 if ok
   796| 	 */
   797| 	function set_date_delivery($user, $date_delivery)
   798| 	{
   799| 		global $conf;
   800| 		if ($user->rights->ficheinter->creer)
   801| 		{
   802| 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter ";
   803| 			$sql.= " SET datei = '".$this->db->idate($date_delivery)."'";
   804| 			$sql.= " WHERE rowid = ".$this->id;
   805| 			$sql.= " AND entity = ".$conf->entity;
   806| 			$sql.= " AND fk_statut = 0";
   807| 			if ($this->db->query($sql))
   808| 			{
   809| 				$this->date_delivery = $date_delivery;
   810| 				return 1;
   811| 			}
   812| 			else
   813| 			{
   814| 				$this->error=$this->db->error();
   815| 				dol_syslog("Fichinter::set_date_delivery Erreur SQL");
   816| 				return -1;
   817| 			}
   818| 		}
   819| 	}
   820| 	/**
   821| 	 *	Define the label of the intervention
   822| 	 *
   823| 	 *	@param      User	$user			Object user who modify
   824| 	 *	@param      string	$description    description
   825| 	 *	@return     int						<0 if KO, >0 if OK
   826| 	 */
   827| 	function set_description($user, $description)
   828| 	{
   829| 		global $conf;
   830| 		if ($user->rights->ficheinter->creer)
   831| 		{
   832| 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter ";
   833| 			$sql.= " SET description = '".$this->db->escape($description)."',";
   834| 			$sql.= " fk_user_modif = ".$user->id;
   835| 			$sql.= " WHERE rowid = ".$this->id;
   836| 			$sql.= " AND entity = ".$conf->entity;
   837| 			if ($this->db->query($sql))
   838| 			{
   839| 				$this->description = $description;
   840| 				return 1;
   841| 			}
   842| 			else
   843| 			{
   844| 				$this->error=$this->db->error();
   845| 				dol_syslog("Fichinter::set_description Erreur SQL");
   846| 				return -1;
   847| 			}
   848| 		}
   849| 	}
   850| 	/**
   851| 	 *	Link intervention to a contract
   852| 	 *
   853| 	 *	@param      User	$user			Object user who modify
   854| 	 *	@param      int		$contractid		Description
   855| 	 *	@return     int						<0 if ko, >0 if ok
   856| 	 */
   857| 	function set_contrat($user, $contractid)
   858| 	{
   859| 		global $conf;
   860| 		if ($user->rights->ficheinter->creer)
   861| 		{
   862| 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter ";
   863| 			$sql.= " SET fk_contrat = '".$contractid."'";
   864| 			$sql.= " WHERE rowid = ".$this->id;
   865| 			$sql.= " AND entity = ".$conf->entity;
   866| 			if ($this->db->query($sql))
   867| 			{
   868| 				$this->fk_contrat = $contractid;
   869| 				return 1;
   870| 			}
   871| 			else
   872| 			{
   873| 				$this->error=$this->db->error();
   874| 				return -1;
   875| 			}
   876| 		}
   877| 		return -2;
   878| 	}
   879| 	/**
   880| 	 *	Load an object from its id and create a new one in database
   881| 	 *
   882| 	 *	@param		int			$socid			Id of thirdparty
   883| 	 *	@return		int							New id of clone
   884| 	 */
   885| 	function createFromClone($socid=0)

# --- HUNK 6: Lines 1153-1193 ---
  1153| 				dol_print_error($this->db);
  1154| 				$this->db->rollback();
  1155| 				return -1;
  1156| 			}
  1157| 		}
  1158| 		$sql = 'INSERT INTO '.MAIN_DB_PREFIX.'fichinterdet';
  1159| 		$sql.= ' (fk_fichinter, description, date, duree, rang)';
  1160| 		$sql.= " VALUES (".$this->fk_fichinter.",";
  1161| 		$sql.= " '".$this->db->escape($this->desc)."',";
  1162| 		$sql.= " '".$this->db->idate($this->datei)."',";
  1163| 		$sql.= " ".$this->duration.",";
  1164| 		$sql.= ' '.$rangToUse;
  1165| 		$sql.= ')';
  1166| 		dol_syslog("FichinterLigne::insert", LOG_DEBUG);
  1167| 		$resql=$this->db->query($sql);
  1168| 		if ($resql)
  1169| 		{
  1170| 			$this->rowid=$this->db->last_insert_id(MAIN_DB_PREFIX.'fichinterdet');
  1171| 			if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) // For avoid conflicts if trigger used
  1172| 			{
  1173| 				$this->id=$this->rowid;
  1174| 				$result=$this->insertExtraFields();
  1175| 				if ($result < 0)
  1176| 				{
  1177| 					$error++;
  1178| 				}
  1179| 			}
  1180| 			$result=$this->update_total();
  1181| 			if ($result > 0)
  1182| 			{
  1183| 				$this->rang=$rangToUse;
  1184| 				if (! $notrigger)
  1185| 				{
  1186| 					$result=$this->call_trigger('LINEFICHINTER_CREATE',$user);
  1187| 					if ($result < 0) { $error++; }
  1188| 				}
  1189| 			}
  1190| 			if (!$error) {
  1191| 				$this->db->commit();
  1192| 				return $result;
  1193| 			}

# --- HUNK 7: Lines 1203-1250 ---
  1203| 			$this->db->rollback();
  1204| 			return -1;
  1205| 		}
  1206| 	}
  1207| 	/**
  1208| 	 *	Update intervention into database
  1209| 	 *
  1210| 	 *	@param		User	$user 		Objet user that make creation
  1211| 	 *	@param		int		$notrigger	Disable all triggers
  1212| 	 *	@return		int		<0 if ko, >0 if ok
  1213| 	 */
  1214| 	function update($user,$notrigger=0)
  1215| 	{
  1216| 		global $langs,$conf;
  1217| 		$this->db->begin();
  1218| 		$sql = "UPDATE ".MAIN_DB_PREFIX."fichinterdet SET";
  1219| 		$sql.= " description='".$this->db->escape($this->desc)."'";
  1220| 		$sql.= ",date='".$this->db->idate($this->datei)."'";
  1221| 		$sql.= ",duree=".$this->duration;
  1222| 		$sql.= ",rang='".$this->db->escape($this->rang)."'";
  1223| 		$sql.= " WHERE rowid = ".$this->rowid;
  1224| 		dol_syslog("FichinterLigne::update", LOG_DEBUG);
  1225| 		$resql=$this->db->query($sql);
  1226| 		if ($resql)
  1227| 		{
  1228| 			if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) // For avoid conflicts if trigger used
  1229| 			{
  1230| 				$this->id=$this->rowid;
  1231| 				$result=$this->insertExtraFields();
  1232| 				if ($result < 0)
  1233| 				{
  1234| 					$error++;
  1235| 				}
  1236| 			}
  1237| 			$result=$this->update_total();
  1238| 			if ($result > 0)
  1239| 			{
  1240| 				if (! $notrigger)
  1241| 				{
  1242| 					$result=$this->call_trigger('LINEFICHINTER_UPDATE',$user);
  1243| 					if ($result < 0) { $error++; }
  1244| 				}
  1245| 			}
  1246| 			if (!$error)
  1247| 			{
  1248| 				$this->db->commit();
  1249| 				return $result;
  1250| 			}

# --- HUNK 8: Lines 1269-1346 ---
  1269| 	 */
  1270| 	function update_total()
  1271| 	{
  1272| 		global $conf;
  1273| 		$this->db->begin();
  1274| 		$sql = "SELECT SUM(duree) as total_duration, min(date) as dateo, max(date) as datee ";
  1275| 		$sql.= " FROM ".MAIN_DB_PREFIX."fichinterdet";
  1276| 		$sql.= " WHERE fk_fichinter=".$this->fk_fichinter;
  1277| 		dol_syslog("FichinterLigne::update_total", LOG_DEBUG);
  1278| 		$resql=$this->db->query($sql);
  1279| 		if ($resql)
  1280| 		{
  1281| 			$obj=$this->db->fetch_object($resql);
  1282| 			$total_duration=0;
  1283| 			if (!empty($obj->total_duration)) $total_duration = $obj->total_duration;
  1284| 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter";
  1285| 			$sql.= " SET duree = ".$total_duration;
  1286| 			$sql.= " , dateo = ".(! empty($obj->dateo)?"'".$this->db->idate($obj->dateo)."'":"null");
  1287| 			$sql.= " , datee = ".(! empty($obj->datee)?"'".$this->db->idate($obj->datee)."'":"null");
  1288| 			$sql.= " WHERE rowid = ".$this->fk_fichinter;
  1289| 			$sql.= " AND entity = ".$conf->entity;
  1290| 			dol_syslog("FichinterLigne::update_total", LOG_DEBUG);
  1291| 			$resql=$this->db->query($sql);
  1292| 			if ($resql)
  1293| 			{
  1294| 				$this->db->commit();
  1295| 				return 1;
  1296| 			}
  1297| 			else
  1298| 			{
  1299| 				$this->error=$this->db->error();
  1300| 				$this->db->rollback();
  1301| 				return -2;
  1302| 			}
  1303| 		}
  1304| 		else
  1305| 		{
  1306| 			$this->error=$this->db->error();
  1307| 			$this->db->rollback();
  1308| 			return -1;
  1309| 		}
  1310| 	}
  1311| 	/**
  1312| 	 *	Delete a intervention line
  1313| 	 *
  1314| 	 *	@param		User	$user 		Objet user that make creation
  1315| 	 *	@param		int		$notrigger	Disable all triggers
  1316| 	 *	@return     int		>0 if ok, <0 if ko
  1317| 	 */
  1318| 	function deleteline($user,$notrigger=0)
  1319| 	{
  1320| 		global $langs,$conf;
  1321| 		$error=0;
  1322| 		if ($this->statut == 0)
  1323| 		{
  1324| 			dol_syslog(get_class($this)."::deleteline lineid=".$this->rowid);
  1325| 			$this->db->begin();
  1326| 			$sql = "DELETE FROM ".MAIN_DB_PREFIX."fichinterdet WHERE rowid = ".$this->rowid;
  1327| 			$resql = $this->db->query($sql);
  1328| 			if ($resql)
  1329| 			{
  1330| 				$result = $this->update_total();
  1331| 				if ($result > 0)
  1332| 				{
  1333| 					if (! $notrigger)
  1334| 					{
  1335| 						$result=$this->call_trigger('LINEFICHINTER_DELETE',$user);
  1336| 						if ($result < 0) { $error++; $this->db->rollback(); return -1; }
  1337| 					}
  1338| 					$this->db->commit();
  1339| 					return $result;
  1340| 				}
  1341| 				else
  1342| 				{
  1343| 					$this->db->rollback();
  1344| 					return -1;
  1345| 				}
  1346| 			}


# ====================================================================
# FILE: htdocs/fichinter/index.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 45-86 ---
    45| print load_fiche_titre($langs->trans("InterventionsArea"));
    46| print '<div class="fichecenter"><div class="fichethirdleft">';
    47| if (! empty($conf->global->MAIN_SEARCH_FORM_ON_HOME_AREAS))     // This is useless due to the global search combo
    48| {
    49|     $var=false;
    50|     print '<table class="noborder nohover" width="100%">';
    51|     print '<form method="post" action="'.DOL_URL_ROOT.'/fichinter/list.php">';
    52|     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
    53|     print '<tr class="liste_titre"><td colspan="3">'.$langs->trans("Search").'</td></tr>';
    54|     print '<tr class="oddeven"><td>';
    55|     print $langs->trans("Intervention").':</td><td><input type="text" class="flat" name="sall" size="18"></td><td><input type="submit" value="'.$langs->trans("Search").'" class="button"></td></tr>';
    56|     print "</form></table><br>\n";
    57| }
    58| /*
    59|  * Statistics
    60|  */
    61| $sql = "SELECT count(f.rowid), f.fk_statut";
    62| $sql.= " FROM ".MAIN_DB_PREFIX."societe as s";
    63| $sql.= ", ".MAIN_DB_PREFIX."fichinter as f";
    64| if (! $user->rights->societe->client->voir && ! $socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
    65| $sql.= " WHERE f.fk_soc = s.rowid";
    66| $sql.= " AND f.entity IN (".getEntity('societe').")";
    67| if ($user->societe_id) $sql.=' AND f.fk_soc = '.$user->societe_id;
    68| if (! $user->rights->societe->client->voir && ! $socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
    69| $sql.= " GROUP BY f.fk_statut";
    70| $resql = $db->query($sql);
    71| if ($resql)
    72| {
    73|     $num = $db->num_rows($resql);
    74|     $i = 0;
    75|     $total=0;
    76|     $totalinprocess=0;
    77|     $dataseries=array();
    78|     $vals=array();
    79|     $bool=false;
    80|     while ($i < $num)
    81|     {
    82|         $row = $db->fetch_row($resql);
    83|         if ($row)
    84|         {
    85|             {
    86|                 $bool=(! empty($row[2])?true:false);

# --- HUNK 2: Lines 134-215 ---
   134|             if ($status==3 && ! $bool) $bool=true;
   135|             else $bool=false;
   136|         }
   137|     }
   138|     print '<tr class="liste_total"><td>'.$langs->trans("Total").'</td><td align="right">'.$total.'</td></tr>';
   139|     print "</table><br>";
   140| }
   141| else
   142| {
   143|     dol_print_error($db);
   144| }
   145| /*
   146|  * Draft orders
   147|  */
   148| if (! empty($conf->ficheinter->enabled))
   149| {
   150| 	$sql = "SELECT f.rowid, f.ref, s.nom as name, s.rowid as socid";
   151| 	$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
   152| 	$sql.= ", ".MAIN_DB_PREFIX."societe as s";
   153| 	if (!$user->rights->societe->client->voir && !$socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
   154| 	$sql.= " WHERE f.fk_soc = s.rowid";
   155| 	$sql.= " AND f.entity IN (".getEntity('intervention').")";
   156| 	$sql.= " AND f.fk_statut = 0";
   157| 	if ($socid) $sql.= " AND f.fk_soc = ".$socid;
   158| 	if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
   159| 	$resql=$db->query($sql);
   160| 	if ($resql)
   161| 	{
   162| 		print '<table class="noborder" width="100%">';
   163| 		print '<tr class="liste_titre">';
   164| 		print '<th colspan="2">'.$langs->trans("DraftFichinter").'</th></tr>';
   165| 		$langs->load("fichinter");
   166| 		$num = $db->num_rows($resql);
   167| 		if ($num)
   168| 		{
   169| 			$i = 0;
   170| 			$var = true;
   171| 			while ($i < $num)
   172| 			{
   173| 				$obj = $db->fetch_object($resql);
   174| 				print '<tr class="oddeven">';
   175| 				print '<td class="nowrap">';
   176| 				print "<a href=\"card.php?id=".$obj->rowid."\">".img_object($langs->trans("ShowFichinter"),"intervention").' '.$obj->ref."</a></td>";
   177| 				print '<td><a href="'.DOL_URL_ROOT.'/comm/card.php?socid='.$obj->socid.'">'.img_object($langs->trans("ShowCompany"),"company").' '.dol_trunc($obj->name,24).'</a></td></tr>';
   178| 				$i++;
   179| 			}
   180| 		}
   181| 		print "</table><br>";
   182| 	}
   183| }
   184| print '</div><div class="fichetwothirdright"><div class="ficheaddleft">';
   185| $max=5;
   186| /*
   187|  * Last modified interventions
   188|  */
   189| $sql = "SELECT f.rowid, f.ref, f.fk_statut, f.date_valid as datec, f.tms as datem,";
   190| $sql.= " s.nom as name, s.rowid as socid";
   191| $sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f,";
   192| $sql.= " ".MAIN_DB_PREFIX."societe as s";
   193| if (!$user->rights->societe->client->voir && !$socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
   194| $sql.= " WHERE f.fk_soc = s.rowid";
   195| $sql.= " AND f.entity IN (".getEntity('commande').")";
   196| if ($socid) $sql .= " AND f.fk_soc = ".$socid;
   197| if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
   198| $sql.= " ORDER BY f.tms DESC";
   199| $sql.= $db->plimit($max, 0);
   200| $resql=$db->query($sql);
   201| if ($resql)
   202| {
   203| 	print '<table class="noborder" width="100%">';
   204| 	print '<tr class="liste_titre">';
   205| 	print '<th colspan="4">'.$langs->trans("LastModifiedInterventions",$max).'</th></tr>';
   206| 	$num = $db->num_rows($resql);
   207| 	if ($num)
   208| 	{
   209| 		$i = 0;
   210| 		$var = true;
   211| 		while ($i < $num)
   212| 		{
   213| 			$obj = $db->fetch_object($resql);
   214| 			print '<tr class="oddeven">';
   215| 			print '<td width="20%" class="nowrap">';

# --- HUNK 3: Lines 231-272 ---
   231| 			print '</td>';
   232| 			print '<td><a href="'.DOL_URL_ROOT.'/comm/card.php?socid='.$obj->socid.'">'.img_object($langs->trans("ShowCompany"),"company").' '.$obj->name.'</a></td>';
   233| 			print '<td>'.dol_print_date($db->jdate($obj->datem),'day').'</td>';
   234| 			print '<td align="right">'.$fichinterstatic->LibStatut($obj->fk_statut,5).'</td>';
   235| 			print '</tr>';
   236| 			$i++;
   237| 		}
   238| 	}
   239| 	print "</table><br>";
   240| }
   241| else dol_print_error($db);
   242| /*
   243|  * interventions to process
   244|  */
   245| if (! empty($conf->ficheinter->enabled))
   246| {
   247| 	$sql = "SELECT f.rowid, f.ref, f.fk_statut, s.nom as name, s.rowid as socid";
   248| 	$sql.=" FROM ".MAIN_DB_PREFIX."fichinter as f";
   249| 	$sql.= ", ".MAIN_DB_PREFIX."societe as s";
   250| 	if (!$user->rights->societe->client->voir && !$socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
   251| 	$sql.= " WHERE f.fk_soc = s.rowid";
   252| 	$sql.= " AND f.entity IN (".getEntity('intervention').")";
   253| 	$sql.= " AND f.fk_statut = 1";
   254| 	if ($socid) $sql.= " AND f.fk_soc = ".$socid;
   255| 	if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
   256| 	$sql.= " ORDER BY f.rowid DESC";
   257| 	$resql=$db->query($sql);
   258| 	if ($resql)
   259| 	{
   260| 		$num = $db->num_rows($resql);
   261| 		print '<table class="noborder" width="100%">';
   262| 		print '<tr class="liste_titre">';
   263| 		print '<th colspan="3">'.$langs->trans("FichinterToProcess").' <a href="'.DOL_URL_ROOT.'/fichinter/list.php?viewstatut=1"><span class="badge">'.$num.'</span></a></th></tr>';
   264| 		if ($num)
   265| 		{
   266| 			$i = 0;
   267| 			$var = true;
   268| 			while ($i < $num)
   269| 			{
   270| 				$obj = $db->fetch_object($resql);
   271| 				print '<tr class="oddeven">';
   272| 				print '<td class="nowrap" width="20%">';


# ====================================================================
# FILE: htdocs/fichinter/list.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 136-177 ---
   136| $now=dol_now();
   137| $form = new Form($db);
   138| $formfile = new FormFile($db);
   139| $objectstatic=new Fichinter($db);
   140| $companystatic=new Societe($db);
   141| $title=$langs->trans("ListOfInterventions");
   142| llxHeader('', $title);
   143| $sql = "SELECT";
   144| $sql.= " f.ref, f.rowid, f.fk_statut, f.description, f.datec as date_creation, f.tms as date_update, f.note_private,";
   145| if (empty($conf->global->FICHINTER_DISABLE_DETAILS)) $sql.= " fd.description as descriptiondetail, fd.date as dp, fd.duree,";
   146| $sql.= " s.nom as name, s.rowid as socid, s.client";
   147| foreach ($extrafields->attribute_label as $key => $val) $sql.=($extrafields->attribute_type[$key] != 'separate' ? ",ef.".$key.' as options_'.$key : '');
   148| $parameters=array();
   149| $reshook=$hookmanager->executeHooks('printFieldListSelect',$parameters);    // Note that $action and $object may have been modified by hook
   150| $sql.=$hookmanager->resPrint;
   151| $sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
   152| if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label)) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."fichinter_extrafields as ef on (f.rowid = ef.fk_object)";
   153| if (empty($conf->global->FICHINTER_DISABLE_DETAILS)) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."fichinterdet as fd ON fd.fk_fichinter = f.rowid";
   154| if (! $user->rights->societe->client->voir && empty($socid)) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
   155| $sql.= ", ".MAIN_DB_PREFIX."societe as s";
   156| $sql.= " WHERE f.fk_soc = s.rowid ";
   157| $sql.= " AND f.entity = ".$conf->entity;
   158| if ($search_ref) {
   159| 	$sql .= natural_search('f.ref', $search_ref);
   160| }
   161| if ($search_company) {
   162| 	$sql .= natural_search('s.nom', $search_company);
   163| }
   164| if ($search_desc) {
   165| 	if (empty($conf->global->FICHINTER_DISABLE_DETAILS)) $sql .= natural_search(array('f.description', 'fd.description'), $search_desc);
   166| 	else $sql .= natural_search(array('f.description'), $search_desc);
   167| }
   168| if ($search_status != '' && $search_status >= 0) {
   169| 	$sql .= ' AND f.fk_statut = '.$search_status;
   170| }
   171| if (! $user->rights->societe->client->voir && empty($socid))
   172| 	$sql .= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
   173| if ($socid)
   174| 	$sql.= " AND s.rowid = " . $socid;
   175| if ($sall) {
   176| 	$sql .= natural_search(array_keys($fieldstosearchall), $sall);
   177| }


# ====================================================================
# FILE: htdocs/filefunc.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 12-52 ---
    12|  *
    13|  * This program is free software; you can redistribute it and/or modify
    14|  * it under the terms of the GNU General Public License as published by
    15|  * the Free Software Foundation; either version 3 of the License, or
    16|  * (at your option) any later version.
    17|  *
    18|  * This program is distributed in the hope that it will be useful,
    19|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    20|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    21|  * GNU General Public License for more details.
    22|  *
    23|  * You should have received a copy of the GNU General Public License
    24|  * along with this program. If not, see <http://www.gnu.org/licenses/>.
    25|  */
    26| /**
    27|  *	\file       htdocs/filefunc.inc.php
    28|  * 	\ingroup	core
    29|  *  \brief      File that include conf.php file and commons lib like functions.lib.php
    30|  */
    31| if (! defined('DOL_APPLICATION_TITLE')) define('DOL_APPLICATION_TITLE','Dolibarr');
    32| if (! defined('DOL_VERSION')) define('DOL_VERSION','7.0.1');		// a.b.c-alpha, a.b.c-beta, a.b.c-rcX or a.b.c
    33| if (! defined('EURO')) define('EURO',chr(128));
    34| if (! defined('LOG_DEBUG'))
    35| {
    36| 	if (! function_exists("syslog")) {
    37| 		define('LOG_EMERG',0);
    38| 		define('LOG_ALERT',1);
    39| 		define('LOG_CRIT',2);
    40| 		define('LOG_ERR',3);
    41| 		define('LOG_WARNING',4);
    42| 		define('LOG_NOTICE',5);
    43| 		define('LOG_INFO',6);
    44| 		define('LOG_DEBUG',7);
    45| 	}
    46| }
    47| if (defined('DOL_INC_FOR_VERSION_ERROR')) return;
    48| $conffiletoshowshort = "conf.php";
    49| $conffile = "conf/conf.php";
    50| $conffiletoshow = "htdocs/conf/conf.php";
    51| $result=@include_once $conffile;	// Keep @ because with some error reporting this break the redirect done when file not found
    52| if (! $result && ! empty($_SERVER["GATEWAY_INTERFACE"]))    // If install not done and we are in a web session

# --- HUNK 2: Lines 87-132 ---
    87| if (! empty($dolibarr_main_prod)) ini_set('display_errors','Off');
    88| $dolibarr_main_data_root=trim($dolibarr_main_data_root);
    89| $dolibarr_main_url_root=trim(preg_replace('/\/+$/','',$dolibarr_main_url_root));
    90| $dolibarr_main_url_root_alt=(empty($dolibarr_main_url_root_alt)?'':trim($dolibarr_main_url_root_alt));
    91| $dolibarr_main_document_root=trim($dolibarr_main_document_root);
    92| $dolibarr_main_document_root_alt=(empty($dolibarr_main_document_root_alt)?'':trim($dolibarr_main_document_root_alt));
    93| if (empty($dolibarr_main_db_port)) $dolibarr_main_db_port=0;		// Pour compatibilite avec anciennes configs, si non defini, on prend 'mysql'
    94| if (empty($dolibarr_main_db_type)) $dolibarr_main_db_type='mysqli';	// Pour compatibilite avec anciennes configs, si non defini, on prend 'mysql'
    95| if ($dolibarr_main_db_type == 'mysql') $dolibarr_main_db_type = 'mysqli';
    96| if (empty($dolibarr_main_db_prefix)) $dolibarr_main_db_prefix='llx_';
    97| if (empty($dolibarr_main_db_character_set)) $dolibarr_main_db_character_set=($dolibarr_main_db_type=='mysqli'?'utf8':'');		// Old installation
    98| if (empty($dolibarr_main_db_collation)) $dolibarr_main_db_collation=($dolibarr_main_db_type=='mysqli'?'utf8_unicode_ci':'');	// Old installation
    99| if (empty($dolibarr_main_db_encryption)) $dolibarr_main_db_encryption=0;
   100| if (empty($dolibarr_main_db_cryptkey)) $dolibarr_main_db_cryptkey='';
   101| if (empty($dolibarr_main_limit_users)) $dolibarr_main_limit_users=0;
   102| if (empty($dolibarr_mailing_limit_sendbyweb)) $dolibarr_mailing_limit_sendbyweb=0;
   103| if (empty($dolibarr_mailing_limit_sendbycli)) $dolibarr_mailing_limit_sendbycli=0;
   104| if (empty($dolibarr_strict_mode)) $dolibarr_strict_mode=0; // For debug in php strict mode
   105| if (! defined('NOCSRFCHECK') && empty($dolibarr_nocsrfcheck))
   106| {
   107|     if (! empty($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] != 'GET' && ! empty($_SERVER['HTTP_HOST'])
   108|     && (empty($_SERVER['HTTP_REFERER']) || ! preg_match('/'.preg_quote($_SERVER['HTTP_HOST'],'/').'/i', $_SERVER['HTTP_REFERER'])))
   109|     {
   110|     	print "Access refused by CSRF protection in main.inc.php. Referer of form is outside server that serve the POST.\n";
   111|         print "If you access your server behind a proxy using url rewriting, you might check that all HTTP header is propagated (or add the line \$dolibarr_nocsrfcheck=1 into your conf.php file).\n";
   112|     	die;
   113|     }
   114| }
   115| if (empty($dolibarr_main_db_host))
   116| {
   117| 	print '<div align="center">Dolibarr setup is not yet complete.<br><br>'."\n";
   118| 	print '<a href="install/index.php">Click here to finish Dolibarr install process</a> ...</div>'."\n";
   119| 	die;
   120| }
   121| if (empty($dolibarr_main_url_root))
   122| {
   123| 	print 'Value for parameter \'dolibarr_main_url_root\' is not defined in your \'htdocs\conf\conf.php\' file.<br>'."\n";
   124| 	print 'You must add this parameter with your full Dolibarr root Url (Example: http://myvirtualdomain/ or http://mydomain/mydolibarrurl/)'."\n";
   125| 	die;
   126| }
   127| if (empty($dolibarr_main_data_root))
   128| {
   129| 	$dolibarr_main_data_root=str_replace("/htdocs","",$dolibarr_main_document_root);
   130| 	$dolibarr_main_data_root.="/documents";
   131| }
   132| define('DOL_CLASS_PATH', 'class/');									// Filesystem path to class dir (defined only for some code that want to be compatible with old versions without this parameter)


# ====================================================================
# FILE: htdocs/fourn/card.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 27-67 ---
    27|  *	\brief      Page for supplier third party card (view, edit)
    28|  */
    29| require '../main.inc.php';
    30| require_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.class.php';
    31| require_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.facture.class.php';
    32| require_once DOL_DOCUMENT_ROOT.'/supplier_proposal/class/supplier_proposal.class.php';
    33| require_once DOL_DOCUMENT_ROOT.'/contact/class/contact.class.php';
    34| require_once DOL_DOCUMENT_ROOT.'/core/lib/company.lib.php';
    35| require_once DOL_DOCUMENT_ROOT.'/core/class/extrafields.class.php';
    36| if (! empty($conf->adherent->enabled)) require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';
    37| $langs->load('companies');
    38| $langs->load('suppliers');
    39| $langs->load('products');
    40| $langs->load('bills');
    41| $langs->load('orders');
    42| $langs->load('commercial');
    43| $action	= GETPOST('action','aZ09');
    44| $cancelbutton = GETPOST('cancel','alpha');
    45| $id = (GETPOST('socid','int') ? GETPOST('socid','int') : GETPOST('id','int'));
    46| if ($user->societe_id) $id=$user->societe_id;
    47| $result = restrictedArea($user, 'societe&fournisseur', $id, '&societe');
    48| $object = new Fournisseur($db);
    49| $extrafields = new ExtraFields($db);
    50| $extralabels=$extrafields->fetch_name_optionals_label($object->table_element);
    51| $hookmanager->initHooks(array('suppliercard','globalcard'));
    52| /*
    53|  * Action
    54|  */
    55| $parameters=array('id'=>$id);
    56| $reshook=$hookmanager->executeHooks('doActions', $parameters, $object, $action);    // Note that $action and $object may have been modified by some hooks
    57| if ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');
    58| if (empty($reshook))
    59| {
    60| 	if ($cancelbutton)
    61| 	{
    62| 		$action = "";
    63| 	}
    64| 	if ($action == 'setsupplieraccountancycode')
    65| 	{
    66| 		$result=$object->fetch($id);
    67|    		$object->code_compta_fournisseur=$_POST["supplieraccountancycode"];


# ====================================================================
# FILE: htdocs/fourn/class/fournisseur.commande.class.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 1310-1350 ---
  1310|             $subprice = price2num($pu,'MU');
  1311|             $rangmax = $this->line_max();
  1312|             $rang = $rangmax + 1;
  1313|             $this->line=new CommandeFournisseurLigne($this->db);
  1314|             $this->line->context = $this->context;
  1315|             $this->line->fk_commande=$this->id;
  1316|             $this->line->label=$label;
  1317|             $this->line->ref_fourn = $ref_supplier;
  1318|             $this->line->ref_supplier = $ref_supplier;
  1319|             $this->line->desc=$desc;
  1320|             $this->line->qty=$qty;
  1321|             $this->line->tva_tx=$txtva;
  1322|             $this->line->localtax1_tx=($total_localtax1?$localtaxes_type[1]:0);
  1323|             $this->line->localtax2_tx=($total_localtax2?$localtaxes_type[3]:0);
  1324|             $this->line->localtax1_type = $localtaxes_type[0];
  1325|             $this->line->localtax2_type = $localtaxes_type[2];
  1326|             $this->line->fk_product=$fk_product;
  1327|             $this->line->product_type=$product_type;
  1328|             $this->line->remise_percent=$remise_percent;
  1329|             $this->line->subprice=$pu_ht;
  1330|             $this->line->rang=$this->rang;
  1331|             $this->line->info_bits=$info_bits;
  1332|             $this->line->vat_src_code=$vat_src_code;
  1333|             $this->line->total_ht=$total_ht;
  1334|             $this->line->total_tva=$total_tva;
  1335|             $this->line->total_localtax1=$total_localtax1;
  1336|             $this->line->total_localtax2=$total_localtax2;
  1337|             $this->line->total_ttc=$total_ttc;
  1338|             $this->line->product_type=$type;
  1339|             $this->line->special_code=$this->special_code;
  1340|             $this->line->origin=$origin;
  1341|             $this->line->origin_id=$origin_id;
  1342|             $this->line->fk_unit=$fk_unit;
  1343|             $this->line->date_start=$date_start;
  1344|             $this->line->date_end=$date_end;
  1345|             $this->line->fk_multicurrency			= $this->fk_multicurrency;
  1346|             $this->line->multicurrency_code			= $this->multicurrency_code;
  1347|             $this->line->multicurrency_subprice		= $pu_ht_devise;
  1348|             $this->line->multicurrency_total_ht 	= $multicurrency_total_ht;
  1349|             $this->line->multicurrency_total_tva 	= $multicurrency_total_tva;
  1350|             $this->line->multicurrency_total_ttc 	= $multicurrency_total_ttc;

# --- HUNK 2: Lines 1637-1693 ---
  1637|                 $i++;
  1638|             }
  1639|             return 0;
  1640|         }
  1641|         else
  1642|         {
  1643|             return -1;
  1644|         }
  1645|     }
  1646|     /**
  1647| 	 * Return array of dispathed lines waiting to be approved for this order
  1648| 	 *
  1649| 	 * @param	int		$status		Filter on stats (-1 = no filter, 0 = lines draft to be approved, 1 = approved lines)
  1650| 	 * @return	array				Array of lines
  1651|      */
  1652|     public function getDispachedLines($status=-1)
  1653|     {
  1654|     	$ret = array();
  1655| 		$sql = "SELECT p.ref, p.label,";
  1656| 		$sql.= " e.rowid as warehouse_id, e.ref as entrepot,";
  1657| 		$sql.= " cfd.rowid as dispatchlineid, cfd.fk_product, cfd.qty, cfd.eatby, cfd.sellby, cfd.batch, cfd.comment, cfd.status";
  1658| 		$sql.= " FROM ".MAIN_DB_PREFIX."product as p,";
  1659| 		$sql.= " ".MAIN_DB_PREFIX."commande_fournisseur_dispatch as cfd";
  1660| 		$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."entrepot as e ON cfd.fk_entrepot = e.rowid";
  1661| 		$sql.= " WHERE cfd.fk_commande = ".$this->id;
  1662| 		$sql.= " AND cfd.fk_product = p.rowid";
  1663| 		if ($status >= 0) $sql.=" AND cfd.status = ".$status;
  1664| 		$sql.= " ORDER BY cfd.rowid ASC";
  1665| 		$resql = $this->db->query($sql);
  1666| 		if ($resql)
  1667| 		{
  1668| 			$num = $this->db->num_rows($resql);
  1669| 			$i = 0;
  1670| 			while ($i < $num)
  1671| 			{
  1672| 				$objp = $this->db->fetch_object($resql);
  1673| 				if ($objp) $ret[]=array('id'=>$objp->dispatchedlineid, 'productid'=>$objp->fk_product, 'warehouseid'=>$objp->warehouse_id);
  1674| 				$i++;
  1675| 			}
  1676| 		}
  1677| 		else dol_print_error($this->db, 'Failed to execute request to get dispatched lines');
  1678| 		return $ret;
  1679|     }
  1680|     /**
  1681|      * 	Set a delivery in database for this supplier order
  1682|      *
  1683|      *	@param	User	$user		User that input data
  1684|      *	@param	date	$date		Date of reception
  1685|      *	@param	string	$type		Type of receipt ('tot' = total/done, 'par' = partial, 'nev' = never, 'can' = cancel)
  1686|      *	@param	string	$comment	Comment
  1687|      *	@return	int					<0 if KO, >0 if OK
  1688|      */
  1689|     function Livraison($user, $date, $type, $comment)
  1690|     {
  1691|     	global $conf, $langs;
  1692|         $result = 0;
  1693| 		$error = 0;

# --- HUNK 3: Lines 2510-2618 ---
  2510|     	return 0;
  2511|     }
  2512| }
  2513| /**
  2514|  *  Class to manage line orders
  2515|  */
  2516| class CommandeFournisseurLigne extends CommonOrderLine
  2517| {
  2518|     public $element='commande_fournisseurdet';
  2519| 	public $table_element='commande_fournisseurdet';
  2520|     public $oldline;
  2521|     /**
  2522|      * Id of parent order
  2523|      * @var int
  2524|      */
  2525|     public $fk_commande;
  2526|     public $fk_parent_line;
  2527|     public $fk_facture;
  2528|     public $label;
  2529|     public $rang = 0;
  2530| 	/**
  2531| 	 * Unit price without taxes
  2532| 	 * @var float
  2533| 	 */
  2534| 	public $pu_ht;
  2535|     public $date_start;
  2536|     public $date_end;
  2537| 	/**
  2538| 	 * Supplier reference of price when we added the line. May have been changed after line was added.
  2539| 	 * @var string
  2540| 	 */
  2541|     public $ref_supplier;
  2542|     public $remise;
  2543|     public $product_libelle;
  2544|     /**
  2545|      *	Constructor
  2546|      *
  2547|      *  @param		DoliDB		$db      Database handler
  2548|      */
  2549|     public function __construct($db)
  2550|     {
  2551|         $this->db= $db;
  2552|     }
  2553|     /**
  2554|      *  Load line order
  2555|      *
  2556|      *  @param  int		$rowid      Id line order
  2557|      *	@return	int					<0 if KO, >0 if OK
  2558|      */
  2559|     public function fetch($rowid)
  2560|     {
  2561|         $sql = 'SELECT cd.rowid, cd.fk_commande, cd.fk_product, cd.product_type, cd.description, cd.qty, cd.tva_tx,';
  2562|         $sql.= ' cd.localtax1_tx, cd.localtax2_tx, cd.localtax1_type, cd.localtax2_type, cd.ref,';
  2563|         $sql.= ' cd.remise, cd.remise_percent, cd.subprice,';
  2564|         $sql.= ' cd.info_bits, cd.total_ht, cd.total_tva, cd.total_ttc,';
  2565|         $sql.= ' cd.total_localtax1, cd.total_localtax2,';
  2566|         $sql.= ' p.ref as product_ref, p.label as product_libelle, p.description as product_desc,';
  2567|         $sql.= ' cd.date_start, cd.date_end, cd.fk_unit,';
  2568| 		$sql.= ' cd.multicurrency_subprice, cd.multicurrency_total_ht, cd.multicurrency_total_tva, cd.multicurrency_total_ttc';
  2569|         $sql.= ' FROM '.MAIN_DB_PREFIX.'commande_fournisseurdet as cd';
  2570|         $sql.= ' LEFT JOIN '.MAIN_DB_PREFIX.'product as p ON cd.fk_product = p.rowid';
  2571|         $sql.= ' WHERE cd.rowid = '.$rowid;
  2572|         $result = $this->db->query($sql);
  2573|         if ($result)
  2574|         {
  2575|             $objp = $this->db->fetch_object($result);
  2576|             $this->rowid            = $objp->rowid;
  2577|             $this->id               = $objp->rowid;
  2578|             $this->fk_commande      = $objp->fk_commande;
  2579|             $this->desc             = $objp->description;
  2580|             $this->qty              = $objp->qty;
  2581|             $this->ref_fourn        = $objp->ref;
  2582|             $this->ref_supplier     = $objp->ref;
  2583|             $this->subprice         = $objp->subprice;
  2584|             $this->tva_tx           = $objp->tva_tx;
  2585|             $this->localtax1_tx		= $objp->localtax1_tx;
  2586|             $this->localtax2_tx		= $objp->localtax2_tx;
  2587|             $this->localtax1_type	= $objp->localtax1_type;
  2588|             $this->localtax2_type	= $objp->localtax2_type;
  2589|             $this->remise           = $objp->remise;
  2590|             $this->remise_percent   = $objp->remise_percent;
  2591|             $this->fk_product       = $objp->fk_product;
  2592|             $this->info_bits        = $objp->info_bits;
  2593|             $this->total_ht         = $objp->total_ht;
  2594|             $this->total_tva        = $objp->total_tva;
  2595|             $this->total_localtax1	= $objp->total_localtax1;
  2596|             $this->total_localtax2	= $objp->total_localtax2;
  2597|             $this->total_ttc        = $objp->total_ttc;
  2598|             $this->product_type     = $objp->product_type;
  2599|             $this->ref	            = $objp->product_ref;
  2600|             $this->product_ref      = $objp->product_ref;
  2601|             $this->product_libelle  = $objp->product_libelle;
  2602|             $this->product_desc     = $objp->product_desc;
  2603|             $this->date_start       		= $this->db->jdate($objp->date_start);
  2604|             $this->date_end         		= $this->db->jdate($objp->date_end);
  2605| 	        $this->fk_unit          		= $objp->fk_unit;
  2606| 			$this->multicurrency_subprice	= $objp->multicurrency_subprice;
  2607| 			$this->multicurrency_total_ht	= $objp->multicurrency_total_ht;
  2608| 			$this->multicurrency_total_tva	= $objp->multicurrency_total_tva;
  2609| 			$this->multicurrency_total_ttc	= $objp->multicurrency_total_ttc;
  2610|             $this->db->free($result);
  2611|             return 1;
  2612|         }
  2613|         else
  2614|         {
  2615|             dol_print_error($this->db);
  2616|             return -1;
  2617|         }
  2618|     }

# --- HUNK 4: Lines 2664-2714 ---
  2664|         if (empty($this->total_localtax1)) $this->total_localtax1=0;
  2665|         if (empty($this->total_localtax2)) $this->total_localtax2=0;
  2666|         if (empty($this->rang)) $this->rang=0;
  2667|         if (empty($this->remise)) $this->remise=0;
  2668|         if (empty($this->remise_percent)) $this->remise_percent=0;
  2669|         if (empty($this->info_bits)) $this->info_bits=0;
  2670|         if (empty($this->special_code)) $this->special_code=0;
  2671|         if (empty($this->fk_parent_line)) $this->fk_parent_line=0;
  2672|         if (empty($this->pa_ht)) $this->pa_ht=0;
  2673|         if (!empty($this->multicurrency_code)) list($this->fk_multicurrency,$this->multicurrency_tx) = MultiCurrency::getIdAndTxFromCode($this->db, $this->multicurrency_code);
  2674|         if (empty($this->fk_multicurrency))
  2675|         {
  2676|             $this->multicurrency_code = $conf->currency;
  2677|             $this->fk_multicurrency = 0;
  2678|             $this->multicurrency_tx = 1;
  2679|         }
  2680|         if ($this->product_type < 0) return -1;
  2681|         $this->db->begin();
  2682|         $sql = 'INSERT INTO '.MAIN_DB_PREFIX.$this->table_element;
  2683|         $sql.= " (fk_commande, label, description, date_start, date_end,";
  2684|         $sql.= " fk_product, product_type,";
  2685|         $sql.= " qty, vat_src_code, tva_tx, localtax1_tx, localtax2_tx, localtax1_type, localtax2_type, remise_percent, subprice, ref,";
  2686|         $sql.= " total_ht, total_tva, total_localtax1, total_localtax2, total_ttc, fk_unit,";
  2687|         $sql.= " fk_multicurrency, multicurrency_code, multicurrency_subprice, multicurrency_total_ht, multicurrency_total_tva, multicurrency_total_ttc";
  2688|         $sql.= ")";
  2689|         $sql.= " VALUES (".$this->fk_commande.", '" . $this->db->escape($this->label) . "','" . $this->db->escape($this->desc) . "',";
  2690|         $sql.= " ".($this->date_start?"'".$this->db->idate($this->date_start)."'":"null").",";
  2691|         $sql.= " ".($this->date_end?"'".$this->db->idate($this->date_end)."'":"null").",";
  2692|         if ($this->fk_product) { $sql.= $this->fk_product.","; }
  2693|         else { $sql.= "null,"; }
  2694|         $sql.= "'".$this->db->escape($this->product_type)."',";
  2695|         $sql.= "'".$this->db->escape($this->qty)."', ";
  2696|         $sql.= " ".(empty($this->vat_src_code)?"''":"'".$this->db->escape($this->vat_src_code)."'").",";
  2697|         $sql.= " ".$this->tva_tx.", ";
  2698|         $sql.= " ".$this->localtax1_tx.",";
  2699|         $sql.= " ".$this->localtax2_tx.",";
  2700|         $sql.= " '".$this->db->escape($this->localtax1_type)."',";
  2701|         $sql.= " '".$this->db->escape($this->localtax2_type)."',";
  2702|         $sql.= " ".$this->remise_percent.", ".price2num($this->subprice,'MU').", '".$this->db->escape($this->ref_supplier)."',";
  2703|         $sql.= " ".price2num($this->total_ht).",";
  2704|         $sql.= " ".price2num($this->total_tva).",";
  2705|         $sql.= " ".price2num($this->total_localtax1).",";
  2706|         $sql.= " ".price2num($this->total_localtax2).",";
  2707|         $sql.= " ".price2num($this->total_ttc).",";
  2708|         $sql.= ($this->fk_unit ? "'".$this->db->escape($this->fk_unit)."'":"null");
  2709|         $sql.= ", ".($this->fk_multicurrency ? $this->fk_multicurrency : "null");
  2710|         $sql.= ", '".$this->db->escape($this->multicurrency_code)."'";
  2711|         $sql.= ", ".price2num($this->multicurrency_subprice);
  2712|         $sql.= ", ".price2num($this->multicurrency_total_ht);
  2713|         $sql.= ", ".price2num($this->multicurrency_total_tva);
  2714|         $sql.= ", ".price2num($this->multicurrency_total_ttc);

# --- HUNK 5: Lines 2765-2804 ---
  2765|         $sql.= "  description='".$this->db->escape($this->desc)."'";
  2766|         $sql.= ", ref='".$this->db->escape($this->ref_supplier)."'";
  2767|         $sql.= ", subprice='".price2num($this->subprice)."'";
  2768|         $sql.= ", remise_percent='".price2num($this->remise_percent)."'";
  2769| 		$sql.= ", vat_src_code = '".(empty($this->vat_src_code)?'':$this->vat_src_code)."'";
  2770|         $sql.= ", tva_tx='".price2num($this->tva_tx)."'";
  2771|         $sql.= ", localtax1_tx='".price2num($this->total_localtax1)."'";
  2772|         $sql.= ", localtax2_tx='".price2num($this->total_localtax2)."'";
  2773|         $sql.= ", localtax1_type='".$this->db->escape($this->localtax1_type)."'";
  2774|         $sql.= ", localtax2_type='".$this->db->escape($this->localtax2_type)."'";
  2775|         $sql.= ", qty='".price2num($this->qty)."'";
  2776|         $sql.= ", date_start=".(! empty($this->date_start)?"'".$this->db->idate($this->date_start)."'":"null");
  2777|         $sql.= ", date_end=".(! empty($this->date_end)?"'".$this->db->idate($this->date_end)."'":"null");
  2778|         $sql.= ", info_bits='".$this->db->escape($this->info_bits)."'";
  2779|         $sql.= ", total_ht='".price2num($this->total_ht)."'";
  2780|         $sql.= ", total_tva='".price2num($this->total_tva)."'";
  2781|         $sql.= ", total_localtax1='".price2num($this->total_localtax1)."'";
  2782|         $sql.= ", total_localtax2='".price2num($this->total_localtax2)."'";
  2783|         $sql.= ", total_ttc='".price2num($this->total_ttc)."'";
  2784|         $sql.= ", product_type=".$this->product_type;
  2785|         $sql.= ($this->fk_unit ? ", fk_unit='".$this->db->escape($this->fk_unit)."'":", fk_unit=null");
  2786|         $sql.= ", multicurrency_subprice=".price2num($this->multicurrency_subprice)."";
  2787|         $sql.= ", multicurrency_total_ht=".price2num($this->multicurrency_total_ht)."";
  2788|         $sql.= ", multicurrency_total_tva=".price2num($this->multicurrency_total_tva)."";
  2789|         $sql.= ", multicurrency_total_ttc=".price2num($this->multicurrency_total_ttc)."";
  2790|         $sql.= " WHERE rowid = ".$this->id;
  2791|         dol_syslog(get_class($this)."::updateline", LOG_DEBUG);
  2792|         $result = $this->db->query($sql);
  2793|         if ($result > 0)
  2794|         {
  2795|             if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) // For avoid conflicts if trigger used
  2796|             {
  2797|                 $result=$this->insertExtraFields();
  2798|                 if ($result < 0)
  2799|                 {
  2800|                     $error++;
  2801|                 }
  2802|             }
  2803|             if (! $error && ! $notrigger)
  2804|             {


# ====================================================================
# FILE: htdocs/fourn/class/fournisseur.facture.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1180-1244 ---
  1180|      *  @param      int     $origin_id          id origin document
  1181| 	 *  @param		double	$pu_ht_devise		Amount in currency
  1182| 	 *  @param		string	$ref_supplier		Supplier ref
  1183|      *	@return    	int             			>0 if OK, <0 if KO
  1184|      *
  1185|      *  FIXME Add field ref (that should be named ref_supplier) and label into update. For example can be filled when product line created from order.
  1186|      */
  1187|     public function addline($desc, $pu, $txtva, $txlocaltax1, $txlocaltax2, $qty, $fk_product=0, $remise_percent=0, $date_start='', $date_end='', $ventil=0, $info_bits='', $price_base_type='HT', $type=0, $rang=-1, $notrigger=false, $array_options=0, $fk_unit=null, $origin_id=0, $pu_ht_devise=0, $ref_supplier='')
  1188|     {
  1189|         dol_syslog(get_class($this)."::addline $desc,$pu,$qty,$txtva,$fk_product,$remise_percent,$date_start,$date_end,$ventil,$info_bits,$price_base_type,$type,$fk_unit", LOG_DEBUG);
  1190|         include_once DOL_DOCUMENT_ROOT.'/core/lib/price.lib.php';
  1191|         global $mysoc;
  1192|         if (empty($remise_percent)) $remise_percent=0;
  1193|         if (empty($qty)) $qty=0;
  1194|         if (empty($info_bits)) $info_bits=0;
  1195|         if (empty($rang)) $rang=0;
  1196|         if (empty($ventil)) $ventil=0;
  1197|         if (empty($txtva)) $txtva=0;
  1198|         if (empty($txlocaltax1)) $txlocaltax1=0;
  1199|         if (empty($txlocaltax2)) $txlocaltax2=0;
  1200|         $localtaxes_type=getLocalTaxesFromRate($txtva, 0, $mysoc, $this->thirdparty);
  1201|         $vat_src_code='';
  1202|         if (preg_match('/\((.*)\)/', $txtva, $reg))
  1203|         {
  1204|             $vat_src_code = $reg[1];
  1205|             $txtva = preg_replace('/\s*\(.*\)/', '', $txtva);    // Remove code into vatrate.
  1206|         }
  1207|         $remise_percent=price2num($remise_percent);
  1208|         $qty=price2num($qty);
  1209|         $pu=price2num($pu);
  1210|         $txtva=price2num($txtva);
  1211|         $txlocaltax1=price2num($txlocaltax1);
  1212|         $txlocaltax2=price2num($txlocaltax2);
  1213|         $tabprice = calcul_price_total($qty, $pu, $remise_percent, $txtva, $txlocaltax1, $txlocaltax2, 0, $price_base_type, $info_bits, $type, $this->thirdparty, $localtaxes_type, 100, $this->multicurrency_tx, $pu_ht_devise);
  1214|         $total_ht  = $tabprice[0];
  1215|         $total_tva = $tabprice[1];
  1216|         $total_ttc = $tabprice[2];
  1217|         $total_localtax1 = $tabprice[9];
  1218|         $total_localtax2 = $tabprice[10];
  1219| 		$pu_ht = $tabprice[3];
  1220|         $multicurrency_total_ht  = $tabprice[16];
  1221|         $multicurrency_total_tva = $tabprice[17];
  1222|         $multicurrency_total_ttc = $tabprice[18];
  1223| 		$pu_ht_devise = $tabprice[19];
  1224|         if ($type < 0) return -1;
  1225|         $this->line=new SupplierInvoiceLine($this->db);
  1226|         $this->line->context = $this->context;
  1227|         $this->line->fk_facture_fourn=$this->id;
  1228|         $this->line->desc=$desc;
  1229|         $this->line->qty=            ($this->type==self::TYPE_CREDIT_NOTE?abs($qty):$qty);	// For credit note, quantity is always positive and unit price negative
  1230| 		$this->line->ref_supplier=$ref_supplier;
  1231|         $this->line->vat_src_code=$vat_src_code;
  1232|         $this->line->tva_tx=$txtva;
  1233|         $this->line->localtax1_tx=($total_localtax1?$localtaxes_type[1]:0);
  1234|         $this->line->localtax2_tx=($total_localtax2?$localtaxes_type[3]:0);
  1235|         $this->line->localtax1_type = $localtaxes_type[0];
  1236|         $this->line->localtax2_type = $localtaxes_type[2];
  1237|         $this->line->fk_product=$fk_product;
  1238|         $this->line->product_type=$type;
  1239|         $this->line->remise_percent=$remise_percent;
  1240|         $this->line->subprice=       ($this->type==self::TYPE_CREDIT_NOTE?-abs($pu_ht):$pu_ht); // For credit note, unit price always negative, always positive otherwise
  1241|         $this->line->date_start=$date_start;
  1242|         $this->line->date_end=$date_end;
  1243|         $this->line->ventil=$ventil;
  1244|         $this->line->rang=$rang;


# ====================================================================
# FILE: htdocs/fourn/class/paiementfourn.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 73-112 ---
    73| 		$sql.= ' LEFT JOIN '.MAIN_DB_PREFIX.'c_paiement as c ON p.fk_paiement = c.id AND c.entity IN ('.getEntity('c_paiement').')';
    74| 		$sql.= ' LEFT JOIN '.MAIN_DB_PREFIX.'bank as b ON p.fk_bank = b.rowid ';
    75| 		$sql.= ' WHERE p.entity IN ('.getEntity('facture_fourn').')';
    76| 		if ($id > 0)
    77| 			$sql.= ' AND p.rowid = '.$id;
    78| 		else if ($ref)
    79| 			$sql.= ' AND p.rowid = '.$ref;
    80| 		else if ($fk_bank)
    81| 			$sql.= ' AND p.fk_bank = '.$fk_bank;
    82| 		$resql = $this->db->query($sql);
    83| 		if ($resql)
    84| 		{
    85| 			$num = $this->db->num_rows($resql);
    86| 			if ($num > 0)
    87| 			{
    88| 				$obj = $this->db->fetch_object($resql);
    89| 				$this->id             = $obj->rowid;
    90| 				$this->ref            = $obj->ref;
    91| 				$this->entity         = $obj->entity;
    92| 				$this->date           = $this->db->jdate($obj->dp);
    93| 				$this->numero         = $obj->num_paiement;
    94| 				$this->bank_account   = $obj->fk_account;
    95| 				$this->bank_line      = $obj->fk_bank;
    96| 				$this->montant        = $obj->amount;
    97| 				$this->note           = $obj->note;
    98| 				$this->type_code      = $obj->paiement_code;
    99| 				$this->type_libelle   = $obj->paiement_type;
   100| 				$this->statut         = $obj->statut;
   101| 				$error = 1;
   102| 			}
   103| 			else
   104| 			{
   105| 				$error = -2;    // TODO Use 0 instead
   106| 			}
   107| 			$this->db->free($resql);
   108| 		}
   109| 		else
   110| 		{
   111| 			dol_print_error($this->db);
   112| 			$error = -1;


# ====================================================================
# FILE: htdocs/fourn/commande/card.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 675-714 ---
   675| 		}
   676| 	}
   677| 	if ($action == 'confirm_commande' && $confirm	== 'yes' &&	$user->rights->fournisseur->commande->commander)
   678| 	{
   679| 		$result = $object->commande($user, $_REQUEST["datecommande"],	$_REQUEST["methode"], $_REQUEST['comment']);
   680| 		if ($result > 0)
   681| 		{
   682| 			if (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE))
   683| 			{
   684| 				$outputlangs = $langs;
   685| 				$newlang = '';
   686| 				if ($conf->global->MAIN_MULTILANGS && empty($newlang) && GETPOST('lang_id','aZ09')) $newlang = GETPOST('lang_id','aZ09');
   687| 				if ($conf->global->MAIN_MULTILANGS && empty($newlang))	$newlang = $object->thirdparty->default_lang;
   688| 				if (! empty($newlang)) {
   689| 					$outputlangs = new Translate("", $conf);
   690| 					$outputlangs->setDefaultLang($newlang);
   691| 				}
   692| 				$object->generateDocument($object->modelpdf, $outputlangs, $hidedetails, $hidedesc, $hideref);
   693| 			}
   694| 			$action = '';
   695| 		}
   696| 		else
   697| 		{
   698| 			setEventMessages($object->error, $object->errors, 'errors');
   699| 		}
   700| 	}
   701| 	if ($action == 'confirm_delete' && $confirm == 'yes' && $user->rights->fournisseur->commande->supprimer)
   702| 	{
   703| 		$result=$object->delete($user);
   704| 		if ($result > 0)
   705| 		{
   706| 			header("Location: ".DOL_URL_ROOT.'/fourn/commande/list.php?restore_lastsearch_values=1');
   707| 			exit;
   708| 		}
   709| 		else
   710| 		{
   711| 			setEventMessages($object->error, $object->errors, 'errors');
   712| 		}
   713| 	}
   714| 	if ($action == 'confirm_clone' && $confirm == 'yes' && $user->rights->fournisseur->commande->creer)

# --- HUNK 2: Lines 866-956 ---
   866| 					$id = $object->create($user);
   867| 					if ($id > 0)
   868| 					{
   869| 						dol_include_once('/' . $element . '/class/' . $subelement . '.class.php');
   870| 						$classname = 'SupplierProposal';
   871| 						$srcobject = new $classname($db);
   872| 						dol_syslog("Try to find source object origin=" . $object->origin . " originid=" . $object->origin_id . " to add lines");
   873| 						$result = $srcobject->fetch($object->origin_id);
   874| 						if ($result > 0)
   875| 						{
   876| 							$object->set_date_livraison($user, $srcobject->date_livraison);
   877| 							$object->set_id_projet($user, $srcobject->fk_project);
   878| 							$lines = $srcobject->lines;
   879| 							if (empty($lines) && method_exists($srcobject, 'fetch_lines'))
   880| 							{
   881| 								$srcobject->fetch_lines();
   882| 								$lines = $srcobject->lines;
   883| 							}
   884| 							$fk_parent_line = 0;
   885| 							$num = count($lines);
   886| 							$productsupplier = new ProductFournisseur($db);
   887| 							for($i = 0; $i < $num; $i ++)
   888| 							{
   889| 								if (empty($lines[$i]->subprice) || $lines[$i]->qty <= 0)
   890| 									continue;
   891| 								$label = (! empty($lines[$i]->label) ? $lines[$i]->label : '');
   892| 								$desc = (! empty($lines[$i]->desc) ? $lines[$i]->desc : $lines[$i]->libelle);
   893| 								$product_type = (! empty($lines[$i]->product_type) ? $lines[$i]->product_type : 0);
   894| 								if (($lines[$i]->product_type != 9 && empty($lines[$i]->fk_parent_line)) || $lines[$i]->product_type == 9) {
   895| 									$fk_parent_line = 0;
   896| 								}
   897| 								if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED) && method_exists($lines[$i], 'fetch_optionals')) 							// For avoid conflicts if
   898| 								{
   899| 									$lines[$i]->fetch_optionals($lines[$i]->rowid);
   900| 									$array_option = $lines[$i]->array_options;
   901| 								}
   902| 								$result = $productsupplier->find_min_price_product_fournisseur($lines[$i]->fk_product, $lines[$i]->qty, $srcobject->socid);
   903| 								if ($result>=0)
   904| 								{
   905| 									$tva_tx = $lines[$i]->tva_tx;
   906| 									if ($origin=="commande")
   907| 									{
   908| 										$soc=new societe($db);
   909| 										$soc->fetch($socid);
   910| 										$tva_tx=get_default_tva($soc, $mysoc, $lines[$i]->fk_product, $productsupplier->product_fourn_price_id);
   911| 									}
   912| 									$result = $object->addline(
   913| 										$desc,
   914| 										$lines[$i]->subprice,
   915| 										$lines[$i]->qty,
   916| 										$tva_tx,
   917| 										$lines[$i]->localtax1_tx,
   918| 										$lines[$i]->localtax2_tx,
   919| 										$lines[$i]->fk_product > 0 ? $lines[$i]->fk_product : 0,
   920| 										$productsupplier->product_fourn_price_id,
   921| 										$productsupplier->ref_supplier,
   922| 										$lines[$i]->remise_percent,
   923| 										'HT',
   924| 										0,
   925| 										$lines[$i]->product_type,
   926| 										'',
   927| 										'',
   928| 										null,
   929| 										null,
   930| 										array(),
   931| 										$lines[$i]->fk_unit,
   932| 										0,
   933| 										$element,
   934| 										!empty($lines[$i]->id) ? $lines[$i]->id : $lines[$i]->rowid
   935| 									);
   936| 								}
   937| 								if ($result < 0) {
   938| 									$error++;
   939| 									break;
   940| 								}
   941| 								if ($result > 0 && $lines[$i]->product_type == 9) {
   942| 									$fk_parent_line = $result;
   943| 								}
   944| 							}
   945| 							$parameters = array('objFrom' => $srcobject);
   946| 							$reshook = $hookmanager->executeHooks('createFrom', $parameters, $object, $action); // Note that $action and $object may have been
   947| 							if ($reshook < 0)
   948| 								$error ++;
   949| 						} else {
   950| 							setEventMessages($srcobject->error, $srcobject->errors, 'errors');
   951| 							$error ++;
   952| 						}
   953| 					} else {
   954| 						setEventMessages($object->error, $object->errors, 'errors');
   955| 						$error ++;
   956| 					}

# --- HUNK 3: Lines 1101-1140 ---
  1101| 				dol_print_error($db);
  1102| 			}
  1103| 		}
  1104| 	}
  1105| }
  1106| /*
  1107|  * View
  1108|  */
  1109| $form =	new	Form($db);
  1110| $formfile = new FormFile($db);
  1111| $formorder = new FormOrder($db);
  1112| $productstatic = new Product($db);
  1113| if (! empty($conf->projet->enabled)) { $formproject = new FormProjets($db); }
  1114| $help_url='EN:Module_Suppliers_Orders|FR:CommandeFournisseur|ES:Mdulo_Pedidos_a_proveedores';
  1115| llxHeader('',$langs->trans("Order"),$help_url);
  1116| $now=dol_now();
  1117| if ($action=='create')
  1118| {
  1119| 	print load_fiche_titre($langs->trans('NewOrder'));
  1120| 	dol_htmloutput_events();
  1121| 	$societe='';
  1122| 	if ($socid>0)
  1123| 	{
  1124| 		$societe=new Societe($db);
  1125| 		$societe->fetch($socid);
  1126| 	}
  1127| 	if (! empty($origin) && ! empty($originid))
  1128| 	{
  1129| 		$element = $subelement = $origin;
  1130| 		if (preg_match('/^([^_]+)_([^_]+)/i', $origin, $regs)) {
  1131| 			$element = $regs [1];
  1132| 			$subelement = $regs [2];
  1133| 		}
  1134| 		$element = 'supplier_proposal';
  1135| 		$subelement = 'supplier_proposal';
  1136| 		dol_include_once('/' . $element . '/class/' . $subelement . '.class.php');
  1137| 		$classname = 'SupplierProposal';
  1138| 		$objectsrc = new $classname($db);
  1139| 		$objectsrc->fetch($originid);
  1140| 		if (empty($objectsrc->lines) && method_exists($objectsrc, 'fetch_lines'))

# --- HUNK 4: Lines 1718-1757 ---
  1718| 			$var = true;
  1719| 			$object->formAddObjectLine(1, $societe, $mysoc);
  1720| 			$parameters = array();
  1721| 			$reshook = $hookmanager->executeHooks('formAddObjectLine', $parameters, $object, $action); // Note that $action and $object may have been modified by hook
  1722| 		}
  1723| 	}
  1724| 	print '</table>';
  1725| 	print '</div>';
  1726| 	print '</form>';
  1727| 	dol_fiche_end();
  1728| 		/**
  1729| 		 * Boutons actions
  1730| 		 */
  1731| 		if ($user->societe_id == 0 && $action != 'editline' && $action != 'delete')
  1732| 		{
  1733| 			print '<div	class="tabsAction">';
  1734| 			$parameters = array();
  1735| 			$reshook = $hookmanager->executeHooks('addMoreActionsButtons', $parameters, $object, $action); // Note that $action and $object may have been
  1736| 			if (empty($reshook))
  1737| 			{
  1738| 				if ($object->statut == 0 && $num > 0)
  1739| 				{
  1740| 					if ((empty($conf->global->MAIN_USE_ADVANCED_PERMS) && ! empty($user->rights->fournisseur->commande->creer))
  1741| 				   	|| (! empty($conf->global->MAIN_USE_ADVANCED_PERMS) && ! empty($user->rights->fournisseur->supplier_order_advance->validate)))
  1742| 					{
  1743| 						$tmpbuttonlabel=$langs->trans('Validate');
  1744| 						if ($user->rights->fournisseur->commande->approuver && empty($conf->global->SUPPLIER_ORDER_NO_DIRECT_APPROVE)) $tmpbuttonlabel = $langs->trans("ValidateAndApprove");
  1745| 						print '<a class="butAction" href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=valid">';
  1746| 						print $tmpbuttonlabel;
  1747| 						print '</a>';
  1748| 					}
  1749| 				}
  1750| 				/*if ($conf->agenda->enabled && ! empty($conf->global->MAIN_ADD_EVENT_ON_ELEMENT_CARD)) 	// Add hidden condition because this is not a "workflow" action so should appears somewhere else on page.
  1751| 				{
  1752| 					print '<div class="inline-block divButAction"><a class="butAction" href="' . DOL_URL_ROOT . '/comm/action/card.php?action=create&amp;origin=' . $object->element . '&amp;originid=' . $object->id . '&amp;socid=' . $object->socid . '">' . $langs->trans("AddAction") . '</a></div>';
  1753| 				}*/
  1754| 				if ($object->statut == 1)
  1755| 				{
  1756| 					if ($user->rights->fournisseur->commande->commander)
  1757| 					{

# --- HUNK 5: Lines 1828-1872 ---
  1828| 						}
  1829| 					}
  1830| 					if (! $buttonshown && $user->rights->fournisseur->commande->approve2 && ! empty($conf->global->SUPPLIER_ORDER_3_STEPS_TO_BE_APPROVED))
  1831| 					{
  1832| 						if (empty($conf->global->SUPPLIER_ORDER_REOPEN_BY_APPROVER2_ONLY)
  1833| 							|| (! empty($conf->global->SUPPLIER_ORDER_REOPEN_BY_APPROVER2_ONLY) && $user->id == $object->user_approve_id2))
  1834| 						{
  1835| 							print '<a class="butAction" href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=reopen">'.$langs->trans("Disapprove").'</a>';
  1836| 						}
  1837| 					}
  1838| 				}
  1839| 				if (in_array($object->statut, array(3, 4, 5, 6, 7, 9)))
  1840| 				{
  1841| 					if ($user->rights->fournisseur->commande->commander)
  1842| 					{
  1843| 						print '<a class="butAction" href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=reopen">'.$langs->trans("ReOpen").'</a>';
  1844| 					}
  1845| 				}
  1846| 				if (! empty($conf->stock->enabled) && ! empty($conf->global->STOCK_CALCULATE_ON_SUPPLIER_DISPATCH_ORDER))
  1847| 				{
  1848| 					if (in_array($object->statut, array(3,4))) {
  1849| 						if ($conf->fournisseur->enabled && $user->rights->fournisseur->commande->receptionner) {
  1850| 							print '<div class="inline-block divButAction"><a class="butAction" href="' . DOL_URL_ROOT . '/fourn/commande/dispatch.php?id=' . $object->id . '">' . $langs->trans('OrderDispatch') . '</a></div>';
  1851| 						} else {
  1852| 							print '<div class="inline-block divButAction"><a class="butActionRefused" href="#" title="' . dol_escape_htmltag($langs->trans("NotAllowed")) . '">' . $langs->trans('OrderDispatch') . '</a></div>';
  1853| 						}
  1854| 					}
  1855| 				}
  1856| 				if ($object->statut == 2)
  1857| 				{
  1858| 					if ($user->rights->fournisseur->commande->commander)
  1859| 					{
  1860| 						print '<div class="inline-block divButAction"><a class="butAction" href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=makeorder#makeorder">'.$langs->trans("MakeOrder").'</a></div>';
  1861| 					}
  1862| 					else
  1863| 					{
  1864| 						print '<div class="inline-block divButAction"><a class="butActionRefused" href="#">'.$langs->trans("MakeOrder").'</a></div>';
  1865| 					}
  1866| 				}
  1867| 				if (! empty($conf->facture->enabled))
  1868| 				{
  1869| 					if (! empty($conf->fournisseur->enabled) && ($object->statut >= 2 && $object->statut != 7 && $object->billed != 1))  // statut 2 means approved, 7 means canceled
  1870| 					{
  1871| 						if ($user->rights->fournisseur->facture->creer)
  1872| 						{


# ====================================================================
# FILE: htdocs/fourn/commande/list.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 31-76 ---
    31| require_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.class.php';
    32| require_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.commande.class.php';
    33| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';
    34| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formorder.class.php';
    35| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formother.class.php';
    36| require_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';
    37| require_once DOL_DOCUMENT_ROOT.'/product/class/product.class.php';
    38| require_once DOL_DOCUMENT_ROOT.'/projet/class/project.class.php';
    39| $langs->load("orders");
    40| $langs->load("sendings");
    41| $langs->load('deliveries');
    42| $langs->load('companies');
    43| $langs->load('compta');
    44| $langs->load('bills');
    45| $langs->load('projects');
    46| $action=GETPOST('action','aZ09');
    47| $massaction=GETPOST('massaction','alpha');
    48| $show_files=GETPOST('show_files','int');
    49| $confirm=GETPOST('confirm','alpha');
    50| $toselect = GETPOST('toselect', 'array');
    51| $orderyear=GETPOST("orderyear","int");
    52| $ordermonth=GETPOST("ordermonth","int");
    53| $orderday=GETPOST("orderday","int");
    54| $deliveryyear=GETPOST("deliveryyear","int");
    55| $deliverymonth=GETPOST("deliverymonth","int");
    56| $deliveryday=GETPOST("deliveryday","int");
    57| $sall=GETPOST('search_all', 'alphanohtml');
    58| $search_product_category=GETPOST('search_product_category','int');
    59| $search_ref=GETPOST('search_ref');
    60| $search_refsupp=GETPOST('search_refsupp');
    61| $search_company=GETPOST('search_company','alpha');
    62| $search_town=GETPOST('search_town','alpha');
    63| $search_zip=GETPOST('search_zip','alpha');
    64| $search_state=trim(GETPOST("search_state"));
    65| $search_country=GETPOST("search_country",'int');
    66| $search_type_thirdparty=GETPOST("search_type_thirdparty",'int');
    67| $search_user=GETPOST('search_user','int');
    68| $search_request_author=GETPOST('search_request_author','alpha');
    69| $search_ht=GETPOST('search_ht');
    70| $search_ttc=GETPOST('search_ttc');
    71| $search_status=(GETPOST('search_status','alpha')!=''?GETPOST('search_status','alpha'):GETPOST('statut','alpha'));	// alpha and not intbecause it can be '6,7'
    72| $optioncss = GETPOST('optioncss','alpha');
    73| $socid = GETPOST('socid','int');
    74| $search_sale=GETPOST('search_sale','int');
    75| $search_total_ht=GETPOST('search_total_ht','alpha');
    76| $search_total_vat=GETPOST('search_total_vat','alpha');

# --- HUNK 2: Lines 133-200 ---
   133| if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label))
   134| {
   135| 	foreach($extrafields->attribute_label as $key => $val)
   136| 	{
   137| 		if (! empty($extrafields->attribute_list[$key])) $arrayfields["ef.".$key]=array('label'=>$extrafields->attribute_label[$key], 'checked'=>(($extrafields->attribute_list[$key]<0)?0:1), 'position'=>$extrafields->attribute_pos[$key], 'enabled'=>(abs($extrafields->attribute_list[$key])!=3 && $extrafields->attribute_perms[$key]));
   138| 	}
   139| }
   140| /*
   141|  * Actions
   142|  */
   143| if (GETPOST('cancel','alpha')) { $action='list'; $massaction=''; }
   144| if (! GETPOST('confirmmassaction','alpha') && $massaction != 'presend' && $massaction != 'confirm_presend') { $massaction=''; }
   145| $parameters=array('socid'=>$socid);
   146| $reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
   147| if ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');
   148| if (empty($reshook))
   149| {
   150| 	include DOL_DOCUMENT_ROOT.'/core/actions_changeselectedfields.inc.php';
   151| 	if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') || GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
   152| 	{
   153| 		$ordermonth='';
   154| 		$orderyear='';
   155| 		$orderday='';
   156| 		$search_categ='';
   157| 		$search_user='';
   158| 		$search_sale='';
   159| 		$search_product_category='';
   160| 		$search_ref='';
   161| 		$search_refsupp='';
   162| 		$search_company='';
   163| 		$search_town='';
   164| 		$search_zip="";
   165| 		$search_state="";
   166| 		$search_type='';
   167| 		$search_country='';
   168| 		$search_type_thirdparty='';
   169| 		$search_request_author='';
   170| 		$search_total_ht='';
   171| 		$search_total_vat='';
   172| 		$search_total_ttc='';
   173| 		$search_project_ref='';
   174| 		$search_status=-1;
   175| 		$orderyear='';
   176| 		$ordermonth='';
   177| 		$orderday='';
   178| 		$deliveryday='';
   179| 		$deliverymonth='';
   180| 		$deliveryyear='';
   181| 		$billed='';
   182| 		$search_billed='';
   183| 		$toselect='';
   184| 		$search_array_options=array();
   185| 	}
   186| 	if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') || GETPOST('button_removefilter','alpha')
   187| 		|| GETPOST('button_search_x','alpha') || GETPOST('button_search.x','alpha') || GETPOST('button_search','alpha'))
   188| 	{
   189| 		$massaction='';     // Protection to avoid mass action if we force a new search during a mass action confirmation
   190| 	}
   191| 	$objectclass='CommandeFournisseur';
   192| 	$objectlabel='SupplierOrders';
   193| 	$permtoread = $user->rights->fournisseur->commande->lire;
   194| 	$permtodelete = $user->rights->fournisseur->commande->supprimer;
   195| 	$uploaddir = $conf->fournisseur->commande->dir_output;
   196| 	include DOL_DOCUMENT_ROOT.'/core/actions_massactions.inc.php';
   197| 	if ($massaction == 'confirm_createbills')
   198| 	{
   199| 		$orders = GETPOST('toselect','array');
   200| 		$createbills_onebythird = GETPOST('createbills_onebythird', 'int');

# --- HUNK 3: Lines 425-498 ---
   425| if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label)) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."commande_fournisseur_extrafields as ef on (cf.rowid = ef.fk_object)";
   426| if ($sall || $search_product_category > 0) $sql.= ' LEFT JOIN '.MAIN_DB_PREFIX.'commande_fournisseurdet as pd ON cf.rowid=pd.fk_commande';
   427| if ($search_product_category > 0) $sql.= ' LEFT JOIN '.MAIN_DB_PREFIX.'categorie_product as cp ON cp.fk_product=pd.fk_product';
   428| $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."user as u ON cf.fk_user_author = u.rowid";
   429| $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."projet as p ON p.rowid = cf.fk_projet";
   430| if ($search_sale > 0 || (!$user->rights->societe->client->voir && ! $socid)) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
   431| if ($search_user > 0)
   432| {
   433| 	$sql.=", ".MAIN_DB_PREFIX."element_contact as ec";
   434| 	$sql.=", ".MAIN_DB_PREFIX."c_type_contact as tc";
   435| }
   436| $sql.= ' WHERE cf.fk_soc = s.rowid';
   437| $sql.= ' AND cf.entity IN ('.getEntity('supplier_order').')';
   438| if ($socid > 0) $sql.= " AND s.rowid = ".$socid;
   439| if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
   440| if ($search_ref) $sql .= natural_search('cf.ref', $search_ref);
   441| if ($search_refsupp) $sql.= natural_search("cf.ref_supplier", $search_refsupp);
   442| if ($sall) $sql .= natural_search(array_keys($fieldstosearchall), $sall);
   443| if ($search_company) $sql .= natural_search('s.nom', $search_company);
   444| if ($search_request_author) $sql.=natural_search(array('u.lastname','u.firstname','u.login'), $search_request_author) ;
   445| if ($search_billed != '' && $search_billed >= 0) $sql .= " AND cf.billed = ".$search_billed;
   446| if (GETPOST('statut', 'intcomma') !== '')
   447| {
   448| 	$sql .= " AND cf.fk_statut IN (".$db->escape($db->escape(GETPOST('statut', 'intcomma'))).")";
   449| }
   450| if ($search_status != '' && $search_status >= 0)
   451| {
   452| 	$sql.=" AND cf.fk_statut IN (".$db->escape($search_status).")";
   453| }
   454| if ($ordermonth > 0)
   455| {
   456| 	if ($orderyear > 0 && empty($orderday))
   457| 		$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_get_first_day($orderyear,$ordermonth,false))."' AND '".$db->idate(dol_get_last_day($orderyear,$ordermonth,false))."'";
   458| 	else if ($orderyear > 0 && ! empty($orderday))
   459| 		$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $ordermonth, $orderday, $orderyear))."' AND '".$db->idate(dol_mktime(23, 59, 59, $ordermonth, $orderday, $orderyear))."'";
   460| 	else
   461| 		$sql.= " AND date_format(cf.date_commande, '%m') = '".$ordermonth."'";
   462| }
   463| else if ($orderyear > 0)
   464| {
   465| 	$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_get_first_day($orderyear,1,false))."' AND '".$db->idate(dol_get_last_day($orderyear,12,false))."'";
   466| }
   467| if ($deliverymonth > 0)
   468| {
   469| 	if ($deliveryyear > 0 && empty($deliveryday))
   470| 		$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_get_first_day($deliveryyear,$deliverymonth,false))."' AND '".$db->idate(dol_get_last_day($deliveryyear,$deliverymonth,false))."'";
   471| 		else if ($deliveryyear > 0 && ! empty($deliveryday))
   472| 			$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $deliverymonth, $deliveryday, $deliveryyear))."' AND '".$db->idate(dol_mktime(23, 59, 59, $deliverymonth, $deliveryday, $deliveryyear))."'";
   473| 			else
   474| 				$sql.= " AND date_format(cf.date_livraison, '%m') = '".$deliverymonth."'";
   475| }
   476| else if ($deliveryyear > 0)
   477| {
   478| 	$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_get_first_day($deliveryyear,1,false))."' AND '".$db->idate(dol_get_last_day($deliveryyear,12,false))."'";
   479| }
   480| if ($search_town)  $sql.= natural_search('s.town', $search_town);
   481| if ($search_zip)   $sql.= natural_search("s.zip",$search_zip);
   482| if ($search_state) $sql.= natural_search("state.nom",$search_state);
   483| if ($search_country) $sql .= " AND s.fk_pays IN (".$db->escape($search_country).')';
   484| if ($search_type_thirdparty) $sql .= " AND s.fk_typent IN (".$db->escape($search_type_thirdparty).')';
   485| if ($search_company) $sql .= natural_search('s.nom', $search_company);
   486| if ($search_sale > 0) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$db->escape($search_sale);
   487| if ($search_user > 0) $sql.= " AND ec.fk_c_type_contact = tc.rowid AND tc.element='supplier_order' AND tc.source='internal' AND ec.element_id = cf.rowid AND ec.fk_socpeople = ".$db->escape($search_user);
   488| if ($search_total_ht != '') $sql.= natural_search('cf.total_ht', $search_total_ht, 1);
   489| if ($search_total_vat != '') $sql.= natural_search('cf.tva', $search_total_vat, 1);
   490| if ($search_total_ttc != '') $sql.= natural_search('cf.total_ttc', $search_total_ttc, 1);
   491| if ($search_project_ref != '') $sql.= natural_search("p.ref",$search_project_ref);
   492| include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_sql.tpl.php';
   493| $parameters=array();
   494| $reshook=$hookmanager->executeHooks('printFieldListWhere',$parameters);    // Note that $action and $object may have been modified by hook
   495| $sql.=$hookmanager->resPrint;
   496| $sql.= $db->order($sortfield,$sortorder);
   497| $nbtotalofrecords = '';
   498| if (empty($conf->global->MAIN_DISABLE_FULL_SCANLIST))

# --- HUNK 4: Lines 504-549 ---
   504| $resql = $db->query($sql);
   505| if ($resql)
   506| {
   507| 	if ($socid > 0)
   508| 	{
   509| 		$soc = new Societe($db);
   510| 		$soc->fetch($socid);
   511| 		$title = $langs->trans('ListOfSupplierOrders') . ' - '.$soc->name;
   512| 	}
   513| 	else
   514| 	{
   515| 		$title = $langs->trans('ListOfSupplierOrders');
   516| 	}
   517| 	$num = $db->num_rows($resql);
   518| 	$arrayofselected=is_array($toselect)?$toselect:array();
   519| 	$param='';
   520| 	if ($socid > 0)             $param.='&socid='.$socid;
   521| 	if (! empty($contextpage) && $contextpage != $_SERVER["PHP_SELF"]) $param.='&contextpage='.$contextpage;
   522| 	if ($limit > 0 && $limit != $conf->liste_limit) $param.='&limit='.$limit;
   523| 	if ($sall)					$param.="&search_all=".$sall;
   524| 	if ($orderday)      		$param.='&orderday='.$orderday;
   525| 	if ($ordermonth)      		$param.='&ordermonth='.$ordermonth;
   526| 	if ($orderyear)       		$param.='&orderyear='.$orderyear;
   527| 	if ($deliveryday)   		$param.='&deliveryday='.$deliveryday;
   528| 	if ($deliverymonth)   		$param.='&deliverymonth='.$deliverymonth;
   529| 	if ($deliveryyear)    		$param.='&deliveryyear='.$deliveryyear;
   530| 	if ($search_ref)      		$param.='&search_ref='.$search_ref;
   531| 	if ($search_company)  		$param.='&search_company='.$search_company;
   532| 	if ($search_user > 0) 		$param.='&search_user='.$search_user;
   533| 	if ($search_request_author) $param.='&search_request_author='.$search_request_author;
   534| 	if ($search_sale > 0) 		$param.='&search_sale='.$search_sale;
   535| 	if ($search_total_ht != '') $param.='&search_total_ht='.$search_total_ht;
   536| 	if ($search_total_ttc != '') $param.="&search_total_ttc=".$search_total_ttc;
   537| 	if ($search_refsupp) 		$param.="&search_refsupp=".$search_refsupp;
   538| 	if ($search_status >= 0)  	$param.="&search_status=".$search_status;
   539| 	if ($search_project_ref >= 0) $param.="&search_project_ref=".$search_project_ref;
   540| 	if ($search_billed != '')   $param.="&search_billed=".$search_billed;
   541| 	if ($show_files)            $param.='&show_files=' .$show_files;
   542| 	if ($optioncss != '')       $param.='&optioncss='.$optioncss;
   543| 	include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
   544| 	$arrayofmassactions =  array(
   545| 		'presend'=>$langs->trans("SendByMail"),
   546| 		'builddoc'=>$langs->trans("PDFMerge"),
   547| 	);
   548| 	if ($user->rights->fournisseur->commande->supprimer) $arrayofmassactions['predelete']=$langs->trans("Delete");
   549| 	if (in_array($massaction, array('presend','predelete','createbills'))) $arrayofmassactions=array();

# --- HUNK 5: Lines 674-724 ---
   674| 	{
   675| 		print '<td class="liste_titre">';
   676| 		print '<input class="flat" size="4" type="text" name="search_state" value="'.dol_escape_htmltag($search_state).'">';
   677| 		print '</td>';
   678| 	}
   679| 	if (! empty($arrayfields['country.code_iso']['checked']))
   680| 	{
   681| 		print '<td class="liste_titre" align="center">';
   682| 		print $form->select_country($search_country,'search_country','',0,'maxwidth100');
   683| 		print '</td>';
   684| 	}
   685| 	if (! empty($arrayfields['typent.code']['checked']))
   686| 	{
   687| 		print '<td class="liste_titre maxwidthonsmartphone" align="center">';
   688| 		print $form->selectarray("search_type_thirdparty", $formcompany->typent_array(0), $search_type_thirdparty, 0, 0, 0, '', 0, 0, 0, (empty($conf->global->SOCIETE_SORT_ON_TYPEENT)?'ASC':$conf->global->SOCIETE_SORT_ON_TYPEENT));
   689| 		print '</td>';
   690| 	}
   691| 	if (! empty($arrayfields['cf.date_commande']['checked']))
   692| 	{
   693| 		print '<td class="liste_titre" align="center">';
   694| 		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="orderday" value="'.$orderday.'">';
   695| 		print '<input class="flat" type="text" size="1" maxlength="2" name="ordermonth" value="'.$ordermonth.'">';
   696| 		$formother->select_year($orderyear?$orderyear:-1,'orderyear',1, 20, 5);
   697| 		print '</td>';
   698| 	}
   699| 	if (! empty($arrayfields['cf.date_delivery']['checked']))
   700| 	{
   701| 		print '<td class="liste_titre" align="center">';
   702| 		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="deliveryday" value="'.$deliveryday.'">';
   703| 		print '<input class="flat" type="text" size="1" maxlength="2" name="deliverymonth" value="'.$deliverymonth.'">';
   704| 		$formother->select_year($deliveryyear?$deliveryyear:-1,'deliveryyear',1, 20, 5);
   705| 		print '</td>';
   706| 	}
   707| 	if (! empty($arrayfields['cf.total_ht']['checked']))
   708| 	{
   709| 		print '<td class="liste_titre" align="right">';
   710| 		print '<input class="flat" type="text" size="5" name="search_total_ht" value="'.$search_total_ht.'">';
   711| 		print '</td>';
   712| 	}
   713| 	if (! empty($arrayfields['cf.total_vat']['checked']))
   714| 	{
   715| 		print '<td class="liste_titre" align="right">';
   716| 		print '<input class="flat" type="text" size="5" name="search_total_vat" value="'.$search_total_vat.'">';
   717| 		print '</td>';
   718| 	}
   719| 	if (! empty($arrayfields['cf.total_ttc']['checked']))
   720| 	{
   721| 		print '<td class="liste_titre" align="right">';
   722| 		print '<input class="flat" type="text" size="5" name="search_total_ttc" value="'.$search_total_ttc.'">';
   723| 		print '</td>';
   724| 	}


# ====================================================================
# FILE: htdocs/fourn/facture/card.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 798-853 ---
   798| 				$productsupplier->get_buyprice(0, -1, $idprod, 'none');        // We force qty to -1 to be sure to find if a supplier price exist
   799| 			}
   800| 			elseif (GETPOST('idprodfournprice') > 0)
   801| 			{
   802| 				$qtytosearch=$qty; 	   // Just to see if a price exists for the quantity. Not used to found vat.
   803| 				$idprod=$productsupplier->get_buyprice(GETPOST('idprodfournprice'), $qtytosearch);
   804| 				$res=$productsupplier->fetch($idprod);
   805| 			}
   806| 			if ($idprod > 0)
   807| 			{
   808| 				$label = $productsupplier->label;
   809| 				$desc = $productsupplier->description;
   810| 				if (trim($product_desc) != trim($desc)) $desc = dol_concatdesc($desc, $product_desc);
   811| 				$tva_tx=get_default_tva($object->thirdparty, $mysoc, $productsupplier->id, $_POST['idprodfournprice']);
   812| 				$tva_npr = get_default_npr($object->thirdparty, $mysoc, $productsupplier->id, $_POST['idprodfournprice']);
   813| 				if (empty($tva_tx)) $tva_npr=0;
   814| 				$localtax1_tx= get_localtax($tva_tx, 1, $mysoc, $object->thirdparty, $tva_npr);
   815| 				$localtax2_tx= get_localtax($tva_tx, 2, $mysoc, $object->thirdparty, $tva_npr);
   816| 				$type = $productsupplier->type;
   817| 				$price_base_type = 'HT';
   818| 				$result=$object->addline(
   819| 					$desc,
   820| 					$productsupplier->fourn_pu,
   821| 					$tva_tx,
   822| 					$localtax1_tx,
   823| 					$localtax2_tx,
   824| 					$qty,
   825| 					$idprod,
   826| 					$remise_percent,
   827| 					$date_start,
   828| 					$date_end,
   829| 					0,
   830| 					$tva_npr,
   831| 					$price_base_type,
   832| 					$type,
   833| 					-1,
   834| 					0,
   835| 					$array_options,
   836| 					$productsupplier->fk_unit,
   837| 					$productsupplier->fourn_ref
   838| 				);
   839| 			}
   840| 			if ($idprod == -99 || $idprod == 0)
   841| 			{
   842| 				$error++;
   843| 				$langs->load("errors");
   844| 				setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("ProductOrService")), null, 'errors');
   845| 			}
   846| 			if ($idprod == -1)
   847| 			{
   848| 				$error++;
   849| 				$langs->load("errors");
   850| 				setEventMessages($langs->trans("ErrorQtyTooLowForThisSupplier"), null, 'errors');
   851| 			}
   852| 		}
   853| 		else if (empty($error)) // $price_ht is already set


# ====================================================================
# FILE: htdocs/holiday/class/holiday.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 642-698 ---
   642| 			}
   643| 			elseif ($halfday == 2)
   644| 			{
   645| 				if ($dateStart >= $infos_CP['date_debut'] && $dateStart <= $infos_CP['date_fin'])
   646| 				{
   647| 					if ($dateStart < $infos_CP['date_fin'] || in_array($infos_CP['halfday'], array(0, -1))) return false;
   648| 				}
   649| 				if ($dateEnd <= $infos_CP['date_fin'] && $dateEnd >= $infos_CP['date_debut'])
   650| 				{
   651| 					if ($dateEnd > $infos_CP['date_debut'] || in_array($infos_CP['halfday'], array(0, 1))) return false;
   652| 				}
   653| 			}
   654| 			else
   655| 			{
   656| 				dol_print_error('', 'Bad value of parameter halfday when calling function verifDateHolidayCP');
   657| 			}
   658| 		}
   659| 		return true;
   660| 	}
   661| 	/**
   662| 	 *	Check a user is not on holiday for a particular timestamp
   663| 	 *
   664| 	 * 	@param 	int			$fk_user				Id user
   665| 	 *  @param	timestamp	$timestamp				Time stamp date for a day (YYYY-MM-DD) without hours  (= 12:00AM in english and not 12:00PM that is 12:00)
   666| 	 * 	@return array								array('morning'=> ,'afternoon'=> ), Boolean is true if user is available for day timestamp.
   667| 	 *  @see verifDateHolidayCP
   668| 	 */
   669| 	function verifDateHolidayForTimestamp($fk_user, $timestamp)
   670| 	{
   671| 		global $langs, $conf;
   672| 		$isavailablemorning=true;
   673| 		$isavailableafternoon=true;
   674| 		$sql = "SELECT cp.rowid, cp.date_debut as date_start, cp.date_fin as date_end, cp.halfday";
   675| 		$sql.= " FROM ".MAIN_DB_PREFIX."holiday as cp";
   676| 		$sql.= " WHERE cp.entity IN (".getEntity('holiday').")";
   677| 		$sql.= " AND cp.fk_user = ".(int) $fk_user;
   678| 		$sql.= " AND date_debut <= '".$this->db->idate($timestamp)."' AND date_fin >= '".$this->db->idate($timestamp)."'";
   679| 		$resql = $this->db->query($sql);
   680| 		if ($resql)
   681| 		{
   682| 			$num_rows = $this->db->num_rows($resql);	// Note, we can have 2 records if on is morning and the other one is afternoon
   683| 			if ($num_rows > 0)
   684| 			{
   685| 				$arrayofrecord=array();
   686| 				$i=0;
   687| 				while ($i < $num_rows)
   688| 				{
   689| 					$obj = $this->db->fetch_object($resql);
   690| 					$arrayofrecord[$obj->rowid]=array('date_start'=>$this->db->jdate($obj->date_start), 'date_end'=>$this->db->jdate($obj->date_end), 'halfday'=>$obj->halfday);
   691| 					$i++;
   692| 				}
   693| 				$isavailablemorning = true;
   694| 				foreach($arrayofrecord as $record)
   695| 				{
   696| 					if ($timestamp == $record['date_start'] && $record['halfday'] == 2)  continue;
   697| 					if ($timestamp == $record['date_start'] && $record['halfday'] == -1) continue;
   698| 					$isavailablemorning = false;


# ====================================================================
# FILE: htdocs/holiday/list.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 49-89 ---
    49| }
    50| $result = restrictedArea($user, 'holiday', $id, '');
    51| $id = GETPOST('id','int');
    52| $limit = GETPOST('limit','int')?GETPOST('limit','int'):$conf->liste_limit;
    53| $sortfield = GETPOST('sortfield','alpha');
    54| $sortorder = GETPOST('sortorder','alpha');
    55| $page = GETPOST('page','int');
    56| if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
    57| $offset = $limit * $page;
    58| $pageprev = $page - 1;
    59| $pagenext = $page + 1;
    60| $object=new Holiday($db);
    61| $extrafields = new ExtraFields($db);
    62| $diroutputmassaction=$conf->holiday->dir_output . '/temp/massgeneration/'.$user->id;
    63| $hookmanager->initHooks(array('holidaylist'));     // Note that conf->hooks_modules contains array
    64| $extralabels = $extrafields->fetch_name_optionals_label('holiday');
    65| $search_array_options=$extrafields->getOptionalsFromPost($extralabels,'','search_');
    66| if (! $sortfield) $sortfield="cp.rowid";
    67| if (! $sortorder) $sortorder="DESC";
    68| $sall                = trim((GETPOST('search_all', 'alphanohtml')!='')?GETPOST('search_all', 'alphanohtml'):GETPOST('sall', 'alphanohtml'));
    69| $search_ref          = GETPOST('search_ref','alpha');
    70| $search_day_create   = GETPOST('search_day_create','int');
    71| $search_month_create = GETPOST('search_month_create','int');
    72| $search_year_create  = GETPOST('search_year_create','int');
    73| $search_day_start    = GETPOST('search_day_start','int');
    74| $search_month_start  = GETPOST('search_month_start','int');
    75| $search_year_start   = GETPOST('search_year_start','int');
    76| $search_day_end      = GETPOST('search_day_end','int');
    77| $search_month_end    = GETPOST('search_month_end','int');
    78| $search_year_end     = GETPOST('search_year_end','int');
    79| $search_employee     = GETPOST('search_employee','int');
    80| $search_valideur     = GETPOST('search_valideur','int');
    81| $search_statut       = GETPOST('search_statut','int');
    82| $search_type         = GETPOST('search_type','int');
    83| $fieldstosearchall = array(
    84|     'cp.description'=>'Description',
    85|     'uu.lastname'=>'EmployeeLastname',
    86|     'uu.firstname'=>'EmployeeFirstname'
    87| );
    88| /*
    89|  * Actions

# --- HUNK 2: Lines 123-163 ---
   123| 	$permtodelete = $user->rights->holiday->delete;
   124| 	$uploaddir = $conf->holiday->dir_output;
   125| 	include DOL_DOCUMENT_ROOT.'/core/actions_massactions.inc.php';
   126| }
   127| /*
   128|  * View
   129|  */
   130| $form = new Form($db);
   131| $formother = new FormOther($db);
   132| $holiday = new Holiday($db);
   133| $holidaystatic=new Holiday($db);
   134| $fuser = new User($db);
   135| $result = $holiday->updateBalance();
   136| $max_year = 5;
   137| $min_year = 10;
   138| $filter='';
   139| llxHeader('', $langs->trans('CPTitreMenu'));
   140| $order = $db->order($sortfield,$sortorder).$db->plimit($limit + 1, $offset);
   141| if(!empty($search_ref))
   142| {
   143|     $filter.= " AND cp.rowid = ".$db->escape($search_ref);
   144| }
   145| if($search_year_start > 0) {
   146|     if($search_month_start > 0) {
   147|     	$filter .= " AND (cp.date_debut BETWEEN '".$db->idate(dol_get_first_day($search_year_start,$search_month_start,1))."' AND '".$db->idate(dol_get_last_day($search_year_start,$search_month_start,1))."')";
   148|     } else {
   149|     	$filter .= " AND (cp.date_debut BETWEEN '".$db->idate(dol_get_first_day($search_year_start,1,1))."' AND '".$db->idate(dol_get_last_day($search_year_start,12,1))."')";
   150|     }
   151| } else {
   152|     if($search_month_start > 0) {
   153|         $filter.= " AND date_format(cp.date_debut, '%m') = '".$db->escape($search_month_start)."'";
   154|     }
   155| }
   156| if($search_year_end > 0) {
   157|     if($search_month_end > 0) {
   158|     	$filter .= " AND (cp.date_fin BETWEEN '".$db->idate(dol_get_first_day($search_year_end,$search_month_end,1))."' AND '".$db->idate(dol_get_last_day($search_year_end,$search_month_end,1))."')";
   159|     } else {
   160|     	$filter .= " AND (cp.date_fin BETWEEN '".$db->idate(dol_get_first_day($search_year_end,1,1))."' AND '".$db->idate(dol_get_last_day($search_year_end,12,1))."')";
   161|     }
   162| } else {
   163|     if($search_month_end > 0) {


# ====================================================================
# FILE: htdocs/install/upgrade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 128-168 ---
   128|         {
   129|             print '<tr><td class="nowrap">';
   130|             print $langs->trans("DatabaseConnection")." : ".$dolibarr_main_db_name."</td><td align=\"right\">".$langs->trans("OK")."</td></tr>\n";
   131|             dolibarr_install_syslog("upgrade: Database connection successful: " . $dolibarr_main_db_name);
   132|             $ok=1;
   133|         }
   134|         else
   135|         {
   136|             print "<tr><td>".$langs->trans("ErrorFailedToConnectToDatabase",$dolibarr_main_db_name)."</td><td align=\"right\">".$langs->trans("Error")."</td></tr>\n";
   137|             dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ErrorFailedToConnectToDatabase", $dolibarr_main_db_name));
   138|             $ok=0;
   139|         }
   140|     }
   141|     if ($ok)
   142|     {
   143|         $version=$db->getVersion();
   144|         $versionarray=$db->getVersionArray();
   145|         print '<tr><td>'.$langs->trans("ServerVersion").'</td>';
   146|         print '<td align="right">'.$version.'</td></tr>';
   147|         dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ServerVersion") . ": " .$version);
   148|         if ($db->type == 'mysqli')
   149|         {
   150|         	$tmparray = $db->db->get_charset();
   151|         	print '<tr><td>'.$langs->trans("ClientCharset").'</td>';
   152|         	print '<td align="right">'.$tmparray->charset.'</td></tr>';
   153|         	dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ClientCharset") . ": " .$tmparray->charset);
   154|         	print '<tr><td>'.$langs->trans("ClientSortingCharset").'</td>';
   155|         	print '<td align="right">'.$tmparray->collation.'</td></tr>';
   156|         	dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ClientCollation") . ": " .$tmparray->collation);
   157|         }
   158|         $versionmindb=explode('.',$db::VERSIONMIN);
   159|         if (count($versionmindb) && count($versionarray)
   160|         	&& versioncompare($versionarray, $versionmindb) < 0)
   161|         {
   162|         	print "<tr><td>".$langs->trans("ErrorDatabaseVersionTooLow",join('.',$versionarray),join('.',$versionmindb))."</td><td align=\"right\">".$langs->trans("Error")."</td></tr>\n";
   163|         	dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ErrorDatabaseVersionTooLow", join('.', $versionarray), join('.', $versionmindb)));
   164|         	$ok=0;
   165|         }
   166|         if (empty($ignoredbversion))
   167|         {
   168| 			$dbversion_disallowed=array(

