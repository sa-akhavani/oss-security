--- a/build/makepack-dolibarr.pl
+++ b/build/makepack-dolibarr.pl
@@ -356,26 +356,24 @@
 		$ret=`rm -fr $BUILDROOT/$PROJECT/.scrutinizer.yml`;
 		$ret=`rm -fr $BUILDROOT/$PROJECT/.travis.yml`;
 		$ret=`rm -fr $BUILDROOT/$PROJECT/.tx`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build.xml`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/pom.xml`;
 		$ret=`rm -fr $BUILDROOT/$PROJECT/build/html`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/Doli*-*`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr_*.deb`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr_*.dsc`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr_*.tar.gz`;
-		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr_*.tar.xz`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.deb`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.rpm`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.tar`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.tar.gz`;
-		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.tar.xz`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.tgz`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.xz`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/dolibarr-*.zip`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/build/doxygen/doxygen_warnings.log`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/cache.manifest`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php.mysql`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php.old`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf.php.postgres`;
 		$ret=`rm -f  $BUILDROOT/$PROJECT/htdocs/conf/conf*sav*`;
@@ -668,22 +666,20 @@
 			print "Remove target ${FILENAMEDEB}_all.deb...\n";
 			unlink("$NEWDESTI/${FILENAMEDEB}_all.deb");
 			print "Remove target ${FILENAMEDEB}.dsc...\n";
 			unlink("$NEWDESTI/${FILENAMEDEB}.dsc");
 			print "Remove target ${FILENAMEDEB}.tar.gz...\n";
 			unlink("$NEWDESTI/${FILENAMEDEB}.tar.gz");
 			print "Remove target ${FILENAMEDEB}.changes...\n";
 			unlink("$NEWDESTI/${FILENAMEDEB}.changes");
 			print "Remove target ${FILENAMEDEB}.debian.tar.gz...\n";
 			unlink("$NEWDESTI/${FILENAMEDEB}.debian.tar.gz");
-			print "Remove target ${FILENAMEDEB}.debian.tar.xz...\n";
-			unlink("$NEWDESTI/${FILENAMEDEB}.debian.tar.xz");
 			print "Remove target ${FILENAMEDEBNATIVE}.orig.tar.gz...\n";
 			unlink("$NEWDESTI/${FILENAMEDEBNATIVE}.orig.tar.gz");
 			$ret=`rm -fr $BUILDROOT/$PROJECT.tmp`;
 			$ret=`rm -fr $BUILDROOT/$PROJECT-$MAJOR.$MINOR.$build`;
 			print "Copy $BUILDROOT/$PROJECT to $BUILDROOT/$PROJECT.tmp\n";
 			$cmd="cp -pr \"$BUILDROOT/$PROJECT\" \"$BUILDROOT/$PROJECT.tmp\"";
 			$ret=`$cmd`;
 			$cmd="cp -pr \"$BUILDROOT/$PROJECT/build/debian/apache/.htaccess\" \"$BUILDROOT/$PROJECT.tmp/build/debian/apache/.htaccess\"";
 			$ret=`$cmd`;
 			print "Remove other files\n";
@@ -811,21 +807,21 @@
 			print "Launch DEB build ($cmd)\n";
 			$ret=`$cmd 2>&1 3>&1`;
 			print $ret."\n";
 			chdir("$olddir");
 			print "You can check bin package with lintian --pedantic -E -I \"$NEWDESTI/${FILENAMEDEB}_all.deb\"\n";
 			print "You can check src package with lintian --pedantic -E -I \"$NEWDESTI/${FILENAMEDEB}.dsc\"\n";
 			print "Move *_all.deb *.dsc *.orig.tar.gz *.changes to $NEWDESTI\n";
 			$ret=`mv $BUILDROOT/*_all.deb "$NEWDESTI/"`;
 			$ret=`mv $BUILDROOT/*.dsc "$NEWDESTI/"`;
 			$ret=`mv $BUILDROOT/*.orig.tar.gz "$NEWDESTI/"`;
-			$ret=`mv $BUILDROOT/*.debian.tar.xz "$NEWDESTI/"`;
+			$ret=`mv $BUILDROOT/*.debian.tar.gz "$NEWDESTI/"`;
 			$ret=`mv $BUILDROOT/*.changes "$NEWDESTI/"`;
 			next;
 		}
 		if ($target eq 'APS') 
 		{
 			$NEWDESTI=$DESTI;
 			if ($NEWDESTI =~ /stable/)
 			{
 				mkdir($DESTI.'/package_aps');
 				if (-d $DESTI.'/package_aps') { $NEWDESTI=$DESTI.'/package_aps'; }
@@ -925,34 +921,35 @@
 	{
 		if ($CHOOSEDPUBLISH{$target} < 0) { next; }
 		print "\nList of files to publish (BUILD=$BUILD)\n";
 		%filestoscansf=(
 			"$DESTI/signatures/filelist-$MAJOR.$MINOR.$BUILD.xml"=>'none',				# none means it won't be published on SF
 			"$DESTI/package_rpm_generic/$FILENAMERPM"=>'Dolibarr installer for Fedora-Redhat-Mandriva-Opensuse (DoliRpm)',
 			"$DESTI/package_rpm_generic/$FILENAMERPMSRC"=>'none',						# none means it won't be published on SF
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_all.deb"=>'Dolibarr installer for Debian-Ubuntu (DoliDeb)',
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_amd64.changes"=>'none',		# none means it won't be published on SF
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.dsc"=>'none',					# none means it won't be published on SF
-			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.debian.tar.xz"=>'none',		# none means it won't be published on SF
+			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.debian.tar.gz"=>'none',		# none means it won't be published on SF
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEBSHORT}.orig.tar.gz"=>'none',		# none means it won't be published on SF
 			"$DESTI/package_windows/$FILENAMEEXEDOLIWAMP.exe"=>'Dolibarr installer for Windows (DoliWamp)',
 			"$DESTI/standard/$FILENAMETGZ.tgz"=>'Dolibarr ERP-CRM',
 			"$DESTI/standard/$FILENAMETGZ.zip"=>'Dolibarr ERP-CRM'
 		);
 		%filestoscanstableasso=(
 			"$DESTI/signatures/filelist-$MAJOR.$MINOR.$BUILD.xml"=>'signatures',
 			"$DESTI/package_rpm_generic/$FILENAMERPM"=>'package_rpm_generic',
 			"$DESTI/package_rpm_generic/$FILENAMERPMSRC"=>'package_rpm_generic',
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_all.deb"=>'package_debian-ubuntu',
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}_amd64.changes"=>'package_debian-ubuntu',
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.dsc"=>'package_debian-ubuntu',
-			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.debian.tar.xz"=>'package_debian-ubuntu',
+			"$DESTI/package_debian-ubuntu/${FILENAMEDEB}.debian.tar.gz"=>'package_debian-ubuntu',
+			"$DESTI/package_debian-ubuntu/${FILENAMEDEBSHORT}.orig.tar.gz"=>'package_debian-ubuntu',
 			"$DESTI/package_debian-ubuntu/${FILENAMEDEBSHORT}.orig.tar.gz"=>'package_debian-ubuntu',
 			"$DESTI/package_windows/$FILENAMEEXEDOLIWAMP.exe"=>'package_windows',
 			"$DESTI/standard/$FILENAMETGZ.tgz"=>'standard',
 			"$DESTI/standard/$FILENAMETGZ.zip"=>'standard'
 		);
 		if ($target eq 'ASSO' && $BUILD =~ /[a-z]/i)   { 	# Not stable
 			%filestoscansf=(
 				"$DESTI/$FILENAMERPM"=>'Dolibarr installer for Fedora-Redhat-Mandriva-Opensuse (DoliRpm)',
 				"$DESTI/${FILENAMEDEB}_all.deb"=>'Dolibarr installer for Debian-Ubuntu (DoliDeb)',
 				"$DESTI/$FILENAMEEXEDOLIWAMP.exe"=>'Dolibarr installer for Windows (DoliWamp)',

--- a/htdocs/accountancy/admin/account.php
+++ b/htdocs/accountancy/admin/account.php
@@ -133,23 +133,23 @@
 $form=new Form($db);
 llxHeader('', $langs->trans("ListAccounts"));
 if ($action == 'delete') {
 	$formconfirm = $html->formconfirm($_SERVER["PHP_SELF"] . '?id=' . $id, $langs->trans('DeleteAccount'), $langs->trans('ConfirmDeleteAccount'), 'confirm_delete', '', 0, 1);
 	print $formconfirm;
 }
 $pcgver = $conf->global->CHARTOFACCOUNTS;
 $sql = "SELECT aa.rowid, aa.fk_pcg_version, aa.pcg_type, aa.pcg_subtype, aa.account_number, aa.account_parent , aa.label, aa.active, ";
 $sql .= " a2.rowid as rowid2, a2.label as label2, a2.account_number as account_number2";
 $sql .= " FROM " . MAIN_DB_PREFIX . "accounting_account as aa";
-$sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_system as asy ON aa.fk_pcg_version = asy.pcg_version AND aa.entity = " . $conf->entity;
-if ($db->type == 'pgsql') $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_account as a2 ON a2.rowid = CAST(aa.account_parent AS INTEGER) AND a2.entity = " . $conf->entity;
-else $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_account as a2 ON a2.rowid = CAST(aa.account_parent AS UNSIGNED) AND a2.entity = " . $conf->entity;
+$sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_system as asy ON aa.fk_pcg_version = asy.pcg_version";
+if ($db->type == 'pgsql') $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_account as a2 ON a2.rowid = CAST(aa.account_parent AS INTEGER)";
+else $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_account as a2 ON a2.rowid = CAST(aa.account_parent AS UNSIGNED)";
 $sql .= " WHERE asy.rowid = " . $pcgver;
 if (strlen(trim($search_account)))			$sql .= natural_search("aa.account_number", $search_account);
 if (strlen(trim($search_label)))			$sql .= natural_search("aa.label", $search_label);
 if (strlen(trim($search_accountparent)))	$sql .= natural_search("aa.account_parent", $search_accountparent);
 if (strlen(trim($search_pcgtype)))			$sql .= natural_search("aa.pcg_type", $search_pcgtype);
 if (strlen(trim($search_pcgsubtype)))		$sql .= natural_search("aa.pcg_subtype", $search_pcgsubtype);
 $sql .= $db->order($sortfield, $sortorder);
 $nbtotalofrecords = '';
 if (empty($conf->global->MAIN_DISABLE_FULL_SCANLIST))
 {

--- a/htdocs/accountancy/admin/accountmodel.php
+++ b/htdocs/accountancy/admin/accountmodel.php
@@ -34,63 +34,74 @@
 require_once DOL_DOCUMENT_ROOT.'/core/class/html.formadmin.class.php';
 require_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
 require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/accounting.lib.php';
 if (! empty($conf->accounting->enabled)) require_once DOL_DOCUMENT_ROOT . '/core/class/html.formaccounting.class.php';
 $langs->loadLangs(array("errors","admin","companies","resource","holiday","compta","accountancy","hrm"));
 $action=GETPOST('action','alpha')?GETPOST('action','alpha'):'view';
 $confirm=GETPOST('confirm','alpha');
-$id=31;
+$id=GETPOST('id','int');
 $rowid=GETPOST('rowid','alpha');
 $code=GETPOST('code','alpha');
 $acts[0] = "activate";
 $acts[1] = "disable";
 $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
 $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
 $listoffset=GETPOST('listoffset');
 $listlimit=GETPOST('listlimit')>0?GETPOST('listlimit'):1000;
 $active = 1;
-$sortfield = GETPOST("sortfield",'aZ09comma');
-$sortorder = GETPOST("sortorder",'aZ09comma');
+$sortfield = GETPOST("sortfield",'alpha');
+$sortorder = GETPOST("sortorder",'alpha');
 $page = GETPOST("page",'int');
 if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
 $offset = $listlimit * $page ;
 $pageprev = $page - 1;
 $pagenext = $page + 1;
 $search_country_id = GETPOST('search_country_id','int');
 if ($user->societe_id > 0) accessforbidden();
 if (! $user->rights->accounting->chartofaccount) accessforbidden();
 $hookmanager->initHooks(array('admin'));
 $tabname=array();
 $tabname[31]= MAIN_DB_PREFIX."accounting_system";
+$tabname[32]= MAIN_DB_PREFIX."c_accounting_category";
 $tablib=array();
 $tablib[31]= "Pcg_version";
+$tablib[32]= "DictionaryAccountancyCategory";
 $tabsql=array();
 $tabsql[31]= "SELECT s.rowid as rowid, pcg_version, s.label, s.fk_country as country_id, c.code as country_code, c.label as country, s.active FROM ".MAIN_DB_PREFIX."accounting_system as s, ".MAIN_DB_PREFIX."c_country as c WHERE s.fk_country=c.rowid and c.active=1";
+$tabsql[32]= "SELECT a.rowid as rowid, a.code as code, a.label, a.range_account, a.sens, a.category_type, a.formula, a.position as position, a.fk_country as country_id, c.code as country_code, c.label as country, a.active FROM ".MAIN_DB_PREFIX."c_accounting_category as a, ".MAIN_DB_PREFIX."c_country as c WHERE a.fk_country=c.rowid and c.active=1";
 $tabsqlsort=array();
 $tabsqlsort[31]="pcg_version ASC";
+$tabsqlsort[32]="position ASC";
 $tabfield=array();
 $tabfield[31]= "pcg_version,label,country_id,country";
+$tabfield[32]= "code,label,range_account,sens,category_type,formula,position,country_id,country";
 $tabfieldvalue=array();
 $tabfieldvalue[31]= "pcg_version,label,country";
+$tabfieldvalue[32]= "code,label,range_account,sens,category_type,formula,position,country";
 $tabfieldinsert=array();
 $tabfieldinsert[31]= "pcg_version,label,fk_country";
+$tabfieldinsert[32]= "code,label,range_account,sens,category_type,formula,position,fk_country";
 $tabrowid=array();
 $tabrowid[31]= "";
+$tabrowid[32]= "";
 $tabcond=array();
 $tabcond[31]= ! empty($conf->accounting->enabled);
+$tabcond[32]= ! empty($conf->accounting->enabled);
 $tabhelp=array();
 $tabhelp[31] = array('pcg_version'=>$langs->trans("EnterAnyCode"));
+$tabhelp[32] = array('code'=>$langs->trans("EnterAnyCode"));
 $tabfieldcheck=array();
 $tabfieldcheck[31] = array();
+$tabfieldcheck[32] = array();
 $elementList = array();
 $sourceList=array();
 /*
  * Actions
  */
 if (GETPOST('button_removefilter') || GETPOST('button_removefilter.x') || GETPOST('button_removefilter_x'))
 {
 	$search_country_id = '';
 }
 if (GETPOST('actionadd') || GETPOST('actionmodify'))
@@ -358,36 +369,50 @@
 $linkback='';
 print load_fiche_titre($titre,$linkback,'title_accountancy');
 if (empty($id))
 {
 	print $langs->trans("DictionaryDesc");
 	print " ".$langs->trans("OnlyActiveElementsAreShown")."<br>\n";
 }
 print "<br>\n";
 if ($action == 'delete')
 {
-	print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.urlencode($page).'&':'').'sortfield='.urlencode($sortfield).'&sortorder='.urlencode($sortorder).'&rowid='.urlencode($rowid).'&code='.urlencode($code).'&id='.urlencode($id), $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
+	print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid.'&code='.$code.'&id='.$id, $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
 }
 /*
  * Show a dictionary
  */
 if ($id)
 {
 	$sql=$tabsql[$id];
 	if ($search_country_id > 0)
 	{
 		if (preg_match('/ WHERE /',$sql)) $sql.= " AND ";
 		else $sql.=" WHERE ";
 		$sql.= " c.rowid = ".$search_country_id;
 	}
-	if ($sortfield == 'country') $sortfield='country_code';
-	$sql.=$db->order($sortfield,$sortorder);
+	if ($sortfield)
+	{
+		if ($sortfield == 'country') $sortfield='country_code';
+		$sql.= " ORDER BY ".$sortfield;
+		if ($sortorder)
+		{
+			$sql.=" ".strtoupper($sortorder);
+		}
+		$sql.=", ";
+		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
+		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
+	}
+	else {
+		$sql.=" ORDER BY ";
+	}
+	$sql.=$tabsqlsort[$id];
 	$sql.=$db->plimit($listlimit+1,$offset);
 	$fieldlist=explode(',',$tabfield[$id]);
 	print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<div class="div-table-responsive">';
 	print '<table class="noborder" width="100%">';
 	if ($tabname[$id])
 	{
 		$alabelisused=0;
 		$var=false;

--- a/htdocs/accountancy/admin/categories.php
+++ b/htdocs/accountancy/admin/categories.php
@@ -64,21 +64,21 @@
 			setEventMessages($langs->trans('errors'), null, 'errors');
 		}
 	}
 }
 /*
  * View
  */
 $form = new Form($db);
 $formaccounting = new FormAccounting($db);
 llxheader('', $langs->trans('AccountingCategory'));
-$linkback = '<a href="'.DOL_URL_ROOT.'/accountancy/admin/categories_list.php?restore_lastsearch_values=1">'.$langs->trans("BackToList").'</a>';
+$linkback = '<a href="'.DOL_URL_ROOT.'/accountancy/admin/categories_list.php?search_country_id='.$mysoc->country_id.'">'.$langs->trans("BackToList").'</a>';
 print load_fiche_titre($langs->trans('AccountingCategory'), $linkback);
 print '<form name="add" action="' . $_SERVER["PHP_SELF"] . '" method="POST">' . "\n";
 print '<input type="hidden" name="token" value="' . $_SESSION['newtoken'] . '">';
 print '<input type="hidden" name="action" value="display">';
 dol_fiche_head();
 print '<table class="border" width="100%">';
 print '<tr><td class="titlefield">' . $langs->trans("AccountingCategory") . '</td>';
 print '<td>';
 $formaccounting->select_accounting_category($cat_id, 'account_category', 1, 0, 0, 1);
 print '<input class="button" type="submit" value="' . $langs->trans("Select") . '">';

--- a/htdocs/accountancy/admin/categories_list.php
+++ b/htdocs/accountancy/admin/categories_list.php
@@ -38,22 +38,22 @@
 {
 	accessforbidden();
 }
 $acts[0] = "activate";
 $acts[1] = "disable";
 $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
 $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
 $listoffset=GETPOST('listoffset');
 $listlimit=GETPOST('listlimit')>0?GETPOST('listlimit'):1000;
 $active = 1;
-$sortfield = GETPOST("sortfield",'aZ09comma');
-$sortorder = GETPOST("sortorder",'aZ09comma');
+$sortfield = GETPOST("sortfield",'alpha');
+$sortorder = GETPOST("sortorder",'alpha');
 $page = GETPOST("page",'int');
 if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
 $offset = $listlimit * $page ;
 $pageprev = $page - 1;
 $pagenext = $page + 1;
 $search_country_id = GETPOST('search_country_id','int');
 $hookmanager->initHooks(array('admin'));
 $taborder=array(32);
 $tabname=array();
 $tabname[32]= MAIN_DB_PREFIX."c_accounting_category";
@@ -213,92 +213,92 @@
         }
     }
 }
 if (GETPOST('actioncancel'))
 {
 }
 if ($action == 'confirm_delete' && $confirm == 'yes')       // delete
 {
     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
     else { $rowidcol="rowid"; }
-    $sql = "DELETE from ".$tabname[$id]." WHERE ".$rowidcol." = '".$db->escape($rowid)."'";
+    $sql = "DELETE from ".$tabname[$id]." WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
     dol_syslog("delete", LOG_DEBUG);
     $result = $db->query($sql);
     if (! $result)
     {
         if ($db->errno() == 'DB_ERROR_CHILD_EXISTS')
         {
             setEventMessages($langs->transnoentities("ErrorRecordIsUsedByChild"), null, 'errors');
         }
         else
         {
             dol_print_error($db);
         }
     }
 }
 if ($action == $acts[0])
 {
     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
     else { $rowidcol="rowid"; }
     if ($rowid) {
-        $sql = "UPDATE ".$tabname[$id]." SET active = 1 WHERE ".$rowidcol." = '".$db->escape($rowid)."'";
+        $sql = "UPDATE ".$tabname[$id]." SET active = 1 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
     }
     elseif ($code) {
-    	$sql = "UPDATE ".$tabname[$id]." SET active = 1 WHERE code = '".$db->escape($code)."'";
+    	$sql = "UPDATE ".$tabname[$id]." SET active = 1 WHERE code = '".$this->db->escape($code)."'";
     }
     $result = $db->query($sql);
     if (!$result)
     {
         dol_print_error($db);
     }
 }
 if ($action == $acts[1])
 {
     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
     else { $rowidcol="rowid"; }
     if ($rowid) {
-    	$sql = "UPDATE ".$tabname[$id]." SET active = 0 WHERE ".$rowidcol." = '".$db->escape($rowid)."'";
+    	$sql = "UPDATE ".$tabname[$id]." SET active = 0 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
     }
     elseif ($code) {
-    	$sql = "UPDATE ".$tabname[$id]." SET active = 0 WHERE code = '".$db->escape($code)."'";
+    	$sql = "UPDATE ".$tabname[$id]." SET active = 0 WHERE code = '".$this->db->escape($code)."'";
     }
     $result = $db->query($sql);
     if (!$result)
     {
         dol_print_error($db);
     }
 }
 if ($action == 'activate_favorite')
 {
     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
     else { $rowidcol="rowid"; }
     if ($rowid) {
-    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 1 WHERE ".$rowidcol." = '".$db->escape($rowid)."'";
+    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 1 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
     }
     elseif ($code) {
-    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 1 WHERE code = '".$db->escape($code)."'";
+    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 1 WHERE code = '".$this->db->escape($code)."'";
     }
     $result = $db->query($sql);
     if (!$result)
     {
         dol_print_error($db);
     }
 }
 if ($action == 'disable_favorite')
 {
     if ($tabrowid[$id]) { $rowidcol=$tabrowid[$id]; }
     else { $rowidcol="rowid"; }
     if ($rowid) {
-    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 0 WHERE ".$rowidcol." = '".$db->escape($rowid)."'";
+    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 0 WHERE ".$rowidcol." = '".$this->db->escape($rowid)."'";
     }
     elseif ($code) {
-    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 0 WHERE code = '".$db->escape($code)."'";
+    	$sql = "UPDATE ".$tabname[$id]." SET favorite = 0 WHERE code = '".$this->db->escape($code)."'";
     }
     $result = $db->query($sql);
     if (!$result)
     {
         dol_print_error($db);
     }
 }
 /*
  * View
  */
@@ -319,22 +319,36 @@
  */
 if ($id)
 {
     $sql=$tabsql[$id];
     if ($search_country_id > 0)
     {
         if (preg_match('/ WHERE /',$sql)) $sql.= " AND ";
         else $sql.=" WHERE ";
         $sql.= " (a.fk_country = ".$search_country_id." OR a.fk_country = 0)";
     }
-    if ($sortfield == 'country') $sortfield='country_code';
-    $sql.=$db->order($sortfield,$sortorder);
+    if ($sortfield)
+    {
+    	if ($sortfield == 'country') $sortfield='country_code';
+        $sql.= " ORDER BY ".$sortfield;
+        if ($sortorder)
+        {
+            $sql.=" ".strtoupper($sortorder);
+        }
+        $sql.=", ";
+        $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
+        $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
+    }
+    else {
+        $sql.=" ORDER BY ";
+    }
+    $sql.=$tabsqlsort[$id];
     $sql.=$db->plimit($listlimit+1,$offset);
     $fieldlist=explode(',',$tabfield[$id]);
     print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
     print '<input type="hidden" name="from" value="'.dol_escape_htmltag(GETPOST('from','alpha')).'">';
 	print '<div class="div-table-responsive">';
     print '<table class="noborder" width="100%">';
     if ($tabname[$id])
     {
         $alabelisused=0;
@@ -599,21 +613,21 @@
                     if ($iserasable)
                     {
                         print '<td align="center">';
                         if ($user->admin) print '<a href="'.$url.'action=delete">'.img_delete().'</a>';
                         print '</td>';
                     }
                     else print '<td>&nbsp;</td>';
                     print '<td class="center">';
                     if (empty($obj->formula))
                     {
-                        print '<a href="'.DOL_URL_ROOT.'/accountancy/admin/categories.php?action=display&save_lastsearch_values=1&account_category='.$obj->rowid.'">';
+                        print '<a href="'.DOL_URL_ROOT.'/accountancy/admin/categories.php?action=display&account_category='.$obj->rowid.'">';
                         print $langs->trans("ListOfAccounts");
                         print '</a>';
                     }
                     print '</td>';
                 }
                 print "</tr>\n";
                 $i++;
             }
         }
     }

--- a/htdocs/accountancy/admin/index.php
+++ b/htdocs/accountancy/admin/index.php
@@ -41,35 +41,46 @@
 $list = array (
     'ACCOUNTING_LENGTH_GACCOUNT',
     'ACCOUNTING_LENGTH_AACCOUNT' ,
 );
 /*
  * Actions
  */
 $accounting_mode = empty($conf->global->ACCOUNTING_MODE) ? 'RECETTES-DEPENSES' : $conf->global->ACCOUNTING_MODE;
 if ($action == 'update') {
 	$error = 0;
-	if (! $error)
-	{
-	    foreach ($list as $constname)
-	    {
-	        $constvalue = GETPOST($constname, 'alpha');
-	        if (! dolibarr_set_const($db, $constname, $constvalue, 'chaine', 0, '', $conf->entity)) {
-	            $error++;
-	        }
-	    }
-	    if ($error) {
-	    	setEventMessages($langs->trans("Error"), null, 'errors');
-	    }
+	$accounting_modes = array (
+			'RECETTES-DEPENSES',
+			'CREANCES-DETTES'
+	);
+	$accounting_mode = GETPOST('accounting_mode', 'alpha');
+	if (in_array($accounting_mode, $accounting_modes)) {
+		if (! dolibarr_set_const($db, 'ACCOUNTING_MODE', $accounting_mode, 'chaine', 0, '', $conf->entity)) {
+			$error ++;
+		}
+	} else {
+		$error ++;
 	}
+	if ($error) {
+		setEventMessages($langs->trans("Error"), null, 'errors');
+	}
+    foreach ($list as $constname)
+    {
+        $constvalue = GETPOST($constname, 'alpha');
+        if (! dolibarr_set_const($db, $constname, $constvalue, 'chaine', 0, '', $conf->entity)) {
+            $error ++;
+        }
+    }
     if (! $error) {
         setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
+    } else {
+        setEventMessages($langs->trans("Error"), null, 'errors');
     }
 }
 if ($action == 'setlistsorttodo') {
     $setlistsorttodo = GETPOST('value', 'int');
     $res = dolibarr_set_const($db, "ACCOUNTING_LIST_SORT_VENTILATION_TODO", $setlistsorttodo, 'yesno', 0, '', $conf->entity);
     if (! $res > 0)
         $error ++;
         if (! $error) {
             setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
         } else {

--- a/htdocs/accountancy/admin/journals_list.php
+++ b/htdocs/accountancy/admin/journals_list.php
@@ -26,21 +26,21 @@
 require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
 require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/accounting.lib.php';
 require_once DOL_DOCUMENT_ROOT.'/accountancy/class/accountingjournal.class.php';
 $langs->load("admin");
 $langs->load("compta");
 $langs->load("accountancy");
 $action=GETPOST('action','alpha')?GETPOST('action','alpha'):'view';
 $confirm=GETPOST('confirm','alpha');
-$id=35;
+$id=GETPOST('id','int');
 $rowid=GETPOST('rowid','alpha');
 $code=GETPOST('code','alpha');
 if (empty($user->rights->accounting->chartofaccount))
 {
 	accessforbidden();
 }
 $acts[0] = "activate";
 $acts[1] = "disable";
 $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
 $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
@@ -57,29 +57,29 @@
 if (empty($sortfield)) $sortfield='code';
 if (empty($sortorder)) $sortorder='ASC';
 $error = 0;
 $hookmanager->initHooks(array('admin'));
 $taborder=array(35);
 $tabname=array();
 $tabname[35]= MAIN_DB_PREFIX."accounting_journal";
 $tablib=array();
 $tablib[35]= "DictionaryAccountancyJournal";
 $tabsql=array();
-$tabsql[35]= "SELECT a.rowid as rowid, a.code as code, a.label, a.nature, a.active FROM ".MAIN_DB_PREFIX."accounting_journal as a WHERE a.entity=".$conf->entity;
+$tabsql[35]= "SELECT a.rowid as rowid, a.code as code, a.label, a.nature, a.active FROM ".MAIN_DB_PREFIX."accounting_journal as a";
 $tabsqlsort=array();
 $tabsqlsort[35]="code ASC";
 $tabfield=array();
 $tabfield[35]= "code,label,nature";
 $tabfieldvalue=array();
 $tabfieldvalue[35]= "code,label,nature";
 $tabfieldinsert=array();
-$tabfieldinsert[35]= "code,label,nature,entity";
+$tabfieldinsert[35]= "code,label,nature";
 $tabrowid=array();
 $tabrowid[35]= "";
 $tabcond=array();
 $tabcond[35]= ! empty($conf->accounting->enabled);
 $tabhelp=array();
 $tabhelp[35] = array('code'=>$langs->trans("EnterAnyCode"));
 $tabfieldcheck=array();
 $tabfieldcheck[35] = array();
 complete_dictionary_with_modules($taborder,$tabname,$tablib,$tabsql,$tabsqlsort,$tabfield,$tabfieldvalue,$tabfieldinsert,$tabrowid,$tabcond,$tabhelp,$tabfieldcheck);
 $elementList = array();
@@ -294,22 +294,36 @@
 {
 	print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid.'&code='.$code.'&id='.$id, $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
 }
 /*
  * Show a dictionary
  */
 if ($id)
 {
 	$sql=$tabsql[$id];
 	$sql.= " WHERE a.entity = ".$conf->entity;
-	if ($sortfield == 'country') $sortfield='country_code';
-	$sql.=$db->order($sortfield,$sortorder);
+	if ($sortfield)
+	{
+		if ($sortfield == 'country') $sortfield='country_code';
+		$sql.= " ORDER BY ".$sortfield;
+		if ($sortorder)
+		{
+			$sql.=" ".strtoupper($sortorder);
+		}
+		$sql.=", ";
+		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
+		$tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
+	}
+	else {
+		$sql.=" ORDER BY ";
+	}
+	$sql.=$tabsqlsort[$id];
 	$sql.=$db->plimit($listlimit+1,$offset);
 	$fieldlist=explode(',',$tabfield[$id]);
 	print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="from" value="'.dol_escape_htmltag(GETPOST('from','alpha')).'">';
 	print '<div class="div-table-responsive">';
 	print '<table class="noborder" width="100%">';
 	if ($tabname[$id])
 	{
 		$alabelisused=0;

--- a/htdocs/accountancy/bookkeeping/card.php
+++ b/htdocs/accountancy/bookkeeping/card.php
@@ -25,37 +25,37 @@
 require '../../main.inc.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
 require_once DOL_DOCUMENT_ROOT . '/accountancy/class/bookkeeping.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/class/html.formaccounting.class.php';
 require_once DOL_DOCUMENT_ROOT . '/compta/facture/class/facture.class.php';
 require_once DOL_DOCUMENT_ROOT . '/fourn/class/fournisseur.facture.class.php';
 require_once DOL_DOCUMENT_ROOT . '/accountancy/class/accountingjournal.class.php';
 $langs->load("accountancy");
 $langs->load("bills");
 $langs->load("compta");
-$action = GETPOST('action','aZ09');
-$id = GETPOST('id', 'int');					// id of record
-$mode = GETPOST('mode','aZ09');		 		// '' or 'tmp'
-$piece_num = GETPOST("piece_num",'int');	// id of transaction (several lines share the same transaction id)
+$id = GETPOST('id', 'int');
 if ($user->societe_id > 0) {
 	accessforbidden();
 }
+$action = GETPOST('action','aZ09');
+$mode = GETPOST('mode','aZ09');		 // '' or 'tmp'
+$piece_num = GETPOST("piece_num");
 $mesg = '';
-$account_number = GETPOST('account_number','alphanohtml');
-$subledger_account = GETPOST('subledger_account','alphanohtml');
+$account_number = GETPOST('account_number');
+$subledger_account = GETPOST('subledger_account');
 if ($subledger_account == - 1) {
 	$subledger_account = null;
 }
-$label_compte = GETPOST('label_compte','alphanohtml');
-$label_operation= GETPOST('label_operation','alphanohtml');
-$debit = price2num(GETPOST('debit','alpha'));
-$credit = price2num(GETPOST('credit','alpha'));
+$label_compte = GETPOST('label_compte');
+$label_operation= GETPOST('label_operation');
+$debit = price2num(GETPOST('debit'));
+$credit = price2num(GETPOST('credit'));
 $save = GETPOST('save','alpha');
 if (! empty($save)) $action = 'add';
 $update = GETPOST('update','alpha');
 if (! empty($update)) $action = 'confirm_update';
 $object = new BookKeeping($db);
 /*
  * Actions
  */
 if ($action == "confirm_update") {
 	$error = 0;
@@ -279,26 +279,26 @@
 	if (empty($next_num_mvt))
 	{
 		dol_print_error('', 'Failed to get next piece number');
 	}
 	print '<form action="' . $_SERVER["PHP_SELF"] . '" name="create_mvt" method="POST">';
 	print '<input type="hidden" name="action" value="confirm_create">' . "\n";
 	print '<input type="hidden" name="next_num_mvt" value="' . $next_num_mvt . '">' . "\n";
 	print '<input type="hidden" name="mode" value="_tmp">' . "\n";
 	dol_fiche_head();
 	print '<table class="border" width="100%">';
-	/*print '<tr>';
+	print '<tr>';
 	print '<td class="titlefieldcreate fieldrequired">' . $langs->trans("NumPiece") . '</td>';
 	print '<td>' . $next_num_mvt . '</td>';
-	print '</tr>';*/
+	print '</tr>';
 	print '<tr>';
-	print '<td class="titlefieldcreate fieldrequired">' . $langs->trans("Docdate") . '</td>';
+	print '<td class="fieldrequired">' . $langs->trans("Docdate") . '</td>';
 	print '<td>';
 	print $html->select_date('', 'doc_date', '', '', '', "create_mvt", 1, 1);
 	print '</td>';
 	print '</tr>';
 	print '<tr>';
 	print '<td class="fieldrequired">' . $langs->trans("Codejournal") . '</td>';
 	print '<td>' . $formaccounting->select_journal(GETPOST('code_journal'),'code_journal',0,1,array(),1,1) . '</td>';
 	print '</tr>';
 	print '<tr>';
 	print '<td>' . $langs->trans("Docref") . '</td>';
@@ -319,21 +319,21 @@
 	print '</div>';
 	print '</form>';
 } else {
 	$book = new BookKeeping($db);
 	$result = $book->fetchPerMvt($piece_num, $mode);
 	if ($result < 0) {
 		setEventMessages($book->error, $book->errors, 'errors');
 	}
 	if (! empty($book->piece_num))
 	{
-		$backlink = '<a href="'.DOL_URL_ROOT.'/accountancy/bookkeeping/list.php?restore_lastsearch_values=1">' . $langs->trans('BackToList') . '</a>';
+		$backlink = '<a href="'.DOL_URL_ROOT.'/accountancy/bookkeeping/list.php">' . $langs->trans('BackToList') . '</a>';
 		print load_fiche_titre($langs->trans("UpdateMvts"), $backlink);
 		$head=array();
 		$h=0;
 		$head[$h][0] = $_SERVER['PHP_SELF'].'?piece_num='.$book->piece_num.($mode?'&mode='.$mode:'');
 		$head[$h][1] = $langs->trans("Transaction");
 		$head[$h][2] = 'transaction';
 		$h++;
 		dol_fiche_head($head, 'transaction', '', -1);
 		print '<div class="fichecenter">';
 		print '<div class="fichehalfleft">';
@@ -485,21 +485,21 @@
 				$total_credit = 0;
 				print '<tr class="liste_titre">';
 				print_liste_field_titre("AccountAccountingShort");
 				print_liste_field_titre("SubledgerAccount");
 				print_liste_field_titre("LabelAccount");
 				print_liste_field_titre("LabelOperation");
 				print_liste_field_titre("Debit", "", "", "", "", 'align="right"');
 				print_liste_field_titre("Credit", "", "", "", "", 'align="right"');
 				print_liste_field_titre("Action", "", "", "", "", 'width="60" align="center"');
 				print "</tr>\n";
-				foreach ($book->linesmvt as $line) {
+				foreach ( $book->linesmvt as $line ) {
 					print '<tr class="oddeven">';
 					$total_debit += $line->debit;
 					$total_credit += $line->credit;
 					if ($action == 'update' && $line->id == $id) {
 						print '<td>';
 						print $formaccounting->select_account($line->numero_compte, 'account_number', 1, array (), 1, 1, '');
 						print '</td>';
 						print '<td>';
 						if (! empty($conf->global->ACCOUNTANCY_COMBO_FOR_AUX))
 						{
@@ -552,22 +552,22 @@
 					print '<td>';
 					if (! empty($conf->global->ACCOUNTANCY_COMBO_FOR_AUX))
 					{
 						print $formaccounting->select_auxaccount($subledger_account, 'subledger_account', 1);
 					}
 					else
 					{
 						print '<input type="text" name="subledger_account" value="">';
 					}
 					print '</td>';
-					print '<td><input type="text" class="minwidth100" name="label_compte" value=""/></td>';
-					print '<td><input type="text" class="minwidth300" name="label_operation" value=""/></td>';
+					print '<td><input type="text" class="minwidth100" name="label_compte" value="' . $line->label_compte . '"/></td>';
+					print '<td><input type="text" class="minwidth300" name="label_operation" value="' . $line->label_operation. '"/></td>';
 					print '<td align="right"><input type="text" size="6" class="right" name="debit" value="' . ($debit ? price($debit) : '') . '"/></td>';
 					print '<td align="right"><input type="text" size="6" class="right" name="credit" value="' . ($credit ? price($credit) : '') . '"/></td>';
 					print '<td><input type="submit" class="button" name="save" value="' . $langs->trans("Add") . '"></td>';
 					print '</tr>';
 				}
 				print '</table>';
 				if ($mode=='_tmp' && $action=='')
 				{
 					print '<br>';
 					print '<div class="center">';

--- a/htdocs/accountancy/bookkeeping/list.php
+++ b/htdocs/accountancy/bookkeeping/list.php
@@ -28,22 +28,22 @@
 require_once DOL_DOCUMENT_ROOT . '/accountancy/class/bookkeeping.class.php';
 require_once DOL_DOCUMENT_ROOT . '/accountancy/class/accountingjournal.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/class/html.formother.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/class/html.formaccounting.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
 $langs->load("accountancy");
 $action = GETPOST('action', 'alpha');
 $search_mvt_num = GETPOST('search_mvt_num', 'int');
 $search_doc_type = GETPOST("search_doc_type");
 $search_doc_ref = GETPOST("search_doc_ref");
-$search_date_start = dol_mktime(0, 0, 0, GETPOST('search_date_startmonth', 'int'), GETPOST('search_date_startday', 'int'), GETPOST('search_date_startyear', 'int'));
-$search_date_end = dol_mktime(0, 0, 0, GETPOST('search_date_endmonth', 'int'), GETPOST('search_date_endday', 'int'), GETPOST('search_date_endyear', 'int'));
+$search_date_start = dol_mktime(0, 0, 0, GETPOST('date_startmonth', 'int'), GETPOST('date_startday', 'int'), GETPOST('date_startyear', 'int'));
+$search_date_end = dol_mktime(0, 0, 0, GETPOST('date_endmonth', 'int'), GETPOST('date_endday', 'int'), GETPOST('date_endyear', 'int'));
 $search_doc_date = dol_mktime(0, 0, 0, GETPOST('doc_datemonth', 'int'), GETPOST('doc_dateday', 'int'), GETPOST('doc_dateyear', 'int'));
 $search_date_creation_start = dol_mktime(0, 0, 0, GETPOST('date_creation_startmonth', 'int'), GETPOST('date_creation_startday', 'int'), GETPOST('date_creation_startyear', 'int'));
 $search_date_creation_end = dol_mktime(0, 0, 0, GETPOST('date_creation_endmonth', 'int'), GETPOST('date_creation_endday', 'int'), GETPOST('date_creation_endyear', 'int'));
 $search_date_modification_start = dol_mktime(0, 0, 0, GETPOST('date_modification_startmonth', 'int'), GETPOST('date_modification_startday', 'int'), GETPOST('date_modification_startyear', 'int'));
 $search_date_modification_end = dol_mktime(0, 0, 0, GETPOST('date_modification_endmonth', 'int'), GETPOST('date_modification_endday', 'int'), GETPOST('date_modification_endyear', 'int'));
 if (GETPOST("button_delmvt_x") || GETPOST("button_delmvt.x") || GETPOST("button_delmvt")) {
 	$action = 'delbookkeepingyear';
 }
 if (GETPOST("button_export_file_x") || GETPOST("button_export_file.x") || GETPOST("button_export_file")) {
 	$action = 'export_file';
@@ -61,40 +61,38 @@
 $search_accountancy_aux_code_start = GETPOST('search_accountancy_aux_code_start', 'alpha');
 if ($search_accountancy_aux_code_start == - 1) {
 	$search_accountancy_aux_code_start = '';
 }
 $search_accountancy_aux_code_end = GETPOST('search_accountancy_aux_code_end', 'alpha');
 if ($search_accountancy_aux_code_end == - 1) {
 	$search_accountancy_aux_code_end = '';
 }
 $search_mvt_label = GETPOST('search_mvt_label', 'alpha');
 $search_direction = GETPOST('search_direction', 'alpha');
-$search_debit = GETPOST('search_debit', 'alpha');
-$search_credit = GETPOST('search_credit', 'alpha');
 $search_ledger_code = GETPOST('search_ledger_code', 'alpha');
 $limit = GETPOST('limit','int')?GETPOST('limit', 'int'):(empty($conf->global->ACCOUNTING_LIMIT_LIST_VENTILATION)?$conf->liste_limit:$conf->global->ACCOUNTING_LIMIT_LIST_VENTILATION);
 $sortfield = GETPOST('sortfield', 'alpha');
 $sortorder = GETPOST('sortorder', 'alpha');
 $page = GETPOST('page','int');
 if (empty($page) || $page < 0) { $page = 0; }
 $offset = $limit * $page;
 $pageprev = $page - 1;
 $pagenext = $page + 1;
 if ($sortorder == "") $sortorder = "ASC";
 if ($sortfield == "") $sortfield = "t.piece_num,t.rowid";
 $object = new BookKeeping($db);
 $formaccounting = new FormAccounting($db);
 $formother = new FormOther($db);
 $form = new Form($db);
 if (! in_array($action, array('export_file', 'delmouv', 'delmouvconfirm')) && ! isset($_POST['begin']) && ! isset($_GET['begin']) && ! isset($_POST['formfilteraction']) && GETPOST('page','int') == '' && ! GETPOST('noreset','int'))
 {
-	if (empty($search_date_start) && empty($search_date_end) && ! GETPOSTISSET('restore_lastsearch_values'))
+	if (empty($search_date_start) && empty($search_date_end))
 	{
 		$query = "SELECT date_start, date_end from ".MAIN_DB_PREFIX."accounting_fiscalyear ";
 		$query.= " where date_start < '".$db->idate(dol_now())."' and date_end > '".$db->idate(dol_now())."' limit 1";
 		$res = $db->query($query);
 		if ($res->num_rows > 0) {
 			$fiscalYear = $db->fetch_object($res);
 			$search_date_start = strtotime($fiscalYear->date_start);
 			$search_date_end = strtotime($fiscalYear->date_end);
 		} else {
 			$month_start= ($conf->global->SOCIETE_FISCAL_MONTH_START?($conf->global->SOCIETE_FISCAL_MONTH_START):1);
@@ -153,79 +151,79 @@
 	$search_date_modification_start = '';
 	$search_date_modification_end = '';
 	$search_debit = '';
 	$search_credit = '';
 }
 $param = '';
 $filter = array ();
 if (! empty($search_date_start)) {
 	$filter['t.doc_date>='] = $search_date_start;
 	$tmp=dol_getdate($search_date_start);
-	$param .= '&search_date_startmonth=' . $tmp['mon'] . '&search_date_startday=' . $tmp['mday'] . '&search_date_startyear=' . $tmp['year'];
+	$param .= '&date_startmonth=' . $tmp['mon'] . '&date_startday=' . $tmp['mday'] . '&date_startyear=' . $tmp['year'];
 }
 if (! empty($search_date_end)) {
 	$filter['t.doc_date<='] = $search_date_end;
 	$tmp=dol_getdate($search_date_end);
-	$param .= '&search_date_endmonth=' . $tmp['mon'] . '&search_date_endday=' . $tmp['mday'] . '&search_date_endyear=' . $tmp['year'];
+	$param .= '&date_endmonth=' . $tmp['mon'] . '&date_endday=' . $tmp['mday'] . '&date_endyear=' . $tmp['year'];
 }
 if (! empty($search_doc_date)) {
 	$filter['t.doc_date'] = $search_doc_date;
 	$tmp=dol_getdate($search_doc_date);
 	$param .= '&doc_datemonth=' . $tmp['mon'] . '&doc_dateday=' . $tmp['mday'] . '&doc_dateyear=' . $tmp['year'];
 }
 if (! empty($search_doc_type)) {
 	$filter['t.doc_type'] = $search_doc_type;
-	$param .= '&search_doc_type=' . urlencode($search_doc_type);
+	$param .= '&search_doc_type=' . $search_doc_type;
 }
 if (! empty($search_doc_ref)) {
 	$filter['t.doc_ref'] = $search_doc_ref;
-	$param .= '&search_doc_ref=' . urlencode($search_doc_ref);
+	$param .= '&search_doc_ref=' . $search_doc_ref;
 }
 if (! empty($search_accountancy_code)) {
 	$filter['t.numero_compte'] = $search_accountancy_code;
-	$param .= '&search_accountancy_code=' . urlencode($search_accountancy_code);
+	$param .= '&search_accountancy_code=' . $search_accountancy_code;
 }
 if (! empty($search_accountancy_code_start)) {
 	$filter['t.numero_compte>='] = $search_accountancy_code_start;
-	$param .= '&search_accountancy_code_start=' . urlencode($search_accountancy_code_start);
+	$param .= '&search_accountancy_code_start=' . $search_accountancy_code_start;
 }
 if (! empty($search_accountancy_code_end)) {
 	$filter['t.numero_compte<='] = $search_accountancy_code_end;
-	$param .= '&search_accountancy_code_end=' . urlencode($search_accountancy_code_end);
+	$param .= '&search_accountancy_code_end=' . $search_accountancy_code_end;
 }
 if (! empty($search_accountancy_aux_code)) {
 	$filter['t.subledger_account'] = $search_accountancy_aux_code;
-	$param .= '&search_accountancy_aux_code=' . urlencode($search_accountancy_aux_code);
+	$param .= '&search_accountancy_aux_code=' . $search_accountancy_aux_code;
 }
 if (! empty($search_accountancy_aux_code_start)) {
 	$filter['t.subledger_account>='] = $search_accountancy_aux_code_start;
-	$param .= '&search_accountancy_aux_code_start=' . urlencode($search_accountancy_aux_code_start);
+	$param .= '&search_accountancy_aux_code_start=' . $search_accountancy_aux_code_start;
 }
 if (! empty($search_accountancy_aux_code_end)) {
 	$filter['t.subledger_account<='] = $search_accountancy_aux_code_end;
-	$param .= '&search_accountancy_aux_code_end=' . urlencode($search_accountancy_aux_code_end);
+	$param .= '&search_accountancy_aux_code_end=' . $search_accountancy_aux_code_end;
 }
 if (! empty($search_mvt_label)) {
 	$filter['t.label_operation'] = $search_mvt_label;
-	$param .= '&search_mvt_label=' . urlencode($search_mvt_label);
+	$param .= '&search_mvt_label=' . $search_mvt_label;
 }
 if (! empty($search_direction)) {
 	$filter['t.sens'] = $search_direction;
-	$param .= '&search_direction=' . urlencode($search_direction);
+	$param .= '&search_direction=' . $search_direction;
 }
 if (! empty($search_ledger_code)) {
 	$filter['t.code_journal'] = $search_ledger_code;
-	$param .= '&search_ledger_code=' . urlencode($search_ledger_code);
+	$param .= '&search_ledger_code=' . $search_ledger_code;
 }
 if (! empty($search_mvt_num)) {
 	$filter['t.piece_num'] = $search_mvt_num;
-	$param .= '&search_mvt_num=' . urlencode($search_mvt_num);
+	$param .= '&search_mvt_num=' . $search_mvt_num;
 }
 if (! empty($search_date_creation_start)) {
 	$filter['t.date_creation>='] = $search_date_creation_start;
 	$tmp=dol_getdate($search_date_creation_start);
 	$param .= '&date_creation_startmonth=' . $tmp['mon'] . '&date_creation_startday=' . $tmp['mday'] . '&date_creation_startyear=' . $tmp['year'];
 }
 if (! empty($search_date_creation_end)) {
 	$filter['t.date_creation<='] = $search_date_creation_end;
 	$tmp=dol_getdate($search_date_creation_end);
 	$param .= '&date_creation_endmonth=' . $tmp['mon'] . '&date_creation_endday=' . $tmp['mday'] . '&date_creation_endyear=' . $tmp['year'];
@@ -235,25 +233,25 @@
 	$tmp=dol_getdate($search_date_modification_start);
 	$param .= '&date_modification_startmonth=' . $tmp['mon'] . '&date_modification_startday=' . $tmp['mday'] . '&date_modification_startyear=' . $tmp['year'];
 }
 if (! empty($search_date_modification_end)) {
 	$filter['t.tms<='] = $search_date_modification_end;
 	$tmp=dol_getdate($search_date_modification_end);
 	$param .= '&date_modification_endmonth=' . $tmp['mon'] . '&date_modification_endday=' . $tmp['mday'] . '&date_modification_endyear=' . $tmp['year'];
 }
 if (! empty($search_debit)) {
 	$filter['t.debit'] = $search_debit;
-	$param .= '&search_debit=' . urlencode($search_debit);
+	$param .= '&search_debit=' . $search_debit;
 }
 if (! empty($search_credit)) {
 	$filter['t.credit'] = $search_credit;
-	$param .= '&search_credit=' . urlencode($search_credit);
+	$param .= '&search_credit=' . $search_credit;
 }
 if ($action == 'delbookkeeping') {
 	$import_key = GETPOST('importkey', 'alpha');
 	if (! empty($import_key)) {
 		$result = $object->deleteByImportkey($import_key);
 		if ($result < 0) {
 			setEventMessages($object->error, $object->errors, 'errors');
 		}
 		Header("Location: list.php");
 		exit();
@@ -392,25 +390,25 @@
 print '<tr class="liste_titre_filter">';
 if (! empty($arrayfields['t.piece_num']['checked']))
 {
 	print '<td class="liste_titre"><input type="text" name="search_mvt_num" size="6" value="' . dol_escape_htmltag($search_mvt_num) . '"></td>';
 }
 if (! empty($arrayfields['t.doc_date']['checked']))
 {
 	print '<td class="liste_titre center">';
 	print '<div class="nowrap">';
 	print $langs->trans('From') . ' ';
-	print $form->select_date($search_date_start?$search_date_start:-1, 'search_date_start', 0, 0, 1);
+	print $form->select_date($search_date_start?$search_date_start:-1, 'date_start', 0, 0, 1);
 	print '</div>';
 	print '<div class="nowrap">';
 	print $langs->trans('to') . ' ';
-	print $form->select_date($search_date_end?$search_date_end:-1, 'search_date_end', 0, 0, 1);
+	print $form->select_date($search_date_end?$search_date_end:-1, 'date_end', 0, 0, 1);
 	print '</div>';
 	print '</td>';
 }
 if (! empty($arrayfields['t.doc_ref']['checked']))
 {
 	print '<td class="liste_titre"><input type="text" name="search_doc_ref" size="8" value="' . dol_escape_htmltag($search_doc_ref) . '"></td>';
 }
 if (! empty($arrayfields['t.numero_compte']['checked']))
 {
 	print '<td class="liste_titre">';
@@ -523,25 +521,21 @@
 	$i=0;
 	$totalarray=array();
 	while ($i < min($num, $limit))
 	{
 		$line = $object->lines[$i];
 		$total_debit += $line->debit;
 		$total_credit += $line->credit;
 		print '<tr class="oddeven">';
 		if (! empty($arrayfields['t.piece_num']['checked']))
 		{
-			print '<td>';
-			$object->id = $line->id;
-			$object->piece_num = $line->piece_num;
-			print $object->getNomUrl(1,'',0,'',1);
-			print '</td>';
+			print '<td><a href="./card.php?piece_num=' . $line->piece_num . '">' . $line->piece_num . '</a></td>';
 			if (! $i) $totalarray['nbfield']++;
 		}
 		if (! empty($arrayfields['t.doc_date']['checked']))
 		{
 			print '<td align="center">' . dol_print_date($line->doc_date, 'day') . '</td>';
 			if (! $i) $totalarray['nbfield']++;
 		}
 		if (! empty($arrayfields['t.doc_ref']['checked']))
 		{
 			print '<td class="nowrap">' . $line->doc_ref . '</td>';

--- a/htdocs/accountancy/class/bookkeeping.class.php
+++ b/htdocs/accountancy/class/bookkeeping.class.php
@@ -301,69 +301,20 @@
 		}
 		if ($error) {
 			$this->db->rollback();
 			return -1 * $error;
 		} else {
 			$this->db->commit();
 			return $result;
 		}
 	}
 	/**
-	 *  Return a link to the object card (with optionaly the picto)
-	 *
-	 *	@param	int		$withpicto					Include picto in link (0=No picto, 1=Include picto into link, 2=Only picto)
-	 *	@param	string	$option						On what the link point to ('nolink', ...)
-	 *  @param	int  	$notooltip					1=Disable tooltip
-	 *  @param  string  $morecss            		Add more css on link
-	 *  @param  int     $save_lastsearch_value    	-1=Auto, 0=No save of lastsearch_values when clicking, 1=Save lastsearch_values whenclicking
-	 *	@return	string								String with URL
-	 */
-	function getNomUrl($withpicto=0, $option='', $notooltip=0, $morecss='', $save_lastsearch_value=-1)
-	{
-		global $db, $conf, $langs;
-		global $dolibarr_main_authentication, $dolibarr_main_demo;
-		global $menumanager;
-		if (! empty($conf->dol_no_mouse_hover)) $notooltip=1;   // Force disable tooltips
-		$result = '';
-		$companylink = '';
-		$label = '<u>' . $langs->trans("Transaction") . '</u>';
-		$label.= '<br>';
-		$label.= '<b>' . $langs->trans('Ref') . ':</b> ' . $this->piece_num;
-		$url = DOL_URL_ROOT.'/accountancy/bookkeeping/card.php?piece_num='.$this->piece_num;
-		if ($option != 'nolink')
-		{
-			$add_save_lastsearch_values=($save_lastsearch_value == 1 ? 1 : 0);
-			if ($save_lastsearch_value == -1 && preg_match('/list\.php/',$_SERVER["PHP_SELF"])) $add_save_lastsearch_values=1;
-			if ($add_save_lastsearch_values) $url.='&save_lastsearch_values=1';
-		}
-		$linkclose='';
-		if (empty($notooltip))
-		{
-			if (! empty($conf->global->MAIN_OPTIMIZEFORTEXTBROWSER))
-			{
-				$label=$langs->trans("ShowTransaction");
-				$linkclose.=' alt="'.dol_escape_htmltag($label, 1).'"';
-			}
-			$linkclose.=' title="'.dol_escape_htmltag($label, 1).'"';
-			$linkclose.=' class="classfortooltip'.($morecss?' '.$morecss:'').'"';
-		}
-		else $linkclose = ($morecss?' class="'.$morecss.'"':'');
-		$linkstart = '<a href="'.$url.'"';
-		$linkstart.=$linkclose.'>';
-		$linkend='</a>';
-		$result .= $linkstart;
-		if ($withpicto) $result.=img_object(($notooltip?'':$label), ($this->picto?$this->picto:'generic'), ($notooltip?(($withpicto != 2) ? 'class="paddingright"' : ''):'class="'.(($withpicto != 2) ? 'paddingright ' : '').'classfortooltip"'), 0, 0, $notooltip?0:1);
-		if ($withpicto != 2) $result.= $this->piece_num;
-		$result .= $linkend;
-		return $result;
-	}
-	/**
 	 * Create object into database
 	 *
 	 * @param  User	$user	   User that creates
 	 * @param  bool	$notrigger  false=launch triggers after, true=disable triggers
 	 * @param  string  $mode 	   Mode
 	 * @return int				 <0 if KO, Id of created object if OK
 	 */
 	public function createStd(User $user, $notrigger = false, $mode='') {
 		global $conf;
 		dol_syslog(__METHOD__, LOG_DEBUG);
@@ -746,28 +697,27 @@
 				} elseif ($key == 't.numero_compte>=' || $key == 't.numero_compte<=' || $key == 't.subledger_account>=' || $key == 't.subledger_account<=') {
 					$sqlwhere[] = $key . '\'' . $this->db->escape($value) . '\'';
 				} elseif ($key == 't.fk_doc' || $key == 't.fk_docdet' || $key == 't.piece_num') {
 					$sqlwhere[] = $key . '=' . $value;
 				} elseif ($key == 't.subledger_account' || $key == 't.numero_compte') {
 					$sqlwhere[] = $key . ' LIKE \'' . $this->db->escape($value) . '%\'';
 				} elseif ($key == 't.date_creation>=' || $key == 't.date_creation<=') {
 					$sqlwhere[] = $key . '\'' . $this->db->idate($value) . '\'';
 				} elseif ($key == 't.tms>=' || $key == 't.tms<=') {
 					$sqlwhere[] = $key . '\'' . $this->db->idate($value) . '\'';
-				} elseif ($key == 't.credit' || $key == 't.debit') {
-					$sqlwhere[] = natural_search($key, $value, 1, 1);
 				} else {
-					$sqlwhere[] = natural_search($key, $value, 0, 1);
+					$sqlwhere[] = $key . ' LIKE \'%' . $this->db->escape($value) . '%\'';
 				}
 			}
 		}
-		$sql.= ' WHERE entity IN (' . getEntity('accountancy') . ')';
+		$sql.= ' WHERE 1 = 1';
+		$sql .= " AND entity IN (" . getEntity('accountancy') . ")";
 		if (count($sqlwhere) > 0) {
 			$sql .= ' AND ' . implode(' ' . $filtermode . ' ', $sqlwhere);
 		}
 		if (! empty($sortfield)) {
 			$sql .= $this->db->order($sortfield, $sortorder);
 		}
 		if (! empty($limit)) {
 			$sql .= ' ' . $this->db->plimit($limit + 1, $offset);
 		}
 		$this->lines = array();

--- a/htdocs/accountancy/customer/index.php
+++ b/htdocs/accountancy/customer/index.php
@@ -33,37 +33,28 @@
 $langs->load("other");
 $langs->load("main");
 $langs->load("accountancy");
 if (empty($conf->accounting->enabled)) {
 	accessforbidden();
 }
 if ($user->societe_id > 0)
 	accessforbidden();
 if (! $user->rights->accounting->bind->write)
 	accessforbidden();
-$month_start= ($conf->global->SOCIETE_FISCAL_MONTH_START?($conf->global->SOCIETE_FISCAL_MONTH_START):1);
-if (GETPOST("year",'int')) $year_start = GETPOST("year",'int');
-else
-{
-	$year_start = dol_print_date(dol_now(), '%Y');
-	if (dol_print_date(dol_now(), '%m') < $month_start) $year_start--;	// If current month is lower that starting fiscal month, we start last year
-}
-$year_end = $year_start + 1;
-$month_end = $month_start - 1;
-if ($month_end < 1)
-{
-	$month_end = 12;
-	$year_end--;
-}
-$search_date_start = dol_mktime(0, 0, 0, $month_start, 1, $year_start);
-$search_date_end = dol_get_last_day($year_end, $month_end);
-$year_current = $year_start;
+$year = GETPOST("year",'int');
+if ($year == 0) {
+	$year_current = strftime("%Y", time());
+	$year_start = $year_current;
+} else {
+	$year_current = $year;
+	$year_start = $year;
+}
 $action = GETPOST('action','aZ09');
 /*
  * Actions
  */
 if ($action == 'validatehistory') {
 	$error = 0;
 	$db->begin();
 	$sqlclean = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
 	$sqlclean .= " SET fk_code_ventilation = 0";
 	$sqlclean .= ' WHERE fd.fk_code_ventilation NOT IN ';
@@ -89,20 +80,40 @@
 	dol_syslog('htdocs/accountancy/customer/index.php');
 	$resql1 = $db->query($sql1);
 	if (! $resql1) {
 		$error ++;
 		$db->rollback();
 		setEventMessages($db->lasterror(), null, 'errors');
 	} else {
 		$db->commit();
 		setEventMessages($langs->trans('AutomaticBindingDone'), null, 'mesgs');
 	}
+} elseif ($action == 'cleanaccountancycode') {
+	$error = 0;
+	$db->begin();
+	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
+	$sql1.= " SET fk_code_ventilation = 0";
+	$sql1.= " WHERE fd.fk_facture IN ( SELECT f.rowid FROM " . MAIN_DB_PREFIX . "facture as f";
+	$sql1.= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($year_current, 1, false)) . "'";
+	$sql1.= " AND f.datef <= '" . $db->idate(dol_get_last_day($year_current, 12, false)) . "'";
+	$sql1.= " AND f.entity IN (" . getEntity('accountancy') . ")";
+	$sql1.=")";
+	dol_syslog("htdocs/accountancy/customer/index.php cleanaccountancycode", LOG_DEBUG);
+	$resql1 = $db->query($sql1);
+	if (! $resql1) {
+		$error ++;
+		$db->rollback();
+		setEventMessage($db->lasterror(), 'errors');
+	} else {
+		$db->commit();
+		setEventMessage($langs->trans('Done'), 'mesgs');
+	}
 }
 /*
  * View
  */
 llxHeader('', $langs->trans("CustomersVentilation"));
 $textprevyear = '<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current - 1) . '">' . img_previous() . '</a>';
 $textnextyear = '&nbsp;<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current + 1) . '">' . img_next() . '</a>';
 print load_fiche_titre($langs->trans("CustomersVentilation") . " " . $textprevyear . " " . $langs->trans("Year") . " " . $year_start . " " . $textnextyear, '', 'title_accountancy');
 $db->begin();
 $sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
@@ -117,47 +128,61 @@
 if (! $resql1) {
 	$error ++;
 	$db->rollback();
 	setEventMessage($db->lasterror(), 'errors');
 } else {
 	$db->commit();
 }
 print $langs->trans("DescVentilCustomer") . '<br>';
 print $langs->trans("DescVentilMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
 print '<br>';
+$sql = "SELECT count(*) FROM " . MAIN_DB_PREFIX . "facturedet as fd";
+$sql .= " , " . MAIN_DB_PREFIX . "facture as f";
+$sql .= " WHERE fd.fk_code_ventilation = 0";
+$sql .= " AND f.rowid = fd.fk_facture";
+$sql .= " AND f.fk_statut > 0";
+if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
+	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
+} else {
+	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
+}
+$sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";	// We don't share object for accountancy
+dol_syslog('htdocs/accountancy/customer/index.php');
+$result = $db->query($sql);
+if ($result) {
+	$row = $db->fetch_row($result);
+	$nbfac = $row[0];
+	$db->free($result);
+}
 $y = $year_current;
 $buttonbind = '<a class="butAction" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=validatehistory">' . $langs->trans("ValidateHistory") . '</a>';
+$buttonreset = '<a class="butActionDelete" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=cleanaccountancycode">' . $langs->trans("CleanHistory", $year_current) . '</a>';
 print_fiche_titre($langs->trans("OverviewOfAmountOfLinesNotBound"), $buttonbind, '');
 print '<div class="div-table-responsive-no-min">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
 print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 }
 print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 $sql = "SELECT " . $db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') . " AS codecomptable,";
 $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $j, 'fd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+	$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, 'fd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 }
 $sql .= "  SUM(fd.total_ht) as total";
 $sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = fd.fk_code_ventilation";
-$sql .= " WHERE f.datef >= '" . $db->idate($search_date_start) . "'";
-$sql .= "  AND f.datef <= '" . $db->idate($search_date_end) . "'";
-$sql .= " AND f.fk_statut > 0";
+$sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+$sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
 $sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";   // We don't share object for accountancy
 $sql .= " AND aa.account_number IS NULL";
 if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
 } else {
 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
 }
 $sql .= " GROUP BY fd.fk_code_ventilation,aa.account_number,aa.label";
 dol_syslog('htdocs/accountancy/customer/index.php sql=' . $sql, LOG_DEBUG);
 $resql = $db->query($sql);
@@ -185,46 +210,41 @@
 		print '<td align="right"><b>' . price($row[14]) . '</b></td>';
 		print '</tr>';
 	}
 	$db->free($resql);
 } else {
 	print $db->lasterror(); // Show last sql error
 }
 print "</table>\n";
 print '</div>';
 print '<br>';
-print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), '', '');
+print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), $buttonreset, '');
 print '<div class="div-table-responsive-no-min">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
 print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 }
 print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 $sql = "SELECT " . $db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') . " AS codecomptable,";
 $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $j, 'fd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+	$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, 'fd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 }
 $sql .= "  SUM(fd.total_ht) as total";
 $sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = fd.fk_code_ventilation";
-$sql .= " WHERE f.datef >= '" . $db->idate($search_date_start) . "'";
-$sql .= "  AND f.datef <= '" . $db->idate($search_date_end) . "'";
+$sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+$sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
 $sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";   // We don't share object for accountancy
-$sql .= " AND f.fk_statut > 0";
 if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
 } else {
 	$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
 }
 $sql .= " AND aa.account_number IS NOT NULL";
 $sql .= " GROUP BY fd.fk_code_ventilation,aa.account_number,aa.label";
 dol_syslog('htdocs/accountancy/customer/index.php');
 $resql = $db->query($sql);
 if ($resql) {
@@ -237,21 +257,21 @@
 		}
 		else print length_accountg($row[0]);
 		print '</td>';
 		print '<td align="left">';
 		if ($row[0] == 'tobind')
 		{
 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/customer/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
 		}
 		else print $row[1];
 		print '</td>';
-		for($i = 2; $i <= 12; $i++) {
+		for($i = 2; $i <= 12; $i ++) {
 			print '<td align="right">' . price($row[$i]) . '</td>';
 		}
 		print '<td align="right">' . price($row[13]) . '</td>';
 		print '<td align="right"><b>' . price($row[14]) . '</b></td>';
 		print '</tr>';
 	}
 	$db->free($resql);
 } else {
 	print $db->lasterror(); // Show last sql error
 }
@@ -259,38 +279,33 @@
 print '</div>';
 if ($conf->global->MAIN_FEATURES_LEVEL > 0) // This part of code looks strange. Why showing a report that should rely on result of this step ?
 {
 	print '<br>';
 	print '<br>';
 	print_fiche_titre($langs->trans("OtherInfo"), '', '');
 	print '<div class="div-table-responsive-no-min">';
 	print '<table class="noborder" width="100%">';
 	print '<tr class="liste_titre"><td width="400" align="left">' . $langs->trans("TotalVente") . '</td>';
 	for($i = 1; $i <= 12; $i ++) {
-		$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-		if ($j > 12) $j-=12;
-		print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+		print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 	}
 	print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 	$sql = "SELECT '" . $langs->trans("TotalVente") . "' AS total,";
 	for($i = 1; $i <= 12; $i ++) {
-		$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-		if ($j > 12) $j-=12;
-		$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $j, 'fd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+		$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, 'fd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 	}
 	$sql .= "  SUM(fd.total_ht) as total";
 	$sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
 	$sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
-	$sql .= " WHERE f.datef >= '" . $db->idate($search_date_start) . "'";
-	$sql .= "  AND f.datef <= '" . $db->idate($search_date_end) . "'";
+	$sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+	$sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
 	$sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")"; // We don't share object for accountancy
-	$sql .= " AND f.fk_statut > 0";
 	if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
 		$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
 	} else {
 		$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
 	}
 	dol_syslog('htdocs/accountancy/customer/index.php');
 	$resql = $db->query($sql);
 	if ($resql) {
 		$num = $db->num_rows($resql);
 		while ($row = $db->fetch_row($resql)) {
@@ -306,38 +321,33 @@
 		print $db->lasterror(); // Show last sql error
 	}
 	print "</table>\n";
 	print '</div>';
 	if (! empty($conf->margin->enabled)) {
 		print "<br>\n";
 		print '<div class="div-table-responsive-no-min">';
 		print '<table class="noborder" width="100%">';
 		print '<tr class="liste_titre"><td width="400">' . $langs->trans("TotalMarge") . '</td>';
 		for($i = 1; $i <= 12; $i ++) {
-			$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-			if ($j > 12) $j-=12;
-			print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+			print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 		}
 		print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 		$sql = "SELECT '" . $langs->trans("Vide") . "' AS marge,";
 		for($i = 1; $i <= 12; $i ++) {
-			$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-			if ($j > 12) $j-=12;
-			$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $j, '(fd.total_ht-(fd.qty * fd.buy_price_ht))', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+			$sql .= "  SUM(" . $db->ifsql('MONTH(f.datef)=' . $i, '(fd.total_ht-(fd.qty * fd.buy_price_ht))', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 		}
 		$sql .= "  SUM((fd.total_ht-(fd.qty * fd.buy_price_ht))) as total";
 		$sql .= " FROM " . MAIN_DB_PREFIX . "facturedet as fd";
 		$sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture as f ON f.rowid = fd.fk_facture";
-		$sql .= " WHERE f.datef >= '" . $db->idate($search_date_start) . "'";
-		$sql .= "  AND f.datef <= '" . $db->idate($search_date_end) . "'";
+		$sql .= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+		$sql .= "  AND f.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
 		$sql .= " AND f.entity IN (" . getEntity('facture', 0) . ")";   // We don't share object for accountancy
-		$sql .= " AND f.fk_statut > 0";
 		if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
 			$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_SITUATION . ")";
 		} else {
 			$sql .= " AND f.type IN (" . Facture::TYPE_STANDARD . "," . Facture::TYPE_REPLACEMENT . "," . Facture::TYPE_CREDIT_NOTE . "," . Facture::TYPE_DEPOSIT . "," . Facture::TYPE_SITUATION . ")";
 		}
 		dol_syslog('htdocs/accountancy/customer/index.php');
 		$resql = $db->query($sql);
 		if ($resql) {
 			$num = $db->num_rows($resql);
 			while ($row = $db->fetch_row($resql)) {

--- a/htdocs/accountancy/customer/lines.php
+++ b/htdocs/accountancy/customer/lines.php
@@ -85,46 +85,38 @@
 	$search_account = '';
 	$search_vat = '';
 	$search_day = '';
 	$search_month = '';
 	$search_year = '';
 	$search_country = '';
 	$search_tvaintra = '';
 }
 if (is_array($changeaccount) && count($changeaccount) > 0) {
 	$error = 0;
-	if (! (GETPOST('account_parent','int') >= 0))
-	{
-		$error++;
-		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Account")), null, 'errors');
+	$db->begin();
+	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as l";
+	$sql1 .= " SET l.fk_code_ventilation=" . GETPOST('account_parent','int');
+	$sql1 .= ' WHERE l.rowid IN (' . implode(',', $changeaccount) . ')';
+	dol_syslog('accountancy/customer/lines.php::changeaccount sql= ' . $sql1);
+	$resql1 = $db->query($sql1);
+	if (! $resql1) {
+		$error ++;
+		setEventMessages($db->lasterror(), null, 'errors');
 	}
-	$db->begin();
-	if (! $error)
-	{
-		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facturedet as l";
-		$sql1 .= " SET l.fk_code_ventilation=" . (GETPOST('account_parent','int') > 0 ? GETPOST('account_parent','int') : '0');
-		$sql1 .= ' WHERE l.rowid IN (' . implode(',', $changeaccount) . ')';
-		dol_syslog('accountancy/customer/lines.php::changeaccount sql= ' . $sql1);
-		$resql1 = $db->query($sql1);
-		if (! $resql1) {
-			$error ++;
-			setEventMessages($db->lasterror(), null, 'errors');
-		}
-		if (! $error) {
-			$db->commit();
-			setEventMessages($langs->trans('Save'), null, 'mesgs');
-		} else {
-			$db->rollback();
-			setEventMessages($db->lasterror(), null, 'errors');
-		}
-		$account_parent = '';   // Protection to avoid to mass apply it a second time
+	if (! $error) {
+		$db->commit();
+		setEventMessages($langs->trans('Save'), null, 'mesgs');
+	} else {
+		$db->rollback();
+		setEventMessages($db->lasterror(), null, 'errors');
 	}
+	$account_parent = '';   // Protection to avoid to mass apply it a second time
 }
 /*
  * View
  */
 $form = new Form($db);
 $formother = new FormOther($db);
 llxHeader('', $langs->trans("CustomersVentilation") . ' - ' . $langs->trans("Dispatched"));
 print '<script type="text/javascript">
 			$(function () {
 				$(\'#select-all\').click(function(event) {
@@ -236,21 +228,21 @@
 	print '<input type="hidden" name="action" value="ventil">';
 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
 	print '<input type="hidden" name="page" value="'.$page.'">';
 	print_barre_liste($langs->trans("InvoiceLinesDone"), $page, $_SERVER["PHP_SELF"], $param, $sortfield, $sortorder, '', $num_lines, $nbtotalofrecords, 'title_accountancy', 0, '', '', $limit);
 	print $langs->trans("DescVentilDoneCustomer") . '<br>';
 	print '<br><div class="inline-block divButAction">' . $langs->trans("ChangeAccount") . '<br>';
-	print $formaccounting->select_account($account_parent, 'account_parent', 2, array(), 0, 0, 'maxwidth300 maxwidthonsmartphone valignmiddle');
+	print $formaccounting->select_account($account_parent, 'account_parent', 1);
 	print '<input type="submit" class="button valignmiddle" value="' . $langs->trans("ChangeBinding") . '"/></div>';
 	$moreforfilter = '';
 	print '<div class="div-table-responsive">';
 	print '<table class="tagtable liste'.($moreforfilter?" listwithfilterbefore":"").'">'."\n";
 	print '<tr class="liste_titre_filter">';
 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_lineid" value="' . dol_escape_htmltag($search_lineid) . '""></td>';
 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_invoice" value="' . dol_escape_htmltag($search_invoice) . '"></td>';
 	print '<td class="liste_titre center">';
    	if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day" value="'.$search_day.'">';
    	print '<input class="flat" type="text" size="1" maxlength="2" name="search_month" value="'.$search_month.'">';

--- a/htdocs/accountancy/expensereport/index.php
+++ b/htdocs/accountancy/expensereport/index.php
@@ -18,50 +18,40 @@
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  */
 /**
  * \file		htdocs/accountancy/expensereport/index.php
  * \ingroup		Advanced accountancy
  * \brief		Home expense report ventilation
  */
 require '../../main.inc.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
-require_once DOL_DOCUMENT_ROOT . '/expensereport/class/expensereport.class.php';
 $langs->load("compta");
 $langs->load("bills");
 $langs->load("other");
 $langs->load("main");
 $langs->load("accountancy");
 if (empty($conf->accounting->enabled)) {
-	accessforbidden();
+    accessforbidden();
 }
 if ($user->societe_id > 0)
 	accessforbidden();
 if (! $user->rights->accounting->bind->write)
 	accessforbidden();
-$month_start= ($conf->global->SOCIETE_FISCAL_MONTH_START?($conf->global->SOCIETE_FISCAL_MONTH_START):1);
-if (GETPOST("year",'int')) $year_start = GETPOST("year",'int');
-else
-{
-	$year_start = dol_print_date(dol_now(), '%Y');
-	if (dol_print_date(dol_now(), '%m') < $month_start) $year_start--;	// If current month is lower that starting fiscal month, we start last year
-}
-$year_end = $year_start + 1;
-$month_end = $month_start - 1;
-if ($month_end < 1)
-{
-	$month_end = 12;
-	$year_end--;
-}
-$search_date_start = dol_mktime(0, 0, 0, $month_start, 1, $year_start);
-$search_date_end = dol_get_last_day($year_end, $month_end);
-$year_current = $year_start;
+$year = GETPOST('year', 'int');
+if ($year == 0) {
+	$year_current = strftime("%Y", time());
+	$year_start = $year_current;
+} else {
+	$year_current = $year;
+	$year_start = $year;
+}
 $action = GETPOST('action','aZ09');
 /*
  * Actions
  */
 if ($action == 'validatehistory') {
 	$error = 0;
 	$db->begin();
 	$sqlclean = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
 	$sqlclean .= " SET fk_code_ventilation = 0";
 	$sqlclean .= ' WHERE erd.fk_code_ventilation NOT IN ';
@@ -87,83 +77,100 @@
 	dol_syslog('htdocs/accountancy/expensereport/index.php');
 	$resql1 = $db->query($sql1);
 	if (! $resql1) {
 		$error ++;
 		$db->rollback();
 		setEventMessages($db->lasterror(), null, 'errors');
 	} else {
 		$db->commit();
 		setEventMessages($langs->trans('AutomaticBindingDone'), null, 'mesgs');
 	}
+} elseif ($action == 'cleanaccountancycode') {
+	$error = 0;
+	$db->begin();
+	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
+	$sql1.= " SET fk_code_ventilation = 0";
+	$sql1.= " WHERE erd.fk_expensereport IN ( SELECT er.rowid FROM " . MAIN_DB_PREFIX . "expensereport as er";
+	$sql1.= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($year_current, 1, false)) . "'";
+	$sql1.= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($year_current, 12, false)) . "'";
+	$sql1.= " AND er.entity IN (" . getEntity('accountancy') . ")";
+	$sql1.=")";
+	dol_syslog("htdocs/accountancy/customer/index.php cleanaccountancycode", LOG_DEBUG);
+	$resql1 = $db->query($sql1);
+	if (! $resql1) {
+		$error ++;
+		$db->rollback();
+		setEventMessage($db->lasterror(), 'errors');
+	} else {
+		$db->commit();
+		setEventMessage($langs->trans('Done'), 'mesgs');
+	}
 }
 /*
  * View
  */
 llxHeader('', $langs->trans("ExpenseReportsVentilation"));
 $textprevyear = '<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current - 1) . '">' . img_previous() . '</a>';
 $textnextyear = '&nbsp;<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current + 1) . '">' . img_next() . '</a>';
 print load_fiche_titre($langs->trans("ExpenseReportsVentilation") . "&nbsp;" . $textprevyear . "&nbsp;" . $langs->trans("Year") . "&nbsp;" . $year_start . "&nbsp;" . $textnextyear, '', 'title_accountancy');
+print $langs->trans("DescVentilExpenseReport") . '<br>';
+print $langs->trans("DescVentilExpenseReportMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
+print '<br>';
 $db->begin();
 $sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
 $sql1 .= " SET fk_code_ventilation = 0";
 $sql1 .= ' WHERE erd.fk_code_ventilation NOT IN ';
 $sql1 .= '	(SELECT accnt.rowid ';
 $sql1 .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
 $sql1 .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
 $sql1 .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
 dol_syslog("htdocs/accountancy/customer/index.php fixaccountancycode", LOG_DEBUG);
 $resql1 = $db->query($sql1);
 if (! $resql1) {
 	$error ++;
 	$db->rollback();
 	setEventMessage($db->lasterror(), 'errors');
 } else {
 	$db->commit();
 }
-print $langs->trans("DescVentilExpenseReport") . '<br>';
-print $langs->trans("DescVentilExpenseReportMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
-print '<br>';
 $y = $year_current;
 $buttonbind = '<a class="butAction" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=validatehistory">' . $langs->trans("ValidateHistory") . '</a>';
+$buttonreset = '<a class="butActionDelete" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=cleanaccountancycode">' . $langs->trans("CleanHistory", $year_current) . '</a>';
 print_fiche_titre($langs->trans("OverviewOfAmountOfLinesNotBound"), $buttonbind, '');
 print '<div class="div-table-responsive-no-min">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
 print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+    print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 }
 print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
 $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	$sql .= "  SUM(" . $db->ifsql('MONTH(er.date_debut)=' . $j, 'erd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+    $sql .= "  SUM(" . $db->ifsql('MONTH(er.date_debut)=' . $i, 'erd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 }
 $sql .= " SUM(erd.total_ht) as total";
 $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport_det as erd";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "expensereport as er ON er.rowid = erd.fk_expensereport";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = erd.fk_code_ventilation";
-$sql .= " WHERE er.date_debut >= '" . $db->idate($search_date_start) . "'";
-$sql .= " AND er.date_debut <= '" . $db->idate($search_date_end) . "'";
-$sql .= " AND er.fk_statut IN (".ExpenseReport::STATUS_APPROVED.", ".ExpenseReport::STATUS_CLOSED.")";
+$sql .= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+$sql .= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
+$sql .= " AND er.fk_statut > 0 ";
 $sql .= " AND er.entity IN (" . getEntity('expensereport', 0) . ")";     // We don't share object for accountancy
 $sql .= " AND aa.account_number IS NULL";
 $sql .= " GROUP BY erd.fk_code_ventilation,aa.account_number,aa.label";
 dol_syslog('/accountancy/expensereport/index.php:: sql=' . $sql);
 $resql = $db->query($sql);
 if ($resql) {
-	$num = $db->num_rows($resql);
-	while ( $row = $db->fetch_row($resql)) {
+    $num = $db->num_rows($resql);
+    while ( $row = $db->fetch_row($resql)) {
 		print '<tr class="oddeven"><td>';
 		if ($row[0] == 'tobind')
 		{
 			print $langs->trans("Unknown");
 		}
 		else print length_accountg($row[0]);
 		print '</td>';
 		print '<td align="left">';
 		if ($row[0] == 'tobind')
 		{
@@ -178,53 +185,49 @@
         print '<td align="right"><b>' . price($row[14]) . '</b></td>';
         print '</tr>';
     }
     $db->free($resql);
 } else {
     print $db->lasterror(); // Show last sql error
 }
 print "</table>\n";
 print '</div>';
 print '<br>';
-print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), '', '');
+print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), $buttonreset, '');
 print '<div class="div-table-responsive-no-min">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
 print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+    print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 }
 print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
 $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	$sql .= "  SUM(" . $db->ifsql('MONTH(er.date_debut)=' . $j, 'erd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+    $sql .= "  SUM(" . $db->ifsql('MONTH(er.date_debut)=' . $i, 'erd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 }
 $sql .= " ROUND(SUM(erd.total_ht),2) as total";
 $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport_det as erd";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "expensereport as er ON er.rowid = erd.fk_expensereport";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = erd.fk_code_ventilation";
-$sql .= " WHERE er.date_debut >= '" . $db->idate($search_date_start) . "'";
-$sql .= " AND er.date_debut <= '" . $db->idate($search_date_end) . "'";
-$sql .= " AND er.fk_statut IN (".ExpenseReport::STATUS_APPROVED.", ".ExpenseReport::STATUS_CLOSED.")";
+$sql .= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+$sql .= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
+$sql .= " AND er.fk_statut > 0 ";
 $sql .= " AND er.entity IN (" . getEntity('expensereport', 0) . ")";     // We don't share object for accountancy
 $sql .= " AND aa.account_number IS NOT NULL";
 $sql .= " GROUP BY erd.fk_code_ventilation,aa.account_number,aa.label";
 dol_syslog('htdocs/accountancy/expensereport/index.php');
 $resql = $db->query($sql);
 if ($resql) {
-	$num = $db->num_rows($resql);
-	while ( $row = $db->fetch_row($resql)) {
+    $num = $db->num_rows($resql);
+    while ( $row = $db->fetch_row($resql)) {
 		print '<tr class="oddeven"><td>';
 		if ($row[0] == 'tobind')
 		{
 			print $langs->trans("Unknown");
 		}
 		else print length_accountg($row[0]);
 		print '</td>';
 		print '<td align="left">';
 		if ($row[0] == 'tobind')
 		{
@@ -238,52 +241,48 @@
         print '<td align="right">' . price($row[13]) . '</td>';
         print '<td align="right"><b>' . price($row[14]) . '</b></td>';
         print '</tr>';
     }
     $db->free($resql);
 } else {
     print $db->lasterror(); // Show last sql error
 }
 print "</table>\n";
 print '</div>';
-if ($conf->global->MAIN_FEATURES_LEVEL > 0) // This part of code looks strange. Why showing a report where results depends on next step (so not yet available) ?
+if ($conf->global->MAIN_FEATURES_LEVEL > 0) // This part of code looks strange. Why showing a report that should rely on result of this step ?
 {
     print '<br>';
     print '<br>';
     print_fiche_titre($langs->trans("OtherInfo"), '', '');
 	print '<div class="div-table-responsive-no-min">';
     print '<table class="noborder" width="100%">';
     print '<tr class="liste_titre"><td width="400" align="left">' . $langs->trans("Total") . '</td>';
     for($i = 1; $i <= 12; $i ++) {
-    	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-    	if ($j > 12) $j-=12;
-    	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+    	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
     }
     print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
     $sql = "SELECT '" . $langs->trans("TotalExpenseReport") . "' AS label,";
     for($i = 1; $i <= 12; $i ++) {
-    	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-    	if ($j > 12) $j-=12;
-    	$sql .= " SUM(" . $db->ifsql('MONTH(er.date_create)=' . $j, 'erd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+    	$sql .= " SUM(" . $db->ifsql('MONTH(er.date_create)=' . $i, 'erd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
     }
     $sql .= " SUM(erd.total_ht) as total";
     $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport_det as erd";
     $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "expensereport as er ON er.rowid = erd.fk_expensereport";
-    $sql .= " WHERE er.date_debut >= '" . $db->idate($search_date_start) . "'";
-    $sql .= " AND er.date_debut <= '" . $db->idate($search_date_end) . "'";
-    $sql .= " AND er.fk_statut IN (".ExpenseReport::STATUS_APPROVED.", ".ExpenseReport::STATUS_CLOSED.")";
+    $sql .= " WHERE er.date_debut >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+    $sql .= " AND er.date_debut <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
+    $sql .= " AND er.fk_statut > 0 ";
     $sql .= " AND er.entity IN (" . getEntity('expensereport', 0) . ")";     // We don't share object for accountancy
     dol_syslog('htdocs/accountancy/expensereport/index.php');
     $resql = $db->query($sql);
     if ($resql) {
     	$num = $db->num_rows($resql);
-    	while ($row = $db->fetch_row($resql)) {
+    	while ( $row = $db->fetch_row($resql)) {
     		print '<tr><td>' . $row[0] . '</td>';
     			for($i = 1; $i <= 12; $i ++) {
     			print '<td align="right">' . price($row[$i]) . '</td>';
     		}
     		print '<td align="right"><b>' . price($row[13]) . '</b></td>';
     		print '</tr>';
     	}
     	$db->free($resql);
     } else {
     	print $db->lasterror(); // Show last sql error

--- a/htdocs/accountancy/expensereport/lines.php
+++ b/htdocs/accountancy/expensereport/lines.php
@@ -30,21 +30,21 @@
 require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
 require_once DOL_DOCUMENT_ROOT . '/core/class/html.formother.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
 $langs->load("compta");
 $langs->load("bills");
 $langs->load("other");
 $langs->load("main");
 $langs->load("accountancy");
 $langs->load("trips");
 $langs->load("productbatch");
-$account_parent = GETPOST('account_parent','int');
+$account_parent = GETPOST('account_parent');
 $changeaccount = GETPOST('changeaccount');
 $search_expensereport = GETPOST('search_expensereport', 'alpha');
 $search_label = GETPOST('search_label', 'alpha');
 $search_desc = GETPOST('search_desc', 'alpha');
 $search_amount = GETPOST('search_amount', 'alpha');
 $search_account = GETPOST('search_account', 'alpha');
 $search_vat = GETPOST('search_vat', 'alpha');
 $search_day=GETPOST("search_day","int");
 $search_month=GETPOST("search_month","int");
 $search_year=GETPOST("search_year","int");
@@ -78,46 +78,38 @@
 	$search_desc = '';
 	$search_amount = '';
 	$search_account = '';
 	$search_vat = '';
 	$search_day = '';
 	$search_month = '';
 	$search_year = '';
 }
 if (is_array($changeaccount) && count($changeaccount) > 0) {
 	$error = 0;
-	if (! (GETPOST('account_parent','int') >= 0))
-	{
-		$error++;
-		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Account")), null, 'errors');
-	}
 	$db->begin();
-	if (! $error)
-	{
-		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
-		$sql1 .= " SET erd.fk_code_ventilation=" . (GETPOST('account_parent','int') > 0 ? GETPOST('account_parent','int') : '0');
-		$sql1 .= ' WHERE erd.rowid IN (' . implode(',', $changeaccount) . ')';
-		dol_syslog('accountancy/expensereport/lines.php::changeaccount sql= ' . $sql1);
-		$resql1 = $db->query($sql1);
-		if (! $resql1) {
-			$error ++;
-			setEventMessages($db->lasterror(), null, 'errors');
-		}
-		if (! $error) {
-			$db->commit();
-			setEventMessages($langs->trans('Save'), null, 'mesgs');
-		} else {
-			$db->rollback();
-			setEventMessages($db->lasterror(), null, 'errors');
-		}
-		$account_parent = '';   // Protection to avoid to mass apply it a second time
-	}
+	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "expensereport_det as erd";
+	$sql1 .= " SET erd.fk_code_ventilation=" . GETPOST('account_parent','int');
+	$sql1 .= ' WHERE erd.rowid IN (' . implode(',', $changeaccount) . ')';
+	dol_syslog('accountancy/expensereport/lines.php::changeaccount sql= ' . $sql1);
+	$resql1 = $db->query($sql1);
+	if (! $resql1) {
+		$error ++;
+		setEventMessages($db->lasterror(), null, 'errors');
+	}
+	if (! $error) {
+		$db->commit();
+		setEventMessages($langs->trans('Save'), null, 'mesgs');
+	} else {
+		$db->rollback();
+		setEventMessages($db->lasterror(), null, 'errors');
+	}
+	$account_parent = '';   // Protection to avoid to mass apply it a second time
 }
 /*
  * View
  */
 $form = new Form($db);
 $formother = new FormOther($db);
 llxHeader('', $langs->trans("ExpenseReportsVentilation") . ' - ' . $langs->trans("Dispatched"));
 print '<script type="text/javascript">
 			$(function () {
 				$(\'#select-all\').click(function(event) {
@@ -136,24 +128,24 @@
  * Expense reports lines
  */
 $sql = "SELECT er.ref, er.rowid as erid,";
 $sql .= " erd.rowid, erd.fk_c_type_fees, erd.comments, erd.total_ht, erd.fk_code_ventilation, erd.tva_tx, erd.vat_src_code, erd.date,";
 $sql .= " aa.label, aa.account_number,";
 $sql .= " f.id as type_fees_id, f.code as type_fees_code, f.label as type_fees_label";
 $sql .= " FROM " . MAIN_DB_PREFIX . "expensereport as er";
 $sql .= " , " . MAIN_DB_PREFIX . "accounting_account as aa";
 $sql .= " , " . MAIN_DB_PREFIX . "expensereport_det as erd";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "c_type_fees as f ON f.id = erd.fk_c_type_fees";
-$sql .= " WHERE er.rowid = erd.fk_expensereport and er.fk_statut IN (".ExpenseReport::STATUS_APPROVED.", ".ExpenseReport::STATUS_CLOSED.") AND erd.fk_code_ventilation <> 0 ";
+$sql .= " WHERE er.rowid = erd.fk_expensereport and er.fk_statut >= 5 AND erd.fk_code_ventilation <> 0 ";
 $sql .= " AND aa.rowid = erd.fk_code_ventilation";
 if (strlen(trim($search_expensereport))) {
-	$sql .= natural_search("er.ref", $search_expensereport);
+	$sql .= " AND er.ref like '%" . $search_expensereport . "%'";
 }
 if (strlen(trim($search_label))) {
 	$sql .= natural_search("f.label", $search_label);
 }
 if (strlen(trim($search_desc))) {
 	$sql .= natural_search("er.comments", $search_desc);
 }
 if (strlen(trim($search_amount))) {
 	$sql .= natural_search("erd.total_ht", $search_amount, 1);
 }
@@ -207,21 +199,21 @@
 	print '<input type="hidden" name="action" value="ventil">';
 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
 	print '<input type="hidden" name="page" value="'.$page.'">';
 	print_barre_liste($langs->trans("ExpenseReportLinesDone"), $page, $_SERVER["PHP_SELF"], $param, $sortfield, $sortorder, '', $num_lines, $nbtotalofrecords, 'title_accountancy', 0, '', '', $limit);
 	print $langs->trans("DescVentilDoneExpenseReport") . '<br>';
 	print '<br><div class="inline-block divButAction">' . $langs->trans("ChangeAccount") . '<br>';
-	print $formaccounting->select_account($account_parent, 'account_parent', 2, array(), 0, 0, 'maxwidth300 maxwidthonsmartphone valignmiddle');
+	print $formaccounting->select_account(GETPOST('account_parent'), 'account_parent', 1);
 	print '<input type="submit" class="button valignmiddle" value="' . $langs->trans("ChangeBinding") . '" /></div>';
 	$moreforfilter = '';
     print '<div class="div-table-responsive">';
 	print '<table class="tagtable liste'.($moreforfilter?" listwithfilterbefore":"").'">'."\n";
 	print '<tr class="liste_titre_filter">';
 	print '<td class="liste_titre"></td>';
 	print '<td><input type="text" class="flat maxwidth50" name="search_expensereport" value="' . dol_escape_htmltag($search_expensereport) . '"></td>';
 	print '<td class="liste_titre center">';
    	if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day" value="'.$search_day.'">';
    	print '<input class="flat" type="text" size="1" maxlength="2" name="search_month" value="'.$search_month.'">';

--- a/htdocs/accountancy/expensereport/list.php
+++ b/htdocs/accountancy/expensereport/list.php
@@ -153,21 +153,21 @@
 	exit;
 }
 $sql = "SELECT er.ref, er.rowid as erid, er.date_debut,";
 $sql.= " erd.rowid, erd.fk_c_type_fees, erd.comments, erd.total_ht as price, erd.fk_code_ventilation, erd.tva_tx as tva_tx_line, erd.vat_src_code, erd.date,";
 $sql.= " f.id as type_fees_id, f.code as type_fees_code, f.label as type_fees_label, f.accountancy_code as code_buy,";
 $sql.= " aa.rowid as aarowid";
 $sql.= " FROM " . MAIN_DB_PREFIX . "expensereport as er";
 $sql.= " INNER JOIN " . MAIN_DB_PREFIX . "expensereport_det as erd ON er.rowid = erd.fk_expensereport";
 $sql.= " LEFT JOIN " . MAIN_DB_PREFIX . "c_type_fees as f ON f.id = erd.fk_c_type_fees";
 $sql.= " LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON f.accountancy_code = aa.account_number AND aa.fk_pcg_version = '" . $chartaccountcode."'";
-$sql.= " WHERE er.fk_statut IN (".ExpenseReport::STATUS_APPROVED.", ".ExpenseReport::STATUS_CLOSED.") AND erd.fk_code_ventilation <= 0";
+$sql.= " WHERE er.fk_statut > 4 AND erd.fk_code_ventilation <= 0";
 if (strlen(trim($search_expensereport))) {
     $sql .= natural_search("er.ref",$search_expensereport);
 }
 if (strlen(trim($search_label))) {
     $sql .= natural_search("f.label",$search_label);
 }
 if (strlen(trim($search_desc))) {
     $sql .= natural_search("erd.comments",$search_desc);
 }
 if (strlen(trim($search_amount))) {

--- a/htdocs/accountancy/index.php
+++ b/htdocs/accountancy/index.php
@@ -39,105 +39,98 @@
 $langs->load("loans");
 /*
  * Actions
  */
 /*
  * View
  */
 llxHeader('', $langs->trans("AccountancyArea"));
 print load_fiche_titre($langs->trans("AccountancyArea"), '', 'title_accountancy');
 $step = 0;
-if ($conf->accounting->enabled)
+print $langs->trans("AccountancyAreaDescIntro")."<br>\n";
+print "<br>\n";print "<br>\n";
+print_fiche_titre('<span class="fa fa-calendar-check-o"></span> '.$langs->trans("AccountancyAreaDescActionOnce"), '', '')."<br>\n";
+print '<hr>';
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescJournalSetup", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("AccountingJournals").'</strong>');
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescChartModel", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("Pcg_version").'</strong>');
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescChart", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("Chartofaccounts").'</strong>');
+print "<br>\n";
+print "<br>\n";
+print $langs->trans("AccountancyAreaDescActionOnceBis");
+print "<br>\n";
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescProd", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBank", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuBankAccounts").'</strong>')."\n";
+print "<br>\n";
+$step++;
+$textlink = '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup").'-'.$langs->transnoentitiesnoconv("MenuVatAccounts").'</strong>';
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescVat", $step, $textlink);
+print "<br>\n";
+if (! empty($conf->tax->enabled))
 {
-	print $langs->trans("AccountancyAreaDescIntro")."<br>\n";
-	print "<br>\n";print "<br>\n";
-	print_fiche_titre('<span class="fa fa-calendar-check-o"></span> '.$langs->trans("AccountancyAreaDescActionOnce"), '', '')."<br>\n";
-	print '<hr>';
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescJournalSetup", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("AccountingJournals").'</strong>');
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescChartModel", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("Pcg_version").'</strong>');
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescChart", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("Chartofaccounts").'</strong>');
-	print "<br>\n";
-	print "<br>\n";
-	print $langs->trans("AccountancyAreaDescActionOnceBis");
-	print "<br>\n";
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescProd", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBank", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuBankAccounts").'</strong>')."\n";
-	print "<br>\n";
-	$step++;
-	$textlink = '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup").'-'.$langs->transnoentitiesnoconv("MenuVatAccounts").'</strong>';
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescVat", $step, $textlink);
-	print "<br>\n";
-	if (! empty($conf->tax->enabled))
-	{
-	    $textlink = '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup").'-'.$langs->transnoentitiesnoconv("MenuTaxAccounts").'</strong>';
-	    $step++;
-	    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescContrib", $step, $textlink);
-	    print "<br>\n";
-	}
-	/*if (! empty($conf->salaries->enabled))
-	{
-	    $step++;
-	    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescSal", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuFinancial").'-'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
-	    print "<br>\n";
-	    print "<br>\n";
-	}*/
-	if (! empty($conf->expensereport->enabled))  // TODO Move this in the default account page because this is only one accounting account per purpose, not several.
-	{
-	    $step++;
-	    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescExpenseReport", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuExpenseReportAccounts").'</strong>');
-	    print "<br>\n";
-	}
-	/*
-	if (! empty($conf->loan->enabled))
-	{
-	    $step++;
-	    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescLoan", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuSpecialExpenses").'-'.$langs->transnoentitiesnoconv("Loans").'</strong> '.$langs->transnoentitiesnoconv("or").' <strong>'.$langs->transnoentitiesnoconv("MenuFinancial").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
-	    print "<br>\n";
-	}
-	if (! empty($conf->don->enabled))
-	{
-	    $step++;
-	    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescDonation", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDonationAccounts").'</strong>');
-	    print "<br>\n";
-	}*/
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescProd", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("ProductsBinding").'</strong>');
-	print "<br>\n";
-	print '<br>';
-	print "<br>\n";
-	print_fiche_titre('<span class="fa fa-calendar"></span> '.$langs->trans("AccountancyAreaDescActionFreq"), '', '');
-	print '<hr>';
-	print "<br>\n";
-	$step = 0;
-	$langs->loadLangs(array('bills', 'trips'));
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("BillsCustomers"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("CustomersVentilation").'</strong>')."\n";
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("BillsSuppliers"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("SuppliersVentilation").'</strong>')."\n";
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("ExpenseReports"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("ExpenseReportsVentilation").'</strong>')."\n";
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescWriteRecords", chr(64+$step), $langs->transnoentitiesnoconv("Journalization"), $langs->transnoentitiesnoconv("WriteBookKeeping"))."\n";
-	print "<br>\n";
-	$step++;
-	print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescAnalyze", chr(64+$step))."<br>\n";
-	print "<br>\n";
+    $textlink = '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup").'-'.$langs->transnoentitiesnoconv("MenuTaxAccounts").'</strong>';
+    $step++;
+    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescContrib", $step, $textlink);
+    print "<br>\n";
 }
-else
+/*if (! empty($conf->salaries->enabled))
 {
-	print $langs->trans("Module10Desc")."<br>\n";
+    $step++;
+    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescSal", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuFinancial").'-'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
+    print "<br>\n";
+    print "<br>\n";
+}*/
+if (! empty($conf->expensereport->enabled))  // TODO Move this in the default account page because this is only one accounting account per purpose, not several.
+{
+    $step++;
+    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescExpenseReport", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuExpenseReportAccounts").'</strong>');
+    print "<br>\n";
 }
+/*
+if (! empty($conf->loan->enabled))
+{
+    $step++;
+    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescLoan", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuSpecialExpenses").'-'.$langs->transnoentitiesnoconv("Loans").'</strong> '.$langs->transnoentitiesnoconv("or").' <strong>'.$langs->transnoentitiesnoconv("MenuFinancial").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
+    print "<br>\n";
+}
+if (! empty($conf->don->enabled))
+{
+    $step++;
+    print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescDonation", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDonationAccounts").'</strong>');
+    print "<br>\n";
+}*/
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescProd", $step, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("ProductsBinding").'</strong>');
+print "<br>\n";
+print '<br>';
+print "<br>\n";
+print_fiche_titre('<span class="fa fa-calendar"></span> '.$langs->trans("AccountancyAreaDescActionFreq"), '', '');
+print '<hr>';
+print "<br>\n";
+$step = 0;
+$langs->loadLangs(array('bills', 'trips'));
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("BillsCustomers"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("CustomersVentilation").'</strong>')."\n";
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("BillsSuppliers"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("SuppliersVentilation").'</strong>')."\n";
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescBind", chr(64+$step), $langs->transnoentitiesnoconv("ExpenseReports"), '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy")."-".$langs->transnoentitiesnoconv("ExpenseReportsVentilation").'</strong>')."\n";
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescWriteRecords", chr(64+$step), $langs->transnoentitiesnoconv("Journalization"), $langs->transnoentitiesnoconv("WriteBookKeeping"))."\n";
+print "<br>\n";
+$step++;
+print img_picto('', 'puce').' '.$langs->trans("AccountancyAreaDescAnalyze", chr(64+$step))."<br>\n";
+print "<br>\n";
 llxFooter();
 $db->close();

--- a/htdocs/accountancy/journal/bankjournal.php
+++ b/htdocs/accountancy/journal/bankjournal.php
@@ -80,22 +80,22 @@
 $date_start = dol_mktime(0, 0, 0, $date_startmonth, $date_startday, $date_startyear);
 $date_end = dol_mktime(23, 59, 59, $date_endmonth, $date_endday, $date_endyear);
 if (! GETPOSTISSET('date_startmonth') && (empty($date_start) || empty($date_end))) // We define date_start and date_end, only if we did not submit the form
 {
 	$date_start = dol_get_first_day($pastmonthyear, $pastmonth, false);
 	$date_end = dol_get_last_day($pastmonthyear, $pastmonth, false);
 }
 $idpays = $mysoc->country_id;
 $sql  = "SELECT b.rowid, b.dateo as do, b.datev as dv, b.amount, b.label, b.rappro, b.num_releve, b.num_chq, b.fk_type, b.fk_account,";
 $sql .= " ba.courant, ba.ref as baref, ba.account_number, ba.fk_accountancy_journal,";
-$sql .= " soc.code_compta, soc.code_compta_fournisseur, soc.rowid as socid, soc.nom as name, soc.email as email, bu1.type as typeop_company,";
-$sql .= " u.accountancy_code, u.rowid as userid, u.lastname as lastname, u.firstname as firstname, u.email as useremail, bu2.type as typeop_user,";
+$sql .= " soc.code_compta, soc.code_compta_fournisseur, soc.rowid as socid, soc.nom as name, bu1.type as typeop_company,";
+$sql .= " u.accountancy_code, u.rowid as userid, u.lastname as lastname, u.firstname as firstname, bu2.type as typeop_user,";
 $sql .= " bu3.type as typeop_payment, bu4.type as typeop_payment_supplier";
 $sql .= " FROM " . MAIN_DB_PREFIX . "bank as b";
 $sql .= " JOIN " . MAIN_DB_PREFIX . "bank_account as ba on b.fk_account=ba.rowid";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu1 ON bu1.fk_bank = b.rowid AND bu1.type='company'";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu2 ON bu2.fk_bank = b.rowid AND bu2.type='user'";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu3 ON bu3.fk_bank = b.rowid AND bu3.type='payment'";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "bank_url as bu4 ON bu4.fk_bank = b.rowid AND bu4.type='payment_supplier'";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "societe as soc on bu1.url_id=soc.rowid";
 $sql .= " LEFT JOIN " . MAIN_DB_PREFIX . "user as u on bu2.url_id=u.rowid";
 $sql .= " WHERE ba.fk_accountancy_journal=" . $id_journal;
@@ -162,43 +162,41 @@
 		$compta_bank = $obj->account_number;
 		$compta_soc = 'NotDefined';
 		if ($lineisapurchase > 0)
 			$compta_soc = (! empty($obj->code_compta_fournisseur) ? $obj->code_compta_fournisseur : $account_supplier);
 		if ($lineisasale > 0)
 			$compta_soc = (! empty($obj->code_compta) ? $obj->code_compta : $account_customer);
 		$tabcompany[$obj->rowid] = array (
 				'id' => $obj->socid,
 				'name' => $obj->name,
 				'code_compta' => $compta_soc,
-				'email' => $obj->email
 		);
 		$compta_user = (! empty($obj->accountancy_code) ? $obj->accountancy_code : $account_employee);
 		$tabuser[$obj->rowid] = array (
 				'id' => $obj->userid,
 				'name' => dolGetFirstLastname($obj->firstname, $obj->lastname),
 				'lastname' => $obj->lastname,
 				'firstname' => $obj->firstname,
-				'email' => $obj->useremail,
-				'accountancy_code' => $compta_user
+				'accountancy_code' => $compta_user,
 		);
 		$tabpay[$obj->rowid]["date"] = $obj->do;
 		$tabpay[$obj->rowid]["type_payment"] = $obj->fk_type;		// CHQ, VIR, LIQ, CB, ...
 		$tabpay[$obj->rowid]["ref"] = $obj->label;					// By default. Not unique. May be changed later
 		$tabpay[$obj->rowid]["fk_bank"] = $obj->rowid;
 		$tabpay[$obj->rowid]["bank_account_ref"] = $obj->baref;
 		$tabpay[$obj->rowid]["fk_bank_account"] = $obj->fk_account;
 		if (preg_match('/^\((.*)\)$/i', $obj->label, $reg)) {
 			$tabpay[$obj->rowid]["lib"] = $langs->trans($reg[1]);
 		} else {
 			$tabpay[$obj->rowid]["lib"] = dol_trunc($obj->label, 60);
 		}
-		$links = $object->get_url($obj->rowid);		// Get an array('url'=>, 'url_id'=>, 'label'=>, 'type'=> 'fk_bank'=> )
+		$links = $object->get_url($obj->rowid);
 		$tabpay[$obj->rowid]['type'] = 'unknown';	// Can be SOLD, miscellaneous entry, payment of patient, or any old record with no links in bank_url.
 		$tabtype[$obj->rowid] = 'unknown';
 		if (is_array($links) && count($links) > 0) {
 			foreach ($links as $key => $val) {
 				if (in_array($links[$key]['type'], array('sc', 'payment_sc', 'payment', 'payment_supplier', 'payment_vat', 'payment_expensereport', 'banktransfert', 'payment_donation', 'payment_salary', 'payment_various')))
 				{
 					$tabpay[$obj->rowid]['type'] = $links[$key]['type'];
 					$tabtype[$obj->rowid] = $links[$key]['type'];
 				}
 				elseif (in_array($links[$key]['type'], array('company', 'user')))
@@ -213,29 +211,25 @@
 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentstatic->getNomUrl(2, '', '');		// TODO Do not include list of invoice in tooltip, the dol_string_nohtmltag is ko with this
 					$tabpay[$obj->rowid]["paymentid"] = $paymentstatic->id;
 				} else if ($links[$key]['type'] == 'payment_supplier') {
 					$paymentsupplierstatic->id = $links[$key]['url_id'];
 					$paymentsupplierstatic->ref = $links[$key]['url_id'];
 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentsupplierstatic->getNomUrl(2);
 					$tabpay[$obj->rowid]["paymentsupplierid"] = $paymentsupplierstatic->id;
 				} else if ($links[$key]['type'] == 'company') {
 					$societestatic->id = $links[$key]['url_id'];
 					$societestatic->name = $links[$key]['label'];
-					$societestatic->email = $tabcompany[$obj->rowid]['email'];
 					$tabpay[$obj->rowid]["soclib"] = $societestatic->getNomUrl(1, '', 30);
 					if ($compta_soc) $tabtp[$obj->rowid][$compta_soc] += $obj->amount;
 				} else if ($links[$key]['type'] == 'user') {
 					$userstatic->id = $links[$key]['url_id'];
 					$userstatic->name = $links[$key]['label'];
-					$userstatic->email = $tabuser[$obj->rowid]['email'];
-					$userstatic->firstname = $tabuser[$obj->rowid]['firstname'];
-					$userstatic->lastname = $tabuser[$obj->rowid]['lastname'];
 					if ($userstatic->id > 0) $tabpay[$obj->rowid]["soclib"] = $userstatic->getNomUrl(1, '', 30);
 					else $tabpay[$obj->rowid]["soclib"] = '???';	// Should not happen, but happens with old data when id of user was not saved on expense report payment.
 					if ($compta_user) $tabtp[$obj->rowid][$compta_user] += $obj->amount;
 				} else if ($links[$key]['type'] == 'sc') {
 					$chargestatic->id = $links[$key]['url_id'];
 					$chargestatic->ref = $links[$key]['url_id'];
 					$tabpay[$obj->rowid]["lib"] .= ' ' . $chargestatic->getNomUrl(2);
 					if (preg_match('/^\((.*)\)$/i', $links[$key]['label'], $reg)) {
 						if ($reg[1] == 'socialcontribution')
 							$reg[1] = 'SocialContribution';
@@ -273,21 +267,21 @@
 					$tabpay[$obj->rowid]["paymentvatid"] = $paymentvatstatic->id;
 					$tabtp[$obj->rowid][$account_pay_vat] += $obj->amount;
 				} else if ($links[$key]['type'] == 'payment_salary') {
 					$paymentsalstatic->id = $links[$key]['url_id'];
 					$paymentsalstatic->ref = $links[$key]['url_id'];
 					$paymentsalstatic->label = $links[$key]['label'];
 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentsalstatic->getNomUrl(2);
 					$tabpay[$obj->rowid]["paymentsalid"] = $paymentsalstatic->id;
 				} else if ($links[$key]['type'] == 'payment_expensereport') {
 					$paymentexpensereportstatic->id = $links[$key]['url_id'];
-					$tabpay[$obj->rowid]["lib"] .= $paymentexpensereportstatic->getNomUrl(2);
+					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentexpensereportstatic->getNomUrl(2);
 					$tabpay[$obj->rowid]["paymentexpensereport"] = $paymentexpensereportstatic->id;
 				} else if ($links[$key]['type'] == 'payment_various') {
 					$paymentvariousstatic->id = $links[$key]['url_id'];
 					$paymentvariousstatic->ref = $links[$key]['url_id'];
 					$paymentvariousstatic->label = $links[$key]['label'];
 					$tabpay[$obj->rowid]["lib"] .= ' ' . $paymentvariousstatic->getNomUrl(2);
 					$tabpay[$obj->rowid]["paymentvariousid"] = $paymentvariousstatic->id;
 					$paymentvariousstatic->fetch($paymentvariousstatic->id);
 					$account_various = (! empty($paymentvariousstatic->accountancy_code) ? $paymentvariousstatic->accountancy_code : 'NotDefined');	// NotDefined is a reserved word
 					$tabtp[$obj->rowid][$account_various] += $obj->amount;
@@ -687,21 +681,21 @@
 	$invoicesupplierstatic = new FactureFournisseur($db);
 	$expensereportstatic = new ExpenseReport($db);
 	$vatstatic = new Tva($db);
 	$donationstatic = new Don($db);
 	$salarystatic = new PaymentSalary($db);
 	$variousstatic = new PaymentVarious($db);
 	llxHeader('', $langs->trans("FinanceJournal"));
 	$nom = $langs->trans("FinanceJournal") . ' - ' . $accountingjournalstatic->getNomUrl(1);
 	$builddate=dol_now();
 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
-	$listofchoices=array('notyet'=>$langs->trans("NotYetInGeneralLedger"), 'already'=>$langs->trans("AlreadyInGeneralLedger"));
+	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
 	$varlink = 'id_journal=' . $id_journal;
 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
 	$sql = 'SELECT COUNT(rowid) as nb FROM '.MAIN_DB_PREFIX.'bank_account WHERE fk_accountancy_journal IS NULL';
 	$resql = $db->query($sql);
 	if ($resql)
 	{
 		$obj = $db->fetch_object($resql);
 		if ($obj->nb > 0)
 		{

--- a/htdocs/accountancy/journal/expensereportsjournal.php
+++ b/htdocs/accountancy/journal/expensereportsjournal.php
@@ -432,21 +432,21 @@
 }
 */
 if (empty($action) || $action == 'view') {
 	llxHeader('', $langs->trans("ExpenseReportsJournal"));
 	$nom = $langs->trans("ExpenseReportsJournal") . ' - ' . $accountingjournalstatic->getNomUrl(1);
 	$nomlink = '';
 	$periodlink = '';
 	$exportlink = '';
 	$builddate=dol_now();
 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
-	$listofchoices=array('notyet'=>$langs->trans("NotYetInGeneralLedger"), 'already'=>$langs->trans("AlreadyInGeneralLedger"));
+	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
 	$varlink = 'id_journal=' . $id_journal;
 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
 	if (empty($conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT) || $conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT == '-1') {
 		print '<br>'.img_warning().' '.$langs->trans("SomeMandatoryStepsOfSetupWereNotDone");
 		print ' : '.$langs->trans("AccountancyAreaDescMisc", 4, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
 	}
 	print '<div class="tabsAction tabsActionNoBottom">';
 	if (empty($conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT) || $conf->global->SALARIES_ACCOUNTING_ACCOUNT_PAYMENT == '-1') {
 		print '<input type="button" class="butActionRefused" title="'.dol_escape_htmltag($langs->trans("SomeMandatoryStepsOfSetupWereNotDone")).'" value="' . $langs->trans("WriteBookKeeping") . '" />';

--- a/htdocs/accountancy/journal/purchasesjournal.php
+++ b/htdocs/accountancy/journal/purchasesjournal.php
@@ -590,21 +590,21 @@
 	$nomlink = '';
 	$periodlink = '';
 	$exportlink = '';
 	$builddate=dol_now();
 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
 	if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) {
 		$description .= $langs->trans("DepositsAreNotIncluded");
 	} else {
 		$description .= $langs->trans("DepositsAreIncluded");
 	}
-	$listofchoices=array('notyet'=>$langs->trans("NotYetInGeneralLedger"), 'already'=>$langs->trans("AlreadyInGeneralLedger"));
+	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
 	$varlink = 'id_journal=' . $id_journal;
 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
 	if (empty($conf->global->ACCOUNTING_ACCOUNT_SUPPLIER) || $conf->global->ACCOUNTING_ACCOUNT_SUPPLIER == '-1') {
 		print img_warning().' '.$langs->trans("SomeMandatoryStepsOfSetupWereNotDone");
 		print ' : '.$langs->trans("AccountancyAreaDescMisc", 4, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
 	}
 	print '<div class="tabsAction tabsActionNoBottom">';
 	print '<input type="button" class="butAction" name="exportcsv" value="' . $langs->trans("ExportDraftJournal") . '" onclick="launch_export();" />';
 	if (empty($conf->global->ACCOUNTING_ACCOUNT_CUSTOMER) || $conf->global->ACCOUNTING_ACCOUNT_CUSTOMER == '-1') {

--- a/htdocs/accountancy/journal/sellsjournal.php
+++ b/htdocs/accountancy/journal/sellsjournal.php
@@ -129,21 +129,21 @@
 		$vatdata = getTaxesFromId($obj->tva_tx.($obj->vat_src_code?' ('.$obj->vat_src_code.')':''), $mysoc, $mysoc, 0);
 		$compta_tva = (! empty($vatdata['accountancy_code_sell']) ? $vatdata['accountancy_code_sell'] : $cpttva);
 		$compta_localtax1 = (! empty($vatdata['accountancy_code_sell']) ? $vatdata['accountancy_code_sell'] : $cpttva);
 		$compta_localtax2 = (! empty($vatdata['accountancy_code_sell']) ? $vatdata['accountancy_code_sell'] : $cpttva);
 		if (price2num($obj->tva_tx) || ! empty($obj->vat_src_code))
 		{
 			$def_tva[$obj->rowid][$compta_tva][vatrate($obj->tva_tx).($obj->vat_src_code?' ('.$obj->vat_src_code.')':'')]=(vatrate($obj->tva_tx).($obj->vat_src_code?' ('.$obj->vat_src_code.')':''));
 		}
 		$line = new FactureLigne($db);
 		$line->fetch($obj->fdid);
-		$prev_progress = $line->get_prev_progress($obj->rowid);
+		$prev_progress = $line->get_prev_progress($obj->fdid);
 		if ($obj->type == Facture::TYPE_SITUATION) {
 			if ($obj->situation_percent == 0) {
 				$situation_ratio = 0;
 			} else {
 				$situation_ratio = ($obj->situation_percent - $prev_progress) / $obj->situation_percent;
 			}
 		} else {
 			$situation_ratio = 1;
 		}
 		$tabfac[$obj->rowid]["date"] = $db->jdate($obj->df);
@@ -518,21 +518,21 @@
 	$nom = $langs->trans("SellsJournal") . ' - ' . $accountingjournalstatic->getNomUrl(1);
 	$nomlink = '';
 	$periodlink = '';
 	$exportlink = '';
 	$builddate=dol_now();
 	$description.= $langs->trans("DescJournalOnlyBindedVisible").'<br>';
 	if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS))
 		$description .= $langs->trans("DepositsAreNotIncluded");
 	else
 		$description .= $langs->trans("DepositsAreIncluded");
-	$listofchoices=array('notyet'=>$langs->trans("NotYetInGeneralLedger"), 'already'=>$langs->trans("AlreadyInGeneralLedger"));
+	$listofchoices=array('already'=>$langs->trans("AlreadyInGeneralLedger"), 'notyet'=>$langs->trans("NotYetInGeneralLedger"));
 	$period = $form->select_date($date_start?$date_start:-1, 'date_start', 0, 0, 0, '', 1, 0, 1) . ' - ' . $form->select_date($date_end?$date_end:-1, 'date_end', 0, 0, 0, '', 1, 0, 1). ' -  ' .$langs->trans("JournalizationInLedgerStatus").' '. $form->selectarray('in_bookkeeping', $listofchoices, $in_bookkeeping, 1);
 	$varlink = 'id_journal=' . $id_journal;
 	journalHead($nom, $nomlink, $period, $periodlink, $description, $builddate, $exportlink, array('action' => ''), '', $varlink);
 	if (empty($conf->global->ACCOUNTING_ACCOUNT_CUSTOMER) || $conf->global->ACCOUNTING_ACCOUNT_CUSTOMER == '-1') {
 		print img_warning().' '.$langs->trans("SomeMandatoryStepsOfSetupWereNotDone");
 		print ' : '.$langs->trans("AccountancyAreaDescMisc", 4, '<strong>'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("MenuAccountancy").'-'.$langs->transnoentitiesnoconv("Setup")."-".$langs->transnoentitiesnoconv("MenuDefaultAccounts").'</strong>');
 	}
 	print '<div class="tabsAction tabsActionNoBottom">';
 	print '<input type="button" class="butAction" name="exportcsv" value="' . $langs->trans("ExportDraftJournal") . '" onclick="launch_export();" />';
 	if (empty($conf->global->ACCOUNTING_ACCOUNT_CUSTOMER) || $conf->global->ACCOUNTING_ACCOUNT_CUSTOMER == '-1') {

--- a/htdocs/accountancy/supplier/index.php
+++ b/htdocs/accountancy/supplier/index.php
@@ -25,44 +25,35 @@
 require '../../main.inc.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/date.lib.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
 require_once DOL_DOCUMENT_ROOT . '/fourn/class/fournisseur.facture.class.php';
 $langs->load("compta");
 $langs->load("bills");
 $langs->load("other");
 $langs->load("main");
 $langs->load("accountancy");
 if (empty($conf->accounting->enabled)) {
-	accessforbidden();
+    accessforbidden();
 }
 if ($user->societe_id > 0)
 	accessforbidden();
 if (! $user->rights->accounting->bind->write)
 	accessforbidden();
-$month_start= ($conf->global->SOCIETE_FISCAL_MONTH_START?($conf->global->SOCIETE_FISCAL_MONTH_START):1);
-if (GETPOST("year",'int')) $year_start = GETPOST("year",'int');
-else
-{
-	$year_start = dol_print_date(dol_now(), '%Y');
-	if (dol_print_date(dol_now(), '%m') < $month_start) $year_start--;	// If current month is lower that starting fiscal month, we start last year
-}
-$year_end = $year_start + 1;
-$month_end = $month_start - 1;
-if ($month_end < 1)
-{
-	$month_end = 12;
-	$year_end--;
-}
-$search_date_start = dol_mktime(0, 0, 0, $month_start, 1, $year_start);
-$search_date_end = dol_get_last_day($year_end, $month_end);
-$year_current = $year_start;
-$action = GETPOST('action','aZ09');
+$year = GETPOST("year",'int');
+if ($year == 0) {
+	$year_current = strftime("%Y", time());
+	$year_start = $year_current;
+} else {
+	$year_current = $year;
+	$year_start = $year;
+}
+$action = GETPOST('action', 'aZ09');
 /*
  * Actions
  */
 if ($action == 'validatehistory') {
 	$error = 0;
 	$db->begin();
 	$sqlclean = "UPDATE " . MAIN_DB_PREFIX . "facturedet as fd";
 	$sqlclean .= " SET fk_code_ventilation = 0";
 	$sqlclean .= ' WHERE fd.fk_code_ventilation NOT IN ';
 	$sqlclean .= '	(SELECT accnt.rowid ';
@@ -87,75 +78,92 @@
 	dol_syslog('htdocs/accountancy/supplier/index.php');
 	$resql1 = $db->query($sql1);
 	if (! $resql1) {
 		$error ++;
 		$db->rollback();
 		setEventMessages($db->lasterror(), null, 'errors');
 	} else {
 		$db->commit();
 		setEventMessages($langs->trans('AutomaticBindingDone'), null, 'mesgs');
 	}
+} elseif ($action == 'cleanaccountancycode') {
+	$error = 0;
+	$db->begin();
+	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as fd";
+	$sql1.= " SET fk_code_ventilation = 0";
+	$sql1.= " WHERE fd.fk_facture_fourn IN ( SELECT f.rowid FROM " . MAIN_DB_PREFIX . "facture_fourn as f";
+	$sql1.= " WHERE f.datef >= '" . $db->idate(dol_get_first_day($year_current, 1, false)) . "'";
+	$sql1.= " AND f.datef <= '" . $db->idate(dol_get_last_day($year_current, 12, false)) . "'";
+	$sql1.= " AND f.entity IN (" . getEntity('accountancy') . ")";
+	$sql1.= ")";
+	dol_syslog("htdocs/accountancy/customer/index.php cleanaccountancycode", LOG_DEBUG);
+	$resql1 = $db->query($sql1);
+	if (! $resql1) {
+		$error ++;
+		$db->rollback();
+		setEventMessage($db->lasterror(), 'errors');
+	} else {
+		$db->commit();
+		setEventMessage($langs->trans('Done'), 'mesgs');
+	}
 }
 /*
  * View
  */
 llxHeader('', $langs->trans("SuppliersVentilation"));
 $textprevyear = '<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current - 1) . '">' . img_previous() . '</a>';
 $textnextyear = '&nbsp;<a href="' . $_SERVER["PHP_SELF"] . '?year=' . ($year_current + 1) . '">' . img_next() . '</a>';
 print load_fiche_titre($langs->trans("SuppliersVentilation") . " " . $textprevyear . "&nbsp;" . $langs->trans("Year") . "&nbsp;" . $year_start . "&nbsp;" . $textnextyear, '', 'title_accountancy');
+print $langs->trans("DescVentilSupplier") . '<br>';
+print $langs->trans("DescVentilMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
+print '<br>';
 $db->begin();
 $sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as fd";
 $sql1 .= " SET fk_code_ventilation = 0";
 $sql1 .= ' WHERE fd.fk_code_ventilation NOT IN ';
 $sql1 .= '	(SELECT accnt.rowid ';
 $sql1 .= '	FROM ' . MAIN_DB_PREFIX . 'accounting_account as accnt';
 $sql1 .= '	INNER JOIN ' . MAIN_DB_PREFIX . 'accounting_system as syst';
 $sql1 .= '	ON accnt.fk_pcg_version = syst.pcg_version AND syst.rowid=' . $conf->global->CHARTOFACCOUNTS . ')';
 dol_syslog("htdocs/accountancy/customer/index.php fixaccountancycode", LOG_DEBUG);
 $resql1 = $db->query($sql1);
 if (! $resql1) {
 	$error ++;
 	$db->rollback();
 	setEventMessage($db->lasterror(), 'errors');
 } else {
 	$db->commit();
 }
-print $langs->trans("DescVentilSupplier") . '<br>';
-print $langs->trans("DescVentilMore", $langs->transnoentitiesnoconv("ValidateHistory"), $langs->transnoentitiesnoconv("ToBind")) . '<br>';
-print '<br>';
 $y = $year_current;
 $buttonbind = '<a class="butAction" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=validatehistory">' . $langs->trans("ValidateHistory") . '</a>';
+$buttonreset = '<a class="butActionDelete" href="' . $_SERVER['PHP_SELF'] . '?year=' . $year_current . '&action=cleanaccountancycode">' . $langs->trans("CleanHistory", $year_current) . '</a>';
 print_fiche_titre($langs->trans("OverviewOfAmountOfLinesNotBound"), $buttonbind, '');
 print '<div class="div-table-responsive-no-min">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
 print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 }
 print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
 $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	$sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $j, 'ffd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+	$sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $i, 'ffd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 }
 $sql .= "  SUM(ffd.total_ht) as total";
 $sql .= " FROM " . MAIN_DB_PREFIX . "facture_fourn_det as ffd";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture_fourn as ff ON ff.rowid = ffd.fk_facture_fourn";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = ffd.fk_code_ventilation";
-$sql .= " WHERE ff.datef >= '" . $db->idate($search_date_start) . "'";
-$sql .= "  AND ff.datef <= '" . $db->idate($search_date_end) . "'";
-$sql .= "  AND ff.fk_statut > 0";
+$sql .= " WHERE ff.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+$sql .= "  AND ff.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
+$sql .= "  AND ff.fk_statut > 0 ";
 $sql .= " AND ff.entity IN (" . getEntity('facture_fourn', 0) . ")";     // We don't share object for accountancy
 $sql .= " AND aa.account_number IS NULL";
 $sql .= " GROUP BY ffd.fk_code_ventilation,aa.account_number,aa.label";
 dol_syslog('htdocs/accountancy/supplier/index.php');
 $resql = $db->query($sql);
 if ($resql) {
 	$num = $db->num_rows($resql);
 	while ( $row = $db->fetch_row($resql)) {
 		print '<tr class="oddeven"><td>';
 		if ($row[0] == 'tobind')
@@ -178,45 +186,41 @@
 		print '<td align="right"><b>' . price($row[14]) . '</b></td>';
 		print '</tr>';
 	}
 	$db->free($resql);
 } else {
 	print $db->lasterror(); // Show last sql error
 }
 print "</table>\n";
 print '</div>';
 print '<br>';
-print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), '', '');
+print_fiche_titre($langs->trans("OverviewOfAmountOfLinesBound"), $buttonreset, '');
 print '<div class="div-table-responsive-no-min">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre"><td width="200">' . $langs->trans("Account") . '</td>';
 print '<td width="200" align="left">' . $langs->trans("Label") . '</td>';
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+    print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
 }
 print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
 $sql = "SELECT  ".$db->ifsql('aa.account_number IS NULL', "'tobind'", 'aa.account_number') ." AS codecomptable,";
 $sql .= "  " . $db->ifsql('aa.label IS NULL', "'tobind'", 'aa.label') . " AS intitule,";
 for($i = 1; $i <= 12; $i ++) {
-	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-	if ($j > 12) $j-=12;
-	$sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $j, 'ffd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+    $sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $i, 'ffd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
 }
 $sql .= "  SUM(ffd.total_ht) as total";
 $sql .= " FROM " . MAIN_DB_PREFIX . "facture_fourn_det as ffd";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture_fourn as ff ON ff.rowid = ffd.fk_facture_fourn";
 $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "accounting_account as aa ON aa.rowid = ffd.fk_code_ventilation";
-$sql .= " WHERE ff.datef >= '" . $db->idate($search_date_start) . "'";
-$sql .= "  AND ff.datef <= '" . $db->idate($search_date_end) . "'";
-$sql .= "  AND ff.fk_statut > 0";
+$sql .= " WHERE ff.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+$sql .= "  AND ff.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
+$sql .= "  AND ff.fk_statut > 0 ";
 $sql .= " AND ff.entity IN (" . getEntity('facture_fourn', 0) . ")";     // We don't share object for accountancy
 $sql .= " AND aa.account_number IS NOT NULL";
 $sql .= " GROUP BY ffd.fk_code_ventilation,aa.account_number,aa.label";
 dol_syslog('htdocs/accountancy/supplier/index.php');
 $resql = $db->query($sql);
 if ($resql) {
     $num = $db->num_rows($resql);
     while ( $row = $db->fetch_row($resql)) {
 		print '<tr class="oddeven"><td>';
 		if ($row[0] == 'tobind')
@@ -225,21 +229,21 @@
 		}
 		else print length_accountg($row[0]);
 		print '</td>';
 		print '<td align="left">';
 		if ($row[0] == 'tobind')
 		{
 			print $langs->trans("UseMenuToSetBindindManualy", DOL_URL_ROOT.'/accountancy/supplier/list.php?search_year='.$y, $langs->transnoentitiesnoconv("ToBind"));
 		}
 		else print $row[1];
 		print '</td>';
-    	for($i = 2; $i <= 12; $i++) {
+    	for($i = 2; $i <= 12; $i ++) {
             print '<td align="right">' . price($row[$i]) . '</td>';
         }
         print '<td align="right">' . price($row[13]) . '</td>';
         print '<td align="right"><b>' . price($row[14]) . '</b></td>';
         print '</tr>';
     }
     $db->free($resql);
 } else {
     print $db->lasterror(); // Show last sql error
 }
@@ -247,43 +251,39 @@
 print '</div>';
 if ($conf->global->MAIN_FEATURES_LEVEL > 0) // This part of code looks strange. Why showing a report that should rely on result of this step ?
 {
     print '<br>';
     print '<br>';
     print_fiche_titre($langs->trans("OtherInfo"), '', '');
 	print '<div class="div-table-responsive-no-min">';
     print '<table class="noborder" width="100%">';
     print '<tr class="liste_titre"><td width="400" align="left">' . $langs->trans("Total") . '</td>';
     for($i = 1; $i <= 12; $i ++) {
-    	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-    	if ($j > 12) $j-=12;
-    	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($j, 2, '0', STR_PAD_LEFT)) . '</td>';
+    	print '<td width="60" align="right">' . $langs->trans('MonthShort' . str_pad($i, 2, '0', STR_PAD_LEFT)) . '</td>';
     }
     print '<td width="60" align="right"><b>' . $langs->trans("Total") . '</b></td></tr>';
     $sql = "SELECT '" . $langs->trans("CAHTF") . "' AS label,";
     for($i = 1; $i <= 12; $i ++) {
-    	$j = $i + ($conf->global->SOCIETE_FISCAL_MONTH_START?$conf->global->SOCIETE_FISCAL_MONTH_START:1) - 1;
-    	if ($j > 12) $j-=12;
-    	$sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $j, 'ffd.total_ht', '0') . ") AS month" . str_pad($j, 2, '0', STR_PAD_LEFT) . ",";
+    	$sql .= "  SUM(" . $db->ifsql('MONTH(ff.datef)=' . $i, 'ffd.total_ht', '0') . ") AS month" . str_pad($i, 2, '0', STR_PAD_LEFT) . ",";
     }
     $sql .= "  SUM(ffd.total_ht) as total";
     $sql .= " FROM " . MAIN_DB_PREFIX . "facture_fourn_det as ffd";
     $sql .= "  LEFT JOIN " . MAIN_DB_PREFIX . "facture_fourn as ff ON ff.rowid = ffd.fk_facture_fourn";
-    $sql .= " WHERE ff.datef >= '" . $db->idate($search_date_start) . "'";
-    $sql .= "  AND ff.datef <= '" . $db->idate($search_date_end) . "'";
-    $sql .= "  AND ff.fk_statut > 0";
+    $sql .= " WHERE ff.datef >= '" . $db->idate(dol_get_first_day($y, 1, false)) . "'";
+    $sql .= "  AND ff.datef <= '" . $db->idate(dol_get_last_day($y, 12, false)) . "'";
+    $sql .= "  AND ff.fk_statut > 0 ";
     $sql .= " AND ff.entity IN (" . getEntity('facture_fourn', 0) . ")";     // We don't share object for accountancy
     dol_syslog('htdocs/accountancy/supplier/index.php');
     $resql = $db->query($sql);
     if ($resql) {
     	$num = $db->num_rows($resql);
-    	while ($row = $db->fetch_row($resql)) {
+    	while ( $row = $db->fetch_row($resql)) {
     		print '<tr><td>' . $row[0] . '</td>';
     			for($i = 1; $i <= 12; $i ++) {
     			print '<td align="right">' . price($row[$i]) . '</td>';
     		}
     		print '<td align="right"><b>' . price($row[13]) . '</b></td>';
     		print '</tr>';
     	}
     	$db->free($resql);
     } else {
     	print $db->lasterror(); // Show last sql error

--- a/htdocs/accountancy/supplier/lines.php
+++ b/htdocs/accountancy/supplier/lines.php
@@ -86,46 +86,38 @@
 	$search_account = '';
 	$search_vat = '';
 	$search_day = '';
 	$search_month = '';
 	$search_year = '';
 	$search_country = '';
 	$search_tvaintra = '';
 }
 if (is_array($changeaccount) && count($changeaccount) > 0) {
 	$error = 0;
-	if (! (GETPOST('account_parent','int') >= 0))
-	{
-		$error++;
-		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Account")), null, 'errors');
+	$db->begin();
+	$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as l";
+	$sql1 .= " SET l.fk_code_ventilation=" . GETPOST('account_parent','int');
+	$sql1 .= ' WHERE l.rowid IN (' . implode(',', $changeaccount) . ')';
+	dol_syslog('accountancy/supplier/lines.php::changeaccount sql= ' . $sql1);
+	$resql1 = $db->query($sql1);
+	if (! $resql1) {
+		$error ++;
+		setEventMessages($db->lasterror(), null, 'errors');
 	}
-	$db->begin();
-	if (! $error)
-	{
-		$sql1 = "UPDATE " . MAIN_DB_PREFIX . "facture_fourn_det as l";
-		$sql1 .= " SET l.fk_code_ventilation=" . (GETPOST('account_parent','int') > 0 ? GETPOST('account_parent','int') : '0');
-		$sql1 .= ' WHERE l.rowid IN (' . implode(',', $changeaccount) . ')';
-		dol_syslog('accountancy/supplier/lines.php::changeaccount sql= ' . $sql1);
-		$resql1 = $db->query($sql1);
-		if (! $resql1) {
-			$error ++;
-			setEventMessages($db->lasterror(), null, 'errors');
-		}
-		if (! $error) {
-			$db->commit();
-			setEventMessages($langs->trans('Save'), null, 'mesgs');
-		} else {
-			$db->rollback();
-			setEventMessages($db->lasterror(), null, 'errors');
-		}
-		$account_parent = '';   // Protection to avoid to mass apply it a second time
+	if (! $error) {
+		$db->commit();
+		setEventMessages($langs->trans('Save'), null, 'mesgs');
+	} else {
+		$db->rollback();
+		setEventMessages($db->lasterror(), null, 'errors');
 	}
+	$account_parent = '';   // Protection to avoid to mass apply it a second time
 }
 /*
  * View
  */
 $form = new Form($db);
 $formother = new FormOther($db);
 llxHeader('', $langs->trans("SuppliersVentilation") . ' - ' . $langs->trans("Dispatched"));
 print '<script type="text/javascript">
 			$(function () {
 				$(\'#select-all\').click(function(event) {
@@ -230,21 +222,21 @@
 	print '<input type="hidden" name="action" value="ventil">';
 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
 	print '<input type="hidden" name="page" value="'.$page.'">';
 	print_barre_liste($langs->trans("InvoiceLinesDone"), $page, $_SERVER["PHP_SELF"], $param, $sortfield, $sortorder, '', $num_lines, $nbtotalofrecords, 'title_accountancy', 0, '', '', $limit);
 	print $langs->trans("DescVentilDoneSupplier") . '<br>';
 	print '<br><div class="inline-block divButAction">' . $langs->trans("ChangeAccount") . '<br>';
-	print $formaccounting->select_account($account_parent, 'account_parent', 2, array(), 0, 0, 'maxwidth300 maxwidthonsmartphone valignmiddle');
+	print $formaccounting->select_account($account_parent, 'account_parent', 1);
 	print '<input type="submit" class="button valignmiddle" value="' . $langs->trans("ChangeBinding") . '" /></div>';
 	$moreforfilter = '';
     print '<div class="div-table-responsive">';
 	print '<table class="tagtable liste'.($moreforfilter?" listwithfilterbefore":"").'">'."\n";
 	print '<tr class="liste_titre_filter">';
 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_lineid" value="' . dol_escape_htmltag($search_lineid) . '""></td>';
 	print '<td class="liste_titre"><input type="text" class="flat maxwidth50" name="search_invoice" value="' . dol_escape_htmltag($search_invoice) . '"></td>';
 	print '<td class="liste_titre"></td>';
 	print '<td class="liste_titre center">';
    	if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day" value="'.$search_day.'">';

--- a/htdocs/adherents/cartes/carte.php
+++ b/htdocs/adherents/cartes/carte.php
@@ -20,30 +20,31 @@
  *	\file 		htdocs/adherents/cartes/carte.php
  *	\ingroup    member
  *	\brief      Page to output members business cards
  */
 require '../../main.inc.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/format_cards.lib.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
 require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';
 require_once DOL_DOCUMENT_ROOT.'/core/modules/member/modules_cards.php';
 require_once DOL_DOCUMENT_ROOT.'/core/modules/printsheet/modules_labels.php';
-$langs->loadLangs(array("members","errors"));
+$langs->load("members");
+$langs->load("errors");
 $now = dol_now();
 $year=dol_print_date($now,'%Y');
 $month=dol_print_date($now,'%m');
 $day=dol_print_date($now,'%d');
-$foruserid=GETPOST('foruserid','alphanohtml');
-$foruserlogin=GETPOST('foruserlogin','alphanohtml');
-$mode=GETPOST('mode','aZ09');
-$model=GETPOST("model",'aZ09');				// Doc template to use for business cards
-$modellabel=GETPOST("modellabel",'aZ09');	// Doc template to use for address sheet
+$foruserid=GETPOST('foruserid');
+$foruserlogin=GETPOST('foruserlogin');
+$mode=GETPOST('mode');
+$model=GETPOST("model");			// Doc template to use for business cards
+$modellabel=GETPOST("modellabel");	// Doc template to use for address sheet
 $mesg='';
 $adherentstatic=new Adherent($db);
 $extrafields = new ExtraFields($db);
 $extralabels = $extrafields->fetch_name_optionals_label('adherent');
 /*
  * Actions
  */
 if ($mode == 'cardlogin' && empty($foruserlogin))
 {
     $mesg=$langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("Login"));

--- a/htdocs/adherents/list.php
+++ b/htdocs/adherents/list.php
@@ -29,21 +29,21 @@
 require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent_type.class.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/company.lib.php';
 $langs->loadLangs(array("members","companies"));
 $action=GETPOST('action','aZ09');
 $massaction=GETPOST('massaction','alpha');
 $show_files=GETPOST('show_files','int');
 $confirm=GETPOST('confirm','alpha');
 $toselect = GETPOST('toselect', 'array');
 $result=restrictedArea($user,'adherent');
 $filter=GETPOST("filter",'alpha');
-$statut=GETPOST("statut",'intcomma');
+$statut=GETPOST("statut",'alpha');
 $search=GETPOST("search",'alpha');
 $search_ref=GETPOST("search_ref",'alpha');
 $search_lastname=GETPOST("search_lastname",'alpha');
 $search_firstname=GETPOST("search_firstname",'alpha');
 $search_login=GETPOST("search_login",'alpha');
 $search_address=GETPOST("search_address",'alpha');
 $search_zip=GETPOST("search_zip",'alpha');
 $search_town=GETPOST("search_town",'alpha');
 $search_state=GETPOST("search_state",'alpha');
 $search_country=GETPOST("search_country",'alpha');

--- a/htdocs/admin/agenda.php
+++ b/htdocs/admin/agenda.php
@@ -55,25 +55,20 @@
 else
 {
 	dol_print_error($db);
 }
 /*
  *	Actions
  */
 if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') ||GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
 {
 	$search_event = '';
-	$action = '';
-}
-if (GETPOST('button_search_x','alpha') || GETPOST('button_search.x','alpha') ||GETPOST('button_search','alpha'))	// To avoid the save when we click on search
-{
-	$action = '';
 }
 if ($action == "save" && empty($cancel))
 {
     $i=0;
     $db->begin();
 	foreach ($triggers as $trigger)
 	{
 		$keyparam='MAIN_AGENDA_ACTIONAUTO_'.$trigger['code'];
 		if ($search_event === '' || preg_match('/'.preg_quote($search_event,'/').'/i', $keyparam))
 		{
@@ -84,20 +79,47 @@
  	if (! $error)
     {
         setEventMessages($langs->trans("SetupSaved"), null, 'mesgs');
         $db->commit();
     }
     else
     {
         setEventMessages($langs->trans("Error"),null, 'errors');
         $db->rollback();
     }
+}
+if (preg_match('/set_(.*)/',$action,$reg))
+{
+	$code=$reg[1];
+	$value=(GETPOST($code) ? GETPOST($code) : 1);
+	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
+	{
+		Header("Location: ".$_SERVER["PHP_SELF"]);
+		exit;
+	}
+	else
+	{
+		dol_print_error($db);
+	}
+}
+if (preg_match('/del_(.*)/',$action,$reg))
+{
+	$code=$reg[1];
+	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
+	{
+		Header("Location: ".$_SERVER["PHP_SELF"]);
+		exit;
+	}
+	else
+	{
+		dol_print_error($db);
+	}
 }
 /**
  * View
  */
 $wikihelp='EN:Module_Agenda_En|FR:Module_Agenda|ES:Mdulo_Agenda';
 llxHeader('', $langs->trans("AgendaSetup"), $wikihelp);
 $linkback='<a href="'.DOL_URL_ROOT.'/admin/modules.php?restore_lastsearch_values=1">'.$langs->trans("BackToModuleList").'</a>';
 print load_fiche_titre($langs->trans("AgendaSetup"),$linkback,'title_setup');
 print '<form action="'.$_SERVER["PHP_SELF"].'" method="POST">';
 print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';

--- a/htdocs/admin/agenda_other.php
+++ b/htdocs/admin/agenda_other.php
@@ -36,35 +36,35 @@
 $action = GETPOST('action','alpha');
 $value = GETPOST('value','alpha');
 $param = GETPOST('param','alpha');
 $cancel = GETPOST('cancel','alpha');
 $scandir = GETPOST('scan_dir','alpha');
 $type = 'action';
 /*
  *	Actions
  */
 include DOL_DOCUMENT_ROOT.'/core/actions_setmoduleoptions.inc.php';
-if (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/set_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
-	$value=(GETPOST($code, 'alpha') ? GETPOST($code, 'alpha') : 1);
+	$value=(GETPOST($code) ? GETPOST($code) : 1);
 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
 	{
 		Header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 }
-if (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/del_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
 	{
 		Header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);

--- a/htdocs/admin/agenda_reminder.php
+++ b/htdocs/admin/agenda_reminder.php
@@ -31,35 +31,35 @@
 $action = GETPOST('action','alpha');
 $value = GETPOST('value','alpha');
 $param = GETPOST('param','alpha');
 $cancel = GETPOST('cancel','alpha');
 $scandir = GETPOST('scandir','alpha');
 $type = 'action';
 /*
  *	Actions
  */
 include DOL_DOCUMENT_ROOT.'/core/actions_setmoduleoptions.inc.php';
-if (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/set_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
-	$value=(GETPOST($code, 'alpha') ? GETPOST($code, 'alpha') : 1);
+	$value=(GETPOST($code) ? GETPOST($code) : 1);
 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
 	{
 		Header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 }
-if (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/del_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
 	{
 		Header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);

--- a/htdocs/admin/company.php
+++ b/htdocs/admin/company.php
@@ -57,21 +57,21 @@
 		$mysoc->country_label=$tmparray['label'];
 		$s=$mysoc->country_id.':'.$mysoc->country_code.':'.$mysoc->country_label;
 		dolibarr_set_const($db, "MAIN_INFO_SOCIETE_COUNTRY", $s,'chaine',0,'',$conf->entity);
 		activateModulesRequiredByCountry($mysoc->country_code);
 	}
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_NOM", GETPOST("nom",'nohtml'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_ADDRESS", GETPOST("address",'nohtml'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_TOWN", GETPOST("town",'nohtml'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_ZIP", GETPOST("zipcode",'alpha'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_STATE", GETPOST("state_id",'alpha'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_MONNAIE", GETPOST("currency",'aZ09'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_MONNAIE", GETPOST("currency",'alpha'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_TEL", GETPOST("tel",'alpha'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_FAX", GETPOST("fax",'alpha'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_MAIL", GETPOST("mail",'alpha'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_WEB", GETPOST("web",'alpha'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_NOTE", GETPOST("note",'none'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_GENCOD", GETPOST("barcode",'alpha'),'chaine',0,'',$conf->entity);
 	$varforimage='logo'; $dirforimage=$conf->mycompany->dir_output.'/logos/';
 	if ($_FILES[$varforimage]["tmp_name"])
 	{
 		if (preg_match('/([^\\/:]+)$/i',$_FILES[$varforimage]["name"],$reg))
@@ -122,58 +122,58 @@
 				}
 			}
 			else
 			{
 				$error++;
 				$langs->load("errors");
 				setEventMessages($langs->trans("ErrorBadImageFormat"), null, 'errors');
 			}
 		}
 	}
-	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_MANAGERS", GETPOST("MAIN_INFO_SOCIETE_MANAGERS",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_CAPITAL", GETPOST("capital",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_FORME_JURIDIQUE", GETPOST("forme_juridique_code",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_SIREN", GETPOST("siren",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_SIRET", GETPOST("siret",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_APE", GETPOST("ape",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_RCS", GETPOST("rcs",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_PROFID5", GETPOST("MAIN_INFO_PROFID5",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_PROFID6", GETPOST("MAIN_INFO_PROFID6",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "MAIN_INFO_TVAINTRA", GETPOST("tva",'nohtml'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_MANAGERS", GETPOST("MAIN_INFO_SOCIETE_MANAGERS",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_CAPITAL", GETPOST("capital",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_FORME_JURIDIQUE", GETPOST("forme_juridique_code",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_SIREN", GETPOST("siren",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_SIRET", GETPOST("siret",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_APE", GETPOST("ape",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_RCS", GETPOST("rcs",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_PROFID5", GETPOST("MAIN_INFO_PROFID5",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_PROFID6", GETPOST("MAIN_INFO_PROFID6",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "MAIN_INFO_TVAINTRA", GETPOST("tva",'alpha'),'chaine',0,'',$conf->entity);
 	dolibarr_set_const($db, "MAIN_INFO_SOCIETE_OBJECT", GETPOST("object",'nohtml'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "SOCIETE_FISCAL_MONTH_START", GETPOST("SOCIETE_FISCAL_MONTH_START",'int'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "FACTURE_TVAOPTION", GETPOST("optiontva",'aZ09'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "FACTURE_LOCAL_TAX1_OPTION", GETPOST("optionlocaltax1",'aZ09'),'chaine',0,'',$conf->entity);
-	dolibarr_set_const($db, "FACTURE_LOCAL_TAX2_OPTION", GETPOST("optionlocaltax2",'aZ09'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "SOCIETE_FISCAL_MONTH_START", GETPOST("SOCIETE_FISCAL_MONTH_START",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "FACTURE_TVAOPTION", GETPOST("optiontva",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "FACTURE_LOCAL_TAX1_OPTION", GETPOST("optionlocaltax1",'alpha'),'chaine',0,'',$conf->entity);
+	dolibarr_set_const($db, "FACTURE_LOCAL_TAX2_OPTION", GETPOST("optionlocaltax2",'alpha'),'chaine',0,'',$conf->entity);
 	if($_POST["optionlocaltax1"]=="localtax1on")
 	{
 		if(!isset($_REQUEST['lt1']))
 		{
 			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX1", 0,'chaine',0,'',$conf->entity);
 		}
 		else
 		{
-			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX1", GETPOST('lt1','aZ09'),'chaine',0,'',$conf->entity);
-		}
-		dolibarr_set_const($db,"MAIN_INFO_LOCALTAX_CALC1",  GETPOST("clt1",'aZ09'),'chaine',0,'',$conf->entity);
+			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX1", GETPOST('lt1','alpha'),'chaine',0,'',$conf->entity);
+		}
+		dolibarr_set_const($db,"MAIN_INFO_LOCALTAX_CALC1",  GETPOST("clt1",'alpha'),'chaine',0,'',$conf->entity);
 	}
 	if($_POST["optionlocaltax2"]=="localtax2on")
 	{
 		if(!isset($_REQUEST['lt2']))
 		{
 			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX2", 0,'chaine',0,'',$conf->entity);
 		}
 		else
 		{
-			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX2", GETPOST('lt2','aZ09'),'chaine',0,'',$conf->entity);
-		}
-		dolibarr_set_const($db,"MAIN_INFO_LOCALTAX_CALC2",  GETPOST("clt2",'aZ09'),'chaine',0,'',$conf->entity);
+			dolibarr_set_const($db, "MAIN_INFO_VALUE_LOCALTAX2", GETPOST('lt2','alpha'),'chaine',0,'',$conf->entity);
+		}
+		dolibarr_set_const($db,"MAIN_INFO_LOCALTAX_CALC2",  GETPOST("clt2",'alpha'),'chaine',0,'',$conf->entity);
 	}
 	if ($action != 'updateedit' && ! $error)
 	{
 		header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 }
 if ($action == 'addthumb')  // Regenerate thumbs
 {
 	if (file_exists($conf->mycompany->dir_output.'/logos/'.$_GET["file"]))
@@ -309,21 +309,21 @@
 		print '<img height="30" src="'.DOL_URL_ROOT.'/public/theme/common/nophoto.png">';
 	}
 	print '</td></tr></table>';
 	print '</td></tr>';
 	print '<tr class="oddeven"><td class="tdtop"><label for="note">'.$langs->trans("Note").'</label></td><td>';
 	print '<textarea class="flat quatrevingtpercent" name="note" id="note" rows="'.ROWS_5.'">'.(GETPOST('note','none') ? GETPOST('note','none') : $conf->global->MAIN_INFO_SOCIETE_NOTE).'</textarea></td></tr>';
 	print '</td></tr>';
 	print '</table>';
 	print '<br>';
 	print '<table class="noborder" width="100%">';
-	print '<tr class="liste_titre"><td class="titlefield">'.$langs->trans("CompanyIds").'</td><td>'.$langs->trans("Value").'</td></tr>';
+	print '<tr class="liste_titre"><td>'.$langs->trans("CompanyIds").'</td><td>'.$langs->trans("Value").'</td></tr>';
 	$langs->load("companies");
 	print '<tr class="oddeven"><td><label for="director">'.$langs->trans("ManagingDirectors").'</label></td><td>';
 	print '<input name="MAIN_INFO_SOCIETE_MANAGERS" id="director" class="minwidth200" value="' . $conf->global->MAIN_INFO_SOCIETE_MANAGERS . '"></td></tr>';
 	print '<tr class="oddeven"><td><label for="capital">'.$langs->trans("Capital").'</label></td><td>';
 	print '<input name="capital" id="capital" class="minwidth100" value="' . $conf->global->MAIN_INFO_CAPITAL . '"></td></tr>';
 	print '<tr class="oddeven"><td><label for="forme_juridique_code">'.$langs->trans("JuridicalStatus").'</label></td><td>';
 	if ($mysoc->country_code) {
 		print $formcompany->select_juridicalstatus($conf->global->MAIN_INFO_SOCIETE_FORME_JURIDIQUE, $mysoc->country_code, '', 'forme_juridique_code');
 	} else {
 		print $countrynotdefined;
@@ -418,21 +418,21 @@
 	print '<table class="noborder" width="100%">';
 	print '<tr class="liste_titre">';
 	print '<td class="titlefield">'.$langs->trans("FiscalYearInformation").'</td><td>'.$langs->trans("Value").'</td>';
 	print "</tr>\n";
 	print '<tr class="oddeven"><td><label for="SOCIETE_FISCAL_MONTH_START">'.$langs->trans("FiscalMonthStart").'</label></td><td>';
 	print $formother->select_month($conf->global->SOCIETE_FISCAL_MONTH_START,'SOCIETE_FISCAL_MONTH_START',0,1) . '</td></tr>';
 	print "</table>";
 	print '<br>';
 	print '<table class="noborder" width="100%">';
 	print '<tr class="liste_titre">';
-	print '<td width="140">'.$langs->trans("VATManagement").'</td><td>'.$langs->trans("Description").'</td>';
+	print '<td class="titlefield">'.$langs->trans("VATManagement").'</td><td>'.$langs->trans("Description").'</td>';
 	print '<td align="right">&nbsp;</td>';
 	print "</tr>\n";
 	print "<tr class=\"oddeven\"><td width=\"140\"><label><input type=\"radio\" name=\"optiontva\" id=\"use_vat\" value=\"1\"".(empty($conf->global->FACTURE_TVAOPTION)?"":" checked")."> ".$langs->trans("VATIsUsed")."</label></td>";
 	print '<td colspan="2">';
 	print "<table>";
 	print "<tr><td><label for=\"use_vat\">".$langs->trans("VATIsUsedDesc")."</label></td></tr>";
 	print "<tr><td><i>".$langs->trans("Example").': '.$langs->trans("VATIsUsedExampleFR")."</i></td></tr>\n";
 	print "</table>";
 	print "</td></tr>\n";
 	print "<tr class=\"oddeven\"><td width=\"140\"><label><input type=\"radio\" name=\"optiontva\" id=\"no_vat\" value=\"0\"".(empty($conf->global->FACTURE_TVAOPTION)?" checked":"")."> ".$langs->trans("VATIsNotUsed")."</label></td>";
@@ -444,21 +444,21 @@
 	print "</td></tr>\n";
 	print "</table>";
 	/*
 	 *  Local Taxes
 	 */
 	if ($mysoc->useLocalTax(1))
 	{
 		print '<br>';
 		print '<table class="noborder" width="100%">';
 		print '<tr class="liste_titre">';
-		print '<td width="140">'.$langs->transcountry("LocalTax1Management",$mysoc->country_code).'</td><td>'.$langs->trans("Description").'</td>';
+		print '<td>'.$langs->transcountry("LocalTax1Management",$mysoc->country_code).'</td><td>'.$langs->trans("Description").'</td>';
 		print '<td align="right">&nbsp;</td>';
 		print "</tr>\n";
 		print "<tr class=\"oddeven\"><td width=\"140\"><input type=\"radio\" name=\"optionlocaltax1\" id=\"lt1\" value=\"localtax1on\"".(($conf->global->FACTURE_LOCAL_TAX1_OPTION == '1' || $conf->global->FACTURE_LOCAL_TAX1_OPTION == "localtax1on")?" checked":"")."> ".$langs->transcountry("LocalTax1IsUsed",$mysoc->country_code)."</td>";
 		print '<td colspan="2">';
 		print '<table class="nobordernopadding">';
 		print "<tr><td><label for=\"lt1\">".$langs->transcountry("LocalTax1IsUsedDesc",$mysoc->country_code)."</label></td></tr>";
 		$example=$langs->transcountry("LocalTax1IsUsedExample",$mysoc->country_code);
 		print ($example!="LocalTax1IsUsedExample"?"<tr><td><i>".$langs->trans("Example").': '.$langs->transcountry("LocalTax1IsUsedExample",$mysoc->country_code)."</i></td></tr>\n":"");
 		if(! isOnlyOneLocalTax(1))
 		{

--- a/htdocs/admin/dict.php
+++ b/htdocs/admin/dict.php
@@ -806,49 +806,49 @@
     $titre=$langs->trans("MenuTaxAccounts");
     $titlepicto='title_accountancy';
 }
 print load_fiche_titre($titre,$linkback,$titlepicto);
 if (empty($id))
 {
     print $langs->trans("DictionaryDesc");
     print " ".$langs->trans("OnlyActiveElementsAreShown")."<br>\n";
 }
 print "<br>\n";
-$param = '&id='.urlencode($id);
-if ($search_country_id > 0) $param.= '&search_country_id='.urlencode($search_country_id);
+$param = '&id='.$id;
+if ($search_country_id > 0) $param.= '&search_country_id='.$search_country_id;
 if ($search_code != '')     $param.= '&search_code='.urlencode($search_country_id);
 if ($entity != '') $param.= '&entity=' . (int) $entity;
 $paramwithsearch = $param;
-if ($sortorder) $paramwithsearch.= '&sortorder='.urlencode($sortorder);
-if ($sortfield) $paramwithsearch.= '&sortfield='.urlencode($sortfield);
-if (GETPOST('from')) $paramwithsearch.= '&from='.urlencode(GETPOST('from','alpha'));
+if ($sortorder) $paramwithsearch.= '&sortorder='.$sortorder;
+if ($sortfield) $paramwithsearch.= '&sortfield='.$sortfield;
+if (GETPOST('from')) $paramwithsearch.= '&from='.GETPOST('from','alpha');
 if ($action == 'delete')
 {
     print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'rowid='.$rowid.'&code='.urlencode($code).$paramwithsearch, $langs->trans('DeleteLine'), $langs->trans('ConfirmDeleteLine'), 'confirm_delete','',0,1);
 }
 /*
  * Show a dictionary
  */
 if ($id)
 {
     $sql=$tabsql[$id];
     if (! preg_match('/ WHERE /',$sql)) $sql.= " WHERE 1 = 1";
     if ($search_country_id > 0) $sql.= " AND c.rowid = ".$search_country_id;
     if ($search_code != '' && $id != 9)     $sql.= natural_search("code", $search_code);
     if ($search_code != '' && $id == 9)     $sql.= natural_search("code_iso", $search_code);
     if ($sortfield)
     {
     	if ($sortfield == 'country') $sortfield='country_code';
-        $sql.= " ORDER BY ".$db->escape($sortfield);
+        $sql.= " ORDER BY ".$sortfield;
         if ($sortorder)
         {
-        	$sql.=" ".strtoupper($db->escape($sortorder));
+            $sql.=" ".strtoupper($sortorder);
         }
         $sql.=", ";
         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
         $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
     }
     else {
         $sql.=" ORDER BY ";
     }
     $sql.=$tabsqlsort[$id];
     $sql.=$db->plimit($listlimit+1,$offset);

--- a/htdocs/admin/ecm.php
+++ b/htdocs/admin/ecm.php
@@ -20,34 +20,34 @@
  *		\ingroup    core
  *		\brief      Page to setup ECM (GED) module
  */
 require '../main.inc.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/admin.lib.php';
 $langs->load("admin");
 if (! $user->admin) accessforbidden();
 /*
  * Action
  */
-if (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/set_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
         dol_print_error($db);
     }
 }
-if (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/del_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
         dol_print_error($db);

--- a/htdocs/admin/mails_templates.php
+++ b/htdocs/admin/mails_templates.php
@@ -41,21 +41,22 @@
 $langs->loadLangs(array("errors","admin","mails","languages"));
 $action     = GETPOST('action','alpha')?GETPOST('action','alpha'):'view';
 $confirm    = GETPOST('confirm','alpha');												// Result of a confirmation
 $id			= GETPOST('id','int');
 $rowid		= GETPOST('rowid','alpha');
 $search_label=GETPOST('search_label','alpha');
 $search_type_template=GETPOST('search_type_template','alpha');
 $search_lang=GETPOST('search_lang','alpha');
 $search_fk_user=GETPOST('search_fk_user','intcomma');
 $search_topic=GETPOST('search_topic','alpha');
-if (! empty($user->socid)) accessforbidden();
+$allowed=1;
+if (! $allowed) accessforbidden();
 $acts[0] = "activate";
 $acts[1] = "disable";
 $actl[0] = img_picto($langs->trans("Disabled"),'switch_off');
 $actl[1] = img_picto($langs->trans("Activated"),'switch_on');
 $listoffset=GETPOST('listoffset','alpha');
 $listlimit =GETPOST('listlimit','alpha')>0?GETPOST('listlimit','alpha'):1000;
 $active = 1;
 $sortfield = GETPOST("sortfield",'alpha');
 $sortorder = GETPOST("sortorder",'alpha');
 $page = GETPOST("page",'int');
@@ -328,22 +329,36 @@
 }
 if (empty($conf->global->MAIN_MULTILANGS))
 {
 	$sql.= " AND (lang = '".$langs->defaultlang."' OR lang IS NULL OR lang = '')";
 }
 if ($search_label) $sql.=natural_search('label', $search_label);
 if ($search_type_template != '' && $search_type_template != '-1') $sql.=natural_search('type_template', $search_type_template);
 if ($search_lang) $sql.=natural_search('lang', $search_lang);
 if ($search_fk_user != '' && $search_fk_user != '-1') $sql.=natural_search('fk_user', $search_fk_user, 2);
 if ($search_topic) $sql.=natural_search('topic', $search_topic);
-if ($sortfield == 'country') $sortfield='country_code';
-$sql.=$db->order($sortfield,$sortorder);
+if ($sortfield)
+{
+	if ($sortfield == 'country') $sortfield='country_code';
+    $sql.= " ORDER BY ".$sortfield;
+    if ($sortorder)
+    {
+        $sql.=" ".strtoupper($sortorder);
+    }
+    $sql.=", ";
+    $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
+    $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
+}
+else {
+    $sql.=" ORDER BY ";
+}
+$sql.=$tabsqlsort[$id];
 $sql.=$db->plimit($listlimit+1,$offset);
 $fieldlist=explode(',',$tabfield[$id]);
 $alabelisused=0;
 $var=false;
 print '<form action="'.$_SERVER['PHP_SELF'].'?id='.$id.'" method="POST">';
 print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 print '<input type="hidden" name="from" value="'.dol_escape_htmltag(GETPOST('from','alpha')).'">';
 print '<div class="div-table-responsive-no-min">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre">';

--- a/htdocs/admin/modules.php
+++ b/htdocs/admin/modules.php
@@ -60,23 +60,23 @@
 	'projects'=>array('position'=>'015', 'label'=>$langs->trans("ModuleFamilyProjects")),
 	'ecm'=>array('position'=>'018', 'label'=>$langs->trans("ModuleFamilyECM")),
 	'technic'=>array('position'=>'021', 'label'=>$langs->trans("ModuleFamilyTechnic")),
 	'portal'=>array('position'=>'040', 'label'=>$langs->trans("ModuleFamilyPortal")),
 	'interface'=>array('position'=>'050', 'label'=>$langs->trans("ModuleFamilyInterface")),
 	'base'=>array('position'=>'060', 'label'=>$langs->trans("ModuleFamilyBase")),
 	'other'=>array('position'=>'100', 'label'=>$langs->trans("ModuleFamilyOther")),
 );
 $param='';
 if ($search_keyword) $param.='&search_keyword='.urlencode($search_keyword);
-if ($search_status && $search_status != '-1')  $param.='&search_status='.urlencode($search_status);
-if ($search_nature && $search_nature != '-1')  $param.='&search_nature='.urlencode($search_nature);
-if ($search_version && $search_version != '-1') $param.='&search_version='.urlencode($search_version);
+if ($search_status > -1)  $param.='&search_status='.urlencode($search_status);
+if ($search_nature > -1)  $param.='&search_nature='.urlencode($search_nature);
+if ($search_version > -1) $param.='&search_version='.urlencode($search_version);
 $dirins=DOL_DOCUMENT_ROOT.'/custom';
 $urldolibarrmodules='https://www.dolistore.com/';
 $hookmanager->initHooks(array('adminmodules','globaladmin'));
 /*
  * Actions
  */
 $formconfirm = '';
 $parameters=array();
 $reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
 if ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');
@@ -364,21 +364,21 @@
 print load_fiche_titre($langs->trans("ModulesSetup"),$moreinfo,'title_setup');
 if ($mode=='common')      print '<span class="opacitymedium">'.$langs->trans("ModulesDesc")."</span><br>\n";
 if ($mode=='marketplace') print '<span class="opacitymedium">'.$langs->trans("ModulesMarketPlaceDesc")."</span><br>\n";
 if ($mode=='deploy')      print '<span class="opacitymedium">'.$langs->trans("ModulesDeployDesc", $langs->transnoentitiesnoconv("AvailableModules"))."</span><br>\n";
 if ($mode=='develop')     print '<span class="opacitymedium">'.$langs->trans("ModulesDevelopDesc")."</span><br>\n";
 $head = modules_prepare_head();
 print "<br>\n";
 if ($mode == 'common')
 {
     dol_set_focus('#search_keyword');
-    print '<form method="POST" id="searchFormList" action="'.$_SERVER["PHP_SELF"].'">';
+    print '<form method="GET" id="searchFormList" action="'.$_SERVER["PHP_SELF"].'">';
     if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
     print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
     print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
     print '<input type="hidden" name="page" value="'.$page.'">';
     dol_fiche_head($head, $mode, '', -1);
     $moreforfilter = '';
     $moreforfilter.='<div class="divsearchfield">';
     $moreforfilter.= $langs->trans('Keyword') . ': <input type="text" id="search_keyword" name="search_keyword" value="'.dol_escape_htmltag($search_keyword).'">';
     $moreforfilter.= '</div>';

--- a/htdocs/admin/multicurrency.php
+++ b/htdocs/admin/multicurrency.php
@@ -27,35 +27,34 @@
 require_once DOL_DOCUMENT_ROOT.'/multicurrency/class/multicurrency.class.php';
 $langs->load("admin");
 $langs->load("multicurrency");
 if (! $user->admin) {
     accessforbidden();
 }
 $action = GETPOST('action', 'alpha');
 /*
  * Actions
  */
-if (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/set_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
-	$value=(GETPOST($code, 'alpha') ? GETPOST($code, 'alpha') : 1);
-	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
+	if (dolibarr_set_const($db, $code, GETPOST($code), 'chaine', 0, '', $conf->entity) > 0)
 	{
 		header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 }
-if (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/del_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
 	if (dolibarr_del_const($db, $code, 0) > 0)
 	{
 		header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);

--- a/htdocs/admin/payment.php
+++ b/htdocs/admin/payment.php
@@ -189,18 +189,27 @@
 print '<td align="center" width="60">'.$langs->trans("Value").'</td>';
 print '<td width="80">&nbsp;</td>';
 print "</tr>\n";
 $var=! $var;
 print '<tr class="oddeven"><td>';
 print $langs->trans("PaymentOnDifferentThirdBills");
 print '</td><td width="60" align="center">';
 print $form->selectyesno("FACTURE_PAYMENTS_ON_DIFFERENT_THIRDPARTIES_BILLS",$conf->global->FACTURE_PAYMENTS_ON_DIFFERENT_THIRDPARTIES_BILLS,1);
 print '</td><td align="right">';
 print "</td></tr>\n";
+/* always on now
+$var=! $var;
+print '<tr class="oddeven"><td>';
+print $langs->trans("JSOnPaimentBill");
+print '</td><td width="60" align="center">';
+print $form->selectyesno("INVOICE_AUTO_FILLJS",$conf->global->INVOICE_AUTO_FILLJS,1);
+print '</td><td align="right">';
+print "</td></tr>\n";
+*/
 print '</table>';
 print '<center>';
 print '<input type="submit" class="button" value="'.$langs->trans("Modify").'" />';
 print '</center>';
 print '</form>';
 dol_fiche_end();
 llxFooter();
 $db->close();

--- a/htdocs/admin/security_file.php
+++ b/htdocs/admin/security_file.php
@@ -33,39 +33,62 @@
 $action=GETPOST('action','alpha');
 $upload_dir=$conf->admin->dir_temp;
 /*
  * Actions
  */
 if (GETPOST('sendit') && ! empty($conf->global->MAIN_UPLOAD_DOC))
 {
     require_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
     dol_add_file_process($upload_dir, 0, 0, 'userfile');
 }
-if ($action == 'updateform')
+if (preg_match('/set_(.*)/',$action,$reg))
 {
-	$antivircommand = GETPOST('MAIN_ANTIVIRUS_COMMAND','none');			// Use GETPOST none because we must accept ". Example c:\Progra~1\ClamWin\bin\clamscan.exe
-	$antivirparam = GETPOST('MAIN_ANTIVIRUS_PARAM','none');				// Use GETPOST none because we must accept ". Example --database="C:\Program Files (x86)\ClamWin\lib"
-	$antivircommand = dol_string_nospecial($antivircommand, '', array("|", ";", "<", ">", "&"));	// Sanitize command
-	$antivirparam = dol_string_nospecial($antivirparam, '', array("|", ";", "<", ">", "&"));		// Sanitize params
+	$code=$reg[1];
+	$value=(GETPOST($code, 'alpha') ? GETPOST($code, 'alpha') : 1);
+	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
+	{
+		Header("Location: ".$_SERVER["PHP_SELF"]);
+		exit;
+	}
+	else
+	{
+		dol_print_error($db);
+	}
+}
+else if (preg_match('/del_(.*)/',$action,$reg))
+{
+	$code=$reg[1];
+	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
+	{
+		Header("Location: ".$_SERVER["PHP_SELF"]);
+		exit;
+	}
+	else
+	{
+		dol_print_error($db);
+	}
+}
+else if ($action == 'updateform')
+{
 	$res3=dolibarr_set_const($db, 'MAIN_UPLOAD_DOC',GETPOST('MAIN_UPLOAD_DOC','alpha'),'chaine',0,'',$conf->entity);
 	$res4=dolibarr_set_const($db, "MAIN_UMASK", GETPOST('MAIN_UMASK','alpha'),'chaine',0,'',$conf->entity);
-	$res5=dolibarr_set_const($db, "MAIN_ANTIVIRUS_COMMAND", trim($antivircommand),'chaine',0,'',$conf->entity);
-	$res6=dolibarr_set_const($db, "MAIN_ANTIVIRUS_PARAM", trim($antivirparam),'chaine',0,'',$conf->entity);
+	$res5=dolibarr_set_const($db, "MAIN_ANTIVIRUS_COMMAND", trim(GETPOST('MAIN_ANTIVIRUS_COMMAND','none')),'chaine',0,'',$conf->entity);    // Use GETPOST none because we must accept "
+	$res6=dolibarr_set_const($db, "MAIN_ANTIVIRUS_PARAM", trim(GETPOST('MAIN_ANTIVIRUS_PARAM','none')),'chaine',0,'',$conf->entity);	// Use GETPOST none because we must accept "
 	if ($res3 && $res4 && $res5 && $res6) setEventMessages($langs->trans("RecordModifiedSuccessfully"), null, 'mesgs');
 }
 else if ($action == 'delete')
 {
 	$langs->load("other");
-	$file = $conf->admin->dir_temp . '/' . GETPOST('urlfile','alpha');	// Do not use urldecode here ($_GET and $_REQUEST are already decoded by PHP).
+	$file = $conf->admin->dir_temp . '/' . GETPOST('urlfile');	// Do not use urldecode here ($_GET and $_REQUEST are already decoded by PHP).
 	$ret=dol_delete_file($file);
-	if ($ret) setEventMessages($langs->trans("FileWasRemoved", GETPOST('urlfile','alpha')), null, 'mesgs');
-	else setEventMessages($langs->trans("ErrorFailToDeleteFile", GETPOST('urlfile','alpha')), null, 'errors');
+	if ($ret) setEventMessages($langs->trans("FileWasRemoved", GETPOST('urlfile')), null, 'mesgs');
+	else setEventMessages($langs->trans("ErrorFailToDeleteFile", GETPOST('urlfile')), null, 'errors');
 	Header('Location: '.$_SERVER["PHP_SELF"]);
 	exit;
 }
 /*
  * View
  */
 $form = new Form($db);
 $wikihelp='EN:Setup_Security|FR:Paramtrage_Scurit|ES:Configuracin_Seguridad';
 llxHeader('',$langs->trans("Files"),$wikihelp);
 print load_fiche_titre($langs->trans("SecuritySetup"),'','title_setup');

--- a/htdocs/admin/security_other.php
+++ b/htdocs/admin/security_other.php
@@ -27,35 +27,35 @@
 require_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';
 $langs->load("users");
 $langs->load("admin");
 $langs->load("other");
 if (! $user->admin)
 	accessforbidden();
 $action=GETPOST('action','alpha');
 /*
  * Actions
  */
-if (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/set_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
-	$value=(GETPOST($code, 'alpha') ? GETPOST($code, 'alpha') : 1);
+	$value=(GETPOST($code) ? GETPOST($code) : 1);
 	if (dolibarr_set_const($db, $code, $value, 'chaine', 0, '', $conf->entity) > 0)
 	{
 		Header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 }
-else if (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+else if (preg_match('/del_(.*)/',$action,$reg))
 {
 	$code=$reg[1];
 	if (dolibarr_del_const($db, $code, $conf->entity) > 0)
 	{
 		Header("Location: ".$_SERVER["PHP_SELF"]);
 		exit;
 	}
 	else
 	{
 		dol_print_error($db);

--- a/htdocs/admin/user.php
+++ b/htdocs/admin/user.php
@@ -62,34 +62,34 @@
 	{
 		$conf->global->USER_ADDON_PDF_ODT = $value;
 	}
 	$ret = delDocumentModel($value, $type);
 	if ($ret > 0)
 	{
 		$ret = addDocumentModel($value, $type, $label, $scandir);
 	}
 	$res = true;
 }
-elseif (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+elseif (preg_match('/set_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
         dol_print_error($db);
     }
 }
-elseif (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+elseif (preg_match('/del_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
         dol_print_error($db);

--- a/htdocs/admin/usergroup.php
+++ b/htdocs/admin/usergroup.php
@@ -61,34 +61,34 @@
 	{
 		$conf->global->USERGROUP_ADDON_PDF_ODT = $value;
 	}
 	$ret = delDocumentModel($value, $type);
 	if ($ret > 0)
 	{
 		$ret = addDocumentModel($value, $type, $label, $scandir);
 	}
 	$res = true;
 }
-elseif (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+elseif (preg_match('/set_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
         dol_print_error($db);
     }
 }
-elseif (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+elseif (preg_match('/del_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
         dol_print_error($db);

--- a/htdocs/admin/website.php
+++ b/htdocs/admin/website.php
@@ -311,21 +311,35 @@
 if ($action == 'delete')
 {
     print $form->formconfirm($_SERVER["PHP_SELF"].'?'.($page?'page='.$page.'&':'').'sortfield='.$sortfield.'&sortorder='.$sortorder.'&rowid='.$rowid, $langs->trans('DeleteWebsite'), $langs->trans('ConfirmDeleteWebsite'), 'confirm_delete','',0,1);
 }
 /*
  * Show website list
  */
 if ($id)
 {
     $sql=$tabsql[$id];
-    $sql.=$db->order($sortfield,$sortorder);
+    if ($sortfield)
+    {
+        $sql.= " ORDER BY ".$sortfield;
+        if ($sortorder)
+        {
+            $sql.=" ".strtoupper($sortorder);
+        }
+        $sql.=", ";
+        $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.' '.$sortorder.',/i','',$tabsqlsort[$id]);
+        $tabsqlsort[$id]=preg_replace('/([a-z]+\.)?'.$sortfield.',/i','',$tabsqlsort[$id]);
+    }
+    else {
+        $sql.=" ORDER BY ";
+    }
+    $sql.=$tabsqlsort[$id];
     $sql.=$db->plimit($limit+1, $offset);
     $fieldlist=explode(',',$tabfield[$id]);
     print '<form action="'.$_SERVER['PHP_SELF'].'" method="POST">';
     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
     print '<table class="noborder" width="100%">';
     if ($tabname[$id])
     {
         $alabelisused=0;
         $var=false;
         $fieldlist=explode(',',$tabfield[$id]);

--- a/htdocs/blockedlog/class/blockedlog.class.php
+++ b/htdocs/blockedlog/class/blockedlog.class.php
@@ -248,27 +248,25 @@
 			return $cachedUser[$this->fk_user]->getNomUrl(1);
 		}
 		return $langs->trans('ImpossibleToRetrieveUser', $this->fk_user);
 	}
 	/**
 	 *      Populate properties of log from object data
 	 *
 	 *      @param		Object		$object     object to store
 	 *      @param		string		$action     action
 	 *      @param		string		$amounts    amounts
-	 *      @param		User		$fuser		User object (forced)
 	 *      @return		int						>0 if OK, <0 if KO
 	 */
-	public function setObjectData(&$object, $action, $amounts, $fuser = null)
+	public function setObjectData(&$object, $action, $amounts)
 	{
 		global $langs, $user, $mysoc;
-		if (is_object($fuser)) $user = $fuser;
 		$this->action = $action;
 		$this->amounts= $amounts;
 		if ($object->element == 'payment' || $object->element == 'payment_supplier')
 		{
 			$this->date_object = $object->datepaye;
 		}
 		elseif ($object->element=='payment_salary')
 		{
 			$this->date_object = $object->datev;
 		}

--- a/htdocs/cashdesk/tpl/facturation1.tpl.php
+++ b/htdocs/cashdesk/tpl/facturation1.tpl.php
@@ -150,29 +150,29 @@
 			<?php
 			print '<div class="inline-block" style="margin: 6px;">';
 			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CASH']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CASH'] < 0)
 			{
 				$langs->load("errors");
 				print '<input class="bouton_mode_reglement_disabled" type="button" name="btnModeReglement" value="'.$langs->trans("Cash").'" title="'.dol_escape_htmltag($langs->trans("ErrorModuleSetupNotComplete")).'" />';
 			}
 			else print '<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="'.$langs->trans("Cash").'" onclick="javascript: verifClic(\'ESP\');" />';
 			print '</div>';
 			print '<div class="inline-block" style="margin: 6px;">';
-			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CB']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CB'] < 0)
+			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CHEQUE']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CHEQUE'] < 0)
 			{
 				$langs->load("errors");
 				print '<input class="bouton_mode_reglement_disabled" type="button" name="btnModeReglement" value="'.$langs->trans("CreditCard").'" title="'.dol_escape_htmltag($langs->trans("ErrorModuleSetupNotComplete")).'" />';
 			}
 			else print '<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="'.$langs->trans("CreditCard").'" onclick="javascript: verifClic(\'CB\');" />';
 			print '</div>';
 			print '<div class="inline-block" style="margin: 6px;">';
-			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CHEQUE']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CHEQUE'] < 0)
+			if (empty($_SESSION['CASHDESK_ID_BANKACCOUNT_CB']) || $_SESSION['CASHDESK_ID_BANKACCOUNT_CB'] < 0)
 			{
 				$langs->load("errors");
 				print '<input class="bouton_mode_reglement_disabled" type="button" name="btnModeReglement" value="'.$langs->trans("CheckBank").'" title="'.dol_escape_htmltag($langs->trans("ErrorModuleSetupNotComplete")).'" />';
 			}
 			else print '<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="'.$langs->trans("CheckBank").'" onclick="javascript: verifClic(\'CHQ\');" />';
 			print '</div>';
 			print '<div class="clearboth">';
 			print '<div class="inline-block" style="margin: 6px;">';
 			?>
 				<input class="button bouton_mode_reglement" type="submit" name="btnModeReglement" value="<?php echo $langs->trans("Reported"); ?>" onclick="javascript: verifClic('DIF');" />

--- a/htdocs/categories/admin/categorie.php
+++ b/htdocs/categories/admin/categorie.php
@@ -23,34 +23,34 @@
  */
 require '../../main.inc.php';
 require_once DOL_DOCUMENT_ROOT.'/core/lib/categories.lib.php';
 if (!$user->admin)
 accessforbidden();
 $langs->load("categories");
 $action=GETPOST('action','aZ09');
 /*
  *	Actions
  */
-if (preg_match('/set_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/set_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_set_const($db, $code, 1, 'chaine', 0, '', $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
         setEventMessages($db->lasterror(), null, 'errors');
     }
 }
-if (preg_match('/del_([a-z0-9_\-]+)/i',$action,$reg))
+if (preg_match('/del_(.*)/',$action,$reg))
 {
     $code=$reg[1];
     if (dolibarr_del_const($db, $code, $conf->entity) > 0)
     {
         header("Location: ".$_SERVER["PHP_SELF"]);
         exit;
     }
     else
     {
          setEventMessages($db->lasterror(), null, 'errors');

--- a/htdocs/categories/viewcat.php
+++ b/htdocs/categories/viewcat.php
@@ -571,21 +571,21 @@
 	{
 		print "<br>";
 		print "<table class='noborder' width='100%'>\n";
 		print '<tr class="liste_titre"><td colspan="4">'.$langs->trans("Project")."</td></tr>\n";
 		if (count($projects) > 0)
 		{
 			foreach ($projects as $key => $project)
 			{
 				print "\t".'<tr class="oddeven">'."\n";
 				print '<td class="nowrap" valign="top">';
-				print $project->getNomUrl(1);
+				print $project->getNomUrl(1,0);
 				print "</td>\n";
 				print '<td class="tdtop">'.$project->ref."</td>\n";
 				print '<td class="tdtop">'.$project->title."</td>\n";
 				print '<td align="right">';
 				$typeid=$object->type;
 				$permission=0;
 				if ($typeid == Categorie::TYPE_PRODUCT)     $permission=($user->rights->produit->creer || $user->rights->service->creer);
 				if ($typeid == Categorie::TYPE_SUPPLIER)    $permission=$user->rights->societe->creer;
 				if ($typeid == Categorie::TYPE_CUSTOMER)    $permission=$user->rights->societe->creer;
 				if ($typeid == Categorie::TYPE_MEMBER)      $permission=$user->rights->adherent->creer;

--- a/htdocs/comm/action/class/api_agendaevents.class.php
+++ b/htdocs/comm/action/class/api_agendaevents.class.php
@@ -88,30 +88,26 @@
     function index($sortfield = "t.id", $sortorder = 'ASC', $limit = 100, $page = 0, $user_ids = 0, $sqlfilters = '') {
         global $db, $conf;
         $obj_ret = array();
         if (! DolibarrApiAccess::$user->rights->agenda->myactions->read) {
         	throw new RestException(401, "Insuffisant rights to read events");
         }
         $socid = 0;
         if (! empty(DolibarrApiAccess::$user->socid)) $socid = DolibarrApiAccess::$user->socid;
         $search_sale = 0;
         if (! DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) $search_sale = DolibarrApiAccess::$user->id;
-		if (empty($conf->societe->enabled)) $search_sale = 0;	// If module thirdparty not enabled, sale representative is something that does not exists
         $sql = "SELECT t.id as rowid";
-        if (! empty($conf->societe->enabled))
-        	if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql .= ", sc.fk_soc, sc.fk_user"; // We need these fields in order to filter by sale (including the case where the user can only see his prospects)
+        if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql .= ", sc.fk_soc, sc.fk_user"; // We need these fields in order to filter by sale (including the case where the user can only see his prospects)
         $sql.= " FROM ".MAIN_DB_PREFIX."actioncomm as t";
-        if (! empty($conf->societe->enabled))
-        	if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc"; // We need this table joined to the select in order to filter by sale
+        if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc"; // We need this table joined to the select in order to filter by sale
         $sql.= ' WHERE t.entity IN ('.getEntity('agenda').')';
-        if (! empty($conf->societe->enabled))
-        	if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql.= " AND t.fk_soc = sc.fk_soc";
+        if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socid) || $search_sale > 0) $sql.= " AND t.fk_soc = sc.fk_soc";
         if ($user_ids) $sql.=" AND t.fk_user_action IN (".$user_ids.")";
         if ($socid > 0) $sql.= " AND t.fk_soc = ".$socid;
         if ($search_sale > 0)
         {
             $sql .= " AND sc.fk_user = ".$search_sale;
         }
         if ($sqlfilters)
         {
             if (! DolibarrApi::_checkFilters($sqlfilters))
             {

--- a/htdocs/comm/action/list.php
+++ b/htdocs/comm/action/list.php
@@ -33,21 +33,21 @@
 $langs->load("companies");
 $langs->load("agenda");
 $langs->load("commercial");
 $action=GETPOST('action','alpha');
 $resourceid=GETPOST("resourceid","int");
 $year=GETPOST("year",'int');
 $month=GETPOST("month",'int');
 $day=GETPOST("day",'int');
 $pid=GETPOST("projectid",'int',3);
 $status=GETPOST("status",'alpha');
-$type=GETPOST('type','alphanohtml');
+$type=GETPOST('type');
 $optioncss = GETPOST('optioncss','alpha');
 if (GETPOST('actioncode','array'))
 {
     $actioncode=GETPOST('actioncode','array',3);
     if (! count($actioncode)) $actioncode='0';
 }
 else
 {
     $actioncode=GETPOST("actioncode","alpha",3)?GETPOST("actioncode","alpha",3):(GETPOST("actioncode")=='0'?'0':(empty($conf->global->AGENDA_DEFAULT_FILTER_TYPE)?'':$conf->global->AGENDA_DEFAULT_FILTER_TYPE));
 }
@@ -185,21 +185,21 @@
 if (GETPOST('dateendyear','int')) $param.='&dateendyear='.GETPOST('dateendyear','int');
 include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
 $sql = "SELECT";
 if ($usergroup > 0) $sql.=" DISTINCT";
 $sql.= " s.nom as societe, s.rowid as socid, s.client,";
 $sql.= " a.id, a.label, a.datep as dp, a.datep2 as dp2,";
 $sql.= ' a.fk_user_author,a.fk_user_action,';
 $sql.= " a.fk_contact, a.note, a.percent as percent,";
 $sql.= " a.fk_element, a.elementtype,";
 $sql.= " c.code as type_code, c.libelle as type_label,";
-$sql.= " sp.lastname, sp.firstname, sp.email, sp.phone, sp.address, sp.phone as phone_pro, sp.phone_mobile, sp.phone_perso, sp.fk_pays as country_id";
+$sql.= " sp.lastname, sp.firstname";
 foreach ($extrafields->attribute_label as $key => $val) $sql.=($extrafields->attribute_type[$key] != 'separate' ? ",ef.".$key.' as options_'.$key : '');
 $sql.= " FROM ".MAIN_DB_PREFIX."actioncomm as a";
 $sql.=" LEFT JOIN ".MAIN_DB_PREFIX."actioncomm_extrafields as ef ON (a.id = ef.fk_object) ";
 if (! $user->rights->societe->client->voir && ! $socid) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe_commerciaux as sc ON a.fk_soc = sc.fk_soc";
 $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe as s ON a.fk_soc = s.rowid";
 $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."socpeople as sp ON a.fk_contact = sp.rowid";
 $sql.=" ,".MAIN_DB_PREFIX."c_actioncomm as c";
 if ($resourceid > 0) $sql.=", ".MAIN_DB_PREFIX."element_resources as r";
 if ($filtert > 0 || $usergroup > 0) $sql.=", ".MAIN_DB_PREFIX."actioncomm_resources as ar";
 if ($usergroup > 0) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."usergroup_user as ugu ON ugu.fk_user = ar.fk_element";
@@ -285,20 +285,21 @@
 	if ($optioncss != '') print '<input type="hidden" name="optioncss" value="'.$optioncss.'">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="action" value="list">';
 	print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
 	print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
 	print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
 	print '<input type="hidden" name="page" value="'.$page.'">';
 	print '<input type="hidden" name="type" value="'.$type.'">';
 	$nav='';
 	if ($filter)          $nav.='<input type="hidden" name="filter" value="'.$filter.'">';
+	if ($filtert)         $nav.='<input type="hidden" name="filtert" value="'.$filtert.'">';
 	if ($showbirthday)    $nav.='<input type="hidden" name="showbirthday" value="1">';
 	print $nav;
     dol_fiche_head($head, $tabactive, $langs->trans('Agenda'), 0, 'action');
     print_actions_filter($form,$canedit,$status,$year,$month,$day,$showbirthday,0,$filtert,0,$pid,$socid,$action,-1,$actioncode,$usergroup,'',$resourceid);
     dol_fiche_end();
     $link='';
     /*
     if (empty($conf->use_javascript_ajax))
     {
         $newparam=$param;   // newparam is for birthday links
@@ -479,28 +480,23 @@
 				$societestatic->name=$obj->societe;
 				print $societestatic->getNomUrl(1,'',28);
 			}
 			else print '&nbsp;';
 			print '</td>';
 		}
 		if (! empty($arrayfields['a.fk_contact']['checked'])) {
 			print '<td>';
 			if ($obj->fk_contact > 0)
 			{
-				$contactstatic->id=$obj->fk_contact;
-				$contactstatic->email=$obj->email;
 				$contactstatic->lastname=$obj->lastname;
 				$contactstatic->firstname=$obj->firstname;
-				$contactstatic->phone_pro=$obj->phone_pro;
-				$contactstatic->phone_mobile=$obj->phone_mobile;
-				$contactstatic->phone_perso=$obj->phone_perso;
-				$contactstatic->country_id=$obj->country_id;
+				$contactstatic->id=$obj->fk_contact;
 				print $contactstatic->getNomUrl(1,'',28);
 			}
 			else
 			{
 				print "&nbsp;";
 			}
 			print '</td>';
 		}
 		if (! empty($arrayfields['a.fk_element']['checked'])) {
 		        print '<td>';

--- a/htdocs/comm/propal/card.php
+++ b/htdocs/comm/propal/card.php
@@ -496,21 +496,21 @@
 	{
 		$result=$object->cloture($user, 4, '');
 		if ($result < 0)
 		{
 			setEventMessages($object->error, $object->errors, 'errors');
 			$error++;
 		}
 	}
 	else if ($action == 'setstatut' && $user->rights->propal->cloturer && ! GETPOST('cancel','alpha'))
 	{
-		if (! (GETPOST('statut','int') > 0)) {
+		if (! GETPOST('statut','int')) {
 			setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("CloseAs")), null, 'errors');
 			$action = 'statut';
 		} else {
 			if ($object->statut == Propal::STATUS_VALIDATED)
 			{
 				$result=$object->cloture($user, GETPOST('statut','int'), GETPOST('note_private','none'));
 				if ($result < 0)
 				{
 					setEventMessages($object->error, $object->errors, 'errors');
 					$error++;

--- a/htdocs/commande/card.php
+++ b/htdocs/commande/card.php
@@ -20,23 +20,23 @@
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  *  GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  */
 /**
- * \file 	htdocs/commande/card.php
+ * \file htdocs/commande/card.php
  * \ingroup commande
- * \brief 	Page to show customer order
+ * \brief Page to show customer order
  */
 require '../main.inc.php';
 require_once DOL_DOCUMENT_ROOT . '/core/class/html.formfile.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/class/html.formorder.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/class/html.formmargin.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/modules/commande/modules_commande.php';
 require_once DOL_DOCUMENT_ROOT . '/commande/class/commande.class.php';
 require_once DOL_DOCUMENT_ROOT . '/comm/action/class/actioncomm.class.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/order.lib.php';
 require_once DOL_DOCUMENT_ROOT . '/core/lib/functions2.lib.php';
@@ -63,21 +63,20 @@
 if (!empty($conf->incoterm->enabled)) $langs->load('incoterm');
 if (! empty($conf->margin->enabled)) $langs->load('margins');
 if (! empty($conf->productbatch->enabled)) $langs->load("productbatch");
 $id = (GETPOST('id', 'int') ? GETPOST('id', 'int') : GETPOST('orderid', 'int'));
 $ref = GETPOST('ref', 'alpha');
 $socid = GETPOST('socid', 'int');
 $action = GETPOST('action', 'alpha');
 $cancel = GETPOST('cancel', 'alpha');
 $confirm = GETPOST('confirm', 'alpha');
 $lineid = GETPOST('lineid', 'int');
-$projectid = GETPOST('projectid', 'int');
 $origin = GETPOST('origin', 'alpha');
 $originid = (GETPOST('originid', 'int') ? GETPOST('originid', 'int') : GETPOST('origin_id', 'int')); // For backward compatibility
 $hidedetails = (GETPOST('hidedetails', 'int') ? GETPOST('hidedetails', 'int') : (! empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DETAILS) ? 1 : 0));
 $hidedesc = (GETPOST('hidedesc', 'int') ? GETPOST('hidedesc', 'int') : (! empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_DESC) ? 1 : 0));
 $hideref = (GETPOST('hideref', 'int') ? GETPOST('hideref', 'int') : (! empty($conf->global->MAIN_GENERATE_DOCUMENTS_HIDE_REF) ? 1 : 0));
 if (! empty($user->societe_id))
 	$socid = $user->societe_id;
 $result = restrictedArea($user, 'commande', $id);
 $object = new Commande($db);
 $extrafields = new ExtraFields($db);
@@ -183,21 +182,21 @@
 			header('Location: '.$_SERVER["PHP_SELF"].'?id='.$object->id);
 			exit;
 		}
 		else
 		{
 			setEventMessages($object->error, $object->errors, 'errors');
 		}
 	}
 	else if ($action == 'classin' && $user->rights->commande->creer)
 	{
-		$object->setProject(GETPOST('projectid','int'));
+		$object->setProject(GETPOST('projectid'));
 	}
 	else if ($action == 'add' && $user->rights->commande->creer)
 	{
 		$datecommande = dol_mktime(12, 0, 0, GETPOST('remonth'), GETPOST('reday'), GETPOST('reyear'));
 		$datelivraison = dol_mktime(12, 0, 0, GETPOST('liv_month'), GETPOST('liv_day'), GETPOST('liv_year'));
 		if ($datecommande == '') {
 			setEventMessages($langs->trans('ErrorFieldRequired', $langs->transnoentities('Date')), null, 'errors');
 			$action = 'create';
 			$error++;
 		}
@@ -207,22 +206,22 @@
 			$error++;
 		}
 		if (! $error) {
 			$object->socid = $socid;
 			$object->fetch_thirdparty();
 			$db->begin();
 			$object->date_commande = $datecommande;
 			$object->note_private = GETPOST('note_private','none');
 			$object->note_public = GETPOST('note_public','none');
 			$object->source = GETPOST('source_id');
-			$object->fk_project = GETPOST('projectid','int');
-			$object->ref_client = GETPOST('ref_client','alpha');
+			$object->fk_project = GETPOST('projectid');
+			$object->ref_client = GETPOST('ref_client');
 			$object->modelpdf = GETPOST('model');
 			$object->cond_reglement_id = GETPOST('cond_reglement_id');
 			$object->mode_reglement_id = GETPOST('mode_reglement_id');
 			$object->fk_account = GETPOST('fk_account', 'int');
 			$object->availability_id = GETPOST('availability_id');
 			$object->demand_reason_id = GETPOST('demand_reason_id');
 			$object->date_livraison = $datelivraison;
 			$object->shipping_method_id = GETPOST('shipping_method_id', 'int');
 			$object->warehouse_id = GETPOST('warehouse_id', 'int');
 			$object->fk_delivery_address = GETPOST('fk_address');
@@ -1113,20 +1112,21 @@
 $formfile = new FormFile($db);
 $formorder = new FormOrder($db);
 $formmargin = new FormMargin($db);
 if (! empty($conf->projet->enabled)) { $formproject = new FormProjets($db); }
 if ($action == 'create' && $user->rights->commande->creer)
 {
 	print load_fiche_titre($langs->trans('CreateOrder'),'','title_commercial.png');
 	$soc = new Societe($db);
 	if ($socid > 0)
 		$res = $soc->fetch($socid);
+	$projectid = 0;
 	$remise_absolue = 0;
 	$currency_code = $conf->currency;
 	if (! empty($origin) && ! empty($originid)) {
 		$element = $subelement = $origin;
 		if (preg_match('/^([^_]+)_([^_]+)/i', $origin, $regs)) {
 			$element = $regs [1];
 			$subelement = $regs [2];
 		}
 		if ($element == 'project') {
 			$projectid = $originid;
@@ -1191,20 +1191,21 @@
 		$cond_reglement_id  = $soc->cond_reglement_id;
 		$mode_reglement_id  = $soc->mode_reglement_id;
 		$fk_account         = $soc->fk_account;
 		$availability_id    = $soc->availability_id;
 		$shipping_method_id = $soc->shipping_method_id;
 		$warehouse_id       = $soc->warehouse_id;
 		$demand_reason_id   = $soc->demand_reason_id;
 		$remise_percent     = $soc->remise_percent;
 		$remise_absolue     = 0;
 		$dateorder          = empty($conf->global->MAIN_AUTOFILL_DATE_ORDER)?-1:'';
+		$projectid          = 0;
 		if (!empty($conf->multicurrency->enabled) && !empty($soc->multicurrency_code)) $currency_code = $soc->multicurrency_code;
 		$note_private = $object->getDefaultCreateValueFor('note_private');
 		$note_public = $object->getDefaultCreateValueFor('note_public');
 	}
 	print '<form name="crea_commande" action="' . $_SERVER["PHP_SELF"] . '" method="POST">';
 	print '<input type="hidden" name="token" value="' . $_SESSION ['newtoken'] . '">';
 	print '<input type="hidden" name="action" value="add">';
 	print '<input type="hidden" name="socid" value="' . $soc->id . '">' . "\n";
 	print '<input type="hidden" name="remise_percent" value="' . $soc->remise_percent . '">';
 	print '<input type="hidden" name="origin" value="' . $origin . '">';

--- a/htdocs/compta/bank/bankentries_list.php
+++ b/htdocs/compta/bank/bankentries_list.php
@@ -322,22 +322,21 @@
 if (!empty($search_account)) $param.='&search_account='.urlencode($search_account);
 if (!empty($search_num_releve)) $param.='&search_num_releve='.urlencode($search_num_releve);
 if ($search_conciliated != '' && $search_conciliated != '-1')  $param.='&search_conciliated='.urlencode($search_conciliated);
 if ($search_bid > 0)  $param.='&search_bid='.urlencode($search_bid);
 if (dol_strlen($search_dt_start) > 0) $param .= '&search_start_dtmonth=' . GETPOST('search_start_dtmonth', 'int') . '&search_start_dtday=' . GETPOST('search_start_dtday', 'int') . '&search_start_dtyear=' . GETPOST('search_start_dtyear', 'int');
 if (dol_strlen($search_dt_end) > 0)   $param .= '&search_end_dtmonth=' . GETPOST('search_end_dtmonth', 'int') . '&search_end_dtday=' . GETPOST('search_end_dtday', 'int') . '&search_end_dtyear=' . GETPOST('search_end_dtyear', 'int');
 if (dol_strlen($search_dv_start) > 0) $param .= '&search_start_dvmonth=' . GETPOST('search_start_dvmonth', 'int') . '&search_start_dvday=' . GETPOST('search_start_dvday', 'int') . '&search_start_dvyear=' . GETPOST('search_start_dvyear', 'int');
 if (dol_strlen($search_dv_end) > 0)   $param .= '&search_end_dvmonth=' . GETPOST('search_end_dvmonth', 'int') . '&search_end_dvday=' . GETPOST('search_end_dvday', 'int') . '&search_end_dvyear=' . GETPOST('search_end_dvyear', 'int');
 if ($search_req_nb) $param.='&req_nb='.urlencode($search_req_nb);
 if (GETPOST("search_thirdparty",'int')) $param.='&thirdparty='.urlencode(GETPOST("search_thirdparty",'int'));
-if ($optioncss != '')       $param.='&optioncss='.urlencode($optioncss);
-if ($action == 'reconcile') $param.='&action=reconcile';
+if ($optioncss != '')      $param.='&optioncss='.urlencode($optioncss);
 include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
 $options = array();
 $buttonreconcile = '';
 if ($id > 0 || ! empty($ref))
 {
 	$title = $langs->trans("FinancialAccount").' - '.$langs->trans("Transactions");
 	$helpurl = "";
 	llxHeader('',$title,$helpurl);
     require_once DOL_DOCUMENT_ROOT.'/compta/bank/class/bankcateg.class.php';
     $bankcateg = new BankCateg($db);
@@ -350,44 +349,42 @@
     dol_banner_tab($object, 'ref', $linkback, 1, 'ref', 'ref', $morehtmlref, '', 0, '', '', 1);
     dol_fiche_end();
     /*
      * Buttons actions
      */
     if ($action != 'reconcile')
     {
         if ($object->canBeConciliated() > 0)
         {
             if ($user->rights->banque->consolidate) {
-            	$newparam = $param;
-            	$newparam = preg_replace('/search_conciliated=\d+/i','',$newparam);
-            	$buttonreconcile = '<a class="butAction" style="margin-bottom: 5px !important; margin-top: 5px !important" href="'.DOL_URL_ROOT.'/compta/bank/bankentries_list.php?action=reconcile&search_conciliated=0'.$newparam.'">'.$langs->trans("Conciliate").'</a>';
+            	$buttonreconcile = '<a class="butAction" style="margin-bottom: 5px !important; margin-top: 5px !important" href="'.DOL_URL_ROOT.'/compta/bank/bankentries_list.php?action=reconcile&search_conciliated=0'.$param.'">'.$langs->trans("Conciliate").'</a>';
             } else {
             	$buttonreconcile = '<a class="butActionRefused" style="margin-bottom: 5px !important; margin-top: 5px !important" title="'.$langs->trans("NotEnoughPermissions").'" href="#">'.$langs->trans("Conciliate").'</a>';
             }
         }
     }
 }
 else
 {
 	llxHeader('', $langs->trans("BankTransactions"), '', '', 0, 0, array(), array(), $param);
 }
 $sql = "SELECT b.rowid, b.dateo as do, b.datev as dv, b.amount, b.label, b.rappro as conciliated, b.num_releve, b.num_chq,";
 $sql.= " b.fk_account, b.fk_type,";
 $sql.= " ba.rowid as bankid, ba.ref as bankref,";
 $sql.= " bu.url_id,";
 $sql.= " s.nom, s.name_alias, s.client, s.fournisseur, s.code_client, s.code_fournisseur, s.code_compta, s.code_compta_fournisseur";
 foreach ($extrafields->attribute_label as $key => $val) $sql.=($extrafields->attribute_type[$key] != 'separate' ? ",ef.".$key.' as options_'.$key : '');
 $parameters=array();
 $reshook=$hookmanager->executeHooks('printFieldListSelect',$parameters);    // Note that $action and $object may have been modified by hook
 $sql.=$hookmanager->resPrint;
 $sql.= " FROM ";
-if ($search_bid>0) $sql.= MAIN_DB_PREFIX."bank_class as l,";
+if ($search_bid) $sql.= MAIN_DB_PREFIX."bank_class as l,";
 $sql.= " ".MAIN_DB_PREFIX."bank_account as ba,";
 $sql.= " ".MAIN_DB_PREFIX."bank as b";
 if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label)) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."bank_extrafields as ef on (b.rowid = ef.fk_object)";
 $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."bank_url as bu ON bu.fk_bank = b.rowid AND type = 'company'";
 $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe as s ON bu.url_id = s.rowid";
 $sql.= " WHERE b.fk_account = ba.rowid";
 $sql.= " AND ba.entity IN (".getEntity('bank_account').")";
 if ($search_account > 0) $sql.=" AND b.fk_account = ".$search_account;
 if (dol_strlen($search_dt_start)>0) $sql .= " AND b.dateo >= '" . $db->idate($search_dt_start) . "'";
 if (dol_strlen($search_dt_end)>0) $sql .= " AND b.dateo <= '" . $db->idate($search_dt_end) . "'";
@@ -818,26 +815,26 @@
                 {
                     $balance = $objforbalance->balance;
                 }
             }
             else dol_print_error($db);
             $balancecalculated=true;
             if ($user->rights->banque->consolidate && $action == 'reconcile')
             {
             	$tmpnbfieldbeforebalance=0;
             	$tmpnbfieldafterbalance=0;
-            	$balancefieldfound=0;
+            	$balancefieldfound=false;
             	foreach($arrayfields as $key => $val)
             	{
             		if ($key == 'balancebefore' || $key == 'balance')
             		{
-            			$balancefieldfound++;
+            			$balancefieldfound=true;
             			continue;
             		}
            			if (! empty($arrayfields[$key]['checked']))
            			{
            				if (! $balancefieldfound) $tmpnbfieldbeforebalance++;
            				else $tmpnbfieldafterbalance++;
            			}
             	}
             	if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label))
             	{
@@ -852,35 +849,24 @@
 		           			}
             			}
             		}
             	}
             	print '<tr class="oddeven trforbreak">';
             	if ($tmpnbfieldbeforebalance)
             	{
             		print '<td colspan="'.$tmpnbfieldbeforebalance.'">';
             		print '</td>';
             	}
-            	if (! empty($arrayfields['balancebefore']['checked']))
-            	{
-	            	print '<td align="right">';
-	            	print price(price2num($balance, 'MT'), 1, $langs);
-	            	print '</td>';
-            	}
-            	if (! empty($arrayfields['balance']['checked']))
-            	{
-            		print '<td align="right">';
-					print price(price2num($balance, 'MT'), 1, $langs);
-					print '</td>';
-            	}
-				print '<td align="center">';
+				print '<td align="right">';
+            	print price(price2num($balance, 'MT'), 1, $langs);
 				print '</td>';
-				print '<td colspan="'.($tmpnbfieldafterbalance+2).'">';
+				print '<td colspan="'.($tmpnbfieldafterbalance+3).'">';
 				print '</td>';
             	print '</tr>';
             }
         }
         $balance = price2num($balance + ($sign * $objp->amount),'MT');
         if (empty($cachebankaccount[$objp->bankid]))
         {
             $bankaccounttmp = new Account($db);
             $bankaccounttmp->fetch($objp->bankid);
             $cachebankaccount[$objp->bankid]=$bankaccounttmp;
@@ -1239,21 +1225,21 @@
 	        $i++;
 	        if ($i == 1)
 	        {
 	            if ($num < $limit && empty($offset)) print '<td align="left">'.$langs->trans("Total").'</td>';
 	            else print '<td align="left">'.$langs->trans("Totalforthispage").'</td>';
 	        }
 	        elseif ($totalarray['totaldebfield'] == $i) print '<td align="right">'.price(-1 * $totalarray['totaldeb']).'</td>';
 	        elseif ($totalarray['totalcredfield'] == $i) print '<td align="right">'.price($totalarray['totalcred']).'</td>';
 	        elseif ($i == $posconciliatecol)
 	        {
-	        	print '<td class="center">';
+	        	print '<td>';
 	        	if ($user->rights->banque->consolidate && $action == 'reconcile') print '<input class="button" name="confirm_reconcile" type="submit" value="' . $langs->trans("Conciliate") . '">';
 	        	print '</td>';
 	        }
 	        else print '<td></td>';
 	    }
 	    print '</tr>';
 	}
 	print "</table>";
 	print "</div>";
     print '</form>';

--- a/htdocs/compta/bank/card.php
+++ b/htdocs/compta/bank/card.php
@@ -609,23 +609,23 @@
 			print '</script>'."\n";
 		}
 		print '<form action="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'" method="post" name="formsoc">';
 		print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 		print '<input type="hidden" name="action" value="update">';
 		print '<input type="hidden" name="id" value="'.$_REQUEST["id"].'">'."\n\n";
 		dol_fiche_head('');
 		print '<div class="underbanner clearboth"></div>';
 		print '<table class="border" width="100%">';
 		print '<tr><td class="fieldrequired titlefieldcreate">'.$langs->trans("Ref").'</td>';
-		print '<td><input size="8" type="text" class="flat" name="ref" value="'.dol_escape_htmltag(isset($_POST["ref"])?GETPOST("ref"):$object->ref).'"></td></tr>';
+		print '<td><input size="8" type="text" class="flat" name="ref" value="'.(isset($_POST["ref"])?GETPOST("ref"):$object->ref).'"></td></tr>';
 		print '<tr><td class="fieldrequired">'.$langs->trans("Label").'</td>';
-		print '<td><input type="text" class="flat minwidth300" name="label" value="'.dol_escape_htmltag(isset($_POST["label"])?GETPOST("label"):$object->label).'"></td></tr>';
+		print '<td><input type="text" class="flat minwidth300" name="label" value="'.(isset($_POST["label"])?GETPOST("label"):$object->label).'"></td></tr>';
 		print '<tr><td class="fieldrequired">'.$langs->trans("AccountType").'</td>';
 		print '<td class="maxwidth200onsmartphone">';
 		$formbank->selectTypeOfBankAccount((isset($_POST["type"])?$_POST["type"]:$object->type),"type");
 		print '</td></tr>';
 		print '<tr><td class="fieldrequired">'.$langs->trans("Currency");
 		print '<input type="hidden" value="'.$object->currency_code.'">';
 		print '</td>';
 		print '<td class="maxwidth200onsmartphone">';
 		$selectedcode=$object->currency_code;
 		if (! $selectedcode) $selectedcode=$conf->currency;

--- a/htdocs/compta/bank/class/account.class.php
+++ b/htdocs/compta/bank/class/account.class.php
@@ -278,21 +278,21 @@
 			return -1;
 		}
 	}
 	/**
 	 * 		TODO Move this into AccountLine
 	 *      Return array with links from llx_bank_url
 	 *
 	 *      @param  int         $fk_bank    To search using bank transaction id
 	 *      @param  int         $url_id     To search using link to
 	 *      @param  string      $type       To search using type
-	 *      @return array|-1                Array of links array('url'=>, 'url_id'=>, 'label'=>, 'type'=> 'fk_bank'=> ) or -1 on error
+	 *      @return array|-1                Array of links or -1 on error
 	 */
 	function get_url($fk_bank='', $url_id='', $type='')
 	{
 		$lines = array();
 		if (! empty($fk_bank) && (! empty($url_id) || ! empty($type)))
 		{
 			$this->error="ErrorBadParameter";
 			return -1;
 		}
 		$sql = "SELECT fk_bank, url_id, url, label, type";

--- a/htdocs/compta/bank/ligne.php
+++ b/htdocs/compta/bank/ligne.php
@@ -362,67 +362,62 @@
                 else {
                     print '<a href="'.$links[$key]['url'].$links[$key]['url_id'].'">';
                     print img_object('','generic').' ';
                     print $links[$key]['label'];
                     print '</a>';
                 }
             }
             print '</td></tr>';
         }
         print "<tr><td>".$langs->trans("Type")." / ".$langs->trans("Numero");
-        print ' <em>('.$langs->trans("ChequeOrTransferNumber").')</em>';
         print "</td>";
         if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
         {
             print '<td>';
             $form->select_types_paiements($objp->fk_type,"value",'',2);
             print '<input type="text" class="flat" name="num_chq" value="'.(empty($objp->num_chq) ? '' : $objp->num_chq).'">';
             if ($objp->receiptid)
             {
                 include_once DOL_DOCUMENT_ROOT.'/compta/paiement/cheque/class/remisecheque.class.php';
                 $receipt=new RemiseCheque($db);
                 $receipt->fetch($objp->receiptid);
                 print ' &nbsp; &nbsp; '.$langs->trans("CheckReceipt").': '.$receipt->getNomUrl(2);
             }
             print '</td>';
         }
         else
         {
             print '<td>'.$objp->fk_type.' '.$objp->num_chq.'</td>';
         }
         print "</tr>";
-        print "<tr><td>".$langs->trans("CheckTransmitter");
-        print ' <em>('.$langs->trans("ChequeMaker").')</em>';
-        print "</td>";
+        print "<tr><td>".$langs->trans("Bank")."</td>";
         if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
         {
             print '<td>';
+            print '<input type="text" class="flat minwidth200" name="banque" value="'.(empty($objp->banque) ? '' : $objp->banque).'">';
+            print '</td>';
+        }
+        else
+        {
+            print '<td>'.$objp->banque.'</td>';
+        }
+        print "</tr>";
+        print "<tr><td>".$langs->trans("CheckTransmitter")."</td>";
+        if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
+        {
+            print '<td>';
             print '<input type="text" class="flat minwidth200" name="emetteur" value="'.(empty($objp->emetteur) ? '' : stripslashes($objp->emetteur)).'">';
             print '</td>';
         }
         else
         {
             print '<td>'.$objp->emetteur.'</td>';
-        }
-        print "</tr>";
-        print "<tr><td>".$langs->trans("Bank");
-        print ' <em>('.$langs->trans("ChequeBank").')</em>';
-        print "</td>";
-        if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
-        {
-        	print '<td>';
-        	print '<input type="text" class="flat minwidth200" name="banque" value="'.(empty($objp->banque) ? '' : $objp->banque).'">';
-        	print '</td>';
-        }
-        else
-        {
-        	print '<td>'.$objp->banque.'</td>';
         }
         print "</tr>";
         print '<tr><td>'.$langs->trans("DateOperation").'</td>';
         if ($user->rights->banque->modifier || $user->rights->banque->consolidate)
         {
             print '<td>';
             print $form->select_date($db->jdate($objp->do),'dateo','','','','update',1,0,1,$objp->rappro);
             if (! $objp->rappro)
             {
                 print ' &nbsp; ';

--- a/htdocs/compta/bank/transfer.php
+++ b/htdocs/compta/bank/transfer.php
@@ -33,22 +33,22 @@
 $action = GETPOST('action','alpha');
 $error = 0;
 /*
  * Actions
  */
 if ($action == 'add')
 {
 	$langs->load("errors");
 	$dateo = dol_mktime(12,0,0,GETPOST('remonth','int'),GETPOST('reday','int'),GETPOST('reyear','int'));
 	$label = GETPOST('label','alpha');
-	$amount= GETPOST('amount','alpha');
-	$amountto= GETPOST('amountto','alpha');
+	$amount= GETPOST('amount');
+	$amountto= GETPOST('amountto');
 	if (! $label)
 	{
 		$error++;
 		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentities("Description")), null, 'errors');
 	}
 	if (! $amount)
 	{
 		$error++;
 		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentities("Amount")), null, 'errors');
 	}
@@ -97,21 +97,21 @@
 			if (! $error) $bank_line_id_from = $accountfrom->addline($dateo, $typefrom, $label, -1*price2num($amount), '', '', $user);
 			if (! ($bank_line_id_from > 0)) $error++;
 			if (! $error) $bank_line_id_to = $accountto->addline($dateo, $typeto, $label, price2num($amountto), '', '', $user);
 			if (! ($bank_line_id_to > 0)) $error++;
 		    if (! $error) $result=$accountfrom->add_url_line($bank_line_id_from, $bank_line_id_to, DOL_URL_ROOT.'/compta/bank/ligne.php?rowid=', '(banktransfert)', 'banktransfert');
 			if (! ($result > 0)) $error++;
 		    if (! $error) $result=$accountto->add_url_line($bank_line_id_to, $bank_line_id_from, DOL_URL_ROOT.'/compta/bank/ligne.php?rowid=', '(banktransfert)', 'banktransfert');
 			if (! ($result > 0)) $error++;
 			if (! $error)
 			{
-				$mesgs = $langs->trans("TransferFromToDone", '<a href="bankentries_list.php?id='.$accountfrom->id.'&sortfield=b.datev,b.dateo,b.rowid&sortorder=desc">'.$accountfrom->label."</a>", '<a href="bankentries_list.php?id='.$accountto->id.'">'.$accountto->label."</a>", $amount, $langs->transnoentities("Currency".$conf->currency));
+				$mesgs = $langs->trans("TransferFromToDone",'<a href="bankentries_list.php?id='.$accountfrom->id.'&sortfield=b.datev,b.dateo,b.rowid&sortorder=desc">'.$accountfrom->label."</a>",'<a href="bankentries_list.php?id='.$accountto->id.'">'.$accountto->label."</a>",$amount,$langs->transnoentities("Currency".$conf->currency));
 				setEventMessages($mesgs, null, 'mesgs');
 				$db->commit();
 			}
 			else
 			{
 				setEventMessages($accountfrom->error.' '.$accountto->error, null, 'errors');
 				$db->rollback();
 			}
 		}
 		else
@@ -121,25 +121,20 @@
 		}
 	}
 }
 /*
  * View
  */
 llxHeader();
 print '		<script type="text/javascript">
         	$(document).ready(function () {
     	  		$(".selectbankaccount").change(function() {
-						console.log("We change bank account");
-						init_page();
-				});
-				function init_page() {
-					console.log("Set fields according to currency");
         			var account1 = $("#selectaccount_from").val();
         			var account2 = $("#selectaccount_to").val();
         			var currencycode1="";
         			var currencycode2="";
 					$.get("'.DOL_URL_ROOT.'/core/ajax/getaccountcurrency.php", {id: account1})
 						.done(function( data ) {
 							if (data != null)
 							{
 								var item= $.parseJSON(data);
 								if (item.num==-1) {
@@ -169,35 +164,34 @@
 			        			}).fail(function( data ) {
 									console.error("Error: has returned an empty page. Should be an empty json array.");
 								});
 							}
 							else {
 								console.error("Error: has returned an empty page. Should be an empty json array.");
 							}
     	        	}).fail(function( data ) {
 						console.error("Error: has returned an empty page. Should be an empty json array.");
 					});
-        		}
-				init_page();
+        		});
         	});
     		</script>';
 $form=new Form($db);
 $account_from='';
 $account_to='';
 $label='';
 $amount='';
-if ($error)
+if($error)
 {
 	$account_from =	GETPOST('account_from','int');
 	$account_to	= GETPOST('account_to','int');
 	$label = GETPOST('label','alpha');
-	$amount = GETPOST('amount','alpha');
+	$amount = GETPOST('amount','int');
 }
 print load_fiche_titre($langs->trans("MenuBankInternalTransfer"), '', 'title_bank.png');
 print $langs->trans("TransferDesc");
 print "<br><br>";
 print '<form name="add" method="post" action="'.$_SERVER["PHP_SELF"].'">';
 print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 print '<input type="hidden" name="action" value="add">';
 print '<table class="noborder" width="100%">';
 print '<tr class="liste_titre">';
 print '<td>'.$langs->trans("TransferFrom").'</td><td>'.$langs->trans("TransferTo").'</td><td>'.$langs->trans("Date").'</td><td>'.$langs->trans("Description").'</td><td>'.$langs->trans("Amount").'</td>';
@@ -206,18 +200,18 @@
 $var=false;
 print '<tr class="oddeven"><td>';
 $form->select_comptes($account_from, 'account_from', 0, '', 1, '', empty($conf->multicurrency->enabled)?0:1);
 print "</td>";
 print "<td>\n";
 $form->select_comptes($account_to, 'account_to', 0, '', 1, '', empty($conf->multicurrency->enabled)?0:1);
 print "</td>\n";
 print "<td>";
 $form->select_date((! empty($dateo)?$dateo:''),'','','','','add');
 print "</td>\n";
-print '<td><input name="label" class="flat quatrevingtpercent" type="text" value="'.dol_escape_htmltag($label).'"></td>';
-print '<td><input name="amount" class="flat" type="text" size="6" value="'.dol_escape_htmltag($amount).'"></td>';
-print '<td style="display:none" class="multicurrency"><input name="amountto" class="flat" type="text" size="6" value="'.dol_escape_htmltag($amountto).'"></td>';
+print '<td><input name="label" class="flat quatrevingtpercent" type="text" value="'.$label.'"></td>';
+print '<td><input name="amount" class="flat" type="text" size="6" value="'.$amount.'"></td>';
+print '<td style="display:none" class="multicurrency"><input name="amountto" class="flat" type="text" size="6" value="'.$amountto.'"></td>';
 print "</table>";
 print '<br><div class="center"><input type="submit" class="button" value="'.$langs->trans("Add").'"></div>';
 print "</form>";
 llxFooter();
 $db->close();

--- a/htdocs/compta/bank/various_payment/card.php
+++ b/htdocs/compta/bank/various_payment/card.php
@@ -273,21 +273,21 @@
 		print '</td></tr>';
 	}
 	$parameters=array();
 	$reshook=$hookmanager->executeHooks('formObjectOptions',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook
 	print $hookmanager->resPrint;
 	print '</table>';
 	dol_fiche_end();
 	print '<div class="center">';
 	print '<input type="submit" class="button" value="'.$langs->trans("Save").'">';
 	print ' &nbsp; ';
-	print '<input type="button" class="button" value="'.$langs->trans("Cancel").'" onclick="javascript:history.go(-1)">';
+	print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
 	print '</div>';
 	print '</form>';
 }
 /* ************************************************************************** */
 /*                                                                            */
 /* View mode                                                                  */
 /*                                                                            */
 /* ************************************************************************** */
 if ($id)
 {

--- a/htdocs/compta/facture/class/facture-rec.class.php
+++ b/htdocs/compta/facture/class/facture-rec.class.php
@@ -832,83 +832,72 @@
 		$nb_create=0;
 		$now = dol_now();
 		$tmparray=dol_getdate($now);
 		$today = dol_mktime(23,59,59,$tmparray['mon'],$tmparray['mday'],$tmparray['year']);   // Today is last second of current day
 		dol_syslog("createRecurringInvoices");
 		$sql = 'SELECT rowid FROM '.MAIN_DB_PREFIX.'facture_rec';
 		$sql.= ' WHERE frequency > 0';      // A recurring invoice is an invoice with a frequency
 		$sql.= " AND (date_when IS NULL OR date_when <= '".$db->idate($today)."')";
 		$sql.= ' AND (nb_gen_done < nb_gen_max OR nb_gen_max = 0)';
 		$sql.= ' AND suspended = 0';
-		$sql.= ' AND entity = '.$conf->entity;	// MUST STAY = $conf->entity here
 		$sql.= $db->order('entity', 'ASC');
 		$resql = $db->query($sql);
 		if ($resql)
 		{
 		    $i=0;
 		    $num = $db->num_rows($resql);
 		    if ($num) $this->output.=$langs->trans("FoundXQualifiedRecurringInvoiceTemplate", $num)."\n";
 		    else $this->output.=$langs->trans("NoQualifiedRecurringInvoiceTemplateFound");
 		    $saventity = $conf->entity;
-		    while ($i < $num)     // Loop on each template invoice. If $num = 0, test is false at first pass.
+		    while ($i < $num)     // Loop on each template invoice
 			{
 			    $line = $db->fetch_object($resql);
 			    $db->begin();
 				$facturerec = new FactureRec($db);
 				$facturerec->fetch($line->rowid);
-				if ($facturerec->id > 0)
-				{
-					$conf->entity = $facturerec->entity;
-					dol_syslog("createRecurringInvoices Process invoice template id=".$facturerec->id.", ref=".$facturerec->ref.", entity=".$facturerec->entity);
-				    $error=0;
-				    $facture = new Facture($db);
-					$facture->fac_rec = $facturerec->id;    // We will create $facture from this recurring invoice
-					$facture->fk_fac_rec_source = $facturerec->id;    // We will create $facture from this recurring invoice
-				    $facture->type = self::TYPE_STANDARD;
-				    $facture->brouillon = 1;
-				    $facture->date = (empty($facturerec->date_when)?$now:$facturerec->date_when);	// We could also use dol_now here but we prefer date_when so invoice has real date when we would like even if we generate later.
-				    $facture->socid = $facturerec->socid;
-				    $invoiceidgenerated = $facture->create($user);
-				    if ($invoiceidgenerated <= 0)
-				    {
-				        $this->errors = $facture->errors;
-				        $this->error = $facture->error;
-				        $error++;
-				    }
-				    if (! $error && $facturerec->auto_validate)
-				    {
-				        $result = $facture->validate($user);
-				        if ($result <= 0)
-				        {
-	    			        $this->errors = $facture->errors;
-	    			        $this->error = $facture->error;
-				            $error++;
-	                    }
-				    }
-	                if (! $error && $facturerec->generate_pdf)
-	                {
-	                    $result = $facture->generateDocument($facturerec->modelpdf, $langs);
-	                    if ($result <= 0)
-	                    {
-	                        $this->errors = $facture->errors;
-	                        $this->error = $facture->error;
-	                        $error++;
-	                    }
-	                }
-				}
-				else
-				{
-					$error++;
-					$this->error="Failed to load invoice template with id=".$line->rowid.", entity=".$conf->entity."\n";
-					$this->errors[]="Failed to load invoice template with id=".$line->rowid.", entity=".$conf->entity;
-					dol_syslog("createRecurringInvoices Failed to load invoice template with id=".$line->rowid.", entity=".$conf->entity);
-				}
+				$conf->entity = $facturerec->entity;
+				dol_syslog("createRecurringInvoices Process invoice template id=".$facturerec->id.", ref=".$facturerec->ref.", entity=".$facturerec->entity);
+			    $error=0;
+			    $facture = new Facture($db);
+				$facture->fac_rec = $facturerec->id;    // We will create $facture from this recurring invoice
+				$facture->fk_fac_rec_source = $facturerec->id;    // We will create $facture from this recurring invoice
+			    $facture->type = self::TYPE_STANDARD;
+			    $facture->brouillon = 1;
+			    $facture->date = (empty($facturerec->date_when)?$now:$facturerec->date_when);	// We could also use dol_now here but we prefer date_when so invoice has real date when we would like even if we generate later.
+			    $facture->socid = $facturerec->socid;
+			    $invoiceidgenerated = $facture->create($user);
+			    if ($invoiceidgenerated <= 0)
+			    {
+			        $this->errors = $facture->errors;
+			        $this->error = $facture->error;
+			        $error++;
+			    }
+			    if (! $error && $facturerec->auto_validate)
+			    {
+			        $result = $facture->validate($user);
+			        if ($result <= 0)
+			        {
+    			        $this->errors = $facture->errors;
+    			        $this->error = $facture->error;
+			            $error++;
+                    }
+			    }
+                if (! $error && $facturerec->generate_pdf)
+                {
+                    $result = $facture->generateDocument($facturerec->modelpdf, $langs);
+                    if ($result <= 0)
+                    {
+                        $this->errors = $facture->errors;
+                        $this->error = $facture->error;
+                        $error++;
+                    }
+                }
 				if (! $error && $invoiceidgenerated >= 0)
 				{
 					$db->commit("createRecurringInvoices Process invoice template id=".$facturerec->id.", ref=".$facturerec->ref);
 					dol_syslog("createRecurringInvoices Process invoice template ".$facturerec->ref." is finished with a success generation");
 					$nb_create++;
 					$this->output.=$langs->trans("InvoiceGeneratedFromTemplate", $facture->ref, $facturerec->ref)."\n";
 				}
 				else
 				{
 				    $db->rollback("createRecurringInvoices Process invoice template id=".$facturerec->id.", ref=".$facturerec->ref);

--- a/htdocs/compta/facture/class/facture.class.php
+++ b/htdocs/compta/facture/class/facture.class.php
@@ -610,28 +610,22 @@
 						if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) // For avoid conflicts if trigger used
 						{*/
 					if (! $error)
 					{
 					    $result=$this->insertExtraFields();
 					    if ($result < 0) $error++;
 					}
 						/*}
 					}
 					else if ($reshook < 0) $error++;*/
-          if (! $error)
-          {
-            if (! $notrigger)
-            {
-              $result=$this->call_trigger('BILL_CREATE',$user);
-              if ($result < 0) $error++;
-            }
-          }
+                    $result=$this->call_trigger('BILL_CREATE',$user);
+                    if ($result < 0) $error++;
 					if (! $error)
 					{
 						$this->db->commit();
 						return $this->id;
 					}
 					else
 					{
 						$this->db->rollback();
 						return -4;
 					}

--- a/htdocs/compta/facture/fiche-rec.php
+++ b/htdocs/compta/facture/fiche-rec.php
@@ -1205,28 +1205,21 @@
 		}
 		else
 		{
 			print $langs->trans("NextDateToExecution");
 		}
 		print '</td><td>';
 		if ($action == 'date_when' || $object->frequency > 0)
 		{
 			print $form->editfieldval($langs->trans("NextDateToExecution"), 'date_when', $object->date_when, $object, $user->rights->facture->creer, 'day', $object->date_when, null, '', '', 0, 'strikeIfMaxNbGenReached');
 		}
-		if (! $object->isMaxNbGenReached())
-		{
-			if ($action != 'editdate_when' && $object->frequency > 0 && $object->date_when && $object->date_when < $now) print img_warning($langs->trans("Late"));
-		}
-		else
-		{
-			print img_info($langs->trans("MaxNumberOfGenerationReached"));
-		}
+		if ($action != 'editdate_when' && $object->frequency > 0 && $object->date_when && $object->date_when < $now) print img_warning($langs->trans("Late"));
 		print '</td>';
 		print '</tr>';
 		print '<tr><td>';
 		if ($action == 'nb_gen_max' || $object->frequency > 0)
 		{
 			print $form->editfieldkey($langs->trans("MaxPeriodNumber"), 'nb_gen_max', $object->nb_gen_max, $object, $user->rights->facture->creer);
 		}
 		else
 		{
 			print $langs->trans("MaxPeriodNumber");

--- a/htdocs/compta/facture/invoicetemplate_list.php
+++ b/htdocs/compta/facture/invoicetemplate_list.php
@@ -509,32 +509,25 @@
 			}
 			if (! empty($arrayfields['f.date_last_gen']['checked']))
 			{
 			   print '<td align="center">';
 			   print ($objp->frequency > 0 ? dol_print_date($db->jdate($objp->date_last_gen),'day') : '<span class="opacitymedium">'.$langs->trans('NA').'</span>');
 			   print '</td>';
 			   if (! $i) $totalarray['nbfield']++;
 			}
 			if (! empty($arrayfields['f.date_when']['checked']))
 			{
-				print '<td align="center">';
-				print ($objp->frequency ? ($invoicerectmp->isMaxNbGenReached()?'<strike>':'').dol_print_date($db->jdate($objp->date_when),'day').($invoicerectmp->isMaxNbGenReached()?'</strike>':'') : '<span class="opacitymedium">'.$langs->trans('NA').'</span>');
-				if (! $invoicerectmp->isMaxNbGenReached())
-				{
-					if ($objp->frequency > 0 && $db->jdate($objp->date_when) && $db->jdate($objp->date_when) < $now) print img_warning($langs->trans("Late"));
-				}
-				else
-				{
-					print img_info($langs->trans("MaxNumberOfGenerationReached"));
-				}
-				print '</td>';
-				if (! $i) $totalarray['nbfield']++;
+			   print '<td align="center">';
+			   print ($objp->frequency ? ($invoicerectmp->isMaxNbGenReached()?'<strike>':'').dol_print_date($db->jdate($objp->date_when),'day').($invoicerectmp->isMaxNbGenReached()?'</strike>':'') : '<span class="opacitymedium">'.$langs->trans('NA').'</span>');
+			   if ($objp->frequency > 0 && $db->jdate($objp->date_when) && $db->jdate($objp->date_when) < $now) print img_warning($langs->trans("Late"));
+			   print '</td>';
+			   if (! $i) $totalarray['nbfield']++;
 			}
 			if (! empty($arrayfields['f.datec']['checked']))
 			{
 			   print '<td align="center">';
 			   print dol_print_date($db->jdate($objp->datec),'dayhour');
 			   print '</td>';
 			   if (! $i) $totalarray['nbfield']++;
 			}
 			if (! empty($arrayfields['f.tms']['checked']))
 			{
@@ -546,25 +539,21 @@
 			if (! empty($arrayfields['status']['checked']))
 			{
 			   print '<td align="center">';
 			   print $invoicerectmp->getLibStatut(3,0);
 			   print '</td>';
 			   if (! $i) $totalarray['nbfield']++;
 			}
 			print '<td align="center">';
 			if ($user->rights->facture->creer && empty($invoicerectmp->suspended))
 			{
-				if ($invoicerectmp->isMaxNbGenReached())
-				{
-					print $langs->trans("MaxNumberOfGenerationReached");
-				}
-				elseif (empty($objp->frequency) || $db->jdate($objp->date_when) <= $today)
+				if (empty($objp->frequency) || $db->jdate($objp->date_when) <= $today)
 				{
 					print '<a href="'.DOL_URL_ROOT.'/compta/facture/card.php?action=create&amp;socid='.$objp->socid.'&amp;fac_rec='.$objp->facid.'">';
 					print $langs->trans("CreateBill").'</a>';
 				}
 				else
 				{
 					print $langs->trans("DateIsNotEnough");
 				}
 			}
 			else

--- a/htdocs/compta/facture/list.php
+++ b/htdocs/compta/facture/list.php
@@ -74,26 +74,26 @@
 $search_montant_ttc=GETPOST('search_montant_ttc','alpha');
 $search_status=GETPOST('search_status','int');
 $search_paymentmode=GETPOST('search_paymentmode','int');
 $search_town=GETPOST('search_town','alpha');
 $search_zip=GETPOST('search_zip','alpha');
 $search_state=trim(GETPOST("search_state"));
 $search_country=GETPOST("search_country",'int');
 $search_type_thirdparty=GETPOST("search_type_thirdparty",'int');
 $search_user = GETPOST('search_user','int');
 $search_sale = GETPOST('search_sale','int');
-$search_day	= GETPOST('search_day','int');
-$search_month	= GETPOST('search_month','int');
-$search_year	= GETPOST('search_year','int');
-$search_day_lim	= GETPOST('search_day_lim','int');
-$search_month_lim	= GETPOST('search_month_lim','int');
-$search_year_lim	= GETPOST('search_year_lim','int');
+$day	= GETPOST('day','int');
+$month	= GETPOST('month','int');
+$year	= GETPOST('year','int');
+$day_lim	= GETPOST('day_lim','int');
+$month_lim	= GETPOST('month_lim','int');
+$year_lim	= GETPOST('year_lim','int');
 $option = GETPOST('option');
 if ($option == 'late') {
 	$search_status = '1';
 }
 $filtre	= GETPOST('filtre','alpha');
 $limit = GETPOST('limit')?GETPOST('limit','int'):$conf->liste_limit;
 $sortfield = GETPOST("sortfield",'alpha');
 $sortorder = GETPOST("sortorder",'alpha');
 $page = GETPOST("page",'int');
 if (empty($page) || $page == -1) { $page = 0; }     // If $page is not defined, or '' or -1
@@ -180,28 +180,28 @@
 	$search_montant_localtax2='';
 	$search_montant_ttc='';
 	$search_status='';
 	$search_paymentmode='';
 	$search_town='';
 	$search_zip="";
 	$search_state="";
 	$search_type='';
 	$search_country='';
 	$search_type_thirdparty='';
-	$search_day='';
-	$search_year='';
-	$search_month='';
+	$day='';
+	$year='';
+	$month='';
 	$option='';
 	$filter='';
-	$search_day_lim='';
-	$search_year_lim='';
-	$search_month_lim='';
+	$day_lim='';
+	$year_lim='';
+	$month_lim='';
 	$toselect='';
 	$search_array_options=array();
 }
 if (empty($reshook))
 {
 	$objectclass='Facture';
 	$objectlabel='Invoices';
 	$permtoread = $user->rights->facture->lire;
 	$permtocreate = $user->rights->facture->creer;
 	$permtodelete = $user->rights->facture->supprimer;
@@ -381,45 +381,45 @@
 if ($search_montant_localtax2 != '') $sql.= natural_search('f.localtax2', $search_montant_localtax2, 1);
 if ($search_montant_ttc != '') $sql.= natural_search('f.total_ttc', $search_montant_ttc, 1);
 if ($search_status != '' && $search_status >= 0)
 {
 	if ($search_status == '0') $sql.=" AND f.fk_statut = 0";  // draft
 	if ($search_status == '1') $sql.=" AND f.fk_statut = 1";  // unpayed
 	if ($search_status == '2') $sql.=" AND f.fk_statut = 2";  // payed     Not that some corrupted data may contains f.fk_statut = 1 AND f.paye = 1 (it means payed too but should not happend. If yes, reopen and reclassify billed)
 	if ($search_status == '3') $sql.=" AND f.fk_statut = 3";  // abandonned
 }
 if ($search_paymentmode > 0) $sql .= " AND f.fk_mode_reglement = ".$db->escape($search_paymentmode);
-if ($search_month > 0)
-{
-	if ($search_year > 0 && empty($search_day))
-	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_get_first_day($search_year,$search_month,false))."' AND '".$db->idate(dol_get_last_day($search_year,$search_month,false))."'";
-	else if ($search_year > 0 && ! empty($search_day))
-	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $search_month, $search_day, $search_year))."' AND '".$db->idate(dol_mktime(23, 59, 59, $search_month, $search_day, $serch_year))."'";
+if ($month > 0)
+{
+	if ($year > 0 && empty($day))
+	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_get_first_day($year,$month,false))."' AND '".$db->idate(dol_get_last_day($year,$month,false))."'";
+	else if ($year > 0 && ! empty($day))
+	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $month, $day, $year))."' AND '".$db->idate(dol_mktime(23, 59, 59, $month, $day, $year))."'";
 	else
 	$sql.= " AND date_format(f.datef, '%m') = '".$month."'";
 }
-else if ($search_year > 0)
-{
-	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_get_first_day($search_year,1,false))."' AND '".$db->idate(dol_get_last_day($search_year,12,false))."'";
+else if ($year > 0)
+{
+	$sql.= " AND f.datef BETWEEN '".$db->idate(dol_get_first_day($year,1,false))."' AND '".$db->idate(dol_get_last_day($year,12,false))."'";
 }
 if ($month_lim > 0)
 {
-	if ($search_year_lim > 0 && empty($search_day_lim))
-		$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_get_first_day($search_year_lim,$search_month_lim,false))."' AND '".$db->idate(dol_get_last_day($search_year_lim,$search_month_lim,false))."'";
-	else if ($search_year_lim > 0 && ! empty($search_day_lim))
-		$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $search_month_lim, $search_day_lim, $search_year_lim))."' AND '".$db->idate(dol_mktime(23, 59, 59, $search_month_lim, $search_day_lim, $search_year_lim))."'";
+	if ($year_lim > 0 && empty($day_lim))
+		$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_get_first_day($year_lim,$month_lim,false))."' AND '".$db->idate(dol_get_last_day($year_lim,$month_lim,false))."'";
+	else if ($year_lim > 0 && ! empty($day_lim))
+		$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $month_lim, $day_lim, $year_lim))."' AND '".$db->idate(dol_mktime(23, 59, 59, $month_lim, $day_lim, $year_lim))."'";
 	else
-		$sql.= " AND date_format(f.date_lim_reglement, '%m') = '".$db->escape($search_month_lim)."'";
-}
-else if ($search_year_lim > 0)
-{
-	$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_get_first_day($search_year_lim,1,false))."' AND '".$db->idate(dol_get_last_day($search_year_lim,12,false))."'";
+		$sql.= " AND date_format(f.date_lim_reglement, '%m') = '".$db->escape($month_lim)."'";
+}
+else if ($year_lim > 0)
+{
+	$sql.= " AND f.date_lim_reglement BETWEEN '".$db->idate(dol_get_first_day($year_lim,1,false))."' AND '".$db->idate(dol_get_last_day($year_lim,12,false))."'";
 }
 if ($option == 'late') $sql.=" AND f.date_lim_reglement < '".$db->idate(dol_now() - $conf->facture->client->warning_delay)."'";
 if ($search_sale > 0) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$search_sale;
 if ($search_user > 0)
 {
 	$sql.= " AND ec.fk_c_type_contact = tc.rowid AND tc.element='facture' AND tc.source='internal' AND ec.element_id = f.rowid AND ec.fk_socpeople = ".$search_user;
 }
 include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_sql.tpl.php';
 $parameters=array();
 $reshook=$hookmanager->executeHooks('printFieldListWhere',$parameters);    // Note that $action and $object may have been modified by hook
@@ -464,43 +464,43 @@
 	if ($socid)
 	{
 		$soc = new Societe($db);
 		$soc->fetch($socid);
 		if (empty($search_societe)) $search_societe = $soc->name;
 	}
 	$param='&socid='.$socid;
 	if (! empty($contextpage) && $contextpage != $_SERVER["PHP_SELF"]) $param.='&contextpage='.$contextpage;
 	if ($limit > 0 && $limit != $conf->liste_limit) $param.='&limit='.$limit;
 	if ($sall)				 $param.='&sall='.urlencode($sall);
-	if ($search_day)         $param.='&search_day='.urlencode($search_day);
-	if ($search_month)       $param.='&search_month='.urlencode($search_month);
-	if ($search_year)        $param.='&search_year=' .urlencode($search_year);
-	if ($search_day_lim)     $param.='&search_day_lim='.urlencode($search_day_lim);
-	if ($search_month_lim)   $param.='&search_month_lim='.urlencode($search_month_lim);
-	if ($search_year_lim)    $param.='&search_year_lim=' .urlencode($search_year_lim);
+	if ($day)                $param.='&day='.urlencode($day);
+	if ($month)              $param.='&month='.urlencode($month);
+	if ($year)               $param.='&year=' .urlencode($year);
+	if ($day_lim)            $param.='&day_lim='.urlencode($day_lim);
+	if ($month_lim)          $param.='&month_lim='.urlencode($month_lim);
+	if ($year_lim)           $param.='&year_lim=' .urlencode($year_lim);
 	if ($search_ref)         $param.='&search_ref=' .urlencode($search_ref);
 	if ($search_refcustomer) $param.='&search_refcustomer=' .urlencode($search_refcustomer);
 	if ($search_type != '')  $param.='&search_type='.urlencode($search_type);
 	if ($search_societe)     $param.='&search_societe=' .urlencode($search_societe);
 	if ($search_sale > 0)    $param.='&search_sale=' .urlencode($search_sale);
 	if ($search_user > 0)    $param.='&search_user=' .urlencode($search_user);
 	if ($search_product_category > 0)   $param.='$search_product_category=' .urlencode($search_product_category);
 	if ($search_montant_ht != '')  $param.='&search_montant_ht='.urlencode($search_montant_ht);
 	if ($search_montant_vat != '')  $param.='&search_montant_vat='.urlencode($search_montant_vat);
 	if ($search_montant_localtax1 != '')  $param.='&search_montant_localtax1='.urlencode($search_montant_localtax1);
 	if ($search_montant_localtax2 != '')  $param.='&search_montant_localtax2='.urlencode($search_montant_localtax2);
 	if ($search_montant_ttc != '') $param.='&search_montant_ttc='.urlencode($search_montant_ttc);
 	if ($search_status != '') $param.='&search_status='.urlencode($search_status);
 	if ($search_paymentmode > 0) $param.='search_paymentmode='.urlencode($search_paymentmode);
-	if ($show_files)         $param.='&show_files=' .urlencode($show_files);
-	if ($option)             $param.="&option=".urlencode($option);
-	if ($optioncss != '')    $param.='&optioncss='.urlencode($optioncss);
+	if ($show_files)         $param.='&show_files=' .$show_files;
+	if ($option)             $param.="&option=".$option;
+	if ($optioncss != '')    $param.='&optioncss='.$optioncss;
 	include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
 	$arrayofmassactions=array(
 		'validate'=>$langs->trans("Validate"),
 		'presend'=>$langs->trans("SendByMail"),
 		'builddoc'=>$langs->trans("PDFMerge"),
 	);
 	if ($conf->prelevement->enabled)
 	{
 	   $langs->load("withdrawals");
 	   $arrayofmassactions['withdrawrequest']=$langs->trans("MakeWithdrawRequest");
@@ -604,31 +604,31 @@
 		if (! empty($conf->global->INVOICE_USE_SITUATION))
 		{
 			$listtype[Facture::TYPE_SITUATION] = $langs->trans("InvoiceSituation");
 		}
 		print $form->selectarray('search_type', $listtype, $search_type, 1, 0, 0, '', 0, 0, 0, 'ASC', 'maxwidth100');
 		print '</td>';
 	}
 	if (! empty($arrayfields['f.date']['checked']))
 	{
 		print '<td class="liste_titre nowraponall" align="center">';
-		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day" value="'.dol_escape_htmltag($search_day).'">';
-		print '<input class="flat" type="text" size="1" maxlength="2" name="search_month" value="'.dol_escape_htmltag($search_month).'">';
-		$formother->select_year($search_year?$search_year:-1,'search_year',1, 20, 5, 0, 0, '', 'width75');
+		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="day" value="'.dol_escape_htmltag($day).'">';
+		print '<input class="flat" type="text" size="1" maxlength="2" name="month" value="'.dol_escape_htmltag($month).'">';
+		$formother->select_year($year?$year:-1,'year',1, 20, 5, 0, 0, '', 'width75');
 		print '</td>';
 	}
 	if (! empty($arrayfields['f.date_lim_reglement']['checked']))
 	{
 		print '<td class="liste_titre nowraponall" align="center">';
-		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_day_lim" value="'.dol_escape_htmltag($search_day_lim).'">';
-		print '<input class="flat" type="text" size="1" maxlength="2" name="search_month_lim" value="'.dol_escape_htmltag($search_month_lim).'">';
-		$formother->select_year($search_year_lim?$search_year_lim:-1,'search_year_lim',1, 20, 5, 0, 0, '', 'width75');
+		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="day_lim" value="'.dol_escape_htmltag($day_lim).'">';
+		print '<input class="flat" type="text" size="1" maxlength="2" name="month_lim" value="'.dol_escape_htmltag($month_lim).'">';
+		$formother->select_year($year_lim?$year_lim:-1,'year_lim',1, 20, 5, 0, 0, '', 'width75');
 		print '<br><input type="checkbox" name="option" value="late"'.($option == 'late'?' checked':'').'> '.$langs->trans("Late");
 		print '</td>';
 	}
 	if (! empty($arrayfields['p.ref']['checked']))
 	{
 		print '<td class="liste_titre"><input class="flat" type="text" size="6" name="search_project" value="'.$search_project.'"></td>';
 	}
 	if (! empty($arrayfields['s.nom']['checked']))
 	{
 		print '<td class="liste_titre"><input class="flat" type="text" size="6" name="search_societe" value="'.$search_societe.'"></td>';

--- a/htdocs/compta/localtax/index.php
+++ b/htdocs/compta/localtax/index.php
@@ -32,25 +32,25 @@
 $year=GETPOST("year","int");
 if ($year == 0)
 {
     $year_current = strftime("%Y",time());
     $year_start = $year_current;
 } else {
     $year_current = $year;
     $year_start = $year;
 }
 $socid = isset($_GET["socid"])?$_GET["socid"]:'';
-if ($user->societe_id)
+if ($user->societe_id) 
     $socid=$user->societe_id;
 $result = restrictedArea($user, 'tax', '', '', 'charges');
 $modetax = $conf->global->TAX_MODE;
-if (isset($_GET["modetax"]))
+if (isset($_GET["modetax"])) 
     $modetax=$_GET["modetax"];
 /**
  * print function
  *
  * @param   DoliDB $db          Database
  * @param   string $sql     sql
  * @param   string $date    date
  * @return  void
  */
 function pt ($db, $sql, $date)
@@ -130,22 +130,22 @@
     print "<td align=\"right\">".$langs->transcountry($LTCustomer,$mysoc->country_code)."</td><td></td>";
 }
 print "<td align=\"right\">".$langs->trans("TotalToPay")."</td>";
 print "<td>&nbsp;</td>\n";
 print "</tr>\n";
 $y = $year_current ;
 $var=True;
 $total=0; $subtotalcoll=0; $subtotalpaye=0; $subtotal=0;
 $i=0;
 for ($m = 1 ; $m < 13 ; $m++ ) {
-	$coll_listsell = tax_by_date('vat', $db, $y, 0, 0, 0, $modetax, 'sell', $m);
-	$coll_listbuy = tax_by_date('vat', $db, $y, 0, 0, 0, $modetax, 'buy', $m);
+    $coll_listsell = vat_by_date($db, $y, 0, 0, 0, $modetax, 'sell', $m);
+    $coll_listbuy = vat_by_date($db, $y, 0, 0, 0, $modetax, 'buy', $m);
     $action = "tva";
     $object = array(&$coll_listsell, &$coll_listbuy);
     $parameters["mode"] = $modetax;
     $parameters["year"] = $y;
     $parameters["month"] = $m;
     $parameters["type"] = 'localtax'.$localTaxType;
     $hookmanager->initHooks(array('externalbalance'));
     $reshook=$hookmanager->executeHooks('addVatLine',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
     if (! is_array($coll_listbuy) && $coll_listbuy == -1) {
         $langs->load("errors");

--- a/htdocs/compta/paiement/cheque/index.php
+++ b/htdocs/compta/paiement/cheque/index.php
@@ -67,21 +67,21 @@
   print "</table>\n";
 }
 else
 {
   dol_print_error($db);
 }
 print '</div><div class="fichetwothirdright"><div class="ficheaddleft">';
 $max=10;
 $sql = "SELECT bc.rowid, bc.date_bordereau as db, bc.amount, bc.ref as ref,";
 $sql.= " bc.statut, bc.nbcheque,";
-$sql.= " ba.ref, ba.label, ba.rowid as bid, ba.number, ba.currency_code, ba.account_number, ba.fk_accountancy_journal,";
+$sql.= " ba.ref, ba.label, ba.rowid as bid, ba.number, ba.currency_code, ba.account_number, ba.accountancy_journal,";
 $sql.= " aj.code";
 $sql.= " FROM ".MAIN_DB_PREFIX."bordereau_cheque as bc, ".MAIN_DB_PREFIX."bank_account as ba";
 $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."accounting_journal as aj ON aj.rowid = ba.fk_accountancy_journal";
 $sql.= " WHERE ba.rowid = bc.fk_bank_account";
 $sql.= " AND bc.entity = ".$conf->entity;
 $sql.= " ORDER BY bc.date_bordereau DESC, rowid DESC";
 $sql.= $db->plimit($max);
 $resql = $db->query($sql);
 if ($resql)
 {
@@ -100,21 +100,20 @@
         $checkdepositstatic->id=$objp->rowid;
         $checkdepositstatic->ref=($objp->ref?$objp->ref:$objp->rowid);
 	    $checkdepositstatic->statut=$objp->statut;
 		$accountstatic->id=$objp->bid;
 		$accountstatic->ref=$objp->ref;
 		$accountstatic->label=$objp->label;
 		$accountstatic->number=$objp->number;
 		$accountstatic->currency_code=$objp->currency_code;
 		$accountstatic->account_number=$objp->account_number;
 		$accountstatic->accountancy_journal=$objp->code;
-		$accountstatic->fk_accountancy_journal=$objp->fk_accountancy_journal;
 		print '<tr class="oddeven">'."\n";
 		print '<td>'.$checkdepositstatic->getNomUrl(1).'</td>';
 		print '<td>'.dol_print_date($db->jdate($objp->db),'day').'</td>';
 		print '<td>'.$accountstatic->getNomUrl(1).'</td>';
 		print '<td align="right">'.$objp->nbcheque.'</td>';
 		print '<td align="right">'.price($objp->amount).'</td>';
 		print '<td align="right">'.$checkdepositstatic->LibStatut($objp->statut,3).'</td>';
 		print '</tr>';
 	}
 	print "</table>";

--- a/htdocs/compta/resultat/clientfourn.php
+++ b/htdocs/compta/resultat/clientfourn.php
@@ -87,21 +87,21 @@
         }
         else $month_end=$month_start;
         $date_start=dol_get_first_day($year_start,$month_start,false); $date_end=dol_get_last_day($year_end,$month_end,false);
     }
     if ($q==1) { $date_start=dol_get_first_day($year_start,1,false); $date_end=dol_get_last_day($year_start,3,false); }
     if ($q==2) { $date_start=dol_get_first_day($year_start,4,false); $date_end=dol_get_last_day($year_start,6,false); }
     if ($q==3) { $date_start=dol_get_first_day($year_start,7,false); $date_end=dol_get_last_day($year_start,9,false); }
     if ($q==4) { $date_start=dol_get_first_day($year_start,10,false); $date_end=dol_get_last_day($year_start,12,false); }
 }
 $tmps=dol_getdate($date_start);
-$year_start = $tmps['year'];
+$start_year = $tmps['year'];
 $tmpe=dol_getdate($date_end);
 $year_end = $tmpe['year'];
 $nbofyear = ($year_end - $start_year) + 1;
 $modecompta = $conf->global->ACCOUNTING_MODE;
 if (! empty($conf->accounting->enabled)) $modecompta='BOOKKEEPING';
 if (GETPOST("modecompta",'alpha')) $modecompta=GETPOST("modecompta",'alpha');
 $AccCat = new AccountancyCategory($db);
 /*
  * View
  */
@@ -200,21 +200,20 @@
 	$predefinedgroupwhere.= " OR ";
 	$predefinedgroupwhere.= " (pcg_type = 'INCOME')";
 	$predefinedgroupwhere.= ")";
 	$charofaccountstring = $conf->global->CHARTOFACCOUNTS;
 	$charofaccountstring=dol_getIdFromCode($db, $conf->global->CHARTOFACCOUNTS, 'accounting_system', 'rowid', 'pcg_version');
 	$sql = "SELECT f.thirdparty_code as name, -1 as socid, aa.pcg_type, aa.pcg_subtype, sum(f.credit - f.debit) as amount";
 	$sql.= " FROM ".MAIN_DB_PREFIX."accounting_bookkeeping as f";
 	$sql.= ", ".MAIN_DB_PREFIX."accounting_account as aa";
 	$sql.= " WHERE f.numero_compte = aa.account_number";
 	$sql.= " AND ".$predefinedgroupwhere;
-	$sql.= " AND fk_pcg_version = '".$db->escape($charofaccountstring)."'";
 	$sql.= " AND f.entity = ".$conf->entity;
 	if (! empty($date_start) && ! empty($date_end))
 		$sql.= " AND f.doc_date >= '".$db->idate($date_start)."' AND f.doc_date <= '".$db->idate($date_end)."'";
 	$sql.= " GROUP BY pcg_type, pcg_subtype, name, socid";
 	$sql.= $db->order($sortfield, $sortorder);
 	$oldpcgtype = '';
 	$oldpcgsubtype = '';
 	dol_syslog("get bookkeeping entries", LOG_DEBUG);
 	$result = $db->query($sql);
 	if ($result) {
@@ -233,32 +232,32 @@
 				print '<tr class="oddeven">';
 				print '<td>&nbsp;</td>';
 				print '<td>'.$objp->pcg_type.($objp->pcg_subtype != 'XXXXXX'?' - '.$objp->pcg_subtype:'').($objp->name?' ('.$objp->name.')':'')."</td>\n";
 				print '<td align="right">'.price($objp->amount)."</td>\n";
 				print "</tr>\n";
 				$total_ht += (isset($objp->amount)?$objp->amount:0);
 				$total_ttc +=  (isset($objp->amount)?$objp->amount:0);
 				if ($showaccountdetail != 'no')
 				{
 					$tmppredefinedgroupwhere="pcg_type = '".$db->escape($objp->pcg_type)."' AND pcg_subtype = '".$db->escape($objp->pcg_subtype)."'";
-					$tmppredefinedgroupwhere.= " AND fk_pcg_version = '".$db->escape($charofaccountstring)."'";
+					$tmppredefinedgroupwhere.= " AND fk_pcg_version = '".$charofaccountstring."'";
 					$cpts = $AccCat->getCptsCat(0, $tmppredefinedgroupwhere);
 					foreach($cpts as $i => $cpt)
 					{
 						$return = $AccCat->getResult($cpt['account_number'], 0, $date_start, $date_end, $cpt['dc']);
 						if ($return < 0) {
 							setEventMessages(null, $AccCat->errors, 'errors');
 							$resultN=0;
 						} else {
 							$resultN=$AccCat->sdc;
 						}
-						if ($showaccountdetail == 'all' || $resultN <> 0)
+						if ($showaccountdetail == 'all' || $resultN > 0)
 						{
 							print '<tr>';
 							print '<td></td>';
 							print '<td class="tdoverflowmax200"> &nbsp; &nbsp; ' . length_accountg($cpt['account_number']) . ' - ' . $cpt['account_label'] . '</td>';
 							print '<td align="right">' . price($resultN) . '</td>';
 							print "</tr>\n";
 						}
 					}
 				}
 				$i++;

--- a/htdocs/compta/resultat/index.php
+++ b/htdocs/compta/resultat/index.php
@@ -68,21 +68,21 @@
 		}
 		else $month_end=$month_start;
 		$date_start=dol_get_first_day($year_start,$month_start,false); $date_end=dol_get_last_day($year_end,$month_end,false);
 	}
 	if ($q==1) { $date_start=dol_get_first_day($year_start,1,false); $date_end=dol_get_last_day($year_start,3,false); }
 	if ($q==2) { $date_start=dol_get_first_day($year_start,4,false); $date_end=dol_get_last_day($year_start,6,false); }
 	if ($q==3) { $date_start=dol_get_first_day($year_start,7,false); $date_end=dol_get_last_day($year_start,9,false); }
 	if ($q==4) { $date_start=dol_get_first_day($year_start,10,false); $date_end=dol_get_last_day($year_start,12,false); }
 }
 $tmps=dol_getdate($date_start);
-$year_start = $tmps['year'];
+$start_year = $tmps['year'];
 $tmpe=dol_getdate($date_end);
 $year_end = $tmpe['year'];
 $nbofyear = ($year_end - $start_year) + 1;
 $socid = GETPOST('socid','int');
 if ($user->societe_id > 0) $socid = $user->societe_id;
 if (! empty($conf->comptabilite->enabled)) $result=restrictedArea($user,'compta','','','resultat');
 if (! empty($conf->accounting->enabled)) $result=restrictedArea($user,'accounting','','','comptarapport');
 $modecompta = $conf->global->ACCOUNTING_MODE;
 if (! empty($conf->accounting->enabled)) $modecompta='BOOKKEEPING';
 if (GETPOST("modecompta",'alpha')) $modecompta=GETPOST("modecompta",'alpha');
@@ -308,20 +308,21 @@
 		if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) $sql.= " AND f.type IN (0,1,2,5)";
 		else $sql.= " AND f.type IN (0,1,2,3,5)";
 		$sql.= " AND f.entity = ".$conf->entity;
     	if (! empty($date_start) && ! empty($date_end))
     		$sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
 		$sql.= " GROUP BY dm";
 		dol_syslog("get vat to pay", LOG_DEBUG);
 		$result=$db->query($sql);
 		if ($result) {
 			$num = $db->num_rows($result);
+			$var=false;
 			$i = 0;
 			if ($num) {
 				while ($i < $num) {
 					$obj = $db->fetch_object($result);
 					if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
 					$decaiss[$obj->dm] += $obj->amount;
 					if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
 					$decaiss_ttc[$obj->dm] += $obj->amount;
 					$i++;
 				}
@@ -335,20 +336,21 @@
 		if (! empty($conf->global->FACTURE_DEPOSITS_ARE_JUST_PAYMENTS)) $sql.= " AND f.type IN (0,1,2)";
 		else $sql.= " AND f.type IN (0,1,2,3)";
 		$sql.= " AND f.entity = ".$conf->entity;
     	if (! empty($date_start) && ! empty($date_end))
     		$sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
 		$sql.= " GROUP BY dm";
 		dol_syslog("get vat to receive back", LOG_DEBUG);
 		$result=$db->query($sql);
 		if ($result) {
 			$num = $db->num_rows($result);
+			$var=false;
 			$i = 0;
 			if ($num) {
 				while ($i < $num) {
 					$obj = $db->fetch_object($result);
 					if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
 					$encaiss[$obj->dm] += $obj->amount;
 					if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
 					$encaiss_ttc[$obj->dm] += $obj->amount;
 					$i++;
 				}
@@ -363,20 +365,21 @@
 		$sql.= " FROM ".MAIN_DB_PREFIX."tva as t";
 		$sql.= " WHERE amount > 0";
 		$sql.= " AND t.entity = ".$conf->entity;
     	if (! empty($date_start) && ! empty($date_end))
     		$sql.= " AND t.datev >= '".$db->idate($date_start)."' AND t.datev <= '".$db->idate($date_end)."'";
 		$sql.= " GROUP BY dm";
 		dol_syslog("get vat really paid", LOG_DEBUG);
 		$result=$db->query($sql);
 		if ($result) {
 			$num = $db->num_rows($result);
+			$var=false;
 			$i = 0;
 			if ($num) {
 				while ($i < $num) {
 					$obj = $db->fetch_object($result);
 					if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
 					$decaiss[$obj->dm] += $obj->amount;
 					if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
 					$decaiss_ttc[$obj->dm] += $obj->amount;
 					$i++;
 				}
@@ -388,20 +391,21 @@
 		$sql.= " FROM ".MAIN_DB_PREFIX."tva as t";
 		$sql.= " WHERE amount < 0";
 		$sql.= " AND t.entity = ".$conf->entity;
     	if (! empty($date_start) && ! empty($date_end))
     		$sql.= " AND t.datev >= '".$db->idate($date_start)."' AND t.datev <= '".$db->idate($date_end)."'";
 		$sql.= " GROUP BY dm";
 		dol_syslog("get vat really received back", LOG_DEBUG);
 		$result=$db->query($sql);
 		if ($result) {
 			$num = $db->num_rows($result);
+			$var=false;
 			$i = 0;
 			if ($num) {
 				while ($i < $num) {
 					$obj = $db->fetch_object($result);
 					if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
 					$encaiss[$obj->dm] += $obj->amount;
 					if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
 					$encaiss_ttc[$obj->dm] += $obj->amount;
 					$i++;
 				}
@@ -442,20 +446,21 @@
 		$sql.= " AND c.deductible = 0";
     	if (! empty($date_start) && ! empty($date_end))
     		$sql.= " AND p.datep >= '".$db->idate($date_start)."' AND p.datep <= '".$db->idate($date_end)."'";
 	}
 	$sql.= " AND cs.entity = ".$conf->entity;
 	$sql.= " GROUP BY c.libelle, dm";
 	dol_syslog("get social contributions deductible=0 ", LOG_DEBUG);
 	$result=$db->query($sql);
 	if ($result) {
 		$num = $db->num_rows($result);
+		$var=false;
 		$i = 0;
 		if ($num) {
 			while ($i < $num) {
 				$obj = $db->fetch_object($result);
 				if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
 				$decaiss[$obj->dm] += $obj->amount;
 				if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
 				$decaiss_ttc[$obj->dm] += $obj->amount;
 				$i++;
 			}
@@ -495,20 +500,21 @@
 		$sql.= " AND c.deductible = 1";
     	if (! empty($date_start) && ! empty($date_end))
     		$sql.= " AND p.datep >= '".$db->idate($date_start)."' AND p.datep <= '".$db->idate($date_end)."'";
 	}
 	$sql.= " AND cs.entity = ".$conf->entity;
 	$sql.= " GROUP BY c.libelle, dm";
 	dol_syslog("get social contributions paid deductible=1", LOG_DEBUG);
 	$result=$db->query($sql);
 	if ($result) {
 		$num = $db->num_rows($result);
+		$var=false;
 		$i = 0;
 		if ($num) {
 			while ($i < $num) {
 				$obj = $db->fetch_object($result);
 				if (! isset($decaiss[$obj->dm])) $decaiss[$obj->dm]=0;
 				$decaiss[$obj->dm] += $obj->amount;
 				if (! isset($decaiss_ttc[$obj->dm])) $decaiss_ttc[$obj->dm]=0;
 				$decaiss_ttc[$obj->dm] += $obj->amount;
 				$i++;
 			}
@@ -532,20 +538,21 @@
 	$sql = "SELECT p.label as nom, date_format(".$column.",'%Y-%m') as dm, sum(p.amount) as amount";
 	$sql .= " FROM " . MAIN_DB_PREFIX . "payment_salary as p";
 	$sql .= " WHERE p.entity IN (".getEntity('payment_salary').")";
 	if (! empty($date_start) && ! empty($date_end))
 		$sql.= " AND ".$column." >= '".$db->idate($date_start)."' AND ".$column." <= '".$db->idate($date_end)."'";
 	$sql .= " GROUP BY p.label, dm";
 	dol_syslog("get social salaries payments");
 	$result = $db->query($sql);
 	if ($result) {
 		$num = $db->num_rows($result);
+		$var = false;
 		$i = 0;
 		if ($num) {
 			while ($i < $num) {
 				$obj = $db->fetch_object($result);
 				if (! isset($decaiss[$obj->dm]))
 					$decaiss[$obj->dm] = 0;
 				$decaiss[$obj->dm] += $obj->amount;
 				if (! isset($decaiss_ttc[$obj->dm]))
 					$decaiss_ttc[$obj->dm] = 0;
 				$decaiss_ttc[$obj->dm] += $obj->amount;
@@ -636,20 +643,21 @@
    	    $sql.= " AND fk_statut >= 2";
 		if (! empty($date_start) && ! empty($date_end))
 			$sql.= " AND pe.datep >= '".$db->idate($date_start)."' AND pe.datep <= '".$db->idate($date_end)."'";
      }
     $sql.= " GROUP BY p.societe, p.firstname, p.lastname, dm";
     dol_syslog("get donation payments");
     $result=$db->query($sql);
     if ($result)
     {
     	$num = $db->num_rows($result);
+    	$var=false;
     	$i = 0;
     	if ($num)
     	{
     		while ($i < $num)
     		{
     			$obj = $db->fetch_object($result);
     			if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
     			$encaiss[$obj->dm] += $obj->amount;
     			if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
     			$encaiss_ttc[$obj->dm] += $obj->amount;
@@ -662,52 +670,49 @@
     	dol_print_error($db);
     }
 }
 elseif ($modecompta == 'BOOKKEEPING') {
 }
 /*
  * Request in mode BOOKKEEPING
  */
 if (! empty($conf->accounting->enabled) && ($modecompta == 'BOOKKEEPING'))
 {
-	$predefinedgroupwhere = "(";
-	$predefinedgroupwhere.= " (pcg_type = 'EXPENSE')";
-	$predefinedgroupwhere.= " OR ";
-	$predefinedgroupwhere.= " (pcg_type = 'INCOME')";
-	$predefinedgroupwhere.= ")";
-	$charofaccountstring = $conf->global->CHARTOFACCOUNTS;
-	$charofaccountstring=dol_getIdFromCode($db, $conf->global->CHARTOFACCOUNTS, 'accounting_system', 'rowid', 'pcg_version');
+	$subtotal_ht = 0;
+	$subtotal_ttc = 0;
 	$sql = "SELECT b.doc_ref, b.numero_compte, b.subledger_account, b.subledger_label, pcg_type, date_format(b.doc_date,'%Y-%m') as dm, sum(b.debit) as debit, sum(b.credit) as credit, sum(b.montant) as amount";
 	$sql.= " FROM ".MAIN_DB_PREFIX."accounting_bookkeeping as b, ".MAIN_DB_PREFIX."accounting_account as aa";
 	$sql.= " WHERE b.numero_compte = aa.account_number AND b.entity = ".$conf->entity;
-	$sql.= " AND ".$predefinedgroupwhere;
-	$sql.= " AND fk_pcg_version = '".$db->escape($charofaccountstring)."'";
+	$sql.= " AND (";
+	$sql.= " (pcg_type = 'EXPENSE')";
+	$sql.= " OR ";
+	$sql.= " (pcg_type = 'INCOME')";
+	$sql.= ")";
 	if (! empty($date_start) && ! empty($date_end))
 		$sql.= " AND b.doc_date >= '".$db->idate($date_start)."' AND b.doc_date <= '".$db->idate($date_end)."'";
 	$sql.= " GROUP BY b.doc_ref, b.numero_compte, b.subledger_account, b.subledger_label, pcg_type, dm";
-	$subtotal_ht = 0;
-	$subtotal_ttc = 0;
 	dol_syslog("get bookkeeping record");
 	$result=$db->query($sql);
 	if ($result)
 	{
 		$num = $db->num_rows($result);
+		$var=false;
 		$i = 0;
 		if ($num)
 		{
 			while ($i < $num)
 			{
 				$obj = $db->fetch_object($result);
 				if (! isset($encaiss[$obj->dm])) $encaiss[$obj->dm]=0;
 				$encaiss[$obj->dm] += $obj->debit;
 				if (! isset($encaiss_ttc[$obj->dm])) $encaiss_ttc[$obj->dm]=0;
-				$encaiss_ttc[$obj->dm] += 0;
+				$encaiss_ttc[$obj->dm] += $obj->credit;
 				$i++;
 			}
 		}
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 }
 $action = "balance";
@@ -738,80 +743,54 @@
 	print '<td class="liste_titre" align="center">';
 	$htmlhelp='';
 	print $form->textwithpicto($langs->trans("Outcome"), $htmlhelp);
 	print '</td>';
 	print '<td class="liste_titre" align="center" class="borderrightlight">';
 	$htmlhelp='';
 	print $form->textwithpicto($langs->trans("Income"), $htmlhelp);
 	print '</td>';
 }
 print '</tr>';
+$var=True;
 $nb_mois_decalage = $conf->global->SOCIETE_FISCAL_MONTH_START?($conf->global->SOCIETE_FISCAL_MONTH_START-1):0;
 for ($mois = 1+$nb_mois_decalage ; $mois <= 12+$nb_mois_decalage ; $mois++)
 {
 	$mois_modulo = $mois;
 	if($mois>12) {$mois_modulo = $mois-12;}
 	print '<tr class="oddeven">';
 	print "<td>".dol_print_date(dol_mktime(12,0,0,$mois_modulo,1,$annee),"%B")."</td>";
 	for ($annee = $year_start ; $annee <= $year_end ; $annee++)
 	{
 		$annee_decalage=$annee;
 		if($mois>12) {$annee_decalage=$annee+1;}
 		$case = strftime("%Y-%m",dol_mktime(12,0,0,$mois_modulo,1,$annee_decalage));
 		print '<td align="right">&nbsp;';
-		if ($modecompta == 'BOOKKEEPING')
+		if (isset($decaiss_ttc[$case]) && $decaiss_ttc[$case] != 0)
 		{
-			if (isset($decaiss[$case]) && $decaiss[$case] != 0)
-			{
-				print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($decaiss[$case],'MT')).'</a>';
-				if (! isset($totsorties[$annee])) $totsorties[$annee]=0;
-				$totsorties[$annee]+=$decaiss[$case];
-			}
-		}
-		else
-		{
-			if (isset($decaiss_ttc[$case]) && $decaiss_ttc[$case] != 0)
-			{
-				print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($decaiss_ttc[$case],'MT')).'</a>';
-				if (! isset($totsorties[$annee])) $totsorties[$annee]=0;
-				$totsorties[$annee]+=$decaiss_ttc[$case];
-			}
+			print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($decaiss_ttc[$case],'MT')).'</a>';
+			if (! isset($totsorties[$annee])) $totsorties[$annee]=0;
+			$totsorties[$annee]+=$decaiss_ttc[$case];
 		}
 		print "</td>";
 		print '<td align="right" class="borderrightlight">&nbsp;';
-		if ($modecompta == 'BOOKKEEPING')
+		if (isset($encaiss_ttc[$case]))
 		{
-			if (isset($encaiss[$case]))
-			{
-				print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($encaiss[$case],'MT')).'</a>';
-				if (! isset($totentrees[$annee])) $totentrees[$annee]=0;
-				$totentrees[$annee]+=$encaiss[$case];
-			}
-		}
-		else
-		{
-			if (isset($encaiss_ttc[$case]))
-			{
-				print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($encaiss_ttc[$case],'MT')).'</a>';
-				if (! isset($totentrees[$annee])) $totentrees[$annee]=0;
-				$totentrees[$annee]+=$encaiss_ttc[$case];
-			}
+			print '<a href="clientfourn.php?year='.$annee_decalage.'&month='.$mois_modulo.($modecompta?'&modecompta='.$modecompta:'').'">'.price(price2num($encaiss_ttc[$case],'MT')).'</a>';
+			if (! isset($totentrees[$annee])) $totentrees[$annee]=0;
+			$totentrees[$annee]+=$encaiss_ttc[$case];
 		}
 		print "</td>";
 	}
 	print '</tr>';
 }
 $nbcols=0;
-print '<tr class="liste_total impair"><td>';
-if ($modecompta == 'BOOKKEEPING') print $langs->trans("Total");
-else print $langs->trans("TotalTTC");
-print '</td>';
+print '<tr class="liste_total impair"><td>'.$langs->trans("TotalTTC").'</td>';
 for ($annee = $year_start ; $annee <= $year_end ; $annee++)
 {
 	$nbcols+=2;
 	print '<td align="right">'.(isset($totsorties[$annee])?price(price2num($totsorties[$annee],'MT')):'&nbsp;').'</td>';
 	print '<td align="right" style="border-right: 1px solid #DDD">'.(isset($totentrees[$annee])?price(price2num($totentrees[$annee],'MT')):'&nbsp;').'</td>';
 }
 print "</tr>\n";
 print '<tr class="impair"><td>&nbsp;</td>';
 print '<td colspan="'.$nbcols.'">&nbsp;</td>';
 print "</tr>\n";

--- a/htdocs/compta/tva/index.php
+++ b/htdocs/compta/tva/index.php
@@ -107,22 +107,22 @@
 print '<td align="right">'.$langs->trans("VATToCollect").'</td>';
 print '<td align="right">'.$langs->trans("TotalToPay").'</td>';
 print '<td>&nbsp;</td>'."\n";
 print '</tr>'."\n";
 $y = $year_current ;
 $var=True;
 $total=0; $subtotalcoll=0; $subtotalpaye=0; $subtotal=0;
 $i=0;
 for ($m = 1 ; $m < 13 ; $m++ )
 {
-	$coll_listsell = tax_by_date('vat', $db, $y, 0, 0, 0, $modetax, 'sell', $m);
-	$coll_listbuy = tax_by_date('vat', $db, $y, 0, 0, 0, $modetax, 'buy', $m);
+    $coll_listsell = vat_by_date($db, $y, 0, 0, 0, $modetax, 'sell', $m);
+    $coll_listbuy = vat_by_date($db, $y, 0, 0, 0, $modetax, 'buy', $m);
     $action = "tva";
     $object = array(&$coll_listsell, &$coll_listbuy);
     $parameters["mode"] = $modetax;
     $parameters["year"] = $y;
     $parameters["month"] = $m;
     $parameters["type"] = 'vat';
     $hookmanager->initHooks(array('externalbalance'));
     $reshook=$hookmanager->executeHooks('addVatLine',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
     if (! is_array($coll_listbuy) && $coll_listbuy == -1)
     {

--- a/htdocs/compta/tva/quadri_detail.php
+++ b/htdocs/compta/tva/quadri_detail.php
@@ -165,22 +165,22 @@
 	if ($mysoc->tva_assuj) $vatsup.=' ('.$langs->trans("ToGetBack").')';
 }
 report_header($name,'',$period,$periodlink,$description,$builddate,$exportlink,array(),$calcmode);
 $vatcust=$langs->trans("VATReceived");
 $vatsup=$langs->trans("VATPaid");
 $vatexpensereport=$langs->trans("VATPaid");
 print '<table class="noborder" width="100%">';
 $y = $year_current;
 $total = 0;
 $i=0;
-$x_coll = tax_by_date('vat', $db, 0, 0, $date_start, $date_end, $modetax, 'sell');
-$x_paye = tax_by_date('vat', $db, 0, 0, $date_start, $date_end, $modetax, 'buy');
+$x_coll = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'sell');
+$x_paye = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'buy');
 if (! is_array($x_coll) || ! is_array($x_paye))
 {
 	$langs->load("errors");
 	if ($x_coll == -1)
 		print '<tr><td colspan="5">'.$langs->trans("ErrorNoAccountancyModuleLoaded").'</td></tr>';
 	else if ($x_coll == -2)
 		print '<tr><td colspan="5">'.$langs->trans("FeatureNotYetAvailable").'</td></tr>';
 	else
 		print '<tr><td colspan="5">'.$langs->trans("Error").'</td></tr>';
 }

--- a/htdocs/compta/tva/quarter_report.php
+++ b/htdocs/compta/tva/quarter_report.php
@@ -207,22 +207,22 @@
 	}
 }
 report_header($name,'',$period,$periodlink,$description,$builddate,$exportlink,array(),$calcmode);
 $vatcust=$langs->trans("VATReceived");
 $vatsup=$langs->trans("VATPaid");
 print '<table class="noborder" width="100%">';
 $y = $year_current;
 $total = 0;
 $i=0;
 $columns = 6;
-$x_coll = tax_by_date('vat', $db, 0, 0, $date_start, $date_end, $modetax, 'sell');
-$x_paye = tax_by_date('vat', $db, 0, 0, $date_start, $date_end, $modetax, 'buy');
+$x_coll = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'sell');
+$x_paye = vat_by_date($db, 0, 0, $date_start, $date_end, $modetax, 'buy');
 if (!is_array($x_coll) || !is_array($x_paye)) {
 	$langs->load("errors");
 	if ($x_coll == -1) {
 		print '<tr><td colspan="' . $columns . '">' . $langs->trans("ErrorNoAccountancyModuleLoaded") . '</td></tr>';
 	} else if ($x_coll == -2) {
 		print '<tr><td colspan="' . $columns . '">' . $langs->trans("FeatureNotYetAvailable") . '</td></tr>';
 	} else {
 		print '<tr><td colspan="' . $columns . '">' . $langs->trans("Error") . '</td></tr>';
 	}
 } else {

--- a/htdocs/contact/card.php
+++ b/htdocs/contact/card.php
@@ -135,40 +135,40 @@
 			header("Location: ".$_SERVER['PHP_SELF'].'?id='.$id);
 			exit;
 		}
 	}
 	if ($action == 'add' && $user->rights->societe->contact->creer)
 	{
 		$db->begin();
         if ($canvas) $object->canvas=$canvas;
         $object->entity			= (GETPOSTISSET('entity')?GETPOST('entity', 'int'):$conf->entity);
         $object->socid			= GETPOST("socid",'int');
-        $object->lastname		= GETPOST("lastname",'alpha');
-        $object->firstname		= GETPOST("firstname",'alpha');
-        $object->civility_id	= GETPOST("civility_id",'alpha');
-        $object->poste			= GETPOST("poste",'alpha');
-        $object->address		= GETPOST("address",'alpha');
-        $object->zip			= GETPOST("zipcode",'alpha');
-        $object->town			= GETPOST("town",'alpha');
+        $object->lastname		= GETPOST("lastname");
+        $object->firstname		= GETPOST("firstname");
+        $object->civility_id		= GETPOST("civility_id",'alpha');
+        $object->poste			= GETPOST("poste");
+        $object->address			= GETPOST("address");
+        $object->zip				= GETPOST("zipcode");
+        $object->town			= GETPOST("town");
         $object->country_id		= GETPOST("country_id",'int');
         $object->state_id		= GETPOST("state_id",'int');
-        $object->skype			= GETPOST("skype",'alpha');
+        $object->skype			= GETPOST("skype");
         $object->email			= GETPOST("email",'alpha');
-        $object->phone_pro		= GETPOST("phone_pro",'alpha');
-        $object->phone_perso	= GETPOST("phone_perso",'alpha');
-        $object->phone_mobile	= GETPOST("phone_mobile",'alpha');
-        $object->fax			= GETPOST("fax",'alpha');
+        $object->phone_pro		= GETPOST("phone_pro");
+        $object->phone_perso		= GETPOST("phone_perso");
+        $object->phone_mobile	= GETPOST("phone_mobile");
+        $object->fax				= GETPOST("fax");
         $object->jabberid		= GETPOST("jabberid",'alpha');
 		$object->no_email		= GETPOST("no_email",'int');
         $object->priv			= GETPOST("priv",'int');
-        $object->note_public	= GETPOST("note_public",'none');
-        $object->note_private	= GETPOST("note_private",'none');
+        $object->note_public		= GETPOST("note_public");
+        $object->note_private	= GETPOST("note_private");
         $object->statut			= 1; //Defult status to Actif
         $object->birthday = dol_mktime(0,0,0,GETPOST("birthdaymonth",'int'),GETPOST("birthdayday",'int'),GETPOST("birthdayyear",'int'));
         $object->birthday_alert = GETPOST("birthday_alert",'alpha');
 		$ret = $extrafields->setOptionalsFromPost($extralabels,$object);
 		if ($ret < 0)
 		{
 			$error++;
 			$action = 'create';
 		}
         if (! GETPOST("lastname"))
@@ -278,44 +278,44 @@
                     case 1: //uploaded file exceeds the upload_max_filesize directive in php.ini
                     case 2: //uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the html form
                         $errors[] = "ErrorFileSizeTooLarge";
                         break;
                     case 3: //uploaded file was only partially uploaded
                         $errors[] = "ErrorFilePartiallyUploaded";
                         break;
                 }
             }
 			$object->oldcopy = clone $object;
-			$object->old_lastname	= GETPOST("old_lastname",'alpha');
-			$object->old_firstname	= GETPOST("old_firstname",'alpha');
+            $object->old_lastname	= GETPOST("old_lastname");
+            $object->old_firstname	= GETPOST("old_firstname");
             $object->socid			= GETPOST("socid",'int');
-            $object->lastname		= GETPOST("lastname",'alpha');
-            $object->firstname		= GETPOST("firstname",'alpha');
-            $object->civility_id	= GETPOST("civility_id",'alpha');
-            $object->poste			= GETPOST("poste",'alpha');
-            $object->address		= GETPOST("address",'alpha');
-            $object->zip			= GETPOST("zipcode",'alpha');
-            $object->town			= GETPOST("town",'alpha');
-            $object->state_id   	= GETPOST("state_id",'int');
+            $object->lastname		= GETPOST("lastname");
+            $object->firstname		= GETPOST("firstname");
+            $object->civility_id		= GETPOST("civility_id",'alpha');
+            $object->poste			= GETPOST("poste");
+            $object->address			= GETPOST("address");
+            $object->zip				= GETPOST("zipcode");
+            $object->town			= GETPOST("town");
+            $object->state_id   		= GETPOST("state_id",'int');
             $object->fk_departement	= GETPOST("state_id",'int');	// For backward compatibility
             $object->country_id		= GETPOST("country_id",'int');
             $object->email			= GETPOST("email",'alpha');
             $object->skype			= GETPOST("skype",'alpha');
-            $object->phone_pro		= GETPOST("phone_pro",'alpha');
-            $object->phone_perso	= GETPOST("phone_perso",'alpha');
-            $object->phone_mobile	= GETPOST("phone_mobile",'alpha');
-            $object->fax			= GETPOST("fax",'alpha');
+            $object->phone_pro		= GETPOST("phone_pro");
+            $object->phone_perso		= GETPOST("phone_perso");
+            $object->phone_mobile	= GETPOST("phone_mobile");
+            $object->fax				= GETPOST("fax");
             $object->jabberid		= GETPOST("jabberid",'alpha');
 			$object->no_email		= GETPOST("no_email",'int');
             $object->priv			= GETPOST("priv",'int');
-            $object->note_public	= GETPOST("note_public",'none');
-       		$object->note_private	= GETPOST("note_private",'none');
+            	$object->note_public		= GETPOST("note_public");
+       		$object->note_private	= GETPOST("note_private");
 			$ret = $extrafields->setOptionalsFromPost($extralabels,$object);
 			if ($ret < 0) $error++;
             $result = $object->update($contactid, $user);
 			if ($result > 0) {
 				$sql = 'DELETE FROM ' . MAIN_DB_PREFIX . 'categorie_contact';
 				$sql .= ' WHERE fk_socpeople = ' . $object->id;
 				$db->query( $sql );
 				$categories = GETPOST( 'contcats', 'array');
 				$object->setCategories($categories);
                 $object->old_lastname='';
@@ -430,23 +430,23 @@
             print '<form method="post" name="formsoc" action="'.$_SERVER["PHP_SELF"].'">';
             print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
             print '<input type="hidden" name="action" value="add">';
             print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
 			if (! empty($objsoc)) {
 				print '<input type="hidden" name="entity" value="'.$objsoc->entity.'">';
             }
             dol_fiche_head($head, 'card', '', 0, '');
             print '<table class="border" width="100%">';
             print '<tr><td class="titlefieldcreate fieldrequired"><label for="lastname">'.$langs->trans("Lastname").' / '.$langs->trans("Label").'</label></td>';
-            print '<td><input name="lastname" id="lastname" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("lastname",'alpha')?GETPOST("lastname",'alpha'):$object->lastname).'" autofocus="autofocus"></td>';
+	        print '<td><input name="lastname" id="lastname" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("lastname")?GETPOST("lastname"):$object->lastname).'" autofocus="autofocus"></td>';
             print '<td><label for="firstname">'.$langs->trans("Firstname").'</label></td>';
-            print '<td><input name="firstname" id="firstname"type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("firstname",'alpha')?GETPOST("firstname",'alpha'):$object->firstname).'"></td></tr>';
+	        print '<td><input name="firstname" id="firstname"type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("firstname")?GETPOST("firstname"):$object->firstname).'"></td></tr>';
             if (empty($conf->global->SOCIETE_DISABLE_CONTACTS))
             {
                 if ($socid > 0)
                 {
                     print '<tr><td><label for="socid">'.$langs->trans("ThirdParty").'</label></td>';
                     print '<td colspan="3" class="maxwidthonsmartphone">';
                     print $objsoc->getNomUrl(1, 'contact');
                     print '</td>';
                     print '<input type="hidden" name="socid" id="socid" value="'.$objsoc->id.'">';
                     print '</td></tr>';
@@ -472,22 +472,22 @@
 	            $rowspan=3;
 	    		if (empty($conf->global->SOCIETE_DISABLE_STATE)) $rowspan++;
 	            print '<td valign="middle" align="center" rowspan="'.$rowspan.'">';
 		        print '<a href="#" id="copyaddressfromsoc">'.$langs->trans('CopyAddressFromSoc').'</a>';
 	            print '</td>';
             }
             print '</tr>';
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->zip)) == 0) $object->zip = $objsoc->zip;			// Predefined with third party
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->town)) == 0) $object->town = $objsoc->town;	// Predefined with third party
             print '<tr><td><label for="zipcode">'.$langs->trans("Zip").'</label> / <label for="town">'.$langs->trans("Town").'</label></td><td colspan="'.$colspan.'" class="maxwidthonsmartphone">';
-            print $formcompany->select_ziptown((GETPOST("zipcode",'alpha')?GETPOST("zipcode",'alpha'):$object->zip),'zipcode',array('town','selectcountry_id','state_id'),6).'&nbsp;';
-            print $formcompany->select_ziptown((GETPOST("town",'alpha')?GETPOST("town",'alpha'):$object->town),'town',array('zipcode','selectcountry_id','state_id'));
+            print $formcompany->select_ziptown((GETPOST("zipcode")?GETPOST("zipcode"):$object->zip),'zipcode',array('town','selectcountry_id','state_id'),6).'&nbsp;';
+            print $formcompany->select_ziptown((GETPOST("town")?GETPOST("town"):$object->town),'town',array('zipcode','selectcountry_id','state_id'));
             print '</td></tr>';
             print '<tr><td><label for="selectcountry_id">'.$langs->trans("Country").'</label></td><td colspan="'.$colspan.'" class="maxwidthonsmartphone">';
             print $form->select_country((GETPOST("country_id",'alpha')?GETPOST("country_id",'alpha'):$object->country_id),'country_id');
             if ($user->admin) print info_admin($langs->trans("YouCanChangeValuesForThisListFromDictionarySetup"),1);
             print '</td></tr>';
             if (empty($conf->global->SOCIETE_DISABLE_STATE))
             {
                 print '<tr><td><label for="state_id">'.$langs->trans('State').'</label></td><td colspan="'.$colspan.'" class="maxwidthonsmartphone">';
                 if ($object->country_id)
                 {
@@ -504,37 +504,37 @@
 	        print '<td><input name="phone_pro" id="phone_pro" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("phone_pro")?GETPOST("phone_pro"):$object->phone_pro).'"></td>';
             print '<td><label for="phone_perso">'.$langs->trans("PhonePerso").'</label></td>';
 	        print '<td><input name="phone_perso" id="phone_perso" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("phone_perso")?GETPOST("phone_perso"):$object->phone_perso).'"></td></tr>';
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->fax)) == 0) $object->fax = $objsoc->fax;	// Predefined with third party
             print '<tr><td><label for="phone_mobile">'.$langs->trans("PhoneMobile").'</label></td>';
 	        print '<td><input name="phone_mobile" id="phone_mobile" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("phone_mobile")?GETPOST("phone_mobile"):$object->phone_mobile).'"></td>';
             print '<td><label for="fax">'.$langs->trans("Fax").'</label></td>';
 	        print '<td><input name="fax" id="fax" type="text" class="maxwidth100onsmartphone" maxlength="80" value="'.dol_escape_htmltag(GETPOST("fax",'alpha')?GETPOST("fax",'alpha'):$object->fax).'"></td></tr>';
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->email)) == 0) $object->email = $objsoc->email;	// Predefined with third party
             print '<tr><td><label for="email">'.$langs->trans("Email").'</label></td>';
-	        print '<td><input name="email" id="email" type="text" class="maxwidth100onsmartphone" value="'.dol_escape_htmltag(GETPOST("email",'alpha')?GETPOST("email",'alpha'):$object->email).'"></td>';
+	        print '<td><input name="email" id="email" type="text" class="maxwidth100onsmartphone" value="'.(GETPOST("email",'alpha')?GETPOST("email",'alpha'):$object->email).'"></td>';
             if (! empty($conf->mailing->enabled))
             {
             	print '<td><label for="no_email">'.$langs->trans("No_Email").'</label></td>';
 	            print '<td>'.$form->selectyesno('no_email',(GETPOST("no_email",'alpha')?GETPOST("no_email",'alpha'):$object->no_email), 1).'</td>';
             }
             else
 			      {
           		print '<td colspan="2">&nbsp;</td>';
             }
             print '</tr>';
             print '<tr><td><label for="jabberid">'.$langs->trans("IM").'</label></td>';
-            print '<td colspan="3"><input name="jabberid" id="jabberid" type="text" class="minwidth100" maxlength="80" value="'.dol_escape_htmltag(GETPOST("jabberid",'alpha')?GETPOST("jabberid",'alpha'):$object->jabberid).'"></td></tr>';
+	        print '<td colspan="3"><input name="jabberid" id="jabberid" type="text" class="minwidth100" maxlength="80" value="'.(GETPOST("jabberid",'alpha')?GETPOST("jabberid",'alpha'):$object->jabberid).'"></td></tr>';
             if (! empty($conf->skype->enabled))
             {
                 print '<tr><td><label for="skype">'.$langs->trans("Skype").'</label></td>';
-                print '<td colspan="3"><input name="skype" id="skype" type="text" class="minwidth100" maxlength="80" value="'.dol_escape_htmltag(GETPOST("skype",'alpha')?GETPOST("skype",'alpha'):$object->skype).'"></td></tr>';
+	            print '<td colspan="3"><input name="skype" id="skype" type="text" class="minwidth100" maxlength="80" value="'.(GETPOST("skype",'alpha')?GETPOST("skype",'alpha'):$object->skype).'"></td></tr>';
             }
             print '<tr><td><label for="priv">'.$langs->trans("ContactVisibility").'</label></td><td colspan="3">';
             $selectarray=array('0'=>$langs->trans("ContactPublic"),'1'=>$langs->trans("ContactPrivate"));
             print $form->selectarray('priv',$selectarray,(GETPOST("priv",'alpha')?GETPOST("priv",'alpha'):$object->priv),0);
             print '</td></tr>';
 			if (! empty($conf->categorie->enabled)  && ! empty($user->rights->categorie->lire)) {
 				print '<tr><td>' . fieldLabel( 'Categories', 'contcats' ) . '</td><td colspan="3">';
 				$cate_arbo = $form->select_all_categories( Categorie::TYPE_CONTACT, null, 'parent', null, null, 1 );
 				print $form->multiselectarray( 'contcats', $cate_arbo, GETPOST( 'contcats', 'array' ), null, null, null,
 					null, '90%' );

--- a/htdocs/contact/class/contact.class.php
+++ b/htdocs/contact/class/contact.class.php
@@ -283,21 +283,20 @@
 		$sql .= ", address='".$this->db->escape($this->address)."'";
 		$sql .= ", zip='".$this->db->escape($this->zip)."'";
 		$sql .= ", town='".$this->db->escape($this->town)."'";
 		$sql .= ", fk_pays=".($this->country_id>0?$this->country_id:'NULL');
 		$sql .= ", fk_departement=".($this->state_id>0?$this->state_id:'NULL');
 		$sql .= ", poste='".$this->db->escape($this->poste)."'";
 		$sql .= ", fax='".$this->db->escape($this->fax)."'";
 		$sql .= ", email='".$this->db->escape($this->email)."'";
 		$sql .= ", skype='".$this->db->escape($this->skype)."'";
 		$sql .= ", photo='".$this->db->escape($this->photo)."'";
-		$sql .= ", birthday=".($this->birthday ? "'".$this->db->idate($this->birthday)."'" : "null");
 		$sql .= ", note_private = ".(isset($this->note_private)?"'".$this->db->escape($this->note_private)."'":"null");
 		$sql .= ", note_public = ".(isset($this->note_public)?"'".$this->db->escape($this->note_public)."'":"null");
 		$sql .= ", phone = ".(isset($this->phone_pro)?"'".$this->db->escape($this->phone_pro)."'":"null");
 		$sql .= ", phone_perso = ".(isset($this->phone_perso)?"'".$this->db->escape($this->phone_perso)."'":"null");
 		$sql .= ", phone_mobile = ".(isset($this->phone_mobile)?"'".$this->db->escape($this->phone_mobile)."'":"null");
 		$sql .= ", jabberid = ".(isset($this->jabberid)?"'".$this->db->escape($this->jabberid)."'":"null");
 		$sql .= ", priv = '".$this->db->escape($this->priv)."'";
 		$sql .= ", statut = ".$this->statut;
 		$sql .= ", fk_user_modif=".($user->id > 0 ? "'".$this->db->escape($user->id)."'":"NULL");
 		$sql .= ", default_lang=".($this->default_lang?"'".$this->db->escape($this->default_lang)."'":"NULL");
@@ -495,22 +494,22 @@
 	    $this->db->begin();
 		$sql = "UPDATE ".MAIN_DB_PREFIX."socpeople SET";
 		$sql.= " birthday=".($this->birthday ? "'".$this->db->idate($this->birthday)."'" : "null");
 		$sql.= ", photo = ".($this->photo? "'".$this->db->escape($this->photo)."'" : "null");
 		if ($user) $sql .= ", fk_user_modif=".$user->id;
 		$sql.= " WHERE rowid=".$this->db->escape($id);
 		dol_syslog(get_class($this)."::update_perso this->birthday=".$this->birthday." -", LOG_DEBUG);
 		$resql = $this->db->query($sql);
 		if (! $resql)
 		{
-			$error++;
-			$this->error=$this->db->lasterror();
+            $error++;
+		    $this->error=$this->db->lasterror();
 		}
 		if ($this->birthday_alert)
 		{
 			$sql_check = "SELECT * FROM ".MAIN_DB_PREFIX."user_alert WHERE type=1 AND fk_contact=".$this->db->escape($id)." AND fk_user=".$user->id;
 			$result_check = $this->db->query($sql_check);
 			if (! $result_check || ($this->db->num_rows($result_check)<1))
 			{
 				$sql = "INSERT INTO ".MAIN_DB_PREFIX."user_alert(type,fk_contact,fk_user) ";
 				$sql.= "VALUES (1,".$this->db->escape($id).",".$user->id.")";
 				$result = $this->db->query($sql);

--- a/htdocs/contact/list.php
+++ b/htdocs/contact/list.php
@@ -1,20 +1,19 @@
 <?php
 /* Copyright (C) 2001-2004  Rodolphe Quiedeville    <rodolphe@quiedeville.org>
  * Copyright (C) 2003       Eric Seigne             <erics@rycks.com>
  * Copyright (C) 2004-2012  Laurent Destailleur     <eldy@users.sourceforge.net>
  * Copyright (C) 2005-2012  Regis Houssin           <regis.houssin@capnetworks.com>
  * Copyright (C) 2013-2015  Raphal Doursenaud      <rdoursenaud@gpcsolutions.fr>
  * Copyright (C) 2013       Cdric Salvador         <csalvador@gpcsolutions.fr>
  * Copyright (C) 2013       Alexandre Spangaro      <aspangaro.dolibarr@gmail.com>
  * Copyright (C) 2015       Jean-Franois Ferry     <jfefe@aternatik.fr>
- * Copyright (C) 2018       Juanjo Menent			<jmenent@2byte.es>
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 3 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
@@ -247,21 +246,20 @@
 if ($search_lastname)               $sql.= natural_search('p.lastname', $search_lastname);
 if ($search_firstname)              $sql.= natural_search('p.firstname', $search_firstname);
 if ($search_societe)                $sql.= natural_search('s.nom', $search_societe);
 if (strlen($search_poste))          $sql.= natural_search('p.poste', $search_poste);
 if (strlen($search_phone_perso))    $sql.= natural_search('p.phone_perso', $search_phone_perso);
 if (strlen($search_phone_pro))      $sql.= natural_search('p.phone', $search_phone);
 if (strlen($search_phone_mobile))   $sql.= natural_search('p.phone_mobile', $search_phone_mobile);
 if (strlen($search_fax))            $sql.= natural_search('p.fax', $search_fax);
 if (strlen($search_skype))          $sql.= natural_search('p.skype', $search_skype);
 if (strlen($search_email))          $sql.= natural_search('p.email', $search_email);
-if (strlen($search_zip))   			$sql.= natural_search("p.zip",$search_zip);
 if ($search_status != '' && $search_status >= 0) $sql.= " AND p.statut = ".$db->escape($search_status);
 if ($search_import_key)             $sql.= natural_search("p.import_key",$search_import_key);
 if ($type == "o")        // filtre sur type
 {
 	$sql .= " AND p.fk_soc IS NULL";
 }
 else if ($type == "f")        // filtre sur type
 {
 	$sql .= " AND s.fournisseur = 1";
 }

--- a/htdocs/contrat/class/contrat.class.php
+++ b/htdocs/contrat/class/contrat.class.php
@@ -193,46 +193,34 @@
 	 *
 	 *  @param	User		$user       Objet User who activate contract
 	 *  @param  int			$line_id    Id of line to activate
 	 *  @param  int			$date       Date d'ouverture
 	 *  @param  int|string	$date_end   Date fin prevue
 	 * 	@param	string		$comment	A comment typed by user
 	 *  @return int         			<0 if KO, >0 if OK
 	 */
 	function active_line($user, $line_id, $date, $date_end='', $comment='')
 	{
-		$result = $this->lines[$this->lines_id_index_mapper[$line_id]]->active_line($user, $date, $date_end, $comment);
-		if ($result < 0)
-		{
-			$this->error = $this->lines[$this->lines_id_index_mapper[$line_id]]->error;
-			$this->errors = $this->lines[$this->lines_id_index_mapper[$line_id]]->errors;
-		}
-		return $result;
+		return $this->lines[$this->lines_id_index_mapper[$line_id]]->active_line($user, $date, $date_end, $comment);
 	}
 	/**
 	 *  Close a contract line
 	 *
 	 *  @param	User		$user       Objet User who close contract
 	 *  @param  int			$line_id    Id of line to close
 	 *  @param  int			$date_end	Date end
 	 * 	@param	string		$comment	A comment typed by user
 	 *  @return int         			<0 if KO, >0 if OK
 	 */
 	function close_line($user, $line_id, $date_end, $comment='')
 	{
-		$result=$this->lines[$this->lines_id_index_mapper[$line_id]]->close_line($user, $date_end, $comment);
-		if ($result < 0)
-		{
-			$this->error = $this->lines[$this->lines_id_index_mapper[$line_id]]->error;
-			$this->errors = $this->lines[$this->lines_id_index_mapper[$line_id]]->errors;
-		}
-		return $result;
+		return $this->lines[$this->lines_id_index_mapper[$line_id]]->close_line($user, $date_end, $comment);
 	}
 	/**
 	 *  Open all lines of a contract
 	 *
 	 *  @param	User		$user      		Object User making action
 	 *  @param	int|string	$date_start		Date start (now if empty)
      *  @param	int			$notrigger		1=Does not execute triggers, 0=Execute triggers
      *  @param	string		$comment		Comment
 	 *	@return	int							<0 if KO, >0 if OK
 	 */

--- a/htdocs/core/actions_addupdatedelete.inc.php
+++ b/htdocs/core/actions_addupdatedelete.inc.php
@@ -26,35 +26,26 @@
 		header("Location: ".$backtopage);
 		exit;
 	}
 	$action='';
 }
 if ($action == 'add' && ! empty($permissiontoadd))
 {
 	foreach ($object->fields as $key => $val)
 	{
 		if (in_array($key, array('rowid', 'entity', 'date_creation', 'tms', 'fk_user_creat', 'fk_user_modif', 'import_key'))) continue;	// Ignore special fields
-		if (in_array($object->fields[$key]['type'], array('text', 'html'))) {
-			$value = GETPOST($key,'none');
-		} elseif ($object->fields[$key]['type']=='date') {
-			$value = dol_mktime(12, 0, 0, GETPOST($key.'month'), GETPOST($key.'day'), GETPOST($key.'year'));
-		} elseif ($object->fields[$key]['type']=='datetime') {
-			$value = dol_mktime(GETPOST($key.'hour'), GETPOST($key.'min'), 0, GETPOST($key.'month'), GETPOST($key.'day'), GETPOST($key.'year'));
-		} elseif ($object->fields[$key]['type']=='price') {
-			$value = price2num(GETPOST($key));
-		} else {
-			$value = GETPOST($key,'alpha');
-		}
+		if (in_array($object->fields[$key]['type'], array('text', 'html'))) $value = GETPOST($key,'none');
+		else $value = GETPOST($key,'alpha');
 		if (preg_match('/^integer:/i', $object->fields[$key]['type']) && $value == '-1') $value='';		// This is an implicit foreign key field
 		if (! empty($object->fields[$key]['foreignkey']) && $value == '-1') $value='';					// This is an explicit foreign key field
 		$object->$key=$value;
-		if ($val['notnull'] > 0 && $object->$key == '' && is_null($val['default']))
+		if ($val['notnull'] > 0 && $object->$key == '')
 		{
 			$error++;
 			setEventMessages($langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv($val['label'])), null, 'errors');
 		}
 	}
 	if (! $error)
 	{
 		$result=$object->createCommon($user);
 		if ($result > 0)
 		{
@@ -75,33 +66,32 @@
 	}
 }
 if ($action == 'update' && ! empty($permissiontoadd))
 {
 	foreach ($object->fields as $key => $val)
 	{
 		if (! GETPOSTISSET($key)) continue;		// The field was not submited to be edited
 		if (in_array($key, array('rowid', 'entity', 'date_creation', 'tms', 'fk_user_creat', 'fk_user_modif', 'import_key'))) continue;	// Ignore special fields
 		if (in_array($object->fields[$key]['type'], array('text', 'html'))) {
 			$value = GETPOST($key,'none');
-		} elseif ($object->fields[$key]['type']=='date') {
+		}
+		elseif ($object->fields[$key]['type']=='date') {
 			$value = dol_mktime(12, 0, 0, GETPOST($key.'month'), GETPOST($key.'day'), GETPOST($key.'year'));
 		} elseif ($object->fields[$key]['type']=='datetime') {
 			$value = dol_mktime(GETPOST($key.'hour'), GETPOST($key.'min'), 0, GETPOST($key.'month'), GETPOST($key.'day'), GETPOST($key.'year'));
-		} elseif ($object->fields[$key]['type']=='price') {
-			$value = price2num(GETPOST($key));
 		} else {
 			$value = GETPOST($key,'alpha');
 		}
 		if (preg_match('/^integer:/i', $object->fields[$key]['type']) && $value == '-1') $value='';		// This is an implicit foreign key field
 		if (! empty($object->fields[$key]['foreignkey']) && $value == '-1') $value='';					// This is an explicit foreign key field
 		$object->$key=$value;
-		if ($val['notnull'] > 0 && $object->$key == '' && is_null($val['default']))
+		if ($val['notnull'] > 0 && $object->$key == '')
 		{
 			$error++;
 			setEventMessages($langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv($val['label'])), null, 'errors');
 		}
 	}
 	if (! $error)
 	{
 		$result=$object->updateCommon($user);
 		if ($result > 0)
 		{

--- a/htdocs/core/actions_linkedfiles.inc.php
+++ b/htdocs/core/actions_linkedfiles.inc.php
@@ -10,21 +10,21 @@
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  * or see http://www.gnu.org/
  */
-if (GETPOST('sendit','alpha') && ! empty($conf->global->MAIN_UPLOAD_DOC))
+if (GETPOST('sendit','none') && ! empty($conf->global->MAIN_UPLOAD_DOC))
 {
 	if (! empty($_FILES))
 	{
 		if (is_array($_FILES['userfile']['tmp_name'])) $userfiles=$_FILES['userfile']['tmp_name'];
 		else $userfiles=array($_FILES['userfile']['tmp_name']);
 		foreach($userfiles as $key => $userfile)
 		{
 			if (empty($_FILES['userfile']['tmp_name'][$key]))
 			{
 				$error++;

--- a/htdocs/core/actions_sendmails.inc.php
+++ b/htdocs/core/actions_sendmails.inc.php
@@ -297,21 +297,21 @@
 			$message=make_substitutions($message, $substitutionarray);
 			if (method_exists($object, 'makeSubstitution'))
 			{
 				$subject = $object->makeSubstitution($subject);
 				$message = $object->makeSubstitution($message);
 			}
 			if (empty($sendcontext)) $sendcontext = 'standard';
 			$mailfile = new CMailFile($subject,$sendto,$from,$message,$filepath,$mimetype,$filename,$sendtocc,$sendtobcc,$deliveryreceipt,-1,'','',$trackid,'', $sendcontext);
 			if ($mailfile->error)
 			{
-				setEventMessages($mailfile->error, $mailfile->errors, 'errors');
+				setEventMessage($mailfile->error, 'errors');
 				$action='presend';
 			}
 			else
 			{
 				$result=$mailfile->sendfile();
 				if ($result)
 				{
 					if (! empty($conf->dolimail->enabled))
 					{
 						$mid = (GETPOST('mid','int') ? GETPOST('mid','int') : 0);	// Original mail id is set ?

--- a/htdocs/core/boxes/box_supplier_orders.php
+++ b/htdocs/core/boxes/box_supplier_orders.php
@@ -62,21 +62,21 @@
         include_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.commande.class.php';
         $supplierorderstatic=new CommandeFournisseur($db);
         include_once DOL_DOCUMENT_ROOT.'/fourn/class/fournisseur.class.php';
         $thirdpartytmp = new Fournisseur($db);
         $this->info_box_head = array('text' => $langs->trans("BoxTitleLatest".($conf->global->MAIN_LASTBOX_ON_OBJECT_DATE?"":"Modified")."SupplierOrders", $max));
         if ($user->rights->fournisseur->commande->lire)
         {
             $sql = "SELECT s.nom as name, s.rowid as socid,";
             $sql.= " s.code_client, s.code_fournisseur,";
             $sql.= " s.logo,";
-            $sql.= " c.rowid, c.ref, c.tms, c.date_commande,";
+            $sql.= " c.ref, c.tms, c.rowid, c.date_commande,";
             $sql.= " c.total_ht,";
             $sql.= " c.tva as total_tva,";
             $sql.= " c.total_ttc,";
             $sql.= " c.fk_statut";
             $sql.= " FROM ".MAIN_DB_PREFIX."societe as s";
             $sql.= ", ".MAIN_DB_PREFIX."commande_fournisseur as c";
             if (!$user->rights->societe->client->voir && !$user->societe_id) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
             $sql.= " WHERE c.fk_soc = s.rowid";
             $sql.= " AND c.entity = ".$conf->entity;
             if (!$user->rights->societe->client->voir && !$user->societe_id) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
@@ -86,21 +86,21 @@
             $sql.= $db->plimit($max, 0);
             $result = $db->query($sql);
             if ($result)
             {
                 $num = $db->num_rows($result);
                 $line = 0;
                 while ($line < $num) {
                     $objp = $db->fetch_object($result);
                     $date=$db->jdate($objp->date_commande);
 					$datem=$db->jdate($objp->tms);
-					$supplierorderstatic->id = $objp->rowid;
+					$supplierorderstatic->id = $objp->id;
 					$supplierorderstatic->ref = $objp->ref;
 					$thirdpartytmp->id = $objp->socid;
                     $thirdpartytmp->name = $objp->name;
                     $thirdpartytmp->fournisseur = 1;
                     $thirdpartytmp->code_fournisseur = $objp->code_fournisseur;
                     $thirdpartytmp->logo = $objp->logo;
                     $this->info_box_contents[$line][] = array(
                         'td' => '',
                         'text' => $supplierorderstatic->getNomUrl(1),
                     	'asis' => 1

--- a/htdocs/core/class/CMailFile.class.php
+++ b/htdocs/core/class/CMailFile.class.php
@@ -850,21 +850,21 @@
 				if ($encoded >= 0)
 				{
 					if ($mimefilename_list[$i]) $filename_list[$i] = $mimefilename_list[$i];
 					if (! $mimetype_list[$i]) {
 						$mimetype_list[$i] = "application/octet-stream";
 					}
 					$out.= "--" . $this->mixed_boundary . $this->eol;
 					$out.= "Content-Disposition: attachment; filename=\"".$filename_list[$i]."\"".$this->eol;
 					$out.= "Content-Type: " . $mimetype_list[$i] . "; name=\"".$filename_list[$i]."\"".$this->eol;
 					$out.= "Content-Transfer-Encoding: base64".$this->eol;
-					$out.= "Content-Description: ".$filename_list[$i].$this->eol;
+					$out.= "Content-Description: File Attachment".$this->eol;
 					$out.= $this->eol;
 					$out.= $encoded;
 					$out.= $this->eol;
 				}
 				else
 				{
 					return $encoded;
 				}
 			}
 		}

--- a/htdocs/core/class/commondocgenerator.class.php
+++ b/htdocs/core/class/commondocgenerator.class.php
@@ -320,21 +320,21 @@
 		$array_key.'_date_limit'=>(! empty($object->date_lim_reglement)?dol_print_date($object->date_lim_reglement,'day'):''),
 	    $array_key.'_date_end'=>(! empty($object->fin_validite)?dol_print_date($object->fin_validite,'day'):''),
 		$array_key.'_date_creation'=>dol_print_date($object->date_creation,'day'),
 		$array_key.'_date_modification'=>(! empty($object->date_modification)?dol_print_date($object->date_modification,'day'):''),
 		$array_key.'_date_validation'=>(! empty($object->date_validation)?dol_print_date($object->date_validation,'dayhour'):''),
 		$array_key.'_date_delivery_planed'=>(! empty($object->date_livraison)?dol_print_date($object->date_livraison,'day'):''),
 		$array_key.'_date_close'=>(! empty($object->date_cloture)?dol_print_date($object->date_cloture,'dayhour'):''),
 		$array_key.'_payment_mode_code'=>$object->mode_reglement_code,
 		$array_key.'_payment_mode'=>($outputlangs->transnoentitiesnoconv('PaymentType'.$object->mode_reglement_code)!='PaymentType'.$object->mode_reglement_code?$outputlangs->transnoentitiesnoconv('PaymentType'.$object->mode_reglement_code):$object->mode_reglement),
 		$array_key.'_payment_term_code'=>$object->cond_reglement_code,
-		$array_key.'_payment_term'=>($outputlangs->transnoentitiesnoconv('PaymentCondition'.$object->cond_reglement_code)!='PaymentCondition'.$object->cond_reglement_code?$outputlangs->transnoentitiesnoconv('PaymentCondition'.$object->cond_reglement_code):($object->cond_reglement_doc?$object->cond_reglement_doc:$object->cond_reglement)),
+		$array_key.'_payment_term'=>($outputlangs->transnoentitiesnoconv('PaymentCondition'.$object->cond_reglement_code)!='PaymentCondition'.$object->cond_reglement_code?$outputlangs->transnoentitiesnoconv('PaymentCondition'.$object->cond_reglement_code):$object->cond_reglement),
 		$array_key.'_total_ht_locale'=>price($object->total_ht, 0, $outputlangs),
 		$array_key.'_total_vat_locale'=>(! empty($object->total_vat)?price($object->total_vat, 0, $outputlangs):price($object->total_tva, 0, $outputlangs)),
 		$array_key.'_total_localtax1_locale'=>price($object->total_localtax1, 0, $outputlangs),
 		$array_key.'_total_localtax2_locale'=>price($object->total_localtax2, 0, $outputlangs),
 		$array_key.'_total_ttc_locale'=>price($object->total_ttc, 0, $outputlangs),
 		$array_key.'_total_ht'=>price2num($object->total_ht),
 		$array_key.'_total_vat'=>(! empty($object->total_vat)?price2num($object->total_vat):price2num($object->total_tva)),
 		$array_key.'_total_localtax1'=>price2num($object->total_localtax1),
 		$array_key.'_total_localtax2'=>price2num($object->total_localtax2),
 		$array_key.'_total_ttc'=>price2num($object->total_ttc),

--- a/htdocs/core/class/commonobject.class.php
+++ b/htdocs/core/class/commonobject.class.php
@@ -1176,33 +1176,29 @@
 	 *  @param  string      $trigkey    Trigger key to run (in most cases something like 'XXX_MODIFY')
 	 *	@return	int						<0 if KO, >0 if OK
 	 */
 	function setValueFrom($field, $value, $table='', $id=null, $format='', $id_field='', $fuser=null, $trigkey='')
 	{
 		global $user,$langs,$conf;
 		if (empty($table)) 	  $table=$this->table_element;
 		if (empty($id))    	  $id=$this->id;
 		if (empty($format))   $format='text';
 		if (empty($id_field)) $id_field='rowid';
-		$fk_user_field = 'fk_user_modif';
 		$error=0;
 		$this->db->begin();
 		if ($table == 'product' && $field == 'note_private') $field='note';
-		if (in_array($table, array('actioncomm', 'adherent', 'advtargetemailing', 'cronjob', 'establishment'))) {
-			$fk_user_field = 'fk_user_mod';
-		}
 		$sql = "UPDATE ".MAIN_DB_PREFIX.$table." SET ";
 		if ($format == 'text') $sql.= $field." = '".$this->db->escape($value)."'";
 		else if ($format == 'int') $sql.= $field." = ".$this->db->escape($value);
 		else if ($format == 'date') $sql.= $field." = ".($value ? "'".$this->db->idate($value)."'" : "null");
-		if (! empty($fuser) && is_object($fuser)) $sql.=", ".$fk_user_field." = ".$fuser->id;
-		elseif (empty($fuser) || $fuser != 'none') $sql.=", ".$fk_user_field." = ".$user->id;
+		if (! empty($fuser) && is_object($fuser)) $sql.=", fk_user_modif = ".$fuser->id;
+		elseif (empty($fuser) || $fuser != 'none') $sql.=", fk_user_modif = ".$user->id;
 		$sql.= " WHERE ".$id_field." = ".$id;
 		dol_syslog(get_class($this)."::".__FUNCTION__."", LOG_DEBUG);
 		$resql = $this->db->query($sql);
 		if ($resql)
 		{
 			if ($trigkey)
 			{
 				$result=$this->call_trigger($trigkey, (! empty($fuser) && is_object($fuser)) ? $fuser : $user);   // This may set this->errors
 				if ($result < 0) $error++;
 			}
@@ -2008,27 +2004,25 @@
 	 *
 	 *  @param      string		$note		New value for note
 	 *  @param		string		$suffix		'', '_public' or '_private'
 	 *  @return     int      		   		<0 if KO, >0 if OK
 	 */
 	function update_note($note,$suffix='')
 	{
 		global $user;
 		if (! $this->table_element)
 		{
-			$this->error='update_note was called on objet with property table_element not defined';
 			dol_syslog(get_class($this)."::update_note was called on objet with property table_element not defined", LOG_ERR);
 			return -1;
 		}
 		if (! in_array($suffix,array('','_public','_private')))
 		{
-			$this->error='update_note Parameter suffix must be empty, \'_private\' or \'_public\'';
 			dol_syslog(get_class($this)."::update_note Parameter suffix must be empty, '_private' or '_public'", LOG_ERR);
 			return -2;
 		}
 		if ($this->table_element == 'product') $suffix='';
 		$sql = 'UPDATE '.MAIN_DB_PREFIX.$this->table_element;
 		$sql.= " SET note".$suffix." = ".(!empty($note)?("'".$this->db->escape($note)."'"):"NULL");
 		$sql.= " ,".(in_array($this->table_element, array('actioncomm', 'adherent', 'advtargetemailing', 'cronjob', 'establishment'))?"fk_user_mod":"fk_user_modif")." = ".$user->id;
 		$sql.= " WHERE rowid =". $this->id;
 		dol_syslog(get_class($this)."::update_note", LOG_DEBUG);
 		if ($this->db->query($sql))
@@ -3915,23 +3909,20 @@
              				$this->array_options[$key] = null;
              			}
              			break;*/
 					case 'price':
 						$new_array_options[$key] = price2num($this->array_options[$key]);
 						break;
 					case 'date':
 						$new_array_options[$key] = $this->db->idate($this->array_options[$key]);
 						break;
 					case 'datetime':
-						if (! is_int($this->array_options[$key])) {
-							$this->array_options[$key] = strtotime($this->array_options[$key]);
-						}
 						$new_array_options[$key] = $this->db->idate($this->array_options[$key]);
 						break;
 		   			case 'link':
 						$param_list=array_keys($attributeParam['options']);
 						$InfoFieldList = explode(":", $param_list[0]);
 						dol_include_once($InfoFieldList[1]);
 						if ($InfoFieldList[0] && class_exists($InfoFieldList[0]))
 						{
 							if ($value == '-1')	// -1 is key for no defined in combo list of objects
 							{
@@ -4080,21 +4071,20 @@
 					}
 					break;
 			}
 			$this->db->begin();
 			$sql = "UPDATE ".MAIN_DB_PREFIX.$this->table_element."_extrafields SET ".$key."='".$this->db->escape($this->array_options["options_".$key])."'";
 			$sql .= " WHERE fk_object = ".$this->id;
 			$resql = $this->db->query($sql);
 			if (! $resql)
 			{
 				$this->error=$this->db->lasterror();
-				dol_syslog(get_class($this) . "::".__METHOD__ . $this->error, LOG_ERR);
 				$this->db->rollback();
 				return -1;
 			}
 			else
 			{
 				$this->db->commit();
 				return 1;
 			}
 		}
 		else return 0;
@@ -4122,22 +4112,21 @@
 		}
 		$objectid = $this->id;
 		$label= $val['label'];
 		$type = $val['type'];
 		$size = $val['css'];
 		if (preg_match('/varchar\((\d+)\)/', $type, $reg))
 		{
 			$type = 'varchar';		// convert varchar(xx) int varchar
 			$size = $reg[1];
 		}
-		elseif (preg_match('/varchar/', $type)) $type = 'varchar';		// convert varchar(xx) into varchar
-		elseif (preg_match('/double/', $type)) $type = 'double';		// convert double(xx) into double
+		elseif (preg_match('/varchar/', $type)) $type = 'varchar';		// convert varchar(xx) int varchar
 		if (is_array($val['arrayofkeyval'])) $type='select';
 		if (preg_match('/^integer:(.*):(.*)/i', $val['type'], $reg)) $type='link';
 		$default=$val['default'];
 		$computed=$val['computed'];
 		$unique=$val['unique'];
 		$required=$val['required'];
 		$param=$val['param'];
 		if (is_array($val['arrayofkeyval'])) $param['options'] = $val['arrayofkeyval'];
 		if (preg_match('/^integer:(.*):(.*)/i', $val['type'], $reg))
 		{
@@ -4651,33 +4640,25 @@
 				else
 				{
 					$showsize = 'minwidth400';
 				}
 			}
 		}
 		if ($key == 'ref' && method_exists($this, 'getNomUrl')) $value=$this->getNomUrl(1, '', 0, '', 1);
 		elseif ($key == 'status' && method_exists($this, 'getLibStatut')) $value=$this->getLibStatut(3);
 		elseif ($type == 'date')
 		{
-			if(! empty($value)) {
-				$value=dol_print_date($value,'day');
-			} else {
-				$value='';
-			}
+			$value=dol_print_date($value,'day');
 		}
 		elseif ($type == 'datetime')
 		{
-			if(! empty($value)) {
-				$value=dol_print_date($value,'dayhour');
-			} else {
-				$value='';
-			}
+			$value=dol_print_date($value,'dayhour');
 		}
 		elseif ($type == 'double')
 		{
 			if (!empty($value)) {
 				$value=price($value);
 			}
 		}
 		elseif ($type == 'boolean')
 		{
 			$checked='';
@@ -4948,25 +4929,25 @@
 							$csstyle=$params['style'];
 						}
 					}
 					$out .= '<tr '.$class.$csstyle.' class="'.$this->element.'_extras_'.$key.'">';
 					if (empty($onetrtd))
 					{
 						if (! empty($conf->global->MAIN_EXTRAFIELDS_USE_TWO_COLUMS) && ($e % 2) == 0) { $colspan='0'; }
 					}
 					if (in_array($extrafields->attribute_type[$key],array('date','datetime')))
 					{
-						$value = GETPOSTISSET($keyprefix.'options_'.$key.$keysuffix)?dol_mktime(GETPOST($keyprefix.'options_'.$key.$keysuffix."hour", 'int', 3), GETPOST($keyprefix.'options_'.$key.$keysuffix."min",'int',3), 0, GETPOST($keyprefix.'options_'.$key.$keysuffix."month",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."day",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."year",'int',3)):$this->db->jdate($this->array_options['options_'.$key]);
+						$value = GETPOSTISSET($keyprefix.'options_'.$key.$keysuffix)?dol_mktime(GETPOST($keyprefix.'options_'.$key.$keysuffix."hour",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."min",'int',3), 0, GETPOST($keyprefix.'options_'.$key.$keysuffix."month",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."day",'int',3), GETPOST($keyprefix.'options_'.$key.$keysuffix."year",'int',3)):$this->db->jdate($this->array_options['options_'.$key]);
 					}
 					if (in_array($extrafields->attribute_type[$key],array('price','double')))
 					{
-						$value = GETPOSTISSET($keyprefix.'options_'.$key.$keysuffix)?price2num(GETPOST($keyprefix.'options_'.$key.$keysuffix, 'alpha', 3)):$this->array_options['options_'.$key];
+						$value = GETPOSTISSET($keyprefix.'options_'.$key.$keysuffix)?price2num(GETPOST($keyprefix.'options_'.$key.$keysuffix,'int',3)):$this->array_options['options_'.$key];
 					}
 					$labeltoshow = $langs->trans($label);
 					if($extrafields->attribute_required[$key])
 					{
 						$labeltoshow = '<span'.($mode != 'view' ? ' class="fieldrequired"':'').'>'.$labeltoshow.'</span>';
 					}
 					if (empty($onetrtd)) $out .= '<td>';
 					else $out .= '<td'.($colspan?' colspan="'.($colspan+1).'"':'').'>';
 					$out .= $labeltoshow;
 					if (empty($onetrtd)) $out .= '</td><td'.($colspan?' colspan="'.($colspan).'"':'').'>';
@@ -5233,21 +5214,21 @@
 			else return false;
 		}
 		else return false;
 	}
 	/**
 	 * Function to prepare the values to insert.
 	 * Note $this->${field} are set by the page that make the createCommon or the updateCommon.
 	 *
 	 * @return array
 	 */
-	protected function setSaveQuery()
+	private function set_save_query()
 	{
 		global $conf;
 		$queryarray=array();
 		foreach ($this->fields as $field=>$info)	// Loop on definition of fields
 		{
 			if($this->isDate($info))
 			{
 				if(empty($this->{$field}))
 				{
 					$queryarray[$field] = NULL;
@@ -5282,21 +5263,21 @@
 			if ($info['type'] == 'timestamp' && empty($queryarray[$field])) unset($queryarray[$field]);
 			if (! empty($info['notnull']) && $info['notnull'] == -1 && empty($queryarray[$field])) $queryarray[$field] = null;
 		}
 		return $queryarray;
 	}
 	/**
 	 * Function to load data from a SQL pointer into properties of current object $this
 	 *
 	 * @param   stdClass    $obj    Contain data of object from database
 	 */
-	protected function setVarsFromFetchObj(&$obj)
+	private function setVarsFromFetchObj(&$obj)
 	{
 		foreach ($this->fields as $field => $info)
 		{
 			if($this->isDate($info))
 			{
 				if(empty($obj->{$field}) || $obj->{$field} === '0000-00-00 00:00:00' || $obj->{$field} === '1000-01-01 00:00:00') $this->{$field} = 0;
 				else $this->{$field} = strtotime($obj->{$field});
 			}
 			elseif($this->isArray($info))
 			{
@@ -5322,21 +5303,21 @@
 				$this->{$field} = $obj->{$field};
 			}
 		}
 		if (! isset($this->fields['ref']) && isset($this->id)) $this->ref = $this->id;
 	}
 	/**
 	 * Function to concat keys of fields
 	 *
 	 * @return string
 	 */
-	protected function getFieldList()
+	private function get_field_list()
 	{
 		$keys = array_keys($this->fields);
 		return implode(',', $keys);
 	}
 	/**
 	 * Add quote to field value if necessary
 	 *
 	 * @param 	string|int	$value			Value to protect
 	 * @param	array		$fieldsentry	Properties of field
 	 * @return 	string
@@ -5351,36 +5332,36 @@
 	 *
 	 * @param  User $user      User that creates
 	 * @param  bool $notrigger false=launch triggers after, true=disable triggers
 	 * @return int             <0 if KO, Id of created object if OK
 	 */
 	public function createCommon(User $user, $notrigger = false)
 	{
 		global $langs;
 		$error = 0;
 		$now=dol_now();
-		$fieldvalues = $this->setSaveQuery();
+		$fieldvalues = $this->set_save_query();
 		if (array_key_exists('date_creation', $fieldvalues) && empty($fieldvalues['date_creation'])) $fieldvalues['date_creation']=$this->db->idate($now);
 		if (array_key_exists('fk_user_creat', $fieldvalues) && ! ($fieldvalues['fk_user_creat'] > 0)) $fieldvalues['fk_user_creat']=$user->id;
 		unset($fieldvalues['rowid']);	// The field 'rowid' is reserved field name for autoincrement field so we don't need it into insert.
 		$keys=array();
 		$values = array();
 		foreach ($fieldvalues as $k => $v) {
 			$keys[$k] = $k;
 			$value = $this->fields[$k];
 			$values[$k] = $this->quote($v, $value);
 		}
 		foreach($keys as $key)
 		{
 			if (preg_match('/^integer:/i', $this->fields[$key]['type']) && $values[$key] == '-1') $values[$key]='';
 			if (! empty($this->fields[$key]['foreignkey']) && $values[$key] == '-1') $values[$key]='';
-			if ($this->fields[$key]['notnull'] == 1 && ! isset($values[$key]) && is_null($val['default']))
+			if ($this->fields[$key]['notnull'] == 1 && ! isset($values[$key]))
 			{
 				$error++;
 				$this->errors[]=$langs->trans("ErrorFieldRequired", $this->fields[$key]['label']);
 			}
 			if (preg_match('/^integer:/i', $this->fields[$key]['type']) && empty($values[$key])) $values[$key]='null';
 			if (! empty($this->fields[$key]['foreignkey']) && empty($values[$key])) $values[$key]='null';
 		}
 		if ($error) return -1;
 		$this->db->begin();
 		if (! $error)
@@ -5419,21 +5400,21 @@
 	/**
 	 * Load object in memory from the database
 	 *
 	 * @param int    $id   Id object
 	 * @param string $ref  Ref
 	 * @return int         <0 if KO, 0 if not found, >0 if OK
 	 */
 	public function fetchCommon($id, $ref = null)
 	{
 		if (empty($id) && empty($ref)) return false;
-		$sql = 'SELECT '.$this->getFieldList();
+		$sql = 'SELECT '.$this->get_field_list();
 		$sql.= ' FROM '.MAIN_DB_PREFIX.$this->table_element;
 		if(!empty($id)) $sql.= ' WHERE rowid = '.$id;
 		else $sql.= " WHERE ref = ".$this->quote($ref, $this->fields['ref']);
 		$res = $this->db->query($sql);
 		if ($res)
 		{
 			$obj = $this->db->fetch_object($res);
 			if ($obj)
 			{
 				$this->setVarsFromFetchObj($obj);
@@ -5456,21 +5437,21 @@
 	 *
 	 * @param  User $user      	User that modifies
 	 * @param  bool $notrigger 	false=launch triggers after, true=disable triggers
 	 * @return int             	<0 if KO, >0 if OK
 	 */
 	public function updateCommon(User $user, $notrigger = false)
 	{
 		global $conf, $langs;
 		$error = 0;
 		$now=dol_now();
-		$fieldvalues = $this->setSaveQuery();
+		$fieldvalues = $this->set_save_query();
 		if (array_key_exists('date_modification', $fieldvalues) && empty($fieldvalues['date_modification'])) $fieldvalues['date_modification']=$this->db->idate($now);
 		if (array_key_exists('fk_user_modif', $fieldvalues) && ! ($fieldvalues['fk_user_modif'] > 0)) $fieldvalues['fk_user_modif']=$user->id;
 		unset($fieldvalues['rowid']);	// The field 'rowid' is reserved field name for autoincrement field so we don't need it into update.
 		$keys=array();
 		$values = array();
 		foreach ($fieldvalues as $k => $v) {
 			$keys[$k] = $k;
 			$value = $this->fields[$k];
 			$values[$k] = $this->quote($v, $value);
 			$tmp[] = $k.'='.$this->quote($v, $this->fields[$k]);

--- a/htdocs/core/class/conf.class.php
+++ b/htdocs/core/class/conf.class.php
@@ -243,39 +243,33 @@
 		$this->expedition_bon->enabled=(! empty($this->global->MAIN_SUBMODULE_EXPEDITION)?$this->global->MAIN_SUBMODULE_EXPEDITION:0);
 		$this->livraison_bon->enabled=(! empty($this->global->MAIN_SUBMODULE_LIVRAISON)?$this->global->MAIN_SUBMODULE_LIVRAISON:0);
 		if (! empty($this->fournisseur))
 		{
 			$this->fournisseur->commande=new stdClass();
 			$this->fournisseur->commande->dir_output=$rootfordata."/fournisseur/commande";
 			$this->fournisseur->commande->dir_temp  =$rootfordata."/fournisseur/commande/temp";
 			$this->fournisseur->facture=new stdClass();
 			$this->fournisseur->facture->dir_output =$rootfordata."/fournisseur/facture";
 			$this->fournisseur->facture->dir_temp   =$rootfordata."/fournisseur/facture/temp";
-			$this->supplierproposal=new stdClass();
-			$this->supplierproposal->dir_output=$rootfordata."/supplier_proposal";
-			$this->supplierproposal->dir_temp=$rootfordata."/supplier_proposal/temp";
 			$this->fournisseur->payment=new stdClass();
 			$this->fournisseur->payment->dir_output =$rootfordata."/fournisseur/payment";
 			$this->fournisseur->payment->dir_temp   =$rootfordata."/fournisseur/payment/temp";
 			if (! empty($this->fournisseur->enabled) && empty($this->global->MAIN_USE_NEW_SUPPLIERMOD))  // By default, if module supplier is on, we set new properties
 			{
     			$this->supplier_order=new stdClass();
     			$this->supplier_order->enabled=1;
     			$this->supplier_order->dir_output=$rootfordata."/fournisseur/commande";
     			$this->supplier_order->dir_temp=$rootfordata."/fournisseur/commande/temp";
     			$this->supplier_invoice=new stdClass();
     			$this->supplier_invoice->enabled=1;
     			$this->supplier_invoice->dir_output=$rootfordata."/fournisseur/facture";
     			$this->supplier_invoice->dir_temp=$rootfordata."/fournisseur/facture/temp";
-    			$this->supplierproposal=new stdClass();
-    			$this->supplierproposal->dir_output=$rootfordata."/supplier_proposal";
-    			$this->supplierproposal->dir_temp=$rootfordata."/supplier_proposal/temp";
 			}
 		}
 		$this->product->multidir_output=array($this->entity => $rootfordata."/produit");
 		$this->product->multidir_temp  =array($this->entity => $rootfordata."/produit/temp");
 		$this->service->multidir_output=array($this->entity => $rootfordata."/produit");
 		$this->service->multidir_temp  =array($this->entity => $rootfordata."/produit/temp");
 		$this->product->dir_output=$rootfordata."/produit";
 		$this->product->dir_temp  =$rootfordata."/produit/temp";
 		$this->service->dir_output=$rootfordata."/produit";
 		$this->service->dir_temp  =$rootfordata."/produit/temp";

--- a/htdocs/core/class/extrafields.class.php
+++ b/htdocs/core/class/extrafields.class.php
@@ -643,35 +643,23 @@
 	 * 	@return	array							Array of attributes keys+label for all extra fields.
 	 */
 	function fetch_name_optionals_label($elementtype,$forceload=false)
 	{
 		global $conf;
 		if (empty($elementtype) ) return array();
 		if ($elementtype == 'thirdparty') $elementtype='societe';
 		if ($elementtype == 'contact') $elementtype='socpeople';
 		$array_name_label=array();
 		if (!$forceload && !empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) return $array_name_label;
-		$labelmulticompany=array();
-		if (!empty($conf->multicompany->enabled))
-		{
-			$sql_entity_name='SELECT rowid, label FROM '.MAIN_DB_PREFIX.'entity WHERE rowid in (0,'.$conf->entity.')';
-			$resql_entity_name=$this->db->query($sql_entity_name);
-			if ($resql_entity_name)
-			{
-				while ($obj = $this->db->fetch_object($resql_entity_name))
-				{
-					$labelmulticompany[$obj->rowid]=$obj->label;
-				}
-			}
-		}
 		dol_syslog("fetch_name_optionals_label elementtype=".$elementtype);
-		$sql = "SELECT rowid,name,label,type,size,elementtype,fieldunique,fieldrequired,param,pos,alwayseditable,perms,langs,list,fielddefault,fieldcomputed,entity";
+		$sql = "SELECT rowid,name,label,type,size,elementtype,fieldunique,fieldrequired,param,pos,alwayseditable,perms,langs,list,fielddefault,fieldcomputed";
+		$sql .= ",entity";
 		$sql.= " FROM ".MAIN_DB_PREFIX."extrafields";
 		$sql.= " WHERE entity IN (0,".$conf->entity.")";
 		if ($elementtype) $sql.= " AND elementtype = '".$elementtype."'";
 		$sql.= " ORDER BY pos";
 		$resql=$this->db->query($sql);
 		if ($resql)
 		{
 			if ($this->db->num_rows($resql))
 			{
 				while ($tab = $this->db->fetch_object($resql))
@@ -688,41 +676,54 @@
 					$this->attribute_computed[$tab->name]=$tab->fieldcomputed;
 					$this->attribute_unique[$tab->name]=$tab->fieldunique;
 					$this->attribute_required[$tab->name]=$tab->fieldrequired;
 					$this->attribute_param[$tab->name]=($tab->param ? unserialize($tab->param) : '');
 					$this->attribute_pos[$tab->name]=$tab->pos;
 					$this->attribute_alwayseditable[$tab->name]=$tab->alwayseditable;
 					$this->attribute_perms[$tab->name]=(strlen($tab->perms) == 0 ? 1 : $tab->perms);
 					$this->attribute_langfile[$tab->name]=$tab->langs;
 					$this->attribute_list[$tab->name]=$tab->list;
 					$this->attribute_entityid[$tab->name]=$tab->entity;
-					$this->attribute_entitylabel[$tab->name]=(empty($labelmulticompany[$tab->entity])?'Entity'.$tab->entity:$labelmulticompany[$tab->entity]);
 					$this->attributes[$tab->elementtype]['type'][$tab->name]=$tab->type;
 					$this->attributes[$tab->elementtype]['label'][$tab->name]=$tab->label;
 					$this->attributes[$tab->elementtype]['size'][$tab->name]=$tab->size;
 					$this->attributes[$tab->elementtype]['elementtype'][$tab->name]=$tab->elementtype;
 					$this->attributes[$tab->elementtype]['default'][$tab->name]=$tab->fielddefault;
 					$this->attributes[$tab->elementtype]['computed'][$tab->name]=$tab->fieldcomputed;
 					$this->attributes[$tab->elementtype]['unique'][$tab->name]=$tab->fieldunique;
 					$this->attributes[$tab->elementtype]['required'][$tab->name]=$tab->fieldrequired;
 					$this->attributes[$tab->elementtype]['param'][$tab->name]=($tab->param ? unserialize($tab->param) : '');
 					$this->attributes[$tab->elementtype]['pos'][$tab->name]=$tab->pos;
 					$this->attributes[$tab->elementtype]['alwayseditable'][$tab->name]=$tab->alwayseditable;
 					$this->attributes[$tab->elementtype]['perms'][$tab->name]=(strlen($tab->perms) == 0 ? 1 : $tab->perms);
 					$this->attributes[$tab->elementtype]['langfile'][$tab->name]=$tab->langs;
 					$this->attributes[$tab->elementtype]['list'][$tab->name]=$tab->list;
 					$this->attributes[$tab->elementtype]['entityid'][$tab->name]=$tab->entity;
-					$this->attributes[$tab->elementtype]['entitylabel'][$tab->name]=(empty($labelmulticompany[$tab->entity])?'Entity'.$tab->entity:$labelmulticompany[$tab->entity]);
-					$this->attributes[$tab->elementtype]['loaded']=1;
-				}
-			}
-			if ($elementtype) $this->attributes[$elementtype]['loaded']=1;	// If nothing found, we also save tag 'loaded'
+					if (!empty($conf->multicompany->enabled))
+					{
+						$sql_entity_name='SELECT label FROM '.MAIN_DB_PREFIX.'entity WHERE rowid='.$tab->entity;
+						$resql_entity_name=$this->db->query($sql_entity_name);
+						if ($resql_entity_name)
+						{
+							if ($this->db->num_rows($resql_entity_name))
+							{
+								if ($obj = $this->db->fetch_object($resql_entity_name))
+								{
+									$this->attribute_entitylabel[$tab->name]=$obj->label;
+									$this->attributes[$tab->elementtype]['entitylabel'][$tab->name]=$obj->label;
+								}
+							}
+						}
+					}
+				}
+			}
+			if ($elementtype) $this->attributes[$elementtype]['loaded']=1;
 		}
 		else
 		{
 			$this->error=$this->db->lasterror();
 			dol_syslog(get_class($this)."::fetch_name_optionals_label ".$this->error, LOG_ERR);
 		}
 		return $array_name_label;
 	}
 	/**
 	 * Return HTML string to put an input field into a page
@@ -916,23 +917,20 @@
 				if (is_array($fields_label))
 				{
 					$keyList .=', ';
 					$keyList .= implode(', ', $fields_label);
 				}
 				$sqlwhere='';
 				$sql = 'SELECT '.$keyList;
 				$sql.= ' FROM '.MAIN_DB_PREFIX .$InfoFieldList[0];
 				if (!empty($InfoFieldList[4]))
 				{
-				    if (strpos($InfoFieldList[4], '$ENTITY$')!==false) {
-				        $InfoFieldList[4]=str_replace('$ENTITY$',$conf->entity,$InfoFieldList[4]);
-				    }
 					if (strpos($InfoFieldList[4], '$SEL$')!==false) {
 						$InfoFieldList[4]=str_replace('$SEL$','SELECT',$InfoFieldList[4]);
 					}
 					if (strpos($InfoFieldList[4], '$ID$')!==false && !empty($objectid)) {
 						$InfoFieldList[4]=str_replace('$ID$',$objectid,$InfoFieldList[4]);
 					} else {
 						$InfoFieldList[4]=str_replace('$ID$','0',$InfoFieldList[4]);
 					}
 					if (strpos($InfoFieldList[4], 'extra')!==false)
 					{
@@ -1551,21 +1549,21 @@
 				{
 					$value_arr=GETPOST("options_".$key, 'array'); // check if an array
 					if (!empty($value_arr)) {
 						$value_key=implode($value_arr,',');
 					}else {
 						$value_key='';
 					}
 				}
 				else if (in_array($key_type,array('price','double')))
 				{
-					$value_arr=GETPOST("options_".$key, 'alpha');
+					$value_arr=GETPOST("options_".$key);
 					$value_key=price2num($value_arr);
 				}
 				else
 				{
 					$value_key=GETPOST("options_".$key);
 				}
 				$object->array_options["options_".$key]=$value_key;
 			}
 			if ($nofillrequired) {
 				$langs->load('errors');

--- a/htdocs/core/class/hookmanager.class.php
+++ b/htdocs/core/class/hookmanager.class.php
@@ -141,21 +141,21 @@
 			    'pdf_getlineprogress',
 			    'pdf_getlinetotalexcltax',
 			    'pdf_getlinetotalwithtax',
 				'paymentsupplierinvoices',
 				'printAddress',
 				'printSearchForm',
 				'printTabsHead',
 				'formatEvent',
                 'printObjectLine',
                 'printObjectSubLine',
-				'createDictionaryFieldlist',
+				'createDictionaryFieldList',
 				'editDictionaryFieldlist',
 				'getFormMail',
 			    'showLinkToObjectBlock'
 				)
 			)) $hooktype='addreplace';
         if ($method == 'insertExtraFields')
         {
         	$hooktype='returnvalue';	// @deprecated. TODO Remove all code with "executeHooks('insertExtraFields'" as soon as there is a trigger available.
         	dol_syslog("Warning: The hook 'insertExtraFields' is deprecated and must not be used. Use instead trigger on CRUD event (ask it to dev team if not implemented)", LOG_WARNING);
         }

--- a/htdocs/core/class/html.form.class.php
+++ b/htdocs/core/class/html.form.class.php
@@ -4570,22 +4570,21 @@
 				if ($val['showoncombobox']) $tmpfieldstoshow.=($tmpfieldstoshow?',':'').'t.'.$key;
 			}
 			if ($tmpfieldstoshow) $fieldstoshow = $tmpfieldstoshow;
 		}
 		$out='';
 		$outarray=array();
 		$num=0;
 		$sql = "SELECT t.rowid, ".$fieldstoshow." FROM ".MAIN_DB_PREFIX .$objecttmp->table_element." as t";
 		if ($objecttmp->ismultientitymanaged == 2)
 			if (!$user->rights->societe->client->voir && !$user->societe_id) $sql .= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
-		$sql.= " WHERE 1=1";
-		if(! empty($objecttmp->ismultientitymanaged)) $sql.= " AND t.entity IN (".getEntity($objecttmp->table_element).")";
+		$sql.= " WHERE t.entity IN (".getEntity($objecttmp->table_element).")";
 		if ($objecttmp->ismultientitymanaged == 1 && ! empty($user->societe_id))
 		{
 			if ($objecttmp->element == 'societe') $sql.= " AND t.rowid = ".$user->societe_id;
 				else $sql.= " AND t.fk_soc = ".$user->societe_id;
 		}
 		if ($searchkey != '') $sql.=natural_search(explode(',',$fieldstoshow), $searchkey);
 		if ($objecttmp->ismultientitymanaged == 2)
 			if (!$user->rights->societe->client->voir && !$user->societe_id) $sql.= " AND t.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
 		$sql.=$this->db->order($fieldstoshow,"ASC");
 		$resql=$this->db->query($sql);

--- a/htdocs/core/class/html.formaccounting.class.php
+++ b/htdocs/core/class/html.formaccounting.class.php
@@ -16,21 +16,20 @@
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  */
 /**
  *	\file       htdocs/core/class/html.formaccounting.class.php
  *  \ingroup    Advanced accountancy
  *	\brief      File of class with all html predefined components
  */
-require_once DOL_DOCUMENT_ROOT .'/core/class/html.form.class.php';
 /**
  *	Class to manage generation of HTML components for accounting management
  */
 class FormAccounting extends Form
 {
 	private $options_cache = array();
 	var $db;
 	var $error;
 	/**
 	* Constructor
@@ -199,48 +198,47 @@
 		while ($obj = $this->db->fetch_object($resql)) {
 			$options[$obj->import_key] = dol_print_date($obj->import_key, 'dayhourtext');
 		}
 		return Form::selectarray($htmlname, $options, $selectedkey);
 	}
 	/**
 	 * Return list of accounts with label by chart of accounts
 	 *
 	 * @param string   $selectid           Preselected id or code of accounting accounts (depends on $select_in)
 	 * @param string   $htmlname           Name of HTML field id. If name start with '.', it is name of HTML css class, so several component with same name in different forms can be used.
-	 * @param int      $showempty          1=Add an empty field, 2=Add an empty field+'None' field
+	 * @param int      $showempty          Add an empty field
 	 * @param array    $event              Event options
 	 * @param int      $select_in          0=selectid value is a aa.rowid (default) or 1=selectid is aa.account_number
 	 * @param int      $select_out         Set value returned by select. 0=rowid (default), 1=account_number
 	 * @param string   $morecss            More css non HTML object
 	 * @param string   $usecache           Key to use to store result into a cache. Next call with same key will reuse the cache.
 	 * @return string                      String with HTML select
 	 */
 	function select_account($selectid, $htmlname = 'account', $showempty = 0, $event = array(), $select_in = 0, $select_out = 0, $morecss='maxwidth300 maxwidthonsmartphone', $usecache='')
 	{
-		global $conf, $langs;
+		global $conf;
 		require_once DOL_DOCUMENT_ROOT . '/core/lib/accounting.lib.php';
 		$out = '';
     	$options = array();
 		if ($usecache && ! empty($this->options_cache[$usecache]))
 		{
 		    $options = $this->options_cache[$usecache];
 		    $selected=$selectid;
 		}
 		else
 		{
     		$trunclength = empty($conf->global->ACCOUNTING_LENGTH_DESCRIPTION_ACCOUNT) ? 50 : $conf->global->ACCOUNTING_LENGTH_DESCRIPTION_ACCOUNT;
     		$sql = "SELECT DISTINCT aa.account_number, aa.label, aa.rowid, aa.fk_pcg_version";
     		$sql .= " FROM " . MAIN_DB_PREFIX . "accounting_account as aa";
     		$sql .= " INNER JOIN " . MAIN_DB_PREFIX . "accounting_system as asy ON aa.fk_pcg_version = asy.pcg_version";
     		$sql .= " AND asy.rowid = " . $conf->global->CHARTOFACCOUNTS;
     		$sql .= " AND aa.active = 1";
-    		$sql .= " AND aa.entity=".$conf->entity;
     		$sql .= " ORDER BY aa.account_number";
     		dol_syslog(get_class($this) . "::select_account", LOG_DEBUG);
     		$resql = $this->db->query($sql);
     		if (!$resql) {
     			$this->error = "Error " . $this->db->lasterror();
     			dol_syslog(get_class($this) . "::select_account " . $this->error, LOG_ERR);
     			return -1;
     		}
     		$selected = 0;
     		while ($obj = $this->db->fetch_object($resql))
@@ -259,25 +257,21 @@
     				$selected = $select_value_out;
     			}
     			$options[$select_value_out] = $label;
     		}
     		$this->db->free($resql);
     		if ($usecache)
     		{
                 $this->options_cache[$usecache] = $options;
     		}
 		}
-		if ($showempty == 2)
-		{
-			$options['0'] = $langs->trans("None");
-		}
-		$out .= Form::selectarray($htmlname, $options, $selected, ($showempty > 0 ? 1 : 0), 0, 0, '', 0, 0, 0, '', $morecss, 1);
+		$out .= Form::selectarray($htmlname, $options, $selected, $showempty, 0, 0, '', 0, 0, 0, '', $morecss, 1);
 		return $out;
 	}
 	/**
 	 * Return list of auxilary thirdparty accounts
 	 *
 	 * @param string   $selectid       Preselected pcg_type
 	 * @param string   $htmlname       Name of field in html form
 	 * @param int      $showempty      Add an empty field
 	 * @param string   $morecss        More css
 	 * @return string                  String with HTML select

--- a/htdocs/core/class/html.formfile.class.php
+++ b/htdocs/core/class/html.formfile.class.php
@@ -724,21 +724,21 @@
 	 *  @param	string	$filter			Filter filenames on this regex string (Example: '\.pdf$')
 	 *	@return	string              	Output string with HTML link of documents (might be empty string). This also fill the array ->infofiles
 	 */
 	function getDocumentsLink($modulepart, $modulesubdir, $filedir, $filter='')
 	{
 		global $conf, $langs;
 		include_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';
 		$out='';
 		$this->infofiles=array('nboffiles'=>0,'extensions'=>array(),'files'=>array());
 		$filterforfilesearch = preg_quote(basename($modulesubdir),'/').'[^\-]+';
-		$file_list=dol_dir_list($filedir, 'files', 0, $filterforfilesearch, '\.meta$|\.png$');	// We also discard .meta and .png preview
+		$file_list=dol_dir_list($filedir, 'files', 0, $filterforfilesearch, '\.meta$|\.png$');	// Get list of files starting with name of ref (but not followed by "-" to discard uploaded files)
 		$out.= '<!-- html.formfile::getDocumentsLink -->'."\n";
 		if (! empty($file_list))
 		{
 			$out='<dl class="dropdown inline-block">
     			<dt><a data-ajax="false" href="#" onClick="return false;">'.img_picto('', 'listlight', '', 0, 0, 0, '', 'valignbottom').'</a></dt>
     			<dd><div class="multichoicedoc" style="position:absolute;left:100px;" ><ul class="ulselectedfields" style="display: none;">';
 			$tmpout='';
 			$found=0;
 			foreach($file_list as $file)
 			{

--- a/htdocs/core/class/smtps.class.php
+++ b/htdocs/core/class/smtps.class.php
@@ -1117,21 +1117,21 @@
 		$keyCount = count($_types);
 		if( $keyCount === 0 )
 		die ("Sorry, no content");
 		else if( $keyCount === 1 && empty($conf->global->MAIN_MAIL_USE_MULTI_PART))
 		{
 			$_msgData = $this->_msgContent;
 			$_msgData = $_msgData[$_types[0]];
 			$content = 'Content-Type: ' . $_msgData['mimeType'] . '; charset="' . $this->getCharSet() . '"' . "\r\n"
 			. 'Content-Transfer-Encoding: ' . $this->getTransEncodeType() . "\r\n"
 			. 'Content-Disposition: inline'  . "\r\n"
-			. 'Content-Description: Message' . "\r\n";
+			. 'Content-Description: message' . "\r\n";
 			if ( $this->getMD5flag() )
 			$content .= 'Content-MD5: ' . $_msgData['md5'] . "\r\n";
 			$content .= "\r\n"
 			.  $_msgData['data'] . "\r\n";
 		}
 		else if( $keyCount >= 1 || ! empty($conf->global->MAIN_MAIL_USE_MULTI_PART))
 		{
 			$content = 'Content-Type: multipart/mixed; boundary="' . $this->_getBoundary('mixed') . '"'   . "\r\n";
 			$content .= "Content-Transfer-Encoding: 8bit\r\n";
 			$content .= "\r\n";
@@ -1145,21 +1145,21 @@
 			foreach ($this->_msgContent as $type => $_content )
 			{
 				if ( $type == 'attachment' )
 				{
 					foreach ( $_content as $_file => $_data )
 					{
 						$content .= "--" . $this->_getBoundary('mixed') . "\r\n"
 						.  'Content-Disposition: attachment; filename="' . $_data['fileName'] . '"' . "\r\n"
 						.  'Content-Type: ' . $_data['mimeType'] . '; name="' . $_data['fileName'] . '"' . "\r\n"
 						.  'Content-Transfer-Encoding: base64' . "\r\n"
-						.  'Content-Description: ' . $_data['fileName'] ."\r\n";
+						.  'Content-Description: File Attachment' . "\r\n";
 						if ( $this->getMD5flag() )
 						$content .= 'Content-MD5: ' . $_data['md5'] . "\r\n";
 						$content .= "\r\n" .  $_data['data'] . "\r\n\r\n";
 					}
 				}
 				else if ( $type == 'image' )
 				{
 					foreach ( $_content as $_image => $_data )
 					{
 						$content .= "--" . $this->_getBoundary('related') . "\r\n";  // always related for an inline image

--- a/htdocs/core/lib/ajax.lib.php
+++ b/htdocs/core/lib/ajax.lib.php
@@ -371,22 +371,21 @@
 	 					/* Code to add class of origin OPTION propagated to the new select2 <li> tag */
 						if (data.element) { $(container).addClass($(data.element).attr("class")); }
 						if ($(data.element).attr("data-html") != undefined) return htmlEntityDecodeJs($(data.element).attr("data-html"));		// If property html set, we decode html entities and use this
 					    return data.text;
 					},
 					templateSelection: function (selection) {		/* Format visible output of selected value */
 						return selection.text;
 					},
 					escapeMarkup: function(markup) {
 						return markup;
-					},
-					dropdownCssClass: \'ui-dialog\'
+					}
 				})';
 	if ($forcefocus) $msg.= '.select2(\'focus\')';
 	$msg.= ';'."\n";
 	if (is_array($events) && count($events))    // If an array of js events to do were provided.
 	{
 		$msg.= '
 			jQuery("#'.$htmlname.'").change(function () {
 				var obj = '.json_encode($events).';
 		   		$.each(obj, function(key,values) {
 	    			if (values.method.length) {

--- a/htdocs/core/lib/company.lib.php
+++ b/htdocs/core/lib/company.lib.php
@@ -140,21 +140,21 @@
 			$h++;
 		}
 		if (! empty($conf->accounting->enabled) && $object->fournisseur>0)
 		{
 			$head[$h][0] = DOL_URL_ROOT.'/accountancy/bookkeeping/thirdparty_lettrage_supplier.php?socid='.$object->id;
 			$head[$h][1] = $langs->trans("TabAccountingSupplier");
 			$head[$h][2] = 'accounting_supplier';
 			$h++;
 		}
 	}
-    if (! empty($conf->commande->enabled) || ! empty($conf->propal->enabled) || ! empty($conf->facture->enabled) || ! empty($conf->ficheinter->enabled) || ! empty($conf->fournisseur->enabled))
+    if (! empty($conf->commande->enabled) || ! empty($conf->propal->enabled) || ! empty($conf->facture->enabled) || ! empty($conf->fichinter->enabled) || ! empty($conf->fournisseur->enabled))
     {
         $head[$h][0] = DOL_URL_ROOT.'/societe/consumption.php?socid='.$object->id;
         $head[$h][1] = $langs->trans("Referers");
         $head[$h][2] = 'consumption';
         $h++;
     }
     if (empty($conf->global->SOCIETE_DISABLE_BANKACCOUNT))
     {
         $langs->load("banks");
         $nbBankAccount=0;
@@ -637,21 +637,20 @@
  * 		@param	DoliDB		$db			Database handler
  * 		@param	Societe		$object		Third party object
  *      @param  string		$backtopage	Url to go once contact is created
  *      @return	void
  */
 function show_contacts($conf,$langs,$db,$object,$backtopage='')
 {
 	global $user,$conf,$extrafields,$hookmanager;
 	global $contextpage;
     $form = new Form($db);
-    $optioncss = GETPOST('optioncss', 'alpha');
     $sortfield = GETPOST("sortfield",'alpha');
     $sortorder = GETPOST("sortorder",'alpha');
     $page = GETPOST('page','int');
     $search_status		= GETPOST("search_status",'int');
     if ($search_status=='') $search_status=1; // always display activ customer first
     $search_name = GETPOST("search_name",'alpha');
     $search_addressphone = GETPOST("search_addressphone",'alpha');
     if (! $sortorder) $sortorder="ASC";
     if (! $sortfield) $sortfield="t.lastname";
     if (! empty($conf->clicktodial->enabled))
@@ -678,21 +677,20 @@
     	foreach($extrafields->attributes[$contactstatic->table_element]['label'] as $key => $val)
     	{
     		if (! empty($extrafields->attributes[$contactstatic->table_element]['list'][$key])) $arrayfields["ef.".$key]=array('label'=>$extrafields->attributes[$contactstatic->table_element]['label'][$key], 'checked'=>(($extrafields->attributes[$contactstatic->table_element]['list'][$key]<0)?0:1), 'position'=>$extrafields->attributes[$contactstatic->table_element]['pos'][$key], 'enabled'=>(abs($extrafields->attributes[$contactstatic->table_element]['list'][$key])!=3 && $extrafields->attributes[$contactstatic->table_element]['perms'][$key]));
     	}
     }
     $search=array();
     foreach($contactstatic->fields as $key => $val)
     {
     	if (GETPOST('search_'.$key,'alpha')) $search[$key]=GETPOST('search_'.$key,'alpha');
     }
-    $search_array_options=$extrafields->getOptionalsFromPost($extralabels,'','search_');
     if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') ||GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
     {
     	$search_status		 = '';
     	$search_name         = '';
     	$search_addressphone = '';
     	$search_array_options=array();
     	foreach($contactstatic->fields as $key => $val)
    		{
    			$search[$key]='';
    		}
@@ -713,33 +711,30 @@
     print '<form method="POST" action="'.$_SERVER["PHP_SELF"].'" name="formfilter">';
     print '<input type="hidden" name="formfilteraction" id="formfilteraction" value="list">';
     print '<input type="hidden" name="socid" value="'.$object->id.'">';
     print '<input type="hidden" name="sortorder" value="'.$sortorder.'">';
     print '<input type="hidden" name="sortfield" value="'.$sortfield.'">';
     print '<input type="hidden" name="page" value="'.$page.'">';
     $varpage=empty($contextpage)?$_SERVER["PHP_SELF"]:$contextpage;
     $selectedfields=$form->multiSelectArrayWithCheckbox('selectedfields', $arrayfields, $varpage);	// This also change content of $arrayfields
 	print '<div class="div-table-responsive">';		// You can use div-table-responsive-no-min if you dont need reserved height for your table
     print "\n".'<table class="tagtable liste">'."\n";
-    $param="socid=".urlencode($object->id);
-    if ($search_status != '') $param.='&search_status='.urlencode($search_status);
-    if ($search_name != '')   $param.='&search_name='.urlencode($search_name);
-    if ($optioncss != '')     $param.='&optioncss='.urlencode($optioncss);
-    include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_param.tpl.php';
+    $param="socid=".$object->id;
+    if ($search_status != '') $param.='&amp;search_status='.$search_status;
+    if ($search_name != '') $param.='&amp;search_name='.urlencode($search_name);
     $sql = "SELECT t.rowid, t.lastname, t.firstname, t.fk_pays as country_id, t.civility, t.poste, t.phone as phone_pro, t.phone_mobile, t.phone_perso, t.fax, t.email, t.skype, t.statut, t.photo,";
     $sql .= " t.civility as civility_id, t.address, t.zip, t.town";
     $sql .= " FROM ".MAIN_DB_PREFIX."socpeople as t";
     $sql .= " LEFT JOIN ".MAIN_DB_PREFIX."socpeople_extrafields as ef on (t.rowid = ef.fk_object)";
     $sql .= " WHERE t.fk_soc = ".$object->id;
     if ($search_status!='' && $search_status != '-1') $sql .= " AND t.statut = ".$db->escape($search_status);
-    if ($search_name) $sql .= natural_search(array('t.lastname', 't.firstname'), $search_name);
-    include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_sql.tpl.php';
+    if ($search_name)       $sql .= " AND (t.lastname LIKE '%".$db->escape($search_name)."%' OR t.firstname LIKE '%".$db->escape($search_name)."%')";
     if ($sortfield == "t.name") $sql.=" ORDER BY t.lastname $sortorder, t.firstname $sortorder";
     else $sql.= " ORDER BY $sortfield $sortorder";
     dol_syslog('core/lib/company.lib.php :: show_contacts', LOG_DEBUG);
     $result = $db->query($sql);
     if (! $result) dol_print_error($db);
     $num = $db->num_rows($result);
     print '<tr class="liste_titre">';
     foreach($contactstatic->fields as $key => $val)
     {
     	$align='';
@@ -848,21 +843,21 @@
             include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_print_fields.tpl.php';
 			print '<td align="right">';
             if (! empty($conf->agenda->enabled) && $user->rights->agenda->myactions->create)
             {
                 print '<a href="'.DOL_URL_ROOT.'/comm/action/card.php?action=create&actioncode=&contactid='.$obj->rowid.'&socid='.$object->id.'&backtopage='.urlencode($backtopage).'">';
                 print img_object($langs->trans("Event"),"action");
                 print '</a> &nbsp; ';
             }
             if ($user->rights->societe->contact->creer)
             {
-                print '<a href="'.DOL_URL_ROOT.'/contact/card.php?action=edit&id='.$obj->rowid.'&backtopage='.urlencode($backtopage).'">';
+                print '<a href="'.DOL_URL_ROOT.'/contact/card.php?action=edit&amp;id='.$obj->rowid.'&amp;backtopage='.urlencode($backtopage).'">';
                 print img_edit();
                 print '</a>';
             }
             print '</td>';
             print "</tr>\n";
             $i++;
         }
     }
     else
 	{
@@ -1202,21 +1197,21 @@
             $tmp.=($donetodo != 'todo' ? $langs->trans("ActionsDoneShort") : '');
             if (get_class($filterobj) == 'Societe') $tmp.='</a>';
             $out.=getTitleFieldOfList($tmp);
 		}
 		$out.=getTitleFieldOfList($langs->trans("Ref"), 0, $_SERVER["PHP_SELF"], 'a.id', '', $param, '', $sortfield, $sortorder);
 		$out.=getTitleFieldOfList($langs->trans("Owner"));
         $out.=getTitleFieldOfList($langs->trans("Type"));
 		$out.=getTitleFieldOfList($langs->trans("Label"), 0, $_SERVER["PHP_SELF"], '', '', $param, '', $sortfield, $sortorder);
         $out.=getTitleFieldOfList($langs->trans("Date"), 0, $_SERVER["PHP_SELF"], 'a.datep,a.id', '', $param, 'align="center"', $sortfield, $sortorder);
 		$out.=getTitleFieldOfList('');
-		$out.=getTitleFieldOfList($langs->trans("ActionOnContact"), 0, $_SERVER["PHP_SELF"], 'a.fk_contact', '', $param, '', $sortfield, $sortorder);
+		$out.=getTitleFieldOfList('');
 		$out.=getTitleFieldOfList($langs->trans("Status"), 0, $_SERVER["PHP_SELF"], 'a.percent', '', $param, 'align="center"', $sortfield, $sortorder);
 		$out.=getTitleFieldOfList('', 0, $_SERVER["PHP_SELF"], '', '', $param, '', $sortfield, $sortorder, 'maxwidthsearch ');
 		$out.='</tr>';
         foreach ($histo as $key=>$value)
         {
 			$actionstatic->fetch($histo[$key]['id']);    // TODO Do we need this, we already have a lot of data of line into $histo
             $out.='<tr class="oddeven">';
             if ($donetodo)
             {
                 $out.='<td class="nowrap">';
@@ -1310,21 +1305,21 @@
                         $facturestatic->type=$histo[$key]['ftype'];
                         $out.=$facturestatic->getNomUrl(1,'compta');
                     } else {
                         $out.= $langs->trans("InvoiceDeleted");
                     }
             	}
             	else $out.='&nbsp;';
             }
             else $out.='&nbsp;';
             $out.='</td>';
-            if (empty($objcon->id) && isset($histo[$key]['contact_id']) && $histo[$key]['contact_id'] > 0)
+            if (! empty($objcon->id) && isset($histo[$key]['contact_id']) && $histo[$key]['contact_id'] > 0)
             {
                 $contactstatic->lastname=$histo[$key]['lastname'];
                 $contactstatic->firstname=$histo[$key]['firstname'];
                 $contactstatic->id=$histo[$key]['contact_id'];
                 $out.='<td width="120">'.$contactstatic->getNomUrl(1,'',10).'</td>';
             }
             else
             {
                 $out.='<td>&nbsp;</td>';
             }

--- a/htdocs/core/lib/functions.lib.php
+++ b/htdocs/core/lib/functions.lib.php
@@ -1,20 +1,20 @@
 <?php
 /* Copyright (C) 2000-2007	Rodolphe Quiedeville			<rodolphe@quiedeville.org>
  * Copyright (C) 2003		Jean-Louis Bergamo			<jlb@j1b.org>
- * Copyright (C) 2004-2018	Laurent Destailleur			<eldy@users.sourceforge.net>
+ * Copyright (C) 2004-2013	Laurent Destailleur			<eldy@users.sourceforge.net>
  * Copyright (C) 2004		Sebastien Di Cintio			<sdicintio@ressource-toi.org>
  * Copyright (C) 2004		Benoit Mortier				<benoit.mortier@opensides.be>
  * Copyright (C) 2004		Christophe Combelles			<ccomb@free.fr>
  * Copyright (C) 2005-2017	Regis Houssin				<regis.houssin@capnetworks.com>
  * Copyright (C) 2008		Raphael Bertrand (Resultic)	<raphael.bertrand@resultic.fr>
- * Copyright (C) 2010-2018	Juanjo Menent				<jmenent@2byte.es>
+ * Copyright (C) 2010-2016	Juanjo Menent				<jmenent@2byte.es>
  * Copyright (C) 2013		Cdric Salvador				<csalvador@gpcsolutions.fr>
  * Copyright (C) 2013-2017	Alexandre Spangaro			<aspangaro@zendsi.com>
  * Copyright (C) 2014		Cdric GROSS					<c.gross@kreiz-it.fr>
  * Copyright (C) 2014-2015	Marcos Garca				<marcosgdf@gmail.com>
  * Copyright (C) 2015		Jean-Franois Ferry			<jfefe@aternatik.fr>
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 3 of the License, or
  * (at your option) any later version.
@@ -473,42 +473,42 @@
 		case 'aZ09':
 			if (! is_array($out))
 			{
 				$out=trim($out);
 				if (preg_match('/[^a-z0-9_\-\.]+/i',$out)) $out='';
 			}
 			break;
 		case 'array':
 			if (! is_array($out) || empty($out)) $out=array();
 			break;
-		case 'nohtml':		// Recommended for most scalar parameters
+		case 'nohtml':
 			$out=dol_string_nohtmltag($out, 0);
 			break;
-		case 'alphanohtml':	// Recommended for search parameters
+		case 'alphanohtml':	// Recommended for search params
 			if (! is_array($out))
 			{
 				$out=trim($out);
 				if (preg_match('/"/',$out)) $out='';
 				else if (preg_match('/\.\.\//',$out)) $out='';
 				$out=dol_string_nohtmltag($out);
 			}
 			break;
 		case 'custom':
 			if (empty($filter)) return 'BadFourthParameterForGETPOST';
 			$out=filter_var($out, $filter, $options);
 			break;
 	}
 	if (empty($method) || $method == 3 || $method == 4)
 	{
 		if (preg_match('/^search_/', $paramname) || in_array($paramname, array('sortorder','sortfield')))
 		{
-			if ($out != '')		// $out = '0' like 'abc' is a search criteria to keep
+			if (! empty($out))
 			{
 				$user->lastsearch_values_tmp[$relativepathstring][$paramname]=$out;
 			}
 		}
 	}
 	return $out;
 }
 /**
  *  Return a prefix to use for this Dolibarr instance, for session/cookie names or email id.
  *  This prefix is valid in a web context only and is unique for instance and avoid conflict
@@ -3590,21 +3590,21 @@
 			{
 				if (! $thirdparty_buyer->localtax1_assuj) return 0;
 			}
 			else
 			{
 				if (! $thirdparty_seller->localtax1_assuj) return 0;
 			}
 		}
 		if ($local == 2)
 		{
-			if (! $mysoc->localtax2_assuj) return 0;		// If main vat is 0, IRPF may be different than 0.
+			if (! $mysoc->localtax2_assuj || (string) $vatratecleaned == "0") return 0;
 			if ($thirdparty_seller->id == $mysoc->id)
 			{
 				if (! $thirdparty_buyer->localtax2_assuj) return 0;
 			}
 			else
 			{
 				if (! $thirdparty_seller->localtax2_assuj) return 0;
 			}
 		}
 	}
@@ -3640,25 +3640,21 @@
 		{
 			if ($thirdparty_seller != $mysoc)
 			{
 				if (!isOnlyOneLocalTax($local))  // TODO We should provide $vatrate to search on correct line and not always on line with highest vat rate
 				{
 					return $thirdparty_seller->localtax2_value;
 				}
 			}
 			else  // i am the seller
 			{
-				if (in_array($mysoc->country_code, array('ES')))
-				{
-					return $thirdparty_buyer->localtax2_value;
-				}
-				else
+				if (!isOnlyOneLocalTax($local))  // This is for spain only, we don't return value found into datbase even if there is only one locatax vat.
 				{
 					return $conf->global->MAIN_INFO_VALUE_LOCALTAX2;
 				}
 			}
 		}
 	}
 	$sql  = "SELECT t.localtax1, t.localtax2, t.localtax1_type, t.localtax2_type";
    	$sql .= " FROM ".MAIN_DB_PREFIX."c_tva as t, ".MAIN_DB_PREFIX."c_country as c";
    	$sql .= " WHERE t.fk_pays = c.rowid AND c.code = '".$thirdparty_seller->country_code."'";
    	$sql .= " AND t.taux = ".((float) $vatratecleaned)." AND t.active = 1";
@@ -3799,29 +3795,64 @@
 		else $sql .= " WHERE t.fk_pays = c.rowid AND c.code = '".$seller->country_code."'";
 		$sql.= " AND t.taux = ".((float) $vatratecleaned)." AND t.active = 1";
 		if ($vatratecode) $sql.= " AND t.code = '".$vatratecode."'";
 	}
 	$resql=$db->query($sql);
 	if ($resql)
 	{
 		$obj = $db->fetch_object($resql);
 		if ($local == 1)
 		{
-			return array($obj->localtax1_type, get_localtax($vatrate, $local, $buyer, $seller), $obj->accountancy_code_sell, $obj->accountancy_code_buy);
+			if (! isOnlyOneLocalTax(1))
+			{
+				return array($obj->localtax1_type, get_localtax($vatrate, $local, $buyer, $seller), $obj->accountancy_code_sell, $obj->accountancy_code_buy);
+			}
+			else
+			{
+				return array($obj->localtax1_type, $obj->localtax1,$obj->accountancy_code_sell, $obj->accountancy_code_buy);
+			}
 		}
 		elseif ($local == 2)
 		{
-			return array($obj->localtax2_type, get_localtax($vatrate, $local, $buyer, $seller),$obj->accountancy_code_sell, $obj->accountancy_code_buy);
+			if (! isOnlyOneLocalTax(2))
+			{
+				return array($obj->localtax2_type, get_localtax($vatrate, $local, $buyer, $seller),$obj->accountancy_code_sell, $obj->accountancy_code_buy);
+			}
+			else
+			{
+				return array($obj->localtax2_type, $obj->localtax2,$obj->accountancy_code_sell, $obj->accountancy_code_buy);
+			}
 		}
 		else
 		{
-			return array($obj->localtax1_type, get_localtax($vatrate, 1, $buyer, $seller), $obj->localtax2_type, get_localtax($vatrate, 2, $buyer, $seller), $obj->accountancy_code_sell,$obj->accountancy_code_buy);
+			if(! isOnlyOneLocalTax(1))
+			{
+				if(! isOnlyOneLocalTax(2))
+				{
+					return array($obj->localtax1_type, get_localtax($vatrate, 1, $buyer, $seller), $obj->localtax2_type, get_localtax($vatrate, 2, $buyer, $seller), $obj->accountancy_code_sell,$obj->accountancy_code_buy);
+				}
+				else
+				{
+					return array($obj->localtax1_type, get_localtax($vatrate, 1, $buyer, $seller), $obj->localtax2_type, $obj->localtax2, $obj->accountancy_code_sell, $obj->accountancy_code_buy);
+				}
+			}
+			else
+			{
+				if(! isOnlyOneLocalTax(2))
+				{
+					return array($obj->localtax1_type, $obj->localtax1, $obj->localtax2_type, get_localtax($vatrate, 2, $buyer, $seller), $obj->accountancy_code_sell, $obj->accountancy_code_buy);
+				}
+				else
+				{
+					return array($obj->localtax1_type, $obj->localtax1, $obj->localtax2_type, $obj->localtax2, $obj->accountancy_code_sell, $obj->accountancy_code_buy);
+				}
+			}
 		}
 	}
 	return 0;
 }
 /**
  *	Return vat rate of a product in a particular selling country or default country vat if product is unknown
  *  Function called by get_default_tva
  *
  *  @param	int			$idprod          	Id of product or 0 if not a predefined product
  *  @param  Societe		$thirdparty_seller  Thirdparty with a ->country_code defined (FR, US, IT, ...)
@@ -4747,22 +4778,22 @@
 			)
 		);
 	}
 	if (! empty($conf->multicompany->enabled))
 	{
 		$substitutionarray=array_merge($substitutionarray, array('__ENTITY_ID__' => $conf->entity));
 	}
 	return $substitutionarray;
 }
 /**
- *  Make substitution into a text string, replacing keys with vals from $substitutionarray (oldval=>newval),
- *  and texts like __(TranslationKey|langfile)__ and __[ConstantKey]__ are also replaced.
+ *  Make substitution into a text string, replacing keys with vals from $substitutionarray (oldval=>newval).
+ *  Texts like __(TranslationKey|langfile)__ and __[ConstantKey]__ are also replaced.
  *  Example of usage:
  *  $substitutionarray = getCommonSubstitutionArray($langs, 0, null, $thirdparty);
  *  complete_substitutions_array($substitutionarray, $langs, $thirdparty);
  *  $mesg = make_substitutions($mesg, $substitutionarray, $langs);
  *
  *  @param	string		$text	      			Source string in which we must do substitution
  *  @param  array		$substitutionarray		Array with key->val to substitute. Example: array('__MYKEY__' => 'MyVal', ...)
  *  @param	Translate	$outputlangs			Output language
  * 	@return string  		    				Output string after substitutions
  *  @see	complete_substitutions_array
@@ -4891,21 +4922,21 @@
  *
  * @param	string	$firstname		Firstname
  * @param	string	$lastname		Lastname
  * @param	int		$nameorder		-1=Auto, 0=Lastname+Firstname, 1=Firstname+Lastname, 2=Firstname
  * @return	string					Firstname + lastname or Lastname + firstname
  */
 function dolGetFirstLastname($firstname,$lastname,$nameorder=-1)
 {
 	global $conf;
 	$ret='';
-	if ($nameorder < 0) $nameorder=$conf->global->MAIN_FIRSTNAME_NAME_POSITION;
+	if ($nameorder < 0) $nameorder=(empty($conf->global->MAIN_FIRSTNAME_NAME_POSITION));
 	if ($nameorder && ((string) $nameorder != '2'))
 	{
 		$ret.=$firstname;
 		if ($firstname && $lastname) $ret.=' ';
 		$ret.=$lastname;
 	}
 	else if ($nameorder == 2)
 	{
 	   $ret.=$firstname;
 	}

--- a/htdocs/core/lib/modulebuilder.lib.php
+++ b/htdocs/core/lib/modulebuilder.lib.php
@@ -47,21 +47,21 @@
         if (empty($addfieldentry['name']))
     	{
     		setEventMessages($langs->trans('ErrorFieldRequired', $langs->transnoentitiesnoconv("Name")), null, 'errors');
     		return -2;
     	}
         if (empty($addfieldentry['label']))
     	{
     		setEventMessages($langs->trans('ErrorFieldRequired', $langs->transnoentitiesnoconv("Label")), null, 'errors');
     		return -2;
     	}
-    	if (! preg_match('/^(integer|date|timestamp|varchar|double|html|price)/', $addfieldentry['type']))
+    	if (! preg_match('/^(integer|date|timestamp|varchar|double)/', $addfieldentry['type']))
     	{
     		setEventMessages($langs->trans('BadFormatForType', $objectname), null, 'errors');
     		return -2;
     	}
     }
     $pathoffiletoeditsrc=$readdir.'/class/'.strtolower($objectname).'.class.php';
     $pathoffiletoedittarget=$destdir.'/class/'.strtolower($objectname).'.class.php'.($readdir != $destdir ? '.new' : '');
     if (! dol_is_file($pathoffiletoeditsrc))
     {
     	$langs->load("errors");
@@ -195,21 +195,20 @@
     $i=0;
     $texttoinsert = '-- BEGIN MODULEBUILDER FIELDS'."\n";
     if (count($object->fields))
     {
         foreach($object->fields as $key => $val)
         {
             $i++;
             $type = $val['type'];
             $type = preg_replace('/:.*$/', '', $type);		// For case type = 'integer:Societe:societe/class/societe.class.php'
             if ($type == 'html') $type = 'text';            // html modulebuilder type is a text type in database
-            if ($type == 'price') $type = 'double';            // html modulebuilder type is a text type in database
             $texttoinsert.= "\t".$key." ".$type;
             if ($key == 'rowid')  $texttoinsert.= ' AUTO_INCREMENT PRIMARY KEY';
             if ($key == 'entity') $texttoinsert.= ' DEFAULT 1';
             else
             {
             	if ($val['default'] != '')
             	{
             		if (preg_match('/^null$/i', $val['default'])) $texttoinsert.= " DEFAULT NULL";
             		else if (preg_match('/varchar/', $val['type'])) $texttoinsert.= " DEFAULT '".$db->escape($val['default'])."'";
             		else $texttoinsert.= (($val['default'] > 0)?' DEFAULT '.$val['default']:'');

--- a/htdocs/core/lib/security.lib.php
+++ b/htdocs/core/lib/security.lib.php
@@ -310,21 +310,21 @@
 	global $db, $conf;
 	$params = explode('&', $tableandshare);
 	$dbtablename=(! empty($params[0]) ? $params[0] : '');
 	$sharedelement=(! empty($params[1]) ? $params[1] : $dbtablename);
 	foreach ($featuresarray as $feature)
 	{
 		$sql='';
 		if ($feature == 'member')  $feature='adherent';
 		if ($feature == 'project') $feature='projet';
 		if ($feature == 'task')    $feature='projet_task';
-		$check = array('adherent','banque','don','user','usergroup','product','produit','service','produit|service','categorie','resource'); // Test on entity only (Objects with no link to company)
+		$check = array('adherent','banque','don','user','usergroup','produit','service','produit|service','categorie','resource'); // Test on entity only (Objects with no link to company)
 		$checksoc = array('societe');	 // Test for societe object
 		$checkother = array('contact','agenda');	 // Test on entity and link to third party. Allowed if link is empty (Ex: contacts...).
 		$checkproject = array('projet','project'); // Test for project object
 		$checktask = array('projet_task');
 		$nocheck = array('barcode','stock');	// No test
 		$checkdefault = 'all other not already defined'; // Test on entity and link to third party. Not allowed if link is empty (Ex: invoice, orders...).
 		if (empty($dbtablename))
 		{
 			$dbtablename = $feature;
 			$sharedelement = (! empty($params[1]) ? $params[1] : $dbtablename);		// We change dbtablename, so we set sharedelement too.

--- a/htdocs/core/lib/tax.lib.php
+++ b/htdocs/core/lib/tax.lib.php
@@ -22,21 +22,21 @@
  */
 /**
  *      \file       htdocs/core/lib/tax.lib.php
  *      \ingroup    tax
  *      \brief      Library for tax module
  */
 /**
  * Prepare array with list of tabs
  *
  * @param   ChargeSociales	$object		Object related to tabs
- * @return  array						Array of tabs to show
+ * @return  array				Array of tabs to show
  */
 function tax_prepare_head(ChargeSociales $object)
 {
     global $db, $langs, $conf, $user;
     $h = 0;
     $head = array();
 	$head[$h][0] = DOL_URL_ROOT.'/compta/sociales/card.php?id='.$object->id;
 	$head[$h][1] = $langs->trans('Card');
 	$head[$h][2] = 'card';
 	$h++;
@@ -152,20 +152,21 @@
     else
     {
         dol_print_error($db);
         return -3;
     }
 }
 /**
  *  Gets Tax to collect for the given year (and given quarter or month)
  *  The function gets the Tax in split results, as the Tax declaration asks
  *  to report the amounts for different Tax rates as different lines.
+ *  This function also accounts recurrent invoices.
  *
  *  @param	string	$type          	Tax type, either 'vat', 'localtax1' or 'localtax2'
  *  @param	DoliDB	$db          	Database handler object
  *  @param  int		$y           	Year
  *  @param  int		$q           	Quarter
  *  @param  string	$date_start  	Start date
  *  @param  string	$date_end    	End date
  *  @param  int		$modetax     	0 or 1 (option vat on debit)
  *  @param  int		$direction   	'sell' (customer invoice) or 'buy' (supplier invoices)
  *  @param  int		$m           	Month
@@ -272,21 +273,21 @@
         if ($q) $sql.= " AND (date_format(f.datef,'%m') > ".(($q-1)*3)." AND date_format(f.datef,'%m') <= ".($q*3).")";
         if ($date_start && $date_end) $sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
         $sql.= " AND (d.product_type = 0";                              // Limit to products
         $sql.= " AND d.date_start is null AND d.date_end IS NULL)";     // enhance detection of service
         $sql.= " ORDER BY d.rowid, d.".$fk_facture;
     }
     if (! $sql) return -1;
     if ($sql == 'TODO') return -2;
     if ($sql != 'TODO')
     {
-        dol_syslog("Tax.lib.php::tax_by_date", LOG_DEBUG);
+        dol_syslog("Tax.lib.php::vat_by_date", LOG_DEBUG);
         $resql = $db->query($sql);
         if ($resql)
         {
             $rate = -1;
             $oldrowid='';
             while($assoc = $db->fetch_array($resql))
             {
                 if (! isset($list[$assoc['rate']]['totalht']))  $list[$assoc['rate']]['totalht']=0;
                 if (! isset($list[$assoc['rate']]['vat']))      $list[$assoc['rate']]['vat']=0;
                 if (! isset($list[$assoc['rate']]['localtax1']))      $list[$assoc['rate']]['localtax1']=0;
@@ -355,21 +356,21 @@
         }
         else if ($y)
         {
             $sql.= " AND f.datef >= '".$db->idate(dol_get_first_day($y,1,false))."'";
             $sql.= " AND f.datef <= '".$db->idate(dol_get_last_day($y,12,false))."'";
         }
         if ($q) $sql.= " AND (date_format(f.datef,'%m') > ".(($q-1)*3)." AND date_format(f.datef,'%m') <= ".($q*3).")";
         if ($date_start && $date_end) $sql.= " AND f.datef >= '".$db->idate($date_start)."' AND f.datef <= '".$db->idate($date_end)."'";
         $sql.= " AND (d.product_type = 1";                              // Limit to services
         $sql.= " OR d.date_start is NOT null OR d.date_end IS NOT NULL)";       // enhance detection of service
-        $sql.= " ORDER BY d.rowid, d.".$fk_facture;
+        $sql.= " ORDER BY d.rowid, d.".$fk_facture; 
     }
     else    // Option vat on delivery for goods (payments) and payments for services
     {
         $sql = "SELECT d.rowid, d.product_type as dtype, d.".$fk_facture." as facid, d.$f_rate as rate, d.total_ht as total_ht, d.total_ttc as total_ttc, d.".$total_tva." as total_vat, d.description as descr,";
         $sql .=" d.".$total_localtax1." as total_localtax1, d.".$total_localtax2." as total_localtax2, ";
         $sql.= " d.date_start as date_start, d.date_end as date_end,";
         $sql.= " f.".$invoicefieldref." as facnum, f.type, f.total_ttc as ftotal_ttc, f.datef, s.nom as company_name, s.rowid as company_id,";
         $sql.= " p.rowid as pid, p.ref as pref, p.fk_product_type as ptype,";
         $sql.= " pf.".$fk_payment." as payment_id, pf.amount as payment_amount";
         $sql.= " FROM ".MAIN_DB_PREFIX.$invoicetable." as f,";
@@ -397,27 +398,27 @@
             $sql.= " AND pa.datep <= '".$db->idate(dol_get_last_day($y,12,false))."'";
         }
         if ($q) $sql.= " AND (date_format(pa.datep,'%m') > ".(($q-1)*3)." AND date_format(pa.datep,'%m') <= ".($q*3).")";
         if ($date_start && $date_end) $sql.= " AND pa.datep >= '".$db->idate($date_start)."' AND pa.datep <= '".$db->idate($date_end)."'";
         $sql.= " AND (d.product_type = 1";                              // Limit to services
         $sql.= " OR d.date_start is NOT null OR d.date_end IS NOT NULL)";       // enhance detection of service
         $sql.= " ORDER BY d.rowid, d.".$fk_facture.", pf.rowid";
     }
     if (! $sql)
     {
-        dol_syslog("Tax.lib.php::tax_by_date no accountancy module enabled".$sql,LOG_ERR);
+        dol_syslog("Tax.lib.php::vat_by_date no accountancy module enabled".$sql,LOG_ERR);
         return -1;  // -1 = Not accountancy module enabled
     }
     if ($sql == 'TODO') return -2; // -2 = Feature not yet available
     if ($sql != 'TODO')
     {
-        dol_syslog("Tax.lib.php::tax_by_date", LOG_DEBUG);
+        dol_syslog("Tax.lib.php::vat_by_date", LOG_DEBUG);
         $resql = $db->query($sql);
         if ($resql)
         {
             $rate = -1;
             $oldrowid='';
             while($assoc = $db->fetch_array($resql))
             {
                 if (! isset($list[$assoc['rate']]['totalht']))  $list[$assoc['rate']]['totalht']=0;
                 if (! isset($list[$assoc['rate']]['vat']))      $list[$assoc['rate']]['vat']=0;
 				if (! isset($list[$assoc['rate']]['localtax1']))      $list[$assoc['rate']]['localtax1']=0;
@@ -478,32 +479,32 @@
 			$sql.= " AND p.datep >= '".$db->idate(dol_get_first_day($y,$m,false))."'";
 			$sql.= " AND p.datep <= '".$db->idate(dol_get_last_day($y,$m,false))."'";
 		}
 		else if ($y)
 		{
 			$sql.= " AND p.datep >= '".$db->idate(dol_get_first_day($y,1,false))."'";
 			$sql.= " AND p.datep <= '".$db->idate(dol_get_last_day($y,12,false))."'";
 		}
 		if ($q) $sql.= " AND (date_format(p.datep,'%m') > ".(($q-1)*3)." AND date_format(p.datep,'%m') <= ".($q*3).")";
 		if ($date_start && $date_end) $sql.= " AND p.datep >= '".$db->idate($date_start)."' AND p.datep <= '".$db->idate($date_end)."'";
-		$sql.= " AND (d.product_type = -1";
+		$sql.= " AND (d.product_type = -1";                              
 		$sql.= " OR e.date_debut is NOT null OR e.date_fin IS NOT NULL)";       // enhance detection of service
 		$sql.= " ORDER BY e.rowid";
 		if (! $sql)
 		{
-			dol_syslog("Tax.lib.php::tax_by_date no accountancy module enabled".$sql,LOG_ERR);
+			dol_syslog("Tax.lib.php::vat_by_date no accountancy module enabled".$sql,LOG_ERR);
 			return -1;  // -1 = Not accountancy module enabled
 		}
 		if ($sql == 'TODO') return -2; // -2 = Feature not yet available
 		if ($sql != 'TODO')
 		{
-			dol_syslog("Tax.lib.php::tax_by_date", LOG_DEBUG);
+			dol_syslog("Tax.lib.php::vat_by_date", LOG_DEBUG);
 			$resql = $db->query($sql);
 			if ($resql)
 			{
 				$rate = -1;
 				$oldrowid='';
 				while($assoc = $db->fetch_array($resql))
 				{
 					if (! isset($list[$assoc['rate']]['totalht']))  $list[$assoc['rate']]['totalht']=0;
 					if (! isset($list[$assoc['rate']]['vat']))      $list[$assoc['rate']]['vat']=0;
 					if (! isset($list[$assoc['rate']]['localtax1']))      $list[$assoc['rate']]['localtax1']=0;
@@ -542,10 +543,30 @@
 			}
 			else
 			{
 				dol_print_error($db);
 				return -3;
 			}
 		}
 	}
 	return $list;
 }
+/**
+ *  Gets VAT to collect for the given year (and given quarter or month)
+ *  The function gets the VAT in split results, as the VAT declaration asks
+ *  to report the amounts for different VAT rates as different lines.
+ *  This function also accounts recurrent invoices.
+ *
+ *  @param	DoliDB	$db          	Database handler object
+ *  @param  int		$y           	Year
+ *  @param  int		$q           	Quarter
+ *  @param  string	$date_start  	Start date
+ *  @param  string	$date_end    	End date
+ *  @param  int		$modetax     	0 or 1 (option vat on debit)
+ *  @param  int		$direction   	'sell' (customer invoice) or 'buy' (supplier invoices)
+ *  @param  int		$m           	Month
+ *  @return array       			List of quarters with vat
+ */
+function vat_by_date ($db, $y, $q, $date_start, $date_end, $modetax, $direction, $m=0)
+{
+	return tax_by_date('vat', $db, $y, $q, $date_start, $date_end, $modetax, $direction, $m);
+}

--- a/htdocs/core/menus/standard/auguria_menu.php
+++ b/htdocs/core/menus/standard/auguria_menu.php
@@ -181,29 +181,22 @@
 						    while ($levelcursor >= 0)
 						    {
                                 if ($lastlevel2[$levelcursor] != 'enabled') $showmenu=false;
                                 $levelcursor--;
 						    }
 						}
 						if ($showmenu)		// Visible (option to hide when not allowed is off or allowed)
        					{
        						$substitarray = array('__LOGIN__' => $user->login, '__USER_ID__' => $user->id, '__USER_SUPERVISOR_ID__' => $user->fk_user);
        						$substitarray['__USERID__'] = $user->id;	// For backward compatibility
-       						$val2['url'] = make_substitutions($val2['url'], $substitarray);		// Make also substitution of __(XXX)__ and __[XXX]__
-       						if (! preg_match("/^(http:\/\/|https:\/\/)/i", $val2['url']))
-       						{
-       							$relurl2=dol_buildpath($val2['url'],1);
-       						}
-       						else
-       						{
-       							$relurl2=$val2['url'];
-       						}
+       						$val2['url'] = make_substitutions($val2['url'], $substitarray);
+	        				$relurl2=dol_buildpath($val2['url'],1);
 	        				$canonurl2=preg_replace('/\?.*$/','',$val2['url']);
 	        				if (in_array($canonurl2,array('/admin/index.php','/admin/tools/index.php','/core/tools.php'))) $relurl2='';
 	        				$disabled='';
 	        				if (! $val2['enabled'])
 	        				{
 	        				    $disabled=" vsmenudisabled";
 	        				}
 	        				print str_pad('',$val2['level']+1);
 	        				print '<li class="lilevel'.($val2['level']+1);
 	        				if ($val2['level']==0) print ' ui-btn-icon-right ui-btn';  // ui-btn to highlight on clic

--- a/htdocs/core/menus/standard/eldy.lib.php
+++ b/htdocs/core/menus/standard/eldy.lib.php
@@ -987,32 +987,32 @@
 				$newmenu->add("/product/stock/list.php", $langs->trans("List"), 1, $user->rights->stock->lire);
 				$newmenu->add("/product/stock/mouvement.php", $langs->trans("Movements"), 1, $user->rights->stock->mouvement->lire);
                 $newmenu->add("/product/stock/massstockmove.php", $langs->trans("MassStockTransferShort"), 1, $user->rights->stock->mouvement->creer);
                 if ($conf->supplier_order->enabled) $newmenu->add("/product/stock/replenish.php", $langs->trans("Replenishment"), 1, $user->rights->stock->mouvement->creer && $user->rights->fournisseur->lire);
 			}
 			if ($conf->global->MAIN_FEATURES_LEVEL >= 2)
 			{
     			if (! empty($conf->stock->enabled))
     			{
     				$langs->load("stocks");
-					if (empty($conf->global->MAIN_USE_ADVANCED_PERMS))
-					{
-						$newmenu->add("/product/inventory/list.php?leftmenu=stock", $langs->trans("Inventory"), 0, $user->rights->stock->lire, '', $mainmenu, 'stock');
-						$newmenu->add("/product/inventory/card.php?action=create", $langs->trans("NewInventory"), 1, $user->rights->stock->creer);
-						$newmenu->add("/product/inventory/list.php", $langs->trans("List"), 1, $user->rights->stock->lire);
-					}
-					else
-					{
-						$newmenu->add("/product/inventory/list.php?leftmenu=stock", $langs->trans("Inventory"), 0, $user->rights->stock->inventory_advance->read, '', $mainmenu, 'stock');
-						$newmenu->add("/product/inventory/card.php?action=create", $langs->trans("NewInventory"), 1, $user->rights->stock->inventory_advance->write);
-						$newmenu->add("/product/inventory/list.php", $langs->trans("List"), 1, $user->rights->stock->inventory_advance->read);
-					}
+				if (empty($conf->global->MAIN_USE_ADVANCED_PERMS))
+				{
+    					$newmenu->add("/product/inventory/list.php?leftmenu=stock", $langs->trans("Inventory"), 0, $user->rights->stock->lire, '', $mainmenu, 'stock');
+    					$newmenu->add("/product/inventory/card.php?action=create", $langs->trans("NewInventory"), 1, $user->rights->stock->creer);
+    					$newmenu->add("/product/inventory/list.php", $langs->trans("List"), 1, $user->rights->stock->lire);
+				}
+				else
+				{
+					$newmenu->add("/product/inventory/list.php?leftmenu=stock", $langs->trans("Inventory"), 0, $user->rights->stock->advance_inventory->read, '', $mainmenu, 'stock');
+    					$newmenu->add("/product/inventory/card.php?action=create", $langs->trans("NewInventory"), 1, $user->rights->stock->advance_inventory->write);
+    					$newmenu->add("/product/inventory/list.php", $langs->trans("List"), 1, $user->rights->stock->advance_inventory->read);
+				}
     			}
 			}
 			if (! empty($conf->expedition->enabled))
 			{
 				$langs->load("sendings");
 				$newmenu->add("/expedition/index.php?leftmenu=sendings", $langs->trans("Shipments"), 0, $user->rights->expedition->lire, '', $mainmenu, 'sendings');
 				$newmenu->add("/expedition/card.php?action=create2&amp;leftmenu=sendings", $langs->trans("NewSending"), 1, $user->rights->expedition->creer);
 				$newmenu->add("/expedition/list.php?leftmenu=sendings", $langs->trans("List"), 1, $user->rights->expedition->lire);
 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="sendings") $newmenu->add("/expedition/list.php?leftmenu=sendings&viewstatut=0", $langs->trans("StatusSendingDraftShort"), 2, $user->rights->expedition->lire);
 				if ($usemenuhider || empty($leftmenu) || $leftmenu=="sendings") $newmenu->add("/expedition/list.php?leftmenu=sendings&viewstatut=1", $langs->trans("StatusSendingValidatedShort"), 2, $user->rights->expedition->lire);
@@ -1116,25 +1116,22 @@
 					$search_project_user = GETPOST('search_project_user','int');
 					$newmenu->add("/projet/activity/perweek.php?leftmenu=tasks".($search_project_user?'&search_project_user='.$search_project_user:''), $langs->trans("NewTimeSpent"), 0, $user->rights->projet->lire);
 				}
 			}
 		}
 		/*
 		 * Menu TOOLS
 		 */
 		if ($mainmenu == 'tools')
 		{
-			if (empty($user->socid)) // limit to internal users
-			{
-				$langs->load("mails");
-				$newmenu->add("/admin/mails_templates.php?leftmenu=email_templates", $langs->trans("EMailTemplates"), 0, 1, '', $mainmenu, 'email_templates');
-			}
+			$langs->load("mails");
+			$newmenu->add("/admin/mails_templates.php?leftmenu=email_templates", $langs->trans("EMailTemplates"), 0, 1, '', $mainmenu, 'email_templates');
 			if (! empty($conf->mailing->enabled))
 			{
 				$newmenu->add("/comm/mailing/index.php?leftmenu=mailing", $langs->trans("EMailings"), 0, $user->rights->mailing->lire, '', $mainmenu, 'mailing');
 				$newmenu->add("/comm/mailing/card.php?leftmenu=mailing&amp;action=create", $langs->trans("NewMailing"), 1, $user->rights->mailing->creer);
 				$newmenu->add("/comm/mailing/list.php?leftmenu=mailing", $langs->trans("List"), 1, $user->rights->mailing->lire);
 			}
 			if (! empty($conf->export->enabled))
 			{
 				$langs->load("exports");
 				$newmenu->add("/exports/index.php?leftmenu=export",$langs->trans("FormatedExport"),0, $user->rights->export->lire, '', $mainmenu, 'export');

--- a/htdocs/core/menus/standard/eldy_menu.php
+++ b/htdocs/core/menus/standard/eldy_menu.php
@@ -188,29 +188,22 @@
 						    while ($levelcursor >= 0)
 						    {
                                 if ($lastlevel2[$levelcursor] != 'enabled') $showmenu=false;
                                 $levelcursor--;
 						    }
 						}
        					if ($showmenu)		// Visible (option to hide when not allowed is off or allowed)
        					{
        						$substitarray = array('__LOGIN__' => $user->login, '__USER_ID__' => $user->id, '__USER_SUPERVISOR_ID__' => $user->fk_user);
        						$substitarray['__USERID__'] = $user->id;	// For backward compatibility
-       						$val2['url'] = make_substitutions($val2['url'], $substitarray);		// Make also substitution of __(XXX)__ and __[XXX]__
-       						if (! preg_match("/^(http:\/\/|https:\/\/)/i", $val2['url']))
-       						{
-       							$relurl2=dol_buildpath($val2['url'],1);
-       						}
-       						else
-       						{
-       							$relurl2=$val2['url'];
-       						}
+       						$val2['url'] = make_substitutions($val2['url'], $substitarray);
+	        				$relurl2=dol_buildpath($val2['url'],1);
 	        				$canonurl2=preg_replace('/\?.*$/','',$val2['url']);
 	        				if (in_array($canonurl2,array('/admin/index.php','/admin/tools/index.php','/core/tools.php'))) $relurl2='';
 	        				$disabled='';
 	        				if (! $val2['enabled'])
 	        				{
 	        				    $disabled=" vsmenudisabled";
 	        				}
 	        				print str_pad('',$val2['level']+1);
 	        				print '<li class="lilevel'.($val2['level']+1);
 	        				if ($val2['level']==0) print ' ui-btn-icon-right ui-btn';  // ui-btn to highlight on clic

--- a/htdocs/core/modules/DolibarrModules.class.php
+++ b/htdocs/core/modules/DolibarrModules.class.php
@@ -1038,41 +1038,40 @@
 	 */
 	function insert_cronjobs()
 	{
 		require_once DOL_DOCUMENT_ROOT . '/core/class/infobox.class.php';
 		global $conf;
 		$err=0;
 		if (is_array($this->cronjobs))
 		{
 			foreach ($this->cronjobs as $key => $value)
 			{
-				$entity  = isset($this->cronjobs[$key]['entity'])?$this->cronjobs[$key]['entity']:$conf->entity;
 				$label  = isset($this->cronjobs[$key]['label'])?$this->cronjobs[$key]['label']:'';
 				$jobtype  = isset($this->cronjobs[$key]['jobtype'])?$this->cronjobs[$key]['jobtype']:'';
 				$class  = isset($this->cronjobs[$key]['class'])?$this->cronjobs[$key]['class']:'';
 				$objectname  = isset($this->cronjobs[$key]['objectname'])?$this->cronjobs[$key]['objectname']:'';
 				$method = isset($this->cronjobs[$key]['method'])?$this->cronjobs[$key]['method']:'';
 				$command  = isset($this->cronjobs[$key]['command'])?$this->cronjobs[$key]['command']:'';
 				$parameters  = isset($this->cronjobs[$key]['parameters'])?$this->cronjobs[$key]['parameters']:'';
 				$comment = isset($this->cronjobs[$key]['comment'])?$this->cronjobs[$key]['comment']:'';
 				$frequency = isset($this->cronjobs[$key]['frequency'])?$this->cronjobs[$key]['frequency']:'';
 				$unitfrequency = isset($this->cronjobs[$key]['unitfrequency'])?$this->cronjobs[$key]['unitfrequency']:'';
 				$status = isset($this->cronjobs[$key]['status'])?$this->cronjobs[$key]['status']:'';
 				$priority = isset($this->cronjobs[$key]['priority'])?$this->cronjobs[$key]['priority']:'';
 				$test = isset($this->cronjobs[$key]['test'])?$this->cronjobs[$key]['test']:'';                              // Line must be visible
 				$sql = "SELECT count(*) as nb FROM ".MAIN_DB_PREFIX."cronjob";
 				$sql.= " WHERE module_name = '".$this->db->escape($this->rights_class)."'";
 				if ($class) $sql.= " AND classesname = '".$this->db->escape($class)."'";
 				if ($objectname) $sql.= " AND objectname = '".$this->db->escape($objectname)."'";
 				if ($method) $sql.= " AND methodename = '".$this->db->escape($method)."'";
 				if ($command) $sql.= " AND command = '".$this->db->escape($command)."'";
-				$sql.= " AND entity = ".$entity;	// Must be exact entity
+				$sql.= " AND entity = ".$conf->entity;
 				$now=dol_now();
 				dol_syslog(get_class($this)."::insert_cronjobs", LOG_DEBUG);
 				$result=$this->db->query($sql);
 				if ($result)
 				{
 					$obj = $this->db->fetch_object($result);
 					if ($obj->nb == 0)
 					{
 						$this->db->begin();
 						if (! $err)
@@ -1092,21 +1091,21 @@
 							$sql.= ($class?"'".$this->db->escape($class)."'":"null").",";
 							$sql.= ($objectname?"'".$this->db->escape($objectname)."'":"null").",";
 							$sql.= ($method?"'".$this->db->escape($method)."'":"null").",";
 							$sql.= ($command?"'".$this->db->escape($command)."'":"null").",";
 							$sql.= ($parameters?"'".$this->db->escape($parameters)."'":"null").",";
 							$sql.= ($comment?"'".$this->db->escape($comment)."'":"null").",";
 							if(is_int($frequency)){ $sql.= "'".$this->db->escape($frequency)."', "; }
 							if(is_int($unitfrequency)){ $sql.= "'".$this->db->escape($unitfrequency)."', "; }
 							if(is_int($priority)) {$sql.= "'".$this->db->escape($priority)."', ";}
 							if(is_int($status)){ $sql.= "'".$this->db->escape($status)."', "; }
-							$sql.= $entity.",";
+							$sql.= $conf->entity.",";
 							$sql.= "'".$this->db->escape($test)."'";
 							$sql.= ")";
 							dol_syslog(get_class($this)."::insert_cronjobs", LOG_DEBUG);
 							$resql=$this->db->query($sql);
 							if (! $resql) $err++;
 						}
 						if (! $err)
 						{
 							$this->db->commit();
 						}

--- a/htdocs/core/modules/modCron.class.php
+++ b/htdocs/core/modules/modCron.class.php
@@ -58,22 +58,22 @@
 					'chaine',
 					'',
 					'CRON KEY',
 					0,
 					'main',
 					0
 				),);
         $this->tabs = array();
         $this->boxes = array();
 		$this->cronjobs = array(
-			0=>array('entity'=>0, 'label'=>'PurgeDeleteTemporaryFilesShort', 'jobtype'=>'method', 'class'=>'core/class/utils.class.php', 'objectname'=>'Utils', 'method'=>'purgeFiles', 'parameters'=>'', 'comment'=>'PurgeDeleteTemporaryFiles', 'frequency'=>2, 'unitfrequency'=>3600 * 24 * 7, 'priority'=>50, 'status'=>1, 'test'=>true),
-			1=>array('entity'=>0, 'label'=>'MakeLocalDatabaseDumpShort', 'jobtype'=>'method', 'class'=>'core/class/utils.class.php', 'objectname'=>'Utils', 'method'=>'dumpDatabase', 'parameters'=>'none,auto,1,auto,10', 'comment'=>'MakeLocalDatabaseDump', 'frequency'=>1, 'unitfrequency'=>3600 * 24 * 7, 'priority'=>90, 'status'=>0, 'test'=>in_array($db->type, array('mysql', 'mysqli'))),
+			0=>array('label'=>'PurgeDeleteTemporaryFilesShort', 'jobtype'=>'method', 'class'=>'core/class/utils.class.php', 'objectname'=>'Utils', 'method'=>'purgeFiles', 'parameters'=>'', 'comment'=>'PurgeDeleteTemporaryFiles', 'frequency'=>2, 'unitfrequency'=>3600 * 24 * 7, 'priority'=>50, 'status'=>1, 'test'=>true),
+			1=>array('label'=>'MakeLocalDatabaseDumpShort', 'jobtype'=>'method', 'class'=>'core/class/utils.class.php', 'objectname'=>'Utils', 'method'=>'dumpDatabase', 'parameters'=>'none,auto,1,auto,10', 'comment'=>'MakeLocalDatabaseDump', 'frequency'=>1, 'unitfrequency'=>3600 * 24 * 7, 'priority'=>90, 'status'=>0, 'test'=>in_array($db->type, array('mysql', 'mysqli'))),
 		);
 		$this->rights = array(); // Permission array used by this module
 		$this->rights_class = 'cron';
 		$r = 0;
 		$this->rights[$r][0] = 23001;
 		$this->rights[$r][1] = 'Read cron jobs';
 		$this->rights[$r][3] = 0;
 		$this->rights[$r][4] = 'read';
 		$r++;
 		$this->rights[$r][0] = 23002;

--- a/htdocs/core/modules/modResource.class.php
+++ b/htdocs/core/modules/modResource.class.php
@@ -107,21 +107,21 @@
 		$this->menu[$r++]=array(
 			'fk_menu'=>'fk_mainmenu=tools,fk_leftmenu=resource', //On utilise les ancres dfinis dans le menu parent dclar au dessus
 			'type'=> 'left', // Toujours un menu gauche
 			'titre'=> 'MenuResourceAdd',
 			'mainmenu'=> 'tools',
 			'leftmenu'=> 'resource_add',
 			'url'=> '/resource/card.php?action=create',
 			'langs'=> 'resource',
 			'position'=> 101,
 			'enabled'=> '1',
-			'perms'=> '$user->rights->resource->write',
+			'perms'=> '$user->rights->resource->read',
 			'target'=> '',
 			'user'=> 0
 		);
 		$this->menu[$r++]=array(
 			'fk_menu'=>'fk_mainmenu=tools,fk_leftmenu=resource', //On utilise les ancres dfinis dans le menu parent dclar au dessus
 			'type'=> 'left', // Toujours un menu gauche
 			'titre'=> 'List',
 			'mainmenu'=> 'tools',
 			'leftmenu'=> 'resource_list',
 			'url'=> '/resource/list.php',

--- a/htdocs/core/modules/modStock.class.php
+++ b/htdocs/core/modules/modStock.class.php
@@ -86,41 +86,41 @@
 		$this->rights[4][0] = 1005;
 		$this->rights[4][1] = 'Creer/modifier mouvements de stocks';
 		$this->rights[4][2] = 'w';
 		$this->rights[4][3] = 0;
 		$this->rights[4][4] = 'mouvement';
 		$this->rights[4][5] = 'creer';
 		if ($conf->global->MAIN_FEATURES_LEVEL >= 2) {
 		$this->rights[5][0] = 1011;
 		$this->rights[5][1] = 'inventoryReadPermission';	// Permission label
 		$this->rights[5][3] = 0; 					// Permission by default for new user (0/1)
-		$this->rights[5][4] = 'inventory_advance';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
+		$this->rights[5][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[5][5] = 'read';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[6][0] = 1012;
 		$this->rights[6][1] = 'inventoryCreatePermission';	// Permission label
 		$this->rights[6][3] = 0; 					// Permission by default for new user (0/1)
-		$this->rights[6][4] = 'inventory_advance';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
+		$this->rights[6][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[6][5] = 'create';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[7][0] = 1013;
 		$this->rights[7][1] = 'inventoryWritePermission';	// Permission label
 		$this->rights[7][3] = 0; 					// Permission by default for new user (0/1)
-		$this->rights[7][4] = 'inventory_advance';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
+		$this->rights[7][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[7][5] = 'write';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[8][0] = 1014;
 		$this->rights[8][1] = 'inventoryValidatePermission';	// Permission label
 		$this->rights[8][3] = 0; 					// Permission by default for new user (0/1)
-		$this->rights[8][4] = 'inventory_advance';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
+		$this->rights[8][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[8][5] = 'validate';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[9][0] = 1015;
 		$this->rights[9][1] = 'inventoryChangePMPPermission';	// Permission label
 		$this->rights[9][3] = 0; 					// Permission by default for new user (0/1)
-		$this->rights[9][4] = 'inventory_advance';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
+		$this->rights[9][4] = 'advance_inventory';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		$this->rights[9][5] = 'changePMP';			// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)
 		}
 		$this->menu = array();			// List of menus to add
 		$r=0;
 		$this->menu = 1;        // This module add menu entries. They are coded into menu manager.
 		$r=0;
 		$r++;
 		$this->export_code[$r]=$this->rights_class;
 		$this->export_label[$r]="WarehousesAndProducts";	// Translation key (used only if key ExportDataset_xxx_z not found)
 		$this->export_permission[$r]=array(array("stock","lire"));

--- a/htdocs/core/modules/supplier_invoice/pdf/pdf_canelle.modules.php
+++ b/htdocs/core/modules/supplier_invoice/pdf/pdf_canelle.modules.php
@@ -308,41 +308,39 @@
     					$vat_rate = pdf_getlinevatrate($object, $i, $outputlangs, $hidedetails);
                         $pdf->SetXY($this->posxtva, $curY);
 	       				$pdf->MultiCell($this->posxup-$this->posxtva-1, 3, $vat_rate, 0, 'R');
                     }
 					$up_excl_tax = pdf_getlineupexcltax($object, $i, $outputlangs, $hidedetails);
 					$pdf->SetXY($this->posxup, $curY);
 					$pdf->MultiCell($this->posxqty-$this->posxup-0.8, 3, $up_excl_tax, 0, 'R', 0);
 					$up_excl_tax = pdf_getlineupexcltax($object, $i, $outputlangs, $hidedetails);
 					$pdf->SetXY($this->posxup, $curY);
 					$pdf->MultiCell($this->posxqty-$this->posxup-0.8, 3, $up_excl_tax, 0, 'R', 0);
-					$qty = pdf_getlineqty($object, $i, $outputlangs, $hidedetails);
 					$pdf->SetXY($this->posxqty, $curY);
 					if($conf->global->PRODUCT_USE_UNITS)
 					{
-						$pdf->MultiCell($this->posxunit-$this->posxqty-0.8, 4, $qty, 0, 'R');
+						$pdf->MultiCell($this->posxunit-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
 					}
 					else
 					{
-						$pdf->MultiCell($this->posxdiscount-$this->posxqty-0.8, 4, $qty, 0, 'R');
+						$pdf->MultiCell($this->posxdiscount-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
 					}
 					if($conf->global->PRODUCT_USE_UNITS)
 					{
 						$unit = pdf_getlineunit($object, $i, $outputlangs, $hidedetails, $hookmanager);
 						$pdf->SetXY($this->posxunit, $curY);
 						$pdf->MultiCell($this->posxdiscount-$this->posxunit-0.8, 4, $unit, 0, 'L');
 					}
 					$pdf->SetXY($this->posxdiscount, $curY);
 					if ($object->lines[$i]->remise_percent)
 					{
-					    $remise_percent = pdf_getlineremisepercent($object, $i, $outputlangs, $hidedetails);
-						$pdf->MultiCell($this->postotalht-$this->posxdiscount-1, 3, $remise_percent."%", 0, 'R');
+						$pdf->MultiCell($this->postotalht-$this->posxdiscount-1, 3, $object->lines[$i]->remise_percent."%", 0, 'R');
 					}
                     $total_excl_tax = pdf_getlinetotalexcltax($object, $i, $outputlangs);
                     $pdf->SetXY($this->postotalht, $curY);
                     $pdf->MultiCell($this->page_largeur-$this->marge_droite-$this->postotalht, 3, $total_excl_tax, 0, 'R', 0);
 					if ($conf->multicurrency->enabled && $object->multicurrency_tx != 1) $tvaligne=$object->lines[$i]->multicurrency_total_tva;
 					else $tvaligne=$object->lines[$i]->total_tva;
 					$localtax1ligne=$object->lines[$i]->total_localtax1;
 					$localtax2ligne=$object->lines[$i]->total_localtax2;
 					if (! empty($object->remise_percent)) $tvaligne-=($tvaligne*$object->remise_percent)/100;
 					$vatrate=(string) $object->lines[$i]->tva_tx;
@@ -846,28 +844,21 @@
 			$posy+=4;
 			$pdf->SetXY($posx,$posy);
 			$pdf->SetTextColor(0,0,60);
 			$pdf->MultiCell(100, 3, $outputlangs->transnoentities("SupplierCode")." : " . $outputlangs->transnoentities($object->thirdparty->code_fournisseur), '', 'R');
 		}
 		$posy+=1;
 		$pdf->SetTextColor(0,0,60);
 		$posy = pdf_writeLinkedObjects($pdf, $object, $outputlangs, $posx, $posy, 100, 3, 'R', $default_font_size);
 		if ($showaddress)
 		{
-		    $carac_emetteur='';
-		    $arrayidcontact=$object->getIdContact('internal','SALESREPFOLL');
-		    if (count($arrayidcontact) > 0)
-		    {
-		        $object->fetch_user($arrayidcontact[0]);
-		        $carac_emetteur .= ($carac_emetteur ? "\n" : '' ).$outputlangs->convToOutputCharset($object->user->getFullName($outputlangs))."\n";
-		    }
-		    $carac_emetteur .= pdf_build_address($outputlangs, $this->emetteur, $object->thirdparty);
+			$carac_emetteur = pdf_build_address($outputlangs, $this->emetteur, $object->thirdparty);
 			$posy=42;
 			$posx=$this->marge_gauche;
 			if (! empty($conf->global->MAIN_INVERT_SENDER_RECIPIENT)) $posx=$this->page_largeur-$this->marge_droite-80;
 			$hautcadre=40;
 			$pdf->SetTextColor(0,0,0);
 			$pdf->SetFont('','', $default_font_size - 2);
 			$pdf->SetXY($posx,$posy-5);
 			$pdf->MultiCell(66,5, $outputlangs->transnoentities("BillFrom").":", 0, 'L');
 			$pdf->SetXY($posx,$posy);
 			$pdf->SetFillColor(230,230,230);

--- a/htdocs/core/modules/supplier_order/pdf/pdf_muscadet.modules.php
+++ b/htdocs/core/modules/supplier_order/pdf/pdf_muscadet.modules.php
@@ -375,41 +375,39 @@
 					$pdf->SetFont('','', $default_font_size - 1);   // On repositionne la police par defaut
 					if (empty($conf->global->MAIN_GENERATE_DOCUMENTS_WITHOUT_VAT))
 					{
 						$vat_rate = pdf_getlinevatrate($object, $i, $outputlangs, $hidedetails);
 						$pdf->SetXY($this->posxtva, $curY);
 						$pdf->MultiCell($this->posxup-$this->posxtva-1, 3, $vat_rate, 0, 'R');
 					}
 					$up_excl_tax = pdf_getlineupexcltax($object, $i, $outputlangs, $hidedetails);
 					$pdf->SetXY($this->posxup, $curY);
 					$pdf->MultiCell($this->posxqty-$this->posxup-0.8, 3, $up_excl_tax, 0, 'R', 0);
-					$qty = pdf_getlineqty($object, $i, $outputlangs, $hidedetails);
 					$pdf->SetXY($this->posxqty, $curY);
 					if($conf->global->PRODUCT_USE_UNITS)
 					{
-						$pdf->MultiCell($this->posxunit-$this->posxqty-0.8, 4, $qty, 0, 'R');
+						$pdf->MultiCell($this->posxunit-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
 					}
 					else
 					{
-						$pdf->MultiCell($this->posxdiscount-$this->posxqty-0.8, 4, $qty, 0, 'R');
+						$pdf->MultiCell($this->posxdiscount-$this->posxqty-0.8, 4, $object->lines[$i]->qty, 0, 'R');
 					}
 					if($conf->global->PRODUCT_USE_UNITS)
 					{
 						$unit = pdf_getlineunit($object, $i, $outputlangs, $hidedetails, $hookmanager);
 						$pdf->SetXY($this->posxunit, $curY);
 						$pdf->MultiCell($this->posxdiscount-$this->posxunit-0.8, 4, $unit, 0, 'L');
 					}
 					$pdf->SetXY($this->posxdiscount, $curY);
 					if ($object->lines[$i]->remise_percent)
 					{
-					    $remise_percent = pdf_getlineremisepercent($object, $i, $outputlangs, $hidedetails);
-						$pdf->MultiCell($this->postotalht-$this->posxdiscount-1, 3, $remise_percent."%", 0, 'R');
+						$pdf->MultiCell($this->postotalht-$this->posxdiscount-1, 3, $object->lines[$i]->remise_percent."%", 0, 'R');
 					}
                     $total_excl_tax = pdf_getlinetotalexcltax($object, $i, $outputlangs);
 					$pdf->SetXY($this->postotalht, $curY);
 					$pdf->MultiCell($this->page_largeur-$this->marge_droite-$this->postotalht, 3, $total_excl_tax, 0, 'R', 0);
 					if ($conf->multicurrency->enabled && $object->multicurrency_tx != 1) $tvaligne=$object->lines[$i]->multicurrency_total_tva;
 					else $tvaligne=$object->lines[$i]->total_tva;
 					$localtax1ligne=$object->lines[$i]->total_localtax1;
 					$localtax2ligne=$object->lines[$i]->total_localtax2;
 					$localtax1_rate=$object->lines[$i]->localtax1_tx;
 					$localtax2_rate=$object->lines[$i]->localtax2_tx;
@@ -947,28 +945,21 @@
                 $pdf->SetXY($posx,$posy);
     		    $pdf->SetTextColor(0,0,60);
     		    $pdf->MultiCell(100, 3, $langs->trans("BuyerName")." : ".$usertmp->getFullName($langs), '', 'R');
     		}
 		}
 		$posy+=1;
 		$pdf->SetTextColor(0,0,60);
 		$posy = pdf_writeLinkedObjects($pdf, $object, $outputlangs, $posx, $posy, 100, 3, 'R', $default_font_size);
 		if ($showaddress)
 		{
-		    $carac_emetteur='';
-		    $arrayidcontact=$object->getIdContact('internal','SALESREPFOLL');
-		    if (count($arrayidcontact) > 0)
-		    {
-		        $object->fetch_user($arrayidcontact[0]);
-		        $carac_emetteur .= ($carac_emetteur ? "\n" : '' ).$outputlangs->convToOutputCharset($object->user->getFullName($outputlangs))."\n";
-		    }
-			$carac_emetteur .= pdf_build_address($outputlangs, $this->emetteur, $object->thirdparty);
+			$carac_emetteur = pdf_build_address($outputlangs, $this->emetteur, $object->thirdparty);
 			$posy=42;
 			$posx=$this->marge_gauche;
 			if (! empty($conf->global->MAIN_INVERT_SENDER_RECIPIENT)) $posx=$this->page_largeur-$this->marge_droite-80;
 			$hautcadre=40;
 			$pdf->SetTextColor(0,0,0);
 			$pdf->SetFont('','', $default_font_size - 2);
 			$pdf->SetXY($posx,$posy-5);
 			$pdf->MultiCell(66,5, $outputlangs->transnoentities("BillFrom").":", 0, 'L');
 			$pdf->SetXY($posx,$posy);
 			$pdf->SetFillColor(230,230,230);

--- a/htdocs/core/tpl/admin_extrafields_view.tpl.php
+++ b/htdocs/core/tpl/admin_extrafields_view.tpl.php
@@ -47,21 +47,21 @@
 print '<td align="center">'.$langs->trans("Unique").'</td>';
 print '<td>'.$langs->trans("ComputedFormula").'</td>';
 print '<td align="center">'.$langs->trans("Required").'</td>';
 print '<td align="center">'.$langs->trans("AlwaysEditable").'</td>';
 print '<td align="center">'.$form->textwithpicto($langs->trans("Visible"), $langs->trans("VisibleDesc")).'</td>';
 if ($conf->multicompany->enabled)  {
 	print '<td align="center">'.$langs->trans("Entities").'</td>';
 }
 print '<td width="80">&nbsp;</td>';
 print "</tr>\n";
-if (is_array($extrafields->attribute_type) && count($extrafields->attribute_type))
+if (count($extrafields->attributes[$elementtype]['type']))
 {
 	foreach($extrafields->attributes[$elementtype]['type'] as $key => $value)
 	{
 		if (! empty($extrafields->attributes[$elementtype]['langfile'][$key])) {
 			$langs->load($extrafields->attributes[$elementtype]['langfile'][$key]);
 		}
 		print '<tr class="oddeven">';
 		print "<td>".$extrafields->attributes[$elementtype]['pos'][$key]."</td>\n";
 		print "<td>".$extrafields->attributes[$elementtype]['label'][$key]."</td>\n";	// We don't translate here, we want admin to know what is the key not translated value
 		print "<td>".$langs->trans($extrafields->attributes[$elementtype]['label'][$key])."</td>\n";

--- a/htdocs/core/triggers/interface_50_modBlockedlog_ActionsBlockedLog.class.php
+++ b/htdocs/core/triggers/interface_50_modBlockedlog_ActionsBlockedLog.class.php
@@ -86,21 +86,21 @@
 		}
 		elseif (strpos($action,'PAYMENT')!==false && ! in_array($action, array('PAYMENT_ADD_TO_BANK')))
 		{
 			$qualified++;
 			$amounts = (double) $object->amount;
 		}
 		if (! $qualified)
 		{
 			return 0; // not implemented action log
 		}
-		$result = $b->setObjectData($object, $action, $amounts, $user);		// Set field date_object, ref_object, fk_object, element, object_data
+		$result = $b->setObjectData($object, $action, $amounts);		// Set field date_object, ref_object, fk_object, element, object_data
 		if ($result < 0)
 		{
 			$this->error = $b->error;
 			$this->errors = $b->errors;
 			return -1;
 		}
 		$res = $b->create($user);
 		if ($res < 0)
 		{
 			$this->error = $b->error;

--- a/htdocs/cron/card.php
+++ b/htdocs/cron/card.php
@@ -508,35 +508,20 @@
 	print $object->params;
 	print "</td></tr>";
 	print '<tr class="blockcommand"><td>';
 	print $langs->trans('CronCommand')."</td><td>";
 	print $object->command;
 	print "</td></tr>";
 	print '<tr><td>';
 	print $langs->trans('CronNote')."</td><td>";
 	print $langs->trans($object->note);
 	print "</td></tr>";
-	if (! empty($conf->multicompany->enabled))
-	{
-		print '<tr><td>';
-		print $langs->trans('Entity')."</td><td>";
-		if (! $object->entity)
-		{
-			print $langs->trans("AllEntities");
-		}
-		else
-		{
-			$mc->getInfo($object->entity);
-			print $mc->label;
-		}
-		print "</td></tr>";
-	}
 	print '</table>';
     print '</div>';
 	print '<br>';
 	print '<div class="fichecenter">';
 	print '<div class="underbanner clearboth"></div>';
 	print '<table class="border" width="100%">';
 	print '<tr><td class="titlefield">';
 	print $langs->trans('CronEvery')."</td>";
 	print "<td>";
 	if($object->unitfrequency == "60") print $langs->trans('CronEach')." ".($object->frequency)." ".$langs->trans('Minutes');

--- a/htdocs/cron/class/cronjob.class.php
+++ b/htdocs/cron/class/cronjob.class.php
@@ -21,21 +21,20 @@
  */
 require_once(DOL_DOCUMENT_ROOT."/core/class/commonobject.class.php");
 /**
  *	Crob Job class
  */
 class Cronjob extends CommonObject
 {
 	public $element='cronjob';			//!< Id that identify managed objects
 	public $table_element='cronjob';		//!< Name of table without prefix where object is stored
     public $picto = 'cron';
-    public $entity;
     public $jobtype;
 	public $tms='';
 	public $datec='';
 	public $label;
 	public $command;
 	public $classesname;
 	public $objectname;
 	public $methodename;
 	public $params;
 	public $md5params;
@@ -128,21 +127,20 @@
 		}
 		if (($this->jobtype=='method') && (empty($this->objectname))) {
 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->trans('CronObject'));
 			$error++;
 		}
 		if (($this->jobtype=='function') && (empty($this->libname))) {
 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->trans('CronLib'));
 			$error++;
 		}
 		$sql = "INSERT INTO ".MAIN_DB_PREFIX."cronjob(";
-		$sql.= "entity,";
 		$sql.= "datec,";
 		$sql.= "jobtype,";
 		$sql.= "label,";
 		$sql.= "command,";
 		$sql.= "classesname,";
 		$sql.= "objectname,";
 		$sql.= "methodename,";
 		$sql.= "params,";
 		$sql.= "md5params,";
 		$sql.= "module_name,";
@@ -158,21 +156,20 @@
 		$sql.= "frequency,";
 		$sql.= "status,";
 		$sql.= "fk_user_author,";
 		$sql.= "fk_user_mod,";
 		$sql.= "note,";
 		$sql.= "nbrun,";
 		$sql.= "maxrun,";
 		$sql.= "libname,";
 		$sql.= "test";
 		$sql.= ") VALUES (";
-		$sql.= " ".(! isset($this->entity)?$conf->entity:$this->db->escape($this->entity)).",";
 		$sql.= " '".$this->db->idate($now)."',";
 		$sql.= " ".(! isset($this->jobtype)?'NULL':"'".$this->db->escape($this->jobtype)."'").",";
 		$sql.= " ".(! isset($this->label)?'NULL':"'".$this->db->escape($this->label)."'").",";
 		$sql.= " ".(! isset($this->command)?'NULL':"'".$this->db->escape($this->command)."'").",";
 		$sql.= " ".(! isset($this->classesname)?'NULL':"'".$this->db->escape($this->classesname)."'").",";
 		$sql.= " ".(! isset($this->objectname)?'NULL':"'".$this->db->escape($this->objectname)."'").",";
 		$sql.= " ".(! isset($this->methodename)?'NULL':"'".$this->db->escape($this->methodename)."'").",";
 		$sql.= " ".(! isset($this->params)?'NULL':"'".$this->db->escape($this->params)."'").",";
 		$sql.= " ".(! isset($this->md5params)?'NULL':"'".$this->db->escape($this->md5params)."'").",";
 		$sql.= " ".(! isset($this->module_name)?'NULL':"'".$this->db->escape($this->module_name)."'").",";
@@ -224,22 +221,21 @@
     }
     /**
      *  Load object in memory from the database
      *
      *  @param	int		$id    Id object
      *  @return int          	<0 if KO, >0 if OK
      */
     function fetch($id)
     {
         $sql = "SELECT";
-        $sql.= " t.rowid,";
-        $sql.= " t.entity,";
+		$sql.= " t.rowid,";
 		$sql.= " t.tms,";
 		$sql.= " t.datec,";
 		$sql.= " t.jobtype,";
 		$sql.= " t.label,";
 		$sql.= " t.command,";
 		$sql.= " t.classesname,";
 		$sql.= " t.objectname,";
 		$sql.= " t.methodename,";
 		$sql.= " t.params,";
 		$sql.= " t.md5params,";
@@ -267,21 +263,20 @@
         $sql.= " WHERE t.rowid = ".$id;
     	dol_syslog(get_class($this)."::fetch", LOG_DEBUG);
         $resql=$this->db->query($sql);
         if ($resql)
         {
             if ($this->db->num_rows($resql))
             {
                 $obj = $this->db->fetch_object($resql);
                 $this->id    = $obj->rowid;
                 $this->ref = $obj->rowid;
-				$this->entity = $obj->entity;
 				$this->tms = $this->db->jdate($obj->tms);
 				$this->datec = $this->db->jdate($obj->datec);
 				$this->label = $obj->label;
 				$this->jobtype = $obj->jobtype;
 				$this->command = $obj->command;
 				$this->classesname = $obj->classesname;
 				$this->objectname = $obj->objectname;
 				$this->methodename = $obj->methodename;
 				$this->params = $obj->params;
 				$this->md5params = $obj->md5params;
@@ -368,21 +363,21 @@
     	if ($processing >= 0) $sql.= " AND t.processing = ".(empty($processing)?'0':'1');
     	if ($status >= 0 && $status < 2) $sql.= " AND t.status = ".(empty($status)?'0':'1');
     	if ($status == 2) $sql.= " AND t.status = 2";
     	if (is_array($filter) && count($filter)>0) {
     		foreach($filter as $key => $value)
     		{
     		    if ($key == 't.rowid') $sql.= ' AND '.$key.' = '.$this->db->escape($value);
    				else $sql.= ' AND '.$key.' LIKE \'%'.$this->db->escape($value).'%\'';
     		}
     	}
-    	$sql.= $this->db->order($sortfield,$sortorder);
+    	$sql.= " ORDER BY $sortfield $sortorder ";
     	if (!empty($limit) && !empty($offset)) {
     		$sql.= $this->db->plimit($limit + 1,$offset);
     	}
     	$sqlwhere = array();
     	if (count($sqlwhere)>0) {
     		$sql.= " WHERE ".implode(' AND ',$sqlwhere);
     	}
     	dol_syslog(get_class($this)."::fetch_all", LOG_DEBUG);
     	$resql=$this->db->query($sql);
     	if ($resql)
@@ -503,21 +498,20 @@
 		}
 		if (($this->jobtype=='method') && (empty($this->objectname))) {
 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->transnoentitiesnoconv('CronObject'));
 			$error++;
 		}
 		if (($this->jobtype=='function') && (empty($this->libname))) {
 			$this->errors[]=$langs->trans('CronFieldMandatory',$langs->transnoentitiesnoconv('CronLib'));
 			$error++;
 		}
         $sql = "UPDATE ".MAIN_DB_PREFIX."cronjob SET";
-        $sql.= " entity=".(isset($this->entity)?$this->db->escape($this->entity):$conf->entity).",";
 		$sql.= " label=".(isset($this->label)?"'".$this->db->escape($this->label)."'":"null").",";
 		$sql.= " jobtype=".(isset($this->jobtype)?"'".$this->db->escape($this->jobtype)."'":"null").",";
 		$sql.= " command=".(isset($this->command)?"'".$this->db->escape($this->command)."'":"null").",";
 		$sql.= " classesname=".(isset($this->classesname)?"'".$this->db->escape($this->classesname)."'":"null").",";
 		$sql.= " objectname=".(isset($this->objectname)?"'".$this->db->escape($this->objectname)."'":"null").",";
 		$sql.= " methodename=".(isset($this->methodename)?"'".$this->db->escape($this->methodename)."'":"null").",";
 		$sql.= " params=".(isset($this->params)?"'".$this->db->escape($this->params)."'":"null").",";
 		$sql.= " md5params=".(isset($this->md5params)?"'".$this->db->escape($this->md5params)."'":"null").",";
 		$sql.= " module_name=".(isset($this->module_name)?"'".$this->db->escape($this->module_name)."'":"null").",";
 		$sql.= " priority=".(isset($this->priority)?$this->priority:"null").",";
@@ -637,21 +631,20 @@
 	/**
 	 *	Initialise object with example values
 	 *	Id must be 0 if object instance is a specimen
 	 *
 	 *	@return	void
 	 */
 	function initAsSpecimen()
 	{
 		$this->id=0;
 		$this->ref=0;
-		$this->entity=0;
 		$this->tms='';
 		$this->datec='';
 		$this->label='';
 		$this->jobtype='';
 		$this->command='';
 		$this->classesname='';
 		$this->objectname='';
 		$this->methodename='';
 		$this->params='';
 		$this->md5params='';
@@ -771,44 +764,35 @@
 		$now=dol_now();
 		$error = 0;
 		$retval = '';
 		$langs->load('cron');
 		if (empty($userlogin))
 		{
 			$this->error="User login is mandatory";
 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
 			return -1;
 		}
-		if ($conf->entity != $this->entity && $this->entity > 0)
-		{
-			dol_syslog("We try to run a job in entity ".$this->entity." when we are in entity ".$conf->entity, LOG_WARNING);
-		}
-		$savcurrententity = $conf->entity;
-		$conf->entity = $this->entity;
-		dol_syslog(get_class($this)."::run_jobs entity for running job is ".$conf->entity);
 		require_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';
 		$user=new User($this->db);
 		$result=$user->fetch('',$userlogin);
 		if ($result<0)
 		{
 			$this->error="User Error:".$user->error;
 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
-			$conf->entity = $savcurrententity;
 			return -1;
 		}
 		else
 		{
 			if (empty($user->id))
 			{
 				$this->error=" User user login:".$userlogin." do not exists";
 				dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
-				$conf->entity = $savcurrententity;
 				return -1;
 			}
 		}
 		dol_syslog(get_class($this)."::run_jobs jobtype=".$this->jobtype." userlogin=".$userlogin, LOG_DEBUG);
 		$ExecTimeLimit=600;
 		if (!empty($ExecTimeLimit))
 		{
 			$err=error_reporting();
 			error_reporting(0);     // Disable all errors
 			@set_time_limit($ExecTimeLimit);   // Need more than 240 on Windows 7/64
@@ -820,21 +804,20 @@
 		}
 		$this->datelastrun=$now;
 		$this->datelastresult=null;
 		$this->lastoutput='';
 		$this->lastresult='';
 		$this->processing = 1;                // To know job was started
 		$this->nbrun=$this->nbrun + 1;
 		$result = $this->update($user);       // This include begin/commit
 		if ($result<0) {
 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
-			$conf->entity = $savcurrententity;
 			return -1;
 		}
 		if ($this->jobtype=='method')
 		{
 			if (! $error)
 			{
 				$ret=dol_include_once($this->classesname);
 				if ($ret===false || (! class_exists($this->objectname)))
 				{
 					$this->error=$langs->trans('CronCannotLoadClass',$this->classesname,$this->objectname);
@@ -867,21 +850,20 @@
 					$this->lastoutput = $this->error;
 					$this->lastresult = -1;
 	                $retval = $this->lastresult;
 	                $error++;
 				}
 			}
 			if (! $error)
 			{
 				dol_syslog(get_class($this)."::run_jobs START ".$this->objectname."->".$this->methodename."(".$this->params.");", LOG_DEBUG);
 				$object = new $this->objectname($this->db);
-				if ($this->entity > 0) $object->entity = $this->entity;		// We work on a dedicated entity
 				$params_arr = array_map('trim', explode(",",$this->params));
 				if (!is_array($params_arr))
 				{
 					$result = call_user_func(array($object, $this->methodename), $this->params);
 				}
 				else
 				{
 					$result = call_user_func_array(array($object, $this->methodename), $params_arr);
 				}
 				if ($result === false || (! is_bool($result) && $result != 0))
@@ -904,28 +886,26 @@
 			}
 		}
 		if($this->jobtype == 'function')
 		{
 			$libpath = '/' . strtolower($this->module_name) . '/lib/' . $this->libname;
 			$ret = dol_include_once($libpath);
 			if ($ret === false)
 			{
 				$this->error = $langs->trans('CronCannotLoadLib') . ': ' . $libpath;
 				dol_syslog(get_class($this) . "::run_jobs " . $this->error, LOG_ERR);
-				$conf->entity = $savcurrententity;
 				return -1;
 			}
 			$result=$langs->load($this->module_name . '@' . $this->module_name);
 			if ($result<0)
 			{
 				dol_syslog(get_class($this) . "::run_jobs Cannot load module langs" . $langs->error, LOG_ERR);
-				$conf->entity = $savcurrententity;
 				return -1;
 			}
 			dol_syslog(get_class($this) . "::run_jobs " . $this->libname . "::" . $this->methodename."(" . $this->params . ");", LOG_DEBUG);
 			$params_arr = explode(", ", $this->params);
 			if (!is_array($params_arr))
 			{
 				$result = call_user_func($this->methodename, $this->params);
 			}
 			else
 			{
@@ -965,25 +945,26 @@
 				$this->lastresult = $arrayresult['result'];
 			}
 		}
 		dol_syslog(get_class($this)."::run_jobs now we update job to track it is finished (with success or error)");
 		$this->datelastresult=dol_now();
 		$this->processing=0;
 		$result = $this->update($user);       // This include begin/commit
 		if ($result < 0)
 		{
 			dol_syslog(get_class($this)."::run_jobs ".$this->error, LOG_ERR);
-			$conf->entity = $savcurrententity;
 			return -1;
 		}
-		$conf->entity = $savcurrententity;
-		return $error?-1:1;
+		else
+		{
+			return $error?-1:1;
+		}
 	}
 	/**
 	 * Reprogram a job
 	 *
 	 * @param  string		$userlogin      User login
 	 * @param  timestamp    $now            Date returned by dol_now()
 	 * @return int					        <0 if KO, >0 if OK
 	 */
 	function reprogram_jobs($userlogin, $now)
 	{

--- a/htdocs/cron/list.php
+++ b/htdocs/cron/list.php
@@ -141,21 +141,21 @@
 $sql.= " t.unitfrequency,";
 $sql.= " t.frequency,";
 $sql.= " t.status,";
 $sql.= " t.fk_user_author,";
 $sql.= " t.fk_user_mod,";
 $sql.= " t.note,";
 $sql.= " t.nbrun,";
 $sql.= " t.libname,";
 $sql.= " t.test";
 $sql.= " FROM ".MAIN_DB_PREFIX."cronjob as t";
-$sql.= " WHERE entity IN (0,".$conf->entity.")";
+$sql.= " WHERE 1 = 1";
 if ($status >= 0 && $status < 2) $sql.= " AND t.status = ".(empty($status)?'0':'1');
 if ($status == 2) $sql.= " AND t.status = 2";
 if (is_array($filter) && count($filter)>0) {
 	foreach($filter as $key => $value) {
 		$sql.= ' AND '.$key.' LIKE \'%'.$value.'%\'';
 	}
 }
 $sqlwhere = array();
 if (!empty($module_name)) {
 	$sqlwhere[]='(t.module_name='.$module_name.')';

--- a/htdocs/expensereport/card.php
+++ b/htdocs/expensereport/card.php
@@ -893,28 +893,23 @@
     	if (empty($date) || $date=="--")
     	{
     		$error++;
     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Date")), null, 'errors');
     	}
     	if ($value_unit==0)
     	{
     		$error++;
     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("PriceUTTC")), null, 'errors');
     	}
-    	if ($date < $object->date_debut || $date > ($object->date_fin + (24 * 3600 - 1)))
-    	{
-    		$langs->load("errors");
-    		setEventMessages($langs->trans("WarningDateOfLineMustBeInExpenseReportRange"), null, 'warnings');
-    	}
     	if (! $error)
     	{
-    		$type = 0;	// TODO What if service ? We should take the type product/service from the type of expense report llx_c_type_fees
+    		$type = 0;	// TODO What if service ?
 			$result = $object->addline($qty,$value_unit,$fk_c_type_fees,$vatrate,$date,$comments,$fk_projet,$fk_c_exp_tax_cat,$type);
 			if ($result > 0) {
 				$ret = $object->fetch($object->id); // Reload to get new records
 				if (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE)) {
 					$outputlangs = $langs;
 					$newlang = GETPOST('lang_id', 'alpha');
 					if (! empty($conf->global->MAIN_MULTILANGS) && empty($newlang))
 						$newlang = $object->thirdparty->default_lang;
 					if (! empty($newlang)) {
 						$outputlangs = new Translate("", $conf);
@@ -990,25 +985,20 @@
     	{
     		$error++;
     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Type")), null, 'errors');
     		$action='';
     	}
     	if ((int) $vatrate < 0 || $vatrate == '')
     	{
     		$error++;
     		setEventMessages($langs->trans("ErrorFieldRequired", $langs->transnoentitiesnoconv("Vat")), null, 'errors');
     		$action='';
-    	}
-		if ($date < $object->date_debut || $date > ($object->date_fin + (24 * 3600 - 1)))
-    	{
-    		$langs->load("errors");
-    		setEventMessages($langs->trans("WarningDateOfLineMustBeInExpenseReportRange"), null, 'warnings');
     	}
     	if (! $error)
     	{
     		$result = $object->updateline($rowid, $type_fees_id, $projet_id, $vatrate, $comments, $qty, $value_unit, $date, $id, $fk_c_exp_tax_cat);
     		if ($result >= 0)
     		{
     			if ($result > 0)
     			{
     				if (empty($conf->global->MAIN_DISABLE_PDF_AUTOUPDATE))
     				{
@@ -1019,20 +1009,22 @@
     					if (! empty($newlang)) {
     						$outputlangs = new Translate("", $conf);
     						$outputlangs->setDefaultLang($newlang);
     					}
     					$model=$object->modelpdf;
     					$ret = $object->fetch($id); // Reload to get new records
     					$object->generateDocument($model, $outputlangs, $hidedetails, $hidedesc, $hideref);
     				}
     			}
     			$result = $object->recalculer($id);
+    			header("Location: ".$_SERVER["PHP_SELF"]."?id=".$id);
+    			exit;
     		}
     		else
     		{
     			setEventMessages($object->error, $object->errors, 'errors');
     		}
     	}
     }
     include DOL_DOCUMENT_ROOT.'/core/actions_printing.inc.php';
     $trigger_name='EXPENSEREPORT_SENTBYMAIL';
     $autocopy='MAIN_MAIL_AUTOCOPY_EXPENSEREPORT_TO';
@@ -1673,21 +1665,21 @@
 						if ($action == 'editline' && $line->rowid == GETPOST('rowid', 'int'))
 						{
 								print '<tr class="oddeven">';
 								print '<td></td>';
 								print '<td class="center">';
 								$form->select_date($line->date,'date');
 								print '</td>';
 								if (! empty($conf->projet->enabled))
 								{
 									print '<td>';
-									$formproject->select_projects(-1, $line->fk_projet,'fk_projet', 0, 0, 1, 1, 0, 0, 0, '', 0, 0, 'maxwidth300');
+									$formproject->select_projects(-1, $line->fk_projet,'fk_projet', 0, 0, 1, 1);
 									print '</td>';
 								}
 								if (!empty($conf->global->MAIN_USE_EXPENSE_IK))
 								{
 									print '<td class="fk_c_exp_tax_cat">';
 									$params = array('fk_expense' => $object->id, 'fk_expense_det' => $line->rowid, 'date' => $line->dates);
 									print $form->selectExpenseCategories($line->fk_c_exp_tax_cat, 'fk_c_exp_tax_cat', 1, array(), 'fk_c_type_fees', $userauthor->default_c_exp_tax_cat, $params);
 									print '</td>';
 								}
 								print '<td class="center">';

--- a/htdocs/expensereport/class/expensereport.class.php
+++ b/htdocs/expensereport/class/expensereport.class.php
@@ -1022,21 +1022,21 @@
      * Set status to approved
      *
      * @param   User    $fuser      User
 	 * @param   int     $notrigger  Disable triggers
      * @return  int                 <0 if KO, 0 if nothing done, >0 if OK
      */
     function setApproved($fuser, $notrigger=0)
     {
         $now=dol_now();
 		$error = 0;
-        $this->date_approve = $now;
+        $this->date_approve = $this->db->idate($now);
         if ($this->fk_statut != 5)
         {
 			$this->db->begin();
             $sql = 'UPDATE '.MAIN_DB_PREFIX.$this->table_element;
             $sql.= " SET ref = '".$this->db->escape($this->ref)."', fk_statut = 5, fk_user_approve = ".$fuser->id.",";
             $sql.= " date_approve='".$this->db->idate($this->date_approve)."'";
             $sql.= ' WHERE rowid = '.$this->id;
             if ($this->db->query($sql))
             {
                 if (!$notrigger)
@@ -1401,26 +1401,20 @@
 		if (empty($vatrate) || $vatrate < 0) $vatrate = 0;
 		if (empty($date)) $date = '';
 		if (empty($fk_project)) $fk_project = 0;
 		$qty = price2num($qty);
 		$vatrate = price2num($vatrate);
 		$up = price2num($up);
 		if ($this->fk_statut == self::STATUS_DRAFT)
         {
 			$this->db->begin();
 			$this->line = new ExpenseReportLine($this->db);
-			if (preg_match('/\((.*)\)/', $vatrate, $reg))
-			{
-				$vat_src_code = $reg[1];
-				$vatrate = preg_replace('/\s*\(.*\)/', '', $vatrate);    // Remove code into vatrate.
-			}
-			$vatrate = preg_replace('/\*/','',$vatrate);
 			$seller = '';  // seller is unknown
 			$tmp = calcul_price_total($qty, $up, 0, $vatrate, 0, 0, 0, 'TTC', 0, $type, $seller);
 			$this->line->value_unit = $up;
 			$this->line->vatrate = price2num($vatrate);
 			$this->line->total_ttc = $tmp[2];
 			$this->line->total_ht = $tmp[0];
 			$this->line->total_tva = $tmp[1];
 			$this->line->fk_expensereport = $this->id;
 			$this->line->qty = $qty;
 			$this->line->date = $date;

--- a/htdocs/expensereport/list.php
+++ b/htdocs/expensereport/list.php
@@ -53,21 +53,21 @@
 $pagenext = $page + 1;
 if (!$sortorder) $sortorder="DESC";
 if (!$sortfield) $sortfield="d.date_debut";
 $id = GETPOST('id', 'int');
 $sall         = trim((GETPOST('search_all', 'alphanohtml')!='')?GETPOST('search_all', 'alphanohtml'):GETPOST('sall', 'alphanohtml'));
 $search_ref   = GETPOST('search_ref');
 $search_user  = GETPOST('search_user','int');
 $search_amount_ht = GETPOST('search_amount_ht','alpha');
 $search_amount_vat = GETPOST('search_amount_vat','alpha');
 $search_amount_ttc = GETPOST('search_amount_ttc','alpha');
-$search_status = (GETPOST('search_status','intcomma')!=''?GETPOST('search_status','intcomma'):GETPOST('statut','intcomma'));
+$search_status = (GETPOST('search_status','alpha')!=''?GETPOST('search_status','alpha'):GETPOST('statut','alpha'));
 $month_start  = GETPOST("month_start","int");
 $year_start   = GETPOST("year_start","int");
 $month_end    = GETPOST("month_end","int");
 $year_end     = GETPOST("year_end","int");
 $optioncss    = GETPOST('optioncss','alpha');
 if ($search_status == '') $search_status=-1;
 if ($search_user == '') $search_user=-1;
 $contextpage=GETPOST('contextpage','aZ')?GETPOST('contextpage','aZ'):'expensereportlist';
 $hookmanager->initHooks(array('expensereportlist'));
 $extrafields = new ExtraFields($db);
@@ -234,21 +234,25 @@
     else
     $sql.= " AND date_format(d.date_fin, '%m') = '".$month_end."'";
 }
 else if ($year_end > 0)
 {
 	$sql.= " AND d.date_fin BETWEEN '".$db->idate(dol_get_first_day($year_end,1,false))."' AND '".$db->idate(dol_get_last_day($year_end,12,false))."'";
 }
 if ($search_amount_ht != '') $sql.= natural_search('d.total_ht', $search_amount_ht, 1);
 if ($search_amount_ttc != '') $sql.= natural_search('d.total_ttc', $search_amount_ttc, 1);
 if ($search_user != '' && $search_user >= 0) $sql.= " AND u.rowid = '".$db->escape($search_user)."'";
-if ($search_status != '' && $search_status >= 0) $sql.=" AND d.fk_statut IN (".$db->escape($search_status).")";
+if ($search_status != '' && $search_status >= 0)
+{
+	if (strstr($search_status, ',')) $sql.=" AND d.fk_statut IN (".$db->escape($search_status).")";
+	else $sql.=" AND d.fk_statut = ".$search_status;
+}
 if (empty($user->rights->expensereport->readall) && empty($user->rights->expensereport->lire_tous)
     && (empty($conf->global->MAIN_USE_ADVANCED_PERMS) || empty($user->rights->expensereport->writeall_advance)))
 {
 	$childids = $user->getAllChildIds();
 	$childids[]=$user->id;
 	$sql.= " AND d.fk_user_author IN (".join(',',$childids).")\n";
 }
 include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_list_search_sql.tpl.php';
 $parameters=array();
 $reshook=$hookmanager->executeHooks('printFieldListWhere',$parameters);    // Note that $action and $object may have been modified by hook

--- a/htdocs/expensereport/note.php
+++ b/htdocs/expensereport/note.php
@@ -60,17 +60,18 @@
 	$object->fetch($id, $ref);
 	$object->info($object->id);
 	$head = expensereport_prepare_head($object);
 	dol_fiche_head($head, 'note', $langs->trans("ExpenseReport"), -1, 'trip');
 	$linkback = '<a href="'.DOL_URL_ROOT.'/expensereport/list.php?restore_lastsearch_values=1'.(! empty($socid)?'&socid='.$socid:'').'">'.$langs->trans("BackToList").'</a>';
 	$morehtmlref='<div class="refidno">';
     $morehtmlref.='</div>';
 	dol_banner_tab($object, 'ref', $linkback, 1, 'ref', 'ref', $morehtmlref);
     print '<div class="fichecenter">';
     print '<div class="underbanner clearboth"></div>';
+var_dump($value_public);
 	$cssclass="titlefield";
 	include DOL_DOCUMENT_ROOT.'/core/tpl/notes.tpl.php';
 	print '</div>';
 	dol_fiche_end();
 }
 llxFooter();
 $db->close();

--- a/htdocs/fichinter/class/api_interventions.class.php
+++ b/htdocs/fichinter/class/api_interventions.class.php
@@ -97,21 +97,21 @@
     function index($sortfield = "t.rowid", $sortorder = 'ASC', $limit = 100, $page = 0, $thirdparty_ids = '', $sqlfilters = '') {
         global $db, $conf;
         $obj_ret = array();
         $socids = DolibarrApiAccess::$user->societe_id ? DolibarrApiAccess::$user->societe_id : $thirdparty_ids;
         $search_sale = 0;
         if (! DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) $search_sale = DolibarrApiAccess::$user->id;
         $sql = "SELECT t.rowid";
         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) || $search_sale > 0) $sql .= ", sc.fk_soc, sc.fk_user"; // We need these fields in order to filter by sale (including the case where the user can only see his prospects)
         $sql.= " FROM ".MAIN_DB_PREFIX."fichinter as t";
         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) || $search_sale > 0) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc"; // We need this table joined to the select in order to filter by sale
-        $sql.= ' WHERE t.entity IN ('.getEntity('intervention').')';
+        $sql.= ' WHERE t.entity IN ('.getEntity('fichinter').')';
         if ((!DolibarrApiAccess::$user->rights->societe->client->voir && !$socids) || $search_sale > 0) $sql.= " AND t.fk_soc = sc.fk_soc";
         if ($socids) $sql.= " AND t.fk_soc IN (".$socids.")";
         if ($search_sale > 0) $sql.= " AND t.rowid = sc.fk_soc";		// Join for the needed table to filter by sale
         if ($search_sale > 0)
         {
             $sql .= " AND sc.fk_user = ".$search_sale;
         }
         if ($sqlfilters)
         {
             if (! DolibarrApi::_checkFilters($sqlfilters))

--- a/htdocs/fichinter/class/fichinter.class.php
+++ b/htdocs/fichinter/class/fichinter.class.php
@@ -107,21 +107,21 @@
 		$clause = "WHERE";
 		$sql = "SELECT count(fi.rowid) as nb";
 		$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as fi";
 		$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe as s ON fi.fk_soc = s.rowid";
 		if (!$user->rights->societe->client->voir && !$user->societe_id)
 		{
 			$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."societe_commerciaux as sc ON s.rowid = sc.fk_soc";
 			$sql.= " WHERE sc.fk_user = " .$user->id;
 			$clause = "AND";
 		}
-		$sql.= " ".$clause." fi.entity IN (".getEntity('intervention').")";
+		$sql.= " ".$clause." fi.entity IN (".getEntity($this->element).")";
 		$resql=$this->db->query($sql);
 		if ($resql)
 		{
 			while ($obj=$this->db->fetch_object($resql))
 			{
 				$this->nb["fichinters"]=$obj->nb;
 			}
 			$this->db->free($resql);
 			return 1;
 		}
@@ -296,24 +296,21 @@
 	 *	@return		int					<0 if KO, >0 if OK
 	 */
 	function fetch($rowid,$ref='')
 	{
 		$sql = "SELECT f.rowid, f.ref, f.description, f.fk_soc, f.fk_statut,";
 		$sql.= " f.datec, f.dateo, f.datee, f.datet, f.fk_user_author,";
 		$sql.= " f.date_valid as datev,";
 		$sql.= " f.tms as datem,";
 		$sql.= " f.duree, f.fk_projet, f.note_public, f.note_private, f.model_pdf, f.extraparams, fk_contrat";
 		$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
-		if ($ref) {
-			$sql.= " WHERE f.entity IN (".getEntity('intervention').")";
-			$sql.= " AND f.ref='".$this->db->escape($ref)."'";
-		}
+		if ($ref) $sql.= " WHERE f.ref='".$this->db->escape($ref)."'";
 		else $sql.= " WHERE f.rowid=".$rowid;
 		dol_syslog(get_class($this)."::fetch", LOG_DEBUG);
 		$resql=$this->db->query($sql);
 		if ($resql)
 		{
 			if ($this->db->num_rows($resql))
 			{
 				$obj = $this->db->fetch_object($resql);
 				$this->id           = $obj->rowid;
 				$this->ref          = $obj->ref;
@@ -659,20 +656,21 @@
 		global $conf;
 		$sql = "SELECT f.rowid,";
 		$sql.= " f.datec,";
 		$sql.= " f.tms as date_modification,";
 		$sql.= " f.date_valid as datev,";
 		$sql.= " f.fk_user_author,";
 		$sql.= " f.fk_user_modif as fk_user_modification,";
 		$sql.= " f.fk_user_valid";
 		$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
 		$sql.= " WHERE f.rowid = ".$id;
+		$sql.= " AND f.entity = ".$conf->entity;
 		$resql = $this->db->query($sql);
 		if ($resql)
 		{
 			if ($this->db->num_rows($resql))
 			{
 				$obj = $this->db->fetch_object($resql);
 				$this->id                = $obj->rowid;
 				$this->date_creation     = $this->db->jdate($obj->datec);
 				$this->date_modification = $this->db->jdate($obj->date_modification);
 				$this->date_validation   = $this->db->jdate($obj->datev);
@@ -740,20 +738,21 @@
 		}
 		if ((! $error) && (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED))) // For avoid conflicts if trigger used
 		{
 			$res = $this->deleteExtraFields();
 			if ($res < 0) $error++;
 		}
 		if (! $error)
 		{
 			$sql = "DELETE FROM ".MAIN_DB_PREFIX."fichinter";
 			$sql.= " WHERE rowid = ".$this->id;
+			$sql.= " AND entity = ".$conf->entity;
 			dol_syslog("Fichinter::delete", LOG_DEBUG);
 			$resql = $this->db->query($sql);
 			if (! $resql) $error++;
 		}
 		if (! $error)
 		{
 			$fichinterref = dol_sanitizeFileName($this->ref);
 			if ($conf->ficheinter->dir_output)
 			{
 				$dir = $conf->ficheinter->dir_output . "/" . $fichinterref ;
@@ -796,20 +795,21 @@
 	 *	@return     int							<0 if ko, >0 if ok
 	 */
 	function set_date_delivery($user, $date_delivery)
 	{
 		global $conf;
 		if ($user->rights->ficheinter->creer)
 		{
 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter ";
 			$sql.= " SET datei = '".$this->db->idate($date_delivery)."'";
 			$sql.= " WHERE rowid = ".$this->id;
+			$sql.= " AND entity = ".$conf->entity;
 			$sql.= " AND fk_statut = 0";
 			if ($this->db->query($sql))
 			{
 				$this->date_delivery = $date_delivery;
 				return 1;
 			}
 			else
 			{
 				$this->error=$this->db->error();
 				dol_syslog("Fichinter::set_date_delivery Erreur SQL");
@@ -826,20 +826,21 @@
 	 */
 	function set_description($user, $description)
 	{
 		global $conf;
 		if ($user->rights->ficheinter->creer)
 		{
 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter ";
 			$sql.= " SET description = '".$this->db->escape($description)."',";
 			$sql.= " fk_user_modif = ".$user->id;
 			$sql.= " WHERE rowid = ".$this->id;
+			$sql.= " AND entity = ".$conf->entity;
 			if ($this->db->query($sql))
 			{
 				$this->description = $description;
 				return 1;
 			}
 			else
 			{
 				$this->error=$this->db->error();
 				dol_syslog("Fichinter::set_description Erreur SQL");
 				return -1;
@@ -854,20 +855,21 @@
 	 *	@return     int						<0 if ko, >0 if ok
 	 */
 	function set_contrat($user, $contractid)
 	{
 		global $conf;
 		if ($user->rights->ficheinter->creer)
 		{
 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter ";
 			$sql.= " SET fk_contrat = '".$contractid."'";
 			$sql.= " WHERE rowid = ".$this->id;
+			$sql.= " AND entity = ".$conf->entity;
 			if ($this->db->query($sql))
 			{
 				$this->fk_contrat = $contractid;
 				return 1;
 			}
 			else
 			{
 				$this->error=$this->db->error();
 				return -1;
 			}
@@ -1161,21 +1163,21 @@
 		$sql.= " ".$this->duration.",";
 		$sql.= ' '.$rangToUse;
 		$sql.= ')';
 		dol_syslog("FichinterLigne::insert", LOG_DEBUG);
 		$resql=$this->db->query($sql);
 		if ($resql)
 		{
 			$this->rowid=$this->db->last_insert_id(MAIN_DB_PREFIX.'fichinterdet');
 			if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) // For avoid conflicts if trigger used
 			{
-				$this->id=$this->id;
+				$this->id=$this->rowid;
 				$result=$this->insertExtraFields();
 				if ($result < 0)
 				{
 					$error++;
 				}
 			}
 			$result=$this->update_total();
 			if ($result > 0)
 			{
 				$this->rang=$rangToUse;
@@ -1211,28 +1213,28 @@
 	 */
 	function update($user,$notrigger=0)
 	{
 		global $langs,$conf;
 		$this->db->begin();
 		$sql = "UPDATE ".MAIN_DB_PREFIX."fichinterdet SET";
 		$sql.= " description='".$this->db->escape($this->desc)."'";
 		$sql.= ",date='".$this->db->idate($this->datei)."'";
 		$sql.= ",duree=".$this->duration;
 		$sql.= ",rang='".$this->db->escape($this->rang)."'";
-		$sql.= " WHERE rowid = ".$this->id;
+		$sql.= " WHERE rowid = ".$this->rowid;
 		dol_syslog("FichinterLigne::update", LOG_DEBUG);
 		$resql=$this->db->query($sql);
 		if ($resql)
 		{
 			if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED)) // For avoid conflicts if trigger used
 			{
-				$this->id=$this->id;
+				$this->id=$this->rowid;
 				$result=$this->insertExtraFields();
 				if ($result < 0)
 				{
 					$error++;
 				}
 			}
 			$result=$this->update_total();
 			if ($result > 0)
 			{
 				if (! $notrigger)
@@ -1277,20 +1279,21 @@
 		if ($resql)
 		{
 			$obj=$this->db->fetch_object($resql);
 			$total_duration=0;
 			if (!empty($obj->total_duration)) $total_duration = $obj->total_duration;
 			$sql = "UPDATE ".MAIN_DB_PREFIX."fichinter";
 			$sql.= " SET duree = ".$total_duration;
 			$sql.= " , dateo = ".(! empty($obj->dateo)?"'".$this->db->idate($obj->dateo)."'":"null");
 			$sql.= " , datee = ".(! empty($obj->datee)?"'".$this->db->idate($obj->datee)."'":"null");
 			$sql.= " WHERE rowid = ".$this->fk_fichinter;
+			$sql.= " AND entity = ".$conf->entity;
 			dol_syslog("FichinterLigne::update_total", LOG_DEBUG);
 			$resql=$this->db->query($sql);
 			if ($resql)
 			{
 				$this->db->commit();
 				return 1;
 			}
 			else
 			{
 				$this->error=$this->db->error();
@@ -1311,23 +1314,23 @@
 	 *	@param		User	$user 		Objet user that make creation
 	 *	@param		int		$notrigger	Disable all triggers
 	 *	@return     int		>0 if ok, <0 if ko
 	 */
 	function deleteline($user,$notrigger=0)
 	{
 		global $langs,$conf;
 		$error=0;
 		if ($this->statut == 0)
 		{
-			dol_syslog(get_class($this)."::deleteline lineid=".$this->id);
+			dol_syslog(get_class($this)."::deleteline lineid=".$this->rowid);
 			$this->db->begin();
-			$sql = "DELETE FROM ".MAIN_DB_PREFIX."fichinterdet WHERE rowid = ".$this->id;
+			$sql = "DELETE FROM ".MAIN_DB_PREFIX."fichinterdet WHERE rowid = ".$this->rowid;
 			$resql = $this->db->query($sql);
 			if ($resql)
 			{
 				$result = $this->update_total();
 				if ($result > 0)
 				{
 					if (! $notrigger)
 					{
 						$result=$this->call_trigger('LINEFICHINTER_DELETE',$user);
 						if ($result < 0) { $error++; $this->db->rollback(); return -1; }

--- a/htdocs/fichinter/index.php
+++ b/htdocs/fichinter/index.php
@@ -55,22 +55,22 @@
     print $langs->trans("Intervention").':</td><td><input type="text" class="flat" name="sall" size="18"></td><td><input type="submit" value="'.$langs->trans("Search").'" class="button"></td></tr>';
     print "</form></table><br>\n";
 }
 /*
  * Statistics
  */
 $sql = "SELECT count(f.rowid), f.fk_statut";
 $sql.= " FROM ".MAIN_DB_PREFIX."societe as s";
 $sql.= ", ".MAIN_DB_PREFIX."fichinter as f";
 if (! $user->rights->societe->client->voir && ! $socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
-$sql.= " WHERE f.entity IN (".getEntity('intervention').")";
-$sql.= " AND f.fk_soc = s.rowid";
+$sql.= " WHERE f.fk_soc = s.rowid";
+$sql.= " AND f.entity IN (".getEntity('societe').")";
 if ($user->societe_id) $sql.=' AND f.fk_soc = '.$user->societe_id;
 if (! $user->rights->societe->client->voir && ! $socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
 $sql.= " GROUP BY f.fk_statut";
 $resql = $db->query($sql);
 if ($resql)
 {
     $num = $db->num_rows($resql);
     $i = 0;
     $total=0;
     $totalinprocess=0;
@@ -144,22 +144,22 @@
 }
 /*
  * Draft orders
  */
 if (! empty($conf->ficheinter->enabled))
 {
 	$sql = "SELECT f.rowid, f.ref, s.nom as name, s.rowid as socid";
 	$sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
 	$sql.= ", ".MAIN_DB_PREFIX."societe as s";
 	if (!$user->rights->societe->client->voir && !$socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
-	$sql.= " WHERE f.entity IN (".getEntity('intervention').")";
-	$sql.= " AND f.fk_soc = s.rowid";
+	$sql.= " WHERE f.fk_soc = s.rowid";
+	$sql.= " AND f.entity IN (".getEntity('intervention').")";
 	$sql.= " AND f.fk_statut = 0";
 	if ($socid) $sql.= " AND f.fk_soc = ".$socid;
 	if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
 	$resql=$db->query($sql);
 	if ($resql)
 	{
 		print '<table class="noborder" width="100%">';
 		print '<tr class="liste_titre">';
 		print '<th colspan="2">'.$langs->trans("DraftFichinter").'</th></tr>';
 		$langs->load("fichinter");
@@ -184,22 +184,22 @@
 print '</div><div class="fichetwothirdright"><div class="ficheaddleft">';
 $max=5;
 /*
  * Last modified interventions
  */
 $sql = "SELECT f.rowid, f.ref, f.fk_statut, f.date_valid as datec, f.tms as datem,";
 $sql.= " s.nom as name, s.rowid as socid";
 $sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f,";
 $sql.= " ".MAIN_DB_PREFIX."societe as s";
 if (!$user->rights->societe->client->voir && !$socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
-$sql.= " WHERE f.entity IN (".getEntity('intervention').")";
-$sql.= " AND f.fk_soc = s.rowid";
+$sql.= " WHERE f.fk_soc = s.rowid";
+$sql.= " AND f.entity IN (".getEntity('commande').")";
 if ($socid) $sql .= " AND f.fk_soc = ".$socid;
 if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
 $sql.= " ORDER BY f.tms DESC";
 $sql.= $db->plimit($max, 0);
 $resql=$db->query($sql);
 if ($resql)
 {
 	print '<table class="noborder" width="100%">';
 	print '<tr class="liste_titre">';
 	print '<th colspan="4">'.$langs->trans("LastModifiedInterventions",$max).'</th></tr>';
@@ -241,22 +241,22 @@
 else dol_print_error($db);
 /*
  * interventions to process
  */
 if (! empty($conf->ficheinter->enabled))
 {
 	$sql = "SELECT f.rowid, f.ref, f.fk_statut, s.nom as name, s.rowid as socid";
 	$sql.=" FROM ".MAIN_DB_PREFIX."fichinter as f";
 	$sql.= ", ".MAIN_DB_PREFIX."societe as s";
 	if (!$user->rights->societe->client->voir && !$socid) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
-	$sql.= " WHERE f.entity IN (".getEntity('intervention').")";
-	$sql.= " AND f.fk_soc = s.rowid";
+	$sql.= " WHERE f.fk_soc = s.rowid";
+	$sql.= " AND f.entity IN (".getEntity('intervention').")";
 	$sql.= " AND f.fk_statut = 1";
 	if ($socid) $sql.= " AND f.fk_soc = ".$socid;
 	if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
 	$sql.= " ORDER BY f.rowid DESC";
 	$resql=$db->query($sql);
 	if ($resql)
 	{
 		$num = $db->num_rows($resql);
 		print '<table class="noborder" width="100%">';
 		print '<tr class="liste_titre">';

--- a/htdocs/fichinter/list.php
+++ b/htdocs/fichinter/list.php
@@ -146,22 +146,22 @@
 $sql.= " s.nom as name, s.rowid as socid, s.client";
 foreach ($extrafields->attribute_label as $key => $val) $sql.=($extrafields->attribute_type[$key] != 'separate' ? ",ef.".$key.' as options_'.$key : '');
 $parameters=array();
 $reshook=$hookmanager->executeHooks('printFieldListSelect',$parameters);    // Note that $action and $object may have been modified by hook
 $sql.=$hookmanager->resPrint;
 $sql.= " FROM ".MAIN_DB_PREFIX."fichinter as f";
 if (is_array($extrafields->attribute_label) && count($extrafields->attribute_label)) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."fichinter_extrafields as ef on (f.rowid = ef.fk_object)";
 if (empty($conf->global->FICHINTER_DISABLE_DETAILS)) $sql.= " LEFT JOIN ".MAIN_DB_PREFIX."fichinterdet as fd ON fd.fk_fichinter = f.rowid";
 if (! $user->rights->societe->client->voir && empty($socid)) $sql.= ", ".MAIN_DB_PREFIX."societe_commerciaux as sc";
 $sql.= ", ".MAIN_DB_PREFIX."societe as s";
-$sql.= " WHERE f.entity IN (".getEntity('intervention').")";
-$sql.= " AND f.fk_soc = s.rowid";
+$sql.= " WHERE f.fk_soc = s.rowid ";
+$sql.= " AND f.entity = ".$conf->entity;
 if ($search_ref) {
 	$sql .= natural_search('f.ref', $search_ref);
 }
 if ($search_company) {
 	$sql .= natural_search('s.nom', $search_company);
 }
 if ($search_desc) {
 	if (empty($conf->global->FICHINTER_DISABLE_DETAILS)) $sql .= natural_search(array('f.description', 'fd.description'), $search_desc);
 	else $sql .= natural_search(array('f.description'), $search_desc);
 }

--- a/htdocs/filefunc.inc.php
+++ b/htdocs/filefunc.inc.php
@@ -22,21 +22,21 @@
  *
  * You should have received a copy of the GNU General Public License
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  */
 /**
  *	\file       htdocs/filefunc.inc.php
  * 	\ingroup	core
  *  \brief      File that include conf.php file and commons lib like functions.lib.php
  */
 if (! defined('DOL_APPLICATION_TITLE')) define('DOL_APPLICATION_TITLE','Dolibarr');
-if (! defined('DOL_VERSION')) define('DOL_VERSION','7.0.2');		// a.b.c-alpha, a.b.c-beta, a.b.c-rcX or a.b.c
+if (! defined('DOL_VERSION')) define('DOL_VERSION','7.0.1');		// a.b.c-alpha, a.b.c-beta, a.b.c-rcX or a.b.c
 if (! defined('EURO')) define('EURO',chr(128));
 if (! defined('LOG_DEBUG'))
 {
 	if (! function_exists("syslog")) {
 		define('LOG_EMERG',0);
 		define('LOG_ALERT',1);
 		define('LOG_CRIT',2);
 		define('LOG_ERR',3);
 		define('LOG_WARNING',4);
 		define('LOG_NOTICE',5);
@@ -97,36 +97,26 @@
 if (empty($dolibarr_main_db_character_set)) $dolibarr_main_db_character_set=($dolibarr_main_db_type=='mysqli'?'utf8':'');		// Old installation
 if (empty($dolibarr_main_db_collation)) $dolibarr_main_db_collation=($dolibarr_main_db_type=='mysqli'?'utf8_unicode_ci':'');	// Old installation
 if (empty($dolibarr_main_db_encryption)) $dolibarr_main_db_encryption=0;
 if (empty($dolibarr_main_db_cryptkey)) $dolibarr_main_db_cryptkey='';
 if (empty($dolibarr_main_limit_users)) $dolibarr_main_limit_users=0;
 if (empty($dolibarr_mailing_limit_sendbyweb)) $dolibarr_mailing_limit_sendbyweb=0;
 if (empty($dolibarr_mailing_limit_sendbycli)) $dolibarr_mailing_limit_sendbycli=0;
 if (empty($dolibarr_strict_mode)) $dolibarr_strict_mode=0; // For debug in php strict mode
 if (! defined('NOCSRFCHECK') && empty($dolibarr_nocsrfcheck))
 {
-	if (! empty($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] != 'GET' && ! empty($_SERVER['HTTP_HOST']))
-    {
-    	$csrfattack=false;
-    	if (empty($_SERVER['HTTP_REFERER'])) $csrfattack=true;	// An evil browser was used
-    	else
-    	{
-    		$tmpa=parse_url($_SERVER['HTTP_HOST']);
-    		$tmpb=parse_url($_SERVER['HTTP_REFERER']);
-    		if ((empty($tmpa['host'])?$tmpa['path']:$tmpa['host']) != (empty($tmpb['host'])?$tmpb['path']:$tmpb['host'])) $csrfattack=true;
-    	}
-    	if ($csrfattack)
-    	{
-    		print "Access refused by CSRF protection in main.inc.php. Referer of form is outside server that serve the POST.\n";
-        	print "If you access your server behind a proxy using url rewriting, you might check that all HTTP header is propagated (or add the line \$dolibarr_nocsrfcheck=1 into your conf.php file).\n";
-    		die;
-    	}
+    if (! empty($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] != 'GET' && ! empty($_SERVER['HTTP_HOST'])
+    && (empty($_SERVER['HTTP_REFERER']) || ! preg_match('/'.preg_quote($_SERVER['HTTP_HOST'],'/').'/i', $_SERVER['HTTP_REFERER'])))
+    {
+    	print "Access refused by CSRF protection in main.inc.php. Referer of form is outside server that serve the POST.\n";
+        print "If you access your server behind a proxy using url rewriting, you might check that all HTTP header is propagated (or add the line \$dolibarr_nocsrfcheck=1 into your conf.php file).\n";
+    	die;
     }
 }
 if (empty($dolibarr_main_db_host))
 {
 	print '<div align="center">Dolibarr setup is not yet complete.<br><br>'."\n";
 	print '<a href="install/index.php">Click here to finish Dolibarr install process</a> ...</div>'."\n";
 	die;
 }
 if (empty($dolibarr_main_url_root))
 {

--- a/htdocs/fourn/card.php
+++ b/htdocs/fourn/card.php
@@ -37,21 +37,21 @@
 $langs->load('companies');
 $langs->load('suppliers');
 $langs->load('products');
 $langs->load('bills');
 $langs->load('orders');
 $langs->load('commercial');
 $action	= GETPOST('action','aZ09');
 $cancelbutton = GETPOST('cancel','alpha');
 $id = (GETPOST('socid','int') ? GETPOST('socid','int') : GETPOST('id','int'));
 if ($user->societe_id) $id=$user->societe_id;
-$result = restrictedArea($user, 'societe&fournisseur', $id, '&societe', '', 'rowid');
+$result = restrictedArea($user, 'societe&fournisseur', $id, '&societe');
 $object = new Fournisseur($db);
 $extrafields = new ExtraFields($db);
 $extralabels=$extrafields->fetch_name_optionals_label($object->table_element);
 $hookmanager->initHooks(array('suppliercard','globalcard'));
 /*
  * Action
  */
 $parameters=array('id'=>$id);
 $reshook=$hookmanager->executeHooks('doActions', $parameters, $object, $action);    // Note that $action and $object may have been modified by some hooks
 if ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');

--- a/htdocs/fourn/class/fournisseur.commande.class.php
+++ b/htdocs/fourn/class/fournisseur.commande.class.php
@@ -1320,21 +1320,21 @@
             $this->line->qty=$qty;
             $this->line->tva_tx=$txtva;
             $this->line->localtax1_tx=($total_localtax1?$localtaxes_type[1]:0);
             $this->line->localtax2_tx=($total_localtax2?$localtaxes_type[3]:0);
             $this->line->localtax1_type = $localtaxes_type[0];
             $this->line->localtax2_type = $localtaxes_type[2];
             $this->line->fk_product=$fk_product;
             $this->line->product_type=$product_type;
             $this->line->remise_percent=$remise_percent;
             $this->line->subprice=$pu_ht;
-            $this->line->rang=$rang;
+            $this->line->rang=$this->rang;
             $this->line->info_bits=$info_bits;
             $this->line->vat_src_code=$vat_src_code;
             $this->line->total_ht=$total_ht;
             $this->line->total_tva=$total_tva;
             $this->line->total_localtax1=$total_localtax1;
             $this->line->total_localtax2=$total_localtax2;
             $this->line->total_ttc=$total_ttc;
             $this->line->product_type=$type;
             $this->line->special_code=$this->special_code;
             $this->line->origin=$origin;
@@ -1647,45 +1647,37 @@
 	 * Return array of dispathed lines waiting to be approved for this order
 	 *
 	 * @param	int		$status		Filter on stats (-1 = no filter, 0 = lines draft to be approved, 1 = approved lines)
 	 * @return	array				Array of lines
      */
     public function getDispachedLines($status=-1)
     {
     	$ret = array();
 		$sql = "SELECT p.ref, p.label,";
 		$sql.= " e.rowid as warehouse_id, e.ref as entrepot,";
-		$sql.= " cfd.rowid as dispatchedlineid, cfd.fk_product, cfd.qty, cfd.eatby, cfd.sellby, cfd.batch, cfd.comment, cfd.status";
+		$sql.= " cfd.rowid as dispatchlineid, cfd.fk_product, cfd.qty, cfd.eatby, cfd.sellby, cfd.batch, cfd.comment, cfd.status";
 		$sql.= " FROM ".MAIN_DB_PREFIX."product as p,";
 		$sql.= " ".MAIN_DB_PREFIX."commande_fournisseur_dispatch as cfd";
 		$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."entrepot as e ON cfd.fk_entrepot = e.rowid";
 		$sql.= " WHERE cfd.fk_commande = ".$this->id;
 		$sql.= " AND cfd.fk_product = p.rowid";
 		if ($status >= 0) $sql.=" AND cfd.status = ".$status;
 		$sql.= " ORDER BY cfd.rowid ASC";
 		$resql = $this->db->query($sql);
 		if ($resql)
 		{
 			$num = $this->db->num_rows($resql);
 			$i = 0;
 			while ($i < $num)
 			{
 				$objp = $this->db->fetch_object($resql);
-				if ($objp)
-				{
-					$ret[] = array(
-						'id' => $objp->dispatchedlineid,
-						'productid' => $objp->fk_product,
-						'warehouseid' => $objp->warehouse_id,
-						'qty' => $objp->qty,
-					);
-				}
+				if ($objp) $ret[]=array('id'=>$objp->dispatchedlineid, 'productid'=>$objp->fk_product, 'warehouseid'=>$objp->warehouse_id);
 				$i++;
 			}
 		}
 		else dol_print_error($this->db, 'Failed to execute request to get dispatched lines');
 		return $ret;
     }
     /**
      * 	Set a delivery in database for this supplier order
      *
      *	@param	User	$user		User that input data
@@ -2528,21 +2520,20 @@
     public $oldline;
     /**
      * Id of parent order
      * @var int
      */
     public $fk_commande;
     public $fk_parent_line;
     public $fk_facture;
     public $label;
     public $rang = 0;
-    public $special_code = 0;
 	/**
 	 * Unit price without taxes
 	 * @var float
 	 */
 	public $pu_ht;
     public $date_start;
     public $date_end;
 	/**
 	 * Supplier reference of price when we added the line. May have been changed after line was added.
 	 * @var string
@@ -2560,21 +2551,21 @@
         $this->db= $db;
     }
     /**
      *  Load line order
      *
      *  @param  int		$rowid      Id line order
      *	@return	int					<0 if KO, >0 if OK
      */
     public function fetch($rowid)
     {
-        $sql = 'SELECT cd.rowid, cd.fk_commande, cd.fk_product, cd.product_type, cd.description, cd.qty, cd.tva_tx, cd.special_code,';
+        $sql = 'SELECT cd.rowid, cd.fk_commande, cd.fk_product, cd.product_type, cd.description, cd.qty, cd.tva_tx,';
         $sql.= ' cd.localtax1_tx, cd.localtax2_tx, cd.localtax1_type, cd.localtax2_type, cd.ref,';
         $sql.= ' cd.remise, cd.remise_percent, cd.subprice,';
         $sql.= ' cd.info_bits, cd.total_ht, cd.total_tva, cd.total_ttc,';
         $sql.= ' cd.total_localtax1, cd.total_localtax2,';
         $sql.= ' p.ref as product_ref, p.label as product_libelle, p.description as product_desc,';
         $sql.= ' cd.date_start, cd.date_end, cd.fk_unit,';
 		$sql.= ' cd.multicurrency_subprice, cd.multicurrency_total_ht, cd.multicurrency_total_tva, cd.multicurrency_total_ttc';
         $sql.= ' FROM '.MAIN_DB_PREFIX.'commande_fournisseurdet as cd';
         $sql.= ' LEFT JOIN '.MAIN_DB_PREFIX.'product as p ON cd.fk_product = p.rowid';
         $sql.= ' WHERE cd.rowid = '.$rowid;
@@ -2598,21 +2589,20 @@
             $this->remise           = $objp->remise;
             $this->remise_percent   = $objp->remise_percent;
             $this->fk_product       = $objp->fk_product;
             $this->info_bits        = $objp->info_bits;
             $this->total_ht         = $objp->total_ht;
             $this->total_tva        = $objp->total_tva;
             $this->total_localtax1	= $objp->total_localtax1;
             $this->total_localtax2	= $objp->total_localtax2;
             $this->total_ttc        = $objp->total_ttc;
             $this->product_type     = $objp->product_type;
-            $this->special_code     = $objp->special_code;
             $this->ref	            = $objp->product_ref;
             $this->product_ref      = $objp->product_ref;
             $this->product_libelle  = $objp->product_libelle;
             $this->product_desc     = $objp->product_desc;
             $this->date_start       		= $this->db->jdate($objp->date_start);
             $this->date_end         		= $this->db->jdate($objp->date_end);
 	        $this->fk_unit          		= $objp->fk_unit;
 			$this->multicurrency_subprice	= $objp->multicurrency_subprice;
 			$this->multicurrency_total_ht	= $objp->multicurrency_total_ht;
 			$this->multicurrency_total_tva	= $objp->multicurrency_total_tva;
@@ -2684,33 +2674,31 @@
         if (empty($this->fk_multicurrency))
         {
             $this->multicurrency_code = $conf->currency;
             $this->fk_multicurrency = 0;
             $this->multicurrency_tx = 1;
         }
         if ($this->product_type < 0) return -1;
         $this->db->begin();
         $sql = 'INSERT INTO '.MAIN_DB_PREFIX.$this->table_element;
         $sql.= " (fk_commande, label, description, date_start, date_end,";
-        $sql.= " fk_product, product_type, special_code, rang,";
+        $sql.= " fk_product, product_type,";
         $sql.= " qty, vat_src_code, tva_tx, localtax1_tx, localtax2_tx, localtax1_type, localtax2_type, remise_percent, subprice, ref,";
         $sql.= " total_ht, total_tva, total_localtax1, total_localtax2, total_ttc, fk_unit,";
         $sql.= " fk_multicurrency, multicurrency_code, multicurrency_subprice, multicurrency_total_ht, multicurrency_total_tva, multicurrency_total_ttc";
         $sql.= ")";
         $sql.= " VALUES (".$this->fk_commande.", '" . $this->db->escape($this->label) . "','" . $this->db->escape($this->desc) . "',";
         $sql.= " ".($this->date_start?"'".$this->db->idate($this->date_start)."'":"null").",";
         $sql.= " ".($this->date_end?"'".$this->db->idate($this->date_end)."'":"null").",";
         if ($this->fk_product) { $sql.= $this->fk_product.","; }
         else { $sql.= "null,"; }
         $sql.= "'".$this->db->escape($this->product_type)."',";
-        $sql.= "'".$this->db->escape($this->special_code)."',";
-        $sql.= "'".$this->db->escape($this->rang)."',";
         $sql.= "'".$this->db->escape($this->qty)."', ";
         $sql.= " ".(empty($this->vat_src_code)?"''":"'".$this->db->escape($this->vat_src_code)."'").",";
         $sql.= " ".$this->tva_tx.", ";
         $sql.= " ".$this->localtax1_tx.",";
         $sql.= " ".$this->localtax2_tx.",";
         $sql.= " '".$this->db->escape($this->localtax1_type)."',";
         $sql.= " '".$this->db->escape($this->localtax2_type)."',";
         $sql.= " ".$this->remise_percent.", ".price2num($this->subprice,'MU').", '".$this->db->escape($this->ref_supplier)."',";
         $sql.= " ".price2num($this->total_ht).",";
         $sql.= " ".price2num($this->total_tva).",";
@@ -2787,21 +2775,20 @@
         $sql.= ", qty='".price2num($this->qty)."'";
         $sql.= ", date_start=".(! empty($this->date_start)?"'".$this->db->idate($this->date_start)."'":"null");
         $sql.= ", date_end=".(! empty($this->date_end)?"'".$this->db->idate($this->date_end)."'":"null");
         $sql.= ", info_bits='".$this->db->escape($this->info_bits)."'";
         $sql.= ", total_ht='".price2num($this->total_ht)."'";
         $sql.= ", total_tva='".price2num($this->total_tva)."'";
         $sql.= ", total_localtax1='".price2num($this->total_localtax1)."'";
         $sql.= ", total_localtax2='".price2num($this->total_localtax2)."'";
         $sql.= ", total_ttc='".price2num($this->total_ttc)."'";
         $sql.= ", product_type=".$this->product_type;
-        $sql.= ", special_code=".(!empty($this->special_code) ? $this->special_code : 0);
         $sql.= ($this->fk_unit ? ", fk_unit='".$this->db->escape($this->fk_unit)."'":", fk_unit=null");
         $sql.= ", multicurrency_subprice=".price2num($this->multicurrency_subprice)."";
         $sql.= ", multicurrency_total_ht=".price2num($this->multicurrency_total_ht)."";
         $sql.= ", multicurrency_total_tva=".price2num($this->multicurrency_total_tva)."";
         $sql.= ", multicurrency_total_ttc=".price2num($this->multicurrency_total_ttc)."";
         $sql.= " WHERE rowid = ".$this->id;
         dol_syslog(get_class($this)."::updateline", LOG_DEBUG);
         $result = $this->db->query($sql);
         if ($result > 0)
         {

--- a/htdocs/fourn/class/fournisseur.facture.class.php
+++ b/htdocs/fourn/class/fournisseur.facture.class.php
@@ -1190,24 +1190,20 @@
         include_once DOL_DOCUMENT_ROOT.'/core/lib/price.lib.php';
         global $mysoc;
         if (empty($remise_percent)) $remise_percent=0;
         if (empty($qty)) $qty=0;
         if (empty($info_bits)) $info_bits=0;
         if (empty($rang)) $rang=0;
         if (empty($ventil)) $ventil=0;
         if (empty($txtva)) $txtva=0;
         if (empty($txlocaltax1)) $txlocaltax1=0;
         if (empty($txlocaltax2)) $txlocaltax2=0;
-        if ($rang < 0) {
-            $rangmax = $this->line_max();
-            $rang = $rangmax + 1;
-        }
         $localtaxes_type=getLocalTaxesFromRate($txtva, 0, $mysoc, $this->thirdparty);
         $vat_src_code='';
         if (preg_match('/\((.*)\)/', $txtva, $reg))
         {
             $vat_src_code = $reg[1];
             $txtva = preg_replace('/\s*\(.*\)/', '', $txtva);    // Remove code into vatrate.
         }
         $remise_percent=price2num($remise_percent);
         $qty=price2num($qty);
         $pu=price2num($pu);
@@ -1219,25 +1215,20 @@
         $total_tva = $tabprice[1];
         $total_ttc = $tabprice[2];
         $total_localtax1 = $tabprice[9];
         $total_localtax2 = $tabprice[10];
 		$pu_ht = $tabprice[3];
         $multicurrency_total_ht  = $tabprice[16];
         $multicurrency_total_tva = $tabprice[17];
         $multicurrency_total_ttc = $tabprice[18];
 		$pu_ht_devise = $tabprice[19];
         if ($type < 0) return -1;
-        if ($rang < 0)
-        {
-        	$rangmax = $this->line_max();
-        	$rang = $rangmax + 1;
-        }
         $this->line=new SupplierInvoiceLine($this->db);
         $this->line->context = $this->context;
         $this->line->fk_facture_fourn=$this->id;
         $this->line->desc=$desc;
         $this->line->qty=            ($this->type==self::TYPE_CREDIT_NOTE?abs($qty):$qty);	// For credit note, quantity is always positive and unit price negative
 		$this->line->ref_supplier=$ref_supplier;
         $this->line->vat_src_code=$vat_src_code;
         $this->line->tva_tx=$txtva;
         $this->line->localtax1_tx=($total_localtax1?$localtaxes_type[1]:0);
         $this->line->localtax2_tx=($total_localtax2?$localtaxes_type[3]:0);

--- a/htdocs/fourn/class/paiementfourn.class.php
+++ b/htdocs/fourn/class/paiementfourn.class.php
@@ -83,21 +83,20 @@
 		if ($resql)
 		{
 			$num = $this->db->num_rows($resql);
 			if ($num > 0)
 			{
 				$obj = $this->db->fetch_object($resql);
 				$this->id             = $obj->rowid;
 				$this->ref            = $obj->ref;
 				$this->entity         = $obj->entity;
 				$this->date           = $this->db->jdate($obj->dp);
-				$this->datepaye       = $this->db->jdate($obj->dp);
 				$this->numero         = $obj->num_paiement;
 				$this->bank_account   = $obj->fk_account;
 				$this->bank_line      = $obj->fk_bank;
 				$this->montant        = $obj->amount;
 				$this->note           = $obj->note;
 				$this->type_code      = $obj->paiement_code;
 				$this->type_libelle   = $obj->paiement_type;
 				$this->statut         = $obj->statut;
 				$error = 1;
 			}

--- a/htdocs/fourn/commande/card.php
+++ b/htdocs/fourn/commande/card.php
@@ -685,22 +685,20 @@
 				$newlang = '';
 				if ($conf->global->MAIN_MULTILANGS && empty($newlang) && GETPOST('lang_id','aZ09')) $newlang = GETPOST('lang_id','aZ09');
 				if ($conf->global->MAIN_MULTILANGS && empty($newlang))	$newlang = $object->thirdparty->default_lang;
 				if (! empty($newlang)) {
 					$outputlangs = new Translate("", $conf);
 					$outputlangs->setDefaultLang($newlang);
 				}
 				$object->generateDocument($object->modelpdf, $outputlangs, $hidedetails, $hidedesc, $hideref);
 			}
 			$action = '';
-			header("Location: ".$_SERVER["PHP_SELF"]."?id=".$object->id);
-			exit;
 		}
 		else
 		{
 			setEventMessages($object->error, $object->errors, 'errors');
 		}
 	}
 	if ($action == 'confirm_delete' && $confirm == 'yes' && $user->rights->fournisseur->commande->supprimer)
 	{
 		$result=$object->delete($user);
 		if ($result > 0)
@@ -878,83 +876,71 @@
 							$object->set_date_livraison($user, $srcobject->date_livraison);
 							$object->set_id_projet($user, $srcobject->fk_project);
 							$lines = $srcobject->lines;
 							if (empty($lines) && method_exists($srcobject, 'fetch_lines'))
 							{
 								$srcobject->fetch_lines();
 								$lines = $srcobject->lines;
 							}
 							$fk_parent_line = 0;
 							$num = count($lines);
+							$productsupplier = new ProductFournisseur($db);
 							for($i = 0; $i < $num; $i ++)
 							{
 								if (empty($lines[$i]->subprice) || $lines[$i]->qty <= 0)
 									continue;
 								$label = (! empty($lines[$i]->label) ? $lines[$i]->label : '');
-								$desc = (! empty($lines[$i]->desc) ? $lines[$i]->desc : $lines[$i]->product_desc);
+								$desc = (! empty($lines[$i]->desc) ? $lines[$i]->desc : $lines[$i]->libelle);
 								$product_type = (! empty($lines[$i]->product_type) ? $lines[$i]->product_type : 0);
 								if (($lines[$i]->product_type != 9 && empty($lines[$i]->fk_parent_line)) || $lines[$i]->product_type == 9) {
 									$fk_parent_line = 0;
 								}
 								if (empty($conf->global->MAIN_EXTRAFIELDS_DISABLED) && method_exists($lines[$i], 'fetch_optionals')) 							// For avoid conflicts if
 								{
 									$lines[$i]->fetch_optionals($lines[$i]->rowid);
 									$array_option = $lines[$i]->array_options;
 								}
-								$ref_supplier = '';
-								$product_fourn_price_id = 0;
-								if ($origin == "commande")
+								$result = $productsupplier->find_min_price_product_fournisseur($lines[$i]->fk_product, $lines[$i]->qty, $srcobject->socid);
+								if ($result>=0)
 								{
-									$productsupplier = new ProductFournisseur($db);
-									$result = $productsupplier->find_min_price_product_fournisseur($lines[$i]->fk_product, $lines[$i]->qty, $srcobject->socid);
-									if ($result > 0)
+									$tva_tx = $lines[$i]->tva_tx;
+									if ($origin=="commande")
 									{
-										$ref_supplier = $productsupplier->ref_supplier;
-										$product_fourn_price_id = $productsupplier->product_fourn_price_id;
+										$soc=new societe($db);
+										$soc->fetch($socid);
+										$tva_tx=get_default_tva($soc, $mysoc, $lines[$i]->fk_product, $productsupplier->product_fourn_price_id);
 									}
+									$result = $object->addline(
+										$desc,
+										$lines[$i]->subprice,
+										$lines[$i]->qty,
+										$tva_tx,
+										$lines[$i]->localtax1_tx,
+										$lines[$i]->localtax2_tx,
+										$lines[$i]->fk_product > 0 ? $lines[$i]->fk_product : 0,
+										$productsupplier->product_fourn_price_id,
+										$productsupplier->ref_supplier,
+										$lines[$i]->remise_percent,
+										'HT',
+										0,
+										$lines[$i]->product_type,
+										'',
+										'',
+										null,
+										null,
+										array(),
+										$lines[$i]->fk_unit,
+										0,
+										$element,
+										!empty($lines[$i]->id) ? $lines[$i]->id : $lines[$i]->rowid
+									);
 								}
-								else
-								{
-									$ref_supplier = $lines[$i]->ref_fourn;
-									$product_fourn_price_id = 0;
-								}
-								$tva_tx = $lines[$i]->tva_tx;
-								if ($origin=="commande")
-								{
-									$soc=new societe($db);
-									$soc->fetch($socid);
-									$tva_tx=get_default_tva($soc, $mysoc, $lines[$i]->fk_product, $product_fourn_price_id);
-								}
-								$result = $object->addline(
-									$desc,
-									$lines[$i]->subprice,
-									$lines[$i]->qty,
-									$tva_tx,
-									$lines[$i]->localtax1_tx,
-									$lines[$i]->localtax2_tx,
-									$lines[$i]->fk_product > 0 ? $lines[$i]->fk_product : 0,
-									$product_fourn_price_id,
-									$ref_supplier,
-									$lines[$i]->remise_percent,
-									'HT',
-									0,
-									$lines[$i]->product_type,
-									'',
-									'',
-									null,
-									null,
-									array(),
-									$lines[$i]->fk_unit,
-									0,
-									$element,
-									!empty($lines[$i]->id) ? $lines[$i]->id : $lines[$i]->rowid
-								);
 								if ($result < 0) {
 									$error++;
 									break;
 								}
 								if ($result > 0 && $lines[$i]->product_type == 9) {
 									$fk_parent_line = $result;
 								}
 							}
 							$parameters = array('objFrom' => $srcobject);
 							$reshook = $hookmanager->executeHooks('createFrom', $parameters, $object, $action); // Note that $action and $object may have been
@@ -1125,21 +1111,20 @@
 $formorder = new FormOrder($db);
 $productstatic = new Product($db);
 if (! empty($conf->projet->enabled)) { $formproject = new FormProjets($db); }
 $help_url='EN:Module_Suppliers_Orders|FR:CommandeFournisseur|ES:Mdulo_Pedidos_a_proveedores';
 llxHeader('',$langs->trans("Order"),$help_url);
 $now=dol_now();
 if ($action=='create')
 {
 	print load_fiche_titre($langs->trans('NewOrder'));
 	dol_htmloutput_events();
-	$currency_code = $conf->currency;
 	$societe='';
 	if ($socid>0)
 	{
 		$societe=new Societe($db);
 		$societe->fetch($socid);
 	}
 	if (! empty($origin) && ! empty($originid))
 	{
 		$element = $subelement = $origin;
 		if (preg_match('/^([^_]+)_([^_]+)/i', $origin, $regs)) {
@@ -1743,21 +1728,20 @@
 		/**
 		 * Boutons actions
 		 */
 		if ($user->societe_id == 0 && $action != 'editline' && $action != 'delete')
 		{
 			print '<div	class="tabsAction">';
 			$parameters = array();
 			$reshook = $hookmanager->executeHooks('addMoreActionsButtons', $parameters, $object, $action); // Note that $action and $object may have been
 			if (empty($reshook))
 			{
-				$object->fetchObjectLinked();		// Links are used to show or not button, so we load them now.
 				if ($object->statut == 0 && $num > 0)
 				{
 					if ((empty($conf->global->MAIN_USE_ADVANCED_PERMS) && ! empty($user->rights->fournisseur->commande->creer))
 				   	|| (! empty($conf->global->MAIN_USE_ADVANCED_PERMS) && ! empty($user->rights->fournisseur->supplier_order_advance->validate)))
 					{
 						$tmpbuttonlabel=$langs->trans('Validate');
 						if ($user->rights->fournisseur->commande->approuver && empty($conf->global->SUPPLIER_ORDER_NO_DIRECT_APPROVE)) $tmpbuttonlabel = $langs->trans("ValidateAndApprove");
 						print '<a class="butAction" href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=valid">';
 						print $tmpbuttonlabel;
 						print '</a>';
@@ -1854,25 +1838,25 @@
 				}
 				if (in_array($object->statut, array(3, 4, 5, 6, 7, 9)))
 				{
 					if ($user->rights->fournisseur->commande->commander)
 					{
 						print '<a class="butAction" href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=reopen">'.$langs->trans("ReOpen").'</a>';
 					}
 				}
 				if (! empty($conf->stock->enabled) && ! empty($conf->global->STOCK_CALCULATE_ON_SUPPLIER_DISPATCH_ORDER))
 				{
-					if (in_array($object->statut, array(3,4,5))) {
+					if (in_array($object->statut, array(3,4))) {
 						if ($conf->fournisseur->enabled && $user->rights->fournisseur->commande->receptionner) {
-							print '<div class="inline-block divButAction"><a class="butAction" href="' . DOL_URL_ROOT . '/fourn/commande/dispatch.php?id=' . $object->id . '">' . $langs->trans('ReceiveProducts') . '</a></div>';
+							print '<div class="inline-block divButAction"><a class="butAction" href="' . DOL_URL_ROOT . '/fourn/commande/dispatch.php?id=' . $object->id . '">' . $langs->trans('OrderDispatch') . '</a></div>';
 						} else {
-							print '<div class="inline-block divButAction"><a class="butActionRefused" href="#" title="' . dol_escape_htmltag($langs->trans("NotAllowed")) . '">' . $langs->trans('ReceiveProducts') . '</a></div>';
+							print '<div class="inline-block divButAction"><a class="butActionRefused" href="#" title="' . dol_escape_htmltag($langs->trans("NotAllowed")) . '">' . $langs->trans('OrderDispatch') . '</a></div>';
 						}
 					}
 				}
 				if ($object->statut == 2)
 				{
 					if ($user->rights->fournisseur->commande->commander)
 					{
 						print '<div class="inline-block divButAction"><a class="butAction" href="'.$_SERVER["PHP_SELF"].'?id='.$object->id.'&amp;action=makeorder#makeorder">'.$langs->trans("MakeOrder").'</a></div>';
 					}
 					else

--- a/htdocs/fourn/commande/list.php
+++ b/htdocs/fourn/commande/list.php
@@ -41,26 +41,26 @@
 $langs->load('deliveries');
 $langs->load('companies');
 $langs->load('compta');
 $langs->load('bills');
 $langs->load('projects');
 $action=GETPOST('action','aZ09');
 $massaction=GETPOST('massaction','alpha');
 $show_files=GETPOST('show_files','int');
 $confirm=GETPOST('confirm','alpha');
 $toselect = GETPOST('toselect', 'array');
-$search_orderyear=GETPOST("search_orderyear","int");
-$search_ordermonth=GETPOST("search_ordermonth","int");
-$search_orderday=GETPOST("search_orderday","int");
-$search_deliveryyear=GETPOST("search_deliveryyear","int");
-$search_deliverymonth=GETPOST("search_deliverymonth","int");
-$search_deliveryday=GETPOST("search_deliveryday","int");
+$orderyear=GETPOST("orderyear","int");
+$ordermonth=GETPOST("ordermonth","int");
+$orderday=GETPOST("orderday","int");
+$deliveryyear=GETPOST("deliveryyear","int");
+$deliverymonth=GETPOST("deliverymonth","int");
+$deliveryday=GETPOST("deliveryday","int");
 $sall=GETPOST('search_all', 'alphanohtml');
 $search_product_category=GETPOST('search_product_category','int');
 $search_ref=GETPOST('search_ref');
 $search_refsupp=GETPOST('search_refsupp');
 $search_company=GETPOST('search_company','alpha');
 $search_town=GETPOST('search_town','alpha');
 $search_zip=GETPOST('search_zip','alpha');
 $search_state=trim(GETPOST("search_state"));
 $search_country=GETPOST("search_country",'int');
 $search_type_thirdparty=GETPOST("search_type_thirdparty",'int');
@@ -143,45 +143,48 @@
 if (GETPOST('cancel','alpha')) { $action='list'; $massaction=''; }
 if (! GETPOST('confirmmassaction','alpha') && $massaction != 'presend' && $massaction != 'confirm_presend') { $massaction=''; }
 $parameters=array('socid'=>$socid);
 $reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks
 if ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');
 if (empty($reshook))
 {
 	include DOL_DOCUMENT_ROOT.'/core/actions_changeselectedfields.inc.php';
 	if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') || GETPOST('button_removefilter','alpha')) // All tests are required to be compatible with all browsers
 	{
+		$ordermonth='';
+		$orderyear='';
+		$orderday='';
 		$search_categ='';
 		$search_user='';
 		$search_sale='';
 		$search_product_category='';
 		$search_ref='';
 		$search_refsupp='';
 		$search_company='';
 		$search_town='';
 		$search_zip="";
 		$search_state="";
 		$search_type='';
 		$search_country='';
 		$search_type_thirdparty='';
 		$search_request_author='';
 		$search_total_ht='';
 		$search_total_vat='';
 		$search_total_ttc='';
 		$search_project_ref='';
 		$search_status=-1;
-		$search_orderyear='';
-		$search_ordermonth='';
-		$search_orderday='';
-		$search_deliveryday='';
-		$search_deliverymonth='';
-		$search_deliveryyear='';
+		$orderyear='';
+		$ordermonth='';
+		$orderday='';
+		$deliveryday='';
+		$deliverymonth='';
+		$deliveryyear='';
 		$billed='';
 		$search_billed='';
 		$toselect='';
 		$search_array_options=array();
 	}
 	if (GETPOST('button_removefilter_x','alpha') || GETPOST('button_removefilter.x','alpha') || GETPOST('button_removefilter','alpha')
 		|| GETPOST('button_search_x','alpha') || GETPOST('button_search.x','alpha') || GETPOST('button_search','alpha'))
 	{
 		$massaction='';     // Protection to avoid mass action if we force a new search during a mass action confirmation
 	}
@@ -432,54 +435,54 @@
 }
 $sql.= ' WHERE cf.fk_soc = s.rowid';
 $sql.= ' AND cf.entity IN ('.getEntity('supplier_order').')';
 if ($socid > 0) $sql.= " AND s.rowid = ".$socid;
 if (!$user->rights->societe->client->voir && !$socid) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$user->id;
 if ($search_ref) $sql .= natural_search('cf.ref', $search_ref);
 if ($search_refsupp) $sql.= natural_search("cf.ref_supplier", $search_refsupp);
 if ($sall) $sql .= natural_search(array_keys($fieldstosearchall), $sall);
 if ($search_company) $sql .= natural_search('s.nom', $search_company);
 if ($search_request_author) $sql.=natural_search(array('u.lastname','u.firstname','u.login'), $search_request_author) ;
-if ($search_billed != '' && $search_billed >= 0) $sql .= " AND cf.billed = ".$db->escape($search_billed);
+if ($search_billed != '' && $search_billed >= 0) $sql .= " AND cf.billed = ".$search_billed;
 if (GETPOST('statut', 'intcomma') !== '')
 {
 	$sql .= " AND cf.fk_statut IN (".$db->escape($db->escape(GETPOST('statut', 'intcomma'))).")";
 }
 if ($search_status != '' && $search_status >= 0)
 {
 	$sql.=" AND cf.fk_statut IN (".$db->escape($search_status).")";
 }
-if ($search_ordermonth > 0)
-{
-	if ($search_orderyear > 0 && empty($search_orderday))
-		$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_get_first_day($search_orderyear,$search_ordermonth,false))."' AND '".$db->idate(dol_get_last_day($search_orderyear,$search_ordermonth,false))."'";
-	else if ($search_orderyear > 0 && ! empty($search_orderday))
-		$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $search_ordermonth, $search_orderday, $search_orderyear))."' AND '".$db->idate(dol_mktime(23, 59, 59, $search_ordermonth, $search_orderday, $search_orderyear))."'";
+if ($ordermonth > 0)
+{
+	if ($orderyear > 0 && empty($orderday))
+		$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_get_first_day($orderyear,$ordermonth,false))."' AND '".$db->idate(dol_get_last_day($orderyear,$ordermonth,false))."'";
+	else if ($orderyear > 0 && ! empty($orderday))
+		$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $ordermonth, $orderday, $orderyear))."' AND '".$db->idate(dol_mktime(23, 59, 59, $ordermonth, $orderday, $orderyear))."'";
 	else
-		$sql.= " AND date_format(cf.date_commande, '%m') = '".$db->escape($search_ordermonth)."'";
-}
-else if ($search_orderyear > 0)
-{
-	$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_get_first_day($search_orderyear,1,false))."' AND '".$db->idate(dol_get_last_day($search_orderyear,12,false))."'";
-}
-if ($search_deliverymonth > 0)
-{
-	if ($search_deliveryyear > 0 && empty($search_deliveryday))
-		$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_get_first_day($search_deliveryyear,$search_deliverymonth,false))."' AND '".$db->idate(dol_get_last_day($search_deliveryyear,$search_deliverymonth,false))."'";
-	else if ($search_deliveryyear > 0 && ! empty($search_deliveryday))
-		$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $search_eliverymonth, $search_deliveryday, $search_deliveryyear))."' AND '".$db->idate(dol_mktime(23, 59, 59, $search_deliverymonth, $search_deliveryday, $search_deliveryyear))."'";
-	else
-		$sql.= " AND date_format(cf.date_livraison, '%m') = '".$db->escape($search_deliverymonth)."'";
-}
-else if ($search_deliveryyear > 0)
-{
-	$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_get_first_day($search_deliveryyear,1,false))."' AND '".$db->idate(dol_get_last_day($search_deliveryyear,12,false))."'";
+		$sql.= " AND date_format(cf.date_commande, '%m') = '".$ordermonth."'";
+}
+else if ($orderyear > 0)
+{
+	$sql.= " AND cf.date_commande BETWEEN '".$db->idate(dol_get_first_day($orderyear,1,false))."' AND '".$db->idate(dol_get_last_day($orderyear,12,false))."'";
+}
+if ($deliverymonth > 0)
+{
+	if ($deliveryyear > 0 && empty($deliveryday))
+		$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_get_first_day($deliveryyear,$deliverymonth,false))."' AND '".$db->idate(dol_get_last_day($deliveryyear,$deliverymonth,false))."'";
+		else if ($deliveryyear > 0 && ! empty($deliveryday))
+			$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_mktime(0, 0, 0, $deliverymonth, $deliveryday, $deliveryyear))."' AND '".$db->idate(dol_mktime(23, 59, 59, $deliverymonth, $deliveryday, $deliveryyear))."'";
+			else
+				$sql.= " AND date_format(cf.date_livraison, '%m') = '".$deliverymonth."'";
+}
+else if ($deliveryyear > 0)
+{
+	$sql.= " AND cf.date_livraison BETWEEN '".$db->idate(dol_get_first_day($deliveryyear,1,false))."' AND '".$db->idate(dol_get_last_day($deliveryyear,12,false))."'";
 }
 if ($search_town)  $sql.= natural_search('s.town', $search_town);
 if ($search_zip)   $sql.= natural_search("s.zip",$search_zip);
 if ($search_state) $sql.= natural_search("state.nom",$search_state);
 if ($search_country) $sql .= " AND s.fk_pays IN (".$db->escape($search_country).')';
 if ($search_type_thirdparty) $sql .= " AND s.fk_typent IN (".$db->escape($search_type_thirdparty).')';
 if ($search_company) $sql .= natural_search('s.nom', $search_company);
 if ($search_sale > 0) $sql.= " AND s.rowid = sc.fk_soc AND sc.fk_user = " .$db->escape($search_sale);
 if ($search_user > 0) $sql.= " AND ec.fk_c_type_contact = tc.rowid AND tc.element='supplier_order' AND tc.source='internal' AND ec.element_id = cf.rowid AND ec.fk_socpeople = ".$db->escape($search_user);
 if ($search_total_ht != '') $sql.= natural_search('cf.total_ht', $search_total_ht, 1);
@@ -511,26 +514,26 @@
 	{
 		$title = $langs->trans('ListOfSupplierOrders');
 	}
 	$num = $db->num_rows($resql);
 	$arrayofselected=is_array($toselect)?$toselect:array();
 	$param='';
 	if ($socid > 0)             $param.='&socid='.$socid;
 	if (! empty($contextpage) && $contextpage != $_SERVER["PHP_SELF"]) $param.='&contextpage='.$contextpage;
 	if ($limit > 0 && $limit != $conf->liste_limit) $param.='&limit='.$limit;
 	if ($sall)					$param.="&search_all=".$sall;
-	if ($search_orderday)      	$param.='&search_orderday='.$search_orderday;
-	if ($search_ordermonth)     $param.='&search_ordermonth='.$search_ordermonth;
-	if ($search_orderyear)      $param.='&search_orderyear='.$search_orderyear;
-	if ($search_deliveryday)   	$param.='&search_deliveryday='.$search_deliveryday;
-	if ($search_deliverymonth)  $param.='&search_deliverymonth='.$search_deliverymonth;
-	if ($search_deliveryyear)   $param.='&search_deliveryyear='.$search_deliveryyear;
+	if ($orderday)      		$param.='&orderday='.$orderday;
+	if ($ordermonth)      		$param.='&ordermonth='.$ordermonth;
+	if ($orderyear)       		$param.='&orderyear='.$orderyear;
+	if ($deliveryday)   		$param.='&deliveryday='.$deliveryday;
+	if ($deliverymonth)   		$param.='&deliverymonth='.$deliverymonth;
+	if ($deliveryyear)    		$param.='&deliveryyear='.$deliveryyear;
 	if ($search_ref)      		$param.='&search_ref='.$search_ref;
 	if ($search_company)  		$param.='&search_company='.$search_company;
 	if ($search_user > 0) 		$param.='&search_user='.$search_user;
 	if ($search_request_author) $param.='&search_request_author='.$search_request_author;
 	if ($search_sale > 0) 		$param.='&search_sale='.$search_sale;
 	if ($search_total_ht != '') $param.='&search_total_ht='.$search_total_ht;
 	if ($search_total_ttc != '') $param.="&search_total_ttc=".$search_total_ttc;
 	if ($search_refsupp) 		$param.="&search_refsupp=".$search_refsupp;
 	if ($search_status >= 0)  	$param.="&search_status=".$search_status;
 	if ($search_project_ref >= 0) $param.="&search_project_ref=".$search_project_ref;
@@ -681,31 +684,31 @@
 	}
 	if (! empty($arrayfields['typent.code']['checked']))
 	{
 		print '<td class="liste_titre maxwidthonsmartphone" align="center">';
 		print $form->selectarray("search_type_thirdparty", $formcompany->typent_array(0), $search_type_thirdparty, 0, 0, 0, '', 0, 0, 0, (empty($conf->global->SOCIETE_SORT_ON_TYPEENT)?'ASC':$conf->global->SOCIETE_SORT_ON_TYPEENT));
 		print '</td>';
 	}
 	if (! empty($arrayfields['cf.date_commande']['checked']))
 	{
 		print '<td class="liste_titre" align="center">';
-		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_orderday" value="'.$search_orderday.'">';
-		print '<input class="flat" type="text" size="1" maxlength="2" name="search_ordermonth" value="'.$search_ordermonth.'">';
-		$formother->select_year($search_orderyear?$search_orderyear:-1,'search_orderyear',1, 20, 5);
+		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="orderday" value="'.$orderday.'">';
+		print '<input class="flat" type="text" size="1" maxlength="2" name="ordermonth" value="'.$ordermonth.'">';
+		$formother->select_year($orderyear?$orderyear:-1,'orderyear',1, 20, 5);
 		print '</td>';
 	}
 	if (! empty($arrayfields['cf.date_delivery']['checked']))
 	{
 		print '<td class="liste_titre" align="center">';
-		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="search_deliveryday" value="'.$search_deliveryday.'">';
-		print '<input class="flat" type="text" size="1" maxlength="2" name="search_deliverymonth" value="'.$search_deliverymonth.'">';
-		$formother->select_year($search_deliveryyear?$search_deliveryyear:-1,'search_deliveryyear',1, 20, 5);
+		if (! empty($conf->global->MAIN_LIST_FILTER_ON_DAY)) print '<input class="flat" type="text" size="1" maxlength="2" name="deliveryday" value="'.$deliveryday.'">';
+		print '<input class="flat" type="text" size="1" maxlength="2" name="deliverymonth" value="'.$deliverymonth.'">';
+		$formother->select_year($deliveryyear?$deliveryyear:-1,'deliveryyear',1, 20, 5);
 		print '</td>';
 	}
 	if (! empty($arrayfields['cf.total_ht']['checked']))
 	{
 		print '<td class="liste_titre" align="right">';
 		print '<input class="flat" type="text" size="5" name="search_total_ht" value="'.$search_total_ht.'">';
 		print '</td>';
 	}
 	if (! empty($arrayfields['cf.total_vat']['checked']))
 	{

--- a/htdocs/fourn/facture/card.php
+++ b/htdocs/fourn/facture/card.php
@@ -808,37 +808,36 @@
 				$label = $productsupplier->label;
 				$desc = $productsupplier->description;
 				if (trim($product_desc) != trim($desc)) $desc = dol_concatdesc($desc, $product_desc);
 				$tva_tx=get_default_tva($object->thirdparty, $mysoc, $productsupplier->id, $_POST['idprodfournprice']);
 				$tva_npr = get_default_npr($object->thirdparty, $mysoc, $productsupplier->id, $_POST['idprodfournprice']);
 				if (empty($tva_tx)) $tva_npr=0;
 				$localtax1_tx= get_localtax($tva_tx, 1, $mysoc, $object->thirdparty, $tva_npr);
 				$localtax2_tx= get_localtax($tva_tx, 2, $mysoc, $object->thirdparty, $tva_npr);
 				$type = $productsupplier->type;
 				$price_base_type = 'HT';
-				$rang = $object->line_max() +1;
 				$result=$object->addline(
 					$desc,
 					$productsupplier->fourn_pu,
 					$tva_tx,
 					$localtax1_tx,
 					$localtax2_tx,
 					$qty,
 					$idprod,
 					$remise_percent,
 					$date_start,
 					$date_end,
 					0,
 					$tva_npr,
 					$price_base_type,
 					$type,
-					$rang,
+					-1,
 					0,
 					$array_options,
 					$productsupplier->fk_unit,
 					$productsupplier->fourn_ref
 				);
 			}
 			if ($idprod == -99 || $idprod == 0)
 			{
 				$error++;
 				$langs->load("errors");

--- a/htdocs/holiday/class/holiday.class.php
+++ b/htdocs/holiday/class/holiday.class.php
@@ -652,39 +652,37 @@
 				}
 			}
 			else
 			{
 				dol_print_error('', 'Bad value of parameter halfday when calling function verifDateHolidayCP');
 			}
 		}
 		return true;
 	}
 	/**
-	 *	Check that a user is not on holiday for a particular timestamp
+	 *	Check a user is not on holiday for a particular timestamp
 	 *
 	 * 	@param 	int			$fk_user				Id user
 	 *  @param	timestamp	$timestamp				Time stamp date for a day (YYYY-MM-DD) without hours  (= 12:00AM in english and not 12:00PM that is 12:00)
-	 *  @param	string		$status					Filter on holiday status. '-1' = no filter.
 	 * 	@return array								array('morning'=> ,'afternoon'=> ), Boolean is true if user is available for day timestamp.
 	 *  @see verifDateHolidayCP
 	 */
-	function verifDateHolidayForTimestamp($fk_user, $timestamp, $status='-1')
+	function verifDateHolidayForTimestamp($fk_user, $timestamp)
 	{
 		global $langs, $conf;
 		$isavailablemorning=true;
 		$isavailableafternoon=true;
-		$sql = "SELECT cp.rowid, cp.date_debut as date_start, cp.date_fin as date_end, cp.halfday, cp.statut";
+		$sql = "SELECT cp.rowid, cp.date_debut as date_start, cp.date_fin as date_end, cp.halfday";
 		$sql.= " FROM ".MAIN_DB_PREFIX."holiday as cp";
 		$sql.= " WHERE cp.entity IN (".getEntity('holiday').")";
 		$sql.= " AND cp.fk_user = ".(int) $fk_user;
-		$sql.= " AND cp.date_debut <= '".$this->db->idate($timestamp)."' AND cp.date_fin >= '".$this->db->idate($timestamp)."'";
-		if ($status != '-1') $sql.=" AND cp.statut IN (".$this->db->escape($status).")";
+		$sql.= " AND date_debut <= '".$this->db->idate($timestamp)."' AND date_fin >= '".$this->db->idate($timestamp)."'";
 		$resql = $this->db->query($sql);
 		if ($resql)
 		{
 			$num_rows = $this->db->num_rows($resql);	// Note, we can have 2 records if on is morning and the other one is afternoon
 			if ($num_rows > 0)
 			{
 				$arrayofrecord=array();
 				$i=0;
 				while ($i < $num_rows)
 				{

--- a/htdocs/holiday/list.php
+++ b/htdocs/holiday/list.php
@@ -59,21 +59,21 @@
 $pagenext = $page + 1;
 $object=new Holiday($db);
 $extrafields = new ExtraFields($db);
 $diroutputmassaction=$conf->holiday->dir_output . '/temp/massgeneration/'.$user->id;
 $hookmanager->initHooks(array('holidaylist'));     // Note that conf->hooks_modules contains array
 $extralabels = $extrafields->fetch_name_optionals_label('holiday');
 $search_array_options=$extrafields->getOptionalsFromPost($extralabels,'','search_');
 if (! $sortfield) $sortfield="cp.rowid";
 if (! $sortorder) $sortorder="DESC";
 $sall                = trim((GETPOST('search_all', 'alphanohtml')!='')?GETPOST('search_all', 'alphanohtml'):GETPOST('sall', 'alphanohtml'));
-$search_ref          = GETPOST('search_ref','alphanohtml');
+$search_ref          = GETPOST('search_ref','alpha');
 $search_day_create   = GETPOST('search_day_create','int');
 $search_month_create = GETPOST('search_month_create','int');
 $search_year_create  = GETPOST('search_year_create','int');
 $search_day_start    = GETPOST('search_day_start','int');
 $search_month_start  = GETPOST('search_month_start','int');
 $search_year_start   = GETPOST('search_year_start','int');
 $search_day_end      = GETPOST('search_day_end','int');
 $search_month_end    = GETPOST('search_month_end','int');
 $search_year_end     = GETPOST('search_year_end','int');
 $search_employee     = GETPOST('search_employee','int');
@@ -133,21 +133,21 @@
 $holidaystatic=new Holiday($db);
 $fuser = new User($db);
 $result = $holiday->updateBalance();
 $max_year = 5;
 $min_year = 10;
 $filter='';
 llxHeader('', $langs->trans('CPTitreMenu'));
 $order = $db->order($sortfield,$sortorder).$db->plimit($limit + 1, $offset);
 if(!empty($search_ref))
 {
-    $filter.= " AND cp.rowid = ".(int) $db->escape($search_ref);
+    $filter.= " AND cp.rowid = ".$db->escape($search_ref);
 }
 if($search_year_start > 0) {
     if($search_month_start > 0) {
     	$filter .= " AND (cp.date_debut BETWEEN '".$db->idate(dol_get_first_day($search_year_start,$search_month_start,1))."' AND '".$db->idate(dol_get_last_day($search_year_start,$search_month_start,1))."')";
     } else {
     	$filter .= " AND (cp.date_debut BETWEEN '".$db->idate(dol_get_first_day($search_year_start,1,1))."' AND '".$db->idate(dol_get_last_day($search_year_start,12,1))."')";
     }
 } else {
     if($search_month_start > 0) {
         $filter.= " AND date_format(cp.date_debut, '%m') = '".$db->escape($search_month_start)."'";

--- a/htdocs/install/upgrade.php
+++ b/htdocs/install/upgrade.php
@@ -138,21 +138,21 @@
             $ok=0;
         }
     }
     if ($ok)
     {
         $version=$db->getVersion();
         $versionarray=$db->getVersionArray();
         print '<tr><td>'.$langs->trans("ServerVersion").'</td>';
         print '<td align="right">'.$version.'</td></tr>';
         dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ServerVersion") . ": " .$version);
-        if ($db->type == 'mysqli' && function_exists('mysqli_get_charset'))
+        if ($db->type == 'mysqli')
         {
         	$tmparray = $db->db->get_charset();
         	print '<tr><td>'.$langs->trans("ClientCharset").'</td>';
         	print '<td align="right">'.$tmparray->charset.'</td></tr>';
         	dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ClientCharset") . ": " .$tmparray->charset);
         	print '<tr><td>'.$langs->trans("ClientSortingCharset").'</td>';
         	print '<td align="right">'.$tmparray->collation.'</td></tr>';
         	dolibarr_install_syslog("upgrade: " . $langs->transnoentities("ClientCollation") . ": " .$tmparray->collation);
         }
         $versionmindb=explode('.',$db::VERSIONMIN);
