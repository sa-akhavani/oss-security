# ====================================================================
# FILE: templates/trust.tpl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| <?php
     2| $this->includeAtTemplateBase('includes/header.php');
     3| ?>
     4| <div class="form">
     5| <?php
     6| $params = array(
     7| 	'%SITEURL%' => '<code>' . htmlspecialchars($this->data['trustRoot']) . '</code>',
     8| 	);
     9| echo('<p>' . $this->t('{openidProvider:openidProvider:confirm_question}', $params) . '</p>');
    10| ?>
    11| <form method="post" action="?">
    12| <input type="hidden" name="StateID" value="<?php echo htmlspecialchars($this->data['StateID']); ?>" />
    13| <input type="checkbox" name="TrustRemember" value="on" id="remember" />
    14| <label for="TrustRemember"><?php echo($this->t('{openidProvider:openidProvider:remember}')); ?></label>
    15| <br />
    16| <input type="submit" name="TrustYes" value="<?php echo($this->t('{openidProvider:openidProvider:confirm}')); ?>" />
    17| <input type="submit" name="TrustNo" value="<?php echo($this->t('{openidProvider:openidProvider:notconfirm}')); ?>" />
    18| </form>
    19| </div>
    20| <?php
    21| $this->includeAtTemplateBase('includes/footer.php');
    22| ?>


# ====================================================================
# FILE: templates/user.tpl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-67 ---
     1| <?php
     2| $identity = $this->data['identity'];
     3| $loggedInAs = $this->data['loggedInAs'];
     4| $loginURL = $this->data['loginURL'];
     5| $logoutURL = $this->data['logoutURL'];
     6| $ownPage = $this->data['ownPage'];
     7| $serverURL = $this->data['serverURL'];
     8| $trustedSites = $this->data['trustedSites'];
     9| $userId = $this->data['userId'];
    10| $userIdURL = $this->data['userIdURL'];
    11| $xrdsURL = $this->data['xrdsURL'];
    12| header('X-XRDS-Location: ' . $xrdsURL);
    13| if ($userId !== FALSE) {
    14| 	$title = $this->t('{openidProvider:openidProvider:title_user}', array('%USERID%' => htmlspecialchars($userId)));
    15| } else {
    16| 	$title = $this->t('{openidProvider:openidProvider:title_no_user}');
    17| }
    18| $serverLink = '<link rel="openid.server" href="' . htmlspecialchars($serverURL) . '" />' . "\n";
    19| $serverLink .= '<link rel="openid2.provider" href="' . htmlspecialchars($serverURL) . '" />';
    20| $delegateLink = '<link rel="openid.delegate" href="' . htmlspecialchars($userIdURL) . '" />' . "\n";
    21| $delegateLink .= '<link rel="openid2.local_id" href="' . htmlspecialchars($userIdURL) . '" />';
    22| $this->data['header'] = $title;
    23| $this->data['head'] = $serverLink;
    24| $this->includeAtTemplateBase('includes/header.php');
    25| echo('<h2>' . $title . '</h2>');
    26| if ($userId !== FALSE) {
    27| 	echo('<p>' . $this->t('{openidProvider:openidProvider:user_page_for}', array('%USERID%' => htmlspecialchars($userId))) . '</p>');
    28| }
    29| if ($loggedInAs === NULL) {
    30| 	echo('<p><a href="' . htmlspecialchars($loginURL) . '">' . $this->t('{openidProvider:openidProvider:login_view_own_page}') . '</a></p>');
    31| } elseif (!$ownPage) {
    32| 	echo('<p><a href="' . htmlspecialchars($identity) . '">' . $this->t('{openidProvider:openidProvider:view_own_page}') . '</a></p>');
    33| }
    34| if ($ownPage) {
    35| 	echo('<h3>Using your OpenID</h3>');
    36| 	echo('<p>');
    37| 	echo($this->t('{openidProvider:openidProvider:your_identifier}') . '<br />');
    38| 	echo('<code>' . htmlspecialchars($userIdURL) . '</code>');
    39| 	echo('</p>');
    40| 	echo('<p>');
    41| 	echo($this->t('{openidProvider:openidProvider:howto_delegate}'));
    42| 	echo('<br />');
    43| 	echo('<pre>' . htmlspecialchars($serverLink) . "\n" . htmlspecialchars($delegateLink) . '</pre>');
    44| 	echo('</p>');
    45| 	echo('<h3>' . $this->t('{openidProvider:openidProvider:trustlist_trustedsites}') . '</h3>');
    46| 	if (count($trustedSites) > 0) {
    47| 		echo('<div class="form">');
    48| 		echo('<form method="post" action="?">');
    49| 		echo('<ul>');
    50| 		foreach ($trustedSites as $site) {
    51| 			echo '<li>';
    52| 			echo '<input type="submit" name="remove_' . bin2hex($site) .
    53| 				'" value="' . $this->t('{openidProvider:openidProvider:trustlist_remove}') . '" />';
    54| 			echo ' <code>' . htmlspecialchars($site) . '</code>';
    55| 			echo '</li>';
    56| 		}
    57| 		echo('</ul>');
    58| 		echo('</form>');
    59| 		echo('</div>');
    60| 	} else {
    61| 		echo('<p>' . $this->t('{openidProvider:openidProvider:trustlist_nosites}') . '</p>');
    62| 	}
    63| 	echo('<h3>' . $this->t('{openidProvider:openidProvider:logout_title}') . '</h3>');
    64| 	echo('<p><a href="' . htmlspecialchars($logoutURL) . '">' . $this->t('{openidProvider:openidProvider:logout}') . '</a></p>');
    65| }
    66| $this->includeAtTemplateBase('includes/footer.php');
    67| ?>


# ====================================================================
# FILE: www/trust.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-28 ---
     5| $StateID = $_REQUEST['StateID'];
     6| $server = \SimpleSAML\Module\openidprovider\ProviderServer::getInstance();
     7| $state = $server->loadState($_REQUEST['StateID']);
     8| $trustRoot = $state['request']->trust_root;
     9| $identity = $server->getIdentity();
    10| if ($identity === null) {
    11|     $server->processRequest($state);
    12| }
    13| if (isset($_REQUEST['TrustYes'])) {
    14|     if (isset($_REQUEST['TrustRemember'])) {
    15|         $server->addTrustRoot($identity, $trustRoot);
    16|     }
    17|     $state['TrustResponse'] = true;
    18|     $server->processRequest($state);
    19| }
    20| if (isset($_REQUEST['TrustNo'])) {
    21|     $state['TrustResponse'] = false;
    22|     $server->processRequest($state);
    23| }
    24| $globalConfig = \SimpleSAML\Configuration::getInstance();
    25| $t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:trust.tpl.php');
    26| $t->data['StateID'] = $_REQUEST['StateID'];
    27| $t->data['trustRoot'] = $trustRoot;
    28| $t->show();


# ====================================================================
# FILE: www/user.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-58 ---
    17| if ($userId && $userId === $server->getUserId()) {
    18|     $ownPage = true;
    19| } else {
    20|     $ownPage = false;
    21| }
    22| if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    23|     if ($ownPage) {
    24|         foreach ($_POST as $k => $v) {
    25|             $op = explode('_', $k, 2);
    26|             if (count($op) == 1 || $op[0] !== 'remove') {
    27|                 continue;
    28|             }
    29|             $site = $op[1];
    30|             $site = pack("H*", $site);
    31|             $server->removeTrustRoot($identity, $site);
    32|         }
    33|     }
    34|     \SimpleSAML\Utils\HTTP::redirectTrustedURL($identity);
    35| }
    36| if ($ownPage) {
    37|     $trustedSites = $server->getTrustRoots($identity);
    38| } else {
    39|     $trustedSites = [];
    40| }
    41| $userBase = \SimpleSAML\Module::getModuleURL('openidProvider/user.php');
    42| $xrds = \SimpleSAML\Module::getModuleURL('openidProvider/xrds.php');
    43| if ($userId !== false) {
    44|     $xrds = \SimpleSAML\Utils\HTTP::addURLParameters($xrds, array('user' => $userId));
    45| }
    46| $as = $server->getAuthSource();
    47| $t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:user.tpl.php');
    48| $t->data['identity'] = $identity;
    49| $t->data['loggedInAs'] = $server->getUserId();
    50| $t->data['loginURL'] = $as->getLoginURL($userBase);
    51| $t->data['logoutURL'] = $as->getLogoutURL();
    52| $t->data['ownPage'] = $ownPage;
    53| $t->data['serverURL'] = $server->getServerURL();
    54| $t->data['trustedSites'] = $trustedSites;
    55| $t->data['userId'] = $userId;
    56| $t->data['userIdURL'] = $userBase . '/' . $userId;
    57| $t->data['xrdsURL'] = $xrds;
    58| $t->show();

