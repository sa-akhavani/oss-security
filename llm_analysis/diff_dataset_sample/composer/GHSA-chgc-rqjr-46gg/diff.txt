--- a/templates/trust.tpl.php
+++ b//dev/null
@@ -1,22 +0,0 @@
-<?php
-$this->includeAtTemplateBase('includes/header.php');
-?>
-<div class="form">
-<?php
-$params = array(
-	'%SITEURL%' => '<code>' . htmlspecialchars($this->data['trustRoot']) . '</code>',
-	);
-echo('<p>' . $this->t('{openidProvider:openidProvider:confirm_question}', $params) . '</p>');
-?>
-<form method="post" action="?">
-<input type="hidden" name="StateID" value="<?php echo htmlspecialchars($this->data['StateID']); ?>" />
-<input type="checkbox" name="TrustRemember" value="on" id="remember" />
-<label for="TrustRemember"><?php echo($this->t('{openidProvider:openidProvider:remember}')); ?></label>
-<br />
-<input type="submit" name="TrustYes" value="<?php echo($this->t('{openidProvider:openidProvider:confirm}')); ?>" />
-<input type="submit" name="TrustNo" value="<?php echo($this->t('{openidProvider:openidProvider:notconfirm}')); ?>" />
-</form>
-</div>
-<?php
-$this->includeAtTemplateBase('includes/footer.php');
-?>

--- a/templates/user.tpl.php
+++ b//dev/null
@@ -1,67 +0,0 @@
-<?php
-$identity = $this->data['identity'];
-$loggedInAs = $this->data['loggedInAs'];
-$loginURL = $this->data['loginURL'];
-$logoutURL = $this->data['logoutURL'];
-$ownPage = $this->data['ownPage'];
-$serverURL = $this->data['serverURL'];
-$trustedSites = $this->data['trustedSites'];
-$userId = $this->data['userId'];
-$userIdURL = $this->data['userIdURL'];
-$xrdsURL = $this->data['xrdsURL'];
-header('X-XRDS-Location: ' . $xrdsURL);
-if ($userId !== FALSE) {
-	$title = $this->t('{openidProvider:openidProvider:title_user}', array('%USERID%' => htmlspecialchars($userId)));
-} else {
-	$title = $this->t('{openidProvider:openidProvider:title_no_user}');
-}
-$serverLink = '<link rel="openid.server" href="' . htmlspecialchars($serverURL) . '" />' . "\n";
-$serverLink .= '<link rel="openid2.provider" href="' . htmlspecialchars($serverURL) . '" />';
-$delegateLink = '<link rel="openid.delegate" href="' . htmlspecialchars($userIdURL) . '" />' . "\n";
-$delegateLink .= '<link rel="openid2.local_id" href="' . htmlspecialchars($userIdURL) . '" />';
-$this->data['header'] = $title;
-$this->data['head'] = $serverLink;
-$this->includeAtTemplateBase('includes/header.php');
-echo('<h2>' . $title . '</h2>');
-if ($userId !== FALSE) {
-	echo('<p>' . $this->t('{openidProvider:openidProvider:user_page_for}', array('%USERID%' => htmlspecialchars($userId))) . '</p>');
-}
-if ($loggedInAs === NULL) {
-	echo('<p><a href="' . htmlspecialchars($loginURL) . '">' . $this->t('{openidProvider:openidProvider:login_view_own_page}') . '</a></p>');
-} elseif (!$ownPage) {
-	echo('<p><a href="' . htmlspecialchars($identity) . '">' . $this->t('{openidProvider:openidProvider:view_own_page}') . '</a></p>');
-}
-if ($ownPage) {
-	echo('<h3>Using your OpenID</h3>');
-	echo('<p>');
-	echo($this->t('{openidProvider:openidProvider:your_identifier}') . '<br />');
-	echo('<code>' . htmlspecialchars($userIdURL) . '</code>');
-	echo('</p>');
-	echo('<p>');
-	echo($this->t('{openidProvider:openidProvider:howto_delegate}'));
-	echo('<br />');
-	echo('<pre>' . htmlspecialchars($serverLink) . "\n" . htmlspecialchars($delegateLink) . '</pre>');
-	echo('</p>');
-	echo('<h3>' . $this->t('{openidProvider:openidProvider:trustlist_trustedsites}') . '</h3>');
-	if (count($trustedSites) > 0) {
-		echo('<div class="form">');
-		echo('<form method="post" action="?">');
-		echo('<ul>');
-		foreach ($trustedSites as $site) {
-			echo '<li>';
-			echo '<input type="submit" name="remove_' . bin2hex($site) .
-				'" value="' . $this->t('{openidProvider:openidProvider:trustlist_remove}') . '" />';
-			echo ' <code>' . htmlspecialchars($site) . '</code>';
-			echo '</li>';
-		}
-		echo('</ul>');
-		echo('</form>');
-		echo('</div>');
-	} else {
-		echo('<p>' . $this->t('{openidProvider:openidProvider:trustlist_nosites}') . '</p>');
-	}
-	echo('<h3>' . $this->t('{openidProvider:openidProvider:logout_title}') . '</h3>');
-	echo('<p><a href="' . htmlspecialchars($logoutURL) . '">' . $this->t('{openidProvider:openidProvider:logout}') . '</a></p>');
-}
-$this->includeAtTemplateBase('includes/footer.php');
-?>

--- a/www/trust.php
+++ b/www/trust.php
@@ -15,14 +15,14 @@
         $server->addTrustRoot($identity, $trustRoot);
     }
     $state['TrustResponse'] = true;
     $server->processRequest($state);
 }
 if (isset($_REQUEST['TrustNo'])) {
     $state['TrustResponse'] = false;
     $server->processRequest($state);
 }
 $globalConfig = \SimpleSAML\Configuration::getInstance();
-$t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:trust.tpl.php');
+$t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:trust.twig');
 $t->data['StateID'] = $_REQUEST['StateID'];
 $t->data['trustRoot'] = $trustRoot;
-$t->show();
+$t->send();

--- a/www/user.php
+++ b/www/user.php
@@ -27,32 +27,37 @@
                 continue;
             }
             $site = $op[1];
             $site = pack("H*", $site);
             $server->removeTrustRoot($identity, $site);
         }
     }
     \SimpleSAML\Utils\HTTP::redirectTrustedURL($identity);
 }
 if ($ownPage) {
+    $newSites = [];
     $trustedSites = $server->getTrustRoots($identity);
+    foreach ($trustedSites as $i => $site) {
+        $newSites[bin2hex($site)] = $site;
+    }
+    $trustedSites = $newSites;
 } else {
     $trustedSites = [];
 }
 $userBase = \SimpleSAML\Module::getModuleURL('openidProvider/user.php');
 $xrds = \SimpleSAML\Module::getModuleURL('openidProvider/xrds.php');
 if ($userId !== false) {
     $xrds = \SimpleSAML\Utils\HTTP::addURLParameters($xrds, array('user' => $userId));
 }
+header('X-XRDS-Location: ' . $xrds);
 $as = $server->getAuthSource();
-$t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:user.tpl.php');
+$t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:user.twig');
 $t->data['identity'] = $identity;
 $t->data['loggedInAs'] = $server->getUserId();
 $t->data['loginURL'] = $as->getLoginURL($userBase);
 $t->data['logoutURL'] = $as->getLogoutURL();
 $t->data['ownPage'] = $ownPage;
 $t->data['serverURL'] = $server->getServerURL();
 $t->data['trustedSites'] = $trustedSites;
 $t->data['userId'] = $userId;
 $t->data['userIdURL'] = $userBase . '/' . $userId;
-$t->data['xrdsURL'] = $xrds;
-$t->show();
+$t->send();
