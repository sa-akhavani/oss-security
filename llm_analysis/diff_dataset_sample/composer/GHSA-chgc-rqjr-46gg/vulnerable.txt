# ====================================================================
# FILE: www/trust.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 5-28 ---
     5| $StateID = $_REQUEST['StateID'];
     6| $server = \SimpleSAML\Module\openidprovider\ProviderServer::getInstance();
     7| $state = $server->loadState($_REQUEST['StateID']);
     8| $trustRoot = $state['request']->trust_root;
     9| $identity = $server->getIdentity();
    10| if ($identity === null) {
    11|     $server->processRequest($state);
    12| }
    13| if (isset($_REQUEST['TrustYes'])) {
    14|     if (isset($_REQUEST['TrustRemember'])) {
    15|         $server->addTrustRoot($identity, $trustRoot);
    16|     }
    17|     $state['TrustResponse'] = true;
    18|     $server->processRequest($state);
    19| }
    20| if (isset($_REQUEST['TrustNo'])) {
    21|     $state['TrustResponse'] = false;
    22|     $server->processRequest($state);
    23| }
    24| $globalConfig = \SimpleSAML\Configuration::getInstance();
    25| $t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:trust.twig');
    26| $t->data['StateID'] = $_REQUEST['StateID'];
    27| $t->data['trustRoot'] = $trustRoot;
    28| $t->send();


# ====================================================================
# FILE: www/user.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-63 ---
    17| if ($userId && $userId === $server->getUserId()) {
    18|     $ownPage = true;
    19| } else {
    20|     $ownPage = false;
    21| }
    22| if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    23|     if ($ownPage) {
    24|         foreach ($_POST as $k => $v) {
    25|             $op = explode('_', $k, 2);
    26|             if (count($op) == 1 || $op[0] !== 'remove') {
    27|                 continue;
    28|             }
    29|             $site = $op[1];
    30|             $site = pack("H*", $site);
    31|             $server->removeTrustRoot($identity, $site);
    32|         }
    33|     }
    34|     \SimpleSAML\Utils\HTTP::redirectTrustedURL($identity);
    35| }
    36| if ($ownPage) {
    37|     $newSites = [];
    38|     $trustedSites = $server->getTrustRoots($identity);
    39|     foreach ($trustedSites as $i => $site) {
    40|         $newSites[bin2hex($site)] = $site;
    41|     }
    42|     $trustedSites = $newSites;
    43| } else {
    44|     $trustedSites = [];
    45| }
    46| $userBase = \SimpleSAML\Module::getModuleURL('openidProvider/user.php');
    47| $xrds = \SimpleSAML\Module::getModuleURL('openidProvider/xrds.php');
    48| if ($userId !== false) {
    49|     $xrds = \SimpleSAML\Utils\HTTP::addURLParameters($xrds, array('user' => $userId));
    50| }
    51| header('X-XRDS-Location: ' . $xrds);
    52| $as = $server->getAuthSource();
    53| $t = new \SimpleSAML\XHTML\Template($globalConfig, 'openidProvider:user.twig');
    54| $t->data['identity'] = $identity;
    55| $t->data['loggedInAs'] = $server->getUserId();
    56| $t->data['loginURL'] = $as->getLoginURL($userBase);
    57| $t->data['logoutURL'] = $as->getLogoutURL();
    58| $t->data['ownPage'] = $ownPage;
    59| $t->data['serverURL'] = $server->getServerURL();
    60| $t->data['trustedSites'] = $trustedSites;
    61| $t->data['userId'] = $userId;
    62| $t->data['userIdURL'] = $userBase . '/' . $userId;
    63| $t->send();

