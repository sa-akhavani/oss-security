# ====================================================================
# FILE: actions/admin/settings/120.system.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 238-286 ---
   238| 					'settinggroup' => 'system',
   239| 					'varname' => 'mail_smtp_usetls',
   240| 					'type' => 'checkbox',
   241| 					'default' => true,
   242| 					'save_method' => 'storeSettingField'
   243| 				],
   244| 				'system_mail_smtp_auth' => [
   245| 					'label' => lng('serversettings.mail_smtp_auth'),
   246| 					'settinggroup' => 'system',
   247| 					'varname' => 'mail_smtp_auth',
   248| 					'type' => 'checkbox',
   249| 					'default' => true,
   250| 					'save_method' => 'storeSettingField'
   251| 				],
   252| 				'system_mail_smtp_user' => [
   253| 					'label' => lng('serversettings.mail_smtp_user'),
   254| 					'settinggroup' => 'system',
   255| 					'varname' => 'mail_smtp_user',
   256| 					'type' => 'text',
   257| 					'default' => '',
   258| 					'save_method' => 'storeSettingField'
   259| 				],
   260| 				'system_mail_smtp_passwd' => [
   261| 					'label' => lng('serversettings.mail_smtp_passwd'),
   262| 					'settinggroup' => 'system',
   263| 					'varname' => 'mail_smtp_passwd',
   264| 					'type' => 'password',
   265| 					'default' => '',
   266| 					'save_method' => 'storeSettingField'
   267| 				],
   268| 				'system_apply_specialsettings_default' => [
   269| 					'label' => lng('serversettings.apply_specialsettings_default'),
   270| 					'settinggroup' => 'system',
   271| 					'varname' => 'apply_specialsettings_default',
   272| 					'type' => 'checkbox',
   273| 					'default' => true,
   274| 					'save_method' => 'storeSettingField',
   275| 					'advanced_mode' => true
   276| 				],
   277| 				'system_apply_phpconfigs_default' => [
   278| 					'label' => lng('serversettings.apply_phpconfigs_default'),
   279| 					'settinggroup' => 'system',
   280| 					'varname' => 'apply_phpconfigs_default',
   281| 					'type' => 'checkbox',
   282| 					'default' => true,
   283| 					'save_method' => 'storeSettingField',
   284| 					'advanced_mode' => true
   285| 				],
   286| 				'system_domaindefaultalias' => [


# ====================================================================
# FILE: actions/admin/settings/131.ssl.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 248-285 ---
   248| 					'string_type' => 'validate_ip',
   249| 					'string_emptyallowed' => true,
   250| 					'default' => '',
   251| 					'save_method' => 'storeSettingField',
   252| 					'advanced_mode' => true
   253| 				],
   254| 				'system_le_renew_services' => [
   255| 					'label' => lng('serversettings.le_renew_services'),
   256| 					'settinggroup' => 'system',
   257| 					'varname' => 'le_renew_services',
   258| 					'type' => 'select',
   259| 					'default' => '',
   260| 					'select_mode' => 'multiple',
   261| 					'option_emptyallowed' => true,
   262| 					'select_var' => [
   263| 						'' => lng('panel.none_value'),
   264| 						'postfix' => 'postfix (smtp)',
   265| 						'dovecot' => 'dovecot (imap/pop3)',
   266| 						'proftpd' => 'proftpd (ftp)',
   267| 					],
   268| 					'save_method' => 'storeSettingField',
   269| 					'advanced_mode' => true
   270| 				],
   271| 				'system_le_renew_hook' => [
   272| 					'label' => lng('serversettings.le_renew_hook'),
   273| 					'settinggroup' => 'system',
   274| 					'varname' => 'le_renew_hook',
   275| 					'type' => 'text',
   276| 					'string_regexp' => '/^[a-z0-9\/\._\- ]+$/i',
   277| 					'default' => 'systemctl restart postfix dovecot proftpd',
   278| 					'save_method' => 'storeSettingField',
   279| 					'advanced_mode' => true,
   280| 					'required_otp' => true
   281| 				],
   282| 			]
   283| 		]
   284| 	]
   285| ];


# ====================================================================
# FILE: actions/admin/settings/180.antispam.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 39-105 ---
    39| 				'antispam_config_file' => [
    40| 					'label' => lng('antispam.config_file'),
    41| 					'settinggroup' => 'antispam',
    42| 					'varname' => 'config_file',
    43| 					'type' => 'text',
    44| 					'string_type' => 'file',
    45| 					'default' => '/etc/rspamd/local.d/froxlor_settings.conf',
    46| 					'save_method' => 'storeSettingFieldInsertAntispamTask',
    47| 					'requires_reconf' => ['antispam']
    48| 				],
    49| 				'antispam_reload_command' => [
    50| 					'label' => lng('antispam.reload_command'),
    51| 					'settinggroup' => 'antispam',
    52| 					'varname' => 'reload_command',
    53| 					'type' => 'text',
    54| 					'string_regexp' => '/^[a-z0-9\/\._\- ]+$/i',
    55| 					'default' => 'service rspamd restart',
    56| 					'save_method' => 'storeSettingField',
    57| 					'required_otp' => true
    58| 				],
    59| 				'antispam_dkim_keylength' => [
    60| 					'label' => lng('antispam.dkim_keylength'),
    61| 					'settinggroup' => 'antispam',
    62| 					'varname' => 'dkim_keylength',
    63| 					'type' => 'select',
    64| 					'default' => '1024',
    65| 					'select_var' => [
    66| 						'1024' => '1024 Bit',
    67| 						'2048' => '2048 Bit'
    68| 					],
    69| 					'save_method' => 'storeSettingFieldInsertBindTask',
    70| 					'advanced_mode' => true,
    71| 				],
    72| 				'spf_use_spf' => [
    73| 					'label' => lng('spf.use_spf'),
    74| 					'settinggroup' => 'spf',
    75| 					'varname' => 'use_spf',
    76| 					'type' => 'checkbox',
    77| 					'default' => false,
    78| 					'save_method' => 'storeSettingField',
    79| 				],
    80| 				'spf_spf_entry' => [
    81| 					'label' => lng('spf.spf_entry'),
    82| 					'settinggroup' => 'spf',
    83| 					'varname' => 'spf_entry',
    84| 					'type' => 'text',
    85| 					'string_regexp' => '/^v=spf[a-z0-9:~?\s.-]+$/i',
    86| 					'default' => 'v=spf1 a mx -all',
    87| 					'save_method' => 'storeSettingField'
    88| 				],
    89| 				'dmarc_use_dmarc' => [
    90| 					'label' => lng('dmarc.use_dmarc'),
    91| 					'settinggroup' => 'dmarc',
    92| 					'varname' => 'use_dmarc',
    93| 					'type' => 'checkbox',
    94| 					'default' => false,
    95| 					'save_method' => 'storeSettingField',
    96| 				],
    97| 				'dmarc_dmarc_entry' => [
    98| 					'label' => lng('dmarc.dmarc_entry'),
    99| 					'settinggroup' => 'dmarc',
   100| 					'varname' => 'dmarc_entry',
   101| 					'type' => 'text',
   102| 					'string_regexp' => '/^v=dmarc1(.+)$/i',
   103| 					'default' => 'v=DMARC1; p=none;',
   104| 					'save_method' => 'storeSettingField'
   105| 				]


# ====================================================================
# FILE: admin_customers.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 263-304 ---
   263| 							'value' => $row['id']
   264| 						];
   265| 					} else {
   266| 						$phpconfigs[] = [
   267| 							'label' => $row['description'],
   268| 							'value' => $row['id']
   269| 						];
   270| 					}
   271| 				}
   272| 				$plans = Database::query("
   273| 					SELECT *
   274| 					FROM `" . TABLE_PANEL_PLANS . "`
   275| 					ORDER BY name ASC
   276| 				");
   277| 				$hosting_plans = [
   278| 					0 => "---"
   279| 				];
   280| 				while ($row = $plans->fetch(PDO::FETCH_ASSOC)) {
   281| 					$hosting_plans[$row['id']] = $row['name'];
   282| 				}
   283| 				$available_admins_stmt = Database::prepare("
   284| 					SELECT * FROM `" . TABLE_PANEL_ADMINS . "`
   285| 					WHERE (`customers` = '-1' OR `customers` > `customers_used`)
   286| 					AND adminid <> :currentadmin
   287| 				");
   288| 				Database::pexecute($available_admins_stmt, ['currentadmin' => $result['adminid']]);
   289| 				$admin_select = [
   290| 					0 => "---"
   291| 				];
   292| 				while ($available_admin = $available_admins_stmt->fetch()) {
   293| 					$admin_select[$available_admin['adminid']] = $available_admin['name'] . " (" . $available_admin['loginname'] . ")";
   294| 				}
   295| 				$customer_edit_data = include_once dirname(__FILE__) . '/lib/formfields/admin/customer/formfield.customer_edit.php';
   296| 				UI::view('user/form.html.twig', [
   297| 					'formaction' => $linker->getLink(['section' => 'customers', 'id' => $id]),
   298| 					'formdata' => $customer_edit_data['customer_edit'],
   299| 					'editid' => $id
   300| 				]);
   301| 			}
   302| 		}
   303| 	}
   304| }


# ====================================================================
# FILE: admin_domains.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 264-304 ---
   264| 		}
   265| 		$result = json_decode($json_result, true)['data'];
   266| 		if ($result['domain'] != '') {
   267| 			$subdomains_stmt = Database::prepare("
   268| 				SELECT COUNT(`id`) AS count FROM `" . TABLE_PANEL_DOMAINS . "` WHERE
   269| 				`parentdomainid` = :resultid
   270| 			");
   271| 			$subdomains = Database::pexecute_first($subdomains_stmt, [
   272| 				'resultid' => $result['id']
   273| 			]);
   274| 			$subdomains = $subdomains['count'];
   275| 			$alias_check_stmt = Database::prepare("
   276| 				SELECT COUNT(`id`) AS count FROM `" . TABLE_PANEL_DOMAINS . "` WHERE
   277| 				`aliasdomain` = :resultid
   278| 			");
   279| 			$alias_check = Database::pexecute_first($alias_check_stmt, [
   280| 				'resultid' => $result['id']
   281| 			]);
   282| 			$alias_check = $alias_check['count'];
   283| 			$domain_emails_result_stmt = Database::prepare("
   284| 				SELECT `email`, `email_full`, `destination`, `popaccountid` AS `number_email_forwarders`
   285| 				FROM `" . TABLE_MAIL_VIRTUAL . "` WHERE `customerid` = :customerid AND `domainid` = :id
   286| 			");
   287| 			Database::pexecute($domain_emails_result_stmt, [
   288| 				'customerid' => $result['customerid'],
   289| 				'id' => $result['id']
   290| 			]);
   291| 			$emails = Database::num_rows();
   292| 			$email_forwarders = 0;
   293| 			$email_accounts = 0;
   294| 			while ($domain_emails_row = $domain_emails_result_stmt->fetch(PDO::FETCH_ASSOC)) {
   295| 				if ($domain_emails_row['destination'] != '') {
   296| 					$domain_emails_row['destination'] = explode(' ', FileDir::makeCorrectDestination($domain_emails_row['destination']));
   297| 					$email_forwarders += count($domain_emails_row['destination']);
   298| 					if (in_array($domain_emails_row['email_full'], $domain_emails_row['destination'])) {
   299| 						$email_forwarders -= 1;
   300| 						$email_accounts++;
   301| 					}
   302| 				}
   303| 			}
   304| 			$ipsresult_stmt = Database::prepare("

# --- HUNK 2: Lines 508-547 ---
   508| 		$allowed_phpconfigs = Customer::getCustomerDetail($customerid, 'allowed_phpconfigs');
   509| 		echo !empty($allowed_phpconfigs) ? $allowed_phpconfigs : json_encode([]);
   510| 		exit();
   511| 	} elseif ($action == 'jqSpeciallogfileNote') {
   512| 		$domainid = intval(Request::post('id'));
   513| 		$newval = intval(Request::post('newval'));
   514| 		try {
   515| 			$json_result = Domains::getLocal($userinfo, [
   516| 				'id' => $domainid
   517| 			])->get();
   518| 		} catch (Exception $e) {
   519| 			Response::dynamicError($e->getMessage());
   520| 		}
   521| 		$result = json_decode($json_result, true)['data'];
   522| 		if ($newval != $result['speciallogfile']) {
   523| 			echo json_encode(['changed' => true, 'info' => lng('admin.speciallogwarning')]);
   524| 			exit();
   525| 		}
   526| 		echo 0;
   527| 		exit();
   528| 	} elseif ($action == 'import') {
   529| 		if (Request::post('send') == 'send') {
   530| 			$separator = Validate::validate(Request::post('separator'), 'separator');
   531| 			$offset = (int)Validate::validate(Request::post('offset'), 'offset', "/[0-9]/i");
   532| 			$file_name = $_FILES['file']['tmp_name'];
   533| 			$result = [];
   534| 			try {
   535| 				$bulk = new DomainBulkAction($file_name, $userinfo);
   536| 				$result = $bulk->doImport($separator, $offset);
   537| 			} catch (Exception $e) {
   538| 				Response::standardError('domain_import_error', $e->getMessage());
   539| 			}
   540| 			if (!empty($bulk->getErrors())) {
   541| 				Response::dynamicError(implode("<br>", $bulk->getErrors()));
   542| 			}
   543| 			User::updateCounters(false);
   544| 			Cronjob::inserttask(TaskId::REBUILD_VHOST);
   545| 			Cronjob::inserttask(TaskId::REBUILD_DNS);
   546| 			$result_str = $result['imported'] . ' / ' . $result['all'] . (!empty($result['note']) ? ' (' . $result['note'] . ')' : '');
   547| 			Response::standardSuccess('domain_import_successfully', $result_str, [


# ====================================================================
# FILE: customer_domains.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 109-149 ---
   109| 			}
   110| 		} else {
   111| 			Response::standardError('domains_cantdeletemaindomain');
   112| 		}
   113| 	} elseif ($action == 'add') {
   114| 		if ($userinfo['subdomains_used'] < $userinfo['subdomains'] || $userinfo['subdomains'] == '-1') {
   115| 			if (Request::post('send') == 'send') {
   116| 				try {
   117| 					SubDomains::getLocal($userinfo, Request::postAll())->add();
   118| 				} catch (Exception $e) {
   119| 					Response::dynamicError($e->getMessage());
   120| 				}
   121| 				Response::redirectTo($filename, [
   122| 					'page' => $page
   123| 				]);
   124| 			} else {
   125| 				$stmt = Database::prepare("SELECT `id`, `domain`, `documentroot`, `ssl_redirect`,`isemaildomain`,`letsencrypt` FROM `" . TABLE_PANEL_DOMAINS . "`
   126| 					WHERE `customerid` = :customerid
   127| 					AND `parentdomainid` = '0'
   128| 					AND `email_only` = '0'
   129| 					AND `caneditdomain` = '1'
   130| 					AND `deactivated` = '0'
   131| 					ORDER BY `domain` ASC");
   132| 				Database::pexecute($stmt, [
   133| 					"customerid" => $userinfo['customerid']
   134| 				]);
   135| 				$domains = [];
   136| 				while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
   137| 					$domains[$row['domain']] = $idna_convert->decode($row['domain']);
   138| 				}
   139| 				if (count($domains) <= 0) {
   140| 					Response::redirectTo($filename, [
   141| 						'page' => $page
   142| 					]);
   143| 				}
   144| 				$aliasdomains[0] = lng('domains.noaliasdomain');
   145| 				$domains_stmt = Database::prepare("SELECT `d`.`id`, `d`.`domain` FROM `" . TABLE_PANEL_DOMAINS . "` `d`, `" . TABLE_PANEL_CUSTOMERS . "` `c`
   146| 					WHERE `d`.`aliasdomain` IS NULL
   147| 					AND `d`.`id` <> `c`.`standardsubdomain`
   148| 					AND `d`.`parentdomainid` = '0'
   149| 					AND `d`.`customerid`=`c`.`customerid`


# ====================================================================
# FILE: customer_email.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 10-50 ---
    10|  *
    11|  * This program is distributed in the hope that it will be useful,
    12|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program; if not, you can also view it online at
    18|  * https://files.froxlor.org/misc/COPYING.txt
    19|  *
    20|  * @copyright  the authors
    21|  * @author     Froxlor team <team@froxlor.org>
    22|  * @license    https://files.froxlor.org/misc/COPYING.txt GPLv2
    23|  */
    24| const AREA = 'customer';
    25| require __DIR__ . '/lib/init.php';
    26| use Froxlor\Api\Commands\EmailAccounts;
    27| use Froxlor\Api\Commands\EmailDomains;
    28| use Froxlor\Api\Commands\EmailForwarders;
    29| use Froxlor\Api\Commands\Emails;
    30| use Froxlor\Cron\Mail\Rspamd;
    31| use Froxlor\CurrentUser;
    32| use Froxlor\Database\Database;
    33| use Froxlor\FroxlorLogger;
    34| use Froxlor\PhpHelper;
    35| use Froxlor\Settings;
    36| use Froxlor\UI\Collection;
    37| use Froxlor\UI\HTML;
    38| use Froxlor\UI\Listing;
    39| use Froxlor\UI\Panel\UI;
    40| use Froxlor\UI\Request;
    41| use Froxlor\UI\Response;
    42| use Froxlor\Validate\Check;
    43| if (Settings::IsInList('panel.customer_hide_options', 'email') || $userinfo['emails'] == 0) {
    44| 	Response::redirectTo('customer_index.php');
    45| }
    46| $id = (int)Request::any('id');
    47| if ($page == 'overview' || $page == 'emails') {
    48| 	$result_stmt = Database::prepare("
    49| 		SELECT COUNT(DISTINCT `domainid`) as maildomains FROM `" . TABLE_MAIL_VIRTUAL . "` WHERE `customerid`= :cid
    50| 	");

# --- HUNK 2: Lines 76-116 ---
    76| 		UI::view('user/table.html.twig', [
    77| 			'listing' => Listing::format($collection, $emaildomain_list_data, 'emaildomain_list'),
    78| 			'actions_links' => $actions_links,
    79| 		]);
    80| 	} else {
    81| 		$page = 'email_domain';
    82| 	}
    83| }
    84| if ($page == 'email_domain') {
    85| 	$email_domainid = Request::any('domainid', 0);
    86| 	if ($action == '') {
    87| 		$log->logAction(FroxlorLogger::USR_ACTION, LOG_INFO, "viewed customer_email::emails");
    88| 		$sql_search = [];
    89| 		if ($email_domainid > 0) {
    90| 			$sql_search = ['sql_search' => ['m.domainid' => ['op' => '=', 'value' => $email_domainid]]];
    91| 		}
    92| 		try {
    93| 			$email_list_data = include_once dirname(__FILE__) . '/lib/tablelisting/customer/tablelisting.emails.php';
    94| 			$collection = (new Collection(Emails::class, $userinfo, $sql_search))
    95| 				->withPagination($email_list_data['email_list']['columns'],
    96| 					$email_list_data['email_list']['default_sorting']);
    97| 		} catch (Exception $e) {
    98| 			Response::dynamicError($e->getMessage());
    99| 		}
   100| 		$result_stmt = Database::prepare("
   101| 			SELECT COUNT(`id`) as emaildomains
   102| 			FROM `" . TABLE_PANEL_DOMAINS . "`
   103| 			WHERE `customerid`= :cid AND `isemaildomain` = '1'
   104| 		");
   105| 		$result2 = Database::pexecute_first($result_stmt, [
   106| 			"cid" => $userinfo['customerid']
   107| 		]);
   108| 		$emaildomains_count = $result2['emaildomains'];
   109| 		$actions_links = [];
   110| 		if ($email_domainid > 0) {
   111| 			$actions_links[] = [
   112| 				'class' => 'btn-outline-primary',
   113| 				'href' => $linker->getLink([
   114| 					'section' => 'email',
   115| 					'page' => 'emails',
   116| 				]),


# ====================================================================
# FILE: customer_mysql.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 182-222 ---
   182| 					}
   183| 				} catch (Exception $e) {
   184| 					/* just none */
   185| 				}
   186| 				$mysql_edit_data = include_once dirname(__FILE__) . '/lib/formfields/customer/mysql/formfield.mysql_edit.php';
   187| 				UI::view('user/form.html.twig', [
   188| 					'formaction' => $linker->getLink(['section' => 'mysql', 'id' => $id]),
   189| 					'formdata' => $mysql_edit_data['mysql_edit'],
   190| 					'editid' => $id
   191| 				]);
   192| 			}
   193| 		}
   194| 	} elseif ($action == 'global_user') {
   195| 		$allowed_mysqlservers = json_decode($userinfo['allowed_mysqlserver'] ?? '[]', true);
   196| 		if ($userinfo['mysqls'] == 0 || empty($allowed_mysqlservers)) {
   197| 			Response::dynamicError('No permission');
   198| 		}
   199| 		if (Request::post('send') == 'send') {
   200| 			$new_password = Crypt::validatePassword(Request::post('mysql_password'));
   201| 			foreach ($allowed_mysqlservers as $dbserver) {
   202| 				Database::needRoot(true, $dbserver, false);
   203| 				$dbm = new DbManager($log);
   204| 				foreach (array_map('trim', explode(',', Settings::Get('system.mysql_access_host'))) as $mysql_access_host) {
   205| 					if ($dbm->getManager()->userExistsOnHost($userinfo['loginname'], $mysql_access_host)) {
   206| 						$dbm->getManager()->grantPrivilegesTo($userinfo['loginname'], $new_password, $mysql_access_host, false, true, true);
   207| 					} else {
   208| 						$dbm->getManager()->grantPrivilegesTo($userinfo['loginname'], $new_password, $mysql_access_host, false, false, true);
   209| 					}
   210| 				}
   211| 				$dbm->getManager()->flushPrivileges();
   212| 			}
   213| 			Response::redirectTo($filename, [
   214| 				'page' => 'overview'
   215| 			]);
   216| 		} else {
   217| 			$mysql_global_user_data = include_once dirname(__FILE__) . '/lib/formfields/customer/mysql/formfield.mysql_global_user.php';
   218| 			UI::view('user/form.html.twig', [
   219| 				'formaction' => $linker->getLink(['section' => 'mysql', 'page' => 'mysqls', 'action' => 'global_user']),
   220| 				'formdata' => $mysql_global_user_data['mysql_global_user'],
   221| 				'editid' => $id
   222| 			]);


# ====================================================================
# FILE: install/froxlor.sql.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 348-387 ---
   348| ) ENGINE=InnoDB CHARSET=utf8 COLLATE=utf8_general_ci;
   349| INSERT INTO `panel_settings` (`settinggroup`, `varname`, `value`) VALUES
   350| 	('catchall', 'catchall_enabled', '1'),
   351| 	('session', 'allow_multiple_login', '0'),
   352| 	('session', 'sessiontimeout', '600'),
   353| 	('customer', 'accountprefix', 'web'),
   354| 	('customer', 'ftpprefix', 'ftp'),
   355| 	('customer', 'mysqlprefix', 'sql'),
   356| 	('customer', 'ftpatdomain', '0'),
   357| 	('customer', 'show_news_feed', '0'),
   358| 	('customer', 'news_feed_url', ''),
   359| 	('logger', 'enabled', '1'),
   360| 	('logger', 'log_cron', '0'),
   361| 	('logger', 'logfile', ''),
   362| 	('logger', 'logtypes', 'syslog,mysql'),
   363| 	('logger', 'severity', '1'),
   364| 	('antispam', 'activated', '0'),
   365| 	('antispam', 'config_file', '/etc/rspamd/local.d/froxlor_settings.conf'),
   366| 	('antispam', 'reload_command', 'service rspamd restart'),
   367| 	('antispam', 'dkim_keylength', '1024'),
   368| 	('admin', 'show_news_feed', '0'),
   369| 	('admin', 'show_version_login', '0'),
   370| 	('admin', 'show_version_footer', '0'),
   371| 	('caa', 'caa_entry', ''),
   372| 	('spf', 'use_spf', '0'),
   373| 	('spf', 'spf_entry', 'v=spf1 a mx -all'),
   374| 	('dmarc', 'use_dmarc', '0'),
   375| 	('dmarc', 'dmarc_entry', 'v=DMARC1; p=none;'),
   376| 	('defaultwebsrverrhandler', 'enabled', '0'),
   377| 	('defaultwebsrverrhandler', 'err401', ''),
   378| 	('defaultwebsrverrhandler', 'err403', ''),
   379| 	('defaultwebsrverrhandler', 'err404', ''),
   380| 	('defaultwebsrverrhandler', 'err500', ''),
   381| 	('customredirect', 'enabled', '1'),
   382| 	('customredirect', 'default', '1'),
   383| 	('perl', 'suexecworkaround', '0'),
   384| 	('perl', 'suexecpath', '/var/www/cgi-bin/'),
   385| 	('login', 'domain_login', '0'),
   386| 	('login', 'maxloginattempts', '3'),
   387| 	('login', 'deactivatetime', '900'),

# --- HUNK 2: Lines 687-728 ---
   687| 	('panel', 'phpconfigs_hidestdsubdomain', '0'),
   688| 	('panel', 'phpconfigs_hidesubdomains', '1'),
   689| 	('panel', 'allow_theme_change_admin', '1'),
   690| 	('panel', 'allow_theme_change_customer', '1'),
   691| 	('panel', 'password_alpha_lower', '1'),
   692| 	('panel', 'password_alpha_upper', '1'),
   693| 	('panel', 'password_numeric', '0'),
   694| 	('panel', 'password_special_char_required', '0'),
   695| 	('panel', 'password_special_char', '!?<>ยง$%+#=@'),
   696| 	('panel', 'customer_hide_options', ''),
   697| 	('panel', 'is_configured', '0'),
   698| 	('panel', 'imprint_url', ''),
   699| 	('panel', 'terms_url', ''),
   700| 	('panel', 'privacy_url', ''),
   701| 	('panel', 'logo_image_header', ''),
   702| 	('panel', 'logo_image_login', ''),
   703| 	('panel', 'logo_overridetheme', '0'),
   704| 	('panel', 'logo_overridecustom', '0'),
   705| 	('panel', 'settings_mode', '0'),
   706| 	('panel', 'menu_collapsed', '1'),
   707| 	('panel', 'version', '2.2.5'),
   708| 	('panel', 'db_version', '202409280');
   709| DROP TABLE IF EXISTS `panel_tasks`;
   710| CREATE TABLE `panel_tasks` (
   711|   `id` int(11) unsigned NOT NULL auto_increment,
   712|   `type` int(11) NOT NULL default '0',
   713|   `data` text,
   714|   PRIMARY KEY  (`id`)
   715| ) ENGINE=InnoDB CHARSET=utf8 COLLATE=utf8_general_ci;
   716| INSERT INTO `panel_tasks` (`type`) VALUES ('99');
   717| DROP TABLE IF EXISTS `panel_templates`;
   718| CREATE TABLE `panel_templates` (
   719|   `id` int(11) NOT NULL auto_increment,
   720|   `adminid` int(11) NOT NULL default '0',
   721|   `language` varchar(255) NOT NULL default '',
   722|   `templategroup` varchar(255) NOT NULL default '',
   723|   `varname` varchar(255) NOT NULL default '',
   724|   `value` longtext NOT NULL,
   725|   `file_extension` varchar(50) NOT NULL default 'html',
   726|   PRIMARY KEY  (id),
   727|   KEY adminid (adminid)
   728| ) ENGINE=InnoDB CHARSET=utf8 COLLATE=utf8_general_ci;


# ====================================================================
# FILE: install/updates/froxlor/update_2.2.inc.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 5-45 ---
     5|  *
     6|  * This program is free software; you can redistribute it and/or
     7|  * modify it under the terms of the GNU General Public License
     8|  * as published by the Free Software Foundation; either version 2
     9|  * of the License, or (at your option) any later version.
    10|  *
    11|  * This program is distributed in the hope that it will be useful,
    12|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program; if not, you can also view it online at
    18|  * https://files.froxlor.org/misc/COPYING.txt
    19|  *
    20|  * @copyright  the authors
    21|  * @author     Froxlor team <team@froxlor.org>
    22|  * @license    https://files.froxlor.org/misc/COPYING.txt GPLv2
    23|  */
    24| use Froxlor\Database\Database;
    25| use Froxlor\Froxlor;
    26| use Froxlor\Install\Update;
    27| use Froxlor\Settings;
    28| if (!defined('_CRON_UPDATE')) {
    29| 	if (!defined('AREA') || (defined('AREA') && AREA != 'admin') || !isset($userinfo['loginname']) || (isset($userinfo['loginname']) && $userinfo['loginname'] == '')) {
    30| 		header('Location: ../../../../index.php');
    31| 		exit();
    32| 	}
    33| }
    34| if (Froxlor::isFroxlorVersion('2.1.9')) {
    35| 	Update::showUpdateStep("Enhancing virtual email table");
    36| 	Database::query("ALTER TABLE `" . TABLE_MAIL_VIRTUAL . "` ADD `spam_tag_level` float(4,1) NOT NULL DEFAULT 7.0;");
    37| 	Database::query("ALTER TABLE `" . TABLE_MAIL_VIRTUAL . "` ADD `spam_kill_level` float(4,1) NOT NULL DEFAULT 14.0;");
    38| 	Database::query("ALTER TABLE `" . TABLE_MAIL_VIRTUAL . "` ADD `bypass_spam` tinyint(1) NOT NULL default '0';");
    39| 	Database::query("ALTER TABLE `" . TABLE_MAIL_VIRTUAL . "` ADD `policy_greylist` tinyint(1) NOT NULL default '1';");
    40| 	Update::lastStepStatus(0);
    41| 	Update::showUpdateStep("Adjusting settings");
    42| 	$antispam_activated = $_POST['antispam_activated'] ?? 0;
    43| 	Database::query("UPDATE `" . TABLE_PANEL_SETTINGS . "` SET `settinggroup` = 'antispam', `varname` = 'activated', `value` = '" . (int)$antispam_activated . "' WHERE `settinggroup` = 'dkim' AND `varname` = 'use_dkim';");
    44| 	Database::query("UPDATE `" . TABLE_PANEL_SETTINGS . "` SET `settinggroup` = 'antispam', `varname` = 'reload_command', `value` = 'service rspamd restart' WHERE `settinggroup` = 'dkim' AND `varname` = 'dkimrestart_command';");
    45| 	Database::query("UPDATE `" . TABLE_PANEL_SETTINGS . "` SET `settinggroup` = 'antispam', `varname` = 'config_file', `value` = '/etc/rspamd/local.d/froxlor_settings.conf' WHERE `settinggroup` = 'dkim' AND `varname` = 'dkim_prefix';");

# --- HUNK 2: Lines 150-169 ---
   150| 	Database::query("ALTER TABLE `" . TABLE_MAIL_VIRTUAL . "` ADD `rewrite_subject` tinyint(1) NOT NULL default '1' AFTER `spam_tag_level`;");
   151| 	Update::lastStepStatus(0);
   152| 	Froxlor::updateToDbVersion('202409280');
   153| }
   154| if (Froxlor::isFroxlorVersion('2.2.1')) {
   155| 	Update::showUpdateStep("Updating from 2.2.1 to 2.2.2", false);
   156| 	Froxlor::updateToVersion('2.2.2');
   157| }
   158| if (Froxlor::isFroxlorVersion('2.2.2')) {
   159| 	Update::showUpdateStep("Updating from 2.2.2 to 2.2.3", false);
   160| 	Froxlor::updateToVersion('2.2.3');
   161| }
   162| if (Froxlor::isFroxlorVersion('2.2.3')) {
   163| 	Update::showUpdateStep("Updating from 2.2.3 to 2.2.4", false);
   164| 	Froxlor::updateToVersion('2.2.4');
   165| }
   166| if (Froxlor::isFroxlorVersion('2.2.4')) {
   167| 	Update::showUpdateStep("Updating from 2.2.4 to 2.2.5", false);
   168| 	Froxlor::updateToVersion('2.2.5');
   169| }


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Admins.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 242-291 ---
   242| 				$email_quota = -1;
   243| 			}
   244| 			$password = Validate::validate($password, 'password', '', '', [], true);
   245| 			if ($password != '') {
   246| 				$password = Crypt::validatePassword($password, true);
   247| 			}
   248| 			$diskspace *= 1024;
   249| 			$traffic *= 1024 * 1024;
   250| 			$loginname_check_stmt = Database::prepare("
   251| 				SELECT `loginname` FROM `" . TABLE_PANEL_CUSTOMERS . "` WHERE `loginname` = :login
   252| 			");
   253| 			$loginname_check = Database::pexecute_first($loginname_check_stmt, [
   254| 				'login' => $loginname
   255| 			], true, true);
   256| 			$loginname_check_admin_stmt = Database::prepare("
   257| 				SELECT `loginname` FROM `" . TABLE_PANEL_ADMINS . "` WHERE `loginname` = :login
   258| 			");
   259| 			$loginname_check_admin = Database::pexecute_first($loginname_check_admin_stmt, [
   260| 				'login' => $loginname
   261| 			], true, true);
   262| 			if (($loginname_check && strtolower($loginname_check['loginname']) == strtolower($loginname)) || ($loginname_check_admin && strtolower($loginname_check_admin['loginname']) == strtolower($loginname))) {
   263| 				Response::standardError('loginnameexists', $loginname, true);
   264| 			} elseif (preg_match('/^' . preg_quote(Settings::Get('customer.accountprefix'), '/') . '([0-9]+)/', $loginname)) {
   265| 				Response::standardError('loginnameisusingprefix', Settings::Get('customer.accountprefix'), true);
   266| 			} elseif (function_exists('posix_getpwnam') && !in_array("posix_getpwnam", explode(",", ini_get('disable_functions'))) && posix_getpwnam($loginname)) {
   267| 				Response::standardError('loginnameissystemaccount', $loginname, true);
   268| 			} elseif (!Validate::validateUsername($loginname)) {
   269| 				Response::standardError('loginnameiswrong', $loginname, true);
   270| 			} elseif (!Validate::validateEmail($email)) {
   271| 				Response::standardError('emailiswrong', $email, true);
   272| 			} else {
   273| 				if ($customers_see_all != '1') {
   274| 					$customers_see_all = '0';
   275| 				}
   276| 				if ($caneditphpsettings != '1') {
   277| 					$caneditphpsettings = '0';
   278| 				}
   279| 				if ($change_serversettings != '1') {
   280| 					$change_serversettings = '0';
   281| 				}
   282| 				if ($password == '') {
   283| 					$password = Crypt::generatePassword();
   284| 				}
   285| 				$_theme = Settings::Get('panel.default_theme');
   286| 				$ins_data = [
   287| 					'loginname' => $loginname,
   288| 					'password' => Crypt::makeCryptPassword($password),
   289| 					'name' => $name,
   290| 					'email' => $email,
   291| 					'lang' => $def_language,

# --- HUNK 2: Lines 539-580 ---
   539| 				$theme = Validate::validate($theme, 'theme', '', '', [], true);
   540| 				$password = Validate::validate($password, 'password', '', '', [], true);
   541| 				if (Settings::Get('system.mail_quota_enabled') != '1') {
   542| 					$email_quota = -1;
   543| 				}
   544| 				if (empty($theme)) {
   545| 					$theme = Settings::Get('panel.default_theme');
   546| 				}
   547| 				if (empty(trim($name))) {
   548| 					Response::standardError([
   549| 						'stringisempty',
   550| 						'admin.name'
   551| 					], '', true);
   552| 				}
   553| 				if (empty(trim($email))) {
   554| 					Response::standardError([
   555| 						'stringisempty',
   556| 						'admin.email'
   557| 					], '', true);
   558| 				}
   559| 				if (!Validate::validateEmail($email)) {
   560| 					Response::standardError('emailiswrong', $email, true);
   561| 				} else {
   562| 					if ($deactivated != '1') {
   563| 						$deactivated = '0';
   564| 					}
   565| 					if ($customers_see_all != '1') {
   566| 						$customers_see_all = '0';
   567| 					}
   568| 					if ($caneditphpsettings != '1') {
   569| 						$caneditphpsettings = '0';
   570| 					}
   571| 					if ($change_serversettings != '1') {
   572| 						$change_serversettings = '0';
   573| 					}
   574| 					if ($password != '') {
   575| 						$password = Crypt::validatePassword($password, true);
   576| 						$password = Crypt::makeCryptPassword($password);
   577| 					} else {
   578| 						$password = $result['password'];
   579| 					}
   580| 					$res_warning = "";


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Customers.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 442-490 ---
   442| 						$login_blacklist = array_unique($login_blacklist);
   443| 						if (in_array($loginname, $login_blacklist)) {
   444| 							Response::standardError('loginnameisreservedname', $loginname, true);
   445| 						}
   446| 					} else {
   447| 						$accountnumber = intval(Settings::Get('system.lastaccountnumber')) + 1;
   448| 						$loginname = Settings::Get('customer.accountprefix') . $accountnumber;
   449| 					}
   450| 					$loginname_check_stmt = Database::prepare("
   451| 						SELECT `loginname` FROM `" . TABLE_PANEL_CUSTOMERS . "` WHERE `loginname` = :login
   452| 					");
   453| 					$loginname_check = Database::pexecute_first($loginname_check_stmt, [
   454| 						'login' => $loginname
   455| 					], true, true);
   456| 					$loginname_check_admin_stmt = Database::prepare("
   457| 						SELECT `loginname` FROM `" . TABLE_PANEL_ADMINS . "` WHERE `loginname` = :login
   458| 					");
   459| 					$loginname_check_admin = Database::pexecute_first($loginname_check_admin_stmt, [
   460| 						'login' => $loginname
   461| 					], true, true);
   462| 					$mysql_maxlen = Database::getSqlUsernameLength() - strlen(Settings::Get('customer.mysqlprefix'));
   463| 					if (($loginname_check && strtolower($loginname_check['loginname']) == strtolower($loginname)) || ($loginname_check_admin && strtolower($loginname_check_admin['loginname']) == strtolower($loginname))) {
   464| 						Response::standardError('loginnameexists', $loginname, true);
   465| 					} elseif (!Validate::validateUsername($loginname, Settings::Get('panel.unix_names'), $mysql_maxlen)) {
   466| 						if (strlen($loginname) > $mysql_maxlen) {
   467| 							Response::standardError('loginnameiswrong2', $mysql_maxlen, true);
   468| 						} else {
   469| 							Response::standardError('loginnameiswrong', $loginname, true);
   470| 						}
   471| 					}
   472| 					$guid = intval(Settings::Get('system.lastguid')) + 1;
   473| 					$documentroot = FileDir::makeCorrectDir(Settings::Get('system.documentroot_prefix') . '/' . $loginname);
   474| 					if (file_exists($documentroot)) {
   475| 						Response::standardError('documentrootexists', $documentroot, true);
   476| 					}
   477| 					if ($password == '') {
   478| 						$password = Crypt::generatePassword();
   479| 					}
   480| 					$_theme = Settings::Get('panel.default_theme');
   481| 					$ins_data = [
   482| 						'adminid' => $this->getUserDetail('adminid'),
   483| 						'loginname' => $loginname,
   484| 						'passwd' => Crypt::makeCryptPassword($password),
   485| 						'name' => $name,
   486| 						'firstname' => $firstname,
   487| 						'gender' => $gender,
   488| 						'company' => $company,
   489| 						'street' => $street,
   490| 						'zipcode' => $zipcode,

# --- HUNK 2: Lines 659-699 ---
   659| 						try {
   660| 							$std_domain = $this->apiCall('Domains.add', $ins_data, true);
   661| 							$domainid = $std_domain['id'];
   662| 						} catch (Exception $e) {
   663| 							$this->logger()->logAction(FroxlorLogger::ADM_ACTION, LOG_ERR, "[API] Unable to add standard-subdomain: " . $e->getMessage());
   664| 						}
   665| 						if ($domainid > 0) {
   666| 							$upd_stmt = Database::prepare("
   667| 								UPDATE `" . TABLE_PANEL_CUSTOMERS . "` SET `standardsubdomain` = :domainid WHERE `customerid` = :customerid
   668| 							");
   669| 							Database::pexecute($upd_stmt, [
   670| 								'domainid' => $domainid,
   671| 								'customerid' => $customerid
   672| 							], true, true);
   673| 							$this->logger()->logAction(FroxlorLogger::ADM_ACTION, LOG_NOTICE, "[API] automatically added standardsubdomain for user '" . $loginname . "'");
   674| 							Cronjob::inserttask(TaskId::REBUILD_VHOST);
   675| 						}
   676| 					}
   677| 					if ($mysqls != 0) {
   678| 						foreach ($allowed_mysqlserver as $dbserver) {
   679| 							Database::needRoot(true, $dbserver, false);
   680| 							$dbm = new DbManager($this->logger());
   681| 							foreach (array_map('trim', explode(',', Settings::Get('system.mysql_access_host'))) as $mysql_access_host) {
   682| 								$dbm->getManager()->grantPrivilegesTo($loginname, $password, $mysql_access_host, false, false, true);
   683| 							}
   684| 							$dbm->getManager()->flushPrivileges();
   685| 							Database::needRoot(false);
   686| 						}
   687| 					}
   688| 					if ($sendpassword == '1') {
   689| 						$srv_hostname = Settings::Get('system.hostname');
   690| 						if (Settings::Get('system.froxlordirectlyviahostname') == '0') {
   691| 							$srv_hostname .= '/' . basename(\Froxlor\Froxlor::getInstallDir());
   692| 						}
   693| 						$srv_ip_stmt = Database::prepare("
   694| 							SELECT ip, port FROM `" . TABLE_PANEL_IPSANDPORTS . "`
   695| 							WHERE `id` = :defaultip
   696| 						");
   697| 						$default_ips = Settings::Get('system.defaultip');
   698| 						$default_ips = explode(',', $default_ips);
   699| 						$srv_ip = Database::pexecute_first($srv_ip_stmt, [

# --- HUNK 3: Lines 712-752 ---
   712| 							'USERNAME' => $loginname,
   713| 							'PASSWORD' => $password,
   714| 							'SERVER_HOSTNAME' => $srv_hostname,
   715| 							'SERVER_IP' => $srv_ip['ip'] ?? '',
   716| 							'SERVER_PORT' => $srv_ip['port'] ?? '',
   717| 							'DOMAINNAME' => $_stdsubdomain
   718| 						];
   719| 						$mail_subject = $this->getMailTemplate([
   720| 							'adminid' => $this->getUserDetail('adminid'),
   721| 							'def_language' => $def_language
   722| 						], 'mails', 'createcustomer_subject', $replace_arr, lng('mails.createcustomer.subject'));
   723| 						$mail_body = $this->getMailTemplate([
   724| 							'adminid' => $this->getUserDetail('adminid'),
   725| 							'def_language' => $def_language
   726| 						], 'mails', 'createcustomer_mailbody', $replace_arr, lng('mails.createcustomer.mailbody'));
   727| 						$_mailerror = false;
   728| 						$mailerr_msg = "";
   729| 						try {
   730| 							$this->mailer()->Subject = $mail_subject;
   731| 							$this->mailer()->AltBody = $mail_body;
   732| 							$this->mailer()->msgHTML(str_replace("\n", "<br />", $mail_body));
   733| 							$this->mailer()->addAddress($email, User::getCorrectUserSalutation([
   734| 								'firstname' => $firstname,
   735| 								'name' => $name,
   736| 								'company' => $company
   737| 							]));
   738| 							$this->mailer()->send();
   739| 						} catch (\PHPMailer\PHPMailer\Exception $e) {
   740| 							$mailerr_msg = $e->errorMessage();
   741| 							$_mailerror = true;
   742| 						} catch (Exception $e) {
   743| 							$mailerr_msg = $e->getMessage();
   744| 							$_mailerror = true;
   745| 						}
   746| 						if ($_mailerror) {
   747| 							$this->logger()->logAction(FroxlorLogger::ADM_ACTION, LOG_ERR, "[API] Error sending mail: " . $mailerr_msg);
   748| 							Response::standardError('errorsendingmail', $email, true);
   749| 						}
   750| 						$this->mailer()->clearAddresses();
   751| 						$this->logger()->logAction(FroxlorLogger::ADM_ACTION, LOG_NOTICE, "[API] automatically sent password to user '" . $loginname . "'");
   752| 					}

# --- HUNK 4: Lines 976-1016 ---
   976| 	 * @access admin, customer
   977| 	 * @return string json-encoded array
   978| 	 * @throws Exception
   979| 	 */
   980| 	public function update()
   981| 	{
   982| 		$id = $this->getParam('id', true, 0);
   983| 		$ln_optional = $id > 0;
   984| 		$loginname = $this->getParam('loginname', $ln_optional, '');
   985| 		$result = $this->apiCall('Customers.get', [
   986| 			'id' => $id,
   987| 			'loginname' => $loginname
   988| 		]);
   989| 		$id = $result['customerid'];
   990| 		if ($this->isAdmin()) {
   991| 			$move_to_admin = (int)($this->getParam('move_to_admin', true, 0));
   992| 			$idna_convert = new IdnaWrapper();
   993| 			$email = $this->getParam('email', true, $idna_convert->decode($result['email']));
   994| 			$name = $this->getParam('name', true, $result['name']);
   995| 			$firstname = $this->getParam('firstname', true, $result['firstname']);
   996| 			$company_required = (!empty($name) && empty($firstname)) || (empty($name) && !empty($firstname)) || (empty($name) && empty($firstname));
   997| 			$company = $this->getParam('company', !$company_required, $result['company']);
   998| 			$street = $this->getParam('street', true, $result['street']);
   999| 			$zipcode = $this->getParam('zipcode', true, $result['zipcode']);
  1000| 			$city = $this->getParam('city', true, $result['city']);
  1001| 			$phone = $this->getParam('phone', true, $result['phone']);
  1002| 			$fax = $this->getParam('fax', true, $result['fax']);
  1003| 			$customernumber = $this->getParam('customernumber', true, $result['customernumber']);
  1004| 			$def_language = $this->getParam('def_language', true, $result['def_language']);
  1005| 			$gui_access = $this->getBoolParam('gui_access', true, $result['gui_access']);
  1006| 			$api_allowed = $this->getBoolParam('api_allowed', true, $result['api_allowed']);
  1007| 			$gender = (int)$this->getParam('gender', true, $result['gender']);
  1008| 			$custom_notes = $this->getParam('custom_notes', true, $result['custom_notes']);
  1009| 			$custom_notes_show = $this->getBoolParam('custom_notes_show', true, $result['custom_notes_show']);
  1010| 			$dec_places = Settings::Get('panel.decimal_places');
  1011| 			$diskspace = $this->getUlParam('diskspace', 'diskspace_ul', true, round($result['diskspace'] / 1024, $dec_places));
  1012| 			$traffic = $this->getUlParam('traffic', 'traffic_ul', true, round($result['traffic'] / (1024 * 1024), $dec_places));
  1013| 			$subdomains = $this->getUlParam('subdomains', 'subdomains_ul', true, $result['subdomains']);
  1014| 			$emails = $this->getUlParam('emails', 'emails_ul', true, $result['emails']);
  1015| 			$email_accounts = $this->getUlParam('email_accounts', 'email_accounts_ul', true, $result['email_accounts']);
  1016| 			$email_forwarders = $this->getUlParam('email_forwarders', 'email_forwarders_ul', true, $result['email_forwarders']);

# --- HUNK 5: Lines 1098-1137 ---
  1098| 				$to_remove_mysqlserver = array_diff($former_allowed_mysqlserver, $allowed_mysqlserver);
  1099| 				if (count($to_remove_mysqlserver) > 0) {
  1100| 					foreach ($to_remove_mysqlserver as $mysqlserver_check) {
  1101| 						$result_ms = $this->apiCall('MysqlServer.databasesOnServer', [
  1102| 							'mysql_server' => $mysqlserver_check,
  1103| 							'customerid' => $id
  1104| 						]);
  1105| 						if ($result_ms['count'] > 0) {
  1106| 							Response::standardError('mysqlserverstillhasdbs', '', true);
  1107| 						}
  1108| 					}
  1109| 				}
  1110| 			}
  1111| 			if ($email == '') {
  1112| 				Response::standardError([
  1113| 					'stringisempty',
  1114| 					'customer.email'
  1115| 				], '', true);
  1116| 			} elseif (!Validate::validateEmail($email)) {
  1117| 				Response::standardError('emailiswrong', $email, true);
  1118| 			}
  1119| 		}
  1120| 		if ($password != '') {
  1121| 			$password = Crypt::validatePassword($password, true);
  1122| 			$password = Crypt::makeCryptPassword($password);
  1123| 		} else {
  1124| 			$password = $result['password'];
  1125| 		}
  1126| 		if ($this->isAdmin()) {
  1127| 			if ($createstdsubdomain != '1' || $deactivated) {
  1128| 				$createstdsubdomain = '0';
  1129| 			}
  1130| 			if ($createstdsubdomain == '1' && $result['standardsubdomain'] == '0') {
  1131| 				if (Settings::Get('system.stdsubdomain') !== null && Settings::Get('system.stdsubdomain') != '') {
  1132| 					$_stdsubdomain = $result['loginname'] . '.' . Settings::Get('system.stdsubdomain');
  1133| 				} else {
  1134| 					$_stdsubdomain = $result['loginname'] . '.' . Settings::Get('system.hostname');
  1135| 				}
  1136| 				$ins_data = [
  1137| 					'domain' => $_stdsubdomain,

# --- HUNK 6: Lines 1187-1227 ---
  1187| 					'pop3' => $pop3,
  1188| 					'imap' => $imap,
  1189| 					'customerid' => $id
  1190| 				]);
  1191| 				$upd_stmt = Database::prepare("
  1192| 					UPDATE `" . TABLE_FTP_USERS . "` SET `login_enabled` = :yesno WHERE `customerid` = :customerid
  1193| 				");
  1194| 				Database::pexecute($upd_stmt, [
  1195| 					'yesno' => $yesno,
  1196| 					'customerid' => $id
  1197| 				]);
  1198| 				$upd_stmt = Database::prepare("
  1199| 					UPDATE `" . TABLE_PANEL_DOMAINS . "` SET `deactivated`= :deactivated WHERE `customerid` = :customerid
  1200| 				");
  1201| 				Database::pexecute($upd_stmt, [
  1202| 					'deactivated' => $deactivated,
  1203| 					'customerid' => $id
  1204| 				]);
  1205| 				$current_allowed_mysqlserver =  isset($result['allowed_mysqlserver']) && !empty($result['allowed_mysqlserver']) ? json_decode($result['allowed_mysqlserver'], true) : [];
  1206| 				foreach ($current_allowed_mysqlserver as $dbserver) {
  1207| 					Database::needRoot(true, $dbserver, false);
  1208| 					$dbm = new DbManager($this->logger());
  1209| 					foreach (array_map('trim', explode(',', Settings::Get('system.mysql_access_host'))) as $mysql_access_host) {
  1210| 						if ($deactivated) {
  1211| 							$dbm->getManager()->disableUser($result['loginname'], $mysql_access_host);
  1212| 						} else {
  1213| 							$dbm->getManager()->enableUser($result['loginname'], $mysql_access_host, true);
  1214| 						}
  1215| 					}
  1216| 					$dbm->getManager()->flushPrivileges();
  1217| 					Database::needRoot(false);
  1218| 				}
  1219| 				$databases_stmt = Database::prepare("SELECT * FROM " . TABLE_PANEL_DATABASES . " WHERE customerid = :customerid ORDER BY `dbserver`");
  1220| 				Database::pexecute($databases_stmt, [
  1221| 					'customerid' => $id
  1222| 				]);
  1223| 				Database::needRoot(true);
  1224| 				$last_dbserver = 0;
  1225| 				$dbm = new DbManager($this->logger());
  1226| 				$priv_changed = false;
  1227| 				while ($row_database = $databases_stmt->fetch(PDO::FETCH_ASSOC)) {


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/DomainZones.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 128-168 ---
   128| 		}
   129| 		if ($type == 'A' && filter_var($content, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4) === false) {
   130| 			$errors[] = lng('error.dns_arec_noipv4');
   131| 		} elseif ($type == 'A') {
   132| 			foreach ($dom_entries as $existing_entries) {
   133| 				if ($existing_entries['type'] == 'CNAME' && $existing_entries['record'] == $record) {
   134| 					$errors[] = lng('error.dns_other_nomorerr');
   135| 					break;
   136| 				}
   137| 			}
   138| 		} elseif ($type == 'AAAA' && filter_var($content, FILTER_VALIDATE_IP, FILTER_FLAG_IPV6) === false) {
   139| 			$errors[] = lng('error.dns_aaaarec_noipv6');
   140| 		} elseif ($type == 'AAAA') {
   141| 			foreach ($dom_entries as $existing_entries) {
   142| 				if ($existing_entries['type'] == 'CNAME' && $existing_entries['record'] == $record) {
   143| 					$errors[] = lng('error.dns_other_nomorerr');
   144| 					break;
   145| 				}
   146| 			}
   147| 		} elseif ($type == 'CAA' && !empty($content)) {
   148| 			$re = '/(?\'critical\'\d)\h*(?\'type\'iodef|issue|issuewild)\h*(?\'value\'(?\'issuevalue\'"(?\'domain\'(?=.{3,128}$)(?>(?>[a-zA-Z0-9]+[a-zA-Z0-9-]*[a-zA-Z0-9]+|[a-zA-Z0-9]+)\.)*(?>[a-zA-Z]{2,}|[a-zA-Z0-9]{2,}\.[a-zA-Z]{2,}))[;\h]*(?\'parameters\'(?>[a-zA-Z0-9]{1,60}=[a-zA-Z0-9]{1,60}\h*)+)?")|(?\'iodefvalue\'"(?\'url\'(mailto:.*|http:\/\/.*|https:\/\/.*))"))/';
   149| 			preg_match($re, $content, $matches);
   150| 			if (empty($matches)) {
   151| 				$errors[] = lng('error.dns_content_invalid');
   152| 			} elseif (($matches['type'] == 'issue' || $matches['type'] == 'issuewild') && !Validate::validateDomain($matches['domain'])) {
   153| 				$errors[] = lng('error.dns_content_invalid');
   154| 			} elseif ($matches['type'] == 'iodef' && !Validate::validateUrl($matches['url'])) {
   155| 				$errors[] = lng('error.dns_content_invalid');
   156| 			} else {
   157| 				$content = $matches[0];
   158| 			}
   159| 		} elseif ($type == 'CNAME' || $type == 'DNAME') {
   160| 			if (substr($content, -1) == '.') {
   161| 				$content = substr($content, 0, -1);
   162| 			} else {
   163| 				$content .= '.' . $domain;
   164| 			}
   165| 			if (!Validate::validateDomain($content, true)) {
   166| 				$errors[] = lng('error.dns_cname_invaliddom');
   167| 			} else {
   168| 				foreach ($dom_entries as $existing_entries) {


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Domains.php
# Total hunks: 9
# ====================================================================
# --- HUNK 1: Lines 173-213 ---
   173| 	 *            optional, allow email usage with this domain, default 0 (false)
   174| 	 * @param bool $email_only
   175| 	 *            optional, restrict domain to email usage, default 0 (false)
   176| 	 * @param int $selectserveralias
   177| 	 *            optional, 0 = wildcard, 1 = www-alias, 2 = none, default [system.domaindefaultalias]
   178| 	 * @param bool $speciallogfile
   179| 	 *            optional, whether to create an exclusive web-logfile for this domain, default 0 (false)
   180| 	 * @param int $alias
   181| 	 *            optional, domain-id of a domain that the new domain should be an alias of, default 0 (none)
   182| 	 * @param string $registration_date
   183| 	 *            optional, date of domain registration in form of YYYY-MM-DD, default empty (none)
   184| 	 * @param string $termination_date
   185| 	 *            optional, date of domain termination in form of YYYY-MM-DD, default empty (none)
   186| 	 * @param bool $caneditdomain
   187| 	 *            optional, whether to allow the customer to edit domain settings, default 0 (false)
   188| 	 * @param bool $isbinddomain
   189| 	 *            optional, whether to generate a dns-zone or not (only of nameserver is activated), default 0 (false)
   190| 	 * @param string $zonefile
   191| 	 *            optional, custom dns zone filename (only of nameserver is activated), default empty (auto-generated)
   192| 	 * @param bool $dkim
   193| 	 *            optional, currently not in use, default 0 (false)
   194| 	 * @param string $specialsettings
   195| 	 *            optional, custom webserver vhost-content which is added to the generated vhost, default empty
   196| 	 * @param string $ssl_specialsettings
   197| 	 *            optional, custom webserver vhost-content which is added to the generated ssl-vhost, default empty
   198| 	 * @param bool $include_specialsettings
   199| 	 *            optional, whether to include non-ssl specialsettings in the generated ssl-vhost, default false
   200| 	 * @param bool $notryfiles
   201| 	 *            optional, [nginx only] do not generate the default try-files directive, default 0 (false)
   202| 	 * @param bool $writeaccesslog
   203| 	 *            optional, Enable writing an access-log file for this domain, default 1 (true)
   204| 	 * @param bool $writeerrorlog
   205| 	 *            optional, Enable writing an error-log file for this domain, default 1 (true)
   206| 	 * @param string $documentroot
   207| 	 *            optional, specify homedir of domain by specifying a directory (relative to customer-docroot), be
   208| 	 *            aware, if path starts with / it is considered a full path, not relative to customer-docroot. Also
   209| 	 *            specifying a URL is possible here (redirect), default empty (autogenerated)
   210| 	 * @param bool $phpenabled
   211| 	 *            optional, whether php is enabled for this domain, default 0 (false)
   212| 	 * @param bool $openbasedir
   213| 	 *            optional, whether to activate openbasedir restriction for this domain, default 0 (false)

# --- HUNK 2: Lines 422-462 ---
   422| 							'TLSv1.3'
   423| 						];
   424| 						foreach ($p_ssl_protocols as $ssl_protocol) {
   425| 							if (!in_array(trim($ssl_protocol), $protocols_available)) {
   426| 								$this->logger()->logAction(FroxlorLogger::ADM_ACTION, LOG_DEBUG, "[API] unknown SSL protocol '" . trim($ssl_protocol) . "'");
   427| 								continue;
   428| 							}
   429| 							$ssl_protocols[] = $ssl_protocol;
   430| 						}
   431| 					}
   432| 					if (empty($ssl_protocols)) {
   433| 						$override_tls = '0';
   434| 					}
   435| 				} else {
   436| 					$isbinddomain = '0';
   437| 					if (Settings::Get('system.bind_enable') == '1') {
   438| 						$isbinddomain = '1';
   439| 					}
   440| 					$caneditdomain = '1';
   441| 					$zonefile = '';
   442| 					$dkim = '0';
   443| 					$specialsettings = '';
   444| 					$ssl_specialsettings = '';
   445| 					$include_specialsettings = 0;
   446| 					$notryfiles = '0';
   447| 					$writeaccesslog = '1';
   448| 					$writeerrorlog = '1';
   449| 					$override_tls = '0';
   450| 					$ssl_protocols = [];
   451| 				}
   452| 				if ($this->getUserDetail('caneditphpsettings') == '1' || $this->getUserDetail('change_serversettings') == '1') {
   453| 					if ((int)Settings::Get('system.mod_fcgid') == 1 || (int)Settings::Get('phpfpm.enabled') == 1) {
   454| 						$phpsettingid_check_stmt = Database::prepare("
   455| 							SELECT * FROM `" . TABLE_PANEL_PHPCONFIGS . "`
   456| 							WHERE `id` = :phpsettingid");
   457| 						$phpsettingid_check = Database::pexecute_first($phpsettingid_check_stmt, [
   458| 							'phpsettingid' => $phpsettingid
   459| 						], true, true);
   460| 						if (!isset($phpsettingid_check['id']) || $phpsettingid_check['id'] == '0' || $phpsettingid_check['id'] != $phpsettingid) {
   461| 							Response::standardError('phpsettingidwrong', '', true);
   462| 						}

# --- HUNK 3: Lines 488-528 ---
   488| 					if ((int)Settings::Get('phpfpm.enabled') == 1) {
   489| 						$phpsettingid = Settings::Get('phpfpm.defaultini');
   490| 					} else {
   491| 						$phpsettingid = Settings::Get('system.mod_fcgid_defaultini');
   492| 					}
   493| 					$mod_fcgid_starter = '-1';
   494| 					$mod_fcgid_maxrequests = '-1';
   495| 				}
   496| 				if ($openbasedir_path > 2 && $openbasedir_path < 0) {
   497| 					$openbasedir_path = 0;
   498| 				}
   499| 				$ipandports = $this->validateIpAddresses($p_ipandports);
   500| 				$ssl_ipandports = [];
   501| 				if (Settings::Get('system.use_ssl') == "1" && !empty($p_ssl_ipandports)) {
   502| 					$ssl_ipandports = $this->validateIpAddresses($p_ssl_ipandports, true);
   503| 					if ($this->getUserDetail('change_serversettings') == '1') {
   504| 						$ssl_specialsettings = Validate::validate(str_replace("\r\n", "\n", $ssl_specialsettings), 'ssl_specialsettings', '/^[^\0]*$/', '', [], true);
   505| 					}
   506| 				}
   507| 				if (Settings::Get('system.use_ssl') == "1" && $sslenabled == 1 && empty($ssl_ipandports)) {
   508| 					Response::standardError('nosslippportgiven', '', true);
   509| 				}
   510| 				if (Settings::Get('system.use_ssl') == "0" || empty($ssl_ipandports)) {
   511| 					$ssl_redirect = 0;
   512| 					$letsencrypt = 0;
   513| 					$http2 = 0;
   514| 					$ssl_ipandports[] = -1;
   515| 					$hsts_maxage = 0;
   516| 					$hsts_sub = 0;
   517| 					$hsts_preload = 0;
   518| 					$ocsp_stapling = 0;
   519| 					$ssl_specialsettings = '';
   520| 					$include_specialsettings = 0;
   521| 				}
   522| 				if ($letsencrypt == '1' && Settings::Get('system.le_domain_dnscheck') == '1') {
   523| 					$domain_ips = PhpHelper::gethostbynamel6($domain, true, Settings::Get('system.le_domain_dnscheck_resolver'));
   524| 					$selected_ips = $this->getIpsFromIdArray($ssl_ipandports);
   525| 					if ($domain_ips == false || count(array_intersect($selected_ips, $domain_ips)) <= 0) {
   526| 						Response::standardError('invaliddnsforletsencrypt', '', true);
   527| 					}
   528| 				}

# --- HUNK 4: Lines 939-1001 ---
   939| 	/**
   940| 	 * update domain entry by either id or domainname
   941| 	 *
   942| 	 * @param int $id
   943| 	 *            optional, the domain-id
   944| 	 * @param string $domainname
   945| 	 *            optional, the domainname
   946| 	 * @param int $customerid
   947| 	 *            required (if $loginname is not specified)
   948| 	 * @param string $loginname
   949| 	 *            required (if $customerid is not specified)
   950| 	 * @param int $adminid
   951| 	 *            optional, default is the calling admin's ID
   952| 	 * @param array $ipandport
   953| 	 *            optional list of ip/ports to assign to domain, default is system-default-ips
   954| 	 * @param int $subcanemaildomain
   955| 	 *            optional, allow subdomains of this domain as email domains, 1 = choosable (default no), 2 = choosable
   956| 	 *            (default yes), 3 = always, default 0 (never)
   957| 	 * @param bool $isemaildomain
   958| 	 *            optional, allow email usage with this domain, default 0 (false)
   959| 	 * @param bool $email_only
   960| 	 *            optional, restrict domain to email usage, default 0 (false)
   961| 	 * @param int $selectserveralias
   962| 	 *            optional, 0 = wildcard, 1 = www-alias, 2 = none, default 0
   963| 	 * @param bool $speciallogfile
   964| 	 *            optional, whether to create an exclusive web-logfile for this domain, default 0 (false)
   965| 	 * @param bool $speciallogverified
   966| 	 *            optional, when setting $speciallogfile to false, this needs to be set to true to confirm the action,
   967| 	 *            default 0 (false)
   968| 	 * @param int $alias
   969| 	 *            optional, domain-id of a domain that the new domain should be an alias of, default 0 (none)
   970| 	 * @param string $registration_date
   971| 	 *            optional, date of domain registration in form of YYYY-MM-DD, default empty (none)
   972| 	 * @param string $termination_date
   973| 	 *            optional, date of domain termination in form of YYYY-MM-DD, default empty (none)
   974| 	 * @param bool $caneditdomain
   975| 	 *            optional, whether to allow the customer to edit domain settings, default 0 (false)
   976| 	 * @param bool $isbinddomain
   977| 	 *            optional, whether to generate a dns-zone or not (only of nameserver is activated), default 0 (false)
   978| 	 * @param string $zonefile
   979| 	 *            optional, custom dns zone filename (only of nameserver is activated), default empty (auto-generated)
   980| 	 * @param bool $dkim
   981| 	 *            optional, currently not in use, default 0 (false)
   982| 	 * @param string $specialsettings
   983| 	 *            optional, custom webserver vhost-content which is added to the generated vhost, default empty
   984| 	 * @param string $ssl_specialsettings
   985| 	 *            optional, custom webserver vhost-content which is added to the generated ssl-vhost, default empty
   986| 	 * @param bool $include_specialsettings
   987| 	 *            optional, whether to include non-ssl specialsettings in the generated ssl-vhost, default false
   988| 	 * @param bool $specialsettingsforsubdomains
   989| 	 *            optional, whether to apply specialsettings to all subdomains of this domain, default is read from
   990| 	 *            setting system.apply_specialsettings_default
   991| 	 * @param bool $notryfiles
   992| 	 *            optional, [nginx only] do not generate the default try-files directive, default 0 (false)
   993| 	 * @param bool $writeaccesslog
   994| 	 *            optional, Enable writing an access-log file for this domain, default 1 (true)
   995| 	 * @param bool $writeerrorlog
   996| 	 *            optional, Enable writing an error-log file for this domain, default 1 (true)
   997| 	 * @param string $documentroot
   998| 	 *            optional, specify homedir of domain by specifying a directory (relative to customer-docroot), be
   999| 	 *            aware, if path starts with / it is considered a full path, not relative to customer-docroot. Also
  1000| 	 *            specifying a URL is possible here (redirect), default empty (autogenerated)
  1001| 	 * @param bool $phpenabled

# --- HUNK 5: Lines 1059-1098 ---
  1059| 			$dn_optional = $id > 0;
  1060| 			$domainname = $this->getParam('domainname', $dn_optional, '');
  1061| 			$result = $this->apiCall('Domains.get', [
  1062| 				'id' => $id,
  1063| 				'domainname' => $domainname
  1064| 			]);
  1065| 			$id = $result['id'];
  1066| 			$p_ipandports = $this->getParam('ipandport', true, []);
  1067| 			$adminid = intval($this->getParam('adminid', true, $result['adminid']));
  1068| 			if ($this->getParam('customerid', true, 0) == 0 && $this->getParam('loginname', true, '') == '') {
  1069| 				$customerid = $result['customerid'];
  1070| 				$customer = $this->apiCall('Customers.get', [
  1071| 					'id' => $customerid
  1072| 				]);
  1073| 			} else {
  1074| 				$customer = $this->getCustomerData();
  1075| 				$customerid = $customer['customerid'];
  1076| 			}
  1077| 			$subcanemaildomain = $this->getParam('subcanemaildomain', true, $result['subcanemaildomain']);
  1078| 			$isemaildomain = $this->getBoolParam('isemaildomain', true, $result['isemaildomain']);
  1079| 			$email_only = $this->getBoolParam('email_only', true, $result['email_only']);
  1080| 			$p_serveraliasoption = $this->getParam('selectserveralias', true, -1);
  1081| 			$speciallogfile = $this->getBoolParam('speciallogfile', true, $result['speciallogfile']);
  1082| 			$speciallogverified = $this->getBoolParam('speciallogverified', true, 0);
  1083| 			$aliasdomain = intval($this->getParam('alias', true, $result['aliasdomain']));
  1084| 			$registration_date = $this->getParam('registration_date', true, $result['registration_date']);
  1085| 			$termination_date = $this->getParam('termination_date', true, $result['termination_date']);
  1086| 			$caneditdomain = $this->getBoolParam('caneditdomain', true, $result['caneditdomain']);
  1087| 			$isbinddomain = $this->getBoolParam('isbinddomain', true, $result['isbinddomain']);
  1088| 			$zonefile = $this->getParam('zonefile', true, $result['zonefile']);
  1089| 			$dkim = $this->getBoolParam('dkim', true, $result['dkim']);
  1090| 			$specialsettings = $this->getParam('specialsettings', true, $result['specialsettings']);
  1091| 			$ssl_specialsettings = $this->getParam('ssl_specialsettings', true, $result['ssl_specialsettings']);
  1092| 			$include_specialsettings = $this->getBoolParam('include_specialsettings', true, $result['include_specialsettings']);
  1093| 			$ssfs = $this->getBoolParam('specialsettingsforsubdomains', true, Settings::Get('system.apply_specialsettings_default'));
  1094| 			$notryfiles = $this->getBoolParam('notryfiles', true, $result['notryfiles']);
  1095| 			$writeaccesslog = $this->getBoolParam('writeaccesslog', true, $result['writeaccesslog']);
  1096| 			$writeerrorlog = $this->getBoolParam('writeerrorlog', true, $result['writeerrorlog']);
  1097| 			$documentroot = $this->getParam('documentroot', true, $result['documentroot']);
  1098| 			$phpenabled = $this->getBoolParam('phpenabled', true, $result['phpenabled']);

# --- HUNK 6: Lines 1134-1192 ---
  1134| 			}
  1135| 			$description = $this->getParam('description', true, $result['description']);
  1136| 			$deactivated = $this->getBoolParam('deactivated', true, $result['deactivated']);
  1137| 			$subdomains_stmt = Database::prepare("
  1138| 				SELECT COUNT(`id`) AS count FROM `" . TABLE_PANEL_DOMAINS . "` WHERE
  1139| 				`parentdomainid` = :resultid
  1140| 			");
  1141| 			$subdomains = Database::pexecute_first($subdomains_stmt, [
  1142| 				'resultid' => $result['id']
  1143| 			], true, true);
  1144| 			$subdomains = $subdomains['count'];
  1145| 			$alias_check_stmt = Database::prepare("
  1146| 				SELECT COUNT(`id`) AS count FROM `" . TABLE_PANEL_DOMAINS . "` WHERE
  1147| 				`aliasdomain` = :resultid
  1148| 			");
  1149| 			$alias_check = Database::pexecute_first($alias_check_stmt, [
  1150| 				'resultid' => $result['id']
  1151| 			], true, true);
  1152| 			$alias_check = $alias_check['count'];
  1153| 			$domain_emails_result_stmt = Database::prepare("
  1154| 				SELECT `email`, `email_full`, `destination`, `popaccountid` AS `number_email_forwarders`
  1155| 				FROM `" . TABLE_MAIL_VIRTUAL . "` WHERE `customerid` = :customerid AND `domainid` = :id
  1156| 			");
  1157| 			Database::pexecute($domain_emails_result_stmt, [
  1158| 				'customerid' => $result['customerid'],
  1159| 				'id' => $result['id']
  1160| 			], true, true);
  1161| 			$emails = Database::num_rows();
  1162| 			$email_forwarders = 0;
  1163| 			$email_accounts = 0;
  1164| 			while ($domain_emails_row = $domain_emails_result_stmt->fetch(PDO::FETCH_ASSOC)) {
  1165| 				if ($domain_emails_row['destination'] != '') {
  1166| 					$domain_emails_row['destination'] = explode(' ', FileDir::makeCorrectDestination($domain_emails_row['destination']));
  1167| 					$email_forwarders += count($domain_emails_row['destination']);
  1168| 					if (in_array($domain_emails_row['email_full'], $domain_emails_row['destination'])) {
  1169| 						$email_forwarders -= 1;
  1170| 						$email_accounts++;
  1171| 					}
  1172| 				}
  1173| 			}
  1174| 			if ($customerid > 0 && $customerid != $result['customerid'] && Settings::Get('panel.allow_domain_change_customer') == '1') {
  1175| 				$customer_stmt = Database::prepare("
  1176| 					SELECT * FROM `" . TABLE_PANEL_CUSTOMERS . "`
  1177| 					WHERE `customerid` = :customerid
  1178| 					AND (`subdomains_used` + :subdomains <= `subdomains` OR `subdomains` = '-1' )
  1179| 					AND (`emails_used` + :emails <= `emails` OR `emails` = '-1' )
  1180| 					AND (`email_forwarders_used` + :forwarders <= `email_forwarders` OR `email_forwarders` = '-1' )
  1181| 					AND (`email_accounts_used` + :accounts <= `email_accounts` OR `email_accounts` = '-1' ) " . ($this->getUserDetail('customers_see_all') ? '' : " AND `adminid` = :adminid"));
  1182| 				$params = [
  1183| 					'customerid' => $customerid,
  1184| 					'subdomains' => $subdomains,
  1185| 					'emails' => $emails,
  1186| 					'forwarders' => $email_forwarders,
  1187| 					'accounts' => $email_accounts
  1188| 				];
  1189| 				if ($this->getUserDetail('customers_see_all') == '0') {
  1190| 					$params['adminid'] = $this->getUserDetail('adminid');
  1191| 				}
  1192| 				$customer = Database::pexecute_first($customer_stmt, $params, true, true);

# --- HUNK 7: Lines 1289-1329 ---
  1289| 					$protocols_available = [
  1290| 						'TLSv1',
  1291| 						'TLSv1.1',
  1292| 						'TLSv1.2',
  1293| 						'TLSv1.3'
  1294| 					];
  1295| 					foreach ($p_ssl_protocols as $ssl_protocol) {
  1296| 						if (!in_array(trim($ssl_protocol), $protocols_available)) {
  1297| 							$this->logger()->logAction(FroxlorLogger::ADM_ACTION, LOG_DEBUG, "[API] unknown SSL protocol '" . trim($ssl_protocol) . "'");
  1298| 							continue;
  1299| 						}
  1300| 						$ssl_protocols[] = $ssl_protocol;
  1301| 					}
  1302| 				}
  1303| 				if (empty($ssl_protocols)) {
  1304| 					$override_tls = '0';
  1305| 				}
  1306| 			} else {
  1307| 				$isbinddomain = $result['isbinddomain'];
  1308| 				$zonefile = $result['zonefile'];
  1309| 				$dkim = $result['dkim'];
  1310| 				$specialsettings = $result['specialsettings'];
  1311| 				$ssl_specialsettings = $result['ssl_specialsettings'];
  1312| 				$include_specialsettings = $result['include_specialsettings'];
  1313| 				$ssfs = (empty($specialsettings) ? 0 : 1);
  1314| 				$notryfiles = $result['notryfiles'];
  1315| 				$writeaccesslog = $result['writeaccesslog'];
  1316| 				$writeerrorlog = $result['writeerrorlog'];
  1317| 				$ssl_protocols = $p_ssl_protocols;
  1318| 				$override_tls = $result['override_tls'];
  1319| 			}
  1320| 			if ($this->getUserDetail('caneditphpsettings') == '1' || $this->getUserDetail('change_serversettings') == '1') {
  1321| 				if ((int)Settings::Get('system.mod_fcgid') == 1 || (int)Settings::Get('phpfpm.enabled') == 1) {
  1322| 					$phpsettingid_check_stmt = Database::prepare("
  1323| 						SELECT * FROM `" . TABLE_PANEL_PHPCONFIGS . "` WHERE `id` = :phpid
  1324| 					");
  1325| 					$phpsettingid_check = Database::pexecute_first($phpsettingid_check_stmt, [
  1326| 						'phpid' => $phpsettingid
  1327| 					], true, true);
  1328| 					if (!isset($phpsettingid_check['id']) || $phpsettingid_check['id'] == '0' || $phpsettingid_check['id'] != $phpsettingid) {
  1329| 						Response::standardError('phpsettingidwrong', '', true);

# --- HUNK 8: Lines 1385-1425 ---
  1385| 				$letsencrypt = 0;
  1386| 				$http2 = 0;
  1387| 				$ssl_ipandports = [];
  1388| 				$hsts_maxage = 0;
  1389| 				$hsts_sub = 0;
  1390| 				$hsts_preload = 0;
  1391| 				$ocsp_stapling = 0;
  1392| 				$ssl_specialsettings = '';
  1393| 				$include_specialsettings = 0;
  1394| 			}
  1395| 			if ($letsencrypt == '1' && Settings::Get('system.le_domain_dnscheck') == '1') {
  1396| 				$domain_ips = PhpHelper::gethostbynamel6($result['domain'], true, Settings::Get('system.le_domain_dnscheck_resolver'));
  1397| 				$selected_ips = $this->getIpsFromIdArray($ssl_ipandports);
  1398| 				if ($domain_ips == false || count(array_intersect($selected_ips, $domain_ips)) <= 0) {
  1399| 					Response::standardError('invaliddnsforletsencrypt', '', true);
  1400| 				}
  1401| 			}
  1402| 			if ($serveraliasoption == '0' && $letsencrypt == '1') {
  1403| 				Response::standardError('nowildcardwithletsencrypt', '', true);
  1404| 			}
  1405| 			if (($result['letsencrypt'] != $letsencrypt || $result['ssl_redirect'] != $ssl_redirect) && $ssl_redirect > 0 && $letsencrypt == 1) {
  1406| 				$ssl_redirect = 2;
  1407| 			}
  1408| 			if (!preg_match('/^https?\:\/\//', $documentroot)) {
  1409| 				if ($documentroot != $result['documentroot']) {
  1410| 					if (substr($documentroot, 0, 1) != "/") {
  1411| 						$documentroot = $customer['documentroot'] . '/' . $documentroot;
  1412| 					}
  1413| 					$documentroot = FileDir::makeCorrectDir($documentroot);
  1414| 				}
  1415| 			}
  1416| 			if ($email_only == '1') {
  1417| 				$isemaildomain = '1';
  1418| 			} else {
  1419| 				$email_only = '0';
  1420| 			}
  1421| 			if ($subcanemaildomain != '1' && $subcanemaildomain != '2' && $subcanemaildomain != '3') {
  1422| 				$subcanemaildomain = '0';
  1423| 			}
  1424| 			$aliasdomain_check = [
  1425| 				'id' => 0


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/EmailAccounts.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 197-260 ---
   197| 			if ($sendinfomail) {
   198| 				$replace_arr = [
   199| 					'EMAIL' => $email_full,
   200| 					'PASSWORD' => htmlentities(htmlentities($password)),
   201| 					'SALUTATION' => User::getCorrectUserSalutation($customer),
   202| 					'NAME' => $customer['name'],
   203| 					'FIRSTNAME' => $customer['firstname'],
   204| 					'COMPANY' => $customer['company'],
   205| 					'USERNAME' => $customer['loginname'],
   206| 					'CUSTOMER_NO' => $customer['customernumber']
   207| 				];
   208| 				$stmt = Database::prepare("SELECT `name`, `email` FROM `" . TABLE_PANEL_ADMINS . "` WHERE `adminid`= :adminid");
   209| 				$admin = Database::pexecute_first($stmt, [
   210| 					"adminid" => $customer['adminid']
   211| 				]);
   212| 				$mail_subject = $this->getMailTemplate($customer, 'mails', 'pop_success_subject', $replace_arr, lng('mails.pop_success.subject'));
   213| 				$mail_body = $this->getMailTemplate($customer, 'mails', 'pop_success_mailbody', $replace_arr, lng('mails.pop_success.mailbody'));
   214| 				$_mailerror = false;
   215| 				$mailerr_msg = "";
   216| 				try {
   217| 					$this->mailer()->setFrom($admin['email'], User::getCorrectUserSalutation($admin));
   218| 					$this->mailer()->Subject = $mail_subject;
   219| 					$this->mailer()->AltBody = $mail_body;
   220| 					$this->mailer()->msgHTML(str_replace("\n", "<br />", $mail_body));
   221| 					$this->mailer()->addAddress($email_full);
   222| 					$this->mailer()->send();
   223| 				} catch (\PHPMailer\PHPMailer\Exception $e) {
   224| 					$mailerr_msg = $e->errorMessage();
   225| 					$_mailerror = true;
   226| 				} catch (Exception $e) {
   227| 					$mailerr_msg = $e->getMessage();
   228| 					$_mailerror = true;
   229| 				}
   230| 				if ($_mailerror) {
   231| 					$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_ERR, "[API] Error sending mail: " . $mailerr_msg);
   232| 					Response::standardError('errorsendingmail', $email_full, true);
   233| 				}
   234| 				$this->mailer()->clearAddresses();
   235| 				if (Settings::Get('panel.sendalternativemail') == 1 && !empty($alternative_email)) {
   236| 					$mail_subject = $this->getMailTemplate($customer, 'mails', 'pop_success_alternative_subject', $replace_arr, lng('mails.pop_success_alternative.subject'));
   237| 					$mail_body = $this->getMailTemplate($customer, 'mails', 'pop_success_alternative_mailbody', $replace_arr, lng('mails.pop_success_alternative.mailbody'));
   238| 					$_mailerror = false;
   239| 					try {
   240| 						$this->mailer()->setFrom($admin['email'], User::getCorrectUserSalutation($admin));
   241| 						$this->mailer()->Subject = $mail_subject;
   242| 						$this->mailer()->AltBody = $mail_body;
   243| 						$this->mailer()->msgHTML(str_replace("\n", "<br />", $mail_body));
   244| 						$this->mailer()->addAddress($idna_convert->encode($alternative_email), User::getCorrectUserSalutation($customer));
   245| 						$this->mailer()->send();
   246| 					} catch (\PHPMailer\PHPMailer\Exception $e) {
   247| 						$mailerr_msg = $e->errorMessage();
   248| 						$_mailerror = true;
   249| 					} catch (Exception $e) {
   250| 						$mailerr_msg = $e->getMessage();
   251| 						$_mailerror = true;
   252| 					}
   253| 					if ($_mailerror) {
   254| 						$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_ERR, "[API] Error sending mail: " . $mailerr_msg);
   255| 						Response::standardError([
   256| 							'errorsendingmail'
   257| 						], $alternative_email, true);
   258| 					}
   259| 					$this->mailer()->clearAddresses();
   260| 				}


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Emails.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 32-106 ---
    32| use Froxlor\Settings;
    33| use Froxlor\System\Cronjob;
    34| use Froxlor\UI\Response;
    35| use Froxlor\Validate\Validate;
    36| use PDO;
    37| /**
    38|  * @since 0.10.0
    39|  */
    40| class Emails extends ApiCommand implements ResourceEntity
    41| {
    42| 	/**
    43| 	 * add a new email address
    44| 	 *
    45| 	 * @param string $email_part
    46| 	 *            name of the address before @
    47| 	 * @param string $domain
    48| 	 *            domain-name for the email-address
    49| 	 * @param float $spam_tag_level
    50| 	 *            optional, score which is required to tag emails as spam, default: 7.0
    51| 	 * @param bool $rewrite_subject
    52| 	 *            optional, whether to add ***SPAM*** to the email's subject if applicable, default true
    53| 	 * @param float $spam_kill_level
    54| 	 *            optional, score which is required to discard emails, default: 14.0
    55| 	 * @param boolean $bypass_spam
    56| 	 *            optional, disable spam-filter entirely, default: no
    57| 	 * @param boolean $policy_greylist
    58| 	 *            optional, enable grey-listing, default: yes
    59| 	 * @param boolean $iscatchall
    60| 	 *            optional, make this address a catchall address, default: no
    61| 	 * @param int $customerid
    62| 	 *            optional, required when called as admin (if $loginname is not specified)
    63| 	 * @param string $loginname
    64| 	 *            optional, required when called as admin (if $customerid is not specified)
    65| 	 * @param string $description
    66| 	 *            optional custom description (currently not used/shown in the frontend), default empty
    67| 	 *
    68| 	 * @access admin, customer
    69| 	 * @return string json-encoded array
    70| 	 * @throws Exception
    71| 	 */
    72| 	public function add()
    73| 	{
    74| 		if ($this->isAdmin() == false && Settings::IsInList('panel.customer_hide_options', 'email')) {
    75| 			throw new Exception("You cannot access this resource", 405);
    76| 		}
    77| 		if ($this->getUserDetail('emails_used') < $this->getUserDetail('emails') || $this->getUserDetail('emails') == '-1') {
    78| 			$email_part = $this->getParam('email_part');
    79| 			$domain = $this->getParam('domain');
    80| 			$spam_tag_level = $this->getParam('spam_tag_level', true, '7.0');
    81| 			$rewrite_subject = $this->getBoolParam('rewrite_subject', true, 1);
    82| 			$spam_kill_level = $this->getUlParam('spam_kill_level', 'spam_kill_level_ul', true, '14.0');
    83| 			$bypass_spam = $this->getBoolParam('bypass_spam', true, 0);
    84| 			$policy_greylist = $this->getBoolParam('policy_greylist', true, 1);
    85| 			$iscatchall = $this->getBoolParam('iscatchall', true, 0);
    86| 			$description = $this->getParam('description', true, '');
    87| 			$idna_convert = new IdnaWrapper();
    88| 			if (substr($domain, 0, 4) != 'xn--') {
    89| 				$domain = $idna_convert->encode(Validate::validate($domain, 'domain', '', '', [], true));
    90| 			}
    91| 			$email_part = $idna_convert->encode($email_part);
    92| 			$domain_check = $this->apiCall('SubDomains.get', [
    93| 				'domainname' => $domain
    94| 			], true);
    95| 			if ((int)$domain_check['isemaildomain'] == 0) {
    96| 				Response::standardError('maindomainnonexist', $idna_convert->decode($domain), true);
    97| 			}
    98| 			if ((int)$domain_check['deactivated'] == 1) {
    99| 				Response::standardError('maindomaindeactivated', $idna_convert->decode($domain), true);
   100| 			}
   101| 			if (Settings::Get('catchall.catchall_enabled') != '1') {
   102| 				$iscatchall = 0;
   103| 			}
   104| 			if ($iscatchall) {
   105| 				$iscatchall = '1';
   106| 				$email = '@' . $domain;

# --- HUNK 2: Lines 205-280 ---
   205| 			$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_INFO, "[API] get email address '" . $result['email_full'] . "'");
   206| 			return $this->response($result);
   207| 		}
   208| 		$key = ($id > 0 ? "id #" . $id : "emailaddr '" . $emailaddr . "'");
   209| 		throw new Exception("Email address with " . $key . " could not be found", 404);
   210| 	}
   211| 	/**
   212| 	 * toggle catchall flag of given email address either by id or email-address
   213| 	 *
   214| 	 * @param int $id
   215| 	 *            optional, the email-address-id
   216| 	 * @param string $emailaddr
   217| 	 *            optional, the email-address
   218| 	 * @param int $customerid
   219| 	 *            optional, required when called as admin (if $loginname is not specified)
   220| 	 * @param string $loginname
   221| 	 *            optional, required when called as admin (if $customerid is not specified)
   222| 	 * @param float $spam_tag_level
   223| 	 *            optional, score which is required to tag emails as spam, default: 7.0
   224| 	 * @param bool $rewrite_subject
   225| 	 *              optional, whether to add ***SPAM*** to the email's subject if applicable, default true
   226| 	 * @param float $spam_kill_level
   227| 	 *            optional, score which is required to discard emails, default: 14.0
   228| 	 * @param boolean $bypass_spam
   229| 	 *            optional, disable spam-filter entirely, default: no
   230| 	 * @param boolean $policy_greylist
   231| 	 *            optional, enable grey-listing, default: yes
   232| 	 * @param boolean $iscatchall
   233| 	 *            optional
   234| 	 * @param string $description
   235| 	 *            optional custom description (currently not used/shown in the frontend), default empty
   236| 	 *
   237| 	 * @access admin, customer
   238| 	 * @return string json-encoded array
   239| 	 * @throws Exception
   240| 	 */
   241| 	public function update()
   242| 	{
   243| 		if ($this->isAdmin() == false && Settings::IsInList('panel.customer_hide_options', 'email')) {
   244| 			throw new Exception("You cannot access this resource", 405);
   245| 		}
   246| 		$id = $this->getParam('id', true, 0);
   247| 		$ea_optional = $id > 0;
   248| 		$emailaddr = $this->getParam('emailaddr', $ea_optional, '');
   249| 		$result = $this->apiCall('Emails.get', [
   250| 			'id' => $id,
   251| 			'emailaddr' => $emailaddr
   252| 		]);
   253| 		$id = $result['id'];
   254| 		$spam_tag_level = $this->getParam('spam_tag_level', true, $result['spam_tag_level']);
   255| 		$rewrite_subject = $this->getBoolParam('rewrite_subject', true, $result['rewrite_subject']);
   256| 		$spam_kill_level = $this->getUlParam('spam_kill_level', 'spam_kill_level_ul', true, $result['spam_kill_level']);
   257| 		$bypass_spam = $this->getBoolParam('bypass_spam', true, $result['bypass_spam']);
   258| 		$policy_greylist = $this->getBoolParam('policy_greylist', true, $result['policy_greylist']);
   259| 		$iscatchall = $this->getBoolParam('iscatchall', true, $result['iscatchall']);
   260| 		$description = $this->getParam('description', true, $result['description']);
   261| 		if ($iscatchall && $result['iscatchall'] == 0 && Settings::Get('catchall.catchall_enabled') != '1') {
   262| 			Response::standardError([
   263| 				'operationnotpermitted',
   264| 				'featureisdisabled'
   265| 			], 'catchall', true);
   266| 		}
   267| 		$customer = $this->getCustomerData();
   268| 		$email = $result['email_full'];
   269| 		if ($iscatchall) {
   270| 			$iscatchall = '1';
   271| 			$email = $result['email'];
   272| 			if ($result['iscatchall'] == 0) {
   273| 				$email_parts = explode('@', $result['email_full']);
   274| 				$email = '@' . $email_parts[1];
   275| 				$stmt = Database::prepare("
   276| 					SELECT `email_full` FROM `" . TABLE_MAIL_VIRTUAL . "`
   277| 					WHERE `email` = :email AND `customerid` = :cid AND `iscatchall` = '1'
   278| 				");
   279| 				$params = [
   280| 					"email" => $email,


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Ftps.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 229-269 ---
   229| 				if ($sendinfomail == 1) {
   230| 					$replace_arr = [
   231| 						'SALUTATION' => User::getCorrectUserSalutation($customer),
   232| 						'CUST_NAME' => User::getCorrectUserSalutation($customer),
   233| 						'NAME' => $customer['name'],
   234| 						'FIRSTNAME' => $customer['firstname'],
   235| 						'COMPANY' => $customer['company'],
   236| 						'USERNAME' => $customer['loginname'],
   237| 						'CUSTOMER_NO' => $customer['customernumber'],
   238| 						'USR_NAME' => $username,
   239| 						'USR_PASS' => htmlentities(htmlentities($password)),
   240| 						'USR_PATH' => FileDir::makeCorrectDir(str_replace($customer['documentroot'], "/", $path))
   241| 					];
   242| 					$mail_subject = $this->getMailTemplate($customer, 'mails', 'new_ftpaccount_by_customer_subject', $replace_arr, lng('mails.new_ftpaccount_by_customer.subject'));
   243| 					$mail_body = $this->getMailTemplate($customer, 'mails', 'new_ftpaccount_by_customer_mailbody', $replace_arr, lng('mails.new_ftpaccount_by_customer.mailbody'));
   244| 					$_mailerror = false;
   245| 					$mailerr_msg = "";
   246| 					try {
   247| 						$this->mailer()->Subject = $mail_subject;
   248| 						$this->mailer()->AltBody = $mail_body;
   249| 						$this->mailer()->msgHTML(str_replace("\n", "<br />", $mail_body));
   250| 						$this->mailer()->addAddress($customer['email'], User::getCorrectUserSalutation($customer));
   251| 						$this->mailer()->send();
   252| 					} catch (\PHPMailer\PHPMailer\Exception $e) {
   253| 						$mailerr_msg = $e->errorMessage();
   254| 						$_mailerror = true;
   255| 					} catch (Exception $e) {
   256| 						$mailerr_msg = $e->getMessage();
   257| 						$_mailerror = true;
   258| 					}
   259| 					if ($_mailerror) {
   260| 						$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_ERR, "[API] Error sending mail: " . $mailerr_msg);
   261| 						Response::standardError('errorsendingmail', $customer['email'], true);
   262| 					}
   263| 					$this->mailer()->clearAddresses();
   264| 				}
   265| 				$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_NOTICE, "[API] added ftp-user '" . $username . "'");
   266| 				$result = $this->apiCall('Ftps.get', [
   267| 					'username' => $username
   268| 				]);
   269| 				return $this->response($result);


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/Mysqls.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 79-121 ---
    79| 			$dbserver = Validate::validate($dbserver, html_entity_decode(lng('mysql.mysql_server')), '/^[0-9]+$/', '', 0, true);
    80| 			Database::needRoot(true, $dbserver, false);
    81| 			Database::needSqlData();
    82| 			$sql_root = Database::getSqlData();
    83| 			Database::needRoot(false);
    84| 			if (!is_array($sql_root)) {
    85| 				throw new Exception("Database server with index #" . $dbserver . " is unknown", 404);
    86| 			}
    87| 			if ($sendinfomail != 1) {
    88| 				$sendinfomail = 0;
    89| 			}
    90| 			$newdb_params = [
    91| 				'loginname' => ($this->isAdmin() ? $customer['loginname'] : $this->getUserDetail('loginname')),
    92| 				'mysql_lastaccountnumber' => ($this->isAdmin() ? $customer['mysql_lastaccountnumber'] : $this->getUserDetail('mysql_lastaccountnumber'))
    93| 			];
    94| 			$dbm = new DbManager($this->logger());
    95| 			if (strtoupper(Settings::Get('customer.mysqlprefix')) == 'DBNAME' && !empty($databasename)) {
    96| 				if (strlen($newdb_params['loginname'] . '_' . $databasename) > Database::getSqlUsernameLength()) {
    97| 					throw new Exception("Database name cannot be longer than " . (Database::getSqlUsernameLength() - strlen($newdb_params['loginname'] . '_')) . " characters.", 406);
    98| 				}
    99| 				$username = $dbm->createDatabase($newdb_params['loginname'] . '_' . $databasename, $password, $dbserver);
   100| 			} else {
   101| 				$username = $dbm->createDatabase($newdb_params['loginname'], $password, $dbserver, $newdb_params['mysql_lastaccountnumber']);
   102| 			}
   103| 			if ($username == false) {
   104| 				Response::standardError('passwordshouldnotbeusername', '', true);
   105| 			}
   106| 			$stmt = Database::prepare("
   107| 				INSERT INTO `" . TABLE_PANEL_DATABASES . "`
   108| 				SET
   109| 				`customerid` = :customerid,
   110| 				`databasename` = :databasename,
   111| 				`description` = :description,
   112| 				`dbserver` = :dbserver
   113| 			");
   114| 			$params = [
   115| 				"customerid" => $customer['customerid'],
   116| 				"databasename" => $username,
   117| 				"description" => $databasedescription,
   118| 				"dbserver" => $dbserver
   119| 			];
   120| 			Database::pexecute($stmt, $params, true, true);
   121| 			$databaseid = Database::lastInsertId();

# --- HUNK 2: Lines 136-176 ---
   136| 					'SALUTATION' => User::getCorrectUserSalutation($userinfo),
   137| 					'CUST_NAME' => User::getCorrectUserSalutation($userinfo), // < keep this for compatibility
   138| 					'NAME' => $userinfo['name'],
   139| 					'FIRSTNAME' => $userinfo['firstname'],
   140| 					'COMPANY' => $userinfo['company'],
   141| 					'USERNAME' => $userinfo['loginname'],
   142| 					'CUSTOMER_NO' => $userinfo['customernumber'],
   143| 					'DB_NAME' => $username,
   144| 					'DB_PASS' => htmlentities(htmlentities($password)),
   145| 					'DB_DESC' => $databasedescription,
   146| 					'DB_SRV' => $sql_root['host'],
   147| 					'PMA_URI' => $pma
   148| 				];
   149| 				$mail_subject = $this->getMailTemplate($userinfo, 'mails', 'new_database_by_customer_subject', $replace_arr, lng('mails.new_database_by_customer.subject'));
   150| 				$mail_body = $this->getMailTemplate($userinfo, 'mails', 'new_database_by_customer_mailbody', $replace_arr, lng('mails.new_database_by_customer.mailbody'));
   151| 				$_mailerror = false;
   152| 				$mailerr_msg = "";
   153| 				try {
   154| 					$this->mailer()->Subject = $mail_subject;
   155| 					$this->mailer()->AltBody = $mail_body;
   156| 					$this->mailer()->msgHTML(str_replace("\n", "<br />", $mail_body));
   157| 					$this->mailer()->addAddress($userinfo['email'], User::getCorrectUserSalutation($userinfo));
   158| 					$this->mailer()->send();
   159| 				} catch (\PHPMailer\PHPMailer\Exception $e) {
   160| 					$mailerr_msg = $e->errorMessage();
   161| 					$_mailerror = true;
   162| 				} catch (Exception $e) {
   163| 					$mailerr_msg = $e->getMessage();
   164| 					$_mailerror = true;
   165| 				}
   166| 				if ($_mailerror) {
   167| 					$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_ERR, "[API] Error sending mail: " . $mailerr_msg);
   168| 					Response::standardError('errorsendingmail', $userinfo['email'], true);
   169| 				}
   170| 				$this->mailer()->clearAddresses();
   171| 			}
   172| 			$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_NOTICE, "[API] added mysql-database '" . $username . "'");
   173| 			$result = $this->apiCall('Mysqls.get', [
   174| 				'dbname' => $username,
   175| 				'mysql_server' => $dbserver
   176| 			]);

# --- HUNK 3: Lines 459-499 ---
   459| 	 * @throws Exception
   460| 	 */
   461| 	public function delete()
   462| 	{
   463| 		$id = $this->getParam('id', true, 0);
   464| 		$dn_optional = $id > 0;
   465| 		$dbname = $this->getParam('dbname', $dn_optional, '');
   466| 		$dbserver = $this->getParam('mysql_server', true, -1);
   467| 		$customer = $this->getCustomerData();
   468| 		if ($this->isAdmin() == false && Settings::IsInList('panel.customer_hide_options', 'mysql')) {
   469| 			throw new Exception("You cannot access this resource", 405);
   470| 		}
   471| 		$result = $this->apiCall('Mysqls.get', [
   472| 			'id' => $id,
   473| 			'dbname' => $dbname,
   474| 			'mysql_server' => $dbserver
   475| 		]);
   476| 		$id = $result['id'];
   477| 		Database::needRoot(true, $result['dbserver'], false);
   478| 		$dbm = new DbManager($this->logger());
   479| 		$dbm->getManager()->deleteDatabase($result['databasename']);
   480| 		Database::needRoot(false);
   481| 		$stmt = Database::prepare("DELETE FROM `" . TABLE_PANEL_DATABASES . "` WHERE `id` = :id");
   482| 		Database::pexecute($stmt, [
   483| 			"id" => $id
   484| 		], true, true);
   485| 		$mysql_used = $customer['mysqls_used'];
   486| 		$resetaccnumber = ($mysql_used == '1') ? " , `mysql_lastaccountnumber` = '0' " : '';
   487| 		Customers::decreaseUsage($customer['customerid'], 'mysqls_used', $resetaccnumber);
   488| 		$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_WARNING, "[API] deleted database '" . $result['databasename'] . "'");
   489| 		return $this->response($result);
   490| 	}
   491| 	private function getDefaultMySqlServer(array $customer) {
   492| 		$allowed_mysqlservers = json_decode($customer['allowed_mysqlserver'] ?? '[]', true);
   493| 		asort($allowed_mysqlservers, SORT_NUMERIC);
   494| 		if (count($allowed_mysqlservers) == 1 && $allowed_mysqlservers[0] != 0) {
   495| 			return (int) $allowed_mysqlservers[0];
   496| 		}
   497| 		return (int) array_shift($allowed_mysqlservers);
   498| 	}
   499| }


# ====================================================================
# FILE: lib/Froxlor/Api/Commands/SubDomains.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 416-457 ---
   416| 				SELECT d.*, pd.`subcanemaildomain`, pd.`isbinddomain` as subisbinddomain
   417| 				FROM `" . TABLE_PANEL_DOMAINS . "` d, `" . TABLE_PANEL_DOMAINS . "` pd
   418| 				WHERE d.`customerid`= :customerid AND " . ($id > 0 ? "d.`id` = :iddn" : "d.`domain` = :iddn") . "
   419| 				AND ((d.`parentdomainid`!='0' AND pd.`id` = d.`parentdomainid`) OR (d.`parentdomainid`='0' AND pd.`id` = d.`id`))
   420| 			");
   421| 			$params = [
   422| 				'customerid' => $this->getUserDetail('customerid'),
   423| 				'iddn' => ($id <= 0 ? $domainname : $id)
   424| 			];
   425| 		}
   426| 		$result = Database::pexecute_first($result_stmt, $params, true, true);
   427| 		if ($result) {
   428| 			$result['ipsandports'] = [];
   429| 			if ($with_ips) {
   430| 				$result['ipsandports'] = $this->getIpsForDomain($result['id']);
   431| 			}
   432| 			$result['domain_hascert'] = $this->getHasCertValueForDomain((int)$result['id'], (int)$result['parentdomainid']);
   433| 			$this->logger()->logAction($this->isAdmin() ? FroxlorLogger::ADM_ACTION : FroxlorLogger::USR_ACTION, LOG_INFO, "[API] get subdomain '" . $result['domain'] . "'");
   434| 			return $this->response($result);
   435| 		}
   436| 		$key = ($id > 0 ? "id #" . $id : "domainname '" . $domainname . "'");
   437| 		throw new Exception("Subdomain with " . $key . " could not be found", 404);
   438| 	}
   439| 	private function getHasCertValueForDomain(int $domainid, int $parentdomainid): int
   440| 	{
   441| 		$domain_hascert = 0;
   442| 		$ssl_stmt = Database::prepare("SELECT * FROM `" . TABLE_PANEL_DOMAIN_SSL_SETTINGS . "` WHERE `domainid` = :domainid");
   443| 		Database::pexecute($ssl_stmt, array(
   444| 			"domainid" => $domainid
   445| 		));
   446| 		$ssl_result = $ssl_stmt->fetch(PDO::FETCH_ASSOC);
   447| 		if (is_array($ssl_result) && isset($ssl_result['ssl_cert_file']) && $ssl_result['ssl_cert_file'] != '') {
   448| 			$domain_hascert = 1;
   449| 		} else {
   450| 			if ($parentdomainid != 0) {
   451| 				$ssl_stmt = Database::prepare("SELECT * FROM `" . TABLE_PANEL_DOMAIN_SSL_SETTINGS . "` WHERE `domainid` = :domainid");
   452| 				Database::pexecute($ssl_stmt, array(
   453| 					"domainid" => $parentdomainid
   454| 				));
   455| 				$ssl_result = $ssl_stmt->fetch(PDO::FETCH_ASSOC);
   456| 				if (is_array($ssl_result) && isset($ssl_result['ssl_cert_file']) && $ssl_result['ssl_cert_file'] != '') {
   457| 					$domain_hascert = 2;


# ====================================================================
# FILE: lib/Froxlor/Cli/MasterCron.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 51-90 ---
    51| 			->addOption('debug', 'd', InputOption::VALUE_NONE, 'Output debug information about what is going on to STDOUT.')
    52| 			->addOption('no-fork', 'N', InputOption::VALUE_NONE, 'Do not fork to background (traffic cron only).');
    53| 	}
    54| 	/**
    55| 	 * @throws Exception
    56| 	 */
    57| 	protected function execute(InputInterface $input, OutputInterface $output): int
    58| 	{
    59| 		$result = $this->validateRequirements($output);
    60| 		if ($result != self::SUCCESS) {
    61| 			return $result;
    62| 		}
    63| 		$jobs = $input->getArgument('job');
    64| 		if ($input->getOption('force')) {
    65| 			if (empty($jobs) || in_array('tasks', $jobs)) {
    66| 				Cronjob::inserttask(TaskId::REBUILD_VHOST);
    67| 				Cronjob::inserttask(TaskId::REBUILD_DNS);
    68| 				Cronjob::inserttask(TaskId::REBUILD_RSPAMD);
    69| 				Cronjob::inserttask(TaskId::CREATE_QUOTA);
    70| 				Cronjob::inserttask(TaskId::REBUILD_CRON);
    71| 				$jobs[] = 'tasks';
    72| 			}
    73| 			define('CRON_IS_FORCED', 1);
    74| 		}
    75| 		if ($input->getOption('debug')) {
    76| 			define('CRON_DEBUG_FLAG', 1);
    77| 		}
    78| 		if ($input->getOption('no-fork')) {
    79| 			define('CRON_NOFORK_FLAG', 1);
    80| 		}
    81| 		if ($input->getOption('run-task')) {
    82| 			$tasks_to_run = $input->getOption('run-task');
    83| 			foreach ($tasks_to_run as $ttr) {
    84| 				if (in_array($ttr, [TaskId::REBUILD_VHOST, TaskId::REBUILD_DNS, TaskId::REBUILD_RSPAMD, TaskId::CREATE_QUOTA, TaskId::REBUILD_CRON])) {
    85| 					Cronjob::inserttask($ttr);
    86| 					$jobs[] = 'tasks';
    87| 				} else {
    88| 					$output->writeln('<comment>Unknown task number "' . $ttr . '"</>');
    89| 				}
    90| 			}

# --- HUNK 2: Lines 138-179 ---
   138| 		if (((int)Settings::Get('system.mod_fcgid') == 1 && (int)Settings::Get('system.mod_fcgid_ownvhost') == 1) || ((int)Settings::Get('phpfpm.enabled') == 1 && (int)Settings::Get('phpfpm.enabled_ownvhost') == 1)) {
   139| 			$user = Settings::Get('system.mod_fcgid_httpuser');
   140| 			$group = Settings::Get('system.mod_fcgid_httpgroup');
   141| 			if (Settings::Get('phpfpm.enabled') == 1) {
   142| 				$user = Settings::Get('phpfpm.vhost_httpuser');
   143| 				$group = Settings::Get('phpfpm.vhost_httpgroup');
   144| 			}
   145| 			FileDir::safe_exec('chown -R ' . $user . ':' . $group . ' ' . escapeshellarg($_mypath));
   146| 		} else {
   147| 			$user = Settings::Get('system.httpuser');
   148| 			$group = Settings::Get('system.httpgroup');
   149| 			FileDir::safe_exec('chown -R ' . $user . ':' . $group . ' ' . escapeshellarg($_mypath));
   150| 		}
   151| 		$output->writeln('OK');
   152| 	}
   153| 	private function lockJob(string $job, OutputInterface $output): bool
   154| 	{
   155| 		$this->lockFile = '/run/lock/froxlor_' . $job . '.lock';
   156| 		if (file_exists($this->lockFile)) {
   157| 			$jobinfo = json_decode(file_get_contents($this->lockFile), true);
   158| 			$check_pid_return = null;
   159| 			system("kill -CHLD " . (int)$jobinfo['pid'] . " 1> /dev/null 2> /dev/null", $check_pid_return);
   160| 			if ($check_pid_return == 1) {
   161| 				$this->unlockJob();
   162| 			} else {
   163| 				$output->writeln([
   164| 					'<comment>Job "' . $jobinfo['job'] . '" is currently running.',
   165| 					'Started: ' . date('d.m.Y H:i', (int)$jobinfo['startts']),
   166| 					'PID: ' . $jobinfo['pid'] . '</>'
   167| 				]);
   168| 				return false;
   169| 			}
   170| 		}
   171| 		$jobinfo = [
   172| 			'job' => $job,
   173| 			'startts' => time(),
   174| 			'pid' => getmypid()
   175| 		];
   176| 		file_put_contents($this->lockFile, json_encode($jobinfo));
   177| 		return true;
   178| 	}
   179| 	private function unlockJob(): bool


# ====================================================================
# FILE: lib/Froxlor/Cron/Http/LetsEncrypt/AcmeSh.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 46-96 ---
    46| 		'google' => "https://dv.acme-v02.api.pki.goog/directory",
    47| 		'google_test' => "https://dv.acme-v02.test-api.pki.goog/directory",
    48| 	];
    49| 	public static $no_inserttask = false;
    50| 	private static $apiserver = "";
    51| 	private static $acmesh = "/root/.acme.sh/acme.sh";
    52| 	/**
    53| 	 *
    54| 	 * @var PDOStatement
    55| 	 */
    56| 	private static $updcert_stmt = null;
    57| 	/**
    58| 	 *
    59| 	 * @var PDOStatement
    60| 	 */
    61| 	private static $upddom_stmt = null;
    62| 	/**
    63| 	 * run the task
    64| 	 *
    65| 	 * @param bool $internal
    66| 	 * @return number
    67| 	 */
    68| 	public static function run(bool $internal = false)
    69| 	{
    70| 		if (!defined('CRON_IS_FORCED') && !defined('CRON_DEBUG_FLAG') && $internal == false) {
    71| 			$issue_froxlor = self::issueFroxlorVhost();
    72| 			$issue_domains = self::issueDomains();
    73| 			$renew_froxlor = self::renewFroxlorVhost();
    74| 			$renew_domains = self::renewDomains(true);
    75| 			if ($issue_froxlor || !empty($issue_domains) || !empty($renew_froxlor) || $renew_domains) {
    76| 				Cronjob::inserttask(TaskId::REBUILD_VHOST);
    77| 			}
    78| 			return 0;
    79| 		}
    80| 		self::$apiserver = self::ACME_PROVIDER[Settings::Get('system.letsencryptca')];
    81| 		if (!self::checkInstall()) {
    82| 			return -1;
    83| 		}
    84| 		self::checkUpgrade();
    85| 		$changedetected = 0;
    86| 		self::$updcert_stmt = Database::prepare("
    87| 			REPLACE INTO
    88| 				`" . TABLE_PANEL_DOMAIN_SSL_SETTINGS . "`
    89| 			SET
    90| 				`id` = :id,
    91| 				`domainid` = :domainid,
    92| 				`ssl_cert_file` = :crt,
    93| 				`ssl_key_file` = :key,
    94| 				`ssl_ca_file` = :ca,
    95| 				`ssl_cert_chainfile` = :chain,
    96| 				`ssl_csr_file` = :csr,

# --- HUNK 2: Lines 160-211 ---
   160| 			]);
   161| 			if (defined('CRON_IS_FORCED') || self::checkFsFilesAreNewer($domain['domain'], $domain['validtodate'])) {
   162| 				self::certToDb($domain, $cronlog, []);
   163| 				$changedetected = 1;
   164| 			}
   165| 		}
   166| 		if ($changedetected) {
   167| 			if (self::$no_inserttask == false) {
   168| 				Cronjob::inserttask(TaskId::REBUILD_VHOST);
   169| 			}
   170| 			FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, "Let's Encrypt certificates have been updated");
   171| 		} else {
   172| 			FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, "No new certificates or certificate updates found");
   173| 		}
   174| 		return 0;
   175| 	}
   176| 	/**
   177| 	 * check whether we need to issue a new certificate for froxlor itself
   178| 	 *
   179| 	 * @return boolean
   180| 	 */
   181| 	private static function issueFroxlorVhost()
   182| 	{
   183| 		if (Settings::Get('system.le_froxlor_enabled') == '1') {
   184| 			$froxlor_ssl_settings_stmt = Database::prepare("
   185| 				SELECT * FROM `" . TABLE_PANEL_DOMAIN_SSL_SETTINGS . "`
   186| 				WHERE `domainid` = '0'
   187| 			");
   188| 			$froxlor_ssl = Database::pexecute_first($froxlor_ssl_settings_stmt);
   189| 			if (($froxlor_ssl && empty($froxlor_ssl['validtodate']))
   190| 				|| (!$froxlor_ssl && !self::checkFsFilesAreNewer(Settings::Get('system.hostname'), date('Y-m-d H:i:s')))
   191| 			) {
   192| 				return true;
   193| 			}
   194| 		}
   195| 		return false;
   196| 	}
   197| 	private static function checkFsFilesAreNewer($domain, $cert_date = 0): bool
   198| 	{
   199| 		$certificate_folder = self::getCertificateFolder(strtolower($domain));
   200| 		if (empty($certificate_folder)) {
   201| 			return false;
   202| 		}
   203| 		$ssl_file = FileDir::makeCorrectFile($certificate_folder . '/' . strtolower($domain) . '.cer');
   204| 		if (is_dir($certificate_folder) && file_exists($ssl_file) && is_readable($ssl_file)) {
   205| 			$cert_data = openssl_x509_parse(file_get_contents($ssl_file));
   206| 			if ($cert_data && $cert_data['validTo_time_t'] > strtotime($cert_date)) {
   207| 				return true;
   208| 			}
   209| 		}
   210| 		return false;
   211| 	}

# --- HUNK 3: Lines 271-310 ---
   271| 				dom.`customerid` = cust.`customerid`
   272| 				AND cust.deactivated = 0
   273| 				AND dom.deactivated = 0
   274| 				AND dom.`ssl_enabled` = 1
   275| 				AND dom.`letsencrypt` = 1
   276| 				AND dom.`aliasdomain` IS NULL
   277| 				AND dom.`iswildcarddomain` = 0
   278| 				AND dom.`email_only` = 0
   279| 				AND domssl.`validtodate` IS NULL
   280| 		");
   281| 		$customer_ssl = $certificates_stmt->fetchAll(PDO::FETCH_ASSOC);
   282| 		if ($customer_ssl) {
   283| 			return $customer_ssl;
   284| 		}
   285| 		return [];
   286| 	}
   287| 	/**
   288| 	 * check whether we need to renew-check the certificate for froxlor itself
   289| 	 *
   290| 	 * @return boolean
   291| 	 */
   292| 	private static function renewFroxlorVhost()
   293| 	{
   294| 		if (Settings::Get('system.le_froxlor_enabled') == '1') {
   295| 			$froxlor_ssl_settings_stmt = Database::prepare("
   296| 				SELECT * FROM `" . TABLE_PANEL_DOMAIN_SSL_SETTINGS . "`
   297| 				WHERE `domainid` = '0'
   298| 			");
   299| 			$froxlor_ssl = Database::pexecute_first($froxlor_ssl_settings_stmt);
   300| 			if ($froxlor_ssl && self::checkFsFilesAreNewer(Settings::Get('system.hostname'), $froxlor_ssl['validtodate'])) {
   301| 				return $froxlor_ssl;
   302| 			}
   303| 		}
   304| 		return false;
   305| 	}
   306| 	/**
   307| 	 * get a list of domains that have a lets encrypt certificate (possible renew)
   308| 	 */
   309| 	private static function renewDomains($check = false)
   310| 	{

# --- HUNK 4: Lines 319-358 ---
   319| 				domssl.`ssl_key_file`,
   320| 				dom.`domain`,
   321| 				dom.`id` AS 'domainid',
   322| 				dom.`ssl_redirect`,
   323| 				cust.`loginname`
   324| 			FROM
   325| 				`" . TABLE_PANEL_CUSTOMERS . "` AS cust,
   326| 				`" . TABLE_PANEL_DOMAINS . "` AS dom
   327| 			LEFT JOIN
   328| 				`" . TABLE_PANEL_DOMAIN_SSL_SETTINGS . "` AS domssl ON
   329| 					dom.`id` = domssl.`domainid`
   330| 			WHERE
   331| 				dom.`customerid` = cust.`customerid`
   332| 				AND cust.deactivated = 0
   333| 				AND dom.deactivated = 0
   334| 				AND dom.`ssl_enabled` = 1
   335| 				AND dom.`letsencrypt` = 1
   336| 				AND dom.`aliasdomain` IS NULL
   337| 				AND dom.`iswildcarddomain` = 0
   338| 				AND dom.`email_only` = 0
   339| 		");
   340| 		$renew_certs = $certificates_stmt->fetchAll(PDO::FETCH_ASSOC);
   341| 		if ($renew_certs) {
   342| 			if ($check) {
   343| 				foreach ($renew_certs as $cert) {
   344| 					if (self::checkFsFilesAreNewer($cert['domain'], $cert['validtodate'])) {
   345| 						return true;
   346| 					}
   347| 				}
   348| 				return false;
   349| 			}
   350| 			return $renew_certs;
   351| 		}
   352| 		return [];
   353| 	}
   354| 	/**
   355| 	 * install acme.sh if not found yet
   356| 	 */
   357| 	private static function checkInstall($tries = 0)
   358| 	{

# --- HUNK 5: Lines 447-486 ---
   447| 						if ($aliasdomain['wwwserveralias'] == 1) {
   448| 							$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, "Adding SAN entry: www." . $aliasdomain['domain']);
   449| 							$domains[] = strtolower('www.' . $aliasdomain['domain']);
   450| 						}
   451| 					}
   452| 				}
   453| 				self::validateDns($domains, $certrow['domainid'], $cronlog);
   454| 				self::runAcmeSh($certrow, $domains, $cronlog, $do_force, $certrow['domainid'] == 0);
   455| 			} else {
   456| 				$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_WARNING, "Skipping Let's Encrypt generation for " . $certrow['domain'] . " due to an enabled ssl_redirect");
   457| 				Cronjob::inserttask(TaskId::REBUILD_VHOST);
   458| 			}
   459| 		}
   460| 	}
   461| 	/**
   462| 	 * validate dns (A / AAAA record) of domain against known system ips
   463| 	 *
   464| 	 * @param array $domains
   465| 	 * @param int $domain_id
   466| 	 * @param FroxlorLogger $cronlog
   467| 	 */
   468| 	private static function validateDns(array &$domains, $domain_id, &$cronlog)
   469| 	{
   470| 		if (Settings::Get('system.le_domain_dnscheck') == '1' && !empty($domains)) {
   471| 			$loop_domains = $domains;
   472| 			$our_ips = Domain::getIpsOfDomain($domain_id);
   473| 			foreach ($loop_domains as $idx => $domain) {
   474| 				$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, "Validating DNS of " . $domain);
   475| 				$domain_ips = PhpHelper::gethostbynamel6($domain, true, Settings::Get('system.le_domain_dnscheck_resolver'));
   476| 				if ($domain_ips == false || count(array_intersect($our_ips, $domain_ips)) <= 0) {
   477| 					$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_WARNING, "Skipping Let's Encrypt generation for " . $domain . " due to no system known IP address via DNS check");
   478| 					unset($domains[$idx]);
   479| 					if ($domain_id > 0) {
   480| 						$upd_stmt = Database::prepare("UPDATE `" . TABLE_PANEL_DOMAINS . "` SET `letsencrypt` = '0' WHERE `id` = :did");
   481| 						Database::pexecute($upd_stmt, [
   482| 							'did' => $domain_id
   483| 						]);
   484| 					} else {
   485| 						Settings::Set('system.le_froxlor_enabled', 0);
   486| 					}

# --- HUNK 6: Lines 514-595 ---
   514| 			if ($renew_hook
   515| 				&& !empty(trim(Settings::Get('system.le_renew_services') ?? ""))
   516| 				&& !empty(trim(Settings::Get('system.le_renew_hook') ?? ""))
   517| 			) {
   518| 				$acmesh_cmd .= " --renew-hook '" . Settings::Get('system.le_renew_hook') . "'";
   519| 			}
   520| 			if (defined('CRON_DEBUG_FLAG')) {
   521| 				$acmesh_cmd .= " --debug";
   522| 			}
   523| 			$exit_code = null;
   524| 			$acme_result = FileDir::safe_exec($acmesh_cmd, $exit_code);
   525| 			$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_DEBUG, implode("\n", $acme_result));
   526| 			if ($exit_code != 0) {
   527| 				$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_DEBUG, "Non-successful exit-code returned :(");
   528| 				if (!defined('CRON_IS_FORCED') && !defined('CRON_DEBUG_FLAG')) {
   529| 					Cronjob::notifyMailToAdmin("Let's Encrypt certificate could not be obtained for: " . implode(", ", $domains) . "\n\n" . implode("\n", $acme_result));
   530| 				}
   531| 			} else {
   532| 				$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_DEBUG, "Successful exit-code returned - storing certificate");
   533| 				$cert_stored = self::certToDb($certrow, $cronlog, $acme_result);
   534| 				if ($cert_stored
   535| 					&& $renew_hook
   536| 					&& !empty(trim(Settings::Get('system.le_renew_services') ?? ""))
   537| 					&& !empty(trim(Settings::Get('system.le_renew_hook') ?? ""))
   538| 				) {
   539| 					$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_DEBUG, "Renew-hook is enabled - adjusting configurations");
   540| 					$certificate_folder = self::getCertificateFolder(strtolower(Settings::Get('system.hostname')));
   541| 					$fullchain = FileDir::makeCorrectFile($certificate_folder . '/fullchain.cer');
   542| 					$keyfile = FileDir::makeCorrectFile($certificate_folder . '/' . strtolower(Settings::Get('system.hostname')) . '.key');
   543| 					$ca_file = FileDir::makeCorrectFile($certificate_folder . '/ca.cer');
   544| 					if (Settings::IsInList('system.le_renew_services', 'postfix')) {
   545| 						FileDir::safe_exec('postconf -e smtpd_tls_cert_file=' . escapeshellarg($fullchain));
   546| 						FileDir::safe_exec('postconf -e smtpd_tls_key_file=' . escapeshellarg($keyfile));
   547| 					}
   548| 					if (Settings::IsInList('system.le_renew_services', 'dovecot')) {
   549| 						$dovecot_conf = '/etc/dovecot/conf.d/99-froxlor.ssl.conf'; // @fixme setting?
   550| 						$ssl_content = <<<EOSSL
   551| ssl = yes
   552| ssl_cert = <{$fullchain}
   553| ssl_key = <{$keyfile}
   554| EOSSL;
   555| 						file_put_contents($dovecot_conf, $ssl_content);
   556| 					}
   557| 					if (Settings::IsInList('system.le_renew_services', 'proftpd')) {
   558| 						$proftpd_conf = '/etc/proftpd/tls.conf'; // @fixme setting?
   559| 						$rval = false;
   560| 						if (strpos($certificate_folder, '_ecc') === false) {
   561| 							FileDir::safe_exec("sed -i.bak 's|^TLSECCertificateFile|# TLSECCertificateFile|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   562| 							FileDir::safe_exec("sed -i.bak 's|^TLSECCertificateKeyFile|# TLSECCertificateKeyFile|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   563| 							FileDir::safe_exec("sed -i.bak 's|^#\?\s\?TLSRSACertificateFile.*|TLSRSACertificateFile " . $fullchain . "|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   564| 							FileDir::safe_exec("sed -i.bak 's|^#\?\s\?TLSRSACertificateKeyFile.*|TLSRSACertificateKeyFile " . $keyfile . "|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   565| 						} else {
   566| 							FileDir::safe_exec("sed -i.bak 's|^TLSRSACertificateFile|# TLSRSACertificateFile|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   567| 							FileDir::safe_exec("sed -i.bak 's|^TLSRSACertificateKeyFile|# TLSRSACertificateKeyFile|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   568| 							FileDir::safe_exec("sed -i.bak 's|^#\?\s\?TLSECCertificateFile.*|TLSECCertificateFile " . $fullchain . "|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   569| 							FileDir::safe_exec("sed -i.bak 's|^#\?\s\?TLSECCertificateKeyFile.*|TLSECCertificateKeyFile " . $keyfile . "|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   570| 						}
   571| 						FileDir::safe_exec("sed -i.bak 's|^#\?\s\?TLSCACertificateFile.*|TLSCACertificateFile " . $ca_file . "|' " . escapeshellarg($proftpd_conf), $rval, ['|', '?']);
   572| 					}
   573| 					FileDir::safe_exec(Settings::Get('system.le_renew_hook'));
   574| 				}
   575| 			}
   576| 		}
   577| 	}
   578| 	private static function certToDb($certrow, &$cronlog, $acme_result): bool
   579| 	{
   580| 		$return = [];
   581| 		self::readCertificateToVar(strtolower($certrow['domain']), $return, $cronlog);
   582| 		if (!empty($return['crt'])) {
   583| 			$newcert = openssl_x509_parse($return['crt']);
   584| 			if ($newcert) {
   585| 				Database::pexecute(self::$updcert_stmt, [
   586| 					'id' => $certrow['id'],
   587| 					'domainid' => $certrow['domainid'],
   588| 					'crt' => $return['crt'],
   589| 					'key' => $return['key'],
   590| 					'ca' => $return['chain'],
   591| 					'chain' => $return['chain'],
   592| 					'csr' => $return['csr'],
   593| 					'fullchain' => $return['fullchain'],
   594| 					'validfromdate' => date('Y-m-d H:i:s', $newcert['validFrom_time_t']),
   595| 					'validtodate' => date('Y-m-d H:i:s', $newcert['validTo_time_t']),


# ====================================================================
# FILE: lib/Froxlor/Cron/System/TasksCron.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 9-48 ---
     9|  * of the License, or (at your option) any later version.
    10|  *
    11|  * This program is distributed in the hope that it will be useful,
    12|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program; if not, you can also view it online at
    18|  * https://files.froxlor.org/misc/COPYING.txt
    19|  *
    20|  * @copyright  the authors
    21|  * @author     Froxlor team <team@froxlor.org>
    22|  * @license    https://files.froxlor.org/misc/COPYING.txt GPLv2
    23|  */
    24| namespace Froxlor\Cron\System;
    25| use Exception;
    26| use Froxlor\Cron\FroxlorCron;
    27| use Froxlor\Cron\Http\ConfigIO;
    28| use Froxlor\Cron\Http\HttpConfigBase;
    29| use Froxlor\Cron\Mail\Rspamd;
    30| use Froxlor\Cron\TaskId;
    31| use Froxlor\Database\Database;
    32| use Froxlor\Dns\PowerDNS;
    33| use Froxlor\Domain\Domain;
    34| use Froxlor\FileDir;
    35| use Froxlor\FroxlorLogger;
    36| use Froxlor\Settings;
    37| use PDO;
    38| class TasksCron extends FroxlorCron
    39| {
    40| 	/**
    41| 	 * @throws Exception
    42| 	 */
    43| 	public static function run()
    44| 	{
    45| 		/**
    46| 		 * LOOK INTO TASKS TABLE TO SEE IF THERE ARE ANY UNDONE JOBS
    47| 		 */
    48| 		self::$cronlog->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, "TasksCron: Searching for tasks to do");

# --- HUNK 2: Lines 98-137 ---
    98| 				 * TYPE=9 Rebuild antispam config
    99| 				 */
   100| 				self::rebuildAntiSpamConfigs();
   101| 			} elseif ($row['type'] == TaskId::CREATE_QUOTA && (int)Settings::Get('system.diskquota_enabled') != 0) {
   102| 				/**
   103| 				 * TYPE=10 Set the filesystem - quota
   104| 				 */
   105| 				self::setFilesystemQuota();
   106| 			} elseif ($row['type'] == TaskId::DELETE_DOMAIN_PDNS && Settings::Get('system.dns_server') == 'PowerDNS') {
   107| 				/**
   108| 				 * TYPE=11 domain has been deleted, remove from pdns database if used
   109| 				 */
   110| 				FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_NOTICE, "Removing PowerDNS entries for domain " . $row['data']['domain']);
   111| 				PowerDNS::cleanDomainZone($row['data']['domain']);
   112| 			} elseif ($row['type'] == TaskId::DELETE_DOMAIN_SSL) {
   113| 				/**
   114| 				 * TYPE=12 domain has been deleted, remove from acme.sh/let's encrypt directory if used
   115| 				 */
   116| 				FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_NOTICE, "Removing Let's Encrypt entries for domain " . $row['data']['domain']);
   117| 				Domain::doLetsEncryptCleanUp($row['data']['domain']);
   118| 			}
   119| 		}
   120| 		if ($num_results != 0) {
   121| 			$where = [];
   122| 			$where_data = [];
   123| 			foreach ($resultIDs as $id) {
   124| 				$where[] = "`id` = :id_" . (int)$id;
   125| 				$where_data['id_' . $id] = $id;
   126| 			}
   127| 			$where = implode(' OR ', $where);
   128| 			$del_stmt = Database::prepare("DELETE FROM `" . TABLE_PANEL_TASKS . "` WHERE " . $where);
   129| 			Database::pexecute($del_stmt, $where_data);
   130| 			unset($resultIDs);
   131| 			unset($where);
   132| 		}
   133| 		Database::query("UPDATE `" . TABLE_PANEL_SETTINGS . "` SET `value` = UNIX_TIMESTAMP() WHERE `settinggroup` = 'system' AND `varname` = 'last_tasks_run';");
   134| 	}
   135| 	private static function rebuildWebserverConfigs()
   136| 	{
   137| 		if (Settings::Get('system.webserver') == "apache2") {

# --- HUNK 3: Lines 251-293 ---
   251| 					FileDir::safe_exec('rm -rf ' . escapeshellarg($homedir));
   252| 				}
   253| 				$maildir = FileDir::makeCorrectDir(Settings::Get('system.vmail_homedir') . '/' . $row['data']['loginname']);
   254| 				if (file_exists($maildir) && $maildir != '/' && $maildir != Settings::Get('system.vmail_homedir') && substr($maildir, 0, strlen(Settings::Get('system.vmail_homedir'))) == Settings::Get('system.vmail_homedir') && is_dir($maildir) && fileowner($maildir) == Settings::Get('system.vmail_uid') && filegroup($maildir) == Settings::Get('system.vmail_gid')) {
   255| 					FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_NOTICE, 'Running: rm -rf ' . escapeshellarg($maildir));
   256| 					$return = false;
   257| 					FileDir::safe_exec('rm -rf ' . escapeshellarg($maildir), $return, [
   258| 						'|',
   259| 						'&',
   260| 						'`',
   261| 						'$',
   262| 						'?'
   263| 					]);
   264| 				}
   265| 				$tmpdir = FileDir::makeCorrectDir(Settings::Get('system.mod_fcgid_tmpdir') . '/' . $row['data']['loginname'] . '/');
   266| 				if (file_exists($tmpdir) && is_dir($tmpdir) && $tmpdir != "/" && $tmpdir != Settings::Get('system.mod_fcgid_tmpdir') && substr($tmpdir, 0, strlen(Settings::Get('system.mod_fcgid_tmpdir'))) == Settings::Get('system.mod_fcgid_tmpdir')) {
   267| 					FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_NOTICE, 'Running: rm -rf ' . escapeshellarg($tmpdir));
   268| 					FileDir::safe_exec('rm -rf ' . escapeshellarg($tmpdir));
   269| 				}
   270| 				$logsdir = FileDir::makeCorrectFile(Settings::Get('system.logfiles_directory') . '/' . $row['data']['loginname']);
   271| 				if (file_exists($logsdir) && $logsdir != '/' && $logsdir != FileDir::makeCorrectDir(Settings::Get('system.logfiles_directory')) && substr($logsdir, 0, strlen(Settings::Get('system.logfiles_directory'))) == Settings::Get('system.logfiles_directory')) {
   272| 					$logsdir .= '-*';
   273| 					FileDir::safe_exec('rm -f ' . escapeshellarg($logsdir));
   274| 				}
   275| 			}
   276| 		}
   277| 	}
   278| 	private static function deleteEmailData($row = null)
   279| 	{
   280| 		FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_INFO, 'TasksCron: Task7 started - deleting customer e-mail data');
   281| 		if (is_array($row['data'])) {
   282| 			if (isset($row['data']['loginname']) && isset($row['data']['emailpath'])) {
   283| 				$email_full = $row['data']['emailpath'];
   284| 				if (empty($email_full)) {
   285| 					FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_ERR, 'FATAL: Task7 asks to delete a email account but emailpath field is empty!');
   286| 				}
   287| 				$maildir = FileDir::makeCorrectDir($email_full);
   288| 				if ($maildir != '/' && !empty($maildir) && $maildir != Settings::Get('system.vmail_homedir') && substr($maildir, 0, strlen(Settings::Get('system.vmail_homedir'))) == Settings::Get('system.vmail_homedir') && is_dir($maildir) && fileowner($maildir) == Settings::Get('system.vmail_uid') && filegroup($maildir) == Settings::Get('system.vmail_gid')) {
   289| 					FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_NOTICE, 'Running: rm -rf ' . escapeshellarg($maildir));
   290| 					$return = false;
   291| 					FileDir::safe_exec('rm -rf ' . escapeshellarg($maildir), $return, [
   292| 						'|',
   293| 						'&',


# ====================================================================
# FILE: lib/Froxlor/Cron/TaskId.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 56-95 ---
    56| 	 */
    57| 	const DELETE_FTP_DATA = 8;
    58| 	/**
    59| 	 * TYPE=9 MEANS THAT SOMETHING ANTISPAM RELATED HAS CHANGED.
    60| 	 * REBUILD froxlor_settings.conf IF ANTISPAM IS ENABLED
    61| 	 */
    62| 	const REBUILD_RSPAMD = 9;
    63| 	/**
    64| 	 * TYPE=10 Set the filesystem - quota
    65| 	 */
    66| 	const CREATE_QUOTA = 10;
    67| 	/**
    68| 	 * TYPE=11 domain has been deleted, remove from pdns database if used
    69| 	 */
    70| 	const DELETE_DOMAIN_PDNS = 11;
    71| 	/**
    72| 	 * TYPE=12 domain has been deleted, remove from acme.sh/let's encrypt directory if used
    73| 	 */
    74| 	const DELETE_DOMAIN_SSL = 12;
    75| 	/**
    76| 	 * TYPE=20 CUSTUMER DATA DUMP
    77| 	 */
    78| 	const CREATE_CUSTOMER_DATADUMP = 20;
    79| 	/**
    80| 	 * TYPE=99 REGENERATE CRON
    81| 	 */
    82| 	const REBUILD_CRON = 99;
    83| 	/**
    84| 	 * Return if a cron task id is valid
    85| 	 *
    86| 	 * @param int|string $id cron task id (legacy string support)
    87| 	 * @return boolean
    88| 	 */
    89| 	public static function isValid($id)
    90| 	{
    91| 		static $reflContants;
    92| 		if (!is_numeric($id)) {
    93| 			return false;
    94| 		}
    95| 		$numericid = (int)$id;


# ====================================================================
# FILE: lib/Froxlor/Cron/Traffic/ReportsCron.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 95-135 ---
    95| 					Language::setLanguage($row['def_language']);
    96| 					$result2_stmt = Database::prepare("
    97| 						SELECT `value` FROM `" . TABLE_PANEL_TEMPLATES . "`
    98| 						WHERE `adminid` = :adminid
    99| 						AND `language` = :lang
   100| 						AND `templategroup` = 'mails' AND `varname` = :varname
   101| 					");
   102| 					$result2_data = [
   103| 						'adminid' => $row['adminid'],
   104| 						'lang' => $row['def_language'],
   105| 						'varname' => 'trafficmaxpercent_subject'
   106| 					];
   107| 					$result2 = Database::pexecute_first($result2_stmt, $result2_data);
   108| 					$mail_subject = html_entity_decode(PhpHelper::replaceVariables((($result2 !== false && $result2['value'] != '') ? $result2['value'] : Language::getTranslation('mails.trafficmaxpercent.subject')), $replace_arr));
   109| 					$result2_data['varname'] = 'trafficmaxpercent_mailbody';
   110| 					$result2 = Database::pexecute_first($result2_stmt, $result2_data);
   111| 					$mail_body = html_entity_decode(PhpHelper::replaceVariables((($result2 !== false && $result2['value'] != '') ? $result2['value'] : Language::getTranslation('mails.trafficmaxpercent.mailbody')), $replace_arr));
   112| 					$_mailerror = false;
   113| 					$mailerr_msg = "";
   114| 					try {
   115| 						$mail->SetFrom($row['adminmail'], $row['adminname']);
   116| 						$mail->Subject = $mail_subject;
   117| 						$mail->AltBody = $mail_body;
   118| 						$mail->MsgHTML(nl2br($mail_body));
   119| 						$mail->AddAddress($row['email'], $row['firstname'] . ' ' . $row['name']);
   120| 						$mail->Send();
   121| 					} catch (\PHPMailer\PHPMailer\Exception $e) {
   122| 						$mailerr_msg = $e->errorMessage();
   123| 						$_mailerror = true;
   124| 					} catch (Exception $e) {
   125| 						$mailerr_msg = $e->getMessage();
   126| 						$_mailerror = true;
   127| 					}
   128| 					if ($_mailerror) {
   129| 						FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_ERR, 'Error sending mail: ' . $mailerr_msg);
   130| 						echo 'Error sending mail: ' . $mailerr_msg . "\n";
   131| 					}
   132| 					$mail->ClearAddresses();
   133| 					Database::pexecute($upd_stmt, [
   134| 						'customerid' => $row['customerid']
   135| 					]);

# --- HUNK 2: Lines 330-370 ---
   330| 					Language::setLanguage($row['def_language']);
   331| 					$result2_stmt = Database::prepare("
   332| 						SELECT `value` FROM `" . TABLE_PANEL_TEMPLATES . "`
   333| 						WHERE `adminid` = :adminid
   334| 						AND `language` = :lang
   335| 						AND `templategroup` = 'mails' AND `varname` = :varname
   336| 					");
   337| 					$result2_data = [
   338| 						'adminid' => $row['adminid'],
   339| 						'lang' => $row['def_language'],
   340| 						'varname' => 'diskmaxpercent_subject'
   341| 					];
   342| 					$result2 = Database::pexecute_first($result2_stmt, $result2_data);
   343| 					$mail_subject = html_entity_decode(PhpHelper::replaceVariables((($result2 !== false && $result2['value'] != '') ? $result2['value'] : Language::getTranslation('mails.diskmaxpercent.subject')), $replace_arr));
   344| 					$result2_data['varname'] = 'diskmaxpercent_mailbody';
   345| 					$result2 = Database::pexecute_first($result2_stmt, $result2_data);
   346| 					$mail_body = html_entity_decode(PhpHelper::replaceVariables((($result2 !== false && $result2['value'] != '') ? $result2['value'] : Language::getTranslation('mails.diskmaxpercent.mailbody')), $replace_arr));
   347| 					$_mailerror = false;
   348| 					$mailerr_msg = "";
   349| 					try {
   350| 						$mail->SetFrom($row['adminmail'], $row['adminname']);
   351| 						$mail->Subject = $mail_subject;
   352| 						$mail->AltBody = $mail_body;
   353| 						$mail->MsgHTML(nl2br($mail_body));
   354| 						$mail->AddAddress($row['email'], $row['name']);
   355| 						$mail->Send();
   356| 					} catch (\PHPMailer\PHPMailer\Exception $e) {
   357| 						$mailerr_msg = $e->errorMessage();
   358| 						$_mailerror = true;
   359| 					} catch (Exception $e) {
   360| 						$mailerr_msg = $e->getMessage();
   361| 						$_mailerror = true;
   362| 					}
   363| 					if ($_mailerror) {
   364| 						FroxlorLogger::getInstanceOf()->logAction(FroxlorLogger::CRON_ACTION, LOG_ERR, "Error sending mail: " . $mailerr_msg);
   365| 						echo "Error sending mail: " . $mailerr_msg . "\n";
   366| 					}
   367| 					$mail->ClearAddresses();
   368| 					Database::pexecute($upd_stmt, [
   369| 						'customerid' => $row['customerid']
   370| 					]);


# ====================================================================
# FILE: lib/Froxlor/Database/DbManager.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 73-169 ---
    73| 	 *
    74| 	 * @param array $mysql_access_host_array
    75| 	 *
    76| 	 * @return void
    77| 	 * @throws Exception
    78| 	 */
    79| 	public static function correctMysqlUsers(array $mysql_access_host_array)
    80| 	{
    81| 		$databases = [];
    82| 		$databases_result_stmt = Database::prepare("
    83| 			SELECT * FROM `" . TABLE_PANEL_DATABASES . "`
    84| 			ORDER BY `dbserver` ASC
    85| 		");
    86| 		Database::pexecute($databases_result_stmt);
    87| 		while ($databases_row = $databases_result_stmt->fetch(PDO::FETCH_ASSOC)) {
    88| 			if (!isset($databases[$databases_row['dbserver']])) {
    89| 				$databases[$databases_row['dbserver']] = [];
    90| 			}
    91| 			$databases[$databases_row['dbserver']][] = $databases_row['databasename'];
    92| 		}
    93| 		$dbservers_stmt = Database::query("SELECT DISTINCT `dbserver` FROM `" . TABLE_PANEL_DATABASES . "`");
    94| 		while ($dbserver = $dbservers_stmt->fetch(PDO::FETCH_ASSOC)) {
    95| 			Database::needRoot(true, $dbserver['dbserver'], false);
    96| 			$dbm = new DbManager(FroxlorLogger::getInstanceOf());
    97| 			$users = $dbm->getManager()->getAllSqlUsers(false);
    98| 			foreach ($databases[$dbserver['dbserver']] as $username) {
    99| 				if (isset($users[$username]['hosts']) && is_array($users[$username]['hosts'])) {
   100| 					$password = [
   101| 						'password' => $users[$username]['password'],
   102| 						'plugin' => $users[$username]['plugin']
   103| 					];
   104| 					foreach ($mysql_access_host_array as $mysql_access_host) {
   105| 						$mysql_access_host = trim($mysql_access_host);
   106| 						if (!in_array($mysql_access_host, $users[$username]['hosts'])) {
   107| 							$dbm->getManager()->grantPrivilegesTo($username, $password, $mysql_access_host, true);
   108| 						}
   109| 					}
   110| 					foreach ($users[$username]['hosts'] as $mysql_access_host) {
   111| 						if (!in_array($mysql_access_host, $mysql_access_host_array)) {
   112| 							$dbm->getManager()->deleteUser($username, $mysql_access_host);
   113| 						}
   114| 					}
   115| 				}
   116| 			}
   117| 			$dbm->getManager()->flushPrivileges();
   118| 			Database::needRoot(false);
   119| 		}
   120| 	}
   121| 	/**
   122| 	 * creates a new database and a user with the
   123| 	 * same name with all privileges granted on the db.
   124| 	 * DB-name and user-name are being generated and
   125| 	 * the password for the user will be set
   126| 	 *
   127| 	 * @param ?string $loginname
   128| 	 * @param ?string $password
   129| 	 * @param int $dbserver
   130| 	 * @param int $last_accnumber
   131| 	 *
   132| 	 * @return string|bool $username if successful or false of username is equal to the password
   133| 	 * @throws Exception
   134| 	 */
   135| 	public function createDatabase(string $loginname = null, string $password = null, int $dbserver = 0, int $last_accnumber = 0)
   136| 	{
   137| 		Database::needRoot(true, $dbserver, false);
   138| 		if (strtoupper(Settings::Get('customer.mysqlprefix')) == 'RANDOM') {
   139| 			$allsqlusers = $this->getManager()->getAllSqlUsers();
   140| 			$username = $loginname . '-' . substr(Froxlor::genSessionId(), 20, 3);
   141| 			while (in_array($username, $allsqlusers)) {
   142| 				$username = $loginname . '-' . substr(Froxlor::genSessionId(), 20, 3);
   143| 			}
   144| 		} elseif (strtoupper(Settings::Get('customer.mysqlprefix')) == 'DBNAME') {
   145| 			$username = $loginname;
   146| 		} else {
   147| 			$username = $loginname . Settings::Get('customer.mysqlprefix') . (intval($last_accnumber) + 1);
   148| 		}
   149| 		if ($username == $password) {
   150| 			return false;
   151| 		}
   152| 		$this->getManager()->createDatabase($username);
   153| 		foreach (array_map('trim', explode(',', Settings::Get('system.mysql_access_host'))) as $mysql_access_host) {
   154| 			$this->getManager()->grantPrivilegesTo($username, $password, $mysql_access_host);
   155| 		}
   156| 		$this->getManager()->flushPrivileges();
   157| 		Database::needRoot(false);
   158| 		$this->log->logAction(FroxlorLogger::USR_ACTION, LOG_INFO, "created database '" . $username . "'");
   159| 		return $username;
   160| 	}
   161| 	/**
   162| 	 * returns the manager-object
   163| 	 * from where we can control it
   164| 	 */
   165| 	public function getManager()
   166| 	{
   167| 		return $this->manager;
   168| 	}
   169| }


# ====================================================================
# FILE: lib/Froxlor/Database/Manager/DbManagerMySQL.php
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 81-176 ---
    81| 		}
    82| 		if (!$update) {
    83| 			if ($p_encrypted) {
    84| 				if (version_compare(Database::getAttribute(\PDO::ATTR_SERVER_VERSION), '5.7.0', '<') || version_compare(Database::getAttribute(\PDO::ATTR_SERVER_VERSION), '10.0.0', '>=')) {
    85| 					$stmt = Database::prepare("
    86| 						CREATE USER '" . $username . "'@'" . $access_host . "' IDENTIFIED BY PASSWORD :password
    87| 					");
    88| 				} else {
    89| 					$stmt = Database::prepare("
    90| 						CREATE USER '" . $username . "'@'" . $access_host . "' IDENTIFIED WITH " . $pwd_plugin . " AS :password
    91| 					");
    92| 				}
    93| 			} else {
    94| 				$stmt = Database::prepare("
    95| 					CREATE USER '" . $username . "'@'" . $access_host . "' IDENTIFIED BY :password
    96| 				");
    97| 			}
    98| 			Database::pexecute($stmt, [
    99| 				"password" => $password
   100| 			]);
   101| 			$stmt = Database::prepare("
   102| 				GRANT ALL ON `" . $username . ($grant_access_prefix ? '%' : '') . "`.* TO :username@:host
   103| 			");
   104| 			Database::pexecute($stmt, [
   105| 				"username" => $username,
   106| 				"host" => $access_host
   107| 			]);
   108| 		} else {
   109| 			if (version_compare(Database::getAttribute(\PDO::ATTR_SERVER_VERSION), '5.7.6', '<') || version_compare(Database::getAttribute(\PDO::ATTR_SERVER_VERSION), '10.0.0', '>=')) {
   110| 				if ($p_encrypted) {
   111| 					$stmt = Database::prepare("SET PASSWORD FOR :username@:host = :password");
   112| 				} else {
   113| 					$stmt = Database::prepare("SET PASSWORD FOR :username@:host = PASSWORD(:password)");
   114| 				}
   115| 			} else {
   116| 				if ($p_encrypted) {
   117| 					$stmt = Database::prepare("ALTER USER :username@:host IDENTIFIED WITH " . $pwd_plugin . " AS :password");
   118| 				} else {
   119| 					$stmt = Database::prepare("ALTER USER :username@:host IDENTIFIED BY :password");
   120| 				}
   121| 			}
   122| 			Database::pexecute($stmt, [
   123| 				"username" => $username,
   124| 				"host" => $access_host,
   125| 				"password" => $password
   126| 			]);
   127| 		}
   128| 	}
   129| 	/**
   130| 	 * removes the given database from the dbms and also
   131| 	 * takes away any privileges from a user to that db
   132| 	 *
   133| 	 * @param string $dbname
   134| 	 * @throws \Exception
   135| 	 */
   136| 	public function deleteDatabase(string $dbname)
   137| 	{
   138| 		if (version_compare(Database::getAttribute(PDO::ATTR_SERVER_VERSION), '5.0.2', '<')) {
   139| 			$stmt = Database::prepare("REVOKE ALL PRIVILEGES, GRANT OPTION FROM `" . $dbname . "`");
   140| 			Database::pexecute($stmt, [], false);
   141| 		}
   142| 		$host_res_stmt = Database::prepare("
   143| 			SELECT `Host` FROM `mysql`.`user` WHERE `User` = :dbname");
   144| 		Database::pexecute($host_res_stmt, [
   145| 			'dbname' => $dbname
   146| 		]);
   147| 		if (version_compare(Database::getAttribute(PDO::ATTR_SERVER_VERSION), '5.7.0', '<')) {
   148| 			$drop_stmt = Database::prepare("DROP USER :dbname@:host");
   149| 		} else {
   150| 			$drop_stmt = Database::prepare("DROP USER IF EXISTS :dbname@:host");
   151| 		}
   152| 		while ($host = $host_res_stmt->fetch(PDO::FETCH_ASSOC)) {
   153| 			Database::pexecute($drop_stmt, [
   154| 				'dbname' => $dbname,
   155| 				'host' => $host['Host']
   156| 			], false);
   157| 		}
   158| 		$drop_stmt = Database::prepare("DROP DATABASE IF EXISTS `" . $dbname . "`");
   159| 		Database::pexecute($drop_stmt);
   160| 	}
   161| 	/**
   162| 	 * removes a user from the dbms and revokes all privileges
   163| 	 *
   164| 	 * @param string $username
   165| 	 * @param string $host
   166| 	 * @throws \Exception
   167| 	 */
   168| 	public function deleteUser(string $username, string $host)
   169| 	{
   170| 		if ($this->userExistsOnHost($username, $host)) {
   171| 			if (version_compare(Database::getAttribute(PDO::ATTR_SERVER_VERSION), '5.0.2', '<')) {
   172| 				$stmt = Database::prepare("REVOKE ALL PRIVILEGES ON * . * FROM `" . $username . "`@`" . $host . "`");
   173| 				Database::pexecute($stmt);
   174| 			}
   175| 			if (version_compare(Database::getAttribute(PDO::ATTR_SERVER_VERSION), '5.7.0', '<')) {
   176| 				$stmt = Database::prepare("DROP USER :username@:host");

# --- HUNK 2: Lines 189-230 ---
   189| 	 * @param string $username
   190| 	 * @param string $host
   191| 	 * @throws \Exception
   192| 	 */
   193| 	public function disableUser(string $username, string $host)
   194| 	{
   195| 		$stmt = Database::prepare('REVOKE ALL PRIVILEGES, GRANT OPTION FROM `' . $username . '`@`' . $host . '`');
   196| 		Database::pexecute($stmt, [], false);
   197| 	}
   198| 	/**
   199| 	 * re-grant permissions to a user
   200| 	 *
   201| 	 * @param string $username
   202| 	 * @param string $host
   203| 	 * @param bool $grant_access_prefix
   204| 	 * @throws \Exception
   205| 	 */
   206| 	public function enableUser(string $username, string $host, bool $grant_access_prefix = false)
   207| 	{
   208| 		if ($this->userExistsOnHost($username, $host)) {
   209| 			Database::query('GRANT ALL PRIVILEGES ON `' . $username . ($grant_access_prefix ? '%' : '') . '`.* TO `' . $username . '`@`' . $host . '`');
   210| 			Database::query('GRANT ALL PRIVILEGES ON `' . str_replace('_', '\_', $username) . ($grant_access_prefix ? '%' : '') . '` . * TO `' . $username . '`@`' . $host . '`');
   211| 		}
   212| 	}
   213| 	/**
   214| 	 * Check whether a given username exists for the given host
   215| 	 *
   216| 	 * @param string $username
   217| 	 * @param string $host
   218| 	 * @return bool
   219| 	 * @throws \Exception
   220| 	 */
   221| 	public function userExistsOnHost(string $username, string $host): bool
   222| 	{
   223| 		$exist_check_stmt = Database::prepare("SELECT EXISTS(SELECT 1 FROM mysql.user WHERE user = '" . $username . "' AND host = '" . $host . "')");
   224| 		$exist_check = Database::pexecute_first($exist_check_stmt);
   225| 		return ($exist_check && array_pop($exist_check) == '1');
   226| 	}
   227| 	/**
   228| 	 * flushes the privileges...pretty obvious eh?
   229| 	 */
   230| 	public function flushPrivileges()

# --- HUNK 3: Lines 247-267 ---
   247| 			$result_stmt = Database::prepare('SELECT `User` FROM mysql.user');
   248| 		}
   249| 		Database::pexecute($result_stmt);
   250| 		$allsqlusers = [];
   251| 		while ($row = $result_stmt->fetch(PDO::FETCH_ASSOC)) {
   252| 			if ($user_only == false) {
   253| 				if (!isset($allsqlusers[$row['User']]) || !is_array($allsqlusers[$row['User']])) {
   254| 					$allsqlusers[$row['User']] = [
   255| 						'password' => $row['Password'] ?? $row['authentication_string'],
   256| 						'plugin' => $row['plugin'] ?? 'caching_sha2_password',
   257| 						'hosts' => []
   258| 					];
   259| 				}
   260| 				$allsqlusers[$row['User']]['hosts'][] = $row['Host'];
   261| 			} else {
   262| 				$allsqlusers[] = $row['User'];
   263| 			}
   264| 		}
   265| 		return $allsqlusers;
   266| 	}
   267| }


# ====================================================================
# FILE: lib/Froxlor/Froxlor.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 8-49 ---
     8|  * as published by the Free Software Foundation; either version 2
     9|  * of the License, or (at your option) any later version.
    10|  *
    11|  * This program is distributed in the hope that it will be useful,
    12|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program; if not, you can also view it online at
    18|  * https://files.froxlor.org/misc/COPYING.txt
    19|  *
    20|  * @copyright  the authors
    21|  * @author     Froxlor team <team@froxlor.org>
    22|  * @license    https://files.froxlor.org/misc/COPYING.txt GPLv2
    23|  */
    24| namespace Froxlor;
    25| use Froxlor\Database\Database;
    26| final class Froxlor
    27| {
    28| 	const VERSION = '2.2.5';
    29| 	const DBVERSION = '202409280';
    30| 	const BRANDING = '';
    31| 	const DOCS_URL = 'https://docs.froxlor.org';
    32| 	/**
    33| 	 * return path to where froxlor is installed, e.g.
    34| 	 * /var/www/froxlor/
    35| 	 *
    36| 	 * @return string
    37| 	 */
    38| 	public static function getInstallDir(): string
    39| 	{
    40| 		return dirname(__DIR__, 2) . '/';
    41| 	}
    42| 	public static function getDocsUrl(): string
    43| 	{
    44| 		if (preg_match('/(.+)-(dev|beta|rc)\d+$/', self::VERSION)) {
    45| 			return self::DOCS_URL . '/dev/';
    46| 		}
    47| 		return self::DOCS_URL . '/v' . self::getShortVersion() . '/';
    48| 	}
    49| 	/**

# --- HUNK 2: Lines 261-301 ---
   261| 				$b[] = '0';
   262| 			}
   263| 		}
   264| 		foreach ($a as $depth => $aVal) {
   265| 			if (isset($b[$depth])) {
   266| 				if ($aVal > $b[$depth]) {
   267| 					return 1; // A > B
   268| 				} elseif ($aVal < $b[$depth]) {
   269| 					return -1; // B > A
   270| 				}
   271| 			} else {
   272| 				return 1; // so A > B
   273| 			}
   274| 		}
   275| 		return (count($a) < count($b)) ? -1 : 0;
   276| 	}
   277| 	/**
   278| 	 * @param array|null $arr
   279| 	 * @return void
   280| 	 */
   281| 	private static function parseVersionArray(array &$arr = null)
   282| 	{
   283| 		if (stripos($arr[count($arr) - 1], '-') !== false) {
   284| 			$x = explode("-", $arr[count($arr) - 1]);
   285| 			$arr[count($arr) - 1] = $x[0];
   286| 			if (stripos($x[1], 'rc') !== false) {
   287| 				$arr[] = '-1';
   288| 				$arr[] = '2'; // dev < beta < rc
   289| 				$arr[] = substr($x[1], 2);
   290| 			} else {
   291| 				if (stripos($x[1], 'beta') !== false) {
   292| 					$arr[] = '-1';
   293| 					$arr[] = '1'; // dev < beta < rc
   294| 					$arr[] = substr($x[1], 3);
   295| 				} else {
   296| 					if (stripos($x[1], 'dev') !== false) {
   297| 						$arr[] = '-1';
   298| 						$arr[] = '0'; // dev < beta < rc
   299| 						$arr[] = substr($x[1], 3);
   300| 					}
   301| 				}


# ====================================================================
# FILE: lib/Froxlor/Settings/Store.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 90-167 ---
    90| 	public static function storeSettingDefaultIp($fieldname, $fielddata, $newfieldvalue)
    91| 	{
    92| 		$defaultips_old = Settings::Get('system.defaultip');
    93| 		$returnvalue = self::storeSettingField($fieldname, $fielddata, $newfieldvalue);
    94| 		if ($returnvalue !== false && is_array($fielddata) && isset($fielddata['settinggroup']) && $fielddata['settinggroup'] == 'system' && isset($fielddata['varname']) && $fielddata['varname'] == 'defaultip') {
    95| 			self::updateStdSubdomainDefaultIp($newfieldvalue, $defaultips_old);
    96| 		}
    97| 		return $returnvalue;
    98| 	}
    99| 	private static function updateStdSubdomainDefaultIp($newfieldvalue, $defaultips_old)
   100| 	{
   101| 		$customerstddomains_result_stmt = Database::prepare("
   102| 			SELECT `standardsubdomain` FROM `" . TABLE_PANEL_CUSTOMERS . "` WHERE `standardsubdomain` <> '0'
   103| 		");
   104| 		Database::pexecute($customerstddomains_result_stmt);
   105| 		$ids = [];
   106| 		while ($customerstddomains_row = $customerstddomains_result_stmt->fetch(PDO::FETCH_ASSOC)) {
   107| 			$ids[] = (int)$customerstddomains_row['standardsubdomain'];
   108| 		}
   109| 		if (count($ids) > 0) {
   110| 			$defaultips_new = explode(',', $newfieldvalue);
   111| 			if (!empty($defaultips_old) && !empty($newfieldvalue)) {
   112| 				$in_value = $defaultips_old . ", " . $newfieldvalue;
   113| 			} elseif (!empty($defaultips_old) && empty($newfieldvalue)) {
   114| 				$in_value = $defaultips_old;
   115| 			} else {
   116| 				$in_value = $newfieldvalue;
   117| 			}
   118| 			$del_stmt = Database::prepare("
   119| 				DELETE FROM `" . TABLE_DOMAINTOIP . "`
   120| 				WHERE `id_domain` IN (" . implode(', ', $ids) . ")
   121| 				AND `id_ipandports` IN (" . $in_value . ")
   122| 			");
   123| 			Database::pexecute($del_stmt);
   124| 			if (count($defaultips_new) > 0) {
   125| 				$ins_stmt = Database::prepare("
   126| 					INSERT INTO `" . TABLE_DOMAINTOIP . "`
   127| 					SET `id_domain` = :domainid, `id_ipandports` = :ipandportid
   128| 				");
   129| 				foreach ($ids as $id) {
   130| 					foreach ($defaultips_new as $defaultip_new) {
   131| 						Database::pexecute($ins_stmt, [
   132| 							'domainid' => $id,
   133| 							'ipandportid' => $defaultip_new
   134| 						]);
   135| 					}
   136| 				}
   137| 			}
   138| 		}
   139| 	}
   140| 	public static function storeSettingDefaultSslIp($fieldname, $fielddata, $newfieldvalue)
   141| 	{
   142| 		$defaultips_old = Settings::Get('system.defaultsslip');
   143| 		$returnvalue = self::storeSettingField($fieldname, $fielddata, $newfieldvalue);
   144| 		if ($returnvalue !== false && is_array($fielddata) && isset($fielddata['settinggroup']) && $fielddata['settinggroup'] == 'system' && isset($fielddata['varname']) && $fielddata['varname'] == 'defaultsslip') {
   145| 			self::updateStdSubdomainDefaultIp($newfieldvalue, $defaultips_old);
   146| 		}
   147| 		return $returnvalue;
   148| 	}
   149| 	/**
   150| 	 * updates the setting for the default panel-theme
   151| 	 * and also the user themes (customers and admins) if
   152| 	 * the changing of themes is disallowed for them
   153| 	 *
   154| 	 * @param string $fieldname
   155| 	 * @param array $fielddata
   156| 	 * @param mixed $newfieldvalue
   157| 	 *
   158| 	 * @return boolean|array
   159| 	 */
   160| 	public static function storeSettingDefaultTheme($fieldname, $fielddata, $newfieldvalue)
   161| 	{
   162| 		$returnvalue = self::storeSettingField($fieldname, $fielddata, $newfieldvalue);
   163| 		if ($returnvalue !== false && is_array($fielddata) && isset($fielddata['settinggroup']) && $fielddata['settinggroup'] == 'panel' && isset($fielddata['varname']) && $fielddata['varname'] == 'default_theme') {
   164| 			if (Settings::Get('panel.allow_theme_change_customer') == '0') {
   165| 				$upd_stmt = Database::prepare("
   166| 					UPDATE `" . TABLE_PANEL_CUSTOMERS . "` SET `theme` = :theme
   167| 				");

# --- HUNK 2: Lines 176-215 ---
   176| 				Database::pexecute($upd_stmt, [
   177| 					'theme' => $newfieldvalue
   178| 				]);
   179| 			}
   180| 		}
   181| 		return $returnvalue;
   182| 	}
   183| 	public static function storeSettingFieldInsertBindTask($fieldname, $fielddata, $newfieldvalue)
   184| 	{
   185| 		$returnvalue = self::storeSettingField($fieldname, $fielddata, $newfieldvalue);
   186| 		if ($returnvalue !== false) {
   187| 			Cronjob::inserttask(TaskId::REBUILD_DNS);
   188| 		}
   189| 		return $returnvalue;
   190| 	}
   191| 	public static function storeSettingFieldInsertAntispamTask($fieldname, $fielddata, $newfieldvalue)
   192| 	{
   193| 		$returnvalue = self::storeSettingField($fieldname, $fielddata, $newfieldvalue);
   194| 		if ($returnvalue !== false) {
   195| 			Cronjob::inserttask(TaskId::REBUILD_RSPAMD);
   196| 		}
   197| 		return $returnvalue;
   198| 	}
   199| 	public static function storeSettingHostname($fieldname, $fielddata, $newfieldvalue)
   200| 	{
   201| 		$returnvalue = self::storeSettingField($fieldname, $fielddata, $newfieldvalue);
   202| 		if ($returnvalue !== false && is_array($fielddata) && isset($fielddata['settinggroup']) && $fielddata['settinggroup'] == 'system' && isset($fielddata['varname']) && ($fielddata['varname'] == 'hostname' || $fielddata['varname'] == 'stdsubdomain')) {
   203| 			$idna_convert = new IdnaWrapper();
   204| 			$newfieldvalue = $idna_convert->encode($newfieldvalue);
   205| 			if (($fielddata['varname'] == 'hostname' && Settings::Get('system.stdsubdomain') == '') || $fielddata['varname'] == 'stdsubdomain') {
   206| 				if ($fielddata['varname'] == 'stdsubdomain' && $newfieldvalue == '') {
   207| 					$oldhost = $idna_convert->encode(Settings::Get('system.stdsubdomain'));
   208| 					$newhost = $idna_convert->encode(Settings::Get('system.hostname'));
   209| 				} elseif ($fielddata['varname'] == 'stdsubdomain' && Settings::Get('system.stdsubdomain') == '') {
   210| 					$oldhost = $idna_convert->encode(Settings::Get('system.hostname'));
   211| 					$newhost = $newfieldvalue;
   212| 				} elseif ($fielddata['varname'] == 'stdsubdomain') {
   213| 					$oldhost = $idna_convert->encode(Settings::Get('system.stdsubdomain'));
   214| 					$newhost = $newfieldvalue;
   215| 				} elseif ($fielddata['varname'] == 'hostname' && Settings::Get('system.stdsubdomain') == '') {


# ====================================================================
# FILE: lib/Froxlor/System/Cronjob.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 93-140 ---
    93| 			}
    94| 		} else {
    95| 			$mylog->logAction(FroxlorLogger::CRON_ACTION, LOG_NOTICE,
    96| 				'File /etc/group does not exist; cannot check for latest guid');
    97| 		}
    98| 	}
    99| 	/**
   100| 	 * Inserts a task into the PANEL_TASKS-Table
   101| 	 *
   102| 	 * @param int $type Type of task
   103| 	 * @param string $params Parameter (possible to pass multiple times)
   104| 	 *
   105| 	 * @throws Exception
   106| 	 * @author Froxlor team <team@froxlor.org> (2010-)
   107| 	 */
   108| 	public static function inserttask(int $type, ...$params)
   109| 	{
   110| 		$ins_stmt = Database::prepare("
   111| 			INSERT INTO `" . TABLE_PANEL_TASKS . "` SET `type` = :type, `data` = :data
   112| 		");
   113| 		if ($type == TaskId::REBUILD_VHOST || $type == TaskId::REBUILD_DNS || $type == TaskId::CREATE_FTP || $type == TaskId::REBUILD_RSPAMD || $type == TaskId::CREATE_QUOTA || $type == TaskId::REBUILD_CRON) {
   114| 			if ($type == TaskId::REBUILD_DNS && Settings::Get('system.bind_enable') == '0') {
   115| 				return;
   116| 			}
   117| 			if ($type == TaskId::REBUILD_RSPAMD && Settings::Get('antispam.activated') == '0') {
   118| 				return;
   119| 			}
   120| 			if ($type == TaskId::CREATE_QUOTA && Settings::Get('system.diskquota_enabled') == '0') {
   121| 				return;
   122| 			}
   123| 			$del_stmt = Database::prepare("
   124| 				DELETE FROM `" . TABLE_PANEL_TASKS . "` WHERE `type` = :type
   125| 			");
   126| 			Database::pexecute($del_stmt, [
   127| 				'type' => $type
   128| 			]);
   129| 			Database::pexecute($ins_stmt, [
   130| 				'type' => $type,
   131| 				'data' => ''
   132| 			]);
   133| 		} elseif ($type == TaskId::CREATE_HOME && count($params) == 4 && $params[0] != '' && $params[1] != '' && $params[2] != '' && ($params[3] == 0 || $params[3] == 1)) {
   134| 			$data = [];
   135| 			$data['loginname'] = $params[0];
   136| 			$data['uid'] = $params[1];
   137| 			$data['gid'] = $params[2];
   138| 			$data['store_defaultindex'] = $params[3];
   139| 			$data = json_encode($data);
   140| 			Database::pexecute($ins_stmt, [


# ====================================================================
# FILE: lib/Froxlor/System/Mailer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 42-68 ---
    42| 			$this->isSMTP();
    43| 			$this->Host = Settings::Get('system.mail_smtp_host');
    44| 			$this->SMTPAuth = Settings::Get('system.mail_smtp_auth') == '1';
    45| 			$this->Username = Settings::Get('system.mail_smtp_user');
    46| 			$this->Password = Settings::Get('system.mail_smtp_passwd');
    47| 			if (Settings::Get('system.mail_smtp_usetls')) {
    48| 				$this->SMTPSecure = 'tls';
    49| 			} else {
    50| 				$this->SMTPAutoTLS = false;
    51| 			}
    52| 			$this->Port = Settings::Get('system.mail_smtp_port');
    53| 		}
    54| 		/**
    55| 		 * use froxlor's email-validation
    56| 		 */
    57| 		self::$validator = [
    58| 			'\Froxlor\\Validate\\Validate',
    59| 			'validateEmail'
    60| 		];
    61| 		if (self::ValidateAddress(Settings::Get('panel.adminmail')) !== false) {
    62| 			$this->SetFrom(Settings::Get('panel.adminmail'), Settings::Get('panel.adminmail_defname'));
    63| 			if (Settings::Get('panel.adminmail_return') != '') {
    64| 				$this->AddReplyTo(Settings::Get('panel.adminmail_return'), Settings::Get('panel.adminmail_defname'));
    65| 			}
    66| 		}
    67| 	}
    68| }


# ====================================================================
# FILE: lib/Froxlor/UI/Panel/UI.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 83-123 ---
    83| 			return null;
    84| 		$colonPosition = strrpos($_SERVER['HTTP_HOST'], ':');
    85| 		if ($colonPosition === false)
    86| 			return $_SERVER['HTTP_HOST'];
    87| 		$closingSquareBracketPosition = strrpos($_SERVER['HTTP_HOST'], ']');
    88| 		if ($closingSquareBracketPosition === false)
    89| 			return substr($_SERVER['HTTP_HOST'], 0, $colonPosition);
    90| 		return substr($_SERVER['HTTP_HOST'], 0, $closingSquareBracketPosition + 1);
    91| 	}
    92| 	/**
    93| 	 * send various security related headers
    94| 	 */
    95| 	public static function sendHeaders()
    96| 	{
    97| 		session_set_cookie_params([
    98| 			'lifetime' => self::$install_mode ? 7200 : 600, // will be renewed based on settings in lib/init.php
    99| 			'path' => '/',
   100| 			'domain' => self::getCookieHost(),
   101| 			'secure' => self::requestIsHttps(),
   102| 			'httponly' => true,
   103| 			'samesite' => 'Strict'
   104| 		]);
   105| 		session_start();
   106| 		header("Content-Type: text/html; charset=UTF-8");
   107| 		header("Cache-Control: no-store, no-cache, must-revalidate");
   108| 		header("Pragma: no-cache");
   109| 		header('Last-Modified: ' . gmdate('D, d M Y H:i:s \G\M\T', time()));
   110| 		header('Expires: ' . gmdate('D, d M Y H:i:s \G\M\T', time()));
   111| 		$csp_content = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; object-src 'self'; frame-src 'self'; frame-ancestors 'self';";
   112| 		header("Content-Security-Policy: " . $csp_content);
   113| 		header("X-Content-Security-Policy: " . $csp_content);
   114| 		header("X-WebKit-CSP: " . $csp_content);
   115| 		header("X-Frame-Options: DENY");
   116| 		header("X-Content-Type-Options: nosniff");
   117| 		if (function_exists("date_default_timezone_set") && function_exists("date_default_timezone_get")) {
   118| 			@date_default_timezone_set(@date_default_timezone_get());
   119| 		}
   120| 	}
   121| 	public static function sendSslHeaders()
   122| 	{
   123| 		/**


# ====================================================================
# FILE: lib/Froxlor/User.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 110-150 ---
   110| 				'emails',
   111| 				'email_accounts',
   112| 				'email_forwarders',
   113| 				'email_quota',
   114| 				'subdomains'
   115| 			] as $field) {
   116| 				self::addResourceCount($admin_resources[$cur_adm], $customer, $field . '_used', $field);
   117| 			}
   118| 			$customer_mysqls_stmt = Database::prepare('SELECT COUNT(*) AS `number_mysqls` FROM `' . TABLE_PANEL_DATABASES . '`
   119| 			WHERE `customerid` = :cid');
   120| 			$customer_mysqls = Database::pexecute_first($customer_mysqls_stmt, [
   121| 				"cid" => $customer['customerid']
   122| 			]);
   123| 			$customer['mysqls_used_new'] = (int)$customer_mysqls['number_mysqls'];
   124| 			$customer_emails_stmt = Database::prepare('SELECT COUNT(*) AS `number_emails` FROM `' . TABLE_MAIL_VIRTUAL . '`
   125| 			WHERE `customerid` = :cid');
   126| 			$customer_emails = Database::pexecute_first($customer_emails_stmt, [
   127| 				"cid" => $customer['customerid']
   128| 			]);
   129| 			$customer['emails_used_new'] = (int)$customer_emails['number_emails'];
   130| 			$customer_emails_result_stmt = Database::prepare('SELECT `email`, `email_full`, `destination`, `popaccountid` AS `number_email_forwarders` FROM `' . TABLE_MAIL_VIRTUAL . '`
   131| 			WHERE `customerid` = :cid');
   132| 			Database::pexecute($customer_emails_result_stmt, [
   133| 				"cid" => $customer['customerid']
   134| 			]);
   135| 			$customer_email_forwarders = 0;
   136| 			$customer_email_accounts = 0;
   137| 			while ($customer_emails_row = $customer_emails_result_stmt->fetch(PDO::FETCH_ASSOC)) {
   138| 				if ($customer_emails_row['destination'] != '') {
   139| 					$customer_emails_row['destination'] = explode(' ', FileDir::makeCorrectDestination($customer_emails_row['destination']));
   140| 					$customer_email_forwarders += count($customer_emails_row['destination']);
   141| 					if (in_array($customer_emails_row['email_full'], $customer_emails_row['destination'])) {
   142| 						$customer_email_forwarders -= 1;
   143| 						$customer_email_accounts++;
   144| 					}
   145| 				}
   146| 			}
   147| 			$customer['email_accounts_used_new'] = $customer_email_accounts;
   148| 			$customer['email_forwarders_used_new'] = $customer_email_forwarders;
   149| 			$customer_ftps_stmt = Database::prepare('SELECT COUNT(*) AS `number_ftps` FROM `' . TABLE_FTP_USERS . '` WHERE `customerid` = :cid');
   150| 			$customer_ftps = Database::pexecute_first($customer_ftps_stmt, [


# ====================================================================
# FILE: lib/formfields/admin/admin/formfield.admin_add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-66 ---
    26| use Froxlor\System\Crypt;
    27| return [
    28| 	'admin_add' => [
    29| 		'title' => lng('admin.admin_add'),
    30| 		'image' => 'fa-solid fa-user-plus',
    31| 		'self_overview' => ['section' => 'admins', 'page' => 'admins'],
    32| 		'sections' => [
    33| 			'section_a' => [
    34| 				'title' => lng('admin.accountdata'),
    35| 				'image' => 'icons/user_add.png',
    36| 				'fields' => [
    37| 					'new_loginname' => [
    38| 						'label' => lng('login.username'),
    39| 						'type' => 'text',
    40| 						'mandatory' => true
    41| 					],
    42| 					'admin_password' => [
    43| 						'label' => lng('login.password'),
    44| 						'type' => 'password',
    45| 						'mandatory' => true,
    46| 						'autocomplete' => 'off',
    47| 						'next_to' => [
    48| 							'admin_password_suggestion' => [
    49| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    50| 								'type' => 'text',
    51| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    52| 								'value' => Crypt::generatePassword(),
    53| 								'readonly' => true
    54| 							]
    55| 						]
    56| 					],
    57| 					'def_language' => [
    58| 						'label' => lng('login.language'),
    59| 						'type' => 'select',
    60| 						'select_var' => Language::getLanguages(),
    61| 						'selected' => $userinfo['language']
    62| 					],
    63| 					'gui_access' => [
    64| 						'label' => lng('usersettings.gui_access.title'),
    65| 						'desc' => lng('usersettings.gui_access.description'),
    66| 						'type' => 'checkbox',


# ====================================================================
# FILE: lib/formfields/admin/admin/formfield.admin_edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 32-72 ---
    32| 		'sections' => [
    33| 			'section_a' => [
    34| 				'title' => lng('admin.accountdata'),
    35| 				'image' => 'icons/user_edit.png',
    36| 				'fields' => [
    37| 					'loginname' => [
    38| 						'label' => lng('login.username'),
    39| 						'type' => 'label',
    40| 						'value' => $result['loginname']
    41| 					],
    42| 					'deactivated' => [
    43| 						'label' => lng('admin.deactivated_user'),
    44| 						'type' => 'checkbox',
    45| 						'value' => '1',
    46| 						'checked' => $result['deactivated'],
    47| 						'visible' => $result['adminid'] != $userinfo['userid']
    48| 					],
    49| 					'admin_password' => [
    50| 						'label' => lng('login.password') . '&nbsp;(' . lng('panel.emptyfornochanges') . ')',
    51| 						'type' => 'password',
    52| 						'autocomplete' => 'off',
    53| 						'visible' => $result['adminid'] != $userinfo['userid'],
    54| 						'next_to' => [
    55| 							'admin_password_suggestion' => [
    56| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    57| 								'type' => 'text',
    58| 								'visible' => (Settings::Get('panel.password_regex') == '' && !($result['adminid'] == $userinfo['userid'])),
    59| 								'value' => Crypt::generatePassword(),
    60| 								'readonly' => true
    61| 							]
    62| 						]
    63| 					],
    64| 					'def_language' => [
    65| 						'label' => lng('login.language'),
    66| 						'type' => 'select',
    67| 						'select_var' => Language::getLanguages(),
    68| 						'selected' => $result['def_language'],
    69| 						'visible' => $result['adminid'] != $userinfo['userid']
    70| 					],
    71| 					'gui_access' => [
    72| 						'label' => lng('usersettings.gui_access.title'),


# ====================================================================
# FILE: lib/formfields/admin/customer/formfield.customer_add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-78 ---
    38| 					'new_loginname' => [
    39| 						'label' => lng('login.username'),
    40| 						'type' => 'text',
    41| 						'placeholder' => lng('admin.username_default_msg')
    42| 					],
    43| 					'createstdsubdomain' => [
    44| 						'label' => lng('admin.stdsubdomain_add') . '?',
    45| 						'type' => 'checkbox',
    46| 						'value' => '1',
    47| 						'checked' => Settings::Get('system.createstdsubdom_default')
    48| 					],
    49| 					'store_defaultindex' => [
    50| 						'label' => lng('admin.store_defaultindex') . '?',
    51| 						'type' => 'checkbox',
    52| 						'value' => '1',
    53| 						'checked' => true
    54| 					],
    55| 					'new_customer_password' => [
    56| 						'label' => lng('login.password'),
    57| 						'type' => 'password',
    58| 						'autocomplete' => 'off',
    59| 						'placeholder' => lng('admin.password_default_msg'),
    60| 						'next_to' => [
    61| 							'new_customer_password_suggestion' => [
    62| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    63| 								'type' => 'text',
    64| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    65| 								'value' => Crypt::generatePassword(),
    66| 								'readonly' => true
    67| 							]
    68| 						]
    69| 					],
    70| 					'sendpassword' => [
    71| 						'label' => lng('admin.sendpassword'),
    72| 						'type' => 'checkbox',
    73| 						'value' => '1',
    74| 						'checked' => true
    75| 					],
    76| 					'def_language' => [
    77| 						'label' => lng('login.language'),
    78| 						'type' => 'select',


# ====================================================================
# FILE: lib/formfields/admin/customer/formfield.customer_edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 43-83 ---
    43| 					'documentroot' => [
    44| 						'label' => lng('customer.documentroot'),
    45| 						'type' => 'label',
    46| 						'value' => $result['documentroot']
    47| 					],
    48| 					'createstdsubdomain' => [
    49| 						'label' => lng('admin.stdsubdomain_add') . '?',
    50| 						'type' => 'checkbox',
    51| 						'value' => '1',
    52| 						'checked' => (bool)$result['standardsubdomain']
    53| 					],
    54| 					'deactivated' => [
    55| 						'label' => lng('admin.deactivated_user'),
    56| 						'type' => 'checkbox',
    57| 						'value' => '1',
    58| 						'checked' => $result['deactivated']
    59| 					],
    60| 					'new_customer_password' => [
    61| 						'label' => lng('login.password') . '&nbsp;(' . lng('panel.emptyfornochanges') . ')',
    62| 						'type' => 'password',
    63| 						'autocomplete' => 'off',
    64| 						'next_to' => [
    65| 							'new_customer_password_suggestion' => [
    66| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    67| 								'type' => 'text',
    68| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    69| 								'value' => Crypt::generatePassword(),
    70| 								'readonly' => true
    71| 							]
    72| 						]
    73| 					],
    74| 					'def_language' => [
    75| 						'label' => lng('login.language'),
    76| 						'type' => 'select',
    77| 						'select_var' => Language::getLanguages(),
    78| 						'selected' => $result['def_language']
    79| 					],
    80| 					'gui_access' => [
    81| 						'label' => lng('usersettings.gui_access.title'),
    82| 						'desc' => lng('usersettings.gui_access.description'),
    83| 						'type' => 'checkbox',


# ====================================================================
# FILE: lib/formfields/admin/domains/formfield.domains_add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 173-213 ---
   173| 					],
   174| 					'speciallogfile' => [
   175| 						'label' => lng('admin.speciallogfile.title'),
   176| 						'desc' => lng('admin.speciallogfile.description'),
   177| 						'type' => 'checkbox',
   178| 						'value' => '1',
   179| 						'checked' => false
   180| 					],
   181| 				]
   182| 			],
   183| 			'section_bssl' => [
   184| 				'title' => lng('admin.webserversettings_ssl'),
   185| 				'image' => 'icons/domain_add.png',
   186| 				'visible' => Settings::Get('system.use_ssl') == '1',
   187| 				'fields' => [
   188| 					'sslenabled' => [
   189| 						'visible' => !empty($ssl_ipsandports),
   190| 						'label' => lng('admin.domain_sslenabled'),
   191| 						'type' => 'checkbox',
   192| 						'value' => '1',
   193| 						'checked' => !empty($ssl_ipsandports)
   194| 					],
   195| 					'no_ssl_available_info' => [
   196| 						'visible' => empty($ssl_ipsandports),
   197| 						'label' => 'SSL',
   198| 						'type' => 'label',
   199| 						'value' => lng('panel.nosslipsavailable')
   200| 					],
   201| 					'ssl_ipandport' => [
   202| 						'visible' => !empty($ssl_ipsandports),
   203| 						'label' => lng('domains.ipandport_ssl_multi.title'),
   204| 						'desc' => lng('domains.ipandport_multi.description'),
   205| 						'type' => 'checkbox',
   206| 						'values' => $ssl_ipsandports,
   207| 						'value' => explode(',', Settings::Get('system.defaultsslip')),
   208| 						'is_array' => 1
   209| 					],
   210| 					'ssl_redirect' => [
   211| 						'visible' => !empty($ssl_ipsandports),
   212| 						'label' => lng('domains.ssl_redirect.title'),
   213| 						'desc' => lng('domains.ssl_redirect.description'),


# ====================================================================
# FILE: lib/formfields/admin/domains/formfield.domains_edit.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 193-232 ---
   193| 						'checked' => $result['writeaccesslog']
   194| 					],
   195| 					'writeerrorlog' => [
   196| 						'label' => lng('admin.writeerrorlog.title'),
   197| 						'desc' => lng('admin.writeerrorlog.description'),
   198| 						'type' => 'checkbox',
   199| 						'value' => '1',
   200| 						'checked' => $result['writeerrorlog']
   201| 					],
   202| 					'speciallogfile' => [
   203| 						'label' => lng('admin.speciallogfile.title'),
   204| 						'desc' => lng('admin.speciallogfile.description'),
   205| 						'type' => 'checkbox',
   206| 						'value' => '1',
   207| 						'checked' => $result['speciallogfile']
   208| 					],
   209| 					'speciallogverified' => [
   210| 						'type' => 'hidden',
   211| 						'value' => '0'
   212| 					],
   213| 				]
   214| 			],
   215| 			'section_bssl' => [
   216| 				'title' => lng('admin.webserversettings_ssl'),
   217| 				'image' => 'icons/domain_edit.png',
   218| 				'visible' => Settings::Get('system.use_ssl') == '1',
   219| 				'fields' => [
   220| 					'sslenabled' => [
   221| 						'visible' => !empty($ssl_ipsandports),
   222| 						'label' => lng('admin.domain_sslenabled'),
   223| 						'type' => 'checkbox',
   224| 						'value' => '1',
   225| 						'checked' => $result['ssl_enabled']
   226| 					],
   227| 					'no_ssl_available_info' => [
   228| 						'visible' => empty($ssl_ipsandports),
   229| 						'label' => 'SSL',
   230| 						'type' => 'label',
   231| 						'value' => lng('panel.nosslipsavailable')
   232| 					],

# --- HUNK 2: Lines 413-469 ---
   413| 						'value' => '1',
   414| 						'checked' => Settings::Get('system.apply_phpconfigs_default') == 1 ? '1' : '0'
   415| 					],
   416| 					'mod_fcgid_starter' => [
   417| 						'visible' => (int)Settings::Get('system.mod_fcgid') == 1,
   418| 						'label' => lng('admin.mod_fcgid_starter.title'),
   419| 						'type' => 'number',
   420| 						'value' => ((int)$result['mod_fcgid_starter'] != -1 ? $result['mod_fcgid_starter'] : '')
   421| 					],
   422| 					'mod_fcgid_maxrequests' => [
   423| 						'visible' => (int)Settings::Get('system.mod_fcgid') == 1,
   424| 						'label' => lng('admin.mod_fcgid_maxrequests.title'),
   425| 						'type' => 'number',
   426| 						'value' => ((int)$result['mod_fcgid_maxrequests'] != -1 ? $result['mod_fcgid_maxrequests'] : '')
   427| 					]
   428| 				]
   429| 			],
   430| 			'section_d' => [
   431| 				'title' => lng('admin.nameserversettings'),
   432| 				'image' => 'icons/domain_edit.png',
   433| 				'visible' => Settings::Get('system.bind_enable') == '1' && $userinfo['change_serversettings'] == '1',
   434| 				'fields' => [
   435| 					'isbinddomain' => [
   436| 						'label' => lng('admin.createzonefile'),
   437| 						'type' => 'checkbox',
   438| 						'value' => '1',
   439| 						'checked' => $result['isbinddomain']
   440| 					],
   441| 					'zonefile' => [
   442| 						'label' => lng('admin.custombindzone'),
   443| 						'desc' => lng('admin.bindzonewarning'),
   444| 						'type' => 'text',
   445| 						'value' => $result['zonefile']
   446| 					],
   447| 					'spf_entry' => [
   448| 						'visible' => (Settings::Get('system.bind_enable') == '0' && Settings::Get('spf.use_spf') == '1' && $result['isemaildomain'] == '1'),
   449| 						'label' => lng('antispam.required_spf_dns'),
   450| 						'type' => 'longtext',
   451| 						'value' => (string)(new \Froxlor\Dns\DnsEntry('@', 'TXT', \Froxlor\Dns\Dns::encloseTXTContent(Settings::Get('spf.spf_entry'))))
   452| 					],
   453| 					'dmarc_entry' => [
   454| 						'visible' => (Settings::Get('system.bind_enable') == '0' && Settings::Get('dmarc.use_dmarc') == '1' && $result['isemaildomain'] == '1'),
   455| 						'label' => lng('antispam.required_dmarc_dns'),
   456| 						'type' => 'longtext',
   457| 						'value' => (string)(new \Froxlor\Dns\DnsEntry('_dmarc', 'TXT', \Froxlor\Dns\Dns::encloseTXTContent(Settings::Get('dmarc.dmarc_entry'))))
   458| 					],
   459| 					'dkim_entry' => [
   460| 						'visible' => (Settings::Get('system.bind_enable') == '0' && Settings::Get('antispam.activated') == '1' && $result['dkim'] == '1' && $result['dkim_pubkey'] != ''),
   461| 						'label' => lng('antispam.required_dkim_dns'),
   462| 						'type' => 'longtext',
   463| 						'value' => (string)(new \Froxlor\Dns\DnsEntry('dkim' . $result['dkim_id'] . '._domainkey', 'TXT', \Froxlor\Dns\Dns::encloseTXTContent('v=DKIM1; k=rsa; p='.trim($result['dkim_pubkey']))))
   464| 					],
   465| 				]
   466| 			]
   467| 		]
   468| 	]
   469| ];


# ====================================================================
# FILE: lib/formfields/customer/email/formfield.emails_accountchangepasswd.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-58 ---
    23|  */
    24| use Froxlor\Settings;
    25| use Froxlor\System\Crypt;
    26| return [
    27| 	'emails_accountchangepasswd' => [
    28| 		'title' => lng('menue.main.changepassword'),
    29| 		'image' => 'icons/email_edit.png',
    30| 		'sections' => [
    31| 			'section_a' => [
    32| 				'title' => lng('menue.main.changepassword'),
    33| 				'image' => 'icons/email_edit.png',
    34| 				'fields' => [
    35| 					'emailaddr' => [
    36| 						'label' => lng('emails.emailaddress'),
    37| 						'type' => 'label',
    38| 						'value' => $result['email_full']
    39| 					],
    40| 					'email_password' => [
    41| 						'label' => lng('login.password'),
    42| 						'type' => 'password',
    43| 						'autocomplete' => 'off',
    44| 						'next_to' => [
    45| 							'email_password_suggestion' => [
    46| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    47| 								'type' => 'text',
    48| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    49| 								'value' => Crypt::generatePassword(),
    50| 								'readonly' => true
    51| 							]
    52| 						]
    53| 					]
    54| 				]
    55| 			]
    56| 		]
    57| 	]
    58| ];


# ====================================================================
# FILE: lib/formfields/customer/email/formfield.emails_addaccount.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-63 ---
    23|  */
    24| use Froxlor\Settings;
    25| use Froxlor\System\Crypt;
    26| return [
    27| 	'emails_addaccount' => [
    28| 		'title' => lng('emails.account_add'),
    29| 		'image' => 'fa-solid fa-plus',
    30| 		'sections' => [
    31| 			'section_a' => [
    32| 				'title' => lng('emails.account_add'),
    33| 				'image' => 'icons/email_add.png',
    34| 				'fields' => [
    35| 					'emailaddr' => [
    36| 						'label' => lng('emails.emailaddress'),
    37| 						'type' => 'label',
    38| 						'value' => $result['email_full']
    39| 					],
    40| 					'email_password' => [
    41| 						'label' => lng('login.password'),
    42| 						'type' => 'password',
    43| 						'autocomplete' => 'off',
    44| 						'mandatory' => true,
    45| 						'next_to' => [
    46| 							'email_password_suggestion' => [
    47| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    48| 								'type' => 'text',
    49| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    50| 								'value' => Crypt::generatePassword(),
    51| 								'readonly' => true
    52| 							]
    53| 						]
    54| 					],
    55| 					'email_quota' => [
    56| 						'visible' => Settings::Get('system.mail_quota_enabled') == '1',
    57| 						'label' => lng('emails.quota'),
    58| 						'desc' => "MiB",
    59| 						'type' => 'number',
    60| 						'value' => $quota
    61| 					],
    62| 					'alternative_email' => [
    63| 						'visible' => Settings::Get('panel.sendalternativemail') == '1',


# ====================================================================
# FILE: lib/formfields/customer/email/formfield.emails_edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 77-147 ---
    77| 						'type' => 'label',
    78| 						'value' => $result['quota'] . ' MiB',
    79| 						'next_to' => [
    80| 							'add_link' => [
    81| 								'visible' => ((int)$result['popaccountid'] != 0 && Settings::Get('system.mail_quota_enabled')),
    82| 								'type' => 'link',
    83| 								'href' => $filename . '?page=accounts&amp;domainid=' . $result['domainid'] . '&amp;action=changequota&amp;id=' . $result['id'],
    84| 								'label' => lng('emails.quota_edit'),
    85| 								'classes' => 'btn btn-sm btn-secondary'
    86| 							]
    87| 						]
    88| 					],
    89| 					'iscatchall' => [
    90| 						'visible' => Settings::Get('catchall.catchall_enabled') == '1',
    91| 						'label' => lng('emails.catchall'),
    92| 						'type' => 'checkbox',
    93| 						'value' => '1',
    94| 						'checked' => (int)$result['iscatchall'],
    95| 					],
    96| 					'bypass_spam' => [
    97| 						'visible' => Settings::Get('antispam.activated') == '1',
    98| 						'label' => lng('antispam.bypass_spam'),
    99| 						'type' => 'checkbox',
   100| 						'value' => '1',
   101| 						'checked' => (int)$result['bypass_spam'],
   102| 					],
   103| 					'spam_tag_level' => [
   104| 						'visible' => Settings::Get('antispam.activated') == '1',
   105| 						'label' => lng('antispam.spam_tag_level'),
   106| 						'type' => 'number',
   107| 						'min' => 0,
   108| 						'step' => 0.1,
   109| 						'value' => $result['spam_tag_level'],
   110| 					],
   111| 					'spam_rewrite_subject' => [
   112| 						'visible' => Settings::Get('antispam.activated') == '1',
   113| 						'label' => lng('antispam.rewrite_subject'),
   114| 						'type' => 'checkbox',
   115| 						'value' => '1',
   116| 						'checked' => (int)$result['rewrite_subject'],
   117| 					],
   118| 					'spam_kill_level' => [
   119| 						'visible' => Settings::Get('antispam.activated') == '1',
   120| 						'label' => lng('antispam.spam_kill_level'),
   121| 						'desc' => lng('panel.use_checkbox_to_disable'),
   122| 						'type' => 'textul',
   123| 						'step' => 0.1,
   124| 						'value' => $result['spam_kill_level']
   125| 					],
   126| 					'policy_greylist' => [
   127| 						'visible' => Settings::Get('antispam.activated') == '1',
   128| 						'label' => lng('antispam.policy_greylist'),
   129| 						'type' => 'checkbox',
   130| 						'value' => '1',
   131| 						'checked' => (int)$result['policy_greylist'],
   132| 					],
   133| 					'mail_fwds' => [
   134| 						'label' => lng('emails.forwarders') . ' (' . $forwarders_count . ')',
   135| 						'type' => 'itemlist',
   136| 						'values' => $forwarders,
   137| 						'next_to' => [
   138| 							'add_link' => [
   139| 								'type' => 'link',
   140| 								'href' => $filename . '?page=forwarders&amp;domainid=' . $result['domainid'] . '&amp;action=add&amp;id=' . $result['id'],
   141| 								'label' => lng('emails.forwarder_add'),
   142| 								'classes' => 'btn btn-sm btn-primary'
   143| 							]
   144| 						]
   145| 					]
   146| 				]
   147| 			]


# ====================================================================
# FILE: lib/formfields/customer/extras/formfield.htpasswd_add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 34-74 ---
    34| 				'image' => 'icons/htpasswd_add.png',
    35| 				'fields' => [
    36| 					'path' => [
    37| 						'label' => lng('panel.path'),
    38| 						'desc' => (Settings::Get('panel.pathedit') != 'Dropdown' ? lng('panel.pathDescription') : null),
    39| 						'type' => $pathSelect['type'],
    40| 						'select_var' => $pathSelect['select_var'] ?? '',
    41| 						'selected' => $pathSelect['value'],
    42| 						'value' => $pathSelect['value'],
    43| 						'note' => $pathSelect['note'] ?? '',
    44| 						'mandatory' => true
    45| 					],
    46| 					'username' => [
    47| 						'label' => lng('login.username'),
    48| 						'type' => 'text',
    49| 						'mandatory' => true
    50| 					],
    51| 					'directory_password' => [
    52| 						'label' => lng('login.password'),
    53| 						'type' => 'password',
    54| 						'autocomplete' => 'off',
    55| 						'mandatory' => true,
    56| 						'next_to' => [
    57| 							'directory_password_suggestion' => [
    58| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    59| 								'type' => 'text',
    60| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    61| 								'value' => Crypt::generatePassword(),
    62| 								'readonly' => true
    63| 							]
    64| 						]
    65| 					],
    66| 					'directory_authname' => [
    67| 						'label' => lng('extras.htpasswdauthname'),
    68| 						'type' => 'text',
    69| 						'mandatory' => true
    70| 					]
    71| 				]
    72| 			]
    73| 		]
    74| 	]


# ====================================================================
# FILE: lib/formfields/customer/extras/formfield.htpasswd_edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 29-69 ---
    29| 		'image' => 'fa-solid fa-lock',
    30| 		'self_overview' => ['section' => 'extras', 'page' => 'htpasswds'],
    31| 		'sections' => [
    32| 			'section_a' => [
    33| 				'title' => lng('extras.directoryprotection_edit'),
    34| 				'image' => 'icons/htpasswd_edit.png',
    35| 				'fields' => [
    36| 					'path' => [
    37| 						'label' => lng('panel.path'),
    38| 						'type' => 'label',
    39| 						'value' => $result['path']
    40| 					],
    41| 					'username' => [
    42| 						'label' => lng('login.username'),
    43| 						'type' => 'label',
    44| 						'value' => $result['username']
    45| 					],
    46| 					'directory_password' => [
    47| 						'label' => lng('login.password'),
    48| 						'type' => 'password',
    49| 						'autocomplete' => 'off',
    50| 						'next_to' => [
    51| 							'directory_password_suggestion' => [
    52| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    53| 								'type' => 'text',
    54| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    55| 								'value' => Crypt::generatePassword(),
    56| 								'readonly' => true
    57| 							]
    58| 						]
    59| 					],
    60| 					'directory_authname' => [
    61| 						'label' => lng('extras.htpasswdauthname'),
    62| 						'type' => 'text',
    63| 						'value' => $result['authname'],
    64| 						'mandatory' => true
    65| 					]
    66| 				]
    67| 			]
    68| 		]
    69| 	]


# ====================================================================
# FILE: lib/formfields/customer/ftp/formfield.ftp_add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-78 ---
    38| 						]
    39| 							: [])
    40| 					],
    41| 					'ftp_description' => [
    42| 						'label' => lng('panel.ftpdesc'),
    43| 						'type' => 'text'
    44| 					],
    45| 					'path' => [
    46| 						'label' => lng('panel.path'),
    47| 						'desc' => (Settings::Get('panel.pathedit') != 'Dropdown' ? lng('panel.pathDescription') : null),
    48| 						'type' => $pathSelect['type'],
    49| 						'select_var' => $pathSelect['select_var'] ?? '',
    50| 						'selected' => $pathSelect['value'],
    51| 						'value' => $pathSelect['value'],
    52| 						'note' => $pathSelect['note'] ?? '',
    53| 						'mandatory' => true
    54| 					],
    55| 					'ftp_password' => [
    56| 						'label' => lng('login.password'),
    57| 						'type' => 'password',
    58| 						'autocomplete' => 'off',
    59| 						'mandatory' => true,
    60| 						'next_to' => [
    61| 							'ftp_password_suggestion' => [
    62| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    63| 								'type' => 'text',
    64| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    65| 								'value' => Crypt::generatePassword(),
    66| 								'readonly' => true
    67| 							]
    68| 						]
    69| 					],
    70| 					'sendinfomail' => [
    71| 						'label' => lng('customer.sendinfomail'),
    72| 						'type' => 'checkbox',
    73| 						'value' => '1',
    74| 						'checked' => false
    75| 					],
    76| 					'shell' => [
    77| 						'visible' => Settings::Get('system.allow_customer_shell') == '1',
    78| 						'label' => lng('panel.shell'),


# ====================================================================
# FILE: lib/formfields/customer/ftp/formfield.ftp_edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 31-71 ---
    31| 					],
    32| 					'ftp_description' => [
    33| 						'label' => lng('panel.ftpdesc'),
    34| 						'type' => 'text',
    35| 						'value' => $result['description']
    36| 					],
    37| 					'path' => [
    38| 						'label' => lng('panel.path'),
    39| 						'desc' => (Settings::Get('panel.pathedit') != 'Dropdown' ? lng('panel.pathDescription') : null),
    40| 						'type' => $pathSelect['type'],
    41| 						'select_var' => $pathSelect['select_var'] ?? '',
    42| 						'selected' => $pathSelect['value'],
    43| 						'value' => $pathSelect['value'],
    44| 						'note' => $pathSelect['note'] ?? '',
    45| 						'mandatory' => true
    46| 					],
    47| 					'ftp_password' => [
    48| 						'label' => lng('login.password'),
    49| 						'desc' => lng('ftp.editpassdescription'),
    50| 						'type' => 'password',
    51| 						'autocomplete' => 'off',
    52| 						'next_to' => [
    53| 							'ftp_password_suggestion' => [
    54| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    55| 								'type' => 'text',
    56| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    57| 								'value' => Crypt::generatePassword(),
    58| 								'readonly' => true
    59| 							]
    60| 						]
    61| 					],
    62| 					'shell' => [
    63| 						'visible' => Settings::Get('system.allow_customer_shell') == '1',
    64| 						'label' => lng('panel.shell'),
    65| 						'type' => 'select',
    66| 						'select_var' => $shells,
    67| 						'selected' => $result['shell'] ?? '/bin/false'
    68| 					],
    69| 					'login_enabled' => [
    70| 						'label' => lng('panel.active'),
    71| 						'type' => 'checkbox',


# ====================================================================
# FILE: lib/formfields/customer/mysql/formfield.mysql_add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 25-65 ---
    25| 				'image' => 'icons/mysql_add.png',
    26| 				'fields' => [
    27| 					'custom_suffix' => [
    28| 						'visible' => strtoupper(Settings::Get('customer.mysqlprefix')) == 'DBNAME',
    29| 						'label' => lng('mysql.databasename'),
    30| 						'type' => 'text'
    31| 					],
    32| 					'description' => [
    33| 						'label' => lng('mysql.databasedescription'),
    34| 						'type' => 'text'
    35| 					],
    36| 					'mysql_server' => [
    37| 						'visible' => count($mysql_servers) > 1,
    38| 						'label' => lng('mysql.mysql_server'),
    39| 						'type' => 'select',
    40| 						'select_var' => $mysql_servers
    41| 					],
    42| 					'mysql_password' => [
    43| 						'label' => lng('login.password'),
    44| 						'type' => 'password',
    45| 						'autocomplete' => 'off',
    46| 						'mandatory' => true,
    47| 						'next_to' => [
    48| 							'mysql_password_suggestion' => [
    49| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    50| 								'type' => 'text',
    51| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    52| 								'value' => Crypt::generatePassword(),
    53| 								'readonly' => true
    54| 							]
    55| 						]
    56| 					],
    57| 					'sendinfomail' => [
    58| 						'label' => lng('customer.sendinfomail'),
    59| 						'type' => 'checkbox',
    60| 						'value' => '1',
    61| 						'checked' => false
    62| 					]
    63| 				]
    64| 			]
    65| 		]


# ====================================================================
# FILE: lib/formfields/customer/mysql/formfield.mysql_edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 32-67 ---
    32| 					'mysql_server' => [
    33| 						'visible' => count($mysql_servers) > 1,
    34| 						'type' => 'hidden',
    35| 						'value' => $result['dbserver'] ?? 0,
    36| 					],
    37| 					'mysql_server_info' => [
    38| 						'visible' => count($mysql_servers) > 1,
    39| 						'label' => lng('mysql.mysql_server'),
    40| 						'type' => 'label',
    41| 						'disabled' => true,
    42| 						'value' => $mysql_servers[$result['dbserver']] ?? 'unknown db server',
    43| 					],
    44| 					'description' => [
    45| 						'label' => lng('mysql.databasedescription'),
    46| 						'type' => 'text',
    47| 						'value' => $result['description']
    48| 					],
    49| 					'mysql_password' => [
    50| 						'label' => lng('changepassword.new_password_ifnotempty'),
    51| 						'type' => 'password',
    52| 						'autocomplete' => 'off',
    53| 						'next_to' => [
    54| 							'mysql_password_suggestion' => [
    55| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    56| 								'type' => 'text',
    57| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    58| 								'value' => Crypt::generatePassword(),
    59| 								'readonly' => true
    60| 							]
    61| 						]
    62| 					]
    63| 				]
    64| 			]
    65| 		]
    66| 	]
    67| ];


# ====================================================================
# FILE: lib/formfields/customer/mysql/formfield.mysql_global_user.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 14-50 ---
    14|  * @license        GPLv2 https://files.froxlor.org/misc/COPYING.txt
    15|  * @package        Formfields
    16|  */
    17| return [
    18| 	'mysql_global_user' => [
    19| 		'title' => lng('mysql.edit_global_user'),
    20| 		'self_overview' => ['section' => 'mysql', 'page' => 'mysqls'],
    21| 		'sections' => [
    22| 			'section_a' => [
    23| 				'title' => lng('mysql.edit_global_user'),
    24| 				'fields' => [
    25| 					'username' => [
    26| 						'label' => lng('login.username'),
    27| 						'value' => $userinfo['loginname'],
    28| 						'type' => 'text',
    29| 						'readonly' => true
    30| 					],
    31| 					'mysql_password' => [
    32| 						'label' => lng('login.password'),
    33| 						'type' => 'password',
    34| 						'autocomplete' => 'off',
    35| 						'mandatory' => true,
    36| 						'next_to' => [
    37| 							'mysql_password_suggestion' => [
    38| 								'next_to_prefix' => lng('customer.generated_pwd') . ':',
    39| 								'type' => 'text',
    40| 								'visible' => (Settings::Get('panel.password_regex') == ''),
    41| 								'value' => Crypt::generatePassword(),
    42| 								'readonly' => true
    43| 							]
    44| 						]
    45| 					]
    46| 				]
    47| 			]
    48| 		]
    49| 	]
    50| ];


# ====================================================================
# FILE: lib/functions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 38-78 ---
    38| }
    39| /**
    40|  * Get the current translation for a given string.
    41|  *
    42|  * @param string $identifier
    43|  * @param array $arguments
    44|  * @return array|string
    45|  */
    46| function lng(string $identifier, array $arguments = [])
    47| {
    48| 	return Language::getTranslation($identifier, $arguments);
    49| }
    50| /**
    51|  * Get the value of a request variable.
    52|  *
    53|  * @param string $identifier
    54|  * @param string|null $default
    55|  * @param string|null $session
    56|  * @return mixed|string|null
    57|  */
    58| function old(string $identifier, string $default = null, string $session = null)
    59| {
    60| 	if ($session && isset($_SESSION[$session])) {
    61| 		return $_SESSION[$session][$identifier] ?? $default;
    62| 	}
    63| 	return Request::any($identifier, $default);
    64| }
    65| /**
    66|  * Loading the mix manifest file from given theme.
    67|  * This file contains the hashed filenames of the assets.
    68|  * It must be always placed in the theme assets folder.
    69|  *
    70|  * @deprecated since 2.1.x no longer in use
    71|  * @param $filename
    72|  * @return mixed|string
    73|  */
    74| function mix($filename)
    75| {
    76| 	if (preg_match('/templates\/(.+)\/assets\/(.+)\/(.+)/', $filename, $matches)) {
    77| 		$mixManifest = dirname(__DIR__) . '/templates/' . $matches[1] . '/assets/mix-manifest.json';
    78| 		if (file_exists($mixManifest)) {


# ====================================================================
# FILE: lib/init.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 276-301 ---
   276| $mail = new Mailer(true);
   277| if (CurrentUser::hasSession()) {
   278| 	if (!$csrf_token = CurrentUser::getField('csrf_token')) {
   279| 		$csrf_token = Froxlor::genSessionId(20);
   280| 		CurrentUser::setField('csrf_token', $csrf_token);
   281| 	}
   282| 	UI::twig()->addGlobal('csrf_token', $csrf_token);
   283| 	if (in_array($_SERVER['REQUEST_METHOD'], ['POST', 'PUT', 'PATCH', 'DELETE'])) {
   284| 		$current_token = Request::post('csrf_token', $_SERVER['HTTP_X_CSRF_TOKEN'] ?? null);
   285| 		if ($current_token != CurrentUser::getField('csrf_token')) {
   286| 			http_response_code(403);
   287| 			Response::dynamicError('CSRF validation failed');
   288| 		}
   289| 	}
   290| 	$cookie_params = [
   291| 		'expires' => time() + min(Settings::Get('session.sessiontimeout'), 31536000),
   292| 		'path' => '/',
   293| 		'domain' => UI::getCookieHost(),
   294| 		'secure' => UI::requestIsHttps(),
   295| 		'httponly' => true,
   296| 		'samesite' => 'Strict'
   297| 	];
   298| 	setcookie(session_name(), $_COOKIE[session_name()], $cookie_params);
   299| } else {
   300| 	UI::twig()->addGlobal('csrf_token', Froxlor::genSessionId(20));
   301| }


# ====================================================================
# FILE: lng/de.lng.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 485-524 ---
   485| 			'add' => 'MySQL Server hinzufรผgen',
   486| 			'edit' => 'MySQL Server bearbeiten',
   487| 			'password' => 'Passwort privilegierter Benutzer',
   488| 			'password_emptynochange' => 'Neues Passwort, leer fรผr keine รnderung',
   489| 			'allowall' => [
   490| 				'title' => 'Nutzung fรผr aktuelle Kunden automatisch erlauben',
   491| 				'description' => 'Ist diese Einstellung aktiv, wird die Verwendung dieses Datenbank-Servers automatisch allen aktuell existierenden Kunden-Accounts erlaubt. Diese Einstellung ist nicht permanent, kann aber mehrfach / nach Bedarf ausgefรผhrt werden.',
   492| 			],
   493| 			'testconn' => 'Teste Verbindung beim Speichern',
   494| 			'ssl' => 'Verwende SSL fรผr die Verbindung zum Datenbank-Server',
   495| 			'ssl_cert_file' => 'Dateipfad zur SSL certificate authority',
   496| 			'verify_ca' => 'Aktiviere SSL Zertifikats-Verifikation',
   497| 		],
   498| 		'settings_importfile' => 'Wรคhle Import-Datei',
   499| 		'documentation' => 'Dokumentation',
   500| 		'adminguide' => 'Admin Guide',
   501| 		'userguide' => 'User Guide',
   502| 		'apiguide' => 'API Guide',
   503| 		'domain_duplicate' => 'Domain duplizieren',
   504| 		'domain_duplicate_named' => '%s duplizieren',
   505| 	],
   506| 	'apikeys' => [
   507| 		'no_api_keys' => 'Keine API Keys gefunden',
   508| 		'key_add' => 'API Key hinzufรผgen',
   509| 		'apikey_removed' => 'Der API Key mit der ID #%s wurde erfolgreich gelรถscht.',
   510| 		'apikey_added' => 'Der neue API Key wurde erfolgreich angelegt.',
   511| 		'clicktoview' => 'Details anzeigen',
   512| 		'allowed_from' => 'Erlaube Zugriff von',
   513| 		'allowed_from_help' => 'Komma getrennte Liste von IPs oder Netzen.<br>Standard ist leer (von รผberall erlaubt).',
   514| 		'valid_until' => 'Gรผltig bis',
   515| 		'valid_until_help' => 'Datum Gรผltigkeitsende, Format YYYY-MM-DDThh:mm',
   516| 	],
   517| 	'changepassword' => [
   518| 		'old_password' => 'Altes Passwort',
   519| 		'new_password' => 'Neues Passwort',
   520| 		'new_password_confirm' => 'Neues Passwort bestรคtigen',
   521| 		'new_password_ifnotempty' => 'Neues Passwort (leer fรผr keine รnderung)',
   522| 		'also_change_ftp' => 'Auch Passwort des Haupt-FTP-Zugangs รคndern',
   523| 		'also_change_stats' => ' Auch Passwort der Statistikseite รคndern',
   524| 		'also_change_global_mysql' => 'Auch Passwort des globalen MySQL-Zugangs รคndern',

# --- HUNK 2: Lines 621-660 ---
   621| 		],
   622| 		'rewrite_subject' => [
   623| 			'title' => 'Betreff รคndern',
   624| 			'description' => 'Dem E-Mail Betreff <strong>***SPAM***</strong> hinzufรผgen, sofern zutreffend',
   625| 		],
   626| 		'spam_kill_level' => [
   627| 			'title' => 'Ablehnungs Level',
   628| 			'description' => 'Erforderliche Punktzahl fรผr das Ablehnen einer E-Mail<br/>Standard: 14.0'
   629| 		],
   630| 		'bypass_spam' => [
   631| 			'title' => 'Spamfilter umgehen',
   632| 			'description' => 'Aktivieren, um den Spamfilter fรผr diese Adresse zu umgehen/deaktivieren.<br/>Standard: Nein'
   633| 		],
   634| 		'policy_greylist' => [
   635| 			'title' => 'Verwende greylisting',
   636| 			'description' => 'Eingehende E-Mails mittels <a href="https://de.wikipedia.org/wiki/Greylisting" target="_blank">Greylisting</a> schรผtzen.<br/>Standard: Ja'
   637| 		],
   638| 		'required_spf_dns' => 'Erforderlicher SPF DNS Eintrag',
   639| 		'required_dmarc_dns' => 'Erforderlicher DMARC DNS Eintrag',
   640| 		'required_dkim_dns' => 'Erforderlicher DKIM DNS Eintrag',
   641| 	],
   642| 	'dns' => [
   643| 		'destinationip' => 'Domain-IP-Adresse(n)',
   644| 		'standardip' => 'Server-Standard-IP-Adresse',
   645| 		'a_record' => 'A-Eintrag (IPv6 optional)',
   646| 		'cname_record' => 'CNAME-Eintrag',
   647| 		'mxrecords' => 'MX Eintrรคge definieren',
   648| 		'standardmx' => 'Server Standard MX Eintrag',
   649| 		'mxconfig' => 'Eigene MX Eintrรคge',
   650| 		'priority10' => 'Prioritรคt 10',
   651| 		'priority20' => 'Prioritรคt 20',
   652| 		'txtrecords' => 'TXT-Eintrรคge definieren',
   653| 		'txtexample' => 'Beispiel (SPF-Eintrag):<br />v=spf1 ip4:xxx.xxx.xx.0/23 -all',
   654| 		'howitworks' => 'Hier kรถnnen DNS Eintrรคge fรผr die Domain verwaltet werden. Beachten Sie, dass Froxlor automatisch NS/MX/A/AAAA Eintrรคge generiert. Die benutzerdefinierten Eintrรคge werden bevorzugt, nur fehlende Eintrรคge werden automatisch generiert.',
   655| 	],
   656| 	'dnseditor' => [
   657| 		'edit' => 'DNS editieren',
   658| 		'records' => 'Eintrรคge',
   659| 	],
   660| 	'domain' => [

# --- HUNK 3: Lines 750-789 ---
   750| 		'domains_cantdeletemaindomain' => 'Sie kรถnnen keine zugewiesene Domain lรถschen. ',
   751| 		'domains_canteditdomain' => 'Sie kรถnnen diese Domain nicht bearbeiten. Dies wurde durch den Admin verweigert.',
   752| 		'domains_cantdeletedomainwithemail' => 'Sie kรถnnen keine Domain lรถschen, die noch als E-Mail-Domain verwendet wird. Lรถschen Sie zuerst alle E-Mail-Adressen dieser Domain.',
   753| 		'firstdeleteallsubdomains' => 'Sie mรผssen zuerst alle Subdomains lรถschen, bevor Sie eine Wildcarddomain anlegen kรถnnen.',
   754| 		'youhavealreadyacatchallforthisdomain' => 'Sie haben bereits eine E-Mail-Adresse als Catchall fรผr diese Domain definiert.',
   755| 		'ftp_cantdeletemainaccount' => 'Sie kรถnnen Ihren Hauptaccount nicht lรถschen.',
   756| 		'login' => 'Die Kombination aus Benutzername und Passwort ist ungรผltig.',
   757| 		'login_blocked' => 'Dieser Account wurde aufgrund zu vieler Fehlversuche vorรผbergehend geschlossen.<br />Bitte versuchen Sie es in "%s" Sekunden erneut.',
   758| 		'notallreqfieldsorerrors' => 'Sie haben nicht alle Felder bzw. ein Feld mit fehlerhaften Angaben ausgefรผllt.',
   759| 		'oldpasswordnotcorrect' => 'Das alte Passwort ist nicht korrekt.',
   760| 		'youcantallocatemorethanyouhave' => 'Sie kรถnnen nicht mehr Ressourcen verteilen als Ihnen noch zur Verfรผgung stehen.',
   761| 		'mustbeurl' => 'Sie mรผssen eine vollstรคndige URL angeben (z. B. http://domain.de/error404.htm).',
   762| 		'invalidpath' => 'Sie haben keine gรผltige URL angegeben (evtl. Probleme beim Verzeichnislisting?).',
   763| 		'stringisempty' => 'Fehlende Eingabe im Feld',
   764| 		'stringiswrong' => 'Falsche Eingabe im Feld',
   765| 		'newpasswordconfirmerror' => 'Das neue Passwort und dessen Bestรคtigung sind nicht identisch.',
   766| 		'mydomain' => '\'Domain\'',
   767| 		'mydocumentroot' => '\'Documentroot\'',
   768| 		'loginnameexists' => 'Der Login-Name "%s" existiert bereits.',
   769| 		'emailiswrong' => 'Die E-Mail-Adresse "%s" enthรคlt ungรผltige Zeichen oder ist nicht vollstรคndig.',
   770| 		'alternativeemailiswrong' => 'Die angegebene alternative E-Mail Adresse "%s", an welche die Zugangsdaten geschickt werden soll, scheint ungรผltig zu sein.',
   771| 		'loginnameiswrong' => 'Der Login-Name "%s" enthรคlt ungรผltige Zeichen.',
   772| 		'loginnameiswrong2' => 'Der Login-Name enthรคlt zu viele Zeichen, es sind maximal %s Zeichen erlaubt.',
   773| 		'userpathcombinationdupe' => 'Die Kombination aus Benutzername und Pfad existiert bereits.',
   774| 		'patherror' => 'Allgemeiner Fehler! Pfad darf nicht leer sein.',
   775| 		'errordocpathdupe' => 'Option fรผr Pfad "%s" existiert bereits.',
   776| 		'adduserfirst' => 'Sie mรผssen zuerst einen Kunden anlegen.',
   777| 		'domainalreadyexists' => 'Die Domain "%s" wurde bereits einem Kunden zugeordnet.',
   778| 		'nolanguageselect' => 'Es wurde keine Sprache ausgewรคhlt.',
   779| 		'nosubjectcreate' => 'Sie mรผssen einen Betreff angeben.',
   780| 		'nomailbodycreate' => 'Sie mรผssen einen E-Mail-Text eingeben.',
   781| 		'templatenotfound' => 'Vorlage wurde nicht gefunden.',
   782| 		'alltemplatesdefined' => 'Sie kรถnnen keine weiteren Vorlagen anlegen, da bereits fรผr alle Sprachen eine Vorlage existiert.',
   783| 		'wwwnotallowed' => 'Ihre Subdomain darf nicht \'www\' heiรen.',
   784| 		'subdomainiswrong' => 'Die Subdomain "%s" enthรคlt ungรผltige Zeichen.',
   785| 		'domaincantbeempty' => 'Der Domainname darf nicht leer sein.',
   786| 		'domainexistalready' => 'Die Domain "%s" existiert bereits.',
   787| 		'domainisaliasorothercustomer' => 'Die ausgewรคhlte Aliasdomain ist entweder selbst eine Aliasdomain, hat nicht die gleiche IP/Port-Kombination oder gehรถrt einem anderen Kunden.',
   788| 		'emailexistalready' => 'Die E-Mail-Adresse "%s" existiert bereits.',
   789| 		'maindomainnonexist' => 'Die Hauptdomain "%s" existiert nicht.',

# --- HUNK 4: Lines 937-976 ---
   937| 		'dns_record_toolong' => 'Records/Labels kรถnnen maximal 63 Zeichen lang sein',
   938| 		'noipportgiven' => 'Keine IP/Port angegeben',
   939| 		'nosslippportgiven' => 'Wenn SSL aktiviert ist, muss eine SSL IP/Port angegeben werden',
   940| 		'jsonextensionnotfound' => 'Diese Funktion benรถtigt die PHP json-Erweiterung.',
   941| 		'cannotdeletesuperadmin' => 'Der erste Administrator kann nicht gelรถscht werden.',
   942| 		'no_wwwcnamae_ifwwwalias' => 'Es kann kein CNAME Eintrag fรผr "www" angelegt werden, da die Domain einen www-Alias aktiviert hat. รndere diese Einstellung auf "Kein Alias" oder "Wildcard Alias"',
   943| 		'local_group_exists' => 'Die angegebene Gruppe existiert bereits auf dem System',
   944| 		'local_group_invalid' => 'Der angegebene Gruppen-Name ist nicht gรผltig',
   945| 		'invaliddnsforletsencrypt' => 'Die DNS-Eintrรคge der Domain enthalten keine der gewรคhlten IP Adressen. Let\'s Encrypt Zertifikats-Erstellung ist nicht mรถglich.',
   946| 		'notallowedphpconfigused' => 'Nutzung einer PHP-Konfiguration welche nicht dem Kunden zugeordnet ist',
   947| 		'pathmustberelative' => 'Der Benutzer hat nicht die benรถtigten Berechtigungen, um Pfade auรerhalb des Kunden-Heimatverzeichnisses anzugeben. Bitte einen relativen Pfad angeben (kein fรผhrendes /).',
   948| 		'mysqlserverstillhasdbs' => 'Datenbank-Server kann fรผr den Kunden nicht entfernt werden, da sich dort noch Datenbanken befinden.',
   949| 		'domaincannotbeedited' => 'Keine Berechtigung, um die Domain %s zu bearbeiten',
   950| 		'invalidcronjobintervalvalue' => 'Cronjob Intervall muss einer der folgenden Werte sein: %s',
   951| 		'phpgdextensionnotavailable' => 'Die PHP GD Extension ist nicht verfรผgbar. Bild-Daten kรถnnen nicht validiert werden.',
   952| 		'2fa_wrongcode' => 'Der angegebene Code ist nicht korrekt',
   953| 		'gnupgextensionnotavailable' => 'Die PHP GnuPG Extension ist nicht verfรผgbar. PGP Schlรผssel kรถnnen nicht validiert werden.',
   954| 		'invalidpgppublickey' => 'Der angegebene PGP Public Key ist ungรผltig',
   955| 		'invalid_validtime' => 'Wert der valid_time in Sekunden muss zwischen 10 und 120 liegen.',
   956| 		'customerphpenabledbutnoconfig' => 'Kunde hat PHP aktiviert aber keine PHP-Konfiguration wurde gewรคhlt.',
   957| 	],
   958| 	'extras' => [
   959| 		'description' => 'Hier kรถnnen Sie zusรคtzliche Extras einrichten, wie zum Beispiel einen Verzeichnisschutz.<br />Die รnderungen sind erst nach einer kurzen Zeit wirksam.',
   960| 		'directoryprotection_add' => 'Verzeichnisschutz anlegen',
   961| 		'view_directory' => 'Verzeichnis anzeigen',
   962| 		'pathoptions_add' => 'Pfadoptionen hinzufรผgen',
   963| 		'directory_browsing' => 'Verzeichnisinhalt anzeigen',
   964| 		'pathoptions_edit' => 'Pfadoptionen bearbeiten',
   965| 		'error404path' => '404',
   966| 		'error403path' => '403',
   967| 		'error500path' => '500',
   968| 		'error401path' => '401',
   969| 		'errordocument404path' => 'Fehlerdokument 404',
   970| 		'errordocument403path' => 'Fehlerdokument 403',
   971| 		'errordocument500path' => 'Fehlerdokument 500',
   972| 		'errordocument401path' => 'Fehlerdokument 401',
   973| 		'execute_perl' => 'Perl/CGI ausfรผhren',
   974| 		'htpasswdauthname' => 'Grund der Authentifizierung (AuthName)',
   975| 		'directoryprotection_edit' => 'Verzeichnisschutz bearbeiten',
   976| 		'export' => 'Datenexport erstellen',

# --- HUNK 5: Lines 2150-2189 ---
  2150| 		'testmailsent' => 'Test E-Mail erfolgreich gesendet',
  2151| 		'settingsimported' => 'Einstellungnen erfolgreich importiert',
  2152| 		'sent_error_report' => 'Fehlerbericht erfolgreich gesendet. Danke fรผr die Unterstรผtzung.',
  2153| 	],
  2154| 	'tasks' => [
  2155| 		'outstanding_tasks' => 'Ausstehende Cron-Aufgaben',
  2156| 		'REBUILD_VHOST' => 'Neuerstellung der Webserver-Konfiguration',
  2157| 		'CREATE_HOME' => 'Erstelle neuen Kunden %s',
  2158| 		'REBUILD_DNS' => 'Neuerstellung der Bind-Konfiguration',
  2159| 		'CREATE_FTP' => 'Erstelle Verzeichnis fรผr neuen FTP-Benutzer',
  2160| 		'DELETE_CUSTOMER_FILES' => 'Lรถschen von Kunden-Dateien %s',
  2161| 		'noneoutstanding' => 'Zur Zeit gibt es keine ausstehenden Aufgaben fรผr Froxlor',
  2162| 		'DELETE_EMAIL_DATA' => 'E-Mail-Dateien des Kunden lรถschen',
  2163| 		'DELETE_FTP_DATA' => 'Kunden FTP-Konto Dateien lรถschen',
  2164| 		'REBUILD_RSPAMD' => 'Neuerstellung der Antispam-Konfiguration',
  2165| 		'CREATE_QUOTA' => 'Quota auf dem Dateisystem setzen',
  2166| 		'REBUILD_CRON' => 'Neuerstellung der cron.d-Datei',
  2167| 		'CREATE_CUSTOMER_DATADUMP' => 'Daten-Export fรผr Kunde %s',
  2168| 		'DELETE_DOMAIN_PDNS' => 'Lรถsche Domain %s von PowerDNS Datenbank',
  2169| 		'DELETE_DOMAIN_SSL' => 'Lรถsche SSL Dateien von Domain %s',
  2170| 	],
  2171| 	'terms' => 'AGB',
  2172| 	'traffic' => [
  2173| 		'month' => 'Monat',
  2174| 		'months' => [
  2175| 			1 => 'Januar',
  2176| 			2 => 'Februar',
  2177| 			3 => 'Mรคrz',
  2178| 			4 => 'April',
  2179| 			5 => 'Mai',
  2180| 			6 => 'Juni',
  2181| 			7 => 'Juli',
  2182| 			8 => 'August',
  2183| 			9 => 'September',
  2184| 			10 => 'Oktober',
  2185| 			11 => 'November',
  2186| 			12 => 'Dezember',
  2187| 			'jan' => 'Jan',
  2188| 			'feb' => 'Feb',
  2189| 			'mar' => 'Mรคr',

# --- HUNK 6: Lines 2245-2284 ---
  2245| 		'custom_notes' => [
  2246| 			'title' => 'Eigene Notizen',
  2247| 			'description' => 'Hier kรถnnen Notizen je nach Lust und Laune eingetragen werden. Diese werden in der Administrator/Kunden-รbersicht bei dem jeweiligen Benutzer angezeigt.<br>Markdown ist unterstรผtzt, HTML wird entfernt.',
  2248| 			'show' => 'Zeige die Notizen auf dem Dashboard des Benutzers',
  2249| 		],
  2250| 		'api_allowed' => [
  2251| 			'title' => 'Erlaube API Zugriff',
  2252| 			'description' => 'Wenn in den Einstellungen aktiviert, kann der Benutzer API Schlรผssel erstellen und auf die froxlor API Zugreifen',
  2253| 			'notice' => 'API Zugriff ist fรผr dieses Konto deaktiviert.',
  2254| 		],
  2255| 		'gui_access' => [
  2256| 			'title' => 'WebUI-Anmeldung zulassen',
  2257| 			'description' => 'Wenn diese Option deaktiviert ist, kann sich der Benutzer nicht bei der Froxlor-Weboberflรคche anmelden, aber alle Dienste (Web, FTP, E-Mail, Datenbanken, API-Zugriff, usw.) funktionieren normal.',
  2258| 		],
  2259| 	],
  2260| 	'install' => [
  2261| 		'preflight' => 'System-Prรผfung',
  2262| 		'critical_error' => 'Kritischer Fehler',
  2263| 		'suggestions' => 'Nicht notwendig, aber emfohlen',
  2264| 		'phpinfosuccess' => 'Auf dem System ist PHP %s installiert',
  2265| 		'phpinfowarn' => 'Die genutzte PHP Version ist kleiner als die geforderte Version %s',
  2266| 		'phpinfoupdate' => 'Aktualisierung von PHP Version %s auf %s oder hรถher notwendig',
  2267| 		'start_installation' => 'Installation starten',
  2268| 		'check_again' => 'Erneut prรผfen...',
  2269| 		'switchmode_advanced' => 'Erweiterte Optionen anzeigen',
  2270| 		'switchmode_basic' => 'Erweiterte Optionen ausblenden',
  2271| 		'dependency_check' => [
  2272| 			'title' => 'Willkommen bei froxlor',
  2273| 			'description' => 'Das System wird auf Abhรคngigkeiten รผberprรผft, um sicher zu stellen das alle erforderlichen PHP Erweiterungen vorhanden und aktiviert sind, so dass froxlor einwandfrei funktioniert.',
  2274| 		],
  2275| 		'database' => [
  2276| 			'top' => 'Datenbank',
  2277| 			'title' => 'Datenbank und Benutzer erstellen',
  2278| 			'description' => 'Froxlor benรถtigt eine Datenbank und zusรคtzlich <a href="https://docs.froxlor.org/latest/general/installation/tarball.html#_3-create-privileged-database-user" target="_blank">einen Benutzer mit privilegierten Rechten</a>, welcher Benutzer und Datenbanken erstellen darf (GRANT Option). Die angegebene Datenbank und der unprivilegierte Benutzer werden automatisch in diesem Prozess erstellt. Der privilegierte Benutzer muss existieren.',
  2279| 			'user' => 'Unprivilegierter Datenbank Benutzer',
  2280| 			'dbname' => 'Datenbank Name',
  2281| 			'force_create' => 'Sichern und รผberschreiben, sofern Datenbank existiert?',
  2282| 		],
  2283| 		'admin' => [
  2284| 			'top' => 'Admin Konto',


# ====================================================================
# FILE: lng/en.lng.php
# Total hunks: 7
# ====================================================================
# --- HUNK 1: Lines 10-49 ---
    10|  *
    11|  * This program is distributed in the hope that it will be useful,
    12|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    13|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
    14|  * GNU General Public License for more details.
    15|  *
    16|  * You should have received a copy of the GNU General Public License
    17|  * along with this program; if not, you can also view it online at
    18|  * https://files.froxlor.org/misc/COPYING.txt
    19|  *
    20|  * @copyright  the authors
    21|  * @author     Froxlor team <team@froxlor.org>
    22|  * @license    https://files.froxlor.org/misc/COPYING.txt GPLv2
    23|  */
    24| return [
    25| 	'languages' => [
    26| 		'cz' => 'Czech',
    27| 		'de' => 'German',
    28| 		'en' => 'English',
    29| 		'fr' => 'French',
    30| 		'it' => 'Italian',
    31| 		'nl' => 'Dutch',
    32| 		'pt' => 'Portuguese',
    33| 		'se' => 'Swedish',
    34| 		'es' => 'Spanish',
    35| 		'ca' => 'Catalan',
    36| 	],
    37| 	'2fa' => [
    38| 		'2fa' => '2FA options',
    39| 		'2fa_enabled' => 'Activate Two-factor authentication (2FA)',
    40| 		'2fa_removed' => '2FA removed successfully',
    41| 		'2fa_added' => '2FA activated successfully<br><a class="alert-link" href="%s?page=2fa">View 2FA details</a>',
    42| 		'2fa_add' => 'Activate 2FA',
    43| 		'2fa_delete' => 'Deactivate 2FA',
    44| 		'2fa_verify' => 'Verify code',
    45| 		'2fa_overview_desc' => 'Here you can activate a two-factor authentication for your account.<br><br>You can either use an authenticator-app (time-based one-time password / TOTP) or let froxlor send you an email to your account-address after each successful login with a one-time password.',
    46| 		'2fa_email_desc' => 'Your account is set up to use one-time passwords via e-mail. To deactivate, click on "Deactivate 2FA"',
    47| 		'2fa_ga_desc' => 'Your account is set up to use time-based one-time passwords via authenticator-app. Please scan the QR code below with your desired authenticator app to generate the codes. To deactivate, click on "Deactivate 2FA"',
    48| 		'2fa_not_activated' => 'Two-factor authentication is not enabled',
    49| 		'2fa_not_activated_for_user' => 'Two-factor authentication is not enabled for the current user',

# --- HUNK 2: Lines 500-539 ---
   500| 			'password_emptynochange' => 'New password, leave empty for no change',
   501| 			'allowall' => [
   502| 				'title' => 'Allow use of this server to all currently existing customers',
   503| 				'description' => 'Set this to "true" if you want to allow use of this database-server to all currently existing customers so they can add databases on it. This setting is not permanent but can be run multiple times.',
   504| 			],
   505| 			'testconn' => 'Test connection when saving',
   506| 			'ssl' => 'Use SSL for connection to database-server',
   507| 			'ssl_cert_file' => 'The file path to the SSL certificate authority',
   508| 			'verify_ca' => 'Enable verification of the server SSL certificate',
   509| 		],
   510| 		'settings_importfile' => 'Chose import file',
   511| 		'documentation' => 'Documentation',
   512| 		'adminguide' => 'Admin guide',
   513| 		'userguide' => 'User guide',
   514| 		'apiguide' => 'API guide',
   515| 		'domain_duplicate' => 'Duplicate domain',
   516| 		'domain_duplicate_named' => 'Duplicate %s',
   517| 		'backups' => [
   518| 			'backups' => 'Backups',
   519| 		],
   520| 	],
   521| 	'apcuinfo' => [
   522| 		'clearcache' => 'Clear APCu cache',
   523| 		'generaltitle' => 'General Cache Information',
   524| 		'version' => 'APCu Version',
   525| 		'phpversion' => 'PHP Version',
   526| 		'host' => 'APCu Host',
   527| 		'sharedmem' => 'Shared Memory',
   528| 		'sharedmemval' => '%d Segment(s) with %s (%s memory)',
   529| 		'start' => 'Start Time',
   530| 		'uptime' => 'Uptime',
   531| 		'upload' => 'File Upload Support',
   532| 		'cachetitle' => 'Cache Information',
   533| 		'cvar' => 'Cached Variables',
   534| 		'hit' => 'Hits',
   535| 		'miss' => 'Misses',
   536| 		'reqrate' => 'Request Rate (hits, misses)',
   537| 		'creqsec' => 'cache requests/second',
   538| 		'hitrate' => 'Hit Rate',
   539| 		'missrate' => 'Miss Rate',

# --- HUNK 3: Lines 670-709 ---
   670| 		],
   671| 		'rewrite_subject' => [
   672| 			'title' => 'Rewrite subject',
   673| 			'description' => 'Whether to add <strong>***SPAM***</strong> to the email subject if applicable',
   674| 		],
   675| 		'spam_kill_level' => [
   676| 			'title' => 'Spam kill level',
   677| 			'description' => 'Score that is required to discard an email entirely<br/>Default: 14.0'
   678| 		],
   679| 		'bypass_spam' => [
   680| 			'title' => 'Bypass spamfilter',
   681| 			'description' => 'Activate to bypass/disable spamfiltering for this address.<br/>Default: no'
   682| 		],
   683| 		'policy_greylist' => [
   684| 			'title' => 'Use greylisting',
   685| 			'description' => 'Incoming emails will be protected by <a href="https://en.wikipedia.org/wiki/Greylisting_(email)" target="_blank">greylisting</a>.<br/>Default: yes'
   686| 		],
   687| 		'required_spf_dns' => 'Required SPF DNS entry',
   688| 		'required_dmarc_dns' => 'Required DMARC DNS entry',
   689| 		'required_dkim_dns' => 'Required DKIM DNS entry',
   690| 	],
   691| 	'dns' => [
   692| 		'destinationip' => 'Domain IP(s)',
   693| 		'standardip' => 'Server standard IP',
   694| 		'a_record' => 'A-Record (IPv6 optional)',
   695| 		'cname_record' => 'CNAME-Record',
   696| 		'mxrecords' => 'Define MX records',
   697| 		'standardmx' => 'Server standard MX record',
   698| 		'mxconfig' => 'Custom MX records',
   699| 		'priority10' => 'Priority 10',
   700| 		'priority20' => 'Priority 20',
   701| 		'txtrecords' => 'Define TXT records',
   702| 		'txtexample' => 'Example (SPF-entry):<br />v=spf1 ip4:xxx.xxx.xx.0/23 -all',
   703| 		'howitworks' => 'Here you can manage DNS entries for your domain. Note that froxlor will automatically generate NS/MX/A/AAAA records for you. The custom entries are preferred, only missing entries will be automatically generated.',
   704| 	],
   705| 	'dnseditor' => [
   706| 		'edit' => 'edit DNS',
   707| 		'records' => 'records',
   708| 		'notes' => [
   709| 			'A' => '32-bit IPv4 address, used to map hostnames to an IP address of the host.',

# --- HUNK 4: Lines 821-860 ---
   821| 		'domains_cantdeletemaindomain' => 'You cannot delete an assigned domain.',
   822| 		'domains_canteditdomain' => 'You cannot edit this domain. It has been disabled by the admin.',
   823| 		'domains_cantdeletedomainwithemail' => 'You cannot delete a domain which is used as an email-domain. Delete all email addresses first.',
   824| 		'firstdeleteallsubdomains' => 'You have to delete all subdomains first before you can create a wildcard domain.',
   825| 		'youhavealreadyacatchallforthisdomain' => 'You have already defined a catchall for this domain.',
   826| 		'ftp_cantdeletemainaccount' => 'You cannot delete your main FTP account',
   827| 		'login' => 'The username or password you typed in is wrong. Please try it again!',
   828| 		'login_blocked' => 'This account has been suspended because of too many login errors. <br />Please try again in %s seconds.',
   829| 		'notallreqfieldsorerrors' => 'You have not filled in all or filled in some fields incorrectly.',
   830| 		'oldpasswordnotcorrect' => 'The old password is not correct.',
   831| 		'youcantallocatemorethanyouhave' => 'You cannot allocate more resources than you own for yourself.',
   832| 		'mustbeurl' => 'You have not typed a valid or complete url (e.g. http://somedomain.com/error404.htm)',
   833| 		'invalidpath' => 'You have not chosen a valid URL (maybe problems with the dirlisting?)',
   834| 		'stringisempty' => 'Missing Input in Field',
   835| 		'stringiswrong' => 'Wrong Input in Field',
   836| 		'newpasswordconfirmerror' => 'New password and confirmation does not match',
   837| 		'mydomain' => '\'Domain\'',
   838| 		'mydocumentroot' => '\'Documentroot\'',
   839| 		'loginnameexists' => 'Loginname %s already exists',
   840| 		'emailiswrong' => 'Email-address %s contains invalid characters or is incomplete',
   841| 		'alternativeemailiswrong' => 'The given alternative email address %s to send the credentials to seems to be invalid',
   842| 		'loginnameiswrong' => 'Loginname "%s" contains illegal characters.',
   843| 		'loginnameiswrong2' => 'Loginname contains too many characters. Only %s characters are allowed.',
   844| 		'userpathcombinationdupe' => 'Combination of username and path already exists',
   845| 		'patherror' => 'General Error! Path cannot be empty',
   846| 		'errordocpathdupe' => 'Option for path %s already exists',
   847| 		'adduserfirst' => 'Please create a customer first',
   848| 		'domainalreadyexists' => 'The domain %s is already assigned to a customer',
   849| 		'nolanguageselect' => 'No language selected.',
   850| 		'nosubjectcreate' => 'You must define a topic for this mail template.',
   851| 		'nomailbodycreate' => 'You must define a mail-text for this mail template.',
   852| 		'templatenotfound' => 'Template was not found.',
   853| 		'alltemplatesdefined' => 'You can\'t define more templates, all languages are supported already.',
   854| 		'wwwnotallowed' => 'www is not allowed for subdomains.',
   855| 		'subdomainiswrong' => 'The subdomain %s contains invalid characters.',
   856| 		'domaincantbeempty' => 'The domain-name can not be empty.',
   857| 		'domainexistalready' => 'The domain %s already exists.',
   858| 		'domainisaliasorothercustomer' => 'The selected alias domain is either itself an alias domain, has a different ip/port combination or belongs to another customer.',
   859| 		'emailexistalready' => 'The email-address %s already exists.',
   860| 		'maindomainnonexist' => 'The main-domain %s does not exist.',

# --- HUNK 5: Lines 1009-1048 ---
  1009| 		'dns_record_toolong' => 'Records/labels can only be up to 63 characters',
  1010| 		'noipportgiven' => 'No IP/port given',
  1011| 		'nosslippportgiven' => 'When enabling SSL you need to select a SSL IP/port',
  1012| 		'jsonextensionnotfound' => 'This feature requires the php json-extension.',
  1013| 		'cannotdeletesuperadmin' => 'The first admin cannot be deleted.',
  1014| 		'no_wwwcnamae_ifwwwalias' => 'Cannot set CNAME record for "www" as domain is set to generate a www-alias. Please change settings to either "No alias" or "Wildcard alias"',
  1015| 		'local_group_exists' => 'The given group already exists on the system.',
  1016| 		'local_group_invalid' => 'The given group name is invalid',
  1017| 		'invaliddnsforletsencrypt' => 'The domains DNS does not include any of the chosen IP addresses. Let\'s Encrypt certificate generation not possible.',
  1018| 		'notallowedphpconfigused' => 'Trying to use php-config which is not assigned to customer',
  1019| 		'pathmustberelative' => 'The user does not have the permission to specify directories outside the customers home-directory. Please specify a relative path (no leading /).',
  1020| 		'mysqlserverstillhasdbs' => 'Cannot remove database server from customers allow-list as there are still databases on it.',
  1021| 		'domaincannotbeedited' => 'You are not permitted to edit the domain %s',
  1022| 		'invalidcronjobintervalvalue' => 'Cronjob interval must be one of: %s',
  1023| 		'phpgdextensionnotavailable' => 'The PHP GD extension is not available. Unable to validate image-data',
  1024| 		'2fa_wrongcode' => 'The code entered is not valid',
  1025| 		'gnupgextensionnotavailable' => 'The PHP GnuPG extension is not available. Unable to validate PGP Public Key',
  1026| 		'invalidpgppublickey' => 'The PGP Public Key is not valid',
  1027| 		'invalid_validtime' => 'Valid time in seconds can only be between 10 and 120',
  1028| 		'customerphpenabledbutnoconfig' => 'Customer has PHP activated but no PHP-configuration was selected.',
  1029| 	],
  1030| 	'extras' => [
  1031| 		'description' => 'Here you can add some extras, for example directory protection.<br />The system will need some time to apply the new settings after every change.',
  1032| 		'directoryprotection_add' => 'Add directory protection',
  1033| 		'view_directory' => 'Display directory content',
  1034| 		'pathoptions_add' => 'Add path options',
  1035| 		'directory_browsing' => 'Directory content browsing',
  1036| 		'pathoptions_edit' => 'Edit path options',
  1037| 		'error404path' => '404',
  1038| 		'error403path' => '403',
  1039| 		'error500path' => '500',
  1040| 		'error401path' => '401',
  1041| 		'errordocument404path' => 'ErrorDocument 404',
  1042| 		'errordocument403path' => 'ErrorDocument 403',
  1043| 		'errordocument500path' => 'ErrorDocument 500',
  1044| 		'errordocument401path' => 'ErrorDocument 401',
  1045| 		'execute_perl' => 'Execute perl/CGI',
  1046| 		'htpasswdauthname' => 'Authentication reason (AuthName)',
  1047| 		'directoryprotection_edit' => 'Edit directory protection',
  1048| 		'export' => 'Create data dump',

# --- HUNK 6: Lines 2284-2323 ---
  2284| 		'testmailsent' => 'Test mail sent successfully',
  2285| 		'settingsimported' => 'Settings imported successfully',
  2286| 		'sent_error_report' => 'Succesfully sent error report. Thank you for your contribution.',
  2287| 	],
  2288| 	'tasks' => [
  2289| 		'outstanding_tasks' => 'Pending cron-tasks',
  2290| 		'REBUILD_VHOST' => 'Rebuilding webserver-configuration',
  2291| 		'CREATE_HOME' => 'Adding new customer %s',
  2292| 		'REBUILD_DNS' => 'Rebuilding bind-configuration',
  2293| 		'CREATE_FTP' => 'Creating directory for new ftp-user',
  2294| 		'DELETE_CUSTOMER_FILES' => 'Deleting customer-files %s',
  2295| 		'noneoutstanding' => 'There are currently no outstanding tasks for Froxlor',
  2296| 		'DELETE_EMAIL_DATA' => 'Delete customer e-mail data.',
  2297| 		'DELETE_FTP_DATA' => 'Delete customer ftp-account data.',
  2298| 		'REBUILD_RSPAMD' => 'Rebuilding antispam-configuration.',
  2299| 		'CREATE_QUOTA' => 'Set quota on filesystem',
  2300| 		'REBUILD_CRON' => 'Rebuilding the cron.d-file',
  2301| 		'CREATE_CUSTOMER_DATADUMP' => 'Data export job for customer %s',
  2302| 		'DELETE_DOMAIN_PDNS' => 'Delete domain %s from PowerDNS database',
  2303| 		'DELETE_DOMAIN_SSL' => 'Delete ssl files of domain %s',
  2304| 	],
  2305| 	'terms' => 'Terms of use',
  2306| 	'traffic' => [
  2307| 		'month' => 'Month',
  2308| 		'day' => 'Day',
  2309| 		'months' => [
  2310| 			1 => 'January',
  2311| 			2 => 'February',
  2312| 			3 => 'March',
  2313| 			4 => 'April',
  2314| 			5 => 'May',
  2315| 			6 => 'June',
  2316| 			7 => 'July',
  2317| 			8 => 'August',
  2318| 			9 => 'September',
  2319| 			10 => 'October',
  2320| 			11 => 'November',
  2321| 			12 => 'December',
  2322| 			'jan' => 'Jan',
  2323| 			'feb' => 'Feb',

# --- HUNK 7: Lines 2381-2420 ---
  2381| 			'title' => 'Custom notes',
  2382| 			'description' => 'Feel free to put any notes you want/need in here. They will show up in the admin/customer overview for the corresponding user.<br>Markdown is supported, HTML will be removed.',
  2383| 			'show' => 'Show your notes on the dashboard of the user',
  2384| 		],
  2385| 		'api_allowed' => [
  2386| 			'title' => 'Allow API access',
  2387| 			'description' => 'When enabled in the settings, this user can create API keys and access the froxlor API',
  2388| 			'notice' => 'API access is not allowed for your account.',
  2389| 		],
  2390| 		'gui_access' => [
  2391| 			'title' => 'Allow WebUI login',
  2392| 			'description' => 'When disabled, the user cannot log in to the froxlor web-ui but all the services (web, ftp, mail, databases, api-access, etc.) will work normally.',
  2393| 		],
  2394| 	],
  2395| 	'install' => [
  2396| 		'slogan' => 'froxlor Server Management Panel',
  2397| 		'preflight' => 'System check',
  2398| 		'critical_error' => 'Critical error',
  2399| 		'suggestions' => 'Not required but recommended',
  2400| 		'phpinfosuccess' => 'Your system is running with PHP %s',
  2401| 		'phpinfowarn' => 'Your system is running a lower version than PHP %s',
  2402| 		'phpinfoupdate' => 'Update your current PHP version from %s to %s or higher',
  2403| 		'start_installation' => 'Start installation',
  2404| 		'check_again' => 'Reload to check again',
  2405| 		'switchmode_advanced' => 'Show advanced options',
  2406| 		'switchmode_basic' => 'Hide advanced options',
  2407| 		'dependency_check' => [
  2408| 			'title' => 'Welcome to froxlor',
  2409| 			'description' => 'We check the system for dependencies to ensure that all required php extensions and modules are enabled so that froxlor runs properly.',
  2410| 		],
  2411| 		'database' => [
  2412| 			'top' => 'Database',
  2413| 			'title' => 'Create database and user',
  2414| 			'description' => 'Froxlor requires a database and additionally <a href="https://docs.froxlor.org/latest/general/installation/tarball.html#_3-create-privileged-database-user" target="_blank">a privileged user</a> to be able to create users and databases (GRANT option). The given database and unprivileged database-user will be created in this process. The privileged user must exist.',
  2415| 			'user' => 'Unprivileged database user',
  2416| 			'dbname' => 'Database name',
  2417| 			'force_create' => 'Backup and overwrite database if exists?',
  2418| 		],
  2419| 		'admin' => [
  2420| 			'top' => 'Admin user',


# ====================================================================
# FILE: templates/Froxlor/assets/js/jquery/domains.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 46-85 ---
    46| 						id: $('input[name=id]').val(), newval: +$('#speciallogfile').is(':checked')
    47| 					},
    48| 					dataType: "json",
    49| 					async: false,
    50| 					beforeSend: function (request) {
    51| 						request.setRequestHeader('X-CSRF-TOKEN', document.querySelector('meta[name="csrf-token"]').getAttribute('content'));
    52| 					},
    53| 					success: function (json) {
    54| 						if (json.changed) {
    55| 							$('#speciallogfile').addClass('is-invalid');
    56| 							$('#speciallogfile').parent().append(json.info);
    57| 							$('#speciallogverified').val(1);
    58| 						}
    59| 					},
    60| 					error: function (a, b) {
    61| 						console.log(a, b);
    62| 					}
    63| 				});
    64| 			});
    65| 		}
    66| 		/**
    67| 		 * email only domain - hide unnecessary/unused sections
    68| 		 */
    69| 		if ($('#id') && $('#email_only').is(':checked')) {
    70| 			$('#section_b').hide();
    71| 			$('#section_bssl').hide();
    72| 			$('#section_c').hide();
    73| 		}
    74| 		/**
    75| 		 * toggle show/hide of sections in case of email only flag
    76| 		 */
    77| 		$('#email_only').on('click', function () {
    78| 			if ($(this).is(':checked')) {
    79| 				$('#section_b').hide();
    80| 				$('#section_bssl').hide();
    81| 				$('#section_c').hide();
    82| 			} else {
    83| 				$('#section_b').show();
    84| 				$('#section_bssl').show();
    85| 				$('#section_c').show();

