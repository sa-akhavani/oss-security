# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Asset/AssetController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2248 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Asset;
    15| use Pimcore\Bundle\AdminBundle\Controller\Admin\ElementControllerBase;
    16| use Pimcore\Bundle\AdminBundle\Controller\Traits\AdminStyleTrait;
    17| use Pimcore\Bundle\AdminBundle\Controller\Traits\ApplySchedulerDataTrait;
    18| use Pimcore\Bundle\AdminBundle\Helper\GridHelperService;
    19| use Pimcore\Bundle\AdminBundle\Security\CsrfProtectionHandler;
    20| use Pimcore\Config;
    21| use Pimcore\Controller\KernelControllerEventInterface;
    22| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    23| use Pimcore\Event\Admin\ElementAdminStyleEvent;
    24| use Pimcore\Event\AdminEvents;
    25| use Pimcore\Event\AssetEvents;
    26| use Pimcore\File;
    27| use Pimcore\Loader\ImplementationLoader\Exception\UnsupportedException;
    28| use Pimcore\Logger;
    29| use Pimcore\Model;
    30| use Pimcore\Model\Asset;
    31| use Pimcore\Model\Element;
    32| use Pimcore\Tool;
    33| use Symfony\Component\EventDispatcher\GenericEvent;
    34| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    35| use Symfony\Component\HttpFoundation\JsonResponse;
    36| use Symfony\Component\HttpFoundation\Request;
    37| use Symfony\Component\HttpFoundation\Response;
    38| use Symfony\Component\HttpFoundation\ResponseHeaderBag;
    39| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    40| use Symfony\Component\HttpFoundation\StreamedResponse;
    41| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    42| use Symfony\Component\Mime\MimeTypes;
    43| use Symfony\Component\Process\Process;
    44| use Symfony\Component\Routing\Annotation\Route;
    45| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    46| /**
    47|  * @Route("/asset")
    48|  *
    49|  * @internal
    50|  */
    51| class AssetController extends ElementControllerBase implements KernelControllerEventInterface
    52| {
    53|     use AdminStyleTrait;
    54|     use ElementEditLockHelperTrait;
    55|     use ApplySchedulerDataTrait;
    56|     /**
    57|      * @var Asset\Service
    58|      */
    59|     protected $_assetService;
    60|     /**
    61|      * @Route("/tree-get-root", name="pimcore_admin_asset_treegetroot", methods={"GET"})
    62|      *
    63|      * @param Request $request
    64|      *
    65|      * @return JsonResponse
    66|      */
    67|     public function treeGetRootAction(Request $request)
    68|     {
    69|         return parent::treeGetRootAction($request);
    70|     }
    71|     /**
    72|      * @Route("/delete-info", name="pimcore_admin_asset_deleteinfo", methods={"GET"})
    73|      *
    74|      * @param Request $request
    75|      * @param EventDispatcherInterface $eventDispatcher
    76|      *
    77|      * @return JsonResponse
    78|      */
    79|     public function deleteInfoAction(Request $request, EventDispatcherInterface $eventDispatcher)
    80|     {
    81|         return parent::deleteInfoAction($request, $eventDispatcher);
    82|     }
    83|     /**
    84|      * @Route("/get-data-by-id", name="pimcore_admin_asset_getdatabyid", methods={"GET"})
    85|      *
    86|      * @param Request $request
    87|      *
    88|      * @return JsonResponse
    89|      */
    90|     public function getDataByIdAction(Request $request, EventDispatcherInterface $eventDispatcher)
    91|     {
    92|         $asset = Asset::getById((int)$request->get('id'));
    93|         if (!$asset instanceof Asset) {
    94|             return $this->adminJson(['success' => false, 'message' => "asset doesn't exist"]);
    95|         }
    96|         if ($asset->isAllowed('publish') || $asset->isAllowed('delete')) {
    97|             if (Element\Editlock::isLocked($request->get('id'), 'asset')) {
    98|                 return $this->getEditLockResponse($request->get('id'), 'asset');
    99|             }
   100|             Element\Editlock::lock($request->get('id'), 'asset');
   101|         }
   102|         $asset = clone $asset;
   103|         $asset->getScheduledTasks();
   104|         $asset->setLocked($asset->isLocked());
   105|         $asset->setParent(null);
   106|         $asset->setStream(null);
   107|         $data = $asset->getObjectVars();
   108|         if ($asset instanceof Asset\Text) {
   109|             if ($asset->getFileSize() < 2000000) {
   110|                 $data['data'] = \ForceUTF8\Encoding::toUTF8($asset->getData());
   111|             } else {
   112|                 $data['data'] = false;
   113|             }
   114|         } elseif ($asset instanceof Asset\Document) {
   115|             $data['pdfPreviewAvailable'] = (bool)$this->getDocumentPreviewPdf($asset);
   116|         } elseif ($asset instanceof Asset\Video) {
   117|             $videoInfo = [];
   118|             if (\Pimcore\Video::isAvailable()) {
   119|                 $config = Asset\Video\Thumbnail\Config::getPreviewConfig();
   120|                 $thumbnail = $asset->getThumbnail($config, ['mp4']);
   121|                 if ($thumbnail) {
   122|                     if ($thumbnail['status'] == 'finished') {
   123|                         $videoInfo['previewUrl'] = $thumbnail['formats']['mp4'];
   124|                         $videoInfo['width'] = $asset->getWidth();
   125|                         $videoInfo['height'] = $asset->getHeight();
   126|                         $metaData = $asset->getSphericalMetaData();
   127|                         if (isset($metaData['ProjectionType']) && strtolower($metaData['ProjectionType']) == 'equirectangular') {
   128|                             $videoInfo['isVrVideo'] = true;
   129|                         }
   130|                     }
   131|                 }
   132|             }
   133|             $data['videoInfo'] = $videoInfo;
   134|         } elseif ($asset instanceof Asset\Image) {
   135|             $imageInfo = [];
   136|             $previewUrl = $this->generateUrl('pimcore_admin_asset_getimagethumbnail', [
   137|                 'id' => $asset->getId(),
   138|                 'treepreview' => true,
   139|                 'hdpi' => true,
   140|                 '_dc' => time(),
   141|             ]);
   142|             if ($asset->isAnimated()) {
   143|                 $previewUrl = $this->generateUrl('pimcore_admin_asset_getasset', [
   144|                     'id' => $asset->getId(),
   145|                     '_dc' => time(),
   146|                 ]);
   147|             }
   148|             $imageInfo['previewUrl'] = $previewUrl;
   149|             if ($asset->getWidth() && $asset->getHeight()) {
   150|                 $imageInfo['dimensions'] = [];
   151|                 $imageInfo['dimensions']['width'] = $asset->getWidth();
   152|                 $imageInfo['dimensions']['height'] = $asset->getHeight();
   153|             }
   154|             $imageInfo['exiftoolAvailable'] = (bool)\Pimcore\Tool\Console::getExecutable('exiftool');
   155|             if (!$asset->getEmbeddedMetaData(false)) {
   156|                 $asset->getEmbeddedMetaData(true, false); // read Exif, IPTC and XPM like in the old days ...
   157|             }
   158|             $data['imageInfo'] = $imageInfo;
   159|         }
   160|         $data['properties'] = Element\Service::minimizePropertiesForEditmode($asset->getProperties());
   161|         $data['metadata'] = Asset\Service::expandMetadataForEditmode($asset->getMetadata());
   162|         $data['versionDate'] = $asset->getModificationDate();
   163|         $data['filesizeFormatted'] = $asset->getFileSize(true);
   164|         $data['filesize'] = $asset->getFileSize();
   165|         $data['fileExtension'] = File::getFileExtension($asset->getFilename());
   166|         $data['idPath'] = Element\Service::getIdPath($asset);
   167|         $data['userPermissions'] = $asset->getUserPermissions();
   168|         $frontendPath = $asset->getFrontendFullPath();
   169|         $data['url'] = preg_match('/^http(s)?:\\/\\/.+/', $frontendPath) ?
   170|             $frontendPath :
   171|             $request->getSchemeAndHttpHost() . $frontendPath;
   172|         $this->addAdminStyle($asset, ElementAdminStyleEvent::CONTEXT_EDITOR, $data);
   173|         $data['php'] = [
   174|             'classes' => array_merge([get_class($asset)], array_values(class_parents($asset))),
   175|             'interfaces' => array_values(class_implements($asset)),
   176|         ];
   177|         $event = new GenericEvent($this, [
   178|             'data' => $data,
   179|             'asset' => $asset,
   180|         ]);
   181|         $eventDispatcher->dispatch($event, AdminEvents::ASSET_GET_PRE_SEND_DATA);
   182|         $data = $event->getArgument('data');
   183|         if ($asset->isAllowed('view')) {
   184|             return $this->adminJson($data);
   185|         }
   186|         throw $this->createAccessDeniedHttpException();
   187|     }
   188|     /**
   189|      * @Route("/tree-get-childs-by-id", name="pimcore_admin_asset_treegetchildsbyid", methods={"GET"})
   190|      *
   191|      * @param Request $request
   192|      *
   193|      * @return JsonResponse
   194|      */
   195|     public function treeGetChildsByIdAction(Request $request, EventDispatcherInterface $eventDispatcher)
   196|     {
   197|         $allParams = array_merge($request->request->all(), $request->query->all());
   198|         $assets = [];
   199|         $cv = false;
   200|         $asset = Asset::getById($allParams['node']);
   201|         $filter = $request->get('filter');
   202|         $limit = (int)$allParams['limit'];
   203|         if (!is_null($filter)) {
   204|             if (substr($filter, -1) != '*') {
   205|                 $filter .= '*';
   206|             }
   207|             $filter = str_replace('*', '%', $filter);
   208|             $limit = 100;
   209|             $offset = 0;
   210|         } elseif (!$allParams['limit']) {
   211|             $limit = 100000000;
   212|         }
   213|         $offset = isset($allParams['start']) ? (int)$allParams['start'] : 0;
   214|         $filteredTotalCount = 0;
   215|         if ($asset->hasChildren()) {
   216|             if ($allParams['view']) {
   217|                 $cv = \Pimcore\Model\Element\Service::getCustomViewById($allParams['view']);
   218|             }
   219|             $childsList = new Asset\Listing();
   220|             $childsList->addConditionParam('parentId = ?', [$asset->getId()]);
   221|             $childsList->filterAccessibleByUser($this->getAdminUser());
   222|             if (!is_null($filter)) {
   223|                 $childsList->addConditionParam('CAST(assets.filename AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci LIKE ?', [$filter]);
   224|             }
   225|             $childsList->setLimit($limit);
   226|             $childsList->setOffset($offset);
   227|             $childsList->setOrderKey("FIELD(assets.type, 'folder') DESC, CAST(assets.filename AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci ASC", false);
   228|             \Pimcore\Model\Element\Service::addTreeFilterJoins($cv, $childsList);
   229|             $beforeListLoadEvent = new GenericEvent($this, [
   230|                 'list' => $childsList,
   231|                 'context' => $allParams,
   232|             ]);
   233|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::ASSET_LIST_BEFORE_LIST_LOAD);
   234|             /** @var Asset\Listing $childsList */
   235|             $childsList = $beforeListLoadEvent->getArgument('list');
   236|             $childs = $childsList->load();
   237|             $filteredTotalCount = $childsList->getTotalCount();
   238|             foreach ($childs as $childAsset) {
   239|                 if ($childAsset->isAllowed('list')) {
   240|                     $assets[] = $this->getTreeNodeConfig($childAsset);
   241|                 }
   242|             }
   243|         }
   244|         $event = new GenericEvent($this, [
   245|             'assets' => $assets,
   246|         ]);
   247|         $eventDispatcher->dispatch($event, AdminEvents::ASSET_TREE_GET_CHILDREN_BY_ID_PRE_SEND_DATA);
   248|         $assets = $event->getArgument('assets');
   249|         if ($allParams['limit']) {
   250|             return $this->adminJson([
   251|                 'offset' => $offset,
   252|                 'limit' => $limit,
   253|                 'total' => $asset->getChildAmount($this->getAdminUser()),
   254|                 'overflow' => !is_null($filter) && ($filteredTotalCount > $limit),
   255|                 'nodes' => $assets,
   256|                 'filter' => $request->get('filter') ? $request->get('filter') : '',
   257|                 'inSearch' => (int)$request->get('inSearch'),
   258|             ]);
   259|         } else {
   260|             return $this->adminJson($assets);
   261|         }
   262|     }
   263|     /**
   264|      * @Route("/add-asset", name="pimcore_admin_asset_addasset", methods={"POST"})
   265|      *
   266|      * @param Request $request
   267|      * @param Config $config
   268|      *
   269|      * @return JsonResponse
   270|      */
   271|     public function addAssetAction(Request $request, Config $config)
   272|     {
   273|         try {
   274|             $res = $this->addAsset($request, $config);
   275|             $response = [
   276|                 'success' => $res['success'],
   277|             ];
   278|             if ($res['success']) {
   279|                 $response['asset'] = [
   280|                     'id' => $res['asset']->getId(),
   281|                     'path' => $res['asset']->getFullPath(),
   282|                     'type' => $res['asset']->getType(),
   283|                 ];
   284|             }
   285|             return $this->adminJson($response);
   286|         } catch (\Exception $e) {
   287|             return $this->adminJson([
   288|                 'success' => false,
   289|                 'message' => $e->getMessage(),
   290|             ]);
   291|         }
   292|     }
   293|     /**
   294|      * @Route("/add-asset-compatibility", name="pimcore_admin_asset_addassetcompatibility", methods={"POST"})
   295|      *
   296|      * @param Request $request
   297|      * @param Config $config
   298|      *
   299|      * @return JsonResponse
   300|      */
   301|     public function addAssetCompatibilityAction(Request $request, Config $config)
   302|     {
   303|         try {
   304|             $res = $this->addAsset($request, $config);
   305|             $response = $this->adminJson([
   306|                 'success' => $res['success'],
   307|                 'msg' => $res['success'] ? 'Success' : 'Error',
   308|                 'id' => $res['asset'] ? $res['asset']->getId() : null,
   309|                 'fullpath' => $res['asset'] ? $res['asset']->getRealFullPath() : null,
   310|                 'type' => $res['asset'] ? $res['asset']->getType() : null,
   311|             ]);
   312|             $response->headers->set('Content-Type', 'text/html');
   313|             return $response;
   314|         } catch (\Exception $e) {
   315|             return $this->adminJson([
   316|                 'success' => false,
   317|                 'message' => $e->getMessage(),
   318|             ]);
   319|         }
   320|     }
   321|     /**
   322|      * @param Request $request
   323|      * @param Config $config
   324|      *
   325|      * @return array
   326|      *
   327|      * @throws \Exception
   328|      */
   329|     protected function addAsset(Request $request, Config $config)
   330|     {
   331|         $defaultUploadPath = $config['assets']['default_upload_path'] ?? '/';
   332|         if (array_key_exists('Filedata', $_FILES)) {
   333|             $filename = $_FILES['Filedata']['name'];
   334|             $sourcePath = $_FILES['Filedata']['tmp_name'];
   335|         } elseif ($request->get('type') == 'base64') {
   336|             $filename = $request->get('filename');
   337|             $sourcePath = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/upload-base64' . uniqid() . '.tmp';
   338|             $data = preg_replace('@^data:[^,]+;base64,@', '', $request->get('data'));
   339|             File::put($sourcePath, base64_decode($data));
   340|         } else {
   341|             throw new \Exception('The filename of the asset is empty');
   342|         }
   343|         $parentId = $request->get('parentId');
   344|         $parentPath = $request->get('parentPath');
   345|         if ($request->get('dir') && $request->get('parentId')) {
   346|             $parent = Asset::getById($request->get('parentId'));
   347|             $dir = $request->get('dir');
   348|             if (strpos($dir, '..') !== false) {
   349|                 throw new \Exception('not allowed');
   350|             }
   351|             $newPath = $parent->getRealFullPath() . '/' . trim($dir, '/ ');
   352|             $maxRetries = 5;
   353|             $newParent = null;
   354|             for ($retries = 0; $retries < $maxRetries; $retries++) {
   355|                 try {
   356|                     $newParent = Asset\Service::createFolderByPath($newPath);
   357|                     break;
   358|                 } catch (\Exception $e) {
   359|                     if ($retries < ($maxRetries - 1)) {
   360|                         $waitTime = rand(100000, 900000); // microseconds
   361|                         usleep($waitTime); // wait specified time until we restart the transaction
   362|                     } else {
   363|                         throw $e;
   364|                     }
   365|                 }
   366|             }
   367|             if ($newParent) {
   368|                 $parentId = $newParent->getId();
   369|             }
   370|         } elseif (!$request->get('parentId') && $parentPath) {
   371|             $parent = Asset::getByPath($parentPath);
   372|             if ($parent instanceof Asset\Folder) {
   373|                 $parentId = $parent->getId();
   374|             }
   375|         }
   376|         $filename = Element\Service::getValidKey($filename, 'asset');
   377|         if (empty($filename)) {
   378|             throw new \Exception('The filename of the asset is empty');
   379|         }
   380|         $context = $request->get('context');
   381|         if ($context) {
   382|             $context = json_decode($context, true);
   383|             $context = $context ? $context : [];
   384|             $event = new \Pimcore\Event\Model\Asset\ResolveUploadTargetEvent($parentId, $filename, $context);
   385|             \Pimcore::getEventDispatcher()->dispatch($event, AssetEvents::RESOLVE_UPLOAD_TARGET);
   386|             $filename = Element\Service::getValidKey($event->getFilename(), 'asset');
   387|             $parentId = $event->getParentId();
   388|         }
   389|         if (!$parentId) {
   390|             $parentId = Asset\Service::createFolderByPath($defaultUploadPath)->getId();
   391|         }
   392|         $parentAsset = Asset::getById((int)$parentId);
   393|         $filename = $this->getSafeFilename($parentAsset->getRealFullPath(), $filename);
   394|         $asset = null;
   395|         if (!$parentAsset->isAllowed('create')) {
   396|             throw $this->createAccessDeniedHttpException(
   397|                 'Missing the permission to create new assets in the folder: ' . $parentAsset->getRealFullPath()
   398|             );
   399|         }
   400|         if (is_file($sourcePath) && filesize($sourcePath) < 1) {
   401|             throw new \Exception('File is empty!');
   402|         } elseif (!is_file($sourcePath)) {
   403|             throw new \Exception('Something went wrong, please check upload_max_filesize and post_max_size in your php.ini as well as the write permissions of your temporary directories.');
   404|         }
   405|         $asset = Asset::create($parentId, [
   406|             'filename' => $filename,
   407|             'sourcePath' => $sourcePath,
   408|             'userOwner' => $this->getAdminUser()->getId(),
   409|             'userModification' => $this->getAdminUser()->getId(),
   410|         ]);
   411|         @unlink($sourcePath);
   412|         return [
   413|             'success' => true,
   414|             'asset' => $asset,
   415|         ];
   416|     }
   417|     /**
   418|      * @param string $targetPath
   419|      * @param string $filename
   420|      *
   421|      * @return string
   422|      */
   423|     protected function getSafeFilename($targetPath, $filename)
   424|     {
   425|         $pathinfo = pathinfo($filename);
   426|         $originalFilename = $pathinfo['filename'];
   427|         $originalFileextension = empty($pathinfo['extension']) ? '' : '.' . $pathinfo['extension'];
   428|         $count = 1;
   429|         if ($targetPath == '/') {
   430|             $targetPath = '';
   431|         }
   432|         while (true) {
   433|             if (Asset\Service::pathExists($targetPath . '/' . $filename)) {
   434|                 $filename = $originalFilename . '_' . $count . $originalFileextension;
   435|                 $count++;
   436|             } else {
   437|                 return $filename;
   438|             }
   439|         }
   440|     }
   441|     /**
   442|      * @Route("/replace-asset", name="pimcore_admin_asset_replaceasset", methods={"POST", "PUT"})
   443|      *
   444|      * @param Request $request
   445|      *
   446|      * @return JsonResponse
   447|      *
   448|      * @throws \Exception
   449|      */
   450|     public function replaceAssetAction(Request $request)
   451|     {
   452|         $asset = Asset::getById($request->get('id'));
   453|         $newFilename = Element\Service::getValidKey($_FILES['Filedata']['name'], 'asset');
   454|         $mimetype = MimeTypes::getDefault()->guessMimeType($_FILES['Filedata']['tmp_name']);
   455|         $newType = Asset::getTypeFromMimeMapping($mimetype, $newFilename);
   456|         if ($newType != $asset->getType()) {
   457|             return $this->adminJson([
   458|                 'success' => false,
   459|                 'message' => sprintf($this->trans('asset_type_change_not_allowed', [], 'admin'), $asset->getType(), $newType),
   460|             ]);
   461|         }
   462|         $stream = fopen($_FILES['Filedata']['tmp_name'], 'r+');
   463|         $asset->setStream($stream);
   464|         $asset->setCustomSetting('thumbnails', null);
   465|         $asset->setUserModification($this->getAdminUser()->getId());
   466|         $newFileExt = File::getFileExtension($newFilename);
   467|         $currentFileExt = File::getFileExtension($asset->getFilename());
   468|         if ($newFileExt != $currentFileExt) {
   469|             $newFilename = preg_replace('/\.' . $currentFileExt . '$/i', '.' . $newFileExt, $asset->getFilename());
   470|             $newFilename = Element\Service::getSafeCopyName($newFilename, $asset->getParent());
   471|             $asset->setFilename($newFilename);
   472|         }
   473|         if ($asset->isAllowed('publish')) {
   474|             $asset->save();
   475|             $response = $this->adminJson([
   476|                 'id' => $asset->getId(),
   477|                 'path' => $asset->getRealFullPath(),
   478|                 'success' => true,
   479|             ]);
   480|             $response->headers->set('Content-Type', 'text/html');
   481|             return $response;
   482|         } else {
   483|             throw new \Exception('missing permission');
   484|         }
   485|     }
   486|     /**
   487|      * @Route("/add-folder", name="pimcore_admin_asset_addfolder", methods={"POST"})
   488|      *
   489|      * @param Request $request
   490|      *
   491|      * @return JsonResponse
   492|      */
   493|     public function addFolderAction(Request $request)
   494|     {
   495|         $success = false;
   496|         $parentAsset = Asset::getById((int)$request->get('parentId'));
   497|         $equalAsset = Asset::getByPath($parentAsset->getRealFullPath() . '/' . $request->get('name'));
   498|         if ($parentAsset->isAllowed('create')) {
   499|             if (!$equalAsset) {
   500|                 $asset = Asset::create($request->get('parentId'), [
   501|                     'filename' => $request->get('name'),
   502|                     'type' => 'folder',
   503|                     'userOwner' => $this->getAdminUser()->getId(),
   504|                     'userModification' => $this->getAdminUser()->getId(),
   505|                 ]);
   506|                 $success = true;
   507|             }
   508|         } else {
   509|             Logger::debug('prevented creating asset because of missing permissions');
   510|         }
   511|         return $this->adminJson(['success' => $success]);
   512|     }
   513|     /**
   514|      * @Route("/delete", name="pimcore_admin_asset_delete", methods={"DELETE"})
   515|      *
   516|      * @param Request $request
   517|      *
   518|      * @return JsonResponse
   519|      */
   520|     public function deleteAction(Request $request)
   521|     {
   522|         if ($request->get('type') == 'childs') {
   523|             $parentAsset = Asset::getById($request->get('id'));
   524|             $list = new Asset\Listing();
   525|             $list->setCondition('path LIKE ?', [$list->escapeLike($parentAsset->getRealFullPath()) . '/%']);
   526|             $list->setLimit((int)$request->get('amount'));
   527|             $list->setOrderKey('LENGTH(path)', false);
   528|             $list->setOrder('DESC');
   529|             $deletedItems = [];
   530|             foreach ($list as $asset) {
   531|                 $deletedItems[$asset->getId()] = $asset->getRealFullPath();
   532|                 if ($asset->isAllowed('delete') && !$asset->isLocked()) {
   533|                     $asset->delete();
   534|                 }
   535|             }
   536|             return $this->adminJson(['success' => true, 'deleted' => $deletedItems]);
   537|         } elseif ($request->get('id')) {
   538|             $asset = Asset::getById($request->get('id'));
   539|             if ($asset && $asset->isAllowed('delete')) {
   540|                 if ($asset->isLocked()) {
   541|                     return $this->adminJson([
   542|                         'success' => false,
   543|                         'message' => 'prevented deleting asset, because it is locked: ID: ' . $asset->getId(),
   544|                     ]);
   545|                 } else {
   546|                     $asset->delete();
   547|                     return $this->adminJson(['success' => true]);
   548|                 }
   549|             }
   550|         }
   551|         throw $this->createAccessDeniedHttpException();
   552|     }
   553|     /**
   554|      * @param Asset $element
   555|      *
   556|      * @return array
   557|      */
   558|     protected function getTreeNodeConfig($element)
   559|     {
   560|         $asset = $element;
   561|         $tmpAsset = [
   562|             'id' => $asset->getId(),
   563|             'text' => htmlspecialchars($asset->getFilename()),
   564|             'type' => $asset->getType(),
   565|             'path' => $asset->getRealFullPath(),
   566|             'basePath' => $asset->getRealPath(),
   567|             'locked' => $asset->isLocked(),
   568|             'lockOwner' => $asset->getLocked() ? true : false,
   569|             'elementType' => 'asset',
   570|             'permissions' => [
   571|                 'remove' => $asset->isAllowed('delete'),
   572|                 'settings' => $asset->isAllowed('settings'),
   573|                 'rename' => $asset->isAllowed('rename'),
   574|                 'publish' => $asset->isAllowed('publish'),
   575|                 'view' => $asset->isAllowed('view'),
   576|             ],
   577|         ];
   578|         if ($asset instanceof Asset\Folder) {
   579|             $tmpAsset['leaf'] = false;
   580|             $tmpAsset['expanded'] = !$asset->hasChildren();
   581|             $tmpAsset['loaded'] = !$asset->hasChildren();
   582|             $tmpAsset['permissions']['create'] = $asset->isAllowed('create');
   583|             $tmpAsset['thumbnail'] = $this->getThumbnailUrl($asset);
   584|         } else {
   585|             $tmpAsset['leaf'] = true;
   586|             $tmpAsset['expandable'] = false;
   587|             $tmpAsset['expanded'] = false;
   588|         }
   589|         $this->addAdminStyle($asset, ElementAdminStyleEvent::CONTEXT_TREE, $tmpAsset);
   590|         if ($asset->getType() == 'image') {
   591|             try {
   592|                 $tmpAsset['thumbnail'] = $this->getThumbnailUrl($asset);
   593|                 $tmpAsset['thumbnailHdpi'] = $this->getThumbnailUrl($asset, true);
   594|                 if ($asset->getCustomSetting('imageWidth') && $asset->getCustomSetting('imageHeight')) {
   595|                     $tmpAsset['imageWidth'] = $asset->getCustomSetting('imageWidth');
   596|                     $tmpAsset['imageHeight'] = $asset->getCustomSetting('imageHeight');
   597|                 }
   598|             } catch (\Exception $e) {
   599|                 Logger::debug('Cannot get dimensions of image, seems to be broken.');
   600|             }
   601|         } elseif ($asset->getType() == 'video') {
   602|             try {
   603|                 if (\Pimcore\Video::isAvailable()) {
   604|                     $tmpAsset['thumbnail'] = $this->getThumbnailUrl($asset);
   605|                     $tmpAsset['thumbnailHdpi'] = $this->getThumbnailUrl($asset, true);
   606|                 }
   607|             } catch (\Exception $e) {
   608|                 Logger::debug('Cannot get dimensions of video, seems to be broken.');
   609|             }
   610|         } elseif ($asset->getType() == 'document') {
   611|             try {
   612|                 if (\Pimcore\Document::isAvailable() && \Pimcore\Document::isFileTypeSupported($asset->getFilename())) {
   613|                     $tmpAsset['thumbnail'] = $this->getThumbnailUrl($asset);
   614|                     $tmpAsset['thumbnailHdpi'] = $this->getThumbnailUrl($asset, true);
   615|                 }
   616|             } catch (\Exception $e) {
   617|                 Logger::debug('Cannot get dimensions of video, seems to be broken.');
   618|             }
   619|         }
   620|         $tmpAsset['cls'] = '';
   621|         if ($asset->isLocked()) {
   622|             $tmpAsset['cls'] .= 'pimcore_treenode_locked ';
   623|         }
   624|         if ($asset->getLocked()) {
   625|             $tmpAsset['cls'] .= 'pimcore_treenode_lockOwner ';
   626|         }
   627|         return $tmpAsset;
   628|     }
   629|     /**
   630|      * @param Asset $asset
   631|      * @param bool $hdpi
   632|      * @param bool $grid
   633|      *
   634|      * @return null|string
   635|      */
   636|     protected function getThumbnailUrl(Asset $asset, $hdpi = false, $grid = false)
   637|     {
   638|         $params = [
   639|             'id' => $asset->getId(),
   640|             'treepreview' => true,
   641|         ];
   642|         if ($hdpi) {
   643|             $params['hdpi'] = true;
   644|         }
   645|         if ($grid) {
   646|             $params['grid'] = true;
   647|         }
   648|         if ($asset instanceof Asset\Image) {
   649|             return $this->generateUrl('pimcore_admin_asset_getimagethumbnail', $params);
   650|         }
   651|         if ($asset instanceof Asset\Folder) {
   652|             return $this->generateUrl('pimcore_admin_asset_getfolderthumbnail', $params);
   653|         }
   654|         if ($asset instanceof Asset\Video && \Pimcore\Video::isAvailable()) {
   655|             return $this->generateUrl('pimcore_admin_asset_getvideothumbnail', $params);
   656|         }
   657|         if ($asset instanceof Asset\Document && \Pimcore\Document::isAvailable() && $asset->getPageCount()) {
   658|             return $this->generateUrl('pimcore_admin_asset_getdocumentthumbnail', $params);
   659|         }
   660|         return null;
   661|     }
   662|     /**
   663|      * @Route("/update", name="pimcore_admin_asset_update", methods={"PUT"})
   664|      *
   665|      * @param Request $request
   666|      *
   667|      * @return JsonResponse
   668|      *
   669|      * @throws \Exception
   670|      */
   671|     public function updateAction(Request $request)
   672|     {
   673|         $success = false;
   674|         $allowUpdate = true;
   675|         $updateData = array_merge($request->request->all(), $request->query->all());
   676|         $asset = Asset::getById($request->get('id'));
   677|         if ($asset->isAllowed('settings')) {
   678|             $asset->setUserModification($this->getAdminUser()->getId());
   679|             if ($request->get('parentId')) {
   680|                 $parentAsset = Asset::getById($request->get('parentId'));
   681|                 if ($asset->getParentId() != $parentAsset->getId()) {
   682|                     if (!$parentAsset->isAllowed('create')) {
   683|                         throw new \Exception('Prevented moving asset - no create permission on new parent ');
   684|                     }
   685|                     $intendedPath = $parentAsset->getRealPath();
   686|                     $pKey = $parentAsset->getKey();
   687|                     if (!empty($pKey)) {
   688|                         $intendedPath .= $parentAsset->getKey() . '/';
   689|                     }
   690|                     $assetWithSamePath = Asset::getByPath($intendedPath . $asset->getKey());
   691|                     if ($assetWithSamePath != null) {
   692|                         $allowUpdate = false;
   693|                     }
   694|                     if ($asset->isLocked()) {
   695|                         $allowUpdate = false;
   696|                     }
   697|                 }
   698|             }
   699|             if ($allowUpdate) {
   700|                 if ($request->get('filename') != $asset->getFilename() and !$asset->isAllowed('rename')) {
   701|                     unset($updateData['filename']);
   702|                     Logger::debug('prevented renaming asset because of missing permissions ');
   703|                 }
   704|                 $asset->setValues($updateData);
   705|                 try {
   706|                     $asset->save();
   707|                     $success = true;
   708|                 } catch (\Exception $e) {
   709|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   710|                 }
   711|             } else {
   712|                 $msg = 'prevented moving asset, asset with same path+key already exists at target location or the asset is locked. ID: ' . $asset->getId();
   713|                 Logger::debug($msg);
   714|                 return $this->adminJson(['success' => $success, 'message' => $msg]);
   715|             }
   716|         } elseif ($asset->isAllowed('rename') && $request->get('filename')) {
   717|             try {
   718|                 $asset->setFilename($request->get('filename'));
   719|                 $asset->save();
   720|                 $success = true;
   721|             } catch (\Exception $e) {
   722|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   723|             }
   724|         } else {
   725|             Logger::debug('prevented update asset because of missing permissions ');
   726|         }
   727|         return $this->adminJson(['success' => $success]);
   728|     }
   729|     /**
   730|      * @Route("/webdav{path}", name="pimcore_admin_webdav", requirements={"path"=".*"})
   731|      *
   732|      * @param Request $request
   733|      */
   734|     public function webdavAction(Request $request)
   735|     {
   736|         $homeDir = Asset::getById(1);
   737|         try {
   738|             $publicDir = new Asset\WebDAV\Folder($homeDir);
   739|             $objectTree = new Asset\WebDAV\Tree($publicDir);
   740|             $server = new \Sabre\DAV\Server($objectTree);
   741|             $server->setBaseUri($this->generateUrl('pimcore_admin_webdav', ['path' => '/']));
   742|             $lockBackend = new \Sabre\DAV\Locks\Backend\PDO(\Pimcore\Db::get()->getWrappedConnection());
   743|             $lockBackend->tableName = 'webdav_locks';
   744|             $lockPlugin = new \Sabre\DAV\Locks\Plugin($lockBackend);
   745|             $server->addPlugin($lockPlugin);
   746|             $server->addPlugin(new \Sabre\DAV\Browser\Plugin());
   747|             $server->exec();
   748|         } catch (\Exception $e) {
   749|             Logger::error($e);
   750|         }
   751|         exit;
   752|     }
   753|     /**
   754|      * @Route("/save", name="pimcore_admin_asset_save", methods={"PUT","POST"})
   755|      *
   756|      * @param Request $request
   757|      * @param EventDispatcherInterface $eventDispatcher
   758|      *
   759|      * @return JsonResponse
   760|      *
   761|      * @throws \Exception
   762|      */
   763|     public function saveAction(Request $request, EventDispatcherInterface $eventDispatcher)
   764|     {
   765|         $asset = Asset::getById($request->get('id'));
   766|         if (!$asset) {
   767|             throw $this->createNotFoundException('Asset not found');
   768|         }
   769|         if ($asset->isAllowed('publish')) {
   770|             if ($request->get('metadata')) {
   771|                 $metadata = $this->decodeJson($request->get('metadata'));
   772|                 $metadataEvent = new GenericEvent($this, [
   773|                     'id' => $asset->getId(),
   774|                     'metadata' => $metadata,
   775|                 ]);
   776|                 $eventDispatcher->dispatch($metadataEvent, AdminEvents::ASSET_METADATA_PRE_SET);
   777|                 $metadata = $metadataEvent->getArgument('metadata');
   778|                 $metadataValues = $metadata['values'];
   779|                 $metadataValues = Asset\Service::minimizeMetadata($metadataValues, 'editor');
   780|                 $asset->setMetadataRaw($metadataValues);
   781|             }
   782|             if ($request->get('properties')) {
   783|                 $properties = [];
   784|                 $propertiesData = $this->decodeJson($request->get('properties'));
   785|                 if (is_array($propertiesData)) {
   786|                     foreach ($propertiesData as $propertyName => $propertyData) {
   787|                         $value = $propertyData['data'];
   788|                         try {
   789|                             $property = new Model\Property();
   790|                             $property->setType($propertyData['type']);
   791|                             $property->setName($propertyName);
   792|                             $property->setCtype('asset');
   793|                             $property->setDataFromEditmode($value);
   794|                             $property->setInheritable($propertyData['inheritable']);
   795|                             $properties[$propertyName] = $property;
   796|                         } catch (\Exception $e) {
   797|                             Logger::err("Can't add " . $propertyName . ' to asset ' . $asset->getRealFullPath());
   798|                         }
   799|                     }
   800|                     $asset->setProperties($properties);
   801|                 }
   802|             }
   803|             $this->applySchedulerDataToElement($request, $asset);
   804|             if ($request->get('data')) {
   805|                 $asset->setData($request->get('data'));
   806|             }
   807|             if ($asset instanceof Asset\Image) {
   808|                 if ($request->get('image')) {
   809|                     $imageData = $this->decodeJson($request->get('image'));
   810|                     if (isset($imageData['focalPoint'])) {
   811|                         $asset->setCustomSetting('focalPointX', $imageData['focalPoint']['x']);
   812|                         $asset->setCustomSetting('focalPointY', $imageData['focalPoint']['y']);
   813|                         $asset->removeCustomSetting('disableFocalPointDetection');
   814|                     }
   815|                 } else {
   816|                     $asset->removeCustomSetting('focalPointX');
   817|                     $asset->removeCustomSetting('focalPointY');
   818|                     $asset->setCustomSetting('disableFocalPointDetection', true);
   819|                 }
   820|             }
   821|             $asset->setUserModification($this->getAdminUser()->getId());
   822|             if ($request->get('task') === 'session') {
   823|                 Asset\Service::saveElementToSession($asset);
   824|             } else {
   825|                 $asset->save();
   826|             }
   827|             $treeData = $this->getTreeNodeConfig($asset);
   828|             return $this->adminJson([
   829|                 'success' => true,
   830|                 'data' => [
   831|                     'versionDate' => $asset->getModificationDate(),
   832|                     'versionCount' => $asset->getVersionCount(),
   833|                 ],
   834|                 'treeData' => $treeData,
   835|             ]);
   836|         } else {
   837|             throw $this->createAccessDeniedHttpException();
   838|         }
   839|     }
   840|     /**
   841|      * @Route("/publish-version", name="pimcore_admin_asset_publishversion", methods={"POST"})
   842|      *
   843|      * @param Request $request
   844|      *
   845|      * @return JsonResponse
   846|      */
   847|     public function publishVersionAction(Request $request)
   848|     {
   849|         $version = Model\Version::getById($request->get('id'));
   850|         $asset = $version->loadData();
   851|         $currentAsset = Asset::getById($asset->getId());
   852|         if ($currentAsset->isAllowed('publish')) {
   853|             try {
   854|                 $asset->setUserModification($this->getAdminUser()->getId());
   855|                 $asset->save();
   856|                 $treeData = $this->getTreeNodeConfig($asset);
   857|                 return $this->adminJson(['success' => true, 'treeData' => $treeData]);
   858|             } catch (\Exception $e) {
   859|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   860|             }
   861|         }
   862|         throw $this->createAccessDeniedHttpException();
   863|     }
   864|     /**
   865|      * @Route("/show-version", name="pimcore_admin_asset_showversion", methods={"GET"})
   866|      *
   867|      * @param Request $request
   868|      *
   869|      * @return Response
   870|      */
   871|     public function showVersionAction(Request $request)
   872|     {
   873|         $id = (int)$request->get('id');
   874|         $version = Model\Version::getById($id);
   875|         if (!$version) {
   876|             throw $this->createNotFoundException('Version not found');
   877|         }
   878|         $asset = $version->loadData();
   879|         if (!$asset->isAllowed('versions')) {
   880|             throw $this->createAccessDeniedHttpException('Permission denied, version id [' . $id . ']');
   881|         }
   882|         $loader = \Pimcore::getContainer()->get('pimcore.implementation_loader.asset.metadata.data');
   883|         return $this->render(
   884|             '@PimcoreAdmin/Admin/Asset/showVersion' . ucfirst($asset->getType()) . '.html.twig',
   885|             [
   886|                 'asset' => $asset,
   887|                 'loader' => $loader,
   888|             ]
   889|         );
   890|     }
   891|     /**
   892|      * @Route("/download", name="pimcore_admin_asset_download", methods={"GET"})
   893|      *
   894|      * @param Request $request
   895|      *
   896|      * @return StreamedResponse
   897|      */
   898|     public function downloadAction(Request $request)
   899|     {
   900|         $asset = Asset::getById($request->get('id'));
   901|         if (!$asset) {
   902|             throw $this->createNotFoundException('Asset not found');
   903|         }
   904|         if (!$asset->isAllowed('view')) {
   905|             throw $this->createAccessDeniedException('not allowed to view asset');
   906|         }
   907|         $stream = $asset->getStream();
   908|         return new StreamedResponse(function () use ($stream) {
   909|             fpassthru($stream);
   910|         }, 200, [
   911|             'Content-Type' => $asset->getMimetype(),
   912|             'Content-Disposition' => sprintf('attachment; filename="%s"', $asset->getFilename()),
   913|             'Content-Length' => $asset->getFileSize(),
   914|         ]);
   915|     }
   916|     /**
   917|      * @Route("/download-image-thumbnail", name="pimcore_admin_asset_downloadimagethumbnail", methods={"GET"})
   918|      *
   919|      * @param Request $request
   920|      *
   921|      * @return BinaryFileResponse
   922|      */
   923|     public function downloadImageThumbnailAction(Request $request)
   924|     {
   925|         $image = Asset\Image::getById($request->get('id'));
   926|         if (!$image) {
   927|             throw $this->createNotFoundException('Asset not found');
   928|         }
   929|         if (!$image->isAllowed('view')) {
   930|             throw $this->createAccessDeniedException('not allowed to view thumbnail');
   931|         }
   932|         $config = null;
   933|         $thumbnail = null;
   934|         $thumbnailName = $request->get('thumbnail');
   935|         $thumbnailFile = null;
   936|         $deleteThumbnail = true;
   937|         if ($request->get('config')) {
   938|             $config = $this->decodeJson($request->get('config'));
   939|         } elseif ($request->get('type')) {
   940|             $predefined = [
   941|                 'web' => [
   942|                     'resize_mode' => 'scaleByWidth',
   943|                     'width' => 3500,
   944|                     'dpi' => 72,
   945|                     'format' => 'JPEG',
   946|                     'quality' => 85,
   947|                 ],
   948|                 'print' => [
   949|                     'resize_mode' => 'scaleByWidth',
   950|                     'width' => 6000,
   951|                     'dpi' => 300,
   952|                     'format' => 'JPEG',
   953|                     'quality' => 95,
   954|                 ],
   955|                 'office' => [
   956|                     'resize_mode' => 'scaleByWidth',
   957|                     'width' => 1190,
   958|                     'dpi' => 144,
   959|                     'format' => 'JPEG',
   960|                     'quality' => 90,
   961|                 ],
   962|             ];
   963|             $config = $predefined[$request->get('type')];
   964|         } elseif ($thumbnailName) {
   965|             $thumbnail = $image->getThumbnail($thumbnailName);
   966|             $deleteThumbnail = false;
   967|         }
   968|         if ($config) {
   969|             $thumbnailConfig = new Asset\Image\Thumbnail\Config();
   970|             $thumbnailConfig->setName('pimcore-download-' . $image->getId() . '-' . md5($request->get('config')));
   971|             if ($config['resize_mode'] == 'scaleByWidth') {
   972|                 $thumbnailConfig->addItem('scaleByWidth', [
   973|                     'width' => $config['width'],
   974|                 ]);
   975|             } elseif ($config['resize_mode'] == 'scaleByHeight') {
   976|                 $thumbnailConfig->addItem('scaleByHeight', [
   977|                     'height' => $config['height'],
   978|                 ]);
   979|             } else {
   980|                 $thumbnailConfig->addItem('resize', [
   981|                     'width' => $config['width'],
   982|                     'height' => $config['height'],
   983|                 ]);
   984|             }
   985|             $thumbnailConfig->setQuality($config['quality']);
   986|             $thumbnailConfig->setFormat($config['format']);
   987|             $thumbnailConfig->setRasterizeSVG(true);
   988|             if ($thumbnailConfig->getFormat() == 'JPEG') {
   989|                 $thumbnailConfig->setPreserveMetaData(true);
   990|                 if (empty($config['quality'])) {
   991|                     $thumbnailConfig->setPreserveColor(true);
   992|                 }
   993|             }
   994|             $thumbnail = $image->getThumbnail($thumbnailConfig);
   995|             $thumbnailFile = $thumbnail->getLocalFile();
   996|             $exiftool = \Pimcore\Tool\Console::getExecutable('exiftool');
   997|             if ($thumbnailConfig->getFormat() == 'JPEG' && $exiftool && isset($config['dpi']) && $config['dpi']) {
   998|                 $process = new Process([$exiftool, '-overwrite_original', '-xresolution=' . (int)$config['dpi'], '-yresolution=' . (int)$config['dpi'], '-resolutionunit=inches', $thumbnailFile]);
   999|                 $process->run();
  1000|             }
  1001|         }
  1002|         if ($thumbnail) {
  1003|             $thumbnailFile = $thumbnailFile ?: $thumbnail->getLocalFile();
  1004|             $downloadFilename = preg_replace(
  1005|                 '/\.' . preg_quote(File::getFileExtension($image->getFilename())) . '$/i',
  1006|                 '.' . $thumbnail->getFileExtension(),
  1007|                 $image->getFilename()
  1008|             );
  1009|             $downloadFilename = strtolower($downloadFilename);
  1010|             clearstatcache();
  1011|             $response = new BinaryFileResponse($thumbnailFile);
  1012|             $response->headers->set('Content-Type', $thumbnail->getMimeType());
  1013|             $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, $downloadFilename);
  1014|             $this->addThumbnailCacheHeaders($response);
  1015|             $response->deleteFileAfterSend($deleteThumbnail);
  1016|             return $response;
  1017|         }
  1018|         throw $this->createNotFoundException('Thumbnail not found');
  1019|     }
  1020|     /**
  1021|      * @Route("/get-asset", name="pimcore_admin_asset_getasset", methods={"GET"})
  1022|      *
  1023|      * @param Request $request
  1024|      *
  1025|      * @return StreamedResponse
  1026|      */
  1027|     public function getAssetAction(Request $request)
  1028|     {
  1029|         $image = Asset::getById((int)$request->get('id'));
  1030|         if (!$image) {
  1031|             throw $this->createNotFoundException('Asset not found');
  1032|         }
  1033|         if (!$image->isAllowed('view')) {
  1034|             throw $this->createAccessDeniedException('not allowed to view asset');
  1035|         }
  1036|         $stream = $image->getStream();
  1037|         $response = new StreamedResponse(function () use ($stream) {
  1038|             fpassthru($stream);
  1039|         }, 200, [
  1040|             'Content-Type' => $image->getMimetype(),
  1041|             'Access-Control-Allow-Origin' => '*',
  1042|         ]);
  1043|         $this->addThumbnailCacheHeaders($response);
  1044|         return $response;
  1045|     }
  1046|     /**
  1047|      * @Route("/get-image-thumbnail", name="pimcore_admin_asset_getimagethumbnail", methods={"GET"})
  1048|      *
  1049|      * @param Request $request
  1050|      *
  1051|      * @return StreamedResponse|JsonResponse
  1052|      */
  1053|     public function getImageThumbnailAction(Request $request)
  1054|     {
  1055|         $fileinfo = $request->get('fileinfo');
  1056|         $image = Asset\Image::getById((int)$request->get('id'));
  1057|         if (!$image) {
  1058|             throw $this->createNotFoundException('Asset not found');
  1059|         }
  1060|         if (!$image->isAllowed('view')) {
  1061|             throw $this->createAccessDeniedException('not allowed to view thumbnail');
  1062|         }
  1063|         $thumbnailConfig = null;
  1064|         if ($request->get('thumbnail')) {
  1065|             $thumbnailConfig = $image->getThumbnailConfig($request->get('thumbnail'));
  1066|         }
  1067|         if (!$thumbnailConfig) {
  1068|             if ($request->get('config')) {
  1069|                 $thumbnailConfig = $image->getThumbnailConfig($this->decodeJson($request->get('config')));
  1070|             } else {
  1071|                 $thumbnailConfig = $image->getThumbnailConfig(array_merge($request->request->all(), $request->query->all()));
  1072|             }
  1073|         } else {
  1074|             $thumbnailConfig->setHighResolution(1);
  1075|         }
  1076|         $format = strtolower($thumbnailConfig->getFormat());
  1077|         if ($format == 'source' || $format == 'print') {
  1078|             $thumbnailConfig->setFormat('PNG');
  1079|             $thumbnailConfig->setRasterizeSVG(true);
  1080|         }
  1081|         if ($request->get('treepreview')) {
  1082|             $thumbnailConfig = Asset\Image\Thumbnail\Config::getPreviewConfig((bool)$request->get('hdpi'));
  1083|         }
  1084|         $cropPercent = $request->get('cropPercent');
  1085|         if ($cropPercent && filter_var($cropPercent, FILTER_VALIDATE_BOOLEAN)) {
  1086|             $thumbnailConfig->addItemAt(0, 'cropPercent', [
  1087|                 'width' => $request->get('cropWidth'),
  1088|                 'height' => $request->get('cropHeight'),
  1089|                 'y' => $request->get('cropTop'),
  1090|                 'x' => $request->get('cropLeft'),
  1091|             ]);
  1092|             $hash = md5(Tool\Serialize::serialize(array_merge($request->request->all(), $request->query->all())));
  1093|             $thumbnailConfig->setName($thumbnailConfig->getName() . '_auto_' . $hash);
  1094|         }
  1095|         $thumbnail = $image->getThumbnail($thumbnailConfig);
  1096|         if ($fileinfo) {
  1097|             return $this->adminJson([
  1098|                 'width' => $thumbnail->getWidth(),
  1099|                 'height' => $thumbnail->getHeight(), ]);
  1100|         }
  1101|         $stream = $thumbnail->getStream();
  1102|         $response = new StreamedResponse(function () use ($stream) {
  1103|             fpassthru($stream);
  1104|         }, 200, [
  1105|             'Content-Type' => $thumbnail->getMimeType(),
  1106|             'Access-Control-Allow-Origin', '*',
  1107|         ]);
  1108|         $this->addThumbnailCacheHeaders($response);
  1109|         return $response;
  1110|     }
  1111|     /**
  1112|      * @Route("/get-folder-thumbnail", name="pimcore_admin_asset_getfolderthumbnail", methods={"GET"})
  1113|      *
  1114|      * @param Request $request
  1115|      *
  1116|      * @return BinaryFileResponse|StreamedResponse
  1117|      */
  1118|     public function getFolderThumbnailAction(Request $request)
  1119|     {
  1120|         $folder = null;
  1121|         if ($request->get('id')) {
  1122|             $folder = Asset\Folder::getById((int)$request->get('id'));
  1123|             if ($folder instanceof  Asset\Folder) {
  1124|                 if (!$folder->isAllowed('view')) {
  1125|                     throw $this->createAccessDeniedException('not allowed to view thumbnail');
  1126|                 }
  1127|                 $stream = $folder->getPreviewImage((bool)$request->get('hdpi'));
  1128|                 if (!$stream) {
  1129|                     $response = new BinaryFileResponse(PIMCORE_PATH . '/bundles/AdminBundle/Resources/public/img/blank.png');
  1130|                 } else {
  1131|                     $response = new StreamedResponse(function () use ($stream) {
  1132|                         fpassthru($stream);
  1133|                     }, 200, [
  1134|                         'Content-Type' => 'image/jpg',
  1135|                     ]);
  1136|                 }
  1137|                 $this->addThumbnailCacheHeaders($response);
  1138|                 return $response;
  1139|             }
  1140|         }
  1141|         throw $this->createNotFoundException('could not load asset folder');
  1142|     }
  1143|     /**
  1144|      * @Route("/get-video-thumbnail", name="pimcore_admin_asset_getvideothumbnail", methods={"GET"})
  1145|      *
  1146|      * @param Request $request
  1147|      *
  1148|      * @return StreamedResponse
  1149|      */
  1150|     public function getVideoThumbnailAction(Request $request)
  1151|     {
  1152|         $video = null;
  1153|         if ($request->get('id')) {
  1154|             $video = Asset\Video::getById((int)$request->get('id'));
  1155|         } elseif ($request->get('path')) {
  1156|             $video = Asset\Video::getByPath($request->get('path'));
  1157|         }
  1158|         if (!$video) {
  1159|             throw $this->createNotFoundException('could not load video asset');
  1160|         }
  1161|         if (!$video->isAllowed('view')) {
  1162|             throw $this->createAccessDeniedException('not allowed to view thumbnail');
  1163|         }
  1164|         $thumbnail = array_merge($request->request->all(), $request->query->all());
  1165|         if ($request->get('treepreview')) {
  1166|             $thumbnail = Asset\Image\Thumbnail\Config::getPreviewConfig((bool)$request->get('hdpi'));
  1167|         }
  1168|         $time = null;
  1169|         if ($request->get('time')) {
  1170|             $time = (int)$request->get('time');
  1171|         }
  1172|         if ($request->get('settime')) {
  1173|             $video->removeCustomSetting('image_thumbnail_asset');
  1174|             $video->setCustomSetting('image_thumbnail_time', $time);
  1175|             $video->save();
  1176|         }
  1177|         $image = null;
  1178|         if ($request->get('image')) {
  1179|             $image = Asset\Image::getById((int)$request->get('image'));
  1180|         }
  1181|         if ($request->get('setimage') && $image) {
  1182|             $video->removeCustomSetting('image_thumbnail_time');
  1183|             $video->setCustomSetting('image_thumbnail_asset', $image->getId());
  1184|             $video->save();
  1185|         }
  1186|         $thumb = $video->getImageThumbnail($thumbnail, $time, $image);
  1187|         $stream = $thumb->getStream();
  1188|         $response = new StreamedResponse(function () use ($stream) {
  1189|             fpassthru($stream);
  1190|         }, 200, [
  1191|             'Content-Type' => 'image/' . $thumb->getFileExtension(),
  1192|         ]);
  1193|         $this->addThumbnailCacheHeaders($response);
  1194|         return $response;
  1195|     }
  1196|     /**
  1197|      * @Route("/get-document-thumbnail", name="pimcore_admin_asset_getdocumentthumbnail", methods={"GET"})
  1198|      *
  1199|      * @param Request $request
  1200|      *
  1201|      * @return StreamedResponse|BinaryFileResponse
  1202|      */
  1203|     public function getDocumentThumbnailAction(Request $request)
  1204|     {
  1205|         $document = Asset\Document::getById((int)$request->get('id'));
  1206|         if (!$document) {
  1207|             throw $this->createNotFoundException('could not load document asset');
  1208|         }
  1209|         if (!$document->isAllowed('view')) {
  1210|             throw $this->createAccessDeniedException('not allowed to view thumbnail');
  1211|         }
  1212|         $thumbnail = Asset\Image\Thumbnail\Config::getByAutoDetect(array_merge($request->request->all(), $request->query->all()));
  1213|         $format = strtolower($thumbnail->getFormat());
  1214|         if ($format == 'source') {
  1215|             $thumbnail->setFormat('jpeg'); // default format for documents is JPEG not PNG (=too big)
  1216|         }
  1217|         if ($request->get('treepreview')) {
  1218|             $thumbnail = Asset\Image\Thumbnail\Config::getPreviewConfig((bool)$request->get('hdpi'));
  1219|         }
  1220|         $page = 1;
  1221|         if (is_numeric($request->get('page'))) {
  1222|             $page = (int)$request->get('page');
  1223|         }
  1224|         $thumb = $document->getImageThumbnail($thumbnail, $page);
  1225|         $stream = $thumb->getStream();
  1226|         if ($stream) {
  1227|             $response = new StreamedResponse(function () use ($stream) {
  1228|                 fpassthru($stream);
  1229|             }, 200, [
  1230|                 'Content-Type' => 'image/' . $thumb->getFileExtension(),
  1231|             ]);
  1232|         } else {
  1233|             $response = new BinaryFileResponse(PIMCORE_PATH . '/bundles/AdminBundle/Resources/public/img/filetype-not-supported.svg');
  1234|         }
  1235|         $this->addThumbnailCacheHeaders($response);
  1236|         return $response;
  1237|     }
  1238|     /**
  1239|      * @param Response $response
  1240|      */
  1241|     protected function addThumbnailCacheHeaders(Response $response)
  1242|     {
  1243|         $lifetime = 300;
  1244|         $date = new \DateTime('now');
  1245|         $date->add(new \DateInterval('PT' . $lifetime . 'S'));
  1246|         $response->setMaxAge($lifetime);
  1247|         $response->setPublic();
  1248|         $response->setExpires($date);
  1249|         $response->headers->set('Pragma', '');
  1250|     }
  1251|     /**
  1252|      * @Route("/get-preview-document", name="pimcore_admin_asset_getpreviewdocument", methods={"GET"})
  1253|      *
  1254|      * @param Request $request
  1255|      *
  1256|      * @return StreamedResponse
  1257|      */
  1258|     public function getPreviewDocumentAction(Request $request)
  1259|     {
  1260|         $asset = Asset\Document::getById($request->get('id'));
  1261|         if (!$asset) {
  1262|             throw $this->createNotFoundException('could not load document asset');
  1263|         }
  1264|         if ($asset->isAllowed('view')) {
  1265|             $stream = $this->getDocumentPreviewPdf($asset);
  1266|             if ($stream) {
  1267|                 return new StreamedResponse(function () use ($stream) {
  1268|                     fpassthru($stream);
  1269|                 }, 200, [
  1270|                     'Content-Type' => 'application/pdf',
  1271|                 ]);
  1272|             } else {
  1273|                 throw $this->createNotFoundException('Unable to get preview for asset ' . $asset->getId());
  1274|             }
  1275|         } else {
  1276|             throw $this->createAccessDeniedException('Access to asset ' . $asset->getId() . ' denied');
  1277|         }
  1278|     }
  1279|     /**
  1280|      * @param Asset\Document $asset
  1281|      *
  1282|      * @return resource|null
  1283|      */
  1284|     protected function getDocumentPreviewPdf(Asset\Document $asset)
  1285|     {
  1286|         $stream = null;
  1287|         if ($asset->getMimetype() == 'application/pdf') {
  1288|             $stream = $asset->getStream();
  1289|         }
  1290|         if (!$stream && $asset->getPageCount() && \Pimcore\Document::isAvailable() && \Pimcore\Document::isFileTypeSupported($asset->getFilename())) {
  1291|             try {
  1292|                 $document = \Pimcore\Document::getInstance();
  1293|                 $stream = $document->getPdf($asset);
  1294|             } catch (\Exception $e) {
  1295|             }
  1296|         }
  1297|         return $stream;
  1298|     }
  1299|     /**
  1300|      * @Route("/get-preview-video", name="pimcore_admin_asset_getpreviewvideo", methods={"GET"})
  1301|      *
  1302|      * @param Request $request
  1303|      *
  1304|      * @return Response
  1305|      */
  1306|     public function getPreviewVideoAction(Request $request)
  1307|     {
  1308|         $asset = Asset\Video::getById($request->get('id'));
  1309|         if (!$asset) {
  1310|             throw $this->createNotFoundException('could not load video asset');
  1311|         }
  1312|         if (!$asset->isAllowed('view')) {
  1313|             throw $this->createAccessDeniedException('not allowed to preview');
  1314|         }
  1315|         $previewData = ['asset' => $asset];
  1316|         $config = Asset\Video\Thumbnail\Config::getPreviewConfig();
  1317|         $thumbnail = $asset->getThumbnail($config, ['mp4']);
  1318|         if ($thumbnail) {
  1319|             $previewData['asset'] = $asset;
  1320|             $previewData['thumbnail'] = $thumbnail;
  1321|             if ($thumbnail['status'] == 'finished') {
  1322|                 return $this->render(
  1323|                     '@PimcoreAdmin/Admin/Asset/getPreviewVideoDisplay.html.twig',
  1324|                     $previewData
  1325|                 );
  1326|             } else {
  1327|                 return $this->render(
  1328|                     '@PimcoreAdmin/Admin/Asset/getPreviewVideoError.html.twig',
  1329|                     $previewData
  1330|                 );
  1331|             }
  1332|         } else {
  1333|             return $this->render(
  1334|                 '@PimcoreAdmin/Admin/Asset/getPreviewVideoError.html.twig',
  1335|                 $previewData
  1336|             );
  1337|         }
  1338|     }
  1339|     /**
  1340|      * @Route("/serve-video-preview", name="pimcore_admin_asset_servevideopreview", methods={"GET"})
  1341|      *
  1342|      * @param Request $request
  1343|      *
  1344|      * @return StreamedResponse
  1345|      */
  1346|     public function serveVideoPreviewAction(Request $request)
  1347|     {
  1348|         $asset = Asset\Video::getById($request->get('id'));
  1349|         if (!$asset) {
  1350|             throw $this->createNotFoundException('could not load video asset');
  1351|         }
  1352|         if (!$asset->isAllowed('view')) {
  1353|             throw $this->createAccessDeniedException('not allowed to preview');
  1354|         }
  1355|         $config = Asset\Video\Thumbnail\Config::getPreviewConfig();
  1356|         $thumbnail = $asset->getThumbnail($config, ['mp4']);
  1357|         $storagePath = $asset->getRealPath() . '/' . preg_replace('@^' . preg_quote($asset->getPath(), '@') . '@', '', urldecode($thumbnail['formats']['mp4']));
  1358|         $storage = Tool\Storage::get('thumbnail');
  1359|         if ($storage->fileExists($storagePath)) {
  1360|             $stream = $storage->readStream($storagePath);
  1361|             return new StreamedResponse(function () use ($stream) {
  1362|                 fpassthru($stream);
  1363|             }, 200, [
  1364|                 'Content-Type' => 'video/mp4',
  1365|             ]);
  1366|         } else {
  1367|             throw $this->createNotFoundException('Video thumbnail not found');
  1368|         }
  1369|     }
  1370|     /**
  1371|      * @Route("/image-editor", name="pimcore_admin_asset_imageeditor", methods={"GET"})
  1372|      *
  1373|      * @param Request $request
  1374|      *
  1375|      * @return Response
  1376|      */
  1377|     public function imageEditorAction(Request $request)
  1378|     {
  1379|         $asset = Asset::getById($request->get('id'));
  1380|         if (!$asset->isAllowed('view')) {
  1381|             throw new \Exception('not allowed to preview');
  1382|         }
  1383|         return $this->render(
  1384|             '@PimcoreAdmin/Admin/Asset/imageEditor.html.twig',
  1385|             ['asset' => $asset]
  1386|         );
  1387|     }
  1388|     /**
  1389|      * @Route("/image-editor-save", name="pimcore_admin_asset_imageeditorsave", methods={"PUT"})
  1390|      *
  1391|      * @param Request $request
  1392|      *
  1393|      * @return JsonResponse
  1394|      */
  1395|     public function imageEditorSaveAction(Request $request)
  1396|     {
  1397|         $asset = Asset::getById($request->get('id'));
  1398|         if (!$asset) {
  1399|             throw $this->createNotFoundException('Asset not found');
  1400|         }
  1401|         if (!$asset->isAllowed('publish')) {
  1402|             throw $this->createAccessDeniedException('not allowed to publish');
  1403|         }
  1404|         $data = $request->get('dataUri');
  1405|         $data = substr($data, strpos($data, ','));
  1406|         $data = base64_decode($data);
  1407|         $asset->setData($data);
  1408|         $asset->setUserModification($this->getAdminUser()->getId());
  1409|         $asset->save();
  1410|         return $this->adminJson(['success' => true]);
  1411|     }
  1412|     /**
  1413|      * @Route("/get-folder-content-preview", name="pimcore_admin_asset_getfoldercontentpreview", methods={"GET"})
  1414|      *
  1415|      * @param Request $request
  1416|      *
  1417|      * @return JsonResponse
  1418|      */
  1419|     public function getFolderContentPreviewAction(Request $request, EventDispatcherInterface $eventDispatcher)
  1420|     {
  1421|         $allParams = array_merge($request->request->all(), $request->query->all());
  1422|         $filterPrepareEvent = new GenericEvent($this, [
  1423|             'requestParams' => $allParams,
  1424|         ]);
  1425|         $eventDispatcher->dispatch($filterPrepareEvent, AdminEvents::ASSET_LIST_BEFORE_FILTER_PREPARE);
  1426|         $allParams = $filterPrepareEvent->getArgument('requestParams');
  1427|         $folder = Asset::getById($allParams['id']);
  1428|         $start = 0;
  1429|         $limit = 10;
  1430|         if ($allParams['limit']) {
  1431|             $limit = $allParams['limit'];
  1432|         }
  1433|         if ($allParams['start']) {
  1434|             $start = $allParams['start'];
  1435|         }
  1436|         $conditionFilters = [];
  1437|         $list = new Asset\Listing();
  1438|         $conditionFilters[] = 'path LIKE ' . ($folder->getRealFullPath() == '/' ? "'/%'" : $list->quote($list->escapeLike($folder->getRealFullPath()) . '/%')) . " AND type != 'folder'";
  1439|         if (!$this->getAdminUser()->isAdmin()) {
  1440|             $userIds = $this->getAdminUser()->getRoles();
  1441|             $userIds[] = $this->getAdminUser()->getId();
  1442|             $conditionFilters[] = ' (
  1443|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(CONCAT(path, filename),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
  1444|                                                     OR
  1445|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(path, filename))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
  1446|                                                  )';
  1447|         }
  1448|         $condition = implode(' AND ', $conditionFilters);
  1449|         $list->setCondition($condition);
  1450|         $list->setLimit($limit);
  1451|         $list->setOffset($start);
  1452|         $list->setOrderKey('CAST(filename AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci ASC', false);
  1453|         $beforeListLoadEvent = new GenericEvent($this, [
  1454|             'list' => $list,
  1455|             'context' => $allParams,
  1456|         ]);
  1457|         $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::ASSET_LIST_BEFORE_LIST_LOAD);
  1458|         /** @var Asset\Listing $list */
  1459|         $list = $beforeListLoadEvent->getArgument('list');
  1460|         $list->load();
  1461|         $assets = [];
  1462|         foreach ($list as $asset) {
  1463|             $thumbnailMethod = Asset\Service::getPreviewThumbnail($asset, [], true);
  1464|             if (!empty($thumbnailMethod)) {
  1465|                 $filenameDisplay = $asset->getFilename();
  1466|                 if (strlen($filenameDisplay) > 32) {
  1467|                     $filenameDisplay = substr($filenameDisplay, 0, 25) . '...' . \Pimcore\File::getFileExtension($filenameDisplay);
  1468|                 }
  1469|                 if ($asset->isAllowed('list')) {
  1470|                     $assets[] = [
  1471|                         'id' => $asset->getId(),
  1472|                         'type' => $asset->getType(),
  1473|                         'filename' => $asset->getFilename(),
  1474|                         'filenameDisplay' => htmlspecialchars($filenameDisplay),
  1475|                         'url' => $this->getThumbnailUrl($asset, true, true),
  1476|                         'idPath' => $data['idPath'] = Element\Service::getIdPath($asset),
  1477|                     ];
  1478|                 }
  1479|             }
  1480|         }
  1481|         $result = ['data' => $assets, 'success' => true, 'total' => $list->getTotalCount()];
  1482|         $afterListLoadEvent = new GenericEvent($this, [
  1483|             'list' => $result,
  1484|             'context' => $allParams,
  1485|         ]);
  1486|         $eventDispatcher->dispatch($afterListLoadEvent, AdminEvents::ASSET_LIST_AFTER_LIST_LOAD);
  1487|         $result = $afterListLoadEvent->getArgument('list');
  1488|         return $this->adminJson(['assets' => $result['data'], 'success' => $result['success'], 'total' => $result['total']]);
  1489|     }
  1490|     /**
  1491|      * @Route("/copy-info", name="pimcore_admin_asset_copyinfo", methods={"GET"})
  1492|      *
  1493|      * @param Request $request
  1494|      *
  1495|      * @return JsonResponse
  1496|      */
  1497|     public function copyInfoAction(Request $request)
  1498|     {
  1499|         $transactionId = time();
  1500|         $pasteJobs = [];
  1501|         Tool\Session::useSession(function (AttributeBagInterface $session) use ($transactionId) {
  1502|             $session->set($transactionId, []);
  1503|         }, 'pimcore_copy');
  1504|         if ($request->get('type') == 'recursive') {
  1505|             $asset = Asset::getById($request->get('sourceId'));
  1506|             if (!$asset) {
  1507|                 throw $this->createNotFoundException('Source not found');
  1508|             }
  1509|             $pasteJobs[] = [[
  1510|                 'url' => $this->generateUrl('pimcore_admin_asset_copy'),
  1511|                 'method' => 'POST',
  1512|                 'params' => [
  1513|                     'sourceId' => $request->get('sourceId'),
  1514|                     'targetId' => $request->get('targetId'),
  1515|                     'type' => 'child',
  1516|                     'transactionId' => $transactionId,
  1517|                     'saveParentId' => true,
  1518|                 ],
  1519|             ]];
  1520|             if ($asset->hasChildren()) {
  1521|                 $list = new Asset\Listing();
  1522|                 $list->setCondition('path LIKE ?', [$list->escapeLike($asset->getRealFullPath()) . '/%']);
  1523|                 $list->setOrderKey('LENGTH(path)', false);
  1524|                 $list->setOrder('ASC');
  1525|                 $childIds = $list->loadIdList();
  1526|                 if (count($childIds) > 0) {
  1527|                     foreach ($childIds as $id) {
  1528|                         $pasteJobs[] = [[
  1529|                             'url' => $this->generateUrl('pimcore_admin_asset_copy'),
  1530|                             'method' => 'POST',
  1531|                             'params' => [
  1532|                                 'sourceId' => $id,
  1533|                                 'targetParentId' => $request->get('targetId'),
  1534|                                 'sourceParentId' => $request->get('sourceId'),
  1535|                                 'type' => 'child',
  1536|                                 'transactionId' => $transactionId,
  1537|                             ],
  1538|                         ]];
  1539|                     }
  1540|                 }
  1541|             }
  1542|         } elseif ($request->get('type') == 'child' || $request->get('type') == 'replace') {
  1543|             $pasteJobs[] = [[
  1544|                 'url' => $this->generateUrl('pimcore_admin_asset_copy'),
  1545|                 'method' => 'POST',
  1546|                 'params' => [
  1547|                     'sourceId' => $request->get('sourceId'),
  1548|                     'targetId' => $request->get('targetId'),
  1549|                     'type' => $request->get('type'),
  1550|                     'transactionId' => $transactionId,
  1551|                 ],
  1552|             ]];
  1553|         }
  1554|         return $this->adminJson([
  1555|             'pastejobs' => $pasteJobs,
  1556|         ]);
  1557|     }
  1558|     /**
  1559|      * @Route("/copy", name="pimcore_admin_asset_copy", methods={"POST"})
  1560|      *
  1561|      * @param Request $request
  1562|      *
  1563|      * @return JsonResponse
  1564|      */
  1565|     public function copyAction(Request $request)
  1566|     {
  1567|         $success = false;
  1568|         $sourceId = (int)$request->get('sourceId');
  1569|         $source = Asset::getById($sourceId);
  1570|         $session = Tool\Session::get('pimcore_copy');
  1571|         $sessionBag = $session->get($request->get('transactionId'));
  1572|         $targetId = (int)$request->get('targetId');
  1573|         if ($request->get('targetParentId')) {
  1574|             $sourceParent = Asset::getById($request->get('sourceParentId'));
  1575|             if ($sessionBag['parentId']) {
  1576|                 $targetParent = Asset::getById($sessionBag['parentId']);
  1577|             } else {
  1578|                 $targetParent = Asset::getById($request->get('targetParentId'));
  1579|             }
  1580|             $targetPath = preg_replace('@^' . $sourceParent->getRealFullPath() . '@', $targetParent . '/', $source->getRealPath());
  1581|             $target = Asset::getByPath($targetPath);
  1582|         } else {
  1583|             $target = Asset::getById($targetId);
  1584|         }
  1585|         if (!$target) {
  1586|             throw $this->createNotFoundException('Target not found');
  1587|         }
  1588|         if ($target->isAllowed('create')) {
  1589|             $source = Asset::getById($sourceId);
  1590|             if ($source != null) {
  1591|                 if ($request->get('type') == 'child') {
  1592|                     $newAsset = $this->_assetService->copyAsChild($target, $source);
  1593|                     if ($request->get('saveParentId')) {
  1594|                         $sessionBag['parentId'] = $newAsset->getId();
  1595|                     }
  1596|                 } elseif ($request->get('type') == 'replace') {
  1597|                     $this->_assetService->copyContents($target, $source);
  1598|                 }
  1599|                 $session->set($request->get('transactionId'), $sessionBag);
  1600|                 Tool\Session::writeClose();
  1601|                 $success = true;
  1602|             } else {
  1603|                 Logger::debug('prevended copy/paste because asset with same path+key already exists in this location');
  1604|             }
  1605|         } else {
  1606|             Logger::error('could not execute copy/paste because of missing permissions on target [ ' . $targetId . ' ]');
  1607|             throw $this->createAccessDeniedHttpException();
  1608|         }
  1609|         Tool\Session::writeClose();
  1610|         return $this->adminJson(['success' => $success]);
  1611|     }
  1612|     /**
  1613|      * @Route("/download-as-zip-jobs", name="pimcore_admin_asset_downloadaszipjobs", methods={"GET"})
  1614|      *
  1615|      * @param Request $request
  1616|      *
  1617|      * @return JsonResponse
  1618|      */
  1619|     public function downloadAsZipJobsAction(Request $request)
  1620|     {
  1621|         $jobId = uniqid();
  1622|         $filesPerJob = 5;
  1623|         $jobs = [];
  1624|         $asset = Asset::getById($request->get('id'));
  1625|         if (!$asset) {
  1626|             throw $this->createNotFoundException('Asset not found');
  1627|         }
  1628|         if ($asset->isAllowed('view')) {
  1629|             $parentPath = $asset->getRealFullPath();
  1630|             if ($asset->getId() == 1) {
  1631|                 $parentPath = '';
  1632|             }
  1633|             $db = \Pimcore\Db::get();
  1634|             $conditionFilters = [];
  1635|             $selectedIds = explode(',', $request->get('selectedIds', ''));
  1636|             $quotedSelectedIds = [];
  1637|             foreach ($selectedIds as $selectedId) {
  1638|                 if ($selectedId) {
  1639|                     $quotedSelectedIds[] = $db->quote($selectedId);
  1640|                 }
  1641|             }
  1642|             if (!empty($quotedSelectedIds)) {
  1643|                 $conditionFilters[] = 'id IN (' . implode(',', $quotedSelectedIds) . ')';
  1644|             }
  1645|             $conditionFilters[] = 'path LIKE ' . $db->quote($db->escapeLike($parentPath) . '/%') . ' AND type != ' . $db->quote('folder');
  1646|             if (!$this->getAdminUser()->isAdmin()) {
  1647|                 $userIds = $this->getAdminUser()->getRoles();
  1648|                 $userIds[] = $this->getAdminUser()->getId();
  1649|                 $conditionFilters[] = ' (
  1650|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(CONCAT(path, filename),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
  1651|                                                     OR
  1652|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(path, filename))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
  1653|                                                  )';
  1654|             }
  1655|             $condition = implode(' AND ', $conditionFilters);
  1656|             $assetList = new Asset\Listing();
  1657|             $assetList->setCondition($condition);
  1658|             $assetList->setOrderKey('LENGTH(path)', false);
  1659|             $assetList->setOrder('ASC');
  1660|             for ($i = 0; $i < ceil($assetList->getTotalCount() / $filesPerJob); $i++) {
  1661|                 $jobs[] = [[
  1662|                     'url' => $this->generateUrl('pimcore_admin_asset_downloadaszipaddfiles'),
  1663|                     'method' => 'GET',
  1664|                     'params' => [
  1665|                         'id' => $asset->getId(),
  1666|                         'selectedIds' => implode(',', $selectedIds),
  1667|                         'offset' => $i * $filesPerJob,
  1668|                         'limit' => $filesPerJob,
  1669|                         'jobId' => $jobId,
  1670|                     ],
  1671|                 ]];
  1672|             }
  1673|         }
  1674|         return $this->adminJson([
  1675|             'success' => true,
  1676|             'jobs' => $jobs,
  1677|             'jobId' => $jobId,
  1678|         ]);
  1679|     }
  1680|     /**
  1681|      * @Route("/download-as-zip-add-files", name="pimcore_admin_asset_downloadaszipaddfiles", methods={"GET"})
  1682|      *
  1683|      * @param Request $request
  1684|      *
  1685|      * @return JsonResponse
  1686|      */
  1687|     public function downloadAsZipAddFilesAction(Request $request)
  1688|     {
  1689|         $zipFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/download-zip-' . $request->get('jobId') . '.zip';
  1690|         $asset = Asset::getById($request->get('id'));
  1691|         $success = false;
  1692|         if (!$asset) {
  1693|             throw $this->createNotFoundException('Asset not found');
  1694|         }
  1695|         if ($asset->isAllowed('view')) {
  1696|             $zip = new \ZipArchive();
  1697|             if (!is_file($zipFile)) {
  1698|                 $zipState = $zip->open($zipFile, \ZipArchive::CREATE);
  1699|             } else {
  1700|                 $zipState = $zip->open($zipFile);
  1701|             }
  1702|             if ($zipState === true) {
  1703|                 $parentPath = $asset->getRealFullPath();
  1704|                 if ($asset->getId() == 1) {
  1705|                     $parentPath = '';
  1706|                 }
  1707|                 $db = \Pimcore\Db::get();
  1708|                 $conditionFilters = [];
  1709|                 $selectedIds = $request->get('selectedIds', []);
  1710|                 if (!empty($selectedIds)) {
  1711|                     $selectedIds = explode(',', $selectedIds);
  1712|                     $conditionFilters[] = 'id IN (' . implode(',', $selectedIds) . ')';
  1713|                 }
  1714|                 $conditionFilters[] = "type != 'folder' AND path LIKE " . $db->quote($db->escapeLike($parentPath) . '/%');
  1715|                 if (!$this->getAdminUser()->isAdmin()) {
  1716|                     $userIds = $this->getAdminUser()->getRoles();
  1717|                     $userIds[] = $this->getAdminUser()->getId();
  1718|                     $conditionFilters[] = ' (
  1719|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(CONCAT(path, filename),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
  1720|                                                     OR
  1721|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(path, filename))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
  1722|                                                  )';
  1723|                 }
  1724|                 $condition = implode(' AND ', $conditionFilters);
  1725|                 $assetList = new Asset\Listing();
  1726|                 $assetList->setCondition($condition);
  1727|                 $assetList->setOrderKey('LENGTH(path) ASC, id ASC', false);
  1728|                 $assetList->setOffset((int)$request->get('offset'));
  1729|                 $assetList->setLimit((int)$request->get('limit'));
  1730|                 foreach ($assetList as $a) {
  1731|                     if ($a->isAllowed('view')) {
  1732|                         if (!$a instanceof Asset\Folder) {
  1733|                             $zip->addFile($a->getLocalFile(), preg_replace('@^' . preg_quote($asset->getRealPath(), '@') . '@i', '', $a->getRealFullPath()));
  1734|                         }
  1735|                     }
  1736|                 }
  1737|                 $zip->close();
  1738|                 $success = true;
  1739|             }
  1740|         }
  1741|         return $this->adminJson([
  1742|             'success' => $success,
  1743|         ]);
  1744|     }
  1745|     /**
  1746|      * @Route("/download-as-zip", name="pimcore_admin_asset_downloadaszip", methods={"GET"})
  1747|      *
  1748|      * @param Request $request
  1749|      *
  1750|      * @return BinaryFileResponse
  1751|      * Download all assets contained in the folder with parameter id as ZIP file.
  1752|      * The suggested filename is either [folder name].zip or assets.zip for the root folder.
  1753|      */
  1754|     public function downloadAsZipAction(Request $request)
  1755|     {
  1756|         $asset = Asset::getById($request->get('id'));
  1757|         if (!$asset) {
  1758|             throw $this->createNotFoundException('Asset not found');
  1759|         }
  1760|         $zipFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/download-zip-' . $request->get('jobId') . '.zip';
  1761|         $suggestedFilename = $asset->getFilename();
  1762|         if (empty($suggestedFilename)) {
  1763|             $suggestedFilename = 'assets';
  1764|         }
  1765|         $response = new BinaryFileResponse($zipFile);
  1766|         $response->headers->set('Content-Type', 'application/zip');
  1767|         $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, $suggestedFilename . '.zip');
  1768|         $response->deleteFileAfterSend(true);
  1769|         return $response;
  1770|     }
  1771|     /**
  1772|      * @Route("/import-zip", name="pimcore_admin_asset_importzip", methods={"POST"})
  1773|      *
  1774|      * @param Request $request
  1775|      *
  1776|      * @return Response
  1777|      */
  1778|     public function importZipAction(Request $request)
  1779|     {
  1780|         $jobId = uniqid();
  1781|         $filesPerJob = 5;
  1782|         $jobs = [];
  1783|         $asset = Asset::getById($request->get('parentId'));
  1784|         if (!is_file($_FILES['Filedata']['tmp_name'])) {
  1785|             return $this->adminJson([
  1786|                 'success' => false,
  1787|                 'message' => 'Something went wrong, please check upload_max_filesize and post_max_size in your php.ini as well as the write permissions on the file system',
  1788|             ]);
  1789|         }
  1790|         if (!$asset) {
  1791|             throw $this->createNotFoundException('Parent asset not found');
  1792|         }
  1793|         if (!$asset->isAllowed('create')) {
  1794|             throw $this->createAccessDeniedException('not allowed to create');
  1795|         }
  1796|         $zipFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . $jobId . '.zip';
  1797|         copy($_FILES['Filedata']['tmp_name'], $zipFile);
  1798|         $zip = new \ZipArchive;
  1799|         if ($zip->open($zipFile) === true) {
  1800|             $jobAmount = ceil($zip->numFiles / $filesPerJob);
  1801|             for ($i = 0; $i < $jobAmount; $i++) {
  1802|                 $jobs[] = [[
  1803|                     'url' => $this->generateUrl('pimcore_admin_asset_importzipfiles'),
  1804|                     'method' => 'POST',
  1805|                     'params' => [
  1806|                         'parentId' => $asset->getId(),
  1807|                         'offset' => $i * $filesPerJob,
  1808|                         'limit' => $filesPerJob,
  1809|                         'jobId' => $jobId,
  1810|                         'last' => (($i + 1) >= $jobAmount) ? 'true' : '',
  1811|                     ],
  1812|                 ]];
  1813|             }
  1814|             $zip->close();
  1815|         }
  1816|         $responseJson = $this->encodeJson([
  1817|             'success' => true,
  1818|             'jobs' => $jobs,
  1819|             'jobId' => $jobId,
  1820|         ]);
  1821|         return new Response($responseJson);
  1822|     }
  1823|     /**
  1824|      * @Route("/import-zip-files", name="pimcore_admin_asset_importzipfiles", methods={"POST"})
  1825|      *
  1826|      * @param Request $request
  1827|      *
  1828|      * @return JsonResponse
  1829|      */
  1830|     public function importZipFilesAction(Request $request)
  1831|     {
  1832|         $jobId = $request->get('jobId');
  1833|         $limit = (int)$request->get('limit');
  1834|         $offset = (int)$request->get('offset');
  1835|         $importAsset = Asset::getById($request->get('parentId'));
  1836|         $zipFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . $jobId . '.zip';
  1837|         $tmpDir = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/zip-import';
  1838|         if (!is_dir($tmpDir)) {
  1839|             File::mkdir($tmpDir, 0777, true);
  1840|         }
  1841|         $zip = new \ZipArchive;
  1842|         if ($zip->open($zipFile) === true) {
  1843|             for ($i = $offset; $i < ($offset + $limit); $i++) {
  1844|                 $path = $zip->getNameIndex($i);
  1845|                 if ($path !== false) {
  1846|                     if ($zip->extractTo($tmpDir . '/', $path)) {
  1847|                         $tmpFile = $tmpDir . '/' . preg_replace('@^/@', '', $path);
  1848|                         $filename = Element\Service::getValidKey(basename($path), 'asset');
  1849|                         $relativePath = '';
  1850|                         if (dirname($path) != '.') {
  1851|                             $relativePath = dirname($path);
  1852|                         }
  1853|                         $parentPath = $importAsset->getRealFullPath() . '/' . preg_replace('@^/@', '', $relativePath);
  1854|                         $parent = Asset\Service::createFolderByPath($parentPath);
  1855|                         $filename = $this->getSafeFilename($parent->getRealFullPath(), $filename);
  1856|                         if ($parent->isAllowed('create')) {
  1857|                             $asset = Asset::create($parent->getId(), [
  1858|                                 'filename' => $filename,
  1859|                                 'sourcePath' => $tmpFile,
  1860|                                 'userOwner' => $this->getAdminUser()->getId(),
  1861|                                 'userModification' => $this->getAdminUser()->getId(),
  1862|                             ]);
  1863|                             @unlink($tmpFile);
  1864|                         } else {
  1865|                             Logger::debug('prevented creating asset because of missing permissions');
  1866|                         }
  1867|                     }
  1868|                 }
  1869|             }
  1870|             $zip->close();
  1871|         }
  1872|         if ($request->get('last')) {
  1873|             unlink($zipFile);
  1874|         }
  1875|         return $this->adminJson([
  1876|             'success' => true,
  1877|         ]);
  1878|     }
  1879|     /**
  1880|      * @Route("/import-server", name="pimcore_admin_asset_importserver", methods={"POST"})
  1881|      *
  1882|      * @param Request $request
  1883|      *
  1884|      * @return JsonResponse
  1885|      */
  1886|     public function importServerAction(Request $request)
  1887|     {
  1888|         $success = true;
  1889|         $filesPerJob = 5;
  1890|         $jobs = [];
  1891|         $importDirectory = str_replace('/fileexplorer', PIMCORE_PROJECT_ROOT, $request->get('serverPath'));
  1892|         if (preg_match('@^' . preg_quote(PIMCORE_PROJECT_ROOT, '@') . '@', $importDirectory) && is_dir($importDirectory)) {
  1893|             $this->checkForPharStreamWrapper($importDirectory);
  1894|             $files = rscandir($importDirectory . '/');
  1895|             $count = count($files);
  1896|             $jobFiles = [];
  1897|             for ($i = 0; $i < $count; $i++) {
  1898|                 if (is_dir($files[$i])) {
  1899|                     continue;
  1900|                 }
  1901|                 $jobFiles[] = preg_replace('@^' . preg_quote($importDirectory, '@') . '@', '', $files[$i]);
  1902|                 if (count($jobFiles) >= $filesPerJob || $i >= ($count - 1)) {
  1903|                     $relativeImportDirectory = preg_replace('@^' . preg_quote(PIMCORE_PROJECT_ROOT, '@') . '@', '', $importDirectory);
  1904|                     $jobs[] = [[
  1905|                         'url' => $this->generateUrl('pimcore_admin_asset_importserverfiles'),
  1906|                         'method' => 'POST',
  1907|                         'params' => [
  1908|                             'parentId' => $request->get('parentId'),
  1909|                             'serverPath' => $relativeImportDirectory,
  1910|                             'files' => implode('::', $jobFiles),
  1911|                         ],
  1912|                     ]];
  1913|                     $jobFiles = [];
  1914|                 }
  1915|             }
  1916|         }
  1917|         return $this->adminJson([
  1918|             'success' => $success,
  1919|             'jobs' => $jobs,
  1920|         ]);
  1921|     }
  1922|     /**
  1923|      * @Route("/import-server-files", name="pimcore_admin_asset_importserverfiles", methods={"POST"})
  1924|      *
  1925|      * @param Request $request
  1926|      *
  1927|      * @return JsonResponse
  1928|      */
  1929|     public function importServerFilesAction(Request $request)
  1930|     {
  1931|         $assetFolder = Asset::getById($request->get('parentId'));
  1932|         if (!$assetFolder) {
  1933|             throw $this->createNotFoundException('Parent asset not found');
  1934|         }
  1935|         $serverPath = PIMCORE_PROJECT_ROOT . $request->get('serverPath');
  1936|         $files = explode('::', $request->get('files'));
  1937|         foreach ($files as $file) {
  1938|             $absolutePath = $serverPath . $file;
  1939|             $this->checkForPharStreamWrapper($absolutePath);
  1940|             if (is_file($absolutePath)) {
  1941|                 $relFolderPath = str_replace('\\', '/', dirname($file));
  1942|                 $folder = Asset\Service::createFolderByPath($assetFolder->getRealFullPath() . $relFolderPath);
  1943|                 $filename = basename($file);
  1944|                 $filename = Element\Service::getValidKey($filename, 'asset');
  1945|                 $filename = $this->getSafeFilename($folder->getRealFullPath(), $filename);
  1946|                 if ($assetFolder->isAllowed('create')) {
  1947|                     $asset = Asset::create($folder->getId(), [
  1948|                         'filename' => $filename,
  1949|                         'sourcePath' => $absolutePath,
  1950|                         'userOwner' => $this->getAdminUser()->getId(),
  1951|                         'userModification' => $this->getAdminUser()->getId(),
  1952|                     ]);
  1953|                 } else {
  1954|                     Logger::debug('prevented creating asset because of missing permissions ');
  1955|                 }
  1956|             }
  1957|         }
  1958|         return $this->adminJson([
  1959|             'success' => true,
  1960|         ]);
  1961|     }
  1962|     protected function checkForPharStreamWrapper($path)
  1963|     {
  1964|         if (stripos($path, 'phar://') !== false) {
  1965|             throw $this->createAccessDeniedException('Using PHAR files is not allowed!');
  1966|         }
  1967|     }
  1968|     /**
  1969|      * @Route("/import-url", name="pimcore_admin_asset_importurl", methods={"POST"})
  1970|      *
  1971|      * @param Request $request
  1972|      *
  1973|      * @return JsonResponse
  1974|      *
  1975|      * @throws \Exception
  1976|      */
  1977|     public function importUrlAction(Request $request)
  1978|     {
  1979|         $success = true;
  1980|         $data = Tool::getHttpData($request->get('url'));
  1981|         $filename = basename($request->get('url'));
  1982|         $parentId = $request->get('id');
  1983|         $parentAsset = Asset::getById((int)$parentId);
  1984|         if (!$parentAsset) {
  1985|             throw $this->createNotFoundException('Parent asset not found');
  1986|         }
  1987|         $filename = Element\Service::getValidKey($filename, 'asset');
  1988|         $filename = $this->getSafeFilename($parentAsset->getRealFullPath(), $filename);
  1989|         if (empty($filename)) {
  1990|             throw new \Exception('The filename of the asset is empty');
  1991|         }
  1992|         $filename = $this->getSafeFilename($parentAsset->getRealFullPath(), $filename);
  1993|         if ($parentAsset->isAllowed('create')) {
  1994|             $asset = Asset::create($parentId, [
  1995|                 'filename' => $filename,
  1996|                 'data' => $data,
  1997|                 'userOwner' => $this->getAdminUser()->getId(),
  1998|                 'userModification' => $this->getAdminUser()->getId(),
  1999|             ]);
  2000|             $success = true;
  2001|         } else {
  2002|             Logger::debug('prevented creating asset because of missing permissions');
  2003|         }
  2004|         return $this->adminJson(['success' => $success]);
  2005|     }
  2006|     /**
  2007|      * @Route("/clear-thumbnail", name="pimcore_admin_asset_clearthumbnail", methods={"POST"})
  2008|      *
  2009|      * @param Request $request
  2010|      *
  2011|      * @return JsonResponse
  2012|      */
  2013|     public function clearThumbnailAction(Request $request)
  2014|     {
  2015|         $success = false;
  2016|         if ($asset = Asset::getById($request->get('id'))) {
  2017|             if (method_exists($asset, 'clearThumbnails')) {
  2018|                 if (!$asset->isAllowed('publish')) {
  2019|                     throw $this->createAccessDeniedException('not allowed to publish');
  2020|                 }
  2021|                 $asset->clearThumbnails(true); // force clear
  2022|                 $asset->save();
  2023|                 $success = true;
  2024|             }
  2025|         }
  2026|         return $this->adminJson(['success' => $success]);
  2027|     }
  2028|     /**
  2029|      * @Route("/grid-proxy", name="pimcore_admin_asset_gridproxy", methods={"GET", "POST", "PUT"})
  2030|      *
  2031|      * @param Request $request
  2032|      * @param EventDispatcherInterface $eventDispatcher
  2033|      * @param GridHelperService $gridHelperService
  2034|      * @param CsrfProtectionHandler $csrfProtection
  2035|      *
  2036|      * @return JsonResponse
  2037|      */
  2038|     public function gridProxyAction(Request $request, EventDispatcherInterface $eventDispatcher, GridHelperService $gridHelperService, CsrfProtectionHandler $csrfProtection)
  2039|     {
  2040|         $allParams = array_merge($request->request->all(), $request->query->all());
  2041|         $filterPrepareEvent = new GenericEvent($this, [
  2042|             'requestParams' => $allParams,
  2043|         ]);
  2044|         $language = $request->get('language') != 'default' ? $request->get('language') : null;
  2045|         $eventDispatcher->dispatch($filterPrepareEvent, AdminEvents::ASSET_LIST_BEFORE_FILTER_PREPARE);
  2046|         $allParams = $filterPrepareEvent->getArgument('requestParams');
  2047|         $loader = \Pimcore::getContainer()->get('pimcore.implementation_loader.asset.metadata.data');
  2048|         if (isset($allParams['data']) && $allParams['data']) {
  2049|             $csrfProtection->checkCsrfToken($request);
  2050|             if ($allParams['xaction'] == 'update') {
  2051|                 try {
  2052|                     $data = $this->decodeJson($allParams['data']);
  2053|                     $updateEvent = new GenericEvent($this, [
  2054|                         'data' => $data,
  2055|                         'processed' => false,
  2056|                     ]);
  2057|                     $eventDispatcher->dispatch($updateEvent, AdminEvents::ASSET_LIST_BEFORE_UPDATE);
  2058|                     $processed = $updateEvent->getArgument('processed');
  2059|                     if ($processed) {
  2060|                         return $this->adminJson(['success' => true]);
  2061|                     }
  2062|                     $data = $updateEvent->getArgument('data');
  2063|                     $asset = Asset::getById($data['id']);
  2064|                     if (!$asset) {
  2065|                         throw $this->createNotFoundException('Asset not found');
  2066|                     }
  2067|                     if (!$asset->isAllowed('publish')) {
  2068|                         throw $this->createAccessDeniedException("Permission denied. You don't have the rights to save this asset.");
  2069|                     }
  2070|                     $metadata = $asset->getMetadata(null, null, false, true);
  2071|                     $dirty = false;
  2072|                     unset($data['id']);
  2073|                     foreach ($data as $key => $value) {
  2074|                         $fieldDef = explode('~', $key);
  2075|                         $key = $fieldDef[0];
  2076|                         if (isset($fieldDef[1])) {
  2077|                             $language = ($fieldDef[1] == 'none' ? '' : $fieldDef[1]);
  2078|                         }
  2079|                         foreach ($metadata as $idx => &$em) {
  2080|                             if ($em['name'] == $key && $em['language'] == $language) {
  2081|                                 try {
  2082|                                     $dataImpl = $loader->build($em['type']);
  2083|                                     $value = $dataImpl->getDataFromListfolderGrid($value, $em);
  2084|                                 } catch (UnsupportedException $le) {
  2085|                                     Logger::error('could not resolve metadata implementation for ' . $em['type']);
  2086|                                 }
  2087|                                 $em['data'] = $value;
  2088|                                 $dirty = true;
  2089|                                 break;
  2090|                             }
  2091|                         }
  2092|                         if (!$dirty) {
  2093|                             $defaulMetadata = ['title', 'alt', 'copyright'];
  2094|                             if (in_array($key, $defaulMetadata)) {
  2095|                                 $newEm = [
  2096|                                     'name' => $key,
  2097|                                     'language' => $language,
  2098|                                     'type' => 'input',
  2099|                                     'data' => $value,
  2100|                                 ];
  2101|                                 try {
  2102|                                     $dataImpl = $loader->build($newEm['type']);
  2103|                                     $newEm['data'] = $dataImpl->getDataFromListfolderGrid($value, $newEm);
  2104|                                 } catch (UnsupportedException $le) {
  2105|                                     Logger::error('could not resolve metadata implementation for ' . $newEm['type']);
  2106|                                 }
  2107|                                 $metadata[] = $newEm;
  2108|                                 $dirty = true;
  2109|                             } else {
  2110|                                 $predefined = Model\Metadata\Predefined::getByName($key);
  2111|                                 if ($predefined && (empty($predefined->getTargetSubtype())
  2112|                                         || $predefined->getTargetSubtype() == $asset->getType())) {
  2113|                                     $newEm = [
  2114|                                         'name' => $key,
  2115|                                         'language' => $language,
  2116|                                         'type' => $predefined->getType(),
  2117|                                         'data' => $value,
  2118|                                     ];
  2119|                                     try {
  2120|                                         $dataImpl = $loader->build($newEm['type']);
  2121|                                         $newEm['data'] = $dataImpl->getDataFromListfolderGrid($value, $newEm);
  2122|                                     } catch (UnsupportedException $le) {
  2123|                                         Logger::error('could not resolve metadata implementation for ' . $newEm['type']);
  2124|                                     }
  2125|                                     $metadata[] = $newEm;
  2126|                                     $dirty = true;
  2127|                                 }
  2128|                             }
  2129|                         }
  2130|                     }
  2131|                     if ($dirty) {
  2132|                         $asset->setMetadataRaw($metadata);
  2133|                         $asset->save();
  2134|                         return $this->adminJson(['success' => true]);
  2135|                     }
  2136|                     return $this->adminJson(['success' => false, 'message' => 'something went wrong.']);
  2137|                 } catch (\Exception $e) {
  2138|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
  2139|                 }
  2140|             }
  2141|         } else {
  2142|             $list = $gridHelperService->prepareAssetListingForGrid($allParams, $this->getAdminUser());
  2143|             $beforeListLoadEvent = new GenericEvent($this, [
  2144|                 'list' => $list,
  2145|                 'context' => $allParams,
  2146|             ]);
  2147|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::ASSET_LIST_BEFORE_LIST_LOAD);
  2148|             /** @var Asset\Listing $list */
  2149|             $list = $beforeListLoadEvent->getArgument('list');
  2150|             $list->load();
  2151|             $assets = [];
  2152|             foreach ($list->getAssets() as $index => $asset) {
  2153|                 if ($asset->isAllowed('list')) {
  2154|                     $a = Asset\Service::gridAssetData($asset, $allParams['fields'], $allParams['language'] ?? '');
  2155|                     $assets[] = $a;
  2156|                 }
  2157|             }
  2158|             $result = ['data' => $assets, 'success' => true, 'total' => $list->getTotalCount()];
  2159|             $afterListLoadEvent = new GenericEvent($this, [
  2160|                 'list' => $result,
  2161|                 'context' => $allParams,
  2162|             ]);
  2163|             $eventDispatcher->dispatch($afterListLoadEvent, AdminEvents::ASSET_LIST_AFTER_LIST_LOAD);
  2164|             $result = $afterListLoadEvent->getArgument('list');
  2165|             return $this->adminJson($result);
  2166|         }
  2167|         return $this->adminJson(['success' => false]);
  2168|     }
  2169|     /**
  2170|      * @Route("/get-text", name="pimcore_admin_asset_gettext", methods={"GET"})
  2171|      *
  2172|      * @param Request $request
  2173|      *
  2174|      * @return JsonResponse
  2175|      */
  2176|     public function getTextAction(Request $request)
  2177|     {
  2178|         $asset = Asset::getById($request->get('id'));
  2179|         if (!$asset) {
  2180|             throw $this->createNotFoundException('Asset not found');
  2181|         }
  2182|         if (!$asset->isAllowed('view')) {
  2183|             throw $this->createAccessDeniedException('not allowed to view');
  2184|         }
  2185|         $page = $request->get('page');
  2186|         $text = null;
  2187|         if ($asset instanceof Asset\Document) {
  2188|             $text = $asset->getText($page);
  2189|         }
  2190|         return $this->adminJson(['success' => 'true', 'text' => $text]);
  2191|     }
  2192|     /**
  2193|      * @Route("/detect-image-features", name="pimcore_admin_asset_detectimagefeatures", methods={"GET"})
  2194|      *
  2195|      * @param Request $request
  2196|      *
  2197|      * @return JsonResponse
  2198|      */
  2199|     public function detectImageFeaturesAction(Request $request)
  2200|     {
  2201|         $asset = Asset\Image::getById((int)$request->get('id'));
  2202|         if (!$asset instanceof Asset) {
  2203|             return $this->adminJson(['success' => false, 'message' => "asset doesn't exist"]);
  2204|         }
  2205|         if ($asset->isAllowed('publish')) {
  2206|             $asset->detectFaces();
  2207|             $asset->removeCustomSetting('disableImageFeatureAutoDetection');
  2208|             $asset->save();
  2209|             return $this->adminJson(['success' => true]);
  2210|         }
  2211|         throw $this->createAccessDeniedHttpException();
  2212|     }
  2213|     /**
  2214|      * @Route("/delete-image-features", name="pimcore_admin_asset_deleteimagefeatures", methods={"GET"})
  2215|      *
  2216|      * @param Request $request
  2217|      *
  2218|      * @return JsonResponse
  2219|      */
  2220|     public function deleteImageFeaturesAction(Request $request)
  2221|     {
  2222|         $asset = Asset::getById((int)$request->get('id'));
  2223|         if (!$asset instanceof Asset) {
  2224|             return $this->adminJson(['success' => false, 'message' => "asset doesn't exist"]);
  2225|         }
  2226|         if ($asset->isAllowed('publish')) {
  2227|             $asset->removeCustomSetting('faceCoordinates');
  2228|             $asset->setCustomSetting('disableImageFeatureAutoDetection', true);
  2229|             $asset->save();
  2230|             return $this->adminJson(['success' => true]);
  2231|         }
  2232|         throw $this->createAccessDeniedHttpException();
  2233|     }
  2234|     /**
  2235|      * @param ControllerEvent $event
  2236|      */
  2237|     public function onKernelControllerEvent(ControllerEvent $event)
  2238|     {
  2239|         $isMasterRequest = $event->isMasterRequest();
  2240|         if (!$isMasterRequest) {
  2241|             return;
  2242|         }
  2243|         $this->checkActionPermission($event, 'assets', [
  2244|             'getImageThumbnailAction', 'getVideoThumbnailAction', 'getDocumentThumbnailAction',
  2245|         ]);
  2246|         $this->_assetService = new Asset\Service($this->getAdminUser());
  2247|     }
  2248| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Asset/AssetHelperController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-899 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Asset;
    15| use PhpOffice\PhpSpreadsheet\Reader\Csv;
    16| use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
    17| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    18| use Pimcore\Bundle\AdminBundle\Helper\GridHelperService;
    19| use Pimcore\Db;
    20| use Pimcore\Event\AdminEvents;
    21| use Pimcore\Loader\ImplementationLoader\Exception\UnsupportedException;
    22| use Pimcore\Localization\LocaleServiceInterface;
    23| use Pimcore\Logger;
    24| use Pimcore\Model\Asset;
    25| use Pimcore\Model\Element;
    26| use Pimcore\Model\GridConfig;
    27| use Pimcore\Model\GridConfigFavourite;
    28| use Pimcore\Model\GridConfigShare;
    29| use Pimcore\Model\Metadata;
    30| use Pimcore\Model\User;
    31| use Pimcore\Tool;
    32| use Pimcore\Version;
    33| use Symfony\Component\EventDispatcher\GenericEvent;
    34| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    35| use Symfony\Component\HttpFoundation\JsonResponse;
    36| use Symfony\Component\HttpFoundation\Request;
    37| use Symfony\Component\HttpFoundation\ResponseHeaderBag;
    38| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    39| use Symfony\Component\Routing\Annotation\Route;
    40| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    41| /**
    42|  * @Route("/asset-helper")
    43|  *
    44|  * @internal
    45|  */
    46| class AssetHelperController extends AdminController
    47| {
    48|     /**
    49|      * @param int $userId
    50|      * @param string $classId
    51|      * @param string $searchType
    52|      *
    53|      * @return GridConfig[]
    54|      */
    55|     public function getMyOwnGridColumnConfigs($userId, $classId, $searchType)
    56|     {
    57|         $db = Db::get();
    58|         $configListingConditionParts = [];
    59|         $configListingConditionParts[] = 'ownerId = ' . $userId;
    60|         $configListingConditionParts[] = 'classId = ' . $db->quote($classId);
    61|         if ($searchType) {
    62|             $configListingConditionParts[] = 'searchType = ' . $db->quote($searchType);
    63|         }
    64|         $configCondition = implode(' AND ', $configListingConditionParts);
    65|         $configListing = new GridConfig\Listing();
    66|         $configListing->setOrderKey('name');
    67|         $configListing->setOrder('ASC');
    68|         $configListing->setCondition($configCondition);
    69|         $configListing = $configListing->load();
    70|         return $configListing;
    71|     }
    72|     /**
    73|      * @param User $user
    74|      * @param string $classId
    75|      * @param string $searchType
    76|      *
    77|      * @return GridConfig[]
    78|      */
    79|     public function getSharedGridColumnConfigs($user, $classId, $searchType = null)
    80|     {
    81|         $db = Db::get();
    82|         $configListing = [];
    83|         $userIds = [$user->getId()];
    84|         $userIds = array_merge($userIds, $user->getRoles());
    85|         $userIds = implode(',', $userIds);
    86|         $query = 'select distinct c1.id from gridconfigs c1, gridconfig_shares s
    87|                     where (c1.searchType = ' . $db->quote($searchType) . ' and ((c1.id = s.gridConfigId and s.sharedWithUserId IN (' . $userIds . '))) and c1.classId = ' . $db->quote($classId) . ')
    88|                             UNION distinct select c2.id from gridconfigs c2 where shareGlobally = 1 and c2.classId = '. $db->quote($classId) . '  and c2.ownerId != ' . $db->quote($user->getId());
    89|         $ids = $db->fetchCol($query);
    90|         if ($ids) {
    91|             $ids = implode(',', $ids);
    92|             $configListing = new GridConfig\Listing();
    93|             $configListing->setOrderKey('name');
    94|             $configListing->setOrder('ASC');
    95|             $configListing->setCondition('id in (' . $ids . ')');
    96|             $configListing = $configListing->load();
    97|         }
    98|         return $configListing;
    99|     }
   100|     /**
   101|      * @Route("/grid-delete-column-config", name="pimcore_admin_asset_assethelper_griddeletecolumnconfig", methods={"DELETE"})
   102|      *
   103|      * @param Request $request
   104|      *
   105|      * @return JsonResponse
   106|      */
   107|     public function gridDeleteColumnConfigAction(Request $request)
   108|     {
   109|         $gridConfigId = $request->get('gridConfigId');
   110|         $gridConfig = null;
   111|         try {
   112|             $gridConfig = GridConfig::getById($gridConfigId);
   113|         } catch (\Exception $e) {
   114|         }
   115|         $success = false;
   116|         if ($gridConfig) {
   117|             if ($gridConfig->getOwnerId() != $this->getAdminUser()->getId()) {
   118|                 throw new \Exception("don't mess with someone elses grid config");
   119|             }
   120|             $gridConfig->delete();
   121|             $success = true;
   122|         }
   123|         $newGridConfig = $this->doGetGridColumnConfig($request, true);
   124|         $newGridConfig['deleteSuccess'] = $success;
   125|         return $this->adminJson($newGridConfig);
   126|     }
   127|     /**
   128|      * @Route("/grid-get-column-config", name="pimcore_admin_asset_assethelper_gridgetcolumnconfig", methods={"GET"})
   129|      *
   130|      * @param Request $request
   131|      *
   132|      * @return JsonResponse
   133|      */
   134|     public function gridGetColumnConfigAction(Request $request)
   135|     {
   136|         $result = $this->doGetGridColumnConfig($request);
   137|         return $this->adminJson($result);
   138|     }
   139|     /**
   140|      * @param Request $request
   141|      * @param bool $isDelete
   142|      *
   143|      * @return array
   144|      */
   145|     public function doGetGridColumnConfig(Request $request, $isDelete = false)
   146|     {
   147|         $gridConfigId = null;
   148|         $classId = $request->get('id');
   149|         $type = $request->get('type');
   150|         $context = ['purpose' => 'gridconfig'];
   151|         $types = [];
   152|         if ($request->get('types')) {
   153|             $types = explode(',', $request->get('types'));
   154|         }
   155|         $userId = $this->getAdminUser()->getId();
   156|         $requestedGridConfigId = $isDelete ? null : $request->get('gridConfigId');
   157|         $gridConfig = [];
   158|         $searchType = $request->get('searchType');
   159|         if (strlen($requestedGridConfigId) == 0) {
   160|             $favourite = null;
   161|             try {
   162|                 try {
   163|                     $favourite = GridConfigFavourite::getByOwnerAndClassAndObjectId($userId, $classId, 0, $searchType);
   164|                 } catch (\Exception $e) {
   165|                 }
   166|                 if ($favourite) {
   167|                     $requestedGridConfigId = $favourite->getGridConfigId();
   168|                 }
   169|             } catch (\Exception $e) {
   170|             }
   171|         }
   172|         if (is_numeric($requestedGridConfigId) && $requestedGridConfigId > 0) {
   173|             $db = Db::get();
   174|             $configListingConditionParts = [];
   175|             $configListingConditionParts[] = 'ownerId = ' . $userId;
   176|             $configListingConditionParts[] = 'classId = ' . $db->quote($classId);
   177|             $configListingConditionParts[] = 'type = ' . $db->quote($type);
   178|             if ($searchType) {
   179|                 $configListingConditionParts[] = 'searchType = ' . $db->quote($searchType);
   180|             }
   181|             $savedGridConfig = null;
   182|             try {
   183|                 $savedGridConfig = GridConfig::getById($requestedGridConfigId);
   184|             } catch (\Exception $e) {
   185|             }
   186|             if ($savedGridConfig) {
   187|                 $shared = null;
   188|                 try {
   189|                     $userIds = [$this->getAdminUser()->getId()];
   190|                     if ($this->getAdminUser()->getRoles()) {
   191|                         $userIds = array_merge($userIds, $this->getAdminUser()->getRoles());
   192|                     }
   193|                     $userIds = implode(',', $userIds);
   194|                     $shared = ($savedGridConfig->getOwnerId() != $userId && $savedGridConfig->isShareGlobally()) || $db->fetchOne('select * from gridconfig_shares where sharedWithUserId IN (' . $userIds . ') and gridConfigId = ' . $savedGridConfig->getId());
   195|                 } catch (\Exception $e) {
   196|                 }
   197|                 if (!$shared && $savedGridConfig->getOwnerId() != $this->getAdminUser()->getId()) {
   198|                     throw new \Exception('you are neither the onwner of this config nor it is shared with you');
   199|                 }
   200|                 $gridConfigId = $savedGridConfig->getId();
   201|                 $gridConfig = $savedGridConfig->getConfig();
   202|                 $gridConfig = json_decode($gridConfig, true);
   203|                 $gridConfigName = $savedGridConfig->getName();
   204|                 $gridConfigDescription = $savedGridConfig->getDescription();
   205|                 $sharedGlobally = $savedGridConfig->isShareGlobally();
   206|             }
   207|         }
   208|         $availableFields = [];
   209|         $language = '';
   210|         if (empty($gridConfig)) {
   211|             $availableFields = $this->getDefaultGridFields(
   212|                 $request->get('no_system_columns'),
   213|                 null, //maybe required for types other than metadata
   214|                 $context,
   215|                 $types);
   216|         } else {
   217|             $savedColumns = $gridConfig['columns'];
   218|             foreach ($savedColumns as $key => $sc) {
   219|                 if (!$sc['hidden']) {
   220|                     $colConfig = $this->getFieldGridConfig($sc, $language, null);
   221|                     if ($colConfig) {
   222|                         $availableFields[] = $colConfig;
   223|                     }
   224|                 }
   225|             }
   226|         }
   227|         usort($availableFields, function ($a, $b) {
   228|             if ($a['position'] == $b['position']) {
   229|                 return 0;
   230|             }
   231|             return ($a['position'] < $b['position']) ? -1 : 1;
   232|         });
   233|         $availableConfigs = $classId ? $this->getMyOwnGridColumnConfigs($userId, $classId, $searchType) : [];
   234|         $sharedConfigs = $classId ? $this->getSharedGridColumnConfigs($this->getAdminUser(), $classId, $searchType) : [];
   235|         $settings = $this->getShareSettings((int)$gridConfigId);
   236|         $settings['gridConfigId'] = (int)$gridConfigId;
   237|         $settings['gridConfigName'] = $gridConfigName ?? null;
   238|         $settings['gridConfigDescription'] = $gridConfigDescription ?? null;
   239|         $settings['shareGlobally'] = $sharedGlobally ?? null;
   240|         $settings['isShared'] = !$gridConfigId || ($shared ?? null);
   241|         $context = $gridConfig['context'] ?? null;
   242|         if ($context) {
   243|             $context = json_decode($context, true);
   244|         }
   245|         return [
   246|             'sortinfo' => isset($gridConfig['sortinfo']) ? $gridConfig['sortinfo'] : false,
   247|             'availableFields' => $availableFields,
   248|             'settings' => $settings,
   249|             'onlyDirectChildren' => isset($gridConfig['onlyDirectChildren']) ? $gridConfig['onlyDirectChildren'] : false,
   250|             'onlyUnreferenced' => isset($gridConfig['onlyUnreferenced']) ? $gridConfig['onlyUnreferenced'] : false,
   251|             'pageSize' => isset($gridConfig['pageSize']) ? $gridConfig['pageSize'] : false,
   252|             'availableConfigs' => $availableConfigs,
   253|             'sharedConfigs' => $sharedConfigs,
   254|             'context' => $context,
   255|         ];
   256|     }
   257|     /**
   258|      * @param array $field
   259|      * @param string $language
   260|      * @param string|null $keyPrefix
   261|      *
   262|      * @return array|null
   263|      */
   264|     protected function getFieldGridConfig($field, $language = '', $keyPrefix = null)
   265|     {
   266|         $defaulMetadataFields = ['copyright', 'alt', 'title'];
   267|         $predefined = null;
   268|         if (isset($field['fieldConfig']['layout']['name'])) {
   269|             $predefined = Metadata\Predefined::getByName($field['fieldConfig']['layout']['name']);
   270|         }
   271|         $key = $field['name'];
   272|         if ($keyPrefix) {
   273|             $key = $keyPrefix . $key;
   274|         }
   275|         $fieldDef = explode('~', $field['name']);
   276|         $field['name'] = $fieldDef[0];
   277|         if (isset($fieldDef[1]) && $fieldDef[1] === 'system') {
   278|             $type = 'system';
   279|         } elseif (in_array($fieldDef[0], $defaulMetadataFields)) {
   280|             $type = 'input';
   281|         } else {
   282|             $type = $field['fieldConfig']['type'];
   283|             if (isset($fieldDef[1])) {
   284|                 $field['fieldConfig']['label'] = $field['fieldConfig']['layout']['title'] = $fieldDef[0] . ' (' . $fieldDef[1] . ')';
   285|                 $field['fieldConfig']['layout']['icon'] = Tool::getLanguageFlagFile($fieldDef[1], true);
   286|             }
   287|         }
   288|         $result = [
   289|             'key' => $key,
   290|             'type' => $type,
   291|             'label' => $field['fieldConfig']['label'] ?? $key,
   292|             'width' => $field['width'],
   293|             'position' => $field['position'],
   294|             'language' => $field['fieldConfig']['language'] ?? null,
   295|             'layout' => $field['fieldConfig']['layout'] ?? null,
   296|         ];
   297|         if (isset($field['locked'])) {
   298|             $result['locked'] = $field['locked'];
   299|         }
   300|         if ($type === 'select' && $predefined) {
   301|             $field['fieldConfig']['layout']['config'] = $predefined->getConfig();
   302|             $result['layout'] = $field['fieldConfig']['layout'];
   303|         } elseif ($type === 'document' || $type === 'asset' || $type === 'object') {
   304|             $result['layout']['fieldtype'] = 'manyToOneRelation';
   305|             $result['layout']['subtype'] = $type;
   306|         }
   307|         return $result;
   308|     }
   309|     /**
   310|      * @param bool $noSystemColumns
   311|      * @param array $fields
   312|      * @param array $context
   313|      * @param array $types
   314|      *
   315|      * @return array
   316|      */
   317|     public function getDefaultGridFields($noSystemColumns, $fields, $context, $types = [])
   318|     {
   319|         $count = 0;
   320|         $availableFields = [];
   321|         if (!$noSystemColumns) {
   322|             foreach (Asset\Service::GRID_SYSTEM_COLUMNS as $sc) {
   323|                 if (empty($types)) {
   324|                     $availableFields[] = [
   325|                         'key' => $sc . '~system',
   326|                         'type' => 'system',
   327|                         'label' => $sc,
   328|                         'position' => $count, ];
   329|                     $count++;
   330|                 }
   331|             }
   332|         }
   333|         return $availableFields;
   334|     }
   335|     /**
   336|      * @Route("/prepare-helper-column-configs", name="pimcore_admin_asset_assethelper_preparehelpercolumnconfigs", methods={"POST"})
   337|      *
   338|      * @param Request $request
   339|      *
   340|      * @return JsonResponse
   341|      */
   342|     public function prepareHelperColumnConfigs(Request $request)
   343|     {
   344|         $helperColumns = [];
   345|         $newData = [];
   346|         $data = json_decode($request->get('columns'));
   347|         /** @var \stdClass $item */
   348|         foreach ($data as $item) {
   349|             if (!empty($item->isOperator)) {
   350|                 $itemKey = '#' . uniqid();
   351|                 $item->key = $itemKey;
   352|                 $newData[] = $item;
   353|                 $helperColumns[$itemKey] = $item;
   354|             } else {
   355|                 $newData[] = $item;
   356|             }
   357|         }
   358|         Tool\Session::useSession(function (AttributeBagInterface $session) use ($helperColumns) {
   359|             $existingColumns = $session->get('helpercolumns', []);
   360|             $helperColumns = array_merge($helperColumns, $existingColumns);
   361|             $session->set('helpercolumns', $helperColumns);
   362|         }, 'pimcore_gridconfig');
   363|         return $this->adminJson(['success' => true, 'columns' => $newData]);
   364|     }
   365|     /**
   366|      * @Route("/grid-mark-favourite-column-config", name="pimcore_admin_asset_assethelper_gridmarkfavouritecolumnconfig", methods={"POST"})
   367|      *
   368|      * @param Request $request
   369|      *
   370|      * @return JsonResponse
   371|      */
   372|     public function gridMarkFavouriteColumnConfigAction(Request $request)
   373|     {
   374|         $classId = $request->get('classId');
   375|         $asset = Asset::getById($classId);
   376|         if ($asset->isAllowed('list')) {
   377|             $gridConfigId = $request->get('gridConfigId');
   378|             $searchType = $request->get('searchType');
   379|             $type = $request->get('type');
   380|             $user = $this->getAdminUser();
   381|             $favourite = new GridConfigFavourite();
   382|             $favourite->setOwnerId($user->getId());
   383|             $favourite->setClassId($classId);
   384|             $favourite->setSearchType($searchType);
   385|             $favourite->setType($type);
   386|             $specializedConfigs = false;
   387|             try {
   388|                 if ($gridConfigId != 0) {
   389|                     $gridConfig = GridConfig::getById($gridConfigId);
   390|                     $favourite->setGridConfigId($gridConfig->getId());
   391|                 }
   392|                 $favourite->setObjectId(0);
   393|                 $favourite->save();
   394|             } catch (\Exception $e) {
   395|                 $favourite->delete();
   396|             }
   397|             return $this->adminJson(['success' => true, 'spezializedConfigs' => $specializedConfigs]);
   398|         }
   399|         throw $this->createAccessDeniedHttpException();
   400|     }
   401|     /**
   402|      * @param int $gridConfigId
   403|      *
   404|      * @return array
   405|      */
   406|     protected function getShareSettings($gridConfigId)
   407|     {
   408|         $result = [
   409|             'sharedUserIds' => [],
   410|             'sharedRoleIds' => [],
   411|         ];
   412|         $db = Db::get();
   413|         $allShares = $db->fetchAll('select s.sharedWithUserId, u.type from gridconfig_shares s, users u
   414|                       where s.sharedWithUserId = u.id and s.gridConfigId = ' . $gridConfigId);
   415|         if ($allShares) {
   416|             foreach ($allShares as $share) {
   417|                 $type = $share['type'];
   418|                 $key = 'shared' . ucfirst($type) . 'Ids';
   419|                 $result[$key][] = $share['sharedWithUserId'];
   420|             }
   421|         }
   422|         foreach ($result as $idx => $value) {
   423|             $value = $value ? implode(',', $value) : '';
   424|             $result[$idx] = $value;
   425|         }
   426|         return $result;
   427|     }
   428|     /**
   429|      * @Route("/grid-save-column-config", name="pimcore_admin_asset_assethelper_gridsavecolumnconfig", methods={"POST"})
   430|      *
   431|      * @param Request $request
   432|      *
   433|      * @return JsonResponse
   434|      */
   435|     public function gridSaveColumnConfigAction(Request $request)
   436|     {
   437|         $asset = Asset::getById($request->get('id'));
   438|         if ($asset->isAllowed('list')) {
   439|             try {
   440|                 $classId = $request->get('class_id');
   441|                 $context = $request->get('context');
   442|                 $searchType = $request->get('searchType');
   443|                 $type = $request->get('type');
   444|                 $gridConfigData = $this->decodeJson($request->get('gridconfig'));
   445|                 $gridConfigData['pimcore_version'] = Version::getVersion();
   446|                 $gridConfigData['pimcore_revision'] = Version::getRevision();
   447|                 $gridConfigData['context'] = $context;
   448|                 unset($gridConfigData['settings']['isShared']);
   449|                 $metadata = $request->get('settings');
   450|                 $metadata = json_decode($metadata, true);
   451|                 $gridConfigId = $metadata['gridConfigId'];
   452|                 $gridConfig = null;
   453|                 if ($gridConfigId) {
   454|                     try {
   455|                         $gridConfig = GridConfig::getById($gridConfigId);
   456|                     } catch (\Exception $e) {
   457|                     }
   458|                 }
   459|                 if ($gridConfig && $gridConfig->getOwnerId() != $this->getAdminUser()->getId()) {
   460|                     throw new \Exception("don't mess around with somebody else's configuration");
   461|                 }
   462|                 $this->updateGridConfigShares($gridConfig, $metadata);
   463|                 if (!$gridConfig) {
   464|                     $gridConfig = new GridConfig();
   465|                     $gridConfig->setName(date('c'));
   466|                     $gridConfig->setClassId($classId);
   467|                     $gridConfig->setSearchType($searchType);
   468|                     $gridConfig->setType($type);
   469|                     $gridConfig->setOwnerId($this->getAdminUser()->getId());
   470|                 }
   471|                 if ($metadata) {
   472|                     $gridConfig->setName($metadata['gridConfigName']);
   473|                     $gridConfig->setDescription($metadata['gridConfigDescription']);
   474|                     $gridConfig->setShareGlobally($metadata['shareGlobally'] && $this->getAdminUser()->isAdmin());
   475|                 }
   476|                 $gridConfigData = json_encode($gridConfigData);
   477|                 $gridConfig->setConfig($gridConfigData);
   478|                 $gridConfig->save();
   479|                 $userId = $this->getAdminUser()->getId();
   480|                 $availableConfigs = $this->getMyOwnGridColumnConfigs($userId, $classId, $searchType);
   481|                 $sharedConfigs = $this->getSharedGridColumnConfigs($this->getAdminUser(), $classId, $searchType);
   482|                 $settings = $this->getShareSettings($gridConfig->getId());
   483|                 $settings['gridConfigId'] = (int)$gridConfig->getId();
   484|                 $settings['gridConfigName'] = $gridConfig->getName();
   485|                 $settings['gridConfigDescription'] = $gridConfig->getDescription();
   486|                 $settings['shareGlobally'] = $gridConfig->isShareGlobally();
   487|                 $settings['isShared'] = $gridConfig->getOwnerId() != $this->getAdminUser()->getId();
   488|                 return $this->adminJson([
   489|                     'success' => true,
   490|                     'settings' => $settings,
   491|                     'availableConfigs' => $availableConfigs,
   492|                     'sharedConfigs' => $sharedConfigs,
   493|                 ]);
   494|             } catch (\Exception $e) {
   495|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   496|             }
   497|         }
   498|         throw $this->createAccessDeniedHttpException();
   499|     }
   500|     /**
   501|      * @param GridConfig|null $gridConfig
   502|      * @param array $metadata
   503|      *
   504|      * @throws \Exception
   505|      */
   506|     protected function updateGridConfigShares($gridConfig, $metadata)
   507|     {
   508|         $user = $this->getAdminUser();
   509|         if (!$gridConfig || !$user->isAllowed('share_configurations')) {
   510|             return;
   511|         }
   512|         if ($gridConfig->getOwnerId() != $this->getAdminUser()->getId()) {
   513|             throw new \Exception("don't mess with someone elses grid config");
   514|         }
   515|         $combinedShares = [];
   516|         $sharedUserIds = $metadata['sharedUserIds'];
   517|         $sharedRoleIds = $metadata['sharedRoleIds'];
   518|         if ($sharedUserIds) {
   519|             $combinedShares = explode(',', $sharedUserIds);
   520|         }
   521|         if ($sharedRoleIds) {
   522|             $sharedRoleIds = explode(',', $sharedRoleIds);
   523|             $combinedShares = array_merge($combinedShares, $sharedRoleIds);
   524|         }
   525|         $db = Db::get();
   526|         $db->delete('gridconfig_shares', ['gridConfigId' => $gridConfig->getId()]);
   527|         foreach ($combinedShares as $id) {
   528|             $share = new GridConfigShare();
   529|             $share->setGridConfigId($gridConfig->getId());
   530|             $share->setSharedWithUserId($id);
   531|             $share->save();
   532|         }
   533|     }
   534|     /**
   535|      * @Route("/get-export-jobs", name="pimcore_admin_asset_assethelper_getexportjobs", methods={"GET"})
   536|      *
   537|      * @param Request $request
   538|      * @param GridHelperService $gridHelperService
   539|      *
   540|      * @return JsonResponse
   541|      */
   542|     public function getExportJobsAction(Request $request, GridHelperService $gridHelperService)
   543|     {
   544|         $allParams = array_merge($request->request->all(), $request->query->all());
   545|         $list = $gridHelperService->prepareAssetListingForGrid($allParams, $this->getAdminUser());
   546|         if (empty($ids = $allParams['ids'] ?? '')) {
   547|             $ids = $list->loadIdList();
   548|         }
   549|         $jobs = array_chunk($ids, 20);
   550|         $fileHandle = uniqid('asset-export-');
   551|         file_put_contents($this->getCsvFile($fileHandle), '');
   552|         return $this->adminJson(['success' => true, 'jobs' => $jobs, 'fileHandle' => $fileHandle]);
   553|     }
   554|     /**
   555|      * @Route("/do-export", name="pimcore_admin_asset_assethelper_doexport", methods={"POST"})
   556|      *
   557|      * @param Request $request
   558|      * @param LocaleServiceInterface $localeService
   559|      *
   560|      * @return JsonResponse
   561|      */
   562|     public function doExportAction(Request $request, LocaleServiceInterface $localeService)
   563|     {
   564|         $fileHandle = \Pimcore\File::getValidFilename($request->get('fileHandle'));
   565|         $ids = $request->get('ids');
   566|         $settings = $request->get('settings');
   567|         $settings = json_decode($settings, true);
   568|         $delimiter = $settings['delimiter'] ? $settings['delimiter'] : ';';
   569|         $language = str_replace('default', '', $request->get('language'));
   570|         $list = new Asset\Listing();
   571|         $quotedIds = [];
   572|         foreach ($ids as $id) {
   573|             $quotedIds[] = $list->quote($id);
   574|         }
   575|         $list->setCondition('id IN (' . implode(',', $quotedIds) . ')');
   576|         $list->setOrderKey(' FIELD(id, ' . implode(',', $quotedIds) . ')', false);
   577|         $fields = $request->get('fields');
   578|         $addTitles = $request->get('initial');
   579|         $csv = $this->getCsvData($request, $language, $list, $fields, $addTitles);
   580|         $fp = fopen($this->getCsvFile($fileHandle), 'a');
   581|         $firstLine = true;
   582|         foreach ($csv as $line) {
   583|             if ($addTitles && $firstLine) {
   584|                 $firstLine = false;
   585|                 $line = implode($delimiter, $line) . "\r\n";
   586|                 fwrite($fp, $line);
   587|             } else {
   588|                 fwrite($fp, implode($delimiter, array_map([$this, 'encodeFunc'], $line)) . "\r\n");
   589|             }
   590|         }
   591|         fclose($fp);
   592|         return $this->adminJson(['success' => true]);
   593|     }
   594|     public function encodeFunc($value)
   595|     {
   596|         $value = str_replace('"', '""', $value);
   597|         return '"' . $value . '"';
   598|     }
   599|     /**
   600|      * @param Request $request
   601|      * @param string $language
   602|      * @param Asset\Listing $list
   603|      * @param array $fields
   604|      * @param bool $addTitles
   605|      *
   606|      * @return array
   607|      */
   608|     protected function getCsvData(Request $request, $language, $list, $fields, $addTitles = true)
   609|     {
   610|         $csv = [];
   611|         $unsupportedFields = ['preview~system', 'size~system'];
   612|         $fields = array_diff($fields, $unsupportedFields);
   613|         if ($addTitles) {
   614|             $columns = $fields;
   615|             foreach ($columns as $columnIdx => $columnKey) {
   616|                 $columns[$columnIdx] = '"' . $columnKey . '"';
   617|             }
   618|             $csv[] = $columns;
   619|         }
   620|         foreach ($list->load() as $asset) {
   621|             if ($fields) {
   622|                 $dataRows = [];
   623|                 foreach ($fields as $field) {
   624|                     $fieldDef = explode('~', $field);
   625|                     $getter = 'get' . ucfirst($fieldDef[0]);
   626|                     if (isset($fieldDef[1])) {
   627|                         if ($fieldDef[1] == 'system' && method_exists($asset, $getter)) {
   628|                             $data = $asset->$getter($language);
   629|                         } else {
   630|                             $fieldDef[1] = str_replace('none', '', $fieldDef[1]);
   631|                             $data = $asset->getMetadata($fieldDef[0], $fieldDef[1], true);
   632|                         }
   633|                     } else {
   634|                         $data = $asset->getMetadata($field, $language, true);
   635|                     }
   636|                     if ($data instanceof Element\ElementInterface) {
   637|                         $data = $data->getRealFullPath();
   638|                     }
   639|                     $dataRows[] = $data;
   640|                 }
   641|                 $csv[] = $dataRows;
   642|             }
   643|         }
   644|         return $csv;
   645|     }
   646|     /**
   647|      * @param Request $request
   648|      *
   649|      * @return mixed|string
   650|      */
   651|     protected function extractLanguage(Request $request)
   652|     {
   653|         $requestedLanguage = $request->get('language');
   654|         if ($requestedLanguage) {
   655|             if ($requestedLanguage != 'default') {
   656|                 $request->setLocale($requestedLanguage);
   657|             }
   658|         } else {
   659|             $requestedLanguage = $request->getLocale();
   660|         }
   661|         return $requestedLanguage;
   662|     }
   663|     /**
   664|      * @param string $fileHandle
   665|      *
   666|      * @return string
   667|      */
   668|     protected function getCsvFile($fileHandle)
   669|     {
   670|         return PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . $fileHandle . '.csv';
   671|     }
   672|     /**
   673|      * @Route("/download-csv-file", name="pimcore_admin_asset_assethelper_downloadcsvfile", methods={"GET"})
   674|      *
   675|      * @param Request $request
   676|      *
   677|      * @return BinaryFileResponse
   678|      */
   679|     public function downloadCsvFileAction(Request $request)
   680|     {
   681|         $fileHandle = \Pimcore\File::getValidFilename($request->get('fileHandle'));
   682|         $csvFile = $this->getCsvFile($fileHandle);
   683|         if (file_exists($csvFile)) {
   684|             $response = new BinaryFileResponse($csvFile);
   685|             $response->headers->set('Content-Type', 'application/csv');
   686|             $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, 'export.csv');
   687|             $response->deleteFileAfterSend(true);
   688|             return $response;
   689|         }
   690|         throw $this->createNotFoundException('CSV file not found');
   691|     }
   692|     /**
   693|      * @Route("/download-xlsx-file", name="pimcore_admin_asset_assethelper_downloadxlsxfile", methods={"GET"})
   694|      *
   695|      * @param Request $request
   696|      *
   697|      * @return BinaryFileResponse
   698|      */
   699|     public function downloadXlsxFileAction(Request $request)
   700|     {
   701|         $fileHandle = \Pimcore\File::getValidFilename($request->get('fileHandle'));
   702|         $csvFile = $this->getCsvFile($fileHandle);
   703|         if (file_exists($csvFile)) {
   704|             $csvReader = new Csv();
   705|             $csvReader->setDelimiter(';');
   706|             $csvReader->setSheetIndex(0);
   707|             $spreadsheet = $csvReader->load($csvFile);
   708|             $writer = new Xlsx($spreadsheet);
   709|             $xlsxFilename = PIMCORE_SYSTEM_TEMP_DIRECTORY. '/' .$fileHandle. '.xlsx';
   710|             $writer->save($xlsxFilename);
   711|             $response = new BinaryFileResponse($xlsxFilename);
   712|             $response->headers->set('Content-Type', 'application/xlsx');
   713|             $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, 'export.xlsx');
   714|             $response->deleteFileAfterSend(true);
   715|             return $response;
   716|         }
   717|         throw $this->createNotFoundException('XLSX file not found');
   718|     }
   719|     /**
   720|      * @Route("/get-metadata-for-column-config", name="pimcore_admin_asset_assethelper_getmetadataforcolumnconfig", methods={"GET"})
   721|      *
   722|      * @param Request $request
   723|      *
   724|      * @return JsonResponse
   725|      */
   726|     public function getMetadataForColumnConfigAction(Request $request)
   727|     {
   728|         $result = [];
   729|         $defaultMetadataNames = ['copyright', 'alt', 'title'];
   730|         foreach ($defaultMetadataNames as $defaultMetadata) {
   731|             $defaultColumns[] = ['title' => $defaultMetadata, 'name' => $defaultMetadata, 'datatype' => 'data', 'fieldtype' => 'input'];
   732|         }
   733|         $result['defaultColumns']['nodeLabel'] = 'default_metadata';
   734|         $result['defaultColumns']['nodeType'] = 'image';
   735|         $result['defaultColumns']['childs'] = $defaultColumns;
   736|         $list = Metadata\Predefined\Listing::getByTargetType('asset', null);
   737|         $metadataItems = [];
   738|         $tmp = [];
   739|         foreach ($list as $item) {
   740|             $uniqueKey = $item->getName().'_'.$item->getTargetSubtype();
   741|             if (!in_array($uniqueKey, $tmp) && !in_array($item->getName(), $defaultMetadataNames)) {
   742|                 $tmp[] = $uniqueKey;
   743|                 $item->expand();
   744|                 $metadataItems[] = [
   745|                     'title' => $item->getName(),
   746|                     'name' => $item->getName(),
   747|                     'subtype' => $item->getTargetSubtype(),
   748|                     'datatype' => 'data',
   749|                     'fieldtype' => $item->getType(),
   750|                     'config' => $item->getConfig(),
   751|                 ];
   752|             }
   753|         }
   754|         $result['metadataColumns']['childs'] = $metadataItems;
   755|         $result['metadataColumns']['nodeLabel'] = 'predefined_metadata';
   756|         $result['metadataColumns']['nodeType'] = 'metadata';
   757|         $systemColumnNames = Asset\Service::GRID_SYSTEM_COLUMNS;
   758|         $systemColumns = [];
   759|         foreach ($systemColumnNames as $systemColumn) {
   760|             $systemColumns[] = ['title' => $systemColumn, 'name' => $systemColumn, 'datatype' => 'data', 'fieldtype' => 'system'];
   761|         }
   762|         $result['systemColumns']['nodeLabel'] = 'system_columns';
   763|         $result['systemColumns']['nodeType'] = 'system';
   764|         $result['systemColumns']['childs'] = $systemColumns;
   765|         return $this->adminJson($result);
   766|     }
   767|     /**
   768|      * @Route("/get-batch-jobs", name="pimcore_admin_asset_assethelper_getbatchjobs", methods={"GET"})
   769|      *
   770|      * @param Request $request
   771|      *
   772|      * @return JsonResponse
   773|      */
   774|     public function getBatchJobsAction(Request $request, GridHelperService $gridHelperService)
   775|     {
   776|         if ($request->get('language')) {
   777|             $request->setLocale($request->get('language'));
   778|         }
   779|         $allParams = array_merge($request->request->all(), $request->query->all());
   780|         $list = $gridHelperService->prepareAssetListingForGrid($allParams, $this->getAdminUser());
   781|         $jobs = $list->loadIdList();
   782|         return $this->adminJson(['success' => true, 'jobs' => $jobs]);
   783|     }
   784|     /**
   785|      * @Route("/batch", name="pimcore_admin_asset_assethelper_batch", methods={"PUT"})
   786|      *
   787|      * @param Request $request
   788|      * @param EventDispatcherInterface $eventDispatcher
   789|      *
   790|      * @return JsonResponse
   791|      */
   792|     public function batchAction(Request $request, EventDispatcherInterface $eventDispatcher)
   793|     {
   794|         try {
   795|             if ($request->get('data')) {
   796|                 $loader = \Pimcore::getContainer()->get('pimcore.implementation_loader.asset.metadata.data');
   797|                 $data = $this->decodeJson($request->get('data'), true);
   798|                 $updateEvent = new GenericEvent($this, [
   799|                     'data' => $data,
   800|                     'processed' => false,
   801|                 ]);
   802|                 $eventDispatcher->dispatch($updateEvent, AdminEvents::ASSET_LIST_BEFORE_BATCH_UPDATE);
   803|                 $processed = $updateEvent->getArgument('processed');
   804|                 if ($processed) {
   805|                     return $this->adminJson(['success' => true]);
   806|                 }
   807|                 $language = null;
   808|                 if (isset($data['language'])) {
   809|                     $language = $data['language'] != 'default' ? $data['language'] : null;
   810|                 }
   811|                 $asset = Asset::getById($data['job']);
   812|                 if ($asset) {
   813|                     if (!$asset->isAllowed('publish')) {
   814|                         throw new \Exception("Permission denied. You don't have the rights to save this asset.");
   815|                     }
   816|                     $metadata = $asset->getMetadata(null, null, false, true);
   817|                     $dirty = false;
   818|                     $name = $data['name'];
   819|                     $value = $data['value'];
   820|                     if ($data['valueType'] == 'object') {
   821|                         $value = $this->decodeJson($value);
   822|                     }
   823|                     $fieldDef = explode('~', $name);
   824|                     $name = $fieldDef[0];
   825|                     if (count($fieldDef) > 1) {
   826|                         $language = ($fieldDef[1] == 'none' ? '' : $fieldDef[1]);
   827|                     }
   828|                     foreach ($metadata as $idx => &$em) {
   829|                         if ($em['name'] == $name && $em['language'] == $language) {
   830|                             try {
   831|                                 $dataImpl = $loader->build($em['type']);
   832|                                 $value = $dataImpl->getDataFromListfolderGrid($value, $em);
   833|                             } catch (UnsupportedException $le) {
   834|                                 Logger::error('could not resolve metadata implementation for ' . $em['type']);
   835|                             }
   836|                             $em['data'] = $value;
   837|                             $dirty = true;
   838|                             break;
   839|                         }
   840|                     }
   841|                     if (!$dirty) {
   842|                         $defaulMetadata = ['title', 'alt', 'copyright'];
   843|                         if (in_array($name, $defaulMetadata)) {
   844|                             $newEm = [
   845|                                 'name' => $name,
   846|                                 'language' => $language,
   847|                                 'type' => 'input',
   848|                                 'data' => $value,
   849|                             ];
   850|                             try {
   851|                                 $dataImpl = $loader->build($newEm['type']);
   852|                                 $newEm['data'] = $dataImpl->getDataFromListfolderGrid($value, $newEm);
   853|                             } catch (UnsupportedException $le) {
   854|                                 Logger::error('could not resolve metadata implementation for ' . $newEm['type']);
   855|                             }
   856|                             $metadata[] = $newEm;
   857|                             $dirty = true;
   858|                         } else {
   859|                             $predefined = Metadata\Predefined::getByName($name);
   860|                             if ($predefined && (empty($predefined->getTargetSubtype())
   861|                                     || $predefined->getTargetSubtype() == $asset->getType())) {
   862|                                 $newEm = [
   863|                                     'name' => $name,
   864|                                     'language' => $language,
   865|                                     'type' => $predefined->getType(),
   866|                                     'data' => $value,
   867|                                 ];
   868|                                 try {
   869|                                     $dataImpl = $loader->build($newEm['type']);
   870|                                     $newEm['data'] = $dataImpl->getDataFromListfolderGrid($value, $newEm);
   871|                                 } catch (UnsupportedException $le) {
   872|                                     Logger::error('could not resolve metadata implementation for ' . $newEm['type']);
   873|                                 }
   874|                                 $metadata[] = $newEm;
   875|                                 $dirty = true;
   876|                             }
   877|                         }
   878|                     }
   879|                     try {
   880|                         if ($dirty) {
   881|                             $asset->setMetadataRaw($metadata);
   882|                             $asset->save();
   883|                             return $this->adminJson(['success' => true]);
   884|                         }
   885|                     } catch (\Exception $e) {
   886|                         return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   887|                     }
   888|                 } else {
   889|                     Logger::debug('AssetHelperController::batchAction => There is no asset left to update.');
   890|                     return $this->adminJson(['success' => false, 'message' => 'AssetHelperController::batchAction => There is no asset left to update.']);
   891|                 }
   892|             }
   893|         } catch (\Exception $e) {
   894|             Logger::err($e);
   895|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   896|         }
   897|         return $this->adminJson(['success' => false, 'message' => 'something went wrong.']);
   898|     }
   899| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/DataObject/ClassController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1567 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\DataObject;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Pimcore\Db;
    19| use Pimcore\Event\AdminEvents;
    20| use Pimcore\Logger;
    21| use Pimcore\Model\Asset;
    22| use Pimcore\Model\DataObject;
    23| use Pimcore\Model\Document;
    24| use Pimcore\Model\Translation;
    25| use Pimcore\Tool\Session;
    26| use Symfony\Component\EventDispatcher\GenericEvent;
    27| use Symfony\Component\HttpFoundation\Request;
    28| use Symfony\Component\HttpFoundation\Response;
    29| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    30| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    31| use Symfony\Component\Routing\Annotation\Route;
    32| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    33| /**
    34|  * @Route("/class")
    35|  *
    36|  * @internal
    37|  */
    38| class ClassController extends AdminController implements KernelControllerEventInterface
    39| {
    40|     /**
    41|      * @Route("/get-document-types", name="pimcore_admin_dataobject_class_getdocumenttypes", methods={"GET"})
    42|      *
    43|      * @param Request $request
    44|      *
    45|      * @return JsonResponse
    46|      */
    47|     public function getDocumentTypesAction(Request $request)
    48|     {
    49|         $documentTypes = Document::getTypes();
    50|         $typeItems = [];
    51|         foreach ($documentTypes as $documentType) {
    52|             $typeItems[] = [
    53|                 'text' => $documentType,
    54|             ];
    55|         }
    56|         return $this->adminJson($typeItems);
    57|     }
    58|     /**
    59|      * @Route("/get-asset-types", name="pimcore_admin_dataobject_class_getassettypes", methods={"GET"})
    60|      *
    61|      * @param Request $request
    62|      *
    63|      * @return JsonResponse
    64|      */
    65|     public function getAssetTypesAction(Request $request)
    66|     {
    67|         $assetTypes = Asset::getTypes();
    68|         $typeItems = [];
    69|         foreach ($assetTypes as $assetType) {
    70|             $typeItems[] = [
    71|                 'text' => $assetType,
    72|             ];
    73|         }
    74|         return $this->adminJson($typeItems);
    75|     }
    76|     /**
    77|      * @Route("/get-tree", name="pimcore_admin_dataobject_class_gettree", methods={"GET", "POST"})
    78|      *
    79|      * @param Request $request
    80|      *
    81|      * @return JsonResponse
    82|      */
    83|     public function getTreeAction(Request $request)
    84|     {
    85|         $defaultIcon = '/bundles/pimcoreadmin/img/flat-color-icons/class.svg';
    86|         $classesList = new DataObject\ClassDefinition\Listing();
    87|         $classesList->setOrderKey('name');
    88|         $classesList->setOrder('asc');
    89|         $classes = $classesList->load();
    90|         if ($request->get('createAllowed')) {
    91|             $tmpClasses = [];
    92|             foreach ($classes as $class) {
    93|                 if ($this->getAdminUser()->isAllowed($class->getId(), 'class')) {
    94|                     $tmpClasses[] = $class;
    95|                 }
    96|             }
    97|             $classes = $tmpClasses;
    98|         }
    99|         $withId = $request->get('withId');
   100|         $getClassConfig = function ($class) use ($defaultIcon, $withId) {
   101|             $text = $class->getname();
   102|             if ($withId) {
   103|                 $text .= ' (' . $class->getId() . ')';
   104|             }
   105|             return [
   106|                 'id' => $class->getId(),
   107|                 'text' => $text,
   108|                 'leaf' => true,
   109|                 'icon' => $class->getIcon() ? $class->getIcon() : $defaultIcon,
   110|                 'cls' => 'pimcore_class_icon',
   111|                 'propertyVisibility' => $class->getPropertyVisibility(),
   112|                 'enableGridLocking' => $class->isEnableGridLocking(),
   113|             ];
   114|         };
   115|         $groups = [];
   116|         foreach ($classes as $class) {
   117|             $groupName = null;
   118|             if ($class->getGroup()) {
   119|                 $type = 'manual';
   120|                 $groupName = $class->getGroup();
   121|             } else {
   122|                 $type = 'auto';
   123|                 if (preg_match('@^([A-Za-z])([^A-Z]+)@', $class->getName(), $matches)) {
   124|                     $groupName = $matches[0];
   125|                 }
   126|                 if (!$groupName) {
   127|                     $groupName = $class->getName();
   128|                 }
   129|             }
   130|             $groupName = Translation::getByKeyLocalized($groupName, Translation::DOMAIN_ADMIN, true, true);
   131|             if (!isset($groups[$groupName])) {
   132|                 $groups[$groupName] = [
   133|                     'classes' => [],
   134|                     'type' => $type,
   135|                 ];
   136|             }
   137|             $groups[$groupName]['classes'][] = $class;
   138|         }
   139|         $treeNodes = [];
   140|         if (!empty($groups)) {
   141|             $types = array_column($groups, 'type');
   142|             array_multisort($types, SORT_ASC, array_keys($groups), SORT_ASC, $groups);
   143|         }
   144|         if (!$request->get('grouped')) {
   145|             foreach ($groups as $groupName => $groupData) {
   146|                 foreach ($groupData['classes'] as $class) {
   147|                     $node = $getClassConfig($class);
   148|                     if (count($groupData['classes']) > 1 || $groupData['type'] == 'manual') {
   149|                         $node['group'] = $groupName;
   150|                     }
   151|                     $treeNodes[] = $node;
   152|                 }
   153|             }
   154|         } else {
   155|             foreach ($groups as $groupName => $groupData) {
   156|                 if (count($groupData['classes']) === 1 && $groupData['type'] == 'auto') {
   157|                     $node = $getClassConfig($groupData['classes'][0]);
   158|                 } else {
   159|                     $node = [
   160|                         'id' => 'folder_' . $groupName,
   161|                         'text' => $groupName,
   162|                         'leaf' => false,
   163|                         'expandable' => true,
   164|                         'allowChildren' => true,
   165|                         'iconCls' => 'pimcore_icon_folder',
   166|                         'children' => [],
   167|                     ];
   168|                     foreach ($groupData['classes'] as $class) {
   169|                         $node['children'][] = $getClassConfig($class);
   170|                     }
   171|                 }
   172|                 $treeNodes[] = $node;
   173|             }
   174|         }
   175|         return $this->adminJson($treeNodes);
   176|     }
   177|     /**
   178|      * @Route("/get", name="pimcore_admin_dataobject_class_get", methods={"GET"})
   179|      *
   180|      * @param Request $request
   181|      *
   182|      * @return JsonResponse
   183|      */
   184|     public function getAction(Request $request)
   185|     {
   186|         $class = DataObject\ClassDefinition::getById($request->get('id'));
   187|         $class->setFieldDefinitions([]);
   188|         $isWriteable = $class->isWritable();
   189|         $class = $class->getObjectVars();
   190|         $class['isWriteable'] = $isWriteable;
   191|         return $this->adminJson($class);
   192|     }
   193|     /**
   194|      * @Route("/get-custom-layout", name="pimcore_admin_dataobject_class_getcustomlayout", methods={"GET"})
   195|      *
   196|      * @param Request $request
   197|      *
   198|      * @return JsonResponse
   199|      */
   200|     public function getCustomLayoutAction(Request $request)
   201|     {
   202|         $customLayout = DataObject\ClassDefinition\CustomLayout::getById($request->get('id'));
   203|         $isWriteable = $customLayout->isWritable();
   204|         $customLayout = $customLayout->getObjectVars();
   205|         $customLayout['isWriteable'] = $isWriteable;
   206|         return $this->adminJson(['success' => true, 'data' => $customLayout]);
   207|     }
   208|     /**
   209|      * @Route("/add", name="pimcore_admin_dataobject_class_add", methods={"POST"})
   210|      *
   211|      * @param Request $request
   212|      *
   213|      * @return JsonResponse
   214|      */
   215|     public function addAction(Request $request)
   216|     {
   217|         $className = $request->get('className');
   218|         $className = $this->correctClassname($className);
   219|         $classId = $request->get('classIdentifier');
   220|         $existingClass = DataObject\ClassDefinition::getById($classId);
   221|         if ($existingClass) {
   222|             throw new \Exception('Class identifier already exists');
   223|         }
   224|         $class = DataObject\ClassDefinition::create(
   225|             ['name' => $className,
   226|                 'userOwner' => $this->getAdminUser()->getId(), ]
   227|         );
   228|         $class->setId($classId);
   229|         $class->save(true);
   230|         return $this->adminJson(['success' => true, 'id' => $class->getId()]);
   231|     }
   232|     /**
   233|      * @Route("/add-custom-layout", name="pimcore_admin_dataobject_class_addcustomlayout", methods={"POST"})
   234|      *
   235|      * @param Request $request
   236|      *
   237|      * @return JsonResponse
   238|      */
   239|     public function addCustomLayoutAction(Request $request)
   240|     {
   241|         $layoutId = $request->get('layoutIdentifier');
   242|         $existingLayout = DataObject\ClassDefinition\CustomLayout::getById($layoutId);
   243|         if ($existingLayout) {
   244|             throw new \Exception('Custom Layout identifier already exists');
   245|         }
   246|         $customLayout = DataObject\ClassDefinition\CustomLayout::create(
   247|             [
   248|                 'name' => $request->get('layoutName'),
   249|                 'userOwner' => $this->getAdminUser()->getId(),
   250|                 'classId' => $request->get('classId'),
   251|             ]
   252|         );
   253|         $customLayout->setId($layoutId);
   254|         $customLayout->save();
   255|         $isWriteable = $customLayout->isWritable();
   256|         $data = $customLayout->getObjectVars();
   257|         $data['isWriteable'] = $isWriteable;
   258|         return $this->adminJson(['success' => true, 'id' => $customLayout->getId(), 'name' => $customLayout->getName(),
   259|                                  'data' => $data, ]);
   260|     }
   261|     /**
   262|      * @Route("/delete", name="pimcore_admin_dataobject_class_delete", methods={"DELETE"})
   263|      *
   264|      * @param Request $request
   265|      *
   266|      * @return Response
   267|      */
   268|     public function deleteAction(Request $request)
   269|     {
   270|         $class = DataObject\ClassDefinition::getById($request->get('id'));
   271|         $class->delete();
   272|         return new Response();
   273|     }
   274|     /**
   275|      * @Route("/delete-custom-layout", name="pimcore_admin_dataobject_class_deletecustomlayout", methods={"DELETE"})
   276|      *
   277|      * @param Request $request
   278|      *
   279|      * @return JsonResponse
   280|      */
   281|     public function deleteCustomLayoutAction(Request $request)
   282|     {
   283|         $customLayout = DataObject\ClassDefinition\CustomLayout::getById($request->get('id'));
   284|         if ($customLayout) {
   285|             $customLayout->delete();
   286|         }
   287|         return $this->adminJson(['success' => true]);
   288|     }
   289|     /**
   290|      * @Route("/save-custom-layout", name="pimcore_admin_dataobject_class_savecustomlayout", methods={"PUT"})
   291|      *
   292|      * @param Request $request
   293|      *
   294|      * @return JsonResponse
   295|      */
   296|     public function saveCustomLayoutAction(Request $request)
   297|     {
   298|         $customLayout = DataObject\ClassDefinition\CustomLayout::getById($request->get('id'));
   299|         $class = DataObject\ClassDefinition::getById($customLayout->getClassId());
   300|         $configuration = $this->decodeJson($request->get('configuration'));
   301|         $values = $this->decodeJson($request->get('values'));
   302|         $modificationDate = (int)$values['modificationDate'];
   303|         if ($modificationDate < $customLayout->getModificationDate()) {
   304|             return $this->adminJson(['success' => false, 'msg' => 'custom_layout_changed']);
   305|         }
   306|         $configuration['datatype'] = 'layout';
   307|         $configuration['fieldtype'] = 'panel';
   308|         $configuration['name'] = 'pimcore_root';
   309|         try {
   310|             $layout = DataObject\ClassDefinition\Service::generateLayoutTreeFromArray($configuration, true);
   311|             $customLayout->setLayoutDefinitions($layout);
   312|             $customLayout->setName($values['name']);
   313|             $customLayout->setDescription($values['description']);
   314|             $customLayout->setDefault($values['default']);
   315|             $customLayout->save();
   316|             return $this->adminJson(['success' => true, 'id' => $customLayout->getId(), 'data' => $customLayout->getObjectVars()]);
   317|         } catch (\Exception $e) {
   318|             Logger::error($e->getMessage());
   319|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   320|         }
   321|     }
   322|     /**
   323|      * @Route("/save", name="pimcore_admin_dataobject_class_save", methods={"PUT"})
   324|      *
   325|      * @param Request $request
   326|      *
   327|      * @return JsonResponse
   328|      *
   329|      * @throws \Exception
   330|      */
   331|     public function saveAction(Request $request)
   332|     {
   333|         $class = DataObject\ClassDefinition::getById($request->get('id'));
   334|         $configuration = $this->decodeJson($request->get('configuration'));
   335|         $values = $this->decodeJson($request->get('values'));
   336|         if ($class->getModificationDate() != $values['modificationDate']) {
   337|             throw new \Exception('The class was modified during editing, please reload the class and make your changes again');
   338|         }
   339|         if ($values['name'] != $class->getName()) {
   340|             $classByName = DataObject\ClassDefinition::getByName($values['name']);
   341|             if ($classByName && $classByName->getId() != $class->getId()) {
   342|                 throw new \Exception('Class name already exists');
   343|             }
   344|             $values['name'] = $this->correctClassname($values['name']);
   345|             $class->rename($values['name']);
   346|         }
   347|         unset($values['creationDate']);
   348|         unset($values['userOwner']);
   349|         unset($values['layoutDefinitions']);
   350|         unset($values['fieldDefinitions']);
   351|         $configuration['datatype'] = 'layout';
   352|         $configuration['fieldtype'] = 'panel';
   353|         $configuration['name'] = 'pimcore_root';
   354|         $class->setValues($values);
   355|         try {
   356|             $layout = DataObject\ClassDefinition\Service::generateLayoutTreeFromArray($configuration, true);
   357|             $class->setLayoutDefinitions($layout);
   358|             $class->setUserModification($this->getAdminUser()->getId());
   359|             $class->setModificationDate(time());
   360|             $propertyVisibility = [];
   361|             foreach ($values as $key => $value) {
   362|                 if (preg_match('/propertyVisibility/i', $key)) {
   363|                     if (preg_match("/\.grid\./i", $key)) {
   364|                         $propertyVisibility['grid'][preg_replace("/propertyVisibility\.grid\./i", '', $key)] = (bool) $value;
   365|                     } elseif (preg_match("/\.search\./i", $key)) {
   366|                         $propertyVisibility['search'][preg_replace("/propertyVisibility\.search\./i", '', $key)] = (bool) $value;
   367|                     }
   368|                 }
   369|             }
   370|             if (!empty($propertyVisibility)) {
   371|                 $class->setPropertyVisibility($propertyVisibility);
   372|             }
   373|             $class->save();
   374|             $class->setFieldDefinitions([]);
   375|             return $this->adminJson(['success' => true, 'class' => $class]);
   376|         } catch (\Exception $e) {
   377|             Logger::error($e->getMessage());
   378|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   379|         }
   380|     }
   381|     /**
   382|      * @param string $name
   383|      *
   384|      * @return string
   385|      */
   386|     protected function correctClassname($name)
   387|     {
   388|         $name = preg_replace('/[^a-zA-Z0-9_]+/', '', $name);
   389|         $name = preg_replace('/^[0-9]+/', '', $name);
   390|         return $name;
   391|     }
   392|     /**
   393|      * @Route("/import-class", name="pimcore_admin_dataobject_class_importclass", methods={"POST", "PUT"})
   394|      *
   395|      * @param Request $request
   396|      *
   397|      * @return Response
   398|      */
   399|     public function importClassAction(Request $request)
   400|     {
   401|         $class = DataObject\ClassDefinition::getById($request->get('id'));
   402|         $json = file_get_contents($_FILES['Filedata']['tmp_name']);
   403|         $success = DataObject\ClassDefinition\Service::importClassDefinitionFromJson($class, $json, false, true);
   404|         $response = $this->adminJson([
   405|             'success' => $success,
   406|         ]);
   407|         $response->headers->set('Content-Type', 'text/html');
   408|         return $response;
   409|     }
   410|     /**
   411|      * @Route("/import-custom-layout-definition", name="pimcore_admin_dataobject_class_importcustomlayoutdefinition", methods={"POST", "PUT"})
   412|      *
   413|      * @param Request $request
   414|      *
   415|      * @return Response
   416|      */
   417|     public function importCustomLayoutDefinitionAction(Request $request)
   418|     {
   419|         $success = false;
   420|         $json = file_get_contents($_FILES['Filedata']['tmp_name']);
   421|         $importData = $this->decodeJson($json);
   422|         $customLayoutId = $request->get('id');
   423|         $customLayout = DataObject\ClassDefinition\CustomLayout::getById($customLayoutId);
   424|         if ($customLayout) {
   425|             try {
   426|                 $layout = DataObject\ClassDefinition\Service::generateLayoutTreeFromArray($importData['layoutDefinitions'], true);
   427|                 $customLayout->setLayoutDefinitions($layout);
   428|                 $customLayout->setDescription($importData['description']);
   429|                 $customLayout->save();
   430|                 $success = true;
   431|             } catch (\Exception $e) {
   432|                 Logger::error($e->getMessage());
   433|             }
   434|         }
   435|         $response = $this->adminJson([
   436|             'success' => $success,
   437|         ]);
   438|         $response->headers->set('Content-Type', 'text/html');
   439|         return $response;
   440|     }
   441|     /**
   442|      * @Route("/get-custom-layout-definitions", name="pimcore_admin_dataobject_class_getcustomlayoutdefinitions", methods={"GET"})
   443|      *
   444|      * @param Request $request
   445|      *
   446|      * @return JsonResponse
   447|      */
   448|     public function getCustomLayoutDefinitionsAction(Request $request)
   449|     {
   450|         $classId = $request->get('classId');
   451|         $list = new DataObject\ClassDefinition\CustomLayout\Listing();
   452|         $list->setCondition('classId = ' . $list->quote($classId));
   453|         $list = $list->load();
   454|         $result = [];
   455|         foreach ($list as $item) {
   456|             $result[] = [
   457|                 'id' => $item->getId(),
   458|                 'name' => $item->getName() . ' (ID: ' . $item->getId() . ')',
   459|                 'default' => $item->getDefault() ?: 0,
   460|             ];
   461|         }
   462|         return $this->adminJson(['success' => true, 'data' => $result]);
   463|     }
   464|     /**
   465|      * @Route("/get-all-layouts", name="pimcore_admin_dataobject_class_getalllayouts", methods={"GET"})
   466|      *
   467|      * @param Request $request
   468|      *
   469|      * @return JsonResponse
   470|      */
   471|     public function getAllLayoutsAction(Request $request)
   472|     {
   473|         $resultList = [];
   474|         $mapping = [];
   475|         $customLayouts = new DataObject\ClassDefinition\CustomLayout\Listing();
   476|         $customLayouts->setOrder('ASC');
   477|         $customLayouts->setOrderKey('name');
   478|         $customLayouts = $customLayouts->load();
   479|         foreach ($customLayouts as $layout) {
   480|             $mapping[$layout->getClassId()][] = $layout;
   481|         }
   482|         $classList = new DataObject\ClassDefinition\Listing();
   483|         $classList->setOrder('ASC');
   484|         $classList->setOrderKey('name');
   485|         $classList = $classList->load();
   486|         foreach ($classList as $class) {
   487|             if (isset($mapping[$class->getId()])) {
   488|                 $classMapping = $mapping[$class->getId()];
   489|                 $resultList[] = [
   490|                     'type' => 'master',
   491|                     'id' => $class->getId() . '_' . 0,
   492|                     'name' => $class->getName(),
   493|                 ];
   494|                 foreach ($classMapping as $layout) {
   495|                     $resultList[] = [
   496|                         'type' => 'custom',
   497|                         'id' => $class->getId() . '_' . $layout->getId(),
   498|                         'name' => $class->getName() . ' - ' . $layout->getName(),
   499|                     ];
   500|                 }
   501|             }
   502|         }
   503|         return $this->adminJson(['data' => $resultList]);
   504|     }
   505|     /**
   506|      * @Route("/export-class", name="pimcore_admin_dataobject_class_exportclass", methods={"GET"})
   507|      *
   508|      * @param Request $request
   509|      *
   510|      * @return Response
   511|      */
   512|     public function exportClassAction(Request $request)
   513|     {
   514|         $id = $request->get('id');
   515|         $class = DataObject\ClassDefinition::getById($id);
   516|         if (!$class instanceof DataObject\ClassDefinition) {
   517|             $errorMessage = ': Class with id [ ' . $id . ' not found. ]';
   518|             Logger::error($errorMessage);
   519|             throw $this->createNotFoundException($errorMessage);
   520|         }
   521|         $json = DataObject\ClassDefinition\Service::generateClassDefinitionJson($class);
   522|         $response = new Response($json);
   523|         $response->headers->set('Content-type', 'application/json');
   524|         $response->headers->set('Content-Disposition', 'attachment; filename="class_' . $class->getName() . '_export.json"');
   525|         return $response;
   526|     }
   527|     /**
   528|      * @Route("/export-custom-layout-definition", name="pimcore_admin_dataobject_class_exportcustomlayoutdefinition", methods={"GET"})
   529|      *
   530|      * @param Request $request
   531|      *
   532|      * @return Response
   533|      */
   534|     public function exportCustomLayoutDefinitionAction(Request $request)
   535|     {
   536|         $id = $request->get('id');
   537|         if ($id) {
   538|             $customLayout = DataObject\ClassDefinition\CustomLayout::getById($id);
   539|             if ($customLayout) {
   540|                 $name = $customLayout->getName();
   541|                 $customLayoutData = [
   542|                     'description' => $customLayout->getDescription(),
   543|                     'layoutDefinitions' => $customLayout->getLayoutDefinitions(),
   544|                     'default' => $customLayout->getDefault() ?? 0,
   545|                 ];
   546|                 $json = json_encode($customLayoutData, JSON_PRETTY_PRINT);
   547|                 $response = new Response($json);
   548|                 $response->headers->set('Content-type', 'application/json');
   549|                 $response->headers->set('Content-Disposition', 'attachment; filename="custom_definition_' . $name . '_export.json"');
   550|                 return $response;
   551|             }
   552|         }
   553|         $errorMessage = ': Custom Layout with id [ ' . $id . ' not found. ]';
   554|         Logger::error($errorMessage);
   555|         throw $this->createNotFoundException($errorMessage);
   556|     }
   557|     /**
   558|      * FIELDCOLLECTIONS
   559|      */
   560|     /**
   561|      * @Route("/fieldcollection-get", name="pimcore_admin_dataobject_class_fieldcollectionget", methods={"GET"})
   562|      *
   563|      * @param Request $request
   564|      *
   565|      * @return JsonResponse
   566|      */
   567|     public function fieldcollectionGetAction(Request $request)
   568|     {
   569|         $fc = DataObject\Fieldcollection\Definition::getByKey($request->get('id'));
   570|         $isWriteable = $fc->isWritable();
   571|         $fc = $fc->getObjectVars();
   572|         $fc['isWriteable'] = $isWriteable;
   573|         return $this->adminJson($fc);
   574|     }
   575|     /**
   576|      * @Route("/fieldcollection-update", name="pimcore_admin_dataobject_class_fieldcollectionupdate", methods={"PUT", "POST"})
   577|      *
   578|      * @param Request $request
   579|      *
   580|      * @return JsonResponse
   581|      */
   582|     public function fieldcollectionUpdateAction(Request $request)
   583|     {
   584|         try {
   585|             $key = $request->get('key');
   586|             $title = $request->get('title');
   587|             $group = $request->get('group');
   588|             if ($request->get('task') == 'add') {
   589|                 $list = new DataObject\Fieldcollection\Definition\Listing();
   590|                 $list = $list->load();
   591|                 foreach ($list as $item) {
   592|                     if (strtolower($key) === strtolower($item->getKey())) {
   593|                         throw new \Exception('FieldCollection with the same name already exists (lower/upper cases may be different)');
   594|                     }
   595|                 }
   596|             }
   597|             $fcDef = new DataObject\Fieldcollection\Definition();
   598|             $fcDef->setKey($key);
   599|             $fcDef->setTitle($title);
   600|             $fcDef->setGroup($group);
   601|             if ($request->get('values')) {
   602|                 $values = $this->decodeJson($request->get('values'));
   603|                 $fcDef->setParentClass($values['parentClass']);
   604|                 $fcDef->setImplementsInterfaces($values['implementsInterfaces']);
   605|                 $fcDef->setGenerateTypeDeclarations($values['generateTypeDeclarations']);
   606|             }
   607|             if ($request->get('configuration')) {
   608|                 $configuration = $this->decodeJson($request->get('configuration'));
   609|                 $configuration['datatype'] = 'layout';
   610|                 $configuration['fieldtype'] = 'panel';
   611|                 $layout = DataObject\ClassDefinition\Service::generateLayoutTreeFromArray($configuration, true);
   612|                 $fcDef->setLayoutDefinitions($layout);
   613|             }
   614|             $fcDef->save();
   615|             return $this->adminJson(['success' => true, 'id' => $fcDef->getKey()]);
   616|         } catch (\Exception $e) {
   617|             Logger::error($e->getMessage());
   618|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   619|         }
   620|     }
   621|     /**
   622|      * @Route("/import-fieldcollection", name="pimcore_admin_dataobject_class_importfieldcollection", methods={"POST"})
   623|      *
   624|      * @param Request $request
   625|      *
   626|      * @return Response
   627|      */
   628|     public function importFieldcollectionAction(Request $request)
   629|     {
   630|         $fieldCollection = DataObject\Fieldcollection\Definition::getByKey($request->get('id'));
   631|         $data = file_get_contents($_FILES['Filedata']['tmp_name']);
   632|         $success = DataObject\ClassDefinition\Service::importFieldCollectionFromJson($fieldCollection, $data);
   633|         $response = $this->adminJson([
   634|             'success' => $success,
   635|         ]);
   636|         $response->headers->set('Content-Type', 'text/html');
   637|         return $response;
   638|     }
   639|     /**
   640|      * @Route("/export-fieldcollection", name="pimcore_admin_dataobject_class_exportfieldcollection", methods={"GET"})
   641|      *
   642|      * @param Request $request
   643|      *
   644|      * @return Response
   645|      */
   646|     public function exportFieldcollectionAction(Request $request)
   647|     {
   648|         $fieldCollection = DataObject\Fieldcollection\Definition::getByKey($request->get('id'));
   649|         if (!$fieldCollection instanceof DataObject\Fieldcollection\Definition) {
   650|             $errorMessage = ': Field-Collection with id [ ' . $request->get('id') . ' not found. ]';
   651|             Logger::error($errorMessage);
   652|             throw $this->createNotFoundException($errorMessage);
   653|         }
   654|         $json = DataObject\ClassDefinition\Service::generateFieldCollectionJson($fieldCollection);
   655|         $response = new Response($json);
   656|         $response->headers->set('Content-type', 'application/json');
   657|         $response->headers->set('Content-Disposition', 'attachment; filename="fieldcollection_' . $fieldCollection->getKey() . '_export.json"');
   658|         return $response;
   659|     }
   660|     /**
   661|      * @Route("/fieldcollection-delete", name="pimcore_admin_dataobject_class_fieldcollectiondelete", methods={"DELETE"})
   662|      *
   663|      * @param Request $request
   664|      *
   665|      * @return JsonResponse
   666|      */
   667|     public function fieldcollectionDeleteAction(Request $request)
   668|     {
   669|         $fc = DataObject\Fieldcollection\Definition::getByKey($request->get('id'));
   670|         $fc->delete();
   671|         return $this->adminJson(['success' => true]);
   672|     }
   673|     /**
   674|      * @Route("/fieldcollection-tree", name="pimcore_admin_dataobject_class_fieldcollectiontree", methods={"GET", "POST"})
   675|      *
   676|      * @param Request $request
   677|      * @param EventDispatcherInterface $eventDispatcher
   678|      *
   679|      * @return JsonResponse
   680|      */
   681|     public function fieldcollectionTreeAction(Request $request, EventDispatcherInterface $eventDispatcher)
   682|     {
   683|         $list = new DataObject\Fieldcollection\Definition\Listing();
   684|         $list = $list->load();
   685|         $forObjectEditor = $request->get('forObjectEditor');
   686|         $layoutDefinitions = [];
   687|         $definitions = [];
   688|         $allowedTypes = null;
   689|         if ($request->query->has('allowedTypes')) {
   690|             $allowedTypes = explode(',', $request->get('allowedTypes'));
   691|         }
   692|         $object = DataObject::getById($request->get('object_id'));
   693|         $currentLayoutId = $request->get('layoutId', null);
   694|         $user = \Pimcore\Tool\Admin::getCurrentUser();
   695|         $groups = [];
   696|         foreach ($list as $item) {
   697|             if ($allowedTypes && !in_array($item->getKey(), $allowedTypes)) {
   698|                 continue;
   699|             }
   700|             if ($item->getGroup()) {
   701|                 if (!isset($groups[$item->getGroup()])) {
   702|                     $groups[$item->getGroup()] = [
   703|                         'id' => 'group_' . $item->getKey(),
   704|                         'text' => $item->getGroup(),
   705|                         'expandable' => true,
   706|                         'leaf' => false,
   707|                         'allowChildren' => true,
   708|                         'iconCls' => 'pimcore_icon_folder',
   709|                         'group' => $item->getGroup(),
   710|                         'children' => [],
   711|                     ];
   712|                 }
   713|                 if ($forObjectEditor) {
   714|                     $itemLayoutDefinitions = $item->getLayoutDefinitions();
   715|                     DataObject\Service::enrichLayoutDefinition($itemLayoutDefinitions, $object);
   716|                     if ($currentLayoutId == -1 && $user->isAdmin()) {
   717|                         DataObject\Service::createSuperLayout($itemLayoutDefinitions);
   718|                     }
   719|                     $layoutDefinitions[$item->getKey()] = $itemLayoutDefinitions;
   720|                 }
   721|                 $groups[$item->getGroup()]['children'][] =
   722|                     [
   723|                         'id' => $item->getKey(),
   724|                         'text' => $item->getKey(),
   725|                         'title' => $item->getTitle(),
   726|                         'key' => $item->getKey(),
   727|                         'leaf' => true,
   728|                         'iconCls' => 'pimcore_icon_fieldcollection',
   729|                     ];
   730|             } else {
   731|                 if ($forObjectEditor) {
   732|                     $itemLayoutDefinitions = $item->getLayoutDefinitions();
   733|                     DataObject\Service::enrichLayoutDefinition($itemLayoutDefinitions, $object);
   734|                     if ($currentLayoutId == -1 && $user->isAdmin()) {
   735|                         DataObject\Service::createSuperLayout($itemLayoutDefinitions);
   736|                     }
   737|                     $layoutDefinitions[$item->getKey()] = $itemLayoutDefinitions;
   738|                 }
   739|                 $definitions[] = [
   740|                     'id' => $item->getKey(),
   741|                     'text' => $item->getKey(),
   742|                     'title' => $item->getTitle(),
   743|                     'key' => $item->getKey(),
   744|                     'leaf' => true,
   745|                     'iconCls' => 'pimcore_icon_fieldcollection',
   746|                 ];
   747|             }
   748|         }
   749|         foreach ($groups as $group) {
   750|             $definitions[] = $group;
   751|         }
   752|         $event = new GenericEvent($this, [
   753|             'list' => $definitions,
   754|             'objectId' => $request->get('object_id'),
   755|         ]);
   756|         $eventDispatcher->dispatch($event, AdminEvents::CLASS_FIELDCOLLECTION_LIST_PRE_SEND_DATA);
   757|         $definitions = $event->getArgument('list');
   758|         if ($forObjectEditor) {
   759|             return $this->adminJson(['fieldcollections' => $definitions, 'layoutDefinitions' => $layoutDefinitions]);
   760|         } else {
   761|             return $this->adminJson($definitions);
   762|         }
   763|     }
   764|     /**
   765|      * @Route("/fieldcollection-list", name="pimcore_admin_dataobject_class_fieldcollectionlist", methods={"GET"})
   766|      *
   767|      * @param Request $request
   768|      * @param EventDispatcherInterface $eventDispatcher
   769|      *
   770|      * @return JsonResponse
   771|      */
   772|     public function fieldcollectionListAction(Request $request, EventDispatcherInterface $eventDispatcher)
   773|     {
   774|         $user = \Pimcore\Tool\Admin::getCurrentUser();
   775|         $currentLayoutId = $request->get('layoutId');
   776|         $list = new DataObject\Fieldcollection\Definition\Listing();
   777|         $list = $list->load();
   778|         if ($request->query->has('allowedTypes')) {
   779|             $filteredList = [];
   780|             $allowedTypes = explode(',', $request->get('allowedTypes'));
   781|             foreach ($list as $type) {
   782|                 if (in_array($type->getKey(), $allowedTypes)) {
   783|                     $filteredList[] = $type;
   784|                     $layoutDefinitions = $type->getLayoutDefinitions();
   785|                     $context = [
   786|                         'containerType' => 'fieldcollection',
   787|                         'containerKey' => $type->getKey(),
   788|                         'outerFieldname' => $request->get('field_name'),
   789|                     ];
   790|                     $object = DataObject::getById($request->get('object_id'));
   791|                     DataObject\Service::enrichLayoutDefinition($layoutDefinitions, $object, $context);
   792|                     if ($currentLayoutId == -1 && $user->isAdmin()) {
   793|                         DataObject\Service::createSuperLayout($layoutDefinitions);
   794|                     }
   795|                 }
   796|             }
   797|             $list = $filteredList;
   798|         }
   799|         $event = new GenericEvent($this, [
   800|             'list' => $list,
   801|             'objectId' => $request->get('object_id'),
   802|         ]);
   803|         $eventDispatcher->dispatch($event, AdminEvents::CLASS_FIELDCOLLECTION_LIST_PRE_SEND_DATA);
   804|         $list = $event->getArgument('list');
   805|         return $this->adminJson(['fieldcollections' => $list]);
   806|     }
   807|     /**
   808|      * @Route("/get-class-definition-for-column-config", name="pimcore_admin_dataobject_class_getclassdefinitionforcolumnconfig", methods={"GET"})
   809|      *
   810|      * @param Request $request
   811|      *
   812|      * @return JsonResponse
   813|      */
   814|     public function getClassDefinitionForColumnConfigAction(Request $request)
   815|     {
   816|         $class = DataObject\ClassDefinition::getById($request->get('id'));
   817|         $objectId = (int)$request->get('oid');
   818|         $filteredDefinitions = DataObject\Service::getCustomLayoutDefinitionForGridColumnConfig($class, $objectId);
   819|         $layoutDefinitions = isset($filteredDefinitions['layoutDefinition']) ? $filteredDefinitions['layoutDefinition'] : false;
   820|         $filteredFieldDefinition = isset($filteredDefinitions['fieldDefinition']) ? $filteredDefinitions['fieldDefinition'] : false;
   821|         $class->setFieldDefinitions([]);
   822|         $result = [];
   823|         DataObject\Service::enrichLayoutDefinition($layoutDefinitions);
   824|         $result['objectColumns']['childs'] = $layoutDefinitions->getChilds();
   825|         $result['objectColumns']['nodeLabel'] = 'object_columns';
   826|         $result['objectColumns']['nodeType'] = 'object';
   827|         $systemColumnNames = DataObject\Concrete::SYSTEM_COLUMN_NAMES;
   828|         $systemColumns = [];
   829|         foreach ($systemColumnNames as $systemColumn) {
   830|             $systemColumns[] = ['title' => $systemColumn, 'name' => $systemColumn, 'datatype' => 'data', 'fieldtype' => 'system'];
   831|         }
   832|         $result['systemColumns']['nodeLabel'] = 'system_columns';
   833|         $result['systemColumns']['nodeType'] = 'system';
   834|         $result['systemColumns']['childs'] = $systemColumns;
   835|         $list = new DataObject\Objectbrick\Definition\Listing();
   836|         $list = $list->load();
   837|         foreach ($list as $brickDefinition) {
   838|             $classDefs = $brickDefinition->getClassDefinitions();
   839|             if (!empty($classDefs)) {
   840|                 foreach ($classDefs as $classDef) {
   841|                     if ($classDef['classname'] == $class->getName()) {
   842|                         $fieldName = $classDef['fieldname'];
   843|                         if ($filteredFieldDefinition && !$filteredFieldDefinition[$fieldName]) {
   844|                             continue;
   845|                         }
   846|                         $key = $brickDefinition->getKey();
   847|                         $brickLayoutDefinitions = $brickDefinition->getLayoutDefinitions();
   848|                         $context = [
   849|                             'containerType' => 'objectbrick',
   850|                             'containerKey' => $key,
   851|                             'outerFieldname' => $fieldName,
   852|                         ];
   853|                         DataObject\Service::enrichLayoutDefinition($brickLayoutDefinitions, null, $context);
   854|                         $result[$key]['nodeLabel'] = $key;
   855|                         $result[$key]['brickField'] = $fieldName;
   856|                         $result[$key]['nodeType'] = 'objectbricks';
   857|                         $result[$key]['childs'] = $brickLayoutDefinitions->getChildren();
   858|                         break;
   859|                     }
   860|                 }
   861|             }
   862|         }
   863|         return $this->adminJson($result);
   864|     }
   865|     /**
   866|      * OBJECT BRICKS
   867|      */
   868|     /**
   869|      * @Route("/objectbrick-get", name="pimcore_admin_dataobject_class_objectbrickget", methods={"GET"})
   870|      *
   871|      * @param Request $request
   872|      *
   873|      * @return JsonResponse
   874|      */
   875|     public function objectbrickGetAction(Request $request)
   876|     {
   877|         $fc = DataObject\Objectbrick\Definition::getByKey($request->get('id'));
   878|         $isWriteable = $fc->isWritable();
   879|         $fc = $fc->getObjectVars();
   880|         $fc['isWriteable'] = $isWriteable;
   881|         return $this->adminJson($fc);
   882|     }
   883|     /**
   884|      * @Route("/objectbrick-update", name="pimcore_admin_dataobject_class_objectbrickupdate", methods={"PUT", "POST"})
   885|      *
   886|      * @param Request $request
   887|      * @param EventDispatcherInterface $eventDispatcher
   888|      *
   889|      * @return JsonResponse
   890|      */
   891|     public function objectbrickUpdateAction(Request $request, EventDispatcherInterface $eventDispatcher)
   892|     {
   893|         try {
   894|             $key = $request->get('key');
   895|             $title = $request->get('title');
   896|             $group = $request->get('group');
   897|             if ($request->get('task') == 'add') {
   898|                 $list = new DataObject\Objectbrick\Definition\Listing();
   899|                 $list = $list->load();
   900|                 foreach ($list as $item) {
   901|                     if (strtolower($key) === strtolower($item->getKey())) {
   902|                         throw new \Exception('Brick with the same name already exists (lower/upper cases may be different)');
   903|                     }
   904|                 }
   905|             }
   906|             $brickDef = new DataObject\Objectbrick\Definition();
   907|             $brickDef->setKey($key);
   908|             $brickDef->setTitle($title);
   909|             $brickDef->setGroup($group);
   910|             if ($request->get('values')) {
   911|                 $values = $this->decodeJson($request->get('values'));
   912|                 $brickDef->setParentClass($values['parentClass']);
   913|                 $brickDef->setImplementsInterfaces($values['implementsInterfaces']);
   914|                 $brickDef->setClassDefinitions($values['classDefinitions']);
   915|                 $brickDef->setGenerateTypeDeclarations($values['generateTypeDeclarations']);
   916|             }
   917|             if ($request->get('configuration')) {
   918|                 $configuration = $this->decodeJson($request->get('configuration'));
   919|                 $configuration['datatype'] = 'layout';
   920|                 $configuration['fieldtype'] = 'panel';
   921|                 $layout = DataObject\ClassDefinition\Service::generateLayoutTreeFromArray($configuration, true);
   922|                 $brickDef->setLayoutDefinitions($layout);
   923|             }
   924|             $event = new GenericEvent($this, [
   925|                 'brickDefinition' => $brickDef,
   926|             ]);
   927|             $eventDispatcher->dispatch($event, AdminEvents::CLASS_OBJECTBRICK_UPDATE_DEFINITION);
   928|             $brickDef = $event->getArgument('brickDefinition');
   929|             $brickDef->save();
   930|             return $this->adminJson(['success' => true, 'id' => $brickDef->getKey()]);
   931|         } catch (\Exception $e) {
   932|             Logger::error($e->getMessage());
   933|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   934|         }
   935|     }
   936|     /**
   937|      * @Route("/import-objectbrick", name="pimcore_admin_dataobject_class_importobjectbrick", methods={"POST"})
   938|      *
   939|      * @param Request $request
   940|      *
   941|      * @return JsonResponse
   942|      */
   943|     public function importObjectbrickAction(Request $request)
   944|     {
   945|         $objectBrick = DataObject\Objectbrick\Definition::getByKey($request->get('id'));
   946|         $data = file_get_contents($_FILES['Filedata']['tmp_name']);
   947|         $success = DataObject\ClassDefinition\Service::importObjectBrickFromJson($objectBrick, $data);
   948|         $response = $this->adminJson([
   949|             'success' => $success,
   950|         ]);
   951|         $response->headers->set('Content-Type', 'text/html');
   952|         return $response;
   953|     }
   954|     /**
   955|      * @Route("/export-objectbrick", name="pimcore_admin_dataobject_class_exportobjectbrick", methods={"GET"})
   956|      *
   957|      * @param Request $request
   958|      *
   959|      * @return Response
   960|      */
   961|     public function exportObjectbrickAction(Request $request)
   962|     {
   963|         $objectBrick = DataObject\Objectbrick\Definition::getByKey($request->get('id'));
   964|         if (!$objectBrick instanceof DataObject\Objectbrick\Definition) {
   965|             $errorMessage = ': Object-Brick with id [ ' . $request->get('id') . ' not found. ]';
   966|             Logger::error($errorMessage);
   967|             throw $this->createNotFoundException($errorMessage);
   968|         }
   969|         $xml = DataObject\ClassDefinition\Service::generateObjectBrickJson($objectBrick);
   970|         $response = new Response($xml);
   971|         $response->headers->set('Content-type', 'application/json');
   972|         $response->headers->set('Content-Disposition', 'attachment; filename="objectbrick_' . $objectBrick->getKey() . '_export.json"');
   973|         return $response;
   974|     }
   975|     /**
   976|      * @Route("/objectbrick-delete", name="pimcore_admin_dataobject_class_objectbrickdelete", methods={"DELETE"})
   977|      *
   978|      * @param Request $request
   979|      *
   980|      * @return JsonResponse
   981|      */
   982|     public function objectbrickDeleteAction(Request $request)
   983|     {
   984|         $fc = DataObject\Objectbrick\Definition::getByKey($request->get('id'));
   985|         $fc->delete();
   986|         return $this->adminJson(['success' => true]);
   987|     }
   988|     /**
   989|      * @Route("/objectbrick-tree", name="pimcore_admin_dataobject_class_objectbricktree", methods={"GET", "POST"})
   990|      *
   991|      * @param Request $request
   992|      * @param EventDispatcherInterface $eventDispatcher
   993|      *
   994|      * @return JsonResponse
   995|      */
   996|     public function objectbrickTreeAction(Request $request, EventDispatcherInterface $eventDispatcher)
   997|     {
   998|         $list = new DataObject\Objectbrick\Definition\Listing();
   999|         $list = $list->load();
  1000|         $forObjectEditor = $request->get('forObjectEditor');
  1001|         $layoutDefinitions = [];
  1002|         $groups = [];
  1003|         $definitions = [];
  1004|         $fieldname = null;
  1005|         $className = null;
  1006|         $object = DataObject::getById($request->get('object_id'));
  1007|         if ($request->query->has('class_id') && $request->query->has('field_name')) {
  1008|             $classId = $request->get('class_id');
  1009|             $fieldname = $request->get('field_name');
  1010|             $classDefinition = DataObject\ClassDefinition::getById($classId);
  1011|             $className = $classDefinition->getName();
  1012|         }
  1013|         foreach ($list as $item) {
  1014|             if ($request->query->has('class_id') && $request->query->has('field_name')) {
  1015|                 $keep = false;
  1016|                 $clsDefs = $item->getClassDefinitions();
  1017|                 if (!empty($clsDefs)) {
  1018|                     foreach ($clsDefs as $cd) {
  1019|                         if ($cd['classname'] == $className && $cd['fieldname'] == $fieldname) {
  1020|                             $keep = true;
  1021|                             continue;
  1022|                         }
  1023|                     }
  1024|                 }
  1025|                 if (!$keep) {
  1026|                     continue;
  1027|                 }
  1028|             }
  1029|             if ($item->getGroup()) {
  1030|                 if (!isset($groups[$item->getGroup()])) {
  1031|                     $groups[$item->getGroup()] = [
  1032|                         'id' => 'group_' . $item->getKey(),
  1033|                         'text' => $item->getGroup(),
  1034|                         'expandable' => true,
  1035|                         'leaf' => false,
  1036|                         'allowChildren' => true,
  1037|                         'iconCls' => 'pimcore_icon_folder',
  1038|                         'group' => $item->getGroup(),
  1039|                         'children' => [],
  1040|                     ];
  1041|                 }
  1042|                 if ($forObjectEditor) {
  1043|                     $itemLayoutDefinitions = $item->getLayoutDefinitions();
  1044|                     DataObject\Service::enrichLayoutDefinition($itemLayoutDefinitions, $object);
  1045|                     $layoutDefinitions[$item->getKey()] = $itemLayoutDefinitions;
  1046|                 }
  1047|                 $groups[$item->getGroup()]['children'][] =
  1048|                     [
  1049|                         'id' => $item->getKey(),
  1050|                         'text' => $item->getKey(),
  1051|                         'title' => $item->getTitle(),
  1052|                         'key' => $item->getKey(),
  1053|                         'leaf' => true,
  1054|                         'iconCls' => 'pimcore_icon_objectbricks',
  1055|                     ];
  1056|             } else {
  1057|                 if ($forObjectEditor) {
  1058|                     $layout = $item->getLayoutDefinitions();
  1059|                     $currentLayoutId = $request->get('layoutId', null);
  1060|                     $user = $this->getAdminUser();
  1061|                     if ($currentLayoutId == -1 && $user->isAdmin()) {
  1062|                         DataObject\Service::createSuperLayout($layout);
  1063|                         $objectData['layout'] = $layout;
  1064|                     }
  1065|                     $context = [
  1066|                         'containerType' => 'objectbrick',
  1067|                         'containerKey' => $item->getKey(),
  1068|                         'outerFieldname' => $request->get('field_name'),
  1069|                     ];
  1070|                     DataObject\Service::enrichLayoutDefinition($layout, $object, $context);
  1071|                     $layoutDefinitions[$item->getKey()] = $layout;
  1072|                 }
  1073|                 $definitions[] = [
  1074|                     'id' => $item->getKey(),
  1075|                     'text' => $item->getKey(),
  1076|                     'title' => $item->getTitle(),
  1077|                     'key' => $item->getKey(),
  1078|                     'leaf' => true,
  1079|                     'iconCls' => 'pimcore_icon_objectbricks',
  1080|                 ];
  1081|             }
  1082|         }
  1083|         foreach ($groups as $group) {
  1084|             $definitions[] = $group;
  1085|         }
  1086|         $event = new GenericEvent($this, [
  1087|             'list' => $definitions,
  1088|             'objectId' => $request->get('object_id'),
  1089|         ]);
  1090|         $eventDispatcher->dispatch($event, AdminEvents::CLASS_OBJECTBRICK_LIST_PRE_SEND_DATA);
  1091|         $definitions = $event->getArgument('list');
  1092|         if ($forObjectEditor) {
  1093|             return $this->adminJson(['objectbricks' => $definitions, 'layoutDefinitions' => $layoutDefinitions]);
  1094|         } else {
  1095|             return $this->adminJson($definitions);
  1096|         }
  1097|     }
  1098|     /**
  1099|      * @Route("/objectbrick-list", name="pimcore_admin_dataobject_class_objectbricklist", methods={"GET"})
  1100|      *
  1101|      * @param Request $request
  1102|      * @param EventDispatcherInterface $eventDispatcher
  1103|      *
  1104|      * @return JsonResponse
  1105|      */
  1106|     public function objectbrickListAction(Request $request, EventDispatcherInterface $eventDispatcher)
  1107|     {
  1108|         $list = new DataObject\Objectbrick\Definition\Listing();
  1109|         $list = $list->load();
  1110|         if ($request->query->has('class_id') && $request->query->has('field_name')) {
  1111|             $filteredList = [];
  1112|             $classId = $request->get('class_id');
  1113|             $fieldname = $request->get('field_name');
  1114|             $classDefinition = DataObject\ClassDefinition::getById($classId);
  1115|             $className = $classDefinition->getName();
  1116|             foreach ($list as $type) {
  1117|                 $clsDefs = $type->getClassDefinitions();
  1118|                 if (!empty($clsDefs)) {
  1119|                     foreach ($clsDefs as $cd) {
  1120|                         if ($cd['classname'] == $className && $cd['fieldname'] == $fieldname) {
  1121|                             $filteredList[] = $type;
  1122|                             continue;
  1123|                         }
  1124|                     }
  1125|                 }
  1126|                 $layout = $type->getLayoutDefinitions();
  1127|                 $currentLayoutId = $request->get('layoutId', null);
  1128|                 $user = $this->getAdminUser();
  1129|                 if ($currentLayoutId == -1 && $user->isAdmin()) {
  1130|                     DataObject\Service::createSuperLayout($layout);
  1131|                     $objectData['layout'] = $layout;
  1132|                 }
  1133|                 $context = [
  1134|                     'containerType' => 'objectbrick',
  1135|                     'containerKey' => $type->getKey(),
  1136|                     'outerFieldname' => $request->get('field_name'),
  1137|                 ];
  1138|                 $object = DataObject::getById($request->get('object_id'));
  1139|                 DataObject\Service::enrichLayoutDefinition($layout, $object, $context);
  1140|                 $type->setLayoutDefinitions($layout);
  1141|             }
  1142|             $list = $filteredList;
  1143|         }
  1144|         $event = new GenericEvent($this, [
  1145|             'list' => $list,
  1146|             'objectId' => $request->get('object_id'),
  1147|         ]);
  1148|         $eventDispatcher->dispatch($event, AdminEvents::CLASS_OBJECTBRICK_LIST_PRE_SEND_DATA);
  1149|         $list = $event->getArgument('list');
  1150|         return $this->adminJson(['objectbricks' => $list]);
  1151|     }
  1152|     /**
  1153|      * See http://www.pimcore.org/issues/browse/PIMCORE-2358
  1154|      * Add option to export/import all class definitions/brick definitions etc. at once
  1155|      */
  1156|     /**
  1157|      * @Route("/bulk-import", name="pimcore_admin_dataobject_class_bulkimport", methods={"POST"})
  1158|      *
  1159|      * @param Request $request
  1160|      *
  1161|      * @return JsonResponse
  1162|      */
  1163|     public function bulkImportAction(Request $request)
  1164|     {
  1165|         $result = [];
  1166|         $tmpName = $_FILES['Filedata']['tmp_name'];
  1167|         $json = file_get_contents($tmpName);
  1168|         $tmpName = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/bulk-import-' . uniqid() . '.tmp';
  1169|         file_put_contents($tmpName, $json);
  1170|         Session::useSession(function (AttributeBagInterface $session) use ($tmpName) {
  1171|             $session->set('class_bulk_import_file', $tmpName);
  1172|         }, 'pimcore_objects');
  1173|         $json = json_decode($json, true);
  1174|         foreach ($json as $groupName => $group) {
  1175|             foreach ($group as $groupItem) {
  1176|                 $displayName = null;
  1177|                 $icon = null;
  1178|                 if ($groupName == 'class') {
  1179|                     $name = $groupItem['name'];
  1180|                     $icon = 'class';
  1181|                 } elseif ($groupName == 'customlayout') {
  1182|                     $className = $groupItem['className'];
  1183|                     $layoutData = ['className' => $className, 'name' => $groupItem['name']];
  1184|                     $name = base64_encode(json_encode($layoutData));
  1185|                     $displayName = $className . ' / ' . $groupItem['name'];
  1186|                     $icon = 'custom_views';
  1187|                 } else {
  1188|                     if ($groupName == 'objectbrick') {
  1189|                         $icon = 'objectbricks';
  1190|                     } elseif ($groupName == 'fieldcollection') {
  1191|                         $icon = 'fieldcollection';
  1192|                     }
  1193|                     $name = $groupItem['key'];
  1194|                 }
  1195|                 if (!$displayName) {
  1196|                     $displayName = $name;
  1197|                 }
  1198|                 $result[] = ['icon' => $icon, 'checked' => true, 'type' => $groupName, 'name' => $name, 'displayName' => $displayName];
  1199|             }
  1200|         }
  1201|         $response = $this->adminJson(['success' => true, 'data' => $result]);
  1202|         $response->headers->set('Content-Type', 'text/html');
  1203|         return $response;
  1204|     }
  1205|     /**
  1206|      * See http://www.pimcore.org/issues/browse/PIMCORE-2358
  1207|      * Add option to export/import all class definitions/brick definitions etc. at once
  1208|      */
  1209|     /**
  1210|      * @Route("/bulk-commit", name="pimcore_admin_dataobject_class_bulkcommit", methods={"POST"})
  1211|      *
  1212|      * @param Request $request
  1213|      *
  1214|      * @return JsonResponse
  1215|      *
  1216|      * @throws \Exception
  1217|      */
  1218|     public function bulkCommitAction(Request $request)
  1219|     {
  1220|         $data = json_decode($request->get('data'), true);
  1221|         $session = Session::get('pimcore_objects');
  1222|         $filename = $session->get('class_bulk_import_file');
  1223|         $json = @file_get_contents($filename);
  1224|         $json = json_decode($json, true);
  1225|         $type = $data['type'];
  1226|         $name = $data['name'];
  1227|         $list = $json[$type];
  1228|         foreach ($list as $item) {
  1229|             unset($item['creationDate']);
  1230|             unset($item['modificationDate']);
  1231|             unset($item['userOwner']);
  1232|             unset($item['userModification']);
  1233|             if ($type == 'class' && $item['name'] == $name) {
  1234|                 $class = DataObject\ClassDefinition::getByName($name);
  1235|                 if (!$class) {
  1236|                     $class = new DataObject\ClassDefinition();
  1237|                     $class->setName($name);
  1238|                 }
  1239|                 $success = DataObject\ClassDefinition\Service::importClassDefinitionFromJson($class, json_encode($item), true);
  1240|                 return $this->adminJson(['success' => $success !== false]);
  1241|             } elseif ($type == 'objectbrick' && $item['key'] == $name) {
  1242|                 if (!$brick = DataObject\Objectbrick\Definition::getByKey($name)) {
  1243|                     $brick = new DataObject\Objectbrick\Definition();
  1244|                     $brick->setKey($name);
  1245|                 }
  1246|                 $success = DataObject\ClassDefinition\Service::importObjectBrickFromJson($brick, json_encode($item), true);
  1247|                 return $this->adminJson(['success' => $success !== false]);
  1248|             } elseif ($type == 'fieldcollection' && $item['key'] == $name) {
  1249|                 if (!$fieldCollection = DataObject\Fieldcollection\Definition::getByKey($name)) {
  1250|                     $fieldCollection = new DataObject\Fieldcollection\Definition();
  1251|                     $fieldCollection->setKey($name);
  1252|                 }
  1253|                 $success = DataObject\ClassDefinition\Service::importFieldCollectionFromJson($fieldCollection, json_encode($item), true);
  1254|                 return $this->adminJson(['success' => $success !== false]);
  1255|             } elseif ($type == 'customlayout') {
  1256|                 $layoutData = json_decode(base64_decode($data['name']), true);
  1257|                 $className = $layoutData['className'];
  1258|                 $layoutName = $layoutData['name'];
  1259|                 if ($item['name'] == $layoutName && $item['className'] == $className) {
  1260|                     $class = DataObject\ClassDefinition::getByName($className);
  1261|                     if (!$class) {
  1262|                         throw new \Exception('Class does not exist');
  1263|                     }
  1264|                     $classId = $class->getId();
  1265|                     $layoutList = new DataObject\ClassDefinition\CustomLayout\Listing();
  1266|                     $db = \Pimcore\Db::get();
  1267|                     $layoutList->setCondition('name = ' . $db->quote($layoutName) . ' AND classId = ' . $classId);
  1268|                     $layoutList = $layoutList->load();
  1269|                     $layoutDefinition = null;
  1270|                     if ($layoutList) {
  1271|                         $layoutDefinition = $layoutList[0];
  1272|                     }
  1273|                     if (!$layoutDefinition) {
  1274|                         $layoutDefinition = new DataObject\ClassDefinition\CustomLayout();
  1275|                         $layoutDefinition->setName($layoutName);
  1276|                         $layoutDefinition->setClassId($classId);
  1277|                     }
  1278|                     try {
  1279|                         $layoutDefinition->setDescription($item['description']);
  1280|                         $layoutDef = DataObject\ClassDefinition\Service::generateLayoutTreeFromArray($item['layoutDefinitions'], true);
  1281|                         $layoutDefinition->setLayoutDefinitions($layoutDef);
  1282|                         $layoutDefinition->save();
  1283|                     } catch (\Exception $e) {
  1284|                         Logger::error($e->getMessage());
  1285|                         return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
  1286|                     }
  1287|                 }
  1288|             }
  1289|         }
  1290|         return $this->adminJson(['success' => true]);
  1291|     }
  1292|     /**
  1293|      * See http://www.pimcore.org/issues/browse/PIMCORE-2358
  1294|      * Add option to export/import all class definitions/brick definitions etc. at once
  1295|      */
  1296|     /**
  1297|      * @Route("/bulk-export-prepare", name="pimcore_admin_dataobject_class_bulkexportprepare", methods={"POST"})
  1298|      *
  1299|      * @param Request $request
  1300|      *
  1301|      * @return Response
  1302|      */
  1303|     public function bulkExportPrepareAction(Request $request)
  1304|     {
  1305|         $data = $request->get('data');
  1306|         Session::useSession(function (AttributeBagInterface $session) use ($data) {
  1307|             $session->set('class_bulk_export_settings', $data);
  1308|         }, 'pimcore_objects');
  1309|         return $this->adminJson(['success' => true]);
  1310|     }
  1311|     /**
  1312|      * @Route("/bulk-export", name="pimcore_admin_dataobject_class_bulkexport", methods={"GET"})
  1313|      *
  1314|      * @param Request $request
  1315|      *
  1316|      * @return Response
  1317|      */
  1318|     public function bulkExportAction(Request $request)
  1319|     {
  1320|         $result = [];
  1321|         $fieldCollections = new DataObject\Fieldcollection\Definition\Listing();
  1322|         $fieldCollections = $fieldCollections->load();
  1323|         foreach ($fieldCollections as $fieldCollection) {
  1324|             $result[] = [
  1325|                 'icon' => 'fieldcollection',
  1326|                 'checked' => true,
  1327|                 'type' => 'fieldcollection',
  1328|                 'name' => $fieldCollection->getKey(),
  1329|                 'displayName' => $fieldCollection->getKey(),
  1330|             ];
  1331|         }
  1332|         $classes = new DataObject\ClassDefinition\Listing();
  1333|         $classes->setOrder('ASC');
  1334|         $classes->setOrderKey('id');
  1335|         $classes = $classes->load();
  1336|         foreach ($classes as $class) {
  1337|             $result[] = [
  1338|                 'icon' => 'class',
  1339|                 'checked' => true,
  1340|                 'type' => 'class',
  1341|                 'name' => $class->getName(),
  1342|                 'displayName' => $class->getName(),
  1343|             ];
  1344|         }
  1345|         $objectBricks = new DataObject\Objectbrick\Definition\Listing();
  1346|         $objectBricks = $objectBricks->load();
  1347|         foreach ($objectBricks as $objectBrick) {
  1348|             $result[] = [
  1349|                 'icon' => 'objectbricks',
  1350|                 'checked' => true,
  1351|                 'type' => 'objectbrick',
  1352|                 'name' => $objectBrick->getKey(),
  1353|                 'displayName' => $objectBrick->getKey(),
  1354|             ];
  1355|         }
  1356|         $customLayouts = new DataObject\ClassDefinition\CustomLayout\Listing();
  1357|         $customLayouts = $customLayouts->load();
  1358|         foreach ($customLayouts as $customLayout) {
  1359|             $class = DataObject\ClassDefinition::getById($customLayout->getClassId());
  1360|             $displayName = $class->getName() . ' / ' .  $customLayout->getName();
  1361|             $result[] = [
  1362|                 'icon' => 'custom_views',
  1363|                 'checked' => true,
  1364|                 'type' => 'customlayout',
  1365|                 'name' => $customLayout->getId(),
  1366|                 'displayName' => $displayName,
  1367|             ];
  1368|         }
  1369|         return new JsonResponse(['success' => true, 'data' => $result]);
  1370|     }
  1371|     /**
  1372|      * @Route("/do-bulk-export", name="pimcore_admin_dataobject_class_dobulkexport", methods={"GET"})
  1373|      *
  1374|      * @param Request $request
  1375|      *
  1376|      * @return Response
  1377|      */
  1378|     public function doBulkExportAction(Request $request)
  1379|     {
  1380|         $session = Session::get('pimcore_objects');
  1381|         $list = $session->get('class_bulk_export_settings');
  1382|         $list = json_decode($list, true);
  1383|         $result = [];
  1384|         foreach ($list as $item) {
  1385|             if ($item['type'] == 'fieldcollection') {
  1386|                 $fieldCollection = DataObject\Fieldcollection\Definition::getByKey($item['name']);
  1387|                 $key = $fieldCollection->getKey();
  1388|                 $fieldCollectionJson = json_decode(DataObject\ClassDefinition\Service::generateFieldCollectionJson($fieldCollection));
  1389|                 $fieldCollectionJson->key = $key;
  1390|                 $result['fieldcollection'][] = $fieldCollectionJson;
  1391|             } elseif ($item['type'] == 'class') {
  1392|                 $class = DataObject\ClassDefinition::getByName($item['name']);
  1393|                 $data = json_decode(json_encode($class));
  1394|                 unset($data->fieldDefinitions);
  1395|                 $result['class'][] = $data;
  1396|             } elseif ($item['type'] == 'objectbrick') {
  1397|                 $objectBrick = DataObject\Objectbrick\Definition::getByKey($item['name']);
  1398|                 $key = $objectBrick->getKey();
  1399|                 $objectBrickJson = json_decode(DataObject\ClassDefinition\Service::generateObjectBrickJson($objectBrick));
  1400|                 $objectBrickJson->key = $key;
  1401|                 $result['objectbrick'][] = $objectBrickJson;
  1402|             } elseif ($item['type'] == 'customlayout') {
  1403|                 /** @var DataObject\ClassDefinition\CustomLayout $customLayout */
  1404|                 $customLayout = DataObject\ClassDefinition\CustomLayout::getById($item['name']);
  1405|                 $classId = $customLayout->getClassId();
  1406|                 $class = DataObject\ClassDefinition::getById($classId);
  1407|                 $customLayout = $customLayout->getObjectVars();
  1408|                 $customLayout['className'] = $class->getName();
  1409|                 $result['customlayout'][] = $customLayout;
  1410|             }
  1411|         }
  1412|         $result = json_encode($result, JSON_PRETTY_PRINT);
  1413|         $response = new Response($result);
  1414|         $response->headers->set('Content-type', 'application/json');
  1415|         $response->headers->set('Content-Disposition', 'attachment; filename="bulk_export.json"');
  1416|         return $response;
  1417|     }
  1418|     /**
  1419|      * @param ControllerEvent $event
  1420|      */
  1421|     public function onKernelControllerEvent(ControllerEvent $event)
  1422|     {
  1423|         $isMasterRequest = $event->isMasterRequest();
  1424|         if (!$isMasterRequest) {
  1425|             return;
  1426|         }
  1427|         $unrestrictedActions = [
  1428|             'getTreeAction', 'fieldcollectionListAction', 'fieldcollectionTreeAction', 'fieldcollectionGetAction',
  1429|             'getClassDefinitionForColumnConfigAction', 'objectbrickListAction', 'objectbrickTreeAction', 'objectbrickGetAction',
  1430|         ];
  1431|         $this->checkActionPermission($event, 'classes', $unrestrictedActions);
  1432|     }
  1433|     /**
  1434|      * @Route("/get-fieldcollection-usages", name="pimcore_admin_dataobject_class_getfieldcollectionusages", methods={"GET"})
  1435|      *
  1436|      * @param Request $request
  1437|      *
  1438|      * @return Response
  1439|      */
  1440|     public function getFieldcollectionUsagesAction(Request $request)
  1441|     {
  1442|         $key = $request->get('key');
  1443|         $result = [];
  1444|         $classes = new DataObject\ClassDefinition\Listing();
  1445|         $classes = $classes->load();
  1446|         foreach ($classes as $class) {
  1447|             $fieldDefs = $class->getFieldDefinitions();
  1448|             foreach ($fieldDefs as $fieldDef) {
  1449|                 if ($fieldDef instanceof DataObject\ClassDefinition\Data\Fieldcollections) {
  1450|                     $allowedKeys = $fieldDef->getAllowedTypes();
  1451|                     if (is_array($allowedKeys) && in_array($key, $allowedKeys)) {
  1452|                         $result[] = [
  1453|                             'class' => $class->getName(),
  1454|                             'field' => $fieldDef->getName(),
  1455|                         ];
  1456|                     }
  1457|                 }
  1458|             }
  1459|         }
  1460|         return $this->adminJson($result);
  1461|     }
  1462|     /**
  1463|      * @Route("/get-bricks-usages", name="pimcore_admin_dataobject_class_getbrickusages", methods={"GET"})
  1464|      *
  1465|      * @param Request $request
  1466|      *
  1467|      * @return Response
  1468|      */
  1469|     public function getBrickUsagesAction(Request $request)
  1470|     {
  1471|         $classId = $request->get('classId');
  1472|         $myclass = DataObject\ClassDefinition::getById($classId);
  1473|         $result = [];
  1474|         $brickDefinitions = new DataObject\Objectbrick\Definition\Listing();
  1475|         $brickDefinitions = $brickDefinitions->load();
  1476|         foreach ($brickDefinitions as $brickDefinition) {
  1477|             $classes = $brickDefinition->getClassDefinitions();
  1478|             foreach ($classes as $class) {
  1479|                 if ($myclass->getName() == $class['classname']) {
  1480|                     $result[] = [
  1481|                         'objectbrick' => $brickDefinition->getKey(),
  1482|                         'field' => $class['fieldname'],
  1483|                     ];
  1484|                 }
  1485|             }
  1486|         }
  1487|         return $this->adminJson($result);
  1488|     }
  1489|     /**
  1490|      * @Route("/get-icons", name="pimcore_admin_dataobject_class_geticons", methods={"GET"})
  1491|      *
  1492|      * @param Request $request
  1493|      * @param EventDispatcherInterface $eventDispatcher
  1494|      *
  1495|      * @return Response
  1496|      */
  1497|     public function getIconsAction(Request $request, EventDispatcherInterface $eventDispatcher)
  1498|     {
  1499|         $classId = $request->get('classId');
  1500|         $iconDir = PIMCORE_WEB_ROOT . '/bundles/pimcoreadmin/img';
  1501|         $classIcons = rscandir($iconDir . '/object-icons/');
  1502|         $colorIcons = rscandir($iconDir . '/flat-color-icons/');
  1503|         $twemoji = rscandir($iconDir . '/twemoji/');
  1504|         $icons = array_merge($classIcons, $colorIcons, $twemoji);
  1505|         foreach ($icons as &$icon) {
  1506|             $icon = str_replace(PIMCORE_WEB_ROOT, '', $icon);
  1507|         }
  1508|         $event = new GenericEvent($this, [
  1509|             'icons' => $icons,
  1510|             'classId' => $classId,
  1511|         ]);
  1512|         $eventDispatcher->dispatch($event, AdminEvents::CLASS_OBJECT_ICONS_PRE_SEND_DATA);
  1513|         $icons = $event->getArgument('icons');
  1514|         $result = [];
  1515|         foreach ($icons as $icon) {
  1516|             $result[] = [
  1517|                 'text' => "<img src='{$icon}'>",
  1518|                 'value' => $icon,
  1519|             ];
  1520|         }
  1521|         return $this->adminJson($result);
  1522|     }
  1523|     /**
  1524|      * @Route("/suggest-class-identifier", name="pimcore_admin_dataobject_class_suggestclassidentifier")
  1525|      *
  1526|      * @return Response
  1527|      */
  1528|     public function suggestClassIdentifierAction()
  1529|     {
  1530|         $db = Db::get();
  1531|         $maxId = $db->fetchOne('SELECT MAX(CAST(id AS SIGNED)) FROM classes;');
  1532|         $existingIds = $db->fetchCol('select LOWER(id) from classes');
  1533|         $result = [
  1534|             'suggestedIdentifier' => $maxId ? $maxId + 1 : 1,
  1535|             'existingIds' => $existingIds,
  1536|             ];
  1537|         return $this->adminJson($result);
  1538|     }
  1539|     /**
  1540|      * @Route("/suggest-custom-layout-identifier", name="pimcore_admin_dataobject_class_suggestcustomlayoutidentifier")
  1541|      *
  1542|      * @param Request $request
  1543|      *
  1544|      * @return Response
  1545|      */
  1546|     public function suggestCustomLayoutIdentifierAction(Request $request)
  1547|     {
  1548|         $classId = $request->get('classId');
  1549|         $identifier = DataObject\ClassDefinition\CustomLayout::getIdentifier($classId);
  1550|         $list = new DataObject\ClassDefinition\CustomLayout\Listing();
  1551|         $list = $list->load();
  1552|         $existingIds = [];
  1553|         $existingNames = [];
  1554|         foreach ($list as $item) {
  1555|             $existingIds[] = $item->getId();
  1556|             if ($item->getClassId() == $classId) {
  1557|                 $existingNames[] = $item->getName();
  1558|             }
  1559|         }
  1560|         $result = [
  1561|             'suggestedIdentifier' => $identifier,
  1562|             'existingIds' => $existingIds,
  1563|             'existingNames' => $existingNames,
  1564|             ];
  1565|         return $this->adminJson($result);
  1566|     }
  1567| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/DataObject/ClassificationstoreController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1264 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\DataObject;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Controller\KernelControllerEventInterface;
    17| use Pimcore\Db;
    18| use Pimcore\Model\DataObject;
    19| use Pimcore\Model\DataObject\Classificationstore;
    20| use Symfony\Component\HttpFoundation\JsonResponse;
    21| use Symfony\Component\HttpFoundation\Request;
    22| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    23| use Symfony\Component\Routing\Annotation\Route;
    24| /**
    25|  * @Route("/classificationstore")
    26|  *
    27|  * @internal
    28|  */
    29| class ClassificationstoreController extends AdminController implements KernelControllerEventInterface
    30| {
    31|     /**
    32|      * Delete collection with the group-relations
    33|      *
    34|      * @Route("/delete-collection", name="pimcore_admin_dataobject_classificationstore_deletecollection", methods={"DELETE"})
    35|      *
    36|      * @param Request $request
    37|      *
    38|      * @return JsonResponse
    39|      */
    40|     public function deleteCollectionAction(Request $request)
    41|     {
    42|         $id = $request->get('id');
    43|         $configRelations = new Classificationstore\CollectionGroupRelation\Listing();
    44|         $configRelations->setCondition('colId = ?', $id);
    45|         $list = $configRelations->load();
    46|         foreach ($list as $item) {
    47|             $item->delete();
    48|         }
    49|         $config = Classificationstore\CollectionConfig::getById($id);
    50|         $config->delete();
    51|         return $this->adminJson(['success' => true]);
    52|     }
    53|     /**
    54|      * @Route("/delete-collection-relation", name="pimcore_admin_dataobject_classificationstore_deletecollectionrelation", methods={"DELETE"})
    55|      *
    56|      * @param Request $request
    57|      *
    58|      * @return JsonResponse
    59|      */
    60|     public function deleteCollectionRelationAction(Request $request)
    61|     {
    62|         $colId = $request->get('colId');
    63|         $groupId = $request->get('groupId');
    64|         $config = new Classificationstore\CollectionGroupRelation();
    65|         $config->setColId($colId);
    66|         $config->setGroupId($groupId);
    67|         $config->delete();
    68|         return $this->adminJson(['success' => true]);
    69|     }
    70|     /**
    71|      * @Route("/delete-relation", name="pimcore_admin_dataobject_classificationstore_deleterelation", methods={"DELETE"})
    72|      *
    73|      * @param Request $request
    74|      *
    75|      * @return JsonResponse
    76|      */
    77|     public function deleteRelationAction(Request $request)
    78|     {
    79|         $keyId = $request->get('keyId');
    80|         $groupId = $request->get('groupId');
    81|         $config = new Classificationstore\KeyGroupRelation();
    82|         $config->setKeyId($keyId);
    83|         $config->setGroupId($groupId);
    84|         $config->delete();
    85|         return $this->adminJson(['success' => true]);
    86|     }
    87|     /**
    88|      * @Route("/delete-group", name="pimcore_admin_dataobject_classificationstore_deletegroup", methods={"DELETE"})
    89|      *
    90|      * @param Request $request
    91|      *
    92|      * @return JsonResponse
    93|      */
    94|     public function deleteGroupAction(Request $request)
    95|     {
    96|         $id = $request->get('id');
    97|         $config = Classificationstore\GroupConfig::getById($id);
    98|         $config->delete();
    99|         return $this->adminJson(['success' => true]);
   100|     }
   101|     /**
   102|      * @Route("/create-group", name="pimcore_admin_dataobject_classificationstore_creategroup", methods={"POST"})
   103|      *
   104|      * @param Request $request
   105|      *
   106|      * @return JsonResponse
   107|      */
   108|     public function createGroupAction(Request $request)
   109|     {
   110|         $name = $request->get('name');
   111|         $storeId = $request->get('storeId');
   112|         $config = Classificationstore\GroupConfig::getByName($name, $storeId);
   113|         if (!$config) {
   114|             $config = new Classificationstore\GroupConfig();
   115|             $config->setStoreId($storeId);
   116|             $config->setName($name);
   117|             $config->save();
   118|             return $this->adminJson(['success' => true, 'id' => $config->getName()]);
   119|         } else {
   120|             return $this->adminJson(['success' => false, 'id' => $config->getName(), 'message' => 'classificationstore_error_group_exists_msg']);
   121|         }
   122|     }
   123|     /**
   124|      * @Route("/create-store", name="pimcore_admin_dataobject_classificationstore_createstore", methods={"POST"})
   125|      *
   126|      * @param Request $request
   127|      *
   128|      * @return JsonResponse
   129|      *
   130|      * @throws \Exception
   131|      */
   132|     public function createStoreAction(Request $request)
   133|     {
   134|         $name = $request->get('name');
   135|         $config = Classificationstore\StoreConfig::getByName($name);
   136|         if (!$config) {
   137|             $config = new Classificationstore\StoreConfig();
   138|             $config->setName($name);
   139|             $config->save();
   140|         } else {
   141|             throw new \Exception('Store with the given name exists');
   142|         }
   143|         return $this->adminJson(['success' => true, 'storeId' => $config->getId()]);
   144|     }
   145|     /**
   146|      * @Route("/create-collection", name="pimcore_admin_dataobject_classificationstore_createcollection", methods={"POST"})
   147|      *
   148|      * @param Request $request
   149|      *
   150|      * @return JsonResponse
   151|      */
   152|     public function createCollectionAction(Request $request)
   153|     {
   154|         $name = $request->get('name');
   155|         $storeId = $request->get('storeId');
   156|         $config = Classificationstore\CollectionConfig::getByName($name, $storeId);
   157|         if (!$config) {
   158|             $config = new Classificationstore\CollectionConfig();
   159|             $config->setName($name);
   160|             $config->setStoreId($storeId);
   161|             $config->save();
   162|         }
   163|         return $this->adminJson(['success' => true, 'id' => $config->getName()]);
   164|     }
   165|     /**
   166|      * @Route("/collections", name="pimcore_admin_dataobject_classificationstore_collectionsactionget", methods={"GET"})
   167|      *
   168|      * @param Request $request
   169|      *
   170|      * @return JsonResponse
   171|      */
   172|     public function collectionsActionGet(Request $request)
   173|     {
   174|         $this->checkPermission('objects');
   175|         $start = 0;
   176|         $limit = $request->get('limit') ? $request->get('limit') : 15;
   177|         $orderKey = 'name';
   178|         $order = 'ASC';
   179|         if ($request->get('dir')) {
   180|             $order = $request->get('dir');
   181|         }
   182|         if ($request->get('limit')) {
   183|             $limit = $request->get('limit');
   184|         }
   185|         if ($request->get('start')) {
   186|             $start = $request->get('start');
   187|         }
   188|         $allParams = array_merge($request->request->all(), $request->query->all());
   189|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   190|         if ($sortingSettings['orderKey'] && $sortingSettings['order']) {
   191|             $orderKey = $sortingSettings['orderKey'];
   192|             $order = $sortingSettings['order'];
   193|         }
   194|         if ($request->get('overrideSort') == 'true') {
   195|             $orderKey = 'id';
   196|             $order = 'DESC';
   197|         }
   198|         $storeIdFromDefinition = 0;
   199|         $allowedCollectionIds = [];
   200|         if ($request->get('oid')) {
   201|             $object = DataObject\Concrete::getById($request->get('oid'));
   202|             $class = $object->getClass();
   203|             /** @var DataObject\ClassDefinition\Data\Classificationstore $fd */
   204|             $fd = $class->getFieldDefinition($request->get('fieldname'));
   205|             $allowedGroupIds = $fd->getAllowedGroupIds();
   206|             if ($allowedGroupIds) {
   207|                 $db = \Pimcore\Db::get();
   208|                 $query = 'select * from classificationstore_collectionrelations where groupId in (' . implode(',', $allowedGroupIds) .')';
   209|                 $relationList = $db->fetchAll($query);
   210|                 if (is_array($relationList)) {
   211|                     foreach ($relationList as $item) {
   212|                         $allowedCollectionIds[] = $item['colId'];
   213|                     }
   214|                 }
   215|             }
   216|             $storeIdFromDefinition = $fd->getStoreId();
   217|         }
   218|         $list = new Classificationstore\CollectionConfig\Listing();
   219|         $list->setLimit($limit);
   220|         $list->setOffset($start);
   221|         $list->setOrder($order);
   222|         $list->setOrderKey($orderKey);
   223|         $conditionParts = [];
   224|         $db = Db::get();
   225|         $searchfilter = $request->get('searchfilter');
   226|         if ($searchfilter) {
   227|             $conditionParts[] = '(name LIKE ' . $db->quote('%' . $searchfilter . '%') . ' OR description LIKE ' . $db->quote('%'. $searchfilter . '%') . ')';
   228|         }
   229|         $storeId = $request->get('storeId');
   230|         $storeId = $storeId ? $storeId : $storeIdFromDefinition;
   231|         $conditionParts[] = ' (storeId = ' . $db->quote($storeId) . ')';
   232|         if ($request->get('filter')) {
   233|             $filterString = $request->get('filter');
   234|             $filters = json_decode($filterString);
   235|             foreach ($filters as $f) {
   236|                 $conditionParts[] = $db->quoteIdentifier($f->property) . ' LIKE ' . $db->quote('%' . $f->value . '%');
   237|             }
   238|         }
   239|         if ($allowedCollectionIds) {
   240|             $conditionParts[] = ' id in (' . implode(',', $allowedCollectionIds) . ')';
   241|         }
   242|         $condition = implode(' AND ', $conditionParts);
   243|         $list->setCondition($condition);
   244|         $list->load();
   245|         $configList = $list->getList();
   246|         $rootElement = [];
   247|         $data = [];
   248|         foreach ($configList as $config) {
   249|             $name = $config->getName();
   250|             if (!$name) {
   251|                 $name = 'EMPTY';
   252|             }
   253|             $item = [
   254|                 'storeId' => $config->getStoreId(),
   255|                 'id' => $config->getId(),
   256|                 'name' => $name,
   257|                 'description' => $config->getDescription(),
   258|             ];
   259|             if ($config->getCreationDate()) {
   260|                 $item['creationDate'] = $config->getCreationDate();
   261|             }
   262|             if ($config->getModificationDate()) {
   263|                 $item['modificationDate'] = $config->getModificationDate();
   264|             }
   265|             $data[] = $item;
   266|         }
   267|         $rootElement['data'] = $data;
   268|         $rootElement['success'] = true;
   269|         $rootElement['total'] = $list->getTotalCount();
   270|         return $this->adminJson($rootElement);
   271|     }
   272|     /**
   273|      * @Route("/collections", name="pimcore_admin_dataobject_classificationstore_collections", methods={"POST", "PUT"})
   274|      *
   275|      * @param Request $request
   276|      *
   277|      * @return JsonResponse
   278|      */
   279|     public function collectionsAction(Request $request)
   280|     {
   281|         if ($request->get('data')) {
   282|             $dataParam = $request->get('data');
   283|             $data = $this->decodeJson($dataParam);
   284|             $id = $data['id'];
   285|             $config = Classificationstore\CollectionConfig::getById($id);
   286|             foreach ($data as $key => $value) {
   287|                 if ($key != 'id') {
   288|                     $setter = 'set' . $key;
   289|                     $config->$setter($value);
   290|                 }
   291|             }
   292|             $config->save();
   293|             return $this->adminJson(['success' => true, 'data' => $config]);
   294|         }
   295|         return $this->adminJson(['success' => false]);
   296|     }
   297|     /**
   298|      * @Route("/groups", name="pimcore_admin_dataobject_classificationstore_groupsactionget", methods={"GET"})
   299|      *
   300|      * @param Request $request
   301|      *
   302|      * @return JsonResponse
   303|      */
   304|     public function groupsActionGet(Request $request)
   305|     {
   306|         $this->checkPermission('objects');
   307|         $start = 0;
   308|         $limit = 15;
   309|         $orderKey = 'name';
   310|         $order = 'ASC';
   311|         if ($request->get('dir')) {
   312|             $order = $request->get('dir');
   313|         }
   314|         if ($request->get('sort')) {
   315|             $orderKey = $request->get('sort');
   316|         }
   317|         if ($request->get('limit')) {
   318|             $limit = $request->get('limit');
   319|         }
   320|         if ($request->get('start')) {
   321|             $start = $request->get('start');
   322|         }
   323|         $allParams = array_merge($request->request->all(), $request->query->all());
   324|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   325|         if ($sortingSettings['orderKey'] && $sortingSettings['order']) {
   326|             $orderKey = $sortingSettings['orderKey'];
   327|             $order = $sortingSettings['order'];
   328|         }
   329|         if ($request->get('overrideSort') == 'true') {
   330|             $orderKey = 'id';
   331|             $order = 'DESC';
   332|         }
   333|         $list = new Classificationstore\GroupConfig\Listing();
   334|         $list->setLimit($limit);
   335|         $list->setOffset($start);
   336|         $list->setOrder($order);
   337|         $list->setOrderKey($orderKey);
   338|         $conditionParts = [];
   339|         $db = Db::get();
   340|         $searchfilter = $request->get('searchfilter');
   341|         if ($searchfilter) {
   342|             $conditionParts[] = '(name LIKE ' . $db->quote('%' . $searchfilter . '%') . ' OR description LIKE ' . $db->quote('%'. $searchfilter . '%') . ')';
   343|         }
   344|         if ($request->get('storeId')) {
   345|             $conditionParts[] = '(storeId = ' . $db->quote($request->get('storeId')) . ')';
   346|         }
   347|         if ($request->get('filter')) {
   348|             $filterString = $request->get('filter');
   349|             $filters = json_decode($filterString);
   350|             foreach ($filters as $f) {
   351|                 $conditionParts[] = $db->quoteIdentifier($f->property) . ' LIKE ' . $db->quote('%' . $f->value . '%');
   352|             }
   353|         }
   354|         if ($request->get('oid')) {
   355|             $object = DataObject\Concrete::getById($request->get('oid'));
   356|             $class = $object->getClass();
   357|             /** @var DataObject\ClassDefinition\Data\Classificationstore $fd */
   358|             $fd = $class->getFieldDefinition($request->get('fieldname'));
   359|             $allowedGroupIds = $fd->getAllowedGroupIds();
   360|             if ($allowedGroupIds) {
   361|                 $conditionParts[] = 'ID in (' . implode(',', $allowedGroupIds) . ')';
   362|             }
   363|         }
   364|         $condition = implode(' AND ', $conditionParts);
   365|         $list->setCondition($condition);
   366|         $list->load();
   367|         $configList = $list->getList();
   368|         $rootElement = [];
   369|         $data = [];
   370|         foreach ($configList as $config) {
   371|             $name = $config->getName();
   372|             if (!$name) {
   373|                 $name = 'EMPTY';
   374|             }
   375|             $item = [
   376|                 'storeId' => $config->getStoreId(),
   377|                 'id' => $config->getId(),
   378|                 'name' => $name,
   379|                 'description' => $config->getDescription(),
   380|             ];
   381|             if ($config->getCreationDate()) {
   382|                 $item['creationDate'] = $config->getCreationDate();
   383|             }
   384|             if ($config->getModificationDate()) {
   385|                 $item['modificationDate'] = $config->getModificationDate();
   386|             }
   387|             $data[] = $item;
   388|         }
   389|         $rootElement['data'] = $data;
   390|         $rootElement['success'] = true;
   391|         $rootElement['total'] = $list->getTotalCount();
   392|         return $this->adminJson($rootElement);
   393|     }
   394|     /**
   395|      * @Route("/groups", name="pimcore_admin_dataobject_classificationstore_groupsaction", methods={"POST", "PUT"})
   396|      *
   397|      * @param Request $request
   398|      *
   399|      * @return JsonResponse
   400|      */
   401|     public function groupsAction(Request $request)
   402|     {
   403|         if ($request->get('data')) {
   404|             $dataParam = $request->get('data');
   405|             $data = $this->decodeJson($dataParam);
   406|             $id = $data['id'];
   407|             $config = Classificationstore\GroupConfig::getById($id);
   408|             foreach ($data as $key => $value) {
   409|                 if ($key != 'id') {
   410|                     $setter = 'set' . $key;
   411|                     $config->$setter($value);
   412|                 }
   413|             }
   414|             $config->save();
   415|             return $this->adminJson(['success' => true, 'data' => $config]);
   416|         }
   417|         return $this->adminJson(['success' => false]);
   418|     }
   419|     /**
   420|      * @Route("/collection-relations", name="pimcore_admin_dataobject_classificationstore_collectionrelationsget", methods={"GET"})
   421|      *
   422|      * @param Request $request
   423|      *
   424|      * @return JsonResponse
   425|      */
   426|     public function collectionRelationsGetAction(Request $request)
   427|     {
   428|         $mapping = ['groupName' => 'name', 'groupDescription' => 'description'];
   429|         $start = 0;
   430|         $limit = 15;
   431|         $orderKey = 'sorter';
   432|         $order = 'ASC';
   433|         if ($request->get('dir')) {
   434|             $order = $request->get('dir');
   435|         }
   436|         $allParams = array_merge($request->request->all(), $request->query->all());
   437|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   438|         if ($sortingSettings['orderKey'] && $sortingSettings['order']) {
   439|             $orderKey = $sortingSettings['orderKey'];
   440|             $order = $sortingSettings['order'];
   441|         }
   442|         if ($request->get('overrideSort') == 'true') {
   443|             $orderKey = 'id';
   444|             $order = 'DESC';
   445|         }
   446|         if ($request->get('limit')) {
   447|             $limit = $request->get('limit');
   448|         }
   449|         if ($request->get('start')) {
   450|             $start = $request->get('start');
   451|         }
   452|         $list = new Classificationstore\CollectionGroupRelation\Listing();
   453|         if ($limit > 0) {
   454|             $list->setLimit($limit);
   455|         }
   456|         $list->setOffset($start);
   457|         $list->setOrder($order);
   458|         $list->setOrderKey($orderKey);
   459|         $condition = '';
   460|         if ($request->get('filter')) {
   461|             $db = Db::get();
   462|             $filterString = $request->get('filter');
   463|             $filters = json_decode($filterString);
   464|             $count = 0;
   465|             foreach ($filters as $f) {
   466|                 if ($count > 0) {
   467|                     $condition .= ' AND ';
   468|                 }
   469|                 $count++;
   470|                 $fieldname = $mapping[$f->field];
   471|                 $condition .= $db->quoteIdentifier($fieldname) . ' LIKE ' . $db->quote('%' . $f->value . '%');
   472|             }
   473|         }
   474|         $colId = $request->get('colId');
   475|         if ($condition) {
   476|             $condition = '( ' . $condition . ' ) AND';
   477|         }
   478|         $condition .= ' colId = ' . $list->quote($colId);
   479|         $list->setCondition($condition);
   480|         $listItems = $list->load();
   481|         $rootElement = [];
   482|         $data = [];
   483|         foreach ($listItems as $config) {
   484|             $item = [
   485|                 'colId' => $config->getColId(),
   486|                 'groupId' => $config->getGroupId(),
   487|                 'groupName' => $config->getName(),
   488|                 'groupDescription' => $config->getDescription(),
   489|                 'id' => $config->getColId() . '-' . $config->getGroupId(),
   490|                 'sorter' => (int) $config->getSorter(),
   491|             ];
   492|             $data[] = $item;
   493|         }
   494|         $rootElement['data'] = $data;
   495|         $rootElement['success'] = true;
   496|         $rootElement['total'] = $list->getTotalCount();
   497|         return $this->adminJson($rootElement);
   498|     }
   499|     /**
   500|      * @Route("/collection-relations", name="pimcore_admin_dataobject_classificationstore_collectionrelations", methods={"POST", "PUT"})
   501|      *
   502|      * @param Request $request
   503|      *
   504|      * @return JsonResponse
   505|      */
   506|     public function collectionRelationsAction(Request $request)
   507|     {
   508|         if ($request->get('data')) {
   509|             $dataParam = $request->get('data');
   510|             $data = $this->decodeJson($dataParam);
   511|             if (count($data) == count($data, 1)) {
   512|                 $data = [$data];
   513|             }
   514|             foreach ($data as &$row) {
   515|                 $colId = $row['colId'];
   516|                 $groupId = $row['groupId'];
   517|                 $sorter = $row['sorter'];
   518|                 $config = new Classificationstore\CollectionGroupRelation();
   519|                 $config->setGroupId($groupId);
   520|                 $config->setColId($colId);
   521|                 $config->setSorter((int) $sorter);
   522|                 $config->save();
   523|                 $row['id'] = $config->getColId() . '-' . $config->getGroupId();
   524|             }
   525|             return $this->adminJson(['success' => true, 'data' => $data]);
   526|         }
   527|         return $this->adminJson(['success' => false]);
   528|     }
   529|     /**
   530|      * @Route("/list-stores", name="pimcore_admin_dataobject_classificationstore_liststores", methods={"GET"})
   531|      *
   532|      * @return JsonResponse
   533|      */
   534|     public function listStoresAction()
   535|     {
   536|         $storeConfigs = [];
   537|         $storeConfigListing = new Classificationstore\StoreConfig\Listing();
   538|         $storeConfigListing->load();
   539|         foreach ($storeConfigListing as $storeConfig) {
   540|             $storeConfigs[] = $storeConfig->getObjectVars();
   541|         }
   542|         return $this->adminJson($storeConfigs);
   543|     }
   544|     /**
   545|      * @Route("/search-relations", name="pimcore_admin_dataobject_classificationstore_searchrelations", methods={"GET"})
   546|      *
   547|      * @param Request $request
   548|      *
   549|      * @return JsonResponse
   550|      */
   551|     public function searchRelationsAction(Request $request)
   552|     {
   553|         $db = Db::get();
   554|         $storeId = $request->get('storeId');
   555|         $mapping = [
   556|             'groupName' => DataObject\Classificationstore\GroupConfig\Dao::TABLE_NAME_GROUPS .'.name',
   557|             'keyName' => DataObject\Classificationstore\KeyConfig\Dao::TABLE_NAME_KEYS .'.name',
   558|             'keyDescription' => DataObject\Classificationstore\KeyConfig\Dao::TABLE_NAME_KEYS. '.description', ];
   559|         $start = 0;
   560|         $limit = 15;
   561|         $orderKey = 'name';
   562|         $order = 'ASC';
   563|         if ($request->get('dir')) {
   564|             $order = $request->get('dir');
   565|         }
   566|         $allParams = array_merge($request->request->all(), $request->query->all());
   567|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   568|         if ($sortingSettings['orderKey'] && $sortingSettings['order']) {
   569|             $orderKey = $sortingSettings['orderKey'];
   570|             if ($orderKey == 'keyName') {
   571|                 $orderKey = 'name';
   572|             }
   573|             $order = $sortingSettings['order'];
   574|         }
   575|         if ($request->get('overrideSort') == 'true') {
   576|             $orderKey = 'id';
   577|             $order = 'DESC';
   578|         }
   579|         if ($request->get('limit')) {
   580|             $limit = $request->get('limit');
   581|         }
   582|         if ($request->get('start')) {
   583|             $start = $request->get('start');
   584|         }
   585|         $list = new Classificationstore\KeyGroupRelation\Listing();
   586|         if ($limit > 0) {
   587|             $list->setLimit($limit);
   588|         }
   589|         $list->setOffset($start);
   590|         $list->setOrder($order);
   591|         $list->setOrderKey($orderKey);
   592|         $conditionParts = [];
   593|         if ($request->get('filter')) {
   594|             $db = Db::get();
   595|             $filterString = $request->get('filter');
   596|             $filters = json_decode($filterString);
   597|             $count = 0;
   598|             foreach ($filters as $f) {
   599|                 $count++;
   600|                 $fieldname = $mapping[$f->property];
   601|                 $conditionParts[] = $fieldname . ' LIKE ' . $db->quote('%' . $f->value . '%');
   602|             }
   603|         }
   604|         $conditionParts[] = '  groupId IN (select id from classificationstore_groups where storeId = ' . $db->quote($storeId) . ')';
   605|         $searchfilter = $request->get('searchfilter');
   606|         if ($searchfilter) {
   607|             $conditionParts[] = '('
   608|                 . Classificationstore\KeyConfig\Dao::TABLE_NAME_KEYS . '.name LIKE ' . $db->quote('%' . $searchfilter . '%')
   609|                 . ' OR ' . Classificationstore\GroupConfig\Dao::TABLE_NAME_GROUPS . '.name LIKE ' . $db->quote('%' . $searchfilter . '%')
   610|                 . ' OR ' . Classificationstore\KeyConfig\Dao::TABLE_NAME_KEYS . '.description LIKE ' . $db->quote('%' . $searchfilter . '%') . ')';
   611|         }
   612|         $condition = implode(' AND ', $conditionParts);
   613|         $list->setCondition($condition);
   614|         $list->setResolveGroupName(1);
   615|         $listItems = $list->load();
   616|         $rootElement = [];
   617|         $data = [];
   618|         foreach ($listItems as $config) {
   619|             $item = [
   620|                 'keyId' => $config->getKeyId(),
   621|                 'groupId' => $config->getGroupId(),
   622|                 'keyName' => $config->getName(),
   623|                 'keyDescription' => $config->getDescription(),
   624|                 'id' => $config->getGroupId() . '-' . $config->getKeyId(),
   625|                 'sorter' => $config->getSorter(),
   626|             ];
   627|             $groupConfig = Classificationstore\GroupConfig::getById($config->getGroupId());
   628|             if ($groupConfig) {
   629|                 $item['groupName'] = $groupConfig->getName();
   630|             }
   631|             $data[] = $item;
   632|         }
   633|         $rootElement['data'] = $data;
   634|         $rootElement['success'] = true;
   635|         $rootElement['total'] = $list->getTotalCount();
   636|         return $this->adminJson($rootElement);
   637|     }
   638|     /**
   639|      * @Route("/relations", name="pimcore_admin_dataobject_classificationstore_relationsactionget", methods={"GET"})
   640|      *
   641|      * @param Request $request
   642|      *
   643|      * @return JsonResponse
   644|      */
   645|     public function relationsActionGet(Request $request)
   646|     {
   647|         $mapping = ['keyName' => 'name', 'keyDescription' => 'description'];
   648|         $start = 0;
   649|         $limit = 15;
   650|         $orderKey = 'name';
   651|         $order = 'ASC';
   652|         $relationIds = $request->get('relationIds');
   653|         if ($relationIds) {
   654|             $relationIds = json_decode($relationIds, true);
   655|         }
   656|         if ($request->get('dir')) {
   657|             $order = $request->get('dir');
   658|         }
   659|         $allParams = array_merge($request->request->all(), $request->query->all());
   660|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   661|         if ($sortingSettings['orderKey'] && $sortingSettings['order']) {
   662|             $orderKey = $sortingSettings['orderKey'];
   663|             $order = $sortingSettings['order'];
   664|         }
   665|         if ($request->get('overrideSort') == 'true') {
   666|             $orderKey = 'id';
   667|             $order = 'DESC';
   668|         }
   669|         if ($request->get('limit')) {
   670|             $limit = $request->get('limit');
   671|         } elseif (is_array($relationIds)) {
   672|             $limit = count($relationIds);
   673|         }
   674|         if ($request->get('start')) {
   675|             $start = $request->get('start');
   676|         }
   677|         $list = new Classificationstore\KeyGroupRelation\Listing();
   678|         if ($limit > 0) {
   679|             $list->setLimit($limit);
   680|         }
   681|         $list->setOffset($start);
   682|         $list->setOrder($order);
   683|         $list->setOrderKey($orderKey);
   684|         $conditionParts = [];
   685|         if ($request->get('filter')) {
   686|             $db = Db::get();
   687|             $filterString = $request->get('filter');
   688|             $filters = json_decode($filterString);
   689|             foreach ($filters as $f) {
   690|                 $fieldname = $mapping[$f->field];
   691|                 $conditionParts[] = $db->quoteIdentifier($fieldname) . ' LIKE ' . $db->quote('%' . $f->value . '%');
   692|             }
   693|         }
   694|         if (!$request->get('relationIds')) {
   695|             $groupId = $request->get('groupId');
   696|             $conditionParts[] = ' groupId = ' . $list->quote($groupId);
   697|         }
   698|         if ($relationIds) {
   699|             $relationParts = [];
   700|             foreach ($relationIds as $relationId) {
   701|                 $keyId = $relationId['keyId'];
   702|                 $groupId = $relationId['groupId'];
   703|                 $relationParts[] = '(keyId = ' . $list->quote($keyId) . ' AND groupId = ' . $list->quote($groupId) . ')';
   704|             }
   705|             $conditionParts[] = '(' . implode(' OR ', $relationParts) . ')';
   706|         }
   707|         $condition = implode(' AND ', $conditionParts);
   708|         $list->setCondition($condition);
   709|         $listItems = $list->load();
   710|         $rootElement = [];
   711|         $data = [];
   712|         foreach ($listItems as $config) {
   713|             $type = $config->getType();
   714|             $definition = json_decode($config->getDefinition());
   715|             $definition = \Pimcore\Model\DataObject\Classificationstore\Service::getFieldDefinitionFromJson($definition, $type);
   716|             DataObject\Service::enrichLayoutDefinition($definition);
   717|             $item = [
   718|                 'keyId' => $config->getKeyId(),
   719|                 'groupId' => $config->getGroupId(),
   720|                 'keyName' => $config->getName(),
   721|                 'keyDescription' => $config->getDescription(),
   722|                 'id' => $config->getGroupId() . '-' . $config->getKeyId(),
   723|                 'sorter' => (int) $config->getSorter(),
   724|                 'layout' => $definition,
   725|                 'mandatory' => $config->isMandatory(),
   726|             ];
   727|             $data[] = $item;
   728|         }
   729|         $rootElement['data'] = $data;
   730|         $rootElement['success'] = true;
   731|         $rootElement['total'] = $list->getTotalCount();
   732|         return $this->adminJson($rootElement);
   733|     }
   734|     /**
   735|      * @Route("/relations", name="pimcore_admin_dataobject_classificationstore_relations", methods={"POST", "PUT"})
   736|      *
   737|      * @param Request $request
   738|      *
   739|      * @return JsonResponse
   740|      */
   741|     public function relationsAction(Request $request)
   742|     {
   743|         if ($request->get('data')) {
   744|             $dataParam = $request->get('data');
   745|             $data = $this->decodeJson($dataParam);
   746|             $keyId = $data['keyId'];
   747|             $groupId = $data['groupId'];
   748|             $sorter = $data['sorter'];
   749|             $mandatory = $data['mandatory'];
   750|             $config = new Classificationstore\KeyGroupRelation();
   751|             $config->setGroupId($groupId);
   752|             $config->setKeyId($keyId);
   753|             $config->setSorter($sorter);
   754|             $config->setMandatory($mandatory);
   755|             $config->save();
   756|             $data['id'] = $config->getGroupId() . '-' . $config->getKeyId();
   757|             return $this->adminJson(['success' => true, 'data' => $data]);
   758|         }
   759|         return $this->adminJson(['success' => false]);
   760|     }
   761|     /**
   762|      * @Route("/add-collections", name="pimcore_admin_dataobject_classificationstore_addcollections", methods={"POST"})
   763|      *
   764|      * @param Request $request
   765|      *
   766|      * @return JsonResponse
   767|      */
   768|     public function addCollectionsAction(Request $request)
   769|     {
   770|         $this->checkPermission('objects');
   771|         $ids = $this->decodeJson($request->get('collectionIds'));
   772|         $oid = $request->get('oid');
   773|         $object = DataObject\Concrete::getById($oid);
   774|         $fieldname = $request->get('fieldname');
   775|         $data = [];
   776|         if ($ids) {
   777|             $db = \Pimcore\Db::get();
   778|             $mappedData = [];
   779|             $groupsData = $db->fetchAll('select * from classificationstore_groups g, classificationstore_collectionrelations c where colId IN (:ids) and g.id = c.groupId', [
   780|                 'ids' => implode(',', array_filter($ids, 'intval')),
   781|             ]);
   782|             foreach ($groupsData as $groupData) {
   783|                 $mappedData[$groupData['id']] = $groupData;
   784|             }
   785|             $groupIdList = [];
   786|             $groupId = null;
   787|             $allowedGroupIds = null;
   788|             if ($request->get('oid')) {
   789|                 $object = DataObject\Concrete::getById($request->get('oid'));
   790|                 $class = $object->getClass();
   791|                 /** @var DataObject\ClassDefinition\Data\Classificationstore $fd */
   792|                 $fd = $class->getFieldDefinition($request->get('fieldname'));
   793|                 $allowedGroupIds = $fd->getAllowedGroupIds();
   794|             }
   795|             foreach ($groupsData as $groupItem) {
   796|                 $groupId = $groupItem['groupId'];
   797|                 if (!$allowedGroupIds || in_array($groupId, $allowedGroupIds)) {
   798|                     $groupIdList[] = $groupId;
   799|                 }
   800|             }
   801|             if ($groupIdList) {
   802|                 $groupList = new Classificationstore\GroupConfig\Listing();
   803|                 $groupCondition = 'id in (' . implode(',', $groupIdList) . ')';
   804|                 $groupList->setCondition($groupCondition);
   805|                 $groupList = $groupList->load();
   806|                 $keyCondition = 'groupId in (' . implode(',', $groupIdList) . ')';
   807|                 $keyList = new Classificationstore\KeyGroupRelation\Listing();
   808|                 $keyList->setCondition($keyCondition);
   809|                 $keyList->setOrderKey(['sorter', 'id']);
   810|                 $keyList->setOrder(['ASC', 'ASC']);
   811|                 $keyList = $keyList->load();
   812|                 foreach ($groupList as $groupData) {
   813|                     $data[$groupData->getId()] = [
   814|                         'name' => $groupData->getName(),
   815|                         'id' => $groupData->getId(),
   816|                         'description' => $groupData->getDescription(),
   817|                         'keys' => [],
   818|                         'collectionId' => $mappedData[$groupId]['colId'],
   819|                     ];
   820|                 }
   821|                 foreach ($keyList as $keyData) {
   822|                     $groupId = $keyData->getGroupId();
   823|                     $keyList = $data[$groupId]['keys'];
   824|                     $type = $keyData->getType();
   825|                     $definition = json_decode($keyData->getDefinition());
   826|                     $definition = \Pimcore\Model\DataObject\Classificationstore\Service::getFieldDefinitionFromJson($definition, $type);
   827|                     if (method_exists($definition, '__wakeup')) {
   828|                         $definition->__wakeup();
   829|                     }
   830|                     $context['object'] = $object;
   831|                     $context['class'] = $object ? $object->getClass() : null;
   832|                     $context['ownerType'] = 'classificationstore';
   833|                     $context['ownerName'] = $fieldname;
   834|                     $context['keyId'] = $keyData->getKeyId();
   835|                     $context['groupId'] = $groupId;
   836|                     $context['keyDefinition'] = $definition;
   837|                     if (method_exists($definition, 'enrichLayoutDefinition')) {
   838|                         $definition = $definition->enrichLayoutDefinition($object, $context);
   839|                     }
   840|                     $keyList[] = [
   841|                         'name' => $keyData->getName(),
   842|                         'id' => $keyData->getKeyId(),
   843|                         'description' => $keyData->getDescription(),
   844|                         'definition' => $definition,
   845|                     ];
   846|                     $data[$groupId]['keys'] = $keyList;
   847|                 }
   848|             }
   849|         }
   850|         return $this->adminJson($data);
   851|     }
   852|     /**
   853|      * @Route("/add-groups", name="pimcore_admin_dataobject_classificationstore_addgroups", methods={"POST"})
   854|      *
   855|      * @param Request $request
   856|      *
   857|      * @return JsonResponse
   858|      */
   859|     public function addGroupsAction(Request $request)
   860|     {
   861|         $this->checkPermission('objects');
   862|         $ids = $this->decodeJson($request->get('groupIds'));
   863|         $oid = $request->get('oid');
   864|         $object = DataObject\Concrete::getById($oid);
   865|         $fieldname = $request->get('fieldname');
   866|         $keyCondition = 'groupId in (' . implode(',', array_fill(0, count($ids), '?')) . ')';
   867|         $keyList = new Classificationstore\KeyGroupRelation\Listing();
   868|         $keyList->setCondition($keyCondition, $ids);
   869|         $keyList->setOrderKey(['sorter', 'id']);
   870|         $keyList->setOrder(['ASC', 'ASC']);
   871|         $keyList = $keyList->load();
   872|         $groupCondition = 'id in (' . implode(',', array_fill(0, count($ids), '?')) . ')';
   873|         $groupList = new Classificationstore\GroupConfig\Listing();
   874|         $groupList->setCondition($groupCondition, $ids);
   875|         $groupList->setOrder('ASC');
   876|         $groupList->setOrderKey('id');
   877|         $groupList = $groupList->load();
   878|         $data = [];
   879|         foreach ($groupList as $groupData) {
   880|             $data[$groupData->getId()] = [
   881|                 'name' => $groupData->getName(),
   882|                 'id' => $groupData->getId(),
   883|                 'description' => $groupData->getDescription(),
   884|                 'keys' => [],
   885|             ];
   886|         }
   887|         foreach ($keyList as $keyData) {
   888|             $groupId = $keyData->getGroupId();
   889|             $keyList = $data[$groupId]['keys'];
   890|             $type = $keyData->getType();
   891|             $definition = json_decode($keyData->getDefinition());
   892|             $definition = \Pimcore\Model\DataObject\Classificationstore\Service::getFieldDefinitionFromJson($definition, $type);
   893|             if (method_exists($definition, '__wakeup')) {
   894|                 $definition->__wakeup();
   895|             }
   896|             $context['object'] = $object;
   897|             $context['class'] = $object ? $object->getClass() : null;
   898|             $context['ownerType'] = 'classificationstore';
   899|             $context['ownerName'] = $fieldname;
   900|             $context['keyId'] = $keyData->getKeyId();
   901|             $context['groupId'] = $groupId;
   902|             $context['keyDefinition'] = $definition;
   903|             if (method_exists($definition, 'enrichLayoutDefinition')) {
   904|                 $definition = $definition->enrichLayoutDefinition($object, $context);
   905|             }
   906|             $keyList[] = [
   907|                 'name' => $keyData->getName(),
   908|                 'id' => $keyData->getKeyId(),
   909|                 'description' => $keyData->getDescription(),
   910|                 'definition' => $definition,
   911|             ];
   912|             $data[$groupId]['keys'] = $keyList;
   913|         }
   914|         return $this->adminJson($data);
   915|     }
   916|     /**
   917|      * @Route("/properties", name="pimcore_admin_dataobject_classificationstore_propertiesget", methods={"GET"})
   918|      *
   919|      * @param Request $request
   920|      *
   921|      * @return JsonResponse
   922|      */
   923|     public function propertiesGetAction(Request $request)
   924|     {
   925|         $storeId = $request->get('storeId');
   926|         $frameName = $request->get('frameName');
   927|         $db = \Pimcore\Db::get();
   928|         $conditionParts = [];
   929|         if ($frameName) {
   930|             $keyCriteria = ' FALSE ';
   931|             $frameConfig = Classificationstore\CollectionConfig::getByName($frameName, $storeId);
   932|             if ($frameConfig) {
   933|                 $frameId = $frameConfig->getId();
   934|                 $groupList = new Classificationstore\CollectionGroupRelation\Listing();
   935|                 $groupList->setCondition('colId = ' . $db->quote($frameId));
   936|                 $groupList = $groupList->load();
   937|                 $groupIdList = [];
   938|                 foreach ($groupList as $groupEntry) {
   939|                     $groupIdList[] = $groupEntry->getGroupId();
   940|                 }
   941|                 if ($groupIdList) {
   942|                     $keyIdList = new Classificationstore\KeyGroupRelation\Listing();
   943|                     $keyIdList->setCondition('groupId in (' . implode(',', $groupIdList) . ')');
   944|                     $keyIdList = $keyIdList->load();
   945|                     if ($keyIdList) {
   946|                         $keyIds = [];
   947|                         foreach ($keyIdList as $keyEntry) {
   948|                             $keyIds[] = $keyEntry->getKeyId();
   949|                         }
   950|                         $keyCriteria = ' id in (' . implode(',', $keyIds) . ')';
   951|                     }
   952|                 }
   953|             }
   954|             $conditionParts[] = $keyCriteria;
   955|         }
   956|         $start = 0;
   957|         $limit = 15;
   958|         $orderKey = 'name';
   959|         $order = 'ASC';
   960|         if ($request->get('dir')) {
   961|             $order = $request->get('dir');
   962|         }
   963|         $allParams = array_merge($request->request->all(), $request->query->all());
   964|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   965|         if ($sortingSettings['orderKey'] && $sortingSettings['order']) {
   966|             $orderKey = $sortingSettings['orderKey'];
   967|             $order = $sortingSettings['order'];
   968|         }
   969|         if ($request->get('overrideSort') == 'true') {
   970|             $orderKey = 'id';
   971|             $order = 'DESC';
   972|         }
   973|         if ($request->get('limit')) {
   974|             $limit = $request->get('limit');
   975|         }
   976|         if ($request->get('start')) {
   977|             $start = $request->get('start');
   978|         }
   979|         $list = new Classificationstore\KeyConfig\Listing();
   980|         if ($limit > 0 && !$request->get('groupIds') && !$request->get('keyIds')) {
   981|             $list->setLimit($limit);
   982|         }
   983|         $list->setOffset($start);
   984|         $list->setOrder($order);
   985|         $list->setOrderKey($orderKey);
   986|         $searchfilter = $request->get('searchfilter');
   987|         if ($searchfilter) {
   988|             $conditionParts[] = '(name LIKE ' . $db->quote('%' . $searchfilter . '%') . ' OR description LIKE ' . $db->quote('%'. $searchfilter . '%') . ')';
   989|         }
   990|         if ($storeId) {
   991|             $conditionParts[] = '(storeId = ' . $storeId . ')';
   992|         }
   993|         if ($request->get('filter')) {
   994|             $filterString = $request->get('filter');
   995|             $filters = json_decode($filterString);
   996|             foreach ($filters as $f) {
   997|                 $conditionParts[] = $db->quoteIdentifier($f->property) . ' LIKE ' . $db->quote('%' . $f->value . '%');
   998|             }
   999|         }
  1000|         $condition = implode(' AND ', $conditionParts);
  1001|         $list->setCondition($condition);
  1002|         if ($request->get('groupIds') || $request->get('keyIds')) {
  1003|             $db = Db::get();
  1004|             if ($request->get('groupIds')) {
  1005|                 $ids = $this->decodeJson($request->get('groupIds'));
  1006|                 $col = 'group';
  1007|             } else {
  1008|                 $ids = $this->decodeJson($request->get('keyIds'));
  1009|                 $col = 'id';
  1010|             }
  1011|             $condition = $db->quoteIdentifier($col) . ' IN (';
  1012|             $count = 0;
  1013|             foreach ($ids as $theId) {
  1014|                 if ($count > 0) {
  1015|                     $condition .= ',';
  1016|                 }
  1017|                 $condition .= $theId;
  1018|                 $count++;
  1019|             }
  1020|             $condition .= ')';
  1021|             $list->setCondition($condition);
  1022|         }
  1023|         $list->load();
  1024|         $configList = $list->getList();
  1025|         $rootElement = [];
  1026|         $data = [];
  1027|         foreach ($configList as $config) {
  1028|             $item = $this->getConfigItem($config);
  1029|             $data[] = $item;
  1030|         }
  1031|         $rootElement['data'] = $data;
  1032|         $rootElement['success'] = true;
  1033|         $rootElement['total'] = $list->getTotalCount();
  1034|         return $this->adminJson($rootElement);
  1035|     }
  1036|     /**
  1037|      * @Route("/properties", name="pimcore_admin_dataobject_classificationstore_properties", methods={"POST", "PUT"})
  1038|      *
  1039|      * @param Request $request
  1040|      *
  1041|      * @return JsonResponse
  1042|      */
  1043|     public function propertiesAction(Request $request)
  1044|     {
  1045|         if ($request->get('data')) {
  1046|             $dataParam = $request->get('data');
  1047|             $data = $this->decodeJson($dataParam);
  1048|             $id = $data['id'];
  1049|             $config = Classificationstore\KeyConfig::getById($id);
  1050|             foreach ($data as $key => $value) {
  1051|                 if ($key != 'id') {
  1052|                     $setter = 'set' . $key;
  1053|                     if (method_exists($config, $setter)) {
  1054|                         $config->$setter($value);
  1055|                     }
  1056|                 }
  1057|             }
  1058|             $config->save();
  1059|             $item = $this->getConfigItem($config);
  1060|             return $this->adminJson(['success' => true, 'data' => $item]);
  1061|         }
  1062|         return $this->adminJson(['success' => false]);
  1063|     }
  1064|     /**
  1065|      * @param Classificationstore\KeyConfig $config
  1066|      *
  1067|      * @return array
  1068|      */
  1069|     protected function getConfigItem($config)
  1070|     {
  1071|         $name = $config->getName();
  1072|         $groupDescription = null;
  1073|         $item = [
  1074|             'storeId' => $config->getStoreId(),
  1075|             'id' => $config->getId(),
  1076|             'name' => $name,
  1077|             'description' => $config->getDescription(),
  1078|             'type' => $config->getType() ? $config->getType() : 'input',
  1079|             'definition' => $config->getDefinition(),
  1080|         ];
  1081|         if ($config->getDefinition()) {
  1082|             $definition = json_decode($config->getDefinition(), true);
  1083|             if ($definition) {
  1084|                 $item['title'] = $definition['title'];
  1085|             }
  1086|         }
  1087|         if ($config->getCreationDate()) {
  1088|             $item['creationDate'] = $config->getCreationDate();
  1089|         }
  1090|         if ($config->getModificationDate()) {
  1091|             $item['modificationDate'] = $config->getModificationDate();
  1092|         }
  1093|         return $item;
  1094|     }
  1095|     /**
  1096|      * @Route("/add-property", name="pimcore_admin_dataobject_classificationstore_addproperty", methods={"POST"})
  1097|      *
  1098|      * @param Request $request
  1099|      *
  1100|      * @return JsonResponse
  1101|      */
  1102|     public function addPropertyAction(Request $request)
  1103|     {
  1104|         $name = $request->get('name');
  1105|         $storeId = $request->get('storeId');
  1106|         $definition = [
  1107|             'fieldtype' => 'input',
  1108|             'name' => $name,
  1109|             'title' => $name,
  1110|             'datatype' => 'data',
  1111|         ];
  1112|         $config = new Classificationstore\KeyConfig();
  1113|         $config->setName($name);
  1114|         $config->setTitle($name);
  1115|         $config->setType('input');
  1116|         $config->setStoreId($storeId);
  1117|         $config->setEnabled(1);
  1118|         $config->setDefinition(json_encode($definition));
  1119|         $config->save();
  1120|         return $this->adminJson(['success' => true, 'id' => $config->getName()]);
  1121|     }
  1122|     /**
  1123|      * @Route("/delete-property", name="pimcore_admin_dataobject_classificationstore_deleteproperty", methods={"DELETE"})
  1124|      *
  1125|      * @param Request $request
  1126|      *
  1127|      * @return JsonResponse
  1128|      */
  1129|     public function deletePropertyAction(Request $request)
  1130|     {
  1131|         $id = $request->get('id');
  1132|         $config = Classificationstore\KeyConfig::getById($id);
  1133|         $config->setEnabled(false);
  1134|         $config->save();
  1135|         return $this->adminJson(['success' => true]);
  1136|     }
  1137|     /**
  1138|      * @Route("/edit-store", name="pimcore_admin_dataobject_classificationstore_editstore", methods={"PUT"})
  1139|      *
  1140|      * @param Request $request
  1141|      *
  1142|      * @return JsonResponse
  1143|      *
  1144|      * @throws \Exception
  1145|      */
  1146|     public function editStoreAction(Request $request)
  1147|     {
  1148|         $id = $request->get('id');
  1149|         $data = json_decode($request->get('data'), true);
  1150|         $name = $data['name'];
  1151|         if (!$name) {
  1152|             throw new \Exception('Name must not be empty');
  1153|         }
  1154|         $description = $data['description'];
  1155|         $config = Classificationstore\StoreConfig::getByName($name);
  1156|         if ($config && $config->getId() != $id) {
  1157|             throw new \Exception('There is already a config with the same name');
  1158|         }
  1159|         $config = Classificationstore\StoreConfig::getById($id);
  1160|         if (!$config) {
  1161|             throw new \Exception('Configuration does not exist');
  1162|         }
  1163|         $config->setName($name);
  1164|         $config->setDescription($description);
  1165|         $config->save();
  1166|         return $this->adminJson(['success' => true]);
  1167|     }
  1168|     /**
  1169|      * @Route("/storetree", name="pimcore_admin_dataobject_classificationstore_storetree", methods={"GET"})
  1170|      *
  1171|      * @param Request $request
  1172|      *
  1173|      * @return JsonResponse
  1174|      */
  1175|     public function storetreeAction(Request $request)
  1176|     {
  1177|         $result = [];
  1178|         $list = new Classificationstore\StoreConfig\Listing();
  1179|         $list = $list->load();
  1180|         foreach ($list as $item) {
  1181|             $resultItem = [
  1182|                 'id' => $item->getId(),
  1183|                 'text' => $item->getName(),
  1184|                 'expandable' => false,
  1185|                 'leaf' => true,
  1186|                 'expanded' => true,
  1187|                 'description' => $item->getDescription(),
  1188|                 'iconCls' => 'pimcore_icon_classificationstore',
  1189|             ];
  1190|             $resultItem['qtitle'] = 'ID: ' . $item->getId();
  1191|             if ($item->getDescription()) {
  1192|             }
  1193|             $resultItem['qtip'] = $item->getDescription() ? $item->getDescription() : ' ';
  1194|             $result[] = $resultItem;
  1195|         }
  1196|         return $this->adminJson($result);
  1197|     }
  1198|     /**
  1199|      * @Route("/get-page", name="pimcore_admin_dataobject_classificationstore_getpage", methods={"GET"})
  1200|      *
  1201|      * @param Request $request
  1202|      *
  1203|      * @return JsonResponse
  1204|      */
  1205|     public function getPageAction(Request $request)
  1206|     {
  1207|         $tableSuffix = $request->get('table');
  1208|         if (!in_arrayi($tableSuffix, ['keys', 'groups'])) {
  1209|             $tableSuffix = 'keys';
  1210|         }
  1211|         $table = 'classificationstore_' . $tableSuffix;
  1212|         $db = \Pimcore\Db::get();
  1213|         $id = (int) $request->get('id');
  1214|         $storeId = (int) $request->get('storeId');
  1215|         $pageSize = (int) $request->get('pageSize');
  1216|         if ($request->get('sortKey')) {
  1217|             $sortKey = $request->get('sortKey');
  1218|             $sortDir = $request->get('sortDir');
  1219|         } else {
  1220|             $sortKey = 'name';
  1221|             $sortDir = 'ASC';
  1222|         }
  1223|         if (!in_arrayi($sortDir, ['DESC', 'ASC'])) {
  1224|             $sortDir = 'DESC';
  1225|         }
  1226|         if (!in_arrayi($sortKey, ['name', 'title', 'description', 'id', 'type', 'creationDate', 'modificationDate', 'enabled', 'parentId', 'storeId'])) {
  1227|             $sortKey = 'name';
  1228|         }
  1229|         $sorter = ' order by `' . $sortKey .  '` ' . $sortDir;
  1230|         if ($table == 'keys') {
  1231|             $query = '
  1232|                 select *, (item.pos - 1)/ ' . $pageSize . ' + 1  as page from (
  1233|                     select * from (
  1234|                         select @rownum := @rownum + 1 as pos,  id, name, `type`
  1235|                         from `' . $table . '`
  1236|                         where enabled = 1 and storeId = ' . $storeId . $sorter . '
  1237|                       ) all_rows) item where id = ' . $id . ';';
  1238|         } else {
  1239|             $query = '
  1240|             select *, (item.pos - 1)/ ' . $pageSize . ' + 1  as page from (
  1241|                 select * from (
  1242|                     select @rownum := @rownum + 1 as pos,  id, name
  1243|                     from `' . $table . '`
  1244|                     where storeId = ' . $storeId . $sorter . '
  1245|                   ) all_rows) item where id = ' .  $id . ';';
  1246|         }
  1247|         $db->query('select @rownum := 0;');
  1248|         $result = $db->fetchAll($query);
  1249|         $page = (int) $result[0]['page'] ;
  1250|         return $this->adminJson(['success' => true, 'page' => $page]);
  1251|     }
  1252|     /**
  1253|      * @param ControllerEvent $event
  1254|      */
  1255|     public function onKernelControllerEvent(ControllerEvent $event)
  1256|     {
  1257|         $isMasterRequest = $event->isMasterRequest();
  1258|         if (!$isMasterRequest) {
  1259|             return;
  1260|         }
  1261|         $unrestrictedActions = ['collectionsActionGet', 'groupsActionGet', 'relationsActionGet', 'addGroupsAction', 'addCollectionsAction', 'searchRelationsAction'];
  1262|         $this->checkActionPermission($event, 'classes', $unrestrictedActions);
  1263|     }
  1264| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/DataObject/DataObjectController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1922 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\DataObject;
    15| use Pimcore\Bundle\AdminBundle\Controller\Admin\ElementControllerBase;
    16| use Pimcore\Bundle\AdminBundle\Controller\Traits\AdminStyleTrait;
    17| use Pimcore\Bundle\AdminBundle\Controller\Traits\ApplySchedulerDataTrait;
    18| use Pimcore\Bundle\AdminBundle\Helper\GridHelperService;
    19| use Pimcore\Bundle\AdminBundle\Security\CsrfProtectionHandler;
    20| use Pimcore\Controller\KernelControllerEventInterface;
    21| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    22| use Pimcore\Db;
    23| use Pimcore\Event\Admin\ElementAdminStyleEvent;
    24| use Pimcore\Event\AdminEvents;
    25| use Pimcore\Localization\LocaleServiceInterface;
    26| use Pimcore\Logger;
    27| use Pimcore\Model;
    28| use Pimcore\Model\DataObject;
    29| use Pimcore\Model\DataObject\ClassDefinition\Data\ManyToManyObjectRelation;
    30| use Pimcore\Model\DataObject\ClassDefinition\Data\Relations\AbstractRelations;
    31| use Pimcore\Model\DataObject\ClassDefinition\Data\ReverseObjectRelation;
    32| use Pimcore\Model\Element;
    33| use Pimcore\Model\Version;
    34| use Pimcore\Tool;
    35| use Symfony\Component\EventDispatcher\GenericEvent;
    36| use Symfony\Component\HttpFoundation\JsonResponse;
    37| use Symfony\Component\HttpFoundation\RedirectResponse;
    38| use Symfony\Component\HttpFoundation\Request;
    39| use Symfony\Component\HttpFoundation\Response;
    40| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    41| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    42| use Symfony\Component\Routing\Annotation\Route;
    43| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    44| /**
    45|  * @Route("/object")
    46|  *
    47|  * @internal
    48|  */
    49| class DataObjectController extends ElementControllerBase implements KernelControllerEventInterface
    50| {
    51|     use AdminStyleTrait;
    52|     use ElementEditLockHelperTrait;
    53|     use ApplySchedulerDataTrait;
    54|     /**
    55|      * @var DataObject\Service
    56|      */
    57|     protected $_objectService;
    58|     /**
    59|      * @var array
    60|      */
    61|     private $objectData;
    62|     /**
    63|      * @var array
    64|      */
    65|     private $metaData;
    66|     /**
    67|      * @Route("/tree-get-root", name="pimcore_admin_dataobject_dataobject_treegetroot", methods={"GET"})
    68|      *
    69|      * @param Request $request
    70|      *
    71|      * @return JsonResponse
    72|      */
    73|     public function treeGetRootAction(Request $request)
    74|     {
    75|         return parent::treeGetRootAction($request);
    76|     }
    77|     /**
    78|      * @Route("/delete-info", name="pimcore_admin_dataobject_dataobject_deleteinfo", methods={"GET"})
    79|      *
    80|      * @param Request $request
    81|      * @param EventDispatcherInterface $eventDispatcher
    82|      *
    83|      * @return JsonResponse
    84|      */
    85|     public function deleteInfoAction(Request $request, EventDispatcherInterface $eventDispatcher)
    86|     {
    87|         return parent::deleteInfoAction($request, $eventDispatcher);
    88|     }
    89|     /**
    90|      * @Route("/tree-get-childs-by-id", name="pimcore_admin_dataobject_dataobject_treegetchildsbyid", methods={"GET"})
    91|      *
    92|      * @param Request $request
    93|      * @param EventDispatcherInterface $eventDispatcher
    94|      *
    95|      * @return JsonResponse
    96|      */
    97|     public function treeGetChildsByIdAction(Request $request, EventDispatcherInterface $eventDispatcher)
    98|     {
    99|         $allParams = array_merge($request->request->all(), $request->query->all());
   100|         $filter = $request->get('filter');
   101|         $object = DataObject::getById($request->get('node'));
   102|         $objectTypes = null;
   103|         $objects = [];
   104|         $cv = false;
   105|         $offset = 0;
   106|         $total = 0;
   107|         if ($object instanceof DataObject\Concrete) {
   108|             $class = $object->getClass();
   109|             if ($class->getShowVariants()) {
   110|                 $objectTypes = DataObject::$types;
   111|             }
   112|         }
   113|         if (!$objectTypes) {
   114|             $objectTypes = [DataObject::OBJECT_TYPE_OBJECT, DataObject::OBJECT_TYPE_FOLDER];
   115|         }
   116|         $filteredTotalCount = 0;
   117|         $limit = 0;
   118|         if ($object->hasChildren($objectTypes)) {
   119|             $limit = (int)$request->get('limit');
   120|             if (!is_null($filter)) {
   121|                 if (substr($filter, -1) != '*') {
   122|                     $filter .= '*';
   123|                 }
   124|                 $filter = str_replace('*', '%', $filter);
   125|                 $limit = 100;
   126|             } elseif (!$request->get('limit')) {
   127|                 $limit = 100000000;
   128|             }
   129|             $offset = (int)$request->get('start');
   130|             $childsList = new DataObject\Listing();
   131|             $condition = "objects.o_parentId = '" . $object->getId() . "'";
   132|             if ($request->get('view')) {
   133|                 $cv = Element\Service::getCustomViewById($request->get('view'));
   134|                 if ($cv['classes']) {
   135|                     $cvConditions = [];
   136|                     $cvClasses = $cv['classes'];
   137|                     foreach ($cvClasses as $key => $cvClass) {
   138|                         $cvConditions[] = "objects.o_classId = '" . $key . "'";
   139|                     }
   140|                     $cvConditions[] = "objects.o_type = 'folder'";
   141|                     $condition .= ' AND (' . implode(' OR ', $cvConditions) . ')';
   142|                 }
   143|             }
   144|             if (!$this->getAdminUser()->isAdmin()) {
   145|                 $userIds = $this->getAdminUser()->getRoles();
   146|                 $userIds[] = $this->getAdminUser()->getId();
   147|                 $condition .= ' AND
   148|                 (
   149|                     (SELECT list FROM users_workspaces_object WHERE userId IN (' . implode(',', $userIds) . ') AND LOCATE(CONCAT(objects.o_path,objects.o_key),cpath)=1 ORDER BY LENGTH(cpath) DESC, FIELD(userId, '. $this->getAdminUser()->getId() .') DESC, list DESC LIMIT 1)=1
   150|                     OR
   151|                     (SELECT list FROM users_workspaces_object WHERE userId IN (' . implode(',', $userIds) . ') AND LOCATE(cpath,CONCAT(objects.o_path,objects.o_key))=1 ORDER BY LENGTH(cpath) DESC, FIELD(userId, '. $this->getAdminUser()->getId() .') DESC, list DESC LIMIT 1)=1
   152|                 )';
   153|             }
   154|             if (!is_null($filter)) {
   155|                 $db = Db::get();
   156|                 $condition .= ' AND CAST(objects.o_key AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci LIKE ' . $db->quote($filter);
   157|             }
   158|             $childsList->setCondition($condition);
   159|             $childsList->setLimit($limit);
   160|             $childsList->setOffset($offset);
   161|             if ($object->getChildrenSortBy() === 'index') {
   162|                 $childsList->setOrderKey('objects.o_index ASC', false);
   163|             } else {
   164|                 $childsList->setOrderKey(
   165|                     sprintf(
   166|                         'CAST(objects.o_%s AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci %s',
   167|                         $object->getChildrenSortBy(), $object->getChildrenSortOrder() ?? 'ASC'
   168|                     ),
   169|                     false
   170|                 );
   171|             }
   172|             $childsList->setObjectTypes($objectTypes);
   173|             Element\Service::addTreeFilterJoins($cv, $childsList);
   174|             $beforeListLoadEvent = new GenericEvent($this, [
   175|                 'list' => $childsList,
   176|                 'context' => $allParams,
   177|             ]);
   178|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::OBJECT_LIST_BEFORE_LIST_LOAD);
   179|             /** @var DataObject\Listing $childsList */
   180|             $childsList = $beforeListLoadEvent->getArgument('list');
   181|             $childs = $childsList->load();
   182|             $filteredTotalCount = $childsList->getTotalCount();
   183|             foreach ($childs as $child) {
   184|                 $tmpObject = $this->getTreeNodeConfig($child);
   185|                 if ($child->isAllowed('list')) {
   186|                     $objects[] = $tmpObject;
   187|                 }
   188|             }
   189|             $total = $cv
   190|                 ? $filteredTotalCount
   191|                 : $object->getChildAmount(null, $this->getAdminUser());
   192|         }
   193|         $event = new GenericEvent($this, [
   194|             'objects' => $objects,
   195|         ]);
   196|         $eventDispatcher->dispatch($event, AdminEvents::OBJECT_TREE_GET_CHILDREN_BY_ID_PRE_SEND_DATA);
   197|         $objects = $event->getArgument('objects');
   198|         if ($limit) {
   199|             return $this->adminJson([
   200|                 'offset' => $offset,
   201|                 'limit' => $limit,
   202|                 'total' => $total,
   203|                 'overflow' => !is_null($filter) && ($filteredTotalCount > $limit),
   204|                 'nodes' => $objects,
   205|                 'fromPaging' => (int)$request->get('fromPaging'),
   206|                 'filter' => $request->get('filter') ? $request->get('filter') : '',
   207|                 'inSearch' => (int)$request->get('inSearch'),
   208|             ]);
   209|         }
   210|         return $this->adminJson($objects);
   211|     }
   212|     /**
   213|      * @param DataObject\AbstractObject $element
   214|      *
   215|      * @return array
   216|      */
   217|     protected function getTreeNodeConfig($element): array
   218|     {
   219|         $child = $element;
   220|         $tmpObject = [
   221|             'id' => $child->getId(),
   222|             'idx' => (int)$child->getIndex(),
   223|             'key' => $child->getKey(),
   224|             'sortBy' => $child->getChildrenSortBy(),
   225|             'sortOrder' => $child->getChildrenSortOrder(),
   226|             'text' => htmlspecialchars($child->getKey()),
   227|             'type' => $child->getType(),
   228|             'path' => $child->getRealFullPath(),
   229|             'basePath' => $child->getRealPath(),
   230|             'elementType' => 'object',
   231|             'locked' => $child->isLocked(),
   232|             'lockOwner' => $child->getLocked() ? true : false,
   233|         ];
   234|         $allowedTypes = [DataObject::OBJECT_TYPE_OBJECT, DataObject::OBJECT_TYPE_FOLDER];
   235|         if ($child instanceof DataObject\Concrete && $child->getClass()->getShowVariants()) {
   236|             $allowedTypes[] = DataObject::OBJECT_TYPE_VARIANT;
   237|         }
   238|         $hasChildren = $child->hasChildren($allowedTypes);
   239|         $tmpObject['isTarget'] = false;
   240|         $tmpObject['allowDrop'] = false;
   241|         $tmpObject['allowChildren'] = false;
   242|         $tmpObject['leaf'] = !$hasChildren;
   243|         $tmpObject['isTarget'] = true;
   244|         if ($tmpObject['type'] != DataObject::OBJECT_TYPE_VARIANT) {
   245|             $tmpObject['allowDrop'] = true;
   246|         }
   247|         $tmpObject['allowChildren'] = true;
   248|         $tmpObject['leaf'] = !$hasChildren;
   249|         $tmpObject['cls'] = 'pimcore_class_icon ';
   250|         if ($child instanceof DataObject\Concrete) {
   251|             $tmpObject['published'] = $child->isPublished();
   252|             $tmpObject['className'] = $child->getClass()->getName();
   253|             if (!$child->isPublished()) {
   254|                 $tmpObject['cls'] .= 'pimcore_unpublished ';
   255|             }
   256|             $tmpObject['allowVariants'] = $child->getClass()->getAllowVariants();
   257|         }
   258|         $this->addAdminStyle($child, ElementAdminStyleEvent::CONTEXT_TREE, $tmpObject);
   259|         $tmpObject['expanded'] = !$hasChildren;
   260|         $tmpObject['permissions'] = $child->getUserPermissions();
   261|         if ($child->isLocked()) {
   262|             $tmpObject['cls'] .= 'pimcore_treenode_locked ';
   263|         }
   264|         if ($child->getLocked()) {
   265|             $tmpObject['cls'] .= 'pimcore_treenode_lockOwner ';
   266|         }
   267|         if ($tmpObject['leaf']) {
   268|             $tmpObject['expandable'] = false;
   269|             $tmpObject['expanded'] = true;
   270|             $tmpObject['leaf'] = false;
   271|             $tmpObject['loaded'] = true;
   272|         }
   273|         return $tmpObject;
   274|     }
   275|     /**
   276|      * @Route("/get-id-path-paging-info", name="pimcore_admin_dataobject_dataobject_getidpathpaginginfo", methods={"GET"})
   277|      *
   278|      * @param Request $request
   279|      *
   280|      * @return JsonResponse
   281|      */
   282|     public function getIdPathPagingInfoAction(Request $request)
   283|     {
   284|         $path = $request->get('path');
   285|         $pathParts = explode('/', $path);
   286|         $id = array_pop($pathParts);
   287|         $limit = $request->get('limit');
   288|         if (empty($limit)) {
   289|             $limit = 30;
   290|         }
   291|         $data = [];
   292|         $targetObject = DataObject::getById($id);
   293|         $object = $targetObject;
   294|         while ($parent = $object->getParent()) {
   295|             $list = new DataObject\Listing();
   296|             $list->setCondition('o_parentId = ?', $parent->getId());
   297|             $list->setUnpublished(true);
   298|             $total = $list->getTotalCount();
   299|             $info = [
   300|                 'total' => $total,
   301|             ];
   302|             if ($total > $limit) {
   303|                 $idList = $list->loadIdList();
   304|                 $position = array_search($object->getId(), $idList);
   305|                 $info['position'] = $position + 1;
   306|                 $info['page'] = ceil($info['position'] / $limit);
   307|                 $containsPaging = true;
   308|             }
   309|             $data[$parent->getId()] = $info;
   310|             $object = $parent;
   311|         }
   312|         return $this->adminJson($data);
   313|     }
   314|     /**
   315|      * @Route("/get", name="pimcore_admin_dataobject_dataobject_get", methods={"GET"})
   316|      *
   317|      * @param Request $request
   318|      * @param EventDispatcherInterface $eventDispatcher
   319|      *
   320|      * @return JsonResponse
   321|      *
   322|      * @throws \Exception
   323|      */
   324|     public function getAction(Request $request, EventDispatcherInterface $eventDispatcher)
   325|     {
   326|         $objectFromDatabase = DataObject\Concrete::getById((int)$request->get('id'));
   327|         if ($objectFromDatabase === null) {
   328|             return $this->adminJson(['success' => false, 'message' => 'element_not_found'], JsonResponse::HTTP_NOT_FOUND);
   329|         }
   330|         $objectFromDatabase = clone $objectFromDatabase;
   331|         $draftVersion = null;
   332|         $object = $this->getLatestVersion($objectFromDatabase, $draftVersion);
   333|         if ($object->isAllowed('save') || $object->isAllowed('publish') || $object->isAllowed('unpublish') || $object->isAllowed('delete')) {
   334|             if (Element\Editlock::isLocked($request->get('id'), 'object')) {
   335|                 return $this->getEditLockResponse($request->get('id'), 'object');
   336|             }
   337|             Element\Editlock::lock($request->get('id'), 'object');
   338|         }
   339|         $objectFromVersion = $object !== $objectFromDatabase;
   340|         if ($object->isAllowed('view')) {
   341|             $objectData = [];
   342|             /** -------------------------------------------------------------
   343|              *   Load some general data from published object (if existing)
   344|              *  ------------------------------------------------------------- */
   345|             $objectData['idPath'] = Element\Service::getIdPath($objectFromDatabase);
   346|             $previewGenerator = $objectFromDatabase->getClass()->getPreviewGenerator();
   347|             $linkGeneratorReference = $objectFromDatabase->getClass()->getLinkGeneratorReference();
   348|             $objectData['hasPreview'] = false;
   349|             if ($objectFromDatabase->getClass()->getPreviewUrl() || $linkGeneratorReference || $previewGenerator) {
   350|                 $objectData['hasPreview'] = true;
   351|             }
   352|             if ($draftVersion && $objectFromDatabase->getModificationDate() < $draftVersion->getDate()) {
   353|                 $objectData['draft'] = [
   354|                     'id' => $draftVersion->getId(),
   355|                     'modificationDate' => $draftVersion->getDate(),
   356|                 ];
   357|             }
   358|             $objectData['general'] = [];
   359|             $allowedKeys = ['o_published', 'o_key', 'o_id', 'o_creationDate', 'o_classId', 'o_className', 'o_type', 'o_parentId', 'o_userOwner'];
   360|             foreach ($objectFromDatabase->getObjectVars() as $key => $value) {
   361|                 if (in_array($key, $allowedKeys)) {
   362|                     $objectData['general'][$key] = $value;
   363|                 }
   364|             }
   365|             $objectData['general']['fullpath'] = $objectFromDatabase->getRealFullPath();
   366|             $objectData['general']['o_locked'] = $objectFromDatabase->isLocked();
   367|             $objectData['general']['php'] = [
   368|                 'classes' => array_merge([get_class($objectFromDatabase)], array_values(class_parents($objectFromDatabase))),
   369|                 'interfaces' => array_values(class_implements($objectFromDatabase)),
   370|             ];
   371|             $objectData['general']['allowInheritance'] = $objectFromDatabase->getClass()->getAllowInherit();
   372|             $objectData['general']['allowVariants'] = $objectFromDatabase->getClass()->getAllowVariants();
   373|             $objectData['general']['showVariants'] = $objectFromDatabase->getClass()->getShowVariants();
   374|             $objectData['general']['showAppLoggerTab'] = $objectFromDatabase->getClass()->getShowAppLoggerTab();
   375|             $objectData['general']['showFieldLookup'] = $objectFromDatabase->getClass()->getShowFieldLookup();
   376|             if ($objectFromDatabase instanceof DataObject\Concrete) {
   377|                 $objectData['general']['linkGeneratorReference'] = $linkGeneratorReference;
   378|                 if ($previewGenerator) {
   379|                     $objectData['general']['previewConfig'] = $previewGenerator->getPreviewConfig($objectFromDatabase);
   380|                 }
   381|             }
   382|             $objectData['layout'] = $objectFromDatabase->getClass()->getLayoutDefinitions();
   383|             $objectData['userPermissions'] = $objectFromDatabase->getUserPermissions();
   384|             $objectVersions = Element\Service::getSafeVersionInfo($objectFromDatabase->getVersions());
   385|             $objectData['versions'] = array_splice($objectVersions, -1, 1);
   386|             $objectData['scheduledTasks'] = $objectFromDatabase->getScheduledTasks();
   387|             $objectData['childdata']['id'] = $objectFromDatabase->getId();
   388|             $objectData['childdata']['data']['classes'] = $this->prepareChildClasses($objectFromDatabase->getDao()->getClasses());
   389|             $objectData['childdata']['data']['general'] = $objectData['general'];
   390|             /** -------------------------------------------------------------
   391|              *   Load remaining general data from latest version
   392|              *  ------------------------------------------------------------- */
   393|             $allowedKeys = ['o_modificationDate', 'o_userModification'];
   394|             foreach ($object->getObjectVars() as $key => $value) {
   395|                 if (in_array($key, $allowedKeys)) {
   396|                     $objectData['general'][$key] = $value;
   397|                 }
   398|             }
   399|             $this->getDataForObject($object, $objectFromVersion);
   400|             $objectData['data'] = $this->objectData;
   401|             $objectData['metaData'] = $this->metaData;
   402|             $objectData['properties'] = Element\Service::minimizePropertiesForEditmode($object->getProperties());
   403|             $objectData['general']['versionDate'] = $objectFromDatabase->getModificationDate();
   404|             $objectData['general']['versionCount'] = $objectFromDatabase->getVersionCount();
   405|             $this->addAdminStyle($object, ElementAdminStyleEvent::CONTEXT_EDITOR, $objectData['general']);
   406|             $currentLayoutId = $request->get('layoutId', null);
   407|             $validLayouts = DataObject\Service::getValidLayouts($object);
   408|             $ok = false;
   409|             foreach ($validLayouts as $key => $layout) {
   410|                 if ($currentLayoutId == $layout->getId()) {
   411|                     $ok = true;
   412|                 }
   413|             }
   414|             if (!$ok) {
   415|                 if (count($validLayouts) > 0) {
   416|                     $currentLayoutId = reset($validLayouts)->getId();
   417|                 }
   418|             }
   419|             if ((is_null($currentLayoutId) || !strlen($currentLayoutId)) && !empty($validLayouts)) {
   420|                 if (count($validLayouts) == 1) {
   421|                     $firstLayout = reset($validLayouts);
   422|                     $currentLayoutId = $firstLayout->getId();
   423|                 } else {
   424|                     foreach ($validLayouts as $checkDefaultLayout) {
   425|                         if ($checkDefaultLayout->getDefault()) {
   426|                             $currentLayoutId = $checkDefaultLayout->getId();
   427|                         }
   428|                     }
   429|                 }
   430|             }
   431|             if (!empty($validLayouts)) {
   432|                 $objectData['validLayouts'] = [ ];
   433|                 foreach ($validLayouts as $validLayout) {
   434|                     $objectData['validLayouts'][] = ['id' => $validLayout->getId(), 'name' => $validLayout->getName()];
   435|                 }
   436|                 $user = Tool\Admin::getCurrentUser();
   437|                 if (!is_null($currentLayoutId)) {
   438|                     if ($currentLayoutId == '0' && !$user->isAdmin()) {
   439|                         $first = reset($validLayouts);
   440|                         $currentLayoutId = $first->getId();
   441|                     }
   442|                 }
   443|                 if ($currentLayoutId == -1 && $user->isAdmin()) {
   444|                     $layout = DataObject\Service::getSuperLayoutDefinition($object);
   445|                     $objectData['layout'] = $layout;
   446|                 } elseif (!empty($currentLayoutId)) {
   447|                     if (is_array($validLayouts) && $validLayouts[$currentLayoutId]) {
   448|                         $customLayout = DataObject\ClassDefinition\CustomLayout::getById($currentLayoutId);
   449|                         $customLayoutDefinition = $customLayout->getLayoutDefinitions();
   450|                         $objectData['layout'] = $customLayoutDefinition;
   451|                     } else {
   452|                         $currentLayoutId = 0;
   453|                     }
   454|                 }
   455|                 $objectData['currentLayoutId'] = $currentLayoutId;
   456|             }
   457|             $event = new GenericEvent($this, [
   458|                 'data' => $objectData,
   459|                 'object' => $object,
   460|             ]);
   461|             DataObject\Service::enrichLayoutDefinition($objectData['layout'], $object);
   462|             $eventDispatcher->dispatch($event, AdminEvents::OBJECT_GET_PRE_SEND_DATA);
   463|             $data = $event->getArgument('data');
   464|             DataObject\Service::removeElementFromSession('object', $object->getId());
   465|             return $this->adminJson($data);
   466|         }
   467|         throw $this->createAccessDeniedHttpException();
   468|     }
   469|     /**
   470|      * @param DataObject\Concrete $object
   471|      * @param bool $objectFromVersion
   472|      */
   473|     private function getDataForObject(DataObject\Concrete $object, $objectFromVersion = false)
   474|     {
   475|         foreach ($object->getClass()->getFieldDefinitions(['object' => $object]) as $key => $def) {
   476|             $this->getDataForField($object, $key, $def, $objectFromVersion);
   477|         }
   478|     }
   479|     /**
   480|      * gets recursively attribute data from parent and fills objectData and metaData
   481|      *
   482|      * @param DataObject\Concrete $object
   483|      * @param string $key
   484|      * @param DataObject\ClassDefinition\Data $fielddefinition
   485|      * @param bool $objectFromVersion
   486|      * @param int $level
   487|      */
   488|     private function getDataForField($object, $key, $fielddefinition, $objectFromVersion, $level = 0)
   489|     {
   490|         $parent = DataObject\Service::hasInheritableParentObject($object);
   491|         $getter = 'get' . ucfirst($key);
   492|         if (
   493|             (!$objectFromVersion && $fielddefinition instanceof AbstractRelations)
   494|             || $fielddefinition instanceof ReverseObjectRelation
   495|         ) {
   496|             $refId = null;
   497|             if ($fielddefinition instanceof ReverseObjectRelation) {
   498|                 $refKey = $fielddefinition->getOwnerFieldName();
   499|                 $refClass = DataObject\ClassDefinition::getByName($fielddefinition->getOwnerClassName());
   500|                 if ($refClass) {
   501|                     $refId = $refClass->getId();
   502|                 }
   503|             } else {
   504|                 $refKey = $key;
   505|             }
   506|             $relations = $object->getRelationData($refKey, !$fielddefinition instanceof ReverseObjectRelation, $refId);
   507|             if (empty($relations) && !empty($parent)) {
   508|                 $this->getDataForField($parent, $key, $fielddefinition, $objectFromVersion, $level + 1);
   509|             } else {
   510|                 $data = [];
   511|                 if ($fielddefinition instanceof DataObject\ClassDefinition\Data\ManyToOneRelation) {
   512|                     if (isset($relations[0])) {
   513|                         $data = $relations[0];
   514|                         $data['published'] = (bool)$data['published'];
   515|                     } else {
   516|                         $data = null;
   517|                     }
   518|                 } elseif (
   519|                     ($fielddefinition instanceof DataObject\ClassDefinition\Data\OptimizedAdminLoadingInterface && $fielddefinition->isOptimizedAdminLoading())
   520|                     || ($fielddefinition instanceof ManyToManyObjectRelation && !$fielddefinition->getVisibleFields() && !$fielddefinition instanceof DataObject\ClassDefinition\Data\AdvancedManyToManyObjectRelation)
   521|                 ) {
   522|                     foreach ($relations as $rkey => $rel) {
   523|                         $index = $rkey + 1;
   524|                         $rel['fullpath'] = $rel['path'];
   525|                         $rel['classname'] = $rel['subtype'];
   526|                         $rel['rowId'] = $rel['id'] . AbstractRelations::RELATION_ID_SEPARATOR . $index . AbstractRelations::RELATION_ID_SEPARATOR . $rel['type'];
   527|                         $rel['published'] = (bool)$rel['published'];
   528|                         $data[] = $rel;
   529|                     }
   530|                 } else {
   531|                     $fieldData = $object->$getter();
   532|                     $data = $fielddefinition->getDataForEditmode($fieldData, $object, ['objectFromVersion' => $objectFromVersion]);
   533|                 }
   534|                 $this->objectData[$key] = $data;
   535|                 $this->metaData[$key]['objectid'] = $object->getId();
   536|                 $this->metaData[$key]['inherited'] = $level != 0;
   537|             }
   538|         } else {
   539|             $fieldData = $object->$getter();
   540|             $isInheritedValue = false;
   541|             if ($fielddefinition instanceof DataObject\ClassDefinition\Data\CalculatedValue) {
   542|                 $fieldData = new DataObject\Data\CalculatedValue($fielddefinition->getName());
   543|                 $fieldData->setContextualData('object', null, null, null, null, null, $fielddefinition);
   544|                 $value = $fielddefinition->getDataForEditmode($fieldData, $object, ['objectFromVersion' => $objectFromVersion]);
   545|             } else {
   546|                 $value = $fielddefinition->getDataForEditmode($fieldData, $object, ['objectFromVersion' => $objectFromVersion]);
   547|             }
   548|             if ($value && ($fieldData instanceof DataObject\Localizedfield || $fieldData instanceof DataObject\Classificationstore)) {
   549|                 $isInheritedValue = $value['inherited'];
   550|             }
   551|             if ($fielddefinition instanceof DataObject\ClassDefinition\Data\Objectbricks && is_array($value)) {
   552|                 foreach ($value as $singleBrickData) {
   553|                     if (!empty($singleBrickData['inherited'])) {
   554|                         $isInheritedValue = true;
   555|                     }
   556|                 }
   557|             }
   558|             if ($fielddefinition->isEmpty($fieldData) && !empty($parent)) {
   559|                 $this->getDataForField($parent, $key, $fielddefinition, $objectFromVersion, $level + 1);
   560|                 if ($fielddefinition instanceof DataObject\ClassDefinition\Data\Classificationstore && $level == 0) {
   561|                     $this->objectData[$key]['metaData'] = $value['metaData'] ?? [];
   562|                     $this->objectData[$key]['inherited'] = true;
   563|                 }
   564|             } else {
   565|                 $isInheritedValue = $isInheritedValue || ($level != 0);
   566|                 $this->metaData[$key]['objectid'] = $object->getId();
   567|                 $this->objectData[$key] = $value;
   568|                 $this->metaData[$key]['inherited'] = $isInheritedValue;
   569|                 if ($isInheritedValue && !$fielddefinition->isEmpty($fieldData) && !$fielddefinition->supportsInheritance()) {
   570|                     $this->objectData[$key] = null;
   571|                     $this->metaData[$key]['inherited'] = false;
   572|                     $this->metaData[$key]['hasParentValue'] = true;
   573|                 }
   574|             }
   575|         }
   576|     }
   577|     /**
   578|      * @Route("/get-folder", name="pimcore_admin_dataobject_dataobject_getfolder", methods={"GET"})
   579|      *
   580|      * @param Request $request
   581|      * @param EventDispatcherInterface $eventDispatcher
   582|      *
   583|      * @return JsonResponse
   584|      */
   585|     public function getFolderAction(Request $request, EventDispatcherInterface $eventDispatcher)
   586|     {
   587|         if (Element\Editlock::isLocked($request->get('id'), 'object')) {
   588|             return $this->getEditLockResponse($request->get('id'), 'object');
   589|         }
   590|         Element\Editlock::lock($request->get('id'), 'object');
   591|         $object = DataObject::getById((int)$request->get('id'));
   592|         if ($object->isAllowed('view')) {
   593|             $objectData = [];
   594|             $objectData['general'] = [];
   595|             $objectData['idPath'] = Element\Service::getIdPath($object);
   596|             $allowedKeys = ['o_published', 'o_key', 'o_id', 'o_type', 'o_path', 'o_modificationDate', 'o_creationDate', 'o_userOwner', 'o_userModification'];
   597|             foreach ($object->getObjectVars() as $key => $value) {
   598|                 if (strstr($key, 'o_') && in_array($key, $allowedKeys)) {
   599|                     $objectData['general'][$key] = $value;
   600|                 }
   601|             }
   602|             $objectData['general']['fullpath'] = $object->getRealFullPath();
   603|             $objectData['general']['o_locked'] = $object->isLocked();
   604|             $objectData['properties'] = Element\Service::minimizePropertiesForEditmode($object->getProperties());
   605|             $objectData['userPermissions'] = $object->getUserPermissions();
   606|             $objectData['classes'] = $this->prepareChildClasses($object->getDao()->getClasses());
   607|             $configFile = PIMCORE_CONFIGURATION_DIRECTORY . '/object/grid/' . $object->getId() . '-user_' . $this->getAdminUser()->getId() . '.psf';
   608|             if (is_file($configFile)) {
   609|                 $gridConfig = Tool\Serialize::unserialize(file_get_contents($configFile));
   610|                 if ($gridConfig) {
   611|                     $selectedClassId = $gridConfig['classId'];
   612|                     foreach ($objectData['classes'] as $class) {
   613|                         if ($class['id'] == $selectedClassId) {
   614|                             $objectData['selectedClass'] = $selectedClassId;
   615|                             break;
   616|                         }
   617|                     }
   618|                 }
   619|             }
   620|             $event = new GenericEvent($this, [
   621|                 'data' => $objectData,
   622|                 'object' => $object,
   623|             ]);
   624|             $eventDispatcher->dispatch($event, AdminEvents::OBJECT_GET_PRE_SEND_DATA);
   625|             $objectData = $event->getArgument('data');
   626|             return $this->adminJson($objectData);
   627|         }
   628|         throw $this->createAccessDeniedHttpException();
   629|     }
   630|     /**
   631|      * @param DataObject\ClassDefinition[] $classes
   632|      *
   633|      * @return array
   634|      */
   635|     protected function prepareChildClasses($classes)
   636|     {
   637|         $reduced = [];
   638|         foreach ($classes as $class) {
   639|             $reduced[] = [
   640|                 'id' => $class->getId(),
   641|                 'name' => $class->getName(),
   642|                 'inheritance' => $class->getAllowInherit(),
   643|             ];
   644|         }
   645|         return $reduced;
   646|     }
   647|     /**
   648|      * @Route("/add", name="pimcore_admin_dataobject_dataobject_add", methods={"POST"})
   649|      *
   650|      * @param Request $request
   651|      * @param Model\FactoryInterface $modelFactory
   652|      *
   653|      * @return JsonResponse
   654|      */
   655|     public function addAction(Request $request, Model\FactoryInterface $modelFactory)
   656|     {
   657|         $success = false;
   658|         $className = 'Pimcore\\Model\\DataObject\\' . ucfirst($request->get('className'));
   659|         $parent = DataObject::getById($request->get('parentId'));
   660|         $message = '';
   661|         $object = null;
   662|         if ($parent->isAllowed('create')) {
   663|             $intendedPath = $parent->getRealFullPath() . '/' . $request->get('key');
   664|             if (!DataObject\Service::pathExists($intendedPath)) {
   665|                 /** @var DataObject\Concrete $object */
   666|                 $object = $modelFactory->build($className);
   667|                 $object->setOmitMandatoryCheck(true); // allow to save the object although there are mandatory fields
   668|                 if ($request->get('variantViaTree')) {
   669|                     $parentId = $request->get('parentId');
   670|                     $parent = DataObject\Concrete::getById($parentId);
   671|                     $object->setClassId($parent->getClass()->getId());
   672|                 } else {
   673|                     $object->setClassId($request->get('classId'));
   674|                 }
   675|                 $object->setClassName($request->get('className'));
   676|                 $object->setParentId($request->get('parentId'));
   677|                 $object->setKey($request->get('key'));
   678|                 $object->setCreationDate(time());
   679|                 $object->setUserOwner($this->getAdminUser()->getId());
   680|                 $object->setUserModification($this->getAdminUser()->getId());
   681|                 $object->setPublished(false);
   682|                 if ($request->get('objecttype') == DataObject::OBJECT_TYPE_OBJECT
   683|                     || $request->get('objecttype') == DataObject::OBJECT_TYPE_VARIANT) {
   684|                     $object->setType($request->get('objecttype'));
   685|                 }
   686|                 try {
   687|                     $object->save();
   688|                     $success = true;
   689|                 } catch (\Exception $e) {
   690|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   691|                 }
   692|             } else {
   693|                 $message = 'prevented creating object because object with same path+key already exists';
   694|                 Logger::debug($message);
   695|             }
   696|         } else {
   697|             $message = 'prevented adding object because of missing permissions';
   698|             Logger::debug($message);
   699|         }
   700|         if ($success && $object instanceof DataObject\AbstractObject) {
   701|             return $this->adminJson([
   702|                 'success' => $success,
   703|                 'id' => $object->getId(),
   704|                 'type' => $object->getType(),
   705|                 'message' => $message,
   706|             ]);
   707|         } else {
   708|             return $this->adminJson([
   709|                 'success' => $success,
   710|                 'message' => $message,
   711|             ]);
   712|         }
   713|     }
   714|     /**
   715|      * @Route("/add-folder", name="pimcore_admin_dataobject_dataobject_addfolder", methods={"POST"})
   716|      *
   717|      * @param Request $request
   718|      *
   719|      * @return JsonResponse
   720|      */
   721|     public function addFolderAction(Request $request)
   722|     {
   723|         $success = false;
   724|         $parent = DataObject::getById($request->get('parentId'));
   725|         if ($parent->isAllowed('create')) {
   726|             if (!DataObject\Service::pathExists($parent->getRealFullPath() . '/' . $request->get('key'))) {
   727|                 $folder = DataObject\Folder::create([
   728|                     'o_parentId' => $request->get('parentId'),
   729|                     'o_creationDate' => time(),
   730|                     'o_userOwner' => $this->getAdminUser()->getId(),
   731|                     'o_userModification' => $this->getAdminUser()->getId(),
   732|                     'o_key' => $request->get('key'),
   733|                     'o_published' => true,
   734|                 ]);
   735|                 $folder->setCreationDate(time());
   736|                 $folder->setUserOwner($this->getAdminUser()->getId());
   737|                 $folder->setUserModification($this->getAdminUser()->getId());
   738|                 try {
   739|                     $folder->save();
   740|                     $success = true;
   741|                 } catch (\Exception $e) {
   742|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   743|                 }
   744|             }
   745|         } else {
   746|             Logger::debug('prevented creating object id because of missing permissions');
   747|         }
   748|         return $this->adminJson(['success' => $success]);
   749|     }
   750|     /**
   751|      * @Route("/delete", name="pimcore_admin_dataobject_dataobject_delete", methods={"DELETE"})
   752|      *
   753|      * @param Request $request
   754|      *
   755|      * @return JsonResponse
   756|      *
   757|      * @throws \Exception
   758|      */
   759|     public function deleteAction(Request $request)
   760|     {
   761|         if ($request->get('type') == 'childs') {
   762|             $parentObject = DataObject::getById($request->get('id'));
   763|             $list = new DataObject\Listing();
   764|             $list->setCondition('o_path LIKE ' . $list->quote($list->escapeLike($parentObject->getRealFullPath()) . '/%'));
   765|             $list->setLimit((int)$request->get('amount'));
   766|             $list->setOrderKey('LENGTH(o_path)', false);
   767|             $list->setOrder('DESC');
   768|             $deletedItems = [];
   769|             foreach ($list as $object) {
   770|                 $deletedItems[$object->getId()] = $object->getRealFullPath();
   771|                 if ($object->isAllowed('delete') && !$object->isLocked()) {
   772|                     $object->delete();
   773|                 }
   774|             }
   775|             return $this->adminJson(['success' => true, 'deleted' => $deletedItems]);
   776|         } elseif ($request->get('id')) {
   777|             $object = DataObject::getById($request->get('id'));
   778|             if ($object) {
   779|                 if (!$object->isAllowed('delete')) {
   780|                     throw $this->createAccessDeniedHttpException();
   781|                 } elseif ($object->isLocked()) {
   782|                     return $this->adminJson(['success' => false, 'message' => 'prevented deleting object, because it is locked: ID: ' . $object->getId()]);
   783|                 } else {
   784|                     $object->delete();
   785|                 }
   786|             }
   787|             return $this->adminJson(['success' => true]);
   788|         }
   789|         return $this->adminJson(['success' => false]);
   790|     }
   791|     /**
   792|      * @Route("/change-children-sort-by", name="pimcore_admin_dataobject_dataobject_changechildrensortby", methods={"PUT"})
   793|      *
   794|      * @param Request $request
   795|      *
   796|      * @return JsonResponse
   797|      *
   798|      * @throws \Exception
   799|      */
   800|     public function changeChildrenSortByAction(Request $request)
   801|     {
   802|         $object = DataObject::getById($request->get('id'));
   803|         if ($object) {
   804|             $sortBy = $request->get('sortBy');
   805|             $sortOrder = $request->get('childrenSortOrder');
   806|             $currentSortBy = $object->getChildrenSortBy();
   807|             $object->setChildrenSortBy($sortBy);
   808|             $object->setChildrenSortOrder($sortOrder);
   809|             if ($currentSortBy != $sortBy) {
   810|                 $user = Tool\Admin::getCurrentUser();
   811|                 if (!$user->isAdmin()) {
   812|                     return $this->json(['success' => false, 'message' => 'Changing the sort method is only allowed for admin users']);
   813|                 }
   814|                 if ($sortBy == 'index') {
   815|                     $this->reindexBasedOnSortOrder($object, $sortOrder);
   816|                 }
   817|             }
   818|             $object->save();
   819|             return $this->json(['success' => true]);
   820|         }
   821|         return $this->json(['success' => false, 'message' => 'Unable to change a sorting way of children items.']);
   822|     }
   823|     /**
   824|      * @Route("/update", name="pimcore_admin_dataobject_dataobject_update", methods={"PUT"})
   825|      *
   826|      * @param Request $request
   827|      *
   828|      * @return JsonResponse
   829|      *
   830|      * @throws \Exception
   831|      */
   832|     public function updateAction(Request $request)
   833|     {
   834|         $success = false;
   835|         $object = DataObject::getById($request->get('id'));
   836|         if ($object instanceof DataObject\Concrete) {
   837|             $object->setOmitMandatoryCheck(true);
   838|         }
   839|         if ($object instanceof DataObject\Concrete) {
   840|             $latestVersion = $object->getLatestVersion();
   841|             if ($latestVersion && $latestVersion->getData()->getModificationDate() != $object->getModificationDate()) {
   842|                 return $this->adminJson(['success' => false, 'message' => "You can't rename or relocate if there's a newer not published version"]);
   843|             }
   844|         }
   845|         $values = $this->decodeJson($request->get('values'));
   846|         if ($object->isAllowed('settings')) {
   847|             if (isset($values['key']) && $values['key'] && $object->isAllowed('rename')) {
   848|                 $object->setKey($values['key']);
   849|             } elseif (!isset($values['key']) || $values['key'] != $object->getKey()) {
   850|                 Logger::debug('prevented renaming object because of missing permissions ');
   851|             }
   852|             if (!empty($values['parentId'])) {
   853|                 $parent = DataObject::getById($values['parentId']);
   854|                 if ($object->getParentId() != $parent->getId()) {
   855|                     if (!$parent->isAllowed('create')) {
   856|                         throw new \Exception('Prevented moving object - no create permission on new parent ');
   857|                     }
   858|                     $objectWithSamePath = DataObject::getByPath($parent->getRealFullPath() . '/' . $object->getKey());
   859|                     if ($objectWithSamePath != null) {
   860|                         return $this->adminJson(['success' => false, 'message' => 'prevented creating object because object with same path+key already exists']);
   861|                     }
   862|                     if ($object->isLocked()) {
   863|                         return $this->adminJson(['success' => false, 'message' => 'prevented moving object, because it is locked: ID: ' . $object->getId()]);
   864|                     }
   865|                     $object->setParentId($values['parentId']);
   866|                 }
   867|             }
   868|             if (array_key_exists('locked', $values)) {
   869|                 $object->setLocked($values['locked']);
   870|             }
   871|             $object->setModificationDate(time());
   872|             $object->setUserModification($this->getAdminUser()->getId());
   873|             try {
   874|                 $isIndexUpdate = isset($values['index']) && is_int($values['index']);
   875|                 if ($isIndexUpdate) {
   876|                     $object->setIndex($values['index']);
   877|                 }
   878|                 $object->save();
   879|                 if ($isIndexUpdate) {
   880|                     $this->updateIndexesOfObjectSiblings($object, $values['index']);
   881|                 }
   882|                 $success = true;
   883|             } catch (\Exception $e) {
   884|                 Logger::error($e);
   885|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   886|             }
   887|         } elseif ($object->isAllowed('rename') && $values['key']) {
   888|             try {
   889|                 $object->setKey($values['key']);
   890|                 $object->save();
   891|                 $success = true;
   892|             } catch (\Exception $e) {
   893|                 Logger::error($e);
   894|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   895|             }
   896|         } else {
   897|             Logger::debug('prevented update object because of missing permissions.');
   898|         }
   899|         return $this->adminJson(['success' => $success]);
   900|     }
   901|     private function executeInsideTransaction(callable $fn)
   902|     {
   903|         $maxRetries = 5;
   904|         for ($retries = 0; $retries < $maxRetries; $retries++) {
   905|             try {
   906|                 Db::get()->beginTransaction();
   907|                 $fn();
   908|                 Db::get()->commit();
   909|                 break;
   910|             } catch (\Exception $e) {
   911|                 Db::get()->rollBack();
   912|                 if ($retries < ($maxRetries - 1)) {
   913|                     $run = $retries + 1;
   914|                     $waitTime = rand(1, 5) * 100000; // microseconds
   915|                     Logger::warn('Unable to finish transaction (' . $run . ". run) because of the following reason '" . $e->getMessage() . "'. --> Retrying in " . $waitTime . ' microseconds ... (' . ($run + 1) . ' of ' . $maxRetries . ')');
   916|                     usleep($waitTime); // wait specified time until we restart the transaction
   917|                 } else {
   918|                     Logger::error('Finally giving up restarting the same transaction again and again, last message: ' . $e->getMessage());
   919|                     throw $e;
   920|                 }
   921|             }
   922|         }
   923|     }
   924|     /**
   925|      * @param DataObject\AbstractObject $parentObject
   926|      * @param string $currentSortOrder
   927|      */
   928|     protected function reindexBasedOnSortOrder(DataObject\AbstractObject $parentObject, string $currentSortOrder)
   929|     {
   930|         $fn = function () use ($parentObject, $currentSortOrder) {
   931|             $list = new DataObject\Listing();
   932|             Db::get()->executeUpdate(
   933|                 'UPDATE '.$list->getDao()->getTableName().' o,
   934|                     (
   935|                     SELECT newIndex, o_id FROM (
   936|                         SELECT @n := @n +1 AS newIndex, o_id
   937|                         FROM '.$list->getDao()->getTableName().',
   938|                                 (SELECT @n := -1) variable
   939|                                  WHERE o_parentId = ? ORDER BY o_key ' . $currentSortOrder
   940|                                .') tmp
   941|                     ) order_table
   942|                     SET o.o_index = order_table.newIndex
   943|                     WHERE o.o_id=order_table.o_id',
   944|                 [
   945|                     $parentObject->getId(),
   946|                 ]
   947|             );
   948|             $db = Db::get();
   949|             $children = $db->fetchAll(
   950|                 'SELECT o_id, o_modificationDate, o_versionCount FROM objects'
   951|                 .' WHERE o_parentId = ? ORDER BY o_index ASC',
   952|                 [$parentObject->getId()]
   953|             );
   954|             $index = 0;
   955|             foreach ($children as $child) {
   956|                 $this->updateLatestVersionIndex($child['o_id'], $child['o_modificationDate']);
   957|                 $index++;
   958|                 DataObject::clearDependentCacheByObjectId($child['o_id']);
   959|             }
   960|         };
   961|         $this->executeInsideTransaction($fn);
   962|     }
   963|     private function updateLatestVersionIndex($objectId, $newIndex)
   964|     {
   965|         $object = DataObject\Concrete::getById($objectId);
   966|         if ($object && $latestVersion = $object->getLatestVersion()) {
   967|             $object = $latestVersion->loadData(false);
   968|             if ($newIndex !== $object->getIndex()) {
   969|                 $object->setIndex($newIndex);
   970|             }
   971|             $latestVersion->save();
   972|         }
   973|     }
   974|     /**
   975|      * @param DataObject\AbstractObject $updatedObject
   976|      * @param int $newIndex
   977|      */
   978|     protected function updateIndexesOfObjectSiblings(DataObject\AbstractObject $updatedObject, $newIndex)
   979|     {
   980|         $fn = function () use ($updatedObject, $newIndex) {
   981|             $list = new DataObject\Listing();
   982|             $updatedObject->saveIndex($newIndex);
   983|             Db::get()->executeUpdate(
   984|                 'UPDATE '.$list->getDao()->getTableName().' o,
   985|                     (
   986|                         SELECT newIndex, o_id FROM (SELECT @n := IF(@n = ? - 1,@n + 2,@n + 1) AS newIndex, o_id
   987|                         FROM '.$list->getDao()->getTableName().',
   988|                         (SELECT @n := -1) variable
   989|                         WHERE o_id != ? AND o_parentId = ? AND o_type IN (\''.implode(
   990|                     "','", [
   991|                         DataObject::OBJECT_TYPE_OBJECT,
   992|                         DataObject::OBJECT_TYPE_VARIANT,
   993|                         DataObject::OBJECT_TYPE_FOLDER,
   994|                     ]
   995|                 ).'\')
   996|                             ORDER BY o_index, o_id=?
   997|                         ) tmp
   998|                     ) order_table
   999|                     SET o.o_index = order_table.newIndex
  1000|                     WHERE o.o_id=order_table.o_id',
  1001|                 [
  1002|                     $newIndex,
  1003|                     $updatedObject->getId(),
  1004|                     $updatedObject->getParentId(),
  1005|                     $updatedObject->getId(),
  1006|                 ]
  1007|             );
  1008|             $db = Db::get();
  1009|             $siblings = $db->fetchAll(
  1010|                 'SELECT o_id, o_modificationDate, o_versionCount FROM objects'
  1011|                 ." WHERE o_parentId = ? AND o_id != ? AND o_type IN ('object', 'variant','folder') ORDER BY o_index ASC",
  1012|                 [$updatedObject->getParentId(), $updatedObject->getId()]
  1013|             );
  1014|             $index = 0;
  1015|             foreach ($siblings as $sibling) {
  1016|                 if ($index == $newIndex) {
  1017|                     $index++;
  1018|                 }
  1019|                 $this->updateLatestVersionIndex($sibling['o_id'], $index);
  1020|                 $index++;
  1021|                 DataObject::clearDependentCacheByObjectId($sibling['o_id']);
  1022|             }
  1023|         };
  1024|         $this->executeInsideTransaction($fn);
  1025|     }
  1026|     /**
  1027|      * @Route("/save", name="pimcore_admin_dataobject_dataobject_save", methods={"POST", "PUT"})
  1028|      *
  1029|      * @param Request $request
  1030|      *
  1031|      * @return JsonResponse
  1032|      *
  1033|      * @throws \Exception
  1034|      */
  1035|     public function saveAction(Request $request)
  1036|     {
  1037|         $objectFromDatabase = DataObject\Concrete::getById($request->get('id'));
  1038|         $object = $this->getLatestVersion($objectFromDatabase);
  1039|         $object->setUserModification($this->getAdminUser()->getId());
  1040|         $objectFromVersion = $object !== $objectFromDatabase;
  1041|         $originalModificationDate = $objectFromVersion ? $object->getModificationDate() : $objectFromDatabase->getModificationDate();
  1042|         if ($objectFromVersion) {
  1043|             if (method_exists($object, 'getLocalizedFields')) {
  1044|                 /** @var DataObject\Localizedfield $localizedFields */
  1045|                 $localizedFields = $object->getLocalizedFields();
  1046|                 $localizedFields->setLoadedAllLazyData();
  1047|             }
  1048|         }
  1049|         $data = [];
  1050|         if ($request->get('data')) {
  1051|             $data = $this->decodeJson($request->get('data'));
  1052|             foreach ($data as $key => $value) {
  1053|                 $fd = $object->getClass()->getFieldDefinition($key);
  1054|                 if ($fd) {
  1055|                     if ($fd instanceof DataObject\ClassDefinition\Data\Localizedfields) {
  1056|                         $user = Tool\Admin::getCurrentUser();
  1057|                         if (!$user->getAdmin()) {
  1058|                             $allowedLanguages = DataObject\Service::getLanguagePermissions($object, $user, 'lEdit');
  1059|                             if (!is_null($allowedLanguages)) {
  1060|                                 $allowedLanguages = array_keys($allowedLanguages);
  1061|                                 $submittedLanguages = array_keys($data[$key]);
  1062|                                 foreach ($submittedLanguages as $submittedLanguage) {
  1063|                                     if (!in_array($submittedLanguage, $allowedLanguages)) {
  1064|                                         unset($value[$submittedLanguage]);
  1065|                                     }
  1066|                                 }
  1067|                             }
  1068|                         }
  1069|                     }
  1070|                     if ($fd instanceof ReverseObjectRelation) {
  1071|                         $remoteClass = DataObject\ClassDefinition::getByName($fd->getOwnerClassName());
  1072|                         $relations = $object->getRelationData($fd->getOwnerFieldName(), false, $remoteClass->getId());
  1073|                         $toAdd = $this->detectAddedRemoteOwnerRelations($relations, $value);
  1074|                         $toDelete = $this->detectDeletedRemoteOwnerRelations($relations, $value);
  1075|                         if (count($toAdd) > 0 or count($toDelete) > 0) {
  1076|                             $this->processRemoteOwnerRelations($object, $toDelete, $toAdd, $fd->getOwnerFieldName());
  1077|                         }
  1078|                     } else {
  1079|                         $object->setValue($key, $fd->getDataFromEditmode($value, $object, ['objectFromVersion' => $objectFromVersion]));
  1080|                     }
  1081|                 }
  1082|             }
  1083|         }
  1084|         if ($request->get('general')) {
  1085|             $general = $this->decodeJson($request->get('general'));
  1086|             if (is_array($general) && count($general) > 0) {
  1087|                 foreach ($general as $key => $value) {
  1088|                     if (!in_array($key, ['o_id', 'o_classId', 'o_className', 'o_type', 'icon', 'o_userOwner', 'o_userModification', 'o_modificationDate'])) {
  1089|                         $object->setValue($key, $value);
  1090|                     }
  1091|                 }
  1092|             }
  1093|         }
  1094|         $this->assignPropertiesFromEditmode($request, $object);
  1095|         $this->applySchedulerDataToElement($request, $object);
  1096|         if (($request->get('task') === 'unpublish' && !$object->isAllowed('unpublish')) || ($request->get('task') === 'publish' && !$object->isAllowed('publish'))) {
  1097|             throw $this->createAccessDeniedHttpException();
  1098|         }
  1099|         if ($request->get('task') == 'unpublish') {
  1100|             $object->setPublished(false);
  1101|         }
  1102|         if ($request->get('task') == 'publish') {
  1103|             $object->setPublished(true);
  1104|         }
  1105|         if (in_array($request->get('task'), ['unpublish', 'version', 'autoSave'])) {
  1106|             $object->setOmitMandatoryCheck(true);
  1107|         }
  1108|         if (($request->get('task') == 'publish') || ($request->get('task') == 'unpublish')) {
  1109|             $object->save();
  1110|             $treeData = $this->getTreeNodeConfig($object);
  1111|             $newObject = DataObject::getById($object->getId(), true);
  1112|             if ($request->get('task') == 'publish') {
  1113|                 $object->deleteAutoSaveVersions($this->getUser()->getId());
  1114|             }
  1115|             return $this->adminJson([
  1116|                 'success' => true,
  1117|                 'general' => ['o_modificationDate' => $object->getModificationDate(),
  1118|                     'versionDate' => $newObject->getModificationDate(),
  1119|                     'versionCount' => $newObject->getVersionCount(),
  1120|                 ],
  1121|                 'treeData' => $treeData,
  1122|             ]);
  1123|         } elseif ($request->get('task') == 'session') {
  1124|             DataObject\Service::saveElementToSession($object, '', false);
  1125|             return $this->adminJson(['success' => true]);
  1126|         } elseif ($request->get('task') == 'scheduler') {
  1127|             if ($object->isAllowed('settings')) {
  1128|                 $object->saveScheduledTasks();
  1129|                 return $this->adminJson(['success' => true]);
  1130|             }
  1131|         } elseif ($object->isAllowed('save')) {
  1132|             $isAutoSave = $request->get('task') == 'autoSave';
  1133|             $draftData = [];
  1134|             if ($object->isPublished() || $isAutoSave) {
  1135|                 $version = $object->saveVersion(true, true, null, $isAutoSave);
  1136|                 $draftData = [
  1137|                     'id' => $version->getId(),
  1138|                     'modificationDate' => $version->getDate(),
  1139|                 ];
  1140|             } else {
  1141|                 $object->save();
  1142|             }
  1143|             if ($request->get('task') == 'version') {
  1144|                 $object->deleteAutoSaveVersions($this->getUser()->getId());
  1145|             }
  1146|             $treeData = $this->getTreeNodeConfig($object);
  1147|             $newObject = DataObject::getById($object->getId(), true);
  1148|             return $this->adminJson([
  1149|                 'success' => true,
  1150|                 'general' => ['o_modificationDate' => $object->getModificationDate(),
  1151|                     'versionDate' => $newObject->getModificationDate(),
  1152|                     'versionCount' => $newObject->getVersionCount(),
  1153|                 ],
  1154|                 'draft' => $draftData,
  1155|                 'treeData' => $treeData,
  1156|             ]);
  1157|         }
  1158|         throw $this->createAccessDeniedHttpException();
  1159|     }
  1160|     /**
  1161|      * @param Request $request
  1162|      * @param DataObject\Concrete $object
  1163|      * @param int $originalModificationDate
  1164|      * @param array $data
  1165|      *
  1166|      * @return bool
  1167|      *
  1168|      * @throws \Exception
  1169|      */
  1170|     protected function performFieldcollectionModificationCheck(Request $request, DataObject\Concrete $object, $originalModificationDate, $data)
  1171|     {
  1172|         $modificationDate = $request->get('modificationDate');
  1173|         if ($modificationDate != $originalModificationDate) {
  1174|             $fielddefinitions = $object->getClass()->getFieldDefinitions();
  1175|             foreach ($fielddefinitions as $fd) {
  1176|                 if ($fd instanceof DataObject\ClassDefinition\Data\Fieldcollections) {
  1177|                     if (isset($data[$fd->getName()])) {
  1178|                         $allowedTypes = $fd->getAllowedTypes();
  1179|                         foreach ($allowedTypes as $type) {
  1180|                             /** @var DataObject\Fieldcollection\Definition $fdDef */
  1181|                             $fdDef = DataObject\Fieldcollection\Definition::getByKey($type);
  1182|                             $childDefinitions = $fdDef->getFieldDefinitions();
  1183|                             foreach ($childDefinitions as $childDef) {
  1184|                                 if ($childDef instanceof DataObject\ClassDefinition\Data\Localizedfields) {
  1185|                                     return false;
  1186|                                 }
  1187|                             }
  1188|                         }
  1189|                     }
  1190|                 }
  1191|             }
  1192|         }
  1193|         return true;
  1194|     }
  1195|     /**
  1196|      * @Route("/save-folder", name="pimcore_admin_dataobject_dataobject_savefolder", methods={"PUT"})
  1197|      *
  1198|      * @param Request $request
  1199|      *
  1200|      * @return JsonResponse
  1201|      */
  1202|     public function saveFolderAction(Request $request)
  1203|     {
  1204|         $object = DataObject::getById($request->get('id'));
  1205|         if (!$object) {
  1206|             throw $this->createNotFoundException('Object not found');
  1207|         }
  1208|         if ($object->isAllowed('publish')) {
  1209|             try {
  1210|                 $general = $this->decodeJson($request->get('general'));
  1211|                 $object->setValues($general);
  1212|                 $object->setUserModification($this->getAdminUser()->getId());
  1213|                 $this->assignPropertiesFromEditmode($request, $object);
  1214|                 $object->save();
  1215|                 return $this->adminJson(['success' => true]);
  1216|             } catch (\Exception $e) {
  1217|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
  1218|             }
  1219|         }
  1220|         throw $this->createAccessDeniedHttpException();
  1221|     }
  1222|     /**
  1223|      * @param Request $request
  1224|      * @param DataObject\AbstractObject $object
  1225|      */
  1226|     protected function assignPropertiesFromEditmode(Request $request, $object)
  1227|     {
  1228|         if ($request->get('properties')) {
  1229|             $properties = [];
  1230|             foreach ($object->getProperties() as $p) {
  1231|                 if ($p->isInherited()) {
  1232|                     $properties[$p->getName()] = $p;
  1233|                 }
  1234|             }
  1235|             $propertiesData = $this->decodeJson($request->get('properties'));
  1236|             if (is_array($propertiesData)) {
  1237|                 foreach ($propertiesData as $propertyName => $propertyData) {
  1238|                     $value = $propertyData['data'];
  1239|                     try {
  1240|                         $property = new Model\Property();
  1241|                         $property->setType($propertyData['type']);
  1242|                         $property->setName($propertyName);
  1243|                         $property->setCtype('object');
  1244|                         $property->setDataFromEditmode($value);
  1245|                         $property->setInheritable($propertyData['inheritable']);
  1246|                         $properties[$propertyName] = $property;
  1247|                     } catch (\Exception $e) {
  1248|                         Logger::err("Can't add " . $propertyName . ' to object ' . $object->getRealFullPath());
  1249|                     }
  1250|                 }
  1251|             }
  1252|             $object->setProperties($properties);
  1253|         }
  1254|     }
  1255|     /**
  1256|      * @Route("/publish-version", name="pimcore_admin_dataobject_dataobject_publishversion", methods={"POST"})
  1257|      *
  1258|      * @param Request $request
  1259|      *
  1260|      * @return JsonResponse
  1261|      */
  1262|     public function publishVersionAction(Request $request)
  1263|     {
  1264|         $version = Model\Version::getById($request->get('id'));
  1265|         $object = $version->loadData();
  1266|         $currentObject = DataObject::getById($object->getId());
  1267|         if ($currentObject->isAllowed('publish')) {
  1268|             $object->setPublished(true);
  1269|             $object->setUserModification($this->getAdminUser()->getId());
  1270|             try {
  1271|                 $object->save();
  1272|                 $this->addAdminStyle($object, ElementAdminStyleEvent::CONTEXT_TREE, $treeData);
  1273|                 return $this->adminJson(
  1274|                     [
  1275|                         'success' => true,
  1276|                         'general' => ['o_modificationDate' => $object->getModificationDate() ],
  1277|                         'treeData' => $treeData, ]
  1278|                 );
  1279|             } catch (\Exception $e) {
  1280|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
  1281|             }
  1282|         }
  1283|         throw $this->createAccessDeniedHttpException();
  1284|     }
  1285|     /**
  1286|      * @Route("/preview-version", name="pimcore_admin_dataobject_dataobject_previewversion", methods={"GET"})
  1287|      *
  1288|      * @param Request $request
  1289|      *
  1290|      * @throws \Exception
  1291|      *
  1292|      * @return Response
  1293|      */
  1294|     public function previewVersionAction(Request $request)
  1295|     {
  1296|         DataObject::setDoNotRestoreKeyAndPath(true);
  1297|         $id = (int)$request->get('id');
  1298|         $version = Model\Version::getById($id);
  1299|         $object = $version->loadData();
  1300|         if (method_exists($object, 'getLocalizedFields')) {
  1301|             /** @var DataObject\Localizedfield $localizedFields */
  1302|             $localizedFields = $object->getLocalizedFields();
  1303|             $localizedFields->setLoadedAllLazyData();
  1304|         }
  1305|         DataObject::setDoNotRestoreKeyAndPath(false);
  1306|         if ($object) {
  1307|             if ($object->isAllowed('versions')) {
  1308|                 return $this->render('@PimcoreAdmin/Admin/DataObject/DataObject/previewVersion.html.twig',
  1309|                     [
  1310|                         'object' => $object,
  1311|                         'versionNote' => $version->getNote(),
  1312|                         'validLanguages' => Tool::getValidLanguages(),
  1313|                     ]);
  1314|             }
  1315|             throw $this->createAccessDeniedException('Permission denied, version id [' . $id . ']');
  1316|         }
  1317|         throw $this->createNotFoundException('Version with id [' . $id . "] doesn't exist");
  1318|     }
  1319|     /**
  1320|      * @Route("/diff-versions/from/{from}/to/{to}", name="pimcore_admin_dataobject_dataobject_diffversions", methods={"GET"})
  1321|      *
  1322|      * @param Request $request
  1323|      * @param int $from
  1324|      * @param int $to
  1325|      *
  1326|      * @return Response
  1327|      *
  1328|      * @throws \Exception
  1329|      */
  1330|     public function diffVersionsAction(Request $request, $from, $to)
  1331|     {
  1332|         DataObject::setDoNotRestoreKeyAndPath(true);
  1333|         $id1 = (int)$from;
  1334|         $id2 = (int)$to;
  1335|         $version1 = Model\Version::getById($id1);
  1336|         $object1 = $version1->loadData();
  1337|         if (method_exists($object1, 'getLocalizedFields')) {
  1338|             /** @var DataObject\Localizedfield $localizedFields1 */
  1339|             $localizedFields1 = $object1->getLocalizedFields();
  1340|             $localizedFields1->setLoadedAllLazyData();
  1341|         }
  1342|         $version2 = Model\Version::getById($id2);
  1343|         $object2 = $version2->loadData();
  1344|         if (method_exists($object2, 'getLocalizedFields')) {
  1345|             /** @var DataObject\Localizedfield $localizedFields2 */
  1346|             $localizedFields2 = $object2->getLocalizedFields();
  1347|             $localizedFields2->setLoadedAllLazyData();
  1348|         }
  1349|         DataObject::setDoNotRestoreKeyAndPath(false);
  1350|         if ($object1 && $object2) {
  1351|             if ($object1->isAllowed('versions') && $object2->isAllowed('versions')) {
  1352|                 return $this->render('@PimcoreAdmin/Admin/DataObject/DataObject/diffVersions.html.twig',
  1353|                     [
  1354|                         'object1' => $object1,
  1355|                         'versionNote1' => $version1->getNote(),
  1356|                         'object2' => $object2,
  1357|                         'versionNote2' => $version2->getNote(),
  1358|                         'validLanguages' => Tool::getValidLanguages(),
  1359|                     ]);
  1360|             }
  1361|             throw $this->createAccessDeniedException('Permission denied, version ids [' . $id1 . ', ' . $id2 . ']');
  1362|         }
  1363|         throw $this->createNotFoundException('Version with ids [' . $id1 . ', ' . $id2 . "] doesn't exist");
  1364|     }
  1365|     /**
  1366|      * @Route("/grid-proxy", name="pimcore_admin_dataobject_dataobject_gridproxy", methods={"GET", "POST", "PUT"})
  1367|      *
  1368|      * @param Request $request
  1369|      * @param EventDispatcherInterface $eventDispatcher
  1370|      * @param GridHelperService $gridHelperService
  1371|      * @param LocaleServiceInterface $localeService
  1372|      * @param CsrfProtectionHandler $csrfProtection
  1373|      *
  1374|      * @return JsonResponse
  1375|      */
  1376|     public function gridProxyAction(
  1377|         Request $request,
  1378|         EventDispatcherInterface $eventDispatcher,
  1379|         GridHelperService $gridHelperService,
  1380|         LocaleServiceInterface $localeService,
  1381|         CsrfProtectionHandler $csrfProtection
  1382|     ) {
  1383|         $allParams = array_merge($request->request->all(), $request->query->all());
  1384|         $csvMode = $allParams['csvMode'] ?? false;
  1385|         if (isset($allParams['context']) && $allParams['context']) {
  1386|             $allParams['context'] = json_decode($allParams['context'], true);
  1387|         } else {
  1388|             $allParams['context'] = [];
  1389|         }
  1390|         $filterPrepareEvent = new GenericEvent($this, [
  1391|             'requestParams' => $allParams,
  1392|         ]);
  1393|         $eventDispatcher->dispatch($filterPrepareEvent, AdminEvents::OBJECT_LIST_BEFORE_FILTER_PREPARE);
  1394|         $allParams = $filterPrepareEvent->getArgument('requestParams');
  1395|         $requestedLanguage = $allParams['language'] ?? null;
  1396|         if ($requestedLanguage) {
  1397|             if ($requestedLanguage != 'default') {
  1398|                 $request->setLocale($requestedLanguage);
  1399|             }
  1400|         } else {
  1401|             $requestedLanguage = $request->getLocale();
  1402|         }
  1403|         if (isset($allParams['data']) && $allParams['data']) {
  1404|             $csrfProtection->checkCsrfToken($request);
  1405|             if ($allParams['xaction'] == 'update') {
  1406|                 try {
  1407|                     $data = $this->decodeJson($allParams['data']);
  1408|                     $object = DataObject::getById($data['id']);
  1409|                     if (!$object instanceof DataObject\Concrete) {
  1410|                         throw $this->createNotFoundException('Object not found');
  1411|                     }
  1412|                     $class = $object->getClass();
  1413|                     if (!$object->isAllowed('publish')) {
  1414|                         throw $this->createAccessDeniedException("Permission denied. You don't have the rights to save this object.");
  1415|                     }
  1416|                     $user = Tool\Admin::getCurrentUser();
  1417|                     $allLanguagesAllowed = false;
  1418|                     $languagePermissions = [];
  1419|                     if (!$user->isAdmin()) {
  1420|                         $languagePermissions = $object->getPermissions('lEdit', $user);
  1421|                         $allLanguagesAllowed = $languagePermissions['lEdit'] == '';
  1422|                         $languagePermissions = explode(',', $languagePermissions['lEdit']);
  1423|                     }
  1424|                     $objectData = [];
  1425|                     foreach ($data as $key => $value) {
  1426|                         $parts = explode('~', $key);
  1427|                         if (substr($key, 0, 1) == '~') {
  1428|                             $type = $parts[1];
  1429|                             $field = $parts[2];
  1430|                             $keyid = $parts[3];
  1431|                             if ($type == 'classificationstore') {
  1432|                                 $groupKeyId = explode('-', $keyid);
  1433|                                 $groupId = $groupKeyId[0];
  1434|                                 $keyid = $groupKeyId[1];
  1435|                                 $getter = 'get' . ucfirst($field);
  1436|                                 if (method_exists($object, $getter)) {
  1437|                                     /** @var Model\DataObject\ClassDefinition\Data\Classificationstore $csFieldDefinition */
  1438|                                     $csFieldDefinition = $object->getClass()->getFieldDefinition($field);
  1439|                                     $csLanguage = $requestedLanguage;
  1440|                                     if (!$csFieldDefinition->isLocalized()) {
  1441|                                         $csLanguage = 'default';
  1442|                                     }
  1443|                                     /** @var DataObject\Classificationstore $classificationStoreData */
  1444|                                     $classificationStoreData = $object->$getter();
  1445|                                     $keyConfig = DataObject\Classificationstore\KeyConfig::getById($keyid);
  1446|                                     if ($keyConfig) {
  1447|                                         $fieldDefinition = $keyDef = DataObject\Classificationstore\Service::getFieldDefinitionFromJson(
  1448|                                             json_decode($keyConfig->getDefinition()),
  1449|                                             $keyConfig->getType()
  1450|                                         );
  1451|                                         if ($fieldDefinition && method_exists($fieldDefinition, 'getDataFromGridEditor')) {
  1452|                                             $value = $fieldDefinition->getDataFromGridEditor($value, $object, []);
  1453|                                         }
  1454|                                     }
  1455|                                     $activeGroups = $classificationStoreData->getActiveGroups() ? $classificationStoreData->getActiveGroups() : [];
  1456|                                     $activeGroups[$groupId] = true;
  1457|                                     $classificationStoreData->setActiveGroups($activeGroups);
  1458|                                     $classificationStoreData->setLocalizedKeyValue($groupId, $keyid, $value, $csLanguage);
  1459|                                 }
  1460|                             }
  1461|                         } elseif (count($parts) > 1) {
  1462|                             $brickType = $parts[0];
  1463|                             $brickDescriptor = null;
  1464|                             if (strpos($brickType, '?') !== false) {
  1465|                                 $brickDescriptor = substr($brickType, 1);
  1466|                                 $brickDescriptor = json_decode($brickDescriptor, true);
  1467|                                 $brickType = $brickDescriptor['containerKey'];
  1468|                             }
  1469|                             $brickKey = $parts[1];
  1470|                             $brickField = DataObject\Service::getFieldForBrickType($object->getClass(), $brickType);
  1471|                             $fieldGetter = 'get' . ucfirst($brickField);
  1472|                             $brickGetter = 'get' . ucfirst($brickType);
  1473|                             $valueSetter = 'set' . ucfirst($brickKey);
  1474|                             $brick = $object->$fieldGetter()->$brickGetter();
  1475|                             if (empty($brick)) {
  1476|                                 $classname = '\\Pimcore\\Model\\DataObject\\Objectbrick\\Data\\' . ucfirst($brickType);
  1477|                                 $brickSetter = 'set' . ucfirst($brickType);
  1478|                                 $brick = new $classname($object);
  1479|                                 $object->$fieldGetter()->$brickSetter($brick);
  1480|                             }
  1481|                             if ($brickDescriptor) {
  1482|                                 $brickDefinition = Model\DataObject\Objectbrick\Definition::getByKey($brickType);
  1483|                                 /** @var DataObject\ClassDefinition\Data\Localizedfields $fieldDefinitionLocalizedFields */
  1484|                                 $fieldDefinitionLocalizedFields = $brickDefinition->getFieldDefinition('localizedfields');
  1485|                                 $fieldDefinition = $fieldDefinitionLocalizedFields->getFieldDefinition($brickKey);
  1486|                             } else {
  1487|                                 $fieldDefinition = $this->getFieldDefinitionFromBrick($brickType, $brickKey);
  1488|                             }
  1489|                             if ($fieldDefinition && method_exists($fieldDefinition, 'getDataFromGridEditor')) {
  1490|                                 $value = $fieldDefinition->getDataFromGridEditor($value, $object, []);
  1491|                             }
  1492|                             if ($brickDescriptor) {
  1493|                                 /** @var DataObject\Localizedfield $localizedFields */
  1494|                                 $localizedFields = $brick->getLocalizedfields();
  1495|                                 $localizedFields->setLocalizedValue($brickKey, $value);
  1496|                             } else {
  1497|                                 $brick->$valueSetter($value);
  1498|                             }
  1499|                         } else {
  1500|                             if (!$user->isAdmin() && $languagePermissions) {
  1501|                                 $fd = $class->getFieldDefinition($key);
  1502|                                 if (!$fd) {
  1503|                                     $localized = $class->getFieldDefinition('localizedfields');
  1504|                                     if ($localized instanceof DataObject\ClassDefinition\Data\Localizedfields) {
  1505|                                         $field = $localized->getFieldDefinition($key);
  1506|                                         if ($field) {
  1507|                                             $currentLocale = $localeService->findLocale();
  1508|                                             if (!$allLanguagesAllowed && !in_array($currentLocale, $languagePermissions)) {
  1509|                                                 continue;
  1510|                                             }
  1511|                                         }
  1512|                                     }
  1513|                                 }
  1514|                             }
  1515|                             $fieldDefinition = $this->getFieldDefinition($class, $key);
  1516|                             if ($fieldDefinition && method_exists($fieldDefinition, 'getDataFromGridEditor')) {
  1517|                                 $value = $fieldDefinition->getDataFromGridEditor($value, $object, []);
  1518|                             }
  1519|                             $objectData[$key] = $value;
  1520|                         }
  1521|                     }
  1522|                     $object->setValues($objectData);
  1523|                     if ($object->getPublished() == false) {
  1524|                         $object->setOmitMandatoryCheck(true);
  1525|                     }
  1526|                     $object->save();
  1527|                     return $this->adminJson(['data' => DataObject\Service::gridObjectData($object, $allParams['fields'], $requestedLanguage), 'success' => true]);
  1528|                 } catch (\Exception $e) {
  1529|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
  1530|                 }
  1531|             }
  1532|         } else {
  1533|             $list = $gridHelperService->prepareListingForGrid($allParams, $requestedLanguage, $this->getAdminUser());
  1534|             $beforeListLoadEvent = new GenericEvent($this, [
  1535|                 'list' => $list,
  1536|                 'context' => $allParams,
  1537|             ]);
  1538|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::OBJECT_LIST_BEFORE_LIST_LOAD);
  1539|             /** @var DataObject\Listing\Concrete $list */
  1540|             $list = $beforeListLoadEvent->getArgument('list');
  1541|             $list->load();
  1542|             $objects = [];
  1543|             foreach ($list->getObjects() as $object) {
  1544|                 if ($csvMode) {
  1545|                     $o = DataObject\Service::getCsvDataForObject($object, $requestedLanguage, $request->get('fields'), DataObject\Service::getHelperDefinitions(), $localeService, false, $allParams['context']);
  1546|                 } else {
  1547|                     $o = DataObject\Service::gridObjectData($object, $allParams['fields'] ?? null, $requestedLanguage,
  1548|                         ['csvMode' => $csvMode]);
  1549|                 }
  1550|                 if ($object->isAllowed('list')) {
  1551|                     $objects[] = $o;
  1552|                 }
  1553|             }
  1554|             $result = ['data' => $objects, 'success' => true, 'total' => $list->getTotalCount()];
  1555|             $afterListLoadEvent = new GenericEvent($this, [
  1556|                 'list' => $result,
  1557|                 'context' => $allParams,
  1558|             ]);
  1559|             $eventDispatcher->dispatch($afterListLoadEvent, AdminEvents::OBJECT_LIST_AFTER_LIST_LOAD);
  1560|             $result = $afterListLoadEvent->getArgument('list');
  1561|             return $this->adminJson($result);
  1562|         }
  1563|         return $this->adminJson(['success' => false]);
  1564|     }
  1565|     /**
  1566|      * @param DataObject\ClassDefinition $class
  1567|      * @param string $key
  1568|      *
  1569|      * @return DataObject\ClassDefinition\Data|null
  1570|      */
  1571|     protected function getFieldDefinition($class, $key)
  1572|     {
  1573|         $fieldDefinition = $class->getFieldDefinition($key);
  1574|         if ($fieldDefinition) {
  1575|             return $fieldDefinition;
  1576|         }
  1577|         $localized = $class->getFieldDefinition('localizedfields');
  1578|         if ($localized instanceof DataObject\ClassDefinition\Data\Localizedfields) {
  1579|             $fieldDefinition = $localized->getFieldDefinition($key);
  1580|         }
  1581|         return $fieldDefinition;
  1582|     }
  1583|     /**
  1584|      * @param string $brickType
  1585|      * @param string $key
  1586|      *
  1587|      * @return DataObject\ClassDefinition\Data|null
  1588|      */
  1589|     protected function getFieldDefinitionFromBrick($brickType, $key)
  1590|     {
  1591|         $brickDefinition = DataObject\Objectbrick\Definition::getByKey($brickType);
  1592|         $fieldDefinition = null;
  1593|         if ($brickDefinition) {
  1594|             $fieldDefinition = $brickDefinition->getFieldDefinition($key);
  1595|         }
  1596|         return $fieldDefinition;
  1597|     }
  1598|     /**
  1599|      * @Route("/copy-info", name="pimcore_admin_dataobject_dataobject_copyinfo", methods={"GET"})
  1600|      *
  1601|      * @param Request $request
  1602|      *
  1603|      * @return JsonResponse
  1604|      */
  1605|     public function copyInfoAction(Request $request)
  1606|     {
  1607|         $transactionId = time();
  1608|         $pasteJobs = [];
  1609|         Tool\Session::useSession(function (AttributeBagInterface $session) use ($transactionId) {
  1610|             $session->set($transactionId, ['idMapping' => []]);
  1611|         }, 'pimcore_copy');
  1612|         if ($request->get('type') == 'recursive' || $request->get('type') == 'recursive-update-references') {
  1613|             $object = DataObject::getById($request->get('sourceId'));
  1614|             $pasteJobs[] = [[
  1615|                 'url' => $this->generateUrl('pimcore_admin_dataobject_dataobject_copy'),
  1616|                 'method' => 'POST',
  1617|                 'params' => [
  1618|                     'sourceId' => $request->get('sourceId'),
  1619|                     'targetId' => $request->get('targetId'),
  1620|                     'type' => 'child',
  1621|                     'transactionId' => $transactionId,
  1622|                     'saveParentId' => true,
  1623|                 ],
  1624|             ]];
  1625|             if ($object->hasChildren(DataObject::$types)) {
  1626|                 $list = new DataObject\Listing();
  1627|                 $list->setCondition('o_path LIKE ' . $list->quote($list->escapeLike($object->getRealFullPath()) . '/%'));
  1628|                 $list->setOrderKey('LENGTH(o_path)', false);
  1629|                 $list->setOrder('ASC');
  1630|                 $list->setObjectTypes(DataObject::$types);
  1631|                 $childIds = $list->loadIdList();
  1632|                 if (count($childIds) > 0) {
  1633|                     foreach ($childIds as $id) {
  1634|                         $pasteJobs[] = [[
  1635|                             'url' => $this->generateUrl('pimcore_admin_dataobject_dataobject_copy'),
  1636|                             'method' => 'POST',
  1637|                             'params' => [
  1638|                                 'sourceId' => $id,
  1639|                                 'targetParentId' => $request->get('targetId'),
  1640|                                 'sourceParentId' => $request->get('sourceId'),
  1641|                                 'type' => 'child',
  1642|                                 'transactionId' => $transactionId,
  1643|                             ],
  1644|                         ]];
  1645|                     }
  1646|                 }
  1647|                 if ($request->get('type') == 'recursive-update-references') {
  1648|                     for ($i = 0; $i < (count($childIds) + 1); $i++) {
  1649|                         $pasteJobs[] = [[
  1650|                             'url' => $this->generateUrl('pimcore_admin_dataobject_dataobject_copyrewriteids'),
  1651|                             'method' => 'PUT',
  1652|                             'params' => [
  1653|                                 'transactionId' => $transactionId,
  1654|                                 '_dc' => uniqid(),
  1655|                             ],
  1656|                         ]];
  1657|                     }
  1658|                 }
  1659|             }
  1660|         } elseif ($request->get('type') == 'child' || $request->get('type') == 'replace') {
  1661|             $pasteJobs[] = [[
  1662|                 'url' => $this->generateUrl('pimcore_admin_dataobject_dataobject_copy'),
  1663|                 'method' => 'POST',
  1664|                 'params' => [
  1665|                     'sourceId' => $request->get('sourceId'),
  1666|                     'targetId' => $request->get('targetId'),
  1667|                     'type' => $request->get('type'),
  1668|                     'transactionId' => $transactionId,
  1669|                 ],
  1670|             ]];
  1671|         }
  1672|         return $this->adminJson([
  1673|             'pastejobs' => $pasteJobs,
  1674|         ]);
  1675|     }
  1676|     /**
  1677|      * @Route("/copy-rewrite-ids", name="pimcore_admin_dataobject_dataobject_copyrewriteids", methods={"PUT"})
  1678|      *
  1679|      * @param Request $request
  1680|      *
  1681|      * @return JsonResponse
  1682|      *
  1683|      * @throws \Exception
  1684|      */
  1685|     public function copyRewriteIdsAction(Request $request)
  1686|     {
  1687|         $transactionId = $request->get('transactionId');
  1688|         $idStore = Tool\Session::useSession(function (AttributeBagInterface $session) use ($transactionId) {
  1689|             return $session->get($transactionId);
  1690|         }, 'pimcore_copy');
  1691|         if (!array_key_exists('rewrite-stack', $idStore)) {
  1692|             $idStore['rewrite-stack'] = array_values($idStore['idMapping']);
  1693|         }
  1694|         $id = array_shift($idStore['rewrite-stack']);
  1695|         $object = DataObject::getById($id);
  1696|         $rewriteConfig = ['object' => $idStore['idMapping']];
  1697|         $object = DataObject\Service::rewriteIds($object, $rewriteConfig);
  1698|         $object->setUserModification($this->getAdminUser()->getId());
  1699|         $object->save();
  1700|         Tool\Session::useSession(function (AttributeBagInterface $session) use ($transactionId, $idStore) {
  1701|             $session->set($transactionId, $idStore);
  1702|         }, 'pimcore_copy');
  1703|         return $this->adminJson([
  1704|             'success' => true,
  1705|             'id' => $id,
  1706|         ]);
  1707|     }
  1708|     /**
  1709|      * @Route("/copy", name="pimcore_admin_dataobject_dataobject_copy", methods={"POST"})
  1710|      *
  1711|      * @param Request $request
  1712|      *
  1713|      * @return JsonResponse
  1714|      */
  1715|     public function copyAction(Request $request)
  1716|     {
  1717|         $message = '';
  1718|         $sourceId = (int)$request->get('sourceId');
  1719|         $source = DataObject::getById($sourceId);
  1720|         $session = Tool\Session::get('pimcore_copy');
  1721|         $sessionBag = $session->get($request->get('transactionId'));
  1722|         $targetId = (int)$request->get('targetId');
  1723|         if ($request->get('targetParentId')) {
  1724|             $sourceParent = DataObject::getById($request->get('sourceParentId'));
  1725|             if ($sessionBag['parentId']) {
  1726|                 $targetParent = DataObject::getById($sessionBag['parentId']);
  1727|             } else {
  1728|                 $targetParent = DataObject::getById($request->get('targetParentId'));
  1729|             }
  1730|             $targetPath = preg_replace('@^' . preg_quote($sourceParent->getRealFullPath(), '@') . '@', $targetParent . '/', $source->getRealPath());
  1731|             $target = DataObject::getByPath($targetPath);
  1732|         } else {
  1733|             $target = DataObject::getById($targetId);
  1734|         }
  1735|         if ($target->isAllowed('create')) {
  1736|             $source = DataObject::getById($sourceId);
  1737|             if ($source != null) {
  1738|                 if ($source instanceof DataObject\Concrete && $latestVersion = $source->getLatestVersion()) {
  1739|                     $source = $latestVersion->loadData();
  1740|                     $source->setPublished(false); //as latest version is used which is not published
  1741|                 }
  1742|                 if ($request->get('type') == 'child') {
  1743|                     $newObject = $this->_objectService->copyAsChild($target, $source);
  1744|                     $sessionBag['idMapping'][(int)$source->getId()] = (int)$newObject->getId();
  1745|                     if ($request->get('saveParentId')) {
  1746|                         $sessionBag['parentId'] = $newObject->getId();
  1747|                     }
  1748|                 } elseif ($request->get('type') == 'replace') {
  1749|                     $this->_objectService->copyContents($target, $source);
  1750|                 }
  1751|                 $session->set($request->get('transactionId'), $sessionBag);
  1752|                 Tool\Session::writeClose();
  1753|                 return $this->adminJson(['success' => true, 'message' => $message]);
  1754|             } else {
  1755|                 Logger::error("could not execute copy/paste, source object with id [ $sourceId ] not found");
  1756|                 return $this->adminJson(['success' => false, 'message' => 'source object not found']);
  1757|             }
  1758|         } else {
  1759|             throw $this->createAccessDeniedHttpException();
  1760|         }
  1761|     }
  1762|     /**
  1763|      * @Route("/preview", name="pimcore_admin_dataobject_dataobject_preview", methods={"GET"})
  1764|      *
  1765|      * @param Request $request
  1766|      *
  1767|      * @return Response|RedirectResponse
  1768|      */
  1769|     public function previewAction(Request $request)
  1770|     {
  1771|         $id = $request->get('id');
  1772|         $object = DataObject\Service::getElementFromSession('object', $id);
  1773|         if ($object instanceof DataObject\Concrete) {
  1774|             $url = $object->getClass()->getPreviewUrl();
  1775|             if ($url) {
  1776|                 $vars = $object->getObjectVars();
  1777|                 foreach ($vars as $key => $value) {
  1778|                     if (!empty($value) && \is_scalar($value)) {
  1779|                         $url = str_replace('%' . $key, urlencode($value), $url);
  1780|                     } else {
  1781|                         if (strpos($url, '%' . $key) !== false) {
  1782|                             return new Response('No preview available, please ensure that all fields which are required for the preview are filled correctly.');
  1783|                         }
  1784|                     }
  1785|                 }
  1786|                 $url = str_replace('%_locale', $this->getAdminUser()->getLanguage(), $url);
  1787|             } elseif ($previewService = $object->getClass()->getPreviewGenerator()) {
  1788|                 $url = $previewService->generatePreviewUrl($object, array_merge(['preview' => true, 'context' => $this], $request->query->all()));
  1789|             } elseif ($linkGenerator = $object->getClass()->getLinkGenerator()) {
  1790|                 $url = $linkGenerator->generate($object, ['preview' => true, 'context' => $this]);
  1791|             }
  1792|             if (!$url) {
  1793|                 return new Response("Preview not available, it seems that there's a problem with this object.");
  1794|             }
  1795|             $url = str_replace('%', '%25', $url);
  1796|             $urlParts = parse_url($url);
  1797|             return $this->redirect($urlParts['path'] . '?pimcore_object_preview=' . $id . '&_dc=' . time() . (isset($urlParts['query']) ? '&' . $urlParts['query'] : ''));
  1798|         } else {
  1799|             return new Response("Preview not available, it seems that there's a problem with this object.");
  1800|         }
  1801|     }
  1802|     /**
  1803|      * @param  DataObject\Concrete $object
  1804|      * @param  array $toDelete
  1805|      * @param  array $toAdd
  1806|      * @param  string $ownerFieldName
  1807|      */
  1808|     protected function processRemoteOwnerRelations($object, $toDelete, $toAdd, $ownerFieldName)
  1809|     {
  1810|         $getter = 'get' . ucfirst($ownerFieldName);
  1811|         $setter = 'set' . ucfirst($ownerFieldName);
  1812|         foreach ($toDelete as $id) {
  1813|             $owner = DataObject::getById($id);
  1814|             if (method_exists($owner, $getter)) {
  1815|                 $currentData = $owner->$getter();
  1816|                 if (is_array($currentData)) {
  1817|                     for ($i = 0; $i < count($currentData); $i++) {
  1818|                         if ($currentData[$i]->getId() == $object->getId()) {
  1819|                             unset($currentData[$i]);
  1820|                             $owner->$setter($currentData);
  1821|                             break;
  1822|                         }
  1823|                     }
  1824|                 } else {
  1825|                     if ($currentData->getId() == $object->getId()) {
  1826|                         $owner->$setter(null);
  1827|                     }
  1828|                 }
  1829|             }
  1830|             $owner->setUserModification($this->getAdminUser()->getId());
  1831|             $owner->save();
  1832|             Logger::debug('Saved object id [ ' . $owner->getId() . ' ] by remote modification through [' . $object->getId() . '], Action: deleted [ ' . $object->getId() . " ] from [ $ownerFieldName]");
  1833|         }
  1834|         foreach ($toAdd as $id) {
  1835|             $owner = DataObject::getById($id);
  1836|             if (method_exists($owner, $getter)) {
  1837|                 $currentData = $owner->$getter();
  1838|                 if (is_array($currentData)) {
  1839|                     $currentData[] = $object;
  1840|                 } else {
  1841|                     $currentData = $object;
  1842|                 }
  1843|                 $owner->$setter($currentData);
  1844|                 $owner->setUserModification($this->getAdminUser()->getId());
  1845|                 $owner->save();
  1846|                 Logger::debug('Saved object id [ ' . $owner->getId() . ' ] by remote modification through [' . $object->getId() . '], Action: added [ ' . $object->getId() . " ] to [ $ownerFieldName ]");
  1847|             }
  1848|         }
  1849|     }
  1850|     /**
  1851|      * @param  array $relations
  1852|      * @param  array $value
  1853|      *
  1854|      * @return array
  1855|      */
  1856|     protected function detectDeletedRemoteOwnerRelations($relations, $value)
  1857|     {
  1858|         $originals = [];
  1859|         $changed = [];
  1860|         foreach ($relations as $r) {
  1861|             $originals[] = $r['dest_id'];
  1862|         }
  1863|         if (is_array($value)) {
  1864|             foreach ($value as $row) {
  1865|                 $changed[] = $row['id'];
  1866|             }
  1867|         }
  1868|         $diff = array_diff($originals, $changed);
  1869|         return $diff;
  1870|     }
  1871|     /**
  1872|      * @param  array $relations
  1873|      * @param  array $value
  1874|      *
  1875|      * @return array
  1876|      */
  1877|     protected function detectAddedRemoteOwnerRelations($relations, $value)
  1878|     {
  1879|         $originals = [];
  1880|         $changed = [];
  1881|         foreach ($relations as $r) {
  1882|             $originals[] = $r['dest_id'];
  1883|         }
  1884|         if (is_array($value)) {
  1885|             foreach ($value as $row) {
  1886|                 $changed[] = $row['id'];
  1887|             }
  1888|         }
  1889|         $diff = array_diff($changed, $originals);
  1890|         return $diff;
  1891|     }
  1892|     /**
  1893|      * @param DataObject\Concrete $object
  1894|      * @param null|Version $draftVersion
  1895|      *
  1896|      * @return DataObject\Concrete|null
  1897|      */
  1898|     protected function getLatestVersion(DataObject\Concrete $object, &$draftVersion = null)
  1899|     {
  1900|         $latestVersion = $object->getLatestVersion($this->getUser()->getId());
  1901|         if ($latestVersion) {
  1902|             $latestObj = $latestVersion->loadData();
  1903|             if ($latestObj instanceof DataObject\Concrete) {
  1904|                 $draftVersion = $latestVersion;
  1905|                 return $latestObj;
  1906|             }
  1907|         }
  1908|         return $object;
  1909|     }
  1910|     /**
  1911|      * @param ControllerEvent $event
  1912|      */
  1913|     public function onKernelControllerEvent(ControllerEvent $event)
  1914|     {
  1915|         $isMasterRequest = $event->isMasterRequest();
  1916|         if (!$isMasterRequest) {
  1917|             return;
  1918|         }
  1919|         $this->checkPermission('objects');
  1920|         $this->_objectService = new DataObject\Service($this->getAdminUser());
  1921|     }
  1922| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/DataObject/DataObjectHelperController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1458 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\DataObject;
    15| use PhpOffice\PhpSpreadsheet\Reader\Csv;
    16| use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
    17| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    18| use Pimcore\Bundle\AdminBundle\Helper\GridHelperService;
    19| use Pimcore\Config;
    20| use Pimcore\Db;
    21| use Pimcore\Event\AdminEvents;
    22| use Pimcore\File;
    23| use Pimcore\Localization\LocaleServiceInterface;
    24| use Pimcore\Logger;
    25| use Pimcore\Model\DataObject;
    26| use Pimcore\Model\GridConfig;
    27| use Pimcore\Model\GridConfigFavourite;
    28| use Pimcore\Model\GridConfigShare;
    29| use Pimcore\Model\User;
    30| use Pimcore\Tool;
    31| use Pimcore\Version;
    32| use Symfony\Component\EventDispatcher\GenericEvent;
    33| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    34| use Symfony\Component\HttpFoundation\JsonResponse;
    35| use Symfony\Component\HttpFoundation\Request;
    36| use Symfony\Component\HttpFoundation\ResponseHeaderBag;
    37| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    38| use Symfony\Component\Routing\Annotation\Route;
    39| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    40| /**
    41|  * @Route("/object-helper")
    42|  *
    43|  * @internal
    44|  */
    45| class DataObjectHelperController extends AdminController
    46| {
    47|     const SYSTEM_COLUMNS = ['id', 'fullpath', 'key', 'published', 'creationDate', 'modificationDate', 'filename', 'classname'];
    48|     /**
    49|      * @Route("/load-object-data", name="pimcore_admin_dataobject_dataobjecthelper_loadobjectdata", methods={"GET"})
    50|      *
    51|      * @param Request $request
    52|      *
    53|      * @return JsonResponse
    54|      */
    55|     public function loadObjectDataAction(Request $request)
    56|     {
    57|         $object = DataObject::getById($request->get('id'));
    58|         $result = [];
    59|         if ($object) {
    60|             $result['success'] = true;
    61|             $fields = $request->get('fields');
    62|             $result['fields'] = DataObject\Service::gridObjectData($object, $fields);
    63|         } else {
    64|             $result['success'] = false;
    65|         }
    66|         return $this->adminJson($result);
    67|     }
    68|     /**
    69|      * @param int $userId
    70|      * @param string $classId
    71|      * @param string $searchType
    72|      *
    73|      * @return array
    74|      */
    75|     public function getMyOwnGridColumnConfigs($userId, $classId, $searchType)
    76|     {
    77|         $db = Db::get();
    78|         $configListingConditionParts = [];
    79|         $configListingConditionParts[] = 'ownerId = ' . $userId;
    80|         $configListingConditionParts[] = 'classId = ' . $db->quote($classId);
    81|         if ($searchType) {
    82|             $configListingConditionParts[] = 'searchType = ' . $db->quote($searchType);
    83|         }
    84|         $configCondition = implode(' AND ', $configListingConditionParts);
    85|         $configListing = new GridConfig\Listing();
    86|         $configListing->setOrderKey('name');
    87|         $configListing->setOrder('ASC');
    88|         $configListing->setCondition($configCondition);
    89|         $configListing = $configListing->load();
    90|         $configData = [];
    91|         if (is_array($configListing)) {
    92|             foreach ($configListing as $config) {
    93|                 $configData[] = $config->getObjectVars();
    94|             }
    95|         }
    96|         return $configData;
    97|     }
    98|     /**
    99|      * @param User $user
   100|      * @param string $classId
   101|      * @param string $searchType
   102|      *
   103|      * @return array
   104|      */
   105|     public function getSharedGridColumnConfigs($user, $classId, $searchType = null)
   106|     {
   107|         $configListing = [];
   108|         $userIds = [$user->getId()];
   109|         $userIds = array_merge($userIds, $user->getRoles());
   110|         $userIds = implode(',', $userIds);
   111|         $db = Db::get();
   112|         $query = 'select distinct c1.id from gridconfigs c1, gridconfig_shares s
   113|                     where (c1.searchType = ' . $db->quote($searchType) . ' and ((c1.id = s.gridConfigId and s.sharedWithUserId IN (' . $userIds . '))) and c1.classId = ' . $db->quote($classId) . ')
   114|                             UNION distinct select c2.id from gridconfigs c2 where shareGlobally = 1 and c2.classId = '. $db->quote($classId) . '  and c2.ownerId != ' . $db->quote($user->getId());
   115|         $ids = $db->fetchCol($query);
   116|         if ($ids) {
   117|             $ids = implode(',', $ids);
   118|             $configListing = new GridConfig\Listing();
   119|             $configListing->setOrderKey('name');
   120|             $configListing->setOrder('ASC');
   121|             $configListing->setCondition('id in (' . $ids . ')');
   122|             $configListing = $configListing->load();
   123|         }
   124|         $configData = [];
   125|         if (is_array($configListing)) {
   126|             foreach ($configListing as $config) {
   127|                 $configData[] = $config->getObjectVars();
   128|             }
   129|         }
   130|         return $configData;
   131|     }
   132|     /**
   133|      * @Route("/get-export-configs", name="pimcore_admin_dataobject_dataobjecthelper_getexportconfigs", methods={"GET"})
   134|      *
   135|      * @param Request $request
   136|      *
   137|      * @return JsonResponse
   138|      */
   139|     public function getExportConfigsAction(Request $request)
   140|     {
   141|         $classId = $request->get('classId');
   142|         $list = $this->getMyOwnGridColumnConfigs($this->getAdminUser()->getId(), $classId, null);
   143|         if (!is_array($list)) {
   144|             $list = [];
   145|         }
   146|         $list = array_merge($list, $this->getSharedGridColumnConfigs($this->getAdminUser(), $classId, null));
   147|         $result = [];
   148|         $result[] = [
   149|             'id' => -1,
   150|             'name' => '--default--',
   151|         ];
   152|         if ($list) {
   153|             /** @var GridConfig $config */
   154|             foreach ($list as $config) {
   155|                 $result[] = [
   156|                     'id' => $config['id'],
   157|                     'name' => $config['name'],
   158|                 ];
   159|             }
   160|         }
   161|         return $this->adminJson(['success' => true, 'data' => $result]);
   162|     }
   163|     /**
   164|      * @Route("/grid-delete-column-config", name="pimcore_admin_dataobject_dataobjecthelper_griddeletecolumnconfig", methods={"DELETE"})
   165|      *
   166|      * @param Request $request
   167|      * @param Config $config
   168|      *
   169|      * @return JsonResponse
   170|      */
   171|     public function gridDeleteColumnConfigAction(Request $request, Config $config)
   172|     {
   173|         $gridConfigId = $request->get('gridConfigId');
   174|         $gridConfig = null;
   175|         try {
   176|             $gridConfig = GridConfig::getById($gridConfigId);
   177|         } catch (\Exception $e) {
   178|         }
   179|         $success = false;
   180|         if ($gridConfig) {
   181|             if ($gridConfig->getOwnerId() != $this->getAdminUser()->getId() && !$this->getAdminUser()->isAdmin()) {
   182|                 throw new \Exception("don't mess with someone elses grid config");
   183|             }
   184|             $gridConfig->delete();
   185|             $success = true;
   186|         }
   187|         $newGridConfig = $this->doGetGridColumnConfig($request, $config, true);
   188|         $newGridConfig['deleteSuccess'] = $success;
   189|         return $this->adminJson($newGridConfig);
   190|     }
   191|     /**
   192|      * @Route("/grid-get-column-config", name="pimcore_admin_dataobject_dataobjecthelper_gridgetcolumnconfig", methods={"GET"})
   193|      *
   194|      * @param Request $request
   195|      * @param Config $config
   196|      *
   197|      * @return JsonResponse
   198|      */
   199|     public function gridGetColumnConfigAction(Request $request, Config $config)
   200|     {
   201|         $result = $this->doGetGridColumnConfig($request, $config);
   202|         return $this->adminJson($result);
   203|     }
   204|     /**
   205|      * @param Request $request
   206|      * @param Config $config
   207|      * @param bool $isDelete
   208|      *
   209|      * @return array
   210|      */
   211|     public function doGetGridColumnConfig(Request $request, Config $config, $isDelete = false)
   212|     {
   213|         $class = null;
   214|         $fields = null;
   215|         if ($request->get('id')) {
   216|             $class = DataObject\ClassDefinition::getById($request->get('id'));
   217|         } elseif ($request->get('name')) {
   218|             $class = DataObject\ClassDefinition::getByName($request->get('name'));
   219|         }
   220|         $gridConfigId = null;
   221|         $gridType = 'search';
   222|         if ($request->get('gridtype')) {
   223|             $gridType = $request->get('gridtype');
   224|         }
   225|         $objectId = $request->get('objectId');
   226|         if ($objectId) {
   227|             $fields = DataObject\Service::getCustomGridFieldDefinitions($class->getId(), $objectId);
   228|         }
   229|         $context = ['purpose' => 'gridconfig'];
   230|         if ($class) {
   231|             $context['class'] = $class;
   232|         }
   233|         if ($objectId) {
   234|             $object = DataObject::getById($objectId);
   235|             $context['object'] = $object;
   236|         }
   237|         if (!$fields && $class) {
   238|             $fields = $class->getFieldDefinitions();
   239|         }
   240|         $types = [];
   241|         if ($request->get('types')) {
   242|             $types = explode(',', $request->get('types'));
   243|         }
   244|         $userId = $this->getAdminUser()->getId();
   245|         $requestedGridConfigId = $isDelete ? null : $request->get('gridConfigId');
   246|         $gridConfig = [];
   247|         $searchType = $request->get('searchType');
   248|         if (strlen($requestedGridConfigId) == 0 && $class) {
   249|             $favourite = null;
   250|             try {
   251|                 try {
   252|                     $favourite = GridConfigFavourite::getByOwnerAndClassAndObjectId($userId, $class->getId(), $objectId ? $objectId : 0, $searchType);
   253|                 } catch (\Exception $e) {
   254|                 }
   255|                 if (!$favourite && $objectId) {
   256|                     $favourite = GridConfigFavourite::getByOwnerAndClassAndObjectId($userId, $class->getId(), 0, $searchType);
   257|                 }
   258|                 if ($favourite) {
   259|                     $requestedGridConfigId = $favourite->getGridConfigId();
   260|                 }
   261|             } catch (\Exception $e) {
   262|             }
   263|         }
   264|         if (is_numeric($requestedGridConfigId) && $requestedGridConfigId > 0) {
   265|             $db = Db::get();
   266|             $configListingConditionParts = [];
   267|             $configListingConditionParts[] = 'ownerId = ' . $userId;
   268|             $configListingConditionParts[] = 'classId = ' . $db->quote($class->getId());
   269|             if ($searchType) {
   270|                 $configListingConditionParts[] = 'searchType = ' . $db->quote($searchType);
   271|             }
   272|             $savedGridConfig = null;
   273|             try {
   274|                 $savedGridConfig = GridConfig::getById($requestedGridConfigId);
   275|             } catch (\Exception $e) {
   276|             }
   277|             if ($savedGridConfig) {
   278|                 $shared = false;
   279|                 if (!$this->getAdminUser()->isAdmin()) {
   280|                     try {
   281|                         $userIds = [$this->getAdminUser()->getId()];
   282|                         if ($this->getAdminUser()->getRoles()) {
   283|                             $userIds = array_merge($userIds, $this->getAdminUser()->getRoles());
   284|                         }
   285|                         $userIds = implode(',', $userIds);
   286|                         $shared = ($savedGridConfig->getOwnerId() != $userId && $savedGridConfig->isShareGlobally()) || $db->fetchOne('select 1 from gridconfig_shares where sharedWithUserId IN ('.$userIds.') and gridConfigId = '.$savedGridConfig->getId());
   287|                     } catch (\Exception $e) {
   288|                     }
   289|                     if (!$shared && $savedGridConfig->getOwnerId() != $this->getAdminUser()->getId()) {
   290|                         throw new \Exception('you are neither the onwner of this config nor it is shared with you');
   291|                     }
   292|                 }
   293|                 $gridConfigId = $savedGridConfig->getId();
   294|                 $gridConfig = $savedGridConfig->getConfig();
   295|                 $gridConfig = json_decode($gridConfig, true);
   296|                 $gridConfigName = $savedGridConfig->getName();
   297|                 $owner = $savedGridConfig->getOwnerId();
   298|                 $ownerObject = User::getById($owner);
   299|                 if ($ownerObject instanceof User) {
   300|                     $owner = $ownerObject->getName();
   301|                 }
   302|                 $modificationDate = $savedGridConfig->getModificationDate();
   303|                 $gridConfigDescription = $savedGridConfig->getDescription();
   304|                 $sharedGlobally = $savedGridConfig->isShareGlobally();
   305|             }
   306|         }
   307|         $localizedFields = [];
   308|         $objectbrickFields = [];
   309|         if (is_array($fields)) {
   310|             foreach ($fields as $key => $field) {
   311|                 if ($field instanceof DataObject\ClassDefinition\Data\Localizedfields) {
   312|                     $localizedFields[] = $field;
   313|                 } elseif ($field instanceof DataObject\ClassDefinition\Data\Objectbricks) {
   314|                     $objectbrickFields[] = $field;
   315|                 }
   316|             }
   317|         }
   318|         $availableFields = [];
   319|         if (empty($gridConfig)) {
   320|             $availableFields = $this->getDefaultGridFields(
   321|                 $request->get('no_system_columns'),
   322|                 $class,
   323|                 $gridType,
   324|                 $request->get('no_brick_columns'),
   325|                 $fields,
   326|                 $context,
   327|                 $objectId,
   328|                 $types);
   329|         } else {
   330|             $savedColumns = $gridConfig['columns'];
   331|             foreach ($savedColumns as $key => $sc) {
   332|                 if (!$sc['hidden']) {
   333|                     if (in_array($key, self::SYSTEM_COLUMNS)) {
   334|                         $colConfig = [
   335|                             'key' => $key,
   336|                             'type' => 'system',
   337|                             'label' => $key,
   338|                             'locked' => $sc['locked'] ?? null,
   339|                             'position' => $sc['position'],
   340|                         ];
   341|                         if (isset($sc['width'])) {
   342|                             $colConfig['width'] = $sc['width'];
   343|                         }
   344|                         $availableFields[] = $colConfig;
   345|                     } else {
   346|                         $keyParts = explode('~', $key);
   347|                         if (substr($key, 0, 1) == '~') {
   348|                             $type = $keyParts[1];
   349|                             $groupAndKeyId = explode('-', $keyParts[3]);
   350|                             $keyId = $groupAndKeyId[1];
   351|                             if ($type == 'classificationstore') {
   352|                                 $keyDef = DataObject\Classificationstore\KeyConfig::getById($keyId);
   353|                                 if ($keyDef) {
   354|                                     $keyFieldDef = json_decode($keyDef->getDefinition(), true);
   355|                                     if ($keyFieldDef) {
   356|                                         $keyFieldDef = \Pimcore\Model\DataObject\Classificationstore\Service::getFieldDefinitionFromJson($keyFieldDef, $keyDef->getType());
   357|                                         $fieldConfig = $this->getFieldGridConfig($keyFieldDef, $gridType, $sc['position'], true, null, $class, $objectId);
   358|                                         if ($fieldConfig) {
   359|                                             $fieldConfig['key'] = $key;
   360|                                             $fieldConfig['label'] = '#' . $keyFieldDef->getTitle();
   361|                                             if (isset($sc['locked'])) {
   362|                                                 $fieldConfig['locked'] = $sc['locked'];
   363|                                             }
   364|                                             $availableFields[] = $fieldConfig;
   365|                                         }
   366|                                     }
   367|                                 }
   368|                             }
   369|                         } elseif (count($keyParts) > 1) {
   370|                             $brick = $keyParts[0];
   371|                             $brickDescriptor = null;
   372|                             if (strpos($brick, '?') !== false) {
   373|                                 $brickDescriptor = substr($brick, 1);
   374|                                 $brickDescriptor = json_decode($brickDescriptor, true);
   375|                                 $keyPrefix = $brick . '~';
   376|                                 $brick = $brickDescriptor['containerKey'];
   377|                             } else {
   378|                                 $keyPrefix = $brick . '~';
   379|                             }
   380|                             $fieldname = $keyParts[1];
   381|                             $brickClass = DataObject\Objectbrick\Definition::getByKey($brick);
   382|                             $fd = null;
   383|                             if ($brickClass instanceof DataObject\Objectbrick\Definition) {
   384|                                 if ($brickDescriptor) {
   385|                                     $innerContainer = $brickDescriptor['innerContainer'] ?? 'localizedfields';
   386|                                     /** @var DataObject\ClassDefinition\Data\Localizedfields $localizedFields */
   387|                                     $localizedFields = $brickClass->getFieldDefinition($innerContainer);
   388|                                     $fd = $localizedFields->getFieldDefinition($brickDescriptor['brickfield']);
   389|                                 } else {
   390|                                     $fd = $brickClass->getFieldDefinition($fieldname);
   391|                                 }
   392|                             }
   393|                             if ($fd !== null) {
   394|                                 $fieldConfig = $this->getFieldGridConfig($fd, $gridType, $sc['position'], true, $keyPrefix, $class, $objectId);
   395|                                 if (!empty($fieldConfig)) {
   396|                                     if (isset($sc['width'])) {
   397|                                         $fieldConfig['width'] = $sc['width'];
   398|                                     }
   399|                                     if (isset($sc['locked'])) {
   400|                                         $fieldConfig['locked'] = $sc['locked'];
   401|                                     }
   402|                                     $availableFields[] = $fieldConfig;
   403|                                 }
   404|                             }
   405|                         } else {
   406|                             if (DataObject\Service::isHelperGridColumnConfig($key)) {
   407|                                 $calculatedColumnConfig = $this->getCalculatedColumnConfig($savedColumns[$key]);
   408|                                 if ($calculatedColumnConfig) {
   409|                                     $availableFields[] = $calculatedColumnConfig;
   410|                                 }
   411|                             } else {
   412|                                 $fd = $class->getFieldDefinition($key);
   413|                                 if (empty($fd)) {
   414|                                     foreach ($localizedFields as $lf) {
   415|                                         $fd = $lf->getFieldDefinition($key);
   416|                                         if (!empty($fd)) {
   417|                                             break;
   418|                                         }
   419|                                     }
   420|                                 }
   421|                                 if (!empty($fd)) {
   422|                                     $fieldConfig = $this->getFieldGridConfig($fd, $gridType, $sc['position'], true, null, $class, $objectId);
   423|                                     if (!empty($fieldConfig)) {
   424|                                         if (isset($sc['width'])) {
   425|                                             $fieldConfig['width'] = $sc['width'];
   426|                                         }
   427|                                         if (isset($sc['locked'])) {
   428|                                             $fieldConfig['locked'] = $sc['locked'];
   429|                                         }
   430|                                         $availableFields[] = $fieldConfig;
   431|                                     }
   432|                                 }
   433|                             }
   434|                         }
   435|                     }
   436|                 }
   437|             }
   438|         }
   439|         usort($availableFields, function ($a, $b) {
   440|             if ($a['position'] == $b['position']) {
   441|                 return 0;
   442|             }
   443|             return ($a['position'] < $b['position']) ? -1 : 1;
   444|         });
   445|         $frontendLanguages = Tool\Admin::reorderWebsiteLanguages(\Pimcore\Tool\Admin::getCurrentUser(), $config['general']['valid_languages']);
   446|         if ($frontendLanguages) {
   447|             $language = explode(',', $frontendLanguages)[0];
   448|         } else {
   449|             $language = $request->getLocale();
   450|         }
   451|         if (!Tool::isValidLanguage($language)) {
   452|             $validLanguages = Tool::getValidLanguages();
   453|             $language = $validLanguages[0];
   454|         }
   455|         if (!empty($gridConfig) && !empty($gridConfig['language'])) {
   456|             $language = $gridConfig['language'];
   457|         }
   458|         if (!empty($gridConfig) && !empty($gridConfig['pageSize'])) {
   459|             $pageSize = $gridConfig['pageSize'];
   460|         }
   461|         $availableConfigs = $class ? $this->getMyOwnGridColumnConfigs($userId, $class->getId(), $searchType) : [];
   462|         $sharedConfigs = $class ? $this->getSharedGridColumnConfigs($this->getAdminUser(), $class->getId(), $searchType) : [];
   463|         $settings = $this->getShareSettings((int)$gridConfigId);
   464|         $settings['gridConfigId'] = (int)$gridConfigId;
   465|         $settings['gridConfigName'] = $gridConfigName ?? null;
   466|         $settings['gridConfigDescription'] = $gridConfigDescription ?? null;
   467|         $settings['owner'] = $owner ?? null;
   468|         $settings['modificationDate'] = $modificationDate ?? null;
   469|         $settings['shareGlobally'] = $sharedGlobally ?? null;
   470|         $settings['isShared'] = !$gridConfigId || ($shared ?? null);
   471|         $context = $gridConfig['context'] ?? null;
   472|         if ($context) {
   473|             $context = json_decode($context, true);
   474|         }
   475|         return [
   476|             'sortinfo' => $gridConfig['sortinfo'] ?? false,
   477|             'language' => $language,
   478|             'availableFields' => $availableFields,
   479|             'settings' => $settings,
   480|             'onlyDirectChildren' => $gridConfig['onlyDirectChildren'] ?? false,
   481|             'pageSize' => $gridConfig['pageSize'] ?? false,
   482|             'availableConfigs' => $availableConfigs,
   483|             'sharedConfigs' => $sharedConfigs,
   484|             'context' => $context,
   485|             'sqlFilter' => $gridConfig['sqlFilter'] ?? '',
   486|             'searchFilter' => $gridConfig['searchFilter'] ?? '',
   487|         ];
   488|     }
   489|     /**
   490|      * @param bool $noSystemColumns
   491|      * @param DataObject\ClassDefinition|null $class
   492|      * @param string $gridType
   493|      * @param bool $noBrickColumns
   494|      * @param DataObject\ClassDefinition\Data[] $fields
   495|      * @param array $context
   496|      * @param int $objectId
   497|      * @param array $types
   498|      *
   499|      * @return array
   500|      */
   501|     public function getDefaultGridFields($noSystemColumns, $class, $gridType, $noBrickColumns, $fields, $context, $objectId, $types = [])
   502|     {
   503|         $count = 0;
   504|         $availableFields = [];
   505|         if (!$noSystemColumns && $class) {
   506|             $vis = $class->getPropertyVisibility();
   507|             foreach (self::SYSTEM_COLUMNS as $sc) {
   508|                 $key = $sc;
   509|                 if ($key === 'fullpath') {
   510|                     $key = 'path';
   511|                 }
   512|                 if (empty($types) && (!empty($vis[$gridType][$key]) || $gridType === 'all')) {
   513|                     $availableFields[] = [
   514|                         'key' => $sc,
   515|                         'type' => 'system',
   516|                         'label' => $sc,
   517|                         'position' => $count, ];
   518|                     $count++;
   519|                 }
   520|             }
   521|         }
   522|         $includeBricks = !$noBrickColumns;
   523|         if (is_array($fields)) {
   524|             foreach ($fields as $key => $field) {
   525|                 if ($field instanceof DataObject\ClassDefinition\Data\Localizedfields) {
   526|                     foreach ($field->getFieldDefinitions($context) as $fd) {
   527|                         if (empty($types) || in_array($fd->getFieldType(), $types)) {
   528|                             $fieldConfig = $this->getFieldGridConfig($fd, $gridType, $count, false, null, $class, $objectId);
   529|                             if (!empty($fieldConfig)) {
   530|                                 $availableFields[] = $fieldConfig;
   531|                                 $count++;
   532|                             }
   533|                         }
   534|                     }
   535|                 } elseif ($field instanceof DataObject\ClassDefinition\Data\Objectbricks && $includeBricks) {
   536|                     if (in_array($field->getFieldType(), $types)) {
   537|                         $fieldConfig = $this->getFieldGridConfig($field, $gridType, $count, false, null, $class, $objectId);
   538|                         if (!empty($fieldConfig)) {
   539|                             $availableFields[] = $fieldConfig;
   540|                             $count++;
   541|                         }
   542|                     } else {
   543|                         $allowedTypes = $field->getAllowedTypes();
   544|                         if (!empty($allowedTypes)) {
   545|                             foreach ($allowedTypes as $t) {
   546|                                 $brickClass = DataObject\Objectbrick\Definition::getByKey($t);
   547|                                 $brickFields = $brickClass->getFieldDefinitions($context);
   548|                                 $this->appendBrickFields($field, $brickFields, $availableFields, $gridType, $count, $t, $class, $objectId);
   549|                             }
   550|                         }
   551|                     }
   552|                 } else {
   553|                     if (empty($types) || in_array($field->getFieldType(), $types)) {
   554|                         $fieldConfig = $this->getFieldGridConfig($field, $gridType, $count, !empty($types), null, $class, $objectId);
   555|                         if (!empty($fieldConfig)) {
   556|                             $availableFields[] = $fieldConfig;
   557|                             $count++;
   558|                         }
   559|                     }
   560|                 }
   561|             }
   562|         }
   563|         return $availableFields;
   564|     }
   565|     /**
   566|      * @param DataObject\ClassDefinition\Data $field
   567|      * @param DataObject\ClassDefinition\Data[] $brickFields
   568|      * @param array $availableFields
   569|      * @param string $gridType
   570|      * @param int $count
   571|      * @param string $brickType
   572|      * @param DataObject\ClassDefinition $class
   573|      * @param int $objectId
   574|      * @param array|null $context
   575|      */
   576|     protected function appendBrickFields($field, $brickFields, &$availableFields, $gridType, &$count, $brickType, $class, $objectId, $context = null)
   577|     {
   578|         if (!empty($brickFields)) {
   579|             foreach ($brickFields as $bf) {
   580|                 if ($bf instanceof DataObject\ClassDefinition\Data\Localizedfields) {
   581|                     $localizedFieldDefinitions = $bf->getFieldDefinitions();
   582|                     $localizedContext = [
   583|                         'containerKey' => $brickType,
   584|                         'fieldname' => $field->getName(),
   585|                     ];
   586|                     $this->appendBrickFields($bf, $localizedFieldDefinitions, $availableFields, $gridType, $count, $brickType, $class, $objectId, $localizedContext);
   587|                 } else {
   588|                     if ($context) {
   589|                         $context['brickfield'] = $bf->getName();
   590|                         $keyPrefix = '?' . json_encode($context) . '~';
   591|                     } else {
   592|                         $keyPrefix = $brickType . '~';
   593|                     }
   594|                     $fieldConfig = $this->getFieldGridConfig($bf, $gridType, $count, false, $keyPrefix, $class, $objectId);
   595|                     if (!empty($fieldConfig)) {
   596|                         $availableFields[] = $fieldConfig;
   597|                         $count++;
   598|                     }
   599|                 }
   600|             }
   601|         }
   602|     }
   603|     /**
   604|      * @param array $config
   605|      *
   606|      * @return mixed
   607|      */
   608|     protected function getCalculatedColumnConfig($config)
   609|     {
   610|         try {
   611|             $calculatedColumnConfig = Tool\Session::useSession(function (AttributeBagInterface $session) use ($config) {
   612|                 $calculatedColumn = [];
   613|                 $existingKey = $config['fieldConfig']['key'];
   614|                 $calculatedColumnConfig['key'] = $existingKey;
   615|                 $calculatedColumnConfig['position'] = $config['position'];
   616|                 $calculatedColumnConfig['isOperator'] = true;
   617|                 $calculatedColumnConfig['attributes'] = $config['fieldConfig']['attributes'];
   618|                 $calculatedColumnConfig['width'] = $config['width'];
   619|                 $calculatedColumnConfig['locked'] = $config['locked'];
   620|                 $existingColumns = $session->get('helpercolumns', []);
   621|                 if (isset($existingColumns[$existingKey])) {
   622|                     return $calculatedColumnConfig;
   623|                 }
   624|                 $newKey = '#' . uniqid();
   625|                 $calculatedColumnConfig['key'] = $newKey;
   626|                 $phpConfig = json_encode($config['fieldConfig']);
   627|                 $phpConfig = json_decode($phpConfig);
   628|                 $helperColumns = [];
   629|                 $helperColumns[$newKey] = $phpConfig;
   630|                 $helperColumns = array_merge($helperColumns, $existingColumns);
   631|                 $session->set('helpercolumns', $helperColumns);
   632|                 return $calculatedColumnConfig;
   633|             }, 'pimcore_gridconfig');
   634|             return $calculatedColumnConfig;
   635|         } catch (\Exception $e) {
   636|             Logger::error($e);
   637|         }
   638|     }
   639|     /**
   640|      * @Route("/prepare-helper-column-configs", name="pimcore_admin_dataobject_dataobjecthelper_preparehelpercolumnconfigs", methods={"POST"})
   641|      *
   642|      * @param Request $request
   643|      *
   644|      * @return JsonResponse
   645|      */
   646|     public function prepareHelperColumnConfigs(Request $request)
   647|     {
   648|         $helperColumns = [];
   649|         $newData = [];
   650|         /** @var \stdClass[] $data */
   651|         $data = json_decode($request->get('columns'));
   652|         foreach ($data as $item) {
   653|             if (!empty($item->isOperator)) {
   654|                 $itemKey = '#' . uniqid();
   655|                 $item->key = $itemKey;
   656|                 $newData[] = $item;
   657|                 $helperColumns[$itemKey] = $item;
   658|             } else {
   659|                 $newData[] = $item;
   660|             }
   661|         }
   662|         Tool\Session::useSession(function (AttributeBagInterface $session) use ($helperColumns) {
   663|             $existingColumns = $session->get('helpercolumns', []);
   664|             $helperColumns = array_merge($helperColumns, $existingColumns);
   665|             $session->set('helpercolumns', $helperColumns);
   666|         }, 'pimcore_gridconfig');
   667|         return $this->adminJson(['success' => true, 'columns' => $newData]);
   668|     }
   669|     /**
   670|      * @Route("/grid-config-apply-to-all", name="pimcore_admin_dataobject_dataobjecthelper_gridconfigapplytoall", methods={"POST"})
   671|      *
   672|      * @param Request $request
   673|      *
   674|      * @return JsonResponse
   675|      */
   676|     public function gridConfigApplyToAllAction(Request $request)
   677|     {
   678|         $objectId = $request->get('objectId');
   679|         $object = DataObject::getById($objectId);
   680|         if ($object->isAllowed('list')) {
   681|             $classId = $request->get('classId');
   682|             $gridConfigId = $request->get('gridConfigId');
   683|             $searchType = $request->get('searchType');
   684|             $user = $this->getAdminUser();
   685|             $db = Db::get();
   686|             $db->query('delete from gridconfig_favourites where '
   687|                 . 'ownerId = ' . $user->getId()
   688|                 . ' and classId = ' . $db->quote($classId) .
   689|                 ' and searchType = ' . $db->quote($searchType)
   690|                 . ' and objectId != ' . $objectId . ' and objectId != 0');
   691|             return $this->adminJson(['success' => true]);
   692|         }
   693|         throw $this->createAccessDeniedHttpException();
   694|     }
   695|     /**
   696|      * @Route("/grid-mark-favourite-column-config", name="pimcore_admin_dataobject_dataobjecthelper_gridmarkfavouritecolumnconfig", methods={"POST"})
   697|      *
   698|      * @param Request $request
   699|      *
   700|      * @return JsonResponse
   701|      */
   702|     public function gridMarkFavouriteColumnConfigAction(Request $request)
   703|     {
   704|         $objectId = $request->get('objectId');
   705|         $object = DataObject::getById($objectId);
   706|         if ($object->isAllowed('list')) {
   707|             $classId = $request->get('classId');
   708|             $gridConfigId = $request->get('gridConfigId');
   709|             $searchType = $request->get('searchType');
   710|             $global = $request->get('global');
   711|             $user = $this->getAdminUser();
   712|             $type = $request->get('type');
   713|             $favourite = new GridConfigFavourite();
   714|             $favourite->setOwnerId($user->getId());
   715|             $class = DataObject\ClassDefinition::getById($classId);
   716|             if (!$class) {
   717|                 throw new \Exception('class ' . $classId . ' does not exist anymore');
   718|             }
   719|             $favourite->setClassId($classId);
   720|             $favourite->setSearchType($searchType);
   721|             $favourite->setType($type);
   722|             $specializedConfigs = false;
   723|             try {
   724|                 if ($gridConfigId != 0) {
   725|                     $gridConfig = GridConfig::getById($gridConfigId);
   726|                     $favourite->setGridConfigId($gridConfig->getId());
   727|                 }
   728|                 $favourite->setObjectId($objectId);
   729|                 $favourite->save();
   730|                 if ($global) {
   731|                     $favourite->setObjectId(0);
   732|                     $favourite->save();
   733|                 }
   734|                 $db = Db::get();
   735|                 $count = $db->fetchOne('select * from gridconfig_favourites where '
   736|                     . 'ownerId = ' . $user->getId()
   737|                     . ' and classId = ' . $db->quote($classId).
   738|                     ' and searchType = ' . $db->quote($searchType)
   739|                     . ' and objectId != ' . $objectId . ' and objectId != 0'
   740|                     . ' and type != ' . $db->quote($type));
   741|                 $specializedConfigs = $count > 0;
   742|             } catch (\Exception $e) {
   743|                 $favourite->delete();
   744|             }
   745|             return $this->adminJson(['success' => true, 'spezializedConfigs' => $specializedConfigs]);
   746|         }
   747|         throw $this->createAccessDeniedHttpException();
   748|     }
   749|     /**
   750|      * @param int $gridConfigId
   751|      *
   752|      * @return array
   753|      */
   754|     protected function getShareSettings($gridConfigId)
   755|     {
   756|         $result = [
   757|             'sharedUserIds' => [],
   758|             'sharedRoleIds' => [],
   759|         ];
   760|         $db = Db::get();
   761|         $allShares = $db->fetchAll('select s.sharedWithUserId, u.type from gridconfig_shares s, users u
   762|                       where s.sharedWithUserId = u.id and s.gridConfigId = ' . $gridConfigId);
   763|         if ($allShares) {
   764|             foreach ($allShares as $share) {
   765|                 $type = $share['type'];
   766|                 $key = 'shared' . ucfirst($type) . 'Ids';
   767|                 $result[$key][] = $share['sharedWithUserId'];
   768|             }
   769|         }
   770|         foreach ($result as $idx => $value) {
   771|             $value = $value ? implode(',', $value) : '';
   772|             $result[$idx] = $value;
   773|         }
   774|         return $result;
   775|     }
   776|     /**
   777|      * @Route("/grid-save-column-config", name="pimcore_admin_dataobject_dataobjecthelper_gridsavecolumnconfig", methods={"POST"})
   778|      *
   779|      * @param Request $request
   780|      *
   781|      * @return JsonResponse
   782|      */
   783|     public function gridSaveColumnConfigAction(Request $request)
   784|     {
   785|         $object = DataObject::getById($request->get('id'));
   786|         if ($object->isAllowed('list')) {
   787|             try {
   788|                 $classId = $request->get('class_id');
   789|                 $context = $request->get('context');
   790|                 $searchType = $request->get('searchType');
   791|                 $gridConfigData = $this->decodeJson($request->get('gridconfig'));
   792|                 $gridConfigData['pimcore_version'] = Version::getVersion();
   793|                 $gridConfigData['pimcore_revision'] = Version::getRevision();
   794|                 $gridConfigData['context'] = $context;
   795|                 unset($gridConfigData['settings']['isShared']);
   796|                 $metadata = $request->get('settings');
   797|                 $metadata = json_decode($metadata, true);
   798|                 $gridConfigId = $metadata['gridConfigId'];
   799|                 $gridConfig = null;
   800|                 if ($gridConfigId) {
   801|                     try {
   802|                         $gridConfig = GridConfig::getById($gridConfigId);
   803|                     } catch (\Exception $e) {
   804|                     }
   805|                 }
   806|                 if ($gridConfig && $gridConfig->getOwnerId() != $this->getAdminUser()->getId() && !$this->getAdminUser()->isAdmin()) {
   807|                     throw new \Exception("don't mess around with somebody elses configuration");
   808|                 }
   809|                 $this->updateGridConfigShares($gridConfig, $metadata);
   810|                 if (!$gridConfig) {
   811|                     $gridConfig = new GridConfig();
   812|                     $gridConfig->setName(date('c'));
   813|                     $gridConfig->setClassId($classId);
   814|                     $gridConfig->setSearchType($searchType);
   815|                     $gridConfig->setOwnerId($this->getAdminUser()->getId());
   816|                 }
   817|                 if ($metadata) {
   818|                     $gridConfig->setName($metadata['gridConfigName']);
   819|                     $gridConfig->setDescription($metadata['gridConfigDescription']);
   820|                     $gridConfig->setShareGlobally($metadata['shareGlobally'] && $this->getAdminUser()->isAdmin());
   821|                 }
   822|                 $gridConfigData = json_encode($gridConfigData);
   823|                 $gridConfig->setConfig($gridConfigData);
   824|                 $gridConfig->save();
   825|                 $userId = $this->getAdminUser()->getId();
   826|                 $availableConfigs = $this->getMyOwnGridColumnConfigs($userId, $classId, $searchType);
   827|                 $sharedConfigs = $this->getSharedGridColumnConfigs($this->getAdminUser(), $classId, $searchType);
   828|                 $settings = $this->getShareSettings($gridConfig->getId());
   829|                 $settings['gridConfigId'] = (int)$gridConfig->getId();
   830|                 $settings['gridConfigName'] = $gridConfig->getName();
   831|                 $settings['gridConfigDescription'] = $gridConfig->getDescription();
   832|                 $settings['shareGlobally'] = $gridConfig->isShareGlobally();
   833|                 $settings['isShared'] = $gridConfig->getOwnerId() != $this->getAdminUser()->getId() && !$this->getAdminUser()->isAdmin();
   834|                 return $this->adminJson([
   835|                     'success' => true,
   836|                     'settings' => $settings,
   837|                     'availableConfigs' => $availableConfigs,
   838|                     'sharedConfigs' => $sharedConfigs,
   839|                 ]);
   840|             } catch (\Exception $e) {
   841|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   842|             }
   843|         }
   844|         throw $this->createAccessDeniedHttpException();
   845|     }
   846|     /**
   847|      * @param GridConfig|null $gridConfig
   848|      * @param array $metadata
   849|      *
   850|      * @throws \Exception
   851|      */
   852|     protected function updateGridConfigShares($gridConfig, $metadata)
   853|     {
   854|         $user = $this->getAdminUser();
   855|         if (!$gridConfig || !$user->isAllowed('share_configurations')) {
   856|             return;
   857|         }
   858|         if ($gridConfig->getOwnerId() != $user->getId() && !$user->isAdmin()) {
   859|             throw new \Exception("don't mess with someone elses grid config");
   860|         }
   861|         $combinedShares = [];
   862|         $sharedUserIds = $metadata['sharedUserIds'];
   863|         $sharedRoleIds = $metadata['sharedRoleIds'];
   864|         if ($sharedUserIds) {
   865|             $combinedShares = explode(',', $sharedUserIds);
   866|         }
   867|         if ($sharedRoleIds) {
   868|             $sharedRoleIds = explode(',', $sharedRoleIds);
   869|             $combinedShares = array_merge($combinedShares, $sharedRoleIds);
   870|         }
   871|         $db = Db::get();
   872|         $db->delete('gridconfig_shares', ['gridConfigId' => $gridConfig->getId()]);
   873|         foreach ($combinedShares as $id) {
   874|             $share = new GridConfigShare();
   875|             $share->setGridConfigId($gridConfig->getId());
   876|             $share->setSharedWithUserId($id);
   877|             $share->save();
   878|         }
   879|     }
   880|     /**
   881|      * @param DataObject\ClassDefinition\Data $field
   882|      * @param string $gridType
   883|      * @param string $position
   884|      * @param bool $force
   885|      * @param string|null $keyPrefix
   886|      * @param DataObject\ClassDefinition|null $class
   887|      * @param int|null $objectId
   888|      *
   889|      * @return array|null
   890|      */
   891|     protected function getFieldGridConfig($field, $gridType, $position, $force = false, $keyPrefix = null, $class = null, $objectId = null)
   892|     {
   893|         $key = $keyPrefix . $field->getName();
   894|         $config = null;
   895|         $title = $field->getName();
   896|         if (method_exists($field, 'getTitle')) {
   897|             if ($field->getTitle()) {
   898|                 $title = $field->getTitle();
   899|             }
   900|         }
   901|         if ($field instanceof DataObject\ClassDefinition\Data\Slider) {
   902|             $config['minValue'] = $field->getMinValue();
   903|             $config['maxValue'] = $field->getMaxValue();
   904|             $config['increment'] = $field->getIncrement();
   905|         }
   906|         if (method_exists($field, 'getWidth')) {
   907|             $config['width'] = $field->getWidth();
   908|         }
   909|         if (method_exists($field, 'getHeight')) {
   910|             $config['height'] = $field->getHeight();
   911|         }
   912|         $visible = false;
   913|         if ($gridType == 'search') {
   914|             $visible = $field->getVisibleSearch();
   915|         } elseif ($gridType == 'grid') {
   916|             $visible = $field->getVisibleGridView();
   917|         } elseif ($gridType == 'all') {
   918|             $visible = true;
   919|         }
   920|         if (!$field->getInvisible() && ($force || $visible)) {
   921|             $context = ['purpose' => 'gridconfig'];
   922|             if ($class) {
   923|                 $context['class'] = $class;
   924|             }
   925|             if ($objectId) {
   926|                 $object = DataObject::getById($objectId);
   927|                 $context['object'] = $object;
   928|             }
   929|             DataObject\Service::enrichLayoutDefinition($field, null, $context);
   930|             $result = [
   931|                 'key' => $key,
   932|                 'type' => $field->getFieldType(),
   933|                 'label' => $title,
   934|                 'config' => $config,
   935|                 'layout' => $field,
   936|                 'position' => $position,
   937|             ];
   938|             if ($field instanceof DataObject\ClassDefinition\Data\EncryptedField) {
   939|                 $result['delegateDatatype'] = $field->getDelegateDatatype();
   940|             }
   941|             return $result;
   942|         } else {
   943|             return null;
   944|         }
   945|     }
   946|     /**
   947|      * IMPORTER
   948|      */
   949|     /**
   950|      * @Route("/import-upload", name="pimcore_admin_dataobject_dataobjecthelper_importupload", methods={"POST"})
   951|      *
   952|      * @param Request $request
   953|      *
   954|      * @return JsonResponse
   955|      */
   956|     public function importUploadAction(Request $request)
   957|     {
   958|         $data = file_get_contents($_FILES['Filedata']['tmp_name']);
   959|         $data = Tool\Text::convertToUTF8($data);
   960|         $importId = $request->get('importId');
   961|         $importId = str_replace('..', '', $importId);
   962|         $importFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/import_' . $importId;
   963|         File::put($importFile, $data);
   964|         $importFileOriginal = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/import_' . $importId . '_original';
   965|         File::put($importFileOriginal, $data);
   966|         $response = $this->adminJson([
   967|             'success' => true,
   968|         ]);
   969|         $response->headers->set('Content-Type', 'text/html');
   970|         return $response;
   971|     }
   972|     private function getDataPreview($originalFile, $dialect)
   973|     {
   974|         $count = 0;
   975|         $data = [];
   976|         if (($handle = fopen($originalFile, 'r')) !== false) {
   977|             while (($rowData = fgetcsv($handle, 0, $dialect->delimiter, $dialect->quotechar, $dialect->escapechar)) !== false) {
   978|                 $tmpData = [];
   979|                 foreach ($rowData as $key => $value) {
   980|                     $tmpData['field_' . $key] = $value;
   981|                 }
   982|                 $tmpData['rowId'] = $count + 1;
   983|                 $data[] = $tmpData;
   984|                 $count++;
   985|                 /**
   986|                  * Reached the number or rows for the preview
   987|                  */
   988|                 if ($count > 18) {
   989|                     break;
   990|                 }
   991|             }
   992|             fclose($handle);
   993|         }
   994|         return $data;
   995|     }
   996|     /**
   997|      * @param Request $request
   998|      *
   999|      * @return mixed|string
  1000|      */
  1001|     protected function extractLanguage(Request $request)
  1002|     {
  1003|         $requestedLanguage = $request->get('language');
  1004|         if ($requestedLanguage) {
  1005|             if ($requestedLanguage != 'default') {
  1006|                 $request->setLocale($requestedLanguage);
  1007|             }
  1008|         } else {
  1009|             $requestedLanguage = $request->getLocale();
  1010|         }
  1011|         return $requestedLanguage;
  1012|     }
  1013|     /**
  1014|      * @param string $fileHandle
  1015|      *
  1016|      * @return string
  1017|      */
  1018|     protected function getCsvFile($fileHandle)
  1019|     {
  1020|         return PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . $fileHandle . '.csv';
  1021|     }
  1022|     /**
  1023|      * @Route("/get-export-jobs", name="pimcore_admin_dataobject_dataobjecthelper_getexportjobs", methods={"GET"})
  1024|      *
  1025|      * @param Request $request
  1026|      * @param GridHelperService $gridHelperService
  1027|      * @param EventDispatcherInterface $eventDispatcher
  1028|      *
  1029|      * @return JsonResponse
  1030|      */
  1031|     public function getExportJobsAction(Request $request, GridHelperService $gridHelperService, EventDispatcherInterface $eventDispatcher)
  1032|     {
  1033|         $requestedLanguage = $this->extractLanguage($request);
  1034|         $allParams = array_merge($request->request->all(), $request->query->all());
  1035|         $list = $gridHelperService->prepareListingForGrid($allParams, $requestedLanguage, $this->getAdminUser());
  1036|         $beforeListPrepareEvent = new GenericEvent($this, [
  1037|             'list' => $list,
  1038|             'context' => $allParams,
  1039|         ]);
  1040|         $eventDispatcher->dispatch($beforeListPrepareEvent, AdminEvents::OBJECT_LIST_BEFORE_EXPORT_PREPARE);
  1041|         $list = $beforeListPrepareEvent->getArgument('list');
  1042|         $ids = $list->loadIdList();
  1043|         $jobs = array_chunk($ids, 20);
  1044|         $fileHandle = uniqid('export-');
  1045|         file_put_contents($this->getCsvFile($fileHandle), '');
  1046|         return $this->adminJson(['success' => true, 'jobs' => $jobs, 'fileHandle' => $fileHandle]);
  1047|     }
  1048|     /**
  1049|      * @Route("/do-export", name="pimcore_admin_dataobject_dataobjecthelper_doexport", methods={"POST"})
  1050|      *
  1051|      * @param Request $request
  1052|      * @param LocaleServiceInterface $localeService
  1053|      * @param EventDispatcherInterface $eventDispatcher
  1054|      *
  1055|      * @return JsonResponse
  1056|      *
  1057|      * @throws \Exception
  1058|      */
  1059|     public function doExportAction(Request $request, LocaleServiceInterface $localeService, EventDispatcherInterface $eventDispatcher)
  1060|     {
  1061|         $fileHandle = \Pimcore\File::getValidFilename($request->get('fileHandle'));
  1062|         $ids = $request->get('ids');
  1063|         $settings = $request->get('settings');
  1064|         $settings = json_decode($settings, true);
  1065|         $delimiter = $settings['delimiter'] ?? ';';
  1066|         $allParams = array_merge($request->request->all(), $request->query->all());
  1067|         $enableInheritance = $settings['enableInheritance'] ?? null;
  1068|         DataObject\Concrete::setGetInheritedValues($enableInheritance);
  1069|         $class = DataObject\ClassDefinition::getById($request->get('classId'));
  1070|         if (!$class) {
  1071|             throw new \Exception('No class definition found');
  1072|         }
  1073|         $className = $class->getName();
  1074|         $listClass = '\\Pimcore\\Model\\DataObject\\' . ucfirst($className) . '\\Listing';
  1075|         /** @var \Pimcore\Model\DataObject\Listing $list */
  1076|         $list = new $listClass();
  1077|         $quotedIds = [];
  1078|         foreach ($ids as $id) {
  1079|             $quotedIds[] = $list->quote($id);
  1080|         }
  1081|         $list->setObjectTypes(DataObject::$types);
  1082|         $list->setCondition('o_id IN (' . implode(',', $quotedIds) . ')');
  1083|         $list->setOrderKey(' FIELD(o_id, ' . implode(',', $quotedIds) . ')', false);
  1084|         $beforeListExportEvent = new GenericEvent($this, [
  1085|             'list' => $list,
  1086|             'context' => $allParams,
  1087|         ]);
  1088|         $eventDispatcher->dispatch($beforeListExportEvent, AdminEvents::OBJECT_LIST_BEFORE_EXPORT);
  1089|         $list = $beforeListExportEvent->getArgument('list');
  1090|         $fields = $request->get('fields');
  1091|         $addTitles = $request->get('initial');
  1092|         $requestedLanguage = $this->extractLanguage($request);
  1093|         $contextFromRequest = $request->get('context');
  1094|         if ($contextFromRequest) {
  1095|             $contextFromRequest = json_decode($contextFromRequest, true);
  1096|         }
  1097|         $context = [
  1098|             'source' => 'pimcore-export',
  1099|         ];
  1100|         if (is_array($contextFromRequest)) {
  1101|             $context = array_merge($context, $contextFromRequest);
  1102|         }
  1103|         $csv = DataObject\Service::getCsvData($requestedLanguage, $localeService, $list, $fields, $addTitles, $context);
  1104|         $fp = fopen($this->getCsvFile($fileHandle), 'a');
  1105|         $firstLine = true;
  1106|         $lineCount = count($csv);
  1107|         if (!$addTitles && $lineCount > 0) {
  1108|             fwrite($fp, "\r\n");
  1109|         }
  1110|         for ($i = 0; $i < $lineCount; $i++) {
  1111|             $line = $csv[$i];
  1112|             if ($addTitles && $firstLine) {
  1113|                 $firstLine = false;
  1114|                 $line = implode($delimiter, $line);
  1115|                 fwrite($fp, $line);
  1116|             } else {
  1117|                 fwrite($fp, implode($delimiter, array_map([$this, 'encodeFunc'], $line)));
  1118|             }
  1119|             if ($i < $lineCount - 1) {
  1120|                 fwrite($fp, "\r\n");
  1121|             }
  1122|         }
  1123|         fclose($fp);
  1124|         return $this->adminJson(['success' => true]);
  1125|     }
  1126|     public function encodeFunc($value)
  1127|     {
  1128|         $value = str_replace('"', '""', $value);
  1129|         return '"' . $value . '"';
  1130|     }
  1131|     /**
  1132|      * @Route("/download-csv-file", name="pimcore_admin_dataobject_dataobjecthelper_downloadcsvfile", methods={"GET"})
  1133|      *
  1134|      * @param Request $request
  1135|      *
  1136|      * @return BinaryFileResponse
  1137|      */
  1138|     public function downloadCsvFileAction(Request $request)
  1139|     {
  1140|         $fileHandle = \Pimcore\File::getValidFilename($request->get('fileHandle'));
  1141|         $csvFile = $this->getCsvFile($fileHandle);
  1142|         if (file_exists($csvFile)) {
  1143|             $response = new BinaryFileResponse($csvFile);
  1144|             $response->headers->set('Content-Type', 'application/csv');
  1145|             $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, 'export.csv');
  1146|             $response->deleteFileAfterSend(true);
  1147|             return $response;
  1148|         }
  1149|         throw $this->createNotFoundException('CSV file not found');
  1150|     }
  1151|     /**
  1152|      * @Route("/download-xlsx-file", name="pimcore_admin_dataobject_dataobjecthelper_downloadxlsxfile", methods={"GET"})
  1153|      *
  1154|      * @param Request $request
  1155|      *
  1156|      * @return BinaryFileResponse
  1157|      */
  1158|     public function downloadXlsxFileAction(Request $request)
  1159|     {
  1160|         $fileHandle = \Pimcore\File::getValidFilename($request->get('fileHandle'));
  1161|         $csvFile = $this->getCsvFile($fileHandle);
  1162|         if (file_exists($csvFile)) {
  1163|             $csvReader = new Csv();
  1164|             $csvReader->setDelimiter(';');
  1165|             $csvReader->setSheetIndex(0);
  1166|             $spreadsheet = $csvReader->load($csvFile);
  1167|             $writer = new Xlsx($spreadsheet);
  1168|             $xlsxFilename = PIMCORE_SYSTEM_TEMP_DIRECTORY. '/' .$fileHandle. '.xlsx';
  1169|             $writer->save($xlsxFilename);
  1170|             $response = new BinaryFileResponse($xlsxFilename);
  1171|             $response->headers->set('Content-Type', 'application/xlsx');
  1172|             $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, 'export.xlsx');
  1173|             $response->deleteFileAfterSend(true);
  1174|             return $response;
  1175|         }
  1176|         throw $this->createNotFoundException('XLSX file not found');
  1177|     }
  1178|     /**
  1179|      * Flattens object data to an array with key=>value where
  1180|      * value is simply a string representation of the value (for objects, hrefs and assets the full path is used)
  1181|      *
  1182|      * @param DataObject\Concrete $object
  1183|      *
  1184|      * @return array
  1185|      */
  1186|     protected function csvObjectData($object)
  1187|     {
  1188|         $o = [];
  1189|         foreach ($object->getClass()->getFieldDefinitions() as $key => $value) {
  1190|             if (!$value instanceof DataObject\ClassDefinition\Data\ReverseObjectRelation) {
  1191|                 $o[$key] = $value->getForCsvExport($object);
  1192|             }
  1193|         }
  1194|         $o['id (system)'] = $object->getId();
  1195|         $o['key (system)'] = $object->getKey();
  1196|         $o['fullpath (system)'] = $object->getRealFullPath();
  1197|         $o['published (system)'] = $object->isPublished();
  1198|         $o['type (system)'] = $object->getType();
  1199|         return $o;
  1200|     }
  1201|     /**
  1202|      * @Route("/get-batch-jobs", name="pimcore_admin_dataobject_dataobjecthelper_getbatchjobs", methods={"GET"})
  1203|      *
  1204|      * @param Request $request
  1205|      *
  1206|      * @return JsonResponse
  1207|      */
  1208|     public function getBatchJobsAction(Request $request, GridHelperService $gridHelperService)
  1209|     {
  1210|         if ($request->get('language')) {
  1211|             $request->setLocale($request->get('language'));
  1212|         }
  1213|         $allParams = array_merge($request->request->all(), $request->query->all());
  1214|         $list = $gridHelperService->prepareListingForGrid($allParams, $request->getLocale(), $this->getAdminUser());
  1215|         $jobs = $list->loadIdList();
  1216|         return $this->adminJson(['success' => true, 'jobs' => $jobs]);
  1217|     }
  1218|     /**
  1219|      * @Route("/batch", name="pimcore_admin_dataobject_dataobjecthelper_batch", methods={"PUT"})
  1220|      *
  1221|      * @param Request $request
  1222|      *
  1223|      * @return JsonResponse
  1224|      */
  1225|     public function batchAction(Request $request)
  1226|     {
  1227|         $success = true;
  1228|         try {
  1229|             if ($request->get('data')) {
  1230|                 $params = $this->decodeJson($request->get('data'), true);
  1231|                 $object = DataObject\Concrete::getById($params['job']);
  1232|                 if ($object) {
  1233|                     $name = $params['name'];
  1234|                     if (!$object->isAllowed('save') || ($name === 'published' && !$object->isAllowed('publish'))) {
  1235|                         throw new \Exception("Permission denied. You don't have the rights to save this object.");
  1236|                     }
  1237|                     $append = $params['append'] ?? false;
  1238|                     $remove = $params['remove'] ?? false;
  1239|                     $className = $object->getClassName();
  1240|                     $class = DataObject\ClassDefinition::getByName($className);
  1241|                     $value = $params['value'];
  1242|                     if ($params['valueType'] == 'object') {
  1243|                         $value = $this->decodeJson($value);
  1244|                     }
  1245|                     $parts = explode('~', $name);
  1246|                     if (substr($name, 0, 1) == '~') {
  1247|                         $type = $parts[1];
  1248|                         $field = $parts[2];
  1249|                         $keyid = $parts[3];
  1250|                         if ($type == 'classificationstore') {
  1251|                             $requestedLanguage = $params['language'];
  1252|                             if ($requestedLanguage) {
  1253|                                 if ($requestedLanguage != 'default') {
  1254|                                     $request->setLocale($requestedLanguage);
  1255|                                 }
  1256|                             } else {
  1257|                                 $requestedLanguage = $request->getLocale();
  1258|                             }
  1259|                             $groupKeyId = explode('-', $keyid);
  1260|                             $groupId = $groupKeyId[0];
  1261|                             $keyid = $groupKeyId[1];
  1262|                             $getter = 'get' . ucfirst($field);
  1263|                             if (method_exists($object, $getter)) {
  1264|                                 /** @var DataObject\ClassDefinition\Data\Classificationstore $csFieldDefinition */
  1265|                                 $csFieldDefinition = $object->getClass()->getFieldDefinition($field);
  1266|                                 $csLanguage = $requestedLanguage;
  1267|                                 if (!$csFieldDefinition->isLocalized()) {
  1268|                                     $csLanguage = 'default';
  1269|                                 }
  1270|                                 /** @var DataObject\ClassDefinition\Data\Classificationstore $fd */
  1271|                                 $fd = $class->getFieldDefinition($field);
  1272|                                 $keyConfig = $fd->getKeyConfiguration($keyid);
  1273|                                 $dataDefinition = DataObject\Classificationstore\Service::getFieldDefinitionFromKeyConfig($keyConfig);
  1274|                                 /** @var DataObject\Classificationstore $classificationStoreData */
  1275|                                 $classificationStoreData = $object->$getter();
  1276|                                 $classificationStoreData->setLocalizedKeyValue(
  1277|                                     $groupId,
  1278|                                     $keyid,
  1279|                                     $dataDefinition->getDataFromEditmode($value),
  1280|                                     $csLanguage
  1281|                                 );
  1282|                             }
  1283|                         }
  1284|                     } elseif (count($parts) > 1) {
  1285|                         $brickType = $parts[0];
  1286|                         $brickKey = $parts[1];
  1287|                         $brickField = DataObject\Service::getFieldForBrickType($object->getClass(), $brickType);
  1288|                         $fieldGetter = 'get' . ucfirst($brickField);
  1289|                         $brickGetter = 'get' . ucfirst($brickType);
  1290|                         $valueSetter = 'set' . ucfirst($brickKey);
  1291|                         $brick = $object->$fieldGetter()->$brickGetter();
  1292|                         if (empty($brick)) {
  1293|                             $classname = '\\Pimcore\\Model\\DataObject\\Objectbrick\\Data\\' . ucfirst($brickType);
  1294|                             $brickSetter = 'set' . ucfirst($brickType);
  1295|                             $brick = new $classname($object);
  1296|                             $object->$fieldGetter()->$brickSetter($brick);
  1297|                         }
  1298|                         $brickClass = DataObject\Objectbrick\Definition::getByKey($brickType);
  1299|                         $field = $brickClass->getFieldDefinition($brickKey);
  1300|                         $newData = $field->getDataFromEditmode($value, $object);
  1301|                         if ($append) {
  1302|                             $valueGetter = 'get' . ucfirst($brickKey);
  1303|                             $existingData = $brick->$valueGetter();
  1304|                             $newData = $field->appendData($existingData, $newData);
  1305|                         }
  1306|                         if ($remove) {
  1307|                             $valueGetter = 'get' . ucfirst($brickKey);
  1308|                             $existingData = $brick->$valueGetter();
  1309|                             $newData = $field->removeData($existingData, $newData);
  1310|                         }
  1311|                         $brick->$valueSetter($newData);
  1312|                     } else {
  1313|                         $field = $class->getFieldDefinition($name);
  1314|                         if ($field) {
  1315|                             $newData = $field->getDataFromEditmode($value, $object);
  1316|                             if ($append) {
  1317|                                 $existingData = $object->{'get' . $name}();
  1318|                                 $newData = $field->appendData($existingData, $newData);
  1319|                             }
  1320|                             if ($remove) {
  1321|                                 $existingData = $object->{'get' . $name}();
  1322|                                 $newData = $field->removeData($existingData, $newData);
  1323|                             }
  1324|                             $object->setValue($name, $newData);
  1325|                         } else {
  1326|                             if ($params['language']) {
  1327|                                 $localizedField = $class->getFieldDefinition('localizedfields');
  1328|                                 if ($localizedField instanceof DataObject\ClassDefinition\Data\Localizedfields) {
  1329|                                     $field = $localizedField->getFieldDefinition($name);
  1330|                                     if ($field) {
  1331|                                         $getter = 'get' . $name;
  1332|                                         $setter = 'set' . $name;
  1333|                                         $newData = $field->getDataFromEditmode($value, $object);
  1334|                                         if ($append) {
  1335|                                             $existingData = $object->$getter($params['language']);
  1336|                                             $newData = $field->appendData($existingData, $newData);
  1337|                                         }
  1338|                                         if ($remove) {
  1339|                                             $existingData = $object->$getter($request->get('language'));
  1340|                                             $newData = $field->removeData($existingData, $newData);
  1341|                                         }
  1342|                                         $object->$setter($newData, $params['language']);
  1343|                                     }
  1344|                                 }
  1345|                             }
  1346|                             if ($name == 'published') {
  1347|                                 if ($value === 'false' || empty($value)) {
  1348|                                     $object->setPublished(false);
  1349|                                 } else {
  1350|                                     $object->setPublished(true);
  1351|                                 }
  1352|                             }
  1353|                         }
  1354|                     }
  1355|                     try {
  1356|                         $object->setOmitMandatoryCheck(!$object->isPublished());
  1357|                         $object->setUserModification($this->getAdminUser()->getId());
  1358|                         $object->save();
  1359|                         $success = true;
  1360|                     } catch (\Exception $e) {
  1361|                         return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
  1362|                     }
  1363|                 } else {
  1364|                     Logger::debug('DataObjectController::batchAction => There is no object left to update.');
  1365|                     return $this->adminJson(['success' => false, 'message' => 'DataObjectController::batchAction => There is no object left to update.']);
  1366|                 }
  1367|             }
  1368|         } catch (\Exception $e) {
  1369|             Logger::err($e);
  1370|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
  1371|         }
  1372|         return $this->adminJson(['success' => $success]);
  1373|     }
  1374|     /**
  1375|      * @Route("/get-available-visible-vields", name="pimcore_admin_dataobject_dataobjecthelper_getavailablevisiblefields", methods={"GET"})
  1376|      *
  1377|      * @param Request $request
  1378|      *
  1379|      * @return JsonResponse
  1380|      */
  1381|     public function getAvailableVisibleFieldsAction(Request $request)
  1382|     {
  1383|         $class = null;
  1384|         $fields = null;
  1385|         $classList = [];
  1386|         $classNameList = [];
  1387|         if ($request->get('classes')) {
  1388|             $classNameList = $request->get('classes');
  1389|             $classNameList = explode(',', $classNameList);
  1390|             foreach ($classNameList as $className) {
  1391|                 $class = DataObject\ClassDefinition::getByName($className);
  1392|                 if ($class) {
  1393|                     $classList[] = $class;
  1394|                 }
  1395|             }
  1396|         }
  1397|         if (!$classList) {
  1398|             return $this->adminJson(['availableFields' => []]);
  1399|         }
  1400|         $availableFields = [];
  1401|         foreach (self::SYSTEM_COLUMNS as $field) {
  1402|             $availableFields[] = [
  1403|                 'key' => $field,
  1404|                 'value' => $field,
  1405|             ];
  1406|         }
  1407|         /** @var DataObject\ClassDefinition\Data[] $commonFields */
  1408|         $commonFields = [];
  1409|         $firstOne = true;
  1410|         foreach ($classNameList as $className) {
  1411|             $class = DataObject\ClassDefinition::getByName($className);
  1412|             if ($class) {
  1413|                 $fds = $class->getFieldDefinitions();
  1414|                 $additionalFieldNames = array_keys($fds);
  1415|                 $localizedFields = $class->getFieldDefinition('localizedfields');
  1416|                 if ($localizedFields instanceof DataObject\ClassDefinition\Data\Localizedfields) {
  1417|                     $lfNames = array_keys($localizedFields->getFieldDefinitions());
  1418|                     $additionalFieldNames = array_merge($additionalFieldNames, $lfNames);
  1419|                 }
  1420|                 foreach ($commonFields as $commonFieldKey => $commonFieldDefinition) {
  1421|                     if (!in_array($commonFieldKey, $additionalFieldNames)) {
  1422|                         unset($commonFields[$commonFieldKey]);
  1423|                     }
  1424|                 }
  1425|                 $this->processAvailableFieldDefinitions($fds, $firstOne, $commonFields);
  1426|                 $firstOne = false;
  1427|             }
  1428|         }
  1429|         $commonFieldKeys = array_keys($commonFields);
  1430|         foreach ($commonFieldKeys as $field) {
  1431|             $availableFields[] = [
  1432|                 'key' => $field,
  1433|                 'value' => $field,
  1434|             ];
  1435|         }
  1436|         return $this->adminJson(['availableFields' => $availableFields]);
  1437|     }
  1438|     /**
  1439|      * @param DataObject\ClassDefinition\Data[] $fds
  1440|      * @param bool $firstOne
  1441|      * @param DataObject\ClassDefinition\Data[] $commonFields
  1442|      */
  1443|     protected function processAvailableFieldDefinitions($fds, &$firstOne, &$commonFields)
  1444|     {
  1445|         foreach ($fds as $fd) {
  1446|             if ($fd instanceof DataObject\ClassDefinition\Data\Fieldcollections || $fd instanceof DataObject\ClassDefinition\Data\Objectbricks
  1447|                 || $fd instanceof DataObject\ClassDefinition\Data\Block) {
  1448|                 continue;
  1449|             }
  1450|             if ($fd instanceof DataObject\ClassDefinition\Data\Localizedfields) {
  1451|                 $lfDefs = $fd->getFieldDefinitions();
  1452|                 $this->processAvailableFieldDefinitions($lfDefs, $firstOne, $commonFields);
  1453|             } elseif ($firstOne || (isset($commonFields[$fd->getName()]) && $commonFields[$fd->getName()]->getFieldtype() == $fd->getFieldtype())) {
  1454|                 $commonFields[$fd->getName()] = $fd;
  1455|             }
  1456|         }
  1457|     }
  1458| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/DataObject/QuantityValueController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-234 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\DataObject;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Model\DataObject\Data\QuantityValue;
    17| use Pimcore\Model\DataObject\QuantityValue\Unit;
    18| use Pimcore\Model\DataObject\QuantityValue\UnitConversionService;
    19| use Pimcore\Model\Translation;
    20| use Symfony\Component\HttpFoundation\JsonResponse;
    21| use Symfony\Component\HttpFoundation\Request;
    22| use Symfony\Component\Routing\Annotation\Route;
    23| /**
    24|  *  @internal
    25|  */
    26| class QuantityValueController extends AdminController
    27| {
    28|     /**
    29|      * @Route("/quantity-value/unit-proxy", name="pimcore_admin_dataobject_quantityvalue_unitproxyget", methods={"GET"})
    30|      *
    31|      * @param Request $request
    32|      *
    33|      * @return JsonResponse
    34|      *
    35|      * @throws \Exception
    36|      */
    37|     public function unitProxyGetAction(Request $request)
    38|     {
    39|         $list = new Unit\Listing();
    40|         $order = ['ASC', 'ASC', 'ASC'];
    41|         $orderKey = ['baseunit', 'factor', 'abbreviation'];
    42|         $allParams = array_merge($request->request->all(), $request->query->all());
    43|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
    44|         if ($sortingSettings['orderKey']) {
    45|             array_unshift($orderKey, $sortingSettings['orderKey']);
    46|         }
    47|         if ($sortingSettings['order']) {
    48|             array_unshift($order, $sortingSettings['order']);
    49|         }
    50|         $list->setOrder($order);
    51|         $list->setOrderKey($orderKey);
    52|         $list->setLimit($request->get('limit'));
    53|         $list->setOffset($request->get('start'));
    54|         $condition = '1 = 1';
    55|         if ($request->get('filter')) {
    56|             $filterString = $request->get('filter');
    57|             $filters = json_decode($filterString);
    58|             $db = \Pimcore\Db::get();
    59|             foreach ($filters as $f) {
    60|                 if ($f->type == 'string') {
    61|                     $condition .= ' AND ' . $db->quoteIdentifier($f->property) . ' LIKE ' . $db->quote('%' . $f->value . '%');
    62|                 } elseif ($f->type == 'numeric') {
    63|                     $operator = $this->getOperator($f->comparison);
    64|                     $condition .= ' AND ' . $db->quoteIdentifier($f->property) . ' ' . $operator . ' ' . $db->quote($f->value);
    65|                 }
    66|             }
    67|             $list->setCondition($condition);
    68|         }
    69|         $units = [];
    70|         foreach ($list->getUnits() as $u) {
    71|             $units[] = $u->getObjectVars();
    72|         }
    73|         return $this->adminJson(['data' => $units, 'success' => true, 'total' => $list->getTotalCount()]);
    74|     }
    75|     /**
    76|      * @Route("/quantity-value/unit-proxy", name="pimcore_admin_dataobject_quantityvalue_unitproxy", methods={"POST", "PUT"})
    77|      *
    78|      * @param Request $request
    79|      *
    80|      * @return JsonResponse
    81|      *
    82|      * @throws \Exception
    83|      */
    84|     public function unitProxyAction(Request $request)
    85|     {
    86|         if ($request->get('data')) {
    87|             if ($request->get('xaction') == 'destroy') {
    88|                 $data = json_decode($request->get('data'), true);
    89|                 $id = $data['id'];
    90|                 $unit = \Pimcore\Model\DataObject\QuantityValue\Unit::getById($id);
    91|                 if (!empty($unit)) {
    92|                     $unit->delete();
    93|                     return $this->adminJson(['data' => [], 'success' => true]);
    94|                 } else {
    95|                     throw new \Exception('Unit with id ' . $id . ' not found.');
    96|                 }
    97|             } elseif ($request->get('xaction') == 'update') {
    98|                 $data = json_decode($request->get('data'), true);
    99|                 $unit = Unit::getById($data['id']);
   100|                 if (!empty($unit)) {
   101|                     if (($data['baseunit'] ?? null) === -1) {
   102|                         $data['baseunit'] = null;
   103|                     }
   104|                     $unit->setValues($data);
   105|                     $unit->save();
   106|                     return $this->adminJson(['data' => $unit->getObjectVars(), 'success' => true]);
   107|                 } else {
   108|                     throw new \Exception('Unit with id ' . $data['id'] . ' not found.');
   109|                 }
   110|             } elseif ($request->get('xaction') == 'create') {
   111|                 $data = json_decode($request->get('data'), true);
   112|                 if (isset($data['baseunit']) && $data['baseunit'] === -1) {
   113|                     $data['baseunit'] = null;
   114|                 }
   115|                 $id = $data['id'];
   116|                 if (Unit::getById($id)) {
   117|                     throw new \Exception('unit with ID [' . $id . '] already exists');
   118|                 }
   119|                 $unit = new Unit();
   120|                 $unit->setValues($data);
   121|                 $unit->save();
   122|                 return $this->adminJson(['data' => $unit->getObjectVars(), 'success' => true]);
   123|             }
   124|         }
   125|         return $this->adminJson(['success' => false]);
   126|     }
   127|     /**
   128|      * @param string $comparison
   129|      *
   130|      * @return string
   131|      */
   132|     private function getOperator($comparison)
   133|     {
   134|         $mapper = [
   135|             'lt' => '<',
   136|             'gt' => '>',
   137|             'eq' => '=',
   138|         ];
   139|         return $mapper[$comparison];
   140|     }
   141|     /**
   142|      * @Route("/quantity-value/unit-list", name="pimcore_admin_dataobject_quantityvalue_unitlist", methods={"GET"})
   143|      *
   144|      * @param Request $request
   145|      *
   146|      * @return JsonResponse
   147|      */
   148|     public function unitListAction(Request $request)
   149|     {
   150|         $list = new Unit\Listing();
   151|         $list->setOrderKey(['baseunit', 'factor', 'abbreviation']);
   152|         $list->setOrder(['ASC', 'ASC', 'ASC']);
   153|         if ($request->get('filter')) {
   154|             $array = explode(',', $request->get('filter'));
   155|             $quotedArray = [];
   156|             $db = \Pimcore\Db::get();
   157|             foreach ($array as $a) {
   158|                 $quotedArray[] = $db->quote($a);
   159|             }
   160|             $string = implode(',', $quotedArray);
   161|             $list->setCondition('id IN (' . $string . ')');
   162|         }
   163|         $result = [];
   164|         $units = $list->getUnits();
   165|         foreach ($units as &$unit) {
   166|             try {
   167|                 if ($unit->getAbbreviation()) {
   168|                     $unit->setAbbreviation(\Pimcore\Model\Translation::getByKeyLocalized($unit->getAbbreviation(), Translation::DOMAIN_ADMIN,
   169|                         true, true));
   170|                 }
   171|                 if ($unit->getLongname()) {
   172|                     $unit->setLongname(\Pimcore\Model\Translation::getByKeyLocalized($unit->getLongname(), Translation::DOMAIN_ADMIN, true,
   173|                         true));
   174|                 }
   175|                 $result[] = $unit->getObjectVars();
   176|             } catch (\Exception $e) {
   177|             }
   178|         }
   179|         return $this->adminJson(['data' => $result, 'success' => true, 'total' => $list->getTotalCount()]);
   180|     }
   181|     /**
   182|      * @Route("/quantity-value/convert", name="pimcore_admin_dataobject_quantityvalue_convert", methods={"GET"})
   183|      *
   184|      * @param Request $request
   185|      * @param UnitConversionService $conversionService
   186|      *
   187|      * @return JsonResponse
   188|      */
   189|     public function convertAction(Request $request, UnitConversionService $conversionService)
   190|     {
   191|         $fromUnitId = $request->get('fromUnit');
   192|         $toUnitId = $request->get('toUnit');
   193|         $fromUnit = Unit::getById($fromUnitId);
   194|         $toUnit = Unit::getById($toUnitId);
   195|         if (!$fromUnit instanceof Unit || !$toUnit instanceof Unit) {
   196|             return $this->adminJson(['success' => false]);
   197|         }
   198|         try {
   199|             $convertedValue = $conversionService->convert(new QuantityValue($request->get('value'), $fromUnit), $toUnit);
   200|         } catch (\Exception $e) {
   201|             return $this->adminJson(['success' => false]);
   202|         }
   203|         return $this->adminJson(['value' => $convertedValue->getValue(), 'success' => true]);
   204|     }
   205|     /**
   206|      * @Route("/quantity-value/convert-all", name="pimcore_admin_dataobject_quantityvalue_convertall", methods={"GET"})
   207|      *
   208|      * @param Request $request
   209|      * @param UnitConversionService $conversionService
   210|      *
   211|      * @return JsonResponse
   212|      */
   213|     public function convertAllAction(Request $request, UnitConversionService $conversionService)
   214|     {
   215|         $unitId = $request->get('unit');
   216|         $fromUnit = Unit::getById($unitId);
   217|         if (!$fromUnit instanceof Unit) {
   218|             return $this->adminJson(['success' => false]);
   219|         }
   220|         $baseUnit = $fromUnit->getBaseunit() ?? $fromUnit;
   221|         $units = new Unit\Listing();
   222|         $units->setCondition('baseunit = '.$units->quote($baseUnit->getId()).' AND id != '.$units->quote($fromUnit->getId()));
   223|         $convertedValues = [];
   224|         foreach ($units->getUnits() as $targetUnit) {
   225|             try {
   226|                 $convertedValue = $conversionService->convert(new QuantityValue($request->get('value'), $fromUnit), $targetUnit);
   227|                 $convertedValues[] = ['unit' => $targetUnit->getAbbreviation(), 'unitName' => $targetUnit->getLongname(), 'value' => round($convertedValue->getValue(), 4)];
   228|             } catch (\Exception $e) {
   229|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   230|             }
   231|         }
   232|         return $this->adminJson(['value' => $request->get('value'), 'fromUnit' => $fromUnit->getAbbreviation(), 'values' => $convertedValues, 'success' => true]);
   233|     }
   234| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/DataObject/VariantsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-228 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\DataObject;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Bundle\AdminBundle\Helper\GridHelperService;
    17| use Pimcore\Model\DataObject;
    18| use Symfony\Component\HttpFoundation\JsonResponse;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| /**
    22|  * @Route("/variants")
    23|  *
    24|  * @internal
    25|  */
    26| class VariantsController extends AdminController
    27| {
    28|     /**
    29|      * @Route("/update-key", name="pimcore_admin_dataobject_variants_updatekey", methods={"PUT"})
    30|      *
    31|      * @param Request $request
    32|      *
    33|      * @return JsonResponse
    34|      */
    35|     public function updateKeyAction(Request $request)
    36|     {
    37|         $id = $request->get('id');
    38|         $key = $request->get('key');
    39|         $object = DataObject\Concrete::getById($id);
    40|         try {
    41|             if (!empty($object)) {
    42|                 $object->setKey($key);
    43|                 $object->save();
    44|                 return $this->adminJson(['success' => true]);
    45|             } else {
    46|                 throw new \Exception('No Object found for given id.');
    47|             }
    48|         } catch (\Exception $e) {
    49|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
    50|         }
    51|     }
    52|     /**
    53|      * @Route("/get-variants", name="pimcore_admin_dataobject_variants_getvariants", methods={"GET", "POST"})
    54|      *
    55|      * @param Request $request
    56|      * @param GridHelperService $gridHelperService
    57|      *
    58|      * @return JsonResponse
    59|      *
    60|      * @throws \Exception
    61|      */
    62|     public function getVariantsAction(Request $request, GridHelperService $gridHelperService)
    63|     {
    64|         $requestedLanguage = $request->get('language');
    65|         if ($requestedLanguage) {
    66|             if ($requestedLanguage != 'default') {
    67|                 $request->setLocale($requestedLanguage);
    68|             }
    69|         } else {
    70|             $requestedLanguage = $request->getLocale();
    71|         }
    72|         if ($request->get('xaction') == 'update') {
    73|             $data = $this->decodeJson($request->get('data'));
    74|             $object = DataObject\Concrete::getById($data['id']);
    75|             $class = $object->getClass();
    76|             if ($object->isAllowed('publish')) {
    77|                 $objectData = [];
    78|                 foreach ($data as $key => $value) {
    79|                     $parts = explode('~', $key);
    80|                     if (substr($key, 0, 1) == '~') {
    81|                         $type = $parts[1];
    82|                         $field = $parts[2];
    83|                         $keyid = $parts[3];
    84|                         if ($type == 'classificationstore') {
    85|                             $groupKeyId = explode('-', $keyid);
    86|                             $groupId = $groupKeyId[0];
    87|                             $keyid = $groupKeyId[1];
    88|                             $getter = 'get' . ucfirst($field);
    89|                             if (method_exists($object, $getter)) {
    90|                                 /** @var DataObject\ClassDefinition\Data\Classificationstore $csFieldDefinition */
    91|                                 $csFieldDefinition = $object->getClass()->getFieldDefinition($field);
    92|                                 $csLanguage = $requestedLanguage;
    93|                                 if (!$csFieldDefinition->isLocalized()) {
    94|                                     $csLanguage = 'default';
    95|                                 }
    96|                                 /** @var DataObject\Classificationstore $classificationStoreData */
    97|                                 $classificationStoreData = $object->$getter();
    98|                                 $keyConfig = DataObject\Classificationstore\KeyConfig::getById($keyid);
    99|                                 if ($keyConfig) {
   100|                                     $fieldDefinition = $keyDef = DataObject\Classificationstore\Service::getFieldDefinitionFromJson(
   101|                                         json_decode($keyConfig->getDefinition()),
   102|                                         $keyConfig->getType()
   103|                                     );
   104|                                     if ($fieldDefinition && method_exists($fieldDefinition, 'getDataFromGridEditor')) {
   105|                                         $value = $fieldDefinition->getDataFromGridEditor($value, $object, []);
   106|                                     }
   107|                                 }
   108|                                 $activeGroups = $classificationStoreData->getActiveGroups() ? $classificationStoreData->getActiveGroups() : [];
   109|                                 $activeGroups[$groupId] = true;
   110|                                 $classificationStoreData->setActiveGroups($activeGroups);
   111|                                 $classificationStoreData->setLocalizedKeyValue($groupId, $keyid, $value, $csLanguage);
   112|                             }
   113|                         }
   114|                     } elseif (count($parts) > 1) {
   115|                         $brickType = $parts[0];
   116|                         $brickDescriptor = null;
   117|                         if (strpos($brickType, '?') !== false) {
   118|                             $brickDescriptor = substr($brickType, 1);
   119|                             $brickDescriptor = json_decode($brickDescriptor, true);
   120|                             $brickType = $brickDescriptor['containerKey'];
   121|                         }
   122|                         $brickKey = $parts[1];
   123|                         $brickField = DataObject\Service::getFieldForBrickType($object->getClass(), $brickType);
   124|                         $fieldGetter = 'get' . ucfirst($brickField);
   125|                         $brickGetter = 'get' . ucfirst($brickType);
   126|                         $valueSetter = 'set' . ucfirst($brickKey);
   127|                         $brick = $object->$fieldGetter()->$brickGetter();
   128|                         if (empty($brick)) {
   129|                             $classname = '\\Pimcore\\Model\\DataObject\\Objectbrick\\Data\\' . ucfirst($brickType);
   130|                             $brickSetter = 'set' . ucfirst($brickType);
   131|                             $brick = new $classname($object);
   132|                             $object->$fieldGetter()->$brickSetter($brick);
   133|                         }
   134|                         if ($brickDescriptor) {
   135|                             $brickDefinition = DataObject\Objectbrick\Definition::getByKey($brickType);
   136|                             /** @var DataObject\ClassDefinition\Data\Localizedfields $fieldDefinitionLocalizedFields */
   137|                             $fieldDefinitionLocalizedFields = $brickDefinition->getFieldDefinition('localizedfields');
   138|                             $fieldDefinition = $fieldDefinitionLocalizedFields->getFieldDefinition($brickKey);
   139|                         } else {
   140|                             $fieldDefinition = $this->getFieldDefinitionFromBrick($brickType, $brickKey);
   141|                         }
   142|                         if ($fieldDefinition && method_exists($fieldDefinition, 'getDataFromGridEditor')) {
   143|                             $value = $fieldDefinition->getDataFromGridEditor($value, $object, []);
   144|                         }
   145|                         if ($brickDescriptor) {
   146|                             /** @var DataObject\Localizedfield $localizedFields */
   147|                             $localizedFields = $brick->getLocalizedfields();
   148|                             $localizedFields->setLocalizedValue($brickKey, $value);
   149|                         } else {
   150|                             $brick->$valueSetter($value);
   151|                         }
   152|                     }
   153|                     $fieldDefinition = $this->getFieldDefinition($class, $key);
   154|                     if ($fieldDefinition && method_exists($fieldDefinition, 'getDataFromGridEditor')) {
   155|                         $value = $fieldDefinition->getDataFromGridEditor($value, $object, []);
   156|                     }
   157|                     $objectData[$key] = $value;
   158|                 }
   159|                 $object->setValues($objectData);
   160|                 try {
   161|                     $object->save();
   162|                     return $this->adminJson(['data' => DataObject\Service::gridObjectData($object, $request->get('fields')), 'success' => true]);
   163|                 } catch (\Exception $e) {
   164|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   165|                 }
   166|             } else {
   167|                 throw new \Exception('Permission denied');
   168|             }
   169|         } else {
   170|             $parentObject = DataObject\Concrete::getById($request->get('objectId'));
   171|             if (empty($parentObject)) {
   172|                 throw new \Exception('No Object found with id ' . $request->get('objectId'));
   173|             }
   174|             if ($parentObject->isAllowed('view')) {
   175|                 $allParams = array_merge($request->request->all(), $request->query->all());
   176|                 $allParams['folderId'] = $parentObject->getId();
   177|                 $allParams['only_direct_children'] = 'true';
   178|                 $allParams['classId'] = $parentObject->getClassId();
   179|                 $list = $gridHelperService->prepareListingForGrid($allParams, $request->getLocale(), $this->getAdminUser());
   180|                 $list->setObjectTypes([DataObject::OBJECT_TYPE_VARIANT]);
   181|                 $list->load();
   182|                 $objects = [];
   183|                 foreach ($list->getObjects() as $object) {
   184|                     if ($object->isAllowed('view')) {
   185|                         $o = DataObject\Service::gridObjectData($object, $request->get('fields'), $requestedLanguage);
   186|                         $objects[] = $o;
   187|                     }
   188|                 }
   189|                 return $this->adminJson(['data' => $objects, 'success' => true, 'total' => $list->getTotalCount()]);
   190|             } else {
   191|                 throw new \Exception('Permission denied');
   192|             }
   193|         }
   194|     }
   195|     /**
   196|      * @param DataObject\ClassDefinition $class
   197|      * @param string $key
   198|      *
   199|      * @return DataObject\ClassDefinition\Data|null
   200|      */
   201|     protected function getFieldDefinition($class, $key)
   202|     {
   203|         $fieldDefinition = $class->getFieldDefinition($key);
   204|         if ($fieldDefinition) {
   205|             return $fieldDefinition;
   206|         }
   207|         $localized = $class->getFieldDefinition('localizedfields');
   208|         if ($localized instanceof DataObject\ClassDefinition\Data\Localizedfields) {
   209|             $fieldDefinition = $localized->getFieldDefinition($key);
   210|         }
   211|         return $fieldDefinition;
   212|     }
   213|     /**
   214|      * @param string $brickType
   215|      * @param string $key
   216|      *
   217|      * @return DataObject\ClassDefinition\Data|null
   218|      */
   219|     protected function getFieldDefinitionFromBrick($brickType, $key)
   220|     {
   221|         $brickDefinition = DataObject\Objectbrick\Definition::getByKey($brickType);
   222|         $fieldDefinition = null;
   223|         if ($brickDefinition) {
   224|             $fieldDefinition = $brickDefinition->getFieldDefinition($key);
   225|         }
   226|         return $fieldDefinition;
   227|     }
   228| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/DocumentController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1294 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Bundle\AdminBundle\Controller\Admin\ElementControllerBase;
    16| use Pimcore\Bundle\AdminBundle\Controller\Traits\DocumentTreeConfigTrait;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Pimcore\Db;
    19| use Pimcore\Event\Admin\ElementAdminStyleEvent;
    20| use Pimcore\Event\AdminEvents;
    21| use Pimcore\Image\HtmlToImage;
    22| use Pimcore\Logger;
    23| use Pimcore\Model\Document;
    24| use Pimcore\Model\Redirect;
    25| use Pimcore\Model\Site;
    26| use Pimcore\Model\Version;
    27| use Pimcore\Routing\Dynamic\DocumentRouteHandler;
    28| use Pimcore\Tool;
    29| use Pimcore\Tool\Frontend;
    30| use Pimcore\Tool\Session;
    31| use Symfony\Component\EventDispatcher\GenericEvent;
    32| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    33| use Symfony\Component\HttpFoundation\JsonResponse;
    34| use Symfony\Component\HttpFoundation\Request;
    35| use Symfony\Component\HttpFoundation\Response;
    36| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    37| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    38| use Symfony\Component\Routing\Annotation\Route;
    39| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    40| /**
    41|  * @Route("/document")
    42|  *
    43|  * @internal
    44|  */
    45| class DocumentController extends ElementControllerBase implements KernelControllerEventInterface
    46| {
    47|     use DocumentTreeConfigTrait;
    48|     /**
    49|      * @var Document\Service
    50|      */
    51|     protected $_documentService;
    52|     /**
    53|      * @Route("/tree-get-root", name="pimcore_admin_document_document_treegetroot", methods={"GET"})
    54|      *
    55|      * @param Request $request
    56|      *
    57|      * @return JsonResponse
    58|      */
    59|     public function treeGetRootAction(Request $request)
    60|     {
    61|         return parent::treeGetRootAction($request);
    62|     }
    63|     /**
    64|      * @Route("/delete-info", name="pimcore_admin_document_document_deleteinfo", methods={"GET"})
    65|      *
    66|      * @param Request $request
    67|      * @param EventDispatcherInterface $eventDispatcher
    68|      *
    69|      * @return JsonResponse
    70|      */
    71|     public function deleteInfoAction(Request $request, EventDispatcherInterface $eventDispatcher)
    72|     {
    73|         return parent::deleteInfoAction($request, $eventDispatcher);
    74|     }
    75|     /**
    76|      * @Route("/get-data-by-id", name="pimcore_admin_document_document_getdatabyid", methods={"GET"})
    77|      *
    78|      * @param Request $request
    79|      *
    80|      * @return JsonResponse
    81|      */
    82|     public function getDataByIdAction(Request $request, EventDispatcherInterface $eventDispatcher)
    83|     {
    84|         $document = Document::getById($request->get('id'));
    85|         if (!$document) {
    86|             throw $this->createNotFoundException('Document not found');
    87|         }
    88|         $document = clone $document;
    89|         $data = $document->getObjectVars();
    90|         $data['versionDate'] = $document->getModificationDate();
    91|         $data['php'] = [
    92|             'classes' => array_merge([get_class($document)], array_values(class_parents($document))),
    93|             'interfaces' => array_values(class_implements($document)),
    94|         ];
    95|         $this->addAdminStyle($document, ElementAdminStyleEvent::CONTEXT_EDITOR, $data);
    96|         $event = new GenericEvent($this, [
    97|             'data' => $data,
    98|             'document' => $document,
    99|         ]);
   100|         $eventDispatcher->dispatch($event, AdminEvents::DOCUMENT_GET_PRE_SEND_DATA);
   101|         $data = $event->getArgument('data');
   102|         if ($document->isAllowed('view')) {
   103|             return $this->adminJson($data);
   104|         }
   105|         throw $this->createAccessDeniedHttpException();
   106|     }
   107|     /**
   108|      * @Route("/tree-get-childs-by-id", name="pimcore_admin_document_document_treegetchildsbyid", methods={"GET"})
   109|      *
   110|      * @param Request $request
   111|      *
   112|      * @return JsonResponse
   113|      */
   114|     public function treeGetChildsByIdAction(Request $request, EventDispatcherInterface $eventDispatcher)
   115|     {
   116|         $allParams = array_merge($request->request->all(), $request->query->all());
   117|         $filter = $request->get('filter');
   118|         $limit = (int)($allParams['limit'] ?? 100000000);
   119|         $offset = (int)($allParams['start'] ?? 0);
   120|         if (!is_null($filter)) {
   121|             if (substr($filter, -1) != '*') {
   122|                 $filter .= '*';
   123|             }
   124|             $filter = str_replace('*', '%', $filter);
   125|             $limit = 100;
   126|             $offset = 0;
   127|         }
   128|         $document = Document::getById($allParams['node']);
   129|         if (!$document) {
   130|             throw $this->createNotFoundException('Document was not found');
   131|         }
   132|         $documents = [];
   133|         $cv = false;
   134|         if ($document->hasChildren()) {
   135|             if ($allParams['view']) {
   136|                 $cv = \Pimcore\Model\Element\Service::getCustomViewById($allParams['view']);
   137|             }
   138|             $db = Db::get();
   139|             $list = new Document\Listing();
   140|             if ($this->getAdminUser()->isAdmin()) {
   141|                 $condition = 'parentId =  ' . $db->quote($document->getId());
   142|             } else {
   143|                 $userIds = $this->getAdminUser()->getRoles();
   144|                 $userIds[] = $this->getAdminUser()->getId();
   145|                 $condition = 'parentId = ' . $db->quote($document->getId()) . ' AND
   146|                 (
   147|                     (SELECT list FROM users_workspaces_document WHERE userId IN (' . implode(',', $userIds) . ') AND LOCATE(CONCAT(path,`key`),cpath)=1  ORDER BY LENGTH(cpath) DESC, FIELD(userId, '. $this->getAdminUser()->getId() .') DESC, list DESC LIMIT 1)=1
   148|                     or
   149|                     (SELECT list FROM users_workspaces_document WHERE userId IN (' . implode(',', $userIds) . ') AND LOCATE(cpath,CONCAT(path,`key`))=1  ORDER BY LENGTH(cpath) DESC, FIELD(userId, '. $this->getAdminUser()->getId() .') DESC, list DESC LIMIT 1)=1
   150|                 )';
   151|             }
   152|             if ($filter) {
   153|                 $condition = '(' . $condition . ')' . ' AND CAST(documents.key AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci LIKE ' . $db->quote($filter);
   154|             }
   155|             $list->setCondition($condition);
   156|             $list->setOrderKey(['index', 'id']);
   157|             $list->setOrder(['asc', 'asc']);
   158|             $list->setLimit($limit);
   159|             $list->setOffset($offset);
   160|             \Pimcore\Model\Element\Service::addTreeFilterJoins($cv, $list);
   161|             $beforeListLoadEvent = new GenericEvent($this, [
   162|                 'list' => $list,
   163|                 'context' => $allParams,
   164|             ]);
   165|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::DOCUMENT_LIST_BEFORE_LIST_LOAD);
   166|             /** @var Document\Listing $list */
   167|             $list = $beforeListLoadEvent->getArgument('list');
   168|             $childsList = $list->load();
   169|             foreach ($childsList as $childDocument) {
   170|                 if ($childDocument->isAllowed('list')) {
   171|                     $documents[] = $this->getTreeNodeConfig($childDocument);
   172|                 }
   173|             }
   174|         }
   175|         $event = new GenericEvent($this, [
   176|             'documents' => $documents,
   177|         ]);
   178|         $eventDispatcher->dispatch($event, AdminEvents::DOCUMENT_TREE_GET_CHILDREN_BY_ID_PRE_SEND_DATA);
   179|         $documents = $event->getArgument('documents');
   180|         if ($allParams['limit']) {
   181|             return $this->adminJson([
   182|                 'offset' => $offset,
   183|                 'limit' => $limit,
   184|                 'total' => $document->getChildAmount($this->getAdminUser()),
   185|                 'nodes' => $documents,
   186|                 'filter' => $request->get('filter') ? $request->get('filter') : '',
   187|                 'inSearch' => (int)$request->get('inSearch'),
   188|             ]);
   189|         } else {
   190|             return $this->adminJson($documents);
   191|         }
   192|     }
   193|     /**
   194|      * @Route("/add", name="pimcore_admin_document_document_add", methods={"POST"})
   195|      *
   196|      * @param Request $request
   197|      *
   198|      * @return JsonResponse
   199|      */
   200|     public function addAction(Request $request)
   201|     {
   202|         $success = false;
   203|         $errorMessage = '';
   204|         $parentDocument = Document::getById((int)$request->get('parentId'));
   205|         $document = null;
   206|         if ($parentDocument->isAllowed('create')) {
   207|             $intendedPath = $parentDocument->getRealFullPath() . '/' . $request->get('key');
   208|             if (!Document\Service::pathExists($intendedPath)) {
   209|                 $createValues = [
   210|                     'userOwner' => $this->getAdminUser()->getId(),
   211|                     'userModification' => $this->getAdminUser()->getId(),
   212|                     'published' => false,
   213|                 ];
   214|                 $createValues['key'] = \Pimcore\Model\Element\Service::getValidKey($request->get('key'), 'document');
   215|                 $docType = Document\DocType::getById((int)$request->get('docTypeId'));
   216|                 if ($docType) {
   217|                     $createValues['template'] = $docType->getTemplate();
   218|                     $createValues['controller'] = $docType->getController();
   219|                 } elseif ($request->get('translationsBaseDocument')) {
   220|                     $translationsBaseDocument = Document::getById($request->get('translationsBaseDocument'));
   221|                     if ($translationsBaseDocument instanceof Document\PageSnippet) {
   222|                         $createValues['template'] = $translationsBaseDocument->getTemplate();
   223|                         $createValues['controller'] = $translationsBaseDocument->getController();
   224|                     }
   225|                 } elseif ($request->get('type') == 'page' || $request->get('type') == 'snippet' || $request->get('type') == 'email') {
   226|                     $createValues['controller'] = $this->getParameter('pimcore.documents.default_controller');
   227|                 } elseif ($request->get('type') == 'printpage') {
   228|                     $createValues['controller'] = $this->getParameter('pimcore.documents.web_to_print.default_controller_print_page');
   229|                 } elseif ($request->get('type') == 'printcontainer') {
   230|                     $createValues['controller'] = $this->getParameter('pimcore.documents.web_to_print.default_controller_print_container');
   231|                 }
   232|                 if ($request->get('inheritanceSource')) {
   233|                     $createValues['contentMasterDocumentId'] = $request->get('inheritanceSource');
   234|                 }
   235|                 switch ($request->get('type')) {
   236|                     case 'page':
   237|                         $document = Document\Page::create($request->get('parentId'), $createValues, false);
   238|                         $document->setTitle($request->get('title', null));
   239|                         $document->setProperty('navigation_name', 'text', $request->get('name', null), false, false);
   240|                         $document->save();
   241|                         $success = true;
   242|                         break;
   243|                     case 'snippet':
   244|                         $document = Document\Snippet::create($request->get('parentId'), $createValues);
   245|                         $success = true;
   246|                         break;
   247|                     case 'email': //ckogler
   248|                         $document = Document\Email::create($request->get('parentId'), $createValues);
   249|                         $success = true;
   250|                         break;
   251|                     case 'link':
   252|                         $document = Document\Link::create($request->get('parentId'), $createValues);
   253|                         $success = true;
   254|                         break;
   255|                     case 'hardlink':
   256|                         $document = Document\Hardlink::create($request->get('parentId'), $createValues);
   257|                         $success = true;
   258|                         break;
   259|                     case 'folder':
   260|                         $document = Document\Folder::create($request->get('parentId'), $createValues);
   261|                         $document->setPublished(true);
   262|                         try {
   263|                             $document->save();
   264|                             $success = true;
   265|                         } catch (\Exception $e) {
   266|                             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   267|                         }
   268|                         break;
   269|                     default:
   270|                         $classname = '\\Pimcore\\Model\\Document\\' . ucfirst($request->get('type'));
   271|                         if (!\Pimcore\Tool::classExists($classname)) {
   272|                             $oldStyleClass = '\\Document_' . ucfirst($request->get('type'));
   273|                             if (\Pimcore\Tool::classExists($oldStyleClass)) {
   274|                                 $classname = $oldStyleClass;
   275|                             }
   276|                         }
   277|                         if (Tool::classExists($classname)) {
   278|                             $document = $classname::create($request->get('parentId'), $createValues);
   279|                             try {
   280|                                 $document->save();
   281|                                 $success = true;
   282|                             } catch (\Exception $e) {
   283|                                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   284|                             }
   285|                             break;
   286|                         } else {
   287|                             Logger::debug("Unknown document type, can't add [ " . $request->get('type') . ' ] ');
   288|                         }
   289|                         break;
   290|                 }
   291|             } else {
   292|                 $errorMessage = "prevented adding a document because document with same path+key [ $intendedPath ] already exists";
   293|                 Logger::debug($errorMessage);
   294|             }
   295|         } else {
   296|             $errorMessage = 'prevented adding a document because of missing permissions';
   297|             Logger::debug($errorMessage);
   298|         }
   299|         if ($success && $document instanceof Document) {
   300|             if ($request->get('translationsBaseDocument')) {
   301|                 $translationsBaseDocument = Document::getById($request->get('translationsBaseDocument'));
   302|                 $properties = $translationsBaseDocument->getProperties();
   303|                 $properties = array_merge($properties, $document->getProperties());
   304|                 $document->setProperties($properties);
   305|                 $document->setProperty('language', 'text', $request->get('language'), false, true);
   306|                 $document->save();
   307|                 $service = new Document\Service();
   308|                 $service->addTranslation($translationsBaseDocument, $document);
   309|             }
   310|             return $this->adminJson([
   311|                 'success' => $success,
   312|                 'id' => $document->getId(),
   313|                 'type' => $document->getType(),
   314|             ]);
   315|         }
   316|         return $this->adminJson([
   317|             'success' => $success,
   318|             'message' => $errorMessage,
   319|         ]);
   320|     }
   321|     /**
   322|      * @Route("/delete", name="pimcore_admin_document_document_delete", methods={"DELETE"})
   323|      *
   324|      * @param Request $request
   325|      *
   326|      * @return JsonResponse
   327|      */
   328|     public function deleteAction(Request $request)
   329|     {
   330|         if ($request->get('type') == 'childs') {
   331|             $parentDocument = Document::getById($request->get('id'));
   332|             $list = new Document\Listing();
   333|             $list->setCondition('path LIKE ?', [$list->escapeLike($parentDocument->getRealFullPath()) . '/%']);
   334|             $list->setLimit((int)$request->get('amount'));
   335|             $list->setOrderKey('LENGTH(path)', false);
   336|             $list->setOrder('DESC');
   337|             $documents = $list->load();
   338|             $deletedItems = [];
   339|             foreach ($documents as $document) {
   340|                 $deletedItems[$document->getId()] = $document->getRealFullPath();
   341|                 if ($document->isAllowed('delete') && !$document->isLocked()) {
   342|                     $document->delete();
   343|                 }
   344|             }
   345|             return $this->adminJson(['success' => true, 'deleted' => $deletedItems]);
   346|         } elseif ($request->get('id')) {
   347|             $document = Document::getById($request->get('id'));
   348|             if ($document && $document->isAllowed('delete')) {
   349|                 try {
   350|                     if ($document->isLocked()) {
   351|                         throw new \Exception('prevented deleting document, because it is locked: ID: ' . $document->getId());
   352|                     }
   353|                     $document->delete();
   354|                     return $this->adminJson(['success' => true]);
   355|                 } catch (\Exception $e) {
   356|                     Logger::err($e);
   357|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   358|                 }
   359|             }
   360|         }
   361|         throw $this->createAccessDeniedHttpException();
   362|     }
   363|     /**
   364|      * @Route("/update", name="pimcore_admin_document_document_update", methods={"PUT"})
   365|      *
   366|      * @param Request $request
   367|      *
   368|      * @return JsonResponse
   369|      *
   370|      * @throws \Exception
   371|      */
   372|     public function updateAction(Request $request)
   373|     {
   374|         $success = false;
   375|         $allowUpdate = true;
   376|         $document = Document::getById($request->get('id'));
   377|         $oldPath = $document->getDao()->getCurrentFullPath();
   378|         $oldDocument = Document::getById($document->getId(), true);
   379|         if ($document instanceof Document\PageSnippet) {
   380|             $latestVersion = $document->getLatestVersion();
   381|             if ($latestVersion && $latestVersion->getData()->getModificationDate() != $document->getModificationDate()) {
   382|                 return $this->adminJson(['success' => false, 'message' => "You can't rename or relocate if there's a newer not published version"]);
   383|             }
   384|         }
   385|         if ($document->isAllowed('settings')) {
   386|             if ($request->get('parentId')) {
   387|                 $parentDocument = Document::getById($request->get('parentId'));
   388|                 if ($document->getParentId() != $parentDocument->getId()) {
   389|                     if (!$parentDocument->isAllowed('create')) {
   390|                         throw new \Exception('Prevented moving document - no create permission on new parent ');
   391|                     }
   392|                     $intendedPath = $parentDocument->getRealPath();
   393|                     $pKey = $parentDocument->getKey();
   394|                     if (!empty($pKey)) {
   395|                         $intendedPath .= $parentDocument->getKey() . '/';
   396|                     }
   397|                     $documentWithSamePath = Document::getByPath($intendedPath . $document->getKey());
   398|                     if ($documentWithSamePath != null) {
   399|                         $allowUpdate = false;
   400|                     }
   401|                     if ($document->isLocked()) {
   402|                         $allowUpdate = false;
   403|                     }
   404|                 }
   405|             }
   406|             if ($allowUpdate) {
   407|                 $blockedVars = ['controller', 'action', 'module'];
   408|                 if (!$document->isAllowed('rename') && $request->get('key')) {
   409|                     $blockedVars[] = 'key';
   410|                     Logger::debug('prevented renaming document because of missing permissions ');
   411|                 }
   412|                 $updateData = array_merge($request->request->all(), $request->query->all());
   413|                 foreach ($updateData as $key => $value) {
   414|                     if (!in_array($key, $blockedVars)) {
   415|                         $document->setValue($key, $value);
   416|                     }
   417|                 }
   418|                 $document->setUserModification($this->getAdminUser()->getId());
   419|                 try {
   420|                     $document->save();
   421|                     if ($request->get('index') !== null) {
   422|                         $this->updateIndexesOfDocumentSiblings($document, $request->get('index'));
   423|                     }
   424|                     $success = true;
   425|                     $this->createRedirectForFormerPath($request, $document, $oldPath, $oldDocument);
   426|                 } catch (\Exception $e) {
   427|                     return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   428|                 }
   429|             } else {
   430|                 $msg = 'Prevented moving document, because document with same path+key already exists or the document is locked. ID: ' . $document->getId();
   431|                 Logger::debug($msg);
   432|                 return $this->adminJson(['success' => false, 'message' => $msg]);
   433|             }
   434|         } elseif ($document->isAllowed('rename') && $request->get('key')) {
   435|             try {
   436|                 $document->setKey($request->get('key'));
   437|                 $document->setUserModification($this->getAdminUser()->getId());
   438|                 $document->save();
   439|                 $success = true;
   440|                 $this->createRedirectForFormerPath($request, $document, $oldPath, $oldDocument);
   441|             } catch (\Exception $e) {
   442|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   443|             }
   444|         } else {
   445|             Logger::debug('Prevented update document, because of missing permissions.');
   446|         }
   447|         return $this->adminJson(['success' => $success]);
   448|     }
   449|     private function createRedirectForFormerPath(Request $request, Document $document, string $oldPath, Document $oldDocument)
   450|     {
   451|         if ($document instanceof Document\Page || $document instanceof Document\Hardlink) {
   452|             if ($request->get('create_redirects') === 'true' && $this->getAdminUser()->isAllowed('redirects')) {
   453|                 if ($oldPath && $oldPath != $document->getRealFullPath()) {
   454|                     $sourceSite = Frontend::getSiteForDocument($oldDocument);
   455|                     if ($sourceSite) {
   456|                         $oldPath = preg_replace('@^' . preg_quote($sourceSite->getRootPath(), '@') . '@', '', $oldPath);
   457|                     }
   458|                     $targetSite = Frontend::getSiteForDocument($document);
   459|                     $this->doCreateRedirectForFormerPath($oldPath, $document->getId(), $sourceSite, $targetSite);
   460|                     if ($document->hasChildren()) {
   461|                         $list = new Document\Listing();
   462|                         $list->setCondition('path LIKE :path', [
   463|                             'path' => $list->escapeLike($document->getRealFullPath()) . '/%',
   464|                         ]);
   465|                         $childrenList = $list->loadIdPathList();
   466|                         $count = 0;
   467|                         foreach ($childrenList as $child) {
   468|                             $source = preg_replace('@^' . preg_quote($document->getRealFullPath(), '@') . '@', $oldDocument, $child['path']);
   469|                             if ($sourceSite) {
   470|                                 $source = preg_replace('@^' . preg_quote($sourceSite->getRootPath(), '@') . '@', '', $source);
   471|                             }
   472|                             $target = $child['id'];
   473|                             $this->doCreateRedirectForFormerPath($source, $target, $sourceSite, $targetSite);
   474|                             $count++;
   475|                             if ($count % 10 === 0) {
   476|                                 \Pimcore::collectGarbage();
   477|                             }
   478|                         }
   479|                     }
   480|                 }
   481|             }
   482|         }
   483|     }
   484|     private function doCreateRedirectForFormerPath(string $source, int $targetId, ?Site $sourceSite, ?Site $targetSite)
   485|     {
   486|         $redirect = new Redirect();
   487|         $redirect->setType(Redirect::TYPE_AUTO_CREATE);
   488|         $redirect->setRegex(false);
   489|         $redirect->setTarget($targetId);
   490|         $redirect->setSource($source);
   491|         $redirect->setStatusCode(301);
   492|         $redirect->setExpiry(time() + 86400 * 365); // this entry is removed automatically after 1 year
   493|         if ($sourceSite) {
   494|             $redirect->setSourceSite($sourceSite->getId());
   495|         }
   496|         if ($targetSite) {
   497|             $redirect->setTargetSite($targetSite->getId());
   498|         }
   499|         $redirect->save();
   500|     }
   501|     /**
   502|      * @param Document $document
   503|      * @param int $newIndex
   504|      */
   505|     protected function updateIndexesOfDocumentSiblings(Document $document, $newIndex)
   506|     {
   507|         $updateLatestVersionIndex = function ($document, $newIndex) {
   508|             if ($document instanceof Document\PageSnippet && $latestVersion = $document->getLatestVersion()) {
   509|                 $document = $latestVersion->loadData();
   510|                 $document->setIndex($newIndex);
   511|                 $latestVersion->save();
   512|             }
   513|         };
   514|         $newIndex = (int)$newIndex;
   515|         $document->saveIndex($newIndex);
   516|         $list = new Document\Listing();
   517|         $list->setCondition('parentId = ? AND id != ?', [$document->getParentId(), $document->getId()]);
   518|         $list->setOrderKey('index');
   519|         $list->setOrder('asc');
   520|         $childsList = $list->load();
   521|         $count = 0;
   522|         foreach ($childsList as $child) {
   523|             if ($count == $newIndex) {
   524|                 $count++;
   525|             }
   526|             $child->saveIndex($count);
   527|             $updateLatestVersionIndex($child, $count);
   528|             $count++;
   529|         }
   530|     }
   531|     /**
   532|      * @Route("/doc-types", name="pimcore_admin_document_document_doctypesget", methods={"GET"})
   533|      *
   534|      * @param Request $request
   535|      *
   536|      * @return JsonResponse
   537|      */
   538|     public function docTypesGetAction(Request $request)
   539|     {
   540|         $list = new Document\DocType\Listing();
   541|         $list->load();
   542|         $docTypes = [];
   543|         foreach ($list->getDocTypes() as $type) {
   544|             if ($this->getAdminUser()->isAllowed($type->getId(), 'docType')) {
   545|                 $docTypes[] = $type->getObjectVars();
   546|             }
   547|         }
   548|         return $this->adminJson(['data' => $docTypes, 'success' => true, 'total' => count($docTypes)]);
   549|     }
   550|     /**
   551|      * @Route("/doc-types", name="pimcore_admin_document_document_doctypes", methods={"PUT", "POST","DELETE"})
   552|      *
   553|      * @param Request $request
   554|      *
   555|      * @return JsonResponse
   556|      */
   557|     public function docTypesAction(Request $request)
   558|     {
   559|         if ($request->get('data')) {
   560|             $this->checkPermission('document_types');
   561|             if ($request->get('xaction') == 'destroy') {
   562|                 $data = $this->decodeJson($request->get('data'));
   563|                 $id = $data['id'];
   564|                 $type = Document\DocType::getById($id);
   565|                 $type->delete();
   566|                 return $this->adminJson(['success' => true, 'data' => []]);
   567|             } elseif ($request->get('xaction') == 'update') {
   568|                 $data = $this->decodeJson($request->get('data'));
   569|                 $type = Document\DocType::getById($data['id']);
   570|                 $type->setValues($data);
   571|                 $type->save();
   572|                 return $this->adminJson(['data' => $type->getObjectVars(), 'success' => true]);
   573|             } elseif ($request->get('xaction') == 'create') {
   574|                 $data = $this->decodeJson($request->get('data'));
   575|                 unset($data['id']);
   576|                 $type = Document\DocType::create();
   577|                 $type->setValues($data);
   578|                 $type->save();
   579|                 return $this->adminJson(['data' => $type->getObjectVars(), 'success' => true]);
   580|             }
   581|         }
   582|         return $this->adminJson(false);
   583|     }
   584|     /**
   585|      * @Route("/get-doc-types", name="pimcore_admin_document_document_getdoctypes", methods={"GET"})
   586|      *
   587|      * @param Request $request
   588|      *
   589|      * @return JsonResponse
   590|      */
   591|     public function getDocTypesAction(Request $request)
   592|     {
   593|         $list = new Document\DocType\Listing();
   594|         if ($request->get('type')) {
   595|             $type = $request->get('type');
   596|             if (Document\Service::isValidType($type)) {
   597|                 $list->setFilter(function ($row) use ($type) {
   598|                     if ($row['type'] == $type) {
   599|                         return true;
   600|                     }
   601|                     return false;
   602|                 });
   603|             }
   604|         }
   605|         $list->load();
   606|         $docTypes = [];
   607|         foreach ($list->getDocTypes() as $type) {
   608|             $docTypes[] = $type->getObjectVars();
   609|         }
   610|         return $this->adminJson(['docTypes' => $docTypes]);
   611|     }
   612|     /**
   613|      * @Route("/version-to-session", name="pimcore_admin_document_document_versiontosession", methods={"POST"})
   614|      *
   615|      * @param Request $request
   616|      *
   617|      * @return Response
   618|      */
   619|     public function versionToSessionAction(Request $request)
   620|     {
   621|         $version = Version::getById($request->get('id'));
   622|         $document = $version->loadData();
   623|         Document\Service::saveElementToSession($document);
   624|         return new Response();
   625|     }
   626|     /**
   627|      * @Route("/publish-version", name="pimcore_admin_document_document_publishversion", methods={"POST"})
   628|      *
   629|      * @param Request $request
   630|      *
   631|      * @return JsonResponse
   632|      */
   633|     public function publishVersionAction(Request $request)
   634|     {
   635|         $this->versionToSessionAction($request);
   636|         $version = Version::getById($request->get('id'));
   637|         $document = $version->loadData();
   638|         $currentDocument = Document::getById($document->getId());
   639|         if ($currentDocument->isAllowed('publish')) {
   640|             $document->setPublished(true);
   641|             try {
   642|                 $document->setKey($currentDocument->getKey());
   643|                 $document->setPath($currentDocument->getRealPath());
   644|                 $document->setUserModification($this->getAdminUser()->getId());
   645|                 $document->save();
   646|             } catch (\Exception $e) {
   647|                 return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   648|             }
   649|         }
   650|         $this->addAdminStyle($document, ElementAdminStyleEvent::CONTEXT_EDITOR, $treeData);
   651|         return $this->adminJson(['success' => true, 'treeData' => $treeData]);
   652|     }
   653|     /**
   654|      * @Route("/update-site", name="pimcore_admin_document_document_updatesite", methods={"PUT"})
   655|      *
   656|      * @param Request $request
   657|      *
   658|      * @return JsonResponse
   659|      */
   660|     public function updateSiteAction(Request $request)
   661|     {
   662|         $domains = $request->get('domains');
   663|         $domains = str_replace(' ', '', $domains);
   664|         $domains = explode("\n", $domains);
   665|         if (!$site = Site::getByRootId((int)$request->get('id'))) {
   666|             $site = Site::create([
   667|                 'rootId' => (int)$request->get('id'),
   668|             ]);
   669|         }
   670|         $site->setDomains($domains);
   671|         $site->setMainDomain($request->get('mainDomain'));
   672|         $site->setErrorDocument($request->get('errorDocument'));
   673|         $site->setRedirectToMainDomain(($request->get('redirectToMainDomain') == 'true') ? true : false);
   674|         $site->save();
   675|         $site->setRootDocument(null); // do not send the document to the frontend
   676|         return $this->adminJson($site->getObjectVars());
   677|     }
   678|     /**
   679|      * @Route("/remove-site", name="pimcore_admin_document_document_removesite", methods={"DELETE"})
   680|      *
   681|      * @param Request $request
   682|      *
   683|      * @return JsonResponse
   684|      */
   685|     public function removeSiteAction(Request $request)
   686|     {
   687|         $site = Site::getByRootId((int)$request->get('id'));
   688|         $site->delete();
   689|         return $this->adminJson(['success' => true]);
   690|     }
   691|     /**
   692|      * @Route("/copy-info", name="pimcore_admin_document_document_copyinfo", methods={"GET"})
   693|      *
   694|      * @param Request $request
   695|      *
   696|      * @return JsonResponse
   697|      */
   698|     public function copyInfoAction(Request $request)
   699|     {
   700|         $transactionId = time();
   701|         $pasteJobs = [];
   702|         Session::useSession(function (AttributeBagInterface $session) use ($transactionId) {
   703|             $session->set($transactionId, ['idMapping' => []]);
   704|         }, 'pimcore_copy');
   705|         if ($request->get('type') == 'recursive' || $request->get('type') == 'recursive-update-references') {
   706|             $document = Document::getById($request->get('sourceId'));
   707|             $pasteJobs[] = [[
   708|                 'url' => $this->generateUrl('pimcore_admin_document_document_copy'),
   709|                 'method' => 'POST',
   710|                 'params' => [
   711|                     'sourceId' => $request->get('sourceId'),
   712|                     'targetId' => $request->get('targetId'),
   713|                     'type' => 'child',
   714|                     'language' => $request->get('language'),
   715|                     'enableInheritance' => $request->get('enableInheritance'),
   716|                     'transactionId' => $transactionId,
   717|                     'saveParentId' => true,
   718|                     'resetIndex' => true,
   719|                 ],
   720|             ]];
   721|             $childIds = [];
   722|             if ($document->hasChildren()) {
   723|                 $list = new Document\Listing();
   724|                 $list->setCondition('path LIKE ?', [$list->escapeLike($document->getRealFullPath()) . '/%']);
   725|                 $list->setOrderKey('LENGTH(path)', false);
   726|                 $list->setOrder('ASC');
   727|                 $childIds = $list->loadIdList();
   728|                 if (count($childIds) > 0) {
   729|                     foreach ($childIds as $id) {
   730|                         $pasteJobs[] = [[
   731|                             'url' => $this->generateUrl('pimcore_admin_document_document_copy'),
   732|                             'method' => 'POST',
   733|                             'params' => [
   734|                                 'sourceId' => $id,
   735|                                 'targetParentId' => $request->get('targetId'),
   736|                                 'sourceParentId' => $request->get('sourceId'),
   737|                                 'type' => 'child',
   738|                                 'language' => $request->get('language'),
   739|                                 'enableInheritance' => $request->get('enableInheritance'),
   740|                                 'transactionId' => $transactionId,
   741|                             ],
   742|                         ]];
   743|                     }
   744|                 }
   745|             }
   746|             if ($request->get('type') == 'recursive-update-references') {
   747|                 for ($i = 0; $i < (count($childIds) + 1); $i++) {
   748|                     $pasteJobs[] = [[
   749|                         'url' => $this->generateUrl('pimcore_admin_document_document_copyrewriteids'),
   750|                         'method' => 'PUT',
   751|                         'params' => [
   752|                             'transactionId' => $transactionId,
   753|                             'enableInheritance' => $request->get('enableInheritance'),
   754|                             '_dc' => uniqid(),
   755|                         ],
   756|                     ]];
   757|                 }
   758|             }
   759|         } elseif ($request->get('type') == 'child' || $request->get('type') == 'replace') {
   760|             $pasteJobs[] = [[
   761|                 'url' => $this->generateUrl('pimcore_admin_document_document_copy'),
   762|                 'method' => 'POST',
   763|                 'params' => [
   764|                     'sourceId' => $request->get('sourceId'),
   765|                     'targetId' => $request->get('targetId'),
   766|                     'type' => $request->get('type'),
   767|                     'language' => $request->get('language'),
   768|                     'enableInheritance' => $request->get('enableInheritance'),
   769|                     'transactionId' => $transactionId,
   770|                     'resetIndex' => ($request->get('type') == 'child'),
   771|                 ],
   772|             ]];
   773|         }
   774|         return $this->adminJson([
   775|             'pastejobs' => $pasteJobs,
   776|         ]);
   777|     }
   778|     /**
   779|      * @Route("/copy-rewrite-ids", name="pimcore_admin_document_document_copyrewriteids", methods={"PUT"})
   780|      *
   781|      * @param Request $request
   782|      *
   783|      * @return JsonResponse
   784|      */
   785|     public function copyRewriteIdsAction(Request $request)
   786|     {
   787|         $transactionId = $request->get('transactionId');
   788|         $idStore = Session::useSession(function (AttributeBagInterface $session) use ($transactionId) {
   789|             return $session->get($transactionId);
   790|         }, 'pimcore_copy');
   791|         if (!array_key_exists('rewrite-stack', $idStore)) {
   792|             $idStore['rewrite-stack'] = array_values($idStore['idMapping']);
   793|         }
   794|         $id = array_shift($idStore['rewrite-stack']);
   795|         $document = Document::getById($id);
   796|         if ($document) {
   797|             $rewriteConfig = ['document' => $idStore['idMapping']];
   798|             $document = Document\Service::rewriteIds($document, $rewriteConfig, [
   799|                 'enableInheritance' => ($request->get('enableInheritance') == 'true') ? true : false,
   800|             ]);
   801|             $document->setUserModification($this->getAdminUser()->getId());
   802|             $document->save();
   803|         }
   804|         Session::useSession(function (AttributeBagInterface $session) use ($transactionId, $idStore) {
   805|             $session->set($transactionId, $idStore);
   806|         }, 'pimcore_copy');
   807|         return $this->adminJson([
   808|             'success' => true,
   809|             'id' => $id,
   810|         ]);
   811|     }
   812|     /**
   813|      * @Route("/copy", name="pimcore_admin_document_document_copy", methods={"POST"})
   814|      *
   815|      * @param Request $request
   816|      *
   817|      * @return JsonResponse
   818|      */
   819|     public function copyAction(Request $request)
   820|     {
   821|         $success = false;
   822|         $sourceId = (int)$request->get('sourceId');
   823|         $source = Document::getById($sourceId);
   824|         $session = Session::get('pimcore_copy');
   825|         $targetId = (int)$request->get('targetId');
   826|         $sessionBag = $session->get($request->get('transactionId'));
   827|         if ($request->get('targetParentId')) {
   828|             $sourceParent = Document::getById($request->get('sourceParentId'));
   829|             if ($sessionBag['parentId']) {
   830|                 $targetParent = Document::getById($sessionBag['parentId']);
   831|             } else {
   832|                 $targetParent = Document::getById($request->get('targetParentId'));
   833|             }
   834|             $targetPath = preg_replace('@^' . $sourceParent->getRealFullPath() . '@', $targetParent . '/', $source->getRealPath());
   835|             $target = Document::getByPath($targetPath);
   836|         } else {
   837|             $target = Document::getById($targetId);
   838|         }
   839|         if ($target instanceof Document) {
   840|             if ($target->isAllowed('create')) {
   841|                 if ($source != null) {
   842|                     if ($source instanceof Document\PageSnippet && $latestVersion = $source->getLatestVersion()) {
   843|                         $source = $latestVersion->loadData();
   844|                         $source->setPublished(false); //as latest version is used which is not published
   845|                     }
   846|                     if ($request->get('type') == 'child') {
   847|                         $enableInheritance = ($request->get('enableInheritance') == 'true') ? true : false;
   848|                         $language = false;
   849|                         if (Tool::isValidLanguage($request->get('language'))) {
   850|                             $language = $request->get('language');
   851|                         }
   852|                         $resetIndex = ($request->get('resetIndex') == 'true') ? true : false;
   853|                         $newDocument = $this->_documentService->copyAsChild($target, $source, $enableInheritance, $resetIndex, $language);
   854|                         $sessionBag['idMapping'][(int)$source->getId()] = (int)$newDocument->getId();
   855|                         if ($request->get('saveParentId')) {
   856|                             $sessionBag['parentId'] = $newDocument->getId();
   857|                         }
   858|                         $session->set($request->get('transactionId'), $sessionBag);
   859|                         Session::writeClose();
   860|                     } elseif ($request->get('type') == 'replace') {
   861|                         $this->_documentService->copyContents($target, $source);
   862|                     }
   863|                     $success = true;
   864|                 } else {
   865|                     Logger::error('prevended copy/paste because document with same path+key already exists in this location');
   866|                 }
   867|             } else {
   868|                 Logger::error('could not execute copy/paste because of missing permissions on target [ ' . $targetId . ' ]');
   869|                 throw $this->createAccessDeniedHttpException();
   870|             }
   871|         }
   872|         return $this->adminJson(['success' => $success]);
   873|     }
   874|     /**
   875|      * @Route("/diff-versions/from/{from}/to/{to}", name="pimcore_admin_document_document_diffversions", requirements={"from": "\d+", "to": "\d+"}, methods={"GET"})
   876|      *
   877|      * @param Request $request
   878|      * @param int $from
   879|      * @param int $to
   880|      *
   881|      * @return Response
   882|      */
   883|     public function diffVersionsAction(Request $request, $from, $to)
   884|     {
   885|         if (!HtmlToImage::isSupported() || !class_exists('Imagick')) {
   886|             return $this->render('@PimcoreAdmin/Admin/Document/Document/diff-versions-unsupported.html.twig');
   887|         }
   888|         $versionFrom = Version::getById($from);
   889|         $docFrom = $versionFrom->loadData();
   890|         $prefix = $request->getSchemeAndHttpHost() . $docFrom->getRealFullPath() . '?pimcore_version=';
   891|         $fromUrl = $prefix . $from;
   892|         $toUrl = $prefix . $to;
   893|         $toFileId = uniqid();
   894|         $fromFileId = uniqid();
   895|         $diffFileId = uniqid();
   896|         $fromFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/version-diff-tmp-' . $fromFileId . '.png';
   897|         $toFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/version-diff-tmp-' . $toFileId . '.png';
   898|         $diffFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/version-diff-tmp-' . $diffFileId . '.png';
   899|         $viewParams = [];
   900|         HtmlToImage::convert($fromUrl, $fromFile);
   901|         HtmlToImage::convert($toUrl, $toFile);
   902|         $image1 = new \Imagick($fromFile);
   903|         $image2 = new \Imagick($toFile);
   904|         if ($image1->getImageWidth() == $image2->getImageWidth() && $image1->getImageHeight() == $image2->getImageHeight()) {
   905|             $result = $image1->compareImages($image2, \Imagick::METRIC_MEANSQUAREERROR);
   906|             $result[0]->setImageFormat('png');
   907|             $result[0]->writeImage($diffFile);
   908|             $result[0]->clear();
   909|             $result[0]->destroy();
   910|             $viewParams['image'] = $diffFileId;
   911|         } else {
   912|             $viewParams['image1'] = $fromFileId;
   913|             $viewParams['image2'] = $toFileId;
   914|         }
   915|         $image1->clear();
   916|         $image1->destroy();
   917|         $image2->clear();
   918|         $image2->destroy();
   919|         return $this->render('@PimcoreAdmin/Admin/Document/Document/diff-versions.html.twig', $viewParams);
   920|     }
   921|     /**
   922|      * @Route("/diff-versions-image", name="pimcore_admin_document_document_diffversionsimage", methods={"GET"})
   923|      *
   924|      * @param Request $request
   925|      *
   926|      * @return BinaryFileResponse
   927|      */
   928|     public function diffVersionsImageAction(Request $request)
   929|     {
   930|         $file = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/version-diff-tmp-' . $request->get('id') . '.png';
   931|         if (file_exists($file)) {
   932|             $response = new BinaryFileResponse($file);
   933|             $response->headers->set('Content-Type', 'image/png');
   934|             return $response;
   935|         }
   936|         throw $this->createNotFoundException('Version diff file not found');
   937|     }
   938|     /**
   939|      * @Route("/get-id-for-path", name="pimcore_admin_document_document_getidforpath", methods={"GET"})
   940|      *
   941|      * @param Request $request
   942|      *
   943|      * @return JsonResponse
   944|      */
   945|     public function getIdForPathAction(Request $request)
   946|     {
   947|         if ($doc = Document::getByPath($request->get('path'))) {
   948|             return $this->adminJson([
   949|                 'id' => $doc->getId(),
   950|                 'type' => $doc->getType(),
   951|             ]);
   952|         } else {
   953|             return $this->adminJson(false);
   954|         }
   955|     }
   956|     /**
   957|      * SEO PANEL
   958|      */
   959|     /**
   960|      * @Route("/seopanel-tree-root", name="pimcore_admin_document_document_seopaneltreeroot", methods={"GET"})
   961|      *
   962|      * @param DocumentRouteHandler $documentRouteHandler
   963|      *
   964|      * @return JsonResponse
   965|      */
   966|     public function seopanelTreeRootAction(DocumentRouteHandler $documentRouteHandler)
   967|     {
   968|         $this->checkPermission('seo_document_editor');
   969|         /** @var Document\Page $root */
   970|         $root = Document\Page::getById(1);
   971|         if ($root->isAllowed('list')) {
   972|             $documentRouteHandler->setForceHandleUnpublishedDocuments(true);
   973|             $nodeConfig = $this->getSeoNodeConfig($root);
   974|             return $this->adminJson($nodeConfig);
   975|         }
   976|         throw $this->createAccessDeniedHttpException();
   977|     }
   978|     /**
   979|      * @Route("/seopanel-tree", name="pimcore_admin_document_document_seopaneltree", methods={"GET"})
   980|      *
   981|      * @param Request $request
   982|      * @param EventDispatcherInterface $eventDispatcher
   983|      * @param DocumentRouteHandler $documentRouteHandler
   984|      *
   985|      * @return JsonResponse
   986|      */
   987|     public function seopanelTreeAction(
   988|         Request $request,
   989|         EventDispatcherInterface $eventDispatcher,
   990|         DocumentRouteHandler $documentRouteHandler
   991|     ) {
   992|         $allParams = array_merge($request->request->all(), $request->query->all());
   993|         $filterPrepareEvent = new GenericEvent($this, [
   994|             'requestParams' => $allParams,
   995|         ]);
   996|         $eventDispatcher->dispatch($filterPrepareEvent, AdminEvents::DOCUMENT_LIST_BEFORE_FILTER_PREPARE);
   997|         $allParams = $filterPrepareEvent->getArgument('requestParams');
   998|         $this->checkPermission('seo_document_editor');
   999|         $documentRouteHandler->setForceHandleUnpublishedDocuments(true);
  1000|         $document = Document::getById($allParams['node']);
  1001|         $documents = [];
  1002|         if ($document->hasChildren()) {
  1003|             $list = new Document\Listing();
  1004|             $list->setCondition('parentId = ?', $document->getId());
  1005|             $list->setOrderKey('index');
  1006|             $list->setOrder('asc');
  1007|             $beforeListLoadEvent = new GenericEvent($this, [
  1008|                 'list' => $list,
  1009|                 'context' => $allParams,
  1010|             ]);
  1011|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::DOCUMENT_LIST_BEFORE_LIST_LOAD);
  1012|             /** @var Document\Listing $list */
  1013|             $list = $beforeListLoadEvent->getArgument('list');
  1014|             $childsList = $list->load();
  1015|             foreach ($childsList as $childDocument) {
  1016|                 if ($childDocument->isAllowed('list')) {
  1017|                     $list = new Document\Listing();
  1018|                     $list->setCondition('path LIKE ? and type = ?', [$list->escapeLike($childDocument->getRealFullPath()). '/%', 'page']);
  1019|                     if ($childDocument instanceof Document\Page || $list->getTotalCount() > 0) {
  1020|                         $documents[] = $this->getSeoNodeConfig($childDocument);
  1021|                     }
  1022|                 }
  1023|             }
  1024|         }
  1025|         $result = ['data' => $documents, 'success' => true, 'total' => count($documents)];
  1026|         $afterListLoadEvent = new GenericEvent($this, [
  1027|             'list' => $result,
  1028|             'context' => $allParams,
  1029|         ]);
  1030|         $eventDispatcher->dispatch($afterListLoadEvent, AdminEvents::DOCUMENT_LIST_AFTER_LIST_LOAD);
  1031|         $result = $afterListLoadEvent->getArgument('list');
  1032|         return $this->adminJson($result['data']);
  1033|     }
  1034|     /**
  1035|      * @Route("/language-tree", name="pimcore_admin_document_document_languagetree", methods={"GET"})
  1036|      *
  1037|      * @param Request $request
  1038|      *
  1039|      * @return JsonResponse
  1040|      */
  1041|     public function languageTreeAction(Request $request)
  1042|     {
  1043|         $document = Document::getById($request->query->get('node'));
  1044|         $service = new Document\Service();
  1045|         $languages = explode(',', $request->get('languages'));
  1046|         $result = [];
  1047|         foreach ($document->getChildren() as $child) {
  1048|             $result[] = $this->getTranslationTreeNodeConfig($child, $languages);
  1049|         }
  1050|         return $this->adminJson($result);
  1051|     }
  1052|     /**
  1053|      * @Route("/language-tree-root", name="pimcore_admin_document_document_languagetreeroot", methods={"GET"})
  1054|      *
  1055|      * @param Request $request
  1056|      *
  1057|      * @return JsonResponse
  1058|      *
  1059|      * @throws \Exception
  1060|      */
  1061|     public function languageTreeRootAction(Request $request)
  1062|     {
  1063|         $document = Document::getById($request->query->get('id'));
  1064|         if (!$document) {
  1065|             return $this->adminJson([
  1066|                 'success' => false,
  1067|             ]);
  1068|         }
  1069|         $service = new Document\Service();
  1070|         $locales = Tool::getSupportedLocales();
  1071|         $lang = $document->getProperty('language');
  1072|         $columns = [
  1073|             [
  1074|                 'xtype' => 'treecolumn',
  1075|                 'text' => $lang ? $locales[$lang] : '',
  1076|                 'dataIndex' => 'text',
  1077|                 'cls' => $lang ? 'x-column-header_' . strtolower($lang) : null,
  1078|                 'width' => 300,
  1079|                 'sortable' => false,
  1080|             ],
  1081|         ];
  1082|         $translations = $service->getTranslations($document);
  1083|         $combinedTranslations = $translations;
  1084|         if ($parentDocument = $document->getParent()) {
  1085|             $parentTranslations = $service->getTranslations($parentDocument);
  1086|             foreach ($parentTranslations as $language => $languageDocumentId) {
  1087|                 $combinedTranslations[$language] = $translations[$language] ?? $languageDocumentId;
  1088|             }
  1089|         }
  1090|         foreach ($combinedTranslations as $language => $languageDocumentId) {
  1091|             $languageDocument = Document::getById($languageDocumentId);
  1092|             if ($languageDocument && $languageDocument->isAllowed('list') && $language != $document->getProperty('language')) {
  1093|                 $columns[] = [
  1094|                     'text' => $locales[$language],
  1095|                     'dataIndex' => $language,
  1096|                     'cls' => 'x-column-header_' . strtolower($language),
  1097|                     'width' => 300,
  1098|                     'sortable' => false,
  1099|                 ];
  1100|             }
  1101|         }
  1102|         return $this->adminJson([
  1103|             'root' => $this->getTranslationTreeNodeConfig($document, array_keys($translations), $translations),
  1104|             'columns' => $columns,
  1105|             'languages' => array_keys($translations),
  1106|         ]);
  1107|     }
  1108|     private function getTranslationTreeNodeConfig($document, array $languages, array $translations = null)
  1109|     {
  1110|         $service = new Document\Service();
  1111|         $config = $this->getTreeNodeConfig($document);
  1112|         $translations = is_null($translations) ? $service->getTranslations($document) : $translations;
  1113|         foreach ($languages as $language) {
  1114|             if ($languageDocument = $translations[$language] ?? false) {
  1115|                 $languageDocument = Document::getById($languageDocument);
  1116|                 $config[$language] = [
  1117|                     'text' => $languageDocument->getKey(),
  1118|                     'id' => $languageDocument->getId(),
  1119|                     'type' => $languageDocument->getType(),
  1120|                     'fullPath' => $languageDocument->getFullPath(),
  1121|                     'published' => $languageDocument->getPublished(),
  1122|                     'itemType' => 'document',
  1123|                     'permissions' => $languageDocument->getUserPermissions(),
  1124|                 ];
  1125|             } elseif (!$document instanceof Document\Folder) {
  1126|                 $config[$language] = [
  1127|                     'text' => '--',
  1128|                     'itemType' => 'empty',
  1129|                 ];
  1130|             }
  1131|         }
  1132|         return $config;
  1133|     }
  1134|     /**
  1135|      * @Route("/convert", name="pimcore_admin_document_document_convert", methods={"PUT"})
  1136|      *
  1137|      * @param Request $request
  1138|      *
  1139|      * @return JsonResponse
  1140|      */
  1141|     public function convertAction(Request $request)
  1142|     {
  1143|         $document = Document::getById($request->get('id'));
  1144|         $type = $request->get('type');
  1145|         $class = '\\Pimcore\\Model\\Document\\' . ucfirst($type);
  1146|         if (Tool::classExists($class)) {
  1147|             $new = new $class;
  1148|             \Pimcore\Cache\Runtime::set('document_' . $document->getId(), $new);
  1149|             $props = $document->getObjectVars();
  1150|             foreach ($props as $name => $value) {
  1151|                 $new->setValue($name, $value);
  1152|             }
  1153|             if ($type == 'hardlink' || $type == 'folder') {
  1154|                 foreach (['name', 'title', 'target', 'exclude', 'class', 'anchor', 'parameters', 'relation', 'accesskey', 'tabindex'] as $propertyName) {
  1155|                     $new->removeProperty('navigation_' . $propertyName);
  1156|                 }
  1157|             }
  1158|             $new->setType($type);
  1159|             $new->save();
  1160|         }
  1161|         return $this->adminJson(['success' => true]);
  1162|     }
  1163|     /**
  1164|      * @Route("/translation-determine-parent", name="pimcore_admin_document_document_translationdetermineparent", methods={"GET"})
  1165|      *
  1166|      * @param Request $request
  1167|      *
  1168|      * @return JsonResponse
  1169|      */
  1170|     public function translationDetermineParentAction(Request $request)
  1171|     {
  1172|         $success = false;
  1173|         $targetDocument = null;
  1174|         $document = Document::getById($request->get('id'));
  1175|         if ($document) {
  1176|             $service = new Document\Service;
  1177|             $document = $document->getId() === 1 ? $document : $document->getParent();
  1178|             $translations = $service->getTranslations($document);
  1179|             if (isset($translations[$request->get('language')])) {
  1180|                 $targetDocument = Document::getById($translations[$request->get('language')]);
  1181|                 $success = true;
  1182|             }
  1183|         }
  1184|         return $this->adminJson([
  1185|             'success' => $success,
  1186|             'targetPath' => $targetDocument ? $targetDocument->getRealFullPath() : null,
  1187|             'targetId' => $targetDocument ? $targetDocument->getid() : null,
  1188|         ]);
  1189|     }
  1190|     /**
  1191|      * @Route("/translation-add", name="pimcore_admin_document_document_translationadd", methods={"POST"})
  1192|      *
  1193|      * @param Request $request
  1194|      *
  1195|      * @return JsonResponse
  1196|      */
  1197|     public function translationAddAction(Request $request)
  1198|     {
  1199|         $sourceDocument = Document::getById($request->get('sourceId'));
  1200|         $targetDocument = Document::getByPath($request->get('targetPath'));
  1201|         if ($sourceDocument && $targetDocument) {
  1202|             if (empty($sourceDocument->getProperty('language'))) {
  1203|                 throw new \Exception(sprintf('Source Document(ID:%s) Language(Properties) missing', $sourceDocument->getId()));
  1204|             }
  1205|             if (empty($targetDocument->getProperty('language'))) {
  1206|                 throw new \Exception(sprintf('Target Document(ID:%s) Language(Properties) missing', $sourceDocument->getId()));
  1207|             }
  1208|             $service = new Document\Service;
  1209|             if ($service->getTranslationSourceId($targetDocument) != $targetDocument->getId()) {
  1210|                 throw new \Exception('Target Document already linked to Source Document ID('.$service->getTranslationSourceId($targetDocument).'). Please unlink existing relation first.');
  1211|             }
  1212|             $service->addTranslation($sourceDocument, $targetDocument);
  1213|         }
  1214|         return $this->adminJson([
  1215|             'success' => true,
  1216|         ]);
  1217|     }
  1218|     /**
  1219|      * @Route("/translation-remove", name="pimcore_admin_document_document_translationremove", methods={"DELETE"})
  1220|      *
  1221|      * @param Request $request
  1222|      *
  1223|      * @return JsonResponse
  1224|      */
  1225|     public function translationRemoveAction(Request $request)
  1226|     {
  1227|         $sourceDocument = Document::getById($request->get('sourceId'));
  1228|         $targetDocument = Document::getById($request->get('targetId'));
  1229|         if ($sourceDocument && $targetDocument) {
  1230|             $service = new Document\Service;
  1231|             $service->removeTranslationLink($sourceDocument, $targetDocument);
  1232|         }
  1233|         return $this->adminJson([
  1234|             'success' => true,
  1235|         ]);
  1236|     }
  1237|     /**
  1238|      * @Route("/translation-check-language", name="pimcore_admin_document_document_translationchecklanguage", methods={"GET"})
  1239|      *
  1240|      * @param Request $request
  1241|      *
  1242|      * @return JsonResponse
  1243|      */
  1244|     public function translationCheckLanguageAction(Request $request)
  1245|     {
  1246|         $success = false;
  1247|         $language = null;
  1248|         $translationLinks = null;
  1249|         $document = Document::getByPath($request->get('path'));
  1250|         if ($document) {
  1251|             $language = $document->getProperty('language');
  1252|             if ($language) {
  1253|                 $success = true;
  1254|             }
  1255|             $translationLinks = array_keys($this->_documentService->getTranslations($document));
  1256|         }
  1257|         return $this->adminJson([
  1258|             'success' => $success,
  1259|             'language' => $language,
  1260|             'translationLinks' => $translationLinks,
  1261|         ]);
  1262|     }
  1263|     /**
  1264|      * @param Document\Page $document
  1265|      *
  1266|      * @return array
  1267|      */
  1268|     private function getSeoNodeConfig($document)
  1269|     {
  1270|         $nodeConfig = $this->getTreeNodeConfig($document);
  1271|         if (method_exists($document, 'getTitle') && method_exists($document, 'getDescription')) {
  1272|             $nodeConfig['prettyUrl'] = $document->getPrettyUrl();
  1273|             $title = $document->getTitle();
  1274|             $description = $document->getDescription();
  1275|             $nodeConfig['title'] = $title;
  1276|             $nodeConfig['description'] = $description;
  1277|             $nodeConfig['title_length'] = mb_strlen($title);
  1278|             $nodeConfig['description_length'] = mb_strlen($description);
  1279|         }
  1280|         return $nodeConfig;
  1281|     }
  1282|     /**
  1283|      * @param ControllerEvent $event
  1284|      */
  1285|     public function onKernelControllerEvent(ControllerEvent $event)
  1286|     {
  1287|         $isMasterRequest = $event->isMasterRequest();
  1288|         if (!$isMasterRequest) {
  1289|             return;
  1290|         }
  1291|         $this->checkActionPermission($event, 'documents', ['docTypesGetAction']);
  1292|         $this->_documentService = new Document\Service($this->getAdminUser());
  1293|     }
  1294| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/DocumentControllerBase.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-285 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Bundle\AdminBundle\Controller\Traits\ApplySchedulerDataTrait;
    17| use Pimcore\Bundle\AdminBundle\Controller\Traits\DocumentTreeConfigTrait;
    18| use Pimcore\Controller\KernelControllerEventInterface;
    19| use Pimcore\Event\Admin\ElementAdminStyleEvent;
    20| use Pimcore\Event\AdminEvents;
    21| use Pimcore\Logger;
    22| use Pimcore\Model;
    23| use Pimcore\Model\Document\Targeting\TargetingDocumentInterface;
    24| use Pimcore\Model\Element;
    25| use Pimcore\Model\Property;
    26| use Pimcore\Model\Version;
    27| use Symfony\Component\EventDispatcher\GenericEvent;
    28| use Symfony\Component\HttpFoundation\JsonResponse;
    29| use Symfony\Component\HttpFoundation\Request;
    30| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    31| /**
    32|  * @internal
    33|  */
    34| abstract class DocumentControllerBase extends AdminController implements KernelControllerEventInterface
    35| {
    36|     use ApplySchedulerDataTrait;
    37|     use DocumentTreeConfigTrait;
    38|     protected function preSendDataActions(&$data, Model\Document $document, ?Version $draftVersion = null)
    39|     {
    40|         $documentFromDatabase = Model\Document::getById($document->getId(), true);
    41|         $data['versionDate'] = $documentFromDatabase->getModificationDate();
    42|         $data['userPermissions'] = $document->getUserPermissions();
    43|         $data['idPath'] = Element\Service::getIdPath($document);
    44|         $data['php'] = [
    45|             'classes' => array_merge([get_class($document)], array_values(class_parents($document))),
    46|             'interfaces' => array_values(class_implements($document)),
    47|         ];
    48|         $this->addAdminStyle($document, ElementAdminStyleEvent::CONTEXT_EDITOR, $data);
    49|         if ($draftVersion && $documentFromDatabase->getModificationDate() < $draftVersion->getDate()) {
    50|             $data['draft'] = [
    51|                 'id' => $draftVersion->getId(),
    52|                 'modificationDate' => $draftVersion->getDate(),
    53|             ];
    54|         }
    55|         $event = new GenericEvent($this, [
    56|             'data' => $data,
    57|             'document' => $document,
    58|         ]);
    59|         \Pimcore::getEventDispatcher()->dispatch($event, AdminEvents::DOCUMENT_GET_PRE_SEND_DATA);
    60|         $data = $event->getArgument('data');
    61|     }
    62|     /**
    63|      * @param Request $request
    64|      * @param Model\Document $document
    65|      */
    66|     protected function addPropertiesToDocument(Request $request, Model\Document $document)
    67|     {
    68|         if ($request->get('properties')) {
    69|             $properties = [];
    70|             foreach ($document->getProperties() as $p) {
    71|                 if ($p->isInherited()) {
    72|                     $properties[$p->getName()] = $p;
    73|                 }
    74|             }
    75|             $propertiesData = $this->decodeJson($request->get('properties'));
    76|             if (is_array($propertiesData)) {
    77|                 foreach ($propertiesData as $propertyName => $propertyData) {
    78|                     $value = $propertyData['data'];
    79|                     try {
    80|                         $property = new Property();
    81|                         $property->setType($propertyData['type']);
    82|                         $property->setName($propertyName);
    83|                         $property->setCtype('document');
    84|                         $property->setDataFromEditmode($value);
    85|                         $property->setInheritable($propertyData['inheritable']);
    86|                         if ($propertyName == 'language') {
    87|                             $property->setInherited($this->getPropertyInheritance($document, $propertyName, $value));
    88|                         }
    89|                         $properties[$propertyName] = $property;
    90|                     } catch (\Exception $e) {
    91|                         Logger::warning("Can't add " . $propertyName . ' to document ' . $document->getRealFullPath());
    92|                     }
    93|                 }
    94|             }
    95|             if ($document->isAllowed('properties')) {
    96|                 $document->setProperties($properties);
    97|             }
    98|         }
    99|         $document->getProperties();
   100|     }
   101|     /**
   102|      * @param Request $request
   103|      * @param Model\Document $document
   104|      */
   105|     protected function addSettingsToDocument(Request $request, Model\Document $document)
   106|     {
   107|         if ($request->get('settings')) {
   108|             if ($document->isAllowed('settings')) {
   109|                 $settings = $this->decodeJson($request->get('settings'));
   110|                 $document->setValues($settings);
   111|             }
   112|         }
   113|     }
   114|     /**
   115|      * @param Request $request
   116|      * @param Model\Document\PageSnippet $document
   117|      */
   118|     protected function addDataToDocument(Request $request, Model\Document\PageSnippet $document)
   119|     {
   120|         if ($request->get('appendEditables') || ($document instanceof TargetingDocumentInterface && $document->hasTargetGroupSpecificEditables())) {
   121|             $document->getEditables();
   122|         }
   123|         if ($request->get('data')) {
   124|             $data = $this->decodeJson($request->get('data'));
   125|             foreach ($data as $name => $value) {
   126|                 $data = $value['data'] ?? null;
   127|                 $type = $value['type'];
   128|                 $document->setRawEditable($name, $type, $data);
   129|             }
   130|         }
   131|     }
   132|     /**
   133|      * @param Model\Document $document
   134|      * @param array $data
   135|      */
   136|     protected function addTranslationsData(Model\Document $document, array &$data)
   137|     {
   138|         $service = new Model\Document\Service;
   139|         $translations = $service->getTranslations($document);
   140|         $unlinkTranslations = $service->getTranslations($document, 'unlink');
   141|         $language = $document->getProperty('language');
   142|         unset($translations[$language], $unlinkTranslations[$language]);
   143|         $data['translations'] = $translations;
   144|         $data['unlinkTranslations'] = $unlinkTranslations;
   145|     }
   146|     /**
   147|      * @param Request $request
   148|      *
   149|      * @return JsonResponse
   150|      */
   151|     public function saveToSessionAction(Request $request)
   152|     {
   153|         if ($request->get('id')) {
   154|             $documentId = $request->get('id');
   155|             if (!$document = Model\Document\Service::getElementFromSession('document', $documentId)) {
   156|                 $document = Model\Document::getById($request->get('id'));
   157|                 $document = $this->getLatestVersion($document);
   158|             }
   159|             $document->setInDumpState(true);
   160|             $this->setValuesToDocument($request, $document);
   161|             Model\Document\Service::saveElementToSession($document);
   162|         }
   163|         return $this->adminJson(['success' => true]);
   164|     }
   165|     /**
   166|      * @param Model\Document $doc
   167|      * @param bool $useForSave
   168|      */
   169|     protected function saveToSession($doc, $useForSave = false)
   170|     {
   171|         Model\Document\Service::saveElementToSession($doc);
   172|         if ($useForSave) {
   173|             Model\Document\Service::saveElementToSession($doc, '_useForSave');
   174|         }
   175|     }
   176|     /**
   177|      * @param Model\Document $doc
   178|      *
   179|      * @return Model\Document|null $sessionDocument
   180|      */
   181|     protected function getFromSession($doc)
   182|     {
   183|         $sessionDocument = null;
   184|         if ($doc instanceof Model\Document) {
   185|             if (($sessionDocument = Model\Document\Service::getElementFromSession('document', $doc->getId())) &&
   186|                 ($documentForSave = Model\Document\Service::getElementFromSession('document', $doc->getId(), '_useForSave'))) {
   187|                 Model\Document\Service::removeElementFromSession('document', $doc->getId(), '_useForSave');
   188|             }
   189|         }
   190|         return $sessionDocument;
   191|     }
   192|     /**
   193|      * @param Request $request
   194|      *
   195|      * @return JsonResponse
   196|      */
   197|     public function removeFromSessionAction(Request $request)
   198|     {
   199|         Model\Document\Service::removeElementFromSession('document', $request->get('id'));
   200|         return $this->adminJson(['success' => true]);
   201|     }
   202|     /**
   203|      * @param Model\Document $document
   204|      * @param array $data
   205|      */
   206|     protected function minimizeProperties($document, array &$data)
   207|     {
   208|         $data['properties'] = Model\Element\Service::minimizePropertiesForEditmode($document->getProperties());
   209|     }
   210|     /**
   211|      * @param Model\Document $document
   212|      * @param string $propertyName
   213|      * @param string $propertyValue
   214|      *
   215|      * @return bool
   216|      */
   217|     protected function getPropertyInheritance(Model\Document $document, $propertyName, $propertyValue)
   218|     {
   219|         if ($document->getParent()) {
   220|             return $propertyValue == $document->getParent()->getProperty($propertyName);
   221|         }
   222|         return false;
   223|     }
   224|     /**
   225|      * @param Model\Document\PageSnippet $document
   226|      * @param null|Version $draftVersion
   227|      *
   228|      * @return Model\Document\PageSnippet
   229|      */
   230|     protected function getLatestVersion(Model\Document\PageSnippet $document, &$draftVersion = null)
   231|     {
   232|         $latestVersion = $document->getLatestVersion($this->getUser()->getId());
   233|         if ($latestVersion) {
   234|             $latestDoc = $latestVersion->loadData();
   235|             if ($latestDoc instanceof Model\Document\PageSnippet) {
   236|                 $draftVersion = $latestVersion;
   237|                 return $latestDoc;
   238|             }
   239|         }
   240|         return $document;
   241|     }
   242|     /**
   243|      * This is used for pages and snippets to change the master document (which is not saved with the normal save button)
   244|      *
   245|      * @param Request $request
   246|      *
   247|      * @return JsonResponse
   248|      */
   249|     public function changeMasterDocumentAction(Request $request)
   250|     {
   251|         $doc = Model\Document::getById($request->get('id'));
   252|         if ($doc instanceof Model\Document\PageSnippet) {
   253|             $doc->setEditables([]);
   254|             $doc->setContentMasterDocumentId($request->get('contentMasterDocumentPath'));
   255|             $doc->saveVersion();
   256|         }
   257|         return $this->adminJson(['success' => true]);
   258|     }
   259|     /**
   260|      * @param ControllerEvent $event
   261|      */
   262|     public function onKernelControllerEvent(ControllerEvent $event)
   263|     {
   264|         $isMasterRequest = $event->isMasterRequest();
   265|         if (!$isMasterRequest) {
   266|             return;
   267|         }
   268|         $this->checkPermission('documents');
   269|     }
   270|     /**
   271|      * @param Request $request
   272|      * @param Model\Document $page
   273|      */
   274|     abstract protected function setValuesToDocument(Request $request, Model\Document $page);
   275|     /**
   276|      * @param string $task
   277|      * @param Model\Document\Snippet $page
   278|      */
   279|     protected function handleTask($task, $page)
   280|     {
   281|         if ($task == 'publish' || $task == 'version') {
   282|             $page->deleteAutoSaveVersions($this->getUser()->getId());
   283|         }
   284|     }
   285| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/EmailController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-154 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    16| use Pimcore\Model\Document;
    17| use Pimcore\Model\Element;
    18| use Symfony\Component\HttpFoundation\JsonResponse;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| /**
    22|  * @Route("/email")
    23|  *
    24|  * @internal
    25|  */
    26| class EmailController extends DocumentControllerBase
    27| {
    28|     use ElementEditLockHelperTrait;
    29|     /**
    30|      * @Route("/save-to-session", name="pimcore_admin_document_email_savetosession", methods={"POST"})
    31|      *
    32|      * {@inheritDoc}
    33|      */
    34|     public function saveToSessionAction(Request $request)
    35|     {
    36|         return parent::saveToSessionAction($request);
    37|     }
    38|     /**
    39|      * @Route("/remove-from-session", name="pimcore_admin_document_email_removefromsession", methods={"DELETE"})
    40|      *
    41|      * {@inheritDoc}
    42|      */
    43|     public function removeFromSessionAction(Request $request)
    44|     {
    45|         return parent::removeFromSessionAction($request);
    46|     }
    47|     /**
    48|      * @Route("/change-master-document", name="pimcore_admin_document_email_changemasterdocument", methods={"PUT"})
    49|      *
    50|      * {@inheritDoc}
    51|      */
    52|     public function changeMasterDocumentAction(Request $request)
    53|     {
    54|         return parent::changeMasterDocumentAction($request);
    55|     }
    56|     /**
    57|      * @Route("/get-data-by-id", name="pimcore_admin_document_email_getdatabyid", methods={"GET"})
    58|      *
    59|      * @param Request $request
    60|      *
    61|      * @return JsonResponse
    62|      */
    63|     public function getDataByIdAction(Request $request)
    64|     {
    65|         if (Element\Editlock::isLocked($request->get('id'), 'document')) {
    66|             return $this->getEditLockResponse($request->get('id'), 'document');
    67|         }
    68|         Element\Editlock::lock($request->get('id'), 'document');
    69|         $email = Document\Email::getById($request->get('id'));
    70|         if (!$email) {
    71|             throw $this->createNotFoundException('Email not found');
    72|         }
    73|         $email = clone $email;
    74|         $draftVersion = null;
    75|         $email = $this->getLatestVersion($email, $draftVersion);
    76|         $versions = Element\Service::getSafeVersionInfo($email->getVersions());
    77|         $email->setVersions(array_splice($versions, -1, 1));
    78|         $email->setLocked($email->isLocked());
    79|         $email->setParent(null);
    80|         $email->setEditables(null);
    81|         $email->setChildren(null);
    82|         $data = $email->getObjectVars();
    83|         $this->addTranslationsData($email, $data);
    84|         $this->minimizeProperties($email, $data);
    85|         $data['url'] = $email->getUrl();
    86|         $this->preSendDataActions($data, $email, $draftVersion);
    87|         if ($email->isAllowed('view')) {
    88|             return $this->adminJson($data);
    89|         }
    90|         throw $this->createAccessDeniedHttpException();
    91|     }
    92|     /**
    93|      * @Route("/save", name="pimcore_admin_document_email_save", methods={"PUT", "POST"})
    94|      *
    95|      * @param Request $request
    96|      *
    97|      * @return JsonResponse
    98|      *
    99|      * @throws \Exception
   100|      */
   101|     public function saveAction(Request $request)
   102|     {
   103|         $page = Document\Email::getById($request->get('id'));
   104|         if (!$page) {
   105|             throw $this->createNotFoundException('Email not found');
   106|         }
   107|         $page = $this->getLatestVersion($page);
   108|         $page->setUserModification($this->getAdminUser()->getId());
   109|         if ($request->get('task') == 'unpublish') {
   110|             $page->setPublished(false);
   111|         }
   112|         if ($request->get('task') == 'publish') {
   113|             $page->setPublished(true);
   114|         }
   115|         if (($request->get('task') == 'publish' && $page->isAllowed('publish')) || ($request->get('task') == 'unpublish' && $page->isAllowed('unpublish'))) {
   116|             $this->setValuesToDocument($request, $page);
   117|             $page->save();
   118|             $this->saveToSession($page);
   119|             $treeData = $this->getTreeNodeConfig($page);
   120|             $this->handleTask($request->get('task'), $page);
   121|             return $this->adminJson([
   122|                 'success' => true,
   123|                 'data' => [
   124|                     'versionDate' => $page->getModificationDate(),
   125|                     'versionCount' => $page->getVersionCount(),
   126|                 ],
   127|                 'treeData' => $treeData,
   128|             ]);
   129|         } elseif ($page->isAllowed('save')) {
   130|             $this->setValuesToDocument($request, $page);
   131|             $version = $page->saveVersion(true, true, null, $request->get('task') == 'autoSave');
   132|             $this->saveToSession($page);
   133|             $draftData = [
   134|                 'id' => $version->getId(),
   135|                 'modificationDate' => $version->getDate(),
   136|             ];
   137|             $this->handleTask($request->get('task'), $page);
   138|             return $this->adminJson(['success' => true, 'draft' => $draftData]);
   139|         } else {
   140|             throw $this->createAccessDeniedHttpException();
   141|         }
   142|     }
   143|     /**
   144|      * @param Request $request
   145|      * @param Document $page
   146|      */
   147|     protected function setValuesToDocument(Request $request, Document $page)
   148|     {
   149|         $this->addSettingsToDocument($request, $page);
   150|         $this->addDataToDocument($request, $page);
   151|         $this->addPropertiesToDocument($request, $page);
   152|         $this->applySchedulerDataToElement($request, $page);
   153|     }
   154| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/FolderController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-120 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    16| use Pimcore\Model\Document;
    17| use Pimcore\Model\Element;
    18| use Symfony\Component\HttpFoundation\JsonResponse;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| /**
    22|  * @Route("/folder")
    23|  *
    24|  * @internal
    25|  */
    26| class FolderController extends DocumentControllerBase
    27| {
    28|     use ElementEditLockHelperTrait;
    29|     /**
    30|      * @Route("/save-to-session", name="pimcore_admin_document_folder_savetosession", methods={"POST"})
    31|      *
    32|      * {@inheritDoc}
    33|      */
    34|     public function saveToSessionAction(Request $request)
    35|     {
    36|         return parent::saveToSessionAction($request);
    37|     }
    38|     /**
    39|      * @Route("/remove-from-session", name="pimcore_admin_document_folder_removefromsession", methods={"DELETE"})
    40|      *
    41|      * {@inheritDoc}
    42|      */
    43|     public function removeFromSessionAction(Request $request)
    44|     {
    45|         return parent::removeFromSessionAction($request);
    46|     }
    47|     /**
    48|      * @Route("/change-master-document", name="pimcore_admin_document_folder_changemasterdocument", methods={"PUT"})
    49|      *
    50|      * {@inheritDoc}
    51|      */
    52|     public function changeMasterDocumentAction(Request $request)
    53|     {
    54|         return parent::changeMasterDocumentAction($request);
    55|     }
    56|     /**
    57|      * @Route("/get-data-by-id", name="pimcore_admin_document_folder_getdatabyid", methods={"GET"})
    58|      *
    59|      * @param Request $request
    60|      *
    61|      * @return JsonResponse
    62|      */
    63|     public function getDataByIdAction(Request $request)
    64|     {
    65|         $folder = Document\Folder::getById($request->get('id'));
    66|         if (!$folder) {
    67|             throw $this->createNotFoundException('Folder not found');
    68|         }
    69|         if ($folder->isAllowed('save') || $folder->isAllowed('publish') || $folder->isAllowed('unpublish') || $folder->isAllowed('delete')) {
    70|             if (Element\Editlock::isLocked($request->get('id'), 'document')) {
    71|                 return $this->getEditLockResponse($request->get('id'), 'document');
    72|             }
    73|             Element\Editlock::lock($request->get('id'), 'document');
    74|         }
    75|         $folder = clone $folder;
    76|         $folder->setLocked($folder->isLocked());
    77|         $folder->setParent(null);
    78|         $data = $folder->getObjectVars();
    79|         $this->addTranslationsData($folder, $data);
    80|         $this->minimizeProperties($folder, $data);
    81|         $this->preSendDataActions($data, $folder);
    82|         if ($folder->isAllowed('view')) {
    83|             return $this->adminJson($data);
    84|         }
    85|         throw $this->createAccessDeniedHttpException();
    86|     }
    87|     /**
    88|      * @Route("/save", name="pimcore_admin_document_folder_save", methods={"PUT", "POST"})
    89|      *
    90|      * @param Request $request
    91|      *
    92|      * @return JsonResponse
    93|      *
    94|      * @throws \Exception
    95|      */
    96|     public function saveAction(Request $request)
    97|     {
    98|         $folder = Document\Folder::getById($request->get('id'));
    99|         if (!$folder) {
   100|             throw $this->createNotFoundException('Folder not found');
   101|         }
   102|         $folder->setModificationDate(time());
   103|         $folder->setUserModification($this->getAdminUser()->getId());
   104|         if ($folder->isAllowed('publish')) {
   105|             $this->setValuesToDocument($request, $folder);
   106|             $folder->save();
   107|             $treeData = $this->getTreeNodeConfig($folder);
   108|             return $this->adminJson(['success' => true, 'treeData' => $treeData]);
   109|         }
   110|         throw $this->createAccessDeniedHttpException();
   111|     }
   112|     /**
   113|      * @param Request $request
   114|      * @param Document $folder
   115|      */
   116|     protected function setValuesToDocument(Request $request, Document $folder)
   117|     {
   118|         $this->addPropertiesToDocument($request, $folder);
   119|     }
   120| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/HardlinkController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-148 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    16| use Pimcore\Model\Document;
    17| use Pimcore\Model\Element;
    18| use Symfony\Component\HttpFoundation\JsonResponse;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| /**
    22|  * @Route("/hardlink")
    23|  *
    24|  * @internal
    25|  */
    26| class HardlinkController extends DocumentControllerBase
    27| {
    28|     use ElementEditLockHelperTrait;
    29|     /**
    30|      * @Route("/save-to-session", name="pimcore_admin_document_hardlink_savetosession", methods={"POST"})
    31|      *
    32|      * {@inheritDoc}
    33|      */
    34|     public function saveToSessionAction(Request $request)
    35|     {
    36|         return parent::saveToSessionAction($request);
    37|     }
    38|     /**
    39|      * @Route("/remove-from-session", name="pimcore_admin_document_hardlink_removefromsession", methods={"DELETE"})
    40|      *
    41|      * {@inheritDoc}
    42|      */
    43|     public function removeFromSessionAction(Request $request)
    44|     {
    45|         return parent::removeFromSessionAction($request);
    46|     }
    47|     /**
    48|      * @Route("/change-master-document", name="pimcore_admin_document_hardlink_changemasterdocument", methods={"PUT"})
    49|      *
    50|      * {@inheritDoc}
    51|      */
    52|     public function changeMasterDocumentAction(Request $request)
    53|     {
    54|         return parent::changeMasterDocumentAction($request);
    55|     }
    56|     /**
    57|      * @Route("/get-data-by-id", name="pimcore_admin_document_hardlink_getdatabyid", methods={"GET"})
    58|      *
    59|      * @param Request $request
    60|      *
    61|      * @return JsonResponse
    62|      */
    63|     public function getDataByIdAction(Request $request)
    64|     {
    65|         $link = Document\Hardlink::getById($request->get('id'));
    66|         if (!$link) {
    67|             throw $this->createNotFoundException('Hardlink not found');
    68|         }
    69|         if ($link->isAllowed('save') || $link->isAllowed('publish') || $link->isAllowed('unpublish') || $link->isAllowed('delete')) {
    70|             if (Element\Editlock::isLocked($request->get('id'), 'document')) {
    71|                 return $this->getEditLockResponse($request->get('id'), 'document');
    72|             }
    73|             Element\Editlock::lock($request->get('id'), 'document');
    74|         }
    75|         $link = clone $link;
    76|         $link->setLocked($link->isLocked());
    77|         $link->setParent(null);
    78|         $link->getScheduledTasks();
    79|         $data = $link->getObjectVars();
    80|         $this->addTranslationsData($link, $data);
    81|         $this->minimizeProperties($link, $data);
    82|         if ($link->getSourceDocument()) {
    83|             $data['sourcePath'] = $link->getSourceDocument()->getRealFullPath();
    84|         }
    85|         $this->preSendDataActions($data, $link);
    86|         if ($link->isAllowed('view')) {
    87|             return $this->adminJson($data);
    88|         }
    89|         throw $this->createAccessDeniedHttpException();
    90|     }
    91|     /**
    92|      * @Route("/save", name="pimcore_admin_document_hardlink_save", methods={"POST", "PUT"})
    93|      *
    94|      * @param Request $request
    95|      *
    96|      * @return JsonResponse
    97|      *
    98|      * @throws \Exception
    99|      */
   100|     public function saveAction(Request $request)
   101|     {
   102|         $link = Document\Hardlink::getById($request->get('id'));
   103|         if (!$link) {
   104|             throw $this->createNotFoundException('Hardlink not found');
   105|         }
   106|         $this->setValuesToDocument($request, $link);
   107|         $link->setModificationDate(time());
   108|         $link->setUserModification($this->getAdminUser()->getId());
   109|         if ($request->get('task') == 'unpublish') {
   110|             $link->setPublished(false);
   111|         }
   112|         if ($request->get('task') == 'publish') {
   113|             $link->setPublished(true);
   114|         }
   115|         if (($request->get('task') == 'publish' && $link->isAllowed('publish')) || ($request->get('task') == 'unpublish' && $link->isAllowed('unpublish'))) {
   116|             $link->save();
   117|             $treeData = $this->getTreeNodeConfig($link);
   118|             return $this->adminJson([
   119|                 'success' => true,
   120|                  'data' => [
   121|                      'versionDate' => $link->getModificationDate(),
   122|                      'versionCount' => $link->getVersionCount(),
   123|                  ],
   124|                 'treeData' => $treeData,
   125|             ]);
   126|         } else {
   127|             throw $this->createAccessDeniedHttpException();
   128|         }
   129|     }
   130|     /**
   131|      * @param Request $request
   132|      * @param Document\Hardlink $link
   133|      */
   134|     protected function setValuesToDocument(Request $request, Document $link)
   135|     {
   136|         if ($request->get('data')) {
   137|             $data = $this->decodeJson($request->get('data'));
   138|             $sourceId = null;
   139|             if ($sourceDocument = Document::getByPath($data['sourcePath'])) {
   140|                 $sourceId = $sourceDocument->getId();
   141|             }
   142|             $link->setSourceId($sourceId);
   143|             $link->setValues($data);
   144|         }
   145|         $this->addPropertiesToDocument($request, $link);
   146|         $this->applySchedulerDataToElement($request, $link);
   147|     }
   148| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/LinkController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-189 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    16| use Pimcore\Model\Asset;
    17| use Pimcore\Model\DataObject\Concrete;
    18| use Pimcore\Model\Document;
    19| use Pimcore\Model\Element;
    20| use Symfony\Component\HttpFoundation\JsonResponse;
    21| use Symfony\Component\HttpFoundation\Request;
    22| use Symfony\Component\Routing\Annotation\Route;
    23| use Symfony\Component\Serializer\SerializerInterface;
    24| /**
    25|  * @Route("/link")
    26|  *
    27|  * @internal
    28|  */
    29| class LinkController extends DocumentControllerBase
    30| {
    31|     use ElementEditLockHelperTrait;
    32|     /**
    33|      * @Route("/save-to-session", name="pimcore_admin_document_link_savetosession", methods={"POST"})
    34|      *
    35|      * {@inheritDoc}
    36|      */
    37|     public function saveToSessionAction(Request $request)
    38|     {
    39|         return parent::saveToSessionAction($request);
    40|     }
    41|     /**
    42|      * @Route("/remove-from-session", name="pimcore_admin_document_link_removefromsession", methods={"DELETE"})
    43|      *
    44|      * {@inheritDoc}
    45|      */
    46|     public function removeFromSessionAction(Request $request)
    47|     {
    48|         return parent::removeFromSessionAction($request);
    49|     }
    50|     /**
    51|      * @Route("/change-master-document", name="pimcore_admin_document_link_changemasterdocument", methods={"PUT"})
    52|      *
    53|      * {@inheritDoc}
    54|      */
    55|     public function changeMasterDocumentAction(Request $request)
    56|     {
    57|         return parent::changeMasterDocumentAction($request);
    58|     }
    59|     /**
    60|      * @Route("/get-data-by-id", name="pimcore_admin_document_link_getdatabyid", methods={"GET"})
    61|      *
    62|      * @param Request $request
    63|      * @param SerializerInterface $serializer
    64|      *
    65|      * @return JsonResponse
    66|      */
    67|     public function getDataByIdAction(Request $request, SerializerInterface $serializer)
    68|     {
    69|         $link = Document\Link::getById($request->get('id'));
    70|         if (!$link) {
    71|             throw $this->createNotFoundException('Link not found');
    72|         }
    73|         if ($link->isAllowed('save') || $link->isAllowed('publish') || $link->isAllowed('unpublish') || $link->isAllowed('delete')) {
    74|             if (Element\Editlock::isLocked($request->get('id'), 'document')) {
    75|                 return $this->getEditLockResponse($request->get('id'), 'document');
    76|             }
    77|             Element\Editlock::lock($request->get('id'), 'document');
    78|         }
    79|         $link = clone $link;
    80|         $link->setObject(null);
    81|         $link->setLocked($link->isLocked());
    82|         $link->setParent(null);
    83|         $link->getScheduledTasks();
    84|         $data = $serializer->serialize($link->getObjectVars(), 'json', []);
    85|         $data = json_decode($data, true);
    86|         $data['rawHref'] = $link->getRawHref();
    87|         $this->addTranslationsData($link, $data);
    88|         $this->minimizeProperties($link, $data);
    89|         $this->preSendDataActions($data, $link);
    90|         if ($link->isAllowed('view')) {
    91|             return $this->adminJson($data);
    92|         }
    93|         throw $this->createAccessDeniedHttpException();
    94|     }
    95|     /**
    96|      * @Route("/save", name="pimcore_admin_document_link_save", methods={"POST", "PUT"})
    97|      *
    98|      * @param Request $request
    99|      *
   100|      * @return JsonResponse
   101|      *
   102|      * @throws \Exception
   103|      */
   104|     public function saveAction(Request $request)
   105|     {
   106|         $link = Document\Link::getById($request->get('id'));
   107|         if (!$link) {
   108|             throw $this->createNotFoundException('Link not found');
   109|         }
   110|         $this->setValuesToDocument($request, $link);
   111|         $link->setModificationDate(time());
   112|         $link->setUserModification($this->getAdminUser()->getId());
   113|         if ($request->get('task') == 'unpublish') {
   114|             $link->setPublished(false);
   115|         }
   116|         if ($request->get('task') == 'publish') {
   117|             $link->setPublished(true);
   118|         }
   119|         $task = $request->get('task');
   120|         if (($task == 'publish' && $link->isAllowed('publish'))
   121|             || ($task == 'unpublish' && $link->isAllowed('unpublish'))
   122|             || $task == 'scheduler' && $link->isAllowed('settings')
   123|         ) {
   124|             $link->save();
   125|             $treeData = $this->getTreeNodeConfig($link);
   126|             return $this->adminJson([
   127|                 'success' => true,
   128|                 'data' => [
   129|                     'versionDate' => $link->getModificationDate(),
   130|                     'versionCount' => $link->getVersionCount(),
   131|                 ],
   132|                 'treeData' => $treeData,
   133|             ]);
   134|         } else {
   135|             throw $this->createAccessDeniedHttpException();
   136|         }
   137|     }
   138|     /**
   139|      * @param Request $request
   140|      * @param Document\Link $link
   141|      */
   142|     protected function setValuesToDocument(Request $request, Document $link)
   143|     {
   144|         if ($request->get('data')) {
   145|             $data = $this->decodeJson($request->get('data'));
   146|             $path = $data['path'];
   147|             if (!empty($path)) {
   148|                 $target = null;
   149|                 if ($data['linktype'] == 'internal' && $data['internalType']) {
   150|                     $target = Element\Service::getElementByPath($data['internalType'], $path);
   151|                     if ($target) {
   152|                         $data['internal'] = $target->getId();
   153|                     }
   154|                 }
   155|                 if (!$target) {
   156|                     if ($target = Document::getByPath($path)) {
   157|                         $data['linktype'] = 'internal';
   158|                         $data['internalType'] = 'document';
   159|                         $data['internal'] = $target->getId();
   160|                     } elseif ($target = Asset::getByPath($path)) {
   161|                         $data['linktype'] = 'internal';
   162|                         $data['internalType'] = 'asset';
   163|                         $data['internal'] = $target->getId();
   164|                     } elseif ($target = Concrete::getByPath($path)) {
   165|                         $data['linktype'] = 'internal';
   166|                         $data['internalType'] = 'object';
   167|                         $data['internal'] = $target->getId();
   168|                     } else {
   169|                         $data['linktype'] = 'direct';
   170|                         $data['internalType'] = null;
   171|                         $data['direct'] = $path;
   172|                     }
   173|                     if ($target) {
   174|                         $data['linktype'] = 'internal';
   175|                     }
   176|                 }
   177|             } else {
   178|                 $data['linktype'] = 'internal';
   179|                 $data['direct'] = '';
   180|                 $data['internalType'] = null;
   181|                 $data['internal'] = null;
   182|             }
   183|             unset($data['path']);
   184|             $link->setValues($data);
   185|         }
   186|         $this->addPropertiesToDocument($request, $link);
   187|         $this->applySchedulerDataToElement($request, $link);
   188|     }
   189| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/NewsletterController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-389 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Exception;
    16| use Pimcore;
    17| use Pimcore\Document\Newsletter\AddressSourceAdapterFactoryInterface;
    18| use Pimcore\Model\DataObject\ClassDefinition\Data\Email;
    19| use Pimcore\Model\DataObject\ClassDefinition\Data\NewsletterActive;
    20| use Pimcore\Model\DataObject\ClassDefinition\Data\NewsletterConfirmed;
    21| use Pimcore\Model\DataObject\ClassDefinition\Listing;
    22| use Pimcore\Model\Document;
    23| use Pimcore\Model\Element;
    24| use Pimcore\Model\Tool;
    25| use Pimcore\Model\Tool\CustomReport\Config;
    26| use Pimcore\Tool\Console;
    27| use Pimcore\Tool\Newsletter;
    28| use RuntimeException;
    29| use Symfony\Component\HttpFoundation\JsonResponse;
    30| use Symfony\Component\HttpFoundation\Request;
    31| use Symfony\Component\Routing\Annotation\Route;
    32| /**
    33|  * @Route("/newsletter")
    34|  *
    35|  * @internal
    36|  */
    37| class NewsletterController extends DocumentControllerBase
    38| {
    39|     use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    40|     /**
    41|      * @Route("/save-to-session", name="pimcore_admin_document_newsletter_savetosession", methods={"POST"})
    42|      *
    43|      * {@inheritDoc}
    44|      */
    45|     public function saveToSessionAction(Request $request)
    46|     {
    47|         return parent::saveToSessionAction($request);
    48|     }
    49|     /**
    50|      * @Route("/remove-from-session", name="pimcore_admin_document_newsletter_removefromsession", methods={"DELETE"})
    51|      *
    52|      * {@inheritDoc}
    53|      */
    54|     public function removeFromSessionAction(Request $request)
    55|     {
    56|         return parent::removeFromSessionAction($request);
    57|     }
    58|     /**
    59|      * @Route("/change-master-document", name="pimcore_admin_document_newsletter_changemasterdocument", methods={"PUT"})
    60|      *
    61|      * {@inheritDoc}
    62|      */
    63|     public function changeMasterDocumentAction(Request $request)
    64|     {
    65|         return parent::changeMasterDocumentAction($request);
    66|     }
    67|     /**
    68|      * @Route("/get-data-by-id", name="pimcore_admin_document_newsletter_getdatabyid", methods={"GET"})
    69|      *
    70|      * @param Request $request
    71|      *
    72|      * @return JsonResponse
    73|      */
    74|     public function getDataByIdAction(Request $request): JsonResponse
    75|     {
    76|         $email = Document\Newsletter::getById($request->get('id'));
    77|         if (!$email) {
    78|             throw $this->createNotFoundException('Document not found');
    79|         }
    80|         if ($email->isAllowed('save') || $email->isAllowed('publish') || $email->isAllowed('unpublish') || $email->isAllowed('delete')) {
    81|             if (Element\Editlock::isLocked($request->get('id'), 'document')) {
    82|                 return $this->getEditLockResponse($request->get('id'), 'document');
    83|             }
    84|             Element\Editlock::lock($request->get('id'), 'document');
    85|         }
    86|         $email = clone $email;
    87|         $draftVersion = null;
    88|         $email = $this->getLatestVersion($email, $draftVersion);
    89|         $versions = Element\Service::getSafeVersionInfo($email->getVersions());
    90|         $email->setVersions(array_splice($versions, -1, 1));
    91|         $email->setLocked($email->isLocked());
    92|         $email->setParent(null);
    93|         $email->setEditables(null);
    94|         $email->setChildren(null);
    95|         $data = $email->getObjectVars();
    96|         $this->addTranslationsData($email, $data);
    97|         $this->minimizeProperties($email, $data);
    98|         $data['url'] = $email->getUrl();
    99|         $this->preSendDataActions($data, $email, $draftVersion);
   100|         if ($email->isAllowed('view')) {
   101|             return $this->adminJson($data);
   102|         }
   103|         throw $this->createAccessDeniedHttpException();
   104|     }
   105|     /**
   106|      * @Route("/save", name="pimcore_admin_document_newsletter_save", methods={"PUT", "POST"})
   107|      *
   108|      * @param Request $request
   109|      *
   110|      * @return JsonResponse
   111|      *
   112|      * @throws Exception
   113|      */
   114|     public function saveAction(Request $request): JsonResponse
   115|     {
   116|         $page = Document\Newsletter::getById($request->get('id'));
   117|         if (!$page) {
   118|             throw $this->createNotFoundException('Document not found');
   119|         }
   120|         $page = $this->getLatestVersion($page);
   121|         $page->setUserModification($this->getAdminUser()->getId());
   122|         if ($request->get('task') === 'unpublish') {
   123|             $page->setPublished(false);
   124|         }
   125|         if ($request->get('task') === 'publish') {
   126|             $page->setPublished(true);
   127|         }
   128|         if (($request->get('task') === 'publish' && $page->isAllowed('publish')) ||
   129|             ($request->get('task') === 'unpublish' && $page->isAllowed('unpublish'))) {
   130|             $this->setValuesToDocument($request, $page);
   131|             $page->save();
   132|             $this->saveToSession($page);
   133|             $treeData = $this->getTreeNodeConfig($page);
   134|             return $this->adminJson([
   135|                 'success' => true,
   136|                 'data' => [
   137|                     'versionDate' => $page->getModificationDate(),
   138|                     'versionCount' => $page->getVersionCount(),
   139|                 ],
   140|                 'treeData' => $treeData,
   141|             ]);
   142|         } elseif ($page->isAllowed('save')) {
   143|             $this->setValuesToDocument($request, $page);
   144|             $version = $page->saveVersion();
   145|             $this->saveToSession($page);
   146|             $draftData = [
   147|                 'id' => $version->getId(),
   148|                 'modificationDate' => $version->getDate(),
   149|             ];
   150|             return $this->adminJson(['success' => true, 'draft' => $draftData]);
   151|         } else {
   152|             throw $this->createAccessDeniedHttpException();
   153|         }
   154|     }
   155|     /**
   156|      * @param Request $request
   157|      * @param Document $page
   158|      */
   159|     protected function setValuesToDocument(Request $request, Document $page)
   160|     {
   161|         $this->addSettingsToDocument($request, $page);
   162|         $this->addDataToDocument($request, $page);
   163|         $this->addPropertiesToDocument($request, $page);
   164|         if ($request->get('plaintext')) {
   165|             $plaintext = $this->decodeJson($request->get('plaintext'));
   166|             $page->setValues($plaintext);
   167|         }
   168|     }
   169|     /**
   170|      * @Route("/checksql", name="pimcore_admin_document_newsletter_checksql", methods={"POST"})
   171|      *
   172|      * @param Request $request
   173|      *
   174|      * @return JsonResponse
   175|      */
   176|     public function checksqlAction(Request $request): JsonResponse
   177|     {
   178|         $count = 0;
   179|         $success = false;
   180|         try {
   181|             $className = '\\Pimcore\\Model\\DataObject\\' . ucfirst($request->get('class')) . '\\Listing';
   182|             /** @var Pimcore\Model\DataObject\Listing $list */
   183|             $list = new $className();
   184|             $conditions = ['(newsletterActive = 1 AND newsletterConfirmed = 1)'];
   185|             if ($request->get('objectFilterSQL')) {
   186|                 $conditions[] = $request->get('objectFilterSQL');
   187|             }
   188|             $list->setCondition(implode(' AND ', $conditions));
   189|             $count = $list->getTotalCount();
   190|             $success = true;
   191|         } catch (Exception $e) {
   192|         }
   193|         return $this->adminJson([
   194|             'count' => $count,
   195|             'success' => $success,
   196|         ]);
   197|     }
   198|     /**
   199|      * @Route("/get-available-classes", name="pimcore_admin_document_newsletter_getavailableclasses", methods={"GET"})
   200|      *
   201|      * @return JsonResponse
   202|      */
   203|     public function getAvailableClassesAction(): JsonResponse
   204|     {
   205|         $classList = new Listing();
   206|         $availableClasses = [];
   207|         foreach ($classList->load() as $class) {
   208|             $fieldCount = 0;
   209|             foreach ($class->getFieldDefinitions() as $fd) {
   210|                 if ($fd instanceof NewsletterActive ||
   211|                     $fd instanceof NewsletterConfirmed ||
   212|                     $fd instanceof Email) {
   213|                     $fieldCount++;
   214|                 }
   215|             }
   216|             if ($fieldCount >= 3) {
   217|                 $availableClasses[] = ['name' => $class->getName()];
   218|             }
   219|         }
   220|         return $this->adminJson(['data' => $availableClasses]);
   221|     }
   222|     /**
   223|      * @Route("/get-available-reports", name="pimcore_admin_document_newsletter_getavailablereports", methods={"GET"})
   224|      *
   225|      * @param Request $request
   226|      *
   227|      * @return JsonResponse
   228|      */
   229|     public function getAvailableReportsAction(Request $request): JsonResponse
   230|     {
   231|         $task = $request->get('task');
   232|         if ($task === 'list') {
   233|             $reportList = Config::getReportsList();
   234|             $availableReports = [];
   235|             foreach ($reportList as $report) {
   236|                 $availableReports[] = ['id' => $report['id'], 'text' => $report['text']];
   237|             }
   238|             return $this->adminJson(['data' => $availableReports]);
   239|         }
   240|         if ($task === 'fieldNames') {
   241|             $reportId = $request->get('reportId');
   242|             $report = Config::getByName($reportId);
   243|             $columnConfiguration = $report !== null ? $report->getColumnConfiguration() : [];
   244|             $availableColumns = [];
   245|             foreach ($columnConfiguration as $column) {
   246|                 if ($column['display']) {
   247|                     $availableColumns[] = ['name' => $column['name']];
   248|                 }
   249|             }
   250|             return $this->adminJson(['data' => $availableColumns]);
   251|         }
   252|         return $this->adminJson(['success' => false]);
   253|     }
   254|     /**
   255|      * @Route("/get-send-status", name="pimcore_admin_document_newsletter_getsendstatus", methods={"GET"})
   256|      *
   257|      * @param Request $request
   258|      *
   259|      * @return JsonResponse
   260|      */
   261|     public function getSendStatusAction(Request $request): JsonResponse
   262|     {
   263|         /** @var Document\Newsletter $document */
   264|         $document = Document\Newsletter::getById($request->get('id'));
   265|         $data = Tool\TmpStore::get($document->getTmpStoreId());
   266|         return $this->adminJson([
   267|             'data' => $data ? $data->getData() : null,
   268|             'success' => true,
   269|         ]);
   270|     }
   271|     /**
   272|      * @Route("/stop-send", name="pimcore_admin_document_newsletter_stopsend", methods={"POST"})
   273|      *
   274|      * @param Request $request
   275|      *
   276|      * @return JsonResponse
   277|      */
   278|     public function stopSendAction(Request $request): JsonResponse
   279|     {
   280|         /** @var Document\Newsletter $document */
   281|         $document = Document\Newsletter::getById($request->get('id'));
   282|         Tool\TmpStore::delete($document->getTmpStoreId());
   283|         return $this->adminJson([
   284|             'success' => true,
   285|         ]);
   286|     }
   287|     /**
   288|      * @Route("/send", name="pimcore_admin_document_newsletter_send", methods={"POST"})
   289|      *
   290|      * @param Request $request
   291|      *
   292|      * @return JsonResponse
   293|      *
   294|      * @throws Exception
   295|      */
   296|     public function sendAction(Request $request): JsonResponse
   297|     {
   298|         /** @var Document\Newsletter $document */
   299|         $document = Document\Newsletter::getById($request->get('id'));
   300|         if (Tool\TmpStore::get($document->getTmpStoreId())) {
   301|             throw new RuntimeException('Newsletter sending already in progress, need to finish first.');
   302|         }
   303|         /** @var Document\Newsletter $document */
   304|         $document = Document\Newsletter::getById($request->get('id'));
   305|         Tool\TmpStore::add($document->getTmpStoreId(), [
   306|             'documentId' => $document->getId(),
   307|             'addressSourceAdapterName' => $request->get('addressAdapterName'),
   308|             'adapterParams' => json_decode($request->get('adapterParams'), true),
   309|             'inProgress' => false,
   310|             'progress' => 0,
   311|         ], 'newsletter');
   312|         Console::runPhpScriptInBackground(
   313|             realpath(PIMCORE_PROJECT_ROOT . DIRECTORY_SEPARATOR . 'bin' . DIRECTORY_SEPARATOR . 'console'),
   314|             ['internal:newsletter-document-send', $document->getTmpStoreId(), \Pimcore\Tool::getHostUrl()],
   315|             PIMCORE_LOG_DIRECTORY . DIRECTORY_SEPARATOR . 'newsletter-sending-output.log'
   316|         );
   317|         return $this->adminJson(['success' => true]);
   318|     }
   319|     /**
   320|      * @Route("/calculate", name="pimcore_admin_document_newsletter_calculate", methods={"POST"})
   321|      *
   322|      * @param Request $request
   323|      *
   324|      * @return JsonResponse
   325|      */
   326|     public function calculateAction(Request $request): JsonResponse
   327|     {
   328|         $addressSourceAdapterName = $request->get('addressAdapterName');
   329|         $adapterParams = json_decode($request->get('adapterParams'), true);
   330|         $serviceLocator = \Pimcore::getContainer()->get('pimcore.newsletter.address_source_adapter.factories');
   331|         if (!$serviceLocator->has($addressSourceAdapterName)) {
   332|             $msg = sprintf(
   333|                 'Cannot send newsletters because Address Source Adapter with identifier %s could not be found',
   334|                 $addressSourceAdapterName
   335|             );
   336|             return $this->adminJson(['success' => false, 'count' => '0', 'message' => $msg]);
   337|         }
   338|         /** @var AddressSourceAdapterFactoryInterface $addressAdapterFactory */
   339|         $addressAdapterFactory = $serviceLocator->get($addressSourceAdapterName);
   340|         $addressAdapter = $addressAdapterFactory->create($adapterParams);
   341|         return $this->adminJson(['success' => true, 'count' => $addressAdapter->getTotalRecordCount()]);
   342|     }
   343|     /**
   344|      * @Route("/send-test", name="pimcore_admin_document_newsletter_sendtest", methods={"POST"})
   345|      *
   346|      * @param Request $request
   347|      *
   348|      * @return JsonResponse
   349|      *
   350|      * @throws Exception
   351|      */
   352|     public function sendTestAction(Request $request): JsonResponse
   353|     {
   354|         $document = Document\Newsletter::getById($request->get('id'));
   355|         $addressSourceAdapterName = $request->get('addressAdapterName');
   356|         $adapterParams = json_decode($request->get('adapterParams'), true);
   357|         $testMailAddress = $request->get('testMailAddress');
   358|         if (empty($testMailAddress)) {
   359|             return $this->adminJson([
   360|                 'success' => false,
   361|                 'message' => 'Please provide a valid email address to send test newsletter',
   362|             ]);
   363|         }
   364|         $serviceLocator = \Pimcore::getContainer()->get('pimcore.newsletter.address_source_adapter.factories');
   365|         if (!$serviceLocator->has($addressSourceAdapterName)) {
   366|             return $this->adminJson([
   367|                 'success' => false,
   368|                 'error' => sprintf(
   369|                     'Cannot send newsletters because Address Source Adapter with identifier %s could not be found',
   370|                     $addressSourceAdapterName
   371|                 ),
   372|             ]);
   373|         }
   374|         /** @var AddressSourceAdapterFactoryInterface $addressAdapterFactory */
   375|         $addressAdapterFactory = $serviceLocator->get($addressSourceAdapterName);
   376|         $addressAdapter = $addressAdapterFactory->create($adapterParams);
   377|         $sendingContainer = $addressAdapter->getParamsForTestSending($testMailAddress);
   378|         try {
   379|             $mail = Newsletter::prepareMail($document);
   380|             Newsletter::sendNewsletterDocumentBasedMail($mail, $sendingContainer);
   381|         } catch (\Exception $e) {
   382|             return $this->adminJson([
   383|                 'success' => false,
   384|                 'error' => $e->getMessage(),
   385|             ]);
   386|         }
   387|         return $this->adminJson(['success' => true]);
   388|     }
   389| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/PageController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-387 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    16| use Pimcore\Document\Editable\Block\BlockStateStack;
    17| use Pimcore\Document\Editable\EditmodeEditableDefinitionCollector;
    18| use Pimcore\Http\Request\Resolver\EditmodeResolver;
    19| use Pimcore\Logger;
    20| use Pimcore\Model\Document;
    21| use Pimcore\Model\Document\Targeting\TargetingDocumentInterface;
    22| use Pimcore\Model\Element;
    23| use Pimcore\Templating\Renderer\EditableRenderer;
    24| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    25| use Symfony\Component\HttpFoundation\JsonResponse;
    26| use Symfony\Component\HttpFoundation\Request;
    27| use Symfony\Component\Routing\Annotation\Route;
    28| use Twig\Environment;
    29| /**
    30|  * @Route("/page")
    31|  *
    32|  * @internal
    33|  */
    34| class PageController extends DocumentControllerBase
    35| {
    36|     use ElementEditLockHelperTrait;
    37|     /**
    38|      * @Route("/save-to-session", name="pimcore_admin_document_page_savetosession", methods={"POST"})
    39|      *
    40|      * {@inheritDoc}
    41|      */
    42|     public function saveToSessionAction(Request $request)
    43|     {
    44|         return parent::saveToSessionAction($request);
    45|     }
    46|     /**
    47|      * @Route("/remove-from-session", name="pimcore_admin_document_page_removefromsession", methods={"DELETE"})
    48|      *
    49|      * {@inheritDoc}
    50|      */
    51|     public function removeFromSessionAction(Request $request)
    52|     {
    53|         return parent::removeFromSessionAction($request);
    54|     }
    55|     /**
    56|      * @Route("/change-master-document", name="pimcore_admin_document_page_changemasterdocument", methods={"PUT"})
    57|      *
    58|      * {@inheritDoc}
    59|      */
    60|     public function changeMasterDocumentAction(Request $request)
    61|     {
    62|         return parent::changeMasterDocumentAction($request);
    63|     }
    64|     /**
    65|      * @Route("/get-data-by-id", name="pimcore_admin_document_page_getdatabyid", methods={"GET"})
    66|      *
    67|      * @param Request $request
    68|      *
    69|      * @return JsonResponse
    70|      */
    71|     public function getDataByIdAction(Request $request)
    72|     {
    73|         $page = Document\Page::getById($request->get('id'));
    74|         if (!$page) {
    75|             throw $this->createNotFoundException('Page not found');
    76|         }
    77|         if ($page->isAllowed('save') || $page->isAllowed('publish') || $page->isAllowed('unpublish') || $page->isAllowed('delete')) {
    78|             if (Element\Editlock::isLocked($request->get('id'), 'document')) {
    79|                 return $this->getEditLockResponse($request->get('id'), 'document');
    80|             }
    81|             Element\Editlock::lock($request->get('id'), 'document');
    82|         }
    83|         $page = clone $page;
    84|         $draftVersion = null;
    85|         $page = $this->getLatestVersion($page, $draftVersion);
    86|         $pageVersions = Element\Service::getSafeVersionInfo($page->getVersions());
    87|         $page->setVersions(array_splice($pageVersions, -1, 1));
    88|         $page->getScheduledTasks();
    89|         $page->setLocked($page->isLocked());
    90|         $page->setParent(null);
    91|         $page->setEditables(null);
    92|         $page->setChildren(null);
    93|         $data = $page->getObjectVars();
    94|         $this->addTranslationsData($page, $data);
    95|         $this->minimizeProperties($page, $data);
    96|         if ($page->getContentMasterDocument()) {
    97|             $data['contentMasterDocumentPath'] = $page->getContentMasterDocument()->getRealFullPath();
    98|         }
    99|         $data['url'] = $page->getUrl();
   100|         $this->preSendDataActions($data, $page, $draftVersion);
   101|         if ($page->isAllowed('view')) {
   102|             return $this->adminJson($data);
   103|         }
   104|         throw $this->createAccessDeniedHttpException();
   105|     }
   106|     /**
   107|      * @Route("/save", name="pimcore_admin_document_page_save", methods={"PUT", "POST"})
   108|      *
   109|      * @param Request $request
   110|      *
   111|      * @return JsonResponse
   112|      *
   113|      * @throws \Exception
   114|      */
   115|     public function saveAction(Request $request)
   116|     {
   117|         $page = Document\Page::getById($request->get('id'));
   118|         if (!$page) {
   119|             throw $this->createNotFoundException('Page not found');
   120|         }
   121|         /** @var Document\Page|null $pageSession */
   122|         $pageSession = $this->getFromSession($page);
   123|         if ($pageSession) {
   124|             $page = $pageSession;
   125|         } else {
   126|             /** @var Document\Page $page */
   127|             $page = $this->getLatestVersion($page);
   128|         }
   129|         $page->setUserModification($this->getAdminUser()->getId());
   130|         if ($request->get('missingRequiredEditable') !== null) {
   131|             $page->setMissingRequiredEditable(($request->get('missingRequiredEditable') == 'true') ? true : false);
   132|         }
   133|         $settings = [];
   134|         if ($request->get('settings')) {
   135|             $settings = $this->decodeJson($request->get('settings'));
   136|             if ($settings['published'] ?? false) {
   137|                 $page->setMissingRequiredEditable(null);
   138|             }
   139|         }
   140|         if ($request->get('settings') && is_array($settings)) {
   141|             $metaData = [];
   142|             for ($i = 1; $i < 30; $i++) {
   143|                 if (array_key_exists('metadata_' . $i, $settings)) {
   144|                     $metaData[] = $settings['metadata_' . $i];
   145|                 }
   146|             }
   147|             $page->setMetaData($metaData);
   148|         }
   149|         if (($request->get('task') == 'publish' && $page->isAllowed('publish')) || ($request->get('task') == 'unpublish' && $page->isAllowed('unpublish'))) {
   150|             $this->setValuesToDocument($request, $page);
   151|             if ($request->get('task') == 'unpublish') {
   152|                 $page->setPublished(false);
   153|             } elseif ($request->get('task') == 'publish') {
   154|                 $page->setPublished(true);
   155|             }
   156|             $page->save();
   157|             $this->saveToSession($page);
   158|             $treeData = $this->getTreeNodeConfig($page);
   159|             $this->handleTask($request->get('task'), $page);
   160|             return $this->adminJson([
   161|                 'success' => true,
   162|                 'treeData' => $treeData,
   163|                 'data' => [
   164|                     'versionDate' => $page->getModificationDate(),
   165|                     'versionCount' => $page->getVersionCount(),
   166|                 ],
   167|             ]);
   168|         } elseif ($page->isAllowed('save')) {
   169|             $this->setValuesToDocument($request, $page);
   170|             $version = $page->saveVersion(true, true, null, $request->get('task') == 'autoSave');
   171|             $this->saveToSession($page);
   172|             $draftData = [
   173|                 'id' => $version->getId(),
   174|                 'modificationDate' => $version->getDate(),
   175|             ];
   176|             $treeData = $this->getTreeNodeConfig($page);
   177|             $this->handleTask($request->get('task'), $page);
   178|             return $this->adminJson(['success' => true, 'treeData' => $treeData, 'draft' => $draftData]);
   179|         } else {
   180|             throw $this->createAccessDeniedHttpException();
   181|         }
   182|     }
   183|     /**
   184|      * @Route("/get-list", name="pimcore_admin_document_page_getlist", methods={"GET"})
   185|      *
   186|      * @param Request $request
   187|      *
   188|      * @return JsonResponse
   189|      */
   190|     public function getListAction(Request $request)
   191|     {
   192|         $list = new Document\Listing();
   193|         $list->setCondition('type = ?', ['page']);
   194|         $data = $list->loadIdPathList();
   195|         return $this->adminJson([
   196|             'success' => true,
   197|             'data' => $data,
   198|         ]);
   199|     }
   200|     /**
   201|      * @Route("/generate-screenshot", name="pimcore_admin_document_page_generatescreenshot", methods={"POST"})
   202|      *
   203|      * @param Request $request
   204|      *
   205|      * @return JsonResponse
   206|      */
   207|     public function generateScreenshotAction(Request $request)
   208|     {
   209|         $success = false;
   210|         if ($request->get('id')) {
   211|             try {
   212|                 $success = Document\Service::generatePagePreview($request->get('id'), $request);
   213|             } catch (\Exception $e) {
   214|                 Logger::err($e);
   215|             }
   216|         }
   217|         return $this->adminJson(['success' => $success]);
   218|     }
   219|     /**
   220|      * @Route("/display-preview-image", name="pimcore_admin_page_display_preview_image", methods={"GET"})
   221|      *
   222|      * @param Request $request
   223|      *
   224|      * @return BinaryFileResponse
   225|      */
   226|     public function displayPreviewImageAction(Request $request)
   227|     {
   228|         $document = Document\Page::getById($request->get('id'));
   229|         if ($document instanceof Document\Page) {
   230|             return new BinaryFileResponse($document->getPreviewImageFilesystemPath((bool) $request->get('hdpi')), 200, ['Content-Type' => 'image/jpg']);
   231|         }
   232|         throw $this->createNotFoundException('Page not found');
   233|     }
   234|     /**
   235|      * @Route("/check-pretty-url", name="pimcore_admin_document_page_checkprettyurl", methods={"POST"})
   236|      *
   237|      * @param Request $request
   238|      *
   239|      * @return JsonResponse
   240|      */
   241|     public function checkPrettyUrlAction(Request $request)
   242|     {
   243|         $docId = $request->get('id');
   244|         $path = (string) trim($request->get('path'));
   245|         $success = true;
   246|         if ($path === '') {
   247|             return $this->adminJson([
   248|                 'success' => $success,
   249|             ]);
   250|         }
   251|         $message = [];
   252|         $path = rtrim($path, '/');
   253|         if ($path !== '' && strpos($path, '/') !== 0) {
   254|             $success = false;
   255|             $message[] = 'URL must start with /.';
   256|         }
   257|         if (strlen($path) < 2) {
   258|             $success = false;
   259|             $message[] = 'URL must be at least 2 characters long.';
   260|         }
   261|         if (!Element\Service::isValidPath($path, 'document')) {
   262|             $success = false;
   263|             $message[] = 'URL is invalid.';
   264|         }
   265|         $list = new Document\Listing();
   266|         $list->setCondition('(CONCAT(path, `key`) = ? OR id IN (SELECT id from documents_page WHERE prettyUrl = ?))
   267|             AND id != ?', [
   268|             $path, $path, $docId,
   269|         ]);
   270|         if ($list->getTotalCount() > 0) {
   271|             $success = false;
   272|             $message[] = 'URL path already exists.';
   273|         }
   274|         return $this->adminJson([
   275|             'success' => $success,
   276|             'message' => implode('<br>', $message),
   277|         ]);
   278|     }
   279|     /**
   280|      * @Route("/clear-editable-data", name="pimcore_admin_document_page_cleareditabledata", methods={"PUT"})
   281|      *
   282|      * @param Request $request
   283|      *
   284|      * @return JsonResponse
   285|      */
   286|     public function clearEditableDataAction(Request $request)
   287|     {
   288|         $targetGroupId = $request->get('targetGroup');
   289|         $docId = $request->get('id');
   290|         $doc = Document\PageSnippet::getById($docId);
   291|         if (!$doc) {
   292|             throw $this->createNotFoundException('Document not found');
   293|         }
   294|         foreach ($doc->getEditables() as $editable) {
   295|             if ($targetGroupId && $doc instanceof TargetingDocumentInterface) {
   296|                 if (preg_match('/^' . preg_quote($doc->getTargetGroupEditablePrefix($targetGroupId), '/') . '/', $editable->getName())) {
   297|                     $doc->removeEditable($editable->getName());
   298|                 }
   299|             } else {
   300|                 if (!preg_match('/^' . preg_quote(TargetingDocumentInterface::TARGET_GROUP_EDITABLE_PREFIX, '/') . '/', $editable->getName())) {
   301|                     $doc->removeEditable($editable->getName());
   302|                 }
   303|             }
   304|         }
   305|         $this->saveToSession($doc, true);
   306|         return $this->adminJson([
   307|             'success' => true,
   308|         ]);
   309|     }
   310|     /**
   311|      * @Route("/qr-code", name="pimcore_admin_document_page_qrcode", methods={"GET"})
   312|      *
   313|      * @param Request $request
   314|      *
   315|      * @return BinaryFileResponse
   316|      */
   317|     public function qrCodeAction(Request $request)
   318|     {
   319|         $page = Document\Page::getById($request->query->get('id'));
   320|         if (!$page) {
   321|             throw $this->createNotFoundException('Page not found');
   322|         }
   323|         $url = $request->getScheme() . '://' . $request->getHttpHost() . $page->getFullPath();
   324|         $code = new \Endroid\QrCode\QrCode;
   325|         $code->setWriterByName('png');
   326|         $code->setText($url);
   327|         $code->setSize(500);
   328|         $tmpFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/qr-code-' . uniqid() . '.png';
   329|         $code->writeFile($tmpFile);
   330|         $response = new BinaryFileResponse($tmpFile);
   331|         $response->headers->set('Content-Type', 'image/png');
   332|         if ($request->query->get('download')) {
   333|             $code->setSize(4000);
   334|             $response->setContentDisposition('attachment', 'qrcode-preview.png');
   335|         }
   336|         $response->deleteFileAfterSend(true);
   337|         return $response;
   338|     }
   339|     /**
   340|      * @Route("/areabrick-render-index-editmode", name="pimcore_admin_document_page_areabrick-render-index-editmode", methods={"POST"})
   341|      *
   342|      * @param Request $request
   343|      * @param BlockStateStack $blockStateStack
   344|      * @param EditmodeEditableDefinitionCollector $definitionCollector
   345|      * @param Environment $twig
   346|      * @param EditableRenderer $editableRenderer
   347|      *
   348|      * @return JsonResponse
   349|      */
   350|     public function areabrickRenderIndexEditmode(
   351|         Request $request,
   352|         BlockStateStack $blockStateStack,
   353|         EditmodeEditableDefinitionCollector $definitionCollector,
   354|         Environment $twig,
   355|         EditableRenderer $editableRenderer
   356|     ) {
   357|         $blockStateStackData = json_decode($request->get('blockStateStack'), true);
   358|         $blockStateStack->loadArray($blockStateStackData);
   359|         $document = Document\PageSnippet::getById($request->get('documentId'));
   360|         $twig->addGlobal('document', $document);
   361|         $twig->addGlobal('editmode', true);
   362|         $request->attributes->set(EditmodeResolver::ATTRIBUTE_EDITMODE, true);
   363|         $areaBlockConfig = json_decode($request->get('areablockConfig'), true);
   364|         /** @var Document\Editable\Areablock $areablock */
   365|         $areablock = $editableRenderer->getEditable($document, 'areablock', $request->get('realName'), $areaBlockConfig, true);
   366|         $areablock->setRealName($request->get('realName'));
   367|         $areablock->setEditmode(true);
   368|         $areaBrickData = json_decode($request->get('areablockData'), true);
   369|         $areablock->setDataFromEditmode($areaBrickData);
   370|         $htmlCode = trim($areablock->renderIndex($request->get('index'), true));
   371|         return new JsonResponse([
   372|             'editableDefinitions' => $definitionCollector->getDefinitions(),
   373|             'htmlCode' => $htmlCode,
   374|         ]);
   375|     }
   376|     /**
   377|      * @param Request $request
   378|      * @param Document $page
   379|      */
   380|     protected function setValuesToDocument(Request $request, Document $page)
   381|     {
   382|         $this->addSettingsToDocument($request, $page);
   383|         $this->addDataToDocument($request, $page);
   384|         $this->addPropertiesToDocument($request, $page);
   385|         $this->applySchedulerDataToElement($request, $page);
   386|     }
   387| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/PrintcontainerController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-124 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Config;
    16| use Symfony\Component\HttpFoundation\Request;
    17| use Symfony\Component\Routing\Annotation\Route;
    18| /**
    19|  * @Route("/printcontainer")
    20|  *
    21|  * @internal
    22|  */
    23| class PrintcontainerController extends PrintpageControllerBase
    24| {
    25|     /**
    26|      * @Route("/save-to-session", name="pimcore_admin_document_printcontainer_savetosession", methods={"POST"})
    27|      *
    28|      * {@inheritDoc}
    29|      */
    30|     public function saveToSessionAction(Request $request)
    31|     {
    32|         return parent::saveToSessionAction($request);
    33|     }
    34|     /**
    35|      * @Route("/remove-from-session", name="pimcore_admin_document_printcontainer_removefromsession", methods={"DELETE"})
    36|      *
    37|      * {@inheritDoc}
    38|      */
    39|     public function removeFromSessionAction(Request $request)
    40|     {
    41|         return parent::removeFromSessionAction($request);
    42|     }
    43|     /**
    44|      * @Route("/change-master-document", name="pimcore_admin_document_printcontainer_changemasterdocument", methods={"PUT"})
    45|      *
    46|      * {@inheritDoc}
    47|      */
    48|     public function changeMasterDocumentAction(Request $request)
    49|     {
    50|         return parent::changeMasterDocumentAction($request);
    51|     }
    52|     /**
    53|      * @Route("/get-data-by-id", name="pimcore_admin_document_printcontainer_getdatabyid", methods={"GET"})
    54|      *
    55|      * {@inheritDoc}
    56|      */
    57|     public function getDataByIdAction(Request $request)
    58|     {
    59|         return parent::getDataByIdAction($request);
    60|     }
    61|     /**
    62|      * @Route("/save", name="pimcore_admin_document_printcontainer_save", methods={"PUT", "POST"})
    63|      *
    64|      * {@inheritDoc}
    65|      */
    66|     public function saveAction(Request $request)
    67|     {
    68|         return parent::saveAction($request);
    69|     }
    70|     /**
    71|      * @Route("/active-generate-process", name="pimcore_admin_document_printcontainer_activegenerateprocess", methods={"POST"})
    72|      *
    73|      * {@inheritDoc}
    74|      */
    75|     public function activeGenerateProcessAction(Request $request)
    76|     {
    77|         return parent::activeGenerateProcessAction($request);
    78|     }
    79|     /**
    80|      * @Route("/pdf-download", name="pimcore_admin_document_printcontainer_pdfdownload", methods={"GET"})
    81|      *
    82|      * {@inheritDoc}
    83|      */
    84|     public function pdfDownloadAction(Request $request)
    85|     {
    86|         return parent::pdfDownloadAction($request);
    87|     }
    88|     /**
    89|      * @Route("/start-pdf-generation", name="pimcore_admin_document_printcontainer_startpdfgeneration", methods={"POST"})
    90|      *
    91|      * {@inheritDoc}
    92|      */
    93|     public function startPdfGenerationAction(Request $request, Config $config)
    94|     {
    95|         return parent::startPdfGenerationAction($request, $config);
    96|     }
    97|     /**
    98|      * @Route("/check-pdf-dirty", name="pimcore_admin_document_printcontainer_checkpdfdirty", methods={"GET"})
    99|      *
   100|      * {@inheritDoc}
   101|      */
   102|     public function checkPdfDirtyAction(Request $request)
   103|     {
   104|         return parent::checkPdfDirtyAction($request);
   105|     }
   106|     /**
   107|      * @Route("/get-processing-options", name="pimcore_admin_document_printcontainer_getprocessingoptions", methods={"GET"})
   108|      *
   109|      * {@inheritDoc}
   110|      */
   111|     public function getProcessingOptionsAction(Request $request)
   112|     {
   113|         return parent::getProcessingOptionsAction($request);
   114|     }
   115|     /**
   116|      * @Route("/cancel-generation", name="pimcore_admin_document_printcontainer_cancelgeneration", methods={"DELETE"})
   117|      *
   118|      * {@inheritDoc}
   119|      */
   120|     public function cancelGenerationAction(Request $request)
   121|     {
   122|         return parent::cancelGenerationAction($request);
   123|     }
   124| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/PrintpageController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-124 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Config;
    16| use Symfony\Component\HttpFoundation\Request;
    17| use Symfony\Component\Routing\Annotation\Route;
    18| /**
    19|  * @Route("/printpage")
    20|  *
    21|  * @internal
    22|  */
    23| class PrintpageController extends PrintpageControllerBase
    24| {
    25|     /**
    26|      * @Route("/save-to-session", name="pimcore_admin_document_printpage_savetosession", methods={"POST"})
    27|      *
    28|      * {@inheritDoc}
    29|      */
    30|     public function saveToSessionAction(Request $request)
    31|     {
    32|         return parent::saveToSessionAction($request);
    33|     }
    34|     /**
    35|      * @Route("/remove-from-session", name="pimcore_admin_document_printpage_removefromsession", methods={"DELETE"})
    36|      *
    37|      * {@inheritDoc}
    38|      */
    39|     public function removeFromSessionAction(Request $request)
    40|     {
    41|         return parent::removeFromSessionAction($request);
    42|     }
    43|     /**
    44|      * @Route("/change-master-document", name="pimcore_admin_document_printpage_changemasterdocument", methods={"PUT"})
    45|      *
    46|      * {@inheritDoc}
    47|      */
    48|     public function changeMasterDocumentAction(Request $request)
    49|     {
    50|         return parent::changeMasterDocumentAction($request);
    51|     }
    52|     /**
    53|      * @Route("/get-data-by-id", name="pimcore_admin_document_printpage_getdatabyid", methods={"GET"})
    54|      *
    55|      * {@inheritDoc}
    56|      */
    57|     public function getDataByIdAction(Request $request)
    58|     {
    59|         return parent::getDataByIdAction($request);
    60|     }
    61|     /**
    62|      * @Route("/save", name="pimcore_admin_document_printpage_save", methods={"PUT", "POST"})
    63|      *
    64|      * {@inheritDoc}
    65|      */
    66|     public function saveAction(Request $request)
    67|     {
    68|         return parent::saveAction($request);
    69|     }
    70|     /**
    71|      * @Route("/active-generate-process", name="pimcore_admin_document_printpage_activegenerateprocess", methods={"POST"})
    72|      *
    73|      * {@inheritDoc}
    74|      */
    75|     public function activeGenerateProcessAction(Request $request)
    76|     {
    77|         return parent::activeGenerateProcessAction($request);
    78|     }
    79|     /**
    80|      * @Route("/pdf-download", name="pimcore_admin_document_printpage_pdfdownload", methods={"GET"})
    81|      *
    82|      * {@inheritDoc}
    83|      */
    84|     public function pdfDownloadAction(Request $request)
    85|     {
    86|         return parent::pdfDownloadAction($request);
    87|     }
    88|     /**
    89|      * @Route("/start-pdf-generation", name="pimcore_admin_document_printpage_startpdfgeneration", methods={"POST"})
    90|      *
    91|      * {@inheritDoc}
    92|      */
    93|     public function startPdfGenerationAction(Request $request, Config $config)
    94|     {
    95|         return parent::startPdfGenerationAction($request, $config);
    96|     }
    97|     /**
    98|      * @Route("/check-pdf-dirty", name="pimcore_admin_document_printpage_checkpdfdirty", methods={"GET"})
    99|      *
   100|      * {@inheritDoc}
   101|      */
   102|     public function checkPdfDirtyAction(Request $request)
   103|     {
   104|         return parent::checkPdfDirtyAction($request);
   105|     }
   106|     /**
   107|      * @Route("/get-processing-options", name="pimcore_admin_document_printpage_getprocessingoptions", methods={"GET"})
   108|      *
   109|      * {@inheritDoc}
   110|      */
   111|     public function getProcessingOptionsAction(Request $request)
   112|     {
   113|         return parent::getProcessingOptionsAction($request);
   114|     }
   115|     /**
   116|      * @Route("/cancel-generation", name="pimcore_admin_document_printpage_cancelgeneration", methods={"DELETE"})
   117|      *
   118|      * {@inheritDoc}
   119|      */
   120|     public function cancelGenerationAction(Request $request)
   121|     {
   122|         return parent::cancelGenerationAction($request);
   123|     }
   124| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/PrintpageControllerBase.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-280 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Config;
    16| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    17| use Pimcore\Model\Document;
    18| use Pimcore\Web2Print\Processor;
    19| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    20| use Symfony\Component\HttpFoundation\JsonResponse;
    21| use Symfony\Component\HttpFoundation\Request;
    22| /**
    23|  * @internal
    24|  */
    25| abstract class PrintpageControllerBase extends DocumentControllerBase
    26| {
    27|     use ElementEditLockHelperTrait;
    28|     /**
    29|      * @param Request $request
    30|      *
    31|      * @return JsonResponse
    32|      */
    33|     public function getDataByIdAction(Request $request)
    34|     {
    35|         $page = Document\PrintAbstract::getById($request->get('id'));
    36|         if (!$page) {
    37|             throw $this->createNotFoundException('Document not found');
    38|         }
    39|         if ($page->isAllowed('save') || $page->isAllowed('publish') || $page->isAllowed('unpublish') || $page->isAllowed('delete')) {
    40|             if (\Pimcore\Model\Element\Editlock::isLocked($request->get('id'), 'document')) {
    41|                 return $this->getEditLockResponse($request->get('id'), 'document');
    42|             }
    43|             \Pimcore\Model\Element\Editlock::lock($request->get('id'), 'document');
    44|         }
    45|         $page = clone $page;
    46|         $draftVersion = null;
    47|         $page = $this->getLatestVersion($page, $draftVersion);
    48|         $page->getVersions();
    49|         $page->getScheduledTasks();
    50|         $page->setLocked($page->isLocked());
    51|         $page->setEditables(null);
    52|         $page->setChildren(null);
    53|         $data = $page->getObjectVars();
    54|         $this->addTranslationsData($page, $data);
    55|         $this->minimizeProperties($page, $data);
    56|         $data['url'] = $page->getUrl();
    57|         if ($page->getContentMasterDocument()) {
    58|             $data['contentMasterDocumentPath'] = $page->getContentMasterDocument()->getRealFullPath();
    59|         }
    60|         $this->preSendDataActions($data, $page, $draftVersion);
    61|         if ($page->isAllowed('view')) {
    62|             return $this->adminJson($data);
    63|         }
    64|         throw $this->createAccessDeniedHttpException();
    65|     }
    66|     /**
    67|      * @param Request $request
    68|      *
    69|      * @return JsonResponse
    70|      */
    71|     public function saveAction(Request $request)
    72|     {
    73|         $page = Document\PrintAbstract::getById($request->get('id'));
    74|         if (!$page) {
    75|             throw $this->createNotFoundException('Document not found');
    76|         }
    77|         $page = $this->getLatestVersion($page);
    78|         $page->setUserModification($this->getAdminUser()->getId());
    79|         $key = 'document_' . $request->get('id');
    80|         Document\Service::saveElementToSession($page);
    81|         if ($request->get('task') == 'unpublish') {
    82|             $page->setPublished(false);
    83|         }
    84|         if ($request->get('task') == 'publish') {
    85|             $page->setPublished(true);
    86|         }
    87|         if (($request->get('task') == 'publish' && $page->isAllowed('publish')) || ($request->get('task') == 'unpublish' && $page->isAllowed('unpublish'))) {
    88|             $config = Config::getWeb2PrintConfig();
    89|             if ($config->get('generalDocumentSaveMode') == 'cleanup') {
    90|                 $page->setEditables([]);
    91|             }
    92|             $this->setValuesToDocument($request, $page);
    93|             $page->save();
    94|             $treeData = $this->getTreeNodeConfig($page);
    95|             $this->handleTask($request->get('task'), $page);
    96|             return $this->adminJson([
    97|                 'success' => true,
    98|                 'data' => [
    99|                     'versionDate' => $page->getModificationDate(),
   100|                     'versionCount' => $page->getVersionCount(),
   101|                 ],
   102|                 'treeData' => $treeData,
   103|             ]);
   104|         } elseif ($page->isAllowed('save')) {
   105|             $this->setValuesToDocument($request, $page);
   106|             $version = $page->saveVersion(true, true, null, $request->get('task') == 'autoSave');
   107|             $draftData = [
   108|                 'id' => $version->getId(),
   109|                 'modificationDate' => $version->getDate(),
   110|             ];
   111|             $this->handleTask($request->get('task'), $page);
   112|             return $this->adminJson(['success' => true, 'draft' => $draftData]);
   113|         } else {
   114|             throw $this->createAccessDeniedHttpException();
   115|         }
   116|     }
   117|     /**
   118|      * @param Request $request
   119|      * @param Document\PrintAbstract $page
   120|      */
   121|     protected function setValuesToDocument(Request $request, Document $page)
   122|     {
   123|         $this->addSettingsToDocument($request, $page);
   124|         $this->addDataToDocument($request, $page);
   125|         $this->addPropertiesToDocument($request, $page);
   126|     }
   127|     /**
   128|      * @param Request $request
   129|      *
   130|      * @return JsonResponse
   131|      *
   132|      * @throws \Exception
   133|      */
   134|     public function activeGenerateProcessAction(Request $request)
   135|     {
   136|         $document = Document\PrintAbstract::getById((int)$request->get('id'));
   137|         if (!$document) {
   138|             throw $this->createNotFoundException('Document with id ' . $request->get('id') . ' not found.');
   139|         }
   140|         $date = $document->getLastGeneratedDate();
   141|         if ($date) {
   142|             $date = $date->format('Y-m-d H:i');
   143|         }
   144|         $inProgress = $document->getInProgress();
   145|         $statusUpdate = [];
   146|         if ($inProgress) {
   147|             $statusUpdate = Processor::getInstance()->getStatusUpdate($document->getId());
   148|         }
   149|         return $this->adminJson([
   150|             'activeGenerateProcess' => !empty($inProgress),
   151|             'date' => $date,
   152|             'message' => $document->getLastGenerateMessage(),
   153|             'downloadAvailable' => file_exists($document->getPdfFileName()),
   154|             'statusUpdate' => $statusUpdate,
   155|         ]);
   156|     }
   157|     /**
   158|      * @param Request $request
   159|      *
   160|      * @throws \Exception
   161|      *
   162|      * @return BinaryFileResponse
   163|      */
   164|     public function pdfDownloadAction(Request $request)
   165|     {
   166|         $document = Document\PrintAbstract::getById((int)$request->get('id'));
   167|         if (!$document) {
   168|             throw $this->createNotFoundException('Document with id ' . $request->get('id') . ' not found.');
   169|         }
   170|         if (file_exists($document->getPdfFileName())) {
   171|             $response = new BinaryFileResponse($document->getPdfFileName());
   172|             $response->headers->set('Content-Type', 'application/pdf');
   173|             if ($request->get('download')) {
   174|                 $response->setContentDisposition('attachment', $document->getKey() . '.pdf');
   175|             }
   176|             return $response;
   177|         } else {
   178|             throw $this->createNotFoundException('File does not exist');
   179|         }
   180|     }
   181|     /**
   182|      * @param Request $request
   183|      * @param Config $config
   184|      *
   185|      * @return JsonResponse
   186|      *
   187|      * @throws \Exception
   188|      */
   189|     public function startPdfGenerationAction(Request $request, Config $config)
   190|     {
   191|         $allParams = json_decode($request->getContent(), true);
   192|         $document = Document\PrintAbstract::getById($allParams['id']);
   193|         if (!$document) {
   194|             throw $this->createNotFoundException('Document with id ' . $allParams['id'] . ' not found.');
   195|         }
   196|         if (empty($allParams['hostName'] = $config['general']['domain'])) {
   197|             $allParams['hostName'] = $_SERVER['HTTP_HOST'];
   198|         }
   199|         $https = $_SERVER['HTTPS'] ?? 'off';
   200|         $allParams['protocol'] = $https === 'on' ? 'https' : 'http';
   201|         $pdf = $document->getPdfFileName();
   202|         if (is_file($pdf)) {
   203|             unlink($pdf);
   204|         }
   205|         $result = $document->generatePdf($allParams);
   206|         $this->saveProcessingOptions($document->getId(), $allParams);
   207|         return $this->adminJson(['success' => $result]);
   208|     }
   209|     /**
   210|      * @param Request $request
   211|      *
   212|      * @return JsonResponse
   213|      */
   214|     public function checkPdfDirtyAction(Request $request)
   215|     {
   216|         $printDocument = Document\PrintAbstract::getById($request->get('id'));
   217|         $dirty = true;
   218|         if ($printDocument) {
   219|             $dirty = $printDocument->pdfIsDirty();
   220|         }
   221|         return $this->adminJson(['pdfDirty' => $dirty]);
   222|     }
   223|     /**
   224|      * @param Request $request
   225|      *
   226|      * @return JsonResponse
   227|      */
   228|     public function getProcessingOptionsAction(Request $request)
   229|     {
   230|         $options = Processor::getInstance()->getProcessingOptions();
   231|         $returnValue = [];
   232|         $storedValues = $this->getStoredProcessingOptions($request->get('id'));
   233|         foreach ($options as $option) {
   234|             $value = $option['default'];
   235|             if ($storedValues && array_key_exists($option['name'], $storedValues)) {
   236|                 $value = $storedValues[$option['name']];
   237|             }
   238|             $returnValue[] = [
   239|                 'name' => $option['name'],
   240|                 'label' => $option['name'],
   241|                 'value' => $value,
   242|                 'type' => $option['type'],
   243|                 'values' => isset($option['values']) ? $option['values'] : null,
   244|             ];
   245|         }
   246|         return $this->adminJson(['options' => $returnValue]);
   247|     }
   248|     /**
   249|      * @param int $documentId
   250|      *
   251|      * @return array|mixed
   252|      */
   253|     private function getStoredProcessingOptions($documentId)
   254|     {
   255|         $filename = PIMCORE_SYSTEM_TEMP_DIRECTORY . DIRECTORY_SEPARATOR . 'web2print-processingoptions-' . $documentId . '_' . $this->getAdminUser()->getId() . '.psf';
   256|         if (file_exists($filename)) {
   257|             return \Pimcore\Tool\Serialize::unserialize(file_get_contents($filename));
   258|         } else {
   259|             return [];
   260|         }
   261|     }
   262|     /**
   263|      * @param int $documentId
   264|      * @param array $options
   265|      */
   266|     private function saveProcessingOptions($documentId, $options)
   267|     {
   268|         file_put_contents(PIMCORE_SYSTEM_TEMP_DIRECTORY . DIRECTORY_SEPARATOR . 'web2print-processingoptions-' . $documentId . '_' . $this->getAdminUser()->getId() . '.psf', \Pimcore\Tool\Serialize::serialize($options));
   269|     }
   270|     /**
   271|      * @param Request $request
   272|      *
   273|      * @return JsonResponse
   274|      */
   275|     public function cancelGenerationAction(Request $request)
   276|     {
   277|         Processor::getInstance()->cancelGeneration((int)$request->get('id'));
   278|         return $this->adminJson(['success' => true]);
   279|     }
   280| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/RenderletController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-112 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\Document\Editable\EditableHandler;
    18| use Pimcore\Localization\LocaleServiceInterface;
    19| use Pimcore\Model\Document;
    20| use Pimcore\Model\Element\ElementInterface;
    21| use Pimcore\Model\Element\Service;
    22| use Pimcore\Model\Tool\Targeting\TargetGroup;
    23| use Pimcore\Templating\Renderer\ActionRenderer;
    24| use Symfony\Cmf\Bundle\RoutingBundle\Routing\DynamicRouter;
    25| use Symfony\Component\HttpFoundation\Request;
    26| use Symfony\Component\HttpFoundation\Response;
    27| use Symfony\Component\Routing\Annotation\Route;
    28| /**
    29|  * @internal
    30|  */
    31| class RenderletController extends AdminController
    32| {
    33|     /**
    34|      * Handles editmode preview for renderlets
    35|      *
    36|      * @Route("/document_tag/renderlet", name="pimcore_admin_document_renderlet_renderlet")
    37|      *
    38|      * @param Request $request
    39|      * @param ActionRenderer $actionRenderer
    40|      * @param EditableHandler $editableHandler
    41|      * @param LocaleServiceInterface $localeService
    42|      *
    43|      * @return Response
    44|      */
    45|     public function renderletAction(
    46|         Request $request,
    47|         ActionRenderer $actionRenderer,
    48|         EditableHandler $editableHandler,
    49|         LocaleServiceInterface $localeService
    50|     ) {
    51|         $query = $request->query->all();
    52|         $attributes = [];
    53|         $element = $this->loadElement($request);
    54|         $this->configureElementTargeting($request, $element);
    55|         $controller = $request->get('controller');
    56|         $action = $request->get('action');
    57|         $moduleOrBundle = null;
    58|         if ($request->get('bundle')) {
    59|             $moduleOrBundle = $request->get('bundle');
    60|         } elseif ($request->get('module')) {
    61|             $moduleOrBundle = $request->get('bundle');
    62|         }
    63|         if ($document = $request->get('pimcore_parentDocument')) {
    64|             $document = Document\PageSnippet::getById($document);
    65|             if ($document) {
    66|                 $attributes = $actionRenderer->addDocumentAttributes($document, $attributes);
    67|                 unset($attributes[DynamicRouter::CONTENT_TEMPLATE]);
    68|             }
    69|         }
    70|         if ($template = $request->get('template')) {
    71|             $attributes[DynamicRouter::CONTENT_TEMPLATE] = $template;
    72|         }
    73|         foreach (['controller', 'action', 'module', 'bundle'] as $key) {
    74|             if (isset($query[$key])) {
    75|                 unset($query[$key]);
    76|             }
    77|         }
    78|         if (isset($attributes['_locale'])) {
    79|             $localeService->setLocale($attributes['_locale']);
    80|         }
    81|         $result = $editableHandler->renderAction($controller, $attributes, $query);
    82|         return new Response($result);
    83|     }
    84|     private function loadElement(Request $request): ElementInterface
    85|     {
    86|         $element = null;
    87|         $id = $request->get('id');
    88|         $type = $request->get('type');
    89|         if ($id && $type) {
    90|             $element = Service::getElementById($type, (int)$id);
    91|         }
    92|         if (!$element instanceof ElementInterface) {
    93|             throw $this->createNotFoundException(sprintf('Element with type %s and ID %d was not found', $type ?: 'null', $id ?: 'null'));
    94|         }
    95|         if (!$element->isAllowed('view')) {
    96|             throw $this->createAccessDeniedException(sprintf('Access to element with type %s and ID %d is not allowed', $type, $id));
    97|         }
    98|         return $element;
    99|     }
   100|     private function configureElementTargeting(Request $request, ElementInterface $element)
   101|     {
   102|         if (!$element instanceof Document\Targeting\TargetingDocumentInterface) {
   103|             return;
   104|         }
   105|         if ($request->get('_ptg')) {
   106|             $targetGroup = TargetGroup::getById((int)$request->get('_ptg'));
   107|             if ($targetGroup) {
   108|                 $element->setUseTargetGroup($targetGroup->getId());
   109|             }
   110|         }
   111|     }
   112| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/Document/SnippetController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-165 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\Document;
    15| use Pimcore\Controller\Traits\ElementEditLockHelperTrait;
    16| use Pimcore\Model\Document;
    17| use Pimcore\Model\Element;
    18| use Symfony\Component\HttpFoundation\JsonResponse;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| /**
    22|  * @Route("/snippet")
    23|  *
    24|  * @internal
    25|  */
    26| class SnippetController extends DocumentControllerBase
    27| {
    28|     use ElementEditLockHelperTrait;
    29|     /**
    30|      * @Route("/save-to-session", name="pimcore_admin_document_snippet_savetosession", methods={"POST"})
    31|      *
    32|      * {@inheritDoc}
    33|      */
    34|     public function saveToSessionAction(Request $request)
    35|     {
    36|         return parent::saveToSessionAction($request);
    37|     }
    38|     /**
    39|      * @Route("/remove-from-session", name="pimcore_admin_document_snippet_removefromsession", methods={"DELETE"})
    40|      *
    41|      * {@inheritDoc}
    42|      */
    43|     public function removeFromSessionAction(Request $request)
    44|     {
    45|         return parent::removeFromSessionAction($request);
    46|     }
    47|     /**
    48|      * @Route("/change-master-document", name="pimcore_admin_document_snippet_changemasterdocument", methods={"PUT"})
    49|      *
    50|      * {@inheritDoc}
    51|      */
    52|     public function changeMasterDocumentAction(Request $request)
    53|     {
    54|         return parent::changeMasterDocumentAction($request);
    55|     }
    56|     /**
    57|      * @Route("/get-data-by-id", name="pimcore_admin_document_snippet_getdatabyid", methods={"GET"})
    58|      *
    59|      * @param Request $request
    60|      *
    61|      * @return JsonResponse
    62|      */
    63|     public function getDataByIdAction(Request $request)
    64|     {
    65|         $snippet = Document\Snippet::getById($request->get('id'));
    66|         if (!$snippet) {
    67|             throw $this->createNotFoundException('Snippet not found');
    68|         }
    69|         if ($snippet->isAllowed('save') || $snippet->isAllowed('publish') || $snippet->isAllowed('unpublish') || $snippet->isAllowed('delete')) {
    70|             if (Element\Editlock::isLocked($request->get('id'), 'document')) {
    71|                 return $this->getEditLockResponse($request->get('id'), 'document');
    72|             }
    73|             Element\Editlock::lock($request->get('id'), 'document');
    74|         }
    75|         $snippet = clone $snippet;
    76|         $draftVersion = null;
    77|         $snippet = $this->getLatestVersion($snippet, $draftVersion);
    78|         $versions = Element\Service::getSafeVersionInfo($snippet->getVersions());
    79|         $snippet->setVersions(array_splice($versions, -1, 1));
    80|         $snippet->getScheduledTasks();
    81|         $snippet->setLocked($snippet->isLocked());
    82|         $snippet->setParent(null);
    83|         $snippet->setEditables(null);
    84|         $data = $snippet->getObjectVars();
    85|         $this->addTranslationsData($snippet, $data);
    86|         $this->minimizeProperties($snippet, $data);
    87|         $data['url'] = $snippet->getUrl();
    88|         if ($snippet->getContentMasterDocument()) {
    89|             $data['contentMasterDocumentPath'] = $snippet->getContentMasterDocument()->getRealFullPath();
    90|         }
    91|         $this->preSendDataActions($data, $snippet, $draftVersion);
    92|         if ($snippet->isAllowed('view')) {
    93|             return $this->adminJson($data);
    94|         }
    95|         throw $this->createAccessDeniedHttpException();
    96|     }
    97|     /**
    98|      * @Route("/save", name="pimcore_admin_document_snippet_save", methods={"POST","PUT"})
    99|      *
   100|      * @param Request $request
   101|      *
   102|      * @return JsonResponse
   103|      *
   104|      * @throws \Exception
   105|      */
   106|     public function saveAction(Request $request)
   107|     {
   108|         $snippet = Document\Snippet::getById($request->get('id'));
   109|         if (!$snippet) {
   110|             throw $this->createNotFoundException('Snippet not found');
   111|         }
   112|         /** @var Document\Snippet|null $snippetSession */
   113|         $snippetSession = $this->getFromSession($snippet);
   114|         if ($snippetSession) {
   115|             $snippet = $snippetSession;
   116|         } else {
   117|             $snippet = $this->getLatestVersion($snippet);
   118|         }
   119|         $snippet->setUserModification($this->getAdminUser()->getId());
   120|         if ($request->get('task') == 'unpublish') {
   121|             $snippet->setPublished(false);
   122|         }
   123|         if ($request->get('task') == 'publish') {
   124|             $snippet->setPublished(true);
   125|         }
   126|         if (($request->get('task') == 'publish' && $snippet->isAllowed('publish')) || ($request->get('task') == 'unpublish' && $snippet->isAllowed('unpublish'))) {
   127|             $this->setValuesToDocument($request, $snippet);
   128|             $snippet->save();
   129|             $this->saveToSession($snippet);
   130|             $treeData = $this->getTreeNodeConfig($snippet);
   131|             $this->handleTask($request->get('task'), $snippet);
   132|             return $this->adminJson([
   133|                 'success' => true,
   134|                 'data' => [
   135|                     'versionDate' => $snippet->getModificationDate(),
   136|                     'versionCount' => $snippet->getVersionCount(),
   137|                 ],
   138|                 'treeData' => $treeData,
   139|             ]);
   140|         } elseif ($snippet->isAllowed('save')) {
   141|             $this->setValuesToDocument($request, $snippet);
   142|             $version = $snippet->saveVersion(true, true, null, $request->get('task') == 'autoSave');
   143|             $this->saveToSession($snippet);
   144|             $draftData = [
   145|                 'id' => $version->getId(),
   146|                 'modificationDate' => $version->getDate(),
   147|             ];
   148|             $this->handleTask($request->get('task'), $snippet);
   149|             return $this->adminJson(['success' => true, 'draft' => $draftData]);
   150|         } else {
   151|             throw $this->createAccessDeniedHttpException();
   152|         }
   153|     }
   154|     /**
   155|      * @param Request $request
   156|      * @param Document $snippet
   157|      */
   158|     protected function setValuesToDocument(Request $request, Document $snippet)
   159|     {
   160|         $this->addSettingsToDocument($request, $snippet);
   161|         $this->addDataToDocument($request, $snippet);
   162|         $this->applySchedulerDataToElement($request, $snippet);
   163|         $this->addPropertiesToDocument($request, $snippet);
   164|     }
   165| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/ElementController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-801 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Bundle\AdminBundle\DependencyInjection\PimcoreAdminExtension;
    17| use Pimcore\Db;
    18| use Pimcore\Event\AdminEvents;
    19| use Pimcore\Event\Model\ResolveElementEvent;
    20| use Pimcore\Logger;
    21| use Pimcore\Model;
    22| use Pimcore\Model\Asset;
    23| use Pimcore\Model\DataObject;
    24| use Pimcore\Model\Document;
    25| use Pimcore\Model\Element;
    26| use Pimcore\Model\Version;
    27| use Symfony\Component\HttpFoundation\JsonResponse;
    28| use Symfony\Component\HttpFoundation\Request;
    29| use Symfony\Component\HttpFoundation\Response;
    30| use Symfony\Component\Routing\Annotation\Route;
    31| /**
    32|  *
    33|  * @internal
    34|  */
    35| class ElementController extends AdminController
    36| {
    37|     /**
    38|      * @Route("/element/lock-element", name="pimcore_admin_element_lockelement", methods={"PUT"})
    39|      *
    40|      * @param Request $request
    41|      *
    42|      * @return Response
    43|      */
    44|     public function lockElementAction(Request $request)
    45|     {
    46|         Element\Editlock::lock($request->get('id'), $request->get('type'));
    47|         return $this->adminJson(['success' => true]);
    48|     }
    49|     /**
    50|      * @Route("/element/unlock-element", name="pimcore_admin_element_unlockelement", methods={"PUT"})
    51|      *
    52|      * @param Request $request
    53|      *
    54|      * @return Response
    55|      */
    56|     public function unlockElementAction(Request $request)
    57|     {
    58|         Element\Editlock::unlock($request->get('id'), $request->get('type'));
    59|         return $this->adminJson(['success' => true]);
    60|     }
    61|     /**
    62|      * Returns the element data denoted by the given type and ID or path.
    63|      *
    64|      * @Route("/element/get-subtype", name="pimcore_admin_element_getsubtype", methods={"GET"})
    65|      *
    66|      * @param Request $request
    67|      *
    68|      * @return JsonResponse
    69|      */
    70|     public function getSubtypeAction(Request $request)
    71|     {
    72|         $idOrPath = trim($request->get('id'));
    73|         $type = $request->get('type');
    74|         $event = new ResolveElementEvent($type, $idOrPath);
    75|         \Pimcore::getEventDispatcher()->dispatch($event, AdminEvents::RESOLVE_ELEMENT);
    76|         $idOrPath = $event->getId();
    77|         $type = $event->getType();
    78|         if (is_numeric($idOrPath)) {
    79|             $el = Element\Service::getElementById($type, (int) $idOrPath);
    80|         } else {
    81|             if ($type == 'document') {
    82|                 $el = Document\Service::getByUrl($idOrPath);
    83|             } else {
    84|                 $el = Element\Service::getElementByPath($type, $idOrPath);
    85|             }
    86|         }
    87|         if ($el) {
    88|             $subtype = null;
    89|             if ($el instanceof Asset || $el instanceof Document) {
    90|                 $subtype = $el->getType();
    91|             } elseif ($el instanceof DataObject\Concrete) {
    92|                 $subtype = $el->getClassName();
    93|             } elseif ($el instanceof DataObject\Folder) {
    94|                 $subtype = 'folder';
    95|             }
    96|             return $this->adminJson([
    97|                 'subtype' => $subtype,
    98|                 'id' => $el->getId(),
    99|                 'type' => $type,
   100|                 'success' => true,
   101|             ]);
   102|         } else {
   103|             return $this->adminJson([
   104|                 'success' => false,
   105|             ]);
   106|         }
   107|     }
   108|     /**
   109|      * @param string $parameterName
   110|      *
   111|      * @return \Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse
   112|      */
   113|     protected function processNoteTypesFromParameters(string $parameterName)
   114|     {
   115|         $config = $this->getParameter($parameterName);
   116|         $result = [];
   117|         foreach ($config as $configEntry) {
   118|             $result[] = [
   119|                 'name' => $configEntry,
   120|             ];
   121|         }
   122|         return $this->adminJson(['noteTypes' => $result]);
   123|     }
   124|     /**
   125|      * @Route("/element/note-types", name="pimcore_admin_element_notetypes", methods={"GET"})
   126|      *
   127|      * @param Request $request
   128|      *
   129|      * @return JsonResponse
   130|      */
   131|     public function noteTypes(Request $request)
   132|     {
   133|         switch ($request->get('ctype')) {
   134|             case 'document':
   135|                 return $this->processNoteTypesFromParameters(PimcoreAdminExtension::PARAM_DOCUMENTS_NOTES_EVENTS_TYPES);
   136|             case 'asset':
   137|                 return $this->processNoteTypesFromParameters(PimcoreAdminExtension::PARAM_ASSETS_NOTES_EVENTS_TYPES);
   138|             case 'object':
   139|                 return $this->processNoteTypesFromParameters(PimcoreAdminExtension::PARAM_DATAOBJECTS_NOTES_EVENTS_TYPES);
   140|             default:
   141|                 return $this->adminJson(['noteTypes' => []]);
   142|         }
   143|     }
   144|     /**
   145|      * @Route("/element/note-list", name="pimcore_admin_element_notelist", methods={"POST"})
   146|      *
   147|      * @param Request $request
   148|      *
   149|      * @return JsonResponse
   150|      */
   151|     public function noteListAction(Request $request)
   152|     {
   153|         $this->checkPermission('notes_events');
   154|         $list = new Element\Note\Listing();
   155|         $list->setLimit($request->get('limit'));
   156|         $list->setOffset($request->get('start'));
   157|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(array_merge($request->request->all(), $request->query->all()));
   158|         if ($sortingSettings['orderKey'] && $sortingSettings['order']) {
   159|             $list->setOrderKey($sortingSettings['orderKey']);
   160|             $list->setOrder($sortingSettings['order']);
   161|         } else {
   162|             $list->setOrderKey(['date', 'id']);
   163|             $list->setOrder(['DESC', 'DESC']);
   164|         }
   165|         $conditions = [];
   166|         $filterText = $request->get('filterText');
   167|         if ($filterText) {
   168|             $conditions[] = '('
   169|                 . '`title` LIKE ' . $list->quote('%'. $filterText .'%')
   170|                 . ' OR `description` LIKE ' . $list->quote('%'.$filterText.'%')
   171|                 . ' OR `type` LIKE ' . $list->quote('%'.$filterText.'%')
   172|                 . ' OR `user` IN (SELECT `id` FROM `users` WHERE `name` LIKE ' . $list->quote('%'.$filterText.'%') . ')'
   173|                 . " OR DATE_FORMAT(FROM_UNIXTIME(`date`), '%Y-%m-%d') LIKE " . $list->quote('%'.$filterText.'%')
   174|                 . ')';
   175|         }
   176|         $filterJson = $request->get('filter');
   177|         if ($filterJson) {
   178|             $db = Db::get();
   179|             $filters = $this->decodeJson($filterJson);
   180|             $propertyKey = 'property';
   181|             $comparisonKey = 'operator';
   182|             foreach ($filters as $filter) {
   183|                 $operator = '=';
   184|                 if ($filter['type'] == 'string') {
   185|                     $operator = 'LIKE';
   186|                 } elseif ($filter['type'] == 'numeric') {
   187|                     if ($filter[$comparisonKey] == 'lt') {
   188|                         $operator = '<';
   189|                     } elseif ($filter[$comparisonKey] == 'gt') {
   190|                         $operator = '>';
   191|                     } elseif ($filter[$comparisonKey] == 'eq') {
   192|                         $operator = '=';
   193|                     }
   194|                 } elseif ($filter['type'] == 'date') {
   195|                     if ($filter[$comparisonKey] == 'lt') {
   196|                         $operator = '<';
   197|                     } elseif ($filter[$comparisonKey] == 'gt') {
   198|                         $operator = '>';
   199|                     } elseif ($filter[$comparisonKey] == 'eq') {
   200|                         $operator = '=';
   201|                     }
   202|                     $filter['value'] = strtotime($filter['value']);
   203|                 } elseif ($filter[$comparisonKey] == 'list') {
   204|                     $operator = '=';
   205|                 } elseif ($filter[$comparisonKey] == 'boolean') {
   206|                     $operator = '=';
   207|                     $filter['value'] = (int) $filter['value'];
   208|                 }
   209|                 $value = $filter['value'];
   210|                 if ($operator == 'LIKE') {
   211|                     $value = '%' . $value . '%';
   212|                 }
   213|                 if ($filter[$propertyKey] == 'user') {
   214|                     $conditions[] = '`user` IN (SELECT `id` FROM `users` WHERE `name` LIKE ' . $list->quote('%'.$filter['value'].'%') . ')';
   215|                 } else {
   216|                     if ($filter['type'] == 'date' && $filter[$comparisonKey] == 'eq') {
   217|                         $maxTime = $filter['value'] + (86400 - 1); //specifies the top point of the range used in the condition
   218|                         $dateCondition = '`' . $filter[$propertyKey] . '` ' . ' BETWEEN ' . $db->quote($filter['value']) . ' AND ' . $db->quote($maxTime);
   219|                         $conditions[] = $dateCondition;
   220|                     } else {
   221|                         $field = '`'.$filter[$propertyKey].'` ';
   222|                         $conditions[] = $field.$operator.' '.$db->quote($value);
   223|                     }
   224|                 }
   225|             }
   226|         }
   227|         if ($request->get('cid') && $request->get('ctype')) {
   228|             $conditions[] = '(cid = ' . $list->quote($request->get('cid')) . ' AND ctype = ' . $list->quote($request->get('ctype')) . ')';
   229|         }
   230|         if (!empty($conditions)) {
   231|             $condition = implode(' AND ', $conditions);
   232|             $list->setCondition($condition);
   233|         }
   234|         $list->load();
   235|         $notes = [];
   236|         foreach ($list->getNotes() as $note) {
   237|             $e = Element\Service::getNoteData($note);
   238|             $notes[] = $e;
   239|         }
   240|         return $this->adminJson([
   241|             'data' => $notes,
   242|             'success' => true,
   243|             'total' => $list->getTotalCount(),
   244|         ]);
   245|     }
   246|     /**
   247|      * @Route("/element/note-add", name="pimcore_admin_element_noteadd", methods={"POST"})
   248|      *
   249|      * @param Request $request
   250|      *
   251|      * @return JsonResponse
   252|      */
   253|     public function noteAddAction(Request $request)
   254|     {
   255|         $this->checkPermission('notes_events');
   256|         $note = new Element\Note();
   257|         $note->setCid((int) $request->get('cid'));
   258|         $note->setCtype($request->get('ctype'));
   259|         $note->setDate(time());
   260|         $note->setTitle($request->get('title'));
   261|         $note->setDescription($request->get('description'));
   262|         $note->setType($request->get('type'));
   263|         $note->save();
   264|         return $this->adminJson([
   265|             'success' => true,
   266|         ]);
   267|     }
   268|     /**
   269|      * @Route("/element/find-usages", name="pimcore_admin_element_findusages", methods={"GET"})
   270|      *
   271|      * @param Request $request
   272|      *
   273|      * @return JsonResponse
   274|      */
   275|     public function findUsagesAction(Request $request)
   276|     {
   277|         $element = null;
   278|         if ($request->get('id')) {
   279|             $element = Element\Service::getElementById($request->get('type'), $request->get('id'));
   280|         } elseif ($request->get('path')) {
   281|             $element = Element\Service::getElementByPath($request->get('type'), $request->get('path'));
   282|         }
   283|         $results = [];
   284|         $success = false;
   285|         $hasHidden = false;
   286|         $total = 0;
   287|         $limit = (int)$request->get('limit', 50);
   288|         $offset = (int)$request->get('start', 0);
   289|         if ($element instanceof Element\ElementInterface) {
   290|             $total = $element->getDependencies()->getRequiredByTotalCount();
   291|             if ($request->get('sort')) {
   292|                 $sort = json_decode($request->get('sort'))[0];
   293|                 $orderBy = $sort->property;
   294|                 $orderDirection = $sort->direction;
   295|             } else {
   296|                 $orderBy = null;
   297|                 $orderDirection = null;
   298|             }
   299|             $queryOffset = $offset;
   300|             $queryLimit = $limit;
   301|             while (count($results) < min($limit, $total) && $queryOffset < $total) {
   302|                 $elements = $element->getDependencies()
   303|                     ->getRequiredByWithPath($queryOffset, $queryLimit, $orderBy, $orderDirection);
   304|                 foreach ($elements as $el) {
   305|                     $item = Element\Service::getElementById($el['type'], $el['id']);
   306|                     if ($item instanceof Element\ElementInterface) {
   307|                         if ($item->isAllowed('list')) {
   308|                             $results[] = $el;
   309|                         } else {
   310|                             $hasHidden = true;
   311|                         }
   312|                     }
   313|                 }
   314|                 $queryOffset += count($elements);
   315|                 $queryLimit = $limit - count($results);
   316|             }
   317|             $success = true;
   318|         }
   319|         return $this->adminJson([
   320|             'data' => $results,
   321|             'total' => $total,
   322|             'hasHidden' => $hasHidden,
   323|             'success' => $success,
   324|         ]);
   325|     }
   326|     /**
   327|      * @Route("/element/get-replace-assignments-batch-jobs", name="pimcore_admin_element_getreplaceassignmentsbatchjobs", methods={"GET"})
   328|      *
   329|      * @param Request $request
   330|      *
   331|      * @return \Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse
   332|      */
   333|     public function getReplaceAssignmentsBatchJobsAction(Request $request)
   334|     {
   335|         $element = null;
   336|         if ($request->get('id')) {
   337|             $element = Element\Service::getElementById($request->get('type'), $request->get('id'));
   338|         } elseif ($request->get('path')) {
   339|             $element = Element\Service::getElementByPath($request->get('type'), $request->get('path'));
   340|         }
   341|         if ($element instanceof Element\ElementInterface) {
   342|             return $this->adminJson([
   343|                 'success' => true,
   344|                 'jobs' => $element->getDependencies()->getRequiredBy(),
   345|             ]);
   346|         } else {
   347|             return $this->adminJson(['success' => false], Response::HTTP_NOT_FOUND);
   348|         }
   349|     }
   350|     /**
   351|      * @Route("/element/replace-assignments", name="pimcore_admin_element_replaceassignments", methods={"POST"})
   352|      *
   353|      * @param Request $request
   354|      *
   355|      * @return JsonResponse
   356|      */
   357|     public function replaceAssignmentsAction(Request $request)
   358|     {
   359|         $success = false;
   360|         $message = '';
   361|         $element = Element\Service::getElementById($request->get('type'), $request->get('id'));
   362|         $sourceEl = Element\Service::getElementById($request->get('sourceType'), $request->get('sourceId'));
   363|         $targetEl = Element\Service::getElementById($request->get('targetType'), $request->get('targetId'));
   364|         if ($element && $sourceEl && $targetEl
   365|             && $request->get('sourceType') == $request->get('targetType')
   366|             && $sourceEl->getType() == $targetEl->getType()
   367|             && $element->isAllowed('save')
   368|         ) {
   369|             $rewriteConfig = [
   370|                 $request->get('sourceType') => [
   371|                     $sourceEl->getId() => $targetEl->getId(),
   372|                 ],
   373|             ];
   374|             if ($element instanceof Document) {
   375|                 $element = Document\Service::rewriteIds($element, $rewriteConfig);
   376|             } elseif ($element instanceof DataObject\AbstractObject) {
   377|                 $element = DataObject\Service::rewriteIds($element, $rewriteConfig);
   378|             } elseif ($element instanceof Asset) {
   379|                 $element = Asset\Service::rewriteIds($element, $rewriteConfig);
   380|             }
   381|             $element->setUserModification($this->getAdminUser()->getId());
   382|             $element->save();
   383|             $success = true;
   384|         } else {
   385|             $message = 'source-type and target-type do not match';
   386|         }
   387|         return $this->adminJson([
   388|             'success' => $success,
   389|             'message' => $message,
   390|         ]);
   391|     }
   392|     /**
   393|      * @Route("/element/unlock-propagate", name="pimcore_admin_element_unlockpropagate", methods={"PUT"})
   394|      *
   395|      * @param Request $request
   396|      *
   397|      * @return JsonResponse
   398|      */
   399|     public function unlockPropagateAction(Request $request)
   400|     {
   401|         $success = false;
   402|         $element = Element\Service::getElementById($request->get('type'), $request->get('id'));
   403|         if ($element) {
   404|             $element->unlockPropagate();
   405|             $success = true;
   406|         }
   407|         return $this->adminJson([
   408|             'success' => $success,
   409|         ]);
   410|     }
   411|     /**
   412|      * @Route("/element/type-path", name="pimcore_admin_element_typepath", methods={"GET"})
   413|      *
   414|      * @param Request $request
   415|      *
   416|      * @return JsonResponse
   417|      */
   418|     public function typePathAction(Request $request)
   419|     {
   420|         $id = $request->get('id');
   421|         $type = $request->get('type');
   422|         $data = [];
   423|         if ($type === 'asset') {
   424|             $element = Asset::getById($id);
   425|         } elseif ($type === 'document') {
   426|             $element = Document::getById($id);
   427|         } else {
   428|             $element = DataObject::getById($id);
   429|         }
   430|         if (!$element) {
   431|             $data['success'] = false;
   432|             return $this->adminJson($data);
   433|         }
   434|         $typePath = Element\Service::getTypePath($element);
   435|         $data['success'] = true;
   436|         $data['index'] = method_exists($element, 'getIndex') ? (int) $element->getIndex() : 0;
   437|         $data['idPath'] = Element\Service::getIdPath($element);
   438|         $data['typePath'] = $typePath;
   439|         $data['fullpath'] = $element->getRealFullPath();
   440|         if ($type !== 'asset') {
   441|             $sortIndexPath = Element\Service::getSortIndexPath($element);
   442|             $data['sortIndexPath'] = $sortIndexPath;
   443|         }
   444|         return $this->adminJson($data);
   445|     }
   446|     /**
   447|      * @Route("/element/version-update", name="pimcore_admin_element_versionupdate", methods={"PUT"})
   448|      *
   449|      * @param Request $request
   450|      *
   451|      * @return JsonResponse
   452|      */
   453|     public function versionUpdateAction(Request $request)
   454|     {
   455|         $data = $this->decodeJson($request->get('data'));
   456|         $version = Version::getById($data['id']);
   457|         if ($data['public'] != $version->getPublic() || $data['note'] != $version->getNote()) {
   458|             $version->setPublic($data['public']);
   459|             $version->setNote($data['note']);
   460|             $version->save();
   461|         }
   462|         return $this->adminJson(['success' => true]);
   463|     }
   464|     /**
   465|      * @Route("/element/get-nice-path", name="pimcore_admin_element_getnicepath", methods={"POST"})
   466|      *
   467|      * @param Request $request
   468|      *
   469|      * @return JsonResponse
   470|      *
   471|      * @throws \Exception
   472|      */
   473|     public function getNicePathAction(Request $request)
   474|     {
   475|         $source = $this->decodeJson($request->get('source'));
   476|         if ($source['type'] != 'object') {
   477|             throw new \Exception('currently only objects as source elements are supported');
   478|         }
   479|         $result = [];
   480|         $id = $source['id'];
   481|         $source = DataObject\Concrete::getById($id);
   482|         if ($request->get('context')) {
   483|             $context = $this->decodeJson($request->get('context'));
   484|         } else {
   485|             $context = [];
   486|         }
   487|         $ownerType = $context['containerType'];
   488|         $fieldname = $context['fieldname'];
   489|         $fd = $this->getNicePathFormatterFieldDefinition($source, $context);
   490|         $targets = $this->decodeJson($request->get('targets'));
   491|         $result = $this->convertResultWithPathFormatter($source, $context, $result, $targets);
   492|         if ($request->get('loadEditModeData') == 'true') {
   493|             $idProperty = $request->get('idProperty', 'id');
   494|             $methodName = 'get' . ucfirst($fieldname);
   495|             if ($ownerType == 'object' && method_exists($source, $methodName)) {
   496|                 $data = $source->$methodName();
   497|                 $editModeData = $fd->getDataForEditmode($data, $source);
   498|                 if (is_array($editModeData) && !empty($editModeData)) {
   499|                     foreach ($editModeData as $relationObjectAttribute) {
   500|                         $relationObjectAttribute['$$nicepath'] =
   501|                             isset($relationObjectAttribute[$idProperty]) && isset($result[$relationObjectAttribute[$idProperty]]) ? $result[$relationObjectAttribute[$idProperty]] : null;
   502|                         $result[$relationObjectAttribute[$idProperty]] = $relationObjectAttribute;
   503|                     }
   504|                 } else {
   505|                     foreach ($result as $resultItemId => $resultItem) {
   506|                         $result[$resultItemId] = ['$$nicepath' => $resultItem];
   507|                     }
   508|                 }
   509|             } else {
   510|                 Logger::error('Loading edit mode data is not supported for ownertype: ' . $ownerType);
   511|             }
   512|         }
   513|         return $this->adminJson(['success' => true, 'data' => $result]);
   514|     }
   515|     /**
   516|      * @Route("/element/get-versions", name="pimcore_admin_element_getversions", methods={"GET"})
   517|      *
   518|      * @param Request $request
   519|      *
   520|      * @return JsonResponse
   521|      *
   522|      * @throws \Exception
   523|      */
   524|     public function getVersionsAction(Request $request)
   525|     {
   526|         $id = (int)$request->get('id');
   527|         $type = $request->get('elementType');
   528|         $allowedTypes = ['asset', 'document', 'object'];
   529|         if ($id && in_array($type, $allowedTypes)) {
   530|             $element = Model\Element\Service::getElementById($type, $id);
   531|             if ($element) {
   532|                 if ($element->isAllowed('versions')) {
   533|                     $schedule = $element->getScheduledTasks();
   534|                     $schedules = [];
   535|                     foreach ($schedule as $task) {
   536|                         if ($task->getActive()) {
   537|                             $schedules[$task->getVersion()] = $task->getDate();
   538|                         }
   539|                     }
   540|                     $list = new Version\Listing();
   541|                     $list->setLoadAutoSave(true);
   542|                     $list->setCondition('cid = ? AND ctype = ? AND (autoSave=0 OR (autoSave=1 AND userId = ?)) ', [
   543|                         $element->getId(),
   544|                         Element\Service::getType($element),
   545|                         $this->getUser()->getId(),
   546|                     ])
   547|                         ->setOrderKey('date')
   548|                         ->setOrder('ASC');
   549|                     $versions = $list->load();
   550|                     $versions = Model\Element\Service::getSafeVersionInfo($versions);
   551|                     $versions = array_reverse($versions); //reverse array to sort by ID DESC
   552|                     foreach ($versions as &$version) {
   553|                         $version['scheduled'] = null;
   554|                         if (array_key_exists($version['id'], $schedules)) {
   555|                             $version['scheduled'] = $schedules[$version['id']];
   556|                         }
   557|                     }
   558|                     return $this->adminJson(['versions' => $versions]);
   559|                 } else {
   560|                     throw $this->createAccessDeniedException('Permission denied, ' . $type . ' id [' . $id . ']');
   561|                 }
   562|             } else {
   563|                 throw $this->createNotFoundException($type . ' with id [' . $id . "] doesn't exist");
   564|             }
   565|         }
   566|         throw $this->createNotFoundException('Element type not found');
   567|     }
   568|     /**
   569|      * @Route("/element/delete-draft", name="pimcore_admin_element_deletedraft", methods={"DELETE"})
   570|      *
   571|      * @param Request $request
   572|      *
   573|      * @return JsonResponse
   574|      */
   575|     public function deleteDraftAction(Request $request)
   576|     {
   577|         $version = Version::getById($request->get('id'));
   578|         if ($version) {
   579|             $version->delete();
   580|         }
   581|         return $this->adminJson(['success' => true]);
   582|     }
   583|     /**
   584|      * @Route("/element/delete-version", name="pimcore_admin_element_deleteversion", methods={"DELETE"})
   585|      *
   586|      * @param Request $request
   587|      *
   588|      * @return JsonResponse
   589|      */
   590|     public function deleteVersionAction(Request $request)
   591|     {
   592|         $version = Model\Version::getById($request->get('id'));
   593|         $version->delete();
   594|         return $this->adminJson(['success' => true]);
   595|     }
   596|     /**
   597|      * @Route("/element/delete-all-versions", name="pimcore_admin_element_deleteallversion", methods={"DELETE"})
   598|      *
   599|      * @param Request $request
   600|      *
   601|      * @return JsonResponse
   602|      */
   603|     public function deleteAllVersionAction(Request $request)
   604|     {
   605|         $elementId = $request->get('id');
   606|         $elementModificationdate = $request->get('date');
   607|         $versions = new Model\Version\Listing();
   608|         $versions->setCondition('cid = ' . $versions->quote($elementId) . ' AND date <> ' . $versions->quote($elementModificationdate));
   609|         foreach ($versions->load() as $vkey => $version) {
   610|             $version->delete();
   611|         }
   612|         return $this->adminJson(['success' => true]);
   613|     }
   614|     /**
   615|      * @Route("/element/get-requires-dependencies", name="pimcore_admin_element_getrequiresdependencies", methods={"GET"})
   616|      *
   617|      * @param Request $request
   618|      *
   619|      * @return JsonResponse
   620|      */
   621|     public function getRequiresDependenciesAction(Request $request)
   622|     {
   623|         $id = $request->get('id');
   624|         $type = $request->get('elementType');
   625|         $allowedTypes = ['asset', 'document', 'object'];
   626|         $offset = $request->get('start');
   627|         $limit = $request->get('limit');
   628|         if ($id && in_array($type, $allowedTypes)) {
   629|             $element = Model\Element\Service::getElementById($type, $id);
   630|             $dependencies = $element->getDependencies();
   631|             if ($element instanceof Model\Element\ElementInterface) {
   632|                 $dependenciesResult = Model\Element\Service::getRequiresDependenciesForFrontend($dependencies, $offset, $limit);
   633|                 $dependenciesResult['start'] = $offset;
   634|                 $dependenciesResult['limit'] = $limit;
   635|                 $dependenciesResult['total'] = $dependencies->getRequiresTotalCount();
   636|                 return $this->adminJson($dependenciesResult);
   637|             }
   638|         }
   639|         return $this->adminJson(false);
   640|     }
   641|     /**
   642|      * @Route("/element/get-required-by-dependencies", name="pimcore_admin_element_getrequiredbydependencies", methods={"GET"})
   643|      *
   644|      * @param Request $request
   645|      *
   646|      * @return JsonResponse
   647|      */
   648|     public function getRequiredByDependenciesAction(Request $request)
   649|     {
   650|         $id = $request->get('id');
   651|         $type = $request->get('elementType');
   652|         $allowedTypes = ['asset', 'document', 'object'];
   653|         $offset = $request->get('start');
   654|         $limit = $request->get('limit');
   655|         if ($id && in_array($type, $allowedTypes)) {
   656|             $element = Model\Element\Service::getElementById($type, $id);
   657|             $dependencies = $element->getDependencies();
   658|             if ($element instanceof Model\Element\ElementInterface) {
   659|                 $dependenciesResult = Model\Element\Service::getRequiredByDependenciesForFrontend($dependencies, $offset, $limit);
   660|                 $dependenciesResult['start'] = $offset;
   661|                 $dependenciesResult['limit'] = $limit;
   662|                 $dependenciesResult['total'] = $dependencies->getRequiredByTotalCount();
   663|                 return $this->adminJson($dependenciesResult);
   664|             }
   665|         }
   666|         return $this->adminJson(false);
   667|     }
   668|     /**
   669|      * @Route("/element/get-predefined-properties", name="pimcore_admin_element_getpredefinedproperties", methods={"GET"})
   670|      *
   671|      * @param Request $request
   672|      *
   673|      * @return JsonResponse
   674|      */
   675|     public function getPredefinedPropertiesAction(Request $request)
   676|     {
   677|         $properties = [];
   678|         $type = $request->get('elementType');
   679|         $allowedTypes = ['asset', 'document', 'object'];
   680|         if (in_array($type, $allowedTypes)) {
   681|             $list = new Model\Property\Predefined\Listing();
   682|             $list->setFilter(function ($row) use ($type) {
   683|                 if (is_array($row['ctype'])) {
   684|                     $row['ctype'] = implode(',', $row['ctype']);
   685|                 }
   686|                 if (strpos($row['ctype'], $type) !== false) {
   687|                     return true;
   688|                 }
   689|                 return false;
   690|             });
   691|             $list->load();
   692|             foreach ($list->getProperties() as $type) {
   693|                 $properties[] = $type->getObjectVars();
   694|             }
   695|         }
   696|         return $this->adminJson(['properties' => $properties]);
   697|     }
   698|     /**
   699|      * @Route("/element/analyze-permissions", name="pimcore_admin_element_analyzepermissions", methods={"POST"})
   700|      *
   701|      * @param Request $request
   702|      *
   703|      * @return Response
   704|      */
   705|     public function analyzePermissionsAction(Request $request)
   706|     {
   707|         $userId = $request->get('userId');
   708|         if ($userId) {
   709|             $user = Model\User::getById($userId);
   710|             $userList = [$user];
   711|         } else {
   712|             $userList = new Model\User\Listing();
   713|             $userList->setCondition('type = ?', ['user']);
   714|             $userList = $userList->load();
   715|         }
   716|         $elementType = $request->get('elementType');
   717|         $elementId = $request->get('elementId');
   718|         $element = Element\Service::getElementById($elementType, $elementId);
   719|         $result = Element\PermissionChecker::check($element, $userList);
   720|         return $this->adminJson(
   721|             [
   722|                 'data' => $result,
   723|                 'success' => true,
   724|             ]
   725|         );
   726|     }
   727|     /**
   728|      * @param DataObject\Concrete $source
   729|      * @param array $context
   730|      *
   731|      * @return bool|DataObject\ClassDefinition\Data|null
   732|      *
   733|      * @throws \Exception
   734|      */
   735|     protected function getNicePathFormatterFieldDefinition($source, $context)
   736|     {
   737|         $ownerType = $context['containerType'];
   738|         $fieldname = $context['fieldname'];
   739|         $fd = null;
   740|         if ($ownerType == 'object') {
   741|             $subContainerType = isset($context['subContainerType']) ? $context['subContainerType'] : null;
   742|             if ($subContainerType) {
   743|                 $subContainerKey = $context['subContainerKey'];
   744|                 $subContainer = $source->getClass()->getFieldDefinition($subContainerKey);
   745|                 if (method_exists($subContainer, 'getFieldDefinition')) {
   746|                     $fd = $subContainer->getFieldDefinition($fieldname);
   747|                 }
   748|             } else {
   749|                 $fd = $source->getClass()->getFieldDefinition($fieldname);
   750|             }
   751|         } elseif ($ownerType == 'localizedfield') {
   752|             $localizedfields = $source->getClass()->getFieldDefinition('localizedfields');
   753|             if ($localizedfields instanceof DataObject\ClassDefinition\Data\Localizedfields) {
   754|                 $fd = $localizedfields->getFieldDefinition($fieldname);
   755|             }
   756|         } elseif ($ownerType == 'objectbrick') {
   757|             $fdBrick = DataObject\Objectbrick\Definition::getByKey($context['containerKey']);
   758|             $fd = $fdBrick->getFieldDefinition($fieldname);
   759|         } elseif ($ownerType == 'fieldcollection') {
   760|             $containerKey = $context['containerKey'];
   761|             $fdCollection = DataObject\Fieldcollection\Definition::getByKey($containerKey);
   762|             if (($context['subContainerType'] ?? null) === 'localizedfield') {
   763|                 /** @var DataObject\ClassDefinition\Data\Localizedfields $fdLocalizedFields */
   764|                 $fdLocalizedFields = $fdCollection->getFieldDefinition('localizedfields');
   765|                 $fd = $fdLocalizedFields->getFieldDefinition($fieldname);
   766|             } else {
   767|                 $fd = $fdCollection->getFieldDefinition($fieldname);
   768|             }
   769|         }
   770|         return $fd;
   771|     }
   772|     /**
   773|      * @param DataObject\Concrete $source
   774|      * @param array $context
   775|      * @param array $result
   776|      * @param array $targets
   777|      *
   778|      * @return array
   779|      *
   780|      * @throws \Exception
   781|      */
   782|     protected function convertResultWithPathFormatter(DataObject\Concrete $source, $context, $result, $targets): array
   783|     {
   784|         $fd = $this->getNicePathFormatterFieldDefinition($source, $context);
   785|         if ($fd instanceof DataObject\ClassDefinition\PathFormatterAwareInterface) {
   786|             $formatter = $fd->getPathFormatterClass();
   787|             if (null !== $formatter) {
   788|                 $pathFormatter = DataObject\ClassDefinition\Helper\PathFormatterResolver::resolvePathFormatter(
   789|                     $fd->getPathFormatterClass()
   790|                 );
   791|                 if ($pathFormatter instanceof DataObject\ClassDefinition\PathFormatterInterface) {
   792|                     $result = $pathFormatter->formatPath($result, $source, $targets, [
   793|                         'fd' => $fd,
   794|                         'context' => $context,
   795|                     ]);
   796|                 }
   797|             }
   798|         }
   799|         return $result;
   800|     }
   801| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/ElementControllerBase.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-192 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Event\AssetEvents;
    17| use Pimcore\Event\DataObjectEvents;
    18| use Pimcore\Event\DocumentEvents;
    19| use Pimcore\Event\Model\AssetDeleteInfoEvent;
    20| use Pimcore\Event\Model\DataObjectDeleteInfoEvent;
    21| use Pimcore\Event\Model\DocumentDeleteInfoEvent;
    22| use Pimcore\Event\Model\ElementDeleteInfoEventInterface;
    23| use Pimcore\Logger;
    24| use Pimcore\Model\Asset;
    25| use Pimcore\Model\DataObject\AbstractObject;
    26| use Pimcore\Model\Document;
    27| use Pimcore\Model\Element\ElementInterface;
    28| use Pimcore\Model\Element\Service;
    29| use Symfony\Component\HttpFoundation\JsonResponse;
    30| use Symfony\Component\HttpFoundation\Request;
    31| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    32| /**
    33|  * @internal
    34|  */
    35| abstract class ElementControllerBase extends AdminController
    36| {
    37|     /**
    38|      * @param ElementInterface $element
    39|      *
    40|      * @return array
    41|      */
    42|     protected function getTreeNodeConfig($element)
    43|     {
    44|         return [];
    45|     }
    46|     /**
    47|      * @param Request $request
    48|      *
    49|      * @return JsonResponse
    50|      */
    51|     public function treeGetRootAction(Request $request)
    52|     {
    53|         $type = $request->get('elementType');
    54|         $allowedTypes = ['asset', 'document', 'object'];
    55|         $id = 1;
    56|         if ($request->get('id')) {
    57|             $id = (int)$request->get('id');
    58|         }
    59|         if (in_array($type, $allowedTypes)) {
    60|             /** @var Document|Asset|AbstractObject $root */
    61|             $root = Service::getElementById($type, $id);
    62|             if ($root->isAllowed('list')) {
    63|                 return $this->adminJson($this->getTreeNodeConfig($root));
    64|             }
    65|         }
    66|         return $this->adminJson(['success' => false, 'message' => 'missing_permission']);
    67|     }
    68|     /**
    69|      * @param Request $request
    70|      * @param EventDispatcherInterface $eventDispatcher
    71|      *
    72|      * @return JsonResponse
    73|      *
    74|      * @throws \Exception
    75|      */
    76|     public function deleteInfoAction(Request $request, EventDispatcherInterface $eventDispatcher)
    77|     {
    78|         $hasDependency = false;
    79|         $errors = false;
    80|         $deleteJobs = [];
    81|         $itemResults = [];
    82|         $totalChilds = 0;
    83|         $ids = $request->get('id');
    84|         $ids = explode(',', $ids);
    85|         $type = $request->get('type');
    86|         foreach ($ids as $id) {
    87|             try {
    88|                 $element = Service::getElementById($type, $id);
    89|                 if (!$element) {
    90|                     continue;
    91|                 }
    92|                 if (!$hasDependency) {
    93|                     $hasDependency = $element->getDependencies()->isRequired();
    94|                 }
    95|             } catch (\Exception $e) {
    96|                 Logger::err('failed to access element with id: ' . $id);
    97|                 continue;
    98|             }
    99|             if ($element instanceof ElementInterface) {
   100|                 $event = null;
   101|                 $eventName = null;
   102|                 if ($element instanceof Asset) {
   103|                     $event = new AssetDeleteInfoEvent($element);
   104|                     $eventName = AssetEvents::DELETE_INFO;
   105|                 } elseif ($element instanceof Document) {
   106|                     $event = new DocumentDeleteInfoEvent($element);
   107|                     $eventName = DocumentEvents::DELETE_INFO;
   108|                 } elseif ($element instanceof AbstractObject) {
   109|                     $event = new DataObjectDeleteInfoEvent($element);
   110|                     $eventName = DataObjectEvents::DELETE_INFO;
   111|                 }
   112|                 if ($event instanceof ElementDeleteInfoEventInterface) {
   113|                     $eventDispatcher->dispatch($event, $eventName);
   114|                     if (!$event->getDeletionAllowed()) {
   115|                         $itemResults[] = [
   116|                             'id' => $element->getId(),
   117|                             'type' => $element->getType(),
   118|                             'key' => $element->getKey(),
   119|                             'reason' => $event->getReason(),
   120|                             'allowed' => false,
   121|                         ];
   122|                         $errors |= true;
   123|                         continue;
   124|                     }
   125|                 }
   126|                 $itemResults[] = [
   127|                     'id' => $element->getId(),
   128|                     'type' => $element->getType(),
   129|                     'key' => $element->getKey(),
   130|                     'allowed' => true,
   131|                 ];
   132|                 $deleteJobs[] = [[
   133|                     'url' => $this->generateUrl('pimcore_admin_recyclebin_add'),
   134|                     'method' => 'POST',
   135|                     'params' => [
   136|                         'type' => $type,
   137|                         'id' => $element->getId(),
   138|                     ],
   139|                 ]];
   140|                 $hasChilds = $element->hasChildren();
   141|                 if (!$hasDependency) {
   142|                     $hasDependency = $hasChilds;
   143|                 }
   144|                 if ($hasChilds) {
   145|                     $list = $element::getList(['unpublished' => true]);
   146|                     $pathColumn = ($type === 'object') ? 'o_path' : 'path';
   147|                     $list->setCondition($pathColumn . ' LIKE ?', [$element->getRealFullPath() . '/%']);
   148|                     $childs = $list->getTotalCount();
   149|                     $totalChilds += $childs;
   150|                     if ($childs > 0) {
   151|                         $deleteObjectsPerRequest = 5;
   152|                         for ($i = 0, $iMax = ceil($childs / $deleteObjectsPerRequest); $i < $iMax; $i++) {
   153|                             $deleteJobs[] = [[
   154|                                 'url' => $request->getBaseUrl() . '/admin/' . $type . '/delete',
   155|                                 'method' => 'DELETE',
   156|                                 'params' => [
   157|                                     'step' => $i,
   158|                                     'amount' => $deleteObjectsPerRequest,
   159|                                     'type' => 'childs',
   160|                                     'id' => $element->getId(),
   161|                                 ],
   162|                             ]];
   163|                         }
   164|                     }
   165|                 }
   166|                 $deleteJobs[] = [[
   167|                     'url' => $request->getBaseUrl() . '/admin/' . $type . '/delete',
   168|                     'method' => 'DELETE',
   169|                     'params' => [
   170|                         'id' => $element->getId(),
   171|                     ],
   172|                 ]];
   173|             }
   174|         }
   175|         $elementKey = false;
   176|         if (count($ids) === 1) {
   177|             $element = Service::getElementById($type, $ids[0]);
   178|             if ($element instanceof ElementInterface) {
   179|                 $elementKey = $element->getKey();
   180|             }
   181|         }
   182|         return $this->adminJson([
   183|             'hasDependencies' => $hasDependency,
   184|             'childs' => $totalChilds,
   185|             'deletejobs' => $deleteJobs,
   186|             'batchDelete' => count($ids) > 1,
   187|             'elementKey' => $elementKey,
   188|             'errors' => $errors,
   189|             'itemResults' => $itemResults,
   190|         ]);
   191|     }
   192| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/EmailController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-459 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Logger;
    17| use Pimcore\Mail;
    18| use Pimcore\Model\Element\ElementInterface;
    19| use Pimcore\Model\Tool;
    20| use Symfony\Component\HttpFoundation\JsonResponse;
    21| use Symfony\Component\HttpFoundation\Request;
    22| use Symfony\Component\HttpFoundation\Response;
    23| use Symfony\Component\HttpKernel\Profiler\Profiler;
    24| use Symfony\Component\Mime\Address;
    25| use Symfony\Component\Routing\Annotation\Route;
    26| /**
    27|  * @Route("/email")
    28|  *
    29|  * @internal
    30|  */
    31| class EmailController extends AdminController
    32| {
    33|     /**
    34|      * @Route("/email-logs", name="pimcore_admin_email_emaillogs", methods={"GET", "POST"})
    35|      *
    36|      * @param Request $request
    37|      *
    38|      * @return JsonResponse
    39|      *
    40|      * @throws \Exception
    41|      */
    42|     public function emailLogsAction(Request $request)
    43|     {
    44|         if (!$this->getAdminUser()->isAllowed('emails') && !$this->getAdminUser()->isAllowed('gdpr_data_extractor')) {
    45|             throw new \Exception("Permission denied, user needs 'emails' permission.");
    46|         }
    47|         $list = new Tool\Email\Log\Listing();
    48|         if ($request->get('documentId')) {
    49|             $list->setCondition('documentId = ' . (int)$request->get('documentId'));
    50|         }
    51|         $list->setLimit($request->get('limit'));
    52|         $list->setOffset($request->get('start'));
    53|         $list->setOrderKey('sentDate');
    54|         if ($request->get('filter')) {
    55|             if ($request->get('filter')) {
    56|                 $filterTerm = $request->get('filter');
    57|                 if ($filterTerm == '*') {
    58|                     $filterTerm = '';
    59|                 }
    60|                 $filterTerm = str_replace('%', '*', $filterTerm);
    61|                 $filterTerm = htmlspecialchars($filterTerm, ENT_QUOTES);
    62|                 if (strpos($filterTerm, '@')) {
    63|                     $parts = explode(' ', $filterTerm);
    64|                     $parts = array_map(function ($part) {
    65|                         if (strpos($part, '@')) {
    66|                             $part = '"' . $part . '"';
    67|                         }
    68|                         return $part;
    69|                     }, $parts);
    70|                     $filterTerm = implode(' ', $parts);
    71|                 }
    72|                 $condition = '( MATCH (`from`,`to`,`cc`,`bcc`,`subject`,`params`) AGAINST (' . $list->quote($filterTerm) . ' IN BOOLEAN MODE) )';
    73|                 if ($request->get('documentId')) {
    74|                     $condition .= 'AND documentId = ' . (int)$request->get('documentId');
    75|                 }
    76|                 $list->setCondition($condition);
    77|             }
    78|         }
    79|         $list->setOrder('DESC');
    80|         $data = $list->load();
    81|         $jsonData = [];
    82|         if (is_array($data)) {
    83|             foreach ($data as $entry) {
    84|                 $tmp = $entry->getObjectVars();
    85|                 unset($tmp['bodyHtml']);
    86|                 unset($tmp['bodyText']);
    87|                 $jsonData[] = $tmp;
    88|             }
    89|         }
    90|         return $this->adminJson([
    91|             'data' => $jsonData,
    92|             'success' => true,
    93|             'total' => $list->getTotalCount(),
    94|         ]);
    95|     }
    96|     /**
    97|      * @Route("/show-email-log", name="pimcore_admin_email_showemaillog", methods={"GET"})
    98|      *
    99|      * @param Request $request
   100|      * @param Profiler $profiler
   101|      *
   102|      * @return JsonResponse|Response
   103|      *
   104|      * @throws \Exception
   105|      */
   106|     public function showEmailLogAction(Request $request, ?Profiler $profiler)
   107|     {
   108|         if ($profiler) {
   109|             $profiler->disable();
   110|         }
   111|         if (!$this->getAdminUser()->isAllowed('emails')) {
   112|             throw new \Exception("Permission denied, user needs 'emails' permission.");
   113|         }
   114|         $type = $request->get('type');
   115|         $emailLog = Tool\Email\Log::getById($request->get('id'));
   116|         if ($request->get('type') == 'text') {
   117|             return $this->render('@PimcoreAdmin/Admin/Email/text.html.twig', ['log' => $emailLog->getTextLog()]);
   118|         } elseif ($request->get('type') == 'html') {
   119|             return new Response($emailLog->getHtmlLog(), 200, [
   120|                 'Content-Security-Policy' => "default-src 'self'; style-src 'self' 'unsafe-inline'",
   121|             ]);
   122|         } elseif ($request->get('type') == 'params') {
   123|             try {
   124|                 $params = $this->decodeJson($emailLog->getParams());
   125|             } catch (\Exception $e) {
   126|                 Logger::warning('Could not decode JSON param string');
   127|                 $params = [];
   128|             }
   129|             foreach ($params as &$entry) {
   130|                 $this->enhanceLoggingData($entry);
   131|             }
   132|             return $this->adminJson($params);
   133|         } elseif ($request->get('type') == 'details') {
   134|             $data = $emailLog->getObjectVars();
   135|             return $this->adminJson($data);
   136|         } else {
   137|             return new Response('No Type specified');
   138|         }
   139|     }
   140|     /**
   141|      * @param array $data
   142|      * @param array $fullEntry
   143|      */
   144|     protected function enhanceLoggingData(&$data, &$fullEntry = null)
   145|     {
   146|         if (!empty($data['objectClass'])) {
   147|             $class = '\\' . ltrim($data['objectClass'], '\\');
   148|             $reflection = new \ReflectionClass($class);
   149|             if (!empty($data['objectId']) && $reflection->implementsInterface(ElementInterface::class)) {
   150|                 $obj = $class::getById($data['objectId']);
   151|                 if (is_null($obj)) {
   152|                     $data['objectPath'] = '';
   153|                 } else {
   154|                     $data['objectPath'] = $obj->getRealFullPath();
   155|                 }
   156|                 if (stristr($class, '\\Pimcore\\Model') === false) {
   157|                     $niceClassName = '\\' . ltrim($reflection->getParentClass()->getName(), '\\');
   158|                 } else {
   159|                     $niceClassName = $class;
   160|                 }
   161|                 $niceClassName = str_replace('\\Pimcore\\Model\\', '', $niceClassName);
   162|                 $niceClassName = str_replace('_', '\\', $niceClassName);
   163|                 $tmp = explode('\\', $niceClassName);
   164|                 if (in_array($tmp[0], ['DataObject', 'Document', 'Asset'])) {
   165|                     $data['objectClassBase'] = $tmp[0];
   166|                     $data['objectClassSubType'] = $tmp[1];
   167|                 }
   168|             }
   169|         }
   170|         foreach ($data as &$value) {
   171|             if (is_array($value)) {
   172|                 $this->enhanceLoggingData($value, $data);
   173|             }
   174|         }
   175|         if ($data['children'] ?? false) {
   176|             foreach ($data['children'] as $key => $entry) {
   177|                 if (is_string($key)) { //key must be integers
   178|                     unset($data['children'][$key]);
   179|                 }
   180|             }
   181|             $data['iconCls'] = 'pimcore_icon_folder';
   182|             $data['data'] = ['type' => 'simple', 'value' => 'Children (' . count($data['children']) . ')'];
   183|         } else {
   184|             if (empty($data['iconCls'])) {
   185|                 if (($data['objectClassBase'] ?? '') == 'DataObject') {
   186|                     $fullEntry['iconCls'] = 'pimcore_icon_object';
   187|                 } elseif (($data['objectClassBase'] ?? '') == 'Asset') {
   188|                     switch ($data['objectClassSubType']) {
   189|                         case 'Image':
   190|                             $fullEntry['iconCls'] = 'pimcore_icon_image';
   191|                             break;
   192|                         case 'Video':
   193|                             $fullEntry['iconCls'] = 'pimcore_icon_wmv';
   194|                             break;
   195|                         case 'Text':
   196|                             $fullEntry['iconCls'] = 'pimcore_icon_txt';
   197|                             break;
   198|                         case 'Document':
   199|                             $fullEntry['iconCls'] = 'pimcore_icon_pdf';
   200|                             break;
   201|                         default:
   202|                             $fullEntry['iconCls'] = 'pimcore_icon_asset';
   203|                     }
   204|                 } elseif (strpos($data['objectClass'] ?? '', 'Document') === 0) {
   205|                     $fullEntry['iconCls'] = 'pimcore_icon_' . strtolower($data['objectClassSubType']);
   206|                 } else {
   207|                     $data['iconCls'] = 'pimcore_icon_text';
   208|                 }
   209|             }
   210|             $data['leaf'] = true;
   211|         }
   212|     }
   213|     /**
   214|      * @Route("/delete-email-log", name="pimcore_admin_email_deleteemaillog", methods={"DELETE"})
   215|      *
   216|      * @param Request $request
   217|      *
   218|      * @return JsonResponse
   219|      *
   220|      * @throws \Exception
   221|      */
   222|     public function deleteEmailLogAction(Request $request)
   223|     {
   224|         if (!$this->getAdminUser()->isAllowed('emails')) {
   225|             throw new \Exception("Permission denied, user needs 'emails' permission.");
   226|         }
   227|         $success = false;
   228|         $emailLog = Tool\Email\Log::getById($request->get('id'));
   229|         if ($emailLog instanceof Tool\Email\Log) {
   230|             $emailLog->delete();
   231|             $success = true;
   232|         }
   233|         return $this->adminJson([
   234|             'success' => $success,
   235|         ]);
   236|     }
   237|     /**
   238|      * @Route("/resend-email", name="pimcore_admin_email_resendemail", methods={"POST"})
   239|      *
   240|      * @param Request $request
   241|      *
   242|      * @return JsonResponse
   243|      *
   244|      * @throws \Exception
   245|      */
   246|     public function resendEmailAction(Request $request)
   247|     {
   248|         if (!$this->getAdminUser()->isAllowed('emails')) {
   249|             throw new \Exception("Permission denied, user needs 'emails' permission.");
   250|         }
   251|         $success = false;
   252|         $emailLog = Tool\Email\Log::getById($request->get('id'));
   253|         if ($emailLog instanceof Tool\Email\Log) {
   254|             $mail = new Mail();
   255|             $mail->preventDebugInformationAppending();
   256|             $mail->setIgnoreDebugMode(true);
   257|             if (!empty($request->get('to'))) {
   258|                 $emailLog->setTo(null);
   259|                 $emailLog->setCc(null);
   260|                 $emailLog->setBcc(null);
   261|             } else {
   262|                 $mail->disableLogging();
   263|             }
   264|             if ($html = $emailLog->getHtmlLog()) {
   265|                 $mail->html($html);
   266|             }
   267|             if ($text = $emailLog->getTextLog()) {
   268|                 $mail->text($text);
   269|             }
   270|             foreach (['From', 'To', 'Cc', 'Bcc', 'ReplyTo'] as $field) {
   271|                 if (!$values = $request->get(strtolower($field))) {
   272|                     $getter = 'get' . $field;
   273|                     $values = $emailLog->{$getter}();
   274|                 }
   275|                 $values = \Pimcore\Helper\Mail::parseEmailAddressField($values);
   276|                 if (!empty($values)) {
   277|                     list($value) = $values;
   278|                     if ($value) {
   279|                         $prefix = 'add';
   280|                         $mail->{$prefix . $field}(new Address($value['email'], $value['name'] ?? ''));
   281|                     }
   282|                 }
   283|             }
   284|             $mail->setSubject($emailLog->getSubject());
   285|             if ($emailLog->getDocumentId()) {
   286|                 $mail->setDocument($emailLog->getDocumentId());
   287|             }
   288|             try {
   289|                 $params = $this->decodeJson($emailLog->getParams());
   290|             } catch (\Exception $e) {
   291|                 Logger::warning('Could not decode JSON param string');
   292|                 $params = [];
   293|             }
   294|             foreach ($params as $entry) {
   295|                 $data = null;
   296|                 $hasChildren = isset($entry['children']) && is_array($entry['children']);
   297|                 if ($hasChildren) {
   298|                     $childData = [];
   299|                     foreach ($entry['children'] as $childParam) {
   300|                         $childData[$childParam['key']] = $this->parseLoggingParamObject($childParam);
   301|                     }
   302|                     $data = $childData;
   303|                 } else {
   304|                     $data = $this->parseLoggingParamObject($entry);
   305|                 }
   306|                 $mail->setParam($entry['key'], $data);
   307|             }
   308|             $mail->send();
   309|             $success = true;
   310|         }
   311|         return $this->adminJson([
   312|             'success' => $success,
   313|         ]);
   314|     }
   315|     /**
   316|      * @Route("/send-test-email", name="pimcore_admin_email_sendtestemail", methods={"POST"})
   317|      *
   318|      * @param Request $request
   319|      *
   320|      * @return JsonResponse
   321|      *
   322|      * @throws \Exception
   323|      */
   324|     public function sendTestEmailAction(Request $request)
   325|     {
   326|         if (!$this->getAdminUser()->isAllowed('emails')) {
   327|             throw new \Exception("Permission denied, user needs 'emails' permission.");
   328|         }
   329|         $mail = new Mail();
   330|         if ($from = $request->get('from')) {
   331|             $addressArray = \Pimcore\Helper\Mail::parseEmailAddressField($from);
   332|             if ($addressArray) {
   333|                 list($cleanedFromAddress) = $addressArray;
   334|                 $mail->from(new Address($cleanedFromAddress['email'], $cleanedFromAddress['name'] ?? ''));
   335|             }
   336|         }
   337|         $toAddresses = \Pimcore\Helper\Mail::parseEmailAddressField($request->get('to'));
   338|         foreach ($toAddresses as $cleanedToAddress) {
   339|             $mail->addTo($cleanedToAddress['email'], $cleanedToAddress['name'] ?? '');
   340|         }
   341|         $mail->setSubject($request->get('subject'));
   342|         $mail->setIgnoreDebugMode(true);
   343|         if ($request->get('emailType') == 'text') {
   344|             $mail->text($request->get('content'));
   345|         } elseif ($request->get('emailType') == 'html') {
   346|             $mail->html($request->get('content'));
   347|         } elseif ($request->get('emailType') == 'document') {
   348|             $doc = \Pimcore\Model\Document::getByPath($request->get('documentPath'));
   349|             if ($doc instanceof \Pimcore\Model\Document\Email || $doc instanceof \Pimcore\Model\Document\Newsletter) {
   350|                 $mail->setDocument($doc);
   351|                 if ($request->get('mailParamaters')) {
   352|                     if ($mailParamsArray = json_decode($request->get('mailParamaters'), true)) {
   353|                         foreach ($mailParamsArray as $mailParam) {
   354|                             if ($mailParam['key']) {
   355|                                 $mail->setParam($mailParam['key'], $mailParam['value']);
   356|                             }
   357|                         }
   358|                     }
   359|                 }
   360|             } else {
   361|                 throw new \Exception('Email document not found!');
   362|             }
   363|         }
   364|         $mail->send();
   365|         return $this->adminJson([
   366|             'success' => true,
   367|         ]);
   368|     }
   369|     /**
   370|      * @Route("/blacklist", name="pimcore_admin_email_blacklist", methods={"POST"})
   371|      *
   372|      * @param Request $request
   373|      *
   374|      * @return JsonResponse
   375|      *
   376|      * @throws \Exception
   377|      */
   378|     public function blacklistAction(Request $request)
   379|     {
   380|         if (!$this->getAdminUser()->isAllowed('emails')) {
   381|             throw new \Exception("Permission denied, user needs 'emails' permission.");
   382|         }
   383|         if ($request->get('data')) {
   384|             $data = $this->decodeJson($request->get('data'));
   385|             if (is_array($data)) {
   386|                 foreach ($data as &$value) {
   387|                     if (is_string($value)) {
   388|                         $value = trim($value);
   389|                     }
   390|                 }
   391|             }
   392|             if ($request->get('xaction') == 'destroy') {
   393|                 $address = Tool\Email\Blacklist::getByAddress($data['address']);
   394|                 $address->delete();
   395|                 return $this->adminJson(['success' => true, 'data' => []]);
   396|             } elseif ($request->get('xaction') == 'update') {
   397|                 $address = Tool\Email\Blacklist::getByAddress($data['address']);
   398|                 $address->setValues($data);
   399|                 $address->save();
   400|                 return $this->adminJson(['data' => $address->getObjectVars(), 'success' => true]);
   401|             } elseif ($request->get('xaction') == 'create') {
   402|                 unset($data['id']);
   403|                 $address = new Tool\Email\Blacklist();
   404|                 $address->setValues($data);
   405|                 $address->save();
   406|                 return $this->adminJson(['data' => $address->getObjectVars(), 'success' => true]);
   407|             }
   408|         } else {
   409|             $list = new Tool\Email\Blacklist\Listing();
   410|             $list->setLimit($request->get('limit'));
   411|             $list->setOffset($request->get('start'));
   412|             $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($request->query->all());
   413|             if ($sortingSettings['orderKey']) {
   414|                 $orderKey = $sortingSettings['orderKey'];
   415|             }
   416|             if ($sortingSettings['order']) {
   417|                 $order = $sortingSettings['order'];
   418|             }
   419|             if ($request->get('filter')) {
   420|                 $list->setCondition('`address` LIKE ' . $list->quote('%'.$request->get('filter').'%'));
   421|             }
   422|             $data = $list->load();
   423|             $jsonData = [];
   424|             if (is_array($data)) {
   425|                 foreach ($data as $entry) {
   426|                     $jsonData[] = $entry->getObjectVars();
   427|                 }
   428|             }
   429|             return $this->adminJson([
   430|                 'success' => true,
   431|                 'data' => $jsonData,
   432|                 'total' => $list->getTotalCount(),
   433|             ]);
   434|         }
   435|         return $this->adminJson(['success' => false]);
   436|     }
   437|     /**
   438|      * @param array $params
   439|      *
   440|      * @return array
   441|      */
   442|     protected function parseLoggingParamObject($params)
   443|     {
   444|         $data = null;
   445|         if ($params['data']['type'] === 'object') {
   446|             $class = '\\' . ltrim($params['data']['objectClass'], '\\');
   447|             $reflection = new \ReflectionClass($class);
   448|             if (!empty($params['data']['objectId']) && $reflection->implementsInterface(ElementInterface::class)) {
   449|                 $obj = $class::getById($params['data']['objectId']);
   450|                 if (!is_null($obj)) {
   451|                     $data = $obj;
   452|                 }
   453|             }
   454|         } else {
   455|             $data = $params['data']['value'];
   456|         }
   457|         return $data;
   458|     }
   459| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/External/AdminerController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-229 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\External {
    15|     use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16|     use Pimcore\Controller\KernelControllerEventInterface;
    17|     use Pimcore\Tool\Session;
    18|     use Symfony\Component\HttpFoundation\Request;
    19|     use Symfony\Component\HttpFoundation\Response;
    20|     use Symfony\Component\HttpKernel\Event\ControllerEvent;
    21|     use Symfony\Component\HttpKernel\Profiler\Profiler;
    22|     use Symfony\Component\Routing\Annotation\Route;
    23|     /**
    24|      * @internal
    25|      */
    26|     class AdminerController extends AdminController implements KernelControllerEventInterface
    27|     {
    28|         /**
    29|          * @var string
    30|          */
    31|         protected $adminerHome = '';
    32|         /**
    33|          * @Route("/external_adminer/adminer", name="pimcore_admin_external_adminer_adminer")
    34|          *
    35|          * @param Request $request
    36|          * @param Profiler $profiler
    37|          *
    38|          * @return Response
    39|          */
    40|         public function adminerAction(Request $request, ?Profiler $profiler)
    41|         {
    42|             if ($profiler) {
    43|                 $profiler->disable();
    44|             }
    45|             $errorHandler = set_error_handler(function () {
    46|             });
    47|             chdir($this->adminerHome . 'adminer');
    48|             include($this->adminerHome . 'adminer/index.php');
    49|             set_error_handler($errorHandler);
    50|             $response = new Response();
    51|             return $this->mergeAdminerHeaders($response);
    52|         }
    53|         /**
    54|          * @Route("/external_adminer/{path}", name="pimcore_admin_external_adminer_proxy", requirements={"path"=".*"})
    55|          * @Route("/adminer/{path}", name="pimcore_admin_external_adminer_proxy_1", requirements={"path"=".*"})
    56|          * @Route("/externals/{path}", name="pimcore_admin_external_adminer_proxy_2", requirements={"path"=".*"}, defaults={"type": "external"})
    57|          *
    58|          * @param Request $request
    59|          *
    60|          * @return Response
    61|          */
    62|         public function proxyAction(Request $request)
    63|         {
    64|             $response = new Response();
    65|             $content = '';
    66|             $path = $request->get('path');
    67|             if (preg_match("@\.(css|js|ico|png|jpg|gif)$@", $path)) {
    68|                 if ($request->get('type') == 'external') {
    69|                     $path = '../' . $path;
    70|                 }
    71|                 if (strpos($path, 'static/') === 0) {
    72|                     $path = 'adminer/' . $path;
    73|                 }
    74|                 $filePath = $this->adminerHome . '/' . $path;
    75|                 if (preg_match('@.css$@', $path)) {
    76|                     $response->headers->set('Content-Type', 'text/css');
    77|                 } elseif (preg_match('@.js$@', $path)) {
    78|                     $response->headers->set('Content-Type', 'text/javascript');
    79|                 }
    80|                 if (file_exists($filePath)) {
    81|                     $content = file_get_contents($filePath);
    82|                     if (preg_match('@default.css$@', $path)) {
    83|                         $content .= file_get_contents($this->adminerHome . 'designs/konya/adminer.css');
    84|                         $content .= file_get_contents(PIMCORE_WEB_ROOT . '/bundles/pimcoreadmin/css/adminer-modifications.css');
    85|                     }
    86|                 }
    87|             }
    88|             $response->setContent($content);
    89|             return $this->mergeAdminerHeaders($response);
    90|         }
    91|         /**
    92|          * @param ControllerEvent $event
    93|          */
    94|         public function onKernelControllerEvent(ControllerEvent $event)
    95|         {
    96|             $isMasterRequest = $event->isMasterRequest();
    97|             if (!$isMasterRequest) {
    98|                 return;
    99|             }
   100|             $request = $event->getRequest();
   101|             ini_set('display_errors', 0);
   102|             $this->checkPermission('adminer');
   103|             $session = Session::get();
   104|             $this->adminerHome = PIMCORE_COMPOSER_PATH . '/vrana/adminer/';
   105|         }
   106|         /**
   107|          * Merges http-headers set from Adminer via headers function
   108|          * to the Symfony Response Object
   109|          *
   110|          * @param Response $response
   111|          *
   112|          * @return Response
   113|          */
   114|         protected function mergeAdminerHeaders(Response $response)
   115|         {
   116|             if (!headers_sent()) {
   117|                 $headersRaw = headers_list();
   118|                 foreach ($headersRaw as $header) {
   119|                     $header = explode(':', $header, 2);
   120|                     list($headerKey, $headerValue) = $header;
   121|                     if ($headerKey && $headerValue) {
   122|                         $response->headers->set($headerKey, $headerValue);
   123|                     }
   124|                 }
   125|                 header_remove();
   126|             }
   127|             return $response;
   128|         }
   129|     }
   130| }
   131| namespace {
   132|     use Pimcore\Cache;
   133|     use Pimcore\Tool\Session;
   134|     if (!function_exists('adminer_object')) {
   135|         /**
   136|          * @return AdminerPimcore
   137|          */
   138|         function adminer_object()
   139|         {
   140|             $pluginDir = PIMCORE_COMPOSER_PATH . '/vrana/adminer/plugins';
   141|             include_once $pluginDir . '/plugin.php';
   142|             foreach (glob($pluginDir . '/*.php') as $filename) {
   143|                 include_once $filename;
   144|             }
   145|             $plugins = [
   146|                 new \AdminerFrames(),
   147|                 new \AdminerDumpDate,
   148|                 new \AdminerDumpJson,
   149|                 new \AdminerDumpBz2,
   150|                 new \AdminerDumpZip,
   151|                 new \AdminerDumpXml,
   152|                 new \AdminerDumpAlter,
   153|             ];
   154|             class AdminerPimcore extends \AdminerPlugin
   155|             {
   156|                 /**
   157|                  * @return string
   158|                  */
   159|                 public function name()
   160|                 {
   161|                     return '';
   162|                 }
   163|                 public function loginForm()
   164|                 {
   165|                     parent::loginForm();
   166|                     echo '<script' . nonce() . ">document.querySelector('input[name=auth\\\\[db\\\\]]').value='" . $this->database() . "'; document.querySelector('form').submit()</script>";
   167|                 }
   168|                 /**
   169|                  * @param bool $create
   170|                  *
   171|                  * @return string
   172|                  */
   173|                 public function permanentLogin($create = false)
   174|                 {
   175|                     return Session::getSessionId();
   176|                 }
   177|                 /**
   178|                  * @param string $login
   179|                  * @param string $password
   180|                  *
   181|                  * @return bool
   182|                  */
   183|                 public function login($login, $password)
   184|                 {
   185|                     return true;
   186|                 }
   187|                 /**
   188|                  * @return array
   189|                  */
   190|                 public function credentials()
   191|                 {
   192|                     $params = \Pimcore\Db::get()->getParams();
   193|                     $host = $params['host'] ?? null;
   194|                     if ($port = $params['port'] ?? null) {
   195|                         $host .= ':' . $port;
   196|                     }
   197|                     $result = [
   198|                         $host,
   199|                         $params['user'] ?? null,
   200|                         $params['password'] ?? null,
   201|                     ];
   202|                     return $result;
   203|                 }
   204|                 /**
   205|                  * @return mixed
   206|                  */
   207|                 public function database()
   208|                 {
   209|                     $db = \Pimcore\Db::get();
   210|                     return $db->getDatabase();
   211|                 }
   212|                 public function databases($flush = true)
   213|                 {
   214|                     $cacheKey = 'pimcore_adminer_databases';
   215|                     if (!$return = Cache::load($cacheKey)) {
   216|                         $db = Pimcore\Db::get();
   217|                         $return = $db->fetchAll('SELECT SCHEMA_NAME FROM information_schema.SCHEMATA');
   218|                         foreach ($return as &$ret) {
   219|                             $ret = $ret['SCHEMA_NAME'];
   220|                         }
   221|                         Cache::save($return, $cacheKey);
   222|                     }
   223|                     return $return;
   224|                 }
   225|             }
   226|             return new AdminerPimcore($plugins);
   227|         }
   228|     }
   229| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/External/OpcacheController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin\External;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Controller\KernelControllerEventInterface;
    17| use Symfony\Component\HttpFoundation\Request;
    18| use Symfony\Component\HttpFoundation\Response;
    19| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    20| use Symfony\Component\HttpKernel\Profiler\Profiler;
    21| use Symfony\Component\Routing\Annotation\Route;
    22| /**
    23|  * @internal
    24|  */
    25| class OpcacheController extends AdminController implements KernelControllerEventInterface
    26| {
    27|     /**
    28|      * @Route("/external_opcache", name="pimcore_admin_external_opcache_index")
    29|      *
    30|      * @param Request $request
    31|      * @param Profiler $profiler
    32|      *
    33|      * @return Response
    34|      */
    35|     public function indexAction(Request $request, ?Profiler $profiler)
    36|     {
    37|         if ($profiler) {
    38|             $profiler->disable();
    39|         }
    40|         $path = PIMCORE_COMPOSER_PATH . '/amnuts/opcache-gui';
    41|         ob_start();
    42|         include($path . '/index.php');
    43|         $content = ob_get_clean();
    44|         return new Response($content);
    45|     }
    46|     /**
    47|      * @param ControllerEvent $event
    48|      */
    49|     public function onKernelControllerEvent(ControllerEvent $event)
    50|     {
    51|         $isMasterRequest = $event->isMasterRequest();
    52|         if (!$isMasterRequest) {
    53|             return;
    54|         }
    55|         $this->checkPermission('opcache');
    56|     }
    57| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/IndexController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-332 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Analytics\Google\Config\SiteConfigProvider;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    18| use Pimcore\Bundle\AdminBundle\Security\CsrfProtectionHandler;
    19| use Pimcore\Config;
    20| use Pimcore\Controller\KernelResponseEventInterface;
    21| use Pimcore\Db\ConnectionInterface;
    22| use Pimcore\Event\Admin\IndexActionSettingsEvent;
    23| use Pimcore\Event\AdminEvents;
    24| use Pimcore\Extension\Bundle\PimcoreBundleManager;
    25| use Pimcore\Google;
    26| use Pimcore\Maintenance\Executor;
    27| use Pimcore\Maintenance\ExecutorInterface;
    28| use Pimcore\Model\Element\Service;
    29| use Pimcore\Model\User;
    30| use Pimcore\Tool;
    31| use Pimcore\Tool\Admin;
    32| use Pimcore\Tool\Session;
    33| use Pimcore\Version;
    34| use Symfony\Component\HttpFoundation\Request;
    35| use Symfony\Component\HttpFoundation\Response;
    36| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    37| use Symfony\Component\HttpKernel\Event\ResponseEvent;
    38| use Symfony\Component\HttpKernel\KernelInterface;
    39| use Symfony\Component\Routing\Annotation\Route;
    40| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    41| /**
    42|  * @internal
    43|  */
    44| class IndexController extends AdminController implements KernelResponseEventInterface
    45| {
    46|     /**
    47|      * @var EventDispatcherInterface
    48|      */
    49|     private $eventDispatcher;
    50|     /**
    51|      * @param EventDispatcherInterface $eventDispatcher
    52|      */
    53|     public function __construct(EventDispatcherInterface $eventDispatcher)
    54|     {
    55|         $this->eventDispatcher = $eventDispatcher;
    56|     }
    57|     /**
    58|      * @Route("/", name="pimcore_admin_index", methods={"GET"})
    59|      *
    60|      * @param Request $request
    61|      * @param SiteConfigProvider $siteConfigProvider
    62|      * @param KernelInterface $kernel
    63|      * @param Executor $maintenanceExecutor
    64|      * @param CsrfProtectionHandler $csrfProtection
    65|      * @param Config $config
    66|      *
    67|      * @return Response
    68|      *
    69|      * @throws \Exception
    70|      */
    71|     public function indexAction(
    72|         Request $request,
    73|         SiteConfigProvider $siteConfigProvider,
    74|         KernelInterface $kernel,
    75|         Executor $maintenanceExecutor,
    76|         CsrfProtectionHandler $csrfProtection,
    77|         Config $config
    78|     ) {
    79|         $user = $this->getAdminUser();
    80|         $templateParams = [
    81|             'config' => $config,
    82|         ];
    83|         $this
    84|             ->addRuntimePerspective($templateParams, $user)
    85|             ->addPluginAssets($templateParams);
    86|         $this->buildPimcoreSettings($request, $templateParams, $user, $kernel, $maintenanceExecutor, $csrfProtection, $siteConfigProvider);
    87|         if ($user->getTwoFactorAuthentication('required') && !$user->getTwoFactorAuthentication('enabled')) {
    88|             $user->setTwoFactorAuthentication('enabled', true);
    89|             Tool\Session::useSession(function (AttributeBagInterface $adminSession) {
    90|                 $adminSession->set('2fa_required', false);
    91|             });
    92|             $user->save();
    93|             $templateParams['settings']['twoFactorSetupRequired'] = true;
    94|         }
    95|         $settingsEvent = new IndexActionSettingsEvent($templateParams['settings'] ?? []);
    96|         $this->eventDispatcher->dispatch($settingsEvent, AdminEvents::INDEX_ACTION_SETTINGS);
    97|         $templateParams['settings'] = $settingsEvent->getSettings();
    98|         return $this->render('@PimcoreAdmin/Admin/Index/index.html.twig', $templateParams);
    99|     }
   100|     /**
   101|      * @Route("/index/statistics", name="pimcore_admin_index_statistics", methods={"GET"})
   102|      *
   103|      * @param Request $request
   104|      * @param ConnectionInterface $db
   105|      * @param KernelInterface $kernel
   106|      *
   107|      * @return JsonResponse
   108|      *
   109|      * @throws \Exception
   110|      */
   111|     public function statisticsAction(Request $request, ConnectionInterface $db, KernelInterface $kernel)
   112|     {
   113|         try {
   114|             $tables = $db->fetchAll('SELECT TABLE_NAME as name,TABLE_ROWS as `rows` from information_schema.TABLES
   115|                 WHERE TABLE_ROWS IS NOT NULL AND TABLE_SCHEMA = ?', [$db->getDatabase()]);
   116|         } catch (\Exception $e) {
   117|             $tables = [];
   118|         }
   119|         try {
   120|             $mysqlVersion = $db->fetchOne('SELECT VERSION()');
   121|         } catch (\Exception $e) {
   122|             $mysqlVersion = null;
   123|         }
   124|         try {
   125|             $data = [
   126|                 'instanceId' => $this->getInstanceId(),
   127|                 'pimcore_major_version' => 10,
   128|                 'pimcore_version' => Version::getVersion(),
   129|                 'pimcore_hash' => Version::getRevision(),
   130|                 'php_version' => PHP_VERSION,
   131|                 'mysql_version' => $mysqlVersion,
   132|                 'bundles' => array_keys($kernel->getBundles()),
   133|                 'tables' => $tables,
   134|             ];
   135|         } catch (\Exception $e) {
   136|             $data = [];
   137|         }
   138|         return $this->adminJson($data);
   139|     }
   140|     /**
   141|      * @param array $templateParams
   142|      * @param User $user
   143|      *
   144|      * @return $this
   145|      */
   146|     protected function addRuntimePerspective(array &$templateParams, User $user)
   147|     {
   148|         $runtimePerspective = Config::getRuntimePerspective($user);
   149|         $templateParams['runtimePerspective'] = $runtimePerspective;
   150|         return $this;
   151|     }
   152|     /**
   153|      * @param array $templateParams
   154|      *
   155|      * @return $this
   156|      */
   157|     protected function addPluginAssets(array &$templateParams)
   158|     {
   159|         $bundleManager = $this->get(PimcoreBundleManager::class);
   160|         $templateParams['pluginJsPaths'] = $bundleManager->getJsPaths();
   161|         $templateParams['pluginCssPaths'] = $bundleManager->getCssPaths();
   162|         return $this;
   163|     }
   164|     /**
   165|      * @param Request $request
   166|      * @param array $templateParams
   167|      * @param User $user
   168|      * @param KernelInterface $kernel
   169|      * @param ExecutorInterface $maintenanceExecutor
   170|      * @param CsrfProtectionHandler $csrfProtection
   171|      * @param SiteConfigProvider $siteConfigProvider
   172|      *
   173|      * @return $this
   174|      */
   175|     protected function buildPimcoreSettings(Request $request, array &$templateParams, User $user, KernelInterface $kernel, ExecutorInterface $maintenanceExecutor, CsrfProtectionHandler $csrfProtection, SiteConfigProvider $siteConfigProvider)
   176|     {
   177|         $config = $templateParams['config'];
   178|         $dashboardHelper = new \Pimcore\Helper\Dashboard($user);
   179|         $settings = [
   180|             'instanceId' => $this->getInstanceId(),
   181|             'version' => Version::getVersion(),
   182|             'build' => Version::getRevision(),
   183|             'debug' => \Pimcore::inDebugMode(),
   184|             'devmode' => \Pimcore::inDevMode(),
   185|             'disableMinifyJs' => \Pimcore::disableMinifyJs(),
   186|             'environment' => $kernel->getEnvironment(),
   187|             'cached_environments' => Tool::getCachedSymfonyEnvironments(),
   188|             'sessionId' => htmlentities(Session::getSessionId(), ENT_QUOTES, 'UTF-8'),
   189|             'language' => $request->getLocale(),
   190|             'websiteLanguages' => Admin::reorderWebsiteLanguages(
   191|                 $this->getAdminUser(),
   192|                 $config['general']['valid_languages'],
   193|                 true
   194|             ),
   195|             'showCloseConfirmation' => true,
   196|             'debug_admin_translations' => (bool)$config['general']['debug_admin_translations'],
   197|             'document_generatepreviews' => (bool)$config['documents']['generate_preview'],
   198|             'asset_disable_tree_preview' => (bool)$config['assets']['disable_tree_preview'],
   199|             'htmltoimage' => \Pimcore\Image\HtmlToImage::isSupported(),
   200|             'videoconverter' => \Pimcore\Video::isAvailable(),
   201|             'asset_hide_edit' => (bool)$config['assets']['hide_edit_image'],
   202|             'main_domain' => $config['general']['domain'],
   203|             'timezone' => $config['general']['timezone'],
   204|             'tile_layer_url_template' => $config['maps']['tile_layer_url_template'],
   205|             'geocoding_url_template' => $config['maps']['geocoding_url_template'],
   206|             'reverse_geocoding_url_template' => $config['maps']['reverse_geocoding_url_template'],
   207|             'asset_tree_paging_limit' => $config['assets']['tree_paging_limit'],
   208|             'document_tree_paging_limit' => $config['documents']['tree_paging_limit'],
   209|             'object_tree_paging_limit' => $config['objects']['tree_paging_limit'],
   210|             'maxmind_geoip_installed' => (bool) $this->getParameter('pimcore.geoip.db_file'),
   211|             'hostname' => htmlentities(\Pimcore\Tool::getHostname(), ENT_QUOTES, 'UTF-8'),
   212|             'document_auto_save_interval' => $config['documents']['auto_save_interval'],
   213|             'object_auto_save_interval' => $config['objects']['auto_save_interval'],
   214|             'perspective' => $templateParams['runtimePerspective'],
   215|             'availablePerspectives' => Config::getAvailablePerspectives($user),
   216|             'disabledPortlets' => $dashboardHelper->getDisabledPortlets(),
   217|             'google_analytics_enabled' => (bool) $siteConfigProvider->isSiteReportingConfigured(),
   218|         ];
   219|         $this
   220|             ->addSystemVarSettings($settings)
   221|             ->addMaintenanceSettings($settings, $maintenanceExecutor)
   222|             ->addMailSettings($settings, $config)
   223|             ->addCustomViewSettings($settings);
   224|         $settings['csrfToken'] = $csrfProtection->getCsrfToken();
   225|         $templateParams['settings'] = $settings;
   226|         return $this;
   227|     }
   228|     /**
   229|      * @return string
   230|      */
   231|     private function getInstanceId()
   232|     {
   233|         $instanceId = 'not-set';
   234|         try {
   235|             $instanceId = $this->getParameter('secret');
   236|             $instanceId = sha1(substr($instanceId, 3, -3));
   237|         } catch (\Exception $e) {
   238|         }
   239|         return $instanceId;
   240|     }
   241|     /**
   242|      * @param array $settings
   243|      *
   244|      * @return $this
   245|      */
   246|     protected function addSystemVarSettings(array &$settings)
   247|     {
   248|         $max_upload = filesize2bytes(ini_get('upload_max_filesize') . 'B');
   249|         $max_post = filesize2bytes(ini_get('post_max_size') . 'B');
   250|         $upload_mb = min($max_upload, $max_post);
   251|         $settings['upload_max_filesize'] = (int) $upload_mb;
   252|         $session_gc_maxlifetime = ini_get('session.gc_maxlifetime');
   253|         if (empty($session_gc_maxlifetime)) {
   254|             $session_gc_maxlifetime = 120;
   255|         }
   256|         $settings['session_gc_maxlifetime'] = (int)$session_gc_maxlifetime;
   257|         return $this;
   258|     }
   259|     /**
   260|      * @param array $settings
   261|      * @param ExecutorInterface $maintenanceExecutor
   262|      *
   263|      * @return $this
   264|      */
   265|     protected function addMaintenanceSettings(array &$settings, ExecutorInterface $maintenanceExecutor)
   266|     {
   267|         $maintenance_active = false;
   268|         if ($lastExecution = $maintenanceExecutor->getLastExecution()) {
   269|             if ((time() - $lastExecution) < 3660) { // maintenance script should run at least every hour + a little tolerance
   270|                 $maintenance_active = true;
   271|             }
   272|         }
   273|         $settings['maintenance_active'] = $maintenance_active;
   274|         $settings['maintenance_mode'] = Admin::isInMaintenanceMode();
   275|         return $this;
   276|     }
   277|     /**
   278|      * @param array $settings
   279|      * @param Config $config
   280|      *
   281|      * @return $this
   282|      */
   283|     protected function addMailSettings(array &$settings, $config)
   284|     {
   285|         $mailIncomplete = false;
   286|         if (isset($config['email'])) {
   287|             if (empty($config['email']['debug']['email_addresses'])) {
   288|                 $mailIncomplete = true;
   289|             }
   290|             if (empty($config['email']['sender']['email'])) {
   291|                 $mailIncomplete = true;
   292|             }
   293|         }
   294|         $settings['mail'] = !$mailIncomplete;
   295|         $settings['mailDefaultAddress'] = $config['email']['sender']['email'] ?? null;
   296|         return $this;
   297|     }
   298|     /**
   299|      * @param array $settings
   300|      *
   301|      * @return $this
   302|      */
   303|     protected function addCustomViewSettings(array &$settings)
   304|     {
   305|         $cvData = [];
   306|         $cvConfig = Tool::getCustomViewConfig();
   307|         if ($cvConfig) {
   308|             foreach ($cvConfig as $node) {
   309|                 $tmpData = $node;
   310|                 $treeType = $tmpData['treetype'] ? $tmpData['treetype'] : 'object';
   311|                 $rootNode = Service::getElementByPath($treeType, $tmpData['rootfolder']);
   312|                 if ($rootNode) {
   313|                     $tmpData['rootId'] = $rootNode->getId();
   314|                     $tmpData['allowedClasses'] = $tmpData['classes'] ?? null;
   315|                     $tmpData['showroot'] = (bool)$tmpData['showroot'];
   316|                     if ($rootNode->isAllowed('list')) {
   317|                         $cvData[] = $tmpData;
   318|                     }
   319|                 }
   320|             }
   321|         }
   322|         $settings['customviews'] = $cvData;
   323|         return $this;
   324|     }
   325|     /**
   326|      * {@inheritdoc}
   327|      */
   328|     public function onKernelResponseEvent(ResponseEvent $event)
   329|     {
   330|         $event->getResponse()->headers->set('X-Frame-Options', 'deny', true);
   331|     }
   332| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/InstallController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Db\ConnectionInterface;
    17| use Pimcore\Tool\Requirements;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\HttpFoundation\Response;
    20| use Symfony\Component\HttpKernel\Profiler\Profiler;
    21| use Symfony\Component\Routing\Annotation\Route;
    22| /**
    23|  * @Route("/install")
    24|  *
    25|  * @internal
    26|  */
    27| class InstallController extends AdminController
    28| {
    29|     /**
    30|      * @Route("/check", name="pimcore_admin_install_check", methods={"GET", "POST"})
    31|      *
    32|      * @param Request $request
    33|      * @param ConnectionInterface $db
    34|      * @param Profiler $profiler
    35|      *
    36|      * @return Response
    37|      */
    38|     public function checkAction(Request $request, ConnectionInterface $db, ?Profiler $profiler)
    39|     {
    40|         if ($profiler) {
    41|             $profiler->disable();
    42|         }
    43|         $viewParams = Requirements::checkAll($db);
    44|         $viewParams['headless'] = (bool)$request->get('headless');
    45|         return $this->render('@PimcoreAdmin/Admin/Install/check.html.twig', $viewParams);
    46|     }
    47| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/LogController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-232 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Doctrine\DBAL\Types\Types;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\Bundle\AdminBundle\Helper\QueryParams;
    18| use Pimcore\Controller\KernelControllerEventInterface;
    19| use Pimcore\Db;
    20| use Pimcore\Log\Handler\ApplicationLoggerDb;
    21| use Symfony\Component\HttpFoundation\JsonResponse;
    22| use Symfony\Component\HttpFoundation\Request;
    23| use Symfony\Component\HttpFoundation\Response;
    24| use Symfony\Component\HttpFoundation\StreamedResponse;
    25| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    26| use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;
    27| use Symfony\Component\Routing\Annotation\Route;
    28| /**
    29|  * @internal
    30|  */
    31| class LogController extends AdminController implements KernelControllerEventInterface
    32| {
    33|     /**
    34|      * @param ControllerEvent $event
    35|      */
    36|     public function onKernelControllerEvent(ControllerEvent $event)
    37|     {
    38|         if (!$this->getAdminUser()->isAllowed('application_logging')) {
    39|             throw new AccessDeniedHttpException("Permission denied, user needs 'application_logging' permission.");
    40|         }
    41|     }
    42|     /**
    43|      * @Route("/log/show", name="pimcore_admin_log_show", methods={"GET", "POST"})
    44|      *
    45|      * @param Request $request
    46|      *
    47|      * @return JsonResponse
    48|      */
    49|     public function showAction(Request $request, Db\ConnectionInterface $db)
    50|     {
    51|         $qb = $db->createQueryBuilder();
    52|         $qb
    53|             ->select('*')
    54|             ->from(ApplicationLoggerDb::TABLE_NAME)
    55|             ->setFirstResult($request->get('start', 0))
    56|             ->setMaxResults($request->get('limit', 50));
    57|         $sortingSettings = QueryParams::extractSortingSettings(array_merge(
    58|             $request->request->all(),
    59|             $request->query->all()
    60|         ));
    61|         if ($sortingSettings['orderKey']) {
    62|             $qb->orderBy($sortingSettings['orderKey'], $sortingSettings['order']);
    63|         } else {
    64|             $qb->orderBy('id', 'DESC');
    65|         }
    66|         $priority = $request->get('priority');
    67|         if ($priority !== '-1' && ($priority == '0' || $priority)) {
    68|             $levels = [];
    69|             foreach (['emergency', 'alert', 'critical', 'error', 'warning', 'notice', 'info', 'debug'] as $level) {
    70|                 $levels[] = $level;
    71|                 if ($priority === $level) {
    72|                     break;
    73|                 }
    74|             }
    75|             $qb->andWhere($qb->expr()->in('priority', ':priority'));
    76|             $qb->setParameter('priority', $levels, Db\Connection::PARAM_STR_ARRAY);
    77|         }
    78|         if ($fromDate = $this->parseDateObject($request->get('fromDate'), $request->get('fromTime'))) {
    79|             $qb->andWhere('timestamp > :fromDate');
    80|             $qb->setParameter('fromDate', $fromDate, Types::DATETIME_MUTABLE);
    81|         }
    82|         if ($toDate = $this->parseDateObject($request->get('toDate'), $request->get('toTime'))) {
    83|             $qb->andWhere('timestamp <= :toDate');
    84|             $qb->setParameter('toDate', $toDate, Types::DATETIME_MUTABLE);
    85|         }
    86|         if (!empty($component = $request->get('component'))) {
    87|             $qb->andWhere('component = ' . $qb->createNamedParameter($component));
    88|         }
    89|         if (!empty($relatedObject = $request->get('relatedobject'))) {
    90|             $qb->andWhere('relatedobject = ' . $qb->createNamedParameter($relatedObject));
    91|         }
    92|         if (!empty($message = $request->get('message'))) {
    93|             $qb->andWhere('message LIKE ' . $qb->createNamedParameter('%' . $message . '%'));
    94|         }
    95|         if (!empty($pid = $request->get('pid'))) {
    96|             $qb->andWhere('pid LIKE ' . $qb->createNamedParameter('%' . $pid . '%'));
    97|         }
    98|         $totalQb = clone $qb;
    99|         $totalQb->setMaxResults(null)
   100|             ->setFirstResult(0)
   101|             ->select('COUNT(id) as count');
   102|         $total = $totalQb->execute()->fetch();
   103|         $total = (int) $total['count'];
   104|         $stmt = $qb->execute();
   105|         $result = $stmt->fetchAll();
   106|         $logEntries = [];
   107|         foreach ($result as $row) {
   108|             $fileobject = null;
   109|             if ($row['fileobject']) {
   110|                 $fileobject = str_replace(PIMCORE_PROJECT_ROOT, '', $row['fileobject']);
   111|             }
   112|             $logEntry = [
   113|                 'id' => $row['id'],
   114|                 'pid' => $row['pid'],
   115|                 'message' => $row['message'],
   116|                 'timestamp' => $row['timestamp'],
   117|                 'priority' => $this->getPriorityName($row['priority']),
   118|                 'fileobject' => $fileobject,
   119|                 'relatedobject' => $row['relatedobject'],
   120|                 'relatedobjecttype' => $row['relatedobjecttype'],
   121|                 'component' => $row['component'],
   122|                 'source' => $row['source'],
   123|             ];
   124|             $logEntries[] = $logEntry;
   125|         }
   126|         return $this->adminJson([
   127|             'p_totalCount' => $total,
   128|             'p_results' => $logEntries,
   129|         ]);
   130|     }
   131|     /**
   132|      * @param string|null $date
   133|      * @param string|null $time
   134|      *
   135|      * @return \DateTime|null
   136|      */
   137|     private function parseDateObject($date = null, $time = null)
   138|     {
   139|         if (empty($date)) {
   140|             return null;
   141|         }
   142|         $pattern = '/^(?P<date>\d{4}\-\d{2}\-\d{2})T(?P<time>\d{2}:\d{2}:\d{2})$/';
   143|         $dateTime = null;
   144|         if (preg_match($pattern, $date, $dateMatches)) {
   145|             if (!empty($time) && preg_match($pattern, $time, $timeMatches)) {
   146|                 $dateTime = new \DateTime(sprintf('%sT%s', $dateMatches['date'], $timeMatches['time']));
   147|             } else {
   148|                 $dateTime = new \DateTime($date);
   149|             }
   150|         }
   151|         return $dateTime;
   152|     }
   153|     /**
   154|      * @param int $priority
   155|      *
   156|      * @return string
   157|      */
   158|     private function getPriorityName($priority)
   159|     {
   160|         $p = ApplicationLoggerDb::getPriorities();
   161|         return $p[$priority];
   162|     }
   163|     /**
   164|      * @Route("/log/priority-json", name="pimcore_admin_log_priorityjson", methods={"GET"})
   165|      *
   166|      * @param Request $request
   167|      *
   168|      * @return JsonResponse
   169|      */
   170|     public function priorityJsonAction(Request $request)
   171|     {
   172|         $priorities[] = ['key' => '-1', 'value' => '-'];
   173|         foreach (ApplicationLoggerDb::getPriorities() as $key => $p) {
   174|             $priorities[] = ['key' => $key, 'value' => $p];
   175|         }
   176|         return $this->adminJson(['priorities' => $priorities]);
   177|     }
   178|     /**
   179|      * @Route("/log/component-json", name="pimcore_admin_log_componentjson", methods={"GET"})
   180|      *
   181|      * @param Request $request
   182|      *
   183|      * @return JsonResponse
   184|      */
   185|     public function componentJsonAction(Request $request)
   186|     {
   187|         $components[] = ['key' => '', 'value' => '-'];
   188|         foreach (ApplicationLoggerDb::getComponents() as $p) {
   189|             $components[] = ['key' => $p, 'value' => $p];
   190|         }
   191|         return $this->adminJson(['components' => $components]);
   192|     }
   193|     /**
   194|      * @Route("/log/show-file-object", name="pimcore_admin_log_showfileobject", methods={"GET"})
   195|      *
   196|      * @param Request $request
   197|      *
   198|      * @return Response
   199|      *
   200|      * @throws \Exception
   201|      */
   202|     public function showFileObjectAction(Request $request)
   203|     {
   204|         $filePath = $request->get('filePath');
   205|         if (!filter_var($filePath, FILTER_VALIDATE_URL)) {
   206|             $filePath = PIMCORE_PROJECT_ROOT . DIRECTORY_SEPARATOR . $filePath;
   207|             $filePath = realpath($filePath);
   208|             $fileObjectPath = realpath(PIMCORE_LOG_FILEOBJECT_DIRECTORY);
   209|         } else {
   210|             $fileObjectPath = PIMCORE_LOG_FILEOBJECT_DIRECTORY;
   211|         }
   212|         if (!preg_match('@^' . $fileObjectPath . '@', $filePath)) {
   213|             throw new AccessDeniedHttpException('Accessing file out of scope');
   214|         }
   215|         if (file_exists($filePath)) {
   216|             $response = new StreamedResponse(
   217|                 static function () use ($filePath) {
   218|                     $handle = fopen($filePath, 'rb');
   219|                     fpassthru($handle);
   220|                     fclose($handle);
   221|                 }
   222|             );
   223|             $response->headers->set('Content-Type', 'text/plain');
   224|         } else {
   225|             $response = new Response();
   226|             $response->headers->set('Content-Type', 'text/plain');
   227|             $response->setContent('Path `'.$filePath.'` not found.');
   228|             $response->setStatusCode(404);
   229|         }
   230|         return $response;
   231|     }
   232| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/LoginController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-276 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Bundle\AdminBundle\Controller\BruteforceProtectedControllerInterface;
    17| use Pimcore\Bundle\AdminBundle\Security\BruteforceProtectionHandler;
    18| use Pimcore\Bundle\AdminBundle\Security\CsrfProtectionHandler;
    19| use Pimcore\Config;
    20| use Pimcore\Controller\KernelControllerEventInterface;
    21| use Pimcore\Controller\KernelResponseEventInterface;
    22| use Pimcore\Event\Admin\Login\LostPasswordEvent;
    23| use Pimcore\Event\AdminEvents;
    24| use Pimcore\Extension\Bundle\PimcoreBundleManager;
    25| use Pimcore\Http\ResponseHelper;
    26| use Pimcore\Logger;
    27| use Pimcore\Model\User;
    28| use Pimcore\Tool;
    29| use Pimcore\Tool\Authentication;
    30| use Symfony\Component\HttpFoundation\RedirectResponse;
    31| use Symfony\Component\HttpFoundation\Request;
    32| use Symfony\Component\HttpFoundation\Response;
    33| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    34| use Symfony\Component\HttpKernel\Event\ResponseEvent;
    35| use Symfony\Component\Routing\Annotation\Route;
    36| use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
    37| use Symfony\Component\Security\Core\Exception\AuthenticationException;
    38| use Symfony\Component\Security\Core\Security;
    39| use Symfony\Component\Security\Core\User\UserInterface;
    40| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    41| /**
    42|  * @internal
    43|  */
    44| class LoginController extends AdminController implements BruteforceProtectedControllerInterface, KernelControllerEventInterface, KernelResponseEventInterface
    45| {
    46|     /**
    47|      * @var ResponseHelper
    48|      */
    49|     protected $reponseHelper;
    50|     public function __construct(ResponseHelper $responseHelper)
    51|     {
    52|         $this->reponseHelper = $responseHelper;
    53|     }
    54|     /**
    55|      * @param ControllerEvent $event
    56|      */
    57|     public function onKernelControllerEvent(ControllerEvent $event)
    58|     {
    59|         $locale = 'en';
    60|         $availableLocales = Tool\Admin::getLanguages();
    61|         foreach ($event->getRequest()->getLanguages() as $userLocale) {
    62|             if (in_array($userLocale, $availableLocales)) {
    63|                 $locale = $userLocale;
    64|                 break;
    65|             }
    66|         }
    67|         $this->get('translator')->setLocale($locale);
    68|     }
    69|     /**
    70|      * {@inheritdoc}
    71|      */
    72|     public function onKernelResponseEvent(ResponseEvent $event)
    73|     {
    74|         $response = $event->getResponse();
    75|         $response->headers->set('X-Frame-Options', 'deny', true);
    76|         $this->reponseHelper->disableCache($response, true);
    77|     }
    78|     /**
    79|      * @Route("/login", name="pimcore_admin_login")
    80|      * @Route("/login/", name="pimcore_admin_login_fallback")
    81|      */
    82|     public function loginAction(Request $request, CsrfProtectionHandler $csrfProtection, Config $config)
    83|     {
    84|         if ($request->get('_route') === 'pimcore_admin_login_fallback') {
    85|             return $this->redirectToRoute('pimcore_admin_login', $request->query->all(), Response::HTTP_MOVED_PERMANENTLY);
    86|         }
    87|         $csrfProtection->regenerateCsrfToken();
    88|         $user = $this->getAdminUser();
    89|         if ($user instanceof UserInterface) {
    90|             return $this->redirectToRoute('pimcore_admin_index');
    91|         }
    92|         $params = $this->buildLoginPageViewParams($config);
    93|         $session_gc_maxlifetime = ini_get('session.gc_maxlifetime');
    94|         if (empty($session_gc_maxlifetime)) {
    95|             $session_gc_maxlifetime = 120;
    96|         }
    97|         $params['csrfTokenRefreshInterval'] = ((int)$session_gc_maxlifetime - 60) * 1000;
    98|         if ($request->get('auth_failed')) {
    99|             $params['error'] = 'error_auth_failed';
   100|         }
   101|         if ($request->get('session_expired')) {
   102|             $params['error'] = 'error_session_expired';
   103|         }
   104|         if ($request->get('deeplink')) {
   105|             $params['deeplink'] = true;
   106|         }
   107|         $params['browserSupported'] = $this->detectBrowser();
   108|         $params['debug'] = \Pimcore::inDebugMode();
   109|         return $this->render('@PimcoreAdmin/Admin/Login/login.html.twig', $params);
   110|     }
   111|     /**
   112|      * @Route("/login/csrf-token", name="pimcore_admin_login_csrf_token")
   113|      */
   114|     public function csrfTokenAction(Request $request, CsrfProtectionHandler $csrfProtection)
   115|     {
   116|         if (!$this->getAdminUser()) {
   117|             $csrfProtection->regenerateCsrfToken();
   118|         }
   119|         return $this->json([
   120|            'csrfToken' => $csrfProtection->getCsrfToken(),
   121|         ]);
   122|     }
   123|     /**
   124|      * @Route("/logout", name="pimcore_admin_logout")
   125|      */
   126|     public function logoutAction()
   127|     {
   128|     }
   129|     /**
   130|      * Dummy route used to check authentication
   131|      *
   132|      * @Route("/login/login", name="pimcore_admin_login_check")
   133|      *
   134|      * @see AdminAuthenticator for the security implementation
   135|      */
   136|     public function loginCheckAction()
   137|     {
   138|         return new RedirectResponse($this->generateUrl('pimcore_admin_login'));
   139|     }
   140|     /**
   141|      * @Route("/login/lostpassword", name="pimcore_admin_login_lostpassword")
   142|      */
   143|     public function lostpasswordAction(Request $request, BruteforceProtectionHandler $bruteforceProtectionHandler, CsrfProtectionHandler $csrfProtection, Config $config, EventDispatcherInterface $eventDispatcher)
   144|     {
   145|         $params = $this->buildLoginPageViewParams($config);
   146|         $error = null;
   147|         if ($request->getMethod() === 'POST' && $username = $request->get('username')) {
   148|             $user = User::getByName($username);
   149|             if ($user instanceof User) {
   150|                 if (!$user->isActive()) {
   151|                     $error = 'user_inactive';
   152|                 }
   153|                 if (!$user->getEmail()) {
   154|                     $error = 'user_no_email_address';
   155|                 }
   156|                 if (!$user->getPassword()) {
   157|                     $error = 'user_no_password';
   158|                 }
   159|             } else {
   160|                 $error = 'user_unknown';
   161|             }
   162|             if (!$error && $user instanceof User) {
   163|                 $token = Authentication::generateToken($user->getName());
   164|                 $loginUrl = $this->generateUrl('pimcore_admin_login_check', [
   165|                     'token' => $token,
   166|                     'reset' => 'true',
   167|                 ], UrlGeneratorInterface::ABSOLUTE_URL);
   168|                 try {
   169|                     $event = new LostPasswordEvent($user, $loginUrl);
   170|                     $eventDispatcher->dispatch($event, AdminEvents::LOGIN_LOSTPASSWORD);
   171|                     if ($event->getSendMail()) {
   172|                         $mail = Tool::getMail([$user->getEmail()], 'Pimcore lost password service');
   173|                         $mail->setIgnoreDebugMode(true);
   174|                         $mail->text("Login to pimcore and change your password using the following link. This temporary login link will expire in 24 hours: \r\n\r\n" . $loginUrl);
   175|                         $mail->send();
   176|                     }
   177|                     if ($event->hasResponse()) {
   178|                         return $event->getResponse();
   179|                     }
   180|                 } catch (\Exception $e) {
   181|                     Logger::error('Error sending password recovery email: ' . $e->getMessage());
   182|                     $error = 'lost_password_email_error';
   183|                 }
   184|             }
   185|             if ($error) {
   186|                 Logger::error('Lost password service: ' . $error);
   187|                 $bruteforceProtectionHandler->addEntry($request->get('username'), $request);
   188|                 $params['error'] = $error;
   189|             }
   190|         }
   191|         $csrfProtection->regenerateCsrfToken();
   192|         return $this->render('@PimcoreAdmin/Admin/Login/lostpassword.html.twig', $params);
   193|     }
   194|     /**
   195|      * @Route("/login/deeplink", name="pimcore_admin_login_deeplink")
   196|      */
   197|     public function deeplinkAction(Request $request)
   198|     {
   199|         $queryString = $_SERVER['QUERY_STRING'];
   200|         if (preg_match('/(document|asset|object)_([0-9]+)_([a-z]+)/', $queryString, $deeplink)) {
   201|             $deeplink = $deeplink[0];
   202|             $perspective = strip_tags($request->get('perspective'));
   203|             if (strpos($queryString, 'token')) {
   204|                 $url = $this->generateUrl('pimcore_admin_login', [
   205|                     'deeplink' => $deeplink,
   206|                     'perspective' => $perspective,
   207|                 ]);
   208|                 $url .= '&' . $queryString;
   209|                 return $this->redirect($url);
   210|             } elseif ($queryString) {
   211|                 return $this->render('@PimcoreAdmin/Admin/Login/deeplink.html.twig', [
   212|                     'tab' => $deeplink,
   213|                     'perspective' => $perspective,
   214|                 ]);
   215|             }
   216|         }
   217|     }
   218|     protected function buildLoginPageViewParams(Config $config): array
   219|     {
   220|         $bundleManager = $this->get(PimcoreBundleManager::class);
   221|         return [
   222|             'config' => $config,
   223|             'pluginCssPaths' => $bundleManager->getCssPaths(),
   224|         ];
   225|     }
   226|     /**
   227|      * @Route("/login/2fa", name="pimcore_admin_2fa")
   228|      */
   229|     public function twoFactorAuthenticationAction(Request $request, BruteforceProtectionHandler $bruteforceProtectionHandler, Config $config)
   230|     {
   231|         $params = $this->buildLoginPageViewParams($config);
   232|         if ($request->hasSession()) {
   233|             $bruteforceProtectionHandler->checkProtection($this->getAdminUser()->getName(), $request);
   234|             $session = $request->getSession();
   235|             $authException = $session->get(Security::AUTHENTICATION_ERROR);
   236|             if ($authException instanceof AuthenticationException) {
   237|                 $session->remove(Security::AUTHENTICATION_ERROR);
   238|                 $params['error'] = $authException->getMessage();
   239|                 $bruteforceProtectionHandler->addEntry($this->getAdminUser()->getName(), $request);
   240|             }
   241|         } else {
   242|             $params['error'] = 'No session available, it either timed out or cookies are not enabled.';
   243|         }
   244|         return $this->render('@PimcoreAdmin/Admin/Login/twoFactorAuthentication.html.twig', $params);
   245|     }
   246|     /**
   247|      * @Route("/login/2fa-verify", name="pimcore_admin_2fa-verify")
   248|      *
   249|      * @param Request $request
   250|      */
   251|     public function twoFactorAuthenticationVerifyAction(Request $request)
   252|     {
   253|     }
   254|     /**
   255|      * @return bool
   256|      */
   257|     public function detectBrowser()
   258|     {
   259|         $supported = false;
   260|         $browser = new \Browser();
   261|         $browserVersion = (int)$browser->getVersion();
   262|         if ($browser->getBrowser() == \Browser::BROWSER_FIREFOX && $browserVersion >= 72) {
   263|             $supported = true;
   264|         }
   265|         if ($browser->getBrowser() == \Browser::BROWSER_CHROME && $browserVersion >= 84) {
   266|             $supported = true;
   267|         }
   268|         if ($browser->getBrowser() == \Browser::BROWSER_SAFARI && $browserVersion >= 13.1) {
   269|             $supported = true;
   270|         }
   271|         if ($browser->getBrowser() == \Browser::BROWSER_OPERA && $browserVersion >= 67) {
   272|             $supported = true;
   273|         }
   274|         return $supported;
   275|     }
   276| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/MiscController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-647 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Config;
    17| use Pimcore\Controller\Config\ControllerDataProvider;
    18| use Pimcore\Db;
    19| use Pimcore\File;
    20| use Pimcore\Localization\LocaleServiceInterface;
    21| use Pimcore\Tool;
    22| use Pimcore\Translation\Translator;
    23| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    24| use Symfony\Component\HttpFoundation\JsonResponse;
    25| use Symfony\Component\HttpFoundation\Request;
    26| use Symfony\Component\HttpFoundation\Response;
    27| use Symfony\Component\HttpKernel\Profiler\Profiler;
    28| use Symfony\Component\Routing\Annotation\Route;
    29| use Symfony\Contracts\Translation\TranslatorInterface;
    30| /**
    31|  * @Route("/misc")
    32|  *
    33|  * @internal
    34|  */
    35| class MiscController extends AdminController
    36| {
    37|     /**
    38|      * @Route("/get-available-controller-references", name="pimcore_admin_misc_getavailablecontroller_references", methods={"GET"})
    39|      *
    40|      * @param Request $request
    41|      * @param ControllerDataProvider $provider
    42|      *
    43|      * @return JsonResponse
    44|      */
    45|     public function getAvailableControllerReferencesAction(Request $request, ControllerDataProvider $provider)
    46|     {
    47|         $controllerReferences = $provider->getControllerReferences();
    48|         $result = array_map(function ($controller) {
    49|             return [
    50|                 'name' => $controller,
    51|             ];
    52|         }, $controllerReferences);
    53|         return $this->adminJson([
    54|             'data' => $result,
    55|         ]);
    56|     }
    57|     /**
    58|      * @Route("/get-available-templates", name="pimcore_admin_misc_getavailabletemplates", methods={"GET"})
    59|      *
    60|      * @param ControllerDataProvider $provider
    61|      *
    62|      * @return JsonResponse
    63|      */
    64|     public function getAvailableTemplatesAction(ControllerDataProvider $provider)
    65|     {
    66|         $templates = $provider->getTemplates();
    67|         sort($templates, SORT_NATURAL | SORT_FLAG_CASE);
    68|         $result = array_map(static function ($template) {
    69|             return [
    70|                 'path' => $template,
    71|             ];
    72|         }, $templates);
    73|         return $this->adminJson([
    74|             'data' => $result,
    75|         ]);
    76|     }
    77|     /**
    78|      * @Route("/json-translations-system", name="pimcore_admin_misc_jsontranslationssystem", methods={"GET"})
    79|      *
    80|      * @param Request $request
    81|      *
    82|      * @return Response
    83|      */
    84|     public function jsonTranslationsSystemAction(Request $request, TranslatorInterface $translator)
    85|     {
    86|         $language = $request->get('language');
    87|         /** @var Translator $translator */
    88|         $translator->lazyInitialize('admin', $language);
    89|         $translations = $translator->getCatalogue($language)->all('admin');
    90|         if ($language != 'en') {
    91|             $translator->lazyInitialize('admin', 'en');
    92|             foreach ($translator->getCatalogue('en')->all('admin') as $key => $value) {
    93|                 if (!isset($translations[$key]) || empty($translations[$key])) {
    94|                     $translations[$key] = $value;
    95|                 }
    96|             }
    97|         }
    98|         $response = new Response('pimcore.system_i18n = ' . $this->encodeJson($translations) . ';');
    99|         $response->headers->set('Content-Type', 'text/javascript');
   100|         return $response;
   101|     }
   102|     /**
   103|      * @Route("/script-proxy", name="pimcore_admin_misc_scriptproxy", methods={"GET"})
   104|      *
   105|      * @param Request $request
   106|      *
   107|      * @return Response
   108|      */
   109|     public function scriptProxyAction(Request $request)
   110|     {
   111|         $allowedFileTypes = ['js', 'css'];
   112|         $scripts = explode(',', $request->get('scripts'));
   113|         if ($request->get('scriptPath')) {
   114|             $scriptPath = PIMCORE_WEB_ROOT . $request->get('scriptPath');
   115|         } else {
   116|             $scriptPath = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/';
   117|         }
   118|         $scriptsContent = '';
   119|         foreach ($scripts as $script) {
   120|             $filePath = $scriptPath . $script;
   121|             if (is_file($filePath) && is_readable($filePath) && in_array(\Pimcore\File::getFileExtension($script), $allowedFileTypes)) {
   122|                 $scriptsContent .= file_get_contents($filePath);
   123|             }
   124|         }
   125|         if (!empty($scriptsContent)) {
   126|             $fileExtension = \Pimcore\File::getFileExtension($scripts[0]);
   127|             $contentType = 'text/javascript';
   128|             if ($fileExtension == 'css') {
   129|                 $contentType = 'text/css';
   130|             }
   131|             $lifetime = 86400;
   132|             $response = new Response($scriptsContent);
   133|             $response->headers->set('Cache-Control', 'max-age=' . $lifetime);
   134|             $response->headers->set('Pragma', '');
   135|             $response->headers->set('Content-Type', $contentType);
   136|             $response->headers->set('Expires', gmdate('D, d M Y H:i:s', time() + $lifetime) . ' GMT');
   137|             return $response;
   138|         } else {
   139|             throw $this->createNotFoundException('Scripts not found');
   140|         }
   141|     }
   142|     /**
   143|      * @Route("/admin-css", name="pimcore_admin_misc_admincss", methods={"GET"})
   144|      *
   145|      * @param Request $request
   146|      * @param Config $config
   147|      *
   148|      * @return Response
   149|      */
   150|     public function adminCssAction(Request $request, Config $config)
   151|     {
   152|         $cvData = Tool::getCustomViewConfig();
   153|         $languages = \Pimcore\Tool::getValidLanguages();
   154|         $adminLanguages = \Pimcore\Tool\Admin::getLanguages();
   155|         $languages = array_unique(array_merge($languages, $adminLanguages));
   156|         $response = $this->render('@PimcoreAdmin/Admin/Misc/admin-css.html.twig', [
   157|             'customviews' => $cvData,
   158|             'config' => $config,
   159|             'languages' => $languages,
   160|         ]);
   161|         $response->headers->set('Content-Type', 'text/css; charset=UTF-8');
   162|         return $response;
   163|     }
   164|     /**
   165|      * @Route("/ping", name="pimcore_admin_misc_ping", methods={"GET"})
   166|      *
   167|      * @param Request $request
   168|      *
   169|      * @return JsonResponse
   170|      */
   171|     public function pingAction(Request $request)
   172|     {
   173|         $response = [
   174|             'success' => true,
   175|         ];
   176|         return $this->adminJson($response);
   177|     }
   178|     /**
   179|      * @Route("/available-languages", name="pimcore_admin_misc_availablelanguages", methods={"GET"})
   180|      *
   181|      * @param Request $request
   182|      *
   183|      * @return Response
   184|      */
   185|     public function availableLanguagesAction(Request $request)
   186|     {
   187|         $locales = Tool::getSupportedLocales();
   188|         $response = new Response('pimcore.available_languages = ' . $this->encodeJson($locales) . ';');
   189|         $response->headers->set('Content-Type', 'text/javascript');
   190|         return $response;
   191|     }
   192|     /**
   193|      * @Route("/get-valid-filename", name="pimcore_admin_misc_getvalidfilename", methods={"GET"})
   194|      *
   195|      * @param Request $request
   196|      *
   197|      * @return JsonResponse
   198|      */
   199|     public function getValidFilenameAction(Request $request)
   200|     {
   201|         return $this->adminJson([
   202|             'filename' => \Pimcore\Model\Element\Service::getValidKey($request->get('value'), $request->get('type')),
   203|         ]);
   204|     }
   205|     /**
   206|      * @Route("/fileexplorer-tree", name="pimcore_admin_misc_fileexplorertree", methods={"GET"})
   207|      *
   208|      * @param Request $request
   209|      *
   210|      * @return JsonResponse
   211|      */
   212|     public function fileexplorerTreeAction(Request $request)
   213|     {
   214|         $this->checkPermission('fileexplorer');
   215|         $referencePath = $this->getFileexplorerPath($request, 'node');
   216|         $items = scandir($referencePath);
   217|         $contents = [];
   218|         foreach ($items as $item) {
   219|             if ($item == '.' || $item == '..') {
   220|                 continue;
   221|             }
   222|             $file = $referencePath . '/' . $item;
   223|             $file = str_replace('//', '/', $file);
   224|             if (is_dir($file) || is_file($file)) {
   225|                 $itemConfig = [
   226|                     'id' => '/fileexplorer' . str_replace(PIMCORE_PROJECT_ROOT, '', $file),
   227|                     'text' => $item,
   228|                     'leaf' => true,
   229|                     'writeable' => is_writable($file),
   230|                 ];
   231|                 if (is_dir($file)) {
   232|                     $itemConfig['leaf'] = false;
   233|                     $itemConfig['type'] = 'folder';
   234|                     if (is_dir_empty($file)) {
   235|                         $itemConfig['loaded'] = true;
   236|                     }
   237|                     $itemConfig['expandable'] = true;
   238|                 } elseif (is_file($file)) {
   239|                     $itemConfig['type'] = 'file';
   240|                 }
   241|                 $contents[] = $itemConfig;
   242|             }
   243|         }
   244|         return $this->adminJson($contents);
   245|     }
   246|     /**
   247|      * @Route("/fileexplorer-content", name="pimcore_admin_misc_fileexplorercontent", methods={"GET"})
   248|      *
   249|      * @param Request $request
   250|      *
   251|      * @return JsonResponse
   252|      */
   253|     public function fileexplorerContentAction(Request $request)
   254|     {
   255|         $this->checkPermission('fileexplorer');
   256|         $success = false;
   257|         $writeable = false;
   258|         $file = $this->getFileexplorerPath($request, 'path');
   259|         $content = null;
   260|         if (is_file($file)) {
   261|             if (is_readable($file)) {
   262|                 $content = file_get_contents($file);
   263|                 $success = true;
   264|                 $writeable = is_writable($file);
   265|             }
   266|         }
   267|         return $this->adminJson([
   268|             'success' => $success,
   269|             'content' => $content,
   270|             'writeable' => $writeable,
   271|             'filename' => basename($file),
   272|             'path' => preg_replace('@^' . preg_quote(PIMCORE_PROJECT_ROOT, '@') . '@', '', $file),
   273|         ]);
   274|     }
   275|     /**
   276|      * @Route("/fileexplorer-content-save", name="pimcore_admin_misc_fileexplorercontentsave", methods={"PUT"})
   277|      *
   278|      * @param Request $request
   279|      *
   280|      * @return JsonResponse
   281|      */
   282|     public function fileexplorerContentSaveAction(Request $request)
   283|     {
   284|         $this->checkPermission('fileexplorer');
   285|         $success = false;
   286|         if ($request->get('content') && $request->get('path')) {
   287|             $file = $this->getFileexplorerPath($request, 'path');
   288|             if (is_file($file) && is_writable($file)) {
   289|                 File::put($file, $request->get('content'));
   290|                 $success = true;
   291|             }
   292|         }
   293|         return $this->adminJson([
   294|             'success' => $success,
   295|         ]);
   296|     }
   297|     /**
   298|      * @Route("/fileexplorer-add", name="pimcore_admin_misc_fileexploreradd", methods={"POST"})
   299|      *
   300|      * @param Request $request
   301|      *
   302|      * @return JsonResponse
   303|      *
   304|      * @throws \Exception
   305|      */
   306|     public function fileexplorerAddAction(Request $request)
   307|     {
   308|         $this->checkPermission('fileexplorer');
   309|         $success = false;
   310|         if ($request->get('filename') && $request->get('path')) {
   311|             $path = $this->getFileexplorerPath($request, 'path');
   312|             $file = $path . '/' . $request->get('filename');
   313|             $file = resolvePath($file);
   314|             if (strpos($file, PIMCORE_PROJECT_ROOT) !== 0) {
   315|                 throw new \Exception('not allowed');
   316|             }
   317|             if (is_writable(dirname($file))) {
   318|                 File::put($file, '');
   319|                 $success = true;
   320|             }
   321|         }
   322|         return $this->adminJson([
   323|             'success' => $success,
   324|         ]);
   325|     }
   326|     /**
   327|      * @Route("/fileexplorer-add-folder", name="pimcore_admin_misc_fileexploreraddfolder", methods={"POST"})
   328|      *
   329|      * @param Request $request
   330|      *
   331|      * @return JsonResponse
   332|      *
   333|      * @throws \Exception
   334|      */
   335|     public function fileexplorerAddFolderAction(Request $request)
   336|     {
   337|         $this->checkPermission('fileexplorer');
   338|         $success = false;
   339|         if ($request->get('filename') && $request->get('path')) {
   340|             $path = $this->getFileexplorerPath($request, 'path');
   341|             $file = $path . '/' . $request->get('filename');
   342|             $file = resolvePath($file);
   343|             if (strpos($file, PIMCORE_PROJECT_ROOT) !== 0) {
   344|                 throw new \Exception('not allowed');
   345|             }
   346|             if (is_writable(dirname($file))) {
   347|                 File::mkdir($file);
   348|                 $success = true;
   349|             }
   350|         }
   351|         return $this->adminJson([
   352|             'success' => $success,
   353|         ]);
   354|     }
   355|     /**
   356|      * @Route("/fileexplorer-delete", name="pimcore_admin_misc_fileexplorerdelete", methods={"DELETE"})
   357|      *
   358|      * @param Request $request
   359|      *
   360|      * @return JsonResponse
   361|      */
   362|     public function fileexplorerDeleteAction(Request $request)
   363|     {
   364|         $this->checkPermission('fileexplorer');
   365|         $success = false;
   366|         if ($request->get('path')) {
   367|             $file = $this->getFileexplorerPath($request, 'path');
   368|             if (is_writable($file)) {
   369|                 unlink($file);
   370|                 $success = true;
   371|             }
   372|         }
   373|         return $this->adminJson([
   374|             'success' => $success,
   375|         ]);
   376|     }
   377|     /**
   378|      * @Route("/fileexplorer-rename", name="pimcore_admin_misc_fileexplorerrename", methods={"PUT"})
   379|      *
   380|      * @param Request $request
   381|      *
   382|      * @return JsonResponse
   383|      */
   384|     public function fileexplorerRenameAction(Request $request)
   385|     {
   386|         $this->checkPermission('fileexplorer');
   387|         $success = false;
   388|         if ($request->get('path') && $request->get('newPath')) {
   389|             $file = $this->getFileexplorerPath($request, 'path');
   390|             $newFile = $this->getFileexplorerPath($request, 'newPath');
   391|             $success = rename($file, $newFile);
   392|         }
   393|         return $this->adminJson([
   394|             'success' => $success,
   395|         ]);
   396|     }
   397|     /**
   398|      * @param Request $request
   399|      * @param string $paramName
   400|      *
   401|      * @return mixed|string
   402|      *
   403|      * @throws \Exception
   404|      */
   405|     private function getFileexplorerPath(Request $request, $paramName = 'node')
   406|     {
   407|         $path = preg_replace("/^\/fileexplorer/", '', $request->get($paramName));
   408|         $path = resolvePath(PIMCORE_PROJECT_ROOT . $path);
   409|         if (strpos($path, PIMCORE_PROJECT_ROOT) !== 0) {
   410|             throw new \Exception('operation permitted, permission denied');
   411|         }
   412|         return $path;
   413|     }
   414|     /**
   415|      * @Route("/maintenance", name="pimcore_admin_misc_maintenance", methods={"POST"})
   416|      *
   417|      * @param Request $request
   418|      *
   419|      * @return JsonResponse
   420|      */
   421|     public function maintenanceAction(Request $request)
   422|     {
   423|         $this->checkPermission('maintenance_mode');
   424|         if ($request->get('activate')) {
   425|             Tool\Admin::activateMaintenanceMode(Tool\Session::getSessionId());
   426|         }
   427|         if ($request->get('deactivate')) {
   428|             Tool\Admin::deactivateMaintenanceMode();
   429|         }
   430|         return $this->adminJson([
   431|             'success' => true,
   432|         ]);
   433|     }
   434|     /**
   435|      * @Route("/http-error-log", name="pimcore_admin_misc_httperrorlog", methods={"POST"})
   436|      *
   437|      * @param Request $request
   438|      *
   439|      * @return JsonResponse
   440|      */
   441|     public function httpErrorLogAction(Request $request)
   442|     {
   443|         $this->checkPermission('http_errors');
   444|         $db = Db::get();
   445|         $limit = (int)$request->get('limit');
   446|         $offset = (int)$request->get('start');
   447|         $sortInfo = ($request->get('sort') ? json_decode($request->get('sort'), true)[0] : []);
   448|         $sort = $sortInfo['property'] ?? null;
   449|         $dir = $sortInfo['direction'] ?? null;
   450|         $filter = $request->get('filter');
   451|         if (!$limit) {
   452|             $limit = 20;
   453|         }
   454|         if (!$offset) {
   455|             $offset = 0;
   456|         }
   457|         if (!$sort || !in_array($sort, ['code', 'uri', 'date', 'count'])) {
   458|             $sort = 'count';
   459|         }
   460|         if (!$dir || !in_array($dir, ['DESC', 'ASC'])) {
   461|             $dir = 'DESC';
   462|         }
   463|         $condition = '';
   464|         if ($filter) {
   465|             $filter = $db->quote('%' . $filter . '%');
   466|             $conditionParts = [];
   467|             foreach (['uri', 'code', 'parametersGet', 'parametersPost', 'serverVars', 'cookies'] as $field) {
   468|                 $conditionParts[] = $field . ' LIKE ' . $filter;
   469|             }
   470|             $condition = ' WHERE ' . implode(' OR ', $conditionParts);
   471|         }
   472|         $logs = $db->fetchAll('SELECT code,uri,`count`,date FROM http_error_log ' . $condition . ' ORDER BY ' . $sort . ' ' . $dir . ' LIMIT ' . $offset . ',' . $limit);
   473|         $total = $db->fetchOne('SELECT count(*) FROM http_error_log ' . $condition);
   474|         return $this->adminJson([
   475|             'items' => $logs,
   476|             'total' => $total,
   477|             'success' => true,
   478|         ]);
   479|     }
   480|     /**
   481|      * @Route("/http-error-log-flush", name="pimcore_admin_misc_httperrorlogflush", methods={"DELETE"})
   482|      *
   483|      * @param Request $request
   484|      *
   485|      * @return JsonResponse
   486|      */
   487|     public function httpErrorLogFlushAction(Request $request)
   488|     {
   489|         $this->checkPermission('http_errors');
   490|         $db = Db::get();
   491|         $db->query('TRUNCATE TABLE http_error_log');
   492|         return $this->adminJson([
   493|             'success' => true,
   494|         ]);
   495|     }
   496|     /**
   497|      * @Route("/http-error-log-detail", name="pimcore_admin_misc_httperrorlogdetail", methods={"GET"})
   498|      *
   499|      * @param Request $request
   500|      * @param Profiler $profiler
   501|      *
   502|      * @return Response
   503|      */
   504|     public function httpErrorLogDetailAction(Request $request, ?Profiler $profiler)
   505|     {
   506|         $this->checkPermission('http_errors');
   507|         if ($profiler) {
   508|             $profiler->disable();
   509|         }
   510|         $db = Db::get();
   511|         $data = $db->fetchRow('SELECT * FROM http_error_log WHERE uri = ?', [$request->get('uri')]);
   512|         foreach ($data as $key => &$value) {
   513|             if (in_array($key, ['parametersGet', 'parametersPost', 'serverVars', 'cookies'])) {
   514|                 $value = unserialize($value);
   515|             }
   516|         }
   517|         $response = $this->render('@PimcoreAdmin/Admin/Misc/http-error-log-detail.html.twig', ['data' => $data]);
   518|         return $response;
   519|     }
   520|     /**
   521|      * @Route("/country-list", name="pimcore_admin_misc_countrylist", methods={"GET"})
   522|      *
   523|      * @param LocaleServiceInterface $localeService
   524|      *
   525|      * @return JsonResponse
   526|      */
   527|     public function countryListAction(LocaleServiceInterface $localeService)
   528|     {
   529|         $countries = $localeService->getDisplayRegions();
   530|         asort($countries);
   531|         $options = [];
   532|         foreach ($countries as $short => $translation) {
   533|             if (strlen($short) == 2) {
   534|                 $options[] = [
   535|                     'name' => $translation,
   536|                     'code' => $short,
   537|                 ];
   538|             }
   539|         }
   540|         return $this->adminJson(['data' => $options]);
   541|     }
   542|     /**
   543|      * @Route("/language-list", name="pimcore_admin_misc_languagelist", methods={"GET"})
   544|      *
   545|      * @param Request $request
   546|      *
   547|      * @return JsonResponse
   548|      */
   549|     public function languageListAction(Request $request)
   550|     {
   551|         $locales = Tool::getSupportedLocales();
   552|         $options = [];
   553|         foreach ($locales as $short => $translation) {
   554|             $options[] = [
   555|                 'name' => $translation,
   556|                 'code' => $short,
   557|             ];
   558|         }
   559|         return $this->adminJson(['data' => $options]);
   560|     }
   561|     /**
   562|      * @Route("/phpinfo", name="pimcore_admin_misc_phpinfo", methods={"GET"})
   563|      *
   564|      * @param Request $request
   565|      * @param Profiler $profiler
   566|      *
   567|      * @throws \Exception
   568|      *
   569|      * @return Response
   570|      */
   571|     public function phpinfoAction(Request $request, ?Profiler $profiler)
   572|     {
   573|         if ($profiler) {
   574|             $profiler->disable();
   575|         }
   576|         if (!$this->getAdminUser()->isAdmin()) {
   577|             throw new \Exception('Permission denied');
   578|         }
   579|         ob_start();
   580|         phpinfo();
   581|         $content = ob_get_clean();
   582|         return new Response($content);
   583|     }
   584|     /**
   585|      * @Route("/get-language-flag", name="pimcore_admin_misc_getlanguageflag", methods={"GET"})
   586|      *
   587|      * @param Request $request
   588|      *
   589|      * @return BinaryFileResponse
   590|      */
   591|     public function getLanguageFlagAction(Request $request)
   592|     {
   593|         $iconPath = Tool::getLanguageFlagFile($request->get('language'));
   594|         $response = new BinaryFileResponse($iconPath);
   595|         $response->headers->set('Content-Type', 'image/svg+xml');
   596|         return $response;
   597|     }
   598|     /**
   599|      * @Route("/icon-list", name="pimcore_admin_misc_iconlist", methods={"GET"})
   600|      *
   601|      * @param Request $request
   602|      * @param Profiler $profiler
   603|      *
   604|      * @return Response
   605|      */
   606|     public function iconListAction(Request $request, ?Profiler $profiler)
   607|     {
   608|         if ($profiler) {
   609|             $profiler->disable();
   610|         }
   611|         $publicDir = PIMCORE_WEB_ROOT . '/bundles/pimcoreadmin';
   612|         $iconDir = $publicDir . '/img';
   613|         $colorIcons = rscandir($iconDir . '/flat-color-icons/');
   614|         $whiteIcons = rscandir($iconDir . '/flat-white-icons/');
   615|         $twemoji = rscandir($iconDir . '/twemoji/');
   616|         $locales = Tool::getSupportedLocales();
   617|         $languageOptions = [];
   618|         foreach ($locales as $short => $translation) {
   619|             if (!empty($short)) {
   620|                 $languageOptions[] = [
   621|                     'language' => $short,
   622|                     'display' => $translation . " ($short)",
   623|                     'flag' => \Pimcore\Tool::getLanguageFlagFile($short, false),
   624|                 ];
   625|             }
   626|         }
   627|         $iconsCss = file_get_contents($publicDir . '/css/icons.css');
   628|         return $this->render('@PimcoreAdmin/Admin/Misc/iconList.html.twig', [
   629|             'colorIcons' => $colorIcons,
   630|             'whiteIcons' => $whiteIcons,
   631|             'twemoji' => $twemoji,
   632|             'languageOptions' => $languageOptions,
   633|             'iconsCss' => $iconsCss,
   634|         ]);
   635|     }
   636|     /**
   637|      * @Route("/test", name="pimcore_admin_misc_test")
   638|      *
   639|      * @param Request $request
   640|      *
   641|      * @return Response
   642|      */
   643|     public function testAction(Request $request)
   644|     {
   645|         return new Response('done');
   646|     }
   647| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/NotificationController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-209 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    18| use Pimcore\Model\Element\Service;
    19| use Pimcore\Model\Notification\Service\NotificationService;
    20| use Pimcore\Model\Notification\Service\NotificationServiceFilterParser;
    21| use Pimcore\Model\Notification\Service\UserService;
    22| use Pimcore\Model\User;
    23| use Pimcore\Translation\Translator;
    24| use Symfony\Component\HttpFoundation\Request;
    25| use Symfony\Component\Routing\Annotation\Route;
    26| /**
    27|  * @Route("/notification")
    28|  *
    29|  * @internal
    30|  */
    31| class NotificationController extends AdminController
    32| {
    33|     /**
    34|      * @Route("/recipients", name="pimcore_admin_notification_recipients", methods={"GET"})
    35|      *
    36|      * @param UserService $service
    37|      * @param Translator $translator
    38|      *
    39|      * @return JsonResponse
    40|      */
    41|     public function recipientsAction(UserService $service, Translator $translator): JsonResponse
    42|     {
    43|         $this->checkPermission('notifications_send');
    44|         $data = [];
    45|         foreach ($service->findAll($this->getAdminUser()) as $recipient) {
    46|             $group = $translator->trans('group');
    47|             $prefix = $recipient->getType() == 'role' ? $group . ' - ' : '';
    48|             $data[] = [
    49|                 'id' => $recipient->getId(),
    50|                 'text' => $prefix . $recipient->getName(),
    51|             ];
    52|         }
    53|         return $this->adminJson($data);
    54|     }
    55|     /**
    56|      * @Route("/send", name="pimcore_admin_notification_send", methods={"POST"})
    57|      *
    58|      * @param Request $request
    59|      * @param NotificationService $service
    60|      *
    61|      * @return JsonResponse
    62|      */
    63|     public function sendAction(Request $request, NotificationService $service): JsonResponse
    64|     {
    65|         $this->checkPermission('notifications_send');
    66|         $recipientId = (int) $request->get('recipientId', 0);
    67|         $fromUser = (int) $this->getAdminUser()->getId();
    68|         $title = $request->get('title', '');
    69|         $message = $request->get('message', '');
    70|         $elementId = $request->get('elementId');
    71|         $elementType = $request->get('elementType', '');
    72|         $element = Service::getElementById($elementType, $elementId);
    73|         if (User::getById($recipientId) instanceof User) {
    74|             $service->sendToUser($recipientId, $fromUser, $title, $message, $element);
    75|         } else {
    76|             $service->sendToGroup($recipientId, $fromUser, $title, $message, $element);
    77|         }
    78|         return $this->adminJson(['success' => true]);
    79|     }
    80|     /**
    81|      * @Route("/find", name="pimcore_admin_notification_find")
    82|      *
    83|      * @param Request $request
    84|      * @param NotificationService $service
    85|      *
    86|      * @return JsonResponse
    87|      */
    88|     public function findAction(Request $request, NotificationService $service): JsonResponse
    89|     {
    90|         $this->checkPermission('notifications');
    91|         $id = (int) $request->get('id', 0);
    92|         try {
    93|             $notification = $service->findAndMarkAsRead($id, $this->getAdminUser()->getId());
    94|         } catch (\UnexpectedValueException $e) {
    95|             return $this->adminJson(
    96|                 [
    97|                     'success' => false,
    98|                 ]
    99|             );
   100|         }
   101|         $data = $service->format($notification);
   102|         return $this->adminJson([
   103|             'success' => true,
   104|             'data' => $data,
   105|         ]);
   106|     }
   107|     /**
   108|      * @Route("/find-all", name="pimcore_admin_notification_findall")
   109|      *
   110|      * @param Request $request
   111|      * @param NotificationService $service
   112|      *
   113|      * @return JsonResponse
   114|      */
   115|     public function findAllAction(Request $request, NotificationService $service): JsonResponse
   116|     {
   117|         $this->checkPermission('notifications');
   118|         $filter = ['recipient' => (int) $this->getAdminUser()->getId()];
   119|         $parser = new NotificationServiceFilterParser($request);
   120|         foreach ($parser->parse() as $key => $val) {
   121|             $filter[$key] = $val;
   122|         }
   123|         $options = [
   124|             'offset' => $request->get('start', 0),
   125|             'limit' => $request->get('limit', 40),
   126|         ];
   127|         $result = $service->findAll($filter, $options);
   128|         $data = [];
   129|         foreach ($result['data'] as $notification) {
   130|             $data[] = $service->format($notification);
   131|         }
   132|         return $this->adminJson([
   133|             'success' => true,
   134|             'total' => $result['total'],
   135|             'data' => $data,
   136|         ]);
   137|     }
   138|     /**
   139|      * @Route("/find-last-unread", name="pimcore_admin_notification_findlastunread")
   140|      *
   141|      * @param Request $request
   142|      * @param NotificationService $service
   143|      *
   144|      * @return JsonResponse
   145|      */
   146|     public function findLastUnreadAction(Request $request, NotificationService $service): JsonResponse
   147|     {
   148|         $this->checkPermission('notifications');
   149|         $user = $this->getAdminUser();
   150|         $lastUpdate = (int) $request->get('lastUpdate', time());
   151|         $result = $service->findLastUnread((int) $user->getId(), $lastUpdate);
   152|         $unread = $service->countAllUnread((int) $user->getId());
   153|         $data = [];
   154|         foreach ($result['data'] as $notification) {
   155|             $data[] = $service->format($notification);
   156|         }
   157|         return $this->adminJson([
   158|             'success' => true,
   159|             'total' => $result['total'],
   160|             'data' => $data,
   161|             'unread' => $unread,
   162|         ]);
   163|     }
   164|     /**
   165|      * @Route("/mark-as-read", name="pimcore_admin_notification_markasread")
   166|      *
   167|      * @param Request $request
   168|      * @param NotificationService $service
   169|      *
   170|      * @return JsonResponse
   171|      */
   172|     public function markAsReadAction(Request $request, NotificationService $service): JsonResponse
   173|     {
   174|         $this->checkPermission('notifications');
   175|         $id = (int) $request->get('id', 0);
   176|         $service->findAndMarkAsRead($id, $this->getAdminUser()->getId());
   177|         return $this->adminJson(['success' => true]);
   178|     }
   179|     /**
   180|      * @Route("/delete", name="pimcore_admin_notification_delete")
   181|      *
   182|      * @param Request $request
   183|      * @param NotificationService $service
   184|      *
   185|      * @return JsonResponse
   186|      */
   187|     public function deleteAction(Request $request, NotificationService $service): JsonResponse
   188|     {
   189|         $this->checkPermission('notifications');
   190|         $id = (int) $request->get('id', 0);
   191|         $service->delete($id, $this->getAdminUser()->getId());
   192|         return $this->adminJson(['success' => true]);
   193|     }
   194|     /**
   195|      * @Route("/delete-all", name="pimcore_admin_notification_deleteall")
   196|      *
   197|      * @param Request $request
   198|      * @param NotificationService $service
   199|      *
   200|      * @return JsonResponse
   201|      */
   202|     public function deleteAllAction(Request $request, NotificationService $service): JsonResponse
   203|     {
   204|         $this->checkPermission('notifications');
   205|         $user = $this->getAdminUser();
   206|         $service->deleteAll((int) $user->getId());
   207|         return $this->adminJson(['success' => true]);
   208|     }
   209| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/PortalController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-376 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Analytics\Google\Config\SiteConfigProvider;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Pimcore\Model\Asset;
    19| use Pimcore\Model\DataObject;
    20| use Pimcore\Model\Document;
    21| use Pimcore\Model\Site;
    22| use Symfony\Component\HttpFoundation\JsonResponse;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    25| use Symfony\Component\Routing\Annotation\Route;
    26| use Symfony\Contracts\Translation\TranslatorInterface;
    27| /**
    28|  * @Route("/portal")
    29|  *
    30|  * @internal
    31|  */
    32| class PortalController extends AdminController implements KernelControllerEventInterface
    33| {
    34|     /**
    35|      * @var \Pimcore\Helper\Dashboard
    36|      */
    37|     protected $dashboardHelper = null;
    38|     /**
    39|      * @param Request $request
    40|      *
    41|      * @return mixed
    42|      */
    43|     protected function getCurrentConfiguration(Request $request)
    44|     {
    45|         return $this->dashboardHelper->getDashboard($request->get('key'));
    46|     }
    47|     /**
    48|      * @param Request $request
    49|      * @param array $config
    50|      */
    51|     protected function saveConfiguration(Request $request, $config)
    52|     {
    53|         $this->dashboardHelper->saveDashboard($request->get('key'), $config);
    54|     }
    55|     /**
    56|      * @Route("/dashboard-list", name="pimcore_admin_portal_dashboardlist", methods={"GET"})
    57|      *
    58|      * @param Request $request
    59|      *
    60|      * @return JsonResponse
    61|      */
    62|     public function dashboardListAction(Request $request)
    63|     {
    64|         $dashboards = $this->dashboardHelper->getAllDashboards();
    65|         $data = [];
    66|         foreach ($dashboards as $key => $config) {
    67|             if ($key != 'welcome') {
    68|                 $data[] = $key;
    69|             }
    70|         }
    71|         return $this->adminJson($data);
    72|     }
    73|     /**
    74|      * @Route("/create-dashboard", name="pimcore_admin_portal_createdashboard", methods={"POST"})
    75|      *
    76|      * @param Request $request
    77|      *
    78|      * @return JsonResponse
    79|      */
    80|     public function createDashboardAction(Request $request)
    81|     {
    82|         $dashboards = $this->dashboardHelper->getAllDashboards();
    83|         $key = trim($request->get('key'));
    84|         if ($dashboards[$key]) {
    85|             return $this->adminJson(['success' => false, 'message' => 'name_already_in_use']);
    86|         } elseif (!empty($key)) {
    87|             $this->dashboardHelper->saveDashboard($key);
    88|             return $this->adminJson(['success' => true]);
    89|         } else {
    90|             return $this->adminJson(['success' => false, 'message' => 'empty']);
    91|         }
    92|     }
    93|     /**
    94|      * @Route("/delete-dashboard", name="pimcore_admin_portal_deletedashboard", methods={"DELETE"})
    95|      *
    96|      * @param Request $request
    97|      *
    98|      * @return JsonResponse
    99|      */
   100|     public function deleteDashboardAction(Request $request)
   101|     {
   102|         $key = $request->get('key');
   103|         $this->dashboardHelper->deleteDashboard($key);
   104|         return $this->adminJson(['success' => true]);
   105|     }
   106|     /**
   107|      * @Route("/get-configuration", name="pimcore_admin_portal_getconfiguration", methods={"GET"})
   108|      *
   109|      * @param Request $request
   110|      *
   111|      * @return JsonResponse
   112|      */
   113|     public function getConfigurationAction(Request $request)
   114|     {
   115|         return $this->adminJson($this->getCurrentConfiguration($request));
   116|     }
   117|     /**
   118|      * @Route("/remove-widget", name="pimcore_admin_portal_removewidget", methods={"DELETE"})
   119|      *
   120|      * @param Request $request
   121|      *
   122|      * @return JsonResponse
   123|      */
   124|     public function removeWidgetAction(Request $request)
   125|     {
   126|         $config = $this->getCurrentConfiguration($request);
   127|         $newConfig = [[], []];
   128|         $colCount = 0;
   129|         foreach ($config['positions'] as $col) {
   130|             foreach ($col as $row) {
   131|                 if ($row['id'] != $request->get('id')) {
   132|                     $newConfig[$colCount][] = $row;
   133|                 }
   134|             }
   135|             $colCount++;
   136|         }
   137|         $config['positions'] = $newConfig;
   138|         $this->saveConfiguration($request, $config);
   139|         return $this->adminJson(['success' => true]);
   140|     }
   141|     /**
   142|      * @Route("/add-widget", name="pimcore_admin_portal_addwidget", methods={"POST"})
   143|      *
   144|      * @param Request $request
   145|      *
   146|      * @return JsonResponse
   147|      */
   148|     public function addWidgetAction(Request $request)
   149|     {
   150|         $config = $this->getCurrentConfiguration($request);
   151|         $nextId = 0;
   152|         foreach ($config['positions'] as $col) {
   153|             foreach ($col as $row) {
   154|                 $nextId = ($row['id'] > $nextId ? $row['id'] : $nextId);
   155|             }
   156|         }
   157|         $nextId = $nextId + 1;
   158|         $config['positions'][0][] = ['id' => $nextId, 'type' => $request->get('type'), 'config' => null];
   159|         $this->saveConfiguration($request, $config);
   160|         return $this->adminJson(['success' => true, 'id' => $nextId]);
   161|     }
   162|     /**
   163|      * @Route("/reorder-widget", name="pimcore_admin_portal_reorderwidget", methods={"PUT"})
   164|      *
   165|      * @param Request $request
   166|      *
   167|      * @return JsonResponse
   168|      */
   169|     public function reorderWidgetAction(Request $request)
   170|     {
   171|         $config = $this->getCurrentConfiguration($request);
   172|         $newConfig = [[], []];
   173|         $colCount = 0;
   174|         $toMove = null;
   175|         foreach ($config['positions'] as $col) {
   176|             foreach ($col as $row) {
   177|                 if ($row['id'] != $request->get('id')) {
   178|                     $newConfig[$colCount][] = $row;
   179|                 } else {
   180|                     $toMove = $row;
   181|                 }
   182|             }
   183|             $colCount++;
   184|         }
   185|         array_splice($newConfig[$request->get('column')], $request->get('row'), 0, [$toMove]);
   186|         $config['positions'] = $newConfig;
   187|         $this->saveConfiguration($request, $config);
   188|         return $this->adminJson(['success' => true]);
   189|     }
   190|     /**
   191|      * @Route("/update-portlet-config", name="pimcore_admin_portal_updateportletconfig", methods={"PUT"})
   192|      *
   193|      * @param Request $request
   194|      *
   195|      * @return JsonResponse
   196|      */
   197|     public function updatePortletConfigAction(Request $request)
   198|     {
   199|         $key = $request->get('key');
   200|         $id = $request->get('id');
   201|         $configuration = $request->get('config');
   202|         $dashboard = $this->dashboardHelper->getDashboard($key);
   203|         foreach ($dashboard['positions'] as &$col) {
   204|             foreach ($col as &$portlet) {
   205|                 if ($portlet['id'] == $id) {
   206|                     $portlet['config'] = $configuration;
   207|                     break;
   208|                 }
   209|             }
   210|         }
   211|         $this->dashboardHelper->saveDashboard($key, $dashboard);
   212|         return $this->adminJson(['success' => true]);
   213|     }
   214|     /**
   215|      * @Route("/portlet-modified-documents", name="pimcore_admin_portal_portletmodifieddocuments", methods={"GET"})
   216|      *
   217|      * @param Request $request
   218|      *
   219|      * @return JsonResponse
   220|      */
   221|     public function portletModifiedDocumentsAction(Request $request)
   222|     {
   223|         $list = Document::getList([
   224|             'limit' => 10,
   225|             'order' => 'DESC',
   226|             'orderKey' => 'modificationDate',
   227|             'condition' => "userModification = '".$this->getAdminUser()->getId()."'",
   228|         ]);
   229|         $response = [];
   230|         $response['documents'] = [];
   231|         foreach ($list as $doc) {
   232|             if ($doc->isAllowed('view')) {
   233|                 $response['documents'][] = [
   234|                     'id' => $doc->getId(),
   235|                     'type' => $doc->getType(),
   236|                     'path' => $doc->getRealFullPath(),
   237|                     'date' => $doc->getModificationDate(),
   238|                 ];
   239|             }
   240|         }
   241|         return $this->adminJson($response);
   242|     }
   243|     /**
   244|      * @Route("/portlet-modified-assets", name="pimcore_admin_portal_portletmodifiedassets", methods={"GET"})
   245|      *
   246|      * @param Request $request
   247|      *
   248|      * @return JsonResponse
   249|      */
   250|     public function portletModifiedAssetsAction(Request $request)
   251|     {
   252|         $list = Asset::getList([
   253|             'limit' => 10,
   254|             'order' => 'DESC',
   255|             'orderKey' => 'modificationDate',
   256|             'condition' => "userModification = '".$this->getAdminUser()->getId()."'",
   257|         ]);
   258|         $response = [];
   259|         $response['assets'] = [];
   260|         foreach ($list as $doc) {
   261|             /**
   262|              * @var Asset $doc
   263|              */
   264|             if ($doc->isAllowed('view')) {
   265|                 $response['assets'][] = [
   266|                     'id' => $doc->getId(),
   267|                     'type' => $doc->getType(),
   268|                     'path' => $doc->getRealFullPath(),
   269|                     'date' => $doc->getModificationDate(),
   270|                 ];
   271|             }
   272|         }
   273|         return $this->adminJson($response);
   274|     }
   275|     /**
   276|      * @Route("/portlet-modified-objects", name="pimcore_admin_portal_portletmodifiedobjects", methods={"GET"})
   277|      *
   278|      * @param Request $request
   279|      *
   280|      * @return JsonResponse
   281|      */
   282|     public function portletModifiedObjectsAction(Request $request)
   283|     {
   284|         $list = DataObject::getList([
   285|             'limit' => 10,
   286|             'order' => 'DESC',
   287|             'orderKey' => 'o_modificationDate',
   288|             'condition' => "o_userModification = '".$this->getAdminUser()->getId()."'",
   289|         ]);
   290|         $response = [];
   291|         $response['objects'] = [];
   292|         foreach ($list as $object) {
   293|             if ($object->isAllowed('view')) {
   294|                 $response['objects'][] = [
   295|                     'id' => $object->getId(),
   296|                     'type' => $object->getType(),
   297|                     'path' => $object->getRealFullPath(),
   298|                     'date' => $object->getModificationDate(),
   299|                 ];
   300|             }
   301|         }
   302|         return $this->adminJson($response);
   303|     }
   304|     /**
   305|      * @Route("/portlet-modification-statistics", name="pimcore_admin_portal_portletmodificationstatistics", methods={"GET"})
   306|      *
   307|      * @param Request $request
   308|      *
   309|      * @return JsonResponse
   310|      */
   311|     public function portletModificationStatisticsAction(Request $request)
   312|     {
   313|         $db = \Pimcore\Db::get();
   314|         $days = 31;
   315|         $startDate = mktime(23, 59, 59, date('m'), date('d'), date('Y'));
   316|         $data = [];
   317|         for ($i = 0; $i < $days; $i++) {
   318|             $end = $startDate - ($i * 86400);
   319|             $start = $end - 86399;
   320|             $o = $db->fetchOne('SELECT COUNT(*) AS count FROM objects WHERE o_modificationDate > '.$start . ' AND o_modificationDate < '.$end);
   321|             $a = $db->fetchOne('SELECT COUNT(*) AS count FROM assets WHERE modificationDate > '.$start . ' AND modificationDate < '.$end);
   322|             $d = $db->fetchOne('SELECT COUNT(*) AS count FROM documents WHERE modificationDate > '.$start . ' AND modificationDate < '.$end);
   323|             $date = new \DateTime();
   324|             $date->setTimestamp($start);
   325|             $data[] = [
   326|                 'timestamp' => $start,
   327|                 'datetext' => $date->format('Y-m-d'),
   328|                 'objects' => (int) $o,
   329|                 'documents' => (int) $d,
   330|                 'assets' => (int) $a,
   331|             ];
   332|         }
   333|         $data = array_reverse($data);
   334|         return $this->adminJson(['data' => $data]);
   335|     }
   336|     /**
   337|      * @Route("/portlet-analytics-sites", name="pimcore_admin_portal_portletanalyticssites", methods={"GET"})
   338|      *
   339|      * @param TranslatorInterface $translator
   340|      * @param SiteConfigProvider $siteConfigProvider
   341|      *
   342|      * @return JsonResponse
   343|      */
   344|     public function portletAnalyticsSitesAction(
   345|         TranslatorInterface $translator,
   346|         SiteConfigProvider $siteConfigProvider
   347|     ) {
   348|         $sites = new Site\Listing();
   349|         $data = [
   350|             [
   351|                 'id' => 0,
   352|                 'site' => $translator->trans('main_site', [], 'admin'),
   353|             ],
   354|         ];
   355|         foreach ($sites->load() as $site) {
   356|             if ($siteConfigProvider->isSiteReportingConfigured($site)) {
   357|                 $data[] = [
   358|                     'id' => $site->getId(),
   359|                     'site' => $site->getMainDomain(),
   360|                 ];
   361|             }
   362|         }
   363|         return $this->adminJson(['data' => $data]);
   364|     }
   365|     /**
   366|      * @param ControllerEvent $event
   367|      */
   368|     public function onKernelControllerEvent(ControllerEvent $event)
   369|     {
   370|         $isMasterRequest = $event->isMasterRequest();
   371|         if (!$isMasterRequest) {
   372|             return;
   373|         }
   374|         $this->dashboardHelper = new \Pimcore\Helper\Dashboard($this->getAdminUser());
   375|     }
   376| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/RecyclebinController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-183 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Controller\KernelControllerEventInterface;
    17| use Pimcore\Model\Element;
    18| use Pimcore\Model\Element\Recyclebin;
    19| use Symfony\Component\HttpFoundation\JsonResponse;
    20| use Symfony\Component\HttpFoundation\Request;
    21| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    22| use Symfony\Component\Routing\Annotation\Route;
    23| /**
    24|  * @internal
    25|  */
    26| class RecyclebinController extends AdminController implements KernelControllerEventInterface
    27| {
    28|     /**
    29|      * @Route("/recyclebin/list", name="pimcore_admin_recyclebin_list", methods={"POST"})
    30|      *
    31|      * @param Request $request
    32|      *
    33|      * @return JsonResponse
    34|      */
    35|     public function listAction(Request $request)
    36|     {
    37|         if ($request->get('xaction') == 'destroy') {
    38|             $item = Recyclebin\Item::getById(\Pimcore\Bundle\AdminBundle\Helper\QueryParams::getRecordIdForGridRequest($request->get('data')));
    39|             $item->delete();
    40|             return $this->adminJson(['success' => true, 'data' => []]);
    41|         } else {
    42|             $db = \Pimcore\Db::get();
    43|             $list = new Recyclebin\Item\Listing();
    44|             $list->setLimit($request->get('limit'));
    45|             $list->setOffset($request->get('start'));
    46|             $list->setOrderKey('date');
    47|             $list->setOrder('DESC');
    48|             $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(array_merge($request->request->all(), $request->query->all()));
    49|             if ($sortingSettings['orderKey']) {
    50|                 $list->setOrderKey($sortingSettings['orderKey']);
    51|                 $list->setOrder($sortingSettings['order']);
    52|             }
    53|             $conditionFilters = [];
    54|             if ($request->get('filterFullText')) {
    55|                 $conditionFilters[] = 'path LIKE ' . $list->quote('%'. $list->escapeLike($request->get('filterFullText')) .'%');
    56|             }
    57|             $filters = $request->get('filter');
    58|             if ($filters) {
    59|                 $filters = $this->decodeJson($filters);
    60|                 foreach ($filters as $filter) {
    61|                     $operator = '=';
    62|                     $filterField = $filter['property'];
    63|                     $filterOperator = $filter['operator'];
    64|                     if ($filter['type'] == 'string') {
    65|                         $operator = 'LIKE';
    66|                     } elseif ($filter['type'] == 'numeric') {
    67|                         if ($filterOperator == 'lt') {
    68|                             $operator = '<';
    69|                         } elseif ($filterOperator == 'gt') {
    70|                             $operator = '>';
    71|                         } elseif ($filterOperator == 'eq') {
    72|                             $operator = '=';
    73|                         }
    74|                     } elseif ($filter['type'] == 'date') {
    75|                         if ($filterOperator == 'lt') {
    76|                             $operator = '<';
    77|                         } elseif ($filterOperator == 'gt') {
    78|                             $operator = '>';
    79|                         } elseif ($filterOperator == 'eq') {
    80|                             $operator = '=';
    81|                         }
    82|                         $filter['value'] = strtotime($filter['value']);
    83|                     } elseif ($filter['type'] == 'list') {
    84|                         $operator = '=';
    85|                     } elseif ($filter['type'] == 'boolean') {
    86|                         $operator = '=';
    87|                         $filter['value'] = (int) $filter['value'];
    88|                     }
    89|                     $value = $filter['value'];
    90|                     if ($operator == 'LIKE') {
    91|                         $value = '%' . $value . '%';
    92|                     }
    93|                     $field = '`' . $filterField . '` ';
    94|                     if ($filter['field'] == 'fullpath') {
    95|                         $field = 'CONCAT(path,filename)';
    96|                     }
    97|                     if ($filter['type'] == 'date' && $operator == '=') {
    98|                         $maxTime = $value + (86400 - 1); //specifies the top point of the range used in the condition
    99|                         $condition = $field . ' BETWEEN ' . $db->quote($value) . ' AND ' . $db->quote($maxTime);
   100|                         $conditionFilters[] = $condition;
   101|                     } else {
   102|                         $conditionFilters[] = $field . $operator . " '" . $value . "' ";
   103|                     }
   104|                 }
   105|             }
   106|             if (!empty($conditionFilters)) {
   107|                 $condition = implode(' AND ', $conditionFilters);
   108|                 $list->setCondition($condition);
   109|             }
   110|             $items = $list->load();
   111|             $data = [];
   112|             if (is_array($items)) {
   113|                 /** @var Recyclebin\Item $item */
   114|                 foreach ($items as $item) {
   115|                     $data[] = $item->getObjectVars();
   116|                 }
   117|             }
   118|             return $this->adminJson(['data' => $data, 'success' => true, 'total' => $list->getTotalCount()]);
   119|         }
   120|     }
   121|     /**
   122|      * @Route("/recyclebin/restore", name="pimcore_admin_recyclebin_restore", methods={"POST"})
   123|      *
   124|      * @param Request $request
   125|      *
   126|      * @return JsonResponse
   127|      */
   128|     public function restoreAction(Request $request)
   129|     {
   130|         $item = Recyclebin\Item::getById($request->get('id'));
   131|         $item->restore();
   132|         return $this->adminJson(['success' => true]);
   133|     }
   134|     /**
   135|      * @Route("/recyclebin/flush", name="pimcore_admin_recyclebin_flush", methods={"DELETE"})
   136|      *
   137|      * @return JsonResponse
   138|      */
   139|     public function flushAction()
   140|     {
   141|         $bin = new Element\Recyclebin();
   142|         $bin->flush();
   143|         return $this->adminJson(['success' => true]);
   144|     }
   145|     /**
   146|      * @Route("/recyclebin/add", name="pimcore_admin_recyclebin_add", methods={"POST"})
   147|      *
   148|      * @param Request $request
   149|      *
   150|      * @return JsonResponse
   151|      */
   152|     public function addAction(Request $request)
   153|     {
   154|         try {
   155|             $element = Element\Service::getElementById($request->get('type'), $request->get('id'));
   156|             if ($element) {
   157|                 $list = $element::getList(['unpublished' => true]);
   158|                 $list->setCondition((($request->get('type') === 'object') ? 'o_' : '') . 'path LIKE ' . $list->quote($list->escapeLike($element->getRealFullPath()) . '/%'));
   159|                 $children = $list->getTotalCount();
   160|                 if ($children <= 100) {
   161|                     Recyclebin\Item::create($element, $this->getAdminUser());
   162|                 }
   163|             }
   164|         } catch (\Exception $e) {
   165|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   166|         }
   167|         return $this->adminJson(['success' => true]);
   168|     }
   169|     /**
   170|      * @param ControllerEvent $event
   171|      */
   172|     public function onKernelControllerEvent(ControllerEvent $event)
   173|     {
   174|         $isMasterRequest = $event->isMasterRequest();
   175|         if (!$isMasterRequest) {
   176|             return;
   177|         }
   178|         $timeout = 600; // 10 minutes
   179|         @ini_set('max_execution_time', $timeout);
   180|         set_time_limit($timeout);
   181|         $this->checkActionPermission($event, 'recyclebin', ['addAction']);
   182|     }
   183| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/RedirectsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-212 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    18| use Pimcore\Logger;
    19| use Pimcore\Model\Document;
    20| use Pimcore\Model\Redirect;
    21| use Pimcore\Model\Site;
    22| use Pimcore\Routing\Redirect\Csv;
    23| use Pimcore\Routing\RedirectHandler;
    24| use Symfony\Component\HttpFoundation\File\UploadedFile;
    25| use Symfony\Component\HttpFoundation\Request;
    26| use Symfony\Component\HttpFoundation\Response;
    27| use Symfony\Component\HttpFoundation\ResponseHeaderBag;
    28| use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
    29| use Symfony\Component\Routing\Annotation\Route;
    30| /**
    31|  * @Route("/redirects")
    32|  *
    33|  * @internal
    34|  */
    35| class RedirectsController extends AdminController
    36| {
    37|     /**
    38|      * @Route("/list", name="pimcore_admin_redirects_redirects", methods={"POST"})
    39|      *
    40|      * @param Request $request
    41|      * @param RedirectHandler $redirectHandler
    42|      *
    43|      * @return JsonResponse
    44|      */
    45|     public function redirectsAction(Request $request, RedirectHandler $redirectHandler)
    46|     {
    47|         $this->checkPermission('redirects');
    48|         if ($request->get('data')) {
    49|             if ($request->get('xaction') == 'destroy') {
    50|                 $data = $this->decodeJson($request->get('data'));
    51|                 $id = $data['id'] ?? null;
    52|                 if ($id) {
    53|                     $redirect = Redirect::getById($id);
    54|                     $redirect->delete();
    55|                 }
    56|                 return $this->adminJson(['success' => true, 'data' => []]);
    57|             } elseif ($request->get('xaction') == 'update') {
    58|                 $data = $this->decodeJson($request->get('data'));
    59|                 $redirect = Redirect::getById($data['id']);
    60|                 if ($data['target']) {
    61|                     if ($doc = Document::getByPath($data['target'])) {
    62|                         $data['target'] = $doc->getId();
    63|                     }
    64|                 }
    65|                 if (!$data['regex'] && $data['source']) {
    66|                     $data['source'] = str_replace('+', ' ', $data['source']);
    67|                 }
    68|                 $redirect->setValues($data);
    69|                 $redirect->save();
    70|                 $redirectTarget = $redirect->getTarget();
    71|                 if (is_numeric($redirectTarget)) {
    72|                     if ($doc = Document::getById((int)$redirectTarget)) {
    73|                         $redirect->setTarget($doc->getRealFullPath());
    74|                     }
    75|                 }
    76|                 return $this->adminJson(['data' => $redirect->getObjectVars(), 'success' => true]);
    77|             } elseif ($request->get('xaction') == 'create') {
    78|                 $data = $this->decodeJson($request->get('data'));
    79|                 unset($data['id']);
    80|                 $redirect = new Redirect();
    81|                 if (!empty($data['target'])) {
    82|                     if ($doc = Document::getByPath($data['target'])) {
    83|                         $data['target'] = $doc->getId();
    84|                     }
    85|                 }
    86|                 if (isset($data['regex']) && !$data['regex'] && isset($data['source']) && $data['source']) {
    87|                     $data['source'] = str_replace('+', ' ', $data['source']);
    88|                 }
    89|                 $redirect->setValues($data);
    90|                 $redirect->save();
    91|                 $redirectTarget = $redirect->getTarget();
    92|                 if (is_numeric($redirectTarget)) {
    93|                     if ($doc = Document::getById((int)$redirectTarget)) {
    94|                         $redirect->setTarget($doc->getRealFullPath());
    95|                     }
    96|                 }
    97|                 return $this->adminJson(['data' => $redirect->getObjectVars(), 'success' => true]);
    98|             }
    99|         } else {
   100|             $list = new Redirect\Listing();
   101|             $list->setLimit($request->get('limit'));
   102|             $list->setOffset($request->get('start'));
   103|             $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(array_merge($request->request->all(), $request->query->all()));
   104|             if ($sortingSettings['orderKey']) {
   105|                 $list->setOrderKey($sortingSettings['orderKey']);
   106|                 $list->setOrder($sortingSettings['order']);
   107|             }
   108|             if ($filterValue = $request->get('filter')) {
   109|                 if (is_numeric($filterValue)) {
   110|                     $list->setCondition('id = ?', [$filterValue]);
   111|                 } elseif (preg_match('@^https?://@', $filterValue)) {
   112|                     $dummyRequest = Request::create($filterValue);
   113|                     $site = Site::getByDomain($dummyRequest->getHost());
   114|                     $dummyResponse = $redirectHandler->checkForRedirect($dummyRequest, false, $site);
   115|                     if ($dummyResponse && $redirectId = $dummyResponse->headers->get(RedirectHandler::RESPONSE_HEADER_NAME_ID)) {
   116|                         $list->setCondition('id = ?', [$redirectId]);
   117|                     } else {
   118|                         $list->setCondition('1 = 2');
   119|                     }
   120|                 } else {
   121|                     $list->setCondition('`source` LIKE ' . $list->quote('%' . $filterValue . '%') . ' OR `target` LIKE ' . $list->quote('%' . $filterValue . '%'));
   122|                 }
   123|             }
   124|             $list->load();
   125|             $redirects = [];
   126|             foreach ($list->getRedirects() as $redirect) {
   127|                 if ($link = $redirect->getTarget()) {
   128|                     if (is_numeric($link)) {
   129|                         if ($doc = Document::getById((int)$link)) {
   130|                             $redirect->setTarget($doc->getRealFullPath());
   131|                         }
   132|                     }
   133|                 }
   134|                 $redirects[] = $redirect->getObjectVars();
   135|             }
   136|             return $this->adminJson(['data' => $redirects, 'success' => true, 'total' => $list->getTotalCount()]);
   137|         }
   138|         return $this->adminJson(['success' => false]);
   139|     }
   140|     /**
   141|      * @Route("/csv-export", name="pimcore_admin_redirects_csvexport", methods={"GET"})
   142|      *
   143|      * @param Request $request
   144|      * @param Csv $csv
   145|      *
   146|      * @return Response
   147|      */
   148|     public function csvExportAction(Request $request, Csv $csv)
   149|     {
   150|         $this->checkPermission('redirects');
   151|         $list = new Redirect\Listing();
   152|         $list->setOrderKey('id');
   153|         $list->setOrder('ASC');
   154|         $list->load();
   155|         $writer = $csv->createExportWriter($list);
   156|         $response = new Response();
   157|         $response->headers->set('Content-Encoding', 'none');
   158|         $response->headers->set('Content-Type', 'text/csv; charset=UTF-8');
   159|         $response->headers->set('Content-Disposition', $response->headers->makeDisposition(
   160|             ResponseHeaderBag::DISPOSITION_ATTACHMENT,
   161|             'redirects.csv'
   162|         ));
   163|         $response->setContent($writer->getContent());
   164|         return $response;
   165|     }
   166|     /**
   167|      * @Route("/csv-import", name="pimcore_admin_redirects_csvimport", methods={"POST"})
   168|      *
   169|      * @param Request $request
   170|      * @param Csv $csv
   171|      *
   172|      * @return Response
   173|      */
   174|     public function csvImportAction(Request $request, Csv $csv)
   175|     {
   176|         $this->checkPermission('redirects');
   177|         /** @var UploadedFile|null $file */
   178|         $file = $request->files->get('redirects');
   179|         if (!$file) {
   180|             throw new BadRequestHttpException('Missing file');
   181|         }
   182|         $result = $csv->import($file->getRealPath());
   183|         return $this->adminJson([
   184|             'success' => true,
   185|             'data' => $result,
   186|         ]);
   187|     }
   188|     /**
   189|      * @Route("/cleanup", name="pimcore_admin_redirects_cleanup", methods={"DELETE"})
   190|      *
   191|      * @param Request $request
   192|      *
   193|      * @return JsonResponse
   194|      */
   195|     public function cleanupAction(Request $request)
   196|     {
   197|         $this->checkPermission('redirects');
   198|         try {
   199|             $now = time();
   200|             $expiredRedirects = new Redirect\Listing();
   201|             $expiredRedirects->setCondition("expiry IS NOT NULL AND expiry < $now");
   202|             $expiredRedirects = $expiredRedirects->load();
   203|             foreach ($expiredRedirects as $expiredRedirect) {
   204|                 $expiredRedirect->delete();
   205|             }
   206|             return $this->adminJson(['success' => true]);
   207|         } catch (\Exception $e) {
   208|             Logger::error($e->getMessage());
   209|             return $this->adminJson(['success' => false]);
   210|         }
   211|     }
   212| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/SettingsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1383 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Cache;
    17| use Pimcore\Cache\Core\CoreCacheHandler;
    18| use Pimcore\Cache\Symfony\CacheClearer;
    19| use Pimcore\Config;
    20| use Pimcore\Event\SystemEvents;
    21| use Pimcore\File;
    22| use Pimcore\Localization\LocaleServiceInterface;
    23| use Pimcore\Model;
    24| use Pimcore\Model\Asset;
    25| use Pimcore\Model\Document;
    26| use Pimcore\Model\Element;
    27| use Pimcore\Model\Glossary;
    28| use Pimcore\Model\Metadata;
    29| use Pimcore\Model\Property;
    30| use Pimcore\Model\Staticroute;
    31| use Pimcore\Model\Tool\SettingsStore;
    32| use Pimcore\Model\WebsiteSetting;
    33| use Pimcore\Tool;
    34| use Symfony\Component\EventDispatcher\EventDispatcherInterface;
    35| use Symfony\Component\EventDispatcher\GenericEvent;
    36| use Symfony\Component\Filesystem\Filesystem;
    37| use Symfony\Component\HttpFoundation\JsonResponse;
    38| use Symfony\Component\HttpFoundation\Request;
    39| use Symfony\Component\HttpFoundation\Response;
    40| use Symfony\Component\HttpFoundation\StreamedResponse;
    41| use Symfony\Component\HttpKernel\KernelEvents;
    42| use Symfony\Component\HttpKernel\KernelInterface;
    43| use Symfony\Component\Routing\Annotation\Route;
    44| use Symfony\Component\Yaml\Yaml;
    45| /**
    46|  * @Route("/settings")
    47|  *
    48|  * @internal
    49|  */
    50| class SettingsController extends AdminController
    51| {
    52|     private const CUSTOM_LOGO_PATH = 'custom-logo.image';
    53|     /**
    54|      * @Route("/display-custom-logo", name="pimcore_settings_display_custom_logo", methods={"GET"})
    55|      *
    56|      * @param Request $request
    57|      *
    58|      * @return StreamedResponse
    59|      */
    60|     public function displayCustomLogoAction(Request $request)
    61|     {
    62|         $mime = 'image/svg+xml';
    63|         if ($request->get('white')) {
    64|             $logo = PIMCORE_WEB_ROOT . '/bundles/pimcoreadmin/img/logo-claim-white.svg';
    65|         } else {
    66|             $logo = PIMCORE_WEB_ROOT . '/bundles/pimcoreadmin/img/logo-claim-gray.svg';
    67|         }
    68|         $stream = fopen($logo, 'rb');
    69|         $storage = Tool\Storage::get('admin');
    70|         if ($storage->fileExists(self::CUSTOM_LOGO_PATH)) {
    71|             try {
    72|                 $mime = $storage->mimeType(self::CUSTOM_LOGO_PATH);
    73|                 $stream = $storage->readStream(self::CUSTOM_LOGO_PATH);
    74|             } catch (\Exception $e) {
    75|             }
    76|         }
    77|         return new StreamedResponse(function () use ($stream) {
    78|             fpassthru($stream);
    79|         }, 200, ['Content-Type' => $mime]);
    80|     }
    81|     /**
    82|      * @Route("/upload-custom-logo", name="pimcore_admin_settings_uploadcustomlogo", methods={"POST"})
    83|      *
    84|      * @param Request $request
    85|      *
    86|      * @return JsonResponse
    87|      *
    88|      * @throws \Exception
    89|      */
    90|     public function uploadCustomLogoAction(Request $request)
    91|     {
    92|         $fileExt = File::getFileExtension($_FILES['Filedata']['name']);
    93|         if (!in_array($fileExt, ['svg', 'png', 'jpg'])) {
    94|             throw new \Exception('Unsupported file format');
    95|         }
    96|         $storage = Tool\Storage::get('admin');
    97|         $storage->writeStream(self::CUSTOM_LOGO_PATH, fopen($_FILES['Filedata']['tmp_name'], 'rb'));
    98|         $response = $this->adminJson(['success' => true]);
    99|         $response->headers->set('Content-Type', 'text/html');
   100|         return $response;
   101|     }
   102|     /**
   103|      * @Route("/delete-custom-logo", name="pimcore_admin_settings_deletecustomlogo", methods={"DELETE"})
   104|      *
   105|      * @param Request $request
   106|      *
   107|      * @return JsonResponse
   108|      */
   109|     public function deleteCustomLogoAction(Request $request)
   110|     {
   111|         if (Tool\Storage::get('admin')->fileExists(self::CUSTOM_LOGO_PATH)) {
   112|             Tool\Storage::get('admin')->delete(self::CUSTOM_LOGO_PATH);
   113|         }
   114|         return $this->adminJson(['success' => true]);
   115|     }
   116|     /**
   117|      * Used by the predefined metadata grid
   118|      *
   119|      * @Route("/predefined-metadata", name="pimcore_admin_settings_metadata", methods={"POST"})
   120|      *
   121|      * @param Request $request
   122|      *
   123|      * @return JsonResponse
   124|      */
   125|     public function metadataAction(Request $request)
   126|     {
   127|         $this->checkPermission('asset_metadata');
   128|         if ($request->get('data')) {
   129|             if ($request->get('xaction') == 'destroy') {
   130|                 $data = $this->decodeJson($request->get('data'));
   131|                 $id = $data['id'];
   132|                 $metadata = Metadata\Predefined::getById($id);
   133|                 $metadata->delete();
   134|                 return $this->adminJson(['success' => true, 'data' => []]);
   135|             } elseif ($request->get('xaction') == 'update') {
   136|                 $data = $this->decodeJson($request->get('data'));
   137|                 $metadata = Metadata\Predefined::getById($data['id']);
   138|                 $metadata->setValues($data);
   139|                 $existingItem = Metadata\Predefined\Listing::getByKeyAndLanguage($metadata->getName(), $metadata->getLanguage(), $metadata->getTargetSubtype());
   140|                 if ($existingItem && $existingItem->getId() != $metadata->getId()) {
   141|                     return $this->adminJson(['message' => 'rule_violation', 'success' => false]);
   142|                 }
   143|                 $metadata->minimize();
   144|                 $metadata->save();
   145|                 $metadata->expand();
   146|                 return $this->adminJson(['data' => $metadata->getObjectVars(), 'success' => true]);
   147|             } elseif ($request->get('xaction') == 'create') {
   148|                 $data = $this->decodeJson($request->get('data'));
   149|                 unset($data['id']);
   150|                 $metadata = Metadata\Predefined::create();
   151|                 $metadata->setValues($data);
   152|                 $existingItem = Metadata\Predefined\Listing::getByKeyAndLanguage($metadata->getName(), $metadata->getLanguage(), $metadata->getTargetSubtype());
   153|                 if ($existingItem) {
   154|                     return $this->adminJson(['message' => 'rule_violation', 'success' => false]);
   155|                 }
   156|                 $metadata->save();
   157|                 return $this->adminJson(['data' => $metadata->getObjectVars(), 'success' => true]);
   158|             }
   159|         } else {
   160|             $list = new Metadata\Predefined\Listing();
   161|             if ($request->get('filter')) {
   162|                 $filter = $request->get('filter');
   163|                 $list->setFilter(function ($row) use ($filter) {
   164|                     foreach ($row as $value) {
   165|                         if (strpos($value, $filter) !== false) {
   166|                             return true;
   167|                         }
   168|                     }
   169|                     return false;
   170|                 });
   171|             }
   172|             $list->load();
   173|             $properties = [];
   174|             if (is_array($list->getDefinitions())) {
   175|                 foreach ($list->getDefinitions() as $metadata) {
   176|                     $metadata->expand();
   177|                     $properties[] = $metadata->getObjectVars();
   178|                 }
   179|             }
   180|             return $this->adminJson(['data' => $properties, 'success' => true, 'total' => $list->getTotalCount()]);
   181|         }
   182|         return $this->adminJson(['success' => false]);
   183|     }
   184|     /**
   185|      * @Route("/get-predefined-metadata", name="pimcore_admin_settings_getpredefinedmetadata", methods={"GET"})
   186|      *
   187|      * @param Request $request
   188|      *
   189|      * @return JsonResponse
   190|      */
   191|     public function getPredefinedMetadataAction(Request $request)
   192|     {
   193|         $type = $request->get('type');
   194|         $subType = $request->get('subType');
   195|         $list = Metadata\Predefined\Listing::getByTargetType($type, [$subType]);
   196|         $result = [];
   197|         foreach ($list as $item) {
   198|             $item->expand();
   199|             $result[] = $item->getObjectVars();
   200|         }
   201|         return $this->adminJson(['data' => $result, 'success' => true]);
   202|     }
   203|     /**
   204|      * @Route("/properties", name="pimcore_admin_settings_properties", methods={"POST"})
   205|      *
   206|      * @param Request $request
   207|      *
   208|      * @return JsonResponse
   209|      */
   210|     public function propertiesAction(Request $request)
   211|     {
   212|         if ($request->get('data')) {
   213|             $this->checkPermission('predefined_properties');
   214|             if ($request->get('xaction') == 'destroy') {
   215|                 $data = $this->decodeJson($request->get('data'));
   216|                 $id = $data['id'];
   217|                 $property = Property\Predefined::getById($id);
   218|                 $property->delete();
   219|                 return $this->adminJson(['success' => true, 'data' => []]);
   220|             } elseif ($request->get('xaction') == 'update') {
   221|                 $data = $this->decodeJson($request->get('data'));
   222|                 $property = Property\Predefined::getById($data['id']);
   223|                 if (is_array($data['ctype'])) {
   224|                     $data['ctype'] = implode(',', $data['ctype']);
   225|                 }
   226|                 $property->setValues($data);
   227|                 $property->save();
   228|                 return $this->adminJson(['data' => $property->getObjectVars(), 'success' => true]);
   229|             } elseif ($request->get('xaction') == 'create') {
   230|                 $data = $this->decodeJson($request->get('data'));
   231|                 unset($data['id']);
   232|                 $property = Property\Predefined::create();
   233|                 $property->setValues($data);
   234|                 $property->save();
   235|                 return $this->adminJson(['data' => $property->getObjectVars(), 'success' => true]);
   236|             }
   237|         } else {
   238|             $list = new Property\Predefined\Listing();
   239|             if ($request->get('filter')) {
   240|                 $filter = $request->get('filter');
   241|                 $list->setFilter(function ($row) use ($filter) {
   242|                     foreach ($row as $value) {
   243|                         if ($value) {
   244|                             $cellValues = is_array($value) ? $value : [$value];
   245|                             foreach ($cellValues as $cellValue) {
   246|                                 if (strpos($cellValue, $filter) !== false) {
   247|                                     return true;
   248|                                 }
   249|                             }
   250|                         }
   251|                     }
   252|                     return false;
   253|                 });
   254|             }
   255|             $list->load();
   256|             $properties = [];
   257|             if (is_array($list->getProperties())) {
   258|                 foreach ($list->getProperties() as $property) {
   259|                     $properties[] = $property->getObjectVars();
   260|                 }
   261|             }
   262|             return $this->adminJson(['data' => $properties, 'success' => true, 'total' => $list->getTotalCount()]);
   263|         }
   264|         return $this->adminJson(['success' => false]);
   265|     }
   266|     /**
   267|      * @Route("/get-system", name="pimcore_admin_settings_getsystem", methods={"GET"})
   268|      *
   269|      * @param Request $request
   270|      * @param Config $config
   271|      *
   272|      * @return JsonResponse
   273|      */
   274|     public function getSystemAction(Request $request, Config $config)
   275|     {
   276|         $this->checkPermission('system_settings');
   277|         $valueArray = [
   278|             'general' => $config['general'],
   279|             'documents' => $config['documents'],
   280|             'assets' => $config['assets'],
   281|             'objects' => $config['objects'],
   282|             'branding' => $config['branding'],
   283|             'email' => $config['email'],
   284|         ];
   285|         $locales = Tool::getSupportedLocales();
   286|         $languageOptions = [];
   287|         $validLanguages = [];
   288|         foreach ($locales as $short => $translation) {
   289|             if (!empty($short)) {
   290|                 $languageOptions[] = [
   291|                     'language' => $short,
   292|                     'display' => $translation . " ($short)",
   293|                 ];
   294|                 $validLanguages[] = $short;
   295|             }
   296|         }
   297|         $valueArray['general']['valid_language'] = explode(',', $valueArray['general']['valid_languages']);
   298|         if (is_array($valueArray['general']['valid_language'])) {
   299|             foreach ($valueArray['general']['valid_language'] as $existingValue) {
   300|                 if (!in_array($existingValue, $validLanguages)) {
   301|                     $languageOptions[] = [
   302|                         'language' => $existingValue,
   303|                         'display' => $existingValue,
   304|                     ];
   305|                 }
   306|             }
   307|         }
   308|         $response = [
   309|             'values' => $valueArray,
   310|             'config' => [
   311|                 'languages' => $languageOptions,
   312|             ],
   313|         ];
   314|         return $this->adminJson($response);
   315|     }
   316|     /**
   317|      * @Route("/set-system", name="pimcore_admin_settings_setsystem", methods={"PUT"})
   318|      *
   319|      * @param Request $request
   320|      * @param LocaleServiceInterface $localeService
   321|      *
   322|      * @return JsonResponse
   323|      */
   324|     public function setSystemAction(Request $request, LocaleServiceInterface $localeService)
   325|     {
   326|         $this->checkPermission('system_settings');
   327|         $values = $this->decodeJson($request->get('data'));
   328|         $existingValues = [];
   329|         try {
   330|             $file = Config::locateConfigFile('system.yml');
   331|             $existingValues = Config::getConfigInstance($file, true);
   332|         } catch (\Exception $e) {
   333|         }
   334|         $fallbackLanguages = [];
   335|         $existingValues['pimcore']['general']['fallback_languages'] = [];
   336|         $languages = explode(',', $values['general.validLanguages']);
   337|         $filteredLanguages = [];
   338|         foreach ($languages as $language) {
   339|             if (isset($values['general.fallbackLanguages.' . $language])) {
   340|                 $fallbackLanguages[$language] = str_replace(' ', '', $values['general.fallbackLanguages.' . $language]);
   341|             }
   342|             if ($localeService->isLocale($language)) {
   343|                 $filteredLanguages[] = $language;
   344|             }
   345|         }
   346|         foreach ($fallbackLanguages as $sourceLang => $targetLang) {
   347|             $this->checkFallbackLanguageLoop($sourceLang, $fallbackLanguages);
   348|         }
   349|         $settings['pimcore'] = [
   350|             'general' => [
   351|                 'domain' => $values['general.domain'],
   352|                 'redirect_to_maindomain' => $values['general.redirect_to_maindomain'],
   353|                 'language' => $values['general.language'],
   354|                 'valid_languages' => implode(',', $filteredLanguages),
   355|                 'fallback_languages' => $fallbackLanguages,
   356|                 'default_language' => $values['general.defaultLanguage'],
   357|                 'debug_admin_translations' => $values['general.debug_admin_translations'],
   358|             ],
   359|             'documents' => [
   360|                 'versions' => [
   361|                     'days' => $values['documents.versions.days'] ?? null,
   362|                     'steps' => $values['documents.versions.steps'] ?? null,
   363|                 ],
   364|                 'error_pages' => [
   365|                     'default' => $values['documents.error_pages.default'],
   366|                 ],
   367|             ],
   368|             'objects' => [
   369|                 'versions' => [
   370|                     'days' => $values['objects.versions.days'] ?? null,
   371|                     'steps' => $values['objects.versions.steps'] ?? null,
   372|                 ],
   373|             ],
   374|             'assets' => [
   375|                 'versions' => [
   376|                     'days' => $values['assets.versions.days'] ?? null,
   377|                     'steps' => $values['assets.versions.steps'] ?? null,
   378|                 ],
   379|                 'hide_edit_image' => $values['assets.hide_edit_image'],
   380|                 'disable_tree_preview' => $values['assets.disable_tree_preview'],
   381|             ],
   382|         ];
   383|         $settings['pimcore_admin'] = [
   384|             'branding' =>
   385|                 [
   386|                     'login_screen_invert_colors' => $values['branding.login_screen_invert_colors'],
   387|                     'color_login_screen' => $values['branding.color_login_screen'],
   388|                     'color_admin_interface' => $values['branding.color_admin_interface'],
   389|                     'login_screen_custom_image' => $values['branding.login_screen_custom_image'],
   390|                 ],
   391|         ];
   392|         if (array_key_exists('email.debug.emailAddresses', $values) && $values['email.debug.emailAddresses']) {
   393|             $settings['pimcore']['email']['debug']['email_addresses'] = $values['email.debug.emailAddresses'];
   394|         }
   395|         $settingsYml = Yaml::dump($settings, 5);
   396|         $configFile = Config::locateConfigFile('system.yml');
   397|         File::put($configFile, $settingsYml);
   398|         $this->forward(self::class . '::clearCacheAction', [
   399|             'only_symfony_cache' => false,
   400|             'only_pimcore_cache' => false,
   401|             'env' => [\Pimcore::getKernel()->getEnvironment()],
   402|         ]);
   403|         return $this->adminJson(['success' => true]);
   404|     }
   405|     /**
   406|      * @param string $source
   407|      * @param array $definitions
   408|      * @param array $fallbacks
   409|      *
   410|      * @throws \Exception
   411|      */
   412|     protected function checkFallbackLanguageLoop($source, $definitions, $fallbacks = [])
   413|     {
   414|         if (isset($definitions[$source])) {
   415|             $targets = explode(',', $definitions[$source]);
   416|             foreach ($targets as $l) {
   417|                 $target = trim($l);
   418|                 if ($target) {
   419|                     if (in_array($target, $fallbacks)) {
   420|                         throw new \Exception("Language `$source` | `$target` causes an infinte loop.");
   421|                     }
   422|                     $fallbacks[] = $target;
   423|                     $this->checkFallbackLanguageLoop($target, $definitions, $fallbacks);
   424|                 }
   425|             }
   426|         } else {
   427|             throw new \Exception("Language `$source` doesn't exist");
   428|         }
   429|     }
   430|     /**
   431|      * @Route("/get-web2print", name="pimcore_admin_settings_getweb2print", methods={"GET"})
   432|      *
   433|      * @param Request $request
   434|      *
   435|      * @return JsonResponse
   436|      */
   437|     public function getWeb2printAction(Request $request)
   438|     {
   439|         $this->checkPermission('web2print_settings');
   440|         $values = Config::getWeb2PrintConfig();
   441|         $valueArray = $values->toArray();
   442|         $optionsString = [];
   443|         if ($valueArray['wkhtml2pdfOptions']) {
   444|             foreach ($valueArray['wkhtml2pdfOptions'] as $key => $value) {
   445|                 $tmpStr = '--'.$key;
   446|                 if ($value !== null && $value !== '') {
   447|                     $tmpStr .= ' '.$value;
   448|                 }
   449|                 $optionsString[] = $tmpStr;
   450|             }
   451|         }
   452|         $valueArray['wkhtml2pdfOptions'] = implode("\n", $optionsString);
   453|         $response = [
   454|             'values' => $valueArray,
   455|         ];
   456|         return $this->adminJson($response);
   457|     }
   458|     /**
   459|      * @Route("/set-web2print", name="pimcore_admin_settings_setweb2print", methods={"PUT"})
   460|      *
   461|      * @param Request $request
   462|      *
   463|      * @return JsonResponse
   464|      */
   465|     public function setWeb2printAction(Request $request)
   466|     {
   467|         $this->checkPermission('web2print_settings');
   468|         $values = $this->decodeJson($request->get('data'));
   469|         if ($values['wkhtml2pdfOptions']) {
   470|             $optionArray = [];
   471|             $lines = explode("\n", $values['wkhtml2pdfOptions']);
   472|             foreach ($lines as $line) {
   473|                 $parts = explode(' ', substr($line, 2));
   474|                 $key = trim($parts[0]);
   475|                 if ($key) {
   476|                     $value = trim($parts[1] ?? '');
   477|                     $optionArray[$key] = $value;
   478|                 }
   479|             }
   480|             $values['wkhtml2pdfOptions'] = $optionArray;
   481|         }
   482|         $configFile = \Pimcore\Config::locateConfigFile('web2print.php');
   483|         File::putPhpFile($configFile, to_php_data_file_format($values));
   484|         return $this->adminJson(['success' => true]);
   485|     }
   486|     /**
   487|      * @Route("/clear-cache", name="pimcore_admin_settings_clearcache", methods={"DELETE"})
   488|      *
   489|      * @param Request $request
   490|      * @param KernelInterface $kernel
   491|      * @param EventDispatcherInterface $eventDispatcher
   492|      * @param CoreCacheHandler $cache
   493|      * @param Filesystem $filesystem
   494|      * @param CacheClearer $symfonyCacheClearer
   495|      *
   496|      * @return JsonResponse
   497|      */
   498|     public function clearCacheAction(
   499|         Request $request,
   500|         KernelInterface $kernel,
   501|         EventDispatcherInterface $eventDispatcher,
   502|         CoreCacheHandler $cache,
   503|         Filesystem $filesystem,
   504|         CacheClearer $symfonyCacheClearer
   505|     ) {
   506|         $this->checkPermissionsHasOneOf(['clear_cache', 'system_settings']);
   507|         $result = [
   508|             'success' => true,
   509|         ];
   510|         $clearPimcoreCache = !(bool)$request->get('only_symfony_cache');
   511|         $clearSymfonyCache = !(bool)$request->get('only_pimcore_cache');
   512|         if ($clearPimcoreCache) {
   513|             $cache->clearAll();
   514|             if ($filesystem->exists(PIMCORE_CACHE_DIRECTORY)) {
   515|                 $filesystem->remove(PIMCORE_CACHE_DIRECTORY);
   516|             }
   517|             File::put(PIMCORE_CACHE_DIRECTORY . '/.gitkeep', '');
   518|             $eventDispatcher->dispatch(new GenericEvent(), SystemEvents::CACHE_CLEAR);
   519|         }
   520|         if ($clearSymfonyCache) {
   521|             $environments = $request->get('env', $kernel->getEnvironment());
   522|             if (!is_array($environments)) {
   523|                 $environments = trim((string)$environments);
   524|                 if (empty($environments)) {
   525|                     $environments = [];
   526|                 } else {
   527|                     $environments = [$environments];
   528|                 }
   529|             }
   530|             if (empty($environments)) {
   531|                 $environments = [$kernel->getEnvironment()];
   532|             }
   533|             $result['environments'] = $environments;
   534|             if (in_array($kernel->getEnvironment(), $environments)) {
   535|                 foreach ($eventDispatcher->getListeners(KernelEvents::TERMINATE) as $listener) {
   536|                     $eventDispatcher->removeListener(KernelEvents::TERMINATE, $listener);
   537|                 }
   538|                 foreach ($eventDispatcher->getListeners(KernelEvents::EXCEPTION) as $listener) {
   539|                     $eventDispatcher->removeListener(KernelEvents::EXCEPTION, $listener);
   540|                 }
   541|             }
   542|             foreach ($environments as $environment) {
   543|                 try {
   544|                     $symfonyCacheClearer->clear($environment);
   545|                 } catch (\Throwable $e) {
   546|                     $errors = $result['errors'] ?? [];
   547|                     $errors[] = $e->getMessage();
   548|                     $result = array_merge($result, [
   549|                         'success' => false,
   550|                         'errors' => $errors,
   551|                     ]);
   552|                 }
   553|             }
   554|         }
   555|         $response = new JsonResponse($result);
   556|         if ($clearSymfonyCache) {
   557|             $response->sendHeaders();
   558|             $response->sendContent();
   559|             exit;
   560|         }
   561|         return $response;
   562|     }
   563|     /**
   564|      * @Route("/clear-output-cache", name="pimcore_admin_settings_clearoutputcache", methods={"DELETE"})
   565|      *
   566|      * @param EventDispatcherInterface $eventDispatcher
   567|      *
   568|      * @return JsonResponse
   569|      */
   570|     public function clearOutputCacheAction(EventDispatcherInterface $eventDispatcher)
   571|     {
   572|         $this->checkPermission('clear_fullpage_cache');
   573|         Cache::removeIgnoredTagOnClear('output');
   574|         Cache::clearTags(['output', 'output_lifetime']);
   575|         $eventDispatcher->dispatch(new GenericEvent(), SystemEvents::CACHE_CLEAR_FULLPAGE_CACHE);
   576|         return $this->adminJson(['success' => true]);
   577|     }
   578|     /**
   579|      * @Route("/clear-temporary-files", name="pimcore_admin_settings_cleartemporaryfiles", methods={"DELETE"})
   580|      *
   581|      * @param EventDispatcherInterface $eventDispatcher
   582|      *
   583|      * @return JsonResponse
   584|      */
   585|     public function clearTemporaryFilesAction(EventDispatcherInterface $eventDispatcher)
   586|     {
   587|         $this->checkPermission('clear_temp_files');
   588|         Tool\Storage::get('thumbnail')->deleteDirectory('/');
   589|         Tool\Storage::get('asset_cache')->deleteDirectory('/');
   590|         recursiveDelete(PIMCORE_SYSTEM_TEMP_DIRECTORY, false);
   591|         $eventDispatcher->dispatch(new GenericEvent(), SystemEvents::CACHE_CLEAR_TEMPORARY_FILES);
   592|         return $this->adminJson(['success' => true]);
   593|     }
   594|     /**
   595|      * @Route("/staticroutes", name="pimcore_admin_settings_staticroutes", methods={"POST"})
   596|      *
   597|      * @param Request $request
   598|      *
   599|      * @return JsonResponse
   600|      */
   601|     public function staticroutesAction(Request $request)
   602|     {
   603|         if ($request->get('data')) {
   604|             $this->checkPermission('routes');
   605|             $data = $this->decodeJson($request->get('data'));
   606|             if (is_array($data)) {
   607|                 foreach ($data as &$value) {
   608|                     if (is_string($value)) {
   609|                         $value = trim($value);
   610|                     }
   611|                 }
   612|             }
   613|             if ($request->get('xaction') == 'destroy') {
   614|                 $data = $this->decodeJson($request->get('data'));
   615|                 $id = $data['id'];
   616|                 $route = Staticroute::getById($id);
   617|                 $route->delete();
   618|                 return $this->adminJson(['success' => true, 'data' => []]);
   619|             } elseif ($request->get('xaction') == 'update') {
   620|                 $route = Staticroute::getById($data['id']);
   621|                 $route->setValues($data);
   622|                 $route->save();
   623|                 return $this->adminJson(['data' => $route->getObjectVars(), 'success' => true]);
   624|             } elseif ($request->get('xaction') == 'create') {
   625|                 unset($data['id']);
   626|                 $route = new Staticroute();
   627|                 $route->setValues($data);
   628|                 $route->save();
   629|                 return $this->adminJson(['data' => $route->getObjectVars(), 'success' => true]);
   630|             }
   631|         } else {
   632|             $list = new Staticroute\Listing();
   633|             if ($request->get('filter')) {
   634|                 $filter = $request->get('filter');
   635|                 $list->setFilter(function ($row) use ($filter) {
   636|                     foreach ($row as $value) {
   637|                         if (! is_scalar($value)) {
   638|                             continue;
   639|                         }
   640|                         if (strpos((string)$value, $filter) !== false) {
   641|                             return true;
   642|                         }
   643|                     }
   644|                     return false;
   645|                 });
   646|             }
   647|             $list->load();
   648|             $routes = [];
   649|             /** @var Staticroute $route */
   650|             foreach ($list->getRoutes() as $route) {
   651|                 if (is_array($route->getSiteId())) {
   652|                     $route = $route->getObjectVars();
   653|                     $route['siteId'] = implode(',', $route['siteId']);
   654|                 }
   655|                 $routes[] = $route;
   656|             }
   657|             return $this->adminJson(['data' => $routes, 'success' => true, 'total' => $list->getTotalCount()]);
   658|         }
   659|         return $this->adminJson(['success' => false]);
   660|     }
   661|     /**
   662|      * @Route("/get-available-admin-languages", name="pimcore_admin_settings_getavailableadminlanguages", methods={"GET"})
   663|      *
   664|      * @param Request $request
   665|      *
   666|      * @return JsonResponse
   667|      */
   668|     public function getAvailableAdminLanguagesAction(Request $request)
   669|     {
   670|         $langs = [];
   671|         $availableLanguages = Tool\Admin::getLanguages();
   672|         $locales = Tool::getSupportedLocales();
   673|         foreach ($availableLanguages as $lang) {
   674|             if (array_key_exists($lang, $locales)) {
   675|                 $langs[] = [
   676|                     'language' => $lang,
   677|                     'display' => $locales[$lang],
   678|                 ];
   679|             }
   680|         }
   681|         usort($langs, function ($a, $b) {
   682|             return strcmp($a['display'], $b['display']);
   683|         });
   684|         return $this->adminJson($langs);
   685|     }
   686|     /**
   687|      * @Route("/glossary", name="pimcore_admin_settings_glossary", methods={"POST"})
   688|      *
   689|      * @param Request $request
   690|      *
   691|      * @return JsonResponse
   692|      */
   693|     public function glossaryAction(Request $request)
   694|     {
   695|         if ($request->get('data')) {
   696|             $this->checkPermission('glossary');
   697|             Cache::clearTag('glossary');
   698|             if ($request->get('xaction') == 'destroy') {
   699|                 $data = $this->decodeJson($request->get('data'));
   700|                 $id = $data['id'];
   701|                 $glossary = Glossary::getById($id);
   702|                 $glossary->delete();
   703|                 return $this->adminJson(['success' => true, 'data' => []]);
   704|             } elseif ($request->get('xaction') == 'update') {
   705|                 $data = $this->decodeJson($request->get('data'));
   706|                 $glossary = Glossary::getById($data['id']);
   707|                 if (!empty($data['link'])) {
   708|                     if ($doc = Document::getByPath($data['link'])) {
   709|                         $data['link'] = $doc->getId();
   710|                     }
   711|                 }
   712|                 $glossary->setValues($data);
   713|                 $glossary->save();
   714|                 if ($link = $glossary->getLink()) {
   715|                     if ((int)$link > 0) {
   716|                         if ($doc = Document::getById((int)$link)) {
   717|                             $glossary->setLink($doc->getRealFullPath());
   718|                         }
   719|                     }
   720|                 }
   721|                 return $this->adminJson(['data' => $glossary, 'success' => true]);
   722|             } elseif ($request->get('xaction') == 'create') {
   723|                 $data = $this->decodeJson($request->get('data'));
   724|                 unset($data['id']);
   725|                 $glossary = new Glossary();
   726|                 if (!empty($data['link'])) {
   727|                     if ($doc = Document::getByPath($data['link'])) {
   728|                         $data['link'] = $doc->getId();
   729|                     }
   730|                 }
   731|                 $glossary->setValues($data);
   732|                 $glossary->save();
   733|                 if ($link = $glossary->getLink()) {
   734|                     if ((int)$link > 0) {
   735|                         if ($doc = Document::getById((int)$link)) {
   736|                             $glossary->setLink($doc->getRealFullPath());
   737|                         }
   738|                     }
   739|                 }
   740|                 return $this->adminJson(['data' => $glossary->getObjectVars(), 'success' => true]);
   741|             }
   742|         } else {
   743|             $list = new Glossary\Listing();
   744|             $list->setLimit($request->get('limit'));
   745|             $list->setOffset($request->get('start'));
   746|             $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(array_merge($request->request->all(), $request->query->all()));
   747|             if ($sortingSettings['orderKey']) {
   748|                 $list->setOrderKey($sortingSettings['orderKey']);
   749|                 $list->setOrder($sortingSettings['order']);
   750|             }
   751|             if ($request->get('filter')) {
   752|                 $list->setCondition('`text` LIKE ' . $list->quote('%'.$request->get('filter').'%'));
   753|             }
   754|             $list->load();
   755|             $glossaries = [];
   756|             foreach ($list->getGlossary() as $glossary) {
   757|                 if ($link = $glossary->getLink()) {
   758|                     if ((int)$link > 0) {
   759|                         if ($doc = Document::getById((int)$link)) {
   760|                             $glossary->setLink($doc->getRealFullPath());
   761|                         }
   762|                     }
   763|                 }
   764|                 $glossaries[] = $glossary->getObjectVars();
   765|             }
   766|             return $this->adminJson(['data' => $glossaries, 'success' => true, 'total' => $list->getTotalCount()]);
   767|         }
   768|         return $this->adminJson(['success' => false]);
   769|     }
   770|     /**
   771|      * @Route("/get-available-sites", name="pimcore_admin_settings_getavailablesites", methods={"GET"})
   772|      *
   773|      * @param Request $request
   774|      *
   775|      * @return JsonResponse
   776|      */
   777|     public function getAvailableSitesAction(Request $request)
   778|     {
   779|         $excludeMainSite = $request->get('excludeMainSite');
   780|         $sitesList = new Model\Site\Listing();
   781|         $sitesObjects = $sitesList->load();
   782|         $sites = [];
   783|         if (!$excludeMainSite) {
   784|             $sites[] = [
   785|                 'id' => 'default',
   786|                 'rootId' => 1,
   787|                 'domains' => '',
   788|                 'rootPath' => '/',
   789|                 'domain' => $this->trans('main_site'),
   790|             ];
   791|         }
   792|         foreach ($sitesObjects as $site) {
   793|             if ($site->getRootDocument()) {
   794|                 if ($site->getMainDomain()) {
   795|                     $sites[] = [
   796|                         'id' => $site->getId(),
   797|                         'rootId' => $site->getRootId(),
   798|                         'domains' => implode(',', $site->getDomains()),
   799|                         'rootPath' => $site->getRootPath(),
   800|                         'domain' => $site->getMainDomain(),
   801|                     ];
   802|                 }
   803|             } else {
   804|                 $site->delete();
   805|             }
   806|         }
   807|         return $this->adminJson($sites);
   808|     }
   809|     /**
   810|      * @Route("/get-available-countries", name="pimcore_admin_settings_getavailablecountries", methods={"GET"})
   811|      *
   812|      * @param LocaleServiceInterface $localeService
   813|      *
   814|      * @return JsonResponse
   815|      */
   816|     public function getAvailableCountriesAction(LocaleServiceInterface $localeService)
   817|     {
   818|         $countries = $localeService->getDisplayRegions();
   819|         asort($countries);
   820|         $options = [];
   821|         foreach ($countries as $short => $translation) {
   822|             if (strlen($short) == 2) {
   823|                 $options[] = [
   824|                     'key' => $translation . ' (' . $short . ')',
   825|                     'value' => $short,
   826|                 ];
   827|             }
   828|         }
   829|         $result = ['data' => $options, 'success' => true, 'total' => count($options)];
   830|         return $this->adminJson($result);
   831|     }
   832|     /**
   833|      * @Route("/thumbnail-adapter-check", name="pimcore_admin_settings_thumbnailadaptercheck", methods={"GET"})
   834|      *
   835|      * @param Request $request
   836|      *
   837|      * @return Response
   838|      */
   839|     public function thumbnailAdapterCheckAction(Request $request)
   840|     {
   841|         $content = '';
   842|         $instance = \Pimcore\Image::getInstance();
   843|         if ($instance instanceof \Pimcore\Image\Adapter\GD) {
   844|             $content = '<span style="color: red; font-weight: bold;padding: 10px;margin:0 0 20px 0;border:1px solid red;display:block;">' .
   845|                 $this->trans('important_use_imagick_pecl_extensions_for_best_results_gd_is_just_a_fallback_with_less_quality') .
   846|                 '</span>';
   847|         }
   848|         return new Response($content);
   849|     }
   850|     /**
   851|      * @Route("/thumbnail-tree", name="pimcore_admin_settings_thumbnailtree", methods={"GET", "POST"})
   852|      *
   853|      * @param Request $request
   854|      *
   855|      * @return JsonResponse
   856|      */
   857|     public function thumbnailTreeAction(Request $request)
   858|     {
   859|         $this->checkPermission('thumbnails');
   860|         $thumbnails = [];
   861|         $list = new Asset\Image\Thumbnail\Config\Listing();
   862|         $items = $list->getThumbnails();
   863|         $groups = [];
   864|         /** @var Asset\Image\Thumbnail\Config $item */
   865|         foreach ($items as $item) {
   866|             if ($item->getGroup()) {
   867|                 if (empty($groups[$item->getGroup()])) {
   868|                     $groups[$item->getGroup()] = [
   869|                         'id' => 'group_' . $item->getName(),
   870|                         'text' => $item->getGroup(),
   871|                         'expandable' => true,
   872|                         'leaf' => false,
   873|                         'allowChildren' => true,
   874|                         'iconCls' => 'pimcore_icon_folder',
   875|                         'group' => $item->getGroup(),
   876|                         'children' => [],
   877|                         ];
   878|                 }
   879|                 $groups[$item->getGroup()]['children'][] =
   880|                     [
   881|                         'id' => $item->getName(),
   882|                         'text' => $item->getName(),
   883|                         'leaf' => true,
   884|                         'iconCls' => 'pimcore_icon_thumbnails',
   885|                     ];
   886|             } else {
   887|                 $thumbnails[] = [
   888|                     'id' => $item->getName(),
   889|                     'text' => $item->getName(),
   890|                     'leaf' => true,
   891|                     'iconCls' => 'pimcore_icon_thumbnails',
   892|                 ];
   893|             }
   894|         }
   895|         foreach ($groups as $group) {
   896|             $thumbnails[] = $group;
   897|         }
   898|         return $this->adminJson($thumbnails);
   899|     }
   900|     /**
   901|      * @Route("/thumbnail-downloadable", name="pimcore_admin_settings_thumbnaildownloadable", methods={"GET"})
   902|      *
   903|      * @param Request $request
   904|      *
   905|      * @return JsonResponse
   906|      */
   907|     public function thumbnailDownloadableAction(Request $request)
   908|     {
   909|         $thumbnails = [];
   910|         $list = new Asset\Image\Thumbnail\Config\Listing();
   911|         $list->setFilter(function (array $config) {
   912|             return array_key_exists('downloadable', $config) ? $config['downloadable'] : false;
   913|         });
   914|         $items = $list->getThumbnails();
   915|         /** @var Asset\Image\Thumbnail\Config $item */
   916|         foreach ($items as $item) {
   917|             $thumbnails[] = [
   918|                 'id' => $item->getName(),
   919|                 'text' => $item->getName(),
   920|             ];
   921|         }
   922|         return $this->adminJson($thumbnails);
   923|     }
   924|     /**
   925|      * @Route("/thumbnail-add", name="pimcore_admin_settings_thumbnailadd", methods={"POST"})
   926|      *
   927|      * @param Request $request
   928|      *
   929|      * @return JsonResponse
   930|      */
   931|     public function thumbnailAddAction(Request $request)
   932|     {
   933|         $this->checkPermission('thumbnails');
   934|         $success = false;
   935|         $pipe = Asset\Image\Thumbnail\Config::getByName($request->get('name'));
   936|         if (!$pipe) {
   937|             $pipe = new Asset\Image\Thumbnail\Config();
   938|             $pipe->setName($request->get('name'));
   939|             $pipe->save();
   940|             $success = true;
   941|         }
   942|         return $this->adminJson(['success' => $success, 'id' => $pipe->getName()]);
   943|     }
   944|     /**
   945|      * @Route("/thumbnail-delete", name="pimcore_admin_settings_thumbnaildelete", methods={"DELETE"})
   946|      *
   947|      * @param Request $request
   948|      *
   949|      * @return JsonResponse
   950|      */
   951|     public function thumbnailDeleteAction(Request $request)
   952|     {
   953|         $this->checkPermission('thumbnails');
   954|         $pipe = Asset\Image\Thumbnail\Config::getByName($request->get('name'));
   955|         $pipe->delete();
   956|         return $this->adminJson(['success' => true]);
   957|     }
   958|     /**
   959|      * @Route("/thumbnail-get", name="pimcore_admin_settings_thumbnailget", methods={"GET"})
   960|      *
   961|      * @param Request $request
   962|      *
   963|      * @return JsonResponse
   964|      */
   965|     public function thumbnailGetAction(Request $request)
   966|     {
   967|         $this->checkPermission('thumbnails');
   968|         $pipe = Asset\Image\Thumbnail\Config::getByName($request->get('name'));
   969|         return $this->adminJson($pipe->getObjectVars());
   970|     }
   971|     /**
   972|      * @Route("/thumbnail-update", name="pimcore_admin_settings_thumbnailupdate", methods={"PUT"})
   973|      *
   974|      * @param Request $request
   975|      *
   976|      * @return JsonResponse
   977|      */
   978|     public function thumbnailUpdateAction(Request $request)
   979|     {
   980|         $this->checkPermission('thumbnails');
   981|         $pipe = Asset\Image\Thumbnail\Config::getByName($request->get('name'));
   982|         $settingsData = $this->decodeJson($request->get('settings'));
   983|         $mediaData = $this->decodeJson($request->get('medias'));
   984|         $mediaOrder = $this->decodeJson($request->get('mediaOrder'));
   985|         foreach ($settingsData as $key => $value) {
   986|             $setter = 'set' . ucfirst($key);
   987|             if (method_exists($pipe, $setter)) {
   988|                 $pipe->$setter($value);
   989|             }
   990|         }
   991|         $pipe->resetItems();
   992|         uksort($mediaData, function ($a, $b) use ($mediaOrder) {
   993|             if ($a === 'default') {
   994|                 return -1;
   995|             }
   996|             return ($mediaOrder[$a] < $mediaOrder[$b]) ? -1 : 1;
   997|         });
   998|         foreach ($mediaData as $mediaName => $items) {
   999|             foreach ($items as $item) {
  1000|                 $type = $item['type'];
  1001|                 unset($item['type']);
  1002|                 $pipe->addItem($type, $item, $mediaName);
  1003|             }
  1004|         }
  1005|         $pipe->save();
  1006|         return $this->adminJson(['success' => true]);
  1007|     }
  1008|     /**
  1009|      * @Route("/video-thumbnail-adapter-check", name="pimcore_admin_settings_videothumbnailadaptercheck", methods={"GET"})
  1010|      *
  1011|      * @param Request $request
  1012|      *
  1013|      * @return Response
  1014|      */
  1015|     public function videoThumbnailAdapterCheckAction(Request $request)
  1016|     {
  1017|         $content = '';
  1018|         if (!\Pimcore\Video::isAvailable()) {
  1019|             $content = '<span style="color: red; font-weight: bold;padding: 10px;margin:0 0 20px 0;border:1px solid red;display:block;">' .
  1020|                 $this->trans('php_cli_binary_and_or_ffmpeg_binary_setting_is_missing') .
  1021|                 '</span>';
  1022|         }
  1023|         return new Response($content);
  1024|     }
  1025|     /**
  1026|      * @Route("/video-thumbnail-tree", name="pimcore_admin_settings_videothumbnailtree", methods={"GET", "POST"})
  1027|      *
  1028|      * @param Request $request
  1029|      *
  1030|      * @return JsonResponse
  1031|      */
  1032|     public function videoThumbnailTreeAction(Request $request)
  1033|     {
  1034|         $this->checkPermission('thumbnails');
  1035|         $thumbnails = [];
  1036|         $list = new Asset\Video\Thumbnail\Config\Listing();
  1037|         $items = $list->getThumbnails();
  1038|         $groups = [];
  1039|         /** @var Asset\Image\Thumbnail\Config $item */
  1040|         foreach ($items as $item) {
  1041|             if ($item->getGroup()) {
  1042|                 if (!$groups[$item->getGroup()]) {
  1043|                     $groups[$item->getGroup()] = [
  1044|                         'id' => 'group_' . $item->getName(),
  1045|                         'text' => $item->getGroup(),
  1046|                         'expandable' => true,
  1047|                         'leaf' => false,
  1048|                         'allowChildren' => true,
  1049|                         'iconCls' => 'pimcore_icon_folder',
  1050|                         'group' => $item->getGroup(),
  1051|                         'children' => [],
  1052|                     ];
  1053|                 }
  1054|                 $groups[$item->getGroup()]['children'][] =
  1055|                     [
  1056|                         'id' => $item->getName(),
  1057|                         'text' => $item->getName(),
  1058|                         'leaf' => true,
  1059|                         'iconCls' => 'pimcore_icon_videothumbnails',
  1060|                     ];
  1061|             } else {
  1062|                 $thumbnails[] = [
  1063|                     'id' => $item->getName(),
  1064|                     'text' => $item->getName(),
  1065|                     'leaf' => true,
  1066|                     'iconCls' => 'pimcore_icon_videothumbnails',
  1067|                 ];
  1068|             }
  1069|         }
  1070|         foreach ($groups as $group) {
  1071|             $thumbnails[] = $group;
  1072|         }
  1073|         return $this->adminJson($thumbnails);
  1074|     }
  1075|     /**
  1076|      * @Route("/video-thumbnail-add", name="pimcore_admin_settings_videothumbnailadd", methods={"POST"})
  1077|      *
  1078|      * @param Request $request
  1079|      *
  1080|      * @return JsonResponse
  1081|      */
  1082|     public function videoThumbnailAddAction(Request $request)
  1083|     {
  1084|         $this->checkPermission('thumbnails');
  1085|         $success = false;
  1086|         $pipe = Asset\Video\Thumbnail\Config::getByName($request->get('name'));
  1087|         if (!$pipe) {
  1088|             $pipe = new Asset\Video\Thumbnail\Config();
  1089|             $pipe->setName($request->get('name'));
  1090|             $pipe->save();
  1091|             $success = true;
  1092|         }
  1093|         return $this->adminJson(['success' => $success, 'id' => $pipe->getName()]);
  1094|     }
  1095|     /**
  1096|      * @Route("/video-thumbnail-delete", name="pimcore_admin_settings_videothumbnaildelete", methods={"DELETE"})
  1097|      *
  1098|      * @param Request $request
  1099|      *
  1100|      * @return JsonResponse
  1101|      */
  1102|     public function videoThumbnailDeleteAction(Request $request)
  1103|     {
  1104|         $this->checkPermission('thumbnails');
  1105|         $pipe = Asset\Video\Thumbnail\Config::getByName($request->get('name'));
  1106|         $pipe->delete();
  1107|         return $this->adminJson(['success' => true]);
  1108|     }
  1109|     /**
  1110|      * @Route("/video-thumbnail-get", name="pimcore_admin_settings_videothumbnailget", methods={"GET"})
  1111|      *
  1112|      * @param Request $request
  1113|      *
  1114|      * @return JsonResponse
  1115|      */
  1116|     public function videoThumbnailGetAction(Request $request)
  1117|     {
  1118|         $this->checkPermission('thumbnails');
  1119|         $pipe = Asset\Video\Thumbnail\Config::getByName($request->get('name'));
  1120|         return $this->adminJson($pipe->getObjectVars());
  1121|     }
  1122|     /**
  1123|      * @Route("/video-thumbnail-update", name="pimcore_admin_settings_videothumbnailupdate", methods={"PUT"})
  1124|      *
  1125|      * @param Request $request
  1126|      *
  1127|      * @return JsonResponse
  1128|      */
  1129|     public function videoThumbnailUpdateAction(Request $request)
  1130|     {
  1131|         $this->checkPermission('thumbnails');
  1132|         $pipe = Asset\Video\Thumbnail\Config::getByName($request->get('name'));
  1133|         $settingsData = $this->decodeJson($request->get('settings'));
  1134|         $mediaData = $this->decodeJson($request->get('medias'));
  1135|         $mediaOrder = $this->decodeJson($request->get('mediaOrder'));
  1136|         foreach ($settingsData as $key => $value) {
  1137|             $setter = 'set' . ucfirst($key);
  1138|             if (method_exists($pipe, $setter)) {
  1139|                 $pipe->$setter($value);
  1140|             }
  1141|         }
  1142|         $pipe->resetItems();
  1143|         uksort($mediaData, function ($a, $b) use ($mediaOrder) {
  1144|             if ($a === 'default') {
  1145|                 return -1;
  1146|             }
  1147|             return ($mediaOrder[$a] < $mediaOrder[$b]) ? -1 : 1;
  1148|         });
  1149|         foreach ($mediaData as $mediaName => $items) {
  1150|             foreach ($items as $item) {
  1151|                 $type = $item['type'];
  1152|                 unset($item['type']);
  1153|                 $pipe->addItem($type, $item, $mediaName);
  1154|             }
  1155|         }
  1156|         $pipe->save();
  1157|         return $this->adminJson(['success' => true]);
  1158|     }
  1159|     /**
  1160|      * @Route("/robots-txt", name="pimcore_admin_settings_robotstxtget", methods={"GET"})
  1161|      *
  1162|      * @return JsonResponse
  1163|      */
  1164|     public function robotsTxtGetAction()
  1165|     {
  1166|         $this->checkPermission('robots.txt');
  1167|         $config = Config::getRobotsConfig();
  1168|         $config = $config->toArray();
  1169|         return $this->adminJson([
  1170|             'success' => true,
  1171|             'data' => $config,
  1172|             'onFileSystem' => file_exists(PIMCORE_WEB_ROOT . '/robots.txt'),
  1173|         ]);
  1174|     }
  1175|     /**
  1176|      * @Route("/robots-txt", name="pimcore_admin_settings_robotstxtput", methods={"PUT"})
  1177|      *
  1178|      * @param Request $request
  1179|      *
  1180|      * @return JsonResponse
  1181|      */
  1182|     public function robotsTxtPutAction(Request $request)
  1183|     {
  1184|         $this->checkPermission('robots.txt');
  1185|         $values = $request->get('data');
  1186|         if (!is_array($values)) {
  1187|             $values = [];
  1188|         }
  1189|         foreach ($values as $siteId => $robotsContent) {
  1190|             SettingsStore::set('robots.txt-' . $siteId, $robotsContent, 'string', 'robots.txt');
  1191|         }
  1192|         return $this->adminJson([
  1193|             'success' => true,
  1194|         ]);
  1195|     }
  1196|     /**
  1197|      * @Route("/website-settings", name="pimcore_admin_settings_websitesettings", methods={"POST"})
  1198|      *
  1199|      * @param Request $request
  1200|      *
  1201|      * @return JsonResponse
  1202|      *
  1203|      * @throws \Exception
  1204|      */
  1205|     public function websiteSettingsAction(Request $request)
  1206|     {
  1207|         $this->checkPermission('website_settings');
  1208|         if ($request->get('data')) {
  1209|             $data = $this->decodeJson($request->get('data'));
  1210|             if (is_array($data)) {
  1211|                 foreach ($data as &$value) {
  1212|                     $value = trim($value);
  1213|                 }
  1214|             }
  1215|             if ($request->get('xaction') == 'destroy') {
  1216|                 $id = $data['id'];
  1217|                 $setting = WebsiteSetting::getById($id);
  1218|                 if ($setting instanceof WebsiteSetting) {
  1219|                     $setting->delete();
  1220|                     return $this->adminJson(['success' => true, 'data' => []]);
  1221|                 }
  1222|             } elseif ($request->get('xaction') == 'update') {
  1223|                 $setting = WebsiteSetting::getById($data['id']);
  1224|                 if ($setting instanceof WebsiteSetting) {
  1225|                     switch ($setting->getType()) {
  1226|                         case 'document':
  1227|                         case 'asset':
  1228|                         case 'object':
  1229|                             if (isset($data['data'])) {
  1230|                                 $element = Element\Service::getElementByPath($setting->getType(), $data['data']);
  1231|                                 $data['data'] = $element;
  1232|                             }
  1233|                             break;
  1234|                     }
  1235|                     $setting->setValues($data);
  1236|                     $setting->save();
  1237|                     $data = $this->getWebsiteSettingForEditMode($setting);
  1238|                     return $this->adminJson(['data' => $data, 'success' => true]);
  1239|                 }
  1240|             } elseif ($request->get('xaction') == 'create') {
  1241|                 unset($data['id']);
  1242|                 $setting = new WebsiteSetting();
  1243|                 $setting->setValues($data);
  1244|                 $setting->save();
  1245|                 return $this->adminJson(['data' => $setting->getObjectVars(), 'success' => true]);
  1246|             }
  1247|         } else {
  1248|             $list = new WebsiteSetting\Listing();
  1249|             $list->setLimit($request->get('limit'));
  1250|             $list->setOffset($request->get('start'));
  1251|             $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(array_merge($request->request->all(), $request->query->all()));
  1252|             if ($sortingSettings['orderKey']) {
  1253|                 $list->setOrderKey($sortingSettings['orderKey']);
  1254|                 $list->setOrder($sortingSettings['order']);
  1255|             } else {
  1256|                 $list->setOrderKey('name');
  1257|                 $list->setOrder('asc');
  1258|             }
  1259|             if ($request->get('filter')) {
  1260|                 $list->setCondition('`name` LIKE ' . $list->quote('%'.$request->get('filter').'%'));
  1261|             }
  1262|             $totalCount = $list->getTotalCount();
  1263|             $list = $list->load();
  1264|             $settings = [];
  1265|             foreach ($list as $item) {
  1266|                 $resultItem = $this->getWebsiteSettingForEditMode($item);
  1267|                 $settings[] = $resultItem;
  1268|             }
  1269|             return $this->adminJson(['data' => $settings, 'success' => true, 'total' => $totalCount]);
  1270|         }
  1271|         return $this->adminJson(['success' => false]);
  1272|     }
  1273|     /**
  1274|      * @param WebsiteSetting $item
  1275|      *
  1276|      * @return array
  1277|      */
  1278|     private function getWebsiteSettingForEditMode($item)
  1279|     {
  1280|         $resultItem = [
  1281|             'id' => $item->getId(),
  1282|             'name' => $item->getName(),
  1283|             'language' => $item->getLanguage(),
  1284|             'type' => $item->getType(),
  1285|             'data' => null,
  1286|             'siteId' => $item->getSiteId(),
  1287|             'creationDate' => $item->getCreationDate(),
  1288|             'modificationDate' => $item->getModificationDate(),
  1289|         ];
  1290|         switch ($item->getType()) {
  1291|             case 'document':
  1292|             case 'asset':
  1293|             case 'object':
  1294|                 $element = $item->getData();
  1295|                 if ($element) {
  1296|                     $resultItem['data'] = $element->getRealFullPath();
  1297|                 }
  1298|                 break;
  1299|             default:
  1300|                 $resultItem['data'] = $item->getData();
  1301|                 break;
  1302|         }
  1303|         return $resultItem;
  1304|     }
  1305|     /**
  1306|      * @Route("/get-available-algorithms", name="pimcore_admin_settings_getavailablealgorithms", methods={"GET"})
  1307|      *
  1308|      * @param Request $request
  1309|      *
  1310|      * @return JsonResponse
  1311|      */
  1312|     public function getAvailableAlgorithmsAction(Request $request)
  1313|     {
  1314|         $options = [
  1315|             [
  1316|                 'key' => 'password_hash',
  1317|                 'value' => 'password_hash',
  1318|             ],
  1319|         ];
  1320|         $algorithms = hash_algos();
  1321|         foreach ($algorithms as $algorithm) {
  1322|             $options[] = [
  1323|                 'key' => $algorithm,
  1324|                 'value' => $algorithm,
  1325|             ];
  1326|         }
  1327|         $result = ['data' => $options, 'success' => true, 'total' => count($options)];
  1328|         return $this->adminJson($result);
  1329|     }
  1330|     /**
  1331|      * deleteViews
  1332|      * delete views for localized fields when languages are removed to
  1333|      * prevent mysql errors
  1334|      *
  1335|      * @param string $language
  1336|      * @param string $dbName
  1337|      */
  1338|     protected function deleteViews($language, $dbName)
  1339|     {
  1340|         $db = \Pimcore\Db::get();
  1341|         $views = $db->fetchAll('SHOW FULL TABLES IN ' . $db->quoteIdentifier($dbName) . " WHERE TABLE_TYPE LIKE 'VIEW'");
  1342|         foreach ($views as $view) {
  1343|             if (preg_match('/^object_localized_[0-9]+_' . $language . '$/', $view['Tables_in_' . $dbName])) {
  1344|                 $sql = 'DROP VIEW ' . $db->quoteIdentifier($view['Tables_in_' . $dbName]);
  1345|                 $db->query($sql);
  1346|             }
  1347|         }
  1348|     }
  1349|     /**
  1350|      * @Route("/test-web2print", name="pimcore_admin_settings_testweb2print", methods={"GET"})
  1351|      *
  1352|      * @param Request $request
  1353|      *
  1354|      * @return Response
  1355|      */
  1356|     public function testWeb2printAction(Request $request)
  1357|     {
  1358|         $this->checkPermission('web2print_settings');
  1359|         $response = $this->render('@PimcoreAdmin/Admin/Settings/testWeb2print.html.twig');
  1360|         $html = $response->getContent();
  1361|         $adapter = \Pimcore\Web2Print\Processor::getInstance();
  1362|         $params = [];
  1363|         if ($adapter instanceof \Pimcore\Web2Print\Processor\WkHtmlToPdf) {
  1364|             $params['adapterConfig'] = '-O landscape';
  1365|         } elseif ($adapter instanceof \Pimcore\Web2Print\Processor\PdfReactor) {
  1366|             $params['adapterConfig'] = [
  1367|                 'javaScriptMode' => 0,
  1368|                 'addLinks' => true,
  1369|                 'appendLog' => true,
  1370|                 'enableDebugMode' => true,
  1371|             ];
  1372|         }
  1373|         $responseOptions = [
  1374|             'Content-Type' => 'application/pdf',
  1375|         ];
  1376|         $pdfData = $adapter->getPdfFromString($html, $params);
  1377|         return new \Symfony\Component\HttpFoundation\Response(
  1378|             $pdfData,
  1379|             200,
  1380|             $responseOptions
  1381|         );
  1382|     }
  1383| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/TagsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-381 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Event\AdminEvents;
    17| use Pimcore\Model\Element\Tag;
    18| use Symfony\Component\EventDispatcher\GenericEvent;
    19| use Symfony\Component\HttpFoundation\JsonResponse;
    20| use Symfony\Component\HttpFoundation\Request;
    21| use Symfony\Component\Routing\Annotation\Route;
    22| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    23| /**
    24|  * @Route("/tags")
    25|  *
    26|  * @internal
    27|  */
    28| class TagsController extends AdminController
    29| {
    30|     /**
    31|      * @Route("/add", name="pimcore_admin_tags_add", methods={"POST"})
    32|      *
    33|      * @param Request $request
    34|      *
    35|      * @return JsonResponse
    36|      */
    37|     public function addAction(Request $request)
    38|     {
    39|         try {
    40|             $tag = new Tag();
    41|             $tag->setName(strip_tags($request->get('text')));
    42|             $tag->setParentId((int)$request->get('parentId'));
    43|             $tag->save();
    44|             return $this->adminJson(['success' => true, 'id' => $tag->getId()]);
    45|         } catch (\Exception $e) {
    46|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
    47|         }
    48|     }
    49|     /**
    50|      * @Route("/delete", name="pimcore_admin_tags_delete", methods={"DELETE"})
    51|      *
    52|      * @param Request $request
    53|      *
    54|      * @return JsonResponse
    55|      *
    56|      * @throws \Exception
    57|      */
    58|     public function deleteAction(Request $request)
    59|     {
    60|         $tag = Tag::getById($request->get('id'));
    61|         if ($tag) {
    62|             $tag->delete();
    63|             return $this->adminJson(['success' => true]);
    64|         } else {
    65|             throw new \Exception('Tag with ID ' . $request->get('id') . ' not found.');
    66|         }
    67|     }
    68|     /**
    69|      * @Route("/update", name="pimcore_admin_tags_update", methods={"PUT"})
    70|      *
    71|      * @param Request $request
    72|      *
    73|      * @return JsonResponse
    74|      *
    75|      * @throws \Exception
    76|      */
    77|     public function updateAction(Request $request)
    78|     {
    79|         $tag = Tag::getById($request->get('id'));
    80|         if ($tag) {
    81|             $parentId = $request->get('parentId');
    82|             if ($parentId || $parentId === '0') {
    83|                 $tag->setParentId((int)$parentId);
    84|             }
    85|             if ($request->get('text')) {
    86|                 $tag->setName(strip_tags($request->get('text')));
    87|             }
    88|             $tag->save();
    89|             return $this->adminJson(['success' => true]);
    90|         } else {
    91|             throw new \Exception('Tag with ID ' . $request->get('id') . ' not found.');
    92|         }
    93|     }
    94|     /**
    95|      * @Route("/tree-get-children-by-id", name="pimcore_admin_tags_treegetchildrenbyid", methods={"GET"})
    96|      *
    97|      * @param Request $request
    98|      *
    99|      * @return JsonResponse
   100|      */
   101|     public function treeGetChildrenByIdAction(Request $request)
   102|     {
   103|         $showSelection = $request->get('showSelection') == 'true';
   104|         $assignmentCId = (int)$request->get('assignmentCId');
   105|         $assignmentCType = strip_tags($request->get('assignmentCType'));
   106|         $recursiveChildren = false;
   107|         $assignedTagIds = [];
   108|         if ($assignmentCId && $assignmentCType) {
   109|             $assignedTags = Tag::getTagsForElement($assignmentCType, $assignmentCId);
   110|             foreach ($assignedTags as $assignedTag) {
   111|                 $assignedTagIds[$assignedTag->getId()] = $assignedTag;
   112|             }
   113|         }
   114|         $tagList = new Tag\Listing();
   115|         if ($request->get('node')) {
   116|             $tagList->setCondition('parentId = ?', (int)$request->get('node'));
   117|         } else {
   118|             $tagList->setCondition('ISNULL(parentId) OR parentId = 0');
   119|         }
   120|         $tagList->setOrderKey('name');
   121|         if (!empty($request->get('filter'))) {
   122|             $filterIds = [0];
   123|             $filterTagList = new Tag\Listing();
   124|             $filterTagList->setCondition('LOWER(`name`) LIKE ?', ['%' . $filterTagList->escapeLike(mb_strtolower($request->get('filter'))) . '%']);
   125|             foreach ($filterTagList->load() as $filterTag) {
   126|                 if ($filterTag->getParentId() === 0) {
   127|                     $filterIds[] = $filterTag->getId();
   128|                 } else {
   129|                     $ids = explode('/', $filterTag->getIdPath());
   130|                     if (isset($ids[1])) {
   131|                         $filterIds[] = (int)$ids[1];
   132|                     }
   133|                 }
   134|             }
   135|             $filterIds = array_unique(array_values($filterIds));
   136|             $tagList->setCondition('id IN('.implode(',', $filterIds).')');
   137|             $recursiveChildren = true;
   138|         }
   139|         $tags = [];
   140|         foreach ($tagList->load() as $tag) {
   141|             $tags[] = $this->convertTagToArray($tag, $showSelection, $assignedTagIds, true, $recursiveChildren);
   142|         }
   143|         return $this->adminJson($tags);
   144|     }
   145|     /**
   146|      * @param Tag $tag
   147|      * @param bool $showSelection
   148|      * @param array $assignedTagIds
   149|      * @param bool $loadChildren
   150|      * @param bool $recursiveChildren
   151|      *
   152|      * @return array
   153|      */
   154|     protected function convertTagToArray(Tag $tag, $showSelection, $assignedTagIds, $loadChildren = false, $recursiveChildren = false)
   155|     {
   156|         $tagArray = [
   157|             'id' => $tag->getId(),
   158|             'text' => $tag->getName(),
   159|             'path' => $tag->getNamePath(),
   160|             'expandable' => $tag->hasChildren(),
   161|             'leaf' => !$tag->hasChildren(),
   162|             'iconCls' => 'pimcore_icon_element_tags',
   163|             'qtipCfg' => [
   164|                 'title' => 'ID: ' . $tag->getId(),
   165|             ],
   166|         ];
   167|         if ($showSelection) {
   168|             $tagArray['checked'] = isset($assignedTagIds[$tag->getId()]);
   169|         }
   170|         if ($loadChildren) {
   171|             $children = $tag->getChildren();
   172|             $loadChildren = $recursiveChildren ?? false;
   173|             foreach ($children as $child) {
   174|                 $tagArray['children'][] = $this->convertTagToArray($child, $showSelection, $assignedTagIds, $loadChildren, $recursiveChildren);
   175|             }
   176|         }
   177|         return $tagArray;
   178|     }
   179|     /**
   180|      * @Route("/load-tags-for-element", name="pimcore_admin_tags_loadtagsforelement", methods={"GET"})
   181|      *
   182|      * @param Request $request
   183|      *
   184|      * @return JsonResponse
   185|      */
   186|     public function loadTagsForElementAction(Request $request)
   187|     {
   188|         $assginmentCId = (int)$request->get('assignmentCId');
   189|         $assginmentCType = strip_tags($request->get('assignmentCType'));
   190|         $assignedTagArray = [];
   191|         if ($assginmentCId && $assginmentCType) {
   192|             $assignedTags = Tag::getTagsForElement($assginmentCType, $assginmentCId);
   193|             foreach ($assignedTags as $assignedTag) {
   194|                 $assignedTagArray[] = $this->convertTagToArray($assignedTag, false, []);
   195|             }
   196|         }
   197|         return $this->adminJson($assignedTagArray);
   198|     }
   199|     /**
   200|      * @Route("/add-tag-to-element", name="pimcore_admin_tags_addtagtoelement", methods={"PUT"})
   201|      *
   202|      * @param Request $request
   203|      *
   204|      * @return JsonResponse
   205|      */
   206|     public function addTagToElementAction(Request $request)
   207|     {
   208|         $assginmentCId = (int)$request->get('assignmentElementId');
   209|         $assginmentCType = strip_tags($request->get('assignmentElementType'));
   210|         $tagId = (int)$request->get('tagId');
   211|         $tag = Tag::getById($tagId);
   212|         if ($tag) {
   213|             Tag::addTagToElement($assginmentCType, $assginmentCId, $tag);
   214|             return $this->adminJson(['success' => true, 'id' => $tag->getId()]);
   215|         } else {
   216|             return $this->adminJson(['success' => false]);
   217|         }
   218|     }
   219|     /**
   220|      * @Route("/remove-tag-from-element", name="pimcore_admin_tags_removetagfromelement", methods={"DELETE"})
   221|      *
   222|      * @param Request $request
   223|      *
   224|      * @return JsonResponse
   225|      */
   226|     public function removeTagFromElementAction(Request $request)
   227|     {
   228|         $assginmentCId = (int)$request->get('assignmentElementId');
   229|         $assginmentCType = strip_tags($request->get('assignmentElementType'));
   230|         $tagId = (int)$request->get('tagId');
   231|         $tag = Tag::getById($tagId);
   232|         if ($tag) {
   233|             Tag::removeTagFromElement($assginmentCType, $assginmentCId, $tag);
   234|             return $this->adminJson(['success' => true, 'id' => $tag->getId()]);
   235|         } else {
   236|             return $this->adminJson(['success' => false]);
   237|         }
   238|     }
   239|     /**
   240|      * @Route("/get-batch-assignment-jobs", name="pimcore_admin_tags_getbatchassignmentjobs", methods={"GET"})
   241|      *
   242|      * @param Request $request
   243|      * @param EventDispatcherInterface $eventDispatcher
   244|      *
   245|      * @return JsonResponse
   246|      */
   247|     public function getBatchAssignmentJobsAction(Request $request, EventDispatcherInterface $eventDispatcher)
   248|     {
   249|         $elementId = (int)$request->get('elementId');
   250|         $elementType = strip_tags($request->get('elementType'));
   251|         $idList = [];
   252|         switch ($elementType) {
   253|             case 'object':
   254|                 $object = \Pimcore\Model\DataObject::getById($elementId);
   255|                 if ($object) {
   256|                     $idList = $this->getSubObjectIds($object, $eventDispatcher);
   257|                 }
   258|                 break;
   259|             case 'asset':
   260|                 $asset = \Pimcore\Model\Asset::getById($elementId);
   261|                 if ($asset) {
   262|                     $idList = $this->getSubAssetIds($asset, $eventDispatcher);
   263|                 }
   264|                 break;
   265|             case 'document':
   266|                 $document = \Pimcore\Model\Document::getById($elementId);
   267|                 if ($document) {
   268|                     $idList = $this->getSubDocumentIds($document, $eventDispatcher);
   269|                 }
   270|                 break;
   271|         }
   272|         $size = 2;
   273|         $offset = 0;
   274|         $idListParts = [];
   275|         while ($offset < count($idList)) {
   276|             $idListParts[] = array_slice($idList, $offset, $size);
   277|             $offset += $size;
   278|         }
   279|         return $this->adminJson(['success' => true, 'idLists' => $idListParts, 'totalCount' => count($idList)]);
   280|     }
   281|     /**
   282|      * @param \Pimcore\Model\DataObject\AbstractObject $object
   283|      *
   284|      * @return int[]
   285|      */
   286|     private function getSubObjectIds(\Pimcore\Model\DataObject\AbstractObject $object, EventDispatcherInterface $eventDispatcher)
   287|     {
   288|         $childsList = new \Pimcore\Model\DataObject\Listing();
   289|         $condition = 'o_path LIKE ?';
   290|         if (!$this->getAdminUser()->isAdmin()) {
   291|             $userIds = $this->getAdminUser()->getRoles();
   292|             $userIds[] = $this->getAdminUser()->getId();
   293|             $condition .= ' AND (
   294|                 (SELECT `view` FROM users_workspaces_object WHERE userId IN (' . implode(',', $userIds) . ') and LOCATE(CONCAT(o_path,o_key),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   295|                     OR
   296|                 (SELECT `view` FROM users_workspaces_object WHERE userId IN (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(o_path,o_key))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   297|              )';
   298|         }
   299|         $childsList->setCondition($condition, $childsList->escapeLike($object->getRealFullPath()) . '/%');
   300|         $beforeListLoadEvent = new GenericEvent($this, [
   301|             'list' => $childsList,
   302|             'context' => [],
   303|         ]);
   304|         $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::OBJECT_LIST_BEFORE_LIST_LOAD);
   305|         /** @var \Pimcore\Model\DataObject\Listing $childsList */
   306|         $childsList = $beforeListLoadEvent->getArgument('list');
   307|         return $childsList->loadIdList();
   308|     }
   309|     /**
   310|      * @param \Pimcore\Model\Asset $asset
   311|      *
   312|      * @return int[]
   313|      */
   314|     private function getSubAssetIds(\Pimcore\Model\Asset $asset, EventDispatcherInterface $eventDispatcher)
   315|     {
   316|         $childsList = new \Pimcore\Model\Asset\Listing();
   317|         $condition = 'path LIKE ?';
   318|         if (!$this->getAdminUser()->isAdmin()) {
   319|             $userIds = $this->getAdminUser()->getRoles();
   320|             $userIds[] = $this->getAdminUser()->getId();
   321|             $condition .= ' AND (
   322|                 (SELECT `view` FROM users_workspaces_asset WHERE userId IN (' . implode(',', $userIds) . ') and LOCATE(CONCAT(path,filename),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   323|                     OR
   324|                 (SELECT `view` FROM users_workspaces_asset WHERE userId IN (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(path,filename))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   325|             )';
   326|         }
   327|         $childsList->setCondition($condition, $childsList->escapeLike($asset->getRealFullPath()) . '/%');
   328|         $beforeListLoadEvent = new GenericEvent($this, [
   329|             'list' => $childsList,
   330|             'context' => [],
   331|         ]);
   332|         $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::ASSET_LIST_BEFORE_LIST_LOAD);
   333|         /** @var \Pimcore\Model\Asset\Listing $childsList */
   334|         $childsList = $beforeListLoadEvent->getArgument('list');
   335|         return $childsList->loadIdList();
   336|     }
   337|     /**
   338|      * @param \Pimcore\Model\Document $document
   339|      *
   340|      * @return int[]
   341|      */
   342|     private function getSubDocumentIds(\Pimcore\Model\Document $document, EventDispatcherInterface $eventDispatcher)
   343|     {
   344|         $childsList = new \Pimcore\Model\Document\Listing();
   345|         $condition = 'path LIKE ?';
   346|         if (!$this->getAdminUser()->isAdmin()) {
   347|             $userIds = $this->getAdminUser()->getRoles();
   348|             $userIds[] = $this->getAdminUser()->getId();
   349|             $condition .= ' AND (
   350|                 (SELECT `view` FROM users_workspaces_document WHERE userId IN (' . implode(',', $userIds) . ') and LOCATE(CONCAT(path,`key`),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   351|                     OR
   352|                 (SELECT `view` FROM users_workspaces_document WHERE userId IN (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(path,`key`))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   353|             )';
   354|         }
   355|         $childsList->setCondition($condition, $childsList->escapeLike($document->getRealFullPath()) . '/%');
   356|         $beforeListLoadEvent = new GenericEvent($this, [
   357|             'list' => $childsList,
   358|             'context' => [],
   359|         ]);
   360|         $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::DOCUMENT_LIST_BEFORE_LIST_LOAD);
   361|         /** @var \Pimcore\Model\Document\Listing $childsList */
   362|         $childsList = $beforeListLoadEvent->getArgument('list');
   363|         return $childsList->loadIdList();
   364|     }
   365|     /**
   366|      * @Route("/do-batch-assignment", name="pimcore_admin_tags_dobatchassignment", methods={"PUT"})
   367|      *
   368|      * @param Request $request
   369|      *
   370|      * @return JsonResponse
   371|      */
   372|     public function doBatchAssignmentAction(Request $request)
   373|     {
   374|         $cType = strip_tags($request->get('elementType'));
   375|         $assignedTags = json_decode($request->get('assignedTags'));
   376|         $elementIds = json_decode($request->get('childrenIds'));
   377|         $doCleanupTags = $request->get('removeAndApply') == 'true';
   378|         Tag::batchAssignTagsToElement($cType, $elementIds, $assignedTags, $doCleanupTags);
   379|         return $this->adminJson(['success' => true]);
   380|     }
   381| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/TargetingController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-272 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Cache\Core\CoreCacheHandler;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Pimcore\Event\Model\TargetGroupEvent;
    19| use Pimcore\Event\TargetGroupEvents;
    20| use Pimcore\Model\Tool\Targeting;
    21| use Pimcore\Model\Tool\Targeting\TargetGroup;
    22| use Symfony\Component\HttpFoundation\JsonResponse;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    25| use Symfony\Component\Routing\Annotation\Route;
    26| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    27| /**
    28|  * @Route("/targeting")
    29|  *
    30|  * @internal
    31|  */
    32| class TargetingController extends AdminController implements KernelControllerEventInterface
    33| {
    34|     /**
    35|      * @Route("/rule/list", name="pimcore_admin_targeting_rulelist", methods={"GET"})
    36|      *
    37|      * @param Request $request
    38|      *
    39|      * @return JsonResponse
    40|      */
    41|     public function ruleListAction(Request $request)
    42|     {
    43|         $targets = [];
    44|         $list = new Targeting\Rule\Listing();
    45|         $list->setOrderKey('prio');
    46|         $list->setOrder('ASC');
    47|         foreach ($list->load() as $target) {
    48|             $targets[] = [
    49|                 'id' => $target->getId(),
    50|                 'text' => $target->getName(),
    51|                 'active' => $target->getActive(),
    52|                 'qtip' => 'ID: ' . $target->getId(),
    53|             ];
    54|         }
    55|         return $this->adminJson($targets);
    56|     }
    57|     /**
    58|      * @Route("/rule/add", name="pimcore_admin_targeting_ruleadd", methods={"POST"})
    59|      *
    60|      * @param Request $request
    61|      *
    62|      * @return JsonResponse
    63|      */
    64|     public function ruleAddAction(Request $request)
    65|     {
    66|         $target = new Targeting\Rule();
    67|         $target->setName($request->get('name'));
    68|         $target->save();
    69|         return $this->adminJson(['success' => true, 'id' => $target->getId()]);
    70|     }
    71|     /**
    72|      * @Route("/rule/delete", name="pimcore_admin_targeting_ruledelete", methods={"DELETE"})
    73|      *
    74|      * @param Request $request
    75|      *
    76|      * @return JsonResponse
    77|      */
    78|     public function ruleDeleteAction(Request $request)
    79|     {
    80|         $success = false;
    81|         $target = Targeting\Rule::getById($request->get('id'));
    82|         if ($target) {
    83|             $target->delete();
    84|             $success = true;
    85|         }
    86|         return $this->adminJson(['success' => $success]);
    87|     }
    88|     /**
    89|      * @Route("/rule/get", name="pimcore_admin_targeting_ruleget", methods={"GET"})
    90|      *
    91|      * @param Request $request
    92|      *
    93|      * @return JsonResponse
    94|      */
    95|     public function ruleGetAction(Request $request)
    96|     {
    97|         $target = Targeting\Rule::getById($request->get('id'));
    98|         $target = $target->getObjectVars();
    99|         return $this->adminJson($target);
   100|     }
   101|     /**
   102|      * @Route("/rule/save", name="pimcore_admin_targeting_rulesave", methods={"PUT"})
   103|      *
   104|      * @param Request $request
   105|      *
   106|      * @return JsonResponse
   107|      */
   108|     public function ruleSaveAction(Request $request)
   109|     {
   110|         $data = $this->decodeJson($request->get('data'));
   111|         /** @var Targeting\Rule|Targeting\Rule\Dao $target */
   112|         $target = Targeting\Rule::getById($request->get('id'));
   113|         $target->setValues($data['settings']);
   114|         $target->setConditions($data['conditions']);
   115|         $target->setActions($data['actions']);
   116|         $target->save();
   117|         return $this->adminJson(['success' => true]);
   118|     }
   119|     /**
   120|      * @Route("/rule/order", name="pimcore_admin_targeting_ruleorder", methods={"POST"})
   121|      *
   122|      * @param Request $request
   123|      *
   124|      * @return JsonResponse
   125|      */
   126|     public function ruleOrderAction(Request $request)
   127|     {
   128|         $return = [
   129|             'success' => false,
   130|             'message' => '',
   131|         ];
   132|         $rules = $this->decodeJson($request->get('rules'));
   133|         /** @var Targeting\Rule[] $changedRules */
   134|         $changedRules = [];
   135|         foreach ($rules as $id => $prio) {
   136|             $rule = Targeting\Rule::getById((int)$id);
   137|             $prio = (int)$prio;
   138|             if ($rule) {
   139|                 if ($rule->getPrio() !== $prio) {
   140|                     $rule->setPrio((int)$prio);
   141|                     $changedRules[] = $rule;
   142|                 }
   143|             } else {
   144|                 $return['message'] = sprintf('Rule %d was not found', (int)$id);
   145|                 return $this->adminJson($return, 400);
   146|             }
   147|         }
   148|         foreach ($changedRules as $changedRule) {
   149|             $changedRule->save();
   150|         }
   151|         $return['success'] = true;
   152|         return $this->adminJson($return);
   153|     }
   154|     /**
   155|      * @Route("/target-group/list", name="pimcore_admin_targeting_targetgrouplist", methods={"GET"})
   156|      *
   157|      * @param Request $request
   158|      *
   159|      * @return JsonResponse
   160|      */
   161|     public function targetGroupListAction(Request $request)
   162|     {
   163|         $targetGroups = [];
   164|         /** @var TargetGroup\Listing|TargetGroup\Listing\Dao $list */
   165|         $list = new TargetGroup\Listing();
   166|         if ($request->get('add-default')) {
   167|             $targetGroups[] = [
   168|                 'id' => 0,
   169|                 'text' => 'default',
   170|                 'active' => true,
   171|                 'qtip' => 0,
   172|             ];
   173|         }
   174|         foreach ($list->load() as $targetGroup) {
   175|             $targetGroups[] = [
   176|                 'id' => $targetGroup->getId(),
   177|                 'text' => $targetGroup->getName(),
   178|                 'active' => $targetGroup->getActive(),
   179|                 'qtip' => $targetGroup->getId(),
   180|             ];
   181|         }
   182|         return $this->adminJson($targetGroups);
   183|     }
   184|     /**
   185|      * @Route("/target-group/add", name="pimcore_admin_targeting_targetgroupadd", methods={"POST"})
   186|      *
   187|      * @param Request $request
   188|      * @param CoreCacheHandler $cache
   189|      * @param EventDispatcherInterface $eventDispatcher
   190|      *
   191|      * @return JsonResponse
   192|      */
   193|     public function targetGroupAddAction(Request $request, CoreCacheHandler $cache, EventDispatcherInterface $eventDispatcher)
   194|     {
   195|         /** @var TargetGroup|TargetGroup\Dao $targetGroup */
   196|         $targetGroup = new TargetGroup();
   197|         $targetGroup->setName($request->get('name'));
   198|         $targetGroup->save();
   199|         $event = new TargetGroupEvent($targetGroup);
   200|         $eventDispatcher->dispatch($event, TargetGroupEvents::POST_ADD);
   201|         $cache->clearTag('target_groups');
   202|         return $this->adminJson(['success' => true, 'id' => $targetGroup->getId()]);
   203|     }
   204|     /**
   205|      * @Route("/target-group/delete", name="pimcore_admin_targeting_targetgroupdelete", methods={"DELETE"})
   206|      *
   207|      * @param Request $request
   208|      * @param CoreCacheHandler $cache
   209|      * @param EventDispatcherInterface $eventDispatcher
   210|      *
   211|      * @return JsonResponse
   212|      */
   213|     public function targetGroupDeleteAction(Request $request, CoreCacheHandler $cache, EventDispatcherInterface $eventDispatcher)
   214|     {
   215|         $success = false;
   216|         $targetGroup = TargetGroup::getById($request->get('id'));
   217|         if ($targetGroup) {
   218|             $event = new TargetGroupEvent($targetGroup);
   219|             $targetGroup->delete();
   220|             $success = true;
   221|             $eventDispatcher->dispatch($event, TargetGroupEvents::POST_DELETE);
   222|         }
   223|         $cache->clearTag('target_groups');
   224|         return $this->adminJson(['success' => $success]);
   225|     }
   226|     /**
   227|      * @Route("/target-group/get", name="pimcore_admin_targeting_targetgroupget", methods={"GET"})
   228|      *
   229|      * @param Request $request
   230|      *
   231|      * @return JsonResponse
   232|      */
   233|     public function targetGroupGetAction(Request $request)
   234|     {
   235|         /** @var TargetGroup|TargetGroup\Dao $targetGroup */
   236|         $targetGroup = TargetGroup::getById($request->get('id'));
   237|         $targetGroup = $targetGroup->getObjectVars();
   238|         return $this->adminJson($targetGroup);
   239|     }
   240|     /**
   241|      * @Route("/target-group/save", name="pimcore_admin_targeting_targetgroupsave", methods={"PUT"})
   242|      *
   243|      * @param Request $request
   244|      * @param CoreCacheHandler $cache
   245|      * @param EventDispatcherInterface $eventDispatcher
   246|      *
   247|      * @return JsonResponse
   248|      */
   249|     public function targetGroupSaveAction(Request $request, CoreCacheHandler $cache, EventDispatcherInterface $eventDispatcher)
   250|     {
   251|         $data = $this->decodeJson($request->get('data'));
   252|         /** @var TargetGroup|TargetGroup\Dao $targetGroup */
   253|         $targetGroup = TargetGroup::getById($request->get('id'));
   254|         $targetGroup->setValues($data['settings']);
   255|         $targetGroup->save();
   256|         $event = new TargetGroupEvent($targetGroup);
   257|         $eventDispatcher->dispatch($event, TargetGroupEvents::POST_UPDATE);
   258|         $cache->clearTag('target_groups');
   259|         return $this->adminJson(['success' => true]);
   260|     }
   261|     /**
   262|      * @param ControllerEvent $event
   263|      */
   264|     public function onKernelControllerEvent(ControllerEvent $event)
   265|     {
   266|         $isMasterRequest = $event->isMasterRequest();
   267|         if (!$isMasterRequest) {
   268|             return;
   269|         }
   270|         $this->checkActionPermission($event, 'targeting', ['targetGroupListAction']);
   271|     }
   272| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/TranslationController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1036 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Doctrine\DBAL\Query\QueryBuilder as DoctrineQueryBuilder;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\File;
    18| use Pimcore\Localization\LocaleServiceInterface;
    19| use Pimcore\Logger;
    20| use Pimcore\Model\DataObject;
    21| use Pimcore\Model\Document;
    22| use Pimcore\Model\Element;
    23| use Pimcore\Model\Translation;
    24| use Pimcore\Tool;
    25| use Pimcore\Translation\ExportService\Exporter\ExporterInterface;
    26| use Pimcore\Translation\ExportService\ExportServiceInterface;
    27| use Pimcore\Translation\ImportDataExtractor\ImportDataExtractorInterface;
    28| use Pimcore\Translation\ImporterService\ImporterServiceInterface;
    29| use Pimcore\Translation\TranslationItemCollection\TranslationItemCollection;
    30| use Pimcore\Translation\Translator;
    31| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    32| use Symfony\Component\HttpFoundation\JsonResponse;
    33| use Symfony\Component\HttpFoundation\Request;
    34| use Symfony\Component\HttpFoundation\Response;
    35| use Symfony\Component\HttpFoundation\ResponseHeaderBag;
    36| use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
    37| use Symfony\Component\Routing\Annotation\Route;
    38| use Symfony\Contracts\Translation\TranslatorInterface;
    39| /**
    40|  * @Route("/translation")
    41|  *
    42|  * @internal
    43|  */
    44| class TranslationController extends AdminController
    45| {
    46|     /**
    47|      * @Route("/import", name="pimcore_admin_translation_import", methods={"POST"})
    48|      *
    49|      * @param Request $request
    50|      * @param LocaleServiceInterface $localeService
    51|      *
    52|      * @return JsonResponse
    53|      */
    54|     public function importAction(Request $request, LocaleServiceInterface $localeService)
    55|     {
    56|         $admin = $request->get('admin');
    57|         $dialect = $request->get('csvSettings', null);
    58|         $tmpFile = $request->get('importFile');
    59|         if ($dialect) {
    60|             $dialect = json_decode($dialect);
    61|         }
    62|         if (!empty($tmpFile)) {
    63|             $tmpFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . $tmpFile;
    64|         } else {
    65|             $tmpFile = $_FILES['Filedata']['tmp_name'];
    66|         }
    67|         $this->checkPermission(($admin ? 'admin_' : '') . 'translations');
    68|         $merge = $request->get('merge');
    69|         $overwrite = $merge ? false : true;
    70|         if ($admin) {
    71|             $delta = Translation::importTranslationsFromFile($tmpFile, Translation::DOMAIN_ADMIN, $overwrite, Tool\Admin::getLanguages(), $dialect);
    72|         } else {
    73|             $delta = Translation::importTranslationsFromFile(
    74|                 $tmpFile,
    75|                 Translation::DOMAIN_DEFAULT,
    76|                 $overwrite,
    77|                 $this->getAdminUser()->getAllowedLanguagesForEditingWebsiteTranslations(),
    78|                 $dialect
    79|             );
    80|         }
    81|         if (is_file($tmpFile)) {
    82|             @unlink($tmpFile);
    83|         }
    84|         $result = [
    85|             'success' => true,
    86|         ];
    87|         if ($merge) {
    88|             $enrichedDelta = [];
    89|             foreach ($delta as $item) {
    90|                 $lg = $item['lg'];
    91|                 $currentLocale = $localeService->findLocale();
    92|                 $item['lgname'] = \Locale::getDisplayLanguage($lg, $currentLocale);
    93|                 $item['icon'] = $this->generateUrl('pimcore_admin_misc_getlanguageflag', ['language' => $lg]);
    94|                 $item['current'] = $item['text'];
    95|                 $enrichedDelta[] = $item;
    96|             }
    97|             $result['delta'] = base64_encode(json_encode($enrichedDelta));
    98|         }
    99|         $response = $this->adminJson($result);
   100|         $response->headers->set('Content-Type', 'text/html');
   101|         return $response;
   102|     }
   103|     /**
   104|      * @Route("/upload-import", name="pimcore_admin_translation_uploadimportfile", methods={"POST"})
   105|      *
   106|      * @param Request $request
   107|      *
   108|      * @return JsonResponse
   109|      */
   110|     public function uploadImportFileAction(Request $request)
   111|     {
   112|         $tmpData = file_get_contents($_FILES['Filedata']['tmp_name']);
   113|         $filename = uniqid('import_translations-');
   114|         $importFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . $filename;
   115|         File::put($importFile, $tmpData);
   116|         $dialect = Tool\Admin::determineCsvDialect($importFile);
   117|         if (!empty($dialect->lineterminator) && empty(preg_match('/[a-f0-9]{2}/i', $dialect->lineterminator))) {
   118|             $dialect->lineterminator = bin2hex($dialect->lineterminator);
   119|         }
   120|         return $this->adminJson([
   121|             'success' => true,
   122|             'config' => [
   123|                 'tmpFile' => $filename,
   124|                 'csvSettings' => $dialect,
   125|             ],
   126|         ]);
   127|     }
   128|     /**
   129|      * @Route("/export", name="pimcore_admin_translation_export", methods={"GET"})
   130|      *
   131|      * @param Request $request
   132|      *
   133|      * @return Response
   134|      */
   135|     public function exportAction(Request $request)
   136|     {
   137|         $admin = $request->get('admin');
   138|         $this->checkPermission(($admin ? 'admin_' : '') . 'translations');
   139|         $domain = Translation::DOMAIN_DEFAULT;
   140|         if ($admin) {
   141|             $domain = Translation::DOMAIN_ADMIN;
   142|         }
   143|         $translation = new Translation();
   144|         $translation->setDomain($domain);
   145|         $tableName = $translation->getDao()->getDatabaseTableName();
   146|         Translation::clearDependentCache();
   147|         $list = new Translation\Listing();
   148|         $list->setDomain($domain);
   149|         $joins = [];
   150|         $list->setOrder('asc');
   151|         $list->setOrderKey($tableName . '.key', false);
   152|         $condition = $this->getGridFilterCondition($request, $tableName, false, $admin);
   153|         if ($condition) {
   154|             $list->setCondition($condition);
   155|         }
   156|         $filters = $this->getGridFilterCondition($request, $tableName, true, $admin);
   157|         if ($filters) {
   158|             $joins = array_merge($joins, $filters['joins']);
   159|         }
   160|         $this->extendTranslationQuery($joins, $list, $tableName, $filters);
   161|         $list->load();
   162|         $translations = [];
   163|         $translationObjects = $list->getTranslations();
   164|         if (empty($translationObjects)) {
   165|             if ($admin) {
   166|                 $t = new Translation();
   167|                 $t->setDomain(Translation::DOMAIN_ADMIN);
   168|                 $languages = Tool\Admin::getLanguages();
   169|             } else {
   170|                 $t = new Translation();
   171|                 $languages = $this->getAdminUser()->getAllowedLanguagesForViewingWebsiteTranslations();
   172|             }
   173|             foreach ($languages as $language) {
   174|                 $t->addTranslation($language, '');
   175|             }
   176|             $translationObjects[] = $t;
   177|         }
   178|         foreach ($translationObjects as $t) {
   179|             $translations[] = array_merge(
   180|                 ['key' => $t->getKey(),
   181|                     'creationDate' => $t->getCreationDate(),
   182|                     'modificationDate' => $t->getModificationDate(),
   183|                 ],
   184|                 $t->getTranslations()
   185|             );
   186|         }
   187|         $columns = array_keys($translations[0]);
   188|         if ($admin) {
   189|             $languages = Tool\Admin::getLanguages();
   190|         } else {
   191|             $languages = $this->getAdminUser()->getAllowedLanguagesForViewingWebsiteTranslations();
   192|         }
   193|         foreach ($languages as $l) {
   194|             if (!in_array($l, $columns)) {
   195|                 $columns[] = $l;
   196|             }
   197|         }
   198|         foreach ($columns as $key => $column) {
   199|             if (strtolower(trim($column)) != 'key' && !in_array($column, $languages)) {
   200|                 unset($columns[$key]);
   201|             }
   202|         }
   203|         $columns = array_values($columns);
   204|         $headerRow = [];
   205|         foreach ($columns as $key => $value) {
   206|             $headerRow[] = '"' . $value . '"';
   207|         }
   208|         $csv = implode(';', $headerRow) . "\r\n";
   209|         foreach ($translations as $t) {
   210|             $tempRow = [];
   211|             foreach ($columns as $key) {
   212|                 $value = $t[$key];
   213|                 if (is_string($value)) {
   214|                     $value = Tool\Text::removeLineBreaks($value);
   215|                     $value = str_replace('"', '&quot;', $value);
   216|                     $tempRow[$key] = '"' . $value . '"';
   217|                 } else {
   218|                     $tempRow[$key] = $value;
   219|                 }
   220|             }
   221|             $csv .= implode(';', $tempRow) . "\r\n";
   222|         }
   223|         $response = new Response("\xEF\xBB\xBF" . $csv);
   224|         $response->headers->set('Content-Encoding', 'UTF-8');
   225|         $response->headers->set('Content-Type', 'text/csv; charset=UTF-8');
   226|         $response->headers->set('Content-Disposition', 'attachment; filename="export_' . $domain . '_translations.csv"');
   227|         ini_set('display_errors', false); //to prevent warning messages in csv
   228|         return $response;
   229|     }
   230|     /**
   231|      * @Route("/add-admin-translation-keys", name="pimcore_admin_translation_addadmintranslationkeys", methods={"POST"})
   232|      *
   233|      * @param Request $request
   234|      *
   235|      * @return JsonResponse
   236|      */
   237|     public function addAdminTranslationKeysAction(Request $request)
   238|     {
   239|         $keys = $request->get('keys');
   240|         if ($keys) {
   241|             $availableLanguages = Tool\Admin::getLanguages();
   242|             $data = $this->decodeJson($keys);
   243|             foreach ($data as $translationData) {
   244|                 $t = null; // reset
   245|                 try {
   246|                     $t = Translation::getByKey($translationData, Translation::DOMAIN_ADMIN);
   247|                 } catch (\Exception $e) {
   248|                     Logger::log($e);
   249|                 }
   250|                 if (!$t instanceof Translation) {
   251|                     $t = new Translation();
   252|                     $t->setDomain(Translation::DOMAIN_ADMIN);
   253|                     $t->setKey($translationData);
   254|                     $t->setCreationDate(time());
   255|                     $t->setModificationDate(time());
   256|                     foreach ($availableLanguages as $lang) {
   257|                         $t->addTranslation($lang, '');
   258|                     }
   259|                     try {
   260|                         $t->save();
   261|                     } catch (\Exception $e) {
   262|                         Logger::log($e);
   263|                     }
   264|                 }
   265|             }
   266|         }
   267|         return $this->adminJson(null);
   268|     }
   269|     /**
   270|      * @Route("/translations", name="pimcore_admin_translation_translations", methods={"POST"})
   271|      *
   272|      * @param Request $request
   273|      * @param Translator $translator
   274|      *
   275|      * @return JsonResponse
   276|      */
   277|     public function translationsAction(Request $request, TranslatorInterface $translator)
   278|     {
   279|         $admin = $request->get('admin');
   280|         $this->checkPermission(($admin ? 'admin_' : '') . 'translations');
   281|         $domain = Translation::DOMAIN_DEFAULT;
   282|         if ($admin) {
   283|             $domain = Translation::DOMAIN_ADMIN;
   284|         }
   285|         $translation = new Translation();
   286|         $translation->setDomain($domain);
   287|         $tableName = $translation->getDao()->getDatabaseTableName();
   288|         Translation::clearDependentCache();
   289|         if ($request->get('data')) {
   290|             $data = $this->decodeJson($request->get('data'));
   291|             if ($request->get('xaction') == 'destroy') {
   292|                 $t = Translation::getByKey($data['key'], $domain);
   293|                 if ($t instanceof Translation) {
   294|                     $t->delete();
   295|                 }
   296|                 return $this->adminJson(['success' => true, 'data' => []]);
   297|             } elseif ($request->get('xaction') == 'update') {
   298|                 $t = Translation::getByKey($data['key'], $domain);
   299|                 foreach ($data as $key => $value) {
   300|                     $key = preg_replace('/^_/', '', $key, 1);
   301|                     if (!in_array($key, ['key', 'type'])) {
   302|                         $t->addTranslation($key, $value);
   303|                     }
   304|                 }
   305|                 if ($data['key']) {
   306|                     $t->setKey($data['key']);
   307|                 }
   308|                 if ($data['type']) {
   309|                     $t->setType($data['type']);
   310|                 }
   311|                 $t->setModificationDate(time());
   312|                 $t->save();
   313|                 $return = array_merge(
   314|                     [
   315|                         'key' => $t->getKey(),
   316|                         'creationDate' => $t->getCreationDate(),
   317|                         'modificationDate' => $t->getModificationDate(),
   318|                         'type' => $t->getType(),
   319|                     ],
   320|                     $this->prefixTranslations($t->getTranslations())
   321|                 );
   322|                 return $this->adminJson(['data' => $return, 'success' => true]);
   323|             } elseif ($request->get('xaction') == 'create') {
   324|                 $t = Translation::getByKey($data['key'], $domain);
   325|                 if ($t) {
   326|                     throw new \Exception($translator->trans('identifier_already_exists', [], $domain));
   327|                 }
   328|                 $t = new Translation();
   329|                 $t->setDomain($domain);
   330|                 $t->setKey($data['key']);
   331|                 $t->setCreationDate(time());
   332|                 $t->setModificationDate(time());
   333|                 $t->setType($data['type'] ?? null);
   334|                 foreach (Tool::getValidLanguages() as $lang) {
   335|                     $t->addTranslation($lang, '');
   336|                 }
   337|                 $t->save();
   338|                 $return = array_merge(
   339|                     [
   340|                         'key' => $t->getKey(),
   341|                         'creationDate' => $t->getCreationDate(),
   342|                         'modificationDate' => $t->getModificationDate(),
   343|                         'type' => $t->getType(),
   344|                     ],
   345|                     $this->prefixTranslations($t->getTranslations())
   346|                 );
   347|                 return $this->adminJson(['data' => $return, 'success' => true]);
   348|             }
   349|         } else {
   350|             $list = new Translation\Listing();
   351|             $list->setDomain($domain);
   352|             $validLanguages = $admin ? Tool\Admin::getLanguages() : $this->getAdminUser()->getAllowedLanguagesForViewingWebsiteTranslations();
   353|             $list->setOrder('asc');
   354|             $list->setOrderKey($tableName . '.key', false);
   355|             $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(
   356|                 array_merge($request->request->all(), $request->query->all())
   357|             );
   358|             $joins = [];
   359|             if ($orderKey = $sortingSettings['orderKey']) {
   360|                 if (in_array(trim($orderKey, '_'), $validLanguages)) {
   361|                     $orderKey = trim($orderKey, '_');
   362|                     $joins[] = [
   363|                         'language' => $orderKey,
   364|                     ];
   365|                     $list->setOrderKey($orderKey);
   366|                 } elseif ($list->isValidOrderKey($sortingSettings['orderKey'])) {
   367|                     $list->setOrderKey($tableName . '.' . $sortingSettings['orderKey'], false);
   368|                 }
   369|             }
   370|             if ($sortingSettings['order']) {
   371|                 $list->setOrder($sortingSettings['order']);
   372|             }
   373|             $list->setLimit($request->get('limit'));
   374|             $list->setOffset($request->get('start'));
   375|             $condition = $this->getGridFilterCondition($request, $tableName, false, $admin);
   376|             $filters = $this->getGridFilterCondition($request, $tableName, true, $admin);
   377|             if ($filters) {
   378|                 $joins = array_merge($joins, $filters['joins']);
   379|             }
   380|             if ($condition) {
   381|                 $list->setCondition($condition);
   382|             }
   383|             $this->extendTranslationQuery($joins, $list, $tableName, $filters);
   384|             $list->load();
   385|             $translations = [];
   386|             foreach ($list->getTranslations() as $t) {
   387|                 $translations[] = array_merge(
   388|                     $this->prefixTranslations($t->getTranslations()),
   389|                     [
   390|                         'key' => $t->getKey(),
   391|                         'creationDate' => $t->getCreationDate(),
   392|                         'modificationDate' => $t->getModificationDate(),
   393|                         'type' => $t->getType(),
   394|                     ]
   395|                 );
   396|             }
   397|             return $this->adminJson(['data' => $translations, 'success' => true, 'total' => $list->getTotalCount()]);
   398|         }
   399|         return $this->adminJson(['success' => false]);
   400|     }
   401|     /**
   402|      * @param array $translations
   403|      *
   404|      * @return array
   405|      */
   406|     protected function prefixTranslations($translations)
   407|     {
   408|         if (!is_array($translations)) {
   409|             return $translations;
   410|         }
   411|         $prefixedTranslations = [];
   412|         foreach ($translations as $lang => $trans) {
   413|             $prefixedTranslations['_' . $lang] = $trans;
   414|         }
   415|         return $prefixedTranslations;
   416|     }
   417|     /**
   418|      * @param array $joins
   419|      * @param Translation\Listing $list
   420|      * @param string $tableName
   421|      * @param array $filters
   422|      */
   423|     protected function extendTranslationQuery($joins, $list, $tableName, $filters)
   424|     {
   425|         if ($joins) {
   426|             $list->onCreateQueryBuilder(
   427|                 function (DoctrineQueryBuilder $select) use (
   428|                     $joins,
   429|                     $tableName,
   430|                     $filters
   431|                 ) {
   432|                     $db = \Pimcore\Db::get();
   433|                     $alreadyJoined = [];
   434|                     foreach ($joins as $join) {
   435|                         $fieldname = $join['language'];
   436|                         if (isset($alreadyJoined[$fieldname])) {
   437|                             continue;
   438|                         }
   439|                         $alreadyJoined[$fieldname] = 1;
   440|                         $select->addSelect($fieldname . '.text AS ' . $fieldname);
   441|                         $select->leftJoin(
   442|                             $tableName,
   443|                             $tableName,
   444|                             $fieldname,
   445|                             '('
   446|                             . $fieldname . '.key = ' . $tableName . '.key'
   447|                             . ' and ' . $fieldname . '.language = ' . $db->quote($fieldname)
   448|                             . ')'
   449|                         );
   450|                     }
   451|                     $havings = $filters['conditions'];
   452|                     if ($havings) {
   453|                         $havings = implode(' AND ', $havings);
   454|                         $select->having($havings);
   455|                     }
   456|                 }
   457|             );
   458|         }
   459|     }
   460|     /**
   461|      * @param Request $request
   462|      * @param string $tableName
   463|      * @param bool $languageMode
   464|      *
   465|      * @return array|null|string
   466|      */
   467|     protected function getGridFilterCondition(Request $request, $tableName, $languageMode = false, $admin = false)
   468|     {
   469|         $joins = [];
   470|         $conditions = [];
   471|         $validLanguages = $admin ? Tool\Admin::getLanguages() : $this->getAdminUser()->getAllowedLanguagesForViewingWebsiteTranslations();
   472|         $db = \Pimcore\Db::get();
   473|         $conditionFilters = [];
   474|         $filterJson = $request->get('filter');
   475|         if ($filterJson) {
   476|             $propertyField = 'property';
   477|             $operatorField = 'operator';
   478|             $filters = $this->decodeJson($filterJson);
   479|             foreach ($filters as $filter) {
   480|                 $operator = '=';
   481|                 $field = null;
   482|                 $value = null;
   483|                 $fieldname = $filter[$propertyField];
   484|                 if (in_array(ltrim($fieldname, '_'), $validLanguages)) {
   485|                     $fieldname = ltrim($fieldname, '_');
   486|                 }
   487|                 if (!$languageMode && in_array($fieldname, $validLanguages)
   488|                     || $languageMode && !in_array($fieldname, $validLanguages)) {
   489|                     continue;
   490|                 }
   491|                 if (!$languageMode) {
   492|                     $fieldname = $tableName . '.' . $fieldname;
   493|                 }
   494|                 if ($filter['type'] == 'string') {
   495|                     $operator = 'LIKE';
   496|                     $field = $fieldname;
   497|                     $value = '%' . $filter['value'] . '%';
   498|                 } elseif ($filter['type'] == 'date' ||
   499|                     (in_array($fieldname, ['modificationDate', 'creationDate']))) {
   500|                     if ($filter[$operatorField] == 'lt') {
   501|                         $operator = '<';
   502|                     } elseif ($filter[$operatorField] == 'gt') {
   503|                         $operator = '>';
   504|                     } elseif ($filter[$operatorField] == 'eq') {
   505|                         $operator = '=';
   506|                         $fieldname = "UNIX_TIMESTAMP(DATE(FROM_UNIXTIME({$fieldname})))";
   507|                     }
   508|                     $filter['value'] = strtotime($filter['value']);
   509|                     $field = $fieldname;
   510|                     $value = $filter['value'];
   511|                 }
   512|                 if ($field && $value) {
   513|                     $condition = $field . ' ' . $operator . ' ' . $db->quote($value);
   514|                     if ($languageMode) {
   515|                         $conditions[$fieldname] = $condition;
   516|                         $joins[] = [
   517|                             'language' => $fieldname,
   518|                         ];
   519|                     } else {
   520|                         $conditionFilters[] = $condition;
   521|                     }
   522|                 }
   523|             }
   524|         }
   525|         if ($request->get('searchString')) {
   526|             $filterTerm = $db->quote('%' . mb_strtolower($request->get('searchString')) . '%');
   527|             $conditionFilters[] = '(lower(' . $tableName . '.key) LIKE ' . $filterTerm . ' OR lower(' . $tableName . '.text) LIKE ' . $filterTerm . ')';
   528|         }
   529|         if ($languageMode) {
   530|             $result = [
   531|                 'joins' => $joins,
   532|                 'conditions' => $conditions,
   533|             ];
   534|             return $result;
   535|         } else {
   536|             if (!empty($conditionFilters)) {
   537|                 return implode(' AND ', $conditionFilters);
   538|             }
   539|             return null;
   540|         }
   541|     }
   542|     /**
   543|      * @Route("/cleanup", name="pimcore_admin_translation_cleanup", methods={"DELETE"})
   544|      *
   545|      * @param Request $request
   546|      *
   547|      * @return JsonResponse
   548|      */
   549|     public function cleanupAction(Request $request)
   550|     {
   551|         $admin = $request->get('admin');
   552|         $domain = Translation::DOMAIN_DEFAULT;
   553|         if ($admin) {
   554|             $domain = Translation::DOMAIN_ADMIN;
   555|         }
   556|         $list = new Translation\Listing();
   557|         $list->setDomain($domain);
   558|         $list->cleanup();
   559|         \Pimcore\Cache::clearTags(['translator', 'translate']);
   560|         return $this->adminJson(['success' => true]);
   561|     }
   562|     /**
   563|      * -----------------------------------------------------------------------------------
   564|      * THE FOLLOWING ISN'T RELATED TO THE SHARED TRANSLATIONS OR ADMIN-TRANSLATIONS
   565|      * XLIFF CONTENT-EXPORT & MS WORD CONTENT-EXPORT
   566|      * -----------------------------------------------------------------------------------
   567|      */
   568|     /**
   569|      * @Route("/content-export-jobs", name="pimcore_admin_translation_contentexportjobs", methods={"POST"})
   570|      *
   571|      * @param Request $request
   572|      *
   573|      * @return JsonResponse
   574|      */
   575|     public function contentExportJobsAction(Request $request)
   576|     {
   577|         $data = $this->decodeJson($request->get('data'));
   578|         $elements = [];
   579|         $jobs = [];
   580|         $exportId = uniqid();
   581|         $source = $request->get('source');
   582|         $target = $request->get('target');
   583|         $type = $request->get('type');
   584|         $source = str_replace('_', '-', $source);
   585|         $target = str_replace('_', '-', $target);
   586|         if ($data && is_array($data)) {
   587|             foreach ($data as $element) {
   588|                 $elements[$element['type'] . '_' . $element['id']] = [
   589|                     'id' => $element['id'],
   590|                     'type' => $element['type'],
   591|                 ];
   592|                 $el = null;
   593|                 if ($element['children']) {
   594|                     $el = Element\Service::getElementById($element['type'], $element['id']);
   595|                     $baseClass = ELement\Service::getBaseClassNameForElement($element['type']);
   596|                     $listClass = '\\Pimcore\\Model\\' . $baseClass . '\\Listing';
   597|                     $list = new $listClass();
   598|                     $list->setUnpublished(true);
   599|                     if ($el instanceof DataObject\AbstractObject) {
   600|                         $list->setObjectTypes(
   601|                             [DataObject::OBJECT_TYPE_VARIANT,
   602|                                 DataObject::OBJECT_TYPE_OBJECT,
   603|                                 DataObject::OBJECT_TYPE_FOLDER, ]
   604|                         );
   605|                     }
   606|                     $list->setCondition(
   607|                         ($el instanceof DataObject ? 'o_' : '') . 'path LIKE ?',
   608|                         [$list->escapeLike($el->getRealFullPath() . ($el->getRealFullPath() != '/' ? '/' : '')) . '%']
   609|                     );
   610|                     $childs = $list->load();
   611|                     foreach ($childs as $child) {
   612|                         $childId = $child->getId();
   613|                         $elements[$element['type'] . '_' . $childId] = [
   614|                             'id' => $childId,
   615|                             'type' => $element['type'],
   616|                         ];
   617|                         if (isset($element['relations']) && $element['relations']) {
   618|                             $childDependencies = $child->getDependencies()->getRequires();
   619|                             foreach ($childDependencies as $cd) {
   620|                                 if ($cd['type'] == 'object' || $cd['type'] == 'document') {
   621|                                     $elements[$cd['type'] . '_' . $cd['id']] = $cd;
   622|                                 }
   623|                             }
   624|                         }
   625|                     }
   626|                 }
   627|                 if (isset($element['relations']) && $element['relations']) {
   628|                     if (!$el instanceof Element\ElementInterface) {
   629|                         $el = Element\Service::getElementById($element['type'], $element['id']);
   630|                     }
   631|                     $dependencies = $el->getDependencies()->getRequires();
   632|                     foreach ($dependencies as $dependency) {
   633|                         if ($dependency['type'] == 'object' || $dependency['type'] == 'document') {
   634|                             $elements[$dependency['type'] . '_' . $dependency['id']] = $dependency;
   635|                         }
   636|                     }
   637|                 }
   638|             }
   639|         }
   640|         $elements = array_values($elements);
   641|         $elementsPerJob = 10;
   642|         if ($type == 'word') {
   643|             $elementsPerJob = 1;
   644|         }
   645|         $elements = array_chunk($elements, $elementsPerJob);
   646|         foreach ($elements as $chunk) {
   647|             $jobs[] = [[
   648|                 'url' => $request->getBaseUrl() . '/admin/translation/' . $type . '-export',
   649|                 'method' => 'POST',
   650|                 'params' => [
   651|                     'id' => $exportId,
   652|                     'source' => $source,
   653|                     'target' => $target,
   654|                     'data' => $this->encodeJson($chunk),
   655|                 ],
   656|             ]];
   657|         }
   658|         return $this->adminJson(
   659|             [
   660|                 'success' => true,
   661|                 'jobs' => $jobs,
   662|                 'id' => $exportId,
   663|             ]
   664|         );
   665|     }
   666|     /**
   667|      * @Route("/xliff-export", name="pimcore_admin_translation_xliffexport", methods={"POST"})
   668|      *
   669|      * @param Request $request
   670|      * @param ExportServiceInterface $exportService
   671|      *
   672|      * @return JsonResponse
   673|      *
   674|      * @throws \Exception
   675|      */
   676|     public function xliffExportAction(Request $request, ExportServiceInterface $exportService)
   677|     {
   678|         $id = $request->get('id');
   679|         $data = $this->decodeJson($request->get('data'));
   680|         $source = $request->get('source');
   681|         $target = $request->get('target');
   682|         $translationItems = new TranslationItemCollection();
   683|         foreach ($data as $el) {
   684|             $element = Element\Service::getElementById($el['type'], $el['id']);
   685|             $translationItems->addPimcoreElement($element);
   686|         }
   687|         $exportService->exportTranslationItems($translationItems, $source, [$target], $id);
   688|         return $this->adminJson([
   689|             'success' => true,
   690|         ]);
   691|     }
   692|     /**
   693|      * @Route("/xliff-export-download", name="pimcore_admin_translation_xliffexportdownload", methods={"GET"})
   694|      *
   695|      * @param Request $request
   696|      * @param ExporterInterface $translationExporter
   697|      *
   698|      * @return BinaryFileResponse
   699|      */
   700|     public function xliffExportDownloadAction(Request $request, ExporterInterface $translationExporter, ExportServiceInterface $exportService)
   701|     {
   702|         $id = $request->get('id');
   703|         $exportFile = $exportService->getTranslationExporter()->getExportFilePath($id);
   704|         $response = new BinaryFileResponse($exportFile);
   705|         $response->headers->set('Content-Type', $translationExporter->getContentType());
   706|         $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, basename($exportFile));
   707|         $response->deleteFileAfterSend(true);
   708|         return $response;
   709|     }
   710|     /**
   711|      * @Route("/xliff-import-upload", name="pimcore_admin_translation_xliffimportupload", methods={"POST"})
   712|      *
   713|      * @param Request $request
   714|      * @param ImportDataExtractorInterface $importDataExtractor
   715|      *
   716|      * @return JsonResponse
   717|      *
   718|      * @throws \Exception
   719|      */
   720|     public function xliffImportUploadAction(Request $request, ImportDataExtractorInterface $importDataExtractor)
   721|     {
   722|         $jobs = [];
   723|         $id = uniqid();
   724|         $importFile = $importDataExtractor->getImportFilePath($id);
   725|         copy($_FILES['file']['tmp_name'], $importFile);
   726|         $steps = $importDataExtractor->countSteps($id);
   727|         for ($i = 0; $i < $steps; $i++) {
   728|             $jobs[] = [[
   729|                 'url' => $this->generateUrl('pimcore_admin_translation_xliffimportelement'),
   730|                 'method' => 'POST',
   731|                 'params' => [
   732|                     'id' => $id,
   733|                     'step' => $i,
   734|                 ],
   735|             ]];
   736|         }
   737|         $response = $this->adminJson([
   738|             'success' => true,
   739|             'jobs' => $jobs,
   740|             'id' => $id,
   741|         ]);
   742|         $response->headers->set('Content-Type', 'text/html');
   743|         return $response;
   744|     }
   745|     /**
   746|      * @Route("/xliff-import-element", name="pimcore_admin_translation_xliffimportelement", methods={"POST"})
   747|      *
   748|      * @param Request $request
   749|      * @param ImportDataExtractorInterface $importDataExtractor
   750|      * @param ImporterServiceInterface $importerService
   751|      *
   752|      * @return JsonResponse
   753|      *
   754|      * @throws \Exception
   755|      */
   756|     public function xliffImportElementAction(Request $request, ImportDataExtractorInterface $importDataExtractor, ImporterServiceInterface $importerService)
   757|     {
   758|         $id = $request->get('id');
   759|         $step = $request->get('step');
   760|         try {
   761|             $attributeSet = $importDataExtractor->extractElement($id, $step);
   762|             if ($attributeSet) {
   763|                 $importerService->import($attributeSet);
   764|             } else {
   765|                 Logger::warning(sprintf('Could not resolve element %s', $id));
   766|             }
   767|         } catch (\Exception $e) {
   768|             Logger::err($e->getMessage());
   769|             return $this->adminJson([
   770|                 'success' => false,
   771|                 'message' => $e->getMessage(),
   772|             ]);
   773|         }
   774|         return $this->adminJson([
   775|             'success' => true,
   776|         ]);
   777|     }
   778|     /**
   779|      * @Route("/word-export", name="pimcore_admin_translation_wordexport", methods={"POST"})
   780|      *
   781|      * @param Request $request
   782|      *
   783|      * @return JsonResponse
   784|      */
   785|     public function wordExportAction(Request $request)
   786|     {
   787|         ini_set('display_errors', 'off');
   788|         $id = $this->sanitzeExportId((string)$request->get('id'));
   789|         $exportFile = $this->getExportFilePath($id, false);
   790|         $data = $this->decodeJson($request->get('data'));
   791|         $source = $request->get('source');
   792|         if (!is_file($exportFile)) {
   793|             File::put($exportFile, '');
   794|         }
   795|         foreach ($data as $el) {
   796|             try {
   797|                 $element = Element\Service::getElementById($el['type'], $el['id']);
   798|                 $output = '';
   799|                 if (!in_array($element->getType(), ['page', 'snippet', 'email', 'object'])) {
   800|                     continue;
   801|                 }
   802|                 if ($element instanceof Element\ElementInterface) {
   803|                     $output .= '<h1 class="element-headline">' . ucfirst(
   804|                             $element->getType()
   805|                         ) . ' - ' . $element->getRealFullPath() . ' (ID: ' . $element->getId() . ')</h1>';
   806|                 }
   807|                 if ($element instanceof Document\PageSnippet) {
   808|                     if ($element instanceof Document\Page) {
   809|                         $structuredDataEmpty = true;
   810|                         $structuredData = '
   811|                             <table border="1" cellspacing="0" cellpadding="5">
   812|                                 <tr>
   813|                                     <td colspan="2"><span style="color:#cc2929;font-weight: bold;">Structured Data</span></td>
   814|                                 </tr>
   815|                         ';
   816|                         if ($element->getTitle()) {
   817|                             $structuredData .= '<tr>
   818|                                     <td><span style="color:#cc2929;">Title</span></td>
   819|                                     <td>' . $element->getTitle() . '&nbsp;</td>
   820|                                 </tr>';
   821|                             $structuredDataEmpty = false;
   822|                         }
   823|                         if ($element->getDescription()) {
   824|                             $structuredData .= '<tr>
   825|                                     <td><span style="color:#cc2929;">Description</span></td>
   826|                                     <td>' . $element->getDescription() . '&nbsp;</td>
   827|                                 </tr>';
   828|                             $structuredDataEmpty = false;
   829|                         }
   830|                         if ($element->getProperty('navigation_name')) {
   831|                             $structuredData .= '<tr>
   832|                                     <td><span style="color:#cc2929;">Navigation</span></td>
   833|                                     <td>' . $element->getProperty('navigation_name') . '&nbsp;</td>
   834|                                 </tr>';
   835|                             $structuredDataEmpty = false;
   836|                         }
   837|                         $structuredData .= '</table>';
   838|                         if (!$structuredDataEmpty) {
   839|                             $output .= $structuredData;
   840|                         }
   841|                     }
   842|                     $html = Document\Service::render($element, [], false, ['pimcore_admin' => true]);
   843|                     $html = preg_replace(
   844|                         '@</?(img|meta|div|section|aside|article|body|bdi|bdo|canvas|embed|footer|head|header|html)([^>]+)?>@',
   845|                         '',
   846|                         $html
   847|                     );
   848|                     $html = preg_replace('/<!--(.*)-->/Uis', '', $html);
   849|                     $dom = new Tool\DomCrawler($html);
   850|                     $elements = $dom->filter('form, script, style, noframes, noscript, object, area, mapm, video, audio, iframe, textarea, input, select, button');
   851|                     foreach ($elements as $element) {
   852|                         $element->parentNode->removeChild($element);
   853|                     }
   854|                     $clearText = function ($string) {
   855|                         $string = str_replace("\r\n", '', $string);
   856|                         $string = str_replace("\n", '', $string);
   857|                         $string = str_replace("\r", '', $string);
   858|                         $string = str_replace("\t", '', $string);
   859|                         $string = preg_replace('/&[a-zA-Z0-9]+;/', '', $string); // remove html entities
   860|                         $string = preg_replace('#[ ]+#', '', $string);
   861|                         return $string;
   862|                     };
   863|                     $elements = $dom->filter('a');
   864|                     foreach ($elements as $element) {
   865|                         $string = $clearText($element->textContent);
   866|                         if (!empty($string)) {
   867|                             $newNode = $element->ownerDocument->createTextNode('[' . $element->textContent . ']');
   868|                             $element->parentNode->replaceChild($newNode, $element);
   869|                         } else {
   870|                             $element->ownerDocument->textContent = '';
   871|                         }
   872|                     }
   873|                     if ($dom->count() > 0) {
   874|                         $html = $dom->html();
   875|                     }
   876|                     $dom->clear();
   877|                     unset($dom);
   878|                     $doc = new \DOMDocument();
   879|                     libxml_use_internal_errors(true);
   880|                     $doc->loadHTML('<?xml encoding="UTF-8"><article>' . $html . '</article>');
   881|                     libxml_clear_errors();
   882|                     $html = $doc->saveHTML();
   883|                     $bodyStart = strpos($html, '<body>') + 6;
   884|                     $bodyEnd = strpos($html, '</body>');
   885|                     if ($bodyStart && $bodyEnd) {
   886|                         $html = substr($html, $bodyStart, $bodyEnd - $bodyStart);
   887|                     }
   888|                     $output .= $html;
   889|                 } elseif ($element instanceof DataObject\Concrete) {
   890|                     $hasContent = false;
   891|                     /** @var DataObject\ClassDefinition\Data\Localizedfields|null $fd */
   892|                     $fd = $element->getClass()->getFieldDefinition('localizedfields');
   893|                     if ($fd) {
   894|                         $definitions = $fd->getFieldDefinitions();
   895|                         $locale = str_replace('-', '_', $source);
   896|                         if (!Tool::isValidLanguage($locale)) {
   897|                             $locale = \Locale::getPrimaryLanguage($locale);
   898|                         }
   899|                         $output .= '
   900|                             <table border="1" cellspacing="0" cellpadding="2">
   901|                                 <tr>
   902|                                     <td colspan="2"><span style="color:#cc2929;font-weight: bold;">Localized Data</span></td>
   903|                                 </tr>
   904|                         ';
   905|                         foreach ($definitions as $definition) {
   906|                             if (!in_array($definition->getFieldtype(), ['input', 'textarea', 'wysiwyg'])) {
   907|                                 continue;
   908|                             }
   909|                             $content = $element->{'get' . ucfirst($definition->getName())}($locale);
   910|                             if (!empty($content)) {
   911|                                 $output .= '
   912|                                 <tr>
   913|                                     <td><span style="color:#cc2929;">' . $definition->getTitle() . ' (' . $definition->getName() . ')<span></td>
   914|                                     <td>' . $content . '&nbsp;</td>
   915|                                 </tr>
   916|                                 ';
   917|                                 $hasContent = true;
   918|                             }
   919|                         }
   920|                         $output .= '</table>';
   921|                     }
   922|                     if (!$hasContent) {
   923|                         $output = ''; // there's no content in the object, so reset all contents and do not inclide it in the export
   924|                     }
   925|                 }
   926|                 if (!empty($output)) {
   927|                     $f = fopen($exportFile, 'a+');
   928|                     fwrite($f, $output);
   929|                     fclose($f);
   930|                 }
   931|             } catch (\Exception $e) {
   932|                 Logger::error('Word Export: ' . $e->getMessage());
   933|                 Logger::error($e);
   934|                 throw $e;
   935|             }
   936|         }
   937|         return $this->adminJson(
   938|             [
   939|                 'success' => true,
   940|             ]
   941|         );
   942|     }
   943|     /**
   944|      * @Route("/word-export-download", name="pimcore_admin_translation_wordexportdownload", methods={"GET"})
   945|      *
   946|      * @param Request $request
   947|      *
   948|      * @return Response
   949|      */
   950|     public function wordExportDownloadAction(Request $request)
   951|     {
   952|         $id = $this->sanitzeExportId((string)$request->get('id'));
   953|         $exportFile = $this->getExportFilePath($id, true);
   954|         $content = file_get_contents($exportFile);
   955|         @unlink($exportFile);
   956|         $content = preg_replace('/<link[^>]+>/im', '$1', $content);
   957|         $content = preg_replace("/<script[^>]+>(.*)?<\/script>/im", '$1', $content);
   958|         $content =
   959|             "<html>\n" .
   960|             "<head>\n" .
   961|             '<style type="text/css">' . "\n" .
   962|             file_get_contents(PIMCORE_WEB_ROOT . '/bundles/pimcoreadmin/css/word-export.css') .
   963|             "</style>\n" .
   964|             "</head>\n\n" .
   965|             "<body>\n" .
   966|             $content .
   967|             "\n\n</body>\n" .
   968|             "</html>\n";
   969|         $response = new Response($content);
   970|         $response->headers->set('Content-Type', 'text/html');
   971|         $response->headers->set(
   972|             'Content-Disposition',
   973|             'attachment; filename="word-export-' . date('Ymd') . '_' . uniqid() . '.htm"'
   974|         );
   975|         return $response;
   976|     }
   977|     private function sanitzeExportId(string $id): string
   978|     {
   979|         if (empty($id) || !preg_match('/^[a-z0-9]+$/', $id)) {
   980|             throw new BadRequestHttpException('Invalid export ID format');
   981|         }
   982|         return $id;
   983|     }
   984|     private function getExportFilePath(string $id, bool $checkExistence = true): string
   985|     {
   986|         $exportFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . DIRECTORY_SEPARATOR . $id . '.html';
   987|         if ($checkExistence && !file_exists($exportFile)) {
   988|             throw $this->createNotFoundException(sprintf('Export file does not exist at path %s', $exportFile));
   989|         }
   990|         return $exportFile;
   991|     }
   992|     /**
   993|      * @Route("/merge-item", name="pimcore_admin_translation_mergeitem", methods={"PUT"})
   994|      *
   995|      * @param Request $request
   996|      *
   997|      * @return JsonResponse
   998|      */
   999|     public function mergeItemAction(Request $request)
  1000|     {
  1001|         $translationType = $request->get('translationType');
  1002|         $dataList = json_decode($request->get('data'), true);
  1003|         $domain = Translation::DOMAIN_DEFAULT;
  1004|         if ($translationType == 'admin') {
  1005|             $domain = Translation::DOMAIN_ADMIN;
  1006|         }
  1007|         foreach ($dataList as $data) {
  1008|             $t = Translation::getByKey($data['key'], $domain, true);
  1009|             $newValue = htmlspecialchars_decode($data['current']);
  1010|             $t->addTranslation($data['lg'], $newValue);
  1011|             $t->setModificationDate(time());
  1012|             $t->save();
  1013|         }
  1014|         return $this->adminJson(
  1015|             [
  1016|                 'success' => true,
  1017|             ]
  1018|         );
  1019|     }
  1020|     /**
  1021|      * @Route("/get-website-translation-languages", name="pimcore_admin_translation_getwebsitetranslationlanguages", methods={"GET"})
  1022|      *
  1023|      * @param Request $request
  1024|      *
  1025|      * @return JsonResponse
  1026|      */
  1027|     public function getWebsiteTranslationLanguagesAction(Request $request)
  1028|     {
  1029|         return $this->adminJson(
  1030|             [
  1031|                 'view' => $this->getAdminUser()->getAllowedLanguagesForViewingWebsiteTranslations(),
  1032|                 'edit' => $this->getAdminUser()->getAllowedLanguagesForEditingWebsiteTranslations(),
  1033|             ]
  1034|         );
  1035|     }
  1036| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/UserController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1036 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    17| use Pimcore\Config;
    18| use Pimcore\Controller\KernelControllerEventInterface;
    19| use Pimcore\Logger;
    20| use Pimcore\Model\DataObject;
    21| use Pimcore\Model\Element;
    22| use Pimcore\Model\User;
    23| use Pimcore\Tool;
    24| use Scheb\TwoFactorBundle\Security\TwoFactor\Provider\Google\GoogleAuthenticatorInterface;
    25| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    26| use Symfony\Component\HttpFoundation\Request;
    27| use Symfony\Component\HttpFoundation\Response;
    28| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    29| use Symfony\Component\HttpFoundation\StreamedResponse;
    30| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    31| use Symfony\Component\Routing\Annotation\Route;
    32| use Symfony\Component\Routing\Generator\UrlGeneratorInterface;
    33| /**
    34|  * @internal
    35|  */
    36| class UserController extends AdminController implements KernelControllerEventInterface
    37| {
    38|     /**
    39|      * @Route("/user/tree-get-childs-by-id", name="pimcore_admin_user_treegetchildsbyid", methods={"GET"})
    40|      *
    41|      * @param Request $request
    42|      *
    43|      * @return JsonResponse
    44|      */
    45|     public function treeGetChildsByIdAction(Request $request)
    46|     {
    47|         $list = new User\Listing();
    48|         $list->setCondition('parentId = ?', (int)$request->get('node'));
    49|         $list->setOrder('ASC');
    50|         $list->setOrderKey('name');
    51|         $list->load();
    52|         $users = [];
    53|         if (is_array($list->getUsers())) {
    54|             foreach ($list->getUsers() as $user) {
    55|                 if ($user->getId() && $user->getName() != 'system') {
    56|                     $users[] = $this->getTreeNodeConfig($user);
    57|                 }
    58|             }
    59|         }
    60|         return $this->adminJson($users);
    61|     }
    62|     /**
    63|      * @param User|User\Folder $user
    64|      *
    65|      * @return array
    66|      */
    67|     protected function getTreeNodeConfig($user)
    68|     {
    69|         $tmpUser = [
    70|             'id' => $user->getId(),
    71|             'text' => $user->getName(),
    72|             'elementType' => 'user',
    73|             'type' => $user->getType(),
    74|             'qtipCfg' => [
    75|                 'title' => 'ID: ' . $user->getId(),
    76|             ],
    77|         ];
    78|         if ($user instanceof User\Folder) {
    79|             $tmpUser['leaf'] = false;
    80|             $tmpUser['iconCls'] = 'pimcore_icon_folder';
    81|             $tmpUser['expanded'] = true;
    82|             $tmpUser['allowChildren'] = true;
    83|             if ($user->hasChildren()) {
    84|                 $tmpUser['expanded'] = false;
    85|             } else {
    86|                 $tmpUser['loaded'] = true;
    87|             }
    88|         } else {
    89|             $tmpUser['leaf'] = true;
    90|             $tmpUser['iconCls'] = 'pimcore_icon_user';
    91|             if (!$user->getActive()) {
    92|                 $tmpUser['cls'] = ' pimcore_unpublished';
    93|             }
    94|             $tmpUser['allowChildren'] = false;
    95|             $tmpUser['admin'] = $user->isAdmin();
    96|         }
    97|         return $tmpUser;
    98|     }
    99|     /**
   100|      * @Route("/user/add", name="pimcore_admin_user_add", methods={"POST"})
   101|      *
   102|      * @param Request $request
   103|      *
   104|      * @return JsonResponse
   105|      */
   106|     public function addAction(Request $request)
   107|     {
   108|         try {
   109|             $type = $request->get('type');
   110|             $className = User\Service::getClassNameForType($type);
   111|             $user = $className::create([
   112|                 'parentId' => (int)$request->get('parentId'),
   113|                 'name' => trim($request->get('name')),
   114|                 'password' => '',
   115|                 'active' => $request->get('active'),
   116|             ]);
   117|             if ($request->get('rid')) {
   118|                 $rid = $request->get('rid');
   119|                 $rObject = $className::getById($rid);
   120|                 if ($rObject) {
   121|                     if ($type == 'user' || $type == 'role') {
   122|                         $user->setParentId($rObject->getParentId());
   123|                         if ($rObject->getClasses()) {
   124|                             $user->setClasses(implode(',', $rObject->getClasses()));
   125|                         }
   126|                         if ($rObject->getDocTypes()) {
   127|                             $user->setDocTypes(implode(',', $rObject->getDocTypes()));
   128|                         }
   129|                         $keys = ['asset', 'document', 'object'];
   130|                         foreach ($keys as $key) {
   131|                             $getter = 'getWorkspaces' . ucfirst($key);
   132|                             $setter = 'setWorkspaces' . ucfirst($key);
   133|                             $workspaces = $rObject->$getter();
   134|                             $clonedWorkspaces = [];
   135|                             if (is_array($workspaces)) {
   136|                                 /** @var User\Workspace\AbstractWorkspace $workspace */
   137|                                 foreach ($workspaces as $workspace) {
   138|                                     $vars = $workspace->getObjectVars();
   139|                                     if ($key == 'object') {
   140|                                         $workspaceClass = '\\Pimcore\\Model\\User\\Workspace\\DataObject';
   141|                                     } else {
   142|                                         $workspaceClass = '\\Pimcore\\Model\\User\\Workspace\\' . ucfirst($key);
   143|                                     }
   144|                                     $newWorkspace = new $workspaceClass();
   145|                                     foreach ($vars as $varKey => $varValue) {
   146|                                         $newWorkspace->setObjectVar($varKey, $varValue);
   147|                                     }
   148|                                     $newWorkspace->setUserId($user->getId());
   149|                                     $clonedWorkspaces[] = $newWorkspace;
   150|                                 }
   151|                             }
   152|                             $user->$setter($clonedWorkspaces);
   153|                         }
   154|                         $user->setPerspectives($rObject->getPerspectives());
   155|                         $user->setPermissions($rObject->getPermissions());
   156|                         if ($type == 'user') {
   157|                             $user->setAdmin(false);
   158|                             if ($this->getAdminUser()->isAdmin()) {
   159|                                 $user->setAdmin($rObject->getAdmin());
   160|                             }
   161|                             $user->setActive($rObject->getActive());
   162|                             $user->setRoles($rObject->getRoles());
   163|                             $user->setWelcomeScreen($rObject->getWelcomescreen());
   164|                             $user->setMemorizeTabs($rObject->getMemorizeTabs());
   165|                             $user->setCloseWarning($rObject->getCloseWarning());
   166|                         }
   167|                         $user->setWebsiteTranslationLanguagesView($rObject->getWebsiteTranslationLanguagesView());
   168|                         $user->setWebsiteTranslationLanguagesEdit($rObject->getWebsiteTranslationLanguagesEdit());
   169|                         $user->save();
   170|                     }
   171|                 }
   172|             }
   173|             return $this->adminJson([
   174|                 'success' => true,
   175|                 'id' => $user->getId(),
   176|             ]);
   177|         } catch (\Exception $e) {
   178|             return $this->adminJson(['success' => false, 'message' => $e->getMessage()]);
   179|         }
   180|     }
   181|     /**
   182|      * @param User $node
   183|      * @param array $currentList
   184|      * @param bool $roleMode
   185|      *
   186|      * @return array
   187|      *
   188|      * @throws \Exception
   189|      */
   190|     protected function populateChildNodes($node, &$currentList, $roleMode)
   191|     {
   192|         $currentUser = \Pimcore\Tool\Admin::getCurrentUser();
   193|         $list = $roleMode ? new User\Role\Listing() : new User\Listing();
   194|         $list->setCondition('parentId = ?', $node->getId());
   195|         $list->setOrder('ASC');
   196|         $list->setOrderKey('name');
   197|         $list->load();
   198|         $childList = $roleMode ? $list->getRoles() : $list->getUsers();
   199|         if (is_array($childList)) {
   200|             foreach ($childList as $user) {
   201|                 if ($user->getId() == $currentUser->getId()) {
   202|                     throw new \Exception('Cannot delete current user');
   203|                 }
   204|                 if ($user->getId() && $currentUser->getId() && $user->getName() != 'system') {
   205|                     $currentList[] = $user;
   206|                     $this->populateChildNodes($user, $currentList, $roleMode);
   207|                 }
   208|             }
   209|         }
   210|         return $currentList;
   211|     }
   212|     /**
   213|      * @Route("/user/delete", name="pimcore_admin_user_delete", methods={"DELETE"})
   214|      *
   215|      * @param Request $request
   216|      *
   217|      * @return JsonResponse
   218|      *
   219|      * @throws \Exception
   220|      */
   221|     public function deleteAction(Request $request)
   222|     {
   223|         $user = User\AbstractUser::getById((int)$request->get('id'));
   224|         if (($user instanceof User\Folder && !$this->getAdminUser()->isAdmin()) || ($user instanceof User && $user->isAdmin() && !$this->getAdminUser()->isAdmin())) {
   225|             throw new \Exception('You are not allowed to delete this user');
   226|         } else {
   227|             if ($user instanceof User\Role\Folder) {
   228|                 $list = [$user];
   229|                 $this->populateChildNodes($user, $list, $user instanceof User\Role\Folder);
   230|                 $listCount = count($list);
   231|                 for ($i = $listCount - 1; $i >= 0; $i--) {
   232|                     $user = $list[$i];
   233|                     $user->delete();
   234|                 }
   235|             } else {
   236|                 if ($user->getId()) {
   237|                     $user->delete();
   238|                 }
   239|             }
   240|         }
   241|         return $this->adminJson(['success' => true]);
   242|     }
   243|     /**
   244|      * @Route("/user/update", name="pimcore_admin_user_update", methods={"PUT"})
   245|      *
   246|      * @param Request $request
   247|      *
   248|      * @return JsonResponse
   249|      *
   250|      * @throws \Exception
   251|      */
   252|     public function updateAction(Request $request)
   253|     {
   254|         /** @var User|User\Role $user */
   255|         $user = User\AbstractUser::getById((int)$request->get('id'));
   256|         if ($user instanceof User && $user->isAdmin() && !$this->getAdminUser()->isAdmin()) {
   257|             throw new \Exception('Only admin users are allowed to modify admin users');
   258|         }
   259|         if ($request->get('data')) {
   260|             $values = $this->decodeJson($request->get('data'), true);
   261|             if (!empty($values['password'])) {
   262|                 if (strlen($values['password']) < 10) {
   263|                     throw new \Exception('Passwords have to be at least 10 characters long');
   264|                 }
   265|                 $values['password'] = Tool\Authentication::getPasswordHash($user->getName(), $values['password']);
   266|             }
   267|             foreach ($values as $key => $value) {
   268|                 if (strpos($key, 'permission_') === 0) {
   269|                     if (method_exists($user, 'setAllAclToFalse')) {
   270|                         $user->setAllAclToFalse();
   271|                     }
   272|                     break;
   273|                 }
   274|             }
   275|             if ($user instanceof User && isset($values['2fa_required'])) {
   276|                 $user->setTwoFactorAuthentication('required', (bool) $values['2fa_required']);
   277|             }
   278|             $user->setValues($values);
   279|             if (!$this->getAdminUser()->isAdmin() && $user instanceof User) {
   280|                 if ($user instanceof User) {
   281|                     $user->setAdmin(false);
   282|                 }
   283|             }
   284|             $availableUserPermissionsList = new User\Permission\Definition\Listing();
   285|             $availableUserPermissions = $availableUserPermissionsList->load();
   286|             foreach ($availableUserPermissions as $permission) {
   287|                 if (isset($values['permission_' . $permission->getKey()])) {
   288|                     $user->setPermission($permission->getKey(), (bool) $values['permission_' . $permission->getKey()]);
   289|                 }
   290|             }
   291|             if ($request->get('workspaces')) {
   292|                 $processedPaths = ['object' => [], 'asset' => [], 'document' => []]; //array to find if there are multiple entries for a path
   293|                 $workspaces = $this->decodeJson($request->get('workspaces'), true);
   294|                 foreach ($workspaces as $type => $spaces) {
   295|                     $newWorkspaces = [];
   296|                     foreach ($spaces as $space) {
   297|                         if (in_array($space['path'], $processedPaths[$type])) {
   298|                             throw new \Exception('Error saving workspaces as multiple entries found for path "' . $space['path'] .'" in '.$this->trans((string)$type) . 's');
   299|                         }
   300|                         $element = Element\Service::getElementByPath($type, $space['path']);
   301|                         if ($element) {
   302|                             $className = '\\Pimcore\\Model\\User\\Workspace\\' . Element\Service::getBaseClassNameForElement($type);
   303|                             $workspace = new $className();
   304|                             $workspace->setValues($space);
   305|                             $workspace->setCid($element->getId());
   306|                             $workspace->setCpath($element->getRealFullPath());
   307|                             $workspace->setUserId($user->getId());
   308|                             $newWorkspaces[] = $workspace;
   309|                             $processedPaths[$type][] = $space['path'];
   310|                         }
   311|                     }
   312|                     $user->{'setWorkspaces' . ucfirst($type)}($newWorkspaces);
   313|                 }
   314|             }
   315|         }
   316|         if ($request->get('keyBindings')) {
   317|             $keyBindings = json_decode($request->get('keyBindings'), true);
   318|             $tmpArray = [];
   319|             foreach ($keyBindings as $action => $item) {
   320|                 $tmpArray[] = json_decode($item, true);
   321|             }
   322|             $tmpArray = array_values(array_filter($tmpArray));
   323|             $tmpArray = json_encode($tmpArray);
   324|             $user->setKeyBindings($tmpArray);
   325|         }
   326|         $user->save();
   327|         return $this->adminJson(['success' => true]);
   328|     }
   329|     /**
   330|      * @Route("/user/get", name="pimcore_admin_user_get", methods={"GET"})
   331|      *
   332|      * @param Request $request
   333|      * @param Config $config
   334|      *
   335|      * @return JsonResponse
   336|      *
   337|      * @throws \Exception
   338|      */
   339|     public function getAction(Request $request, Config $config)
   340|     {
   341|         if ((int)$request->get('id') < 1) {
   342|             return $this->adminJson(['success' => false]);
   343|         }
   344|         /** @var User $user */
   345|         $user = User::getById((int)$request->get('id'));
   346|         if ($user->isAdmin() && !$this->getAdminUser()->isAdmin()) {
   347|             throw new \Exception('Only admin users are allowed to modify admin users');
   348|         }
   349|         $types = ['asset', 'document', 'object'];
   350|         foreach ($types as $type) {
   351|             $workspaces = $user->{'getWorkspaces' . ucfirst($type)}();
   352|             foreach ($workspaces as $wKey => $workspace) {
   353|                 $el = Element\Service::getElementById($type, $workspace->getCid());
   354|                 if ($el) {
   355|                     $workspace->path = $el->getRealFullPath();
   356|                     $workspaces[$wKey] = $workspace->getObjectVars();
   357|                 }
   358|             }
   359|             $user->{'setWorkspaces' . ucfirst($type)}($workspaces);
   360|         }
   361|         $userObjects = DataObject\Service::getObjectsReferencingUser($user->getId());
   362|         $userObjectData = [];
   363|         $hasHidden = false;
   364|         foreach ($userObjects as $o) {
   365|             if ($o->isAllowed('list')) {
   366|                 $userObjectData[] = [
   367|                     'path' => $o->getRealFullPath(),
   368|                     'id' => $o->getId(),
   369|                     'subtype' => $o->getClass()->getName(),
   370|                 ];
   371|             } else {
   372|                 $hasHidden = true;
   373|             }
   374|         }
   375|         $availableUserPermissionsList = new User\Permission\Definition\Listing();
   376|         $availableUserPermissions = $availableUserPermissionsList->load();
   377|         $availableUserPermissionsData = [];
   378|         if (is_array($availableUserPermissions)) {
   379|             foreach ($availableUserPermissions as $availableUserPermission) {
   380|                 $availableUserPermissionsData[] = $availableUserPermission->getObjectVars();
   381|             }
   382|         }
   383|         $list = new User\Role\Listing();
   384|         $list->setCondition('`type` = ?', ['role']);
   385|         $list->load();
   386|         $roles = [];
   387|         if (is_array($list->getItems())) {
   388|             foreach ($list->getItems() as $role) {
   389|                 $roles[] = [$role->getId(), $role->getName()];
   390|             }
   391|         }
   392|         $userData = $user->getObjectVars();
   393|         $userData['roles'] =  array_map('intval', $user->getRoles());
   394|         $userData['docTypes'] =  array_map('intval', $user->getDocTypes());
   395|         $contentLanguages = Tool\Admin::reorderWebsiteLanguages($user, Tool::getValidLanguages());
   396|         $userData['contentLanguages'] = $contentLanguages;
   397|         $userData['twoFactorAuthentication']['isActive'] = ($user->getTwoFactorAuthentication('enabled') || $user->getTwoFactorAuthentication('secret'));
   398|         unset($userData['password']);
   399|         unset($userData['twoFactorAuthentication']['secret']);
   400|         $userData['hasImage'] = $user->hasImage();
   401|         $availablePerspectives = \Pimcore\Config::getAvailablePerspectives(null);
   402|         return $this->adminJson([
   403|             'success' => true,
   404|             'user' => $userData,
   405|             'roles' => $roles,
   406|             'permissions' => $user->generatePermissionList(),
   407|             'availablePermissions' => $availableUserPermissionsData,
   408|             'availablePerspectives' => $availablePerspectives,
   409|             'validLanguages' => Tool::getValidLanguages(),
   410|             'objectDependencies' => [
   411|                 'hasHidden' => $hasHidden,
   412|                 'dependencies' => $userObjectData,
   413|             ],
   414|         ]);
   415|     }
   416|     /**
   417|      * @Route("/user/get-minimal", name="pimcore_admin_user_getminimal", methods={"GET"})
   418|      *
   419|      * @param Request $request
   420|      *
   421|      * @return JsonResponse
   422|      */
   423|     public function getMinimalAction(Request $request)
   424|     {
   425|         /** @var User $user */
   426|         $user = User::getById((int)$request->get('id'));
   427|         $user->setPassword(null);
   428|         $minimalUserData['id'] = $user->getId();
   429|         $minimalUserData['admin'] = $user->isAdmin();
   430|         $minimalUserData['active'] = $user->isActive();
   431|         $minimalUserData['permissionInfo']['assets'] = $user->isAllowed('assets');
   432|         $minimalUserData['permissionInfo']['documents'] = $user->isAllowed('documents');
   433|         $minimalUserData['permissionInfo']['objects'] = $user->isAllowed('objects');
   434|         return $this->adminJson($minimalUserData);
   435|     }
   436|     /**
   437|      * @Route("/user/upload-current-user-image", name="pimcore_admin_user_uploadcurrentuserimage", methods={"POST"})
   438|      *
   439|      * @param Request $request
   440|      *
   441|      * @return JsonResponse
   442|      */
   443|     public function uploadCurrentUserImageAction(Request $request)
   444|     {
   445|         $user = $this->getAdminUser();
   446|         if ($user != null) {
   447|             if ($user->getId() == $request->get('id')) {
   448|                 return $this->uploadImageAction($request);
   449|             } else {
   450|                 Logger::warn('prevented save current user, because ids do not match. ');
   451|                 return $this->adminJson(false);
   452|             }
   453|         } else {
   454|             return $this->adminJson(false);
   455|         }
   456|     }
   457|     /**
   458|      * @Route("/user/update-current-user", name="pimcore_admin_user_updatecurrentuser", methods={"PUT"})
   459|      *
   460|      * @param Request $request
   461|      *
   462|      * @return JsonResponse
   463|      */
   464|     public function updateCurrentUserAction(Request $request)
   465|     {
   466|         $user = $this->getAdminUser();
   467|         if ($user != null) {
   468|             if ($user->getId() == $request->get('id')) {
   469|                 $values = $this->decodeJson($request->get('data'), true);
   470|                 unset($values['name']);
   471|                 unset($values['id']);
   472|                 unset($values['admin']);
   473|                 unset($values['permissions']);
   474|                 unset($values['roles']);
   475|                 unset($values['active']);
   476|                 if (!empty($values['new_password'])) {
   477|                     $oldPasswordCheck = false;
   478|                     if (empty($values['old_password'])) {
   479|                         $oldPasswordCheck = Tool\Session::useSession(function (AttributeBagInterface $adminSession) {
   480|                             if ($adminSession->get('password_reset')) {
   481|                                 return true;
   482|                             }
   483|                             return false;
   484|                         });
   485|                     } else {
   486|                         $checkUser = Tool\Authentication::authenticatePlaintext($user->getName(), $values['old_password']);
   487|                         if ($checkUser) {
   488|                             $oldPasswordCheck = true;
   489|                         }
   490|                     }
   491|                     if (strlen($values['new_password']) < 10) {
   492|                         throw new \Exception('Passwords have to be at least 10 characters long');
   493|                     }
   494|                     if ($oldPasswordCheck && $values['new_password'] == $values['retype_password']) {
   495|                         $values['password'] = Tool\Authentication::getPasswordHash($user->getName(), $values['new_password']);
   496|                     } else {
   497|                         return $this->adminJson(['success' => false, 'message' => 'password_cannot_be_changed']);
   498|                     }
   499|                 }
   500|                 $user->setValues($values);
   501|                 if ($request->get('keyBindings')) {
   502|                     $keyBindings = json_decode($request->get('keyBindings'), true);
   503|                     $tmpArray = [];
   504|                     foreach ($keyBindings as $action => $item) {
   505|                         $tmpArray[] = json_decode($item, true);
   506|                     }
   507|                     $tmpArray = array_values(array_filter($tmpArray));
   508|                     $tmpArray = json_encode($tmpArray);
   509|                     $user->setKeyBindings($tmpArray);
   510|                 }
   511|                 $user->save();
   512|                 return $this->adminJson(['success' => true]);
   513|             } else {
   514|                 Logger::warn('prevented save current user, because ids do not match. ');
   515|                 return $this->adminJson(false);
   516|             }
   517|         } else {
   518|             return $this->adminJson(false);
   519|         }
   520|     }
   521|     /**
   522|      * @Route("/user/get-current-user", name="pimcore_admin_user_getcurrentuser", methods={"GET"})
   523|      *
   524|      * @param Request $request
   525|      *
   526|      * @return Response
   527|      */
   528|     public function getCurrentUserAction(Request $request)
   529|     {
   530|         $user = $this->getAdminUser();
   531|         $list = new User\Permission\Definition\Listing();
   532|         $definitions = $list->load();
   533|         foreach ($definitions as $definition) {
   534|             $user->setPermission($definition->getKey(), $user->isAllowed($definition->getKey()));
   535|         }
   536|         $userData = $user->getObjectVars();
   537|         $contentLanguages = Tool\Admin::reorderWebsiteLanguages($user, Tool::getValidLanguages());
   538|         $userData['contentLanguages'] = $contentLanguages;
   539|         $userData['keyBindings'] = $user->getKeyBindings();
   540|         unset($userData['password']);
   541|         $userData['twoFactorAuthentication'] = $user->getTwoFactorAuthentication();
   542|         unset($userData['twoFactorAuthentication']['secret']);
   543|         $userData['twoFactorAuthentication']['isActive'] = $user->getTwoFactorAuthentication('enabled') && $user->getTwoFactorAuthentication('secret');
   544|         $userData['hasImage'] = $user->hasImage();
   545|         $userData['isPasswordReset'] = Tool\Session::useSession(function (AttributeBagInterface $adminSession) {
   546|             return $adminSession->get('password_reset');
   547|         });
   548|         $response = new Response('pimcore.currentuser = ' . $this->encodeJson($userData));
   549|         $response->headers->set('Content-Type', 'text/javascript');
   550|         return $response;
   551|     }
   552|     /**
   553|      * @Route("/user/role-tree-get-childs-by-id", name="pimcore_admin_user_roletreegetchildsbyid", methods={"GET"})
   554|      *
   555|      * @param Request $request
   556|      *
   557|      * @return JsonResponse
   558|      */
   559|     public function roleTreeGetChildsByIdAction(Request $request)
   560|     {
   561|         $list = new User\Role\Listing();
   562|         $list->setCondition('parentId = ?', (int)$request->get('node'));
   563|         $list->load();
   564|         $roles = [];
   565|         if (is_array($list->getItems())) {
   566|             foreach ($list->getItems() as $role) {
   567|                 $roles[] = $this->getRoleTreeNodeConfig($role);
   568|             }
   569|         }
   570|         return $this->adminJson($roles);
   571|     }
   572|     /**
   573|      * @param User\Role|User\Role\Folder $role
   574|      *
   575|      * @return array
   576|      */
   577|     protected function getRoleTreeNodeConfig($role)
   578|     {
   579|         $tmpUser = [
   580|             'id' => $role->getId(),
   581|             'text' => $role->getName(),
   582|             'elementType' => 'role',
   583|             'qtipCfg' => [
   584|                 'title' => 'ID: ' . $role->getId(),
   585|             ],
   586|         ];
   587|         if ($role instanceof User\Role\Folder) {
   588|             $tmpUser['leaf'] = false;
   589|             $tmpUser['iconCls'] = 'pimcore_icon_folder';
   590|             $tmpUser['expanded'] = true;
   591|             $tmpUser['allowChildren'] = true;
   592|             if ($role->hasChildren()) {
   593|                 $tmpUser['expanded'] = false;
   594|             } else {
   595|                 $tmpUser['loaded'] = true;
   596|             }
   597|         } else {
   598|             $tmpUser['leaf'] = true;
   599|             $tmpUser['iconCls'] = 'pimcore_icon_roles';
   600|             $tmpUser['allowChildren'] = false;
   601|         }
   602|         return $tmpUser;
   603|     }
   604|     /**
   605|      * @Route("/user/role-get", name="pimcore_admin_user_roleget", methods={"GET"})
   606|      *
   607|      * @param Request $request
   608|      *
   609|      * @return JsonResponse
   610|      */
   611|     public function roleGetAction(Request $request)
   612|     {
   613|         /** @var User\UserRole $role */
   614|         $role = User\Role::getById((int)$request->get('id'));
   615|         $types = ['asset', 'document', 'object'];
   616|         foreach ($types as $type) {
   617|             $workspaces = $role->{'getWorkspaces' . ucfirst($type)}();
   618|             foreach ($workspaces as $wKey => $workspace) {
   619|                 $el = Element\Service::getElementById($type, $workspace->getCid());
   620|                 if ($el) {
   621|                     $workspace->path = $el->getRealFullPath();
   622|                     $workspaces[$wKey] = $workspace->getObjectVars();
   623|                 }
   624|             }
   625|             $role->{'setWorkspaces' . ucfirst($type)}($workspaces);
   626|         }
   627|         $replaceFn = function ($value) {
   628|             return $value->getObjectVars();
   629|         };
   630|         $availableUserPermissionsList = new User\Permission\Definition\Listing();
   631|         $availableUserPermissions = $availableUserPermissionsList->load();
   632|         $availableUserPermissions = array_map($replaceFn, $availableUserPermissions);
   633|         $availablePerspectives = \Pimcore\Config::getAvailablePerspectives(null);
   634|         return $this->adminJson([
   635|             'success' => true,
   636|             'role' => $role->getObjectVars(),
   637|             'permissions' => $role->generatePermissionList(),
   638|             'classes' => $role->getClasses(),
   639|             'docTypes' => $role->getDocTypes(),
   640|             'availablePermissions' => $availableUserPermissions,
   641|             'availablePerspectives' => $availablePerspectives,
   642|             'validLanguages' => Tool::getValidLanguages(),
   643|         ]);
   644|     }
   645|     /**
   646|      * @Route("/user/upload-image", name="pimcore_admin_user_uploadimage", methods={"POST"})
   647|      *
   648|      * @param Request $request
   649|      *
   650|      * @throws \Exception
   651|      *
   652|      * @return JsonResponse
   653|      */
   654|     public function uploadImageAction(Request $request)
   655|     {
   656|         /** @var User $userObj */
   657|         $userObj = User::getById($this->getUserId($request));
   658|         if ($userObj->isAdmin() && !$this->getAdminUser()->isAdmin()) {
   659|             throw new \Exception('Only admin users are allowed to modify admin users');
   660|         }
   661|         $userObj->setImage($_FILES['Filedata']['tmp_name']);
   662|         $response = $this->adminJson(['success' => true]);
   663|         $response->headers->set('Content-Type', 'text/html');
   664|         return $response;
   665|     }
   666|     /**
   667|      * @Route("/user/delete-image", name="pimcore_admin_user_deleteimage", methods={"DELETE"})
   668|      *
   669|      * @param Request $request
   670|      *
   671|      * @throws \Exception
   672|      *
   673|      * @return JsonResponse
   674|      */
   675|     public function deleteImageAction(Request $request)
   676|     {
   677|         /** @var User $userObj */
   678|         $userObj = User::getById($this->getUserId($request));
   679|         if ($userObj->isAdmin() && !$this->getAdminUser()->isAdmin()) {
   680|             throw new \Exception('Only admin users are allowed to modify admin users');
   681|         }
   682|         $userObj->setImage(null);
   683|         return $this->adminJson(['success' => true]);
   684|     }
   685|     /**
   686|      * @Route("/user/renew-2fa-qr-secret", name="pimcore_admin_user_renew2fasecret", methods={"GET"})
   687|      *
   688|      * @param Request $request
   689|      * @param GoogleAuthenticatorInterface $twoFactor
   690|      *
   691|      * @return BinaryFileResponse
   692|      */
   693|     public function renew2FaSecretAction(Request $request, GoogleAuthenticatorInterface $twoFactor)
   694|     {
   695|         $user = $this->getAdminUser();
   696|         $proxyUser = $this->getAdminUser(true);
   697|         $newSecret = $twoFactor->generateSecret();
   698|         $user->setTwoFactorAuthentication('enabled', true);
   699|         $user->setTwoFactorAuthentication('type', 'google');
   700|         $user->setTwoFactorAuthentication('secret', $newSecret);
   701|         $user->save();
   702|         Tool\Session::useSession(function (AttributeBagInterface $adminSession) {
   703|             Tool\Session::regenerateId();
   704|             $adminSession->set('2fa_required', true);
   705|         });
   706|         $url = $twoFactor->getQRContent($proxyUser);
   707|         $code = new \Endroid\QrCode\QrCode;
   708|         $code->setWriterByName('png');
   709|         $code->setText($url);
   710|         $code->setSize(200);
   711|         $qrCodeFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/qr-code-' . uniqid() . '.png';
   712|         $code->writeFile($qrCodeFile);
   713|         $response = new BinaryFileResponse($qrCodeFile);
   714|         return $response;
   715|     }
   716|     /**
   717|      * @Route("/user/disable-2fa", name="pimcore_admin_user_disable2fasecret", methods={"DELETE"})
   718|      *
   719|      * @param Request $request
   720|      *
   721|      * @return JsonResponse
   722|      */
   723|     public function disable2FaSecretAction(Request $request)
   724|     {
   725|         $user = $this->getAdminUser();
   726|         $success = false;
   727|         if (!$user->getTwoFactorAuthentication('required')) {
   728|             $user->setTwoFactorAuthentication([]);
   729|             $user->save();
   730|             $success = true;
   731|         }
   732|         return $this->adminJson([
   733|             'success' => $success,
   734|         ]);
   735|     }
   736|     /**
   737|      * @Route("/user/reset-2fa-secret", name="pimcore_admin_user_reset2fasecret", methods={"PUT"})
   738|      *
   739|      * @param Request $request
   740|      *
   741|      * @return JsonResponse
   742|      */
   743|     public function reset2FaSecretAction(Request $request)
   744|     {
   745|         /**
   746|          * @var User $user
   747|          */
   748|         $user = User::getById((int)$request->get('id'));
   749|         $success = true;
   750|         $user->setTwoFactorAuthentication('enabled', false);
   751|         $user->setTwoFactorAuthentication('secret', '');
   752|         $user->save();
   753|         return $this->adminJson([
   754|             'success' => $success,
   755|         ]);
   756|     }
   757|     /**
   758|      * @Route("/user/get-image", name="pimcore_admin_user_getimage", methods={"GET"})
   759|      *
   760|      * @param Request $request
   761|      *
   762|      * @return StreamedResponse
   763|      */
   764|     public function getImageAction(Request $request)
   765|     {
   766|         /** @var User $userObj */
   767|         $userObj = User::getById($this->getUserId($request));
   768|         $stream = $userObj->getImage();
   769|         return new StreamedResponse(function () use ($stream) {
   770|             fpassthru($stream);
   771|         }, 200, [
   772|             'Content-Type' => 'image/png',
   773|         ]);
   774|     }
   775|     /**
   776|      * @Route("/user/get-token-login-link", name="pimcore_admin_user_gettokenloginlink", methods={"GET"})
   777|      *
   778|      * @param Request $request
   779|      *
   780|      * @return JsonResponse
   781|      *
   782|      * @throws \Exception
   783|      */
   784|     public function getTokenLoginLinkAction(Request $request)
   785|     {
   786|         $user = User::getById($request->get('id'));
   787|         if (!$user) {
   788|             return $this->adminJson([
   789|                 'success' => false,
   790|                 'message' => $this->trans('login_token_invalid_user_error'),
   791|             ], Response::HTTP_NOT_FOUND);
   792|         }
   793|         if ($user->isAdmin() && !$this->getAdminUser()->isAdmin()) {
   794|             return $this->adminJson([
   795|                 'success' => false,
   796|                 'message' => $this->trans('login_token_as_admin_non_admin_user_error'),
   797|             ], Response::HTTP_FORBIDDEN);
   798|         }
   799|         if (empty($user->getPassword())) {
   800|             return $this->adminJson([
   801|                 'success' => false,
   802|                 'message' => $this->trans('login_token_no_password_error'),
   803|             ], Response::HTTP_FORBIDDEN);
   804|         }
   805|         $token = Tool\Authentication::generateToken($user->getName());
   806|         $link = $this->generateCustomUrl([
   807|             'token' => $token,
   808|         ]);
   809|         return $this->adminJson([
   810|             'success' => true,
   811|             'link' => $link,
   812|         ]);
   813|     }
   814|     /**
   815|      * @Route("/user/search", name="pimcore_admin_user_search", methods={"GET"})
   816|      *
   817|      * @param Request $request
   818|      *
   819|      * @return JsonResponse
   820|      */
   821|     public function searchAction(Request $request)
   822|     {
   823|         $q = '%' . $request->get('query') . '%';
   824|         $list = new User\Listing();
   825|         $list->setCondition('name LIKE ? OR firstname LIKE ? OR lastname LIKE ? OR email LIKE ? OR id = ?', [$q, $q, $q, $q, (int)$request->get('query')]);
   826|         $list->setOrder('ASC');
   827|         $list->setOrderKey('name');
   828|         $list->load();
   829|         $users = [];
   830|         if (is_array($list->getUsers())) {
   831|             foreach ($list->getUsers() as $user) {
   832|                 if ($user instanceof User && $user->getId() && $user->getName() != 'system') {
   833|                     $users[] = [
   834|                         'id' => $user->getId(),
   835|                         'name' => $user->getName(),
   836|                         'email' => $user->getEmail(),
   837|                         'firstname' => $user->getFirstname(),
   838|                         'lastname' => $user->getLastname(),
   839|                     ];
   840|                 }
   841|             }
   842|         }
   843|         return $this->adminJson([
   844|             'success' => true,
   845|             'users' => $users,
   846|         ]);
   847|     }
   848|     /**
   849|      * @param ControllerEvent $event
   850|      */
   851|     public function onKernelControllerEvent(ControllerEvent $event)
   852|     {
   853|         $isMasterRequest = $event->isMasterRequest();
   854|         if (!$isMasterRequest) {
   855|             return;
   856|         }
   857|         $unrestrictedActions = [
   858|             'getCurrentUserAction', 'updateCurrentUserAction', 'getAvailablePermissionsAction', 'getMinimalAction',
   859|             'getImageAction', 'uploadCurrentUserImageAction', 'disable2FaSecretAction', 'renew2FaSecretAction',
   860|             'getUsersForSharingAction', 'getRolesForSharingAction',
   861|         ];
   862|         $this->checkActionPermission($event, 'users', $unrestrictedActions);
   863|     }
   864|     /**
   865|      * @param Request $request
   866|      *
   867|      * @return JsonResponse
   868|      *
   869|      * @Route("/user/get-users-for-sharing", name="pimcore_admin_user_getusersforsharing", methods={"GET"})
   870|      */
   871|     public function getUsersForSharingAction(Request $request)
   872|     {
   873|         $this->checkPermission('share_configurations');
   874|         return $this->getUsersAction($request);
   875|     }
   876|     /**
   877|      * @param Request $request
   878|      *
   879|      * @return JsonResponse
   880|      *
   881|      * @Route("/user/get-roles-for-sharing", name="pimcore_admin_user_getrolesforsharing", methods={"GET"}))
   882|      */
   883|     public function getRolesForSharingAction(Request $request)
   884|     {
   885|         $this->checkPermission('share_configurations');
   886|         return $this->getRolesAction($request);
   887|     }
   888|     /**
   889|      * @Route("/user/get-users", name="pimcore_admin_user_getusers", methods={"GET"})
   890|      *
   891|      * @param Request $request
   892|      *
   893|      * @return JsonResponse
   894|      */
   895|     public function getUsersAction(Request $request)
   896|     {
   897|         $users = [];
   898|         $list = new \Pimcore\Model\User\Listing();
   899|         $conditions = [ 'type = "user"' ];
   900|         if (!$request->get('include_current_user')) {
   901|             $conditions[] = 'id != ' . $this->getAdminUser()->getId();
   902|         }
   903|         $list->setCondition(implode(' AND ', $conditions));
   904|         $list->load();
   905|         $userList = $list->getUsers();
   906|         foreach ($userList as $user) {
   907|             if (!$request->get('permission') || $user->isAllowed($request->get('permission'))) {
   908|                 $users[] = [
   909|                     'id' => $user->getId(),
   910|                     'label' => $user->getUsername(),
   911|                 ];
   912|             }
   913|         }
   914|         return $this->adminJson(['success' => true, 'total' => count($users), 'data' => $users]);
   915|     }
   916|     /**
   917|      * @Route("/user/get-roles", name="pimcore_admin_user_getroles", methods={"GET"})
   918|      *
   919|      * @param Request $request
   920|      *
   921|      * @return JsonResponse
   922|      */
   923|     public function getRolesAction(Request $request)
   924|     {
   925|         $roles = [];
   926|         $list = new \Pimcore\Model\User\Role\Listing();
   927|         $list->setCondition('type = "role"');
   928|         $list->load();
   929|         $roleList = $list->getRoles();
   930|         foreach ($roleList as $role) {
   931|             if (!$request->get('permission') || in_array($request->get('permission'), $role->getPermissions())) {
   932|                 $roles[] = [
   933|                     'id' => $role->getId(),
   934|                     'label' => $role->getName(),
   935|                 ];
   936|             }
   937|         }
   938|         return $this->adminJson(['success' => true, 'total' => count($roles), 'data' => $roles]);
   939|     }
   940|     /**
   941|      * @Route("/user/get-default-key-bindings", name="pimcore_admin_user_getdefaultkeybindings", methods={"GET"})
   942|      *
   943|      * @param Request $request
   944|      *
   945|      * @return JsonResponse
   946|      */
   947|     public function getDefaultKeyBindingsAction(Request $request)
   948|     {
   949|         $data = User::getDefaultKeyBindings();
   950|         return $this->adminJson(['success' => true, 'data' => $data]);
   951|     }
   952|     /**
   953|      * @Route("/user/invitationlink", name="pimcore_admin_user_invitationlink", methods={"POST"})
   954|      *
   955|      * @param Request $request
   956|      *
   957|      * @return JsonResponse
   958|      *
   959|      * @throws \Exception
   960|      */
   961|     public function invitationLinkAction(Request $request)
   962|     {
   963|         $success = false;
   964|         $message = '';
   965|         if ($username = $request->get('username')) {
   966|             $user = User::getByName($username);
   967|             if ($user instanceof User) {
   968|                 if (!$user->isActive()) {
   969|                     $message .= 'User inactive  <br />';
   970|                 }
   971|                 if (!$user->getEmail()) {
   972|                     $message .= 'User has no email address <br />';
   973|                 }
   974|             } else {
   975|                 $message .= 'User unknown <br />';
   976|             }
   977|             if (empty($message)) {
   978|                 if (!$user->getPassword()) {
   979|                     $user->setPassword(bin2hex(random_bytes(16)));
   980|                     $user->save();
   981|                 }
   982|                 $token = Tool\Authentication::generateToken($user->getName());
   983|                 $loginUrl = $this->generateCustomUrl([
   984|                     'token' => $token,
   985|                     'reset' => true,
   986|                 ]);
   987|                 try {
   988|                     $mail = Tool::getMail([$user->getEmail()], 'Pimcore login invitation for ' . Tool::getHostname());
   989|                     $mail->setIgnoreDebugMode(true);
   990|                     $mail->text("Login to pimcore and change your password using the following link. This temporary login link will expire in  24 hours: \r\n\r\n" . $loginUrl);
   991|                     $mail->send();
   992|                     $success = true;
   993|                     $message = sprintf($this->trans('invitation_link_sent'), $user->getEmail());
   994|                 } catch (\Exception $e) {
   995|                     $message .= 'could not send email';
   996|                 }
   997|             }
   998|         }
   999|         return $this->adminJson([
  1000|             'success' => $success,
  1001|             'message' => $message,
  1002|         ]);
  1003|     }
  1004|     /**
  1005|      * @param Request $request
  1006|      *
  1007|      * @return int
  1008|      */
  1009|     protected function getUserId(Request $request)
  1010|     {
  1011|         if ($request->get('id')) {
  1012|             if ($this->getAdminUser()->getId() != $request->get('id')) {
  1013|                 $this->checkPermission('users');
  1014|             }
  1015|             return (int) $request->get('id');
  1016|         }
  1017|         return $this->getAdminUser()->getId();
  1018|     }
  1019|     /**
  1020|      *
  1021|      * @param array $params
  1022|      * @param string $fallbackUrl
  1023|      * @param int $referenceType //UrlGeneratorInterface::ABSOLUTE_URL, ABSOLUTE_PATH, RELATIVE_PATH, NETWORK_PATH
  1024|      *
  1025|      * @return string The generated URL
  1026|      */
  1027|     private function generateCustomUrl(array $params, $fallbackUrl = 'pimcore_admin_login_check', $referenceType = UrlGeneratorInterface::ABSOLUTE_URL): string
  1028|     {
  1029|         try {
  1030|             $loginUrl = $this->generateUrl('my_custom_admin_entry_point', $params, $referenceType);
  1031|         } catch (\Exception $e) {
  1032|             $loginUrl = $this->generateUrl($fallbackUrl, $params, $referenceType);
  1033|         }
  1034|         return $loginUrl;
  1035|     }
  1036| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Admin/WorkflowController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-391 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Admin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Controller\KernelControllerEventInterface;
    17| use Pimcore\Model\Asset;
    18| use Pimcore\Model\DataObject;
    19| use Pimcore\Model\DataObject\Concrete as ConcreteObject;
    20| use Pimcore\Model\Document;
    21| use Pimcore\Model\Element\ValidationException;
    22| use Pimcore\Tool\Console;
    23| use Pimcore\Workflow\ActionsButtonService;
    24| use Pimcore\Workflow\Manager;
    25| use Pimcore\Workflow\Notes\CustomHtmlServiceInterface;
    26| use Pimcore\Workflow\Place\StatusInfo;
    27| use Pimcore\Workflow\Transition;
    28| use Symfony\Component\HttpFoundation\JsonResponse;
    29| use Symfony\Component\HttpFoundation\Request;
    30| use Symfony\Component\HttpFoundation\Response;
    31| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    32| use Symfony\Component\Process\Process;
    33| use Symfony\Component\Routing\Annotation\Route;
    34| use Symfony\Component\Routing\RouterInterface;
    35| use Symfony\Component\Workflow\Registry;
    36| use Symfony\Component\Workflow\Workflow;
    37| /**
    38|  * @Route("/workflow")
    39|  *
    40|  * @internal
    41|  */
    42| class WorkflowController extends AdminController implements KernelControllerEventInterface
    43| {
    44|     /**
    45|      * @var Document|Asset|ConcreteObject|null $element
    46|      */
    47|     private $element;
    48|     /**
    49|      * Returns a JSON of the available workflow actions to the admin panel
    50|      *
    51|      * @Route("/get-workflow-form", name="pimcore_admin_workflow_getworkflowform")
    52|      *
    53|      * @param Request $request
    54|      *
    55|      * @return JsonResponse
    56|      */
    57|     public function getWorkflowFormAction(Request $request, Manager $workflowManager)
    58|     {
    59|         try {
    60|             $workflow = $workflowManager->getWorkflowIfExists($this->element, (string) $request->get('workflowName'));
    61|             $workflowConfig = $workflowManager->getWorkflowConfig((string) $request->get('workflowName'));
    62|             if (empty($workflow) || empty($workflowConfig)) {
    63|                 $wfConfig = [
    64|                     'message' => 'workflow not found',
    65|                 ];
    66|             } else {
    67|                 $wfConfig = [
    68|                     'message' => '',
    69|                     'notes_enabled' => false,
    70|                     'notes_required' => false,
    71|                     'additional_fields' => [],
    72|                 ];
    73|                 $enabledTransitions = $workflow->getEnabledTransitions($this->element);
    74|                 $transition = null;
    75|                 foreach ($enabledTransitions as $_transition) {
    76|                     if ($_transition->getName() === $request->get('transitionName')) {
    77|                         $transition = $_transition;
    78|                     }
    79|                 }
    80|                 if (!$transition instanceof Transition) {
    81|                     $wfConfig['message'] = sprintf('transition %s currently not allowed', (string) $request->get('transitionName'));
    82|                 } else {
    83|                     $wfConfig['notes_required'] = $transition->getNotesCommentRequired();
    84|                     $wfConfig['additional_fields'] = [];
    85|                 }
    86|             }
    87|         } catch (\Exception $e) {
    88|             $wfConfig['message'] = $e->getMessage();
    89|         }
    90|         return $this->adminJson($wfConfig);
    91|     }
    92|     /**
    93|      * @Route("/submit-workflow-transition", name="pimcore_admin_workflow_submitworkflowtransition", methods={"POST"})
    94|      *
    95|      * @param Request $request
    96|      *
    97|      * @return JsonResponse
    98|      */
    99|     public function submitWorkflowTransitionAction(Request $request, Registry $workflowRegistry, Manager $workflowManager)
   100|     {
   101|         $workflowOptions = $request->get('workflow', []);
   102|         $workflow = $workflowRegistry->get($this->element, $request->get('workflowName'));
   103|         if ($workflow->can($this->element, $request->get('transition'))) {
   104|             try {
   105|                 $workflowManager->applyWithAdditionalData($workflow, $this->element, $request->get('transition'), $workflowOptions, true);
   106|                 $data = [
   107|                     'success' => true,
   108|                     'callback' => 'reloadObject',
   109|                 ];
   110|             } catch (ValidationException $e) {
   111|                 $reason = '';
   112|                 if (count((array)$e->getSubItems()) > 0) {
   113|                     $reason = '<ul>' . implode('', array_map(function ($item) {
   114|                         return '<li>' . $item . '</li>';
   115|                     }, $e->getSubItems())) . '</ul>';
   116|                 }
   117|                 $data = [
   118|                     'success' => false,
   119|                     'message' => $e->getMessage(),
   120|                     'reasons' => [$reason],
   121|                 ];
   122|             } catch (\Exception $e) {
   123|                 $data = [
   124|                     'success' => false,
   125|                     'message' => 'error performing action on this element',
   126|                     'reasons' => [$e->getMessage()],
   127|                 ];
   128|             }
   129|         } else {
   130|             $blockTransitionList = $workflow->buildTransitionBlockerList($this->element, $request->get('transition'));
   131|             $reasons = array_map(function ($blockTransitionItem) {
   132|                 return $blockTransitionItem->getMessage();
   133|             }, $blockTransitionList->getIterator()->getArrayCopy());
   134|             $data = [
   135|                 'success' => false,
   136|                 'message' => 'transition failed',
   137|                 'reasons' => $reasons,
   138|             ];
   139|         }
   140|         return $this->adminJson($data);
   141|     }
   142|     /**
   143|      * @Route("/submit-global-action", name="pimcore_admin_workflow_submitglobal", methods={"POST"})
   144|      *
   145|      * @param Request $request
   146|      *
   147|      * @return JsonResponse
   148|      */
   149|     public function submitGlobalAction(Request $request, Registry $workflowRegistry, Manager $workflowManager)
   150|     {
   151|         $workflowOptions = $request->get('workflow', []);
   152|         $workflow = $workflowRegistry->get($this->element, $request->get('workflowName'));
   153|         try {
   154|             $workflowManager->applyGlobalAction($workflow, $this->element, $request->get('transition'), $workflowOptions, true);
   155|             $data = [
   156|                 'success' => true,
   157|                 'callback' => 'reloadObject',
   158|             ];
   159|         } catch (ValidationException $e) {
   160|             $reason = '';
   161|             if (count((array)$e->getSubItems()) > 0) {
   162|                 $reason = '<ul>' . implode('', array_map(function ($item) {
   163|                     return '<li>' . $item . '</li>';
   164|                 }, $e->getSubItems())) . '</ul>';
   165|             }
   166|             $data = [
   167|                 'success' => false,
   168|                 'message' => $e->getMessage(),
   169|                 'reasons' => [$reason],
   170|             ];
   171|         } catch (\Exception $e) {
   172|             $data = [
   173|                 'success' => false,
   174|                 'message' => 'error performing action on this element',
   175|                 'reasons' => [$e->getMessage()],
   176|             ];
   177|         }
   178|         return $this->adminJson($data);
   179|     }
   180|     /**
   181|      * Returns the JSON needed by the workflow elements detail tab store
   182|      *
   183|      * @Route("/get-workflow-details", name="pimcore_admin_workflow_getworkflowdetailsstore")
   184|      *
   185|      * @param Request $request
   186|      * @param Manager $workflowManager
   187|      * @param StatusInfo $placeStatusInfo
   188|      * @param RouterInterface $router
   189|      *
   190|      * @return JsonResponse
   191|      *
   192|      * @throws \Exception
   193|      */
   194|     public function getWorkflowDetailsStore(Request $request, Manager $workflowManager, StatusInfo $placeStatusInfo, RouterInterface $router, ActionsButtonService $actionsButtonService)
   195|     {
   196|         $data = [];
   197|         foreach ($workflowManager->getAllWorkflowsForSubject($this->element) as $workflow) {
   198|             $workflowConfig = $workflowManager->getWorkflowConfig($workflow->getName());
   199|             $svg = null;
   200|             $msg = '';
   201|             try {
   202|                 $svg = $this->getWorkflowSvg($workflow);
   203|             } catch (\InvalidArgumentException $e) {
   204|                 $msg = $e->getMessage();
   205|             }
   206|             $url = $router->generate(
   207|                 'pimcore_admin_workflow_show_graph',
   208|                 [
   209|                     'cid' => $request->get('cid'),
   210|                     'ctype' => $request->get('ctype'),
   211|                     'workflow' => $workflow->getName(),
   212|                 ]
   213|             );
   214|             $allowedTransitions = $actionsButtonService->getAllowedTransitions($workflow, $this->element);
   215|             $globalActions = $actionsButtonService->getGlobalActions($workflow, $this->element);
   216|             $data[] = [
   217|                 'workflowName' => $workflowConfig->getLabel(),
   218|                 'placeInfo' => $placeStatusInfo->getAllPalacesHtml($this->element, $workflow->getName()),
   219|                 'graph' => $msg ?: '<a href="' . $url .'" target="_blank"><div class="workflow-graph-preview">'.$svg.'</div></a>',
   220|                 'allowedTransitions' => $allowedTransitions,
   221|                 'globalActions' => $globalActions,
   222|             ];
   223|         }
   224|         return $this->adminJson([
   225|             'data' => $data,
   226|             'success' => true,
   227|             'total' => count($data),
   228|         ]);
   229|     }
   230|     /**
   231|      * Returns the JSON needed by the workflow elements detail tab store
   232|      *
   233|      * @Route("/show-graph", name="pimcore_admin_workflow_show_graph")
   234|      *
   235|      * @param Request $request
   236|      * @param Manager $workflowManager
   237|      *
   238|      * @return Response
   239|      *
   240|      * @throws \Exception
   241|      */
   242|     public function showGraph(Request $request, Manager $workflowManager)
   243|     {
   244|         $workflow = $workflowManager->getWorkflowByName($request->get('workflow'));
   245|         $response = new Response($this->getWorkflowSvg($workflow));
   246|         $response->headers->set('Content-Type', 'image/svg+xml');
   247|         return $response;
   248|     }
   249|     /**
   250|      * Get custom HTML for the workflow transition submit modal, depending whether it is configured or not.
   251|      *
   252|      * @Route("/modal-custom-html", name="pimcore_admin_workflow_modal_custom_html", methods={"POST"})
   253|      *
   254|      * @param Request $request
   255|      * @param Registry $workflowRegistry
   256|      * @param Manager $manager
   257|      *
   258|      * @return Response
   259|      *
   260|      * @throws \Exception
   261|      */
   262|     public function getModalCustomHtml(Request $request, Registry $workflowRegistry, Manager $manager)
   263|     {
   264|         $workflow = $workflowRegistry->get($this->element, $request->get('workflowName'));
   265|         if ($request->get('isGlobalAction') == 'true') {
   266|             $globalAction = $manager->getGlobalAction($workflow->getName(), $request->get('transition'));
   267|             if ($globalAction) {
   268|                 return $this->customHtmlResponse($globalAction->getCustomHtmlService());
   269|             }
   270|         } elseif ($workflow->can($this->element, $request->get('transition'))) {
   271|             $enabledTransitions = $workflow->getEnabledTransitions($this->element);
   272|             $transition = null;
   273|             foreach ($enabledTransitions as $_transition) {
   274|                 if ($_transition->getName() === $request->get('transition')) {
   275|                     $transition = $_transition;
   276|                 }
   277|             }
   278|             if ($transition instanceof Transition) {
   279|                 return $this->customHtmlResponse($transition->getCustomHtmlService());
   280|             }
   281|         }
   282|         $data = [
   283|             'success' => false,
   284|             'message' => 'error validating the action on this element, element cannot peform this action',
   285|         ];
   286|         return new JsonResponse($data);
   287|     }
   288|     private function customHtmlResponse(CustomHtmlServiceInterface $customHtmlService = null): JsonResponse
   289|     {
   290|         $data = [
   291|             'success' => true,
   292|             'customHtml' => [],
   293|         ];
   294|         if ($customHtmlService) {
   295|             foreach (['top', 'center', 'bottom'] as $position) {
   296|                 $data['customHtml'][$position] = $customHtmlService->renderHtmlForRequestedPosition($this->element, $position);
   297|             }
   298|         }
   299|         return new JsonResponse($data);
   300|     }
   301|     /**
   302|      * @param Workflow $workflow
   303|      *
   304|      * @return string
   305|      *
   306|      * @throws \Exception
   307|      */
   308|     private function getWorkflowSvg(Workflow $workflow)
   309|     {
   310|         $marking = $workflow->getMarking($this->element);
   311|         $php = Console::getExecutable('php');
   312|         $dot = Console::getExecutable('dot');
   313|         if (!$php) {
   314|             throw new \InvalidArgumentException($this->trans('workflow_cmd_not_found', ['php']));
   315|         }
   316|         if (!$dot) {
   317|             throw new \InvalidArgumentException($this->trans('workflow_cmd_not_found', ['dot']));
   318|         }
   319|         $cmd = $php . ' ' . PIMCORE_PROJECT_ROOT . '/bin/console pimcore:workflow:dump ${WNAME} ${WPLACES} | ${DOT} -Tsvg';
   320|         $params = [
   321|             'WNAME' => $workflow->getName(),
   322|             'WPLACES' => implode(' ', array_keys($marking->getPlaces())),
   323|             'DOT' => $dot,
   324|         ];
   325|         Console::addLowProcessPriority($cmd);
   326|         $process = Process::fromShellCommandline($cmd);
   327|         $process->run(null, $params);
   328|         return $process->getOutput();
   329|     }
   330|     /**
   331|      * @param Document|Asset|DataObject $element
   332|      *
   333|      * @return Document|Asset|DataObject
   334|      */
   335|     protected function getLatestVersion($element)
   336|     {
   337|         if (
   338|             $element instanceof Document\Folder
   339|             || $element instanceof Asset\Folder
   340|             || $element instanceof DataObject\Folder
   341|             || $element instanceof Document\Hardlink
   342|             || $element instanceof Document\Link
   343|         ) {
   344|             return $element;
   345|         }
   346|         if ($element instanceof Document\PageSnippet) {
   347|             $latestVersion = $element->getLatestVersion();
   348|             if ($latestVersion) {
   349|                 $latestDoc = $latestVersion->loadData();
   350|                 if ($latestDoc instanceof Document\PageSnippet) {
   351|                     $element = $latestDoc;
   352|                 }
   353|             }
   354|         }
   355|         if ($element instanceof DataObject\Concrete) {
   356|             $latestVersion = $element->getLatestVersion();
   357|             if ($latestVersion) {
   358|                 $latestObj = $latestVersion->loadData();
   359|                 if ($latestObj instanceof ConcreteObject) {
   360|                     $element = $latestObj;
   361|                 }
   362|             }
   363|         }
   364|         return $element;
   365|     }
   366|     /**
   367|      * @param ControllerEvent $event
   368|      *
   369|      * @throws \Exception
   370|      */
   371|     public function onKernelControllerEvent(ControllerEvent $event)
   372|     {
   373|         $isMasterRequest = $event->isMasterRequest();
   374|         if (!$isMasterRequest) {
   375|             return;
   376|         }
   377|         $request = $event->getRequest();
   378|         if ($request->get('ctype') === 'document') {
   379|             $this->element = Document::getById((int) $request->get('cid', 0));
   380|         } elseif ($request->get('ctype') === 'asset') {
   381|             $this->element = Asset::getById((int) $request->get('cid', 0));
   382|         } elseif ($request->get('ctype') === 'object') {
   383|             $this->element = ConcreteObject::getById((int) $request->get('cid', 0));
   384|         }
   385|         if (!$this->element) {
   386|             throw new \Exception('Cannot load element' . $request->get('cid') . ' of type \'' . $request->get('ctype') . '\'');
   387|         }
   388|         $this->element = $this->getLatestVersion($this->element);
   389|         $this->element->setUserModification($this->getAdminUser()->getId());
   390|     }
   391| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/AdminController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-224 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller;
    15| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    16| use Pimcore\Bundle\AdminBundle\Security\User\TokenStorageUserResolver;
    17| use Pimcore\Bundle\AdminBundle\Security\User\User as UserProxy;
    18| use Pimcore\Controller\Controller;
    19| use Pimcore\Extension\Bundle\PimcoreBundleManager;
    20| use Pimcore\Logger;
    21| use Pimcore\Model\User;
    22| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    23| use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;
    24| use Symfony\Component\Serializer\Encoder\DecoderInterface;
    25| use Symfony\Component\Serializer\SerializerInterface;
    26| use Symfony\Component\Translation\Exception\InvalidArgumentException;
    27| use Symfony\Contracts\Translation\TranslatorInterface;
    28| abstract class AdminController extends Controller implements AdminControllerInterface
    29| {
    30|     public static function getSubscribedServices()
    31|     {
    32|         $services = parent::getSubscribedServices();
    33|         $services['translator'] = TranslatorInterface::class;
    34|         $services[TokenStorageUserResolver::class] = TokenStorageUserResolver::class;
    35|         $services[PimcoreBundleManager::class] = PimcoreBundleManager::class;
    36|         $services['pimcore_admin.serializer'] = '?Pimcore\\Admin\\Serializer';
    37|         return $services;
    38|     }
    39|     /**
    40|      * {@inheritdoc}
    41|      */
    42|     public function needsSessionDoubleAuthenticationCheck()
    43|     {
    44|         return true;
    45|     }
    46|     /**
    47|      * {@inheritdoc}
    48|      */
    49|     public function needsStorageDoubleAuthenticationCheck()
    50|     {
    51|         return true;
    52|     }
    53|     /**
    54|      * Get user from user proxy object which is registered on security component
    55|      *
    56|      * @param bool $proxyUser Return the proxy user (UserInterface) instead of the pimcore model
    57|      *
    58|      * @return UserProxy|User|null
    59|      */
    60|     protected function getAdminUser($proxyUser = false)
    61|     {
    62|         $resolver = $this->get(TokenStorageUserResolver::class);
    63|         if ($proxyUser) {
    64|             return $resolver->getUserProxy();
    65|         }
    66|         return $resolver->getUser();
    67|     }
    68|     /**
    69|      * Check user permission
    70|      *
    71|      * @param string $permission
    72|      *
    73|      * @throws AccessDeniedHttpException
    74|      */
    75|     protected function checkPermission($permission)
    76|     {
    77|         if (!$this->getAdminUser() || !$this->getAdminUser()->isAllowed($permission)) {
    78|             Logger::error(
    79|                 'User {user} attempted to access {permission}, but has no permission to do so',
    80|                 [
    81|                     'user' => $this->getAdminUser()->getName(),
    82|                     'permission' => $permission,
    83|                 ]
    84|             );
    85|             throw $this->createAccessDeniedHttpException();
    86|         }
    87|     }
    88|     /**
    89|      * @param string $message
    90|      * @param \Throwable|null $previous
    91|      * @param int $code
    92|      * @param array $headers
    93|      *
    94|      * @return AccessDeniedHttpException
    95|      */
    96|     protected function createAccessDeniedHttpException(string $message = 'Access Denied.', \Throwable $previous = null, int $code = 0, array $headers = []): AccessDeniedHttpException
    97|     {
    98|         return new AccessDeniedHttpException($message, $previous, $code, $headers);
    99|     }
   100|     /**
   101|      * @param string[] $permissions
   102|      */
   103|     protected function checkPermissionsHasOneOf(array $permissions)
   104|     {
   105|         $allowed = false;
   106|         $permission = null;
   107|         foreach ($permissions as $permission) {
   108|             if ($this->getAdminUser()->isAllowed($permission)) {
   109|                 $allowed = true;
   110|                 break;
   111|             }
   112|         }
   113|         if (!$this->getAdminUser() || !$allowed) {
   114|             Logger::error(
   115|                 'User {user} attempted to access {permission}, but has no permission to do so',
   116|                 [
   117|                     'user' => $this->getAdminUser()->getName(),
   118|                     'permission' => $permission,
   119|                 ]
   120|             );
   121|             throw new AccessDeniedHttpException('Attempt to access ' . $permission . ', but has no permission to do so.');
   122|         }
   123|     }
   124|     /**
   125|      * Check permission against all controller actions. Can optionally exclude a list of actions.
   126|      *
   127|      * @param ControllerEvent $event
   128|      * @param string $permission
   129|      * @param array $unrestrictedActions
   130|      */
   131|     protected function checkActionPermission(ControllerEvent $event, string $permission, array $unrestrictedActions = [])
   132|     {
   133|         $actionName = null;
   134|         $controller = $event->getController();
   135|         if (is_array($controller) && count($controller) === 2 && is_string($controller[1])) {
   136|             $actionName = $controller[1];
   137|         }
   138|         if (null === $actionName || !in_array($actionName, $unrestrictedActions)) {
   139|             $this->checkPermission($permission);
   140|         }
   141|     }
   142|     /**
   143|      * Encodes data into JSON string
   144|      *
   145|      * @param mixed $data    The data to be encoded
   146|      * @param array $context Context to pass to serializer when using serializer component
   147|      * @param int $options   Options passed to json_encode
   148|      * @param bool $useAdminSerializer
   149|      *
   150|      * @TODO check if $useAdminSerializer still required?
   151|      *
   152|      * @return string
   153|      */
   154|     protected function encodeJson($data, array $context = [], $options = JsonResponse::DEFAULT_ENCODING_OPTIONS, bool $useAdminSerializer = true)
   155|     {
   156|         /** @var SerializerInterface $serializer */
   157|         $serializer = null;
   158|         if ($useAdminSerializer) {
   159|             $serializer = $this->container->get('pimcore_admin.serializer');
   160|         } else {
   161|             $serializer = $this->container->get('serializer');
   162|         }
   163|         return $serializer->serialize($data, 'json', array_merge([
   164|             'json_encode_options' => $options,
   165|         ], $context));
   166|     }
   167|     /**
   168|      * Decodes a JSON string into an array/object
   169|      *
   170|      * @param mixed $json       The data to be decoded
   171|      * @param bool $associative Whether to decode into associative array or object
   172|      * @param array $context    Context to pass to serializer when using serializer component
   173|      * @param bool $useAdminSerializer
   174|      *
   175|      * @return mixed
   176|      */
   177|     protected function decodeJson($json, $associative = true, array $context = [], bool $useAdminSerializer = true)
   178|     {
   179|         /** @var SerializerInterface|DecoderInterface $serializer */
   180|         $serializer = null;
   181|         if ($useAdminSerializer) {
   182|             $serializer = $this->container->get('pimcore_admin.serializer');
   183|         } else {
   184|             $serializer = $this->container->get('serializer');
   185|         }
   186|         if ($associative) {
   187|             $context['json_decode_associative'] = true;
   188|         }
   189|         return $serializer->decode($json, 'json', $context);
   190|     }
   191|     /**
   192|      * Returns a JsonResponse that uses the admin serializer
   193|      *
   194|      * @param mixed $data    The response data
   195|      * @param int $status    The status code to use for the Response
   196|      * @param array $headers Array of extra headers to add
   197|      * @param array $context Context to pass to serializer when using serializer component
   198|      * @param bool $useAdminSerializer
   199|      *
   200|      * @return JsonResponse
   201|      */
   202|     protected function adminJson($data, $status = 200, $headers = [], $context = [], bool $useAdminSerializer = true)
   203|     {
   204|         $json = $this->encodeJson($data, $context, JsonResponse::DEFAULT_ENCODING_OPTIONS, $useAdminSerializer);
   205|         return new JsonResponse($json, $status, $headers, true);
   206|     }
   207|     /**
   208|      * Translates the given message.
   209|      *
   210|      * @param string $id The message id (may also be an object that can be cast to string)
   211|      * @param array $parameters An array of parameters for the message
   212|      * @param string|null $domain The domain for the message or null to use the default
   213|      * @param string|null $locale The locale or null to use the default
   214|      *
   215|      * @return string The translated string
   216|      *
   217|      * @throws InvalidArgumentException If the locale contains invalid characters
   218|      */
   219|     public function trans($id, array $parameters = [], $domain = 'admin', $locale = null)
   220|     {
   221|         $translator = $this->get('translator');
   222|         return $translator->trans($id, $parameters, $domain, $locale);
   223|     }
   224| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/AdminControllerInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller;
    15| /**
    16|  * Tagging interface defining controller as admin controller.
    17|  */
    18| interface AdminControllerInterface extends DoubleAuthenticationControllerInterface
    19| {
    20| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/BruteforceProtectedControllerInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller;
    15| use Pimcore\Bundle\AdminBundle\EventListener\BruteforceProtectionListener;
    16| /**
    17|  * @internal
    18|  * Tagging interface used to protect certain controllers from brute force attacks
    19|  *
    20|  * @see BruteforceProtectionListener
    21|  */
    22| interface BruteforceProtectedControllerInterface
    23| {
    24| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/DoubleAuthenticationControllerInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller;
    15| /**
    16|  * Controllers implementing this interface will be double-checked for admin authentication.
    17|  *
    18|  * @see AdminAuthenticationDoubleCheckListener
    19|  */
    20| interface DoubleAuthenticationControllerInterface
    21| {
    22|     /**
    23|      * Determines if session should be checked for a valid user in authentication double check
    24|      *
    25|      * @return bool
    26|      */
    27|     public function needsSessionDoubleAuthenticationCheck();
    28|     /**
    29|      * Determines if token storage should be checked for a valid user in authentication double check
    30|      *
    31|      * @return bool
    32|      */
    33|     public function needsStorageDoubleAuthenticationCheck();
    34| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/ExtensionManager/ExtensionManagerController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-424 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\ExtensionManager;
    15| use ForceUTF8\Encoding;
    16| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    17| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    18| use Pimcore\Cache\Symfony\CacheClearer;
    19| use Pimcore\Controller\KernelControllerEventInterface;
    20| use Pimcore\Extension\Bundle\Exception\BundleNotFoundException;
    21| use Pimcore\Extension\Bundle\PimcoreBundleInterface;
    22| use Pimcore\Extension\Bundle\PimcoreBundleManager;
    23| use Pimcore\Extension\Document\Areabrick\AreabrickInterface;
    24| use Pimcore\Extension\Document\Areabrick\AreabrickManagerInterface;
    25| use Pimcore\Logger;
    26| use Pimcore\Routing\RouteReferenceInterface;
    27| use Pimcore\Tool\AssetsInstaller;
    28| use SensioLabs\AnsiConverter\AnsiToHtmlConverter;
    29| use Symfony\Component\HttpFoundation\Request;
    30| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    31| use Symfony\Component\HttpKernel\Exception\BadRequestHttpException;
    32| use Symfony\Component\HttpKernel\KernelInterface;
    33| use Symfony\Component\Process\Exception\ProcessFailedException;
    34| use Symfony\Component\Routing\Annotation\Route;
    35| /**
    36|  * @internal
    37|  */
    38| class ExtensionManagerController extends AdminController implements KernelControllerEventInterface
    39| {
    40|     /**
    41|      * @var PimcoreBundleManager
    42|      */
    43|     private $bundleManager;
    44|     /**
    45|      * @var AreabrickManagerInterface
    46|      */
    47|     private $areabrickManager;
    48|     public function __construct(
    49|         PimcoreBundleManager $bundleManager,
    50|         AreabrickManagerInterface $areabrickManager
    51|     ) {
    52|         $this->bundleManager = $bundleManager;
    53|         $this->areabrickManager = $areabrickManager;
    54|     }
    55|     /**
    56|      * {@inheritdoc}
    57|      */
    58|     public function onKernelControllerEvent(ControllerEvent $event)
    59|     {
    60|         $this->checkPermission('plugins');
    61|     }
    62|     /**
    63|      * @Route("/admin/extensions", name="pimcore_admin_extensionmanager_extensionmanager_getextensions", methods={"GET"})
    64|      *
    65|      * @return JsonResponse
    66|      */
    67|     public function getExtensionsAction()
    68|     {
    69|         $extensions = array_merge(
    70|             $this->getBundleList(),
    71|             $this->getBrickList()
    72|         );
    73|         return $this->adminJson(['extensions' => $extensions]);
    74|     }
    75|     /**
    76|      * Updates bundle options (priority, environments)
    77|      *
    78|      * @Route("/admin/extensions", name="pimcore_admin_extensionmanager_extensionmanager_updateextensions", methods={"PUT"})
    79|      *
    80|      * @param Request $request
    81|      *
    82|      * @return JsonResponse
    83|      */
    84|     public function updateExtensionsAction(Request $request)
    85|     {
    86|         $data = $this->decodeJson($request->getContent());
    87|         if (!is_array($data) || !isset($data['extensions']) || !is_array($data['extensions'])) {
    88|             throw new BadRequestHttpException('Invalid data. Need an array of extensions to update.');
    89|         }
    90|         $updates = [];
    91|         foreach ($data['extensions'] as $row) {
    92|             if (!$row || !is_array($row) || !isset($row['id'])) {
    93|                 throw new BadRequestHttpException('Invalid data. Missing row ID.');
    94|             }
    95|             $id = (string)$row['id'];
    96|             $options = [];
    97|             if (isset($row['environments'])) {
    98|                 $environments = explode(',', $row['environments']);
    99|                 $environments = array_map(function ($item) {
   100|                     return trim((string)$item);
   101|                 }, $environments);
   102|                 $options['environments'] = $environments;
   103|             }
   104|             if (isset($row['priority'])) {
   105|                 $options['priority'] = (int)$row['priority'];
   106|             }
   107|             $updates[$id] = $options;
   108|         }
   109|         $this->bundleManager->setStates($updates);
   110|         return $this->adminJson([
   111|             'extensions' => $this->getBundleList(array_keys($updates)),
   112|         ]);
   113|     }
   114|     /**
   115|      * @Route("/admin/toggle-extension-state", name="pimcore_admin_extensionmanager_extensionmanager_toggleextensionstate", methods={"PUT"})
   116|      *
   117|      * @param Request $request
   118|      * @param KernelInterface $kernel
   119|      * @param AssetsInstaller $assetsInstaller
   120|      *
   121|      * @return JsonResponse
   122|      */
   123|     public function toggleExtensionStateAction(
   124|         Request $request,
   125|         KernelInterface $kernel,
   126|         CacheClearer $cacheClearer,
   127|         AssetsInstaller $assetsInstaller
   128|     ) {
   129|         $type = $request->get('type');
   130|         $id = $request->get('id');
   131|         $enable = $request->get('method', 'enable') === 'enable' ? true : false;
   132|         $reload = false;
   133|         $message = null;
   134|         $data = [
   135|             'success' => true,
   136|             'errors' => [],
   137|         ];
   138|         if ($type === 'bundle') {
   139|             $this->bundleManager->setState($id, ['enabled' => $enable]);
   140|             $reload = true;
   141|             $message = $this->installAssets($assetsInstaller, $enable);
   142|             if (!$kernel->isDebug()) {
   143|                 try {
   144|                     $cacheClearer->clear($kernel->getEnvironment(), [
   145|                         'no-warmup' => true,
   146|                     ]);
   147|                 } catch (\Throwable $e) {
   148|                     $data['errors'][] = $e->getMessage();
   149|                 }
   150|             }
   151|         } elseif ($type === 'areabrick') {
   152|             $this->areabrickManager->setState($id, $enable);
   153|             $reload = true;
   154|         }
   155|         $data['reload'] = $reload;
   156|         if ($message) {
   157|             $data['message'] = $message;
   158|         }
   159|         return $this->adminJson($data);
   160|     }
   161|     /**
   162|      * Runs array:install command and returns its result as array (line-by-line)
   163|      *
   164|      * @param AssetsInstaller $assetsInstaller
   165|      * @param bool $enable
   166|      *
   167|      * @return array
   168|      */
   169|     private function installAssets(AssetsInstaller $assetsInstaller, bool $enable): array
   170|     {
   171|         $message = null;
   172|         try {
   173|             $installProcess = $assetsInstaller->install();
   174|             if ($enable) {
   175|                 $message = str_replace("'", '', $installProcess->getCommandLine()) . PHP_EOL . $installProcess->getOutput();
   176|             }
   177|         } catch (ProcessFailedException $e) {
   178|             $message = 'Failed to run assets:install command. Please run command manually.' . PHP_EOL . PHP_EOL . $e->getMessage();
   179|         }
   180|         if (!$message) {
   181|             return [];
   182|         }
   183|         $message = Encoding::fixUTF8($message);
   184|         $message = (new AnsiToHtmlConverter())->convert($message);
   185|         return explode(PHP_EOL, $message);
   186|     }
   187|     /**
   188|      * @Route("/admin/install", name="pimcore_admin_extensionmanager_extensionmanager_install", methods={"POST"})
   189|      *
   190|      * @param Request $request
   191|      *
   192|      * @return JsonResponse
   193|      */
   194|     public function installAction(Request $request)
   195|     {
   196|         return $this->handleInstallation($request, true);
   197|     }
   198|     /**
   199|      * @Route("/admin/uninstall", name="pimcore_admin_extensionmanager_extensionmanager_uninstall", methods={"POST"})
   200|      *
   201|      * @param Request $request
   202|      *
   203|      * @return JsonResponse
   204|      */
   205|     public function uninstallAction(Request $request)
   206|     {
   207|         return $this->handleInstallation($request, false);
   208|     }
   209|     /**
   210|      * @param Request $request
   211|      * @param bool $install
   212|      *
   213|      * @return JsonResponse
   214|      */
   215|     private function handleInstallation(Request $request, $install = true)
   216|     {
   217|         try {
   218|             $bundle = $this->bundleManager->getActiveBundle($request->get('id'), false);
   219|             if ($install) {
   220|                 $this->bundleManager->install($bundle);
   221|             } else {
   222|                 $this->bundleManager->uninstall($bundle);
   223|             }
   224|             $data = [
   225|                 'success' => true,
   226|                 'reload' => $this->bundleManager->needsReloadAfterInstall($bundle),
   227|             ];
   228|             if (!empty($message = $this->getInstallerOutput($bundle))) {
   229|                 $data['message'] = $message;
   230|             }
   231|             return $this->adminJson($data);
   232|         } catch (BundleNotFoundException $e) {
   233|             return $this->adminJson([
   234|                 'success' => false,
   235|                 'message' => $e->getMessage(),
   236|             ], 404);
   237|         } catch (\Exception $e) {
   238|             return $this->adminJson([
   239|                 'success' => false,
   240|                 'message' => $e->getMessage(),
   241|             ], 400);
   242|         }
   243|     }
   244|     /**
   245|      * @param array $filter
   246|      *
   247|      * @return array
   248|      */
   249|     private function getBundleList(array $filter = [])
   250|     {
   251|         $bm = $this->bundleManager;
   252|         $results = [];
   253|         foreach ($bm->getEnabledBundleNames() as $className) {
   254|             try {
   255|                 $bundle = $bm->getActiveBundle($className, false);
   256|                 $results[$bm->getBundleIdentifier($bundle)] = $this->buildBundleInfo($bundle, true, $bm->isInstalled($bundle));
   257|             } catch (\Throwable $e) {
   258|                 Logger::error($e);
   259|             }
   260|         }
   261|         foreach ($bm->getAvailableBundles() as $className) {
   262|             if (array_key_exists($className, $results)) {
   263|                 continue;
   264|             }
   265|             $bundle = $this->buildBundleInstance($className);
   266|             if ($bundle) {
   267|                 $results[$bm->getBundleIdentifier($bundle)] = $this->buildBundleInfo($bundle);
   268|             }
   269|         }
   270|         $results = array_values($results);
   271|         if (count($filter) > 0) {
   272|             $results = array_filter($results, function (array $item) use ($filter) {
   273|                 return in_array($item['id'], $filter);
   274|             });
   275|         }
   276|         usort($results, function ($a, $b) {
   277|             if ($a['active'] && !$b['active']) {
   278|                 return -1;
   279|             }
   280|             if (!$a['active'] && $b['active']) {
   281|                 return 1;
   282|             }
   283|             if ($a['active'] === $b['active']) {
   284|                 if ($a['priority'] === $b['priority']) {
   285|                     return 0;
   286|                 }
   287|                 return $a['priority'] < $b['priority'] ? 1 : -1;
   288|             }
   289|         });
   290|         return $results;
   291|     }
   292|     /**
   293|      * @param string $bundleName
   294|      *
   295|      * @return PimcoreBundleInterface|null
   296|      */
   297|     private function buildBundleInstance($bundleName)
   298|     {
   299|         try {
   300|             /** @var PimcoreBundleInterface $bundle */
   301|             $bundle = new $bundleName();
   302|             $bundle->setContainer(\Pimcore::getContainer());
   303|             return $bundle;
   304|         } catch (\Exception $e) {
   305|             Logger::error('Failed to build instance of bundle {bundle}: {error}', [
   306|                 'bundle' => $bundleName,
   307|                 'error' => $e->getMessage(),
   308|             ]);
   309|         }
   310|         return null;
   311|     }
   312|     /**
   313|      * @param PimcoreBundleInterface $bundle
   314|      * @param bool $enabled
   315|      * @param bool $installed
   316|      *
   317|      * @return array
   318|      */
   319|     private function buildBundleInfo(PimcoreBundleInterface $bundle, $enabled = false, $installed = false)
   320|     {
   321|         $bm = $this->bundleManager;
   322|         $state = $bm->getState($bundle);
   323|         $info = [
   324|             'id' => $bm->getBundleIdentifier($bundle),
   325|             'type' => 'bundle',
   326|             'name' => !empty($bundle->getNiceName()) ? $bundle->getNiceName() : $bundle->getName(),
   327|             'active' => $enabled,
   328|             'installable' => false,
   329|             'uninstallable' => false,
   330|             'installed' => $installed,
   331|             'canChangeState' => $bm->canChangeState($bundle),
   332|             'configuration' => $this->getIframePath($bundle),
   333|             'version' => $bundle->getVersion(),
   334|             'priority' => $state['priority'],
   335|             'environments' => implode(', ', $state['environments']),
   336|         ];
   337|         if ($enabled) {
   338|             $info = array_merge($info, [
   339|                 'installable' => $bm->canBeInstalled($bundle),
   340|                 'uninstallable' => $bm->canBeUninstalled($bundle),
   341|             ]);
   342|         }
   343|         $description = $bundle->getDescription();
   344|         if (!empty($installerOutput = $this->getInstallerOutput($bundle))) {
   345|             if (!empty($description)) {
   346|                 $description = $description . '. ';
   347|             }
   348|             $description .= $installerOutput;
   349|         }
   350|         $info['description'] = $description;
   351|         return $info;
   352|     }
   353|     /**
   354|      * @param PimcoreBundleInterface $bundle
   355|      *
   356|      * @return string|null
   357|      */
   358|     private function getIframePath(PimcoreBundleInterface $bundle)
   359|     {
   360|         if ($iframePath = $bundle->getAdminIframePath()) {
   361|             if ($iframePath instanceof RouteReferenceInterface) {
   362|                 return $this->generateUrl(
   363|                     $iframePath->getRoute(),
   364|                     $iframePath->getParameters(),
   365|                     $iframePath->getType()
   366|                 );
   367|             }
   368|             if (!empty($iframePath)) {
   369|                 return $iframePath;
   370|             }
   371|         }
   372|         return null;
   373|     }
   374|     /**
   375|      * @return array
   376|      */
   377|     private function getBrickList()
   378|     {
   379|         $results = [];
   380|         foreach ($this->areabrickManager->getBricks() as $brick) {
   381|             $results[] = $this->buildBrickInfo($brick);
   382|         }
   383|         return $results;
   384|     }
   385|     /**
   386|      * @param AreabrickInterface $brick
   387|      *
   388|      * @return array
   389|      */
   390|     private function buildBrickInfo(AreabrickInterface $brick)
   391|     {
   392|         return [
   393|             'id' => $brick->getId(),
   394|             'type' => 'areabrick',
   395|             'name' => $this->trans($brick->getName()),
   396|             'description' => $this->trans($brick->getDescription()),
   397|             'installable' => false,
   398|             'uninstallable' => false,
   399|             'installed' => true,
   400|             'active' => $this->areabrickManager->isEnabled($brick->getId()),
   401|             'version' => $brick->getVersion(),
   402|         ];
   403|     }
   404|     private function getInstallerOutput(PimcoreBundleInterface $bundle, bool $decorated = false)
   405|     {
   406|         if (!$this->bundleManager->isEnabled($bundle)) {
   407|             return null;
   408|         }
   409|         $installer = $this->bundleManager->getInstaller($bundle);
   410|         if (null !== $installer) {
   411|             /** @var \Symfony\Component\Console\Output\BufferedOutput $output */
   412|             $output = $installer->getOutput();
   413|             if (!empty($output)) {
   414|                 $converter = new AnsiToHtmlConverter(null);
   415|                 $converted = Encoding::fixUTF8($output->fetch());
   416|                 $converted = $converter->convert($converted);
   417|                 if (!$decorated) {
   418|                     $converted = strip_tags($converted);
   419|                 }
   420|                 return $converted;
   421|             }
   422|         }
   423|     }
   424| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/GDPR/AdminController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\Controller\GDPR;
    16| use Pimcore\Bundle\AdminBundle\GDPR\DataProvider\Manager;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    19| use Symfony\Component\Routing\Annotation\Route;
    20| /**
    21|  *
    22|  * @internal
    23|  */
    24| class AdminController extends \Pimcore\Bundle\AdminBundle\Controller\AdminController implements KernelControllerEventInterface
    25| {
    26|     /**
    27|      * @Route("/get-data-providers", name="pimcore_admin_gdpr_admin_getdataproviders", methods={"GET"})
    28|      */
    29|     public function getDataProvidersAction(Manager $manager)
    30|     {
    31|         $response = [];
    32|         foreach ($manager->getServices() as $service) {
    33|             $response[] = [
    34|                 'name' => $service->getName(),
    35|                 'jsClass' => $service->getJsClassName(),
    36|             ];
    37|         }
    38|         return $this->adminJson($response);
    39|     }
    40|     /**
    41|      * {@inheritdoc}
    42|      */
    43|     public function onKernelControllerEvent(ControllerEvent $event)
    44|     {
    45|         if (!$event->isMasterRequest()) {
    46|             return;
    47|         }
    48|         $this->checkActionPermission($event, 'gdpr_data_extractor');
    49|     }
    50| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/GDPR/AssetController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-84 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\GDPR;
    15| use Pimcore\Bundle\AdminBundle\GDPR\DataProvider\Assets;
    16| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\HttpFoundation\Response;
    20| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    21| use Symfony\Component\Routing\Annotation\Route;
    22| /**
    23|  * Class AssetController
    24|  *
    25|  * @Route("/asset")
    26|  *
    27|  * @package GDPRDataExtractorBundle\Controller
    28|  *
    29|  * @internal
    30|  */
    31| class AssetController extends \Pimcore\Bundle\AdminBundle\Controller\AdminController implements KernelControllerEventInterface
    32| {
    33|     /**
    34|      * {@inheritdoc}
    35|      */
    36|     public function onKernelControllerEvent(ControllerEvent $event)
    37|     {
    38|         $isMasterRequest = $event->isMasterRequest();
    39|         if (!$isMasterRequest) {
    40|             return;
    41|         }
    42|         $this->checkActionPermission($event, 'gdpr_data_extractor');
    43|     }
    44|     /**
    45|      * @Route("/search-assets", name="pimcore_admin_gdpr_asset_searchasset", methods={"GET"})
    46|      *
    47|      * @param Request $request
    48|      *
    49|      * @return JsonResponse
    50|      */
    51|     public function searchAssetAction(Request $request, Assets $service)
    52|     {
    53|         $allParams = array_merge($request->request->all(), $request->query->all());
    54|         $result = $service->searchData(
    55|             (int)$allParams['id'],
    56|             strip_tags($allParams['firstname']),
    57|             strip_tags($allParams['lastname']),
    58|             strip_tags($allParams['email']),
    59|             (int)$allParams['start'],
    60|             (int)$allParams['limit'],
    61|             $allParams['sort'] ?? null
    62|         );
    63|         return $this->adminJson($result);
    64|     }
    65|     /**
    66|      * @Route("/export", name="pimcore_admin_gdpr_asset_exportassets", methods={"GET"})
    67|      *
    68|      * @param Request $request
    69|      * @param Assets $service
    70|      *
    71|      * @return Response
    72|      *
    73|      * @throws \Exception
    74|      */
    75|     public function exportAssetsAction(Request $request, Assets $service)
    76|     {
    77|         $asset = \Pimcore\Model\Asset::getById($request->get('id'));
    78|         if (!$asset->isAllowed('view')) {
    79|             throw new \Exception('export denied');
    80|         }
    81|         $exportResult = $service->doExportData($asset);
    82|         return $exportResult;
    83|     }
    84| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/GDPR/DataObjectController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\GDPR;
    15| use Pimcore\Bundle\AdminBundle\GDPR\DataProvider\DataObjects;
    16| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Pimcore\Model\DataObject;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    21| use Symfony\Component\Routing\Annotation\Route;
    22| /**
    23|  * Class DataObjectController
    24|  *
    25|  * @Route("/data-object")
    26|  *
    27|  * @internal
    28|  */
    29| class DataObjectController extends \Pimcore\Bundle\AdminBundle\Controller\AdminController implements KernelControllerEventInterface
    30| {
    31|     /**
    32|      * {@inheritdoc}
    33|      */
    34|     public function onKernelControllerEvent(ControllerEvent $event)
    35|     {
    36|         $isMasterRequest = $event->isMasterRequest();
    37|         if (!$isMasterRequest) {
    38|             return;
    39|         }
    40|         $this->checkActionPermission($event, 'gdpr_data_extractor');
    41|     }
    42|     /**
    43|      * @Route("/search-data-objects", name="pimcore_admin_gdpr_dataobject_searchdataobjects", methods={"GET"})
    44|      *
    45|      * @param Request $request
    46|      *
    47|      * @return JsonResponse
    48|      */
    49|     public function searchDataObjectsAction(Request $request, DataObjects $service)
    50|     {
    51|         $allParams = array_merge($request->request->all(), $request->query->all());
    52|         $result = $service->searchData(
    53|             (int)$allParams['id'],
    54|             strip_tags($allParams['firstname']),
    55|             strip_tags($allParams['lastname']),
    56|             strip_tags($allParams['email']),
    57|             (int)$allParams['start'],
    58|             (int)$allParams['limit'],
    59|             $allParams['sort'] ?? null
    60|         );
    61|         return $this->adminJson($result);
    62|     }
    63|     /**
    64|      * @Route("/export", name="pimcore_admin_gdpr_dataobject_exportdataobject", methods={"GET"})
    65|      *
    66|      * @param Request $request
    67|      *
    68|      * @return JsonResponse
    69|      *
    70|      * @throws \Exception
    71|      */
    72|     public function exportDataObjectAction(Request $request, DataObjects $service)
    73|     {
    74|         $object = DataObject::getById($request->get('id'));
    75|         if (!$object->isAllowed('view')) {
    76|             throw new \Exception('export denied');
    77|         }
    78|         $exportResult = $service->doExportData($object);
    79|         $json = $this->encodeJson($exportResult, [], JsonResponse::DEFAULT_ENCODING_OPTIONS | JSON_PRETTY_PRINT);
    80|         $jsonResponse = new JsonResponse($json, 200, [
    81|             'Content-Disposition' => 'attachment; filename="export-data-object-' . $object->getId() . '.json"',
    82|         ], true);
    83|         return $jsonResponse;
    84|     }
    85| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/GDPR/PimcoreUsersController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-81 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\GDPR;
    15| use Pimcore\Bundle\AdminBundle\GDPR\DataProvider\PimcoreUsers;
    16| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    17| use Pimcore\Controller\KernelControllerEventInterface;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| /**
    22|  * Class PimcoreUsersController
    23|  *
    24|  * @Route("/pimcore-users")
    25|  *
    26|  * @internal
    27|  */
    28| class PimcoreUsersController extends \Pimcore\Bundle\AdminBundle\Controller\AdminController implements KernelControllerEventInterface
    29| {
    30|     /**
    31|      * {@inheritdoc}
    32|      */
    33|     public function onKernelControllerEvent(ControllerEvent $event)
    34|     {
    35|         $isMasterRequest = $event->isMasterRequest();
    36|         if (!$isMasterRequest) {
    37|             return;
    38|         }
    39|         $this->checkActionPermission($event, 'gdpr_data_extractor');
    40|     }
    41|     /**
    42|      * @Route("/search-users", name="pimcore_admin_gdpr_pimcoreusers_searchusers", methods={"GET"})
    43|      *
    44|      * @param Request $request
    45|      * @param PimcoreUsers $pimcoreUsers
    46|      *
    47|      * @return JsonResponse
    48|      */
    49|     public function searchUsersAction(Request $request, PimcoreUsers $pimcoreUsers)
    50|     {
    51|         $allParams = array_merge($request->request->all(), $request->query->all());
    52|         $result = $pimcoreUsers->searchData(
    53|             (int)$allParams['id'],
    54|             strip_tags($allParams['firstname']),
    55|             strip_tags($allParams['lastname']),
    56|             strip_tags($allParams['email']),
    57|             (int)$allParams['start'],
    58|             (int)$allParams['limit'],
    59|             $allParams['sort'] ?? null
    60|         );
    61|         return $this->adminJson($result);
    62|     }
    63|     /**
    64|      * @Route("/export-user-data", name="pimcore_admin_gdpr_pimcoreusers_exportuserdata", methods={"GET"})
    65|      *
    66|      * @param Request $request
    67|      * @param PimcoreUsers $pimcoreUsers
    68|      *
    69|      * @return \Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse
    70|      */
    71|     public function exportUserDataAction(Request $request, PimcoreUsers $pimcoreUsers)
    72|     {
    73|         $this->checkPermission('users');
    74|         $userData = $pimcoreUsers->getExportData((int)$request->get('id'));
    75|         $json = $this->encodeJson($userData, [], JsonResponse::DEFAULT_ENCODING_OPTIONS | JSON_PRETTY_PRINT);
    76|         $jsonResponse = new JsonResponse($json, 200, [
    77|             'Content-Disposition' => 'attachment; filename="export-userdata-' . $userData['id'] . '.json"',
    78|         ], true);
    79|         return $jsonResponse;
    80|     }
    81| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/GDPR/SentMailController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\GDPR;
    15| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    16| use Pimcore\Controller\KernelControllerEventInterface;
    17| use Pimcore\Model\Tool\Email\Log;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| /**
    22|  * Class SentMailController
    23|  *
    24|  * @Route("/sent-mail")
    25|  *
    26|  * @internal
    27|  */
    28| class SentMailController extends \Pimcore\Bundle\AdminBundle\Controller\AdminController implements KernelControllerEventInterface
    29| {
    30|     /**
    31|      * {@inheritdoc}
    32|      */
    33|     public function onKernelControllerEvent(ControllerEvent $event)
    34|     {
    35|         $isMasterRequest = $event->isMasterRequest();
    36|         if (!$isMasterRequest) {
    37|             return;
    38|         }
    39|         $this->checkActionPermission($event, 'gdpr_data_extractor');
    40|     }
    41|     /**
    42|      * @Route("/export", name="pimcore_admin_gdpr_sentmail_exportdataobject", methods={"GET"})
    43|      *
    44|      * @param Request $request
    45|      *
    46|      * @return JsonResponse
    47|      */
    48|     public function exportDataObjectAction(Request $request)
    49|     {
    50|         $this->checkPermission('emails');
    51|         $sentMail = Log::getById($request->get('id'));
    52|         $sentMailArray = (array)$sentMail;
    53|         $sentMailArray['htmlBody'] = $sentMail->getHtmlLog();
    54|         $sentMailArray['textBody'] = $sentMail->getTextLog();
    55|         $json = $this->encodeJson($sentMailArray, [], JsonResponse::DEFAULT_ENCODING_OPTIONS | JSON_PRETTY_PRINT);
    56|         $jsonResponse = new JsonResponse($json, 200, [
    57|             'Content-Disposition' => 'attachment; filename="export-mail-' . $sentMail->getId() . '.json"',
    58|         ], true);
    59|         return $jsonResponse;
    60|     }
    61| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Reports/AnalyticsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-438 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Reports;
    15| use Pimcore\Analytics\Google\Config\SiteConfigProvider;
    16| use Pimcore\Controller\KernelControllerEventInterface;
    17| use Pimcore\Google;
    18| use Pimcore\Model\Document;
    19| use Pimcore\Model\Site;
    20| use Symfony\Component\HttpFoundation\JsonResponse;
    21| use Symfony\Component\HttpFoundation\RedirectResponse;
    22| use Symfony\Component\HttpFoundation\Request;
    23| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    24| use Symfony\Component\Routing\Annotation\Route;
    25| /**
    26|  * @Route("/analytics")
    27|  *
    28|  * @internal
    29|  */
    30| class AnalyticsController extends ReportsControllerBase implements KernelControllerEventInterface
    31| {
    32|     /**
    33|      * @var \Google_Service_Analytics
    34|      */
    35|     protected $service;
    36|     /**
    37|      * @Route("/deeplink", name="pimcore_admin_reports_analytics_deeplink", methods={"GET"})
    38|      *
    39|      * @param Request $request
    40|      *
    41|      * @return RedirectResponse
    42|      */
    43|     public function deeplinkAction(Request $request, SiteConfigProvider $siteConfigProvider)
    44|     {
    45|         $config = $siteConfigProvider->getSiteConfig();
    46|         $url = $request->get('url');
    47|         $url = str_replace(['{accountId}', '{internalWebPropertyId}', '{id}'], [$config->accountid, $config->internalid, $config->profile], $url);
    48|         $url = 'https://www.google.com/analytics/web/' . $url;
    49|         return $this->redirect($url);
    50|     }
    51|     /**
    52|      * @Route("/get-profiles", name="pimcore_admin_reports_analytics_getprofiles", methods={"GET"})
    53|      *
    54|      * @param Request $request
    55|      *
    56|      * @return JsonResponse
    57|      */
    58|     public function getProfilesAction(Request $request)
    59|     {
    60|         try {
    61|             $data = ['data' => []];
    62|             $result = $this->service->management_accounts->listManagementAccounts();
    63|             $accountIds = [];
    64|             if (is_array($result['items'])) {
    65|                 foreach ($result['items'] as $account) {
    66|                     $accountIds[] = $account['id'];
    67|                 }
    68|             }
    69|             foreach ($accountIds as $accountId) {
    70|                 $propertyNames = [];
    71|                 $properties = $this->service->management_webproperties->listManagementWebproperties($accountId);
    72|                 if (is_array($properties['items'])) {
    73|                     foreach ($properties['items'] as $property) {
    74|                         $propertyNames[$property['id']] = $property['name'];
    75|                     }
    76|                 }
    77|                 $details = $this->service->management_profiles->listManagementProfiles($accountId, '~all');
    78|                 if (is_array($details['items'])) {
    79|                     foreach ($details['items'] as $detail) {
    80|                         $name = $detail['name'];
    81|                         if (array_key_exists($detail['webPropertyId'], $propertyNames)) {
    82|                             $name = $propertyNames[$detail['webPropertyId']] . ': ' . $name;
    83|                         }
    84|                         $data['data'][] = [
    85|                             'id' => $detail['id'],
    86|                             'name' => $name,
    87|                             'trackid' => $detail['webPropertyId'],
    88|                             'internalid' => $detail['internalWebPropertyId'],
    89|                             'accountid' => $detail['accountId'],
    90|                         ];
    91|                     }
    92|                 }
    93|             }
    94|             return $this->adminJson($data);
    95|         } catch (\Exception $e) {
    96|             return $this->adminJson(false);
    97|         }
    98|     }
    99|     /**
   100|      * @param Request $request
   101|      *
   102|      * @return \Pimcore\Model\Site|null
   103|      */
   104|     private function getSite(Request $request)
   105|     {
   106|         $siteId = $request->get('site');
   107|         return Site::getById($siteId);
   108|     }
   109|     /**
   110|      * @param Request $request
   111|      *
   112|      * @return mixed|string
   113|      */
   114|     protected function getFilterPath(Request $request)
   115|     {
   116|         if ($request->get('type') == 'document' && $request->get('id')) {
   117|             $doc = Document::getById($request->get('id'));
   118|             $path = $doc->getFullPath();
   119|             if ($doc instanceof Document\Page && $doc->getPrettyUrl()) {
   120|                 $path = $doc->getPrettyUrl();
   121|             }
   122|             if ($request->get('site')) {
   123|                 $site = Site::getById($request->get('site'));
   124|                 $path = preg_replace('@^' . preg_quote($site->getRootPath(), '@') . '/@', '/', $path);
   125|             }
   126|             return $path;
   127|         }
   128|         return $request->get('path');
   129|     }
   130|     /**
   131|      * @Route("/chartmetricdata", name="pimcore_admin_reports_analytics_chartmetricdata", methods={"GET"})
   132|      *
   133|      * @param Request $request
   134|      * @param SiteConfigProvider $siteConfigProvider
   135|      *
   136|      * @return JsonResponse
   137|      */
   138|     public function chartmetricdataAction(Request $request, SiteConfigProvider $siteConfigProvider)
   139|     {
   140|         $config = $siteConfigProvider->getSiteConfig($this->getSite($request));
   141|         $startDate = date('Y-m-d', (time() - (86400 * 31)));
   142|         $endDate = date('Y-m-d');
   143|         if ($request->get('dateFrom') && $request->get('dateTo')) {
   144|             $startDate = date('Y-m-d', strtotime($request->get('dateFrom')));
   145|             $endDate = date('Y-m-d', strtotime($request->get('dateTo')));
   146|         }
   147|         $metrics = ['ga:pageviews'];
   148|         if ($request->get('metric')) {
   149|             $metrics = [];
   150|             if (is_array($request->get('metric'))) {
   151|                 foreach ($request->get('metric') as $m) {
   152|                     $metrics[] = 'ga:' . $m;
   153|                 }
   154|             } else {
   155|                 $metrics[] = 'ga:' . $request->get('metric');
   156|             }
   157|         }
   158|         $filters = [];
   159|         if ($filterPath = $this->getFilterPath($request)) {
   160|             $filters[] = 'ga:pagePath=='.$filterPath;
   161|         }
   162|         if ($request->get('filters')) {
   163|             $filters[] = $request->get('filters');
   164|         }
   165|         $opts = [
   166|             'dimensions' => 'ga:date',
   167|         ];
   168|         if (!empty($filters)) {
   169|             $opts['filters'] = implode(';', $filters);
   170|         }
   171|         $result = $this->service->data_ga->get(
   172|             'ga:' . $config->profile,
   173|             $startDate,
   174|             $endDate,
   175|             implode(',', $metrics),
   176|             $opts
   177|         );
   178|         $data = [];
   179|         foreach ($result['rows'] as $row) {
   180|             $date = $row[0];
   181|             $tmpData = [
   182|                 'timestamp' => strtotime($date),
   183|                 'datetext' => $this->formatDimension('date', $date),
   184|             ];
   185|             foreach ($result['columnHeaders'] as $index => $metric) {
   186|                 if (!$request->get('dataField')) {
   187|                     $tmpData[str_replace('ga:', '', $metric['name'])] = $row[$index];
   188|                 } else {
   189|                     $tmpData[$request->get('dataField')] = $row[$index];
   190|                 }
   191|             }
   192|             $data[] = $tmpData;
   193|         }
   194|         return $this->adminJson(['data' => $data]);
   195|     }
   196|     /**
   197|      * @Route("/summary", name="pimcore_admin_reports_analytics_summary", methods={"GET"})
   198|      *
   199|      * @param Request $request
   200|      * @param SiteConfigProvider $siteConfigProvider
   201|      *
   202|      * @return JsonResponse
   203|      */
   204|     public function summaryAction(Request $request, SiteConfigProvider $siteConfigProvider)
   205|     {
   206|         $config = $siteConfigProvider->getSiteConfig($this->getSite($request));
   207|         $startDate = date('Y-m-d', (time() - (86400 * 31)));
   208|         $endDate = date('Y-m-d');
   209|         if ($request->get('dateFrom') && $request->get('dateTo')) {
   210|             $startDate = date('Y-m-d', strtotime($request->get('dateFrom')));
   211|             $endDate = date('Y-m-d', strtotime($request->get('dateTo')));
   212|         }
   213|         if ($filterPath = $this->getFilterPath($request)) {
   214|             $filters[] = 'ga:pagePath=='.$filterPath;
   215|         }
   216|         $opts = [
   217|             'dimensions' => 'ga:date',
   218|         ];
   219|         if (!empty($filters)) {
   220|             $opts['filters'] = implode(';', $filters);
   221|         }
   222|         $result = $this->service->data_ga->get(
   223|             'ga:' . $config->profile,
   224|             $startDate,
   225|             $endDate,
   226|             'ga:uniquePageviews,ga:pageviews,ga:exits,ga:bounces,ga:entrances',
   227|             $opts
   228|         );
   229|         $data = [];
   230|         $dailyDataGrouped = [];
   231|         foreach ($result['rows'] as $row) {
   232|             foreach ($result['columnHeaders'] as $index => $metric) {
   233|                 if ($index) {
   234|                     $dailyDataGrouped[$metric['name']][] = $row[$index];
   235|                     if (!isset($data[$metric['name']])) {
   236|                         $data[$metric['name']] = 0;
   237|                     }
   238|                     $data[$metric['name']] += $row[$index];
   239|                 }
   240|             }
   241|         }
   242|         $order = [
   243|             'ga:pageviews' => 0,
   244|             'ga:uniquePageviews' => 1,
   245|             'ga:exits' => 2,
   246|             'ga:entrances' => 3,
   247|             'ga:bounces' => 4,
   248|         ];
   249|         $outputData = [];
   250|         foreach ($data as $key => $value) {
   251|             $outputData[$order[$key]] = [
   252|                 'label' => str_replace('ga:', '', $key),
   253|                 'value' => round($value, 2),
   254|                 'chart' => \Pimcore\Helper\ImageChart::lineSmall($dailyDataGrouped[$key]),
   255|                 'metric' => str_replace('ga:', '', $key),
   256|             ];
   257|         }
   258|         ksort($outputData);
   259|         return $this->adminJson(['data' => $outputData]);
   260|     }
   261|     /**
   262|      * @Route("/source", name="pimcore_admin_reports_analytics_source", methods={"GET"})
   263|      *
   264|      * @param Request $request
   265|      * @param SiteConfigProvider $siteConfigProvider
   266|      *
   267|      * @return JsonResponse
   268|      */
   269|     public function sourceAction(Request $request, SiteConfigProvider $siteConfigProvider)
   270|     {
   271|         $config = $siteConfigProvider->getSiteConfig($this->getSite($request));
   272|         $startDate = date('Y-m-d', (time() - (86400 * 31)));
   273|         $endDate = date('Y-m-d');
   274|         if ($request->get('dateFrom') && $request->get('dateTo')) {
   275|             $startDate = date('Y-m-d', strtotime($request->get('dateFrom')));
   276|             $endDate = date('Y-m-d', strtotime($request->get('dateTo')));
   277|         }
   278|         if ($filterPath = $this->getFilterPath($request)) {
   279|             $filters[] = 'ga:pagePath=='.$filterPath;
   280|         }
   281|         $opts = [
   282|             'dimensions' => 'ga:source',
   283|             'max-results' => '10',
   284|             'sort' => '-ga:pageviews',
   285|         ];
   286|         if (!empty($filters)) {
   287|             $opts['filters'] = implode(';', $filters);
   288|         }
   289|         $result = $this->service->data_ga->get(
   290|             'ga:' . $config->profile,
   291|             $startDate,
   292|             $endDate,
   293|             'ga:pageviews',
   294|             $opts
   295|         );
   296|         $data = [];
   297|         foreach ((array) $result['rows'] as $row) {
   298|             $data[] = [
   299|                 'pageviews' => $row[1],
   300|                 'source' => $row[0],
   301|             ];
   302|         }
   303|         return $this->adminJson(['data' => $data]);
   304|     }
   305|     /**
   306|      * @Route("/data-explorer", name="pimcore_admin_reports_analytics_dataexplorer", methods={"GET", "POST"})
   307|      *
   308|      * @param Request $request
   309|      * @param SiteConfigProvider $siteConfigProvider
   310|      *
   311|      * @return JsonResponse
   312|      */
   313|     public function dataExplorerAction(Request $request, SiteConfigProvider $siteConfigProvider)
   314|     {
   315|         $config = $siteConfigProvider->getSiteConfig($this->getSite($request));
   316|         $startDate = date('Y-m-d', (time() - (86400 * 31)));
   317|         $endDate = date('Y-m-d');
   318|         $metric = 'ga:pageviews';
   319|         $dimension = 'ga:date';
   320|         $descending = true;
   321|         $limit = 10;
   322|         if ($request->get('dateFrom') && $request->get('dateTo')) {
   323|             $startDate = date('Y-m-d', strtotime($request->get('dateFrom')));
   324|             $endDate = date('Y-m-d', strtotime($request->get('dateTo')));
   325|         }
   326|         if ($request->get('dimension')) {
   327|             $dimension = $request->get('dimension');
   328|         }
   329|         if ($request->get('metric')) {
   330|             $metric = $request->get('metric');
   331|         }
   332|         if ($request->get('sort')) {
   333|             if ($request->get('sort') == 'asc') {
   334|                 $descending = false;
   335|             }
   336|         }
   337|         if ($request->get('limit')) {
   338|             $limit = $request->get('limit');
   339|         }
   340|         if ($filterPath = $this->getFilterPath($request)) {
   341|             $filters[] = 'ga:pagePath=='.$filterPath;
   342|         }
   343|         $opts = [
   344|             'dimensions' => $dimension,
   345|             'max-results' => $limit,
   346|             'sort' => ($descending ? '-' : '') . $metric,
   347|         ];
   348|         if (!empty($filters)) {
   349|             $opts['filters'] = implode(';', $filters);
   350|         }
   351|         $result = $this->service->data_ga->get(
   352|             'ga:' . $config->profile,
   353|             $startDate,
   354|             $endDate,
   355|             $metric,
   356|             $opts
   357|         );
   358|         $data = [];
   359|         foreach ($result['rows'] as $row) {
   360|             $data[] = [
   361|                 'dimension' => $this->formatDimension($dimension, $row[0]),
   362|                 'metric' => (float) $row[1],
   363|             ];
   364|         }
   365|         return $this->adminJson(['data' => $data]);
   366|     }
   367|     /**
   368|      * @Route("/get-dimensions", name="pimcore_admin_reports_analytics_getdimensions", methods={"GET"})
   369|      *
   370|      * @param Request $request
   371|      *
   372|      * @return JsonResponse
   373|      */
   374|     public function getDimensionsAction(Request $request)
   375|     {
   376|         return $this->adminJson(['data' => Google\Api::getAnalyticsDimensions()]);
   377|     }
   378|     /**
   379|      * @Route("/get-metrics", name="pimcore_admin_reports_analytics_getmetrics", methods={"GET"})
   380|      *
   381|      * @param Request $request
   382|      *
   383|      * @return JsonResponse
   384|      */
   385|     public function getMetricsAction(Request $request)
   386|     {
   387|         return $this->adminJson(['data' => Google\Api::getAnalyticsMetrics()]);
   388|     }
   389|     /**
   390|      * @Route("/get-segments", name="pimcore_admin_reports_analytics_getsegments", methods={"GET"})
   391|      *
   392|      * @param Request $request
   393|      *
   394|      * @return JsonResponse
   395|      */
   396|     public function getSegmentsAction(Request $request)
   397|     {
   398|         $result = $this->service->management_segments->listManagementSegments();
   399|         $data = [];
   400|         foreach ($result['items'] as $row) {
   401|             $data[] = [
   402|                 'id' => $row['segmentId'],
   403|                 'name' => $row['name'],
   404|             ];
   405|         }
   406|         return $this->adminJson(['data' => $data]);
   407|     }
   408|     /**
   409|      * @param string $type
   410|      * @param string $value
   411|      *
   412|      * @return string
   413|      */
   414|     protected function formatDimension($type, $value)
   415|     {
   416|         if (strpos($type, 'date') !== false) {
   417|             $date = new \DateTime();
   418|             $date->setTimestamp(strtotime($value));
   419|             return $date->format('Y-m-d');
   420|         }
   421|         return $value;
   422|     }
   423|     /**
   424|      * {@inheritdoc}
   425|      */
   426|     public function onKernelControllerEvent(ControllerEvent $event)
   427|     {
   428|         $isMasterRequest = $event->isMasterRequest();
   429|         if (!$isMasterRequest) {
   430|             return;
   431|         }
   432|         $client = Google\Api::getServiceClient();
   433|         if (!$client) {
   434|             die('Google Analytics is not configured');
   435|         }
   436|         $this->service = new \Google_Service_Analytics($client);
   437|     }
   438| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Reports/CustomReportController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-381 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Reports;
    15| use Pimcore\Model\Tool\CustomReport;
    16| use Symfony\Component\Filesystem\Exception\FileNotFoundException;
    17| use Symfony\Component\HttpFoundation\BinaryFileResponse;
    18| use Symfony\Component\HttpFoundation\JsonResponse;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\HttpFoundation\ResponseHeaderBag;
    21| use Symfony\Component\Routing\Annotation\Route;
    22| /**
    23|  * @Route("/custom-report")
    24|  *
    25|  * @internal
    26|  */
    27| class CustomReportController extends ReportsControllerBase
    28| {
    29|     /**
    30|      * @Route("/tree", name="pimcore_admin_reports_customreport_tree", methods={"GET", "POST"})
    31|      *
    32|      * @param Request $request
    33|      *
    34|      * @return JsonResponse
    35|      */
    36|     public function treeAction(Request $request)
    37|     {
    38|         $this->checkPermission('reports_config');
    39|         $reports = CustomReport\Config::getReportsList();
    40|         return $this->adminJson($reports);
    41|     }
    42|     /**
    43|      * @Route("/portlet-report-list", name="pimcore_admin_reports_customreport_portletreportlist", methods={"GET", "POST"})
    44|      *
    45|      * @param Request $request
    46|      *
    47|      * @return JsonResponse
    48|      */
    49|     public function portletReportListAction(Request $request)
    50|     {
    51|         $this->checkPermission('reports');
    52|         $reports = CustomReport\Config::getReportsList($this->getAdminUser());
    53|         return $this->adminJson(['data' => $reports]);
    54|     }
    55|     /**
    56|      * @Route("/add", name="pimcore_admin_reports_customreport_add", methods={"POST"})
    57|      *
    58|      * @param Request $request
    59|      *
    60|      * @return JsonResponse
    61|      */
    62|     public function addAction(Request $request)
    63|     {
    64|         $this->checkPermission('reports_config');
    65|         $success = false;
    66|         $report = CustomReport\Config::getByName($request->get('name'));
    67|         if (!$report) {
    68|             $report = new CustomReport\Config();
    69|             $report->setName($request->get('name'));
    70|             $report->save();
    71|             $success = true;
    72|         }
    73|         return $this->adminJson(['success' => $success, 'id' => $report->getName()]);
    74|     }
    75|     /**
    76|      * @Route("/delete", name="pimcore_admin_reports_customreport_delete", methods={"DELETE"})
    77|      *
    78|      * @param Request $request
    79|      *
    80|      * @return JsonResponse
    81|      */
    82|     public function deleteAction(Request $request)
    83|     {
    84|         $this->checkPermission('reports_config');
    85|         $report = CustomReport\Config::getByName($request->get('name'));
    86|         $report->delete();
    87|         return $this->adminJson(['success' => true]);
    88|     }
    89|     /**
    90|      * @Route("/clone", name="pimcore_admin_reports_customreport_clone", methods={"POST"})
    91|      *
    92|      * @param Request $request
    93|      *
    94|      * @return JsonResponse
    95|      */
    96|     public function cloneAction(Request $request)
    97|     {
    98|         $this->checkPermission('reports_config');
    99|         $newName = $request->get('newName');
   100|         $report = CustomReport\Config::getByName($newName);
   101|         if ($report) {
   102|             throw new \Exception('report already exists');
   103|         }
   104|         $report = CustomReport\Config::getByName($request->get('name'));
   105|         $reportData = $this->encodeJson($report);
   106|         $reportData = $this->decodeJson($reportData);
   107|         unset($reportData['name']);
   108|         $reportData['name'] = $newName;
   109|         foreach ($reportData as $key => $value) {
   110|             $setter = 'set' . ucfirst($key);
   111|             if (method_exists($report, $setter)) {
   112|                 $report->$setter($value);
   113|             }
   114|         }
   115|         $report->save();
   116|         return $this->adminJson(['success' => true]);
   117|     }
   118|     /**
   119|      * @Route("/get", name="pimcore_admin_reports_customreport_get", methods={"GET"})
   120|      *
   121|      * @param Request $request
   122|      *
   123|      * @return JsonResponse
   124|      */
   125|     public function getAction(Request $request)
   126|     {
   127|         $this->checkPermissionsHasOneOf(['reports_config', 'reports']);
   128|         $report = CustomReport\Config::getByName($request->get('name'));
   129|         return $this->adminJson($report);
   130|     }
   131|     /**
   132|      * @Route("/update", name="pimcore_admin_reports_customreport_update", methods={"PUT"})
   133|      *
   134|      * @param Request $request
   135|      *
   136|      * @return JsonResponse
   137|      */
   138|     public function updateAction(Request $request)
   139|     {
   140|         $this->checkPermission('reports_config');
   141|         $report = CustomReport\Config::getByName($request->get('name'));
   142|         $data = $this->decodeJson($request->get('configuration'));
   143|         if (!is_array($data['yAxis'])) {
   144|             $data['yAxis'] = strlen($data['yAxis']) ? [$data['yAxis']] : [];
   145|         }
   146|         foreach ($data as $key => $value) {
   147|             $setter = 'set' . ucfirst($key);
   148|             if (method_exists($report, $setter)) {
   149|                 $report->$setter($value);
   150|             }
   151|         }
   152|         $report->save();
   153|         return $this->adminJson(['success' => true]);
   154|     }
   155|     /**
   156|      * @Route("/column-config", name="pimcore_admin_reports_customreport_columnconfig", methods={"POST"})
   157|      *
   158|      * @param Request $request
   159|      *
   160|      * @return JsonResponse
   161|      */
   162|     public function columnConfigAction(Request $request)
   163|     {
   164|         $this->checkPermission('reports_config');
   165|         $report = CustomReport\Config::getByName($request->get('name'));
   166|         $columnConfiguration = $report->getColumnConfiguration();
   167|         if (!is_array($columnConfiguration)) {
   168|             $columnConfiguration = [];
   169|         }
   170|         $configuration = json_decode($request->get('configuration'));
   171|         $configuration = $configuration[0] ?? null;
   172|         $success = false;
   173|         $errorMessage = null;
   174|         $result = [];
   175|         try {
   176|             $adapter = CustomReport\Config::getAdapter($configuration);
   177|             $columns = $adapter->getColumns($configuration);
   178|             if (!is_array($columns)) {
   179|                 $columns = [];
   180|             }
   181|             foreach ($columnConfiguration as $item) {
   182|                 $name = $item['name'];
   183|                 if (in_array($name, $columns)) {
   184|                     $result[] = $name;
   185|                     array_splice($columns, array_search($name, $columns), 1);
   186|                 }
   187|             }
   188|             foreach ($columns as $remainingColumn) {
   189|                 $result[] = $remainingColumn;
   190|             }
   191|             $success = true;
   192|         } catch (\Exception $e) {
   193|             $errorMessage = $e->getMessage();
   194|         }
   195|         return $this->adminJson([
   196|             'success' => $success,
   197|             'columns' => $result,
   198|             'errorMessage' => $errorMessage,
   199|         ]);
   200|     }
   201|     /**
   202|      * @Route("/get-report-config", name="pimcore_admin_reports_customreport_getreportconfig", methods={"GET"})
   203|      *
   204|      * @param Request $request
   205|      *
   206|      * @return JsonResponse
   207|      */
   208|     public function getReportConfigAction(Request $request)
   209|     {
   210|         $this->checkPermission('reports');
   211|         $reports = [];
   212|         $list = new CustomReport\Config\Listing();
   213|         $items = $list->getDao()->loadForGivenUser($this->getAdminUser());
   214|         foreach ($items as $report) {
   215|             $reports[] = [
   216|                 'name' => $report->getName(),
   217|                 'niceName' => $report->getNiceName(),
   218|                 'iconClass' => $report->getIconClass(),
   219|                 'group' => $report->getGroup(),
   220|                 'groupIconClass' => $report->getGroupIconClass(),
   221|                 'menuShortcut' => $report->getMenuShortcut(),
   222|                 'reportClass' => $report->getReportClass(),
   223|             ];
   224|         }
   225|         return $this->adminJson([
   226|             'success' => true,
   227|             'reports' => $reports,
   228|         ]);
   229|     }
   230|     /**
   231|      * @Route("/data", name="pimcore_admin_reports_customreport_data", methods={"GET", "POST"})
   232|      *
   233|      * @param Request $request
   234|      *
   235|      * @return JsonResponse
   236|      */
   237|     public function dataAction(Request $request)
   238|     {
   239|         $this->checkPermission('reports');
   240|         $offset = $request->get('start', 0);
   241|         $limit = $request->get('limit', 40);
   242|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(array_merge($request->request->all(), $request->query->all()));
   243|         $sort = null;
   244|         $dir = null;
   245|         if ($sortingSettings['orderKey']) {
   246|             $sort = $sortingSettings['orderKey'];
   247|             $dir = $sortingSettings['order'];
   248|         }
   249|         $filters = ($request->get('filter') ? json_decode($request->get('filter'), true) : null);
   250|         $drillDownFilters = $request->get('drillDownFilters', null);
   251|         $config = CustomReport\Config::getByName($request->get('name'));
   252|         $configuration = $config->getDataSourceConfig();
   253|         $adapter = CustomReport\Config::getAdapter($configuration, $config);
   254|         $result = $adapter->getData($filters, $sort, $dir, $offset, $limit, null, $drillDownFilters);
   255|         return $this->adminJson([
   256|             'success' => true,
   257|             'data' => $result['data'],
   258|             'total' => $result['total'],
   259|         ]);
   260|     }
   261|     /**
   262|      * @Route("/drill-down-options", name="pimcore_admin_reports_customreport_drilldownoptions", methods={"GET", "POST"})
   263|      *
   264|      * @param Request $request
   265|      *
   266|      * @return JsonResponse
   267|      */
   268|     public function drillDownOptionsAction(Request $request)
   269|     {
   270|         $this->checkPermission('reports');
   271|         $field = $request->get('field');
   272|         $filters = ($request->get('filter') ? json_decode($request->get('filter'), true) : null);
   273|         $drillDownFilters = $request->get('drillDownFilters', null);
   274|         $config = CustomReport\Config::getByName($request->get('name'));
   275|         $configuration = $config->getDataSourceConfig();
   276|         $adapter = CustomReport\Config::getAdapter($configuration, $config);
   277|         $result = $adapter->getAvailableOptions($filters, $field, $drillDownFilters);
   278|         return $this->adminJson([
   279|             'success' => true,
   280|             'data' => $result['data'],
   281|         ]);
   282|     }
   283|     /**
   284|      * @Route("/chart", name="pimcore_admin_reports_customreport_chart", methods={"GET", "POST"})
   285|      *
   286|      * @param Request $request
   287|      *
   288|      * @return JsonResponse
   289|      */
   290|     public function chartAction(Request $request)
   291|     {
   292|         $this->checkPermission('reports');
   293|         $sort = $request->get('sort');
   294|         $dir = $request->get('dir');
   295|         $filters = ($request->get('filter') ? json_decode($request->get('filter'), true) : null);
   296|         $drillDownFilters = $request->get('drillDownFilters', null);
   297|         $config = CustomReport\Config::getByName($request->get('name'));
   298|         $configuration = $config->getDataSourceConfig();
   299|         $adapter = CustomReport\Config::getAdapter($configuration, $config);
   300|         $result = $adapter->getData($filters, $sort, $dir, null, null, null, $drillDownFilters);
   301|         return $this->adminJson([
   302|             'success' => true,
   303|             'data' => $result['data'],
   304|             'total' => $result['total'],
   305|         ]);
   306|     }
   307|     /**
   308|      * @Route("/create-csv", name="pimcore_admin_reports_customreport_createcsv", methods={"GET"})
   309|      *
   310|      * @param Request $request
   311|      *
   312|      * @return JsonResponse
   313|      */
   314|     public function createCsvAction(Request $request)
   315|     {
   316|         $this->checkPermission('reports');
   317|         set_time_limit(300);
   318|         $sort = $request->get('sort');
   319|         $dir = $request->get('dir');
   320|         $filters = $request->get('filter') ? json_decode(urldecode($request->get('filter')), true) : null;
   321|         $drillDownFilters = $request->get('drillDownFilters', null);
   322|         $includeHeaders = $request->get('headers', false);
   323|         $config = CustomReport\Config::getByName($request->get('name'));
   324|         $columns = $config->getColumnConfiguration();
   325|         $fields = [];
   326|         foreach ($columns as $column) {
   327|             if ($column['export']) {
   328|                 $fields[] = $column['name'];
   329|             }
   330|         }
   331|         $configuration = $config->getDataSourceConfig();
   332|         $adapter = CustomReport\Config::getAdapter($configuration, $config);
   333|         $offset = $request->get('offset', 0);
   334|         $limit = 5000;
   335|         $tempData = [];
   336|         $result = $adapter->getData($filters, $sort, $dir, $offset * $limit, $limit, $fields, $drillDownFilters);
   337|         ++$offset;
   338|         if (!($exportFile = $request->get('exportFile'))) {
   339|             $exportFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/report-export-' . uniqid() . '.csv';
   340|             @unlink($exportFile);
   341|         } else {
   342|             $exportFile = PIMCORE_SYSTEM_TEMP_DIRECTORY.'/'.$exportFile;
   343|         }
   344|         $fp = fopen($exportFile, 'a');
   345|         if ($includeHeaders) {
   346|             fputcsv($fp, $fields, ';');
   347|         }
   348|         foreach ($result['data'] as $row) {
   349|             fputcsv($fp, array_values($row), ';');
   350|         }
   351|         fclose($fp);
   352|         $progress = $result['total'] ? ($offset * $limit) / $result['total'] : 1;
   353|         $progress = $progress > 1 ? 1 : $progress;
   354|         return new JsonResponse([
   355|             'exportFile' => basename($exportFile),
   356|             'offset' => $offset,
   357|             'progress' => $progress,
   358|             'finished' => empty($result['data']) || count($result['data']) < $limit,
   359|         ]);
   360|     }
   361|     /**
   362|      * @Route("/download-csv", name="pimcore_admin_reports_customreport_downloadcsv", methods={"GET"})
   363|      *
   364|      * @param Request $request
   365|      *
   366|      * @return BinaryFileResponse
   367|      */
   368|     public function downloadCsvAction(Request $request)
   369|     {
   370|         $this->checkPermission('reports');
   371|         if ($exportFile = $request->get('exportFile')) {
   372|             $exportFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . basename($exportFile);
   373|             $response = new BinaryFileResponse($exportFile);
   374|             $response->headers->set('Content-Type', 'text/csv; charset=UTF-8');
   375|             $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_ATTACHMENT, 'export.csv');
   376|             $response->deleteFileAfterSend(true);
   377|             return $response;
   378|         }
   379|         throw new FileNotFoundException("File \"$exportFile\" not found!");
   380|     }
   381| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Reports/ReportsControllerBase.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Reports;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Config;
    17| /**
    18|  * @internal
    19|  */
    20| abstract class ReportsControllerBase extends AdminController
    21| {
    22|     /**
    23|      * @return \Pimcore\Config\Config
    24|      */
    25|     public function getConfig()
    26|     {
    27|         return Config::getReportConfig();
    28|     }
    29| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Reports/SettingsController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-70 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Reports;
    15| use Pimcore\Config;
    16| use Pimcore\Config\ReportConfigWriter;
    17| use Symfony\Component\HttpFoundation\JsonResponse;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\Routing\Annotation\Route;
    20| /**
    21|  * @Route("/settings")
    22|  *
    23|  * @internal
    24|  */
    25| class SettingsController extends ReportsControllerBase
    26| {
    27|     /**
    28|      * @Route("/get", name="pimcore_admin_reports_settings_get", methods={"GET"})
    29|      *
    30|      * @param Request $request
    31|      *
    32|      * @return JsonResponse
    33|      */
    34|     public function getAction(Request $request)
    35|     {
    36|         $this->checkPermission('system_settings');
    37|         $config = $this->getConfig()->toArray();
    38|         if (!$this->getAdminUser()->isAllowed('piwik_settings') && isset($config['piwik'])) {
    39|             unset($config['piwik']);
    40|         }
    41|         $response = [
    42|             'values' => $config,
    43|             'config' => [],
    44|         ];
    45|         return $this->adminJson($response);
    46|     }
    47|     /**
    48|      * @Route("/save", name="pimcore_admin_reports_settings_save", methods={"PUT"})
    49|      *
    50|      * @param Request $request
    51|      * @param ReportConfigWriter $configWriter
    52|      *
    53|      * @return JsonResponse
    54|      */
    55|     public function saveAction(Request $request, ReportConfigWriter $configWriter)
    56|     {
    57|         $this->checkPermission('system_settings');
    58|         $values = $this->decodeJson($request->get('data'));
    59|         if (!is_array($values)) {
    60|             $values = [];
    61|         }
    62|         if (!$this->getAdminUser()->isAllowed('piwik_settings')) {
    63|             $currentConfig = Config::getReportConfig()->toArray();
    64|             $piwikConfig = $currentConfig['piwik'] ?? [];
    65|             $values['piwik'] = $piwikConfig;
    66|         }
    67|         $configWriter->write($values);
    68|         return $this->adminJson(['success' => true]);
    69|     }
    70| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Searchadmin/SearchController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-426 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Searchadmin;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Bundle\AdminBundle\Helper\GridHelperService;
    17| use Pimcore\Config;
    18| use Pimcore\Event\AdminEvents;
    19| use Pimcore\Model\Asset;
    20| use Pimcore\Model\DataObject;
    21| use Pimcore\Model\Document;
    22| use Pimcore\Model\Element;
    23| use Pimcore\Model\Search\Backend\Data;
    24| use Symfony\Component\EventDispatcher\GenericEvent;
    25| use Symfony\Component\HttpFoundation\JsonResponse;
    26| use Symfony\Component\HttpFoundation\Request;
    27| use Symfony\Component\Routing\Annotation\Route;
    28| use Symfony\Contracts\EventDispatcher\EventDispatcherInterface;
    29| /**
    30|  * @Route("/search")
    31|  *
    32|  * @internal
    33|  */
    34| class SearchController extends AdminController
    35| {
    36|     /**
    37|      * @Route("/find", name="pimcore_admin_searchadmin_search_find", methods={"GET", "POST"})
    38|      *
    39|      * @param Request $request
    40|      *
    41|      * @return JsonResponse
    42|      *
    43|      * @todo: $conditionTypeParts could be undefined
    44|      * @todo: $conditionSubtypeParts could be undefined
    45|      * @todo: $conditionClassnameParts could be undefined
    46|      * @todo: $data could be undefined
    47|      */
    48|     public function findAction(Request $request, EventDispatcherInterface $eventDispatcher, GridHelperService $gridHelperService)
    49|     {
    50|         $allParams = array_merge($request->request->all(), $request->query->all());
    51|         $requestedLanguage = $allParams['language'] ?? null;
    52|         if ($requestedLanguage) {
    53|             if ($requestedLanguage != 'default') {
    54|                 $request->setLocale($requestedLanguage);
    55|             }
    56|         }
    57|         $filterPrepareEvent = new GenericEvent($this, [
    58|             'requestParams' => $allParams,
    59|         ]);
    60|         $eventDispatcher->dispatch($filterPrepareEvent, AdminEvents::SEARCH_LIST_BEFORE_FILTER_PREPARE);
    61|         $allParams = $filterPrepareEvent->getArgument('requestParams');
    62|         $query = $this->filterQueryParam($allParams['query']);
    63|         $types = explode(',', $allParams['type'] ?? '');
    64|         $subtypes = explode(',', $allParams['subtype'] ?? '');
    65|         $classnames = explode(',', $allParams['class'] ?? '');
    66|         $offset = (int)$allParams['start'];
    67|         $limit = (int)$allParams['limit'];
    68|         $offset = $offset ? $offset : 0;
    69|         $limit = $limit ? $limit : 50;
    70|         $searcherList = new Data\Listing();
    71|         $conditionParts = [];
    72|         $db = \Pimcore\Db::get();
    73|         $forbiddenConditions = $this->getForbiddenCondition($types);
    74|         if ($forbiddenConditions) {
    75|             $conditionParts[] = '(' . implode(' AND ', $forbiddenConditions) . ')';
    76|         }
    77|         $queryCondition = '';
    78|         if (!empty($query)) {
    79|             $queryCondition = '( MATCH (`data`,`properties`) AGAINST (' . $db->quote($query) . ' IN BOOLEAN MODE) )';
    80|             $conditionParts[] = $queryCondition;
    81|         }
    82|         $fields = [];
    83|         $bricks = [];
    84|         if (!empty($allParams['fields'])) {
    85|             $fields = $allParams['fields'];
    86|             foreach ($fields as $f) {
    87|                 $parts = explode('~', $f);
    88|                 if (substr($f, 0, 1) == '~') {
    89|                 } elseif (count($parts) > 1) {
    90|                     $bricks[$parts[0]] = $parts[0];
    91|                 }
    92|             }
    93|         }
    94|         if (!empty($allParams['filter']) && !empty($allParams['class'])) {
    95|             $class = DataObject\ClassDefinition::getByName($allParams['class']);
    96|             $params = $this->decodeJson($allParams['filter']);
    97|             $unlocalizedFieldsFilters = [];
    98|             $localizedFieldsFilters = [];
    99|             foreach ($params as $paramConditionObject) {
   100|                 $definitionExists = in_array('o_' . $paramConditionObject['property'], DataObject\Service::getSystemFields())
   101|                     || $class->getFieldDefinition($paramConditionObject['property']);
   102|                 if ($definitionExists) { //TODO: for sure, we can add additional condition like getLocalizedFieldDefinition()->getFieldDefiniton(...
   103|                     $unlocalizedFieldsFilters[] = $paramConditionObject;
   104|                 } else {
   105|                     $localizedFieldsFilters[] = $paramConditionObject;
   106|                 }
   107|             }
   108|             $conditionFilters = count($unlocalizedFieldsFilters)
   109|                 ? $gridHelperService->getFilterCondition($this->encodeJson($unlocalizedFieldsFilters), $class)
   110|                 : null;
   111|             $localizedConditionFilters = count($localizedFieldsFilters)
   112|                 ? $gridHelperService->getFilterCondition($this->encodeJson($localizedFieldsFilters), $class)
   113|                 : null;
   114|             $join = '';
   115|             foreach ($bricks as $ob) {
   116|                 $join .= ' LEFT JOIN object_brick_query_' . $ob . '_' . $class->getId();
   117|                 $join .= ' `' . $ob . '`';
   118|                 $join .= ' ON `' . $ob . '`.o_id = `object_' . $class->getId() . '`.o_id';
   119|             }
   120|             if (null !== $conditionFilters) {
   121|                 $conditionParts[] = '( id IN (SELECT `object_' . $class->getId() . '`.o_id FROM object_' . $class->getId()
   122|                     . $join . ' WHERE ' . $conditionFilters . ') )';
   123|             }
   124|             if (null !== $localizedConditionFilters) {
   125|                 $conditionParts[] = '( id IN (SELECT `object_localized_data_' . $class->getId()
   126|                     . '`.ooo_id FROM object_localized_data_' . $class->getId() . $join . ' WHERE '
   127|                     . $localizedConditionFilters . ' GROUP BY ooo_id ' . ') )';
   128|             }
   129|         }
   130|         if (is_array($types) and !empty($types[0])) {
   131|             $conditionTypeParts = [];
   132|             foreach ($types as $type) {
   133|                 $conditionTypeParts[] = $db->quote($type);
   134|             }
   135|             if (in_array('folder', $subtypes)) {
   136|                 $conditionTypeParts[] = $db->quote('folder');
   137|             }
   138|             $conditionParts[] = '( maintype IN (' . implode(',', $conditionTypeParts) . ') )';
   139|         }
   140|         if (is_array($subtypes) and !empty($subtypes[0])) {
   141|             $conditionSubtypeParts = [];
   142|             foreach ($subtypes as $subtype) {
   143|                 $conditionSubtypeParts[] = $db->quote($subtype);
   144|             }
   145|             $conditionParts[] = '( type IN (' . implode(',', $conditionSubtypeParts) . ') )';
   146|         }
   147|         if (is_array($classnames) and !empty($classnames[0])) {
   148|             if (in_array('folder', $subtypes)) {
   149|                 $classnames[] = 'folder';
   150|             }
   151|             $conditionClassnameParts = [];
   152|             foreach ($classnames as $classname) {
   153|                 $conditionClassnameParts[] = $db->quote($classname);
   154|             }
   155|             $conditionParts[] = '( subtype IN (' . implode(',', $conditionClassnameParts) . ') )';
   156|         }
   157|         if (!empty($allParams['tagIds'])) {
   158|             $tagIds = $allParams['tagIds'];
   159|             foreach ($tagIds as $tagId) {
   160|                 foreach ($types as $type) {
   161|                     if (($allParams['considerChildTags'] ?? 'false') === 'true') {
   162|                         $tag = Element\Tag::getById($tagId);
   163|                         if ($tag) {
   164|                             $tagPath = $tag->getFullIdPath();
   165|                             $conditionParts[] = 'id IN (SELECT cId FROM tags_assignment INNER JOIN tags ON tags.id = tags_assignment.tagid WHERE ctype = ' . $db->quote($type) . ' AND (id = ' .(int)$tagId. ' OR idPath LIKE ' . $db->quote($db->escapeLike($tagPath) . '%') . '))';
   166|                         }
   167|                     } else {
   168|                         $conditionParts[] = 'id IN (SELECT cId FROM tags_assignment WHERE ctype = ' . $db->quote($type) . ' AND tagid = ' .(int)$tagId. ')';
   169|                     }
   170|                 }
   171|             }
   172|         }
   173|         if (count($conditionParts) > 0) {
   174|             $condition = implode(' AND ', $conditionParts);
   175|             $searcherList->setCondition($condition);
   176|         }
   177|         $searcherList->setOffset($offset);
   178|         $searcherList->setLimit($limit);
   179|         $searcherList->setOrderKey($queryCondition, false);
   180|         $searcherList->setOrder('DESC');
   181|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   182|         if ($sortingSettings['orderKey']) {
   183|             $sortMapping = [
   184|                 'classname' => 'subtype',
   185|             ];
   186|             $sort = $sortingSettings['orderKey'];
   187|             if (array_key_exists($sortingSettings['orderKey'], $sortMapping)) {
   188|                 $sort = $sortMapping[$sortingSettings['orderKey']];
   189|             }
   190|             $searcherList->setOrderKey($sort);
   191|         }
   192|         if ($sortingSettings['order']) {
   193|             $searcherList->setOrder($sortingSettings['order']);
   194|         }
   195|         $beforeListLoadEvent = new GenericEvent($this, [
   196|             'list' => $searcherList,
   197|             'context' => $allParams,
   198|         ]);
   199|         $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::SEARCH_LIST_BEFORE_LIST_LOAD);
   200|         /** @var Data\Listing $searcherList */
   201|         $searcherList = $beforeListLoadEvent->getArgument('list');
   202|         if (in_array('asset', $types)) {
   203|             $beforeListLoadEvent = new GenericEvent($this, [
   204|                 'list' => $searcherList,
   205|                 'context' => $allParams,
   206|             ]);
   207|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::ASSET_LIST_BEFORE_LIST_LOAD);
   208|             /** @var Data\Listing $searcherList */
   209|             $searcherList = $beforeListLoadEvent->getArgument('list');
   210|         }
   211|         if (in_array('document', $types)) {
   212|             $beforeListLoadEvent = new GenericEvent($this, [
   213|                 'list' => $searcherList,
   214|                 'context' => $allParams,
   215|             ]);
   216|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::DOCUMENT_LIST_BEFORE_LIST_LOAD);
   217|             /** @var Data\Listing $searcherList */
   218|             $searcherList = $beforeListLoadEvent->getArgument('list');
   219|         }
   220|         if (in_array('object', $types)) {
   221|             $beforeListLoadEvent = new GenericEvent($this, [
   222|                 'list' => $searcherList,
   223|                 'context' => $allParams,
   224|             ]);
   225|             $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::OBJECT_LIST_BEFORE_LIST_LOAD);
   226|             /** @var Data\Listing $searcherList */
   227|             $searcherList = $beforeListLoadEvent->getArgument('list');
   228|         }
   229|         $hits = $searcherList->load();
   230|         $elements = [];
   231|         foreach ($hits as $hit) {
   232|             $element = Element\Service::getElementById($hit->getId()->getType(), $hit->getId()->getId());
   233|             if ($element->isAllowed('list')) {
   234|                 $data = null;
   235|                 if ($element instanceof DataObject\AbstractObject) {
   236|                     $data = DataObject\Service::gridObjectData($element, $fields);
   237|                 } elseif ($element instanceof Document) {
   238|                     $data = Document\Service::gridDocumentData($element);
   239|                 } elseif ($element instanceof Asset) {
   240|                     $data = Asset\Service::gridAssetData($element);
   241|                 }
   242|                 if ($data) {
   243|                     $elements[] = $data;
   244|                 }
   245|             } else {
   246|             }
   247|         }
   248|         if ($allParams['limit']) {
   249|             $totalMatches = $searcherList->getTotalCount();
   250|         } else {
   251|             $totalMatches = count($elements);
   252|         }
   253|         $result = ['data' => $elements, 'success' => true, 'total' => $totalMatches];
   254|         $afterListLoadEvent = new GenericEvent($this, [
   255|             'list' => $result,
   256|             'context' => $allParams,
   257|         ]);
   258|         $eventDispatcher->dispatch($afterListLoadEvent, AdminEvents::SEARCH_LIST_AFTER_LIST_LOAD);
   259|         $result = $afterListLoadEvent->getArgument('list');
   260|         return $this->adminJson($result);
   261|     }
   262|     /**
   263|      * @param array $types
   264|      *
   265|      * @return array
   266|      */
   267|     protected function getForbiddenCondition($types = ['assets', 'documents', 'objects'])
   268|     {
   269|         $user = $this->getAdminUser();
   270|         $db = \Pimcore\Db::get();
   271|         $forbiddenConditions = [];
   272|         if (in_array('asset', $types)) {
   273|             if (!$user->isAllowed('assets')) {
   274|                 $forbiddenConditions[] = " `type` != 'asset' ";
   275|             } else {
   276|                 $forbiddenAssetPaths = Element\Service::findForbiddenPaths('asset', $user);
   277|                 if (count($forbiddenAssetPaths) > 0) {
   278|                     for ($i = 0; $i < count($forbiddenAssetPaths); $i++) {
   279|                         $forbiddenAssetPaths[$i] = " (maintype = 'asset' AND fullpath not like " . $db->quote($forbiddenAssetPaths[$i] . '%') . ')';
   280|                     }
   281|                     $forbiddenConditions[] = implode(' AND ', $forbiddenAssetPaths) ;
   282|                 }
   283|             }
   284|         }
   285|         if (in_array('document', $types)) {
   286|             if (!$user->isAllowed('documents')) {
   287|                 $forbiddenConditions[] = " `type` != 'document' ";
   288|             } else {
   289|                 $forbiddenDocumentPaths = Element\Service::findForbiddenPaths('document', $user);
   290|                 if (count($forbiddenDocumentPaths) > 0) {
   291|                     for ($i = 0; $i < count($forbiddenDocumentPaths); $i++) {
   292|                         $forbiddenDocumentPaths[$i] = " (maintype = 'document' AND fullpath not like " . $db->quote($forbiddenDocumentPaths[$i] . '%') . ')';
   293|                     }
   294|                     $forbiddenConditions[] = implode(' AND ', $forbiddenDocumentPaths) ;
   295|                 }
   296|             }
   297|         }
   298|         if (in_array('object', $types)) {
   299|             if (!$user->isAllowed('objects')) {
   300|                 $forbiddenConditions[] = " `type` != 'object' ";
   301|             } else {
   302|                 $forbiddenObjectPaths = Element\Service::findForbiddenPaths('object', $user);
   303|                 if (count($forbiddenObjectPaths) > 0) {
   304|                     for ($i = 0; $i < count($forbiddenObjectPaths); $i++) {
   305|                         $forbiddenObjectPaths[$i] = " (maintype = 'object' AND fullpath not like " . $db->quote($forbiddenObjectPaths[$i] . '%') . ')';
   306|                     }
   307|                     $forbiddenConditions[] = implode(' AND ', $forbiddenObjectPaths);
   308|                 }
   309|             }
   310|         }
   311|         return $forbiddenConditions;
   312|     }
   313|     /**
   314|      * @param string $query
   315|      *
   316|      * @return string
   317|      */
   318|     protected function filterQueryParam(string $query)
   319|     {
   320|         if ($query == '*') {
   321|             $query = '';
   322|         }
   323|         $query = str_replace('%', '*', $query);
   324|         $query = str_replace('@', '#', $query);
   325|         $query = preg_replace("@([^ ])\-@", '$1 ', $query);
   326|         $query = str_replace(['<', '>', '(', ')', '~'], ' ', $query);
   327|         $query = preg_replace('#[*]+#', '*', $query);
   328|         $query = rtrim($query, '+- ');
   329|         return $query;
   330|     }
   331|     /**
   332|      * @Route("/quicksearch", name="pimcore_admin_searchadmin_search_quicksearch", methods={"GET"})
   333|      *
   334|      * @param Request $request
   335|      * @param EventDispatcherInterface $eventDispatcher
   336|      * @param Config $config
   337|      *
   338|      * @return JsonResponse
   339|      */
   340|     public function quicksearchAction(Request $request, EventDispatcherInterface $eventDispatcher, Config $config)
   341|     {
   342|         $query = $this->filterQueryParam($request->get('query'));
   343|         if (!preg_match('/[\+\-\*"]/', $query)) {
   344|             $query = $query . '*';
   345|         }
   346|         $db = \Pimcore\Db::get();
   347|         $searcherList = new Data\Listing();
   348|         $conditionParts = [];
   349|         $forbiddenConditions = $this->getForbiddenCondition();
   350|         if ($forbiddenConditions) {
   351|             $conditionParts[] = '(' . implode(' AND ', $forbiddenConditions) . ')';
   352|         }
   353|         $matchCondition = '( MATCH (`data`,`properties`) AGAINST (' . $db->quote($query) . ' IN BOOLEAN MODE) )';
   354|         $conditionParts[] = '(' . $matchCondition . " AND type != 'folder') ";
   355|         $queryCondition = implode(' AND ', $conditionParts);
   356|         $searcherList->setCondition($queryCondition);
   357|         $searcherList->setLimit(50);
   358|         $searcherList->setOrderKey($matchCondition, false);
   359|         $searcherList->setOrder('DESC');
   360|         $beforeListLoadEvent = new GenericEvent($this, [
   361|             'list' => $searcherList,
   362|             'query' => $query,
   363|         ]);
   364|         $eventDispatcher->dispatch($beforeListLoadEvent, AdminEvents::QUICKSEARCH_LIST_BEFORE_LIST_LOAD);
   365|         $searcherList = $beforeListLoadEvent->getArgument('list');
   366|         $hits = $searcherList->load();
   367|         $elements = [];
   368|         foreach ($hits as $hit) {
   369|             $element = Element\Service::getElementById($hit->getId()->getType(), $hit->getId()->getId());
   370|             if ($element->isAllowed('list')) {
   371|                 $data = [
   372|                     'id' => $element->getId(),
   373|                     'type' => $hit->getId()->getType(),
   374|                     'subtype' => $element->getType(),
   375|                     'className' => ($element instanceof DataObject\Concrete) ? $element->getClassName() : '',
   376|                     'fullpath' => htmlspecialchars($element->getRealFullPath()),
   377|                     'fullpathList' => htmlspecialchars($this->shortenPath($element->getRealFullPath())),
   378|                     'iconCls' => 'pimcore_icon_asset_default',
   379|                 ];
   380|                 if ($element instanceof Asset) {
   381|                     $data['iconCls'] .= ' pimcore_icon_' . \Pimcore\File::getFileExtension($element->getFilename());
   382|                 } else {
   383|                     $data['iconCls'] .= ' pimcore_icon_' . $element->getType();
   384|                 }
   385|                 $validLanguages = \Pimcore\Tool::getValidLanguages();
   386|                 $data['preview'] = $this->renderView('@PimcoreAdmin/SearchAdmin/Search/Quicksearch/' . $hit->getId()->getType() . '.html.twig', [
   387|                     'element' => $element,
   388|                     'iconCls' => $data['iconCls'],
   389|                     'config' => $config,
   390|                     'validLanguages' => $validLanguages,
   391|                 ]);
   392|                 $elements[] = $data;
   393|             }
   394|         }
   395|         $afterListLoadEvent = new GenericEvent($this, [
   396|             'list' => $elements,
   397|             'context' => $query,
   398|         ]);
   399|         $eventDispatcher->dispatch($afterListLoadEvent, AdminEvents::QUICKSEARCH_LIST_AFTER_LIST_LOAD);
   400|         $elements = $afterListLoadEvent->getArgument('list');
   401|         $result = ['data' => $elements, 'success' => true];
   402|         return $this->adminJson($result);
   403|     }
   404|     /**
   405|      * @param string $path
   406|      *
   407|      * @return string
   408|      */
   409|     protected function shortenPath($path)
   410|     {
   411|         $parts = explode('/', trim($path, '/'));
   412|         $count = count($parts) - 1;
   413|         $shortPath = '';
   414|         for ($i = $count; $i >= 0; $i--) {
   415|             $shortPath = '/' . implode('/', array_unique($parts));
   416|             if (strlen($shortPath) <= 50 || $i === 0) {
   417|                 break;
   418|             }
   419|             array_splice($parts, $i - 1, 1, '');
   420|         }
   421|         if (mb_strlen($shortPath) > 50) {
   422|             $shortPath = mb_substr($shortPath, 0, 49) . '';
   423|         }
   424|         return $shortPath;
   425|     }
   426| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Traits/AdminStyleTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Traits;
    15| use Pimcore\Event\Admin\ElementAdminStyleEvent;
    16| use Pimcore\Event\AdminEvents;
    17| use Pimcore\Model\Element\AdminStyle;
    18| use Pimcore\Model\Element\ElementInterface;
    19| /**
    20|  * @internal
    21|  */
    22| trait AdminStyleTrait
    23| {
    24|     /**
    25|      * @param ElementInterface $element
    26|      * @param null|int $context
    27|      * @param array $data
    28|      *
    29|      * @throws \Exception
    30|      */
    31|     protected function addAdminStyle(ElementInterface $element, $context = null, &$data = [])
    32|     {
    33|         $event = new ElementAdminStyleEvent($element, new AdminStyle($element), $context);
    34|         \Pimcore::getEventDispatcher()->dispatch($event, AdminEvents::RESOLVE_ELEMENT_ADMIN_STYLE);
    35|         $adminStyle = $event->getAdminStyle();
    36|         $data['icon'] = $adminStyle->getElementIcon() !== false ? $adminStyle->getElementIcon() : null;
    37|         $data['iconCls'] = $adminStyle->getElementIconClass() !== false ? $adminStyle->getElementIconClass() : null;
    38|         if ($adminStyle->getElementCssClass() !== false) {
    39|             if (!isset($data['cls'])) {
    40|                 $data['cls'] = '';
    41|             }
    42|             $data['cls'] .= $adminStyle->getElementCssClass() . ' ';
    43|         }
    44|         $data['qtipCfg'] = $adminStyle->getElementQtipConfig();
    45|     }
    46| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Traits/ApplySchedulerDataTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Traits;
    15| use Pimcore\Bundle\AdminBundle\Controller\AdminController;
    16| use Pimcore\Model\Element\ElementInterface;
    17| use Pimcore\Model\Schedule\Task;
    18| use Symfony\Component\HttpFoundation\Request;
    19| /**
    20|  * @internal
    21|  */
    22| trait ApplySchedulerDataTrait
    23| {
    24|     /**
    25|      * @param Request $request
    26|      * @param ElementInterface $element
    27|      */
    28|     protected function applySchedulerDataToElement(Request $request, ElementInterface $element)
    29|     {
    30|         /** @var AdminController $this */
    31|         if ($request->get('scheduler')) {
    32|             $tasks = [];
    33|             $tasksData = $this->decodeJson($request->get('scheduler'));
    34|             if (!empty($tasksData)) {
    35|                 foreach ($tasksData as $taskData) {
    36|                     $taskData['date'] = strtotime($taskData['date'] . ' ' . ($taskData['time'] ?? ''));
    37|                     $taskData['userId'] = $this->getAdminUser()->getId();
    38|                     $task = new Task($taskData);
    39|                     $tasks[] = $task;
    40|                 }
    41|             }
    42|             if ($element->isAllowed('settings') && method_exists($element, 'setScheduledTasks')) {
    43|                 $element->setScheduledTasks($tasks);
    44|             }
    45|         }
    46|     }
    47| }


# ====================================================================
# FILE: bundles/AdminBundle/Controller/Traits/DocumentTreeConfigTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-112 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Controller\Traits;
    15| use Pimcore\Config;
    16| use Pimcore\Event\Admin\ElementAdminStyleEvent;
    17| use Pimcore\Model\Document;
    18| use Pimcore\Model\Site;
    19| use Pimcore\Tool\Frontend;
    20| /**
    21|  * @internal
    22|  */
    23| trait DocumentTreeConfigTrait
    24| {
    25|     use AdminStyleTrait;
    26|     /**
    27|      * @param Document $element
    28|      *
    29|      * @return array
    30|      *
    31|      * @throws \Exception
    32|      */
    33|     public function getTreeNodeConfig($element)
    34|     {
    35|         $site = null;
    36|         $childDocument = $element;
    37|         $container = \Pimcore::getContainer();
    38|         /** @var Config $config */
    39|         $config = $container->get(Config::class);
    40|         $tmpDocument = [
    41|             'id' => $childDocument->getId(),
    42|             'idx' => (int)$childDocument->getIndex(),
    43|             'text' => $childDocument->getKey(),
    44|             'type' => $childDocument->getType(),
    45|             'path' => $childDocument->getRealFullPath(),
    46|             'basePath' => $childDocument->getRealPath(),
    47|             'locked' => $childDocument->isLocked(),
    48|             'lockOwner' => $childDocument->getLocked() ? true : false,
    49|             'published' => $childDocument->isPublished(),
    50|             'elementType' => 'document',
    51|             'leaf' => true,
    52|             'permissions' => [
    53|                 'view' => $childDocument->isAllowed('view'),
    54|                 'remove' => $childDocument->isAllowed('delete'),
    55|                 'settings' => $childDocument->isAllowed('settings'),
    56|                 'rename' => $childDocument->isAllowed('rename'),
    57|                 'publish' => $childDocument->isAllowed('publish'),
    58|                 'unpublish' => $childDocument->isAllowed('unpublish'),
    59|                 'create' => $childDocument->isAllowed('create'),
    60|             ],
    61|         ];
    62|         $tmpDocument['expandable'] = $childDocument->hasChildren();
    63|         $tmpDocument['loaded'] = !$childDocument->hasChildren();
    64|         if ($childDocument->getType() == 'page') {
    65|             $tmpDocument['leaf'] = false;
    66|             $tmpDocument['expanded'] = !$childDocument->hasChildren();
    67|             if ($site = Site::getByRootId($childDocument->getId())) {
    68|                 $site->setRootDocument(null);
    69|                 $tmpDocument['site'] = $site->getObjectVars();
    70|             }
    71|         } elseif ($childDocument->getType() == 'folder' || $childDocument->getType() == 'link' || $childDocument->getType() == 'hardlink') {
    72|             $tmpDocument['leaf'] = false;
    73|             $tmpDocument['expanded'] = !$childDocument->hasChildren();
    74|         } elseif (method_exists($childDocument, 'getTreeNodeConfig')) {
    75|             $tmp = $childDocument->getTreeNodeConfig();
    76|             $tmpDocument = array_merge($tmpDocument, $tmp);
    77|         }
    78|         $this->addAdminStyle($childDocument, ElementAdminStyleEvent::CONTEXT_TREE, $tmpDocument);
    79|         if ($childDocument instanceof Document\Page && isset($config['documents']['generate_preview'])) {
    80|             $thumbnailFile = $childDocument->getPreviewImageFilesystemPath();
    81|             if (file_exists($thumbnailFile) && filemtime($thumbnailFile) > ($childDocument->getModificationDate() - 20)) {
    82|                 $tmpDocument['thumbnail'] = $this->generateUrl('pimcore_admin_page_display_preview_image', ['id' => $childDocument->getId()]);
    83|                 $thumbnailFileHdpi = $childDocument->getPreviewImageFilesystemPath(true);
    84|                 if (file_exists($thumbnailFileHdpi)) {
    85|                     $tmpDocument['thumbnailHdpi'] = $this->generateUrl('pimcore_admin_page_display_preview_image',
    86|                         ['id' => $childDocument->getId(), 'hdpi' => true]);
    87|                 }
    88|             }
    89|         }
    90|         $tmpDocument['cls'] = '';
    91|         if ($childDocument instanceof Document\Page) {
    92|             $tmpDocument['url'] = $childDocument->getFullPath();
    93|             $site = Frontend::getSiteForDocument($childDocument);
    94|             if ($site instanceof Site) {
    95|                 $tmpDocument['url'] = 'http://' . $site->getMainDomain() . preg_replace('@^' . $site->getRootPath() . '/?@', '/', $childDocument->getRealFullPath());
    96|             }
    97|         }
    98|         if ($childDocument->getProperty('navigation_exclude')) {
    99|             $tmpDocument['cls'] .= 'pimcore_navigation_exclude ';
   100|         }
   101|         if (!$childDocument->isPublished()) {
   102|             $tmpDocument['cls'] .= 'pimcore_unpublished ';
   103|         }
   104|         if ($childDocument->isLocked()) {
   105|             $tmpDocument['cls'] .= 'pimcore_treenode_locked ';
   106|         }
   107|         if ($childDocument->getLocked()) {
   108|             $tmpDocument['cls'] .= 'pimcore_treenode_lockOwner ';
   109|         }
   110|         return $tmpDocument;
   111|     }
   112| }


# ====================================================================
# FILE: bundles/AdminBundle/DependencyInjection/Compiler/GDPRDataProviderPass.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler;
    16| use Pimcore\Bundle\AdminBundle\GDPR\DataProvider\Manager;
    17| use Pimcore\DependencyInjection\CollectionServiceLocator;
    18| use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
    19| use Symfony\Component\DependencyInjection\ContainerBuilder;
    20| use Symfony\Component\DependencyInjection\Definition;
    21| use Symfony\Component\DependencyInjection\Reference;
    22| /**
    23|  * @internal
    24|  */
    25| final class GDPRDataProviderPass implements CompilerPassInterface
    26| {
    27|     /**
    28|      * Registers each service with tag pimcore.gdpr.data-provider as dataprovider for gdpr data extractor
    29|      *
    30|      * @param ContainerBuilder $container
    31|      */
    32|     public function process(ContainerBuilder $container)
    33|     {
    34|         $providers = $container->findTaggedServiceIds('pimcore.gdpr.data-provider');
    35|         $mapping = [];
    36|         foreach ($providers as $id => $tags) {
    37|             $mapping[$id] = new Reference($id);
    38|         }
    39|         $collectionLocator = new Definition(CollectionServiceLocator::class, [$mapping]);
    40|         $collectionLocator->setPublic(false);
    41|         $collectionLocator->addTag('container.service_locator');
    42|         $manager = $container->getDefinition(Manager::class);
    43|         $manager->setArgument('$services', $collectionLocator);
    44|     }
    45| }


# ====================================================================
# FILE: bundles/AdminBundle/DependencyInjection/Compiler/ImportExportLocatorsPass.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler;
    16| use Pimcore\DataObject\GridColumnConfig\Service as GridColumnService;
    17| use Symfony\Component\Config\Definition\Exception\InvalidDefinitionException;
    18| use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
    19| use Symfony\Component\DependencyInjection\ContainerBuilder;
    20| use Symfony\Component\DependencyInjection\Definition;
    21| use Symfony\Component\DependencyInjection\Reference;
    22| use Symfony\Component\DependencyInjection\ServiceLocator;
    23| /**
    24|  * @internal
    25|  */
    26| final class ImportExportLocatorsPass implements CompilerPassInterface
    27| {
    28|     public function process(ContainerBuilder $container)
    29|     {
    30|         $this->processGridColumns($container);
    31|     }
    32|     private function processGridColumns(ContainerBuilder $container)
    33|     {
    34|         $gridColumnService = $container->getDefinition(GridColumnService::class);
    35|         $this->createLocatorForTaggedServices(
    36|             $container,
    37|             $gridColumnService,
    38|             'grid column operator factory',
    39|             'pimcore.data_object.grid_column_config.operator_factory',
    40|             '$operatorFactories'
    41|         );
    42|         $this->createLocatorForTaggedServices(
    43|             $container,
    44|             $gridColumnService,
    45|             'grid column value factory',
    46|             'pimcore.data_object.grid_column_config.value_factory',
    47|             '$valueFactories'
    48|         );
    49|     }
    50|     private function createLocatorForTaggedServices(
    51|         ContainerBuilder $container,
    52|         Definition $definition,
    53|         string $type,
    54|         string $tag,
    55|         string $argument
    56|     ) {
    57|         $resolvers = $container->findTaggedServiceIds($tag);
    58|         $mapping = [];
    59|         foreach ($resolvers as $id => $tagEntries) {
    60|             foreach ($tagEntries as $tagEntry) {
    61|                 if (!isset($tagEntry['id'])) {
    62|                     throw new InvalidDefinitionException(sprintf(
    63|                         'The %s "%s" does not define an ID on the "%s" tag.',
    64|                         $type,
    65|                         $id,
    66|                         $tag
    67|                     ));
    68|                 }
    69|                 $mapping[$tagEntry['id']] = new Reference($id);
    70|             }
    71|         }
    72|         $serviceLocator = new Definition(ServiceLocator::class, [$mapping]);
    73|         $serviceLocator->setPublic(false);
    74|         $serviceLocator->addTag('container.service_locator');
    75|         $definition->setArgument($argument, $serviceLocator);
    76|     }
    77| }


# ====================================================================
# FILE: bundles/AdminBundle/DependencyInjection/Compiler/SerializerPass.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler;
    15| use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
    16| use Symfony\Component\DependencyInjection\Compiler\PriorityTaggedServiceTrait;
    17| use Symfony\Component\DependencyInjection\ContainerBuilder;
    18| use Symfony\Component\DependencyInjection\Exception\RuntimeException;
    19| /**
    20|  * Adds all services with the tags "pimcore_admin.serializer.encoder" and "pimcore_admin.serializer.normalizer" as
    21|  * encoders and normalizers to the Admin Serializer service.
    22|  *
    23|  * This does exactly the same as the framework serializer pass, but adds encoders/normalizers to our custom admin
    24|  * serializer.
    25|  *
    26|  * @see \Symfony\Component\Serializer\Serializer
    27|  *
    28|  * @internal
    29|  */
    30| final class SerializerPass implements CompilerPassInterface
    31| {
    32|     use PriorityTaggedServiceTrait;
    33|     public function process(ContainerBuilder $container)
    34|     {
    35|         if (!$container->hasDefinition('Pimcore\\Admin\\Serializer')) {
    36|             return;
    37|         }
    38|         $definition = $container->getDefinition('Pimcore\\Admin\\Serializer');
    39|         $normalizers = $this->findAndSortTaggedServices('pimcore_admin.serializer.normalizer', $container);
    40|         if (empty($normalizers)) {
    41|             throw new RuntimeException('You must tag at least one service as "pimcore_admin.serializer.normalizer" to use the Admin Serializer service');
    42|         }
    43|         $encoders = $this->findAndSortTaggedServices('pimcore_admin.serializer.encoder', $container);
    44|         if (empty($encoders)) {
    45|             throw new RuntimeException('You must tag at least one service as "pimcore_admin.serializer.encoder" to use the Admin Serializer service');
    46|         }
    47|         $definition->setArguments([
    48|             '$normalizers' => $normalizers,
    49|             '$encoders' => $encoders,
    50|         ]);
    51|     }
    52| }


# ====================================================================
# FILE: bundles/AdminBundle/DependencyInjection/Compiler/TranslationServicesPass.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler;
    16| use Pimcore\Translation\ExportDataExtractorService\ExportDataExtractorServiceInterface;
    17| use Pimcore\Translation\ImporterService\ImporterServiceInterface;
    18| use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
    19| use Symfony\Component\DependencyInjection\ContainerBuilder;
    20| use Symfony\Component\DependencyInjection\Reference;
    21| /**
    22|  * @internal
    23|  */
    24| final class TranslationServicesPass implements CompilerPassInterface
    25| {
    26|     /**
    27|      * Registers each service with tag pimcore.translation.data-extractor as data extractor for the translations export data extractor service.
    28|      * Registers each service with tag pimcore.translation.importer as importer for the translations importer service.
    29|      *
    30|      * @param ContainerBuilder $container
    31|      */
    32|     public function process(ContainerBuilder $container)
    33|     {
    34|         $providers = $container->findTaggedServiceIds('pimcore.translation.data-extractor');
    35|         foreach ($providers as $id => $tags) {
    36|             foreach ($tags as $attributes) {
    37|                 if (empty($attributes['type'])) {
    38|                     throw new \Exception('service with tag "pimcore.translation.data-extractor" but without type registered');
    39|                 }
    40|                 $definition = $container->getDefinition(ExportDataExtractorServiceInterface::class);
    41|                 $definition->addMethodCall('registerDataExtractor', [$attributes['type'], new Reference($id)]);
    42|             }
    43|         }
    44|         $providers = $container->findTaggedServiceIds('pimcore.translation.importer');
    45|         foreach ($providers as $id => $tags) {
    46|             foreach ($tags as $attributes) {
    47|                 if (empty($attributes['type'])) {
    48|                     throw new \Exception('service with tag "pimcore.translation.data-extractor" but without type registered');
    49|                 }
    50|                 $definition = $container->getDefinition(ImporterServiceInterface::class);
    51|                 $definition->addMethodCall('registerImporter', [$attributes['type'], new Reference($id)]);
    52|             }
    53|         }
    54|     }
    55| }


# ====================================================================
# FILE: bundles/AdminBundle/DependencyInjection/Configuration.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-194 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\DependencyInjection;
    15| use Symfony\Component\Config\Definition\Builder\ArrayNodeDefinition;
    16| use Symfony\Component\Config\Definition\Builder\TreeBuilder;
    17| use Symfony\Component\Config\Definition\ConfigurationInterface;
    18| /**
    19|  * Adds configuration for gdpr data provider
    20|  *
    21|  * @internal
    22|  */
    23| final class Configuration implements ConfigurationInterface
    24| {
    25|     /**
    26|      * {@inheritdoc}
    27|      */
    28|     public function getConfigTreeBuilder()
    29|     {
    30|         $treeBuilder = new TreeBuilder('pimcore_admin');
    31|         /** @var ArrayNodeDefinition $rootNode */
    32|         $rootNode = $treeBuilder->getRootNode();
    33|         $rootNode->append($this->buildGdprDataExtractorNode());
    34|         $rootNode->append($this->buildObjectsNode());
    35|         $rootNode->append($this->buildAssetsNode());
    36|         $rootNode->append($this->buildDocumentsNode());
    37|         $rootNode->children()
    38|             ->arrayNode('admin_languages')
    39|                 ->prototype('scalar')
    40|                 ->end()
    41|             ->end()
    42|             ->arrayNode('csrf_protection')
    43|                 ->addDefaultsIfNotSet()
    44|                 ->children()
    45|                     ->arrayNode('excluded_routes')
    46|                         ->prototype('scalar')
    47|                         ->end()
    48|                     ->end()
    49|                 ->end()
    50|             ->end()
    51|             ->scalarNode('custom_admin_path_identifier')
    52|                 ->defaultNull()
    53|                 ->validate()
    54|                     ->ifTrue(function ($v) {
    55|                         return strlen($v) < 20;
    56|                     })
    57|                     ->thenInvalid('custom_admin_path_identifier must be at least 20 characters long')
    58|                 ->end()
    59|             ->end()
    60|             ->arrayNode('branding')
    61|                 ->addDefaultsIfNotSet()
    62|                 ->children()
    63|                     ->booleanNode('login_screen_invert_colors')
    64|                         ->defaultFalse()
    65|                     ->end()
    66|                     ->scalarNode('color_login_screen')
    67|                         ->defaultNull()
    68|                     ->end()
    69|                     ->scalarNode('color_admin_interface')
    70|                         ->defaultNull()
    71|                     ->end()
    72|                     ->scalarNode('login_screen_custom_image')
    73|                         ->defaultNull()
    74|                     ->end()
    75|                 ->end()
    76|             ->end()
    77|         ;
    78|         return $treeBuilder;
    79|     }
    80|     /**
    81|      * @return \Symfony\Component\Config\Definition\Builder\ArrayNodeDefinition|\Symfony\Component\Config\Definition\Builder\NodeDefinition
    82|      */
    83|     protected function buildGdprDataExtractorNode()
    84|     {
    85|         $treeBuilder = new TreeBuilder('gdpr_data_extractor');
    86|         $gdprDataExtractor = $treeBuilder->getRootNode();
    87|         $gdprDataExtractor->addDefaultsIfNotSet();
    88|         $dataObjects = $treeBuilder->getRootNode()->children()->arrayNode('dataObjects');
    89|         $dataObjects
    90|             ->addDefaultsIfNotSet()
    91|             ->info('Settings for DataObjects DataProvider');
    92|         $dataObjects
    93|             ->children()
    94|                 ->arrayNode('classes')
    95|                     ->info('Configure which classes should be considered, array key is class name')
    96|                     ->prototype('array')
    97|                         ->info('
    98|     MY_CLASS_NAME:
    99| 		include: true
   100| 		allowDelete: false
   101| 		includedRelations:
   102| 			- manualSegemens
   103| 			- calculatedSegments
   104|                         ')
   105|                         ->children()
   106|                             ->booleanNode('include')
   107|                                 ->info('Set if class should be considered in export.')
   108|                                 ->defaultTrue()
   109|                             ->end()
   110|                             ->booleanNode('allowDelete')
   111|                                 ->info('Allow delete of objects directly in preview grid.')
   112|                                 ->defaultFalse()
   113|                             ->end()
   114|                             ->arrayNode('includedRelations')
   115|                                 ->info('List relation attributes that should be included recursively into export.')
   116|                                 ->prototype('scalar')->end()
   117|                             ->end()
   118|                         ->end()
   119|                     ->end()
   120|                 ->end()
   121|             ->end()
   122|         ;
   123|         $gdprDataExtractor->append($dataObjects);
   124|         $assets = $treeBuilder->getRootNode()->children()->arrayNode('assets');
   125|         $assets
   126|             ->addDefaultsIfNotSet()
   127|             ->info('Settings for Assets DataProvider');
   128|         $assets
   129|             ->children()
   130|                 ->arrayNode('types')
   131|                     ->info('Configure which types should be considered')
   132|                     ->prototype('array')
   133|                     ->info('asset types')
   134|                 ->end()->defaultValue([])
   135|             ->end();
   136|         $gdprDataExtractor->append($assets);
   137|         return $gdprDataExtractor;
   138|     }
   139|     /**
   140|      * @return ArrayNodeDefinition|\Symfony\Component\Config\Definition\Builder\NodeDefinition
   141|      */
   142|     protected function buildEventsNode()
   143|     {
   144|         $treeBuilder = new TreeBuilder('notes_events');
   145|         $notesEvents = $treeBuilder->getRootNode();
   146|         $notesEvents
   147|             ->addDefaultsIfNotSet()
   148|             ->children()
   149|                 ->arrayNode('types')
   150|                     ->info('List all notes/event types.')
   151|                     ->prototype('scalar')->end()
   152|                     ->defaultValue(['', 'content', 'seo', 'warning', 'notice'])
   153|                 ->end()
   154|             ->end()
   155|         ;
   156|         return $notesEvents;
   157|     }
   158|     /**
   159|      * @return ArrayNodeDefinition|\Symfony\Component\Config\Definition\Builder\NodeDefinition
   160|      */
   161|     protected function buildObjectsNode()
   162|     {
   163|         $treeBuilder = new TreeBuilder('objects');
   164|         $objectsNode = $treeBuilder->getRootNode();
   165|         $objectsNode
   166|             ->addDefaultsIfNotSet()
   167|             ->append($this->buildEventsNode());
   168|         return $objectsNode;
   169|     }
   170|     /**
   171|      * @return ArrayNodeDefinition|\Symfony\Component\Config\Definition\Builder\NodeDefinition
   172|      */
   173|     protected function buildAssetsNode()
   174|     {
   175|         $treeBuilder = new TreeBuilder('assets');
   176|         $assetsNode = $treeBuilder->getRootNode();
   177|         $assetsNode
   178|             ->addDefaultsIfNotSet()
   179|             ->append($this->buildEventsNode());
   180|         return $assetsNode;
   181|     }
   182|     /**
   183|      * @return ArrayNodeDefinition|\Symfony\Component\Config\Definition\Builder\NodeDefinition
   184|      */
   185|     protected function buildDocumentsNode()
   186|     {
   187|         $treeBuilder = new TreeBuilder('documents');
   188|         $documentsNode = $treeBuilder->getRootNode();
   189|         $documentsNode
   190|             ->addDefaultsIfNotSet()
   191|             ->append($this->buildEventsNode());
   192|         return $documentsNode;
   193|     }
   194| }


# ====================================================================
# FILE: bundles/AdminBundle/DependencyInjection/PimcoreAdminExtension.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\DependencyInjection;
    15| use Symfony\Component\Config\FileLocator;
    16| use Symfony\Component\DependencyInjection\ContainerBuilder;
    17| use Symfony\Component\DependencyInjection\Extension\Extension;
    18| use Symfony\Component\DependencyInjection\Loader\YamlFileLoader;
    19| /**
    20|  * @internal
    21|  */
    22| final class PimcoreAdminExtension extends Extension
    23| {
    24|     const PARAM_DATAOBJECTS_NOTES_EVENTS_TYPES = 'pimcore_admin.dataObjects.notes_events.types';
    25|     const PARAM_ASSETS_NOTES_EVENTS_TYPES = 'pimcore_admin.assets.notes_events.types';
    26|     const PARAM_DOCUMENTS_NOTES_EVENTS_TYPES = 'pimcore_admin.documents.notes_events.types';
    27|     /**
    28|      * {@inheritdoc}
    29|      */
    30|     public function load(array $configs, ContainerBuilder $container)
    31|     {
    32|         $configuration = new Configuration();
    33|         $config = $this->processConfiguration($configuration, $configs);
    34|         $loader = new YamlFileLoader(
    35|             $container,
    36|             new FileLocator(__DIR__ . '/../Resources/config')
    37|         );
    38|         $loader->load('services.yml');
    39|         $loader->load('security_services.yml');
    40|         $loader->load('security_abstract_services.yml');
    41|         $loader->load('event_listeners.yml');
    42|         $loader->load('serializer.yml');
    43|         $loader->load('export.yml');
    44|         $loader->load('aliases.yml');
    45|         $container->setParameter('pimcore.gdpr-data-extrator.dataobjects', $config['gdpr_data_extractor']['dataObjects']);
    46|         $container->setParameter('pimcore.gdpr-data-extrator.assets', $config['gdpr_data_extractor']['assets']);
    47|         $container->setParameter(self::PARAM_DATAOBJECTS_NOTES_EVENTS_TYPES, $config['objects']['notes_events']['types']);
    48|         $container->setParameter(self::PARAM_ASSETS_NOTES_EVENTS_TYPES, $config['assets']['notes_events']['types']);
    49|         $container->setParameter(self::PARAM_DOCUMENTS_NOTES_EVENTS_TYPES, $config['documents']['notes_events']['types']);
    50|         $container->setParameter('pimcore_admin.csrf_protection.excluded_routes', $config['csrf_protection']['excluded_routes']);
    51|         $container->setParameter('pimcore_admin.admin_languages', $config['admin_languages']);
    52|         $container->setParameter('pimcore_admin.custom_admin_path_identifier', $config['custom_admin_path_identifier']);
    53|         $container->setParameter('pimcore_admin.config', $config);
    54|     }
    55| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/AdminAuthenticationDoubleCheckListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-154 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Bundle\AdminBundle\Controller\DoubleAuthenticationControllerInterface;
    16| use Pimcore\Bundle\AdminBundle\EventListener\Traits\ControllerTypeTrait;
    17| use Pimcore\Bundle\AdminBundle\Security\User\TokenStorageUserResolver;
    18| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    19| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    20| use Pimcore\Http\RequestMatcherFactory;
    21| use Pimcore\Tool\Authentication;
    22| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use Symfony\Component\HttpFoundation\RequestMatcherInterface;
    25| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    26| use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;
    27| use Symfony\Component\HttpKernel\KernelEvents;
    28| /**
    29|  * Handles double authentication check for pimcore controllers after the firewall did to make sure the admin interface is
    30|  * not accessible on configuration errors. Unauthenticated routes are not double-checked (e.g. login).
    31|  *
    32|  * @internal
    33|  */
    34| class AdminAuthenticationDoubleCheckListener implements EventSubscriberInterface
    35| {
    36|     use ControllerTypeTrait;
    37|     use PimcoreContextAwareTrait;
    38|     /**
    39|      * @var RequestMatcherFactory
    40|      */
    41|     protected $requestMatcherFactory;
    42|     /**
    43|      * @var array
    44|      */
    45|     protected $unauthenticatedRoutes;
    46|     /**
    47|      * @var RequestMatcherInterface[]
    48|      */
    49|     protected $unauthenticatedMatchers;
    50|     /**
    51|      * @var TokenStorageUserResolver
    52|      */
    53|     protected $tokenResolver;
    54|     /**
    55|      * @param RequestMatcherFactory $factory
    56|      * @param TokenStorageUserResolver $tokenResolver
    57|      * @param array $unauthenticatedRoutes
    58|      */
    59|     public function __construct(
    60|         RequestMatcherFactory $factory,
    61|         TokenStorageUserResolver $tokenResolver,
    62|         array $unauthenticatedRoutes
    63|     ) {
    64|         $this->requestMatcherFactory = $factory;
    65|         $this->tokenResolver = $tokenResolver;
    66|         $this->unauthenticatedRoutes = $unauthenticatedRoutes;
    67|     }
    68|     /**
    69|      * {@inheritdoc}
    70|      */
    71|     public static function getSubscribedEvents()
    72|     {
    73|         return [
    74|             KernelEvents::CONTROLLER => 'onKernelController',
    75|         ];
    76|     }
    77|     public function onKernelController(ControllerEvent $event)
    78|     {
    79|         if (!$event->isMasterRequest()) {
    80|             return;
    81|         }
    82|         $request = $event->getRequest();
    83|         $isDoubleAuthController = $this->isControllerType($event, DoubleAuthenticationControllerInterface::class);
    84|         $isPimcoreAdminContext = $this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN);
    85|         if (!$isDoubleAuthController && !$isPimcoreAdminContext) {
    86|             return;
    87|         }
    88|         if ($this->requestNeedsAuthentication($request)) {
    89|             if ($isDoubleAuthController) {
    90|                 /** @var DoubleAuthenticationControllerInterface $controller */
    91|                 $controller = $this->getControllerType($event, DoubleAuthenticationControllerInterface::class);
    92|                 if ($controller->needsSessionDoubleAuthenticationCheck()) {
    93|                     $this->checkSessionUser();
    94|                 }
    95|                 if ($controller->needsStorageDoubleAuthenticationCheck()) {
    96|                     $this->checkTokenStorageUser();
    97|                 }
    98|             } else {
    99|                 $this->checkSessionUser();
   100|                 $this->checkTokenStorageUser();
   101|             }
   102|         }
   103|     }
   104|     /**
   105|      * Check if the current request needs double authentication
   106|      *
   107|      * @param Request $request
   108|      *
   109|      * @return bool
   110|      */
   111|     protected function requestNeedsAuthentication(Request $request)
   112|     {
   113|         foreach ($this->getUnauthenticatedMatchers() as $matcher) {
   114|             if ($matcher->matches($request)) {
   115|                 return false;
   116|             }
   117|         }
   118|         return true;
   119|     }
   120|     /**
   121|      * Get list of paths which don't need double authentication check
   122|      *
   123|      * @return RequestMatcherInterface[]
   124|      */
   125|     protected function getUnauthenticatedMatchers()
   126|     {
   127|         if (null === $this->unauthenticatedMatchers) {
   128|             $this->unauthenticatedMatchers = $this->requestMatcherFactory->buildRequestMatchers($this->unauthenticatedRoutes);
   129|         }
   130|         return $this->unauthenticatedMatchers;
   131|     }
   132|     /**
   133|      * @throws AccessDeniedHttpException
   134|      *      if there's no current user in the session
   135|      */
   136|     protected function checkSessionUser()
   137|     {
   138|         $user = Authentication::authenticateSession();
   139|         if (null === $user) {
   140|             throw new AccessDeniedHttpException('User is invalid.');
   141|         }
   142|     }
   143|     /**
   144|      * @throws AccessDeniedHttpException
   145|      *      if there's no current user in the token storage
   146|      */
   147|     protected function checkTokenStorageUser()
   148|     {
   149|         $user = $this->tokenResolver->getUser();
   150|         if (null === $user || !Authentication::isValidUser($user)) {
   151|             throw new AccessDeniedHttpException('User is invalid.');
   152|         }
   153|     }
   154| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/AdminExceptionListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-136 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\EventListener;
    16| use Doctrine\DBAL\Exception as DBALException;
    17| use Pimcore\Bundle\AdminBundle\HttpFoundation\JsonResponse;
    18| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    19| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    20| use Pimcore\Model\Element\ValidationException;
    21| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    22| use Symfony\Component\HttpFoundation\Response;
    23| use Symfony\Component\HttpKernel\Event\ExceptionEvent;
    24| use Symfony\Component\HttpKernel\Exception\HttpExceptionInterface;
    25| use Symfony\Component\HttpKernel\KernelEvents;
    26| /**
    27|  * @internal
    28|  */
    29| class AdminExceptionListener implements EventSubscriberInterface
    30| {
    31|     use PimcoreContextAwareTrait;
    32|     /**
    33|      * {@inheritdoc}
    34|      */
    35|     public static function getSubscribedEvents(): array
    36|     {
    37|         return [
    38|             KernelEvents::EXCEPTION => 'onKernelException',
    39|         ];
    40|     }
    41|     /**
    42|      * @param ExceptionEvent $event
    43|      */
    44|     public function onKernelException(ExceptionEvent $event)
    45|     {
    46|         $request = $event->getRequest();
    47|         $ex = $event->getThrowable();
    48|         if ($this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN)) {
    49|             if (!$request->isXmlHttpRequest()) {
    50|                 return;
    51|             }
    52|             list($code, $headers, $message) = $this->getResponseData($ex);
    53|             $data = [
    54|                 'success' => false,
    55|             ];
    56|             if (!\Pimcore::inDebugMode()) {
    57|                 if ($ex instanceof DBALException) {
    58|                     $message = 'Database error, see logs for details';
    59|                 }
    60|             }
    61|             if (\Pimcore::inDebugMode()) {
    62|                 $data['trace'] = $ex->getTrace();
    63|                 $data['traceString'] = 'in ' . $ex->getFile() . ':' . $ex->getLine() . "\n" . $ex->getTraceAsString();
    64|             }
    65|             if ($ex instanceof ValidationException) {
    66|                 $data['type'] = 'ValidationException';
    67|                 $code = 422;
    68|                 $this->recursiveAddValidationExceptionSubItems($ex->getSubItems(), $message, $data['traceString']);
    69|             }
    70|             $data['message'] = $message;
    71|             $response = new JsonResponse($data, $code, $headers);
    72|             $event->setResponse($response);
    73|             return;
    74|         }
    75|     }
    76|     private function getResponseData(\Throwable $ex, int $defaultStatusCode = 500): array
    77|     {
    78|         $code = $defaultStatusCode;
    79|         $headers = [];
    80|         $message = $ex->getMessage();
    81|         if ($ex instanceof HttpExceptionInterface) {
    82|             if (empty($message)) {
    83|                 $message = Response::$statusTexts[$ex->getStatusCode()];
    84|             }
    85|             $code = $ex->getStatusCode();
    86|             $headers = $ex->getHeaders();
    87|         }
    88|         return [$code, $headers, $message];
    89|     }
    90|     /**
    91|      * @param ValidationException[] $items
    92|      * @param string $message
    93|      * @param string $detailedInfo
    94|      */
    95|     protected function recursiveAddValidationExceptionSubItems($items, &$message, &$detailedInfo)
    96|     {
    97|         if (!$items) {
    98|             return;
    99|         }
   100|         foreach ($items as $e) {
   101|             if ($e->getMessage()) {
   102|                 $message .= '<b>' . $e->getMessage() . '</b>';
   103|                 $this->addContext($e, $message);
   104|                 $message .= '<br>';
   105|                 $detailedInfo .= '<br><b>Message:</b><br>';
   106|                 $detailedInfo .= $e->getMessage() . '<br>';
   107|                 $inner = $this->getInnerStack($e);
   108|                 $detailedInfo .= '<br><b>Trace:</b> ' . $inner->getTraceAsString() . '<br>';
   109|             }
   110|             $this->recursiveAddValidationExceptionSubItems($e->getSubItems(), $message, $detailedInfo);
   111|         }
   112|     }
   113|     /**
   114|      * @param ValidationException $e
   115|      * @param string $message
   116|      */
   117|     protected function addContext(ValidationException $e, &$message)
   118|     {
   119|         $contextStack = $e->getContextStack();
   120|         if ($contextStack) {
   121|             $message = $message . ' (' . implode(',', $contextStack) . ')';
   122|         }
   123|     }
   124|     /**
   125|      * @param \Throwable $e
   126|      *
   127|      * @return \Throwable
   128|      */
   129|     protected function getInnerStack(\Throwable $e)
   130|     {
   131|         while ($e->getPrevious()) {
   132|             $e = $e->getPrevious();
   133|         }
   134|         return $e;
   135|     }
   136| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/BruteforceProtectionListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-73 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Bundle\AdminBundle\Controller\BruteforceProtectedControllerInterface;
    16| use Pimcore\Bundle\AdminBundle\Security\BruteforceProtectionHandler;
    17| use Pimcore\Bundle\AdminBundle\Security\Exception\BruteforceProtectionException;
    18| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    19| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    20| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    21| use Symfony\Component\HttpFoundation\Response;
    22| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    23| use Symfony\Component\HttpKernel\Event\ExceptionEvent;
    24| use Symfony\Component\HttpKernel\KernelEvents;
    25| /**
    26|  * @internal
    27|  */
    28| class BruteforceProtectionListener implements EventSubscriberInterface
    29| {
    30|     use PimcoreContextAwareTrait;
    31|     /**
    32|      * @var BruteforceProtectionHandler
    33|      */
    34|     protected $handler;
    35|     /**
    36|      * @param BruteforceProtectionHandler $handler
    37|      */
    38|     public function __construct(BruteforceProtectionHandler $handler)
    39|     {
    40|         $this->handler = $handler;
    41|     }
    42|     /**
    43|      * {@inheritdoc}
    44|      */
    45|     public static function getSubscribedEvents()
    46|     {
    47|         return [
    48|             KernelEvents::CONTROLLER => 'onKernelController',
    49|             KernelEvents::EXCEPTION => 'onKernelException',
    50|         ];
    51|     }
    52|     public function onKernelController(ControllerEvent $event)
    53|     {
    54|         $request = $event->getRequest();
    55|         if (!$this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN)) {
    56|             return;
    57|         }
    58|         $callable = $event->getController();
    59|         if (is_array($callable)) {
    60|             $controller = $callable[0];
    61|             if ($controller instanceof BruteforceProtectedControllerInterface) {
    62|                 $this->handler->checkProtection($request->get('username'), $request);
    63|             }
    64|         }
    65|     }
    66|     public function onKernelException(ExceptionEvent $event)
    67|     {
    68|         $e = $event->getThrowable();
    69|         if ($e instanceof BruteforceProtectionException) {
    70|             $event->setResponse(new Response($e->getMessage()));
    71|         }
    72|     }
    73| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/CsrfProtectionListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-78 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Bundle\AdminBundle\Security\CsrfProtectionHandler;
    16| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    17| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    18| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\HttpKernel\Event\RequestEvent;
    21| use Symfony\Component\HttpKernel\KernelEvents;
    22| use Twig\Environment;
    23| /**
    24|  * @internal
    25|  */
    26| class CsrfProtectionListener implements EventSubscriberInterface
    27| {
    28|     use PimcoreContextAwareTrait;
    29|     /**
    30|      * @var Environment
    31|      */
    32|     protected $twig;
    33|     /**
    34|      * @var CsrfProtectionHandler $handler
    35|      */
    36|     protected $csrfProtectionHandler;
    37|     /**
    38|      * @param CsrfProtectionHandler $csrfProtectionHandler
    39|      */
    40|     public function __construct(CsrfProtectionHandler $csrfProtectionHandler)
    41|     {
    42|         $this->csrfProtectionHandler = $csrfProtectionHandler;
    43|     }
    44|     /**
    45|      * {@inheritdoc}
    46|      */
    47|     public static function getSubscribedEvents()
    48|     {
    49|         return [
    50|             KernelEvents::REQUEST => ['handleRequest', 11],
    51|         ];
    52|     }
    53|     /**
    54|      * @param RequestEvent $event
    55|      */
    56|     public function handleRequest(RequestEvent $event)
    57|     {
    58|         $request = $event->getRequest();
    59|         if (!$this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN)) {
    60|             return;
    61|         }
    62|         $this->csrfProtectionHandler->generateCsrfToken();
    63|         if ($request->getMethod() == Request::METHOD_GET) {
    64|             return;
    65|         }
    66|         $exludedRoutes = [
    67|             'pimcore_admin_webdav',
    68|             'pimcore_admin_external_opcache_index',
    69|             'pimcore_admin_external_adminer_adminer', 'pimcore_admin_external_adminer_proxy',
    70|             'pimcore_admin_external_adminer_proxy_1', 'pimcore_admin_external_adminer_proxy_2',
    71|         ];
    72|         $route = $request->attributes->get('_route');
    73|         if (in_array($route, $exludedRoutes) || in_array($route, $this->csrfProtectionHandler->getExcludedRoutes())) {
    74|             return;
    75|         }
    76|         $this->csrfProtectionHandler->checkCsrfToken($request);
    77|     }
    78| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/CustomAdminEntryPointCheckListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\EventListener;
    16| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    17| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    18| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    19| use Symfony\Component\HttpKernel\Event\RequestEvent;
    20| use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
    21| use Symfony\Component\HttpKernel\KernelEvents;
    22| /**
    23|  * @internal
    24|  */
    25| class CustomAdminEntryPointCheckListener implements EventSubscriberInterface
    26| {
    27|     use PimcoreContextAwareTrait;
    28|     protected $customAdminPathIdentifier;
    29|     public function __construct(?string $customAdminPathIdentifier)
    30|     {
    31|         $this->customAdminPathIdentifier = $customAdminPathIdentifier;
    32|     }
    33|     /**
    34|      * {@inheritdoc}
    35|      */
    36|     public static function getSubscribedEvents(): array
    37|     {
    38|         return [
    39|             KernelEvents::REQUEST => ['onKernelRequest', 560],
    40|         ];
    41|     }
    42|     /**
    43|      * @param RequestEvent $event
    44|      */
    45|     public function onKernelRequest(RequestEvent $event)
    46|     {
    47|         $request = $event->getRequest();
    48|         if ($event->isMasterRequest() && $this->customAdminPathIdentifier && $this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN)) {
    49|             if ($this->customAdminPathIdentifier !== $request->cookies->get('pimcore_custom_admin')) {
    50|                 throw new NotFoundHttpException();
    51|             }
    52|         }
    53|     }
    54| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/EnablePreviewTimeSliderListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-97 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\EventListener;
    16| use Pimcore\Bundle\CoreBundle\EventListener\Traits\ResponseInjectionTrait;
    17| use Pimcore\Http\Request\Resolver\DocumentResolver;
    18| use Pimcore\Http\Request\Resolver\EditmodeResolver;
    19| use Pimcore\Http\Request\Resolver\OutputTimestampResolver;
    20| use Pimcore\Http\RequestHelper;
    21| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    22| use Symfony\Component\HttpKernel\Event\ResponseEvent;
    23| use Symfony\Component\HttpKernel\KernelEvents;
    24| /**
    25|  * @internal
    26|  */
    27| class EnablePreviewTimeSliderListener implements EventSubscriberInterface
    28| {
    29|     use ResponseInjectionTrait;
    30|     /**
    31|      * @var OutputTimestampResolver
    32|      */
    33|     protected $outputTimestampResolver;
    34|     /**
    35|      * @var RequestHelper
    36|      */
    37|     protected $requestHelper;
    38|     /**
    39|      * @var EditmodeResolver
    40|      */
    41|     protected $editmodeResolver;
    42|     /**
    43|      * @var DocumentResolver
    44|      */
    45|     protected $documentResolver;
    46|     public function __construct(OutputTimestampResolver $outputTimestampResolver, RequestHelper $requestHelper, EditmodeResolver $editmodeResolver, DocumentResolver $documentResolver)
    47|     {
    48|         $this->outputTimestampResolver = $outputTimestampResolver;
    49|         $this->requestHelper = $requestHelper;
    50|         $this->editmodeResolver = $editmodeResolver;
    51|         $this->documentResolver = $documentResolver;
    52|     }
    53|     /**
    54|      * {@inheritdoc}
    55|      */
    56|     public static function getSubscribedEvents()
    57|     {
    58|         return [
    59|             KernelEvents::RESPONSE => 'onKernelResponse',
    60|         ];
    61|     }
    62|     public function onKernelResponse(ResponseEvent $event)
    63|     {
    64|         if (!$event->isMasterRequest()) {
    65|             return;
    66|         }
    67|         if (!$this->outputTimestampResolver->timestampWasQueried()) {
    68|             return;
    69|         }
    70|         $request = $event->getRequest();
    71|         if ($this->editmodeResolver->isEditmode($request)) {
    72|             return;
    73|         }
    74|         if (!$this->requestHelper->isFrontendRequestByAdmin($request)) {
    75|             return;
    76|         }
    77|         $response = $event->getResponse();
    78|         if (!$this->isHtmlResponse($response)) {
    79|             return;
    80|         }
    81|         $documentId = 0;
    82|         $document = $this->documentResolver->getDocument($request);
    83|         if ($document) {
    84|             $documentId = $document->getId();
    85|         }
    86|         $code = '
    87|             <script>
    88|                 var documentId = ' . $documentId . ";
    89|                 var documentTab = top.pimcore.globalmanager.get('document_' + documentId);
    90|                 if(documentTab && documentTab.preview) {
    91|                     documentTab.preview.showTimeSlider();
    92|                 }
    93|             </script>
    94|         ";
    95|         $this->injectBeforeHeadEnd($response, $code);
    96|     }
    97| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/GridConfigListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-88 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Db;
    16| use Pimcore\Event\DataObjectClassDefinitionEvents;
    17| use Pimcore\Event\DataObjectEvents;
    18| use Pimcore\Event\Model\DataObject\ClassDefinitionEvent;
    19| use Pimcore\Event\Model\DataObjectEvent;
    20| use Pimcore\Event\Model\UserRoleEvent;
    21| use Pimcore\Event\UserRoleEvents;
    22| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    23| /**
    24|  * @internal
    25|  */
    26| class GridConfigListener implements EventSubscriberInterface
    27| {
    28|     /**
    29|      * {@inheritdoc}
    30|      */
    31|     public static function getSubscribedEvents()
    32|     {
    33|         return [
    34|             DataObjectClassDefinitionEvents::POST_DELETE => 'onClassDelete',
    35|             UserRoleEvents::POST_DELETE => 'onUserDelete',
    36|             DataObjectEvents::POST_DELETE => 'onObjectDelete',
    37|         ];
    38|     }
    39|     /**
    40|      * @param DataObjectEvent $event
    41|      */
    42|     public function onObjectDelete($event)
    43|     {
    44|         $object = $event->getObject();
    45|         $objectId = $object->getId();
    46|         $this->cleanupGridConfigFavourites('objectId = ' . $objectId);
    47|     }
    48|     /**
    49|      * @param ClassDefinitionEvent $event
    50|      */
    51|     public function onClassDelete($event)
    52|     {
    53|         $class = $event->getClassDefinition();
    54|         $classId = $class->getId();
    55|         $db = Db::get();
    56|         $gridConfigIds = $db->fetchCol('select id from gridconfigs where classId = ?', $classId);
    57|         if ($gridConfigIds) {
    58|             $db->query('delete from gridconfig_shares where gridConfigId in (' . implode($gridConfigIds) . ')');
    59|         }
    60|         $this->cleanupGridConfigs('classId = ' . $db->quote($classId));
    61|         $this->cleanupGridConfigFavourites('classId = ' . $db->quote($classId));
    62|     }
    63|     /**
    64|      * @param UserRoleEvent $event
    65|      */
    66|     public function onUserDelete($event)
    67|     {
    68|         $user = $event->getUserRole();
    69|         $userId = $user->getId();
    70|         $db = Db::get();
    71|         $gridConfigIds = $db->fetchCol('select id from gridconfigs where ownerId = ' . $userId);
    72|         if ($gridConfigIds) {
    73|             $db->query('delete from gridconfig_shares where gridConfigId in (' . implode($gridConfigIds) . ')');
    74|         }
    75|         $this->cleanupGridConfigs('ownerId = ' . $userId);
    76|         $this->cleanupGridConfigFavourites('ownerId = ' . $userId);
    77|     }
    78|     protected function cleanupGridConfigs($condition)
    79|     {
    80|         $db = Db::get();
    81|         $db->query('DELETE FROM gridconfigs where ' . $condition);
    82|     }
    83|     protected function cleanupGridConfigFavourites($condition)
    84|     {
    85|         $db = Db::get();
    86|         $db->query('DELETE FROM gridconfig_favourites where ' . $condition);
    87|     }
    88| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/HttpCacheListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-76 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    16| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    17| use Pimcore\Http\RequestHelper;
    18| use Pimcore\Http\ResponseHelper;
    19| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    20| use Symfony\Component\HttpKernel\Event\ResponseEvent;
    21| use Symfony\Component\HttpKernel\KernelEvents;
    22| /**
    23|  * @internal
    24|  */
    25| class HttpCacheListener implements EventSubscriberInterface
    26| {
    27|     use PimcoreContextAwareTrait;
    28|     /**
    29|      * @var RequestHelper
    30|      */
    31|     protected $requestHelper;
    32|     /**
    33|      * @var ResponseHelper
    34|      */
    35|     protected $responseHelper;
    36|     /**
    37|      * @param RequestHelper $requestHelper
    38|      * @param ResponseHelper $responseHelper
    39|      */
    40|     public function __construct(RequestHelper $requestHelper, ResponseHelper $responseHelper)
    41|     {
    42|         $this->requestHelper = $requestHelper;
    43|         $this->responseHelper = $responseHelper;
    44|     }
    45|     /**
    46|      * {@inheritdoc}
    47|      */
    48|     public static function getSubscribedEvents()
    49|     {
    50|         return [
    51|             KernelEvents::RESPONSE => 'onKernelResponse',
    52|         ];
    53|     }
    54|     public function onKernelResponse(ResponseEvent $event)
    55|     {
    56|         $request = $event->getRequest();
    57|         if (!$event->isMasterRequest()) {
    58|             return;
    59|         }
    60|         $disable = false;
    61|         if ($this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN)) {
    62|             $disable = true;
    63|         } else {
    64|             if ($this->requestHelper->isFrontendRequestByAdmin($request)) {
    65|                 $disable = true;
    66|             }
    67|             if (\Pimcore::inDebugMode()) {
    68|                 $disable = true;
    69|             }
    70|         }
    71|         $response = $event->getResponse();
    72|         if ($disable) {
    73|             $this->responseHelper->disableCache($response, false);
    74|         }
    75|     }
    76| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/ImportConfigListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Db;
    16| use Pimcore\Event\DataObjectClassDefinitionEvents;
    17| use Pimcore\Event\Model\DataObject\ClassDefinitionEvent;
    18| use Pimcore\Event\Model\UserRoleEvent;
    19| use Pimcore\Event\UserRoleEvents;
    20| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    21| /**
    22|  * @internal
    23|  */
    24| class ImportConfigListener implements EventSubscriberInterface
    25| {
    26|     /**
    27|      * {@inheritdoc}
    28|      */
    29|     public static function getSubscribedEvents()
    30|     {
    31|         return [
    32|             DataObjectClassDefinitionEvents::POST_DELETE => 'onClassDelete',
    33|             UserRoleEvents::POST_DELETE => 'onUserDelete',
    34|         ];
    35|     }
    36|     /**
    37|      * @param ClassDefinitionEvent $event
    38|      */
    39|     public function onClassDelete($event)
    40|     {
    41|         $class = $event->getClassDefinition();
    42|         $classId = $class->getId();
    43|         $db = Db::get();
    44|         $importConfigIds = $db->fetchCol('select id from importconfigs where classId = ?', $classId);
    45|         if ($importConfigIds) {
    46|             $db->query('delete from importconfig_shares where importConfigId in (' . implode($importConfigIds) . ')');
    47|         }
    48|         $this->cleanupImportConfigs('classId = ' . $db->quote($classId));
    49|     }
    50|     /**
    51|      * @param UserRoleEvent $event
    52|      */
    53|     public function onUserDelete($event)
    54|     {
    55|         $user = $event->getUserRole();
    56|         $userId = $user->getId();
    57|         $db = Db::get();
    58|         $importConfigIds = $db->fetchCol('select id from importconfigs where ownerId = ' . $userId);
    59|         if ($importConfigIds) {
    60|             $db->query('delete from importconfig_shares where importConfigId in (' . implode($importConfigIds) . ')');
    61|         }
    62|         $this->cleanupImportConfigs('ownerId = ' . $userId);
    63|     }
    64|     protected function cleanupImportConfigs($condition)
    65|     {
    66|         $db = Db::get();
    67|         $db->query('DELETE FROM importconfigs where ' . $condition);
    68|     }
    69| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/Traits/ControllerTypeTrait.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener\Traits;
    15| use Symfony\Component\HttpKernel\Event\ControllerEvent;
    16| /**
    17|  * @internal
    18|  */
    19| trait ControllerTypeTrait
    20| {
    21|     /**
    22|      * Get controller of specified type
    23|      *
    24|      * @param ControllerEvent $event
    25|      * @param string $type
    26|      *
    27|      * @return mixed
    28|      */
    29|     protected function getControllerType(ControllerEvent $event, $type)
    30|     {
    31|         $callable = $event->getController();
    32|         if (!is_array($callable) || count($callable) === 0) {
    33|             return null;
    34|         }
    35|         $controller = $callable[0];
    36|         if ($controller instanceof $type) {
    37|             return $controller;
    38|         }
    39|     }
    40|     /**
    41|      * Test if event controller is of the given type
    42|      *
    43|      * @param ControllerEvent $event
    44|      * @param string $type
    45|      *
    46|      * @return bool
    47|      */
    48|     protected function isControllerType(ControllerEvent $event, $type)
    49|     {
    50|         $controller = $this->getControllerType($event, $type);
    51|         return $controller && $controller instanceof $type;
    52|     }
    53| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/TwoFactorListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-68 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Tool\Session;
    16| use Psr\Log\LoggerAwareTrait;
    17| use Scheb\TwoFactorBundle\Security\Authentication\Token\TwoFactorTokenInterface;
    18| use Scheb\TwoFactorBundle\Security\TwoFactor\Event\TwoFactorAuthenticationEvent;
    19| use Scheb\TwoFactorBundle\Security\TwoFactor\Provider\PreparationRecorderInterface;
    20| use Scheb\TwoFactorBundle\Security\TwoFactor\Provider\TwoFactorProviderRegistry;
    21| use Symfony\Component\HttpFoundation\Session\Attribute\AttributeBagInterface;
    22| /**
    23|  * @internal
    24|  */
    25| class TwoFactorListener
    26| {
    27|     use LoggerAwareTrait;
    28|     /**
    29|      * @var TwoFactorProviderRegistry
    30|      */
    31|     private $providerRegistry;
    32|     /**
    33|      * @var PreparationRecorderInterface
    34|      */
    35|     private $preparationRecorder;
    36|     public function __construct(TwoFactorProviderRegistry $providerRegistry, PreparationRecorderInterface $preparationRecorder)
    37|     {
    38|         $this->providerRegistry = $providerRegistry;
    39|         $this->preparationRecorder = $preparationRecorder;
    40|     }
    41|     public function onAuthenticationComplete(TwoFactorAuthenticationEvent $event)
    42|     {
    43|         Session::useSession(function (AttributeBagInterface $adminSession) {
    44|             $adminSession->set('2fa_required', false);
    45|         });
    46|     }
    47|     public function onAuthenticationAttempt(TwoFactorAuthenticationEvent $event)
    48|     {
    49|         $twoFactorToken = $event->getToken();
    50|         if (!$twoFactorToken instanceof TwoFactorTokenInterface) {
    51|             return;
    52|         }
    53|         $providerName = $twoFactorToken->getCurrentTwoFactorProvider();
    54|         if (null === $providerName) {
    55|             return;
    56|         }
    57|         $twoFactorToken->setTwoFactorProviderPrepared($providerName);
    58|         $firewallName = $twoFactorToken->getProviderKey();
    59|         if ($this->preparationRecorder->isTwoFactorProviderPrepared($firewallName, $providerName)) {
    60|             $this->logger->info(sprintf('Two-factor provider "%s" was already prepared.', $providerName));
    61|             return;
    62|         }
    63|         $user = $twoFactorToken->getUser();
    64|         $this->providerRegistry->getProvider($providerName)->prepareAuthentication($user);
    65|         $this->preparationRecorder->setTwoFactorProviderPrepared($firewallName, $providerName);
    66|         $this->logger->info(sprintf('Two-factor provider "%s" prepared.', $providerName));
    67|     }
    68| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/UsageStatisticsListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-116 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Bundle\AdminBundle\Security\User\TokenStorageUserResolver;
    16| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    17| use Pimcore\Config;
    18| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    19| use Pimcore\Log\Simple;
    20| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    21| use Symfony\Component\HttpFoundation\Request;
    22| use Symfony\Component\HttpKernel\Event\RequestEvent;
    23| use Symfony\Component\HttpKernel\KernelEvents;
    24| /**
    25|  * @internal
    26|  */
    27| class UsageStatisticsListener implements EventSubscriberInterface
    28| {
    29|     use PimcoreContextAwareTrait;
    30|     /**
    31|      * @var TokenStorageUserResolver
    32|      */
    33|     protected $userResolver;
    34|     /**
    35|      * @var Config
    36|      */
    37|     protected $config;
    38|     /**
    39|      * @param TokenStorageUserResolver $userResolver
    40|      */
    41|     public function __construct(TokenStorageUserResolver $userResolver, Config $config)
    42|     {
    43|         $this->userResolver = $userResolver;
    44|         $this->config = $config;
    45|     }
    46|     /**
    47|      * {@inheritdoc}
    48|      */
    49|     public static function getSubscribedEvents()
    50|     {
    51|         return [
    52|             KernelEvents::REQUEST => 'onKernelRequest',
    53|         ];
    54|     }
    55|     public function onKernelRequest(RequestEvent $event)
    56|     {
    57|         $request = $event->getRequest();
    58|         if (!$event->isMasterRequest()) {
    59|             return;
    60|         }
    61|         if (!$this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN)) {
    62|             return;
    63|         }
    64|         $this->logUsageStatistics($request);
    65|     }
    66|     /**
    67|      * @param Request $request
    68|      */
    69|     protected function logUsageStatistics(Request $request)
    70|     {
    71|         if (!empty($this->config['general']['disable_usage_statistics'])) {
    72|             return;
    73|         }
    74|         $params = $this->getParams($request);
    75|         $user = $this->userResolver->getUser();
    76|         $parts = [
    77|             $user ? $user->getId() : '0',
    78|             $request->attributes->get('_controller'),
    79|             $request->attributes->get('_route'),
    80|             @json_encode($request->attributes->get('_route_params')),
    81|             @json_encode($params),
    82|         ];
    83|         Simple::log('usagelog', implode('|', $parts));
    84|     }
    85|     /**
    86|      * @param Request $request
    87|      *
    88|      * @return array
    89|      */
    90|     protected function getParams(Request $request)
    91|     {
    92|         $params = [];
    93|         $disallowedKeys = ['_dc', 'module', 'controller', 'action', 'password'];
    94|         $requestParams = array_merge(
    95|             $request->query->all(),
    96|             $request->request->all()
    97|         );
    98|         foreach ($requestParams as $key => $value) {
    99|             if (is_json($value)) {
   100|                 $value = json_decode($value);
   101|                 if (is_array($value)) {
   102|                     array_walk_recursive($value, function (&$item, $key) {
   103|                         if (strpos($key, 'pass') !== false) {
   104|                             $item = '*************';
   105|                         }
   106|                     });
   107|                 }
   108|                 $value = json_encode($value);
   109|             }
   110|             if (!in_array($key, $disallowedKeys) && is_string($value)) {
   111|                 $params[$key] = (strlen($value) > 40) ? substr($value, 0, 40) . '...' : $value;
   112|             }
   113|         }
   114|         return $params;
   115|     }
   116| }


# ====================================================================
# FILE: bundles/AdminBundle/EventListener/UserPerspectiveListener.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-112 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\EventListener;
    15| use Pimcore\Bundle\AdminBundle\Security\User\TokenStorageUserResolver;
    16| use Pimcore\Bundle\CoreBundle\EventListener\Traits\PimcoreContextAwareTrait;
    17| use Pimcore\Config;
    18| use Pimcore\Http\Request\Resolver\PimcoreContextResolver;
    19| use Pimcore\Model\User;
    20| use Psr\Log\LoggerAwareInterface;
    21| use Psr\Log\LoggerAwareTrait;
    22| use Symfony\Component\EventDispatcher\EventSubscriberInterface;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use Symfony\Component\HttpKernel\Event\RequestEvent;
    25| use Symfony\Component\HttpKernel\KernelEvents;
    26| /**
    27|  * @internal
    28|  */
    29| class UserPerspectiveListener implements EventSubscriberInterface, LoggerAwareInterface
    30| {
    31|     use LoggerAwareTrait;
    32|     use PimcoreContextAwareTrait;
    33|     /**
    34|      * @var TokenStorageUserResolver
    35|      */
    36|     protected $userResolver;
    37|     /**
    38|      * @param TokenStorageUserResolver $userResolver
    39|      */
    40|     public function __construct(TokenStorageUserResolver $userResolver)
    41|     {
    42|         $this->userResolver = $userResolver;
    43|     }
    44|     /**
    45|      * {@inheritdoc}
    46|      */
    47|     public static function getSubscribedEvents()
    48|     {
    49|         return [
    50|             KernelEvents::REQUEST => 'onKernelRequest',
    51|         ];
    52|     }
    53|     public function onKernelRequest(RequestEvent $event)
    54|     {
    55|         $request = $event->getRequest();
    56|         if (!$event->isMasterRequest()) {
    57|             return;
    58|         }
    59|         if (!$this->matchesPimcoreContext($request, PimcoreContextResolver::CONTEXT_ADMIN)) {
    60|             return;
    61|         }
    62|         if ($user = $this->userResolver->getUser()) {
    63|             $this->setRequestedPerspective($user, $request);
    64|         }
    65|     }
    66|     /**
    67|      * @param User $user
    68|      * @param Request $request
    69|      */
    70|     protected function setRequestedPerspective(User $user, Request $request)
    71|     {
    72|         $requestedPerspective = $request->get('perspective');
    73|         if ($requestedPerspective) {
    74|             if ($requestedPerspective !== $user->getActivePerspective()) {
    75|                 $existingPerspectives = array_keys(Config::getPerspectivesConfig()->toArray());
    76|                 if (!in_array($requestedPerspective, $existingPerspectives)) {
    77|                     $this->logger->warning('Requested perspective {perspective} for {user} is not does not exist.', [
    78|                         'user' => $user->getName(),
    79|                         'perspective' => $requestedPerspective,
    80|                     ]);
    81|                     $requestedPerspective = null;
    82|                 }
    83|             }
    84|         }
    85|         if (!$requestedPerspective || !$user->isAllowed($requestedPerspective, 'perspective')) {
    86|             $previouslyRequested = $requestedPerspective;
    87|             $requestedPerspective = $user->isAllowed($user->getActivePerspective(), 'perspective')
    88|                 ? $user->getActivePerspective()
    89|                 : $user->getFirstAllowedPerspective();
    90|             if (null !== $previouslyRequested) {
    91|                 $this->logger->warning('User {user} is not allowed requested perspective {requestedPerspective}. Falling back to {perspective}.', [
    92|                     'user' => $user->getName(),
    93|                     'requestedPerspective' => $previouslyRequested,
    94|                     'perspective' => $requestedPerspective,
    95|                 ]);
    96|             } else {
    97|                 $this->logger->debug('Perspective for user {user} was not requested. Falling back to {perspective}.', [
    98|                     'user' => $user->getName(),
    99|                     'perspective' => $requestedPerspective,
   100|                 ]);
   101|             }
   102|         }
   103|         if ($requestedPerspective !== $user->getActivePerspective()) {
   104|             $this->logger->info('Setting active perspective for user {user} to {perspective}.', [
   105|                 'user' => $user->getName(),
   106|                 'perspective' => $requestedPerspective,
   107|             ]);
   108|             $user->setActivePerspective($requestedPerspective);
   109|             $user->save();
   110|         }
   111|     }
   112| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/Assets.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-165 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| use Pimcore\Db;
    17| use Pimcore\Model\Asset;
    18| use Pimcore\Model\Element\Service;
    19| use Pimcore\Model\Search\Backend\Data;
    20| use Symfony\Component\HttpFoundation\Response;
    21| /**
    22|  * @internal
    23|  */
    24| class Assets extends Elements implements DataProviderInterface
    25| {
    26|     /**
    27|      * @var bool[]
    28|      */
    29|     protected $exportIds = [];
    30|     /**
    31|      * @var array
    32|      */
    33|     protected $config = [];
    34|     public function __construct(array $config = null)
    35|     {
    36|         $this->config = $config;
    37|     }
    38|     /**
    39|      * {@inheritdoc}
    40|      */
    41|     public function getName(): string
    42|     {
    43|         return 'assets';
    44|     }
    45|     /**
    46|      * {@inheritdoc}
    47|      */
    48|     public function getJsClassName(): string
    49|     {
    50|         return 'pimcore.settings.gdpr.dataproviders.assets';
    51|     }
    52|     /**
    53|      * Exports data of given asset as json
    54|      *
    55|      * @param Asset $asset
    56|      *
    57|      * @return Response
    58|      */
    59|     public function doExportData(Asset $asset)
    60|     {
    61|         $this->exportIds = [];
    62|         $this->exportIds[$asset->getId()] = true;
    63|         $file = tempnam('/tmp', 'zip');
    64|         $zip = new \ZipArchive();
    65|         $zip->open($file, \ZipArchive::OVERWRITE);
    66|         foreach (array_keys($this->exportIds) as $id) {
    67|             $theAsset = Asset::getById($id);
    68|             $resultItem = Exporter::exportAsset($theAsset);
    69|             $resultItem = json_encode($resultItem);
    70|             $zip->addFromString($asset->getFilename() . '.txt', $resultItem);
    71|             if (!$theAsset instanceof Asset\Folder) {
    72|                 $zip->addFromString($theAsset->getFilename(), $theAsset->getData());
    73|             }
    74|         }
    75|         $zip->close();
    76|         $size = filesize($file);
    77|         $content = file_get_contents($file);
    78|         unlink($file);
    79|         $response = new Response($content);
    80|         $response->headers->set('Content-Type', 'application/zip');
    81|         $response->headers->set('Content-Length', $size);
    82|         $response->headers->set('Content-Disposition', 'attachment; filename="' . $asset->getFilename() . '.zip"');
    83|         return $response;
    84|     }
    85|     /**
    86|      * @param int $id
    87|      * @param string $firstname
    88|      * @param string $lastname
    89|      * @param string $email
    90|      * @param int $start
    91|      * @param int $limit
    92|      * @param string|null $sort
    93|      *
    94|      * @return array
    95|      */
    96|     public function searchData(int $id, string $firstname, string $lastname, string $email, int $start, int $limit, string $sort = null): array
    97|     {
    98|         if (empty($id) && empty($firstname) && empty($lastname) && empty($email)) {
    99|             return ['data' => [], 'success' => true, 'total' => 0];
   100|         }
   101|         $offset = $start;
   102|         $offset = $offset ?: 0;
   103|         $limit = $limit ?: 50;
   104|         $searcherList = new Data\Listing();
   105|         $conditionParts = [];
   106|         $db = \Pimcore\Db::get();
   107|         if ($id) {
   108|             $conditionParts[] = '( MATCH (`data`,`properties`) AGAINST (+"' . $id . '" IN BOOLEAN MODE) )';
   109|         }
   110|         if ($firstname || $lastname || $email) {
   111|             $firstname = $this->prepareQueryString($firstname);
   112|             $lastname = $this->prepareQueryString($lastname);
   113|             $email = $this->prepareQueryString($email);
   114|             $queryString = ($firstname ? '+"' . $firstname . '"' : '') . ' ' . ($lastname ? '+"' . $lastname . '"' : '') . ' ' . ($email ? '+"' . $email . '"' : '');
   115|             $conditionParts[] = '( MATCH (`data`,`properties`) AGAINST ("' . $db->quote($queryString) . '" IN BOOLEAN MODE) )';
   116|         }
   117|         $db = Db::get();
   118|         $typesPart = '';
   119|         if ($this->config['types']) {
   120|             $typesList = [];
   121|             foreach ($this->config['types'] as $type) {
   122|                 $typesList[] = $db->quote($type);
   123|             }
   124|             $typesPart = ' AND type IN (' . implode(',', $typesList) . ')';
   125|         }
   126|         $conditionParts[] = '( maintype = "asset" ' . $typesPart . ')';
   127|         $condition = implode(' AND ', $conditionParts);
   128|         $searcherList->setCondition($condition);
   129|         $searcherList->setOffset($offset);
   130|         $searcherList->setLimit($limit);
   131|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(['sort' => $sort]);
   132|         if ($sortingSettings['orderKey']) {
   133|             $sortMapping = [
   134|                 'type' => 'subtype',
   135|             ];
   136|             $sort = $sortingSettings['orderKey'];
   137|             if (array_key_exists($sortingSettings['orderKey'], $sortMapping)) {
   138|                 $sort = $sortMapping[$sortingSettings['orderKey']];
   139|             }
   140|             $searcherList->setOrderKey($sort);
   141|         }
   142|         if ($sortingSettings['order']) {
   143|             $searcherList->setOrder($sortingSettings['order']);
   144|         }
   145|         $hits = $searcherList->load();
   146|         $elements = [];
   147|         foreach ($hits as $hit) {
   148|             $element = Service::getElementById($hit->getId()->getType(), $hit->getId()->getId());
   149|             if ($element instanceof Asset) {
   150|                 $data = \Pimcore\Model\Asset\Service::gridAssetData($element);
   151|                 $data['permissions'] = $element->getUserPermissions();
   152|                 $elements[] = $data;
   153|             }
   154|         }
   155|         $totalMatches = $searcherList->getTotalCount();
   156|         return ['data' => $elements, 'success' => true, 'total' => $totalMatches];
   157|     }
   158|     /**
   159|      * {@inheritdoc}
   160|      */
   161|     public function getSortPriority(): int
   162|     {
   163|         return 20;
   164|     }
   165| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/DataObjects.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-193 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| use Pimcore\Model\Asset;
    17| use Pimcore\Model\DataObject\AbstractObject;
    18| use Pimcore\Model\DataObject\Concrete;
    19| use Pimcore\Model\DataObject\Data\ElementMetadata;
    20| use Pimcore\Model\DataObject\Data\ObjectMetadata;
    21| use Pimcore\Model\Element\ElementInterface;
    22| use Pimcore\Model\Element\Service;
    23| use Pimcore\Model\Search\Backend\Data;
    24| /**
    25|  * @internal
    26|  */
    27| class DataObjects extends Elements implements DataProviderInterface
    28| {
    29|     /**
    30|      * @var array
    31|      */
    32|     protected $exportIds = [];
    33|     /**
    34|      * @var array
    35|      */
    36|     protected $config = [];
    37|     public function __construct(array $config)
    38|     {
    39|         $this->config = $config;
    40|     }
    41|     /**
    42|      * {@inheritdoc}
    43|      */
    44|     public function getName(): string
    45|     {
    46|         return 'dataObjects';
    47|     }
    48|     /**
    49|      * {@inheritdoc}
    50|      */
    51|     public function getJsClassName(): string
    52|     {
    53|         return 'pimcore.settings.gdpr.dataproviders.dataObjects';
    54|     }
    55|     /**
    56|      * Exports data of given object as json including all references that are configured to be included
    57|      *
    58|      * @param AbstractObject $object
    59|      *
    60|      * @return array
    61|      */
    62|     public function doExportData(AbstractObject $object): array
    63|     {
    64|         $this->exportIds = [];
    65|         $this->fillIds($object);
    66|         $exportResult = [];
    67|         if (!empty($this->exportIds['object'])) {
    68|             foreach (array_keys($this->exportIds['object']) as $id) {
    69|                 $object = AbstractObject::getById($id);
    70|                 $exportResult[] = Exporter::exportObject($object);
    71|             }
    72|         }
    73|         if (!empty($this->exportIds['image'])) {
    74|             foreach (array_keys($this->exportIds['image']) as $id) {
    75|                 $theAsset = Asset::getById($id);
    76|                 $exportResult[] = Exporter::exportAsset($theAsset);
    77|             }
    78|         }
    79|         return $exportResult;
    80|     }
    81|     protected function fillIds(ElementInterface $element)
    82|     {
    83|         $this->exportIds[$element->getType()][$element->getId()] = true;
    84|         if ($element instanceof Concrete) {
    85|             $subFields = $this->config['classes'][$element->getClass()->getName()]['includedRelations'] ?? [];
    86|             if ($subFields) {
    87|                 foreach ($subFields as $field) {
    88|                     $getter = 'get' . ucfirst($field);
    89|                     $subElements = $element->$getter();
    90|                     if ($subElements) {
    91|                         if (!is_array($subElements)) {
    92|                             $subElements = [$subElements];
    93|                         }
    94|                         foreach ($subElements as $subElement) {
    95|                             if ($subElement instanceof ObjectMetadata) {
    96|                                 $subElement = $subElement->getObject();
    97|                             } elseif ($subElement instanceof ElementMetadata) {
    98|                                 $subElement = $subElement->getElement();
    99|                             }
   100|                             $this->fillIds($subElement);
   101|                         }
   102|                     }
   103|                 }
   104|             }
   105|         }
   106|     }
   107|     /**
   108|      * @param int $id
   109|      * @param string $firstname
   110|      * @param string $lastname
   111|      * @param string $email
   112|      * @param int $start
   113|      * @param int $limit
   114|      * @param string|null $sort
   115|      *
   116|      * @return array
   117|      */
   118|     public function searchData(int $id, string $firstname, string $lastname, string $email, int $start, int $limit, string $sort = null): array
   119|     {
   120|         if (empty($id) && empty($firstname) && empty($lastname) && empty($email)) {
   121|             return ['data' => [], 'success' => true, 'total' => 0];
   122|         }
   123|         $offset = $start;
   124|         $offset = $offset ?: 0;
   125|         $limit = $limit ?: 50;
   126|         $searcherList = new Data\Listing();
   127|         $conditionParts = [];
   128|         $db = \Pimcore\Db::get();
   129|         if ($id) {
   130|             $conditionParts[] = '( MATCH (`data`,`properties`) AGAINST (+"' . $id . '" IN BOOLEAN MODE) )';
   131|         }
   132|         if ($firstname || $lastname || $email) {
   133|             $firstname = $this->prepareQueryString($firstname);
   134|             $lastname = $this->prepareQueryString($lastname);
   135|             $email = $this->prepareQueryString($email);
   136|             $queryString = ($firstname ? '+"' . $firstname . '"' : '') . ' ' . ($lastname ? '+"' . $lastname . '"' : '') . ' ' . ($email ? '+"' . $email . '"' : '');
   137|             $conditionParts[] = '( MATCH (`data`,`properties`) AGAINST ("' . $db->quote($queryString) . '" IN BOOLEAN MODE) )';
   138|         }
   139|         $conditionParts[] = '( maintype = "object" AND type IN ("object", "variant") )';
   140|         $classnames = [];
   141|         if ($this->config['classes']) {
   142|             foreach ($this->config['classes'] as $classname => $classConfig) {
   143|                 if ($classConfig['include'] == true) {
   144|                     $classnames[] = $classname;
   145|                 }
   146|             }
   147|         }
   148|         if (is_array($classnames) and !empty($classnames[0])) {
   149|             $conditionClassnameParts = [];
   150|             foreach ($classnames as $classname) {
   151|                 $conditionClassnameParts[] = $db->quote($classname);
   152|             }
   153|             $conditionParts[] = '( subtype IN (' . implode(',', $conditionClassnameParts) . ') )';
   154|         }
   155|         $condition = implode(' AND ', $conditionParts);
   156|         $searcherList->setCondition($condition);
   157|         $searcherList->setOffset($offset);
   158|         $searcherList->setLimit($limit);
   159|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(['sort' => $sort]);
   160|         if ($sortingSettings['orderKey']) {
   161|             $sortMapping = [
   162|                 'classname' => 'subtype',
   163|             ];
   164|             $sort = $sortingSettings['orderKey'];
   165|             if (array_key_exists($sortingSettings['orderKey'], $sortMapping)) {
   166|                 $sort = $sortMapping[$sortingSettings['orderKey']];
   167|             }
   168|             $searcherList->setOrderKey($sort);
   169|         }
   170|         if ($sortingSettings['order']) {
   171|             $searcherList->setOrder($sortingSettings['order']);
   172|         }
   173|         $hits = $searcherList->load();
   174|         $elements = [];
   175|         foreach ($hits as $hit) {
   176|             $element = Service::getElementById($hit->getId()->getType(), $hit->getId()->getId());
   177|             if ($element instanceof Concrete) {
   178|                 $data = \Pimcore\Model\DataObject\Service::gridObjectData($element);
   179|                 $data['__gdprIsDeletable'] = $this->config['classes'][$element->getClassName()]['allowDelete'] ?? false;
   180|                 $elements[] = $data;
   181|             }
   182|         }
   183|         $totalMatches = $searcherList->getTotalCount();
   184|         return ['data' => $elements, 'success' => true, 'total' => $totalMatches];
   185|     }
   186|     /**
   187|      * {@inheritdoc}
   188|      */
   189|     public function getSortPriority(): int
   190|     {
   191|         return 10;
   192|     }
   193| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/DataProviderInterface.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| interface DataProviderInterface
    17| {
    18|     /**
    19|      * Returns sort priority - higher is sorted first
    20|      *
    21|      * @return int
    22|      */
    23|     public function getSortPriority(): int;
    24|     /**
    25|      * Returns name of DataProvider
    26|      *
    27|      * @return string
    28|      */
    29|     public function getName(): string;
    30|     /**
    31|      * Returns JavaScript class name of frontend implementation
    32|      *
    33|      * @return string
    34|      */
    35|     public function getJsClassName(): string;
    36| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/Elements.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| /**
    17|  * @internal
    18|  */
    19| abstract class Elements implements DataProviderInterface
    20| {
    21|     /**
    22|      * @param string $query
    23|      *
    24|      * @return string
    25|      */
    26|     protected function prepareQueryString($query): string
    27|     {
    28|         if ($query == '*') {
    29|             $query = '';
    30|         }
    31|         $query = str_replace('%', '*', $query);
    32|         $query = str_replace('@', '#', $query);
    33|         $query = preg_replace("@([^ ])\-@", '$1 ', $query);
    34|         return $query;
    35|     }
    36| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/Exporter.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-158 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| use Pimcore\Model\Asset;
    17| use Pimcore\Model\DataObject\AbstractObject;
    18| use Pimcore\Model\DataObject\ClassDefinition\Data;
    19| use Pimcore\Model\DataObject\Concrete;
    20| use Pimcore\Model\DataObject\Fieldcollection;
    21| use Pimcore\Model\DataObject\Objectbrick;
    22| use Pimcore\Normalizer\NormalizerInterface;
    23| /**
    24|  * @internal
    25|  */
    26| class Exporter
    27| {
    28|     /**
    29|      * @param Asset $theAsset
    30|      *
    31|      * @return array
    32|      */
    33|     public static function exportAsset(Asset $theAsset)
    34|     {
    35|         $webAsset = [];
    36|         $webAsset['id'] = $theAsset->getId();
    37|         $webAsset['fullpath'] = $theAsset->getRealFullPath();
    38|         $properties = $theAsset->getProperties();
    39|         $finalProperties = [];
    40|         foreach ($properties as $property) {
    41|             $finalProperties[] = $property->serialize();
    42|         }
    43|         $webAsset['properties'] = $finalProperties;
    44|         $webAsset['customSettings'] = $theAsset->getCustomSettings();
    45|         $resultItem = json_decode(json_encode($webAsset), true);
    46|         unset($resultItem['data']);
    47|         return $resultItem;
    48|     }
    49|     /**
    50|      * @param Concrete $object
    51|      * @param array $result
    52|      * @param Objectbrick $container
    53|      * @param Data\Objectbricks $brickFieldDef
    54|      */
    55|     public static function doExportBrick(Concrete $object, array &$result, Objectbrick $container, Data\Objectbricks $brickFieldDef)
    56|     {
    57|         $allowedBrickTypes = $container->getAllowedBrickTypes();
    58|         $resultContainer = [];
    59|         foreach ($allowedBrickTypes as $brickType) {
    60|             $brickDef = Objectbrick\Definition::getByKey($brickType);
    61|             $brickGetter = 'get' . ucfirst($brickType);
    62|             $brickValue = $container->$brickGetter();
    63|             if ($brickValue instanceof Objectbrick\Data\AbstractData) {
    64|                 $resultContainer[$brickType] = [];
    65|                 $fDefs = $brickDef->getFieldDefinitions();
    66|                 foreach ($fDefs as $fd) {
    67|                     $getter = 'get' . ucfirst($fd->getName());
    68|                     $value = $brickValue->$getter();
    69|                     if ($fd instanceof NormalizerInterface) {
    70|                         $marshalledValue = $fd->normalize($value);
    71|                         $resultContainer[$brickType][$fd->getName()] = $marshalledValue;
    72|                     }
    73|                 }
    74|             }
    75|         }
    76|         $result[$container->getFieldname()] = $resultContainer;
    77|     }
    78|     /**
    79|      * @param Concrete $object
    80|      * @param array $result
    81|      * @param Fieldcollection $container
    82|      * @param Data\Fieldcollections $containerDef
    83|      *
    84|      * @throws \Exception
    85|      */
    86|     public static function doExportFieldcollection(Concrete $object, array &$result, Fieldcollection $container, Data\Fieldcollections $containerDef)
    87|     {
    88|         $resultContainer = [];
    89|         $items = $container->getItems();
    90|         foreach ($items as $item) {
    91|             $type = $item->getType();
    92|             $itemValues = [];
    93|             $itemContainerDefinition = Fieldcollection\Definition::getByKey($type);
    94|             $fDefs = $itemContainerDefinition->getFieldDefinitions();
    95|             foreach ($fDefs as $fd) {
    96|                 $getter = 'get' . ucfirst($fd->getName());
    97|                 $value = $item->$getter();
    98|                 if ($fd instanceof NormalizerInterface) {
    99|                     $marshalledValue = $fd->normalize($value);
   100|                     $itemValues[$fd->getName()] = $marshalledValue;
   101|                 }
   102|             }
   103|             $resultContainer[] = [
   104|                 'type' => $type,
   105|                 'value' => $itemValues,
   106|             ];
   107|         }
   108|         $result[$container->getFieldname()] = $resultContainer;
   109|     }
   110|     /**
   111|      * @param Concrete $object
   112|      * @param array $result
   113|      *
   114|      * @throws \Exception
   115|      */
   116|     public static function doExportObject(Concrete $object, &$result = [])
   117|     {
   118|         $fDefs = $object->getClass()->getFieldDefinitions();
   119|         /** @var Data $fd */
   120|         foreach ($fDefs as $fd) {
   121|             $getter = 'get' . ucfirst($fd->getName());
   122|             $value = $object->$getter();
   123|             if ($fd instanceof Data\Fieldcollections) {
   124|                 self::doExportFieldcollection($object, $result, $value, $fd);
   125|             } elseif ($fd instanceof Data\Objectbricks) {
   126|                 self::doExportBrick($object, $result, $value, $fd);
   127|             } else {
   128|                 if ($fd instanceof NormalizerInterface) {
   129|                     $marshalledValue = $fd->normalize($value);
   130|                     $result[$fd->getName()] = $marshalledValue;
   131|                 }
   132|             }
   133|         }
   134|     }
   135|     /**
   136|      * @param AbstractObject $object
   137|      *
   138|      * @return array
   139|      */
   140|     public static function exportObject(AbstractObject $object)
   141|     {
   142|         $webObject = [];
   143|         $webObject['id'] = $object->getId();
   144|         $webObject['fullpath'] = $object->getFullPath();
   145|         $properties = $object->getProperties();
   146|         $finalProperties = [];
   147|         foreach ($properties as $property) {
   148|             $finalProperties[] = $property->serialize();
   149|         }
   150|         $webObject['properties'] = $finalProperties;
   151|         if ($object instanceof Concrete) {
   152|             self::doExportObject($object, $webObject);
   153|         }
   154|         $resultItem = json_decode(json_encode($webObject), true);
   155|         unset($resultItem['data']);
   156|         return $resultItem;
   157|     }
   158| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/Manager.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| use Pimcore\DependencyInjection\CollectionServiceLocator;
    17| /**
    18|  * @internal
    19|  */
    20| class Manager
    21| {
    22|     /**
    23|      * @var CollectionServiceLocator
    24|      */
    25|     private $services;
    26|     /**
    27|      * @var array
    28|      */
    29|     private $sortedServices;
    30|     public function __construct(CollectionServiceLocator $services)
    31|     {
    32|         $this->services = $services;
    33|     }
    34|     /**
    35|      * Returns registered services in sorted order
    36|      *
    37|      * @return DataProviderInterface[]
    38|      */
    39|     public function getServices(): array
    40|     {
    41|         if (null !== $this->sortedServices) {
    42|             return $this->sortedServices;
    43|         }
    44|         $this->sortedServices = $this->services->all();
    45|         usort($this->sortedServices, function (DataProviderInterface $left, DataProviderInterface $right) {
    46|             return $left->getSortPriority() > $right->getSortPriority();
    47|         });
    48|         return $this->sortedServices;
    49|     }
    50| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/PimcoreUsers.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-178 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| use Pimcore\Bundle\AdminBundle\Security\User\TokenStorageUserResolver;
    17| use Pimcore\Db;
    18| use Pimcore\Model\User;
    19| /**
    20|  * @internal
    21|  */
    22| class PimcoreUsers implements DataProviderInterface
    23| {
    24|     /**
    25|      * @var TokenStorageUserResolver
    26|      */
    27|     protected $userResolver;
    28|     /**
    29|      * @param TokenStorageUserResolver $userResolver
    30|      */
    31|     public function __construct(TokenStorageUserResolver $userResolver)
    32|     {
    33|         $this->userResolver = $userResolver;
    34|     }
    35|     /**
    36|      * {@inheritdoc}
    37|      */
    38|     public function getName(): string
    39|     {
    40|         return 'pimcoreUsers';
    41|     }
    42|     /**
    43|      * {@inheritdoc}
    44|      */
    45|     public function getJsClassName(): string
    46|     {
    47|         return 'pimcore.settings.gdpr.dataproviders.pimcoreUsers';
    48|     }
    49|     /**
    50|      * {@inheritdoc}
    51|      */
    52|     public function getSortPriority(): int
    53|     {
    54|         return 30;
    55|     }
    56|     /**
    57|      * @param int $id
    58|      * @param string $firstname
    59|      * @param string $lastname
    60|      * @param string $email
    61|      * @param int $start
    62|      * @param int $limit
    63|      * @param string|null $sort
    64|      *
    65|      * @return array
    66|      */
    67|     public function searchData(int $id, string $firstname, string $lastname, string $email, int $start, int $limit, string $sort = null): array
    68|     {
    69|         if (empty($id) && empty($firstname) && empty($lastname) && empty($email)) {
    70|             return ['data' => [], 'success' => true, 'total' => 0];
    71|         }
    72|         $userListing = new User\Listing();
    73|         $conditionParams = [];
    74|         $conditionParamData = [];
    75|         if ($id) {
    76|             $conditionParams[] = 'id = ?';
    77|             $conditionParamData[] = $id;
    78|         }
    79|         if ($firstname) {
    80|             $conditionParams[] = 'firstname LIKE ?';
    81|             $conditionParamData[] = '%' . $firstname . '%';
    82|         }
    83|         if ($lastname) {
    84|             $conditionParams[] = 'lastname LIKE ?';
    85|             $conditionParamData[] = '%' . $lastname . '%';
    86|         }
    87|         if ($email) {
    88|             $conditionParams[] = 'email LIKE ?';
    89|             $conditionParamData[] = '%' . $email . '%';
    90|         }
    91|         $userListing->setCondition(implode(' AND ', $conditionParams), $conditionParamData);
    92|         $userListing->setLimit($limit);
    93|         $userListing->setOffset($start);
    94|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings(['sort' => $sort]);
    95|         if ($sortingSettings['orderKey']) {
    96|             $userListing->setOrderKey($sortingSettings['orderKey']);
    97|         }
    98|         if ($sortingSettings['order']) {
    99|             $userListing->setOrder($sortingSettings['order']);
   100|         }
   101|         $userListing->load();
   102|         $users = [];
   103|         $currentUser = $this->userResolver->getUser();
   104|         foreach ($userListing->getUsers() as $user) {
   105|             $users[] = [
   106|                 'id' => $user->getId(),
   107|                 'username' => $user->getUsername(),
   108|                 'firstname' => $user->getFirstname(),
   109|                 'lastname' => $user->getLastname(),
   110|                 'email' => $user->getEmail(),
   111|                 '__gdprIsDeletable' => $user->getId() != $currentUser->getId(),
   112|             ];
   113|         }
   114|         return $users;
   115|     }
   116|     /**
   117|      * @param int $id
   118|      *
   119|      * @return array
   120|      */
   121|     public function getExportData(int $id): array
   122|     {
   123|         $user = User::getById($id);
   124|         $userData = [];
   125|         if ($user) {
   126|             $userData = (array)$user->getObjectVars();
   127|             unset($userData['password']);
   128|             $userData['versions'] = $this->getVersionDataForUser($user);
   129|             $userData['usageLog'] = $this->getUsageLogDataForUser($user);
   130|         }
   131|         return $userData;
   132|     }
   133|     /**
   134|      * @param User\AbstractUser $user
   135|      *
   136|      * @return array
   137|      */
   138|     protected function getVersionDataForUser(User\AbstractUser $user): array
   139|     {
   140|         $db = Db::get();
   141|         $versions = $db->fetchAll("SELECT ctype, cid, note, FROM_UNIXTIME(`date`) AS 'date' FROM versions WHERE userId = ?", [$user->getId()]);
   142|         return $versions;
   143|     }
   144|     /**
   145|      * @param User\AbstractUser $user
   146|      *
   147|      * @return array
   148|      */
   149|     protected function getUsageLogDataForUser(User\AbstractUser $user): array
   150|     {
   151|         $pattern = ' ' . $user->getId() . '|';
   152|         $matches = [];
   153|         $handle = @fopen(PIMCORE_LOG_DIRECTORY . '/usagelog.log', 'r');
   154|         if ($handle) {
   155|             while (!feof($handle)) {
   156|                 $buffer = fgets($handle);
   157|                 if ($buffer && strpos($buffer, $pattern) !== false) {
   158|                     $matches[] = $buffer;
   159|                 }
   160|             }
   161|             fclose($handle);
   162|         }
   163|         $archiveFiles = glob(PIMCORE_LOG_DIRECTORY . '/usagelog-archive-*.log.gz');
   164|         foreach ($archiveFiles as $archiveFile) {
   165|             $handle = @gzopen($archiveFile, 'r');
   166|             if ($handle) {
   167|                 while (!feof($handle)) {
   168|                     $buffer = fgets($handle);
   169|                     if (strpos($buffer, $pattern) !== false) {
   170|                         $matches[] = $buffer;
   171|                     }
   172|                 }
   173|                 fclose($handle);
   174|             }
   175|         }
   176|         return $matches;
   177|     }
   178| }


# ====================================================================
# FILE: bundles/AdminBundle/GDPR/DataProvider/SentMail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\GDPR\DataProvider;
    16| class SentMail implements DataProviderInterface
    17| {
    18|     /**
    19|      * {@inheritdoc}
    20|      */
    21|     public function getName(): string
    22|     {
    23|         return 'sentMail';
    24|     }
    25|     /**
    26|      * {@inheritdoc}
    27|      */
    28|     public function getJsClassName(): string
    29|     {
    30|         return 'pimcore.settings.gdpr.dataproviders.sentMail';
    31|     }
    32|     /**
    33|      * {@inheritdoc}
    34|      */
    35|     public function getSortPriority(): int
    36|     {
    37|         return 20;
    38|     }
    39| }


# ====================================================================
# FILE: bundles/AdminBundle/Helper/GridHelperService.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-721 ---
     1| <?php
     2| declare(strict_types=1);
     3| /**
     4|  * Pimcore
     5|  *
     6|  * This source file is available under two different licenses:
     7|  * - GNU General Public License version 3 (GPLv3)
     8|  * - Pimcore Commercial License (PCL)
     9|  * Full copyright and license information is available in
    10|  * LICENSE.md which is distributed with this source code.
    11|  *
    12|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    13|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    14|  */
    15| namespace Pimcore\Bundle\AdminBundle\Helper;
    16| use Doctrine\DBAL\Query\QueryBuilder as DoctrineQueryBuilder;
    17| use Pimcore\Db;
    18| use Pimcore\Logger;
    19| use Pimcore\Model;
    20| use Pimcore\Model\DataObject;
    21| use Pimcore\Model\DataObject\ClassDefinition;
    22| use Pimcore\Model\DataObject\Objectbrick;
    23| /**
    24|  * @internal
    25|  */
    26| class GridHelperService
    27| {
    28|     /**
    29|      * @param string $filterJson
    30|      * @param ClassDefinition $class
    31|      * @param string $requestedLanguage
    32|      *
    33|      * @return array
    34|      */
    35|     public function getFeatureAndSlugFilters(string $filterJson, ClassDefinition $class, string $requestedLanguage): array
    36|     {
    37|         $featureJoins = [];
    38|         $slugJoins = [];
    39|         $slugConditions = [];
    40|         $featureConditions = [];
    41|         if ($filterJson) {
    42|             $filters = json_decode($filterJson, true);
    43|             foreach ($filters as $filter) {
    44|                 $operator = '=';
    45|                 $filterField = $filter['property'];
    46|                 $filterOperator = $filter['operator'];
    47|                 if ($filter['type'] == 'string') {
    48|                     $operator = 'LIKE';
    49|                 } elseif ($filter['type'] == 'numeric') {
    50|                     if ($filterOperator == 'lt') {
    51|                         $operator = '<';
    52|                     } elseif ($filterOperator == 'gt') {
    53|                         $operator = '>';
    54|                     } elseif ($filterOperator == 'eq') {
    55|                         $operator = '=';
    56|                     }
    57|                 } elseif ($filter['type'] == 'date') {
    58|                     if ($filterOperator == 'lt') {
    59|                         $operator = '<';
    60|                     } elseif ($filterOperator == 'gt') {
    61|                         $operator = '>';
    62|                     } elseif ($filterOperator == 'eq') {
    63|                         $operator = '=';
    64|                     }
    65|                     $filter['value'] = strtotime($filter['value']);
    66|                 } elseif ($filter['type'] == 'list') {
    67|                     $operator = '=';
    68|                 } elseif ($filter['type'] == 'boolean') {
    69|                     $operator = '=';
    70|                     $filter['value'] = (int)$filter['value'];
    71|                 }
    72|                 $keyParts = explode('~', $filterField);
    73|                 $slugFd = null;
    74|                 $field = null;
    75|                 $slugKey = null;
    76|                 $mappedKey = null;
    77|                 if (substr($filterField, 0, 1) == '~') {
    78|                     $type = $keyParts[1];
    79|                     if ($type != 'classificationstore') {
    80|                         continue;
    81|                     }
    82|                     $fieldName = $keyParts[2];
    83|                     $groupKeyId = explode('-', $keyParts[3]);
    84|                     /** @var Model\DataObject\ClassDefinition\Data\Classificationstore $csFieldDefinition */
    85|                     $csFieldDefinition = $class->getFieldDefinition($fieldName);
    86|                     $language = $requestedLanguage;
    87|                     if (!$csFieldDefinition->isLocalized()) {
    88|                         $language = 'default';
    89|                     }
    90|                     $groupId = $groupKeyId[0];
    91|                     $keyid = $groupKeyId[1];
    92|                     $keyConfig = Model\DataObject\Classificationstore\KeyConfig::getById($keyid);
    93|                     $type = $keyConfig->getType();
    94|                     $definition = json_decode($keyConfig->getDefinition());
    95|                     $field = \Pimcore\Model\DataObject\Classificationstore\Service::getFieldDefinitionFromJson($definition, $type);
    96|                     if ($field instanceof Model\DataObject\ClassDefinition\Data) {
    97|                         $mappedKey = 'cskey_' . $fieldName . '_' . $groupId . '_' . $keyid;
    98|                         $featureJoins[] = ['fieldname' => $fieldName, 'groupId' => $groupId, 'keyId' => $keyid, 'language' => $language];
    99|                         $featureCondition = $field->getFilterConditionExt(
   100|                             $filter['value'],
   101|                             $operator,
   102|                             [
   103|                                 'name' => $mappedKey, ]
   104|                         );
   105|                         $featureConditions[$mappedKey] = $featureCondition;
   106|                     }
   107|                 } elseif (count($keyParts) > 1) {
   108|                     $brickType = $keyParts[0];
   109|                     $brickKey = $keyParts[1];
   110|                     if (strpos($brickType, '?') !== false) {
   111|                         $brickDescriptor = substr($brickType, 1);
   112|                         $brickDescriptor = json_decode($brickDescriptor, true);
   113|                         $brickType = $brickDescriptor['containerKey'];
   114|                     }
   115|                     $brickDef = Objectbrick\Definition::getByKey($brickType);
   116|                     if ($slugFd = $brickDef->getFieldDefinition($brickKey) instanceof ClassDefinition\Data\UrlSlug) {
   117|                         $slugKey = $brickKey;
   118|                         $slugJoins[] = ['fieldname' => $brickKey];
   119|                     }
   120|                 } else {
   121|                     if ($slugFd = $class->getFieldDefinition($filterField) instanceof ClassDefinition\Data\UrlSlug) {
   122|                         $slugKey = $filterField;
   123|                         $slugJoins[] = ['fieldname' => $filterField];
   124|                     }
   125|                 }
   126|                 if ($field && $slugFd) {
   127|                     $slugCondition = $field->getFilterConditionExt(
   128|                         $filter['value'],
   129|                         $operator,
   130|                         [
   131|                             'name' => $slugKey, ]
   132|                     );
   133|                     $slugConditions[$mappedKey] = $slugCondition;
   134|                 }
   135|             }
   136|         }
   137|         $result = [
   138|             'featureJoins' => $featureJoins,
   139|             'slugJoins' => $slugJoins,
   140|             'featureConditions' => $featureConditions,
   141|             'slugConditions' => $slugConditions,
   142|         ];
   143|         return $result;
   144|     }
   145|     /**
   146|      *
   147|      * @param string $filterJson
   148|      * @param ClassDefinition $class
   149|      *
   150|      * @return string
   151|      */
   152|     public function getFilterCondition($filterJson, ClassDefinition $class, $tablePrefix = null): string
   153|     {
   154|         $systemFields = Model\DataObject\Service::getSystemFields();
   155|         $conditionPartsFilters = [];
   156|         if ($filterJson) {
   157|             $db = \Pimcore\Db::get();
   158|             $filters = json_decode($filterJson, true);
   159|             foreach ($filters as $filter) {
   160|                 $operator = '=';
   161|                 $filterField = $filter['property'];
   162|                 $filterOperator = $filter['operator'];
   163|                 if ($filter['type'] == 'string') {
   164|                     $operator = 'LIKE';
   165|                 } elseif ($filter['type'] == 'date') {
   166|                     if ($filterOperator == 'lt') {
   167|                         $operator = '<';
   168|                     } elseif ($filterOperator == 'gt') {
   169|                         $operator = '>';
   170|                     } elseif ($filterOperator == 'eq') {
   171|                         $operator = '=';
   172|                     }
   173|                     $filter['value'] = strtotime($filter['value']);
   174|                 } elseif ($filter['type'] == 'list') {
   175|                     $operator = '=';
   176|                 } elseif ($filter['type'] == 'boolean') {
   177|                     $operator = '=';
   178|                     $filter['value'] = (int)$filter['value'];
   179|                 } else {
   180|                     if ($filterOperator == 'lt') {
   181|                         $operator = '<';
   182|                     } elseif ($filterOperator == 'gt') {
   183|                         $operator = '>';
   184|                     } elseif ($filterOperator == 'eq') {
   185|                         $operator = '=';
   186|                     }
   187|                 }
   188|                 $field = $class->getFieldDefinition($filterField);
   189|                 $brickField = null;
   190|                 $brickKey = null;
   191|                 $brickType = null;
   192|                 $brickDescriptor = null;
   193|                 $isLocalized = false;
   194|                 if (!$field) {
   195|                     $localized = $class->getFieldDefinition('localizedfields');
   196|                     if ($localized instanceof ClassDefinition\Data\Localizedfields) {
   197|                         $field = $localized->getFieldDefinition($filterField);
   198|                     }
   199|                     $keyParts = explode('~', $filterField);
   200|                     if (substr($filterField, 0, 1) === '~') {
   201|                     } elseif (count($keyParts) > 1) {
   202|                         $brickType = $keyParts[0];
   203|                         $brickKey = $keyParts[1];
   204|                         if (strpos($brickType, '?') !== false) {
   205|                             $brickDescriptor = substr($brickType, 1);
   206|                             $brickDescriptor = json_decode($brickDescriptor, true);
   207|                             $brickType = $brickDescriptor['containerKey'];
   208|                         }
   209|                         $key = Model\DataObject\Service::getFieldForBrickType($class, $brickType);
   210|                         $field = $class->getFieldDefinition($key);
   211|                         $brickClass = Objectbrick\Definition::getByKey($brickType);
   212|                         $brickFieldKey = $brickDescriptor ? $brickDescriptor['brickfield'] : $brickKey;
   213|                         $brickClassDefinitions = $brickClass->getFieldDefinitions();
   214|                         if (array_key_exists($brickFieldKey, $brickClassDefinitions)) {
   215|                             $brickField = $brickClass->getFieldDefinition($brickFieldKey);
   216|                         } else {
   217|                             /** @var ClassDefinition\Data\Localizedfields|null $localizedFields */
   218|                             $localizedFields = $brickClass->getFieldDefinition('localizedfields');
   219|                             if ($localizedFields) {
   220|                                 $brickField = $localizedFields->getFieldDefinition($brickFieldKey);
   221|                                 $isLocalized = true;
   222|                             }
   223|                         }
   224|                     }
   225|                 }
   226|                 if ($field instanceof ClassDefinition\Data\Objectbricks || $brickDescriptor) {
   227|                     if ($brickDescriptor) {
   228|                         $brickFilterField = $brickDescriptor['fieldname'];
   229|                     } else {
   230|                         $brickFilterField = $field->getName();
   231|                     }
   232|                     $db = \Pimcore\Db::get();
   233|                     if ($isLocalized) {
   234|                         $brickPrefix = $db->quoteIdentifier($brickType . '_localized') . '.';
   235|                     } else {
   236|                         if ($brickField instanceof ClassDefinition\Data\UrlSlug) {
   237|                             $brickPrefix = $db->quoteIdentifier($brickKey) . '.';
   238|                         } else {
   239|                             $brickPrefix = $db->quoteIdentifier($brickType) . '.';
   240|                         }
   241|                     }
   242|                     if (is_array($filter['value'])) {
   243|                         $fieldConditions = [];
   244|                         foreach ($filter['value'] as $filterValue) {
   245|                             $brickCondition = '(' . $brickField->getFilterCondition($filterValue, $operator,
   246|                                     ['brickPrefix' => $brickPrefix]
   247|                                 ) . ' AND ' . $brickPrefix . 'fieldname = ' . $db->quote($brickFilterField) . ')';
   248|                             $fieldConditions[] = $brickCondition;
   249|                         }
   250|                         $conditionPartsFilters[] = '(' . implode(' OR ', $fieldConditions) . ')';
   251|                     } else {
   252|                         $brickCondition = '(' . $brickField->getFilterCondition($filter['value'], $operator,
   253|                                 ['brickPrefix' => $brickPrefix]) . ' AND ' . $brickPrefix . 'fieldname = ' . $db->quote($brickFilterField) . ')';
   254|                         $conditionPartsFilters[] = $brickCondition;
   255|                     }
   256|                 } elseif ($field instanceof ClassDefinition\Data\UrlSlug) {
   257|                     $conditionPartsFilters[] = $db->quoteIdentifier($field->getName()) . '.' . $field->getFilterCondition($filter['value'], $operator);
   258|                 } elseif ($field instanceof ClassDefinition\Data) {
   259|                     if (is_array($filter['value'] ?? false)) {
   260|                         $fieldConditions = [];
   261|                         foreach ($filter['value'] as $filterValue) {
   262|                             $fieldConditions[] = $field->getFilterCondition($filterValue, $operator, ['brickPrefix' => ($tablePrefix ? $tablePrefix.'.' : null)]);
   263|                         }
   264|                         if (!empty($fieldConditions)) {
   265|                             $conditionPartsFilters[] = '(' . implode(' OR ', $fieldConditions) . ')';
   266|                         }
   267|                     } else {
   268|                         $conditionPartsFilters[] = $field->getFilterCondition($filter['value'] ?? null, $operator, ['brickPrefix' => ($tablePrefix ? $tablePrefix.'.' : null)]);
   269|                     }
   270|                 } elseif (in_array('o_' . $filterField, $systemFields)) {
   271|                     if ($filterField == 'fullpath') {
   272|                         $conditionPartsFilters[] = 'concat(o_path, o_key) ' . $operator . ' ' . $db->quote('%' . $filter['value'] . '%');
   273|                     } elseif ($filterField == 'key') {
   274|                         $conditionPartsFilters[] = 'o_key ' . $operator . ' ' . $db->quote('%' . $filter['value'] . '%');
   275|                     } elseif ($filterField == 'id') {
   276|                         $conditionPartsFilters[] = 'oo_id ' . $operator . ' ' . $db->quote($filter['value']);
   277|                     } else {
   278|                         if ($filter['type'] == 'date' && $operator == '=') {
   279|                             $maxTime = $filter['value'] + (86400 - 1); //specifies the top point of the range used in the condition
   280|                             $conditionPartsFilters[] = '`o_' . $filterField . '` BETWEEN ' . $db->quote($filter['value']) . ' AND ' . $db->quote($maxTime);
   281|                         } else {
   282|                             $conditionPartsFilters[] = '`o_' . $filterField . '` ' . $operator . ' ' . $db->quote($filter['value']);
   283|                         }
   284|                     }
   285|                 }
   286|             }
   287|         }
   288|         $conditionFilters = '1 = 1';
   289|         if (count($conditionPartsFilters) > 0) {
   290|             $conditionFilters = '(' . implode(' AND ', $conditionPartsFilters) . ')';
   291|         }
   292|         Logger::log('DataObjectController filter condition:' . $conditionFilters);
   293|         return $conditionFilters;
   294|     }
   295|     /**
   296|      * @param array $fields
   297|      *
   298|      * @return array
   299|      */
   300|     protected function extractBricks(array $fields): array
   301|     {
   302|         $bricks = [];
   303|         if ($fields) {
   304|             foreach ($fields as $f) {
   305|                 $fieldName = $f;
   306|                 $parts = explode('~', $f);
   307|                 if (substr($f, 0, 1) == '~') {
   308|                 } elseif (count($parts) > 1) {
   309|                     $brickType = $parts[0];
   310|                     if (strpos($brickType, '?') !== false) {
   311|                         $brickDescriptor = substr($brickType, 1);
   312|                         $brickDescriptor = json_decode($brickDescriptor, true);
   313|                         $brickType = $brickDescriptor['containerKey'];
   314|                     }
   315|                     $bricks[$brickType] = $brickType;
   316|                 }
   317|                 $newFields[] = $fieldName;
   318|             }
   319|         }
   320|         return $bricks;
   321|     }
   322|     /**
   323|      * Adds all the query stuff that is needed for displaying, filtering and exporting the feature grid data.
   324|      *
   325|      * @param DataObject\Listing\Concrete $list
   326|      * @param array $featureJoins
   327|      * @param ClassDefinition $class
   328|      * @param array $featureAndSlugFilters
   329|      */
   330|     public function addGridFeatureJoins(DataObject\Listing\Concrete $list, array $featureJoins, ClassDefinition $class, array $featureAndSlugFilters)
   331|     {
   332|         if ($featureJoins) {
   333|             $me = $list;
   334|             $list->onCreateQueryBuilder(function (DoctrineQueryBuilder $select) use (
   335|                 $featureJoins,
   336|                 $class,
   337|                 $featureAndSlugFilters,
   338|                 $me
   339|             ) {
   340|                 $db = \Pimcore\Db::get();
   341|                 $alreadyJoined = [];
   342|                 foreach ($featureJoins as $featureJoin) {
   343|                     $fieldname = $featureJoin['fieldname'];
   344|                     $mappedKey = 'cskey_' . $fieldname . '_' . $featureJoin['groupId'] . '_' . $featureJoin['keyId'];
   345|                     if (isset($alreadyJoined[$mappedKey])) {
   346|                         continue;
   347|                     }
   348|                     $alreadyJoined[$mappedKey] = 1;
   349|                     $table = $me->getDao()->getTableName();
   350|                     $select->addSelect('value AS ' . $mappedKey);
   351|                     $select->leftJoin(
   352|                         $table,
   353|                         'object_classificationstore_data_' . $class->getId(),
   354|                         $mappedKey,
   355|                         '('
   356|                         . $mappedKey . '.o_id = ' . $table . '.o_id'
   357|                         . ' and ' . $mappedKey . '.fieldname = ' . $db->quote($fieldname)
   358|                         . ' and ' . $mappedKey . '.groupId=' . $featureJoin['groupId']
   359|                         . ' and ' . $mappedKey . '.keyId=' . $featureJoin['keyId']
   360|                         . ' and ' . $mappedKey . '.language = ' . $db->quote($featureJoin['language'])
   361|                         . ')'
   362|                     );
   363|                 }
   364|                 $havings = $featureAndSlugFilters['featureConditions'] ?? null;
   365|                 if ($havings) {
   366|                     $havings = implode(' AND ', $havings);
   367|                     $select->having($havings);
   368|                 }
   369|             });
   370|         }
   371|     }
   372|     /**
   373|      * Adds all the query stuff that is needed for displaying, filtering and exporting the slug grid data.
   374|      *
   375|      * @param DataObject\Listing\Concrete $list
   376|      * @param array $slugJoins
   377|      * @param array $featureAndSlugFilters
   378|      */
   379|     public function addSlugJoins(DataObject\Listing\Concrete $list, array $slugJoins, array $featureAndSlugFilters)
   380|     {
   381|         if ($slugJoins) {
   382|             $me = $list;
   383|             $list->onCreateQueryBuilder(function (DoctrineQueryBuilder $select) use (
   384|                 $slugJoins,
   385|                 $featureAndSlugFilters,
   386|                 $me
   387|             ) {
   388|                 $db = \Pimcore\Db::get();
   389|                 $alreadyJoined = [];
   390|                 foreach ($slugJoins as $slugJoin) {
   391|                     $fieldname = $slugJoin['fieldname'];
   392|                     $mappedKey = $fieldname;
   393|                     $alreadyJoined[$mappedKey] = 1;
   394|                     $table = $me->getDao()->getTableName();
   395|                     $select->addSelect('slug AS ' . $mappedKey);
   396|                     $select->leftJoin(
   397|                         $table,
   398|                         'object_url_slugs',
   399|                         $mappedKey,
   400|                         '('
   401|                         . $mappedKey . '.objectId = ' . $table . '.o_id'
   402|                         . ' and ' . $mappedKey . '.fieldname = ' . $db->quote($fieldname)
   403|                         . ')'
   404|                     );
   405|                 }
   406|                 $havings = $featureAndSlugFilters['slugConditions'];
   407|                 if ($havings) {
   408|                     $havings = implode(' AND ', $havings);
   409|                     $select->having($havings);
   410|                 }
   411|             });
   412|         }
   413|     }
   414|     public function prepareListingForGrid(array $requestParams, string $requestedLanguage, $adminUser): DataObject\Listing\Concrete
   415|     {
   416|         $folder = Model\DataObject::getById($requestParams['folderId']);
   417|         $class = ClassDefinition::getById($requestParams['classId']);
   418|         $className = $class->getName();
   419|         $listClass = '\\Pimcore\\Model\\DataObject\\' . ucfirst($className) . '\\Listing';
   420|         /** @var DataObject\Listing\Concrete $list */
   421|         $list = new $listClass();
   422|         $colMappings = [
   423|             'key' => 'o_key',
   424|             'filename' => 'o_key',
   425|             'id' => 'oo_id',
   426|             'published' => 'o_published',
   427|             'modificationDate' => 'o_modificationDate',
   428|             'creationDate' => 'o_creationDate',
   429|         ];
   430|         $start = 0;
   431|         $limit = 20;
   432|         $orderKey = 'o_id';
   433|         $order = 'ASC';
   434|         $fields = [];
   435|         $bricks = [];
   436|         if (!empty($requestParams['fields'])) {
   437|             $fields = $requestParams['fields'];
   438|             $bricks = $this->extractBricks($fields);
   439|         }
   440|         if (isset($requestParams['limit'])) {
   441|             $limit = $requestParams['limit'];
   442|         }
   443|         if (isset($requestParams['start'])) {
   444|             $start = $requestParams['start'];
   445|         }
   446|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($requestParams);
   447|         $doNotQuote = false;
   448|         if ($sortingSettings['order']) {
   449|             $order = $sortingSettings['order'];
   450|         }
   451|         if ($sortingSettings['orderKey'] !== null && strlen($sortingSettings['orderKey']) > 0) {
   452|             $orderKey = $sortingSettings['orderKey'];
   453|             if (substr($orderKey, 0, 1) !== '~') {
   454|                 if (array_key_exists($orderKey, $colMappings)) {
   455|                     $orderKey = $colMappings[$orderKey];
   456|                 } elseif ($orderKey === 'fullpath') {
   457|                     $orderKey = 'CAST(CONCAT(o_path, o_key) AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci';
   458|                     $doNotQuote = true;
   459|                 } elseif ($class->getFieldDefinition($orderKey) instanceof ClassDefinition\Data\QuantityValue) {
   460|                     $orderKey = 'concat(' . $orderKey . '__unit, ' . $orderKey . '__value)';
   461|                     $doNotQuote = true;
   462|                 } elseif ($class->getFieldDefinition($orderKey) instanceof ClassDefinition\Data\RgbaColor) {
   463|                     $orderKey = 'concat(' . $orderKey . '__rgb, ' . $orderKey . '__a)';
   464|                     $doNotQuote = true;
   465|                 } elseif (strpos($orderKey, '~') !== false) {
   466|                     $orderKeyParts = explode('~', $orderKey);
   467|                     if (strpos($orderKey, '?') !== false) {
   468|                         $brickDescriptor = substr($orderKeyParts[0], 1);
   469|                         $brickDescriptor = json_decode($brickDescriptor, true);
   470|                         $db = Db::get();
   471|                         $orderKey = $db->quoteIdentifier($brickDescriptor['containerKey'] . '_localized') . '.' . $db->quoteIdentifier($brickDescriptor['brickfield']);
   472|                         $doNotQuote = true;
   473|                     } elseif (count($orderKeyParts) === 2) {
   474|                         $orderKey = $orderKeyParts[0].'.'.$orderKeyParts[1];
   475|                         $doNotQuote = true;
   476|                     }
   477|                 } else {
   478|                     $orderKey = $list->getDao()->getTableName().'.'.$orderKey;
   479|                     $doNotQuote = true;
   480|                 }
   481|             }
   482|         }
   483|         $conditionFilters = [];
   484|         if (($requestParams['specificId'] ?? false) && is_numeric($requestParams['specificId'])) {
   485|             $conditionFilters[] = 'oo_id = ' . (int) $requestParams['specificId'];
   486|         }
   487|         if (isset($requestParams['only_direct_children']) && $requestParams['only_direct_children'] === 'true') {
   488|             $conditionFilters[] = 'o_parentId = ' . $folder->getId();
   489|         } else {
   490|             $quotedPath = $list->quote($folder->getRealFullPath());
   491|             $quotedWildcardPath = $list->quote($list->escapeLike(str_replace('//', '/', $folder->getRealFullPath() . '/')) . '%');
   492|             $conditionFilters[] = '(o_path = ' . $quotedPath . ' OR o_path LIKE ' . $quotedWildcardPath . ')';
   493|         }
   494|         if (!$adminUser->isAdmin()) {
   495|             $userIds = $adminUser->getRoles();
   496|             $userIds[] = $adminUser->getId();
   497|             $conditionFilters[] = ' (
   498|                                                     (select list from users_workspaces_object where userId in (' . implode(',', $userIds) . ') and LOCATE(CONCAT(o_path,o_key),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   499|                                                     OR
   500|                                                     (select list from users_workspaces_object where userId in (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(o_path,o_key))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   501|                                                  )';
   502|         }
   503|         $featureJoins = [];
   504|         $slugJoins = [];
   505|         $featureAndSlugFilters = [];
   506|         if (!empty($requestParams['filter'])) {
   507|             $conditionFilters[] = $this->getFilterCondition($requestParams['filter'], $class, $list->getDao()->getTableName());
   508|             $featureAndSlugFilters = $this->getFeatureAndSlugFilters($requestParams['filter'], $class, $requestedLanguage);
   509|             if ($featureAndSlugFilters) {
   510|                 $featureJoins = array_merge($featureJoins, $featureAndSlugFilters['featureJoins']);
   511|                 $slugJoins = array_merge($slugJoins, $featureAndSlugFilters['slugJoins']);
   512|             }
   513|         }
   514|         if (!empty($requestParams['condition']) && $adminUser->isAdmin()) {
   515|             $conditionFilters[] = '(' . $requestParams['condition'] . ')';
   516|         }
   517|         if (!empty($requestParams['query'])) {
   518|             $query = $this->filterQueryParam($requestParams['query']);
   519|             if (!empty($query)) {
   520|                 $conditionFilters[] = 'oo_id IN (SELECT id FROM search_backend_data WHERE maintype = "object" AND MATCH (`data`,`properties`) AGAINST (' . $list->quote($query) . ' IN BOOLEAN MODE))';
   521|             }
   522|         }
   523|         if (!empty($bricks)) {
   524|             foreach ($bricks as $b) {
   525|                 $brickType = $b;
   526|                 if (is_array($brickType)) {
   527|                     $brickType = $brickType['containerKey'];
   528|                 }
   529|                 $list->addObjectbrick($brickType);
   530|             }
   531|         }
   532|         $list->setCondition(implode(' AND ', $conditionFilters));
   533|         if (empty($requestParams['batch']) && empty($requestParams['ids'])) {
   534|             $list->setLimit($limit);
   535|             $list->setOffset($start);
   536|         }
   537|         if (isset($sortingSettings['isFeature']) && $sortingSettings['isFeature']) {
   538|             $orderKey = 'cskey_' . $sortingSettings['fieldname'] . '_' . $sortingSettings['groupId'] . '_' . $sortingSettings['keyId'];
   539|             $list->setOrderKey($orderKey);
   540|             $list->setGroupBy('oo_id');
   541|             $parts = explode('_', $orderKey);
   542|             $fieldname = $parts[1];
   543|             /** @var DataObject\ClassDefinition\Data\Classificationstore $csFieldDefinition */
   544|             $csFieldDefinition = $class->getFieldDefinition($fieldname);
   545|             $sortingSettings['language'] = $csFieldDefinition->isLocalized() ? $requestedLanguage : 'default';
   546|             $featureJoins[] = $sortingSettings;
   547|         } else {
   548|             $list->setOrderKey($orderKey, !$doNotQuote);
   549|         }
   550|         $list->setOrder($order);
   551|         if (!empty($requestParams['ids'])) {
   552|             $quotedIds = [];
   553|             foreach ($requestParams['ids'] as $id) {
   554|                 $quotedIds[] = $list->quote($id);
   555|             }
   556|             if (!empty($quotedIds)) {
   557|                 $list->addConditionParam('oo_id IN (' . implode(',', $quotedIds) . ')');
   558|             }
   559|         }
   560|         if ($class->getShowVariants()) {
   561|             $list->setObjectTypes([DataObject::OBJECT_TYPE_OBJECT, DataObject::OBJECT_TYPE_VARIANT]);
   562|         }
   563|         $this->addGridFeatureJoins($list, $featureJoins, $class, $featureAndSlugFilters);
   564|         $this->addSlugJoins($list, $slugJoins, $featureAndSlugFilters);
   565|         $list->setLocale($requestedLanguage);
   566|         if (empty($requestParams['filter']) && empty($requestParams['condition']) && empty($requestParams['sort'])) {
   567|             $list->setIgnoreLocalizedFields(true);
   568|         }
   569|         return $list;
   570|     }
   571|     public function prepareAssetListingForGrid($allParams, $adminUser)
   572|     {
   573|         $db = \Pimcore\Db::get();
   574|         $folder = Model\Asset::getById($allParams['folderId']);
   575|         $start = 0;
   576|         $limit = 0;
   577|         $orderKey = 'id';
   578|         $order = 'ASC';
   579|         if (isset($allParams['limit'])) {
   580|             $limit = $allParams['limit'];
   581|         }
   582|         if (isset($allParams['start'])) {
   583|             $start = $allParams['start'];
   584|         }
   585|         $orderKeyQuote = true;
   586|         $sortingSettings = \Pimcore\Bundle\AdminBundle\Helper\QueryParams::extractSortingSettings($allParams);
   587|         if ($sortingSettings['orderKey']) {
   588|             $orderKey = explode('~', $sortingSettings['orderKey'])[0];
   589|             if ($orderKey === 'fullpath') {
   590|                 $orderKey = 'CAST(CONCAT(path,filename) AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci';
   591|                 $orderKeyQuote = false;
   592|             } elseif ($orderKey === 'filename') {
   593|                 $orderKey = 'CAST(filename AS CHAR CHARACTER SET utf8) COLLATE utf8_general_ci';
   594|                 $orderKeyQuote = false;
   595|             }
   596|             $order = $sortingSettings['order'];
   597|         }
   598|         $list = new Model\Asset\Listing();
   599|         $conditionFilters = [];
   600|         if (isset($allParams['only_direct_children']) && $allParams['only_direct_children'] == 'true') {
   601|             $conditionFilters[] = 'parentId = ' . $folder->getId();
   602|         } else {
   603|             $conditionFilters[] = 'path LIKE ' . ($folder->getRealFullPath() === '/' ? "'/%'" : $list->quote($list->escapeLike($folder->getRealFullPath()) . '/%'));
   604|         }
   605|         if (isset($allParams['only_unreferenced']) && $allParams['only_unreferenced'] === 'true') {
   606|             $conditionFilters[] = 'id NOT IN (SELECT targetid FROM dependencies WHERE targettype=\'asset\')';
   607|         }
   608|         $conditionFilters[] = "type != 'folder'";
   609|         $filterJson = $allParams['filter'] ?? null;
   610|         if ($filterJson) {
   611|             $filters = json_decode($filterJson, true);
   612|             foreach ($filters as $filter) {
   613|                 $operator = '=';
   614|                 $filterDef = explode('~', $filter['property']);
   615|                 $filterField = $filterDef[0];
   616|                 $filterOperator = $filter['operator'];
   617|                 $filterType = $filter['type'];
   618|                 if ($filterType == 'string') {
   619|                     $operator = 'LIKE';
   620|                 } elseif ($filterType == 'numeric') {
   621|                     if ($filterOperator == 'lt') {
   622|                         $operator = '<';
   623|                     } elseif ($filterOperator == 'gt') {
   624|                         $operator = '>';
   625|                     } elseif ($filterOperator == 'eq') {
   626|                         $operator = '=';
   627|                     }
   628|                 } elseif ($filterType == 'date') {
   629|                     $filter['value'] = strtotime($filter['value']);
   630|                     if ($filterOperator == 'lt') {
   631|                         $operator = '<';
   632|                     } elseif ($filterOperator == 'gt') {
   633|                         $operator = '>';
   634|                     } elseif ($filterOperator == 'eq') {
   635|                         $operator = 'BETWEEN';
   636|                         $maxTime = $filter['value'] + (86400 - 1); //specifies the top point of the range used in the condition
   637|                         $filter['value'] = $db->quote($filter['value']) . ' AND ' . $db->quote($maxTime);
   638|                     }
   639|                 } elseif ($filterType == 'list') {
   640|                     $operator = 'IN';
   641|                 } elseif ($filterType == 'boolean') {
   642|                     $operator = '=';
   643|                     $filter['value'] = (int) $filter['value'];
   644|                 }
   645|                 $value = $filter['value'] ?? '';
   646|                 if ($operator == 'LIKE') {
   647|                     $value = $db->quote('%' . $value . '%');
   648|                 } elseif ($operator == 'IN') {
   649|                     $quoted = array_map(function ($val) use ($db) {
   650|                         return $db->quote($val);
   651|                     }, $value);
   652|                     $value = '(' . implode(',', $quoted) . ')';
   653|                 } elseif ($operator == 'BETWEEN') {
   654|                 } else {
   655|                     $value = $db->quote($value);
   656|                 }
   657|                 if ($filterField == 'fullpath') {
   658|                     $filterField = 'CONCAT(path,filename)';
   659|                 }
   660|                 if (isset($filterDef[1]) && $filterDef[1] == 'system') {
   661|                     $conditionFilters[] = $filterField . ' ' . $operator . ' ' . $value;
   662|                 } else {
   663|                     $language = $allParams['language'];
   664|                     if (isset($filterDef[1])) {
   665|                         $language = $filterDef[1];
   666|                     }
   667|                     $language = str_replace(['none', 'default'], '', $language);
   668|                     $conditionFilters[] = 'id IN (SELECT cid FROM assets_metadata WHERE `name` = ' . $db->quote($filterField) . ' AND `data` ' . $operator . ' ' . $value . ' AND `language` = ' . $db->quote($language). ')';
   669|                 }
   670|             }
   671|         }
   672|         if (!$adminUser->isAdmin()) {
   673|             $userIds = $adminUser->getRoles();
   674|             $userIds[] = $adminUser->getId();
   675|             $conditionFilters[] = ' (
   676|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(CONCAT(path, filename),cpath)=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   677|                                                     OR
   678|                                                     (select list from users_workspaces_asset where userId in (' . implode(',', $userIds) . ') and LOCATE(cpath,CONCAT(path, filename))=1  ORDER BY LENGTH(cpath) DESC LIMIT 1)=1
   679|                                                  )';
   680|         }
   681|         if (!empty($allParams['tagIds'])) {
   682|             $tagIds = $allParams['tagIds'];
   683|             foreach ($tagIds as $tagId) {
   684|                 if ($allParams['considerChildTags'] ?? false) {
   685|                     $tag = Model\Element\Tag::getById($tagId);
   686|                     if ($tag) {
   687|                         $tagPath = $tag->getFullIdPath();
   688|                         $conditionFilters[] = 'id IN (SELECT cId FROM `tags_assignment` INNER JOIN `tags` ON tags.id = tags_assignment.tagid WHERE `ctype` = "asset" AND (`id` = ' .(int)$tagId. ' OR `idPath` LIKE ' . $db->quote($tagPath . '%') . '))';
   689|                     }
   690|                 } else {
   691|                     $conditionFilters[] = 'id IN (SELECT cId FROM `tags_assignment` WHERE `ctype` = "asset" AND tagid = ' .(int)$tagId. ')';
   692|                 }
   693|             }
   694|         }
   695|         $condition = implode(' AND ', $conditionFilters);
   696|         $list->setCondition($condition);
   697|         $list->setLimit($limit);
   698|         $list->setOffset($start);
   699|         $list->setOrder($order);
   700|         $list->setOrderKey($orderKey, $orderKeyQuote);
   701|         return $list;
   702|     }
   703|     /**
   704|      * @param string $query
   705|      *
   706|      * @return string
   707|      */
   708|     protected function filterQueryParam(string $query)
   709|     {
   710|         if ($query == '*') {
   711|             $query = '';
   712|         }
   713|         $query = str_replace('%', '*', $query);
   714|         $query = str_replace('@', '#', $query);
   715|         $query = preg_replace("@([^ ])\-@", '$1 ', $query);
   716|         $query = str_replace(['<', '>', '(', ')', '~'], ' ', $query);
   717|         $query = preg_replace('#[*]+#', '*', $query);
   718|         $query = rtrim($query, '+- ');
   719|         return $query;
   720|     }
   721| }


# ====================================================================
# FILE: bundles/AdminBundle/Helper/QueryParams.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-131 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\Helper;
    15| use Carbon\Carbon;
    16| /**
    17|  * @internal
    18|  */
    19| class QueryParams
    20| {
    21|     /**
    22|      * @param array $params
    23|      *
    24|      * @return array  [orderKey => null|string, order => null|string]
    25|      */
    26|     public static function extractSortingSettings($params)
    27|     {
    28|         $orderKey = null;
    29|         $order = null;
    30|         $sortParam = isset($params['sort']) ? $params['sort'] : false;
    31|         if ($sortParam) {
    32|             $sortParam = json_decode($sortParam, true);
    33|             $sortParam = $sortParam[0];
    34|             if (substr($sortParam['property'], 0, 1) != '~') {
    35|                 $orderKey = $sortParam['property'];
    36|                 $order = $sortParam['direction'];
    37|             } else {
    38|                 $orderKey = $sortParam['property'];
    39|                 $order = $sortParam['direction'];
    40|                 $parts = explode('~', $orderKey);
    41|                 $fieldname = $parts[2];
    42|                 $groupKeyId = $parts[3];
    43|                 $groupKeyId = explode('-', $groupKeyId);
    44|                 $groupId = $groupKeyId[0];
    45|                 $keyid = $groupKeyId[1];
    46|                 return ['orderKey' => $sortParam['property'], 'fieldname' => $fieldname, 'groupId' => $groupId, 'keyId' => $keyid, 'order' => $order, 'isFeature' => 1];
    47|             }
    48|         }
    49|         return ['orderKey' => $orderKey, 'order' => $order];
    50|     }
    51|     /**
    52|      * @param string $param
    53|      *
    54|      * @return int
    55|      */
    56|     public static function getRecordIdForGridRequest($param)
    57|     {
    58|         $param = json_decode($param, true);
    59|         return $param['id'];
    60|     }
    61|     /**
    62|      * Creates a condition string from the passed ExtJs filter definitions
    63|      *
    64|      * @param string $filterString
    65|      * @param array $matchExact
    66|      * @param bool $returnString
    67|      * @param array $callbacks
    68|      *
    69|      * @return array|string
    70|      *
    71|      * @throws \Exception
    72|      */
    73|     public static function getFilterCondition($filterString, $matchExact = ['id', 'o_id'], $returnString = true, $callbacks = [])
    74|     {
    75|         if (!$filterString) {
    76|             return '';
    77|         }
    78|         $conditions = [];
    79|         $filters = json_decode($filterString);
    80|         $db = \Pimcore\Db::get();
    81|         foreach ($filters as $f) {
    82|             if ($f->type == 'string') {
    83|                 if (in_array($f->property, $matchExact)) {
    84|                     $conditions[$f->property][] = ' ' . $db->quoteIdentifier($f->property) . ' = ' . $db->quote($f->value) . ' ';
    85|                 } else {
    86|                     $conditions[$f->property][] = ' ' . $db->quoteIdentifier($f->property) . ' LIKE ' . $db->quote('%' . $f->value . '%') . ' ';
    87|                 }
    88|             } elseif ($f->type == 'numeric') {
    89|                 $symbol = null;
    90|                 if ($f->operator == 'eq') {
    91|                     $symbol = ' = ';
    92|                 } elseif ($f->operator == 'lt') {
    93|                     $symbol = ' < ';
    94|                 } elseif ($f->operator == 'gt') {
    95|                     $symbol = ' > ';
    96|                 }
    97|                 $conditions[$f->property][] = ' ' . $db->quoteIdentifier($f->property)  . ' ' . $symbol . $db->quote($f->value) . ' ';
    98|             } elseif ($f->type == 'date') {
    99|                 /**
   100|                  * make sure you pass the date as timestamp
   101|                  *
   102|                  * filter: {type : 'date',dateFormat: 'timestamp'}
   103|                  */
   104|                 $date = Carbon::createFromTimestamp($f->value)->setTime(0, 0, 0);
   105|                 if ($f->operator == 'eq') {
   106|                     $conditions[$f->property][] = ' ' . $f->property . ' >= ' . $db->quote($date->getTimestamp());
   107|                     $conditions[$f->property][] = ' ' . $f->property . ' <= ' . $db->quote($date->addDay()->subSecond()->getTimestamp());
   108|                 } elseif ($f->operator == 'lt') {
   109|                     $conditions[$f->property][] = ' ' . $f->property . ' < ' . $db->quote($date->getTimestamp());
   110|                 } elseif ($f->operator == 'gt') {
   111|                     $conditions[$f->property][] = ' ' . $f->property . ' > ' . $db->quote($date->addDay()->subSecond()->getTimestamp());
   112|                 }
   113|             } else {
   114|                 throw new \Exception('Filer of type ' . $f->type . ' not jet supported.');
   115|             }
   116|         }
   117|         $conditionsGrouped = [];
   118|         foreach ($conditions as $fieldName => $fieldConditions) {
   119|             if (count($fieldConditions) > 1) {
   120|                 $conditionsGrouped[$fieldName] = ' (' . implode(' AND ', $fieldConditions) . ') ';
   121|             } else {
   122|                 $conditionsGrouped[$fieldName] = $fieldConditions[0];
   123|             }
   124|         }
   125|         if ($returnString) {
   126|             return implode(' OR ', $conditionsGrouped);
   127|         } else {
   128|             return $conditionsGrouped;
   129|         }
   130|     }
   131| }


# ====================================================================
# FILE: bundles/AdminBundle/HttpFoundation/JsonResponse.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle\HttpFoundation;
    15| use Pimcore\Tool\Serialize;
    16| use Symfony\Component\HttpFoundation\JsonResponse as BaseJsonResponse;
    17| /**
    18|  * This response serializes its data through the admin serializer (with reference loop handling) instead
    19|  * of calling json_encode. This is to make sure we have consistent responses with `$this->json()` and `new JsonResponse`
    20|  * in admin controllers.
    21|  */
    22| class JsonResponse extends BaseJsonResponse
    23| {
    24|     /**
    25|      * {@inheritdoc}
    26|      */
    27|     public function setData($data = [])
    28|     {
    29|         $serializer = Serialize::getAdminSerializer();
    30|         $json = $serializer->serialize($data, 'json', [
    31|             'json_encode_options' => $this->encodingOptions,
    32|         ]);
    33|         return $this->setJson($json);
    34|     }
    35| }


# ====================================================================
# FILE: bundles/AdminBundle/PimcoreAdminBundle.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| /**
     3|  * Pimcore
     4|  *
     5|  * This source file is available under two different licenses:
     6|  * - GNU General Public License version 3 (GPLv3)
     7|  * - Pimcore Commercial License (PCL)
     8|  * Full copyright and license information is available in
     9|  * LICENSE.md which is distributed with this source code.
    10|  *
    11|  *  @copyright  Copyright (c) Pimcore GmbH (http://www.pimcore.org)
    12|  *  @license    http://www.pimcore.org/license     GPLv3 and PCL
    13|  */
    14| namespace Pimcore\Bundle\AdminBundle;
    15| use Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler\GDPRDataProviderPass;
    16| use Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler\ImportExportLocatorsPass;
    17| use Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler\SerializerPass;
    18| use Pimcore\Bundle\AdminBundle\DependencyInjection\Compiler\TranslationServicesPass;
    19| use Pimcore\Bundle\AdminBundle\GDPR\DataProvider\DataProviderInterface;
    20| use Pimcore\Bundle\AdminBundle\Security\Factory\PreAuthenticatedAdminSessionFactory;
    21| use Symfony\Bundle\SecurityBundle\DependencyInjection\SecurityExtension;
    22| use Symfony\Component\DependencyInjection\ContainerBuilder;
    23| use Symfony\Component\HttpKernel\Bundle\Bundle;
    24| /**
    25|  * @internal
    26|  */
    27| class PimcoreAdminBundle extends Bundle
    28| {
    29|     /**
    30|      * {@inheritdoc}
    31|      */
    32|     public function build(ContainerBuilder $container)
    33|     {
    34|         $container
    35|             ->registerForAutoconfiguration(DataProviderInterface::class)
    36|             ->addTag('pimcore.gdpr.data-provider');
    37|         $container->addCompilerPass(new SerializerPass());
    38|         $container->addCompilerPass(new GDPRDataProviderPass());
    39|         $container->addCompilerPass(new ImportExportLocatorsPass());
    40|         $container->addCompilerPass(new TranslationServicesPass());
    41|         /** @var SecurityExtension $extension */
    42|         $extension = $container->getExtension('security');
    43|         $extension->addSecurityListenerFactory(new PreAuthenticatedAdminSessionFactory());
    44|     }
    45| }


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/ajax/DataSimlet.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-178 ---
     1| /**
     2|  * This base class is used to handle data preparation (e.g., sorting, filtering and
     3|  * group summary).
     4|  */
     5| Ext.define('Ext.ux.ajax.DataSimlet', function() {
     6|     function makeSortFn(def, cmp) {
     7|         var order = def.direction,
     8|             sign = (order && order.toUpperCase() === 'DESC') ? -1 : 1;
     9|         return function(leftRec, rightRec) {
    10|             var lhs = leftRec[def.property],
    11|                 rhs = rightRec[def.property],
    12|                 c = (lhs < rhs) ? -1 : ((rhs < lhs) ? 1 : 0);
    13|             if (c || !cmp) {
    14|                 return c * sign;
    15|             }
    16|             return cmp(leftRec, rightRec);
    17|         };
    18|     }
    19|     function makeSortFns(defs, cmp) {
    20|         var sortFn, i;
    21|         for (sortFn = cmp, i = defs && defs.length; i;) {
    22|             sortFn = makeSortFn(defs[--i], sortFn);
    23|         }
    24|         return sortFn;
    25|     }
    26|     return {
    27|         extend: 'Ext.ux.ajax.Simlet',
    28|         buildNodes: function(node, path) {
    29|             var me = this,
    30|                 nodeData = {
    31|                     data: []
    32|                 },
    33|                 len = node.length,
    34|                 children, i, child, name;
    35|             me.nodes[path] = nodeData;
    36|             for (i = 0; i < len; ++i) {
    37|                 nodeData.data.push(child = node[i]);
    38|                 name = child.text || child.title;
    39|                 child.id = path ? path + '/' + name : name;
    40|                 children = child.children;
    41|                 if (!(child.leaf = !children)) {
    42|                     delete child.children;
    43|                     me.buildNodes(children, child.id);
    44|                 }
    45|             }
    46|         },
    47|         deleteRecord: function(pos) {
    48|             if (this.data && typeof this.data !== 'function') {
    49|                 Ext.Array.removeAt(this.data, pos);
    50|             }
    51|         },
    52|         fixTree: function(ctx, tree) {
    53|             var me = this,
    54|                 node = ctx.params.node,
    55|                 nodes;
    56|             if (!(nodes = me.nodes)) {
    57|                 me.nodes = nodes = {};
    58|                 me.buildNodes(tree, '');
    59|             }
    60|             node = nodes[node];
    61|             if (node) {
    62|                 if (me.node) {
    63|                     me.node.sortedData = me.sortedData;
    64|                     me.node.currentOrder = me.currentOrder;
    65|                 }
    66|                 me.node = node;
    67|                 me.data = node.data;
    68|                 me.sortedData = node.sortedData;
    69|                 me.currentOrder = node.currentOrder;
    70|             }
    71|             else {
    72|                 me.data = null;
    73|             }
    74|         },
    75|         getData: function(ctx) {
    76|             var me = this,
    77|                 params = ctx.params,
    78|                 order = (params.filter || '') + (params.group || '') + '-' + (params.sort || '') +
    79|                         '-' + (params.dir || ''),
    80|                 tree = me.tree,
    81|                 dynamicData, data, fields, sortFn, filters;
    82|             if (tree) {
    83|                 me.fixTree(ctx, tree);
    84|             }
    85|             data = me.data;
    86|             if (typeof data === 'function') {
    87|                 dynamicData = true;
    88|                 data = data.call(this, ctx);
    89|             }
    90|             if (!data || order === '--') {
    91|                 return data || [];
    92|             }
    93|             if (!dynamicData && order === me.currentOrder) {
    94|                 return me.sortedData;
    95|             }
    96|             ctx.filterSpec = params.filter && Ext.decode(params.filter);
    97|             ctx.groupSpec = params.group && Ext.decode(params.group);
    98|             fields = params.sort;
    99|             if (params.dir) {
   100|                 fields = [{ direction: params.dir, property: fields }];
   101|             }
   102|             else if (params.sort) {
   103|                 fields = Ext.decode(params.sort);
   104|             }
   105|             else {
   106|                 fields = null;
   107|             }
   108|             if (ctx.filterSpec) {
   109|                 filters = new Ext.util.FilterCollection();
   110|                 filters.add(this.processFilters(ctx.filterSpec));
   111|                 data = Ext.Array.filter(data, filters.getFilterFn());
   112|             }
   113|             sortFn = makeSortFns((ctx.sortSpec = fields));
   114|             if (ctx.groupSpec) {
   115|                 sortFn = makeSortFns([ctx.groupSpec], sortFn);
   116|             }
   117|             data = Ext.isArray(data) ? data.slice(0) : data;
   118|             if (sortFn) {
   119|                 Ext.Array.sort(data, sortFn);
   120|             }
   121|             me.sortedData = data;
   122|             me.currentOrder = order;
   123|             return data;
   124|         },
   125|         processFilters: Ext.identityFn,
   126|         getPage: function(ctx, data) {
   127|             var ret = data,
   128|                 length = data.length,
   129|                 start = ctx.params.start || 0,
   130|                 end = ctx.params.limit ? Math.min(length, start + ctx.params.limit) : length;
   131|             if (start || end < length) {
   132|                 ret = ret.slice(start, end);
   133|             }
   134|             return ret;
   135|         },
   136|         getGroupSummary: function(groupField, rows, ctx) {
   137|             return rows[0];
   138|         },
   139|         getSummary: function(ctx, data, page) {
   140|             var me = this,
   141|                 groupField = ctx.groupSpec.property,
   142|                 accum,
   143|                 todo = {},
   144|                 summary = [],
   145|                 fieldValue,
   146|                 lastFieldValue;
   147|             Ext.each(page, function(rec) {
   148|                 fieldValue = rec[groupField];
   149|                 todo[fieldValue] = true;
   150|             });
   151|             function flush() {
   152|                 if (accum) {
   153|                     summary.push(me.getGroupSummary(groupField, accum, ctx));
   154|                     accum = null;
   155|                 }
   156|             }
   157|             Ext.each(data, function(rec) {
   158|                 fieldValue = rec[groupField];
   159|                 if (lastFieldValue !== fieldValue) {
   160|                     flush();
   161|                     lastFieldValue = fieldValue;
   162|                 }
   163|                 if (!todo[fieldValue]) {
   164|                     return !summary.length;
   165|                 }
   166|                 if (accum) {
   167|                     accum.push(rec);
   168|                 }
   169|                 else {
   170|                     accum = [rec];
   171|                 }
   172|                 return true;
   173|             });
   174|             flush(); // make sure that last pesky summary goes...
   175|             return summary;
   176|         }
   177|     };
   178| }());


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/ajax/JsonSimlet.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| /**
     2|  * JSON Simlet.
     3|  */
     4| Ext.define('Ext.ux.ajax.JsonSimlet', {
     5|     extend: 'Ext.ux.ajax.DataSimlet',
     6|     alias: 'simlet.json',
     7|     doGet: function(ctx) {
     8|         var me = this,
     9|             data = me.getData(ctx),
    10|             page = me.getPage(ctx, data),
    11|             reader = ctx.xhr.options.proxy && ctx.xhr.options.proxy.getReader(),
    12|             root = reader && reader.getRootProperty(),
    13|             ret = me.callParent(arguments), // pick up status/statusText
    14|             response = {};
    15|         if (root && Ext.isArray(page)) {
    16|             response[root] = page;
    17|             response[reader.getTotalProperty()] = data.length;
    18|         }
    19|         else {
    20|             response = page;
    21|         }
    22|         if (ctx.groupSpec) {
    23|             response.summaryData = me.getSummary(ctx, data, page);
    24|         }
    25|         ret.responseText = Ext.encode(response);
    26|         return ret;
    27|     },
    28|     doPost: function(ctx) {
    29|         return this.doGet(ctx);
    30|     }
    31| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/ajax/PivotSimlet.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-185 ---
     1| /**
     2|  * Pivot Simlet does remote pivot calculations.
     3|  * Filtering the pivot results doesn't work.
     4|  */
     5| Ext.define('Ext.ux.ajax.PivotSimlet', {
     6|     extend: 'Ext.ux.ajax.JsonSimlet',
     7|     alias: 'simlet.pivot',
     8|     lastPost: null, // last Ajax params sent to this simlet
     9|     lastResponse: null, // last JSON response produced by this simlet
    10|     keysSeparator: '',
    11|     grandTotalKey: '',
    12|     doPost: function(ctx) {
    13|         var me = this,
    14|             ret = me.callParent(arguments); // pick up status/statusText
    15|         me.lastResponse = me.processData(me.getData(ctx), Ext.decode(ctx.xhr.body));
    16|         ret.responseText = Ext.encode(me.lastResponse);
    17|         return ret;
    18|     },
    19|     processData: function(data, params) {
    20|         var me = this,
    21|             len = data.length,
    22|             response = {
    23|                 success: true,
    24|                 leftAxis: [],
    25|                 topAxis: [],
    26|                 results: []
    27|             },
    28|             leftAxis = new Ext.util.MixedCollection(),
    29|             topAxis = new Ext.util.MixedCollection(),
    30|             results = new Ext.util.MixedCollection(),
    31|             i, j, k, leftKeys, topKeys, item, agg;
    32|         me.lastPost = params;
    33|         me.keysSeparator = params.keysSeparator;
    34|         me.grandTotalKey = params.grandTotalKey;
    35|         for (i = 0; i < len; i++) {
    36|             leftKeys = me.extractValues(data[i], params.leftAxis, leftAxis);
    37|             topKeys = me.extractValues(data[i], params.topAxis, topAxis);
    38|             me.addResult(data[i], me.grandTotalKey, me.grandTotalKey, results);
    39|             for (j = 0; j < leftKeys.length; j++) {
    40|                 me.addResult(data[i], leftKeys[j], me.grandTotalKey, results);
    41|                 for (k = 0; k < topKeys.length; k++) {
    42|                     me.addResult(data[i], leftKeys[j], topKeys[k], results);
    43|                 }
    44|             }
    45|             for (j = 0; j < topKeys.length; j++) {
    46|                 me.addResult(data[i], me.grandTotalKey, topKeys[j], results);
    47|             }
    48|         }
    49|         response.leftAxis = leftAxis.getRange();
    50|         response.topAxis = topAxis.getRange();
    51|         len = results.getCount();
    52|         for (i = 0; i < len; i++) {
    53|             item = results.getAt(i);
    54|             item.values = {};
    55|             for (j = 0; j < params.aggregate.length; j++) {
    56|                 agg = params.aggregate[j];
    57|                 item.values[agg.id] = me[agg.aggregator](
    58|                     item.records, agg.dataIndex, item.leftKey, item.topKey
    59|                 );
    60|             }
    61|             delete(item.records);
    62|             response.results.push(item);
    63|         }
    64|         leftAxis.clear();
    65|         topAxis.clear();
    66|         results.clear();
    67|         return response;
    68|     },
    69|     getKey: function(value) {
    70|         var me = this;
    71|         me.keysMap = me.keysMap || {};
    72|         if (!Ext.isDefined(me.keysMap[value])) {
    73|             me.keysMap[value] = Ext.id();
    74|         }
    75|         return me.keysMap[value];
    76|     },
    77|     extractValues: function(record, dimensions, col) {
    78|         var len = dimensions.length,
    79|             keys = [],
    80|             j, key, item, dim;
    81|         key = '';
    82|         for (j = 0; j < len; j++) {
    83|             dim = dimensions[j];
    84|             key += (j > 0 ? this.keysSeparator : '') + this.getKey(record[dim.dataIndex]);
    85|             item = col.getByKey(key);
    86|             if (!item) {
    87|                 item = col.add(key, {
    88|                     key: key,
    89|                     value: record[dim.dataIndex],
    90|                     dimensionId: dim.id
    91|                 });
    92|             }
    93|             keys.push(key);
    94|         }
    95|         return keys;
    96|     },
    97|     addResult: function(record, leftKey, topKey, results) {
    98|         var item = results.getByKey(leftKey + '/' + topKey);
    99|         if (!item) {
   100|             item = results.add(leftKey + '/' + topKey, {
   101|                 leftKey: leftKey,
   102|                 topKey: topKey,
   103|                 records: []
   104|             });
   105|         }
   106|         item.records.push(record);
   107|     },
   108|     sum: function(records, measure, rowGroupKey, colGroupKey) {
   109|         var length = records.length,
   110|             total = 0,
   111|             i;
   112|         for (i = 0; i < length; i++) {
   113|             total += Ext.Number.from(records[i][measure], 0);
   114|         }
   115|         return total;
   116|     },
   117|     avg: function(records, measure, rowGroupKey, colGroupKey) {
   118|         var length = records.length,
   119|             total = 0,
   120|             i;
   121|         for (i = 0; i < length; i++) {
   122|             total += Ext.Number.from(records[i][measure], 0);
   123|         }
   124|         return length > 0 ? (total / length) : 0;
   125|     },
   126|     min: function(records, measure, rowGroupKey, colGroupKey) {
   127|         var data = [],
   128|             length = records.length,
   129|             i, v;
   130|         for (i = 0; i < length; i++) {
   131|             data.push(records[i][measure]);
   132|         }
   133|         v = Ext.Array.min(data);
   134|         return v;
   135|     },
   136|     max: function(records, measure, rowGroupKey, colGroupKey) {
   137|         var data = [],
   138|             length = records.length,
   139|             i, v;
   140|         for (i = 0; i < length; i++) {
   141|             data.push(records[i][measure]);
   142|         }
   143|         v = Ext.Array.max(data);
   144|         return v;
   145|     },
   146|     count: function(records, measure, rowGroupKey, colGroupKey) {
   147|         return records.length;
   148|     },
   149|     variance: function(records, measure, rowGroupKey, colGroupKey) {
   150|         var me = Ext.pivot.Aggregators,
   151|             length = records.length,
   152|             avg = me.avg.apply(me, arguments),
   153|             total = 0,
   154|             i;
   155|         if (avg > 0) {
   156|             for (i = 0; i < length; i++) {
   157|                 total += Math.pow(Ext.Number.from(records[i][measure], 0) - avg, 2);
   158|             }
   159|         }
   160|         return (total > 0 && length > 1) ? (total / (length - 1)) : 0;
   161|     },
   162|     varianceP: function(records, measure, rowGroupKey, colGroupKey) {
   163|         var me = Ext.pivot.Aggregators,
   164|             length = records.length,
   165|             avg = me.avg.apply(me, arguments),
   166|             total = 0,
   167|             i;
   168|         if (avg > 0) {
   169|             for (i = 0; i < length; i++) {
   170|                 total += Math.pow(Ext.Number.from(records[i][measure], 0) - avg, 2);
   171|             }
   172|         }
   173|         return (total > 0 && length > 0) ? (total / length) : 0;
   174|     },
   175|     stdDev: function(records, measure, rowGroupKey, colGroupKey) {
   176|         var me = Ext.pivot.Aggregators,
   177|             v = me.variance.apply(me, arguments);
   178|         return v > 0 ? Math.sqrt(v) : 0;
   179|     },
   180|     stdDevP: function(records, measure, rowGroupKey, colGroupKey) {
   181|         var me = Ext.pivot.Aggregators,
   182|             v = me.varianceP.apply(me, arguments);
   183|         return v > 0 ? Math.sqrt(v) : 0;
   184|     }
   185| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/ajax/SimManager.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-206 ---
     1| /**
     2|  * This singleton manages simulated Ajax responses. This allows application logic to be
     3|  * written unaware that its Ajax calls are being handled by simulations ("simlets"). This
     4|  * is currently done by hooking {@link Ext.data.Connection} methods, so all users of that
     5|  * class (and {@link Ext.Ajax} since it is a derived class) qualify for simulation.
     6|  *
     7|  * The requires hooks are inserted when either the {@link #init} method is called or the
     8|  * first {@link Ext.ux.ajax.Simlet} is registered. For example:
     9|  *
    10|  *      Ext.onReady(function () {
    11|  *          initAjaxSim();
    12|  *
    13|  *          // normal stuff
    14|  *      });
    15|  *
    16|  *      function initAjaxSim () {
    17|  *          Ext.ux.ajax.SimManager.init({
    18|  *              delay: 300
    19|  *          }).register({
    20|  *              '/app/data/url': {
    21|  *                  type: 'json',  // use JsonSimlet (type is like xtype for components)
    22|  *                  data: [
    23|  *                      { foo: 42, bar: 'abc' },
    24|  *                      ...
    25|  *                  ]
    26|  *              }
    27|  *          });
    28|  *      }
    29|  *
    30|  * As many URL's as desired can be registered and associated with a {@link Ext.ux.ajax.Simlet}.
    31|  * To make non-simulated Ajax requests once this singleton is initialized, add a `nosim:true` option
    32|  * to the Ajax options:
    33|  *
    34|  *      Ext.Ajax.request({
    35|  *          url: 'page.php',
    36|  *          nosim: true, // ignored by normal Ajax request
    37|  *          params: {
    38|  *              id: 1
    39|  *          },
    40|  *          success: function(response){
    41|  *              var text = response.responseText;
    42|  *              // process server response here
    43|  *          }
    44|  *      });
    45|  */
    46| Ext.define('Ext.ux.ajax.SimManager', {
    47|     singleton: true,
    48|     requires: [
    49|         'Ext.data.Connection',
    50|         'Ext.ux.ajax.SimXhr',
    51|         'Ext.ux.ajax.Simlet',
    52|         'Ext.ux.ajax.JsonSimlet'
    53|     ],
    54|     /**
    55|      * @cfg {Ext.ux.ajax.Simlet} defaultSimlet
    56|      * The {@link Ext.ux.ajax.Simlet} instance to use for non-matching URL's. By default, this will
    57|      * return 404. Set this to null to use real Ajax calls for non-matching URL's.
    58|      */
    59|     /**
    60|      * @cfg {String} defaultType
    61|      * The default `type` to apply to generic {@link Ext.ux.ajax.Simlet} configuration objects. The
    62|      * default is 'basic'.
    63|      */
    64|     defaultType: 'basic',
    65|     /**
    66|      * @cfg {Number} delay
    67|      * The number of milliseconds to delay before delivering a response to an async request.
    68|      */
    69|     delay: 150,
    70|     /**
    71|      * @property {Boolean} ready
    72|      * True once this singleton has initialized and applied its Ajax hooks.
    73|      * @private
    74|      */
    75|     ready: false,
    76|     constructor: function() {
    77|         this.simlets = [];
    78|     },
    79|     getSimlet: function(url) {
    80|         var me = this,
    81|             index = url.indexOf('?'),
    82|             simlets = me.simlets,
    83|             len = simlets.length,
    84|             i, simlet, simUrl, match;
    85|         if (index < 0) {
    86|             index = url.indexOf('#');
    87|         }
    88|         if (index > 0) {
    89|             url = url.substring(0, index);
    90|         }
    91|         for (i = 0; i < len; ++i) {
    92|             simlet = simlets[i];
    93|             simUrl = simlet.url;
    94|             if (simUrl instanceof RegExp) {
    95|                 match = simUrl.test(url);
    96|             }
    97|             else {
    98|                 match = simUrl === url;
    99|             }
   100|             if (match) {
   101|                 return simlet;
   102|             }
   103|         }
   104|         return me.defaultSimlet;
   105|     },
   106|     getXhr: function(method, url, options, async) {
   107|         var simlet = this.getSimlet(url);
   108|         if (simlet) {
   109|             return simlet.openRequest(method, url, options, async);
   110|         }
   111|         return null;
   112|     },
   113|     /**
   114|      * Initializes this singleton and applies configuration options.
   115|      * @param {Object} config An optional object with configuration properties to apply.
   116|      * @return {Ext.ux.ajax.SimManager} this
   117|      */
   118|     init: function(config) {
   119|         var me = this;
   120|         Ext.apply(me, config);
   121|         if (!me.ready) {
   122|             me.ready = true;
   123|             if (!('defaultSimlet' in me)) {
   124|                 me.defaultSimlet = new Ext.ux.ajax.Simlet({
   125|                     status: 404,
   126|                     statusText: 'Not Found'
   127|                 });
   128|             }
   129|             me._openRequest = Ext.data.Connection.prototype.openRequest;
   130|             Ext.data.request.Ajax.override({
   131|                 openRequest: function(options, requestOptions, async) {
   132|                     var xhr = !options.nosim &&
   133|                               me.getXhr(requestOptions.method, requestOptions.url, options, async);
   134|                     if (!xhr) {
   135|                         xhr = this.callParent(arguments);
   136|                     }
   137|                     return xhr;
   138|                 }
   139|             });
   140|             if (Ext.data.JsonP) {
   141|                 Ext.data.JsonP.self.override({
   142|                     createScript: function(url, params, options) {
   143|                         var fullUrl = Ext.urlAppend(url, Ext.Object.toQueryString(params)),
   144|                             script = !options.nosim &&
   145|                                      me.getXhr('GET', fullUrl, options, true);
   146|                         if (!script) {
   147|                             script = this.callParent(arguments);
   148|                         }
   149|                         return script;
   150|                     },
   151|                     loadScript: function(request) {
   152|                         var script = request.script;
   153|                         if (script.simlet) {
   154|                             script.jsonpCallback = request.params[request.callbackKey];
   155|                             script.send(null);
   156|                             request.script = document.createElement('script');
   157|                         }
   158|                         else {
   159|                             this.callParent(arguments);
   160|                         }
   161|                     }
   162|                 });
   163|             }
   164|         }
   165|         return me;
   166|     },
   167|     openRequest: function(method, url, async) {
   168|         var opt = {
   169|             method: method,
   170|             url: url
   171|         };
   172|         return this._openRequest.call(Ext.data.Connection.prototype, {}, opt, async);
   173|     },
   174|     /**
   175|      * Registeres one or more {@link Ext.ux.ajax.Simlet} instances.
   176|      * @param {Array/Object} simlet Either a {@link Ext.ux.ajax.Simlet} instance or config, an Array
   177|      * of such elements or an Object keyed by URL with values that are {@link Ext.ux.ajax.Simlet}
   178|      * instances or configs.
   179|      */
   180|     register: function(simlet) {
   181|         var me = this;
   182|         me.init();
   183|         function reg(one) {
   184|             var simlet = one;
   185|             if (!simlet.isSimlet) {
   186|                 simlet =
   187|                     Ext.create('simlet.' + (simlet.type || simlet.stype || me.defaultType), one);
   188|             }
   189|             me.simlets.push(simlet);
   190|             simlet.manager = me;
   191|         }
   192|         if (Ext.isArray(simlet)) {
   193|             Ext.each(simlet, reg);
   194|         }
   195|         else if (simlet.isSimlet || simlet.url) {
   196|             reg(simlet);
   197|         }
   198|         else {
   199|             Ext.Object.each(simlet, function(url, s) {
   200|                 s.url = url;
   201|                 reg(s);
   202|             });
   203|         }
   204|         return me;
   205|     }
   206| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/ajax/SimXhr.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-99 ---
     1| /**
     2|  * Simulates an XMLHttpRequest object's methods and properties but is backed by a
     3|  * {@link Ext.ux.ajax.Simlet} instance that provides the data.
     4|  */
     5| Ext.define('Ext.ux.ajax.SimXhr', {
     6|     readyState: 0,
     7|     mgr: null,
     8|     simlet: null,
     9|     constructor: function(config) {
    10|         var me = this;
    11|         Ext.apply(me, config);
    12|         me.requestHeaders = {};
    13|     },
    14|     abort: function() {
    15|         var me = this;
    16|         if (me.timer) {
    17|             Ext.undefer(me.timer);
    18|             me.timer = null;
    19|         }
    20|         me.aborted = true;
    21|     },
    22|     getAllResponseHeaders: function() {
    23|         var headers = [];
    24|         if (Ext.isObject(this.responseHeaders)) {
    25|             Ext.Object.each(this.responseHeaders, function(name, value) {
    26|                 headers.push(name + ': ' + value);
    27|             });
    28|         }
    29|         return headers.join('\x0d\x0a');
    30|     },
    31|     getResponseHeader: function(header) {
    32|         var headers = this.responseHeaders;
    33|         return (headers && headers[header]) || null;
    34|     },
    35|     open: function(method, url, async, user, password) {
    36|         var me = this;
    37|         me.method = method;
    38|         me.url = url;
    39|         me.async = async !== false;
    40|         me.user = user;
    41|         me.password = password;
    42|         me.setReadyState(1);
    43|     },
    44|     overrideMimeType: function(mimeType) {
    45|         this.mimeType = mimeType;
    46|     },
    47|     schedule: function() {
    48|         var me = this,
    49|             delay = me.simlet.delay || me.mgr.delay;
    50|         if (delay) {
    51|             me.timer = Ext.defer(function() {
    52|                 me.onTick();
    53|             }, delay);
    54|         }
    55|         else {
    56|             me.onTick();
    57|         }
    58|     },
    59|     send: function(body) {
    60|         var me = this;
    61|         me.body = body;
    62|         if (me.async) {
    63|             me.schedule();
    64|         }
    65|         else {
    66|             me.onComplete();
    67|         }
    68|     },
    69|     setReadyState: function(state) {
    70|         var me = this;
    71|         if (me.readyState !== state) {
    72|             me.readyState = state;
    73|             me.onreadystatechange();
    74|         }
    75|     },
    76|     setRequestHeader: function(header, value) {
    77|         this.requestHeaders[header] = value;
    78|     },
    79|     onreadystatechange: Ext.emptyFn,
    80|     onComplete: function() {
    81|         var me = this,
    82|             callback, text;
    83|         me.readyState = 4;
    84|         Ext.apply(me, me.simlet.exec(me));
    85|         callback = me.jsonpCallback;
    86|         if (callback) {
    87|             text = callback + '(' + me.responseText + ')';
    88|             eval(text);
    89|         }
    90|     },
    91|     onTick: function() {
    92|         var me = this;
    93|         me.timer = null;
    94|         me.onComplete();
    95|         if (me.onreadystatechange) {
    96|             me.onreadystatechange();
    97|         }
    98|     }
    99| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/ajax/Simlet.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-187 ---
     1| /**
     2|  * This is a base class for more advanced "simlets" (simulated servers). A simlet is asked
     3|  * to provide a response given a {@link Ext.ux.ajax.SimXhr} instance.
     4|  */
     5| Ext.define('Ext.ux.ajax.Simlet', function() {
     6|     var urlRegex = /([^?#]*)(#.*)?$/,
     7|         dateRegex = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/,
     8|         intRegex = /^[+-]?\d+$/,
     9|         floatRegex = /^[+-]?\d+\.\d+$/;
    10|     function parseParamValue(value) {
    11|         var m;
    12|         if (Ext.isDefined(value)) {
    13|             value = decodeURIComponent(value);
    14|             if (intRegex.test(value)) {
    15|                 value = parseInt(value, 10);
    16|             }
    17|             else if (floatRegex.test(value)) {
    18|                 value = parseFloat(value);
    19|             }
    20|             else if (!!(m = dateRegex.exec(value))) {
    21|                 value = new Date(Date.UTC(+m[1], +m[2] - 1, +m[3], +m[4], +m[5], +m[6]));
    22|             }
    23|         }
    24|         return value;
    25|     }
    26|     return {
    27|         alias: 'simlet.basic',
    28|         isSimlet: true,
    29|         responseProps: ['responseText', 'responseXML', 'status', 'statusText', 'responseHeaders'],
    30|         /**
    31|          * @cfg {String/Function} responseText
    32|          */
    33|         /**
    34|          * @cfg {String/Function} responseXML
    35|          */
    36|         /**
    37|          * @cfg {Object/Function} responseHeaders
    38|          */
    39|         /**
    40|          * @cfg {Number/Function} status
    41|          */
    42|         status: 200,
    43|         /**
    44|          * @cfg {String/Function} statusText
    45|          */
    46|         statusText: 'OK',
    47|         constructor: function(config) {
    48|             Ext.apply(this, config);
    49|         },
    50|         doGet: function(ctx) {
    51|             return this.handleRequest(ctx);
    52|         },
    53|         doPost: function(ctx) {
    54|             return this.handleRequest(ctx);
    55|         },
    56|         doRedirect: function(ctx) {
    57|             return false;
    58|         },
    59|         doDelete: function(ctx) {
    60|             var me = this,
    61|                 xhr = ctx.xhr,
    62|                 records = xhr.options.records;
    63|             me.removeFromData(ctx, records);
    64|         },
    65|         /**
    66|          * Performs the action requested by the given XHR and returns an object to be applied
    67|          * on to the XHR (containing `status`, `responseText`, etc.). For the most part,
    68|          * this is delegated to `doMethod` methods on this class, such as `doGet`.
    69|          *
    70|          * @param {Ext.ux.ajax.SimXhr} xhr The simulated XMLHttpRequest instance.
    71|          * @return {Object} The response properties to add to the XMLHttpRequest.
    72|          */
    73|         exec: function(xhr) {
    74|             var me = this,
    75|                 ret = {},
    76|                 method = 'do' + Ext.String.capitalize(xhr.method.toLowerCase()), // doGet
    77|                 fn = me[method];
    78|             if (fn) {
    79|                 ret = fn.call(me, me.getCtx(xhr.method, xhr.url, xhr));
    80|             }
    81|             else {
    82|                 ret = { status: 405, statusText: 'Method Not Allowed' };
    83|             }
    84|             return ret;
    85|         },
    86|         getCtx: function(method, url, xhr) {
    87|             return {
    88|                 method: method,
    89|                 params: this.parseQueryString(url),
    90|                 url: url,
    91|                 xhr: xhr
    92|             };
    93|         },
    94|         handleRequest: function(ctx) {
    95|             var me = this,
    96|                 ret = {},
    97|                 val;
    98|             Ext.Array.forEach(me.responseProps, function(prop) {
    99|                 if (prop in me) {
   100|                     val = me[prop];
   101|                     if (Ext.isFunction(val)) {
   102|                         val = val.call(me, ctx);
   103|                     }
   104|                     ret[prop] = val;
   105|                 }
   106|             });
   107|             return ret;
   108|         },
   109|         openRequest: function(method, url, options, async) {
   110|             var ctx = this.getCtx(method, url),
   111|                 redirect = this.doRedirect(ctx),
   112|                 xhr;
   113|             if (options.action === 'destroy') {
   114|                 method = 'delete';
   115|             }
   116|             if (redirect) {
   117|                 xhr = redirect;
   118|             }
   119|             else {
   120|                 xhr = new Ext.ux.ajax.SimXhr({
   121|                     mgr: this.manager,
   122|                     simlet: this,
   123|                     options: options
   124|                 });
   125|                 xhr.open(method, url, async);
   126|             }
   127|             return xhr;
   128|         },
   129|         parseQueryString: function(str) {
   130|             var m = urlRegex.exec(str),
   131|                 ret = {},
   132|                 key, value, pair, parts, i, n;
   133|             if (m && m[1]) {
   134|                 parts = m[1].split('&');
   135|                 for (i = 0, n = parts.length; i < n; ++i) {
   136|                     if ((pair = parts[i].split('='))[0]) {
   137|                         key = decodeURIComponent(pair.shift());
   138|                         value = parseParamValue((pair.length > 1) ? pair.join('=') : pair[0]);
   139|                         if (!(key in ret)) {
   140|                             ret[key] = value;
   141|                         }
   142|                         else if (Ext.isArray(ret[key])) {
   143|                             ret[key].push(value);
   144|                         }
   145|                         else {
   146|                             ret[key] = [ret[key], value];
   147|                         }
   148|                     }
   149|                 }
   150|             }
   151|             return ret;
   152|         },
   153|         redirect: function(method, url, params) {
   154|             switch (arguments.length) {
   155|                 case 2:
   156|                     if (typeof url === 'string') {
   157|                         break;
   158|                     }
   159|                     params = url;
   160|                 case 1:
   161|                     url = method;
   162|                     method = 'GET';
   163|                     break;
   164|             }
   165|             if (params) {
   166|                 url = Ext.urlAppend(url, Ext.Object.toQueryString(params));
   167|             }
   168|             return this.manager.openRequest(method, url);
   169|         },
   170|         removeFromData: function(ctx, records) {
   171|             var me = this,
   172|                 data = me.getData(ctx),
   173|                 model = (ctx.xhr.options.proxy && ctx.xhr.options.proxy.getModel()) || {},
   174|                 idProperty = model.idProperty || 'id',
   175|                 i;
   176|             Ext.each(records, function(record) {
   177|                 var id = record.get(idProperty);
   178|                 for (i = data.length; i-- > 0;) {
   179|                     if (data[i][idProperty] === id) {
   180|                         me.deleteRecord(i);
   181|                         break;
   182|                     }
   183|                 }
   184|             });
   185|         }
   186|     };
   187| }());


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/ajax/XmlSimlet.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-90 ---
     1| /**
     2|  * This class simulates XML-based requests.
     3|  */
     4| Ext.define('Ext.ux.ajax.XmlSimlet', {
     5|     extend: 'Ext.ux.ajax.DataSimlet',
     6|     alias: 'simlet.xml',
     7|     /* eslint-disable indent */
     8|     /**
     9|      * This template is used to populate the XML response. The configuration of the Reader
    10|      * is available so that its `root` and `record` properties can be used as well as the
    11|      * `fields` of the associated `model`. But beyond that, the way these pieces are put
    12|      * together in the document requires the flexibility of a template.
    13|      */
    14|     xmlTpl: [
    15|         '<{root}>\n',
    16|             '<tpl for="data">',
    17|         '    <{parent.record}>\n',
    18|                 '<tpl for="parent.fields">',
    19|         '        <{name}>{[parent[values.name]]}</{name}>\n',
    20|                 '</tpl>',
    21|         '    </{parent.record}>\n',
    22|             '</tpl>',
    23|         '</{root}>'
    24|     ],
    25|     /* eslint-enable indent */
    26|     doGet: function(ctx) {
    27|         var me = this,
    28|             data = me.getData(ctx),
    29|             page = me.getPage(ctx, data),
    30|             proxy = ctx.xhr.options.operation.getProxy(),
    31|             reader = proxy && proxy.getReader(),
    32|             model = reader && reader.getModel(),
    33|             ret = me.callParent(arguments), // pick up status/statusText
    34|             response = {
    35|                 data: page,
    36|                 reader: reader,
    37|                 fields: model && model.fields,
    38|                 root: reader && reader.getRootProperty(),
    39|                 record: reader && reader.record
    40|             },
    41|             tpl, xml, doc;
    42|         if (ctx.groupSpec) {
    43|             response.summaryData = me.getSummary(ctx, data, page);
    44|         }
    45|         if (me.xmlTpl) {
    46|             tpl = Ext.XTemplate.getTpl(me, 'xmlTpl');
    47|             xml = tpl.apply(response);
    48|         }
    49|         else {
    50|             xml = data;
    51|         }
    52|         if (typeof DOMParser !== 'undefined') {
    53|             doc = (new DOMParser()).parseFromString(xml, "text/xml");
    54|         }
    55|         else {
    56|             /* global ActiveXObject */
    57|             doc = new ActiveXObject("Microsoft.XMLDOM");
    58|             doc.async = false;
    59|             doc.loadXML(xml);
    60|         }
    61|         ret.responseText = xml;
    62|         ret.responseXML = doc;
    63|         return ret;
    64|     },
    65|     fixTree: function() {
    66|         var buffer = [];
    67|         this.callParent(arguments);
    68|         this.buildTreeXml(this.data, buffer);
    69|         this.data = buffer.join('');
    70|     },
    71|     buildTreeXml: function(nodes, buffer) {
    72|         var rootProperty = this.rootProperty,
    73|             recordProperty = this.recordProperty;
    74|         buffer.push('<', rootProperty, '>');
    75|         Ext.Array.forEach(nodes, function(node) {
    76|             var key;
    77|             buffer.push('<', recordProperty, '>');
    78|             for (key in node) {
    79|                 if (key === 'children') {
    80|                     this.buildTreeXml(node.children, buffer);
    81|                 }
    82|                 else {
    83|                     buffer.push('<', key, '>', node[key], '</', key, '>');
    84|                 }
    85|             }
    86|             buffer.push('</', recordProperty, '>');
    87|         });
    88|         buffer.push('</', rootProperty, '>');
    89|     }
    90| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/overrides/rating/Picker.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| /**
     2|  * @class Ext.ux.rating.Picker
     3|  */
     4| Ext.define('Ext.ux.overrides.rating.Picker', {
     5|     override: 'Ext.ux.rating.Picker',
     6|     initConfig: function(config) {
     7|         if (config && config.tooltip) {
     8|             config.tip = config.tooltip;
     9|             Ext.log.warn('[Ext.ux.rating.Picker] The "tooltip" config was replaced by "tip"');
    10|         }
    11|         this.callParent([ config ]);
    12|     },
    13|     updateTooltipText: function(text) {
    14|         var innerEl = this.innerEl,
    15|             QuickTips = Ext.tip && Ext.tip.QuickTipManager,
    16|             tip = QuickTips && QuickTips.tip,
    17|             target;
    18|         if (QuickTips) {
    19|             innerEl.dom.setAttribute('data-qtip', text);
    20|             this.trackerEl.dom.setAttribute('data-qtip', text);
    21|             target = tip && tip.activeTarget;
    22|             target = target && target.el;
    23|             if (target && innerEl.contains(target)) {
    24|                 tip.update(text);
    25|             }
    26|         }
    27|     }
    28| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/BoxReorderer.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-349 ---
     1| /**
     2|  * Base class from Ext.ux.TabReorderer.
     3|  */
     4| Ext.define('Ext.ux.BoxReorderer', {
     5|     extend: 'Ext.plugin.Abstract',
     6|     alias: 'plugin.boxreorderer',
     7|     requires: [
     8|         'Ext.ux.dd.BoxContainerDD'
     9|     ],
    10|     mixins: {
    11|         observable: 'Ext.util.Observable'
    12|     },
    13|     /**
    14|      * @cfg {String} itemSelector
    15|      * A {@link Ext.DomQuery DomQuery} selector which identifies the encapsulating elements of child
    16|      * Components which participate in reordering.
    17|      */
    18|     itemSelector: '.x-box-item',
    19|     /**
    20|      * @cfg {Mixed} animate
    21|      * If truthy, child reordering is animated so that moved boxes slide smoothly into position.
    22|      * If this option is numeric, it is used as the animation duration in milliseconds.
    23|      */
    24|     animate: 100,
    25|     /**
    26|      * @event StartDrag
    27|      * Fires when dragging of a child Component begins.
    28|      * @param {Ext.ux.BoxReorderer} this
    29|      * @param {Ext.container.Container} container The owning Container
    30|      * @param {Ext.Component} dragCmp The Component being dragged
    31|      * @param {Number} idx The start index of the Component being dragged.
    32|      */
    33|     /**
    34|      * @event Drag
    35|      * Fires during dragging of a child Component.
    36|      * @param {Ext.ux.BoxReorderer} this
    37|      * @param {Ext.container.Container} container The owning Container
    38|      * @param {Ext.Component} dragCmp The Component being dragged
    39|      * @param {Number} startIdx The index position from which the Component was initially dragged.
    40|      * @param {Number} idx The current closest index to which the Component would drop.
    41|      */
    42|     /**
    43|      * @event ChangeIndex
    44|      * Fires when dragging of a child Component causes its drop index to change.
    45|      * @param {Ext.ux.BoxReorderer} this
    46|      * @param {Ext.container.Container} container The owning Container
    47|      * @param {Ext.Component} dragCmp The Component being dragged
    48|      * @param {Number} startIdx The index position from which the Component was initially dragged.
    49|      * @param {Number} idx The current closest index to which the Component would drop.
    50|      */
    51|     /**
    52|      * @event Drop
    53|      * Fires when a child Component is dropped at a new index position.
    54|      * @param {Ext.ux.BoxReorderer} this
    55|      * @param {Ext.container.Container} container The owning Container
    56|      * @param {Ext.Component} dragCmp The Component being dropped
    57|      * @param {Number} startIdx The index position from which the Component was initially dragged.
    58|      * @param {Number} idx The index at which the Component is being dropped.
    59|      */
    60|     constructor: function() {
    61|         this.callParent(arguments);
    62|         this.mixins.observable.constructor.call(this);
    63|     },
    64|     init: function(container) {
    65|         var me = this,
    66|             layout = container.getLayout();
    67|         me.container = container;
    68|         me.names = layout._props[layout.type].names;
    69|         me.animatePolicy = {};
    70|         me.animatePolicy[me.names.x] = true;
    71|         me.container.on({
    72|             scope: me,
    73|             boxready: me.onBoxReady,
    74|             beforedestroy: me.onContainerDestroy
    75|         });
    76|     },
    77|     /**
    78|      * @private
    79|      * Clear up on Container destroy
    80|      */
    81|     onContainerDestroy: function() {
    82|         var dd = this.dd;
    83|         if (dd) {
    84|             dd.unreg();
    85|             this.dd = null;
    86|         }
    87|     },
    88|     onBoxReady: function() {
    89|         var me = this,
    90|             layout = me.container.getLayout(),
    91|             names = me.names,
    92|             dd;
    93|         dd = me.dd = new Ext.ux.dd.BoxContainerDD(layout.innerCt, me.container.id + '-reorderer');
    94|         Ext.apply(dd, {
    95|             animate: me.animate,
    96|             reorderer: me,
    97|             container: me.container,
    98|             getDragCmp: me.getDragCmp,
    99|             clickValidator: Ext.Function.createInterceptor(
   100|                 dd.clickValidator, me.clickValidator, me, false
   101|             ),
   102|             onMouseDown: me.onMouseDown,
   103|             startDrag: me.startDrag,
   104|             onDrag: me.onDrag,
   105|             endDrag: me.endDrag,
   106|             getNewIndex: me.getNewIndex,
   107|             doSwap: me.doSwap,
   108|             findReorderable: me.findReorderable,
   109|             names: names
   110|         });
   111|         dd.dim = names.width;
   112|         dd.startAttr = names.beforeX;
   113|         dd.endAttr = names.afterX;
   114|     },
   115|     getDragCmp: function(e) {
   116|         return this.container.getChildByElement(e.getTarget(this.itemSelector, 10));
   117|     },
   118|     clickValidator: function(e) {
   119|         var cmp = this.getDragCmp(e);
   120|         return !!(cmp && cmp.reorderable !== false);
   121|     },
   122|     onMouseDown: function(e) {
   123|         var me = this,
   124|             container = me.container,
   125|             containerBox,
   126|             cmpEl,
   127|             cmpBox;
   128|         me.dragCmp = me.getDragCmp(e);
   129|         if (me.dragCmp) {
   130|             cmpEl = me.dragCmp.getEl();
   131|             me.startIndex = me.curIndex = container.items.indexOf(me.dragCmp);
   132|             cmpBox = cmpEl.getBox();
   133|             me.lastPos = cmpBox[me.startAttr];
   134|             containerBox = container.el.getBox();
   135|             if (me.dim === 'width') {
   136|                 me.minX = containerBox.left;
   137|                 me.maxX = containerBox.right - cmpBox.width;
   138|                 me.minY = me.maxY = cmpBox.top;
   139|                 me.deltaX = e.getX() - cmpBox.left;
   140|             }
   141|             else {
   142|                 me.minY = containerBox.top;
   143|                 me.maxY = containerBox.bottom - cmpBox.height;
   144|                 me.minX = me.maxX = cmpBox.left;
   145|                 me.deltaY = e.getY() - cmpBox.top;
   146|             }
   147|             me.constrainY = me.constrainX = true;
   148|         }
   149|     },
   150|     startDrag: function() {
   151|         var me = this,
   152|             dragCmp = me.dragCmp,
   153|             targetEl, dom, left, top, scrollable;
   154|         if (dragCmp) {
   155|             scrollable = me.container.getScrollable();
   156|             if (scrollable) {
   157|                 scrollable.scrollBy(-1).then(function() {
   158|                     scrollable.scrollBy(1);
   159|                 });
   160|             }
   161|             dragCmp.setPosition = Ext.emptyFn;
   162|             dragCmp.animate = false;
   163|             if (me.animate) {
   164|                 me.container.getLayout().animatePolicy = me.reorderer.animatePolicy;
   165|             }
   166|             me.dragElId = dragCmp.getEl().id;
   167|             me.reorderer.fireEvent('StartDrag', me, me.container, dragCmp, me.curIndex);
   168|             dragCmp.suspendEvents();
   169|             dragCmp.disabled = true;
   170|             dragCmp.el.setStyle('zIndex', 100);
   171|             if (!dragCmp.nextSibling()) {
   172|                 targetEl = me.container.layout.targetEl;
   173|                 dom = targetEl.dom;
   174|                 left = dom.scrollWidth - 1;
   175|                 top = dom.scrollHeight - 1;
   176|                 me.spacerEl = Ext.dom.Helper.append(targetEl, {
   177|                     tag: 'div',
   178|                     style: 'width: 1px;' +
   179|                            'height: 1px;' +
   180|                            'position: absolute;' +
   181|                            'left: ' + left + 'px;' +
   182|                            'top: ' + top + 'px;"'
   183|                 });
   184|             }
   185|         }
   186|         else {
   187|             me.dragElId = null;
   188|         }
   189|     },
   190|     /**
   191|      * @private
   192|      * Find next or previous reorderable component index.
   193|      * @param {Number} newIndex The initial drop index.
   194|      * @return {Number} The index of the reorderable component.
   195|      */
   196|     findReorderable: function(newIndex) {
   197|         var me = this,
   198|             items = me.container.items,
   199|             newItem;
   200|         if (items.getAt(newIndex).reorderable === false) {
   201|             newItem = items.getAt(newIndex);
   202|             if (newIndex > me.startIndex) {
   203|                 while (newItem && newItem.reorderable === false) {
   204|                     newIndex++;
   205|                     newItem = items.getAt(newIndex);
   206|                 }
   207|             }
   208|             else {
   209|                 while (newItem && newItem.reorderable === false) {
   210|                     newIndex--;
   211|                     newItem = items.getAt(newIndex);
   212|                 }
   213|             }
   214|         }
   215|         newIndex = Math.min(Math.max(newIndex, 0), items.getCount() - 1);
   216|         if (items.getAt(newIndex).reorderable === false) {
   217|             return -1;
   218|         }
   219|         return newIndex;
   220|     },
   221|     /**
   222|      * @private
   223|      * Swap 2 components.
   224|      * @param {Number} newIndex The initial drop index.
   225|      */
   226|     doSwap: function(newIndex) {
   227|         var me = this,
   228|             items = me.container.items,
   229|             container = me.container,
   230|             orig, dest, tmpIndex;
   231|         newIndex = me.findReorderable(newIndex);
   232|         if (newIndex === -1 || newIndex === me.curIndex) {
   233|             return;
   234|         }
   235|         me.reorderer.fireEvent('ChangeIndex', me, container, me.dragCmp, me.startIndex, newIndex);
   236|         orig = items.getAt(me.curIndex);
   237|         dest = items.getAt(newIndex);
   238|         items.remove(orig);
   239|         tmpIndex = Math.min(Math.max(newIndex, 0), items.getCount() - 1);
   240|         items.insert(tmpIndex, orig);
   241|         items.remove(dest);
   242|         items.insert(me.curIndex, dest);
   243|         container.updateLayout({
   244|             isRoot: true
   245|         });
   246|         me.curIndex = newIndex;
   247|     },
   248|     onDrag: function(e) {
   249|         var me = this,
   250|             newIndex;
   251|         newIndex = me.getNewIndex(e.getPoint());
   252|         if ((newIndex !== undefined)) {
   253|             me.reorderer.fireEvent(
   254|                 'Drag', me, me.container, me.dragCmp, me.startIndex, me.curIndex
   255|             );
   256|             me.doSwap(newIndex);
   257|         }
   258|     },
   259|     endDrag: function(e) {
   260|         var me = this,
   261|             dragCmp = me.dragCmp,
   262|             container = me.container,
   263|             layout = container.getLayout(),
   264|             temp;
   265|         if (e) {
   266|             e.stopEvent();
   267|         }
   268|         if (dragCmp) {
   269|             delete me.dragElId;
   270|             delete dragCmp.setPosition;
   271|             dragCmp.animate = true;
   272|             dragCmp.lastBox[me.names.x] = dragCmp.getPosition(true)[me.names.widthIndex];
   273|             container.updateLayout({
   274|                 isRoot: true
   275|             });
   276|             temp = Ext.fx.Manager.getFxQueue(dragCmp.el.id)[0];
   277|             if (temp) {
   278|                 temp.on({
   279|                     afteranimate: me.reorderer.afterBoxReflow,
   280|                     scope: me
   281|                 });
   282|             }
   283|             else {
   284|                 Ext.asap(me.reorderer.afterBoxReflow, me);
   285|             }
   286|             if (me.animate) {
   287|                 delete layout.animatePolicy;
   288|             }
   289|             me.reorderer.fireEvent('drop', me, container, dragCmp, me.startIndex, me.curIndex);
   290|         }
   291|     },
   292|     /**
   293|      * @private
   294|      * Called after the boxes have been reflowed after the drop.
   295|      * Re-enabled the dragged Component.
   296|      */
   297|     afterBoxReflow: function() {
   298|         var me = this,
   299|             spacerEl = Ext.fly(me.spacerEl),
   300|             dragCmp = me.dragCmp;
   301|         dragCmp.el.setStyle('zIndex', '');
   302|         dragCmp.disabled = false;
   303|         dragCmp.resumeEvents();
   304|         if (spacerEl) {
   305|             spacerEl.remove();
   306|             me.spacerEl = null;
   307|         }
   308|     },
   309|     /**
   310|      * @private
   311|      * Calculate drop index based upon the dragEl's position.
   312|      */
   313|     getNewIndex: function(pointerPos) {
   314|         var me = this,
   315|             dragEl = me.getDragEl(),
   316|             dragBox = Ext.fly(dragEl).getBox(),
   317|             targetEl,
   318|             targetBox,
   319|             targetMidpoint,
   320|             i = 0,
   321|             it = me.container.items.items,
   322|             ln = it.length,
   323|             lastPos = me.lastPos;
   324|         me.lastPos = dragBox[me.startAttr];
   325|         for (; i < ln; i++) {
   326|             targetEl = it[i].getEl();
   327|             if (targetEl.dom !== dragEl && targetEl.is(me.reorderer.itemSelector)) {
   328|                 targetBox = targetEl.getBox();
   329|                 targetMidpoint = targetBox[me.startAttr] + (targetBox[me.dim] >> 1);
   330|                 if (i < me.curIndex) {
   331|                     if (
   332|                         (dragBox[me.startAttr] < lastPos) &&
   333|                         (dragBox[me.startAttr] < (targetMidpoint - 5))
   334|                     ) {
   335|                         return i;
   336|                     }
   337|                 }
   338|                 else if (i > me.curIndex) {
   339|                     if (
   340|                         (dragBox[me.startAttr] > lastPos) &&
   341|                         (dragBox[me.endAttr] > (targetMidpoint + 5))
   342|                     ) {
   343|                         return i;
   344|                     }
   345|                 }
   346|             }
   347|         }
   348|     }
   349| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/CellDragDrop.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-262 ---
     1| /**
     2|  * This plugin can enable a cell to cell drag and drop operation within the same grid view.
     3|  *
     4|  * Note that the plugin must be added to the grid view, not to the grid panel. For example,
     5|  * using {@link Ext.panel.Table viewConfig}:
     6|  *
     7|  *      viewConfig: {
     8|  *          plugins: {
     9|  *              celldragdrop: {
    10|  *                  // Remove text from source cell and replace with value of emptyText.
    11|  *                  applyEmptyText: true,
    12|  *
    13|  *                  //emptyText: Ext.String.htmlEncode('<<foo>>'),
    14|  *
    15|  *                  // Will only allow drops of the same type.
    16|  *                  enforceType: true
    17|  *              }
    18|  *          }
    19|  *      }
    20|  */
    21| Ext.define('Ext.ux.CellDragDrop', {
    22|     extend: 'Ext.plugin.Abstract',
    23|     alias: 'plugin.celldragdrop',
    24|     uses: ['Ext.view.DragZone'],
    25|     /**
    26|      * @cfg {Boolean} enforceType
    27|      * Set to `true` to only allow drops of the same type.
    28|      *
    29|      * Defaults to `false`.
    30|      */
    31|     enforceType: false,
    32|     /**
    33|      * @cfg {Boolean} applyEmptyText
    34|      * If `true`, then use the value of {@link #emptyText} to replace the drag record's value
    35|      * after a node drop. Note that, if dropped on a cell of a different type, it will convert
    36|      * the default text according to its own conversion rules.
    37|      *
    38|      * Defaults to `false`.
    39|      */
    40|     applyEmptyText: false,
    41|     /**
    42|      * @cfg {String} emptyText
    43|      * If {@link #applyEmptyText} is `true`, then this value as the drag record's value after
    44|      * a node drop.
    45|      *
    46|      * Defaults to an empty string.
    47|      */
    48|     emptyText: '',
    49|     /**
    50|      * @cfg {String} dropBackgroundColor
    51|      * The default background color for when a drop is allowed.
    52|      *
    53|      * Defaults to green.
    54|      */
    55|     dropBackgroundColor: 'green',
    56|     /**
    57|      * @cfg {String} noDropBackgroundColor
    58|      * The default background color for when a drop is not allowed.
    59|      *
    60|      * Defaults to red.
    61|      */
    62|     noDropBackgroundColor: 'red',
    63|     /**
    64|      * @cfg {String} dragText
    65|      * The text to show while dragging.
    66|      *
    67|      * Two placeholders can be used in the text:
    68|      *
    69|      * - `{0}` The number of selected items.
    70|      * - `{1}` 's' when more than 1 items (only useful for English).
    71|      * @locale
    72|      */
    73|     dragText: '{0} selected row{1}',
    74|     /**
    75|      * @cfg {String} ddGroup
    76|      * A named drag drop group to which this object belongs. If a group is specified, then both
    77|      * the DragZones and DropZone used by this plugin will only interact with other drag drop
    78|      * objects in the same group.
    79|      */
    80|     ddGroup: "GridDD",
    81|     /**
    82|      * @cfg {Boolean} enableDrop
    83|      * Set to `false` to disallow the View from accepting drop gestures.
    84|      */
    85|     enableDrop: true,
    86|     /**
    87|      * @cfg {Boolean} enableDrag
    88|      * Set to `false` to disallow dragging items from the View.
    89|      */
    90|     enableDrag: true,
    91|     /**
    92|      * @cfg {Object/Boolean} containerScroll
    93|      * True to register this container with the Scrollmanager for auto scrolling during drag
    94|      * operations. A {@link Ext.dd.ScrollManager} configuration may also be passed.
    95|      */
    96|     containerScroll: false,
    97|     init: function(view) {
    98|         var me = this;
    99|         view.on('render', me.onViewRender, me, {
   100|             single: true
   101|         });
   102|     },
   103|     destroy: function() {
   104|         var me = this;
   105|         me.dragZone = me.dropZone = Ext.destroy(me.dragZone, me.dropZone);
   106|         me.callParent();
   107|     },
   108|     enable: function() {
   109|         var me = this;
   110|         if (me.dragZone) {
   111|             me.dragZone.unlock();
   112|         }
   113|         if (me.dropZone) {
   114|             me.dropZone.unlock();
   115|         }
   116|         me.callParent();
   117|     },
   118|     disable: function() {
   119|         var me = this;
   120|         if (me.dragZone) {
   121|             me.dragZone.lock();
   122|         }
   123|         if (me.dropZone) {
   124|             me.dropZone.lock();
   125|         }
   126|         me.callParent();
   127|     },
   128|     onViewRender: function(view) {
   129|         var me = this,
   130|             scrollEl;
   131|         if (me.enableDrag) {
   132|             if (me.containerScroll) {
   133|                 scrollEl = view.getEl();
   134|             }
   135|             me.dragZone = new Ext.view.DragZone({
   136|                 view: view,
   137|                 ddGroup: me.dragGroup || me.ddGroup,
   138|                 dragText: me.dragText,
   139|                 containerScroll: me.containerScroll,
   140|                 scrollEl: scrollEl,
   141|                 getDragData: function(e) {
   142|                     var view = this.view,
   143|                         item = e.getTarget(view.getItemSelector()),
   144|                         record = view.getRecord(item),
   145|                         cell = e.getTarget(view.getCellSelector()),
   146|                         dragEl, header;
   147|                     if (item) {
   148|                         dragEl = document.createElement('div');
   149|                         dragEl.className = 'x-form-text';
   150|                         dragEl.appendChild(
   151|                             document.createTextNode(cell.textContent || cell.innerText)
   152|                         );
   153|                         header = view.getHeaderByCell(cell);
   154|                         return {
   155|                             event: new Ext.EventObjectImpl(e),
   156|                             ddel: dragEl,
   157|                             item: e.target,
   158|                             columnName: header.dataIndex,
   159|                             record: record
   160|                         };
   161|                     }
   162|                 },
   163|                 onInitDrag: function(x, y) {
   164|                     var self = this,
   165|                         data = self.dragData,
   166|                         view = self.view,
   167|                         selectionModel = view.getSelectionModel(),
   168|                         record = data.record,
   169|                         el = data.ddel;
   170|                     if (!selectionModel.isSelected(record)) {
   171|                         selectionModel.select(record, true);
   172|                     }
   173|                     Ext.fly(self.ddel).update(el.textContent || el.innerText);
   174|                     self.proxy.update(self.ddel);
   175|                     self.onStartDrag(x, y);
   176|                     return true;
   177|                 }
   178|             });
   179|         }
   180|         if (me.enableDrop) {
   181|             me.dropZone = new Ext.dd.DropZone(view.el, {
   182|                 view: view,
   183|                 ddGroup: me.dropGroup || me.ddGroup,
   184|                 containerScroll: true,
   185|                 getTargetFromEvent: function(e) {
   186|                     var self = this,
   187|                         view = self.view,
   188|                         cell = e.getTarget(view.cellSelector),
   189|                         row, header;
   190|                     if (cell) {
   191|                         row = view.findItemByChild(cell);
   192|                         header = view.getHeaderByCell(cell);
   193|                         if (row && header) {
   194|                             return {
   195|                                 node: cell,
   196|                                 record: view.getRecord(row),
   197|                                 columnName: header.dataIndex
   198|                             };
   199|                         }
   200|                     }
   201|                 },
   202|                 onNodeEnter: function(target, dd, e, dragData) {
   203|                     var self = this,
   204|                         destType, sourceType;
   205|                     destType = target.record.getField(target.columnName).type.toUpperCase();
   206|                     sourceType = dragData.record.getField(dragData.columnName).type.toUpperCase();
   207|                     delete self.dropOK;
   208|                     if (!target || target.node === dragData.item.parentNode) {
   209|                         return;
   210|                     }
   211|                     if (me.enforceType && destType !== sourceType) {
   212|                         self.dropOK = false;
   213|                         if (me.noDropCls) {
   214|                             Ext.fly(target.node).addCls(me.noDropCls);
   215|                         }
   216|                         else {
   217|                             Ext.fly(target.node).applyStyles({
   218|                                 backgroundColor: me.noDropBackgroundColor
   219|                             });
   220|                         }
   221|                         return false;
   222|                     }
   223|                     self.dropOK = true;
   224|                     if (me.dropCls) {
   225|                         Ext.fly(target.node).addCls(me.dropCls);
   226|                     }
   227|                     else {
   228|                         Ext.fly(target.node).applyStyles({
   229|                             backgroundColor: me.dropBackgroundColor
   230|                         });
   231|                     }
   232|                 },
   233|                 onNodeOver: function(target, dd, e, dragData) {
   234|                     return this.dropOK ? this.dropAllowed : this.dropNotAllowed;
   235|                 },
   236|                 onNodeOut: function(target, dd, e, dragData) {
   237|                     var cls = this.dropOK ? me.dropCls : me.noDropCls;
   238|                     if (cls) {
   239|                         Ext.fly(target.node).removeCls(cls);
   240|                     }
   241|                     else {
   242|                         Ext.fly(target.node).applyStyles({
   243|                             backgroundColor: ''
   244|                         });
   245|                     }
   246|                 },
   247|                 onNodeDrop: function(target, dd, e, dragData) {
   248|                     if (this.dropOK) {
   249|                         target.record.set(
   250|                             target.columnName, dragData.record.get(dragData.columnName)
   251|                         );
   252|                         if (me.applyEmptyText) {
   253|                             dragData.record.set(dragData.columnName, me.emptyText);
   254|                         }
   255|                         return true;
   256|                     }
   257|                 },
   258|                 onCellDrop: Ext.emptyFn
   259|             });
   260|         }
   261|     }
   262| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/DataTip.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-120 ---
     1| /**
     2|  * @class Ext.ux.DataTip
     3|  * @extends Ext.tip.ToolTip
     4|  * This plugin implements automatic tooltip generation for an arbitrary number of child nodes
     5|  * *within* a Component.
     6|  *
     7|  * This plugin is applied to a high level Component, which contains repeating elements,
     8|  * and depending on the host Component type, it automatically selects
     9|  * a {@link Ext.ToolTip#delegate delegate} so that it appears when the mouse enters a sub-element.
    10|  *
    11|  * When applied to a GridPanel, this ToolTip appears when over a row, and the Record's data
    12|  * is applied using this object's {@link #tpl} template.
    13|  *
    14|  * When applied to a DataView, this ToolTip appears when over a view node, and the Record's data
    15|  * is applied using this object's {@link #tpl} template.
    16|  *
    17|  * When applied to a TreePanel, this ToolTip appears when over a tree node, and the Node's
    18|  * {@link Ext.data.Model} record data is applied using this object's {@link #tpl} template.
    19|  *
    20|  * When applied to a FormPanel, this ToolTip appears when over a Field, and the Field's `tooltip`
    21|  * property is used is applied using this object's {@link #tpl} template, or if it is a string,
    22|  * used as HTML content. If there is no `tooltip` property, the field itself is used
    23|  * as the template's data object.
    24|  *
    25|  * If more complex logic is needed to determine content, then the {@link #beforeshow} event
    26|  * may be used. This class also publishes a **`beforeshowtip`** event through its host Component.
    27|  * The *host Component* fires the **`beforeshowtip`** event.
    28|  */
    29| Ext.define('Ext.ux.DataTip', function(DataTip) {
    30|     function onHostRender() {
    31|         var e = this.isXType('panel') ? this.body : this.el;
    32|         if (this.dataTip.renderToTarget) {
    33|             this.dataTip.render(e);
    34|         }
    35|         this.dataTip.setTarget(e);
    36|     }
    37|     function updateTip(tip, data) {
    38|         if (tip.rendered) {
    39|             if (tip.host.fireEvent('beforeshowtip', tip.eventHost, tip, data) === false) {
    40|                 return false;
    41|             }
    42|             tip.update(data);
    43|         }
    44|         else {
    45|             if (Ext.isString(data)) {
    46|                 tip.html = data;
    47|             }
    48|             else {
    49|                 tip.data = data;
    50|             }
    51|         }
    52|     }
    53|     function beforeViewTipShow(tip) {
    54|         var rec = this.view.getRecord(tip.triggerElement),
    55|             data;
    56|         if (rec) {
    57|             data = tip.initialConfig.data ? Ext.apply(tip.initialConfig.data, rec.data) : rec.data;
    58|             return updateTip(tip, data);
    59|         }
    60|         else {
    61|             return false;
    62|         }
    63|     }
    64|     function beforeFormTipShow(tip) {
    65|         var field = Ext.getCmp(tip.triggerElement.id);
    66|         if (field && (field.tooltip || tip.tpl)) {
    67|             return updateTip(tip, field.tooltip || field);
    68|         }
    69|         else {
    70|             return false;
    71|         }
    72|     }
    73|     return {
    74|         extend: 'Ext.tip.ToolTip',
    75|         mixins: {
    76|             plugin: 'Ext.plugin.Abstract'
    77|         },
    78|         alias: 'plugin.datatip',
    79|         lockableScope: 'both',
    80|         constructor: function(config) {
    81|             var me = this;
    82|             me.callParent([config]);
    83|             me.mixins.plugin.constructor.call(me, config);
    84|         },
    85|         init: function(host) {
    86|             var me = this;
    87|             me.mixins.plugin.init.call(me, host);
    88|             host.dataTip = me;
    89|             me.host = host;
    90|             if (host.isXType('tablepanel')) {
    91|                 me.view = host.getView();
    92|                 if (host.ownerLockable) {
    93|                     me.host = host.ownerLockable;
    94|                 }
    95|                 me.delegate = me.delegate || me.view.rowSelector;
    96|                 me.on('beforeshow', beforeViewTipShow);
    97|             }
    98|             else if (host.isXType('dataview')) {
    99|                 me.view = me.host;
   100|                 me.delegate = me.delegate || host.itemSelector;
   101|                 me.on('beforeshow', beforeViewTipShow);
   102|             }
   103|             else if (host.isXType('form')) {
   104|                 me.delegate = '.' + Ext.form.Labelable.prototype.formItemCls;
   105|                 me.on('beforeshow', beforeFormTipShow);
   106|             }
   107|             else if (host.isXType('combobox')) {
   108|                 me.view = host.getPicker();
   109|                 me.delegate = me.delegate || me.view.getItemSelector();
   110|                 me.on('beforeshow', beforeViewTipShow);
   111|             }
   112|             if (host.rendered) {
   113|                 onHostRender.call(host);
   114|             }
   115|             else {
   116|                 host.onRender = Ext.Function.createSequence(host.onRender, onHostRender);
   117|             }
   118|         }
   119|     };
   120| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/DataView/Animated.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-280 ---
     1| /**
     2|  * Transition plugin for DataViews
     3|  */
     4| Ext.define('Ext.ux.DataView.Animated', {
     5|     alias: 'plugin.ux-animated-dataview',
     6|     /**
     7|      * @property defaults
     8|      * @type Object
     9|      * Default configuration options for all DataViewTransition instances
    10|      */
    11|     defaults: {
    12|         duration: 750,
    13|         idProperty: 'id'
    14|     },
    15|     /**
    16|      * Creates the plugin instance, applies defaults
    17|      * @constructor
    18|      * @param {Object} config Optional config object
    19|      */
    20|     constructor: function(config) {
    21|         Ext.apply(this, config || {}, this.defaults);
    22|     },
    23|     /**
    24|      * Initializes the transition plugin. Overrides the dataview's default refresh function
    25|      * @param {Ext.view.View} dataview The dataview
    26|      */
    27|     init: function(dataview) {
    28|         var me = this,
    29|             store = dataview.store,
    30|             items = dataview.all,
    31|             task = {
    32|                 interval: 20
    33|             },
    34|             duration = me.duration;
    35|         /**
    36|          * @property dataview
    37|          * @type Ext.view.View
    38|          * Reference to the DataView this instance is bound to
    39|          */
    40|         me.dataview = dataview;
    41|         dataview.blockRefresh = true;
    42|         dataview.updateIndexes = Ext.Function.createSequence(dataview.updateIndexes, function() {
    43|             this.getTargetEl().select(this.itemSelector).each(function(element, composite, index) {
    44|                 element.dom.id = Ext.util.Format.format(
    45|                     "{0}-{1}", dataview.id, store.getAt(index).internalId
    46|                 );
    47|             }, this);
    48|         }, dataview);
    49|         /**
    50|          * @property dataviewID
    51|          * @type String
    52|          * The string ID of the DataView component. This is used internally when animating
    53|          * child objects
    54|          */
    55|         me.dataviewID = dataview.id;
    56|         /**
    57|          * @property cachedStoreData
    58|          * @type Object
    59|          * A cache of existing store data, keyed by id. This is used to determine
    60|          * whether any items were added or removed from the store on data change
    61|          */
    62|         me.cachedStoreData = {};
    63|         me.cacheStoreData(store.data || store.snapshot);
    64|         dataview.on('resize', function() {
    65|             var store = dataview.store;
    66|             if (store.getCount() > 0) {
    67|             }
    68|         }, this);
    69|         dataview.store.on({
    70|             datachanged: reDraw,
    71|             scope: this,
    72|             buffer: 50
    73|         });
    74|         function reDraw() {
    75|             var parentEl = dataview.getTargetEl(),
    76|                 parentElY = parentEl.getY(),
    77|                 parentElPaddingTop = parentEl.getPadding('t'),
    78|                 added = me.getAdded(store),
    79|                 removed = me.getRemoved(store),
    80|                 remaining = me.getRemaining(store),
    81|                 itemArray,
    82|                 i, id,
    83|                 itemFly = new Ext.dom.Fly(),
    84|                 rtl = me.dataview.getInherited().rtl,
    85|                 oldPos, newPos,
    86|                 styleSide = rtl ? 'right' : 'left',
    87|                 newStyle = {},
    88|                 oldPositions, newPositions, doAnimate;
    89|             if (!parentEl) {
    90|                 return;
    91|             }
    92|             Ext.iterate(removed, function(recId, item) {
    93|                 id = me.dataviewID + '-' + recId;
    94|                 Ext.fx.Manager.stopAnimation(id);
    95|                 item.dom = Ext.getDom(id);
    96|                 if (!item.dom) {
    97|                     delete removed[recId];
    98|                 }
    99|             });
   100|             me.cacheStoreData(store);
   101|             oldPositions = {};
   102|             newPositions = {};
   103|             Ext.iterate(remaining, function(id, item) {
   104|                 if (itemFly.attach(Ext.getDom(me.dataviewID + '-' + id))) {
   105|                     oldPos = oldPositions[id] = {
   106|                         top: itemFly.getY() - parentElY - itemFly.getMargin('t') -
   107|                              parentElPaddingTop
   108|                     };
   109|                     oldPos[styleSide] = me.getItemX(itemFly);
   110|                 }
   111|                 else {
   112|                     delete remaining[id];
   113|                 }
   114|             });
   115|             dataview.refresh();
   116|             Ext.iterate(removed, function(id, item) {
   117|                 parentEl.dom.appendChild(item.dom);
   118|                 itemFly.attach(item.dom).animate({
   119|                     duration: duration,
   120|                     opacity: 0,
   121|                     callback: function(anim) {
   122|                         var el = Ext.get(anim.target.id);
   123|                         if (el) {
   124|                             el.destroy();
   125|                         }
   126|                     }
   127|                 });
   128|                 delete item.dom;
   129|             });
   130|             if (!store.getCount()) {
   131|                 return;
   132|             }
   133|             itemArray = items.slice();
   134|             for (i = itemArray.length - 1; i >= 0; i--) {
   135|                 id = store.getAt(i).internalId;
   136|                 itemFly.attach(itemArray[i]);
   137|                 newPositions[id] = {
   138|                     dom: itemFly.dom,
   139|                     top: itemFly.getY() - parentElY - itemFly.getMargin('t') - parentElPaddingTop
   140|                 };
   141|                 newPositions[id][styleSide] = me.getItemX(itemFly);
   142|                 newPos = oldPositions[id] || newPositions[id];
   143|                 newStyle.position = 'absolute';
   144|                 newStyle.top = newPos.top + "px";
   145|                 newStyle[styleSide] = newPos.left + "px";
   146|                 itemFly.applyStyles(newStyle);
   147|             }
   148|             doAnimate = function() {
   149|                 var elapsed = new Date() - task.taskStartTime,
   150|                     fraction = elapsed / duration,
   151|                     oldPos, newPos, oldTop, newTop, oldLeft, newLeft,
   152|                     diffTop, diffLeft, midTop, midLeft;
   153|                 if (fraction >= 1) {
   154|                     newStyle.position = newStyle.top = newStyle[styleSide] = '';
   155|                     for (id in newPositions) {
   156|                         itemFly.attach(newPositions[id].dom).applyStyles(newStyle);
   157|                     }
   158|                     Ext.TaskManager.stop(task);
   159|                 }
   160|                 else {
   161|                     for (id in remaining) {
   162|                         oldPos = oldPositions[id];
   163|                         newPos = newPositions[id];
   164|                         oldTop = oldPos.top;
   165|                         newTop = newPos.top;
   166|                         oldLeft = oldPos[styleSide];
   167|                         newLeft = newPos[styleSide];
   168|                         diffTop = fraction * Math.abs(oldTop - newTop);
   169|                         diffLeft = fraction * Math.abs(oldLeft - newLeft);
   170|                         midTop = oldTop > newTop ? oldTop - diffTop : oldTop + diffTop;
   171|                         midLeft = oldLeft > newLeft ? oldLeft - diffLeft : oldLeft + diffLeft;
   172|                         newStyle.top = midTop + "px";
   173|                         newStyle[styleSide] = midLeft + "px";
   174|                         itemFly.attach(newPos.dom).applyStyles(newStyle);
   175|                     }
   176|                 }
   177|             };
   178|             Ext.iterate(added, function(id, item) {
   179|                 if (itemFly.attach(Ext.getDom(me.dataviewID + '-' + id))) {
   180|                     itemFly.setOpacity(0);
   181|                     itemFly.animate({
   182|                         duration: duration,
   183|                         opacity: 1
   184|                     });
   185|                 }
   186|             });
   187|             Ext.TaskManager.stop(task);
   188|             task.run = doAnimate;
   189|             Ext.TaskManager.start(task);
   190|             me.cacheStoreData(store);
   191|         }
   192|     },
   193|     getItemX: function(el) {
   194|         var rtl = this.dataview.getInherited().rtl,
   195|             parentEl = el.up('');
   196|         if (rtl) {
   197|             return parentEl.getViewRegion().right - el.getRegion().right + el.getMargin('r');
   198|         }
   199|         else {
   200|             return el.getX() - parentEl.getX() - el.getMargin('l') - parentEl.getPadding('l');
   201|         }
   202|     },
   203|     /**
   204|      * Caches the records from a store locally for comparison later
   205|      * @param {Ext.data.Store} store The store to cache data from
   206|      */
   207|     cacheStoreData: function(store) {
   208|         var cachedStoreData = this.cachedStoreData = {};
   209|         store.each(function(record) {
   210|             cachedStoreData[record.internalId] = record;
   211|         });
   212|     },
   213|     /**
   214|      * Returns all records that were already in the DataView
   215|      * @return {Object} All existing records
   216|      */
   217|     getExisting: function() {
   218|         return this.cachedStoreData;
   219|     },
   220|     /**
   221|      * Returns the total number of items that are currently visible in the DataView
   222|      * @return {Number} The number of existing items
   223|      */
   224|     getExistingCount: function() {
   225|         var count = 0,
   226|             items = this.getExisting(),
   227|             k; // eslint-disable-line no-unused-vars
   228|         for (k in items) {
   229|             count++;
   230|         }
   231|         return count;
   232|     },
   233|     /**
   234|      * Returns all records in the given store that were not already present
   235|      * @param {Ext.data.Store} store The updated store instance
   236|      * @return {Object} Object of records not already present in the dataview in format {id: record}
   237|      */
   238|     getAdded: function(store) {
   239|         var cachedStoreData = this.cachedStoreData,
   240|             added = {};
   241|         store.each(function(record) {
   242|             if (cachedStoreData[record.internalId] == null) {
   243|                 added[record.internalId] = record;
   244|             }
   245|         });
   246|         return added;
   247|     },
   248|     /**
   249|      * Returns all records that are present in the DataView but not the new store
   250|      * @param {Ext.data.Store} store The updated store instance
   251|      * @return {Array} Array of records that used to be present
   252|      */
   253|     getRemoved: function(store) {
   254|         var cachedStoreData = this.cachedStoreData,
   255|             removed = {},
   256|             id;
   257|         for (id in cachedStoreData) {
   258|             if (store.findBy(function(record) { return record.internalId === id }) === -1) {
   259|                 removed[id] = cachedStoreData[id];
   260|             }
   261|         }
   262|         return removed;
   263|     },
   264|     /**
   265|      * Returns all records that are already present and are still present in the new store
   266|      * @param {Ext.data.Store} store The updated store instance
   267|      * @return {Object} Object of records that are still present from last time in format
   268|      * {id: record}
   269|      */
   270|     getRemaining: function(store) {
   271|         var cachedStoreData = this.cachedStoreData,
   272|             remaining = {};
   273|         store.each(function(record) {
   274|             if (cachedStoreData[record.internalId] != null) {
   275|                 remaining[record.internalId] = record;
   276|             }
   277|         });
   278|         return remaining;
   279|     }
   280| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/DataView/DragSelector.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-175 ---
     1| /**
     2|  *
     3|  */
     4| Ext.define('Ext.ux.DataView.DragSelector', {
     5|     requires: ['Ext.dd.DragTracker', 'Ext.util.Region'],
     6|     alias: 'plugin.dataviewdragselector',
     7|     /**
     8|      * Initializes the plugin by setting up the drag tracker
     9|      */
    10|     init: function(dataview) {
    11|         var scroller = dataview.getScrollable();
    12|         if (scroller && (scroller.getX() || scroller.getY()) &&
    13|             (Ext.supports.PointerEvents || Ext.supports.MSPointerEvents)) {
    14|             Ext.log.warn('DragSelector not available on PointerEvent devices');
    15|             return;
    16|         }
    17|         /**
    18|          * @property dataview
    19|          * @type Ext.view.View
    20|          * The DataView bound to this instance
    21|          */
    22|         this.dataview = dataview;
    23|         dataview.mon(dataview, {
    24|             beforecontainerclick: this.cancelClick,
    25|             scope: this,
    26|             render: {
    27|                 fn: this.onRender,
    28|                 scope: this,
    29|                 single: true
    30|             }
    31|         });
    32|     },
    33|     /**
    34|      * @private
    35|      * Called when the attached DataView is rendered. This sets up the DragTracker instance
    36|      * that will be used to created a dragged selection area
    37|      */
    38|     onRender: function() {
    39|         /**
    40|          * @property tracker
    41|          * @type Ext.dd.DragTracker
    42|          * The DragTracker attached to this instance. Note that the 4 on* functions are called
    43|          * in the scope of the  DragTracker ('this' refers to the DragTracker inside those
    44|          * functions), so we pass a reference to the  DragSelector so that we can call
    45|          * this class's functions.
    46|          */
    47|         this.tracker = Ext.create('Ext.dd.DragTracker', {
    48|             dataview: this.dataview,
    49|             el: this.dataview.el,
    50|             onBeforeStart: this.onBeforeStart,
    51|             onStart: this.onStart.bind(this),
    52|             onDrag: this.onDrag.bind(this),
    53|             onEnd: Ext.Function.createDelayed(this.onEnd, 100, this)
    54|         });
    55|         /**
    56|          * @property dragRegion
    57|          * @type Ext.util.Region
    58|          * Represents the region currently dragged out by the user. This is used to figure out
    59|          * which dataview nodes are in the selected area and to set the size of the Proxy element
    60|          * used to highlight the current drag area
    61|          */
    62|         this.dragRegion = Ext.create('Ext.util.Region');
    63|     },
    64|     /**
    65|      * @private
    66|      * Listener attached to the DragTracker's onBeforeStart event. Returns false if the drag
    67|      * didn't start within the DataView's el
    68|      */
    69|     onBeforeStart: function(e) {
    70|         return e.target === this.dataview.getEl().dom;
    71|     },
    72|     /**
    73|      * @private
    74|      * Listener attached to the DragTracker's onStart event. Cancel's the DataView's containerclick
    75|      * event from firing and sets the start co-ordinates of the Proxy element. Clears any existing
    76|      * DataView selection
    77|      * @param {Ext.event.Event} e The click event
    78|      */
    79|     onStart: function(e) {
    80|         var dataview = this.dataview;
    81|         this.dragging = true;
    82|         this.fillRegions();
    83|         this.getProxy().show();
    84|         dataview.getSelectionModel().deselectAll();
    85|     },
    86|     /**
    87|      * @private
    88|      * Reusable handler that's used to cancel the container click event when dragging on the
    89|      * dataview. See onStart for details
    90|      */
    91|     cancelClick: function() {
    92|         return !this.dragging;
    93|     },
    94|     /**
    95|      * @private
    96|      * Listener attached to the DragTracker's onDrag event. Figures out how large the drag selection
    97|      * area should be and updates the proxy element's size to match. Then iterates over all of the
    98|      * rendered items and marks them selected if the drag region touches them
    99|      * @param {Ext.event.Event} e The drag event
   100|      */
   101|     onDrag: function(e) {
   102|         var selModel = this.dataview.getSelectionModel(),
   103|             dragRegion = this.dragRegion,
   104|             bodyRegion = this.bodyRegion,
   105|             proxy = this.getProxy(),
   106|             regions = this.regions,
   107|             length = regions.length,
   108|             startXY = this.tracker.startXY,
   109|             currentXY = this.tracker.getXY(),
   110|             minX = Math.min(startXY[0], currentXY[0]),
   111|             minY = Math.min(startXY[1], currentXY[1]),
   112|             width = Math.abs(startXY[0] - currentXY[0]),
   113|             height = Math.abs(startXY[1] - currentXY[1]),
   114|             region, selected, i;
   115|         Ext.apply(dragRegion, {
   116|             top: minY,
   117|             left: minX,
   118|             right: minX + width,
   119|             bottom: minY + height
   120|         });
   121|         dragRegion.constrainTo(bodyRegion);
   122|         proxy.setBox(dragRegion);
   123|         for (i = 0; i < length; i++) {
   124|             region = regions[i];
   125|             selected = dragRegion.intersect(region);
   126|             if (selected) {
   127|                 selModel.select(i, true);
   128|             }
   129|             else {
   130|                 selModel.deselect(i);
   131|             }
   132|         }
   133|     },
   134|     /**
   135|      * @method
   136|      * @private
   137|      * Listener attached to the DragTracker's onEnd event. This is a delayed function which
   138|      * executes 1 millisecond after it has been called. This is because the dragging flag must
   139|      * remain active to cancel the containerclick event which the mouseup event will trigger.
   140|      * @param {Ext.event.Event} e The event object
   141|      */
   142|     onEnd: function(e) {
   143|         var dataview = this.dataview,
   144|             selModel = dataview.getSelectionModel(); // eslint-disable-line no-unused-vars
   145|         this.dragging = false;
   146|         this.getProxy().hide();
   147|     },
   148|     /**
   149|      * @private
   150|      * Creates a Proxy element that will be used to highlight the drag selection region
   151|      * @return {Ext.Element} The Proxy element
   152|      */
   153|     getProxy: function() {
   154|         if (!this.proxy) {
   155|             this.proxy = this.dataview.getEl().createChild({
   156|                 tag: 'div',
   157|                 cls: 'x-view-selector'
   158|             });
   159|         }
   160|         return this.proxy;
   161|     },
   162|     /**
   163|      * @private
   164|      * Gets the region taken up by each rendered node in the DataView. We use these regions
   165|      * to figure out which nodes to select based on the selector region the user has dragged out
   166|      */
   167|     fillRegions: function() {
   168|         var dataview = this.dataview,
   169|             regions = this.regions = [];
   170|         dataview.all.each(function(node) {
   171|             regions.push(node.getRegion());
   172|         });
   173|         this.bodyRegion = dataview.getEl().getRegion();
   174|     }
   175| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/DataView/Draggable.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-216 ---
     1| /**
     2|  * ## Basic DataView with Draggable mixin.
     3|  *
     4|  *     Ext.Loader.setPath('Ext.ux', '../../../SDK/extjs/examples/ux');
     5|  *
     6|  *     Ext.define('My.cool.View', {
     7|  *         extend: 'Ext.view.View',
     8|  *
     9|  *         mixins: {
    10|  *             draggable: 'Ext.ux.DataView.Draggable'
    11|  *         },
    12|  *
    13|  *         initComponent: function() {
    14|  *             this.mixins.draggable.init(this, {
    15|  *                 ddConfig: {
    16|  *                     ddGroup: 'someGroup'
    17|  *                 }
    18|  *             });
    19|  * 
    20|  *             this.callParent(arguments);
    21|  *         }
    22|  *     });
    23|  *
    24|  *     Ext.onReady(function () {
    25|  *         Ext.create('Ext.data.Store', {
    26|  *             storeId: 'baseball',
    27|  *             fields: ['team', 'established'],
    28|  *             data: [
    29|  *                 { team: 'Atlanta Braves', established: '1871' },
    30|  *                 { team: 'Miami Marlins', established: '1993' },
    31|  *                 { team: 'New York Mets', established: '1962' },
    32|  *                 { team: 'Philadelphia Phillies', established: '1883' },
    33|  *                 { team: 'Washington Nationals', established: '1969' }
    34|  *             ]
    35|  *          });
    36|  *
    37|  *          Ext.create('My.cool.View', {
    38|  *              store: Ext.StoreMgr.get('baseball'),
    39|  *              tpl: [
    40|  *                  '<tpl for=".">', 
    41|  *                      '<p class="team">', 
    42|  *                          'The {team} were founded in {established}.',
    43|  *                      '</p>', 
    44|  *                  '</tpl>'
    45|  *              ],
    46|  *              itemSelector: 'p.team',
    47|  *              renderTo: Ext.getBody()
    48|  *          });
    49|  *      });
    50|  */
    51| Ext.define('Ext.ux.DataView.Draggable', {
    52|     requires: 'Ext.dd.DragZone',
    53|     /**
    54|      * @cfg {String} ghostCls The CSS class added to the outermost element of the created
    55|      * ghost proxy (defaults to 'x-dataview-draggable-ghost')
    56|      */
    57|     ghostCls: 'x-dataview-draggable-ghost',
    58|     /**
    59|      * @cfg {Ext.XTemplate/Array} ghostTpl The template used in the ghost DataView
    60|      */
    61|     ghostTpl: [
    62|         '<tpl for=".">',
    63|             '{title}', // eslint-disable-line indent
    64|         '</tpl>'
    65|     ],
    66|     /**
    67|      * @cfg {Object} ddConfig Config object that is applied to the internally created DragZone
    68|      */
    69|     /**
    70|      * @cfg {String} ghostConfig Config object that is used to configure the internally created
    71|      * DataView
    72|      */
    73|     init: function(dataview, config) {
    74|         /**
    75|          * @property dataview
    76|          * @type Ext.view.View
    77|          * The Ext.view.View instance that this DragZone is attached to
    78|          */
    79|         this.dataview = dataview;
    80|         dataview.on('render', this.onRender, this);
    81|         Ext.apply(this, {
    82|             itemSelector: dataview.itemSelector,
    83|             ghostConfig: {}
    84|         }, config || {});
    85|         Ext.applyIf(this.ghostConfig, {
    86|             itemSelector: 'img',
    87|             cls: this.ghostCls,
    88|             tpl: this.ghostTpl
    89|         });
    90|     },
    91|     /**
    92|      * @private
    93|      * Called when the attached DataView is rendered. Sets up the internal DragZone
    94|      */
    95|     onRender: function() {
    96|         var me = this,
    97|             config = Ext.apply({}, me.ddConfig || {}, {
    98|                 dvDraggable: me,
    99|                 dataview: me.dataview,
   100|                 getDragData: me.getDragData,
   101|                 getTreeNode: me.getTreeNode,
   102|                 afterRepair: me.afterRepair,
   103|                 getRepairXY: me.getRepairXY
   104|             });
   105|         /**
   106|          * @property dragZone
   107|          * @type Ext.dd.DragZone
   108|          * The attached DragZone instane
   109|          */
   110|         me.dragZone = Ext.create('Ext.dd.DragZone', me.dataview.getEl(), config);
   111|         me.dataview.setItemsDraggable(true);
   112|     },
   113|     getDragData: function(e) {
   114|         var draggable = this.dvDraggable,
   115|             dataview = this.dataview,
   116|             selModel = dataview.getSelectionModel(),
   117|             target = e.getTarget(draggable.itemSelector),
   118|             selected, dragData;
   119|         if (target) {
   120|             e.preventDefault();
   121|             if (!dataview.isSelected(target)) {
   122|                 selModel.select(dataview.getRecord(target));
   123|             }
   124|             selected = dataview.getSelectedNodes();
   125|             dragData = {
   126|                 copy: true,
   127|                 nodes: selected,
   128|                 records: selModel.getSelection(),
   129|                 item: true
   130|             };
   131|             if (selected.length === 1) {
   132|                 dragData.single = true;
   133|                 dragData.ddel = target;
   134|             }
   135|             else {
   136|                 dragData.multi = true;
   137|                 dragData.ddel = draggable.prepareGhost(selModel.getSelection());
   138|             }
   139|             return dragData;
   140|         }
   141|         return false;
   142|     },
   143|     getTreeNode: function() {
   144|     },
   145|     afterRepair: function() {
   146|         var nodes = this.dragData.nodes,
   147|             length = nodes.length,
   148|             i;
   149|         this.dragging = false;
   150|         for (i = 0; i < length; i++) {
   151|             Ext.get(nodes[i]).frame('#8db2e3', 1);
   152|         }
   153|     },
   154|     /**
   155|      * @private
   156|      * Returns the x and y co-ordinates that the dragged item should be animated back to if it
   157|      * was dropped on an invalid drop target. If we're dragging more than one item we don't animate
   158|      * back and just allow afterRepair to frame each dropped item.
   159|      */
   160|     getRepairXY: function(e) {
   161|         var repairEl, repairXY;
   162|         if (this.dragData.multi) {
   163|             return false;
   164|         }
   165|         else {
   166|             repairEl = Ext.get(this.dragData.ddel);
   167|             repairXY = repairEl.getXY();
   168|             repairXY[0] += repairEl.getPadding('t') + repairEl.getMargin('t');
   169|             repairXY[1] += repairEl.getPadding('l') + repairEl.getMargin('l');
   170|             return repairXY;
   171|         }
   172|     },
   173|     /**
   174|      * Updates the internal ghost DataView by ensuring it is rendered and contains the correct
   175|      * records
   176|      * @param {Array} records The set of records that is currently selected in the parent DataView
   177|      * @return {HTMLElement} The Ghost DataView's encapsulating HTMLElement.
   178|      */
   179|     prepareGhost: function(records) {
   180|         return this.createGhost(records).getEl().dom;
   181|     },
   182|     /**
   183|      * @private
   184|      * Creates the 'ghost' DataView that follows the mouse cursor during the drag operation.
   185|      * This div is usually a lighter-weight representation of just the nodes that are selected
   186|      * in the parent DataView.
   187|      */
   188|     createGhost: function(records) {
   189|         var me = this,
   190|             store;
   191|         if (me.ghost) {
   192|             (store = me.ghost.store).loadRecords(records);
   193|         }
   194|         else {
   195|             store = Ext.create('Ext.data.Store', {
   196|                 model: records[0].self
   197|             });
   198|             store.loadRecords(records);
   199|             me.ghost = Ext.create('Ext.view.View', Ext.apply({
   200|                 renderTo: document.createElement('div'),
   201|                 store: store
   202|             }, me.ghostConfig));
   203|             me.ghost.container.skipGarbageCollection = me.ghost.el.skipGarbageCollection = true;
   204|         }
   205|         store.clearData();
   206|         return me.ghost;
   207|     },
   208|     destroy: function() {
   209|         var ghost = this.ghost;
   210|         if (ghost) {
   211|             ghost.container.destroy();
   212|             ghost.destroy();
   213|         }
   214|         this.callParent();
   215|     }
   216| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/DataView/LabelEditor.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| /**
     2|  *
     3|  */
     4| Ext.define('Ext.ux.DataView.LabelEditor', {
     5|     extend: 'Ext.Editor',
     6|     alias: 'plugin.dataviewlabeleditor',
     7|     alignment: 'tl-tl',
     8|     completeOnEnter: true,
     9|     cancelOnEsc: true,
    10|     shim: false,
    11|     autoSize: {
    12|         width: 'boundEl',
    13|         height: 'field'
    14|     },
    15|     labelSelector: 'x-editable',
    16|     requires: [
    17|         'Ext.form.field.Text'
    18|     ],
    19|     constructor: function(config) {
    20|         config.field = config.field || Ext.create('Ext.form.field.Text', {
    21|             allowOnlyWhitespace: false,
    22|             selectOnFocus: true
    23|         });
    24|         this.callParent([config]);
    25|     },
    26|     init: function(view) {
    27|         this.view = view;
    28|         this.mon(view, 'afterrender', this.bindEvents, this);
    29|         this.on('complete', this.onSave, this);
    30|     },
    31|     bindEvents: function() {
    32|         this.mon(this.view.getEl(), {
    33|             click: {
    34|                 fn: this.onClick,
    35|                 scope: this
    36|             }
    37|         });
    38|     },
    39|     onClick: function(e, target) {
    40|         var me = this,
    41|             item, record;
    42|         if (Ext.fly(target).hasCls(me.labelSelector) && !me.editing && !e.ctrlKey && !e.shiftKey) {
    43|             e.stopEvent();
    44|             item = me.view.findItemByChild(target);
    45|             record = me.view.store.getAt(me.view.indexOf(item));
    46|             me.startEdit(target, record.data[me.dataIndex]);
    47|             me.activeRecord = record;
    48|         }
    49|         else if (me.editing) {
    50|             me.field.blur();
    51|             e.preventDefault();
    52|         }
    53|     },
    54|     onSave: function(ed, value) {
    55|         this.activeRecord.set(this.dataIndex, value);
    56|     }
    57| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/DataViewTransition.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-263 ---
     1| /**
     2|  * @class Ext.ux.DataViewTransition
     3|  * Transition plugin for DataViews
     4|  */
     5| /* eslint-disable vars-on-top, one-var */
     6| Ext.ux.DataViewTransition = Ext.extend(Object, {
     7|     /**
     8|      * @property defaults
     9|      * @type Object
    10|      * Default configuration options for all DataViewTransition instances
    11|      */
    12|     defaults: {
    13|         duration: 750,
    14|         idProperty: 'id'
    15|     },
    16|     /**
    17|      * Creates the plugin instance, applies defaults
    18|      * @constructor
    19|      * @param {Object} config Optional config object
    20|      */
    21|     constructor: function(config) {
    22|         Ext.apply(this, config || {}, this.defaults);
    23|     },
    24|     /**
    25|      * Initializes the transition plugin. Overrides the dataview's default refresh function
    26|      * @param {Ext.view.View} dataview The dataview
    27|      */
    28|     init: function(dataview) {
    29|         /**
    30|          * @property dataview
    31|          * @type Ext.view.View
    32|          * Reference to the DataView this instance is bound to
    33|          */
    34|         this.dataview = dataview;
    35|         var idProperty = this.idProperty;
    36|         dataview.blockRefresh = true;
    37|         dataview.updateIndexes = Ext.Function.createSequence(dataview.updateIndexes, function() {
    38|             this.getTargetEl().select(this.itemSelector).each(function(element, composite, index) {
    39|                 element.id = element.dom.id = Ext.util.Format.format(
    40|                     "{0}-{1}", dataview.id, dataview.store.getAt(index).get(idProperty)
    41|                 );
    42|             }, this);
    43|         }, dataview);
    44|         /**
    45|          * @property dataviewID
    46|          * @type String
    47|          * The string ID of the DataView component. This is used internally when animating
    48|          * child objects
    49|          */
    50|         this.dataviewID = dataview.id;
    51|         /**
    52|          * @property cachedStoreData
    53|          * @type Object
    54|          * A cache of existing store data, keyed by id. This is used to determine
    55|          * whether any items were added or removed from the store on data change
    56|          */
    57|         this.cachedStoreData = {};
    58|         this.cacheStoreData(dataview.store.snapshot);
    59|         dataview.store.on('datachanged', function(store) {
    60|             var parentEl = dataview.getTargetEl(),
    61|                 calcItem = store.getAt(0),
    62|                 added = this.getAdded(store),
    63|                 removed = this.getRemoved(store),
    64|                 previous = this.getRemaining(store);
    65|             Ext.each(removed, function(item) {
    66|                 Ext.fly(this.dataviewID + '-' + item.get(this.idProperty)).animate({
    67|                     remove: false,
    68|                     duration: duration,
    69|                     opacity: 0,
    70|                     useDisplay: true
    71|                 });
    72|             }, this);
    73|             if (calcItem == undefined) { // eslint-disable-line eqeqeq
    74|                 this.cacheStoreData(store);
    75|                 return;
    76|             }
    77|             var el = Ext.get(this.dataviewID + "-" + calcItem.get(this.idProperty)),
    78|                 itemWidth = el.getMargin('lr') + el.getWidth(),
    79|                 itemHeight = el.getMargin('bt') + el.getHeight(),
    80|                 dvWidth = parentEl.getWidth(),
    81|                 columns = Math.floor(dvWidth / itemWidth);
    82|             parentEl.applyStyles({
    83|                 display: 'block',
    84|                 position: 'relative'
    85|             });
    86|             var oldPositions = {},
    87|                 newPositions = {},
    88|                 elCache = {};
    89|             Ext.iterate(previous, function(id, item) {
    90|                 var id = item.get(this.idProperty),
    91|                     el = elCache[id] = Ext.get(this.dataviewID + '-' + id);
    92|                 oldPositions[id] = {
    93|                     top: el.getY() - parentEl.getY() - el.getMargin('t') - parentEl.getPadding('t'),
    94|                     left: el.getX() - parentEl.getX() - el.getMargin('l') - parentEl.getPadding('l')
    95|                 };
    96|             }, this);
    97|             Ext.iterate(previous, function(id, item) {
    98|                 var oldPos = oldPositions[id],
    99|                     el = elCache[id];
   100|                 if (el.getStyle('position') !== 'absolute') {
   101|                     elCache[id].applyStyles({
   102|                         position: 'absolute',
   103|                         left: oldPos.left + "px",
   104|                         top: oldPos.top + "px",
   105|                         width: el.getWidth(!Ext.isIE || Ext.isStrict),
   106|                         height: el.getHeight(!Ext.isIE || Ext.isStrict)
   107|                     });
   108|                 }
   109|             });
   110|             var index = 0;
   111|             Ext.iterate(store.data.items, function(item) {
   112|                 var id = item.get(idProperty),
   113|                     column = index % columns,
   114|                     row = Math.floor(index / columns),
   115|                     top = row * itemHeight,
   116|                     left = column * itemWidth;
   117|                 newPositions[id] = {
   118|                     top: top,
   119|                     left: left
   120|                 };
   121|                 index ++;
   122|             }, this);
   123|             var startTime = new Date(),
   124|                 duration = this.duration,
   125|                 dataviewID = this.dataviewID,
   126|                 doAnimate = function() {
   127|                     var elapsed = new Date() - startTime,
   128|                         fraction = elapsed / duration,
   129|                         id;
   130|                     if (fraction >= 1) {
   131|                         for (id in newPositions) {
   132|                             Ext.fly(dataviewID + '-' + id).applyStyles({
   133|                                 top: newPositions[id].top + "px",
   134|                                 left: newPositions[id].left + "px"
   135|                             });
   136|                         }
   137|                         Ext.TaskManager.stop(task);
   138|                     }
   139|                     else {
   140|                         for (id in newPositions) {
   141|                             if (!previous[id]) {
   142|                                 continue;
   143|                             }
   144|                             var oldPos = oldPositions[id],
   145|                                 newPos = newPositions[id],
   146|                                 oldTop = oldPos.top,
   147|                                 newTop = newPos.top,
   148|                                 oldLeft = oldPos.left,
   149|                                 newLeft = newPos.left,
   150|                                 diffTop = fraction * Math.abs(oldTop - newTop),
   151|                                 diffLeft = fraction * Math.abs(oldLeft - newLeft),
   152|                                 midTop = oldTop > newTop ? oldTop - diffTop : oldTop + diffTop,
   153|                                 midLeft = oldLeft > newLeft
   154|                                     ? oldLeft - diffLeft
   155|                                     : oldLeft + diffLeft;
   156|                             Ext.fly(dataviewID + '-' + id).applyStyles({
   157|                                 top: midTop + "px",
   158|                                 left: midLeft + "px"
   159|                             });
   160|                         }
   161|                     }
   162|                 },
   163|                 task = {
   164|                     run: doAnimate,
   165|                     interval: 20,
   166|                     scope: this
   167|                 };
   168|             Ext.TaskManager.start(task);
   169|             var count = 0;
   170|             for (var k in added) { // eslint-disable-line no-unused-vars
   171|                 count++;
   172|             }
   173|             if (Ext.global.console && Ext.global.console.log) {
   174|                 Ext.global.console.log('added:', count);
   175|             }
   176|             Ext.iterate(added, function(id, item) {
   177|                 Ext.fly(this.dataviewID + '-' + item.get(this.idProperty)).applyStyles({
   178|                     top: newPositions[item.get(this.idProperty)].top + "px",
   179|                     left: newPositions[item.get(this.idProperty)].left + "px"
   180|                 });
   181|                 Ext.fly(this.dataviewID + '-' + item.get(this.idProperty)).animate({
   182|                     remove: false,
   183|                     duration: duration,
   184|                     opacity: 1
   185|                 });
   186|             }, this);
   187|             this.cacheStoreData(store);
   188|         }, this);
   189|     },
   190|     /**
   191|      * Caches the records from a store locally for comparison later
   192|      * @param {Ext.data.Store} store The store to cache data from
   193|      */
   194|     cacheStoreData: function(store) {
   195|         this.cachedStoreData = {};
   196|         store.each(function(record) {
   197|             this.cachedStoreData[record.get(this.idProperty)] = record;
   198|         }, this);
   199|     },
   200|     /**
   201|      * Returns all records that were already in the DataView
   202|      * @return {Object} All existing records
   203|      */
   204|     getExisting: function() {
   205|         return this.cachedStoreData;
   206|     },
   207|     /**
   208|      * Returns the total number of items that are currently visible in the DataView
   209|      * @return {Number} The number of existing items
   210|      */
   211|     getExistingCount: function() {
   212|         var count = 0,
   213|             items = this.getExisting();
   214|         for (var k in items) { // eslint-disable-line no-unused-vars
   215|             count++;
   216|         }
   217|         return count;
   218|     },
   219|     /**
   220|      * Returns all records in the given store that were not already present
   221|      * @param {Ext.data.Store} store The updated store instance
   222|      * @return {Object} Object of records not already present in the dataview in format {id: record}
   223|      */
   224|     getAdded: function(store) {
   225|         var added = {};
   226|         store.each(function(record) {
   227|             if (this.cachedStoreData[record.get(this.idProperty)] == undefined) {
   228|                 added[record.get(this.idProperty)] = record;
   229|             }
   230|         }, this);
   231|         return added;
   232|     },
   233|     /**
   234|      * Returns all records that are present in the DataView but not the new store
   235|      * @param {Ext.data.Store} store The updated store instance
   236|      * @return {Array} Array of records that used to be present
   237|      */
   238|     getRemoved: function(store) {
   239|         var removed = [];
   240|         for (var id in this.cachedStoreData) {
   241|             if (store.findExact(this.idProperty, Number(id)) === -1) {
   242|                 removed.push(this.cachedStoreData[id]);
   243|             }
   244|         }
   245|         return removed;
   246|     },
   247|     /**
   248|      * Returns all records that are already present and are still present in the new store
   249|      * @param {Ext.data.Store} store The updated store instance
   250|      * @return {Object} Object of records that are still present from last time in format
   251|      * {id: record}
   252|      */
   253|     getRemaining: function(store) {
   254|         var remaining = {};
   255|         store.each(function(record) {
   256|             /* eslint-disable-next-line eqeqeq */
   257|             if (this.cachedStoreData[record.get(this.idProperty)] != undefined) {
   258|                 remaining[record.get(this.idProperty)] = record;
   259|             }
   260|         }, this);
   261|         return remaining;
   262|     }
   263| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/Explorer.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-159 ---
     1| /**
     2|  * An explorer component for navigating hierarchical content.  Consists of a breadcrumb bar
     3|  * at the top, tree navigation on the left, and a center panel which displays the contents
     4|  * of a given node.
     5|  */
     6| Ext.define('Ext.ux.Explorer', {
     7|     extend: 'Ext.panel.Panel',
     8|     xtype: 'explorer',
     9|     requires: [
    10|         'Ext.layout.container.Border',
    11|         'Ext.toolbar.Breadcrumb',
    12|         'Ext.tree.Panel'
    13|     ],
    14|     config: {
    15|         /**
    16|          * @cfg {Object} breadcrumb
    17|          * Configuration object for the breadcrumb toolbar
    18|          */
    19|         breadcrumb: {
    20|             dock: 'top',
    21|             xtype: 'breadcrumb',
    22|             reference: 'breadcrumb'
    23|         },
    24|         /* eslint-disable max-len, indent */
    25|         /**
    26|          * @cfg {Object} contentView
    27|          * Configuration object for the "content" data view
    28|          */
    29|         contentView: {
    30|             xtype: 'dataview',
    31|             reference: 'contentView',
    32|             region: 'center',
    33|             cls: Ext.baseCSSPrefix + 'explorer-view',
    34|             itemSelector: '.' + Ext.baseCSSPrefix + 'explorer-item',
    35|             tpl:
    36|                 '<tpl for=".">' +
    37|                     '<div class="' + Ext.baseCSSPrefix + 'explorer-item">' +
    38|                         '<div class="{iconCls}">' +
    39|                             '<div class="' + Ext.baseCSSPrefix + 'explorer-node-icon' +
    40|                                 '{[values.leaf ? " ' + Ext.baseCSSPrefix + 'explorer-leaf-icon' + '" : ""]}' + '">' +
    41|                             '</div>' +
    42|                             '<div class="' + Ext.baseCSSPrefix + 'explorer-item-text">{text}</div>' +
    43|                         '</div>' +
    44|                     '</div>' +
    45|                 '</tpl>'
    46|         },
    47|         /* eslint-enable max-len, indent */
    48|         /**
    49|          * @cfg {Ext.data.TreeStore} store
    50|          * The TreeStore to use as the data source
    51|          */
    52|         store: null,
    53|         /**
    54|          * @cfg {Object} tree
    55|          * Configuration object for the tree
    56|          */
    57|         tree: {
    58|             xtype: 'treepanel',
    59|             reference: 'tree',
    60|             region: 'west',
    61|             width: 200
    62|         }
    63|     },
    64|     renderConfig: {
    65|         /**
    66|          * @cfg {Ext.data.TreeModel} selection
    67|          * The selected node
    68|          * @accessor
    69|          */
    70|         selection: null
    71|     },
    72|     layout: 'border',
    73|     referenceHolder: true,
    74|     defaultListenerScope: true,
    75|     cls: Ext.baseCSSPrefix + 'explorer',
    76|     initComponent: function() {
    77|         var me = this,
    78|             store = me.getStore();
    79|         if (!store) {
    80|             Ext.raise('Ext.ux.Explorer requires a store.');
    81|         }
    82|         me.dockedItems = [ me.getBreadcrumb() ];
    83|         me.items = [ me.getTree(), me.getContentView() ];
    84|         me.callParent();
    85|     },
    86|     applyBreadcrumb: function(breadcrumb) {
    87|         var store = this.getStore();
    88|         breadcrumb = Ext.create(Ext.apply({
    89|             store: store,
    90|             selection: store.getRoot()
    91|         }, breadcrumb));
    92|         breadcrumb.on('selectionchange', '_onBreadcrumbSelectionChange', this);
    93|         return breadcrumb;
    94|     },
    95|     applyContentView: function(contentView) {
    96|         /**
    97|          * @property {Ext.data.Store} contentStore
    98|          * @private
    99|          * The backing store for the content view
   100|          */
   101|         var contentStore = this.contentStore = new Ext.data.Store({
   102|             model: this.getStore().model
   103|         });
   104|         contentView = Ext.create(Ext.apply({
   105|             store: contentStore
   106|         }, contentView));
   107|         return contentView;
   108|     },
   109|     applyTree: function(tree) {
   110|         tree = Ext.create(Ext.apply({
   111|             store: this.getStore()
   112|         }, tree));
   113|         tree.on('selectionchange', '_onTreeSelectionChange', this);
   114|         return tree;
   115|     },
   116|     updateSelection: function(node) {
   117|         var me = this,
   118|             refs = me.getReferences(),
   119|             breadcrumb = refs.breadcrumb,
   120|             tree = refs.tree,
   121|             treeSelectionModel = tree.getSelectionModel(),
   122|             contentStore = me.contentStore,
   123|             parentNode, treeView;
   124|         if (breadcrumb.getSelection() !== node) {
   125|             breadcrumb.setSelection(node);
   126|         }
   127|         if (treeSelectionModel.getSelection()[0] !== node) {
   128|             treeSelectionModel.select([node]);
   129|             parentNode = node.parentNode;
   130|             if (parentNode) {
   131|                 parentNode.expand();
   132|             }
   133|             treeView = tree.getView();
   134|             treeView.scrollRowIntoView(treeView.getRow(node));
   135|         }
   136|         contentStore.removeAll();
   137|         contentStore.add(node.hasChildNodes() ? node.childNodes : [node]);
   138|     },
   139|     updateStore: function(store) {
   140|         this.getBreadcrumb().setStore(store);
   141|     },
   142|     privates: {
   143|         /**
   144|          * Handles the tree's selectionchange event
   145|          * @private
   146|          * @param {Ext.tree.Panel} tree
   147|          * @param {Ext.data.TreeModel[]} selection
   148|          */
   149|         _onTreeSelectionChange: function(tree, selection) {
   150|             this.setSelection(selection[0]);
   151|         },
   152|         /**
   153|          * Handles the breadcrumb bar's selectionchange event
   154|          */
   155|         _onBreadcrumbSelectionChange: function(breadcrumb, selection) {
   156|             this.setSelection(selection);
   157|         }
   158|     }
   159| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/FieldReplicator.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| /**
     2|  * A plugin for Field Components which creates clones of the Field for as
     3|  * long as the user keeps filling them. Leaving the final one blank ends the repeating series.
     4|  *
     5|  * Usage:
     6|  *
     7|  *      items: [{
     8|  *          xtype: 'combo',
     9|  *          plugins: {
    10|  *              fieldreplicator: true
    11|  *          },
    12|  *          triggerAction: 'all',
    13|  *          fieldLabel: 'Select recipient',
    14|  *          store: recipientStore
    15|  *      }]
    16|  *
    17|  */
    18| Ext.define('Ext.ux.FieldReplicator', {
    19|     alias: 'plugin.fieldreplicator',
    20|     init: function(field) {
    21|         if (!field.replicatorId) {
    22|             field.replicatorId = Ext.id();
    23|         }
    24|         field.on('blur', this.onBlur, this);
    25|     },
    26|     onBlur: function(field) {
    27|         var ownerCt = field.ownerCt,
    28|             replicatorId = field.replicatorId,
    29|             isEmpty = Ext.isEmpty(field.getRawValue()),
    30|             siblings = ownerCt.query('[replicatorId=' + replicatorId + ']'),
    31|             isLastInGroup = siblings[siblings.length - 1] === field,
    32|             clone, idx;
    33|         if (isEmpty && !isLastInGroup) {
    34|             Ext.defer(field.destroy, 10, field); // delay to allow tab key to move focus first
    35|         }
    36|         else if (!isEmpty && isLastInGroup) {
    37|             if (field.onReplicate) {
    38|                 field.onReplicate();
    39|             }
    40|             clone = field.cloneConfig({ replicatorId: replicatorId });
    41|             idx = ownerCt.items.indexOf(field);
    42|             ownerCt.add(idx + 1, clone);
    43|         }
    44|     }
    45| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/GMapPanel.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-118 ---
     1| /**
     2|  * The GMap Panel UX extends `Ext.panel.Panel` in order to display Google Maps.
     3|  *
     4|  * It is important to note that you must include the following Google Maps API above
     5|  * bootstrap.js in your  application's index.html file (or equivalent).
     6|  *
     7|  *     <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&sensor=false"></script>
     8|  *
     9|  * It is important to note that due to the Google Maps loader, you cannot currently include
    10|  * the above JS resource in the Cmd generated app.json file. Doing so interferes with the loading of
    11|  * Ext JS and Google Maps. 
    12|  *
    13|  * The following example creates a window containing a GMap Panel.  In this case, the center 
    14|  * is set as geoCodeAddr, which is a string that Google translates into longitude and latitude.
    15|  * 
    16|  *     var mapwin = Ext.create('Ext.Window', {
    17|  *         layout: 'fit',
    18|  *         title: 'GMap Window',
    19|  *         width: 450,
    20|  *         height: 250,
    21|  *         items: {
    22|  *             xtype: 'gmappanel',
    23|  *             gmapType: 'map',
    24|  *             center: {
    25|  *                 geoCodeAddr: "221B Baker Street",
    26|  *                 marker: {
    27|  *                     title: 'Holmes Home'
    28|  *                 }
    29|  *             },
    30|  *             mapOptions : {
    31|  *                 mapTypeId: google.maps.MapTypeId.ROADMAP
    32|  *             }
    33|  *         }
    34|  *     }).show();
    35|  * 
    36|  */
    37| Ext.define('Ext.ux.GMapPanel', {
    38|     extend: 'Ext.panel.Panel',
    39|     alias: 'widget.gmappanel',
    40|     requires: ['Ext.window.MessageBox'],
    41|     initComponent: function() {
    42|         Ext.applyIf(this, {
    43|             plain: true,
    44|             gmapType: 'map',
    45|             border: false
    46|         });
    47|         this.callParent();
    48|     },
    49|     onBoxReady: function() {
    50|         var center = this.center;
    51|         this.callParent(arguments);
    52|         if (center) {
    53|             if (center.geoCodeAddr) {
    54|                 this.lookupCode(center.geoCodeAddr, center.marker);
    55|             }
    56|             else {
    57|                 this.createMap(center);
    58|             }
    59|         }
    60|         else {
    61|             Ext.raise('center is required');
    62|         }
    63|     },
    64|     createMap: function(center, marker) {
    65|         var options = Ext.apply({}, this.mapOptions);
    66|         /* global google */
    67|         options = Ext.applyIf(options, {
    68|             zoom: 14,
    69|             center: center,
    70|             mapTypeId: google.maps.MapTypeId.HYBRID
    71|         });
    72|         this.gmap = new google.maps.Map(this.body.dom, options);
    73|         if (marker) {
    74|             this.addMarker(Ext.applyIf(marker, {
    75|                 position: center
    76|             }));
    77|         }
    78|         Ext.each(this.markers, this.addMarker, this);
    79|         this.fireEvent('mapready', this, this.gmap);
    80|     },
    81|     addMarker: function(marker) {
    82|         var o;
    83|         marker = Ext.apply({
    84|             map: this.gmap
    85|         }, marker);
    86|         if (!marker.position) {
    87|             marker.position = new google.maps.LatLng(marker.lat, marker.lng);
    88|         }
    89|         o = new google.maps.Marker(marker);
    90|         Ext.Object.each(marker.listeners, function(name, fn) {
    91|             google.maps.event.addListener(o, name, fn);
    92|         });
    93|         return o;
    94|     },
    95|     lookupCode: function(addr, marker) {
    96|         this.geocoder = new google.maps.Geocoder();
    97|         this.geocoder.geocode({
    98|             address: addr
    99|         }, Ext.Function.bind(this.onLookupComplete, this, [marker], true));
   100|     },
   101|     onLookupComplete: function(data, response, marker) {
   102|         if (response !== 'OK') {
   103|             Ext.MessageBox.alert('Error', 'An error occured: "' + response + '"');
   104|             return;
   105|         }
   106|         this.createMap(data[0].geometry.location, marker);
   107|     },
   108|     afterComponentLayout: function(w, h) {
   109|         this.callParent(arguments);
   110|         this.redraw();
   111|     },
   112|     redraw: function() {
   113|         var map = this.gmap;
   114|         if (map) {
   115|             google.maps.event.trigger(map, 'resize');
   116|         }
   117|     }
   118| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/IFrame.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-96 ---
     1| /**
     2|  * Barebones iframe implementation. 
     3|  */
     4| Ext.define('Ext.ux.IFrame', {
     5|     extend: 'Ext.Component',
     6|     alias: 'widget.uxiframe',
     7|     loadMask: 'Loading...',
     8|     src: 'about:blank',
     9|     renderTpl: [
    10|         '<iframe src="{src}" id="{id}-iframeEl" data-ref="iframeEl" name="{frameName}" width="100%" height="100%" frameborder="0"></iframe>'
    11|     ],
    12|     childEls: ['iframeEl'],
    13|     initComponent: function() {
    14|         this.callParent();
    15|         this.frameName = this.frameName || this.id + '-frame';
    16|     },
    17|     initEvents: function() {
    18|         var me = this;
    19|         me.callParent();
    20|         me.iframeEl.on('load', me.onLoad, me);
    21|     },
    22|     initRenderData: function() {
    23|         return Ext.apply(this.callParent(), {
    24|             src: this.src,
    25|             frameName: this.frameName
    26|         });
    27|     },
    28|     getBody: function() {
    29|         var doc = this.getDoc();
    30|         return doc.body || doc.documentElement;
    31|     },
    32|     getDoc: function() {
    33|         try {
    34|             return this.getWin().document;
    35|         }
    36|         catch (ex) {
    37|             return null;
    38|         }
    39|     },
    40|     getWin: function() {
    41|         var me = this,
    42|             name = me.frameName,
    43|             win = Ext.isIE ? me.iframeEl.dom.contentWindow : window.frames[name];
    44|         return win;
    45|     },
    46|     getFrame: function() {
    47|         var me = this;
    48|         return me.iframeEl.dom;
    49|     },
    50|     onLoad: function() {
    51|         var me = this,
    52|             doc = me.getDoc();
    53|         if (doc) {
    54|             this.el.unmask();
    55|             this.fireEvent('load', this);
    56|         }
    57|         else if (me.src) {
    58|             this.el.unmask();
    59|             this.fireEvent('error', this);
    60|         }
    61|     },
    62|     load: function(src) {
    63|         var me = this,
    64|             text = me.loadMask,
    65|             frame = me.getFrame();
    66|         if (me.fireEvent('beforeload', me, src) !== false) {
    67|             if (text && me.el) {
    68|                 me.el.mask(text);
    69|             }
    70|             frame.src = me.src = (src || me.src);
    71|         }
    72|     }
    73| });
    74| /*
    75|  * Note: Event relayers are not needed here because the combination of the gesture system and 
    76|  * normal focus/blur will handle it.
    77|  * Tested with the examples/classic/desktop app.
    78|  */
    79| /*
    80|  * TODO items:
    81|  *
    82|  * Iframe should clean up any Ext.dom.Element wrappers around its window, document
    83|  * documentElement and body when it is destroyed.  This helps prevent "Permission Denied"
    84|  * errors in IE when Ext.dom.GarbageCollector tries to access those objects on an orphaned
    85|  * iframe.  Permission Denied errors can occur in one of the following 2 scenarios:
    86|  *
    87|  *     a. When an iframe is removed from the document, and all references to it have been
    88|  *     removed, IE will "clear" the window object.  At this point the window object becomes
    89|  *     completely inaccessible - accessing any of its properties results in a "Permission
    90|  *     Denied" error. http://msdn.microsoft.com/en-us/library/ie/hh180174(v=vs.85).aspx
    91|  *
    92|  *     b. When an iframe is unloaded (either by navigating to a new url, or via document.open/
    93|  *     document.write, new html and body elements are created and the old the html and body
    94|  *     elements are orphaned.  Accessing the html and body elements or any of their properties
    95|  *     results in a "Permission Denied" error.
    96|  */


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/LiveSearchGridPanel.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-253 ---
     1| /**
     2|  * A GridPanel class with live search support.
     3|  */
     4| Ext.define('Ext.ux.LiveSearchGridPanel', {
     5|     extend: 'Ext.grid.Panel',
     6|     requires: [
     7|         'Ext.toolbar.TextItem',
     8|         'Ext.form.field.Checkbox',
     9|         'Ext.form.field.Text',
    10|         'Ext.ux.statusbar.StatusBar'
    11|     ],
    12|     /**
    13|      * @private
    14|      * search value initialization
    15|      */
    16|     searchValue: null,
    17|     /**
    18|      * @private
    19|      * The matched positions from the most recent search
    20|      */
    21|     matches: [],
    22|     /**
    23|      * @private
    24|      * The current index matched.
    25|      */
    26|     currentIndex: null,
    27|     /**
    28|      * @private
    29|      * The generated regular expression used for searching.
    30|      */
    31|     searchRegExp: null,
    32|     /**
    33|      * @private
    34|      * Case sensitive mode.
    35|      */
    36|     caseSensitive: false,
    37|     /**
    38|      * @private
    39|      * Regular expression mode.
    40|      */
    41|     regExpMode: false,
    42|     /**
    43|      * @cfg {String} matchCls
    44|      * The matched string css classe.
    45|      */
    46|     matchCls: 'x-livesearch-match',
    47|     defaultStatusText: 'Nothing Found',
    48|     initComponent: function() {
    49|         var me = this;
    50|         me.tbar = ['Search', {
    51|             xtype: 'textfield',
    52|             name: 'searchField',
    53|             hideLabel: true,
    54|             width: 200,
    55|             listeners: {
    56|                 change: {
    57|                     fn: me.onTextFieldChange,
    58|                     scope: this,
    59|                     buffer: 500
    60|                 }
    61|             }
    62|         }, {
    63|             xtype: 'button',
    64|             text: '&lt;',
    65|             tooltip: 'Find Previous Row',
    66|             handler: me.onPreviousClick,
    67|             scope: me
    68|         }, {
    69|             xtype: 'button',
    70|             text: '&gt;',
    71|             tooltip: 'Find Next Row',
    72|             handler: me.onNextClick,
    73|             scope: me
    74|         }, '-', {
    75|             xtype: 'checkbox',
    76|             hideLabel: true,
    77|             margin: '0 0 0 4px',
    78|             handler: me.regExpToggle,
    79|             scope: me
    80|         }, 'Regular expression', {
    81|             xtype: 'checkbox',
    82|             hideLabel: true,
    83|             margin: '0 0 0 4px',
    84|             handler: me.caseSensitiveToggle,
    85|             scope: me
    86|         }, 'Case sensitive'];
    87|         me.bbar = new Ext.ux.StatusBar({
    88|             defaultText: me.defaultStatusText,
    89|             name: 'searchStatusBar'
    90|         });
    91|         me.callParent(arguments);
    92|     },
    93|     afterRender: function() {
    94|         var me = this;
    95|         me.callParent(arguments);
    96|         me.textField = me.down('textfield[name=searchField]');
    97|         me.statusBar = me.down('statusbar[name=searchStatusBar]');
    98|         me.view.on('cellkeydown', me.focusTextField, me);
    99|     },
   100|     focusTextField: function(view, td, cellIndex, record, tr, rowIndex, e, eOpts) {
   101|         if (e.getKey() === e.S) {
   102|             e.preventDefault();
   103|             this.textField.focus();
   104|         }
   105|     },
   106|     tagsRe: /<[^>]*>/gm,
   107|     tagsProtect: '\x0f',
   108|     /**
   109|      * In normal mode it returns the value with protected regexp characters.
   110|      * In regular expression mode it returns the raw value except if the regexp is invalid.
   111|      * @return {String} The value to process or null if the textfield value is blank or invalid.
   112|      * @private
   113|      */
   114|     getSearchValue: function() {
   115|         var me = this,
   116|             value = me.textField.getValue();
   117|         if (value === '') {
   118|             return null;
   119|         }
   120|         if (!me.regExpMode) {
   121|             value = Ext.String.escapeRegex(value);
   122|         }
   123|         else {
   124|             try {
   125|                 new RegExp(value);
   126|             }
   127|             catch (error) {
   128|                 me.statusBar.setStatus({
   129|                     text: error.message,
   130|                     iconCls: 'x-status-error'
   131|                 });
   132|                 return null;
   133|             }
   134|             if (value === '^' || value === '$') {
   135|                 return null;
   136|             }
   137|         }
   138|         return value;
   139|     },
   140|     /**
   141|      * Finds all strings that matches the searched value in each grid cells.
   142|      * @private
   143|      */
   144|     onTextFieldChange: function() {
   145|         var me = this,
   146|             count = 0,
   147|             view = me.view,
   148|             columns = me.visibleColumnManager.getColumns();
   149|         view.refresh();
   150|         me.statusBar.setStatus({
   151|             text: me.defaultStatusText,
   152|             iconCls: ''
   153|         });
   154|         me.searchValue = me.getSearchValue();
   155|         me.matches = [];
   156|         me.currentIndex = null;
   157|         if (me.searchValue !== null) {
   158|             me.searchRegExp = new RegExp(me.getSearchValue(), 'g' + (me.caseSensitive ? '' : 'i'));
   159|             me.store.each(function(record, idx) {
   160|                 var node = view.getNode(record);
   161|                 if (node) {
   162|                     Ext.Array.forEach(columns, function(column) {
   163|                         var cell = Ext.fly(node).down(column.getCellInnerSelector(), true),
   164|                             matches, cellHTML,
   165|                             seen;
   166|                         if (cell) {
   167|                             matches = cell.innerHTML.match(me.tagsRe);
   168|                             cellHTML = cell.innerHTML.replace(me.tagsRe, me.tagsProtect);
   169|                             cellHTML = cellHTML.replace(me.searchRegExp, function(m) {
   170|                                 ++count;
   171|                                 if (!seen) {
   172|                                     me.matches.push({
   173|                                         record: record,
   174|                                         column: column
   175|                                     });
   176|                                     seen = true;
   177|                                 }
   178|                                 return '<span class="' + me.matchCls + '">' + m + '</span>';
   179|                             }, me);
   180|                             Ext.each(matches, function(match) {
   181|                                 cellHTML = cellHTML.replace(me.tagsProtect, match);
   182|                             });
   183|                             cell.innerHTML = cellHTML;
   184|                         }
   185|                     });
   186|                 }
   187|             }, me);
   188|             if (count) {
   189|                 me.currentIndex = 0;
   190|                 me.gotoCurrent();
   191|                 me.statusBar.setStatus({
   192|                     text: Ext.String.format('{0} match{1} found.', count, count === 1 ? 'es' : ''),
   193|                     iconCls: 'x-status-valid'
   194|                 });
   195|             }
   196|         }
   197|         if (me.currentIndex === null) {
   198|             me.getSelectionModel().deselectAll();
   199|             me.textField.focus();
   200|         }
   201|     },
   202|     /**
   203|      * Selects the previous row containing a match.
   204|      * @private
   205|      */   
   206|     onPreviousClick: function() {
   207|         var me = this,
   208|             matches = me.matches,
   209|             len = matches.length,
   210|             idx = me.currentIndex;
   211|         if (len) {
   212|             me.currentIndex = idx === 0 ? len - 1 : idx - 1;
   213|             me.gotoCurrent();
   214|         }
   215|     },
   216|     /**
   217|      * Selects the next row containing a match.
   218|      * @private
   219|      */    
   220|     onNextClick: function() {
   221|         var me = this,
   222|             matches = me.matches,
   223|             len = matches.length,
   224|             idx = me.currentIndex;
   225|         if (len) {
   226|             me.currentIndex = idx === len - 1 ? 0 : idx + 1;
   227|             me.gotoCurrent();
   228|         }
   229|     },
   230|     /**
   231|      * Switch to case sensitive mode.
   232|      * @private
   233|      */    
   234|     caseSensitiveToggle: function(checkbox, checked) {
   235|         this.caseSensitive = checked;
   236|         this.onTextFieldChange();
   237|     },
   238|     /**
   239|      * Switch to regular expression mode
   240|      * @private
   241|      */
   242|     regExpToggle: function(checkbox, checked) {
   243|         this.regExpMode = checked;
   244|         this.onTextFieldChange();
   245|     },
   246|     privates: {
   247|         gotoCurrent: function() {
   248|             var pos = this.matches[this.currentIndex];
   249|             this.getNavigationModel().setPosition(pos.record, pos.column);
   250|             this.getSelectionModel().select(pos.record);
   251|         }
   252|     }
   253| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/PreviewPlugin.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-87 ---
     1| /**
     2|  * The Preview Plugin enables toggle of a configurable preview of all visible records.
     3|  *
     4|  * Note: This plugin does NOT assert itself against an existing RowBody feature and may conflict
     5|  * with another instance of the same plugin.
     6|  */
     7| Ext.define('Ext.ux.PreviewPlugin', {
     8|     extend: 'Ext.plugin.Abstract',
     9|     alias: 'plugin.preview',
    10|     requires: ['Ext.grid.feature.RowBody'],
    11|     /**
    12|      * @private
    13|      * css class to use to hide the body
    14|      */
    15|     hideBodyCls: 'x-grid-row-body-hidden',
    16|     /**
    17|      * @cfg {String} bodyField
    18|      * Field to display in the preview. Must be a field within the Model definition
    19|      * that the store is using.
    20|      */
    21|     bodyField: '',
    22|     /**
    23|      * @cfg {Boolean} previewExpanded
    24|      */
    25|     previewExpanded: true,
    26|     /**
    27|      * Plugin may be safely declared on either a panel.Grid or a Grid View/viewConfig
    28|      * @param {Ext.grid.Panel/Ext.view.View} target
    29|      */
    30|     setCmp: function(target) {
    31|         this.callParent(arguments);
    32|         var me = this,
    33|             grid = me.cmp = target.isXType('gridview') ? target.grid : target,
    34|             bodyField = me.bodyField,
    35|             hideBodyCls = me.hideBodyCls,
    36|             feature = Ext.create('Ext.grid.feature.RowBody', {
    37|                 grid: grid,
    38|                 getAdditionalData: function(data, idx, model, rowValues) {
    39|                     var getAdditionalData = Ext.grid.feature.RowBody.prototype.getAdditionalData,
    40|                         additionalData = {
    41|                             rowBody: data[bodyField],
    42|                             rowBodyCls: grid.getView().previewExpanded ? '' : hideBodyCls
    43|                         };
    44|                     if (Ext.isFunction(getAdditionalData)) {
    45|                         Ext.apply(additionalData, getAdditionalData.apply(this, arguments));
    46|                     }
    47|                     return additionalData;
    48|                 }
    49|             }),
    50|             initFeature = function(grid, view) {
    51|                 view.previewExpanded = me.previewExpanded;
    52|                 view.featuresMC.add(feature);
    53|                 feature.init(grid);
    54|             };
    55|         if (grid.view) {
    56|             initFeature(grid, grid.view);
    57|         }
    58|         else {
    59|             grid.on({
    60|                 viewcreated: initFeature,
    61|                 single: true
    62|             });
    63|         }
    64|     },
    65|     /**
    66|      * Toggle between the preview being expanded/hidden on all rows
    67|      * @param {Boolean} expanded Pass true to expand the record and false to not show the preview.
    68|      */
    69|     toggleExpanded: function(expanded) {
    70|         var grid = this.getCmp(),
    71|             view = grid && grid.getView(),
    72|             bufferedRenderer = view.bufferedRenderer,
    73|             scrollManager = view.scrollManager;
    74|         if (grid && view && expanded !== view.previewExpanded) {
    75|             this.previewExpanded = view.previewExpanded = !!expanded;
    76|             view.refreshView();
    77|             if (scrollManager) {
    78|                 if (bufferedRenderer) {
    79|                     bufferedRenderer.stretchView(view, bufferedRenderer.getScrollHeight(true));
    80|                 }
    81|                 else {
    82|                     scrollManager.refresh(true);
    83|                 }
    84|             }
    85|         }
    86|     }
    87| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/ProgressBarPager.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-107 ---
     1| /**
     2|  * Plugin for displaying a progressbar inside of a paging toolbar
     3|  * instead of plain text.
     4|  */
     5| Ext.define('Ext.ux.ProgressBarPager', {
     6|     alias: 'plugin.ux-progressbarpager',
     7|     requires: [
     8|         'Ext.ProgressBar'
     9|     ],
    10|     /**
    11|      * @cfg {Number} width
    12|      * <p>The default progress bar width.  Default is 225.</p>
    13|     */
    14|     width: 225,
    15|     /**
    16|      * @cfg {String} defaultText
    17|     * <p>The text to display while the store is loading.  Default is 'Loading...'</p>
    18|      */
    19|     defaultText: 'Loading...',
    20|     /**
    21|      * @cfg {Object} defaultAnimCfg
    22|      * <p>A {@link Ext.fx.Anim Ext.fx.Anim} configuration object.</p>
    23|      */
    24|     defaultAnimCfg: {
    25|         duration: 1000,
    26|         easing: 'bounceOut'
    27|     },
    28|     /**
    29|      * Creates new ProgressBarPager.
    30|      * @param {Object} config Configuration options
    31|      */
    32|     constructor: function(config) {
    33|         if (config) {
    34|             Ext.apply(this, config);
    35|         }
    36|     },
    37|     init: function(parent) {
    38|         var displayItem;
    39|         if (parent.displayInfo) {
    40|             this.parent = parent;
    41|             displayItem = parent.child("#displayItem");
    42|             if (displayItem) {
    43|                 parent.remove(displayItem, true);
    44|             }
    45|             this.progressBar = Ext.create('Ext.ProgressBar', {
    46|                 text: this.defaultText,
    47|                 width: this.width,
    48|                 animate: this.defaultAnimCfg,
    49|                 style: {
    50|                     cursor: 'pointer'
    51|                 },
    52|                 listeners: {
    53|                     el: {
    54|                         scope: this,
    55|                         click: this.handleProgressBarClick
    56|                     }
    57|                 }
    58|             });
    59|             parent.displayItem = this.progressBar;
    60|             parent.add(parent.displayItem);
    61|             Ext.apply(parent, this.parentOverrides);
    62|         }
    63|     },
    64|     /**
    65|      * This method handles the click for the progress bar
    66|      * @private
    67|      */
    68|     handleProgressBarClick: function(e) {
    69|         var parent = this.parent,
    70|             displayItem = parent.displayItem,
    71|             box = this.progressBar.getBox(),
    72|             xy = e.getXY(),
    73|             position = xy[0] - box.x,
    74|             store = parent.store,
    75|             pageSize = parent.pageSize || store.pageSize,
    76|             pages = Math.ceil(store.getTotalCount() / pageSize),
    77|             newPage = Math.max(Math.ceil(position / (displayItem.width / pages)), 1);
    78|         store.loadPage(newPage);
    79|     },
    80|     /**
    81|      * @private
    82|      */
    83|     parentOverrides: {
    84|         /**
    85|          * This method updates the information via the progress bar.
    86|          * @private
    87|          */
    88|         updateInfo: function() {
    89|             if (this.displayItem) {
    90|                 var count = this.store.getCount(),
    91|                     pageData = this.getPageData(),
    92|                     message = count === 0
    93|                         ? this.emptyMsg
    94|                         : Ext.String.format(
    95|                             this.displayMsg,
    96|                             pageData.fromRecord, pageData.toRecord, this.store.getTotalCount()
    97|                         ),
    98|                     percentage = pageData.pageCount > 0
    99|                         ? (pageData.currentPage / pageData.pageCount)
   100|                         : 0;
   101|                 this.displayItem.updateProgress(
   102|                     percentage, message, this.animate || this.defaultAnimConfig
   103|                 );
   104|             }
   105|         }
   106|     }
   107| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/RowExpander.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| /**
     2|  * @deprecated 4.0.0 Ext.ux.RowExpander has been promoted to the core framework. Use
     3|  * {@link Ext.grid.plugin.RowExpander} instead.
     4|  *
     5|  * Ext.ux.RowExpander is now just an empty stub that extends Ext.grid.plugin.RowExpander
     6|  * for backward compatibility reasons.
     7|  */
     8| Ext.define('Ext.ux.RowExpander', {
     9|     extend: 'Ext.grid.plugin.RowExpander'
    10| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/SlidingPager.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| /**
     2|  * Plugin for PagingToolbar which replaces the textfield input with a slider
     3|  */
     4| Ext.define('Ext.ux.SlidingPager', {
     5|     alias: 'plugin.ux-slidingpager',
     6|     requires: [
     7|         'Ext.slider.Single',
     8|         'Ext.slider.Tip'
     9|     ],
    10|     /**
    11|      * Creates new SlidingPager.
    12|      * @param {Object} config Configuration options
    13|      */
    14|     constructor: function(config) {
    15|         if (config) {
    16|             Ext.apply(this, config);
    17|         }
    18|     },
    19|     init: function(pbar) {
    20|         var idx = pbar.items.indexOf(pbar.child("#inputItem")),
    21|             slider;
    22|         Ext.each(pbar.items.getRange(idx - 2, idx + 2), function(c) {
    23|             c.hide();
    24|         });
    25|         slider = Ext.create('Ext.slider.Single', {
    26|             width: 114,
    27|             minValue: 1,
    28|             maxValue: 1,
    29|             hideLabel: true,
    30|             tipText: function(thumb) {
    31|                 return Ext.String.format(
    32|                     'Page <b>{0}</b> of <b>{1}</b>', thumb.value, thumb.slider.maxValue
    33|                 );
    34|             },
    35|             listeners: {
    36|                 changecomplete: function(s, v) {
    37|                     pbar.store.loadPage(v);
    38|                 }
    39|             }
    40|         });
    41|         pbar.insert(idx + 1, slider);
    42|         pbar.on({
    43|             change: function(pb, data) {
    44|                 slider.setMaxValue(data.pageCount);
    45|                 slider.setValue(data.currentPage);
    46|             }
    47|         });
    48|     }
    49| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/Spotlight.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-182 ---
     1| /**
     2|  * UX used to provide a spotlight around a specified component/element.
     3|  */
     4| Ext.define('Ext.ux.Spotlight', {
     5|     /**
     6|      * @private
     7|      * The baseCls for the spotlight elements
     8|      */
     9|     baseCls: 'x-spotlight',
    10|     /**
    11|      * @cfg animate {Boolean} True to animate the spotlight change
    12|      * (defaults to true)
    13|      */
    14|     animate: true,
    15|     /**
    16|      * @cfg duration {Integer} The duration of the animation, in milliseconds
    17|      * (defaults to 250)
    18|      */
    19|     duration: 250,
    20|     /**
    21|      * @cfg easing {String} The type of easing for the spotlight animatation
    22|      * (defaults to null)
    23|      */
    24|     easing: null,
    25|     /**
    26|      * @private
    27|      * True if the spotlight is active on the element
    28|      */
    29|     active: false,
    30|     constructor: function(config) {
    31|         Ext.apply(this, config);
    32|     },
    33|     /**
    34|      * Create all the elements for the spotlight
    35|      */
    36|     createElements: function() {
    37|         var me = this,
    38|             baseCls = me.baseCls,
    39|             body = Ext.getBody();
    40|         me.right = body.createChild({
    41|             cls: baseCls
    42|         });
    43|         me.left = body.createChild({
    44|             cls: baseCls
    45|         });
    46|         me.top = body.createChild({
    47|             cls: baseCls
    48|         });
    49|         me.bottom = body.createChild({
    50|             cls: baseCls
    51|         });
    52|         me.all = Ext.create('Ext.CompositeElement', [me.right, me.left, me.top, me.bottom]);
    53|     },
    54|     /**
    55|      * Show the spotlight
    56|      */
    57|     show: function(el, callback, scope) {
    58|         var me = this;
    59|         me.el = Ext.get(el);
    60|         if (!me.right) {
    61|             me.createElements();
    62|         }
    63|         if (!me.active) {
    64|             me.all.setDisplayed('');
    65|             me.active = true;
    66|             Ext.on('resize', me.syncSize, me);
    67|             me.applyBounds(me.animate, false);
    68|         }
    69|         else {
    70|             me.applyBounds(false, false);
    71|         }
    72|     },
    73|     /**
    74|      * Hide the spotlight
    75|      */
    76|     hide: function(callback, scope) {
    77|         var me = this;
    78|         Ext.un('resize', me.syncSize, me);
    79|         me.applyBounds(me.animate, true);
    80|     },
    81|     /**
    82|      * Resizes the spotlight with the window size.
    83|      */
    84|     syncSize: function() {
    85|         this.applyBounds(false, false);
    86|     },
    87|     /**
    88|      * Resizes the spotlight depending on the arguments
    89|      * @param {Boolean} animate True to animate the changing of the bounds
    90|      * @param {Boolean} reverse True to reverse the animation
    91|      */
    92|     applyBounds: function(animate, reverse) {
    93|         var me = this,
    94|             box = me.el.getBox(),
    95|             viewWidth = Ext.Element.getViewportWidth(),
    96|             viewHeight = Ext.Element.getViewportHeight(),
    97|             from, to, clone;
    98|         from = {
    99|             right: {
   100|                 x: box.right,
   101|                 y: viewHeight,
   102|                 width: (viewWidth - box.right),
   103|                 height: 0
   104|             },
   105|             left: {
   106|                 x: 0,
   107|                 y: 0,
   108|                 width: box.x,
   109|                 height: 0
   110|             },
   111|             top: {
   112|                 x: viewWidth,
   113|                 y: 0,
   114|                 width: 0,
   115|                 height: box.y
   116|             },
   117|             bottom: {
   118|                 x: 0,
   119|                 y: (box.y + box.height),
   120|                 width: 0,
   121|                 height: (viewHeight - (box.y + box.height)) + 'px'
   122|             }
   123|         };
   124|         to = {
   125|             right: {
   126|                 x: box.right,
   127|                 y: box.y,
   128|                 width: (viewWidth - box.right) + 'px',
   129|                 height: (viewHeight - box.y) + 'px'
   130|             },
   131|             left: {
   132|                 x: 0,
   133|                 y: 0,
   134|                 width: box.x + 'px',
   135|                 height: (box.y + box.height) + 'px'
   136|             },
   137|             top: {
   138|                 x: box.x,
   139|                 y: 0,
   140|                 width: (viewWidth - box.x) + 'px',
   141|                 height: box.y + 'px'
   142|             },
   143|             bottom: {
   144|                 x: 0,
   145|                 y: (box.y + box.height),
   146|                 width: (box.x + box.width) + 'px',
   147|                 height: (viewHeight - (box.y + box.height)) + 'px'
   148|             }
   149|         };
   150|         if (reverse) {
   151|             clone = Ext.clone(from);
   152|             from = to;
   153|             to = clone;
   154|         }
   155|         if (animate) {
   156|             Ext.Array.forEach(['right', 'left', 'top', 'bottom'], function(side) {
   157|                 me[side].setBox(from[side]);
   158|                 me[side].animate({
   159|                     duration: me.duration,
   160|                     easing: me.easing,
   161|                     to: to[side]
   162|                 });
   163|             }, this);
   164|         }
   165|         else {
   166|             Ext.Array.forEach(['right', 'left', 'top', 'bottom'], function(side) {
   167|                 me[side].setBox(Ext.apply(from[side], to[side]));
   168|                 me[side].repaint();
   169|             }, this);
   170|         }
   171|     },
   172|     /**
   173|      * Removes all the elements for the spotlight
   174|      */
   175|     destroy: function() {
   176|         var me = this;
   177|         Ext.destroy(me.right, me.left, me.top, me.bottom);
   178|         delete me.el;
   179|         delete me.all;
   180|         me.callParent();
   181|     }
   182| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/TabCloseMenu.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-178 ---
     1| /**
     2|  * Plugin for adding a close context menu to tabs. Note that the menu respects
     3|  * the closable configuration on the tab. As such, commands like remove others
     4|  * and remove all will not remove items that are not closable.
     5|  */
     6| Ext.define('Ext.ux.TabCloseMenu', {
     7|     extend: 'Ext.plugin.Abstract',
     8|     alias: 'plugin.tabclosemenu',
     9|     mixins: {
    10|         observable: 'Ext.util.Observable'
    11|     },
    12|     /**
    13|      * @cfg {String} closeTabText
    14|      * The text for closing the current tab.
    15|      */
    16|     closeTabText: 'Close Tab',
    17|     /**
    18|      * @cfg {Boolean} showCloseOthers
    19|      * Indicates whether to show the 'Close Others' option.
    20|      */
    21|     showCloseOthers: true,
    22|     /**
    23|      * @cfg {String} closeOtherTabsText
    24|      * The text for closing all tabs except the current one.
    25|      */
    26|     closeOtherTabsText: 'Close Other Tabs',
    27|     /**
    28|      * @cfg {Boolean} showCloseAll
    29|      * Indicates whether to show the 'Close All' option.
    30|      */
    31|     showCloseAll: true,
    32|     /**
    33|      * @cfg {String} closeAllTabsText
    34|      * The text for closing all tabs.
    35|      */
    36|     closeAllTabsText: 'Close All Tabs',
    37|     /**
    38|      * @cfg {Array} extraItemsHead
    39|      * An array of additional context menu items to add to the front of the context menu.
    40|      */
    41|     extraItemsHead: null,
    42|     /**
    43|      * @cfg {Array} extraItemsTail
    44|      * An array of additional context menu items to add to the end of the context menu.
    45|      */
    46|     extraItemsTail: null,
    47|     constructor: function(config) {
    48|         this.callParent([config]);
    49|         this.mixins.observable.constructor.call(this, config);
    50|     },
    51|     init: function(tabpanel) {
    52|         this.tabPanel = tabpanel;
    53|         this.tabBar = tabpanel.down("tabbar");
    54|         this.mon(this.tabPanel, {
    55|             scope: this,
    56|             afterlayout: this.onAfterLayout,
    57|             single: true
    58|         });
    59|     },
    60|     onAfterLayout: function() {
    61|         this.mon(this.tabBar.el, {
    62|             scope: this,
    63|             contextmenu: this.onContextMenu,
    64|             delegate: '.x-tab'
    65|         });
    66|     },
    67|     destroy: function() {
    68|         Ext.destroy(this.menu);
    69|         this.callParent();
    70|     },
    71|     /**
    72|      * @private
    73|      */
    74|     onContextMenu: function(event, target) {
    75|         var me = this,
    76|             menu = me.createMenu(),
    77|             disableAll = true,
    78|             disableOthers = true,
    79|             tab = me.tabBar.getChildByElement(target),
    80|             index = me.tabBar.items.indexOf(tab);
    81|         me.item = me.tabPanel.getComponent(index);
    82|         menu.child('#close').setDisabled(!me.item.closable);
    83|         if (me.showCloseAll || me.showCloseOthers) {
    84|             me.tabPanel.items.each(function(item) {
    85|                 if (item.closable) {
    86|                     disableAll = false;
    87|                     if (item !== me.item) {
    88|                         disableOthers = false;
    89|                         return false;
    90|                     }
    91|                 }
    92|                 return true;
    93|             });
    94|             if (me.showCloseAll) {
    95|                 menu.child('#closeAll').setDisabled(disableAll);
    96|             }
    97|             if (me.showCloseOthers) {
    98|                 menu.child('#closeOthers').setDisabled(disableOthers);
    99|             }
   100|         }
   101|         event.preventDefault();
   102|         me.fireEvent('beforemenu', menu, me.item, me);
   103|         menu.showAt(event.getXY());
   104|     },
   105|     createMenu: function() {
   106|         var me = this,
   107|             items;
   108|         if (!me.menu) {
   109|             items = [{
   110|                 itemId: 'close',
   111|                 text: me.closeTabText,
   112|                 scope: me,
   113|                 handler: me.onClose
   114|             }];
   115|             if (me.showCloseAll || me.showCloseOthers) {
   116|                 items.push('-');
   117|             }
   118|             if (me.showCloseOthers) {
   119|                 items.push({
   120|                     itemId: 'closeOthers',
   121|                     text: me.closeOtherTabsText,
   122|                     scope: me,
   123|                     handler: me.onCloseOthers
   124|                 });
   125|             }
   126|             if (me.showCloseAll) {
   127|                 items.push({
   128|                     itemId: 'closeAll',
   129|                     text: me.closeAllTabsText,
   130|                     scope: me,
   131|                     handler: me.onCloseAll
   132|                 });
   133|             }
   134|             if (me.extraItemsHead) {
   135|                 items = me.extraItemsHead.concat(items);
   136|             }
   137|             if (me.extraItemsTail) {
   138|                 items = items.concat(me.extraItemsTail);
   139|             }
   140|             me.menu = Ext.create('Ext.menu.Menu', {
   141|                 items: items,
   142|                 listeners: {
   143|                     hide: me.onHideMenu,
   144|                     scope: me
   145|                 }
   146|             });
   147|         }
   148|         return me.menu;
   149|     },
   150|     onHideMenu: function() {
   151|         var me = this;
   152|         me.fireEvent('aftermenu', me.menu, me);
   153|     },
   154|     onClose: function() {
   155|         this.tabPanel.remove(this.item);
   156|     },
   157|     onCloseOthers: function() {
   158|         this.doClose(true);
   159|     },
   160|     onCloseAll: function() {
   161|         this.doClose(false);
   162|     },
   163|     doClose: function(excludeActive) {
   164|         var items = [];
   165|         this.tabPanel.items.each(function(item) {
   166|             if (item.closable) {
   167|                 if (!excludeActive || item !== this.item) {
   168|                     items.push(item);
   169|                 }
   170|             }
   171|         }, this);
   172|         Ext.suspendLayouts();
   173|         Ext.Array.forEach(items, function(item) {
   174|             this.tabPanel.remove(item);
   175|         }, this);
   176|         Ext.resumeLayouts(true);
   177|     }
   178| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/TabMiddleButtonClose.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| /**
     2|  * Plugin for adding a close context menu to tabs. Note that the menu respects
     3|  * the closable configuration on the tab. As such, commands like remove others
     4|  * and remove all will not remove items that are not closable.
     5|  */
     6| Ext.define('Ext.ux.TabMiddleButtonClose', {
     7|     extend: 'Ext.plugin.Abstract',
     8|     alias: 'plugin.tabmiddlebuttonclose',
     9|     mixins: {
    10|         observable: 'Ext.util.Observable'
    11|     },
    12|     constructor: function (config) {
    13|         this.callParent([config]);
    14|         this.mixins.observable.constructor.call(this, config);
    15|     },
    16|     init : function(tabpanel){
    17|         this.tabPanel = tabpanel;
    18|         this.tabBar = tabpanel.down("tabbar");
    19|         this.mon(this.tabPanel, {
    20|             scope: this,
    21|             afterlayout: this.onAfterLayout,
    22|             single: true
    23|         });
    24|     },
    25|     onAfterLayout: function() {
    26|         this.mon(this.tabBar.el, {
    27|             scope: this,
    28|             mousedown: this.onMiddleClick,
    29|             delegate: '.x-tab'
    30|         });
    31|     },
    32|     /**
    33|      * @private
    34|      */
    35|     onMiddleClick : function(event, target){
    36|         event.preventDefault();
    37|         if( target &&  event.browserEvent.button==1  ){
    38|             var item = this.tabBar.getComponent(target.id);
    39|             item.onCloseClick();
    40|         }
    41|     }
    42| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/TabReorderer.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| /**
     2|  * This plugin allow you to reorder tabs of a TabPanel.
     3|  */
     4| Ext.define('Ext.ux.TabReorderer', {
     5|     extend: 'Ext.ux.BoxReorderer',
     6|     alias: 'plugin.tabreorderer',
     7|     itemSelector: '.' + Ext.baseCSSPrefix + 'tab',
     8|     init: function(tabPanel) {
     9|         var me = this;
    10|         me.callParent([tabPanel.getTabBar()]);
    11|         tabPanel.onAdd = Ext.Function.createSequence(tabPanel.onAdd, me.onAdd);
    12|     },
    13|     onBoxReady: function() {
    14|         var tabs, tab, len,
    15|             i = 0;
    16|         this.callParent(arguments);
    17|         for (tabs = this.container.items.items, len = tabs.length; i < len; i++) {
    18|             tab = tabs[i];
    19|             if (tab.card) {
    20|                 tab.reorderable = tab.card.reorderable;
    21|             }
    22|         }
    23|     },
    24|     onAdd: function(card, index) {
    25|         card.tab.reorderable = card.reorderable;
    26|     },
    27|     afterBoxReflow: function() {
    28|         var me = this;
    29|         Ext.ux.BoxReorderer.prototype.afterBoxReflow.apply(me, arguments);
    30|         if (me.dragCmp) {
    31|             me.container.tabPanel.setActiveTab(me.dragCmp.card);
    32|             me.container.tabPanel.move(me.dragCmp.card, me.curIndex);
    33|         }
    34|     }
    35| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/TabScrollerMenu.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-216 ---
     1| Ext.ns('Ext.ux');
     2| /**
     3|  * Plugin for adding a tab menu to a TabBar is the Tabs overflow.
     4|  */
     5| Ext.define('Ext.ux.TabScrollerMenu', {
     6|     alias: 'plugin.tabscrollermenu',
     7|     requires: ['Ext.menu.Menu'],
     8|     /**
     9|      * @cfg {Number} pageSize How many items to allow per submenu.
    10|      */
    11|     pageSize: 10,
    12|     /**
    13|      * @cfg {Number} maxText How long should the title of each {@link Ext.menu.Item} be.
    14|      */
    15|     maxText: 15,
    16|     /**
    17|      * @cfg {String} menuPrefixText Text to prefix the submenus.
    18|      */
    19|     menuPrefixText: 'Items',
    20|     /**
    21|      * Creates new TabScrollerMenu.
    22|      * @param {Object} config Configuration options
    23|      */
    24|     constructor: function(config) {
    25|         Ext.apply(this, config);
    26|     },
    27|     /**
    28|      * @private
    29|      */
    30|     init: function(tabPanel) {
    31|         var me = this;
    32|         me.tabPanel = tabPanel;
    33|         tabPanel.on({
    34|             render: function() {
    35|                 me.tabBar = tabPanel.tabBar;
    36|                 me.layout = me.tabBar.layout;
    37|                 me.layout.overflowHandler.handleOverflow = me.showButton.bind(me);
    38|                 me.layout.overflowHandler.clearOverflow = Ext.Function.createSequence(
    39|                     me.layout.overflowHandler.clearOverflow, me.hideButton, me
    40|                 );
    41|             },
    42|             destroy: me.destroy,
    43|             scope: me,
    44|             single: true
    45|         });
    46|     },
    47|     showButton: function() {
    48|         var me = this,
    49|             result, button;
    50|         result = Ext.getClass(me.layout.overflowHandler).prototype.handleOverflow.apply(
    51|             me.layout.overflowHandler, arguments
    52|         );
    53|         button = me.menuButton;
    54|         if (me.tabPanel.items.getCount() > 1) {
    55|             if (!button) {
    56|                 button = me.menuButton = me.tabBar.body.createChild({
    57|                     cls: Ext.baseCSSPrefix + 'tab-tabmenu-right'
    58|                 }, me.tabBar.body.child('.' + Ext.baseCSSPrefix + 'box-scroller-right'));
    59|                 button.addClsOnOver(Ext.baseCSSPrefix + 'tab-tabmenu-over');
    60|                 button.on('click', me.showTabsMenu, me);
    61|             }
    62|             button.setVisibilityMode(Ext.dom.Element.DISPLAY);
    63|             button.show();
    64|             result.reservedSpace += button.getWidth();
    65|         }
    66|         else {
    67|             me.hideButton();
    68|         }
    69|         return result;
    70|     },
    71|     hideButton: function() {
    72|         var me = this;
    73|         if (me.menuButton) {
    74|             me.menuButton.hide();
    75|         }
    76|     },
    77|     /**
    78|      * Returns an the current page size (this.pageSize);
    79|      * @return {Number} this.pageSize The current page size.
    80|      */
    81|     getPageSize: function() {
    82|         return this.pageSize;
    83|     },
    84|     /**
    85|      * Sets the number of menu items per submenu "page size".
    86|      * @param {Number} pageSize The page size
    87|      */
    88|     setPageSize: function(pageSize) {
    89|         this.pageSize = pageSize;
    90|     },
    91|     /**
    92|      * Returns the current maxText length;
    93|      * @return {Number} this.maxText The current max text length.
    94|      */
    95|     getMaxText: function() {
    96|         return this.maxText;
    97|     },
    98|     /**
    99|      * Sets the maximum text size for each menu item.
   100|      * @param {Number} t The max text per each menu item.
   101|      */
   102|     setMaxText: function(t) {
   103|         this.maxText = t;
   104|     },
   105|     /**
   106|      * Returns the current menu prefix text String.;
   107|      * @return {String} this.menuPrefixText The current menu prefix text.
   108|      */
   109|     getMenuPrefixText: function() {
   110|         return this.menuPrefixText;
   111|     },
   112|     /**
   113|      * Sets the menu prefix text String.
   114|      * @param {String} t The menu prefix text.
   115|      */
   116|     setMenuPrefixText: function(t) {
   117|         this.menuPrefixText = t;
   118|     },
   119|     showTabsMenu: function(e) {
   120|         var me = this,
   121|             target, xy;
   122|         if (me.tabsMenu) {
   123|             me.tabsMenu.removeAll();
   124|         }
   125|         else {
   126|             me.tabsMenu = new Ext.menu.Menu();
   127|         }
   128|         me.generateTabMenuItems();
   129|         target = Ext.get(e.getTarget());
   130|         xy = target.getXY();
   131|         xy[1] += 24;
   132|         me.tabsMenu.showAt(xy);
   133|     },
   134|     /**
   135|      * @private
   136|      */
   137|     generateTabMenuItems: function() {
   138|         var me = this,
   139|             tabPanel = me.tabPanel,
   140|             curActive = tabPanel.getActiveTab(),
   141|             allItems = tabPanel.items.getRange(),
   142|             pageSize = me.getPageSize(),
   143|             tabsMenu = me.tabsMenu,
   144|             totalItems, numSubMenus, remainder,
   145|             i, curPage, menuItems, x, item, start, index;
   146|         tabsMenu.suspendLayouts();
   147|         allItems = Ext.Array.filter(allItems, function(item) {
   148|             if (item.id === curActive.id) {
   149|                 return false;
   150|             }
   151|             return item.hidden ? !!item.hiddenByLayout : true;
   152|         });
   153|         totalItems = allItems.length;
   154|         numSubMenus = Math.floor(totalItems / pageSize);
   155|         remainder = totalItems % pageSize;
   156|         if (totalItems > pageSize) {
   157|             for (i = 0; i < numSubMenus; i++) {
   158|                 curPage = (i + 1) * pageSize;
   159|                 menuItems = [];
   160|                 for (x = 0; x < pageSize; x++) {
   161|                     index = x + curPage - pageSize;
   162|                     item = allItems[index];
   163|                     menuItems.push(me.autoGenMenuItem(item));
   164|                 }
   165|                 tabsMenu.add({
   166|                     text: me.getMenuPrefixText() + ' ' + (curPage - pageSize + 1) + ' - ' + curPage,
   167|                     menu: menuItems
   168|                 });
   169|             }
   170|             if (remainder > 0) {
   171|                 start = numSubMenus * pageSize;
   172|                 menuItems = [];
   173|                 for (i = start; i < totalItems; i++) {
   174|                     item = allItems[i];
   175|                     menuItems.push(me.autoGenMenuItem(item));
   176|                 }
   177|                 me.tabsMenu.add({
   178|                     text: me.menuPrefixText + ' ' + (start + 1) + ' - ' +
   179|                           (start + menuItems.length),
   180|                     menu: menuItems
   181|                 });
   182|             }
   183|         }
   184|         else {
   185|             for (i = 0; i < totalItems; ++i) {
   186|                 tabsMenu.add(me.autoGenMenuItem(allItems[i]));
   187|             }
   188|         }
   189|         tabsMenu.resumeLayouts(true);
   190|     },
   191|     /**
   192|      * @private
   193|      */
   194|     autoGenMenuItem: function(item) {
   195|         var maxText = this.getMaxText(),
   196|             text = Ext.util.Format.ellipsis(item.title, maxText);
   197|         return {
   198|             text: text,
   199|             handler: this.showTabFromMenu,
   200|             scope: this,
   201|             disabled: item.disabled,
   202|             tabToShow: item,
   203|             iconCls: item.iconCls
   204|         };
   205|     },
   206|     /**
   207|      * @private
   208|      */
   209|     showTabFromMenu: function(menuItem) {
   210|         this.tabPanel.setActiveTab(menuItem.tabToShow);
   211|     },
   212|     destroy: function() {
   213|         Ext.destroy(this.tabsMenu, this.menuButton);
   214|         this.callParent();
   215|     }
   216| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/ToolbarDroppable.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-138 ---
     1| /**
     2|  * Plugin which allows items to be dropped onto a toolbar and be turned into new Toolbar items.
     3|  * To use the plugin, you just need to provide a createItem implementation that takes the drop
     4|  * data as an argument and returns an object that can be placed onto the toolbar. Example:
     5|  * <pre>
     6|  * Ext.create('Ext.ux.ToolbarDroppable', {
     7|  *   createItem: function(data) {
     8|  *     return Ext.create('Ext.Button', {text: data.text});
     9|  *   }
    10|  * });
    11|  * </pre>
    12|  * The afterLayout function can also be overridden, and is called after a new item has been
    13|  * created and inserted into the Toolbar. Use this for any logic that needs to be run after
    14|  * the item has been created.
    15|  */
    16| Ext.define('Ext.ux.ToolbarDroppable', {
    17|     /**
    18|      * Creates new ToolbarDroppable.
    19|      * @param {Object} config Config options.
    20|      */
    21|     constructor: function(config) {
    22|         Ext.apply(this, config);
    23|     },
    24|     /**
    25|      * Initializes the plugin and saves a reference to the toolbar
    26|      * @param {Ext.toolbar.Toolbar} toolbar The toolbar instance
    27|      */
    28|     init: function(toolbar) {
    29|         /**
    30|        * @property toolbar
    31|        * @type Ext.toolbar.Toolbar
    32|        * The toolbar instance that this plugin is tied to
    33|        */
    34|         this.toolbar = toolbar;
    35|         this.toolbar.on({
    36|             scope: this,
    37|             render: this.createDropTarget
    38|         });
    39|     },
    40|     /**
    41|      * Creates a drop target on the toolbar
    42|      */
    43|     createDropTarget: function() {
    44|         /**
    45|          * @property dropTarget
    46|          * @type Ext.dd.DropTarget
    47|          * The drop target attached to the toolbar instance
    48|          */
    49|         this.dropTarget = Ext.create('Ext.dd.DropTarget', this.toolbar.getEl(), {
    50|             notifyOver: this.notifyOver.bind(this),
    51|             notifyDrop: this.notifyDrop.bind(this)
    52|         });
    53|     },
    54|     /**
    55|      * Adds the given DD Group to the drop target
    56|      * @param {String} ddGroup The DD Group
    57|      */
    58|     addDDGroup: function(ddGroup) {
    59|         this.dropTarget.addToGroup(ddGroup);
    60|     },
    61|     /**
    62|      * Calculates the location on the toolbar to create the new sorter button based on the XY of the
    63|      * drag event
    64|      * @param {Ext.event.Event} e The event object
    65|      * @return {Number} The index at which to insert the new button
    66|      */    
    67|     calculateEntryIndex: function(e) {
    68|         var entryIndex = 0,
    69|             toolbar = this.toolbar,
    70|             items = toolbar.items.items,
    71|             count = items.length,
    72|             xHover = e.getXY()[0],
    73|             index = 0,
    74|             el, xTotal, width, midpoint;
    75|         for (; index < count; index++) {
    76|             el = items[index].getEl();
    77|             xTotal = el.getXY()[0];
    78|             width = el.getWidth();
    79|             midpoint = xTotal + width / 2;
    80|             if (xHover < midpoint) {
    81|                 entryIndex = index;
    82|                 break;
    83|             }
    84|             else {
    85|                 entryIndex = index + 1;
    86|             }
    87|         }
    88|         return entryIndex;
    89|     },
    90|     /**
    91|      * Returns true if the drop is allowed on the drop target. This function can be overridden
    92|      * and defaults to simply return true
    93|      * @param {Object} data Arbitrary data from the drag source
    94|      * @return {Boolean} True if the drop is allowed
    95|      */
    96|     canDrop: function(data) {
    97|         return true;
    98|     },
    99|     /**
   100|      * Custom notifyOver method which will be used in the plugin's internal DropTarget
   101|      * @return {String} The CSS class to add
   102|      */
   103|     notifyOver: function(dragSource, event, data) {
   104|         return this.canDrop.apply(this, arguments)
   105|             ? this.dropTarget.dropAllowed
   106|             : this.dropTarget.dropNotAllowed;
   107|     },
   108|     /**
   109|      * Called when the drop has been made. Creates the new toolbar item, places it
   110|      * at the correct location and calls the afterLayout callback.
   111|      */
   112|     notifyDrop: function(dragSource, event, data) {
   113|         var canAdd = this.canDrop(dragSource, event, data),
   114|             tbar = this.toolbar,
   115|             entryIndex;
   116|         if (canAdd) {
   117|             entryIndex = this.calculateEntryIndex(event);
   118|             tbar.insert(entryIndex, this.createItem(data));
   119|             this.afterLayout();
   120|         }
   121|         return canAdd;
   122|     },
   123|     /**
   124|      * Creates the new toolbar item based on drop data. This method must be implemented
   125|      * by the plugin instance
   126|      * @param {Object} data Arbitrary data from the drop
   127|      * @return {Mixed} An item that can be added to a toolbar
   128|      */
   129|     createItem: function(data) {
   130|         Ext.raise("The createItem method must be implemented in the ToolbarDroppable plugin");
   131|     },
   132|     /**
   133|      * @method
   134|      * Called after a new button has been created and added to the toolbar. Add any required
   135|      * cleanup logic here
   136|      */
   137|     afterLayout: Ext.emptyFn
   138| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/TreePicker.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-210 ---
     1| /**
     2|  * A Picker field that contains a tree panel on its popup, enabling selection of tree nodes.
     3|  */
     4| Ext.define('Ext.ux.TreePicker', {
     5|     extend: 'Ext.form.field.Picker',
     6|     xtype: 'treepicker',
     7|     uses: [
     8|         'Ext.tree.Panel'
     9|     ],
    10|     triggerCls: Ext.baseCSSPrefix + 'form-arrow-trigger',
    11|     config: {
    12|         /**
    13|          * @cfg {Ext.data.TreeStore} store
    14|          * A tree store that the tree picker will be bound to
    15|          */
    16|         store: null,
    17|         /**
    18|          * @cfg {String} displayField
    19|          * The field inside the model that will be used as the node's text.
    20|          * Defaults to the default value of {@link Ext.tree.Panel}'s `displayField` configuration.
    21|          */
    22|         displayField: null,
    23|         /**
    24|          * @cfg {Array} columns
    25|          * An optional array of columns for multi-column trees
    26|          */
    27|         columns: null,
    28|         /**
    29|          * @cfg {Boolean} selectOnTab
    30|          * Whether the Tab key should select the currently highlighted item. Defaults to `true`.
    31|          */
    32|         selectOnTab: true,
    33|         /**
    34|          * @cfg {Number} maxPickerHeight
    35|          * The maximum height of the tree dropdown. Defaults to 300.
    36|          */
    37|         maxPickerHeight: 300,
    38|         /**
    39|          * @cfg {Number} minPickerHeight
    40|          * The minimum height of the tree dropdown. Defaults to 100.
    41|          */
    42|         minPickerHeight: 100
    43|     },
    44|     editable: false,
    45|     /**
    46|      * @event select
    47|      * Fires when a tree node is selected
    48|      * @param {Ext.ux.TreePicker} picker        This tree picker
    49|      * @param {Ext.data.Model} record           The selected record
    50|      */
    51|     initComponent: function() {
    52|         var me = this;
    53|         me.callParent(arguments);
    54|         me.mon(me.store, {
    55|             scope: me,
    56|             load: me.onLoad,
    57|             update: me.onUpdate
    58|         });
    59|     },
    60|     /**
    61|      * Creates and returns the tree panel to be used as this field's picker.
    62|      */
    63|     createPicker: function() {
    64|         var me = this,
    65|             picker = new Ext.tree.Panel({
    66|                 baseCls: Ext.baseCSSPrefix + 'boundlist',
    67|                 shrinkWrapDock: 2,
    68|                 store: me.store,
    69|                 floating: true,
    70|                 displayField: me.displayField,
    71|                 columns: me.columns,
    72|                 minHeight: me.minPickerHeight,
    73|                 maxHeight: me.maxPickerHeight,
    74|                 manageHeight: false,
    75|                 shadow: false,
    76|                 listeners: {
    77|                     scope: me,
    78|                     itemclick: me.onItemClick,
    79|                     itemkeydown: me.onPickerKeyDown
    80|                 }
    81|             }),
    82|             view = picker.getView();
    83|         if (Ext.isIE9 && Ext.isStrict) {
    84|             view.on({
    85|                 scope: me,
    86|                 highlightitem: me.repaintPickerView,
    87|                 unhighlightitem: me.repaintPickerView,
    88|                 afteritemexpand: me.repaintPickerView,
    89|                 afteritemcollapse: me.repaintPickerView
    90|             });
    91|         }
    92|         return picker;
    93|     },
    94|     /**
    95|      * repaints the tree view
    96|      */
    97|     repaintPickerView: function() {
    98|         var style = this.picker.getView().getEl().dom.style;
    99|         style.display = style.display; // eslint-disable-line no-self-assign
   100|     },
   101|     /**
   102|      * Handles a click even on a tree node
   103|      * @private
   104|      * @param {Ext.tree.View} view
   105|      * @param {Ext.data.Model} record
   106|      * @param {HTMLElement} node
   107|      * @param {Number} rowIndex
   108|      * @param {Ext.event.Event} e
   109|      */
   110|     onItemClick: function(view, record, node, rowIndex, e) {
   111|         this.selectItem(record);
   112|     },
   113|     /**
   114|      * Handles a keypress event on the picker element
   115|      * @private
   116|      * @param {Ext.tree.View} treeView
   117|      * @param {Ext.data.Model} record
   118|      * @param {HTMLElement} item
   119|      * @param {Number} index
   120|      * @param {Ext.event.Event} e
   121|      */
   122|     onPickerKeyDown: function(treeView, record, item, index, e) {
   123|         var key = e.getKey();
   124|         if (key === e.ENTER || (key === e.TAB && this.selectOnTab)) {
   125|             this.selectItem(record);
   126|         }
   127|     },
   128|     /**
   129|      * Changes the selection to a given record and closes the picker
   130|      * @private
   131|      * @param {Ext.data.Model} record
   132|      */
   133|     selectItem: function(record) {
   134|         var me = this;
   135|         me.setValue(record.getId());
   136|         me.fireEvent('select', me, record);
   137|         me.collapse();
   138|     },
   139|     /**
   140|      * Runs when the picker is expanded.  Selects the appropriate tree node based on the value
   141|      * of the input element, and focuses the picker so that keyboard navigation will work.
   142|      * @private
   143|      */
   144|     onExpand: function() {
   145|         var picker = this.picker,
   146|             store = picker.store,
   147|             value = this.value,
   148|             node;
   149|         if (value) {
   150|             node = store.getNodeById(value);
   151|         }
   152|         if (!node) {
   153|             node = store.getRoot();
   154|         }
   155|         picker.ensureVisible(node, {
   156|             select: true,
   157|             focus: true
   158|         });
   159|     },
   160|     /**
   161|      * Sets the specified value into the field
   162|      * @param {Mixed} value
   163|      * @return {Ext.ux.TreePicker} this
   164|      */
   165|     setValue: function(value) {
   166|         var me = this,
   167|             record;
   168|         me.value = value;
   169|         if (me.store.loading) {
   170|             return me;
   171|         }
   172|         record = value ? me.store.getNodeById(value) : me.store.getRoot();
   173|         if (value === undefined) {
   174|             record = me.store.getRoot();
   175|             me.value = record.getId();
   176|         }
   177|         else {
   178|             record = me.store.getNodeById(value);
   179|         }
   180|         me.setRawValue(record ? record.get(me.displayField) : '');
   181|         return me;
   182|     },
   183|     getSubmitValue: function() {
   184|         return this.value;
   185|     },
   186|     /**
   187|      * Returns the current data value of the field (the idProperty of the record)
   188|      * @return {Number}
   189|      */
   190|     getValue: function() {
   191|         return this.value;
   192|     },
   193|     /**
   194|      * Handles the store's load event.
   195|      * @private
   196|      */
   197|     onLoad: function() {
   198|         var value = this.value;
   199|         if (value) {
   200|             this.setValue(value);
   201|         }
   202|     },
   203|     onUpdate: function(store, rec, type, modifiedFieldNames) {
   204|         var display = this.displayField;
   205|         if (type === 'edit' && modifiedFieldNames &&
   206|             Ext.Array.contains(modifiedFieldNames, display) && this.value === rec.getId()) {
   207|             this.setRawValue(rec.get(display));
   208|         }
   209|     }
   210| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/Button.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-94 ---
     1| /**
     2|  * A simple color swatch that can be clicked to bring up the color selector.
     3|  *
     4|  * The selected color is configurable via {@link #value}.
     5|  *
     6|  *     @example
     7|  *     Ext.create('Ext.ux.colorpick.Button', {
     8|  *         value: '993300',  // initial selected color
     9|  *         renderTo: Ext.getBody(),
    10|  *
    11|  *         listeners: {
    12|  *             select: function(picker, selColor) {
    13|  *                 Ext.Msg.alert('Color', selColor);
    14|  *             }
    15|  *         }
    16|  *     });
    17|  */
    18| Ext.define('Ext.ux.colorpick.Button', {
    19|     extend: 'Ext.Component',
    20|     xtype: 'colorbutton',
    21|     controller: 'colorpick-buttoncontroller',
    22|     mixins: [
    23|         'Ext.ux.colorpick.Selection'
    24|     ],
    25|     requires: [
    26|         'Ext.ux.colorpick.ButtonController'
    27|     ],
    28|     baseCls: Ext.baseCSSPrefix + 'colorpicker-button',
    29|     width: 20,
    30|     height: 20,
    31|     childEls: [
    32|         'btnEl', 'filterEl'
    33|     ],
    34|     config: {
    35|         /**
    36|          * @cfg {Object} popup
    37|          * This object configures the popup window and colorselector component displayed
    38|          * when this button is clicked. Applications should not need to configure this.
    39|          * @private
    40|          */
    41|         popup: {
    42|             lazy: true,
    43|             $value: {
    44|                 xtype: 'window',
    45|                 closeAction: 'hide',
    46|                 referenceHolder: true,
    47|                 minWidth: 540,
    48|                 minHeight: 200,
    49|                 layout: 'fit',
    50|                 header: false,
    51|                 resizable: true,
    52|                 items: {
    53|                     xtype: 'colorselector',
    54|                     reference: 'selector',
    55|                     showPreviousColor: true,
    56|                     showOkCancelButtons: true
    57|                 }
    58|             }
    59|         }
    60|     },
    61|     defaultBindProperty: 'value',
    62|     twoWayBindable: 'value',
    63|     /* eslint-disable max-len */
    64|     renderTpl:
    65|         '<div id="{id}-filterEl" data-ref="filterEl" style="height:100%; width:100%; position: absolute;"></div>' +
    66|         '<a id="{id}-btnEl" data-ref="btnEl" style="height:100%; width:100%; position: absolute;"></a>',
    67|     /* eslint-enable max-len */
    68|     listeners: {
    69|         click: 'onClick',
    70|         element: 'btnEl'
    71|     },
    72|     /**
    73|      * @event change
    74|      * Fires when a color is selected.
    75|      * @param {Ext.ux.colorpick.Selector} this
    76|      * @param {String} color The value of the selected color as per specified {@link #format}.
    77|      * @param {String} previousColor The previous color value.
    78|      */
    79|     updateColor: function(color) {
    80|         var me = this,
    81|             cp = me.colorPicker;
    82|         me.mixins.colorselection.updateColor.call(me, color);
    83|         Ext.ux.colorpick.ColorUtils.setBackground(me.filterEl, color);
    84|         if (cp) {
    85|             cp.setColor(color);
    86|         }
    87|     },
    88|     updateFormat: function(format) {
    89|         var cp = this.colorPicker;
    90|         if (cp) {
    91|             cp.setFormat(format);
    92|         }
    93|     }
    94| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/ButtonController.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| /**
     2|  * @private
     3|  */
     4| Ext.define('Ext.ux.colorpick.ButtonController', {
     5|     extend: 'Ext.app.ViewController',
     6|     alias: 'controller.colorpick-buttoncontroller',
     7|     requires: [
     8|         'Ext.window.Window',
     9|         'Ext.layout.container.Fit',
    10|         'Ext.ux.colorpick.Selector',
    11|         'Ext.ux.colorpick.ColorUtils'
    12|     ],
    13|     afterRender: function(view) {
    14|         view.updateColor(view.getColor());
    15|     },
    16|     destroy: function() {
    17|         var view = this.getView(),
    18|             colorPickerWindow = view.colorPickerWindow;
    19|         if (colorPickerWindow) {
    20|             colorPickerWindow.destroy();
    21|             view.colorPickerWindow = view.colorPicker = null;
    22|         }
    23|         this.callParent();
    24|     },
    25|     getPopup: function() {
    26|         var view = this.getView(),
    27|             popup = view.colorPickerWindow,
    28|             selector;
    29|         if (!popup) {
    30|             popup = Ext.create(view.getPopup());
    31|             view.colorPickerWindow = popup;
    32|             popup.colorPicker = view.colorPicker = selector = popup.lookupReference('selector');
    33|             selector.setFormat(view.getFormat());
    34|             selector.on({
    35|                 ok: 'onColorPickerOK',
    36|                 cancel: 'onColorPickerCancel',
    37|                 scope: this
    38|             });
    39|             popup.on({
    40|                 close: 'onColorPickerCancel',
    41|                 scope: this
    42|             });
    43|         }
    44|         return popup;
    45|     },
    46|     onClick: function() {
    47|         var me = this,
    48|             view = me.getView(),
    49|             color = view.getColor(),
    50|             popup = me.getPopup(),
    51|             colorPicker = popup.colorPicker;
    52|         colorPicker.setColor(color);
    53|         colorPicker.setPreviousColor(color);
    54|         popup.showBy(view, 'tl-br?');
    55|     },
    56|     onColorPickerOK: function(picker) {
    57|         var view = this.getView(),
    58|             color = picker.getColor(),
    59|             cpWin = view.colorPickerWindow;
    60|         cpWin.hide();
    61|         view.setColor(color);
    62|     },
    63|     onColorPickerCancel: function() {
    64|         var view = this.getView(),
    65|             cpWin = view.colorPickerWindow;
    66|         cpWin.hide();
    67|     },
    68|     syncColor: function(color) {
    69|         var view = this.getView();
    70|         Ext.ux.colorpick.ColorUtils.setBackground(view.filterEl, color);
    71|     }
    72| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/ColorMap.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| /**
     2|  * The main colorful square for selecting color shades by dragging around the
     3|  * little circle.
     4|  * @private
     5|  */
     6| Ext.define('Ext.ux.colorpick.ColorMap', {
     7|     extend: 'Ext.container.Container',
     8|     alias: 'widget.colorpickercolormap',
     9|     controller: 'colorpickercolormapcontroller',
    10|     requires: [
    11|         'Ext.ux.colorpick.ColorMapController'
    12|     ],
    13|     cls: Ext.baseCSSPrefix + 'colorpicker-colormap',
    14|     items: [{
    15|         xtype: 'component',
    16|         cls: Ext.baseCSSPrefix + 'colorpicker-colormap-draghandle-container',
    17|         itemId: 'dragHandle',
    18|         width: 1,
    19|         height: 1,
    20|         draggable: true,
    21|         html: '<div class="' + Ext.baseCSSPrefix + 'colorpicker-colormap-draghandle"></div>'
    22|     }],
    23|     listeners: {
    24|         boxready: {
    25|             single: true,
    26|             fn: 'onFirstBoxReady',
    27|             scope: 'controller'
    28|         },
    29|         colorbindingchanged: {
    30|             fn: 'onColorBindingChanged',
    31|             scope: 'controller'
    32|         },
    33|         huebindingchanged: {
    34|             fn: 'onHueBindingChanged',
    35|             scope: 'controller'
    36|         }
    37|     },
    38|     afterRender: function() {
    39|         var me = this,
    40|             src = me.mapGradientUrl,
    41|             el = me.el;
    42|         me.callParent();
    43|         if (!src) {
    44|             src = el.getStyle('background-image');
    45|             src = src.substring(4, src.length - 1);  // strip off outer "url(...)"
    46|             if (src.indexOf('"') === 0) {
    47|                 src = src.substring(1, src.length - 1);
    48|             }
    49|             Ext.ux.colorpick.ColorMap.prototype.mapGradientUrl = src;
    50|         }
    51|         el.setStyle('background-image', 'none');
    52|         el = me.layout.getElementTarget(); // the el for items and html
    53|         el.createChild({
    54|             tag: 'img',
    55|             cls: Ext.baseCSSPrefix + 'colorpicker-colormap-blender',
    56|             src: src
    57|         });
    58|     },
    59|     setPosition: function(data) {
    60|         var me = this,
    61|             dragHandle = me.down('#dragHandle');
    62|         if (!dragHandle.dd || !dragHandle.dd.constrain) {
    63|             return;
    64|         }
    65|         if (typeof dragHandle.dd.dragEnded !== 'undefined' && !dragHandle.dd.dragEnded) {
    66|             return;
    67|         }
    68|         me.fireEvent('colorbindingchanged', data);
    69|     },
    70|     setHue: function(hue) {
    71|         var me = this;
    72|         if (!me.getEl()) {
    73|             return;
    74|         }
    75|         me.fireEvent('huebindingchanged', hue);
    76|     }
    77| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/ColorMapController.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-102 ---
     1| /**
     2|  * @private
     3|  */
     4| Ext.define('Ext.ux.colorpick.ColorMapController', {
     5|     extend: 'Ext.app.ViewController',
     6|     alias: 'controller.colorpickercolormapcontroller',
     7|     requires: [
     8|         'Ext.ux.colorpick.ColorUtils'
     9|     ],
    10|     onFirstBoxReady: function() {
    11|         var me = this,
    12|             colorMap = me.getView(),
    13|             dragHandle = colorMap.down('#dragHandle'),
    14|             dd = dragHandle.dd;
    15|         dd.constrain = true;
    16|         dd.constrainTo = colorMap.getEl();
    17|         dd.initialConstrainTo = dd.constrainTo; // needed otheriwse error EXTJS-13187
    18|         dd.on('drag', Ext.bind(me.onHandleDrag, me));
    19|         me.mon(colorMap.getEl(), {
    20|             mousedown: me.onMouseDown,
    21|             dragstart: me.onDragStart,
    22|             scope: me
    23|         });
    24|     },
    25|     onHandleDrag: function(componentDragger, e) {
    26|         var me = this,
    27|             container = me.getView(), // the Color Map
    28|             dragHandle = container.down('#dragHandle'),
    29|             x = dragHandle.getX() - container.getX(),
    30|             y = dragHandle.getY() - container.getY(),
    31|             containerEl = container.getEl(),
    32|             containerWidth = containerEl.getWidth(),
    33|             containerHeight = containerEl.getHeight(),
    34|             xRatio = x / containerWidth,
    35|             yRatio = y / containerHeight;
    36|         if (xRatio > 0.99) {
    37|             xRatio = 1;
    38|         }
    39|         if (yRatio > 0.99) {
    40|             yRatio = 1;
    41|         }
    42|         container.fireEvent('handledrag', xRatio, yRatio);
    43|     },
    44|     onMouseDown: function(e) {
    45|         var me = this,
    46|             container = me.getView(),
    47|             dragHandle = container.down('#dragHandle');
    48|         dragHandle.setY(e.getY());
    49|         dragHandle.setX(e.getX());
    50|         me.onHandleDrag();
    51|         dragHandle.dd.onMouseDown(e, dragHandle.dd.el);
    52|     },
    53|     onDragStart: function(e) {
    54|         var me = this,
    55|             container = me.getView(),
    56|             dragHandle = container.down('#dragHandle');
    57|         dragHandle.dd.onDragStart(e, dragHandle.dd.el);
    58|     },
    59|     onMapClick: function(e) {
    60|         var me = this,
    61|             container = me.getView(), // the Color Map
    62|             dragHandle = container.down('#dragHandle'),
    63|             cXY = container.getXY(),
    64|             eXY = e.getXY(),
    65|             left, top;
    66|         left = eXY[0] - cXY[0];
    67|         top = eXY[1] - cXY[1];
    68|         dragHandle.getEl().setStyle({
    69|             left: left + 'px',
    70|             top: top + 'px'
    71|         });
    72|         me.onHandleDrag();
    73|     },
    74|     onColorBindingChanged: function(selectedColor) {
    75|         var me = this,
    76|             vm = me.getViewModel(),
    77|             rgba = vm.get('selectedColor'),
    78|             container = me.getView(), // the Color Map
    79|             dragHandle = container.down('#dragHandle'),
    80|             containerEl = container.getEl(),
    81|             containerWidth = containerEl.getWidth(),
    82|             containerHeight = containerEl.getHeight(),
    83|             hsv, xRatio, yRatio, left, top;
    84|         hsv = Ext.ux.colorpick.ColorUtils.rgb2hsv(rgba.r, rgba.g, rgba.b);
    85|         xRatio = hsv.s;
    86|         left = containerWidth * xRatio;
    87|         yRatio = 1 - hsv.v;
    88|         top = containerHeight * yRatio;
    89|         dragHandle.getEl().setStyle({
    90|             left: left + 'px',
    91|             top: top + 'px'
    92|         });
    93|     },
    94|     onHueBindingChanged: function(hue) {
    95|         var me = this,
    96|             fullColorRGB,
    97|             hex;
    98|         fullColorRGB = Ext.ux.colorpick.ColorUtils.hsv2rgb(hue, 1, 1);
    99|         hex = Ext.ux.colorpick.ColorUtils.rgb2hex(fullColorRGB.r, fullColorRGB.g, fullColorRGB.b);
   100|         me.getView().getEl().applyStyles({ 'background-color': '#' + hex });
   101|     }
   102| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/ColorPreview.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| /**
     2|  * A basic component that changes background color, with considerations for opacity
     3|  * support (checkered background image and IE8 support).
     4|  */
     5| Ext.define('Ext.ux.colorpick.ColorPreview', {
     6|     extend: 'Ext.Component',
     7|     alias: 'widget.colorpickercolorpreview',
     8|     requires: [
     9|         'Ext.util.Format',
    10|         'Ext.XTemplate'
    11|     ],
    12|     style: 'position: relative',
    13|     /* eslint-disable max-len */
    14|     html: '<div class="' + Ext.baseCSSPrefix + 'colorpreview-filter" style="height:100%; width:100%; position: absolute;"></div>' +
    15|           '<a class="btn" style="height:100%; width:100%; position: absolute;"></a>',
    16|     /* eslint-enable max-len */
    17|     cls: Ext.baseCSSPrefix + 'colorpreview',
    18|     height: 256,
    19|     onRender: function() {
    20|         var me = this;
    21|         me.callParent(arguments);
    22|         me.mon(me.el.down('.btn'), 'click', me.onClick, me);
    23|     },
    24|     onClick: function() {
    25|         this.fireEvent('click', this, this.color);
    26|     },
    27|     setColor: function(color) {
    28|         var me = this,
    29|             el = me.getEl();
    30|         if (!el) {
    31|             return;
    32|         }
    33|         me.color = color;
    34|         me.applyBgStyle(color);
    35|     },
    36|     bgStyleTpl: Ext.create(
    37|         'Ext.XTemplate',
    38|         Ext.isIE && Ext.ieVersion < 10
    39|             ? 'filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=\'#{hexAlpha}{hex}\', endColorstr=\'#{hexAlpha}{hex}\');' /* IE6-9 */
    40|             : 'background: {rgba};'
    41|     ),
    42|     applyBgStyle: function(color) {
    43|         var me = this,
    44|             colorUtils = Ext.ux.colorpick.ColorUtils,
    45|             filterSelector = '.' + Ext.baseCSSPrefix + 'colorpreview-filter',
    46|             el = me.getEl().down(filterSelector),
    47|             hex, alpha, rgba, bgStyle;
    48|         hex = colorUtils.rgb2hex(color.r, color.g, color.b);
    49|         alpha = Ext.util.Format.hex(Math.floor(color.a * 255), 2);
    50|         rgba = colorUtils.getRGBAString(color);
    51|         bgStyle = this.bgStyleTpl.apply({ hex: hex, hexAlpha: alpha, rgba: rgba });
    52|         el.applyStyles(bgStyle);
    53|     }
    54| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/ColorUtils.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-485 ---
     1| /**
     2|  * @private
     3|  */
     4| Ext.define('Ext.ux.colorpick.ColorUtils', function(ColorUtils) {
     5|     var oldIE = Ext.isIE && Ext.ieVersion < 10;
     6|     return {
     7|         singleton: true,
     8|         constructor: function() {
     9|             ColorUtils = this;
    10|         },
    11|         backgroundTpl: oldIE
    12|             ? 'filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, ' +
    13|                 'startColorstr=\'#{alpha}{hex}\', endColorstr=\'#{alpha}{hex}\');'
    14|             : 'background: {rgba};',
    15|         setBackground: oldIE
    16|             ? function(el, color) {
    17|                 var tpl, data, bgStyle;
    18|                 if (el) {
    19|                     tpl = Ext.XTemplate.getTpl(ColorUtils, 'backgroundTpl');
    20|                     data = {
    21|                         hex: ColorUtils.rgb2hex(color.r, color.g, color.b),
    22|                         alpha: Math.floor(color.a * 255).toString(16)
    23|                     };
    24|                     bgStyle = tpl.apply(data);
    25|                     el.applyStyles(bgStyle);
    26|                 }
    27|             }
    28|             : function(el, color) {
    29|                 var tpl, data, bgStyle;
    30|                 if (el) {
    31|                     tpl = Ext.XTemplate.getTpl(ColorUtils, 'backgroundTpl');
    32|                     data = {
    33|                         rgba: ColorUtils.getRGBAString(color)
    34|                     };
    35|                     bgStyle = tpl.apply(data);
    36|                     el.applyStyles(bgStyle);
    37|                 }
    38|             },
    39|         formats: {
    40|             RGB: function(colorO) {
    41|                 return ColorUtils.getRGBString(colorO).toUpperCase();
    42|             },
    43|             RGBA: function(colorO) {
    44|                 return ColorUtils.getRGBAString(colorO).toUpperCase();
    45|             },
    46|             HEX6: function(colorO) {
    47|                 return ColorUtils.rgb2hex(colorO.r, colorO.g, colorO.b);
    48|             },
    49|             HEX8: function(colorO) {
    50|                 var hex = ColorUtils.rgb2hex(colorO.r, colorO.g, colorO.b),
    51|                     opacityHex = Math.round(colorO.a * 255).toString(16);
    52|                 if (opacityHex.length < 2) {
    53|                     hex += '0';
    54|                 }
    55|                 hex += opacityHex.toUpperCase();
    56|                 return hex;
    57|             }
    58|         },
    59|         /* eslint-disable no-useless-escape */
    60|         hexRe: /^#?(([0-9a-f]{8})|((?:[0-9a-f]{3}){1,2}))$/i,
    61|         rgbaAltRe: /^rgba\(\s*([\w#\d]+)\s*,\s*([\d\.]+)\s*\)$/i,
    62|         rgbaRe: /^rgba\(\s*([\d\.]+)\s*,\s*([\d\.]+)\s*,\s*([\d\.]+)\s*,\s*([\d\.]+)\s*\)$/i,
    63|         rgbRe: /^rgb\(\s*([\d\.]+)\s*,\s*([\d\.]+)\s*,\s*([\d\.]+)\s*\)$/i,
    64|         /* eslint-enable no-useless-escape */
    65|         /**
    66|          * Turn a string to a color object. Supports these formats:
    67|          *
    68|          * - "#ABC" (HEX short)
    69|          * - "#ABCDEF" (HEX)
    70|          * - "#ABCDEFDD" (HEX with opacity)
    71|          * - "red" (named colors - see 
    72|          * [Web Colors](http://en.wikipedia.org/wiki/Web_colors) for a full list)
    73|          * - "rgba(r,g,b,a)" i.e "rgba(255,0,0,1)" (a == alpha == 0-1)
    74|          * - "rgba(red, 0.4)"
    75|          * - "rgba(#ABC, 0.9)"
    76|          * - "rgba(#ABCDEF, 0.8)"
    77|          *
    78|          * @param {String} color The color string to parse.
    79|          * @param {String} alphaFormat The format of decimal places for the Alpha channel.
    80|          * @return {Object} Object with various color properties.
    81|          * @return {Number} return.r The red component (0-255).
    82|          * @return {Number} return.g The green component (0-255).
    83|          * @return {Number} return.b The blue component (0-255).
    84|          * @return {Number} return.a The red component (0-1).
    85|          * @return {Number} return.h The hue component (0-1).
    86|          * @return {Number} return.s The saturation component (0-1).
    87|          * @return {Number} return.v The value component (0-1).
    88|          */
    89|         parseColor: function(color, alphaFormat) {
    90|             if (!color) {
    91|                 return null;
    92|             }
    93|             var me = this,
    94|                 rgb = me.colorMap[color],
    95|                 match, ret, hsv;
    96|             if (rgb) {
    97|                 ret = {
    98|                     r: rgb[0],
    99|                     g: rgb[1],
   100|                     b: rgb[2],
   101|                     a: 1
   102|                 };
   103|             }
   104|             else if (color === 'transparent') {
   105|                 ret = {
   106|                     r: 0,
   107|                     g: 0,
   108|                     b: 0,
   109|                     a: 0
   110|                 };
   111|             }
   112|             else {
   113|                 match = me.hexRe.exec(color);
   114|                 if (match) {
   115|                     match = match[1]; // the captured hex
   116|                     switch (match.length) {
   117|                         default:
   118|                             return null;
   119|                         case 3:
   120|                             ret = {
   121|                                 r: parseInt(match[0] + match[0], 16),
   122|                                 g: parseInt(match[1] + match[1], 16),
   123|                                 b: parseInt(match[2] + match[2], 16),
   124|                                 a: 1
   125|                             };
   126|                             break;
   127|                         case 6:
   128|                         case 8:
   129|                             ret = {
   130|                                 r: parseInt(match.substr(0, 2), 16),
   131|                                 g: parseInt(match.substr(2, 2), 16),
   132|                                 b: parseInt(match.substr(4, 2), 16),
   133|                                 a: parseInt(match.substr(6, 2) || 'ff', 16) / 255
   134|                             };
   135|                             break;
   136|                     }
   137|                 }
   138|                 else {
   139|                     match = me.rgbaRe.exec(color);
   140|                     if (match) {
   141|                         ret = {
   142|                             r: parseFloat(match[1]),
   143|                             g: parseFloat(match[2]),
   144|                             b: parseFloat(match[3]),
   145|                             a: parseFloat(match[4])
   146|                         };
   147|                     }
   148|                     else {
   149|                         match = me.rgbaAltRe.exec(color);
   150|                         if (match) {
   151|                             ret = me.parseColor(match[1]);
   152|                             ret.a = parseFloat(match[2]);
   153|                             return ret;
   154|                         }
   155|                         match = me.rgbRe.exec(color);
   156|                         if (match) {
   157|                             ret = {
   158|                                 r: parseFloat(match[1]),
   159|                                 g: parseFloat(match[2]),
   160|                                 b: parseFloat(match[3]),
   161|                                 a: 1
   162|                             };
   163|                         }
   164|                         else {
   165|                             return null;
   166|                         }
   167|                     }
   168|                 }
   169|             }
   170|             if (alphaFormat) {
   171|                 ret.a = Ext.util.Format.number(ret.a, alphaFormat);
   172|             }
   173|             hsv = this.rgb2hsv(ret.r, ret.g, ret.b);
   174|             return Ext.apply(ret, hsv);
   175|         },
   176|         isValid: function(color) {
   177|             return ColorUtils.parseColor(color) !== null;
   178|         },
   179|         /**
   180|          *
   181|          * @param rgba
   182|          * @return {String}
   183|          */
   184|         getRGBAString: function(rgba) {
   185|             return "rgba(" + rgba.r + "," + rgba.g + "," + rgba.b + "," + rgba.a + ")";
   186|         },
   187|         /**
   188|          * Returns a rgb css string whith this color (without the alpha channel)
   189|          * @param rgb
   190|          * @return {String}
   191|          */
   192|         getRGBString: function(rgb) {
   193|             return "rgb(" + rgb.r + "," + rgb.g + "," + rgb.b + ")";
   194|         },
   195|         /**
   196|          * Following standard math to convert from hsl to rgb
   197|          * Check out wikipedia page for more information on how this works
   198|          * h => [0,1]
   199|          * s,l => [0,1]
   200|          * @param h
   201|          * @param s
   202|          * @param v
   203|          * @return {Object} An object with "r", "g" and "b" color properties.
   204|          */
   205|         hsv2rgb: function(h, s, v) {
   206|             h = h * 360;
   207|             if (h === 360) {
   208|                 h = 0;
   209|             }
   210|             var c = v * s,
   211|                 hprime = h / 60,
   212|                 x = c * (1 - Math.abs(hprime % 2 - 1)),
   213|                 rgb = [0, 0, 0],
   214|                 m;
   215|             switch (Math.floor(hprime)) {
   216|                 case 0:
   217|                     rgb = [c, x, 0];
   218|                     break;
   219|                 case 1:
   220|                     rgb = [x, c, 0];
   221|                     break;
   222|                 case 2:
   223|                     rgb = [0, c, x];
   224|                     break;
   225|                 case 3:
   226|                     rgb = [0, x, c];
   227|                     break;
   228|                 case 4:
   229|                     rgb = [x, 0, c];
   230|                     break;
   231|                 case 5:
   232|                     rgb = [c, 0, x];
   233|                     break;
   234|                 default:
   235|                     console.error("unknown color " + h + ' ' + s + " " + v);
   236|                     break;
   237|             }
   238|             m = v - c;
   239|             rgb[0] += m;
   240|             rgb[1] += m;
   241|             rgb[2] += m;
   242|             rgb[0] = Math.round(rgb[0] * 255);
   243|             rgb[1] = Math.round(rgb[1] * 255);
   244|             rgb[2] = Math.round(rgb[2] * 255);
   245|             return {
   246|                 r: rgb[0],
   247|                 g: rgb[1],
   248|                 b: rgb[2]
   249|             };
   250|         },
   251|         /**
   252|          * http://en.wikipedia.org/wiki/HSL_and_HSV
   253|          * @param {Number} r The red component (0-255).
   254|          * @param {Number} g The green component (0-255).
   255|          * @param {Number} b The blue component (0-255).
   256|          * @return {Object} An object with "h", "s" and "v" color properties.
   257|          */
   258|         rgb2hsv: function(r, g, b) {
   259|             r = r / 255;
   260|             g = g / 255;
   261|             b = b / 255;
   262|             var M = Math.max(r, g, b),
   263|                 m = Math.min(r, g, b),
   264|                 c = M - m,
   265|                 hprime = 0,
   266|                 s = 0,
   267|                 h, v;
   268|             if (c !== 0) {
   269|                 if (M === r) {
   270|                     hprime = ((g - b) / c) % 6;
   271|                 }
   272|                 else if (M === g) {
   273|                     hprime = ((b - r) / c) + 2;
   274|                 }
   275|                 else if (M === b) {
   276|                     hprime = ((r - g) / c) + 4;
   277|                 }
   278|             }
   279|             h = hprime * 60;
   280|             if (h === 360) {
   281|                 h = 0;
   282|             }
   283|             v = M;
   284|             if (c !== 0) {
   285|                 s = c / v;
   286|             }
   287|             h = h / 360;
   288|             if (h < 0) {
   289|                 h = h + 1;
   290|             }
   291|             return {
   292|                 h: h,
   293|                 s: s,
   294|                 v: v
   295|             };
   296|         },
   297|         /**
   298|          *
   299|          * @param r
   300|          * @param g
   301|          * @param b
   302|          * @return {String}
   303|          */
   304|         rgb2hex: function(r, g, b) {
   305|             r = r.toString(16);
   306|             g = g.toString(16);
   307|             b = b.toString(16);
   308|             if (r.length < 2) {
   309|                 r = '0' + r;
   310|             }
   311|             if (g.length < 2) {
   312|                 g = '0' + g;
   313|             }
   314|             if (b.length < 2) {
   315|                 b = '0' + b;
   316|             }
   317|             return (r + g + b).toUpperCase();
   318|         },
   319|         colorMap: {
   320|             aliceblue: [240, 248, 255],
   321|             antiquewhite: [250, 235, 215],
   322|             aqua: [0, 255, 255],
   323|             aquamarine: [127, 255, 212],
   324|             azure: [240, 255, 255],
   325|             beige: [245, 245, 220],
   326|             bisque: [255, 228, 196],
   327|             black: [0, 0, 0],
   328|             blanchedalmond: [255, 235, 205],
   329|             blue: [0, 0, 255],
   330|             blueviolet: [138, 43, 226],
   331|             brown: [165, 42, 42],
   332|             burlywood: [222, 184, 135],
   333|             cadetblue: [95, 158, 160],
   334|             chartreuse: [127, 255, 0],
   335|             chocolate: [210, 105, 30],
   336|             coral: [255, 127, 80],
   337|             cornflowerblue: [100, 149, 237],
   338|             cornsilk: [255, 248, 220],
   339|             crimson: [220, 20, 60],
   340|             cyan: [0, 255, 255],
   341|             darkblue: [0, 0, 139],
   342|             darkcyan: [0, 139, 139],
   343|             darkgoldenrod: [184, 132, 11],
   344|             darkgray: [169, 169, 169],
   345|             darkgreen: [0, 100, 0],
   346|             darkgrey: [169, 169, 169],
   347|             darkkhaki: [189, 183, 107],
   348|             darkmagenta: [139, 0, 139],
   349|             darkolivegreen: [85, 107, 47],
   350|             darkorange: [255, 140, 0],
   351|             darkorchid: [153, 50, 204],
   352|             darkred: [139, 0, 0],
   353|             darksalmon: [233, 150, 122],
   354|             darkseagreen: [143, 188, 143],
   355|             darkslateblue: [72, 61, 139],
   356|             darkslategray: [47, 79, 79],
   357|             darkslategrey: [47, 79, 79],
   358|             darkturquoise: [0, 206, 209],
   359|             darkviolet: [148, 0, 211],
   360|             deeppink: [255, 20, 147],
   361|             deepskyblue: [0, 191, 255],
   362|             dimgray: [105, 105, 105],
   363|             dimgrey: [105, 105, 105],
   364|             dodgerblue: [30, 144, 255],
   365|             firebrick: [178, 34, 34],
   366|             floralwhite: [255, 255, 240],
   367|             forestgreen: [34, 139, 34],
   368|             fuchsia: [255, 0, 255],
   369|             gainsboro: [220, 220, 220],
   370|             ghostwhite: [248, 248, 255],
   371|             gold: [255, 215, 0],
   372|             goldenrod: [218, 165, 32],
   373|             gray: [128, 128, 128],
   374|             green: [0, 128, 0],
   375|             greenyellow: [173, 255, 47],
   376|             grey: [128, 128, 128],
   377|             honeydew: [240, 255, 240],
   378|             hotpink: [255, 105, 180],
   379|             indianred: [205, 92, 92],
   380|             indigo: [75, 0, 130],
   381|             ivory: [255, 255, 240],
   382|             khaki: [240, 230, 140],
   383|             lavender: [230, 230, 250],
   384|             lavenderblush: [255, 240, 245],
   385|             lawngreen: [124, 252, 0],
   386|             lemonchiffon: [255, 250, 205],
   387|             lightblue: [173, 216, 230],
   388|             lightcoral: [240, 128, 128],
   389|             lightcyan: [224, 255, 255],
   390|             lightgoldenrodyellow: [250, 250, 210],
   391|             lightgray: [211, 211, 211],
   392|             lightgreen: [144, 238, 144],
   393|             lightgrey: [211, 211, 211],
   394|             lightpink: [255, 182, 193],
   395|             lightsalmon: [255, 160, 122],
   396|             lightseagreen: [32, 178, 170],
   397|             lightskyblue: [135, 206, 250],
   398|             lightslategray: [119, 136, 153],
   399|             lightslategrey: [119, 136, 153],
   400|             lightsteelblue: [176, 196, 222],
   401|             lightyellow: [255, 255, 224],
   402|             lime: [0, 255, 0],
   403|             limegreen: [50, 205, 50],
   404|             linen: [250, 240, 230],
   405|             magenta: [255, 0, 255],
   406|             maroon: [128, 0, 0],
   407|             mediumaquamarine: [102, 205, 170],
   408|             mediumblue: [0, 0, 205],
   409|             mediumorchid: [186, 85, 211],
   410|             mediumpurple: [147, 112, 219],
   411|             mediumseagreen: [60, 179, 113],
   412|             mediumslateblue: [123, 104, 238],
   413|             mediumspringgreen: [0, 250, 154],
   414|             mediumturquoise: [72, 209, 204],
   415|             mediumvioletred: [199, 21, 133],
   416|             midnightblue: [25, 25, 112],
   417|             mintcream: [245, 255, 250],
   418|             mistyrose: [255, 228, 225],
   419|             moccasin: [255, 228, 181],
   420|             navajowhite: [255, 222, 173],
   421|             navy: [0, 0, 128],
   422|             oldlace: [253, 245, 230],
   423|             olive: [128, 128, 0],
   424|             olivedrab: [107, 142, 35],
   425|             orange: [255, 165, 0],
   426|             orangered: [255, 69, 0],
   427|             orchid: [218, 112, 214],
   428|             palegoldenrod: [238, 232, 170],
   429|             palegreen: [152, 251, 152],
   430|             paleturquoise: [175, 238, 238],
   431|             palevioletred: [219, 112, 147],
   432|             papayawhip: [255, 239, 213],
   433|             peachpuff: [255, 218, 185],
   434|             peru: [205, 133, 63],
   435|             pink: [255, 192, 203],
   436|             plum: [221, 160, 203],
   437|             powderblue: [176, 224, 230],
   438|             purple: [128, 0, 128],
   439|             red: [255, 0, 0],
   440|             rosybrown: [188, 143, 143],
   441|             royalblue: [65, 105, 225],
   442|             saddlebrown: [139, 69, 19],
   443|             salmon: [250, 128, 114],
   444|             sandybrown: [244, 164, 96],
   445|             seagreen: [46, 139, 87],
   446|             seashell: [255, 245, 238],
   447|             sienna: [160, 82, 45],
   448|             silver: [192, 192, 192],
   449|             skyblue: [135, 206, 235],
   450|             slateblue: [106, 90, 205],
   451|             slategray: [119, 128, 144],
   452|             slategrey: [119, 128, 144],
   453|             snow: [255, 255, 250],
   454|             springgreen: [0, 255, 127],
   455|             steelblue: [70, 130, 180],
   456|             tan: [210, 180, 140],
   457|             teal: [0, 128, 128],
   458|             thistle: [216, 191, 216],
   459|             tomato: [255, 99, 71],
   460|             turquoise: [64, 224, 208],
   461|             violet: [238, 130, 238],
   462|             wheat: [245, 222, 179],
   463|             white: [255, 255, 255],
   464|             whitesmoke: [245, 245, 245],
   465|             yellow: [255, 255, 0],
   466|             yellowgreen: [154, 205, 5]
   467|         }
   468|     };
   469| }, function(ColorUtils) {
   470|     var formats = ColorUtils.formats,
   471|         lowerized = {};
   472|     formats['#HEX6'] = function(color) {
   473|         return '#' + formats.HEX6(color);
   474|     };
   475|     formats['#HEX8'] = function(color) {
   476|         return '#' + formats.HEX8(color);
   477|     };
   478|     Ext.Object.each(formats, function(name, fn) {
   479|         lowerized[name.toLowerCase()] = function(color) {
   480|             var ret = fn(color);
   481|             return ret.toLowerCase();
   482|         };
   483|     });
   484|     Ext.apply(formats, lowerized);
   485| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/Field.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-159 ---
     1| /**
     2|  * A field that can be clicked to bring up the color picker.
     3|  * The selected color is configurable via {@link #value}.
     4|  *
     5|  *      @example
     6|  *      Ext.create({
     7|  *          xtype: 'colorfield',
     8|  *          renderTo: Ext.getBody(),
     9|  *
    10|  *          value: '#993300',  // initial selected color
    11|  *
    12|  *          listeners : {
    13|  *              change: function(field, color) {
    14|  *                  console.log('New color: ' + color);
    15|  *              }
    16|  *          }
    17|  *      });
    18|  */
    19| Ext.define('Ext.ux.colorpick.Field', {
    20|     extend: 'Ext.form.field.Picker',
    21|     xtype: 'colorfield',
    22|     mixins: [
    23|         'Ext.ux.colorpick.Selection'
    24|     ],
    25|     requires: [
    26|         'Ext.window.Window',
    27|         'Ext.ux.colorpick.Selector',
    28|         'Ext.ux.colorpick.ColorUtils',
    29|         'Ext.layout.container.Fit'
    30|     ],
    31|     editable: false,
    32|     matchFieldWidth: false, // picker is usually wider than field
    33|     beforeBodyEl: [
    34|         '<div class="' + Ext.baseCSSPrefix + 'colorpicker-field-swatch">' +
    35|             '<div id="{id}-swatchEl" data-ref="swatchEl" class="' + Ext.baseCSSPrefix +
    36|                     'colorpicker-field-swatch-inner"></div>' +
    37|         '</div>'
    38|     ],
    39|     cls: Ext.baseCSSPrefix + 'colorpicker-field',
    40|     childEls: [
    41|         'swatchEl'
    42|     ],
    43|     checkChangeEvents: ['change'],
    44|     config: {
    45|         /**
    46|          * @cfg {Object} popup
    47|          * This object configures the popup window and colorselector component displayed
    48|          * when this button is clicked. Applications should not need to configure this.
    49|          * @private
    50|          */
    51|         popup: {
    52|             lazy: true,
    53|             $value: {
    54|                 xtype: 'window',
    55|                 closeAction: 'hide',
    56|                 referenceHolder: true,
    57|                 minWidth: 540,
    58|                 minHeight: 200,
    59|                 layout: 'fit',
    60|                 header: false,
    61|                 resizable: true,
    62|                 items: {
    63|                     xtype: 'colorselector',
    64|                     reference: 'selector',
    65|                     showPreviousColor: true,
    66|                     showOkCancelButtons: true
    67|                 }
    68|             }
    69|         }
    70|     },
    71|     /**
    72|      * @event change
    73|      * Fires when a color is selected or if the field value is updated (if {@link #editable}).
    74|      * @param {Ext.ux.colorpick.Field} this
    75|      * @param {String} color The value of the selected color as per specified {@link #format}.
    76|      * @param {String} previousColor The previous color value.
    77|      */
    78|     initComponent: function() {
    79|         var me = this;
    80|         me.callParent();
    81|         me.on('change', me.onHexChange);
    82|     },
    83|     afterRender: function() {
    84|         this.callParent();
    85|         this.updateValue(this.value);
    86|     },
    87|     createPicker: function() {
    88|         var me = this,
    89|             popup = me.getPopup(),
    90|             picker;
    91|         me.colorPickerWindow = popup = Ext.create(popup);
    92|         me.colorPicker = picker = popup.lookupReference('selector');
    93|         picker.setFormat(me.getFormat());
    94|         picker.setColor(me.getColor());
    95|         picker.setHexReadOnly(!me.editable);
    96|         picker.on({
    97|             ok: 'onColorPickerOK',
    98|             cancel: 'onColorPickerCancel',
    99|             scope: me
   100|         });
   101|         popup.on({
   102|             close: 'onColorPickerCancel',
   103|             scope: me
   104|         });
   105|         return me.colorPickerWindow;
   106|     },
   107|     onColorPickerOK: function(colorPicker) {
   108|         this.setColor(colorPicker.getColor());
   109|         this.collapse();
   110|     },
   111|     onColorPickerCancel: function() {
   112|         this.collapse();
   113|     },
   114|     onExpand: function() {
   115|         var color = this.getColor();
   116|         this.colorPicker.setPreviousColor(color);
   117|     },
   118|     onHexChange: function(field) {
   119|         if (field.validate()) {
   120|             this.setValue(field.getValue());
   121|         }
   122|     },
   123|     setValue: function(color) {
   124|         var me = this;
   125|         if (Ext.ux.colorpick.ColorUtils.isValid(color)) {
   126|             color = me.applyValue(color);
   127|             me.callParent([color]);
   128|             me.updateValue(color);
   129|         }
   130|     },
   131|     updateFormat: function(format) {
   132|         var cp = this.colorPicker;
   133|         if (cp) {
   134|             cp.setFormat(format);
   135|         }
   136|     },
   137|     updateValue: function(color) {
   138|         var me = this,
   139|             c;
   140|         if (!me.syncing) {
   141|             me.syncing = true;
   142|             me.setColor(color);
   143|             me.syncing = false;
   144|         }
   145|         c = me.getColor();
   146|         if (c) {
   147|             Ext.ux.colorpick.ColorUtils.setBackground(me.swatchEl, c);
   148|             if (me.colorPicker) {
   149|                 me.colorPicker.setColor(c);
   150|             }
   151|         }
   152|     },
   153|     validator: function(val) {
   154|         if (!Ext.ux.colorpick.ColorUtils.isValid(val)) {
   155|             return this.invalidText;
   156|         }
   157|         return true;
   158|     }
   159| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/Selection.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-95 ---
     1| /**
     2|  * @private
     3|  */
     4| Ext.define('Ext.ux.colorpick.Selection', {
     5|     mixinId: 'colorselection',
     6|     /* eslint-disable max-len */
     7|     config: {
     8|         /**
     9|          * @cfg {"hex6"/"hex8"/"#hex6"/"#hex8"/"rgb"/"rgba"/"HEX6"/"HEX8"/"#HEX6"/"#HEX8"/"RGB"/"RGBA"} [format=hex6]
    10|          * The color format to for the `value` config. The `value` can be set using any
    11|          * supported format or named color, but the stored value will always be in this
    12|          * format.
    13|          *
    14|          * Supported formats are:
    15|          *
    16|          * - hex6 - For example "ffaa00" (Note: does not preserve transparency).
    17|          * - hex8 - For example "ffaa00ff" - the last 2 digits represent transparency
    18|          * - #hex6 - For example "#ffaa00" (same as "hex6" but with a leading "#").
    19|          * - #hex8 - For example "#ffaa00ff" (same as "hex8" but with a leading "#").
    20|          * - rgb - For example "rgb(255,255,0)" (Note: does not preserve transparency).
    21|          * - rgba - For example "rgba(255,255,0,.25)"
    22|          * - HEX6 - Same as "hex6" but upper case.
    23|          * - HEX8 - Same as "hex8" but upper case.
    24|          * - #HEX6 - Same as "#hex6" but upper case.
    25|          * - #HEX8 - Same as "#hex8" but upper case.
    26|          * - RGB - Same as "rgb" but upper case.
    27|          * - RGBA - Same as "rgba" but upper case.
    28|          */
    29|         format: 'hex6',
    30|         /* eslint-enable max-len */
    31|         /**
    32|          * @cfg {String} [value=FF0000]
    33|          * The initial color to highlight; see {@link #format} for supported formats.
    34|          */
    35|         value: 'FF0000',
    36|         /**
    37|          * @cfg {Object} color
    38|          * This config property is used internally by the UI to maintain the full color.
    39|          * Changes to this config are automatically reflected in `value` and vise-versa.
    40|          * Setting `value` can, however, cause the alpha to be dropped if the new value
    41|          * does not contain an alpha component.
    42|          * @private
    43|          */
    44|         color: null,
    45|         previousColor: null,
    46|         /**
    47|          * @cfg {String} [alphaDecimalFormat=#.##]
    48|          * The format used by {@link Ext.util.Format#number} to format the alpha channel's
    49|          * value.
    50|          * @since 7.0.0
    51|          */
    52|         alphaDecimalFormat: '#.##'
    53|     },
    54|     applyColor: function(color) {
    55|         var c = color;
    56|         if (Ext.isString(c)) {
    57|             c = Ext.ux.colorpick.ColorUtils.parseColor(color, this.getAlphaDecimalFormat());
    58|         }
    59|         return c;
    60|     },
    61|     applyFormat: function(format) {
    62|         var formats = Ext.ux.colorpick.ColorUtils.formats;
    63|         if (!formats.hasOwnProperty(format)) {
    64|             Ext.raise('The specified format "' + format + '" is invalid.');
    65|             return;
    66|         }
    67|         return format;
    68|     },
    69|     applyValue: function(color) {
    70|         var c = Ext.ux.colorpick.ColorUtils.parseColor(
    71|             color || '#000000', this.getAlphaDecimalFormat()
    72|         );
    73|         return this.formatColor(c);
    74|     },
    75|     formatColor: function(color) {
    76|         return Ext.ux.colorpick.ColorUtils.formats[this.getFormat()](color);
    77|     },
    78|     updateColor: function(color) {
    79|         var me = this;
    80|         if (!me.syncing) {
    81|             me.syncing = true;
    82|             me.setValue(me.formatColor(color));
    83|             me.syncing = false;
    84|         }
    85|     },
    86|     updateValue: function(value, oldValue) {
    87|         var me = this;
    88|         if (!me.syncing) {
    89|             me.syncing = true;
    90|             me.setColor(value);
    91|             me.syncing = false;
    92|         }
    93|         this.fireEvent('change', me, value, oldValue);
    94|     }
    95| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/Selector.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-440 ---
     1| /**
     2|  * Sencha Pro Services presents xtype "colorselector".
     3|  * API has been kept as close to the regular colorpicker as possible. The Selector can be
     4|  * rendered to any container.
     5|  *
     6|  * The defaul selected color is configurable via {@link #value} config. Usually used in
     7|  * forms via {@link Ext.ux.colorpick.Button} or {@link Ext.ux.colorpick.Field}.
     8|  *
     9|  * Typically you will need to listen for the change event to be notified when the user
    10|  * chooses a color. Alternatively, you can bind to the "value" config
    11|  *
    12|  *     @example
    13|  *     Ext.create('Ext.ux.colorpick.Selector', {
    14|  *         value: '993300',  // initial selected color
    15|  *         renderTo: Ext.getBody(),
    16|  *         listeners: {
    17|  *             change: function (colorselector, color) {
    18|  *                 console.log('New color: ' + color);
    19|  *             }
    20|  *         }
    21|  *     });
    22|  */
    23| Ext.define('Ext.ux.colorpick.Selector', {
    24|     extend: 'Ext.container.Container',
    25|     xtype: 'colorselector',
    26|     mixins: [
    27|         'Ext.ux.colorpick.Selection'
    28|     ],
    29|     controller: 'colorpick-selectorcontroller',
    30|     requires: [
    31|         'Ext.layout.container.HBox',
    32|         'Ext.form.field.Text',
    33|         'Ext.form.field.Number',
    34|         'Ext.ux.colorpick.ColorMap',
    35|         'Ext.ux.colorpick.SelectorModel',
    36|         'Ext.ux.colorpick.SelectorController',
    37|         'Ext.ux.colorpick.ColorPreview',
    38|         'Ext.ux.colorpick.Slider',
    39|         'Ext.ux.colorpick.SliderAlpha',
    40|         'Ext.ux.colorpick.SliderSaturation',
    41|         'Ext.ux.colorpick.SliderValue',
    42|         'Ext.ux.colorpick.SliderHue'
    43|     ],
    44|     config: {
    45|         hexReadOnly: true
    46|     },
    47|     width: 580, // default width and height gives 255x255 color map in Crisp
    48|     height: 337,
    49|     cls: Ext.baseCSSPrefix + 'colorpicker',
    50|     padding: 10,
    51|     layout: {
    52|         type: 'hbox',
    53|         align: 'stretch'
    54|     },
    55|     defaultBindProperty: 'value',
    56|     twoWayBindable: [
    57|         'value'
    58|     ],
    59|     /**
    60|      * @cfg fieldWidth {Number} Width of the text fields on the container (excluding HEX);
    61|      * since the width of the slider containers is the same as the text field under it 
    62|      * (it's the same vbox column), changing this value will also affect the spacing between
    63|      * the sliders.
    64|      */
    65|     fieldWidth: 50,
    66|     /**
    67|      * @cfg fieldPad {Number} padding between the sliders and HEX/R/G/B fields.
    68|      */    
    69|     fieldPad: 5,
    70|     /**
    71|      * @cfg {Boolean} [showPreviousColor]
    72|      * Whether "previous color" region (in upper right, below the selected color preview)
    73|      * should be shown; these are relied upon by the {@link Ext.ux.colorpick.Button} and
    74|      * the {@link Ext.ux.colorpick.Field}.
    75|      */
    76|     showPreviousColor: false,
    77|     /**
    78|      * @cfg {Boolean} [showOkCancelButtons]
    79|      * Whether Ok and Cancel buttons (in upper right, below the selected color preview)
    80|      * should be shown; these are relied upon by the {@link Ext.ux.colorpick.Button} and
    81|      * the {@link Ext.ux.colorpick.Field}.
    82|      */
    83|     showOkCancelButtons: false,
    84|     /**
    85|      * @event change
    86|      * Fires when a color is selected. Simply dragging sliders around will trigger this.
    87|      * @param {Ext.ux.colorpick.Selector} this
    88|      * @param {String} color The value of the selected color as per specified {@link #format}.
    89|      * @param {String} previousColor The previous color value.
    90|      */
    91|     /**
    92|      * @event ok
    93|      * Fires when OK button is clicked (see {@link #showOkCancelButtons}).
    94|      * @param {Ext.ux.colorpick.Selector} this
    95|      * @param {String} color The value of the selected color as per specified {@link #format}.
    96|      */
    97|     /**
    98|      * @event cancel
    99|      * Fires when Cancel button is clicked (see {@link #showOkCancelButtons}).
   100|      * @param {Ext.ux.colorpick.Selector} this
   101|      */
   102|     listeners: {
   103|         resize: 'onResize'
   104|     },
   105|     constructor: function(config) {
   106|         var me = this,
   107|             childViewModel = Ext.Factory.viewModel('colorpick-selectormodel');
   108|         me.childViewModel = childViewModel;
   109|         me.items = [
   110|             me.getMapAndHexRGBFields(childViewModel),
   111|             me.getSliderAndHField(childViewModel),
   112|             me.getSliderAndSField(childViewModel),
   113|             me.getSliderAndVField(childViewModel),
   114|             me.getSliderAndAField(childViewModel),
   115|             me.getPreviewAndButtons(childViewModel, config)
   116|         ];
   117|         me.childViewModel.bind('{selectedColor}', function(color) {
   118|             me.setColor(color);
   119|         });
   120|         me.callParent([config]);
   121|     },
   122|     updateColor: function(color) {
   123|         var me = this;
   124|         me.mixins.colorselection.updateColor.call(me, color);
   125|         me.childViewModel.set('selectedColor', color);
   126|     },
   127|     updatePreviousColor: function(color) {
   128|         this.childViewModel.set('previousColor', color);
   129|     },
   130|     getMapAndHexRGBFields: function(childViewModel) {
   131|         var me = this,
   132|             fieldMargin = { top: 0, right: me.fieldPad, bottom: 0, left: 0 },
   133|             fieldWidth = me.fieldWidth;
   134|         return {
   135|             xtype: 'container',
   136|             viewModel: childViewModel,
   137|             cls: Ext.baseCSSPrefix + 'colorpicker-escape-overflow',
   138|             flex: 1,
   139|             layout: {
   140|                 type: 'vbox',
   141|                 align: 'stretch'
   142|             },
   143|             margin: '0 10 0 0',
   144|             items: [
   145|                 {
   146|                     xtype: 'colorpickercolormap',
   147|                     reference: 'colorMap',
   148|                     flex: 1,
   149|                     bind: {
   150|                         position: {
   151|                             bindTo: '{selectedColor}',
   152|                             deep: true
   153|                         },
   154|                         hue: '{selectedColor.h}'
   155|                     },
   156|                     listeners: {
   157|                         handledrag: 'onColorMapHandleDrag'
   158|                     }
   159|                 },
   160|                 {
   161|                     xtype: 'container',
   162|                     layout: 'hbox',
   163|                     defaults: {
   164|                         labelAlign: 'top',
   165|                         labelSeparator: '',
   166|                         allowBlank: false,
   167|                         onChange: function() {
   168|                             if (this.isValid()) {
   169|                                 Ext.form.field.Base.prototype.onChange.apply(this, arguments);
   170|                             }
   171|                         }
   172|                     },
   173|                     items: [{
   174|                         xtype: 'textfield',
   175|                         fieldLabel: 'HEX',
   176|                         flex: 1,
   177|                         bind: '{hex}',
   178|                         margin: fieldMargin,
   179|                         regex: /^#[0-9a-f]{6}$/i,
   180|                         readonly: me.getHexReadOnly()
   181|                     }, {
   182|                         xtype: 'numberfield',
   183|                         fieldLabel: 'R',
   184|                         bind: '{red}',
   185|                         width: fieldWidth,
   186|                         hideTrigger: true,
   187|                         maxValue: 255,
   188|                         minValue: 0,
   189|                         margin: fieldMargin
   190|                     }, {
   191|                         xtype: 'numberfield',
   192|                         fieldLabel: 'G',
   193|                         bind: '{green}',
   194|                         width: fieldWidth,
   195|                         hideTrigger: true,
   196|                         maxValue: 255,
   197|                         minValue: 0,
   198|                         margin: fieldMargin
   199|                     }, {
   200|                         xtype: 'numberfield',
   201|                         fieldLabel: 'B',
   202|                         bind: '{blue}',
   203|                         width: fieldWidth,
   204|                         hideTrigger: true,
   205|                         maxValue: 255,
   206|                         minValue: 0,
   207|                         margin: 0
   208|                     }]
   209|                 }
   210|             ]
   211|         };
   212|     },
   213|     getSliderAndHField: function(childViewModel) {
   214|         var me = this,
   215|             fieldWidth = me.fieldWidth;
   216|         return {
   217|             xtype: 'container',
   218|             viewModel: childViewModel,
   219|             cls: Ext.baseCSSPrefix + 'colorpicker-escape-overflow',
   220|             width: fieldWidth,
   221|             layout: {
   222|                 type: 'vbox',
   223|                 align: 'stretch'
   224|             },
   225|             items: [
   226|                 {
   227|                     xtype: 'colorpickersliderhue',
   228|                     reference: 'hueSlider',
   229|                     flex: 1,
   230|                     bind: {
   231|                         hue: '{selectedColor.h}'
   232|                     },
   233|                     width: fieldWidth,
   234|                     listeners: {
   235|                         handledrag: 'onHueSliderHandleDrag'
   236|                     }
   237|                 },
   238|                 {
   239|                     xtype: 'numberfield',
   240|                     fieldLabel: 'H',
   241|                     labelAlign: 'top',
   242|                     labelSeparator: '',
   243|                     bind: '{hue}',
   244|                     hideTrigger: true,
   245|                     maxValue: 360,
   246|                     minValue: 0,
   247|                     allowBlank: false,
   248|                     margin: 0
   249|                 }
   250|             ]
   251|         };
   252|     },
   253|     getSliderAndSField: function(childViewModel) {
   254|         var me = this,
   255|             fieldWidth = me.fieldWidth;
   256|         return {
   257|             xtype: 'container',
   258|             viewModel: childViewModel,
   259|             cls: Ext.baseCSSPrefix + 'colorpicker-escape-overflow',
   260|             width: fieldWidth,
   261|             layout: {
   262|                 type: 'vbox',
   263|                 align: 'stretch'
   264|             },
   265|             margin: {
   266|                 right: me.fieldPad,
   267|                 left: me.fieldPad
   268|             },
   269|             items: [
   270|                 {
   271|                     xtype: 'colorpickerslidersaturation',
   272|                     reference: 'satSlider',
   273|                     flex: 1,
   274|                     bind: {
   275|                         saturation: '{saturation}',
   276|                         hue: '{selectedColor.h}'
   277|                     },
   278|                     width: fieldWidth,
   279|                     listeners: {
   280|                         handledrag: 'onSaturationSliderHandleDrag'
   281|                     }
   282|                 },
   283|                 {
   284|                     xtype: 'numberfield',
   285|                     fieldLabel: 'S',
   286|                     labelAlign: 'top',
   287|                     labelSeparator: '',
   288|                     bind: '{saturation}',
   289|                     hideTrigger: true,
   290|                     maxValue: 100,
   291|                     minValue: 0,
   292|                     allowBlank: false,
   293|                     margin: 0
   294|                 }
   295|             ]
   296|         };
   297|     },
   298|     getSliderAndVField: function(childViewModel) {
   299|         var me = this,
   300|             fieldWidth = me.fieldWidth;
   301|         return {
   302|             xtype: 'container',
   303|             viewModel: childViewModel,
   304|             cls: Ext.baseCSSPrefix + 'colorpicker-escape-overflow',
   305|             width: fieldWidth,
   306|             layout: {
   307|                 type: 'vbox',
   308|                 align: 'stretch'
   309|             },
   310|             items: [
   311|                 {
   312|                     xtype: 'colorpickerslidervalue',
   313|                     reference: 'valueSlider',
   314|                     flex: 1,
   315|                     bind: {
   316|                         value: '{value}',
   317|                         hue: '{selectedColor.h}'
   318|                     },
   319|                     width: fieldWidth,
   320|                     listeners: {
   321|                         handledrag: 'onValueSliderHandleDrag'
   322|                     }
   323|                 },
   324|                 {
   325|                     xtype: 'numberfield',
   326|                     fieldLabel: 'V',
   327|                     labelAlign: 'top',
   328|                     labelSeparator: '',
   329|                     bind: '{value}',
   330|                     hideTrigger: true,
   331|                     maxValue: 100,
   332|                     minValue: 0,
   333|                     allowBlank: false,
   334|                     margin: 0
   335|                 }
   336|             ]
   337|         };
   338|     },
   339|     getSliderAndAField: function(childViewModel) {
   340|         var me = this,
   341|             fieldWidth = me.fieldWidth;
   342|         return {
   343|             xtype: 'container',
   344|             viewModel: childViewModel,
   345|             cls: Ext.baseCSSPrefix + 'colorpicker-escape-overflow',
   346|             width: fieldWidth,
   347|             layout: {
   348|                 type: 'vbox',
   349|                 align: 'stretch'
   350|             },
   351|             margin: {
   352|                 left: me.fieldPad
   353|             },
   354|             items: [
   355|                 {
   356|                     xtype: 'colorpickerslideralpha',
   357|                     reference: 'alphaSlider',
   358|                     flex: 1,
   359|                     bind: {
   360|                         alpha: '{alpha}',
   361|                         color: {
   362|                             bindTo: '{selectedColor}',
   363|                             deep: true
   364|                         }
   365|                     },
   366|                     width: fieldWidth,
   367|                     listeners: {
   368|                         handledrag: 'onAlphaSliderHandleDrag'
   369|                     }
   370|                 },
   371|                 {
   372|                     xtype: 'numberfield',
   373|                     fieldLabel: 'A',
   374|                     labelAlign: 'top',
   375|                     labelSeparator: '',
   376|                     bind: '{alpha}',
   377|                     hideTrigger: true,
   378|                     maxValue: 100,
   379|                     minValue: 0,
   380|                     allowBlank: false,
   381|                     margin: 0
   382|                 }
   383|             ]
   384|         };
   385|     },
   386|     getPreviewAndButtons: function(childViewModel, config) {
   387|         var items = [{
   388|             xtype: 'colorpickercolorpreview',
   389|             flex: 1,
   390|             bind: {
   391|                 color: {
   392|                     bindTo: '{selectedColor}',
   393|                     deep: true
   394|                 }
   395|             }
   396|         }];
   397|         if (config.showPreviousColor) {
   398|             items.push({
   399|                 xtype: 'colorpickercolorpreview',
   400|                 flex: 1,
   401|                 bind: {
   402|                     color: {
   403|                         bindTo: '{previousColor}',
   404|                         deep: true
   405|                     }
   406|                 },
   407|                 listeners: {
   408|                     click: 'onPreviousColorSelected'
   409|                 }
   410|             });
   411|         }
   412|         if (config.showOkCancelButtons) {
   413|             items.push({
   414|                 xtype: 'button',
   415|                 text: 'OK',
   416|                 margin: '10 0 0 0',
   417|                 padding: '10 0 10 0',
   418|                 handler: 'onOK'
   419|             },
   420|                        {
   421|                            xtype: 'button',
   422|                            text: 'Cancel',
   423|                            margin: '10 0 0 0',
   424|                            padding: '10 0 10 0',
   425|                            handler: 'onCancel'
   426|                        });
   427|         }
   428|         return {
   429|             xtype: 'container',
   430|             viewModel: childViewModel,
   431|             width: 70,
   432|             margin: '0 0 0 10',
   433|             items: items,
   434|             layout: {
   435|                 type: 'vbox',
   436|                 align: 'stretch'
   437|             }
   438|         };
   439|     }
   440| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/SelectorController.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-91 ---
     1| /**
     2|  * @private
     3|  */
     4| Ext.define('Ext.ux.colorpick.SelectorController', {
     5|     extend: 'Ext.app.ViewController',
     6|     alias: 'controller.colorpick-selectorcontroller',
     7|     requires: [
     8|         'Ext.ux.colorpick.ColorUtils'
     9|     ],
    10|     destroy: function() {
    11|         var me = this,
    12|             view = me.getView(),
    13|             childViewModel = view.childViewModel;
    14|         if (childViewModel) {
    15|             childViewModel.destroy();
    16|             view.childViewModel = null;
    17|         }
    18|         me.callParent();
    19|     },
    20|     changeHSV: function(hsv) {
    21|         var view = this.getView(),
    22|             color = view.getColor(),
    23|             rgb;
    24|         Ext.applyIf(hsv, color);
    25|         rgb = Ext.ux.colorpick.ColorUtils.hsv2rgb(hsv.h, hsv.s, hsv.v);
    26|         Ext.apply(hsv, rgb);
    27|         view.setColor(hsv);
    28|     },
    29|     onColorMapHandleDrag: function(xPercent, yPercent) {
    30|         this.changeHSV({
    31|             s: xPercent,
    32|             v: 1 - yPercent
    33|         });
    34|     },
    35|     onValueSliderHandleDrag: function(yPercent) {
    36|         this.changeHSV({
    37|             v: 1 - yPercent
    38|         });
    39|     },
    40|     onSaturationSliderHandleDrag: function(yPercent) {
    41|         this.changeHSV({
    42|             s: 1 - yPercent
    43|         });
    44|     },
    45|     onHueSliderHandleDrag: function(yPercent) {
    46|         this.changeHSV({
    47|             h: 1 - yPercent
    48|         });
    49|     },
    50|     onAlphaSliderHandleDrag: function(yPercent) {
    51|         var view = this.getView(),
    52|             color = view.getColor(),
    53|             newColor = Ext.applyIf({
    54|                 a: 1 - yPercent
    55|             }, color);
    56|         view.setColor(newColor);
    57|         view.el.repaint();
    58|     },
    59|     onPreviousColorSelected: function(comp, color) {
    60|         var view = this.getView();
    61|         view.setColor(color);
    62|     },
    63|     onOK: function() {
    64|         var me = this,
    65|             view = me.getView();
    66|         view.fireEvent('ok', view, view.getValue());
    67|     },
    68|     onCancel: function() {
    69|         this.fireViewEvent('cancel', this.getView());
    70|     },
    71|     onResize: function() {
    72|         var me = this,
    73|             view = me.getView(),
    74|             vm = view.childViewModel,
    75|             refs = me.getReferences(),
    76|             h, s, v, a;
    77|         if (!me.hasResizedOnce) {
    78|             me.hasResizedOnce = true;
    79|             return;
    80|         }
    81|         h = vm.get('hue');
    82|         s = vm.get('saturation');
    83|         v = vm.get('value');
    84|         a = vm.get('alpha');
    85|         refs.colorMap.setPosition(vm.getData());
    86|         refs.hueSlider.setHue(h);
    87|         refs.satSlider.setSaturation(s);
    88|         refs.valueSlider.setValue(v);
    89|         refs.alphaSlider.setAlpha(a);
    90|     }
    91| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/SelectorModel.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-124 ---
     1| /**
     2|  * View Model that holds the "selectedColor" of the color picker container.
     3|  */
     4| Ext.define('Ext.ux.colorpick.SelectorModel', {
     5|     extend: 'Ext.app.ViewModel',
     6|     alias: 'viewmodel.colorpick-selectormodel',
     7|     requires: [
     8|         'Ext.ux.colorpick.ColorUtils'
     9|     ],
    10|     data: {
    11|         selectedColor: {
    12|             r: 255,  // red
    13|             g: 255,  // green
    14|             b: 255,  // blue
    15|             h: 0,    // hue,
    16|             s: 1,    // saturation
    17|             v: 1,    // value
    18|             a: 1     // alpha (opacity)
    19|         },
    20|         previousColor: {
    21|             r: 0,    // red
    22|             g: 0,    // green
    23|             b: 0,    // blue
    24|             h: 0,    // hue,
    25|             s: 1,    // saturation
    26|             v: 1,    // value
    27|             a: 1     // alpha (opacity)
    28|         }
    29|     },
    30|     formulas: {
    31|         hex: {
    32|             get: function(get) {
    33|                 var r = get('selectedColor.r').toString(16),
    34|                     g = get('selectedColor.g').toString(16),
    35|                     b = get('selectedColor.b').toString(16),
    36|                     result;
    37|                 result = Ext.ux.colorpick.ColorUtils.rgb2hex(r, g, b);
    38|                 return '#' + result;
    39|             },
    40|             set: function(hex) {
    41|                 var rgb = Ext.ux.colorpick.ColorUtils.parseColor(hex);
    42|                 this.changeRGB(rgb);
    43|             }
    44|         },
    45|         red: {
    46|             get: function(get) {
    47|                 return get('selectedColor.r');
    48|             },
    49|             set: function(r) {
    50|                 this.changeRGB({ r: r });
    51|             }
    52|         },
    53|         green: {
    54|             get: function(get) {
    55|                 return get('selectedColor.g');
    56|             },
    57|             set: function(g) {
    58|                 this.changeRGB({ g: g });
    59|             }
    60|         },
    61|         blue: {
    62|             get: function(get) {
    63|                 return get('selectedColor.b');
    64|             },
    65|             set: function(b) {
    66|                 this.changeRGB({ b: b });
    67|             }
    68|         },
    69|         hue: {
    70|             get: function(get) {
    71|                 return get('selectedColor.h') * 360;
    72|             },
    73|             set: function(hue) {
    74|                 this.changeHSV({ h: hue / 360 });
    75|             }
    76|         },
    77|         saturation: {
    78|             get: function(get) {
    79|                 return get('selectedColor.s') * 100;
    80|             },
    81|             set: function(saturation) {
    82|                 this.changeHSV({ s: saturation / 100 });
    83|             }
    84|         },
    85|         value: {
    86|             get: function(get) {
    87|                 var v = get('selectedColor.v');
    88|                 return v * 100;
    89|             },
    90|             set: function(value) {
    91|                 this.changeHSV({ v: value / 100 });
    92|             }
    93|         },
    94|         alpha: {
    95|             get: function(data) {
    96|                 var a = data('selectedColor.a');
    97|                 return a * 100;
    98|             },
    99|             set: function(alpha) {
   100|                 this.set('selectedColor', Ext.applyIf({
   101|                     a: alpha / 100
   102|                 }, this.data.selectedColor));
   103|             }
   104|         }
   105|     }, // formulas
   106|     changeHSV: function(hsv) {
   107|         var rgb;
   108|         Ext.applyIf(hsv, this.data.selectedColor);
   109|         rgb = Ext.ux.colorpick.ColorUtils.hsv2rgb(hsv.h, hsv.s, hsv.v);
   110|         hsv.r = rgb.r;
   111|         hsv.g = rgb.g;
   112|         hsv.b = rgb.b;
   113|         this.set('selectedColor', hsv);
   114|     },
   115|     changeRGB: function(rgb) {
   116|         var hsv;
   117|         Ext.applyIf(rgb, this.data.selectedColor);
   118|         hsv = Ext.ux.colorpick.ColorUtils.rgb2hsv(rgb.r, rgb.g, rgb.b);
   119|         rgb.h = hsv.h;
   120|         rgb.s = hsv.s;
   121|         rgb.v = hsv.v;
   122|         this.set('selectedColor', rgb);
   123|     }
   124| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/Slider.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| /**
     2|  * Parent view for the 4 sliders seen on the color picker window.
     3|  * @private
     4|  */
     5| Ext.define('Ext.ux.colorpick.Slider', {
     6|     extend: 'Ext.container.Container',
     7|     xtype: 'colorpickerslider',
     8|     controller: 'colorpick-slidercontroller',
     9|     afterRender: function() {
    10|         var width, dragCt, dragWidth;
    11|         this.callParent(arguments);
    12|         width = this.width;
    13|         dragCt = this.lookupReference('dragHandleContainer');
    14|         dragWidth = dragCt.getWidth();
    15|         dragCt.el.setStyle('left', ((width - dragWidth) / 2) + 'px');
    16|     },
    17|     baseCls: Ext.baseCSSPrefix + 'colorpicker-slider',
    18|     requires: [
    19|         'Ext.ux.colorpick.SliderController'
    20|     ],
    21|     referenceHolder: true,
    22|     listeners: {
    23|         element: 'el',
    24|         mousedown: 'onMouseDown',
    25|         mouseup: 'onMouseUp',
    26|         dragstart: 'onDragStart'
    27|     },
    28|     items: {
    29|         xtype: 'container',
    30|         cls: Ext.baseCSSPrefix + 'colorpicker-draghandle-container',
    31|         reference: 'dragHandleContainer',
    32|         height: '100%',
    33|         items: {
    34|             xtype: 'component',
    35|             cls: Ext.baseCSSPrefix + 'colorpicker-draghandle-outer',
    36|             reference: 'dragHandle',
    37|             width: '100%',
    38|             height: 1,
    39|             draggable: true,
    40|             html: '<div class="' + Ext.baseCSSPrefix + 'colorpicker-draghandle"></div>'
    41|         }
    42|     },
    43|     setHue: function() {
    44|         Ext.raise('Must implement setHue() in a child class!');
    45|     },
    46|     getDragHandle: function() {
    47|         return this.lookupReference('dragHandle');
    48|     },
    49|     getDragContainer: function() {
    50|         return this.lookupReference('dragHandleContainer');
    51|     }
    52| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/SliderAlpha.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| /**
     2|  * Used for "Alpha" slider.
     3|  * @private
     4|  */
     5| Ext.define('Ext.ux.colorpick.SliderAlpha', {
     6|     extend: 'Ext.ux.colorpick.Slider',
     7|     alias: 'widget.colorpickerslideralpha',
     8|     cls: Ext.baseCSSPrefix + 'colorpicker-alpha',
     9|     requires: [
    10|         'Ext.XTemplate'
    11|     ],
    12|     /* eslint-disable max-len */
    13|     gradientStyleTpl: Ext.create(
    14|         'Ext.XTemplate',
    15|         Ext.isIE && Ext.ieVersion < 10
    16|             ? 'filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=\'#FF{hex}\', endColorstr=\'#00{hex}\');' /* IE6-9 */
    17|             : 'background: -moz-linear-gradient(top, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);' +   /* FF3.6+ */
    18|               'background: -webkit-linear-gradient(top,rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);' + /* Chrome10+,Safari5.1+ */
    19|               'background: -o-linear-gradient(top, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);' +      /* Opera 11.10+ */
    20|               'background: -ms-linear-gradient(top, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);' +     /* IE10+ */
    21|               'background: linear-gradient(to bottom, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);'     /* W3C */
    22|     ),
    23|     /* eslint-enable max-len */
    24|     setAlpha: function(value) {
    25|         var me = this,
    26|             container = me.getDragContainer(),
    27|             dragHandle = me.getDragHandle(),
    28|             containerEl = container.getEl(),
    29|             containerHeight = containerEl.getHeight(),
    30|             el, top;
    31|         if (!dragHandle.dd || !dragHandle.dd.constrain) {
    32|             return;
    33|         }
    34|         if (typeof dragHandle.dd.dragEnded !== 'undefined' && !dragHandle.dd.dragEnded) {
    35|             return;
    36|         }
    37|         top = containerHeight * (1 - (value / 100));
    38|         el = dragHandle.getEl();
    39|         el.setStyle({
    40|             top: top + 'px'
    41|         });
    42|     },
    43|     setColor: function(color) {
    44|         var me = this,
    45|             container = me.getDragContainer(),
    46|             hex, el;
    47|         if (!me.getEl()) {
    48|             return;
    49|         }
    50|         hex = Ext.ux.colorpick.ColorUtils.rgb2hex(color.r, color.g, color.b);
    51|         el = container.getEl().first();
    52|         el.applyStyles(me.gradientStyleTpl.apply({ hex: hex, r: color.r, g: color.g, b: color.b }));
    53|     }
    54| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/SliderController.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| /**
     2|  * @private
     3|  */
     4| Ext.define('Ext.ux.colorpick.SliderController', {
     5|     extend: 'Ext.app.ViewController',
     6|     alias: 'controller.colorpick-slidercontroller',
     7|     boxReady: function(view) {
     8|         var me = this,
     9|             container = me.getDragContainer(),
    10|             dragHandle = me.getDragHandle(),
    11|             dd = dragHandle.dd;
    12|         dd.constrain = true;
    13|         dd.constrainTo = container.getEl();
    14|         dd.initialConstrainTo = dd.constrainTo; // needed otherwise error EXTJS-13187
    15|         dd.on('drag', me.onHandleDrag, me);
    16|     },
    17|     getDragHandle: function() {
    18|         return this.view.lookupReference('dragHandle');
    19|     },
    20|     getDragContainer: function() {
    21|         return this.view.lookupReference('dragHandleContainer');
    22|     },
    23|     onHandleDrag: function(e) {
    24|         var me = this,
    25|             view = me.getView(),
    26|             container = me.getDragContainer(),
    27|             dragHandle = me.getDragHandle(),
    28|             y = dragHandle.getY() - container.getY(),
    29|             containerEl = container.getEl(),
    30|             containerHeight = containerEl.getHeight(),
    31|             yRatio = y / containerHeight;
    32|         if (yRatio > 0.99) {
    33|             yRatio = 1;
    34|         }
    35|         view.fireEvent('handledrag', yRatio);
    36|     },
    37|     onMouseDown: function(e) {
    38|         var me = this,
    39|             dragHandle = me.getDragHandle(),
    40|             y = e.getY();
    41|         dragHandle.setY(y);
    42|         me.onHandleDrag();
    43|         dragHandle.el.repaint();
    44|         dragHandle.dd.onMouseDown(e, dragHandle.dd.el);
    45|     },
    46|     onDragStart: function(e) {
    47|         var me = this,
    48|             dragHandle = me.getDragHandle();
    49|         dragHandle.dd.onDragStart(e, dragHandle.dd.el);
    50|     },
    51|     onMouseUp: function() {
    52|         var dragHandle = this.getDragHandle();
    53|         dragHandle.dd.dragEnded = true; // work around DragTracker bug
    54|     }
    55| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/SliderHue.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| /**
     2|  * Used for "Hue" slider.
     3|  * @private
     4|  */
     5| Ext.define('Ext.ux.colorpick.SliderHue', {
     6|     extend: 'Ext.ux.colorpick.Slider',
     7|     alias: 'widget.colorpickersliderhue',
     8|     cls: Ext.baseCSSPrefix + 'colorpicker-hue',
     9|     afterRender: function() {
    10|         var me = this,
    11|             src = me.gradientUrl,
    12|             el = me.el;
    13|         me.callParent();
    14|         if (!src) {
    15|             src = el.getStyle('background-image');
    16|             src = src.substring(4, src.length - 1);  // strip off outer "url(...)"
    17|             if (src.indexOf('"') === 0) {
    18|                 src = src.substring(1, src.length - 1);
    19|             }
    20|             Ext.ux.colorpick.SliderHue.prototype.gradientUrl = src;
    21|         }
    22|         el.setStyle('background-image', 'none');
    23|         el = me.getDragContainer().layout.getElementTarget(); // the el for items and html
    24|         el.createChild({
    25|             tag: 'img',
    26|             cls: Ext.baseCSSPrefix + 'colorpicker-hue-gradient',
    27|             src: src
    28|         });
    29|     },
    30|     setHue: function(hue) {
    31|         var me = this,
    32|             container = me.getDragContainer(),
    33|             dragHandle = me.getDragHandle(),
    34|             containerEl = container.getEl(),
    35|             containerHeight = containerEl.getHeight(),
    36|             el, top;
    37|         if (!dragHandle.dd || !dragHandle.dd.constrain) {
    38|             return;
    39|         }
    40|         if (typeof dragHandle.dd.dragEnded !== 'undefined' && !dragHandle.dd.dragEnded) {
    41|             return;
    42|         }
    43|         top = containerHeight * (1 - hue);
    44|         el = dragHandle.getEl();
    45|         el.setStyle({
    46|             top: top + 'px'
    47|         });
    48|     }
    49| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/SliderSaturation.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| /**
     2|  * Used for "Saturation" slider
     3|  * @private
     4|  */
     5| Ext.define('Ext.ux.colorpick.SliderSaturation', {
     6|     extend: 'Ext.ux.colorpick.Slider',
     7|     alias: 'widget.colorpickerslidersaturation',
     8|     cls: Ext.baseCSSPrefix + 'colorpicker-saturation',
     9|     /* eslint-disable max-len */
    10|     gradientStyleTpl: Ext.create(
    11|         'Ext.XTemplate',
    12|         Ext.isIE && Ext.ieVersion < 10
    13|             ? 'filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=\'#{hex}\', endColorstr=\'#ffffff\');' /* IE6-9 */
    14|             : 'background: -mox-linear-gradient(top, #{hex} 0%, #ffffff 100%);' +   /* FF3.6+ */
    15|               'background: -webkit-linear-gradient(top, #{hex} 0%,#ffffff 100%);' + /* Chrome10+,Safari5.1+ */
    16|               'background: -o-linear-gradient(top, #{hex} 0%,#ffffff 100%);' +      /* Opera 11.10+ */
    17|               'background: -ms-linear-gradient(top, #{hex} 0%,#ffffff 100%);' +     /* IE10+ */
    18|               'background: linear-gradient(to bottom, #{hex} 0%,#ffffff 100%);'     /* W3C */
    19|     ),
    20|     /* eslint-enable max-len */
    21|     setSaturation: function(saturation) {
    22|         var me = this,
    23|             container = me.getDragContainer(),
    24|             dragHandle = me.getDragHandle(),
    25|             containerEl = container.getEl(),
    26|             containerHeight = containerEl.getHeight(),
    27|             yRatio,
    28|             top;
    29|         if (!dragHandle.dd || !dragHandle.dd.constrain) {
    30|             return;
    31|         }
    32|         if (typeof dragHandle.dd.dragEnded !== 'undefined' && !dragHandle.dd.dragEnded) {
    33|             return;
    34|         }
    35|         yRatio = 1 - (saturation / 100);
    36|         top = containerHeight * yRatio;
    37|         dragHandle.getEl().setStyle({
    38|             top: top + 'px'
    39|         });
    40|     },
    41|     setHue: function(hue) {
    42|         var me = this,
    43|             container = me.getDragContainer(),
    44|             rgb, hex;
    45|         if (!me.getEl()) {
    46|             return;
    47|         }
    48|         rgb = Ext.ux.colorpick.ColorUtils.hsv2rgb(hue, 1, 1);
    49|         hex = Ext.ux.colorpick.ColorUtils.rgb2hex(rgb.r, rgb.g, rgb.b);
    50|         container.getEl().applyStyles(me.gradientStyleTpl.apply({ hex: hex }));
    51|     }
    52| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/colorpick/SliderValue.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| /**
     2|  * Used for "Value" slider.
     3|  * @private
     4|  */
     5| Ext.define('Ext.ux.colorpick.SliderValue', {
     6|     extend: 'Ext.ux.colorpick.Slider',
     7|     alias: 'widget.colorpickerslidervalue',
     8|     cls: Ext.baseCSSPrefix + 'colorpicker-value',
     9|     requires: [
    10|         'Ext.XTemplate'
    11|     ],
    12|     /* eslint-disable max-len */
    13|     gradientStyleTpl: Ext.create(
    14|         'Ext.XTemplate',
    15|         Ext.isIE && Ext.ieVersion < 10
    16|             ? 'filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=\'#{hex}\', endColorstr=\'#000000\');' /* IE6-9 */
    17|             : 'background: -mox-linear-gradient(top, #{hex} 0%, #000000 100%);' +   /* FF3.6+ */
    18|           'background: -webkit-linear-gradient(top, #{hex} 0%,#000000 100%);' + /* Chrome10+,Safari5.1+ */
    19|           'background: -o-linear-gradient(top, #{hex} 0%,#000000 100%);' +      /* Opera 11.10+ */
    20|           'background: -ms-linear-gradient(top, #{hex} 0%,#000000 100%);' +     /* IE10+ */
    21|           'background: linear-gradient(to bottom, #{hex} 0%,#000000 100%);'     /* W3C */
    22|     ),
    23|     /* eslint-enable max-len */
    24|     setValue: function(value) {
    25|         var me = this,
    26|             container = me.getDragContainer(),
    27|             dragHandle = me.getDragHandle(),
    28|             containerEl = container.getEl(),
    29|             containerHeight = containerEl.getHeight(),
    30|             yRatio,
    31|             top;
    32|         if (!dragHandle.dd || !dragHandle.dd.constrain) {
    33|             return;
    34|         }
    35|         if (typeof dragHandle.dd.dragEnded !== 'undefined' && !dragHandle.dd.dragEnded) {
    36|             return;
    37|         }
    38|         yRatio = 1 - (value / 100);
    39|         top = containerHeight * yRatio;
    40|         dragHandle.getEl().setStyle({
    41|             top: top + 'px'
    42|         });
    43|     },
    44|     setHue: function(hue) {
    45|         var me = this,
    46|             container = me.getDragContainer(),
    47|             rgb, hex;
    48|         if (!me.getEl()) {
    49|             return;
    50|         }
    51|         rgb = Ext.ux.colorpick.ColorUtils.hsv2rgb(hue, 1, 1);
    52|         hex = Ext.ux.colorpick.ColorUtils.rgb2hex(rgb.r, rgb.g, rgb.b);
    53|         container.getEl().applyStyles(me.gradientStyleTpl.apply({ hex: hex }));
    54|     }
    55| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/data/PagingMemoryProxy.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| /**
     2|  * Paging Memory Proxy, allows to use paging grid with in memory dataset
     3|  */
     4| Ext.define('Ext.ux.data.PagingMemoryProxy', {
     5|     extend: 'Ext.data.proxy.Memory',
     6|     alias: 'proxy.pagingmemory',
     7|     alternateClassName: 'Ext.data.PagingMemoryProxy',
     8|     constructor: function() {
     9|         Ext.log.warn('Ext.ux.data.PagingMemoryProxy functionality has been merged ' +
    10|                      'into Ext.data.proxy.Memory by using the enablePaging flag.');
    11|         this.callParent(arguments);
    12|     },
    13|     read: function(operation, callback, scope) {
    14|         var reader = this.getReader(),
    15|             result = reader.read(this.data),
    16|             sorters, filters, sorterFn, records;
    17|         scope = scope || this;
    18|         filters = operation.filters;
    19|         if (filters.length > 0) {
    20|             records = [];
    21|             Ext.each(result.records, function(record) {
    22|                 var isMatch = true,
    23|                     length = filters.length,
    24|                     filter, fn, scope, i;
    25|                 for (i = 0; i < length; i++) {
    26|                     filter = filters[i];
    27|                     fn = filter.filterFn;
    28|                     scope = filter.scope;
    29|                     isMatch = isMatch && fn.call(scope, record);
    30|                 }
    31|                 if (isMatch) {
    32|                     records.push(record);
    33|                 }
    34|             }, this);
    35|             result.records = records;
    36|             result.totalRecords = result.total = records.length;
    37|         }
    38|         sorters = operation.sorters;
    39|         if (sorters.length > 0) {
    40|             sorterFn = function(r1, r2) {
    41|                 var result = sorters[0].sort(r1, r2),
    42|                     length = sorters.length,
    43|                     i;
    44|                 for (i = 1; i < length; i++) {
    45|                     result = result || sorters[i].sort.call(this, r1, r2);
    46|                 }
    47|                 return result;
    48|             };
    49|             result.records.sort(sorterFn);
    50|         }
    51|         if (operation.start !== undefined && operation.limit !== undefined) {
    52|             result.records = result.records.slice(
    53|                 operation.start, operation.start + operation.limit
    54|             );
    55|             result.count = result.records.length;
    56|         }
    57|         Ext.apply(operation, {
    58|             resultSet: result
    59|         });
    60|         operation.setCompleted();
    61|         operation.setSuccessful();
    62|         Ext.defer(function() {
    63|             Ext.callback(callback, scope, [operation]);
    64|         }, 10);
    65|     }
    66| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/dd/BoxContainerDD.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| /**
     2|  * A DragDrop implementation specialized for use with BoxReorderer.
     3|  */
     4| Ext.define('Ext.ux.dd.BoxContainerDD', {
     5|     extend: 'Ext.dd.DD',
     6|     /**
     7|      * @method alignElWithMouse
     8|      * @member Ext.dd.DD
     9|      * @inheritdoc
    10|      */
    11|     alignElWithMouse: function(el, iPageX, iPageY) {
    12|         var me = this,
    13|             oCoord = me.getTargetCoord(iPageX, iPageY),
    14|             x = oCoord.x,
    15|             y = oCoord.y,
    16|             fly = el.dom ? el : Ext.fly(el, '_dd'),
    17|             aCoord, newLeft, newTop;
    18|         if (!me.deltaSetXY) {
    19|             aCoord = [
    20|                 Math.max(0, x),
    21|                 Math.max(0, y)
    22|             ];
    23|             fly.setXY(aCoord);
    24|             newLeft = me.getLocalX(fly);
    25|             newTop = fly.getLocalY();
    26|             me.deltaSetXY = [newLeft - x, newTop - y];
    27|         }
    28|         else {
    29|             me.setLocalXY(
    30|                 fly,
    31|                 Math.max(0, x + me.deltaSetXY[0]),
    32|                 Math.max(0, y + me.deltaSetXY[1])
    33|             );
    34|         }
    35|         me.cachePosition(x, y);
    36|         me.autoScroll(x, y, el.offsetHeight, el.offsetWidth);
    37|         return oCoord;
    38|     }
    39| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/dd/CellFieldDropZone.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-122 ---
     1| /**
     2|  * This class is used as a grid `plugin`. It provides a DropZone which cooperates with
     3|  * DragZones whose dragData contains a "field" property representing a form Field.
     4|  * Fields may be dropped onto grid data cells containing a matching data type.
     5|  */
     6| Ext.define('Ext.ux.dd.CellFieldDropZone', {
     7|     /* eslint-disable vars-on-top */
     8|     extend: 'Ext.dd.DropZone',
     9|     alias: 'plugin.ux-cellfielddropzone',
    10|     containerScroll: true,
    11|     /**
    12|      * @cfg {Function/String} onCellDrop
    13|      * The function to call on a cell data drop, or the name of the function on the
    14|      * corresponding `{@link Ext.app.ViewController controller}`. For details on the
    15|      * parameters, see `{@link #method!onCellDrop onCellDrop}`.
    16|      */
    17|     /**
    18|      * This method is called when a field is dropped on a cell. This method is normally
    19|      * replaced by the `{@link #cfg!onCellDrop onCellDrop}` config property passed to the
    20|      * constructor.
    21|      * @param {String} fieldName The name of the field.
    22|      * @param {Mixed} value The value of the field.
    23|      * @method onCellDrop
    24|      */
    25|     onCellDrop: Ext.emptyFn,
    26|     constructor: function(cfg) {
    27|         if (cfg) {
    28|             var me = this,
    29|                 ddGroup = cfg.ddGroup,
    30|                 onCellDrop = cfg.onCellDrop;
    31|             if (onCellDrop) {
    32|                 if (typeof onCellDrop === 'string') {
    33|                     me.onCellDropFn = onCellDrop;
    34|                     me.onCellDrop = me.callCellDrop;
    35|                 }
    36|                 else {
    37|                     me.onCellDrop = onCellDrop;
    38|                 }
    39|             }
    40|             if (ddGroup) {
    41|                 me.ddGroup = ddGroup;
    42|             }
    43|         }
    44|     },
    45|     init: function(grid) {
    46|         var me = this;
    47|         if (grid.rendered) {
    48|             me.grid = grid;
    49|             grid.getView().on({
    50|                 render: function(v) {
    51|                     me.view = v;
    52|                     Ext.ux.dd.CellFieldDropZone.superclass.constructor.call(me, me.view.el);
    53|                 },
    54|                 single: true
    55|             });
    56|         }
    57|         else {
    58|             grid.on('render', me.init, me, { single: true });
    59|         }
    60|     },
    61|     getTargetFromEvent: function(e) {
    62|         var me = this,
    63|             v = me.view,
    64|             cell = e.getTarget(v.getCellSelector());
    65|         if (cell) {
    66|             var row = v.findItemByChild(cell),
    67|                 columnIndex = cell.cellIndex;
    68|             if (row && Ext.isDefined(columnIndex)) {
    69|                 return {
    70|                     node: cell,
    71|                     record: v.getRecord(row),
    72|                     fieldName: me.grid.getVisibleColumnManager().getColumns()[columnIndex].dataIndex
    73|                 };
    74|             }
    75|         }
    76|     },
    77|     onNodeEnter: function(target, dd, e, dragData) {
    78|         delete this.dropOK;
    79|         if (!target) {
    80|             return;
    81|         }
    82|         var f = dragData.field;
    83|         if (!f) {
    84|             return;
    85|         }
    86|         var field = target.record.fieldsMap[target.fieldName];
    87|         if (field.isNumeric) {
    88|             if (!f.isXType('numberfield')) {
    89|                 return;
    90|             }
    91|         }
    92|         else if (field.isDateField) {
    93|             if (!f.isXType('datefield')) {
    94|                 return;
    95|             }
    96|         }
    97|         else if (field.isBooleanField) {
    98|             if (!f.isXType('checkbox')) {
    99|                 return;
   100|             }
   101|         }
   102|         this.dropOK = true;
   103|         Ext.fly(target.node).addCls('x-drop-target-active');
   104|     },
   105|     onNodeOver: function(target, dd, e, dragData) {
   106|         return this.dropOK ? this.dropAllowed : this.dropNotAllowed;
   107|     },
   108|     onNodeOut: function(target, dd, e, dragData) {
   109|         Ext.fly(target.node).removeCls('x-drop-target-active');
   110|     },
   111|     onNodeDrop: function(target, dd, e, dragData) {
   112|         if (this.dropOK) {
   113|             var value = dragData.field.getValue();
   114|             target.record.set(target.fieldName, value);
   115|             this.onCellDrop(target.fieldName, value);
   116|             return true;
   117|         }
   118|     },
   119|     callCellDrop: function(fieldName, value) {
   120|         Ext.callback(this.onCellDropFn, null, [fieldName, value], 0, this.grid);
   121|     }
   122| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/dd/PanelFieldDragZone.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| Ext.define('Ext.ux.dd.PanelFieldDragZone', {
     2|     extend: 'Ext.dd.DragZone',
     3|     alias: 'plugin.ux-panelfielddragzone',
     4|     scroll: false,
     5|     constructor: function(cfg) {
     6|         if (cfg) {
     7|             if (cfg.ddGroup) {
     8|                 this.ddGroup = cfg.ddGroup;
     9|             }
    10|         }
    11|     },
    12|     init: function(panel) {
    13|         var el;
    14|         if (panel.nodeType) {
    15|             Ext.ux.dd.PanelFieldDragZone.superclass.init.apply(this, arguments);
    16|         }
    17|         else {
    18|             if (panel.rendered) {
    19|                 el = panel.getEl();
    20|                 el.unselectable();
    21|                 Ext.ux.dd.PanelFieldDragZone.superclass.constructor.call(this, el);
    22|             }
    23|             else {
    24|                 panel.on('afterrender', this.init, this, { single: true });
    25|             }
    26|         }
    27|     },
    28|     getDragData: function(e) {
    29|         var targetLabel = e.getTarget('label', null, true),
    30|             text, oldMark, field, dragEl;
    31|         if (targetLabel) {
    32|             field = Ext.getCmp(targetLabel.up('.' + Ext.form.Labelable.prototype.formItemCls).id);
    33|             oldMark = field.preventMark;
    34|             field.preventMark = true;
    35|             if (field.isValid()) {
    36|                 field.preventMark = oldMark;
    37|                 dragEl = document.createElement('div');
    38|                 dragEl.className = Ext.baseCSSPrefix + 'form-text';
    39|                 text = field.getRawValue();
    40|                 dragEl.innerHTML = Ext.isEmpty(text) ? '&#160;' : text;
    41|                 Ext.fly(dragEl).setWidth(field.getEl().getWidth());
    42|                 return {
    43|                     field: field,
    44|                     ddel: dragEl
    45|                 };
    46|             }
    47|             e.stopEvent();
    48|             field.preventMark = oldMark;
    49|         }
    50|     },
    51|     getRepairXY: function() {
    52|         return this.dragData.field.getEl().getXY();
    53|     }
    54| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/App.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-141 ---
     1| /**
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2014 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  * @class Ext.ux.desktop.App
     7|  */
     8| Ext.define('Ext.ux.desktop.App', {
     9|     mixins: {
    10|         observable: 'Ext.util.Observable'
    11|     },
    12|     requires: [
    13|         'Ext.container.Viewport',
    14|         'Ext.ux.desktop.Desktop'
    15|     ],
    16|     isReady: false,
    17|     modules: null,
    18|     useQuickTips: true,
    19|     constructor: function(config) {
    20|         var me = this;
    21|         me.mixins.observable.constructor.call(this, config);
    22|         if (Ext.isReady) {
    23|             Ext.defer(me.init, 10, me);
    24|         }
    25|         else {
    26|             Ext.onReady(me.init, me);
    27|         }
    28|     },
    29|     init: function() {
    30|         var me = this,
    31|             desktopCfg;
    32|         if (me.useQuickTips) {
    33|             Ext.QuickTips.init();
    34|         }
    35|         me.modules = me.getModules();
    36|         if (me.modules) {
    37|             me.initModules(me.modules);
    38|         }
    39|         desktopCfg = me.getDesktopConfig();
    40|         me.desktop = new Ext.ux.desktop.Desktop(desktopCfg);
    41|         me.viewport = new Ext.container.Viewport({
    42|             layout: 'fit',
    43|             items: [ me.desktop ]
    44|         });
    45|         Ext.getWin().on('beforeunload', me.onUnload, me);
    46|         me.isReady = true;
    47|         me.fireEvent('ready', me);
    48|     },
    49|     /**
    50|      * This method returns the configuration object for the Desktop object. A derived
    51|      * class can override this method, call the base version to build the config and
    52|      * then modify the returned object before returning it.
    53|      */
    54|     getDesktopConfig: function() {
    55|         var me = this,
    56|             cfg = {
    57|                 app: me,
    58|                 taskbarConfig: me.getTaskbarConfig()
    59|             };
    60|         Ext.apply(cfg, me.desktopConfig);
    61|         return cfg;
    62|     },
    63|     getModules: Ext.emptyFn,
    64|     /**
    65|      * This method returns the configuration object for the Start Button. A derived
    66|      * class can override this method, call the base version to build the config and
    67|      * then modify the returned object before returning it.
    68|      */
    69|     getStartConfig: function() {
    70|         var me = this,
    71|             cfg = {
    72|                 app: me,
    73|                 menu: []
    74|             },
    75|             launcher;
    76|         Ext.apply(cfg, me.startConfig);
    77|         Ext.each(me.modules, function(module) {
    78|             launcher = module.launcher;
    79|             if (launcher) {
    80|                 launcher.handler = launcher.handler || Ext.bind(me.createWindow, me, [module]);
    81|                 cfg.menu.push(module.launcher);
    82|             }
    83|         });
    84|         return cfg;
    85|     },
    86|     createWindow: function(module) {
    87|         var window = module.createWindow();
    88|         window.show();
    89|     },
    90|     /**
    91|      * This method returns the configuration object for the TaskBar. A derived class
    92|      * can override this method, call the base version to build the config and then
    93|      * modify the returned object before returning it.
    94|      */
    95|     getTaskbarConfig: function() {
    96|         var me = this,
    97|             cfg = {
    98|                 app: me,
    99|                 startConfig: me.getStartConfig()
   100|             };
   101|         Ext.apply(cfg, me.taskbarConfig);
   102|         return cfg;
   103|     },
   104|     initModules: function(modules) {
   105|         var me = this;
   106|         Ext.each(modules, function(module) {
   107|             module.app = me;
   108|         });
   109|     },
   110|     getModule: function(name) {
   111|         var ms = this.modules,
   112|             i, len, m;
   113|         for (i = 0, len = ms.length; i < len; i++) {
   114|             m = ms[i];
   115|             if (m.id == name || m.appType == name) {
   116|                 return m;
   117|             }
   118|         }
   119|         return null;
   120|     },
   121|     onReady: function(fn, scope) {
   122|         if (this.isReady) {
   123|             fn.call(scope, this);
   124|         }
   125|         else {
   126|             this.on({
   127|                 ready: fn,
   128|                 scope: scope,
   129|                 single: true
   130|             });
   131|         }
   132|     },
   133|     getDesktop: function() {
   134|         return this.desktop;
   135|     },
   136|     onUnload: function(e) {
   137|         if (this.fireEvent('beforeunload', this) === false) {
   138|             e.stopEvent();
   139|         }
   140|     }
   141| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/Desktop.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-369 ---
     1| /**
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2014 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  *
     7|  * @class Ext.ux.desktop.Desktop
     8|  * @extends Ext.panel.Panel
     9|  * <p>This class manages the wallpaper, shortcuts and taskbar.</p>
    10|  */
    11| Ext.define('Ext.ux.desktop.Desktop', {
    12|     extend: 'Ext.panel.Panel',
    13|     alias: 'widget.desktop',
    14|     uses: [
    15|         'Ext.util.MixedCollection',
    16|         'Ext.menu.Menu',
    17|         'Ext.view.View', // dataview
    18|         'Ext.window.Window',
    19|         'Ext.ux.desktop.TaskBar',
    20|         'Ext.ux.desktop.Wallpaper'
    21|     ],
    22|     activeWindowCls: 'ux-desktop-active-win',
    23|     inactiveWindowCls: 'ux-desktop-inactive-win',
    24|     lastActiveWindow: null,
    25|     border: false,
    26|     html: '&#160;',
    27|     layout: 'fit',
    28|     xTickSize: 1,
    29|     yTickSize: 1,
    30|     app: null,
    31|     /**
    32|      * @cfg {Array/Ext.data.Store} shortcuts
    33|      * The items to add to the DataView. This can be a {@link Ext.data.Store Store} or a
    34|      * simple array. Items should minimally provide the fields in the
    35|      * {@link Ext.ux.desktop.ShortcutModel Shortcut}.
    36|      */
    37|     shortcuts: null,
    38|     /**
    39|      * @cfg {String} shortcutItemSelector
    40|      * This property is passed to the DataView for the desktop to select shortcut items.
    41|      * If the {@link #shortcutTpl} is modified, this will probably need to be modified as
    42|      * well.
    43|      */
    44|     shortcutItemSelector: 'div.ux-desktop-shortcut',
    45|     /**
    46|      * @cfg {String} shortcutTpl
    47|      * This XTemplate is used to render items in the DataView. If this is changed, the
    48|      * {@link #shortcutItemSelector} will probably also need to changed.
    49|      */
    50|     /* eslint-disable indent */
    51|     shortcutTpl: [
    52|         '<tpl for=".">',
    53|             '<div class="ux-desktop-shortcut" id="{name}-shortcut">',
    54|                 '<div class="ux-desktop-shortcut-icon {iconCls}">',
    55|                     '<img src="', Ext.BLANK_IMAGE_URL, '" title="{name}">',
    56|                 '</div>',
    57|                 '<span class="ux-desktop-shortcut-text">{name}</span>',
    58|             '</div>',
    59|         '</tpl>',
    60|         '<div class="x-clear"></div>'
    61|     ],
    62|     /* eslint-enable indent */
    63|     /**
    64|      * @cfg {Object} taskbarConfig
    65|      * The config object for the TaskBar.
    66|      */
    67|     taskbarConfig: null,
    68|     windowMenu: null,
    69|     initComponent: function() {
    70|         var me = this,
    71|             wallpaper;
    72|         me.windowMenu = new Ext.menu.Menu(me.createWindowMenu());
    73|         me.bbar = me.taskbar = new Ext.ux.desktop.TaskBar(me.taskbarConfig);
    74|         me.taskbar.windowMenu = me.windowMenu;
    75|         me.windows = new Ext.util.MixedCollection();
    76|         me.contextMenu = new Ext.menu.Menu(me.createDesktopMenu());
    77|         me.items = [
    78|             { xtype: 'wallpaper', id: me.id + '_wallpaper' },
    79|             me.createDataView()
    80|         ];
    81|         me.callParent();
    82|         me.shortcutsView = me.items.getAt(1);
    83|         me.shortcutsView.on('itemclick', me.onShortcutItemClick, me);
    84|         wallpaper = me.wallpaper;
    85|         me.wallpaper = me.items.getAt(0);
    86|         if (wallpaper) {
    87|             me.setWallpaper(wallpaper, me.wallpaperStretch);
    88|         }
    89|     },
    90|     afterRender: function() {
    91|         var me = this;
    92|         me.callParent();
    93|         me.el.on('contextmenu', me.onDesktopMenu, me);
    94|     },
    95|     createDataView: function() {
    96|         var me = this;
    97|         return {
    98|             xtype: 'dataview',
    99|             overItemCls: 'x-view-over',
   100|             trackOver: true,
   101|             itemSelector: me.shortcutItemSelector,
   102|             store: me.shortcuts,
   103|             style: {
   104|                 position: 'absolute'
   105|             },
   106|             x: 0,
   107|             y: 0,
   108|             tpl: new Ext.XTemplate(me.shortcutTpl)
   109|         };
   110|     },
   111|     createDesktopMenu: function() {
   112|         var me = this,
   113|             ret = {
   114|                 items: me.contextMenuItems || []
   115|             };
   116|         if (ret.items.length) {
   117|             ret.items.push('-');
   118|         }
   119|         ret.items.push(
   120|             { text: 'Tile', handler: me.tileWindows, scope: me, minWindows: 1 },
   121|             { text: 'Cascade', handler: me.cascadeWindows, scope: me, minWindows: 1 }
   122|         );
   123|         return ret;
   124|     },
   125|     createWindowMenu: function() {
   126|         var me = this;
   127|         return {
   128|             defaultAlign: 'br-tr',
   129|             items: [
   130|                 { text: 'Restore', handler: me.onWindowMenuRestore, scope: me },
   131|                 { text: 'Minimize', handler: me.onWindowMenuMinimize, scope: me },
   132|                 { text: 'Maximize', handler: me.onWindowMenuMaximize, scope: me },
   133|                 '-',
   134|                 { text: 'Close', handler: me.onWindowMenuClose, scope: me }
   135|             ],
   136|             listeners: {
   137|                 beforeshow: me.onWindowMenuBeforeShow,
   138|                 hide: me.onWindowMenuHide,
   139|                 scope: me
   140|             }
   141|         };
   142|     },
   143|     onDesktopMenu: function(e) {
   144|         var me = this,
   145|             menu = me.contextMenu;
   146|         e.stopEvent();
   147|         if (!menu.rendered) {
   148|             menu.on('beforeshow', me.onDesktopMenuBeforeShow, me);
   149|         }
   150|         menu.showAt(e.getXY());
   151|         menu.doConstrain();
   152|     },
   153|     onDesktopMenuBeforeShow: function(menu) {
   154|         var me = this,
   155|             count = me.windows.getCount();
   156|         menu.items.each(function(item) {
   157|             var min = item.minWindows || 0;
   158|             item.setDisabled(count < min);
   159|         });
   160|     },
   161|     onShortcutItemClick: function(dataView, record) {
   162|         var me = this,
   163|             module = me.app.getModule(record.data.module),
   164|             win = module && module.createWindow();
   165|         if (win) {
   166|             me.restoreWindow(win);
   167|         }
   168|     },
   169|     onWindowClose: function(win) {
   170|         var me = this;
   171|         me.windows.remove(win);
   172|         me.taskbar.removeTaskButton(win.taskButton);
   173|         me.updateActiveWindow();
   174|     },
   175|     onWindowMenuBeforeShow: function(menu) {
   176|         var items = menu.items.items,
   177|             win = menu.theWin;
   178|         items[0].setDisabled(win.maximized !== true && win.hidden !== true); // Restore
   179|         items[1].setDisabled(win.minimized === true); // Minimize
   180|         items[2].setDisabled(win.maximized === true || win.hidden === true); // Maximize
   181|     },
   182|     onWindowMenuClose: function() {
   183|         var me = this,
   184|             win = me.windowMenu.theWin;
   185|         win.close();
   186|     },
   187|     onWindowMenuHide: function(menu) {
   188|         Ext.defer(function() {
   189|             menu.theWin = null;
   190|         }, 1);
   191|     },
   192|     onWindowMenuMaximize: function() {
   193|         var me = this,
   194|             win = me.windowMenu.theWin;
   195|         win.maximize();
   196|         win.toFront();
   197|     },
   198|     onWindowMenuMinimize: function() {
   199|         var me = this,
   200|             win = me.windowMenu.theWin;
   201|         win.minimize();
   202|     },
   203|     onWindowMenuRestore: function() {
   204|         var me = this,
   205|             win = me.windowMenu.theWin;
   206|         me.restoreWindow(win);
   207|     },
   208|     getWallpaper: function() {
   209|         return this.wallpaper.wallpaper;
   210|     },
   211|     setTickSize: function(xTickSize, yTickSize) {
   212|         var me = this,
   213|             xt = me.xTickSize = xTickSize,
   214|             yt = me.yTickSize = (arguments.length > 1) ? yTickSize : xt;
   215|         me.windows.each(function(win) {
   216|             var dd = win.dd,
   217|                 resizer = win.resizer;
   218|             dd.xTickSize = xt;
   219|             dd.yTickSize = yt;
   220|             resizer.widthIncrement = xt;
   221|             resizer.heightIncrement = yt;
   222|         });
   223|     },
   224|     setWallpaper: function(wallpaper, stretch) {
   225|         this.wallpaper.setWallpaper(wallpaper, stretch);
   226|         return this;
   227|     },
   228|     cascadeWindows: function() {
   229|         var x = 0,
   230|             y = 0,
   231|             zmgr = this.getDesktopZIndexManager();
   232|         zmgr.eachBottomUp(function(win) {
   233|             if (win.isWindow && win.isVisible() && !win.maximized) {
   234|                 win.setPosition(x, y);
   235|                 x += 20;
   236|                 y += 20;
   237|             }
   238|         });
   239|     },
   240|     createWindow: function(config, cls) {
   241|         var me = this,
   242|             win,
   243|             cfg = Ext.applyIf(config || {}, {
   244|                 stateful: false,
   245|                 isWindow: true,
   246|                 constrainHeader: true,
   247|                 minimizable: true,
   248|                 maximizable: true
   249|             });
   250|         cls = cls || Ext.window.Window;
   251|         win = me.add(new cls(cfg));
   252|         me.windows.add(win);
   253|         win.taskButton = me.taskbar.addTaskButton(win);
   254|         win.animateTarget = win.taskButton.el;
   255|         win.on({
   256|             activate: me.updateActiveWindow,
   257|             beforeshow: me.updateActiveWindow,
   258|             deactivate: me.updateActiveWindow,
   259|             minimize: me.minimizeWindow,
   260|             destroy: me.onWindowClose,
   261|             scope: me
   262|         });
   263|         win.on({
   264|             boxready: function() {
   265|                 win.dd.xTickSize = me.xTickSize;
   266|                 win.dd.yTickSize = me.yTickSize;
   267|                 if (win.resizer) {
   268|                     win.resizer.widthIncrement = me.xTickSize;
   269|                     win.resizer.heightIncrement = me.yTickSize;
   270|                 }
   271|             },
   272|             single: true
   273|         });
   274|         win.doClose = function() {
   275|             win.doClose = Ext.emptyFn; // dblclick can call again...
   276|             win.el.disableShadow();
   277|             win.el.fadeOut({
   278|                 listeners: {
   279|                     afteranimate: function() {
   280|                         win.destroy();
   281|                     }
   282|                 }
   283|             });
   284|         };
   285|         return win;
   286|     },
   287|     getActiveWindow: function() {
   288|         var win = null,
   289|             zmgr = this.getDesktopZIndexManager();
   290|         if (zmgr) {
   291|             zmgr.eachTopDown(function(comp) {
   292|                 if (comp.isWindow && !comp.hidden) {
   293|                     win = comp;
   294|                     return false;
   295|                 }
   296|                 return true;
   297|             });
   298|         }
   299|         return win;
   300|     },
   301|     getDesktopZIndexManager: function() {
   302|         var windows = this.windows;
   303|         return (windows.getCount() && windows.getAt(0).zIndexManager) || null;
   304|     },
   305|     getWindow: function(id) {
   306|         return this.windows.get(id);
   307|     },
   308|     minimizeWindow: function(win) {
   309|         win.minimized = true;
   310|         win.hide();
   311|     },
   312|     restoreWindow: function(win) {
   313|         if (win.isVisible()) {
   314|             win.restore();
   315|             win.toFront();
   316|         }
   317|         else {
   318|             win.show();
   319|         }
   320|         return win;
   321|     },
   322|     tileWindows: function() {
   323|         var me = this,
   324|             availWidth = me.body.getWidth(true),
   325|             x = me.xTickSize,
   326|             y = me.yTickSize,
   327|             nextY = y;
   328|         me.windows.each(function(win) {
   329|             var w;
   330|             if (win.isVisible() && !win.maximized) {
   331|                 w = win.el.getWidth();
   332|                 if (x > me.xTickSize && x + w > availWidth) {
   333|                     x = me.xTickSize;
   334|                     y = nextY;
   335|                 }
   336|                 win.setPosition(x, y);
   337|                 x += w + me.xTickSize;
   338|                 nextY = Math.max(nextY, y + win.el.getHeight() + me.yTickSize);
   339|             }
   340|         });
   341|     },
   342|     updateActiveWindow: function() {
   343|         var me = this,
   344|             activeWindow = me.getActiveWindow(),
   345|             last = me.lastActiveWindow;
   346|         if (last && last.destroyed) {
   347|             me.lastActiveWindow = null;
   348|             return;
   349|         }
   350|         if (activeWindow === last) {
   351|             return;
   352|         }
   353|         if (last) {
   354|             if (last.el.dom) {
   355|                 last.addCls(me.inactiveWindowCls);
   356|                 last.removeCls(me.activeWindowCls);
   357|             }
   358|             last.active = false;
   359|         }
   360|         me.lastActiveWindow = activeWindow;
   361|         if (activeWindow) {
   362|             activeWindow.addCls(me.activeWindowCls);
   363|             activeWindow.removeCls(me.inactiveWindowCls);
   364|             activeWindow.minimized = false;
   365|             activeWindow.active = true;
   366|         }
   367|         me.taskbar.setActiveButton(activeWindow && activeWindow.taskButton);
   368|     }
   369| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/Module.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-16 ---
     1| /*
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2014 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  */
     7| Ext.define('Ext.ux.desktop.Module', {
     8|     mixins: {
     9|         observable: 'Ext.util.Observable'
    10|     },
    11|     constructor: function(config) {
    12|         this.mixins.observable.constructor.call(this, config);
    13|         this.init();
    14|     },
    15|     init: Ext.emptyFn
    16| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/ShortcutModel.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| /*
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2014 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  */
     7| /**
     8|  * @class Ext.ux.desktop.ShortcutModel
     9|  * @extends Ext.data.Model
    10|  * This model defines the minimal set of fields for desktop shortcuts.
    11|  */
    12| Ext.define('Ext.ux.desktop.ShortcutModel', {
    13|     extend: 'Ext.data.Model',
    14|     fields: [{
    15|         name: 'name',
    16|         convert: Ext.String.createVarName
    17|     }, {
    18|         name: 'iconCls'
    19|     }, {
    20|         name: 'module'
    21|     }]
    22| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/StartMenu.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| /**
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2014 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  * @class Ext.ux.desktop.StartMenu
     7|  */
     8| Ext.define('Ext.ux.desktop.StartMenu', {
     9|     extend: 'Ext.menu.Menu',
    10|     baseCls: Ext.baseCSSPrefix + 'panel',
    11|     cls: 'x-menu ux-start-menu',
    12|     bodyCls: 'ux-start-menu-body',
    13|     defaultAlign: 'bl-tl',
    14|     iconCls: 'user',
    15|     bodyBorder: true,
    16|     width: 300,
    17|     initComponent: function() {
    18|         var me = this;
    19|         me.layout.align = 'stretch';
    20|         me.items = me.menu;
    21|         me.callParent();
    22|         me.toolbar = new Ext.toolbar.Toolbar(Ext.apply({
    23|             dock: 'right',
    24|             cls: 'ux-start-menu-toolbar',
    25|             vertical: true,
    26|             width: 100,
    27|             layout: {
    28|                 align: 'stretch'
    29|             }
    30|         }, me.toolConfig));
    31|         me.addDocked(me.toolbar);
    32|         delete me.toolItems;
    33|     },
    34|     addMenuItem: function() {
    35|         var cmp = this.menu;
    36|         cmp.add.apply(cmp, arguments);
    37|     },
    38|     addToolItem: function() {
    39|         var cmp = this.toolbar;
    40|         cmp.add.apply(cmp, arguments);
    41|     }
    42| }); // StartMenu


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/TaskBar.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-224 ---
     1| /*
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2014 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  */
     7| /**
     8|  * @class Ext.ux.desktop.TaskBar
     9|  * @extends Ext.toolbar.Toolbar
    10|  */
    11| Ext.define('Ext.ux.desktop.TaskBar', {
    12|     extend: 'Ext.toolbar.Toolbar',
    13|     requires: [
    14|         'Ext.button.Button',
    15|         'Ext.resizer.Splitter',
    16|         'Ext.menu.Menu',
    17|         'Ext.ux.desktop.StartMenu'
    18|     ],
    19|     alias: 'widget.taskbar',
    20|     cls: 'ux-taskbar',
    21|     /**
    22|      * @cfg {String} startBtnText
    23|      * The text for the Start Button.
    24|      */
    25|     startBtnText: 'Start',
    26|     initComponent: function() {
    27|         var me = this;
    28|         me.startMenu = new Ext.ux.desktop.StartMenu(me.startConfig);
    29|         me.quickStart = new Ext.toolbar.Toolbar(me.getQuickStart());
    30|         me.windowBar = new Ext.toolbar.Toolbar(me.getWindowBarConfig());
    31|         me.tray = new Ext.toolbar.Toolbar(me.getTrayConfig());
    32|         me.items = [{
    33|             xtype: 'button',
    34|             cls: 'ux-start-button',
    35|             iconCls: 'ux-start-button-icon',
    36|             menu: me.startMenu,
    37|             menuAlign: 'bl-tl',
    38|             text: me.startBtnText
    39|         }, me.quickStart, {
    40|             xtype: 'splitter', html: '&#160;',
    41|             height: 14, width: 2, // TODO - there should be a CSS way here
    42|             cls: 'x-toolbar-separator x-toolbar-separator-horizontal'
    43|         }, me.windowBar, '-', me.tray];
    44|         me.callParent();
    45|     },
    46|     afterLayout: function() {
    47|         var me = this;
    48|         me.callParent();
    49|         me.windowBar.el.on('contextmenu', me.onButtonContextMenu, me);
    50|     },
    51|     /**
    52|      * This method returns the configuration object for the Quick Start toolbar. A derived
    53|      * class can override this method, call the base version to build the config and
    54|      * then modify the returned object before returning it.
    55|      */
    56|     getQuickStart: function() {
    57|         var me = this,
    58|             ret = {
    59|                 minWidth: 20,
    60|                 width: Ext.themeName === 'neptune' ? 70 : 60,
    61|                 items: [],
    62|                 enableOverflow: true
    63|             };
    64|         Ext.each(this.quickStart, function(item) {
    65|             ret.items.push({
    66|                 tooltip: { text: item.name, align: 'bl-tl' },
    67|                 overflowText: item.name,
    68|                 iconCls: item.iconCls,
    69|                 module: item.module,
    70|                 handler: me.onQuickStartClick,
    71|                 scope: me
    72|             });
    73|         });
    74|         return ret;
    75|     },
    76|     /**
    77|      * This method returns the configuration object for the Tray toolbar. A derived
    78|      * class can override this method, call the base version to build the config and
    79|      * then modify the returned object before returning it.
    80|      */
    81|     getTrayConfig: function() {
    82|         var ret = {
    83|             items: this.trayItems
    84|         };
    85|         delete this.trayItems;
    86|         return ret;
    87|     },
    88|     getWindowBarConfig: function() {
    89|         return {
    90|             flex: 1,
    91|             cls: 'ux-desktop-windowbar',
    92|             items: [ '&#160;' ],
    93|             layout: { overflowHandler: 'Scroller' }
    94|         };
    95|     },
    96|     getWindowBtnFromEl: function(el) {
    97|         var c = this.windowBar.getChildByElement(el);
    98|         return c || null;
    99|     },
   100|     onQuickStartClick: function(btn) {
   101|         var module = this.app.getModule(btn.module),
   102|             window;
   103|         if (module) {
   104|             window = module.createWindow();
   105|             window.show();
   106|         }
   107|     },
   108|     onButtonContextMenu: function(e) {
   109|         var me = this,
   110|             t = e.getTarget(),
   111|             btn = me.getWindowBtnFromEl(t);
   112|         if (btn) {
   113|             e.stopEvent();
   114|             me.windowMenu.theWin = btn.win;
   115|             me.windowMenu.showBy(t);
   116|         }
   117|     },
   118|     onWindowBtnClick: function(btn) {
   119|         var win = btn.win;
   120|         if (win.minimized || win.hidden) {
   121|             btn.disable();
   122|             win.show(null, function() {
   123|                 btn.enable();
   124|             });
   125|         }
   126|         else if (win.active) {
   127|             btn.disable();
   128|             win.on('hide', function() {
   129|                 btn.enable();
   130|             }, null, { single: true });
   131|             win.minimize();
   132|         }
   133|         else {
   134|             win.toFront();
   135|         }
   136|     },
   137|     addTaskButton: function(win) {
   138|         var config = {
   139|                 iconCls: win.iconCls,
   140|                 enableToggle: true,
   141|                 toggleGroup: 'all',
   142|                 width: 140,
   143|                 margin: '0 2 0 3',
   144|                 text: Ext.util.Format.ellipsis(win.title, 20),
   145|                 listeners: {
   146|                     click: this.onWindowBtnClick,
   147|                     scope: this
   148|                 },
   149|                 win: win
   150|             },
   151|             cmp = this.windowBar.add(config);
   152|         cmp.toggle(true);
   153|         return cmp;
   154|     },
   155|     removeTaskButton: function(btn) {
   156|         var found,
   157|             me = this;
   158|         me.windowBar.items.each(function(item) {
   159|             if (item === btn) {
   160|                 found = item;
   161|             }
   162|             return !found;
   163|         });
   164|         if (found) {
   165|             me.windowBar.remove(found);
   166|         }
   167|         return found;
   168|     },
   169|     setActiveButton: function(btn) {
   170|         if (btn) {
   171|             btn.toggle(true);
   172|         }
   173|         else {
   174|             this.windowBar.items.each(function(item) {
   175|                 if (item.isButton) {
   176|                     item.toggle(false);
   177|                 }
   178|             });
   179|         }
   180|     }
   181| });
   182| /**
   183|  * @class Ext.ux.desktop.TrayClock
   184|  * @extends Ext.toolbar.TextItem
   185|  * This class displays a clock on the toolbar.
   186|  */
   187| Ext.define('Ext.ux.desktop.TrayClock', {
   188|     extend: 'Ext.toolbar.TextItem',
   189|     alias: 'widget.trayclock',
   190|     cls: 'ux-desktop-trayclock',
   191|     html: '&#160;',
   192|     timeFormat: 'g:i A',
   193|     tpl: '{time}',
   194|     initComponent: function() {
   195|         var me = this;
   196|         me.callParent();
   197|         if (typeof(me.tpl) === 'string') {
   198|             me.tpl = new Ext.XTemplate(me.tpl);
   199|         }
   200|     },
   201|     afterRender: function() {
   202|         var me = this;
   203|         Ext.defer(me.updateTime, 100, me);
   204|         me.callParent();
   205|     },
   206|     doDestroy: function() {
   207|         var me = this;
   208|         if (me.timer) {
   209|             window.clearTimeout(me.timer);
   210|             me.timer = null;
   211|         }
   212|         me.callParent();
   213|     },
   214|     updateTime: function() {
   215|         var me = this,
   216|             time = Ext.Date.format(new Date(), me.timeFormat),
   217|             text = me.tpl.apply({ time: time });
   218|         if (me.lastText !== text) {
   219|             me.setText(text);
   220|             me.lastText = text;
   221|         }
   222|         me.timer = Ext.defer(me.updateTime, 10000, me);
   223|     }
   224| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/Video.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-118 ---
     1| /*
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2015 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  */
     7| /**
     8|  * From code originally written by David Davis
     9|  *
    10|  * For HTML5 video to work, your server must
    11|  * send the right content type, for more info see:
    12|  * <http://developer.mozilla.org/En/HTML/Element/Video>
    13|  * @class Ext.ux.desktop.Video
    14|  */
    15| Ext.define('Ext.ux.desktop.Video', {
    16|     extend: 'Ext.panel.Panel',
    17|     alias: 'widget.video',
    18|     layout: 'fit',
    19|     autoplay: false,
    20|     controls: true,
    21|     bodyStyle: 'background-color:#000;color:#fff',
    22|     html: '',
    23|     /* eslint-disable max-len, indent */
    24|     tpl: [
    25|         '<video id="{id}-video" autoPlay="{autoplay}" controls="{controls}" poster="{poster}" start="{start}" loopstart="{loopstart}" loopend="{loopend}" autobuffer="{autobuffer}" loop="{loop}" style="width:100%;height:100%">',
    26|             '<tpl for="src">',
    27|                 '<source src="{src}" type="{type}"/>',
    28|             '</tpl>',
    29|             '{html}',
    30|         '</video>'
    31|     ],
    32|     /* eslint-enable max-len, indent */
    33|     initComponent: function() {
    34|         var me = this,
    35|             fallback, cfg, chrome;
    36|         if (me.fallbackHTML) {
    37|             fallback = me.fallbackHTML;
    38|         }
    39|         else {
    40|             fallback = "Your browser does not support HTML5 Video. ";
    41|             if (Ext.isChrome) {
    42|                 fallback += 'Upgrade Chrome.';
    43|             }
    44|             else if (Ext.isGecko) {
    45|                 fallback += 'Upgrade to Firefox 3.5 or newer.';
    46|             }
    47|             else {
    48|                 chrome = '<a href="http://www.google.com/chrome">Chrome</a>';
    49|                 fallback += 'Please try <a href="http://www.mozilla.com">Firefox</a>';
    50|                 if (Ext.isIE) {
    51|                     fallback += ', ' + chrome +
    52|                         ' or <a href="http://www.apple.com/safari/">Safari</a>.';
    53|                 }
    54|                 else {
    55|                     fallback += ' or ' + chrome + '.';
    56|                 }
    57|             }
    58|         }
    59|         me.fallbackHTML = fallback;
    60|         cfg = me.data =
    61|             Ext.copyTo(
    62|                 {
    63|                     tag: 'video',
    64|                     html: fallback
    65|                 },
    66|                 me,
    67|                 'id,poster,start,loopstart,loopend,playcount,autobuffer,loop'
    68|             );
    69|         if (me.autoplay) {
    70|             cfg.autoplay = 1;
    71|         }
    72|         if (me.controls) {
    73|             cfg.controls = 1;
    74|         }
    75|         if (Ext.isArray(me.src)) {
    76|             cfg.src = me.src;
    77|         }
    78|         else {
    79|             cfg.src = [{ src: me.src }];
    80|         }
    81|         me.callParent();
    82|     },
    83|     afterRender: function() {
    84|         var me = this,
    85|             el;
    86|         me.callParent();
    87|         me.video = me.body.getById(me.id + '-video');
    88|         el = me.video.dom;
    89|         me.supported = (el && el.tagName.toLowerCase() === 'video');
    90|         if (me.supported) {
    91|             me.video.on('error', me.onVideoError, me);
    92|         }
    93|     },
    94|     getFallback: function() {
    95|         return '<h1 style="background-color:#ff4f4f;padding: 10px;">' + this.fallbackHTML + '</h1>';
    96|     },
    97|     onVideoError: function() {
    98|         var me = this;
    99|         me.video.remove();
   100|         me.supported = false;
   101|         me.body.createChild(me.getFallback());
   102|     },
   103|     doDestroy: function() {
   104|         var me = this,
   105|             video = me.video,
   106|             videoDom;
   107|         video = me.video;
   108|         if (me.supported && video) {
   109|             videoDom = video.dom;
   110|             if (videoDom && videoDom.pause) {
   111|                 videoDom.pause();
   112|             }
   113|             video.remove();
   114|             me.video = null;
   115|         }
   116|         me.callParent();
   117|     }
   118| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/desktop/Wallpaper.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-69 ---
     1| /*
     2|  * Ext JS Library
     3|  * Copyright(c) 2006-2014 Sencha Inc.
     4|  * licensing@sencha.com
     5|  * http://www.sencha.com/license
     6|  */
     7| /**
     8|  * @class Ext.ux.desktop.Wallpaper
     9|  * @extends Ext.Component
    10|  * <p>This component renders an image that stretches to fill the component.</p>
    11|  */
    12| Ext.define('Ext.ux.desktop.Wallpaper', {
    13|     extend: 'Ext.Component',
    14|     alias: 'widget.wallpaper',
    15|     cls: 'ux-wallpaper',
    16|     html: '<img src="' + Ext.BLANK_IMAGE_URL + '">',
    17|     stretch: false,
    18|     wallpaper: null,
    19|     stateful: true,
    20|     stateId: 'desk-wallpaper',
    21|     afterRender: function() {
    22|         var me = this;
    23|         me.callParent();
    24|         me.setWallpaper(me.wallpaper, me.stretch);
    25|     },
    26|     applyState: function() {
    27|         var me = this,
    28|             old = me.wallpaper;
    29|         me.callParent(arguments);
    30|         if (old !== me.wallpaper) {
    31|             me.setWallpaper(me.wallpaper);
    32|         }
    33|     },
    34|     getState: function() {
    35|         return this.wallpaper && { wallpaper: this.wallpaper };
    36|     },
    37|     setWallpaper: function(wallpaper, stretch) {
    38|         var me = this,
    39|             imgEl, bkgnd;
    40|         me.stretch = (stretch !== false);
    41|         me.wallpaper = wallpaper;
    42|         if (me.rendered) {
    43|             imgEl = me.el.dom.firstChild;
    44|             if (!wallpaper || wallpaper === Ext.BLANK_IMAGE_URL) {
    45|                 Ext.fly(imgEl).hide();
    46|             }
    47|             else if (me.stretch) {
    48|                 imgEl.src = wallpaper;
    49|                 me.el.removeCls('ux-wallpaper-tiled');
    50|                 Ext.fly(imgEl).setStyle({
    51|                     width: '100%',
    52|                     height: '100%'
    53|                 }).show();
    54|             }
    55|             else {
    56|                 Ext.fly(imgEl).hide();
    57|                 bkgnd = 'url(' + wallpaper + ')';
    58|                 me.el.addCls('ux-wallpaper-tiled');
    59|             }
    60|             me.el.setStyle({
    61|                 backgroundImage: bkgnd || ''
    62|             });
    63|             if (me.stateful) {
    64|                 me.saveState();
    65|             }
    66|         }
    67|         return me;
    68|     }
    69| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/event/RecorderManager.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-244 ---
     1| /**
     2|  * Recorder manager.
     3|  * Used as a bookmarklet:
     4|  *
     5|  *     javascript:void(window.open("../ux/event/RecorderManager.html","recmgr"))
     6|  */
     7| Ext.define('Ext.ux.event.RecorderManager', {
     8|     extend: 'Ext.panel.Panel',
     9|     alias: 'widget.eventrecordermanager',
    10|     uses: [
    11|         'Ext.ux.event.Recorder',
    12|         'Ext.ux.event.Player'
    13|     ],
    14|     layout: 'fit',
    15|     buttonAlign: 'left',
    16|     eventsToIgnore: {
    17|         mousemove: 1,
    18|         mouseover: 1,
    19|         mouseout: 1
    20|     },
    21|     bodyBorder: false,
    22|     playSpeed: 1,
    23|     initComponent: function() {
    24|         var me = this,
    25|             events;
    26|         me.recorder = new Ext.ux.event.Recorder({
    27|             attachTo: me.attachTo,
    28|             listeners: {
    29|                 add: me.updateEvents,
    30|                 coalesce: me.updateEvents,
    31|                 buffer: 200,
    32|                 scope: me
    33|             }
    34|         });
    35|         me.recorder.eventsToRecord = Ext.apply({}, me.recorder.eventsToRecord);
    36|         function speed(text, value) {
    37|             return {
    38|                 text: text,
    39|                 speed: value,
    40|                 group: 'speed',
    41|                 checked: value === me.playSpeed,
    42|                 handler: me.onPlaySpeed,
    43|                 scope: me
    44|             };
    45|         }
    46|         me.tbar = [
    47|             {
    48|                 text: 'Record',
    49|                 xtype: 'splitbutton',
    50|                 whenIdle: true,
    51|                 handler: me.onRecord,
    52|                 scope: me,
    53|                 menu: me.makeRecordButtonMenu()
    54|             },
    55|             {
    56|                 text: 'Play',
    57|                 xtype: 'splitbutton',
    58|                 whenIdle: true,
    59|                 handler: me.onPlay,
    60|                 scope: me,
    61|                 menu: [
    62|                     speed('Qarter Speed (0.25x)', 0.25),
    63|                     speed('Half Speed (0.5x)', 0.5),
    64|                     speed('3/4 Speed (0.75x)', 0.75),
    65|                     '-',
    66|                     speed('Recorded Speed (1x)', 1),
    67|                     speed('Double Speed (2x)', 2),
    68|                     speed('Quad Speed (4x)', 4),
    69|                     '-',
    70|                     speed('Full Speed', 1000)
    71|                 ]
    72|             },
    73|             {
    74|                 text: 'Clear',
    75|                 whenIdle: true,
    76|                 handler: me.onClear,
    77|                 scope: me
    78|             },
    79|             '->',
    80|             {
    81|                 text: 'Stop',
    82|                 whenActive: true,
    83|                 disabled: true,
    84|                 handler: me.onStop,
    85|                 scope: me
    86|             }
    87|         ];
    88|         events = me.attachTo && me.attachTo.testEvents;
    89|         me.items = [
    90|             {
    91|                 xtype: 'textarea',
    92|                 itemId: 'eventView',
    93|                 fieldStyle: 'font-family: monospace',
    94|                 selectOnFocus: true,
    95|                 emptyText: 'Events go here!',
    96|                 value: events ? me.stringifyEvents(events) : '',
    97|                 scrollToBottom: function() {
    98|                     var inputEl = this.inputEl.dom;
    99|                     inputEl.scrollTop = inputEl.scrollHeight;
   100|                 }
   101|             }
   102|         ];
   103|         me.fbar = [
   104|             {
   105|                 xtype: 'tbtext',
   106|                 text: 'Attached To: ' + (me.attachTo && me.attachTo.location.href)
   107|             }
   108|         ];
   109|         me.callParent();
   110|     },
   111|     makeRecordButtonMenu: function() {
   112|         var ret = [],
   113|             subs = {},
   114|             eventsToRec = this.recorder.eventsToRecord,
   115|             ignoredEvents = this.eventsToIgnore;
   116|         Ext.Object.each(eventsToRec, function(name, value) {
   117|             var sub = subs[value.kind];
   118|             if (!sub) {
   119|                 subs[value.kind] = sub = [];
   120|                 ret.push({
   121|                     text: value.kind,
   122|                     menu: sub
   123|                 });
   124|             }
   125|             sub.push({
   126|                 text: name,
   127|                 checked: true,
   128|                 handler: function(menuItem) {
   129|                     if (menuItem.checked) {
   130|                         eventsToRec[name] = value;
   131|                     }
   132|                     else {
   133|                         delete eventsToRec[name];
   134|                     }
   135|                 }
   136|             });
   137|             if (ignoredEvents[name]) {
   138|                 sub[sub.length - 1].checked = false;
   139|                 Ext.defer(function() {
   140|                     delete eventsToRec[name];
   141|                 }, 1);
   142|             }
   143|         });
   144|         function less(lhs, rhs) {
   145|             return (lhs.text < rhs.text) ? -1 : ((rhs.text < lhs.text) ? 1 : 0);
   146|         }
   147|         ret.sort(less);
   148|         Ext.Array.each(ret, function(sub) {
   149|             sub.menu.sort(less);
   150|         });
   151|         return ret;
   152|     },
   153|     getEventView: function() {
   154|         return this.down('#eventView');
   155|     },
   156|     onClear: function() {
   157|         var view = this.getEventView();
   158|         view.setValue('');
   159|     },
   160|     onPlay: function() {
   161|         var me = this,
   162|             view = me.getEventView(),
   163|             events = view.getValue();
   164|         if (events) {
   165|             events = Ext.decode(events);
   166|             if (events.length) {
   167|                 me.player = Ext.create('Ext.ux.event.Player', {
   168|                     attachTo: window.opener,
   169|                     eventQueue: events,
   170|                     speed: me.playSpeed,
   171|                     listeners: {
   172|                         stop: me.onPlayStop,
   173|                         scope: me
   174|                     }
   175|                 });
   176|                 me.player.start();
   177|                 me.syncBtnUI();
   178|             }
   179|         }
   180|     },
   181|     onPlayStop: function() {
   182|         this.player = null;
   183|         this.syncBtnUI();
   184|     },
   185|     onPlaySpeed: function(menuitem) {
   186|         this.playSpeed = menuitem.speed;
   187|     },
   188|     onRecord: function() {
   189|         this.recorder.start();
   190|         this.syncBtnUI();
   191|     },
   192|     onStop: function() {
   193|         var me = this;
   194|         if (me.player) {
   195|             me.player.stop();
   196|             me.player = null;
   197|         }
   198|         else {
   199|             me.recorder.stop();
   200|         }
   201|         me.syncBtnUI();
   202|         me.updateEvents();
   203|     },
   204|     syncBtnUI: function() {
   205|         var me = this,
   206|             idle = !me.player && !me.recorder.active,
   207|             view;
   208|         Ext.each(me.query('[whenIdle]'), function(btn) {
   209|             btn.setDisabled(!idle);
   210|         });
   211|         Ext.each(me.query('[whenActive]'), function(btn) {
   212|             btn.setDisabled(idle);
   213|         });
   214|         view = me.getEventView();
   215|         view.setReadOnly(!idle);
   216|     },
   217|     stringifyEvents: function(events) {
   218|         var line,
   219|             lines = [];
   220|         Ext.each(events, function(ev) {
   221|             line = [];
   222|             Ext.Object.each(ev, function(name, value) {
   223|                 if (line.length) {
   224|                     line.push(', ');
   225|                 }
   226|                 else {
   227|                     line.push('  { ');
   228|                 }
   229|                 line.push(name, ': ');
   230|                 line.push(Ext.encode(value));
   231|             });
   232|             line.push(' }');
   233|             lines.push(line.join(''));
   234|         });
   235|         return '[\n' + lines.join(',\n') + '\n]';
   236|     },
   237|     updateEvents: function() {
   238|         var me = this,
   239|             text = me.stringifyEvents(me.recorder.getRecordedEvents()),
   240|             view = me.getEventView();
   241|         view.setValue(text);
   242|         view.scrollToBottom();
   243|     }
   244| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/form/ItemSelector.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-333 ---
     1| /*
     2|  * Note that this control will most likely remain as an example, and not as a core Ext form
     3|  * control.  However, the API will be changing in a future release and so should not yet be
     4|  * treated as a final, stable API at this time.
     5|  */
     6| /**
     7|  * A control that allows selection of between two Ext.ux.form.MultiSelect controls.
     8|  */
     9| Ext.define('Ext.ux.form.ItemSelector', {
    10|     extend: 'Ext.ux.form.MultiSelect',
    11|     alias: ['widget.itemselectorfield', 'widget.itemselector'],
    12|     alternateClassName: ['Ext.ux.ItemSelector'],
    13|     requires: [
    14|         'Ext.button.Button',
    15|         'Ext.ux.form.MultiSelect'
    16|     ],
    17|     /**
    18|      * @cfg {Boolean} [hideNavIcons=false] True to hide the navigation icons
    19|      */
    20|     hideNavIcons: false,
    21|     /**
    22|      * @cfg {Array} buttons Defines the set of buttons that should be displayed in between
    23|      * the ItemSelector fields. Defaults to `['top', 'up', 'add', 'remove', 'down', 'bottom']`.
    24|      * These names are used to build the button CSS class names, and to look up the button text
    25|      * labels in {@link #buttonsText}. This can be overridden with a custom Array to change
    26|      * which buttons are displayed or their order.
    27|      */
    28|     buttons: ['top', 'up', 'add', 'remove', 'down', 'bottom'],
    29|     /**
    30|      * @cfg {Object} buttonsText The tooltips for the {@link #buttons}.
    31|      * Labels for buttons.
    32|      */
    33|     buttonsText: {
    34|         top: "Move to Top",
    35|         up: "Move Up",
    36|         add: "Add to Selected",
    37|         remove: "Remove from Selected",
    38|         down: "Move Down",
    39|         bottom: "Move to Bottom"
    40|     },
    41|     layout: {
    42|         type: 'hbox',
    43|         align: 'stretch'
    44|     },
    45|     ariaRole: 'group',
    46|     initComponent: function() {
    47|         var me = this;
    48|         me.ddGroup = me.id + '-dd';
    49|         me.ariaRenderAttributes = me.ariaRenderAttributes || {};
    50|         me.ariaRenderAttributes['aria-labelledby'] = me.id + '-labelEl';
    51|         me.callParent();
    52|         me.bindStore(me.store);
    53|     },
    54|     createList: function(title) {
    55|         var me = this;
    56|         return Ext.create('Ext.ux.form.MultiSelect', {
    57|             submitValue: false,
    58|             getSubmitData: function() {
    59|                 return null;
    60|             },
    61|             getModelData: function() {
    62|                 return null;
    63|             },
    64|             flex: 1,
    65|             dragGroup: me.ddGroup,
    66|             dropGroup: me.ddGroup,
    67|             title: title,
    68|             store: {
    69|                 model: me.store.model,
    70|                 data: []
    71|             },
    72|             displayField: me.displayField,
    73|             valueField: me.valueField,
    74|             disabled: me.disabled,
    75|             listeners: {
    76|                 boundList: {
    77|                     scope: me,
    78|                     itemdblclick: me.onItemDblClick,
    79|                     drop: me.syncValue
    80|                 }
    81|             }
    82|         });
    83|     },
    84|     setupItems: function() {
    85|         var me = this;
    86|         me.fromField = me.createList(me.fromTitle);
    87|         me.toField = me.createList(me.toTitle);
    88|         return [
    89|             me.fromField,
    90|             {
    91|                 xtype: 'toolbar',
    92|                 margin: '0 4',
    93|                 padding: 0,
    94|                 layout: {
    95|                     type: 'vbox',
    96|                     pack: 'center'
    97|                 },
    98|                 items: me.createButtons()
    99|             },
   100|             me.toField
   101|         ];
   102|     },
   103|     createButtons: function() {
   104|         var me = this,
   105|             buttons = [];
   106|         if (!me.hideNavIcons) {
   107|             Ext.Array.forEach(me.buttons, function(name) {
   108|                 buttons.push({
   109|                     xtype: 'button',
   110|                     ui: 'default',
   111|                     tooltip: me.buttonsText[name],
   112|                     ariaLabel: me.buttonsText[name],
   113|                     handler: me['on' + Ext.String.capitalize(name) + 'BtnClick'],
   114|                     cls: Ext.baseCSSPrefix + 'form-itemselector-btn',
   115|                     iconCls: Ext.baseCSSPrefix + 'form-itemselector-' + name,
   116|                     navBtn: true,
   117|                     scope: me,
   118|                     margin: '4 0 0 0'
   119|                 });
   120|             });
   121|         }
   122|         return buttons;
   123|     },
   124|     /**
   125|      * Get the selected records from the specified list.
   126|      * 
   127|      * Records will be returned *in store order*, not in order of selection.
   128|      * @param {Ext.view.BoundList} list The list to read selections from.
   129|      * @return {Ext.data.Model[]} The selected records in store order.
   130|      * 
   131|      */
   132|     getSelections: function(list) {
   133|         var store = list.getStore();
   134|         return Ext.Array.sort(list.getSelectionModel().getSelection(), function(a, b) {
   135|             a = store.indexOf(a);
   136|             b = store.indexOf(b);
   137|             if (a < b) {
   138|                 return -1;
   139|             }
   140|             else if (a > b) {
   141|                 return 1;
   142|             }
   143|             return 0;
   144|         });
   145|     },
   146|     onTopBtnClick: function() {
   147|         var list = this.toField.boundList,
   148|             store = list.getStore(),
   149|             selected = this.getSelections(list);
   150|         store.suspendEvents();
   151|         store.remove(selected, true);
   152|         store.insert(0, selected);
   153|         store.resumeEvents();
   154|         list.refresh();
   155|         this.syncValue();
   156|         list.getSelectionModel().select(selected);
   157|     },
   158|     onBottomBtnClick: function() {
   159|         var list = this.toField.boundList,
   160|             store = list.getStore(),
   161|             selected = this.getSelections(list);
   162|         store.suspendEvents();
   163|         store.remove(selected, true);
   164|         store.add(selected);
   165|         store.resumeEvents();
   166|         list.refresh();
   167|         this.syncValue();
   168|         list.getSelectionModel().select(selected);
   169|     },
   170|     onUpBtnClick: function() {
   171|         var list = this.toField.boundList,
   172|             store = list.getStore(),
   173|             selected = this.getSelections(list),
   174|             rec,
   175|             i = 0,
   176|             len = selected.length,
   177|             index = 0;
   178|         store.suspendEvents();
   179|         for (; i < len; ++i, index++) {
   180|             rec = selected[i];
   181|             index = Math.max(index, store.indexOf(rec) - 1);
   182|             store.remove(rec, true);
   183|             store.insert(index, rec);
   184|         }
   185|         store.resumeEvents();
   186|         list.refresh();
   187|         this.syncValue();
   188|         list.getSelectionModel().select(selected);
   189|     },
   190|     onDownBtnClick: function() {
   191|         var list = this.toField.boundList,
   192|             store = list.getStore(),
   193|             selected = this.getSelections(list),
   194|             rec,
   195|             i = selected.length - 1,
   196|             index = store.getCount() - 1;
   197|         store.suspendEvents();
   198|         for (; i > -1; --i, index--) {
   199|             rec = selected[i];
   200|             index = Math.min(index, store.indexOf(rec) + 1);
   201|             store.remove(rec, true);
   202|             store.insert(index, rec);
   203|         }
   204|         store.resumeEvents();
   205|         list.refresh();
   206|         this.syncValue();
   207|         list.getSelectionModel().select(selected);
   208|     },
   209|     onAddBtnClick: function() {
   210|         var me = this,
   211|             selected = me.getSelections(me.fromField.boundList);
   212|         me.moveRec(true, selected);
   213|         me.toField.boundList.getSelectionModel().select(selected);
   214|     },
   215|     onRemoveBtnClick: function() {
   216|         var me = this,
   217|             selected = me.getSelections(me.toField.boundList);
   218|         me.moveRec(false, selected);
   219|         me.fromField.boundList.getSelectionModel().select(selected);
   220|     },
   221|     moveRec: function(add, recs) {
   222|         var me = this,
   223|             fromField = me.fromField,
   224|             toField = me.toField,
   225|             fromStore = add ? fromField.store : toField.store,
   226|             toStore = add ? toField.store : fromField.store;
   227|         fromStore.suspendEvents();
   228|         toStore.suspendEvents();
   229|         fromStore.remove(recs);
   230|         toStore.add(recs);
   231|         fromStore.resumeEvents();
   232|         toStore.resumeEvents();
   233|         if (fromField.boundList.containsFocus) {
   234|             fromField.boundList.focus();
   235|         }
   236|         fromField.boundList.refresh();
   237|         toField.boundList.refresh();
   238|         me.syncValue();
   239|     },
   240|     syncValue: function() {
   241|         var me = this;
   242|         me.mixins.field.setValue.call(me, me.setupValue(me.toField.store.getRange()));
   243|     },
   244|     onItemDblClick: function(view, rec) {
   245|         this.moveRec(view === this.fromField.boundList, rec);
   246|     },
   247|     setValue: function(value) {
   248|         var me = this,
   249|             fromField = me.fromField,
   250|             toField = me.toField,
   251|             fromStore = fromField.store,
   252|             toStore = toField.store,
   253|             selected;
   254|         if (!me.fromStorePopulated) {
   255|             me.fromField.store.on({
   256|                 load: Ext.Function.bind(me.setValue, me, [value]),
   257|                 single: true
   258|             });
   259|             return;
   260|         }
   261|         value = me.setupValue(value);
   262|         me.mixins.field.setValue.call(me, value);
   263|         selected = me.getRecordsForValue(value);
   264|         fromStore.suspendEvents();
   265|         toStore.suspendEvents();
   266|         fromStore.removeAll();
   267|         toStore.removeAll();
   268|         me.populateFromStore(me.store);
   269|         Ext.Array.forEach(selected, function(rec) {
   270|             if (fromStore.indexOf(rec) > -1) {
   271|                 fromStore.remove(rec);
   272|             }
   273|             toStore.add(rec);
   274|         });
   275|         fromStore.resumeEvents();
   276|         toStore.resumeEvents();
   277|         Ext.suspendLayouts();
   278|         fromField.boundList.refresh();
   279|         toField.boundList.refresh();
   280|         Ext.resumeLayouts(true);
   281|     },
   282|     onBindStore: function(store, initial) {
   283|         var me = this,
   284|             fromField = me.fromField,
   285|             toField = me.toField;
   286|         if (fromField) {
   287|             fromField.store.removeAll();
   288|             toField.store.removeAll();
   289|             if (store.autoCreated) {
   290|                 fromField.resolveDisplayField();
   291|                 toField.resolveDisplayField();
   292|                 me.resolveDisplayField();
   293|             }
   294|             if (!Ext.isDefined(me.valueField)) {
   295|                 me.valueField = me.displayField;
   296|             }
   297|             if (store.getCount()) {
   298|                 me.populateFromStore(store);
   299|             }
   300|             else {
   301|                 me.store.on('load', me.populateFromStore, me);
   302|             }
   303|         }
   304|     },
   305|     populateFromStore: function(store) {
   306|         var fromStore = this.fromField.store;
   307|         this.fromStorePopulated = true;
   308|         fromStore.add(store.getRange());
   309|         fromStore.fireEvent('load', fromStore);
   310|     },
   311|     onEnable: function() {
   312|         var me = this;
   313|         me.callParent();
   314|         me.fromField.enable();
   315|         me.toField.enable();
   316|         Ext.Array.forEach(me.query('[navBtn]'), function(btn) {
   317|             btn.enable();
   318|         });
   319|     },
   320|     onDisable: function() {
   321|         var me = this;
   322|         me.callParent();
   323|         me.fromField.disable();
   324|         me.toField.disable();
   325|         Ext.Array.forEach(me.query('[navBtn]'), function(btn) {
   326|             btn.disable();
   327|         });
   328|     },
   329|     doDestroy: function() {
   330|         this.bindStore(null);
   331|         this.callParent();
   332|     }
   333| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/form/MultiSelect.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-472 ---
     1| /**
     2|  * A control that allows selection of multiple items in a list.
     3|  */
     4| Ext.define('Ext.ux.form.MultiSelect', {
     5|     extend: 'Ext.form.FieldContainer',
     6|     mixins: [
     7|         'Ext.util.StoreHolder',
     8|         'Ext.form.field.Field'
     9|     ],
    10|     alternateClassName: 'Ext.ux.Multiselect',
    11|     alias: ['widget.multiselectfield', 'widget.multiselect'],
    12|     requires: ['Ext.panel.Panel', 'Ext.view.BoundList', 'Ext.layout.container.Fit'],
    13|     uses: ['Ext.view.DragZone', 'Ext.view.DropZone'],
    14|     layout: 'anchor',
    15|     /**
    16|      * @cfg {String} [dragGroup=""] The ddgroup name for the MultiSelect DragZone.
    17|      */
    18|     /**
    19|      * @cfg {String} [dropGroup=""] The ddgroup name for the MultiSelect DropZone.
    20|      */
    21|     /**
    22|      * @cfg {String} [title=""] A title for the underlying panel.
    23|      */
    24|     /**
    25|      * @cfg {Boolean} [ddReorder=false] Whether the items in the MultiSelect list are drag/drop
    26|      * reorderable.
    27|      */
    28|     ddReorder: false,
    29|     /**
    30|      * @cfg {Object/Array} tbar An optional toolbar to be inserted at the top of the control's
    31|      * selection list. This can be a {@link Ext.toolbar.Toolbar} object, a toolbar config,
    32|      * or an array of buttons/button configs to be added to the toolbar.
    33|      * See {@link Ext.panel.Panel#tbar}.
    34|      */
    35|     /**
    36|      * @cfg {String} [appendOnly=false] `true` if the list should only allow append drops
    37|      * when drag/drop is enabled. This is useful for lists which are sorted.
    38|      */
    39|     appendOnly: false,
    40|     /**
    41|      * @cfg {String} [displayField="text"] Name of the desired display field in the dataset.
    42|      */
    43|     displayField: 'text',
    44|     /**
    45|      * @cfg {String} [valueField="text"] Name of the desired value field in the dataset.
    46|      */
    47|     /**
    48|      * @cfg {Boolean} [allowBlank=true] `false` to require at least one item in the list
    49|      * to be selected, `true` to allow no selection.
    50|      */
    51|     allowBlank: true,
    52|     /**
    53|      * @cfg {Number} [minSelections=0] Minimum number of selections allowed.
    54|      */
    55|     minSelections: 0,
    56|     /**
    57|      * @cfg {Number} [maxSelections=Number.MAX_VALUE] Maximum number of selections allowed.
    58|      */
    59|     maxSelections: Number.MAX_VALUE,
    60|     /**
    61|      * @cfg {String} [blankText="This field is required"] Default text displayed when the control
    62|      * contains no items.
    63|      */
    64|     blankText: 'This field is required',
    65|     /**
    66|      * @cfg {String} [minSelectionsText="Minimum {0}item(s) required"] 
    67|      * Validation message displayed when {@link #minSelections} is not met. 
    68|      * The {0} token will be replaced by the value of {@link #minSelections}.
    69|      */
    70|     minSelectionsText: 'Minimum {0} item(s) required',
    71|     /**
    72|      * @cfg {String} [maxSelectionsText="Maximum {0}item(s) allowed"] 
    73|      * Validation message displayed when {@link #maxSelections} is not met
    74|      * The {0} token will be replaced by the value of {@link #maxSelections}.
    75|      */
    76|     maxSelectionsText: 'Maximum {0} item(s) required',
    77|     /**
    78|      * @cfg {String} [delimiter=","] The string used to delimit the selected values when
    79|      * {@link #getSubmitValue submitting} the field as part of a form. If you wish to have
    80|      * the selected values submitted as separate parameters rather than a single
    81|      * delimited parameter, set this to `null`.
    82|      */
    83|     delimiter: ',',
    84|     /**
    85|      * @cfg {String} [dragText="{0} Item{1}"] The text to show while dragging items.
    86|      * {0} will be replaced by the number of items. {1} will be replaced by the plural
    87|      * form if there is more than 1 item.
    88|      */
    89|     dragText: '{0} Item{1}',
    90|     /**
    91|      * @cfg {Ext.data.Store/Array} store The data source to which this MultiSelect is bound
    92|      * (defaults to `undefined`).
    93|      * Acceptable values for this property are:
    94|      * <div class="mdetail-params"><ul>
    95|      * <li><b>any {@link Ext.data.Store Store} subclass</b></li>
    96|      * <li><b>an Array</b> : Arrays will be converted to a {@link Ext.data.ArrayStore} internally.
    97|      * <div class="mdetail-params"><ul>
    98|      * <li><b>1-dimensional array</b> : (e.g., <tt>['Foo','Bar']</tt>)<div class="sub-desc">
    99|      * A 1-dimensional array will automatically be expanded (each array item will be the combo
   100|      * {@link #valueField value} and {@link #displayField text})</div></li>
   101|      * <li><b>2-dimensional array</b> : (e.g., `[['f','Foo'],['b','Bar']]`)<div class="sub-desc">
   102|      * For a multi-dimensional array, the value in index 0 of each item will be assumed to be
   103|      * the combo {@link #valueField value}, while the value at index 1 is assumed to be the combo
   104|      * {@link #displayField text}.
   105|      * </div></li></ul></div></li></ul></div>
   106|      */
   107|     ignoreSelectChange: 0,
   108|     /**
   109|      * @cfg {Object} listConfig
   110|      * An optional set of configuration properties that will be passed to the
   111|      * {@link Ext.view.BoundList}'s constructor. Any configuration that is valid for BoundList
   112|      * can be included.
   113|      */
   114|     /**
   115|      * @cfg {Number} [pageSize=10] The number of items to advance on pageUp and pageDown
   116|      */
   117|     pageSize: 10,
   118|     initComponent: function() {
   119|         var me = this;
   120|         me.items = me.setupItems();
   121|         me.bindStore(me.store, true);
   122|         me.callParent();
   123|         me.initField();
   124|     },
   125|     setupItems: function() {
   126|         var me = this;
   127|         me.boundList = new Ext.view.BoundList(Ext.apply({
   128|             anchor: 'none 100%',
   129|             border: 1,
   130|             multiSelect: true,
   131|             store: me.store,
   132|             displayField: me.displayField,
   133|             disabled: me.disabled,
   134|             tabIndex: 0,
   135|             navigationModel: {
   136|                 type: 'default'
   137|             }
   138|         }, me.listConfig));
   139|         me.boundList.getNavigationModel().addKeyBindings({
   140|             pageUp: me.onKeyPageUp,
   141|             pageDown: me.onKeyPageDown,
   142|             scope: me
   143|         });
   144|         me.boundList.getSelectionModel().on('selectionchange', me.onSelectChange, me);
   145|         me.boundList.pickerField = me;
   146|         if (!me.title) {
   147|             return me.boundList;
   148|         }
   149|         me.boundList.border = false;
   150|         return {
   151|             xtype: 'panel',
   152|             isAriaRegion: false,
   153|             border: true,
   154|             anchor: 'none 100%',
   155|             layout: 'anchor',
   156|             title: me.title,
   157|             tbar: me.tbar,
   158|             items: me.boundList
   159|         };
   160|     },
   161|     onSelectChange: function(selModel, selections) {
   162|         if (!this.ignoreSelectChange) {
   163|             this.setValue(selections);
   164|         }
   165|     },
   166|     getSelected: function() {
   167|         return this.boundList.getSelectionModel().getSelection();
   168|     },
   169|     isEqual: function(v1, v2) {
   170|         var fromArray = Ext.Array.from,
   171|             i = 0,
   172|             len;
   173|         v1 = fromArray(v1);
   174|         v2 = fromArray(v2);
   175|         len = v1.length;
   176|         if (len !== v2.length) {
   177|             return false;
   178|         }
   179|         for (; i < len; i++) {
   180|             if (v2[i] !== v1[i]) {
   181|                 return false;
   182|             }
   183|         }
   184|         return true;
   185|     },
   186|     afterRender: function() {
   187|         var me = this,
   188|             boundList, scrollable, records, panel;
   189|         me.callParent();
   190|         boundList = me.boundList;
   191|         scrollable = boundList && boundList.getScrollable();
   192|         if (me.selectOnRender) {
   193|             records = me.getRecordsForValue(me.value);
   194|             if (records.length) {
   195|                 ++me.ignoreSelectChange;
   196|                 boundList.getSelectionModel().select(records);
   197|                 --me.ignoreSelectChange;
   198|             }
   199|             delete me.toSelect;
   200|         }
   201|         if (me.ddReorder && !me.dragGroup && !me.dropGroup) {
   202|             me.dragGroup = me.dropGroup = 'MultiselectDD-' + Ext.id();
   203|         }
   204|         if (me.draggable || me.dragGroup) {
   205|             me.dragZone = Ext.create('Ext.view.DragZone', {
   206|                 view: boundList,
   207|                 ddGroup: me.dragGroup,
   208|                 dragText: me.dragText,
   209|                 containerScroll: !!scrollable,
   210|                 scrollEl: scrollable && scrollable.getElement()
   211|             });
   212|         }
   213|         if (me.droppable || me.dropGroup) {
   214|             me.dropZone = Ext.create('Ext.view.DropZone', {
   215|                 view: boundList,
   216|                 ddGroup: me.dropGroup,
   217|                 handleNodeDrop: function(data, dropRecord, position) {
   218|                     var view = this.view,
   219|                         store = view.getStore(),
   220|                         records = data.records,
   221|                         index;
   222|                     data.view.store.remove(records);
   223|                     index = store.indexOf(dropRecord);
   224|                     if (position === 'after') {
   225|                         index++;
   226|                     }
   227|                     store.insert(index, records);
   228|                     view.getSelectionModel().select(records);
   229|                     me.fireEvent('drop', me, records);
   230|                 }
   231|             });
   232|         }
   233|         panel = me.down('panel');
   234|         if (panel && boundList) {
   235|             boundList.ariaEl.dom.setAttribute('aria-labelledby', panel.header.id + '-title-textEl');
   236|         }
   237|     },
   238|     onKeyPageUp: function(e) {
   239|         var me = this,
   240|             pageSize = me.pageSize,
   241|             boundList = me.boundList,
   242|             nm = boundList.getNavigationModel(),
   243|             oldIdx, newIdx;
   244|         oldIdx = nm.recordIndex;
   245|         newIdx = oldIdx > pageSize ? oldIdx - pageSize : 0;
   246|         nm.setPosition(newIdx, e);
   247|     },
   248|     onKeyPageDown: function(e) {
   249|         var me = this,
   250|             pageSize = me.pageSize,
   251|             boundList = me.boundList,
   252|             nm = boundList.getNavigationModel(),
   253|             count, oldIdx, newIdx;
   254|         count = boundList.getStore().getCount();
   255|         oldIdx = nm.recordIndex;
   256|         newIdx = oldIdx < (count - pageSize) ? oldIdx + pageSize : count - 1;
   257|         nm.setPosition(newIdx, e);
   258|     },
   259|     isValid: function() {
   260|         var me = this,
   261|             disabled = me.disabled,
   262|             validate = me.forceValidation || !disabled;
   263|         return validate ? me.validateValue(me.value) : disabled;
   264|     },
   265|     validateValue: function(value) {
   266|         var me = this,
   267|             errors = me.getErrors(value),
   268|             isValid = Ext.isEmpty(errors);
   269|         if (!me.preventMark) {
   270|             if (isValid) {
   271|                 me.clearInvalid();
   272|             }
   273|             else {
   274|                 me.markInvalid(errors);
   275|             }
   276|         }
   277|         return isValid;
   278|     },
   279|     markInvalid: function(errors) {
   280|         var me = this,
   281|             oldMsg = me.getActiveError();
   282|         me.setActiveErrors(Ext.Array.from(errors));
   283|         if (oldMsg !== me.getActiveError()) {
   284|             me.updateLayout();
   285|         }
   286|     },
   287|     /**
   288|      * Clear any invalid styles/messages for this field.
   289|      *
   290|      * __Note:__ this method does not cause the Field's {@link #validate} or {@link #isValid}
   291|      * methods to return `true` if the value does not _pass_ validation. So simply clearing
   292|      * a field's errors will not necessarily allow submission of forms submitted with the
   293|      * {@link Ext.form.action.Submit#clientValidation} option set.
   294|      */
   295|     clearInvalid: function() {
   296|         var me = this,
   297|             hadError = me.hasActiveError();
   298|         me.unsetActiveError();
   299|         if (hadError) {
   300|             me.updateLayout();
   301|         }
   302|     },
   303|     getSubmitData: function() {
   304|         var me = this,
   305|             data = null,
   306|             val;
   307|         if (!me.disabled && me.submitValue && !me.isFileUpload()) {
   308|             val = me.getSubmitValue();
   309|             if (val !== null) {
   310|                 data = {};
   311|                 data[me.getName()] = val;
   312|             }
   313|         }
   314|         return data;
   315|     },
   316|     /**
   317|      * Returns the value that would be included in a standard form submit for this field.
   318|      *
   319|      * @return {String} The value to be submitted, or `null`.
   320|      */
   321|     getSubmitValue: function() {
   322|         var me = this,
   323|             delimiter = me.delimiter,
   324|             val = me.getValue();
   325|         return Ext.isString(delimiter) ? val.join(delimiter) : val;
   326|     },
   327|     getValue: function() {
   328|         return this.value || [];
   329|     },
   330|     getRecordsForValue: function(value) {
   331|         var me = this,
   332|             records = [],
   333|             all = me.store.getRange(),
   334|             valueField = me.valueField,
   335|             i = 0,
   336|             allLen = all.length,
   337|             rec,
   338|             j,
   339|             valueLen;
   340|         for (valueLen = value.length; i < valueLen; ++i) {
   341|             for (j = 0; j < allLen; ++j) {
   342|                 rec = all[j];
   343|                 if (rec.get(valueField) === value[i]) {
   344|                     records.push(rec);
   345|                 }
   346|             }
   347|         }
   348|         return records;
   349|     },
   350|     setupValue: function(value) {
   351|         var delimiter = this.delimiter,
   352|             valueField = this.valueField,
   353|             i = 0,
   354|             out,
   355|             len,
   356|             item;
   357|         if (Ext.isDefined(value)) {
   358|             if (delimiter && Ext.isString(value)) {
   359|                 value = value.split(delimiter);
   360|             }
   361|             else if (!Ext.isArray(value)) {
   362|                 value = [value];
   363|             }
   364|             for (len = value.length; i < len; ++i) {
   365|                 item = value[i];
   366|                 if (item && item.isModel) {
   367|                     value[i] = item.get(valueField);
   368|                 }
   369|             }
   370|             out = Ext.Array.unique(value);
   371|         }
   372|         else {
   373|             out = [];
   374|         }
   375|         return out;
   376|     },
   377|     setValue: function(value) {
   378|         var me = this,
   379|             selModel = me.boundList.getSelectionModel(),
   380|             store = me.store;
   381|         if (!store.getCount()) {
   382|             store.on({
   383|                 load: Ext.Function.bind(me.setValue, me, [value]),
   384|                 single: true
   385|             });
   386|             return;
   387|         }
   388|         value = me.setupValue(value);
   389|         me.mixins.field.setValue.call(me, value);
   390|         if (me.rendered) {
   391|             ++me.ignoreSelectChange;
   392|             selModel.deselectAll();
   393|             if (value.length) {
   394|                 selModel.select(me.getRecordsForValue(value));
   395|             }
   396|             --me.ignoreSelectChange;
   397|         }
   398|         else {
   399|             me.selectOnRender = true;
   400|         }
   401|     },
   402|     clearValue: function() {
   403|         this.setValue([]);
   404|     },
   405|     onEnable: function() {
   406|         var list = this.boundList;
   407|         this.callParent();
   408|         if (list) {
   409|             list.enable();
   410|         }
   411|     },
   412|     onDisable: function() {
   413|         var list = this.boundList;
   414|         this.callParent();
   415|         if (list) {
   416|             list.disable();
   417|         }
   418|     },
   419|     getErrors: function(value) {
   420|         var me = this,
   421|             format = Ext.String.format,
   422|             errors = [],
   423|             numSelected;
   424|         value = Ext.Array.from(value || me.getValue());
   425|         numSelected = value.length;
   426|         if (!me.allowBlank && numSelected < 1) {
   427|             errors.push(me.blankText);
   428|         }
   429|         if (numSelected < me.minSelections) {
   430|             errors.push(format(me.minSelectionsText, me.minSelections));
   431|         }
   432|         if (numSelected > me.maxSelections) {
   433|             errors.push(format(me.maxSelectionsText, me.maxSelections));
   434|         }
   435|         return errors;
   436|     },
   437|     doDestroy: function() {
   438|         var me = this;
   439|         me.bindStore(null);
   440|         Ext.destroy(me.dragZone, me.dropZone, me.keyNav);
   441|         me.callParent();
   442|     },
   443|     onBindStore: function(store) {
   444|         var me = this,
   445|             boundList = this.boundList;
   446|         if (store.autoCreated) {
   447|             me.resolveDisplayField();
   448|         }
   449|         if (!Ext.isDefined(me.valueField)) {
   450|             me.valueField = me.displayField;
   451|         }
   452|         if (boundList) {
   453|             boundList.bindStore(store);
   454|         }
   455|     },
   456|     /**
   457|      * Applies auto-created store fields to field and boundlist
   458|      * @private
   459|      */
   460|     resolveDisplayField: function() {
   461|         var me = this,
   462|             boundList = me.boundList,
   463|             store = me.getStore();
   464|         me.valueField = me.displayField = 'field1';
   465|         if (!store.expanded) {
   466|             me.displayField = 'field2';
   467|         }
   468|         if (boundList) {
   469|             boundList.setDisplayField(me.displayField);
   470|         }
   471|     }
   472| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/form/SearchField.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-68 ---
     1| /**
     2|  *
     3|  */
     4| Ext.define('Ext.ux.form.SearchField', {
     5|     extend: 'Ext.form.field.Text',
     6|     alias: 'widget.searchfield',
     7|     triggers: {
     8|         clear: {
     9|             weight: 0,
    10|             cls: Ext.baseCSSPrefix + 'form-clear-trigger',
    11|             hidden: true,
    12|             handler: 'onClearClick',
    13|             scope: 'this'
    14|         },
    15|         search: {
    16|             weight: 1,
    17|             cls: Ext.baseCSSPrefix + 'form-search-trigger',
    18|             handler: 'onSearchClick',
    19|             scope: 'this'
    20|         }
    21|     },
    22|     hasSearch: false,
    23|     paramName: 'query',
    24|     initComponent: function() {
    25|         var me = this,
    26|             store = me.store,
    27|             proxy;
    28|         me.callParent(arguments);
    29|         me.on('specialkey', function(f, e) {
    30|             if (e.getKey() === e.ENTER) {
    31|                 me.onSearchClick();
    32|             }
    33|         });
    34|         if (!store || !store.isStore) {
    35|             store = me.store = Ext.data.StoreManager.lookup(store);
    36|         }
    37|         store.setRemoteFilter(true);
    38|         proxy = me.store.getProxy();
    39|         proxy.setFilterParam(me.paramName);
    40|         proxy.encodeFilters = function(filters) {
    41|             return filters[0].getValue();
    42|         };
    43|     },
    44|     onClearClick: function() {
    45|         var me = this,
    46|             activeFilter = me.activeFilter;
    47|         if (activeFilter) {
    48|             me.setValue('');
    49|             me.store.getFilters().remove(activeFilter);
    50|             me.activeFilter = null;
    51|             me.getTrigger('clear').hide();
    52|             me.updateLayout();
    53|         }
    54|     },
    55|     onSearchClick: function() {
    56|         var me = this,
    57|             value = me.getValue();
    58|         if (value.length > 0) {
    59|             me.activeFilter = new Ext.util.Filter({
    60|                 property: me.paramName,
    61|                 value: value
    62|             });
    63|             me.store.getFilters().add(me.activeFilter);
    64|             me.getTrigger('clear').show();
    65|             me.updateLayout();
    66|         }
    67|     }
    68| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/grid/SubTable.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-99 ---
     1| /**
     2|  * A small grid nested within a parent grid's row. 
     3|  *
     4|  * See the [Kitchen Sink](http://dev.sencha.com/extjs/5.0.1/examples/kitchensink/#customer-grid)
     5|  * for example usage.
     6|  */
     7| Ext.define('Ext.ux.grid.SubTable', {
     8|     extend: 'Ext.grid.plugin.RowExpander',
     9|     alias: 'plugin.subtable',
    10|     /* eslint-disable indent */
    11|     rowBodyTpl: [
    12|         '<table class="' + Ext.baseCSSPrefix + 'grid-subtable">',
    13|             '{%',
    14|                 'this.owner.renderTable(out, values);',
    15|             '%}',
    16|         '</table>'
    17|     ],
    18|     /* eslint-enable indent */
    19|     init: function(grid) {
    20|         var me = this,
    21|             columns = me.columns,
    22|             len, i, columnCfg;
    23|         me.callParent(arguments);
    24|         me.columns = [];
    25|         if (columns) {
    26|             for (i = 0, len = columns.length; i < len; ++i) {
    27|                 columnCfg = Ext.apply({
    28|                     preventRegister: true
    29|                 }, columns[i]);
    30|                 columnCfg.xtype = columnCfg.xtype || 'gridcolumn';
    31|                 me.columns.push(Ext.widget(columnCfg));
    32|             }
    33|         }
    34|     },
    35|     destroy: function() {
    36|         var columns = this.columns,
    37|             len, i;
    38|         if (columns) {
    39|             for (i = 0, len = columns.length; i < len; ++i) {
    40|                 columns[i].destroy();
    41|             }
    42|         }
    43|         this.columns = null;
    44|         this.callParent();
    45|     },
    46|     getRowBodyFeatureData: function(record, idx, rowValues) {
    47|         this.callParent(arguments);
    48|         rowValues.rowBodyCls += ' ' + Ext.baseCSSPrefix + 'grid-subtable-row';
    49|     },
    50|     renderTable: function(out, rowValues) {
    51|         var me = this,
    52|             columns = me.columns,
    53|             numColumns = columns.length,
    54|             associatedRecords = me.getAssociatedRecords(rowValues.record),
    55|             recCount = associatedRecords.length,
    56|             rec, column, i, j, value;
    57|         out.push('<thead>');
    58|         for (j = 0; j < numColumns; j++) {
    59|             out.push(
    60|                 '<th class="' + Ext.baseCSSPrefix + 'grid-subtable-header">',
    61|                 columns[j].text,
    62|                 '</th>'
    63|             );
    64|         }
    65|         out.push('</thead><tbody>');
    66|         for (i = 0; i < recCount; i++) {
    67|             rec = associatedRecords[i];
    68|             out.push('<tr>');
    69|             for (j = 0; j < numColumns; j++) {
    70|                 column = columns[j];
    71|                 value = rec.get(column.dataIndex);
    72|                 if (column.renderer && column.renderer.call) {
    73|                     value = column.renderer.call(column.scope || me, value, {}, rec);
    74|                 }
    75|                 out.push('<td class="' + Ext.baseCSSPrefix + 'grid-subtable-cell"');
    76|                 if (column.width != null) {
    77|                     out.push(' style="width:' + column.width + 'px"');
    78|                 }
    79|                 out.push(
    80|                     '><div class="' + Ext.baseCSSPrefix + 'grid-cell-inner">',
    81|                     value,
    82|                     '</div></td>'
    83|                 );
    84|             }
    85|             out.push('</tr>');
    86|         }
    87|         out.push('</tbody>');
    88|     },
    89|     getRowBodyContentsFn: function(rowBodyTpl) {
    90|         var me = this;
    91|         return function(rowValues) {
    92|             rowBodyTpl.owner = me;
    93|             return rowBodyTpl.applyTemplate(rowValues);
    94|         };
    95|     },
    96|     getAssociatedRecords: function(record) {
    97|         return record[this.association]().getRange();
    98|     }
    99| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/grid/TransformGrid.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-78 ---
     1| /**
     2|  * A Grid which creates itself from an existing HTML table element.
     3|  */
     4| Ext.define('Ext.ux.grid.TransformGrid', {
     5|     extend: 'Ext.grid.Panel',
     6|     /**
     7|      * Creates the grid from HTML table element.
     8|      * @param {String/HTMLElement/Ext.Element} table The table element from which this grid
     9|      * will be created - The table MUST have some type of size defined for the grid to fill.
    10|      * The container will be automatically set to position relative if it isn't already.
    11|      * @param {Object} [config] A config object that sets properties on this grid and has two
    12|      * additional (optional) properties: fields and columns which allow for customizing data fields
    13|      * and columns for this grid.
    14|      */
    15|     constructor: function(table, config) {
    16|         config = Ext.apply({}, config);
    17|         table = this.table = Ext.get(table);
    18|         var configFields = config.fields || [],
    19|             configColumns = config.columns || [],
    20|             fields = [],
    21|             cols = [],
    22|             headers = table.query("thead th"),
    23|             i = 0,
    24|             len = headers.length,
    25|             data = table.dom,
    26|             width, height, col, text, name;
    27|         for (; i < len; ++i) {
    28|             col = headers[i];
    29|             text = col.innerHTML;
    30|             name = 'tcol-' + i;
    31|             fields.push(Ext.applyIf(configFields[i] || {}, {
    32|                 name: name,
    33|                 mapping: 'td:nth(' + (i + 1) + ')/@innerHTML'
    34|             }));
    35|             cols.push(Ext.applyIf(configColumns[i] || {}, {
    36|                 text: text,
    37|                 dataIndex: name,
    38|                 width: col.offsetWidth,
    39|                 tooltip: col.title,
    40|                 sortable: true
    41|             }));
    42|         }
    43|         if (config.width) {
    44|             width = config.width;
    45|         }
    46|         else {
    47|             width = table.getWidth() + 1;
    48|         }
    49|         if (config.height) {
    50|             height = config.height;
    51|         }
    52|         Ext.applyIf(config, {
    53|             store: {
    54|                 data: data,
    55|                 fields: fields,
    56|                 proxy: {
    57|                     type: 'memory',
    58|                     reader: {
    59|                         record: 'tbody tr',
    60|                         type: 'xml'
    61|                     }
    62|                 }
    63|             },
    64|             columns: cols,
    65|             width: width,
    66|             height: height
    67|         });
    68|         this.callParent([config]);
    69|         if (config.remove !== false) {
    70|             data.parentNode.removeChild(data);
    71|         }
    72|     },
    73|     doDestroy: function() {
    74|         this.table.remove();
    75|         this.tabl = null;
    76|         this.callParent();
    77|     }
    78| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/grid/plugin/AutoSelector.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| /**
     2|  * This plugin ensures that its associated grid or tree always has a selection record. The
     3|  * only exception is, of course, when there are no records in the store.
     4|  * @since 6.0.2
     5|  */
     6| Ext.define('Ext.ux.grid.plugin.AutoSelector', {
     7|     extend: 'Ext.plugin.Abstract',
     8|     alias: 'plugin.gridautoselector',
     9|     config: {
    10|         store: null
    11|     },
    12|     init: function(grid) {
    13|         var me = this;
    14|         if (!grid.isXType('tablepanel')) {
    15|             Ext.raise('The gridautoselector plugin is designed only for grids and trees');
    16|         }
    17|         me.grid = grid;
    18|         me.watchGrid();
    19|         grid.on({
    20|             reconfigure: me.watchGrid,
    21|             scope: me
    22|         });
    23|     },
    24|     destroy: function() {
    25|         this.setStore(null);
    26|         this.grid = null;
    27|         this.callParent();
    28|     },
    29|     ensureSelection: function() {
    30|         var grid = this.grid,
    31|             store = grid.getStore(),
    32|             selection;
    33|         if (store.getCount()) {
    34|             selection = grid.getSelection();
    35|             if (!selection || !selection.length) {
    36|                 grid.getSelectionModel().select(0);
    37|             }
    38|         }
    39|     },
    40|     watchGrid: function() {
    41|         this.setStore(this.grid.getStore());
    42|         this.ensureSelection();
    43|     },
    44|     updateStore: function(store) {
    45|         var me = this;
    46|         Ext.destroy(me.storeListeners);
    47|         me.storeListeners = store && store.on({
    48|             add: me.ensureSelection,
    49|             remove: me.ensureSelection,
    50|             destroyable: true,
    51|             scope: me
    52|         });
    53|     }
    54| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/layout/ResponsiveColumn.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-169 ---
     1| /**
     2|  * A simple grid-like layout for proportionally dividing container space and allocating it
     3|  * to each item. All items in this layout are given one or more percentage sizes and CSS
     4|  * `float:left` is used to provide the wrapping.
     5|  *
     6|  * To select which of the percentage sizes an item uses, this layout adds a viewport
     7|  * {@link #states size-dependent} class name to the container. The style sheet must
     8|  * provide the rules to select the desired size using the {@link #responsivecolumn-item}
     9|  * mixin.
    10|  *
    11|  * For example, a panel in a responsive column layout might add the following styles:
    12|  *
    13|  *      .my-panel {
    14|  *          // consume 50% of the available space inside the container by default
    15|  *          @include responsivecolumn-item(50%);
    16|  *
    17|  *          .x-responsivecolumn-small & {
    18|  *              // consume 100% of available space in "small" mode
    19|  *              // (viewport width < 1000 by default)
    20|  *              @include responsivecolumn-item(100%);
    21|  *          }
    22|  *      }
    23|  *
    24|  * Alternatively, instead of targeting specific panels in CSS, you can create reusable
    25|  * classes:
    26|  *
    27|  *      .big-50 {
    28|  *          // consume 50% of the available space inside the container by default
    29|  *          @include responsivecolumn-item(50%);
    30|  *      }
    31|  *
    32|  *      .x-responsivecolumn-small {
    33|  *          > .small-100 {
    34|  *              @include responsivecolumn-item(100%);
    35|  *          }
    36|  *      }
    37|  *
    38|  * These can be added to components in the layout using the `responsiveCls` config:
    39|  *
    40|  *      items: [{
    41|  *          xtype: 'my-panel',
    42|  *
    43|  *          // Use 50% of space when viewport is "big" and 100% when viewport
    44|  *          // is "small":
    45|  *          responsiveCls: 'big-50 small-100'
    46|  *      }]
    47|  *
    48|  * The `responsiveCls` config is provided by this layout to avoid overwriting classes
    49|  * specified using `cls` or other standard configs.
    50|  *
    51|  * Internally, this layout simply uses `float:left` and CSS `calc()` (except on IE8) to
    52|  * "flex" each item. The calculation is always based on a percentage with a spacing taken
    53|  * into account to separate the items from each other.
    54|  */
    55| Ext.define('Ext.ux.layout.ResponsiveColumn', {
    56|     extend: 'Ext.layout.container.Auto',
    57|     alias: 'layout.responsivecolumn',
    58|     /**
    59|      * @cfg {Object} states
    60|      *
    61|      * A set of layout state names corresponding to viewport size thresholds. One of the
    62|      * states will be used to assign the responsive column CSS class to the container to
    63|      * trigger appropriate item sizing.
    64|      *
    65|      * For example:
    66|      *
    67|      *      layout: {
    68|      *          type: 'responsivecolumn',
    69|      *          states: {
    70|      *              small: 800,
    71|      *              medium: 1200,
    72|      *              large: 0
    73|      *          }
    74|      *      }
    75|      *
    76|      * Given the above set of responsive states, one of the following CSS classes will be
    77|      * added to the container:
    78|      *
    79|      *   - `x-responsivecolumn-small` - If the viewport is <= 800px
    80|      *   - `x-responsivecolumn-medium` - If the viewport is > 800px and <= 1200px
    81|      *   - `x-responsivecolumn-large` - If the viewport is > 1200px
    82|      *
    83|      * For sake of efficiency these classes are based on the size of the browser viewport
    84|      * (the browser window) and not on the container size. As the size of the viewport
    85|      * changes, this layout will maintain the appropriate CSS class on the container which
    86|      * will then activate the appropriate CSS rules to size the child items.
    87|      */
    88|     states: {
    89|         small: 1000,
    90|         large: 0
    91|     },
    92|     _responsiveCls: Ext.baseCSSPrefix + 'responsivecolumn',
    93|     initLayout: function() {
    94|         this.innerCtCls += ' ' + this._responsiveCls;
    95|         this.callParent();
    96|     },
    97|     beginLayout: function(ownerContext) {
    98|         var me = this,
    99|             viewportWidth = Ext.Element.getViewportWidth(),
   100|             states = me.states,
   101|             activeThreshold = Infinity,
   102|             innerCt = me.innerCt,
   103|             currentState = me._currentState,
   104|             name, threshold, newState;
   105|         for (name in states) {
   106|             threshold = states[name] || Infinity;
   107|             if (viewportWidth <= threshold && threshold <= activeThreshold) {
   108|                 activeThreshold = threshold;
   109|                 newState = name;
   110|             }
   111|         }
   112|         if (newState !== currentState) {
   113|             innerCt.replaceCls(currentState, newState, me._responsiveCls);
   114|             me._currentState = newState;
   115|         }
   116|         me.callParent(arguments);
   117|     },
   118|     onAdd: function(item) {
   119|         var responsiveCls;
   120|         this.callParent([item]);
   121|         responsiveCls = item.responsiveCls;
   122|         if (responsiveCls) {
   123|             item.addCls(responsiveCls);
   124|         }
   125|     }
   126| }, function(Responsive) {
   127|     if (Ext.isIE8) {
   128|         Responsive.override({
   129|             responsiveSizePolicy: {
   130|                 readsWidth: 0,
   131|                 readsHeight: 0,
   132|                 setsWidth: 1,
   133|                 setsHeight: 0
   134|             },
   135|             setsItemSize: true,
   136|             calculateItems: function(ownerContext, containerSize) {
   137|                 var me = this,
   138|                     targetContext = ownerContext.targetContext,
   139|                     items = ownerContext.childItems,
   140|                     len = items.length,
   141|                     gotWidth = containerSize.gotWidth,
   142|                     contentWidth = containerSize.width,
   143|                     i, itemContext, itemMarginWidth, itemWidth;
   144|                 if (gotWidth === false) {
   145|                     targetContext.domBlock(me, 'width');
   146|                     return false;
   147|                 }
   148|                 if (!gotWidth) {
   149|                     return true;
   150|                 }
   151|                 for (i = 0; i < len; ++i) {
   152|                     itemContext = items[i];
   153|                     itemWidth = parseInt(itemContext.el.getStyle('background-position-x'), 10);
   154|                     itemMarginWidth =
   155|                         parseInt(itemContext.el.getStyle('background-position-y'), 10);
   156|                     itemContext.setWidth(
   157|                         (itemWidth / 100 * (contentWidth - itemMarginWidth)) - itemMarginWidth
   158|                     );
   159|                 }
   160|                 ownerContext.setContentWidth(contentWidth +
   161|                     ownerContext.paddingContext.getPaddingInfo().width);
   162|                 return true;
   163|             },
   164|             getItemSizePolicy: function() {
   165|                 return this.responsiveSizePolicy;
   166|             }
   167|         });
   168|     }
   169| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/statusbar/StatusBar.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-398 ---
     1| /**
     2|  * Basic status bar component that can be used as the bottom toolbar of any {@link Ext.Panel}.
     3|  * In addition to supporting the standard {@link Ext.toolbar.Toolbar} interface for adding buttons,
     4|  * menus and other items, the StatusBar provides a greedy status element that can be aligned
     5|  * to either side and has convenient methods for setting the status text and icon. You can also
     6|  * indicate that something is processing using the {@link #showBusy} method.
     7|  *
     8|  *     Ext.create('Ext.Panel', {
     9|  *         title: 'StatusBar',
    10|  *         // etc.
    11|  *         bbar: Ext.create('Ext.ux.StatusBar', {
    12|  *             id: 'my-status',
    13|  *      
    14|  *             // defaults to use when the status is cleared:
    15|  *             defaultText: 'Default status text',
    16|  *             defaultIconCls: 'default-icon',
    17|  *      
    18|  *             // values to set initially:
    19|  *             text: 'Ready',
    20|  *             iconCls: 'ready-icon',
    21|  *      
    22|  *             // any standard Toolbar items:
    23|  *             items: [{
    24|  *                 text: 'A Button'
    25|  *             }, '-', 'Plain Text']
    26|  *         })
    27|  *     });
    28|  *
    29|  *     // Update the status bar later in code:
    30|  *     var sb = Ext.getCmp('my-status');
    31|  *     sb.setStatus({
    32|  *         text: 'OK',
    33|  *         iconCls: 'ok-icon',
    34|  *         clear: true // auto-clear after a set interval
    35|  *     });
    36|  *
    37|  *     // Set the status bar to show that something is processing:
    38|  *     sb.showBusy();
    39|  *
    40|  *     // processing....
    41|  *
    42|  *     sb.clearStatus(); // once completeed
    43|  *
    44|  */
    45| Ext.define('Ext.ux.statusbar.StatusBar', {
    46|     extend: 'Ext.toolbar.Toolbar',
    47|     xtype: 'statusbar',
    48|     alternateClassName: 'Ext.ux.StatusBar',
    49|     requires: ['Ext.toolbar.TextItem'],
    50|     /**
    51|      * @cfg {String} statusAlign
    52|      * The alignment of the status element within the overall StatusBar layout. When the StatusBar
    53|      * is rendered, it creates an internal div containing the status text and icon. Any additional
    54|      * Toolbar items added in the StatusBar's {@link #cfg-items} config, or added via
    55|      * {@link #method-add} or any of the supported add* methods, will be rendered, in added order,
    56|      * to the opposite side.  The status element is greedy, so it will automatically expand
    57|      * to take up all sapce left over by any other items.  Example usage:
    58|      *
    59|      *     // Create a left-aligned status bar containing a button,
    60|      *     // separator and text item that will be right-aligned (default):
    61|      *     Ext.create('Ext.Panel', {
    62|      *         title: 'StatusBar',
    63|      *         // etc.
    64|      *         bbar: Ext.create('Ext.ux.statusbar.StatusBar', {
    65|      *             defaultText: 'Default status text',
    66|      *             id: 'status-id',
    67|      *             items: [{
    68|      *                 text: 'A Button'
    69|      *             }, '-', 'Plain Text']
    70|      *         })
    71|      *     });
    72|      *
    73|      *     // By adding the statusAlign config, this will create the
    74|      *     // exact same toolbar, except the status and toolbar item
    75|      *     // layout will be reversed from the previous example:
    76|      *     Ext.create('Ext.Panel', {
    77|      *         title: 'StatusBar',
    78|      *         // etc.
    79|      *         bbar: Ext.create('Ext.ux.statusbar.StatusBar', {
    80|      *             defaultText: 'Default status text',
    81|      *             id: 'status-id',
    82|      *             statusAlign: 'right',
    83|      *             items: [{
    84|      *                 text: 'A Button'
    85|      *             }, '-', 'Plain Text']
    86|      *         })
    87|      *     });
    88|      */
    89|     /**
    90|      * @cfg {String} [defaultText='']
    91|      * The default {@link #text} value.  This will be used anytime the status bar is cleared
    92|      * with the `useDefaults:true` option.
    93|      */
    94|     /**
    95|      * @cfg {String} [defaultIconCls='']
    96|      * The default {@link #iconCls} value (see the iconCls docs for additional details about
    97|      * customizing the icon). This will be used anytime the status bar is cleared with the
    98|      * `useDefaults:true` option.
    99|      */
   100|     /**
   101|      * @cfg {String} text
   102|      * A string that will be <b>initially</b> set as the status message.  This string
   103|      * will be set as innerHTML (html tags are accepted) for the toolbar item.
   104|      * If not specified, the value set for {@link #defaultText} will be used.
   105|      */
   106|     /**
   107|      * @cfg [iconCls='']
   108|      * @inheritdoc Ext.panel.Header#cfg-iconCls
   109|      * @localdoc **Note:** This CSS class will be **initially** set as the status bar 
   110|      * icon.  See also {@link #defaultIconCls} and {@link #busyIconCls}.
   111|      *
   112|      * Example usage:
   113|      *
   114|      *     // Example CSS rule:
   115|      *     .x-statusbar .x-status-custom {
   116|      *         padding-left: 25px;
   117|      *         background: transparent url(images/custom-icon.gif) no-repeat 3px 2px;
   118|      *     }
   119|      *
   120|      *     // Setting a default icon:
   121|      *     var sb = Ext.create('Ext.ux.statusbar.StatusBar', {
   122|      *         defaultIconCls: 'x-status-custom'
   123|      *     });
   124|      *
   125|      *     // Changing the icon:
   126|      *     sb.setStatus({
   127|      *         text: 'New status',
   128|      *         iconCls: 'x-status-custom'
   129|      *     });
   130|      */
   131|     /**
   132|      * @cfg {String} cls
   133|      * The base class applied to the containing element for this component on render.
   134|      */
   135|     cls: 'x-statusbar',
   136|     /**
   137|      * @cfg {String} busyIconCls
   138|      * The default {@link #iconCls} applied when calling {@link #showBusy}.
   139|      * It can be overridden at any time by passing the `iconCls` argument into {@link #showBusy}.
   140|      */
   141|     busyIconCls: 'x-status-busy',
   142|     /**
   143|      * @cfg {String} busyText
   144|      * The default {@link #text} applied when calling {@link #showBusy}.
   145|      * It can be overridden at any time by passing the `text` argument into {@link #showBusy}.
   146|      */
   147|     busyText: 'Loading...',
   148|     /**
   149|      * @cfg {Number} autoClear
   150|      * The number of milliseconds to wait after setting the status via
   151|      * {@link #setStatus} before automatically clearing the status text and icon.
   152|      * Note that this only applies when passing the `clear` argument to {@link #setStatus}
   153|      * since that is the only way to defer clearing the status.  This can
   154|      * be overridden by specifying a different `wait` value in {@link #setStatus}.
   155|      * Calls to {@link #clearStatus} always clear the status bar immediately and ignore this value.
   156|      */
   157|     autoClear: 5000,
   158|     /**
   159|      * @cfg {String} emptyText
   160|      * The text string to use if no text has been set. If there are no other items in
   161|      * the toolbar using an empty string (`''`) for this value would end up in the toolbar
   162|      * height collapsing since the empty string will not maintain the toolbar height.
   163|      * Use `''` if the toolbar should collapse in height vertically when no text is
   164|      * specified and there are no other items in the toolbar.
   165|      */
   166|     emptyText: '&#160;',
   167|     /**
   168|      * @private
   169|      */
   170|     activeThreadId: 0,
   171|     initComponent: function() {
   172|         var right = this.statusAlign === 'right';
   173|         this.callParent(arguments);
   174|         this.currIconCls = this.iconCls || this.defaultIconCls;
   175|         this.statusEl = Ext.create('Ext.toolbar.TextItem', {
   176|             cls: 'x-status-text ' + (this.currIconCls || ''),
   177|             text: this.text || this.defaultText || ''
   178|         });
   179|         if (right) {
   180|             this.cls += ' x-status-right';
   181|             this.add('->');
   182|             this.add(this.statusEl);
   183|         }
   184|         else {
   185|             this.insert(0, this.statusEl);
   186|             this.insert(1, '->');
   187|         }
   188|     },
   189|     /**
   190|      * Sets the status {@link #text} and/or {@link #iconCls}. Also supports automatically clearing
   191|      * the status that was set after a specified interval.
   192|      *
   193|      * Example usage:
   194|      *
   195|      *     // Simple call to update the text
   196|      *     statusBar.setStatus('New status');
   197|      *
   198|      *     // Set the status and icon, auto-clearing with default options:
   199|      *     statusBar.setStatus({
   200|      *         text: 'New status',
   201|      *         iconCls: 'x-status-custom',
   202|      *         clear: true
   203|      *     });
   204|      *
   205|      *     // Auto-clear with custom options:
   206|      *     statusBar.setStatus({
   207|      *         text: 'New status',
   208|      *         iconCls: 'x-status-custom',
   209|      *         clear: {
   210|      *             wait: 8000,
   211|      *             anim: false,
   212|      *             useDefaults: false
   213|      *         }
   214|      *     });
   215|      *
   216|      * @param {Object/String} config A config object specifying what status to set, or a string
   217|      * assumed to be the status text (and all other options are defaulted as explained below).
   218|      * A config object containing any or all of the following properties can be passed:
   219|      *
   220|      * @param {String} config.text The status text to display.  If not specified, any current
   221|      * status text will remain unchanged.
   222|      *
   223|      * @param {String} config.iconCls The CSS class used to customize the status icon (see
   224|      * {@link #iconCls} for details). If not specified, any current iconCls will remain unchanged.
   225|      *
   226|      * @param {Boolean/Number/Object} config.clear Allows you to set an internal callback that will
   227|      * automatically clear the status text and iconCls after a specified amount of time has passed.
   228|      * If clear is not specified, the new status will not be auto-cleared and will stay until
   229|      * updated again or cleared using {@link #clearStatus}. If `true` is passed, the status will be
   230|      * cleared using {@link #autoClear}, {@link #defaultText} and {@link #defaultIconCls} via
   231|      * a fade out animation. If a numeric value is passed, it will be used as the callback interval
   232|      * (in milliseconds), overriding the {@link #autoClear} value. All other options will be
   233|      * defaulted as with the boolean option. To customize any other options, you can pass an object
   234|      * in the format:
   235|      * 
   236|      * @param {Number} config.clear.wait The number of milliseconds to wait before clearing
   237|      * (defaults to {@link #autoClear}).
   238|      * @param {Boolean} config.clear.anim False to clear the status immediately once the callback
   239|      * executes (defaults to true which fades the status out).
   240|      * @param {Boolean} config.clear.useDefaults False to completely clear the status text
   241|      * and iconCls (defaults to true which uses {@link #defaultText} and {@link #defaultIconCls}).
   242|      *
   243|      * @return {Ext.ux.statusbar.StatusBar} this
   244|      */
   245|     setStatus: function(config) {
   246|         var me = this,
   247|             c, wait, defaults;
   248|         config = config || {};
   249|         Ext.suspendLayouts();
   250|         if (Ext.isString(config)) {
   251|             config = { text: config };
   252|         }
   253|         if (config.text !== undefined) {
   254|             me.setText(config.text);
   255|         }
   256|         if (config.iconCls !== undefined) {
   257|             me.setIcon(config.iconCls);
   258|         }
   259|         if (config.clear) {
   260|             c = config.clear;
   261|             wait = me.autoClear;
   262|             defaults = { useDefaults: true, anim: true };
   263|             if (Ext.isObject(c)) {
   264|                 c = Ext.applyIf(c, defaults);
   265|                 if (c.wait) {
   266|                     wait = c.wait;
   267|                 }
   268|             }
   269|             else if (Ext.isNumber(c)) {
   270|                 wait = c;
   271|                 c = defaults;
   272|             }
   273|             else if (Ext.isBoolean(c)) {
   274|                 c = defaults;
   275|             }
   276|             c.threadId = this.activeThreadId;
   277|             Ext.defer(me.clearStatus, wait, me, [c]);
   278|         }
   279|         Ext.resumeLayouts(true);
   280|         return me;
   281|     },
   282|     /**
   283|      * Clears the status {@link #text} and {@link #iconCls}. Also supports clearing via an optional
   284|      * fade out animation.
   285|      *
   286|      * @param {Object} [config] A config object containing any or all of the following properties.
   287|      * If this object is not specified the status will be cleared using the defaults below:
   288|      * @param {Boolean} config.anim True to clear the status by fading out the status element
   289|      * (defaults to false which clears immediately).
   290|      * @param {Boolean} config.useDefaults True to reset the text and icon using
   291|      * {@link #defaultText} and {@link #defaultIconCls} (defaults to false which sets the text
   292|      * to '' and removes any existing icon class).
   293|      *
   294|      * @return {Ext.ux.statusbar.StatusBar} this
   295|      */
   296|     clearStatus: function(config) {
   297|         var me = this,
   298|             statusEl = me.statusEl,
   299|             text, iconCls;
   300|         config = config || {};
   301|         if (me.destroyed || config.threadId && config.threadId !== me.activeThreadId) {
   302|             return me;
   303|         }
   304|         text = config.useDefaults ? me.defaultText : me.emptyText;
   305|         iconCls = config.useDefaults ? (me.defaultIconCls ? me.defaultIconCls : '') : '';
   306|         if (config.anim) {
   307|             statusEl.el.puff({
   308|                 remove: false,
   309|                 useDisplay: true,
   310|                 callback: function() {
   311|                     statusEl.el.show();
   312|                     me.setStatus({
   313|                         text: text,
   314|                         iconCls: iconCls
   315|                     });
   316|                 }
   317|             });
   318|         }
   319|         else {
   320|             me.setStatus({
   321|                 text: text,
   322|                 iconCls: iconCls
   323|             });
   324|         }
   325|         return me;
   326|     },
   327|     /**
   328|      * Convenience method for setting the status text directly. For more flexible options see
   329|      * {@link #setStatus}.
   330|      * @param {String} text (optional) The text to set (defaults to '')
   331|      * @return {Ext.ux.statusbar.StatusBar} this
   332|      */
   333|     setText: function(text) {
   334|         var me = this;
   335|         me.activeThreadId++;
   336|         me.text = text || '';
   337|         if (me.rendered) {
   338|             me.statusEl.setText(me.text);
   339|         }
   340|         return me;
   341|     },
   342|     /**
   343|      * Returns the current status text.
   344|      * @return {String} The status text
   345|      */
   346|     getText: function() {
   347|         return this.text;
   348|     },
   349|     /**
   350|      * Convenience method for setting the status icon directly. For more flexible options see
   351|      * {@link #setStatus}.
   352|      * See {@link #iconCls} for complete details about customizing the icon.
   353|      * @param {String} cls (optional) The icon class to set (defaults to '', and any current
   354|      * icon class is removed)
   355|      * @return {Ext.ux.statusbar.StatusBar} this
   356|      */
   357|     setIcon: function(cls) {
   358|         var me = this;
   359|         me.activeThreadId++;
   360|         cls = cls || '';
   361|         if (me.rendered) {
   362|             if (me.currIconCls) {
   363|                 me.statusEl.removeCls(me.currIconCls);
   364|                 me.currIconCls = null;
   365|             }
   366|             if (cls.length > 0) {
   367|                 me.statusEl.addCls(cls);
   368|                 me.currIconCls = cls;
   369|             }
   370|         }
   371|         else {
   372|             me.currIconCls = cls;
   373|         }
   374|         return me;
   375|     },
   376|     /**
   377|      * Convenience method for setting the status text and icon to special values that are
   378|      * pre-configured to indicate a "busy" state, usually for loading or processing activities.
   379|      *
   380|      * @param {Object/String} config (optional) A config object in the same format supported by
   381|      * {@link #setStatus}, or a string to use as the status text (in which case all other options
   382|      * for setStatus will be defaulted). Use the `text` and/or `iconCls` properties on the config
   383|      * to override the default {@link #busyText} and {@link #busyIconCls} settings. If the config
   384|      * argument is not specified, {@link #busyText} and {@link #busyIconCls} will be used
   385|      * in conjunction with all of the default options for {@link #setStatus}.
   386|      * @return {Ext.ux.statusbar.StatusBar} this
   387|      */
   388|     showBusy: function(config) {
   389|         if (Ext.isString(config)) {
   390|             config = { text: config };
   391|         }
   392|         config = Ext.applyIf(config || {}, {
   393|             text: this.busyText,
   394|             iconCls: this.busyIconCls
   395|         });
   396|         return this.setStatus(config);
   397|     }
   398| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/classic/src/statusbar/ValidationStatus.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-222 ---
     1| /**
     2|  * A {@link Ext.ux.statusbar.StatusBar} plugin that provides automatic error
     3|  * notification when the associated form contains validation errors.
     4|  */
     5| Ext.define('Ext.ux.statusbar.ValidationStatus', {
     6|     extend: 'Ext.Component',
     7|     alias: 'plugin.validationstatus',
     8|     requires: ['Ext.util.MixedCollection'],
     9|     /**
    10|      * @cfg {String} errorIconCls
    11|      * The {@link Ext.ux.statusbar.StatusBar#iconCls iconCls} value to be applied
    12|      * to the status message when there is a validation error.
    13|      */
    14|     errorIconCls: 'x-status-error',
    15|     /**
    16|      * @cfg {String} errorListCls
    17|      * The css class to be used for the error list when there are validation errors.
    18|      */
    19|     errorListCls: 'x-status-error-list',
    20|     /**
    21|      * @cfg {String} validIconCls
    22|      * The {@link Ext.ux.statusbar.StatusBar#iconCls iconCls} value to be applied
    23|      * to the status message when the form validates.
    24|      */
    25|     validIconCls: 'x-status-valid',
    26|     /**
    27|      * @cfg {String} showText
    28|      * The {@link Ext.ux.statusbar.StatusBar#text text} value to be applied when
    29|      * there is a form validation error.
    30|      */
    31|     showText: 'The form has errors (click for details...)',
    32|     /**
    33|      * @cfg {String} hideText
    34|      * The {@link Ext.ux.statusbar.StatusBar#text text} value to display when
    35|      * the error list is displayed.
    36|      */
    37|     hideText: 'Click again to hide the error list',
    38|     /**
    39|      * @cfg {String} submitText
    40|      * The {@link Ext.ux.statusbar.StatusBar#text text} value to be applied when
    41|      * the form is being submitted.
    42|      */
    43|     submitText: 'Saving...',
    44|     /**
    45|      * @private
    46|      */
    47|     init: function(sb) {
    48|         var me = this;
    49|         me.statusBar = sb;
    50|         sb.on({
    51|             single: true,
    52|             scope: me,
    53|             render: me.onStatusbarRender
    54|         });
    55|         sb.on({
    56|             click: {
    57|                 element: 'el',
    58|                 fn: me.onStatusClick,
    59|                 scope: me,
    60|                 buffer: 200
    61|             }
    62|         });
    63|     },
    64|     onStatusbarRender: function(sb) {
    65|         var me = this,
    66|             startMonitor = function() {
    67|                 me.monitor = true;
    68|             };
    69|         me.monitor = true;
    70|         me.errors = Ext.create('Ext.util.MixedCollection');
    71|         me.listAlign = (sb.statusAlign === 'right' ? 'br-tr?' : 'bl-tl?');
    72|         if (me.form) {
    73|             me.formPanel = Ext.getCmp(me.form) ||
    74|                            me.statusBar.lookupController().lookupReference(me.form);
    75|             me.basicForm = me.formPanel.getForm();
    76|             me.startMonitoring();
    77|             me.basicForm.on({
    78|                 beforeaction: function(f, action) {
    79|                     if (action.type === 'submit') {
    80|                         me.monitor = false;
    81|                     }
    82|                 }
    83|             });
    84|             me.formPanel.on({
    85|                 beforedestroy: me.destroy,
    86|                 scope: me
    87|             });
    88|             me.basicForm.on('actioncomplete', startMonitor);
    89|             me.basicForm.on('actionfailed', startMonitor);
    90|         }
    91|     },
    92|     /**
    93|      * @private
    94|      */
    95|     startMonitoring: function() {
    96|         this.basicForm.getFields().each(function(f) {
    97|             f.on('validitychange', this.onFieldValidation, this);
    98|         }, this);
    99|     },
   100|     /**
   101|      * @private
   102|      */
   103|     stopMonitoring: function() {
   104|         var form = this.basicForm;
   105|         if (!form.destroyed) {
   106|             form.getFields().each(function(f) {
   107|                 f.un('validitychange', this.onFieldValidation, this);
   108|             }, this);
   109|         }
   110|     },
   111|     doDestroy: function() {
   112|         Ext.destroy(this.msgEl);
   113|         this.stopMonitoring();
   114|         this.statusBar.statusEl.un('click', this.onStatusClick, this);
   115|         this.callParent();
   116|     },
   117|     /**
   118|      * @private
   119|      */
   120|     onFieldValidation: function(f, isValid) {
   121|         var me = this,
   122|             msg;
   123|         if (!me.monitor) {
   124|             return false;
   125|         }
   126|         msg = f.getErrors()[0];
   127|         if (msg) {
   128|             me.errors.add(f.id, { field: f, msg: msg });
   129|         }
   130|         else {
   131|             me.errors.removeAtKey(f.id);
   132|         }
   133|         this.updateErrorList();
   134|         if (me.errors.getCount() > 0) {
   135|             if (me.statusBar.getText() !== me.showText) {
   136|                 me.statusBar.setStatus({
   137|                     text: me.showText,
   138|                     iconCls: me.errorIconCls
   139|                 });
   140|             }
   141|         }
   142|         else {
   143|             me.statusBar.clearStatus().setIcon(me.validIconCls);
   144|         }
   145|     },
   146|     /**
   147|      * @private
   148|      */
   149|     updateErrorList: function() {
   150|         var me = this,
   151|             msg,
   152|             msgEl = me.getMsgEl();
   153|         if (me.errors.getCount() > 0) {
   154|             msg = ['<ul>'];
   155|             this.errors.each(function(err) {
   156|                 msg.push('<li id="x-err-', err.field.id, '"><a href="#">', err.msg, '</a></li>');
   157|             });
   158|             msg.push('</ul>');
   159|             msgEl.update(msg.join(''));
   160|         }
   161|         else {
   162|             msgEl.update('');
   163|         }
   164|         msgEl.setSize('auto', 'auto');
   165|     },
   166|     /**
   167|      * @private
   168|      */
   169|     getMsgEl: function() {
   170|         var me = this,
   171|             msgEl = me.msgEl,
   172|             t;
   173|         if (!msgEl) {
   174|             msgEl = me.msgEl = Ext.DomHelper.append(Ext.getBody(), {
   175|                 cls: me.errorListCls
   176|             }, true);
   177|             msgEl.hide();
   178|             msgEl.on('click', function(e) {
   179|                 t = e.getTarget('li', 10, true);
   180|                 if (t) {
   181|                     Ext.getCmp(t.id.split('x-err-')[1]).focus();
   182|                     me.hideErrors();
   183|                 }
   184|             }, null, { stopEvent: true }); // prevent anchor click navigation
   185|         }
   186|         return msgEl;
   187|     },
   188|     /**
   189|      * @private
   190|      */
   191|     showErrors: function() {
   192|         var me = this;
   193|         me.updateErrorList();
   194|         me.getMsgEl().alignTo(me.statusBar.getEl(), me.listAlign).slideIn(
   195|             'b', { duration: 300, easing: 'easeOut' }
   196|         );
   197|         me.statusBar.setText(me.hideText);
   198|         me.formPanel.body.on('click', me.hideErrors, me, { single: true });
   199|     },
   200|     /**
   201|      * @private
   202|      */
   203|     hideErrors: function() {
   204|         var el = this.getMsgEl();
   205|         if (el.isVisible()) {
   206|             el.slideOut('b', { duration: 300, easing: 'easeIn' });
   207|             this.statusBar.setText(this.showText);
   208|         }
   209|         this.formPanel.body.un('click', this.hideErrors, this);
   210|     },
   211|     /**
   212|      * @private
   213|      */
   214|     onStatusClick: function() {
   215|         if (this.getMsgEl().isVisible()) {
   216|             this.hideErrors();
   217|         }
   218|         else if (this.errors.getCount() > 0) {
   219|             this.showErrors();
   220|         }
   221|     }
   222| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/event/Driver.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-85 ---
     1| /**
     2|  * This is the base class for {@link Ext.ux.event.Recorder} and {@link Ext.ux.event.Player}.
     3|  */
     4| Ext.define('Ext.ux.event.Driver', {
     5|     extend: 'Ext.util.Observable',
     6|     active: null,
     7|     specialKeysByName: {
     8|         PGUP: 33,
     9|         PGDN: 34,
    10|         END: 35,
    11|         HOME: 36,
    12|         LEFT: 37,
    13|         UP: 38,
    14|         RIGHT: 39,
    15|         DOWN: 40
    16|     },
    17|     specialKeysByCode: {
    18|     },
    19|     /**
    20|      * @event start
    21|      * Fires when this object is started.
    22|      * @param {Ext.ux.event.Driver} this
    23|      */
    24|     /**
    25|      * @event stop
    26|      * Fires when this object is stopped.
    27|      * @param {Ext.ux.event.Driver} this
    28|      */
    29|     getTextSelection: function(el) {
    30|         var doc = el.ownerDocument,
    31|             range, range2, start, end;
    32|         if (typeof el.selectionStart === "number") {
    33|             start = el.selectionStart;
    34|             end = el.selectionEnd;
    35|         }
    36|         else if (doc.selection) {
    37|             range = doc.selection.createRange();
    38|             range2 = el.createTextRange();
    39|             range2.setEndPoint('EndToStart', range);
    40|             start = range2.text.length;
    41|             end = start + range.text.length;
    42|         }
    43|         return [ start, end ];
    44|     },
    45|     getTime: function() {
    46|         return new Date().getTime();
    47|     },
    48|     /**
    49|      * Returns the number of milliseconds since start was called.
    50|      */
    51|     getTimestamp: function() {
    52|         var d = this.getTime();
    53|         return d - this.startTime;
    54|     },
    55|     onStart: function() {},
    56|     onStop: function() {},
    57|     /**
    58|      * Starts this object. If this object is already started, nothing happens.
    59|      */
    60|     start: function() {
    61|         var me = this;
    62|         if (!me.active) {
    63|             me.active = new Date();
    64|             me.startTime = me.getTime();
    65|             me.onStart();
    66|             me.fireEvent('start', me);
    67|         }
    68|     },
    69|     /**
    70|      * Stops this object. If this object is not started, nothing happens.
    71|      */
    72|     stop: function() {
    73|         var me = this;
    74|         if (me.active) {
    75|             me.active = null;
    76|             me.onStop();
    77|             me.fireEvent('stop', me);
    78|         }
    79|     }
    80| }, function() {
    81|     var proto = this.prototype;
    82|     Ext.Object.each(proto.specialKeysByName, function(name, value) {
    83|         proto.specialKeysByCode[value] = name;
    84|     });
    85| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/event/Maker.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| /**
     2|  * Event maker.
     3|  */
     4| Ext.define('Ext.ux.event.Maker', {
     5|     eventQueue: [],
     6|     startAfter: 500,
     7|     timerIncrement: 500,
     8|     currentTiming: 0,
     9|     constructor: function(config) {
    10|         var me = this;
    11|         me.currentTiming = me.startAfter;
    12|         if (!Ext.isArray(config)) {
    13|             config = [config];
    14|         }
    15|         Ext.Array.each(config, function(item) {
    16|             item.el = item.el || 'el';
    17|             Ext.Array.each(Ext.ComponentQuery.query(item.cmpQuery), function(cmp) {
    18|                 var event = {},
    19|                     x, y, el;
    20|                 if (!item.domQuery) {
    21|                     el = cmp[item.el];
    22|                 }
    23|                 else {
    24|                     el = cmp.el.down(item.domQuery);
    25|                 }
    26|                 event.target = '#' + el.dom.id;
    27|                 event.type = item.type;
    28|                 event.button = config.button || 0;
    29|                 x = el.getX() + (el.getWidth() / 2);
    30|                 y = el.getY() + (el.getHeight() / 2);
    31|                 event.xy = [x, y];
    32|                 event.ts = me.currentTiming;
    33|                 me.currentTiming += me.timerIncrement;
    34|                 me.eventQueue.push(event);
    35|             });
    36|             if (item.screenshot) {
    37|                 me.eventQueue[me.eventQueue.length - 1].screenshot = true;
    38|             }
    39|         });
    40|         return me.eventQueue;
    41|     }
    42| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/event/Player.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-887 ---
     1| /**
     2|  * @extends Ext.ux.event.Driver
     3|  * This class manages the playback of an array of "event descriptors". For details on the
     4|  * contents of an "event descriptor", see {@link Ext.ux.event.Recorder}. The events recorded by the
     5|  * {@link Ext.ux.event.Recorder} class are designed to serve as input for this class.
     6|  * 
     7|  * The simplest use of this class is to instantiate it with an {@link #eventQueue} and call
     8|  * {@link #method-start}. Like so:
     9|  *
    10|  *      var player = Ext.create('Ext.ux.event.Player', {
    11|  *          eventQueue: [ ... ],
    12|  *          speed: 2,  // play at 2x speed
    13|  *          listeners: {
    14|  *              stop: function() {
    15|  *                  player = null; // all done
    16|  *              }
    17|  *          }
    18|  *      });
    19|  *
    20|  *      player.start();
    21|  *
    22|  * A more complex use would be to incorporate keyframe generation after playing certain
    23|  * events.
    24|  *
    25|  *      var player = Ext.create('Ext.ux.event.Player', {
    26|  *          eventQueue: [ ... ],
    27|  *          keyFrameEvents: {
    28|  *              click: true
    29|  *          },
    30|  *          listeners: {
    31|  *              stop: function() {
    32|  *                  // play has completed... probably time for another keyframe...
    33|  *                  player = null;
    34|  *              },
    35|  *              keyframe: onKeyFrame
    36|  *          }
    37|  *      });
    38|  *
    39|  *      player.start();
    40|  *
    41|  * If a keyframe can be handled immediately (synchronously), the listener would be:
    42|  *
    43|  *      function onKeyFrame () {
    44|  *          handleKeyFrame();
    45|  *      }
    46|  *
    47|  *  If the keyframe event is always handled asynchronously, then the event listener is only
    48|  *  a bit more:
    49|  *
    50|  *      function onKeyFrame (p, eventDescriptor) {
    51|  *          eventDescriptor.defer(); // pause event playback...
    52|  *
    53|  *          handleKeyFrame(function() {
    54|  *              eventDescriptor.finish(); // ...resume event playback
    55|  *          });
    56|  *      }
    57|  *
    58|  * Finally, if the keyframe could be either handled synchronously or asynchronously (perhaps
    59|  * differently by browser), a slightly more complex listener is required.
    60|  *
    61|  *      function onKeyFrame (p, eventDescriptor) {
    62|  *          var async;
    63|  *
    64|  *          handleKeyFrame(function() {
    65|  *              // either this callback is being called immediately by handleKeyFrame (in
    66|  *              // which case async is undefined) or it is being called later (in which case
    67|  *              // async will be true).
    68|  *
    69|  *              if (async) {
    70|  *                  eventDescriptor.finish();
    71|  *              }
    72|  *              else {
    73|  *                  async = false;
    74|  *              }
    75|  *          });
    76|  *
    77|  *          // either the callback was called (and async is now false) or it was not
    78|  *          // called (and async remains undefined).
    79|  *
    80|  *          if (async !== false) {
    81|  *              eventDescriptor.defer();
    82|  *              async = true; // let the callback know that we have gone async
    83|  *          }
    84|  *      }
    85|  */
    86| Ext.define('Ext.ux.event.Player', function(Player) {
    87| /* eslint-disable indent, vars-on-top, one-var */
    88| var defaults = {},
    89|     mouseEvents = {},
    90|     keyEvents = {},
    91|     doc,
    92|     uiEvents = {},
    93|     bubbleEvents = {
    94|         resize: 1,
    95|         reset: 1,
    96|         submit: 1,
    97|         change: 1,
    98|         select: 1,
    99|         error: 1,
   100|         abort: 1
   101|     };
   102| Ext.each([ 'click', 'dblclick', 'mouseover', 'mouseout', 'mousedown', 'mouseup', 'mousemove' ],
   103|     function(type) {
   104|         bubbleEvents[type] = defaults[type] = mouseEvents[type] = {
   105|             bubbles: true,
   106|             cancelable: (type !== "mousemove"), // mousemove cannot be cancelled
   107|             detail: 1,
   108|             screenX: 0,
   109|             screenY: 0,
   110|             clientX: 0,
   111|             clientY: 0,
   112|             ctrlKey: false,
   113|             altKey: false,
   114|             shiftKey: false,
   115|             metaKey: false,
   116|             button: 0
   117|         };
   118|     });
   119| Ext.each([ 'keydown', 'keyup', 'keypress' ],
   120|     function(type) {
   121|         bubbleEvents[type] = defaults[type] = keyEvents[type] = {
   122|             bubbles: true,
   123|             cancelable: true,
   124|             ctrlKey: false,
   125|             altKey: false,
   126|             shiftKey: false,
   127|             metaKey: false,
   128|             keyCode: 0,
   129|             charCode: 0
   130|         };
   131|     });
   132| Ext.each([ 'blur', 'change', 'focus', 'resize', 'scroll', 'select' ],
   133|     function(type) {
   134|         defaults[type] = uiEvents[type] = {
   135|             bubbles: (type in bubbleEvents),
   136|             cancelable: false,
   137|             detail: 1
   138|         };
   139|     });
   140| var inputSpecialKeys = {
   141|         8: function(target, start, end) { // backspace: 8,
   142|             if (start < end) {
   143|                 target.value = target.value.substring(0, start) +
   144|                                target.value.substring(end);
   145|             }
   146|             else if (start > 0) {
   147|                 target.value = target.value.substring(0, --start) +
   148|                                target.value.substring(end);
   149|             }
   150|             this.setTextSelection(target, start, start);
   151|         },
   152|         46: function(target, start, end) { // delete: 46
   153|             if (start < end) {
   154|                 target.value = target.value.substring(0, start) +
   155|                                target.value.substring(end);
   156|             }
   157|             else if (start < target.value.length - 1) {
   158|                 target.value = target.value.substring(0, start) +
   159|                                target.value.substring(start + 1);
   160|             }
   161|             this.setTextSelection(target, start, start);
   162|         }
   163|     };
   164| return {
   165|     extend: 'Ext.ux.event.Driver',
   166|     /**
   167|      * @cfg {Array} eventQueue The event queue to playback. This must be provided before
   168|      * the {@link #method-start} method is called.
   169|      */
   170|     /**
   171|      * @cfg {Object} keyFrameEvents An object that describes the events that should generate
   172|      * keyframe events. For example, `{ click: true }` would generate keyframe events after
   173|      * each `click` event.
   174|      */
   175|     keyFrameEvents: {
   176|         click: true
   177|     },
   178|     /**
   179|      * @cfg {Boolean} pauseForAnimations True to pause event playback during animations, false
   180|      * to ignore animations. Default is true.
   181|      */
   182|     pauseForAnimations: true,
   183|     /**
   184|      * @cfg {Number} speed The playback speed multiplier. Default is 1.0 (to playback at the
   185|      * recorded speed). A value of 2 would playback at 2x speed.
   186|      */
   187|     speed: 1.0,
   188|     stallTime: 0,
   189|     _inputSpecialKeys: {
   190|         INPUT: inputSpecialKeys,
   191|         TEXTAREA: Ext.apply({
   192|         }, inputSpecialKeys)
   193|     },
   194|     tagPathRegEx: /(\w+)(?:\[(\d+)\])?/,
   195|     /**
   196|      * @event beforeplay
   197|      * Fires before an event is played.
   198|      * @param {Ext.ux.event.Player} this
   199|      * @param {Object} eventDescriptor The event descriptor about to be played.
   200|      */
   201|     /**
   202|      * @event keyframe
   203|      * Fires when this player reaches a keyframe. Typically, this is after events
   204|      * like `click` are injected and any resulting animations have been completed.
   205|      * @param {Ext.ux.event.Player} this
   206|      * @param {Object} eventDescriptor The keyframe event descriptor.
   207|      */
   208|     constructor: function(config) {
   209|         var me = this;
   210|         me.callParent(arguments);
   211|         me.timerFn = function() {
   212|             me.onTick();
   213|         };
   214|         me.attachTo = me.attachTo || window;
   215|         doc = me.attachTo.document;
   216|     },
   217|     /**
   218|      * Returns the element given is XPath-like description.
   219|      * @param {String} xpath The XPath-like description of the element.
   220|      * @return {HTMLElement}
   221|      */
   222|     getElementFromXPath: function(xpath) {
   223|         var me = this,
   224|             parts = xpath.split('/'),
   225|             regex = me.tagPathRegEx,
   226|             i, n, m, count, tag, child,
   227|             el = me.attachTo.document;
   228|         el = (parts[0] === '~') ? el.body : el.getElementById(parts[0].substring(1)); // remove '#'
   229|         for (i = 1, n = parts.length; el && i < n; ++i) {
   230|             m = regex.exec(parts[i]);
   231|             count = m[2] ? parseInt(m[2], 10) : 1;
   232|             tag = m[1].toUpperCase();
   233|             for (child = el.firstChild; child; child = child.nextSibling) {
   234|                 if (child.tagName === tag) {
   235|                     if (count === 1) {
   236|                         break;
   237|                     }
   238|                     --count;
   239|                 }
   240|             }
   241|             el = child;
   242|         }
   243|         return el;
   244|     },
   245|     offsetToRangeCharacterMove: function(el, offset) {
   246|         return offset - (el.value.slice(0, offset).split("\r\n").length - 1);
   247|     },
   248|     setTextSelection: function(el, startOffset, endOffset) {
   249|         var range, startCharMove;
   250|         if (startOffset < 0) {
   251|             startOffset += el.value.length;
   252|         }
   253|         if (endOffset == null) {
   254|             endOffset = startOffset;
   255|         }
   256|         if (endOffset < 0) {
   257|             endOffset += el.value.length;
   258|         }
   259|         if (typeof el.selectionStart === "number") {
   260|             el.selectionStart = startOffset;
   261|             el.selectionEnd = endOffset;
   262|         }
   263|         else {
   264|             range = el.createTextRange();
   265|             startCharMove = this.offsetToRangeCharacterMove(el, startOffset);
   266|             range.collapse(true);
   267|             if (startOffset === endOffset) {
   268|                 range.move("character", startCharMove);
   269|             }
   270|             else {
   271|                 range.moveEnd("character", this.offsetToRangeCharacterMove(el, endOffset));
   272|                 range.moveStart("character", startCharMove);
   273|             }
   274|             range.select();
   275|         }
   276|     },
   277|     getTimeIndex: function() {
   278|         var t = this.getTimestamp() - this.stallTime;
   279|         return t * this.speed;
   280|     },
   281|     makeToken: function(eventDescriptor, signal) {
   282|         var me = this,
   283|             t0;
   284|         eventDescriptor[signal] = true;
   285|         eventDescriptor.defer = function() {
   286|             eventDescriptor[signal] = false;
   287|             t0 = me.getTime();
   288|         };
   289|         eventDescriptor.finish = function() {
   290|             eventDescriptor[signal] = true;
   291|             me.stallTime += me.getTime() - t0;
   292|             me.schedule();
   293|         };
   294|     },
   295|     /**
   296|      * This method is called after an event has been played to prepare for the next event.
   297|      * @param {Object} eventDescriptor The descriptor of the event just played.
   298|      */
   299|     nextEvent: function(eventDescriptor) {
   300|         var me = this,
   301|             index = ++me.queueIndex;
   302|         if (me.keyFrameEvents[eventDescriptor.type]) {
   303|             Ext.Array.insert(me.eventQueue, index, [
   304|                 { keyframe: true, ts: eventDescriptor.ts }
   305|             ]);
   306|         }
   307|     },
   308|     /**
   309|      * This method returns the event descriptor at the front of the queue. This does not
   310|      * dequeue the event. Repeated calls return the same object (until {@link #nextEvent}
   311|      * is called).
   312|      */
   313|     peekEvent: function() {
   314|         return this.eventQueue[this.queueIndex] || null;
   315|     },
   316|     /**
   317|      * Replaces an event in the queue with an array of events. This is often used to roll
   318|      * up a multi-step pseudo-event and expand it just-in-time to be played. The process
   319|      * for doing this in a derived class would be this:
   320|      * 
   321|      *      Ext.define('My.Player', {
   322|      *          extend: 'Ext.ux.event.Player',
   323|      *
   324|      *          peekEvent: function() {
   325|      *              var event = this.callParent();
   326|      *
   327|      *              if (event.multiStepSpecial) {
   328|      *                  this.replaceEvent(null, [
   329|      *                      ... expand to actual events
   330|      *                  ]);
   331|      *
   332|      *                  event = this.callParent(); // get the new next event
   333|      *              }
   334|      *
   335|      *              return event;
   336|      *          }
   337|      *      });
   338|      * 
   339|      * This method ensures that the `beforeplay` hook (if any) from the replaced event is
   340|      * placed on the first new event and the `afterplay` hook (if any) is placed on the
   341|      * last new event.
   342|      * 
   343|      * @param {Number} index The queue index to replace. Pass `null` to replace the event
   344|      * at the current `queueIndex`.
   345|      * @param {Event[]} events The array of events with which to replace the specified
   346|      * event.
   347|      */
   348|     replaceEvent: function(index, events) {
   349|         for (var t, i = 0, n = events.length; i < n; ++i) {
   350|             if (i) {
   351|                 t = events[i - 1];
   352|                 delete t.afterplay;
   353|                 delete t.screenshot;
   354|                 delete events[i].beforeplay;
   355|             }
   356|         }
   357|         Ext.Array.replace(this.eventQueue, (index == null) ? this.queueIndex : index, 1, events);
   358|     },
   359|     /**
   360|      * This method dequeues and injects events until it has arrived at the time index. If
   361|      * no events are ready (based on the time index), this method does nothing.
   362|      * @return {Boolean} True if there is more to do; false if not (at least for now).
   363|      */
   364|     processEvents: function() {
   365|         var me = this,
   366|             animations = me.pauseForAnimations && me.attachTo.Ext.fx.Manager.items,
   367|             eventDescriptor;
   368|         while ((eventDescriptor = me.peekEvent()) !== null) {
   369|             if (animations && animations.getCount()) {
   370|                 return true;
   371|             }
   372|             if (eventDescriptor.keyframe) {
   373|                 if (!me.processKeyFrame(eventDescriptor)) {
   374|                     return false;
   375|                 }
   376|                 me.nextEvent(eventDescriptor);
   377|             }
   378|             else if (eventDescriptor.ts <= me.getTimeIndex() &&
   379|                        me.fireEvent('beforeplay', me, eventDescriptor) !== false &&
   380|                        me.playEvent(eventDescriptor)) {
   381|                 me.nextEvent(eventDescriptor);
   382|             }
   383|             else {
   384|                 return true;
   385|             }
   386|         }
   387|         me.stop();
   388|         return false;
   389|     },
   390|     /**
   391|      * This method is called when a keyframe is reached. This will fire the keyframe event.
   392|      * If the keyframe has been handled, true is returned. Otherwise, false is returned.
   393|      * @param {Object} eventDescriptor The event descriptor of the keyframe.
   394|      * @return {Boolean} True if the keyframe was handled, false if not.
   395|      */
   396|     processKeyFrame: function(eventDescriptor) {
   397|         var me = this;
   398|         if (!eventDescriptor.defer) {
   399|             me.makeToken(eventDescriptor, 'done');
   400|             me.fireEvent('keyframe', me, eventDescriptor);
   401|         }
   402|         return eventDescriptor.done;
   403|     },
   404|     /**
   405|      * Called to inject the given event on the specified target.
   406|      * @param {HTMLElement} target The target of the event.
   407|      * @param {Object} event The event to inject. The properties of this object should be
   408|      * those of standard DOM events but vary based on the `type` property. For details on
   409|      * event types and their properties, see the class documentation.
   410|      */
   411|     injectEvent: function(target, event) {
   412|         var me = this,
   413|             type = event.type,
   414|             options = Ext.apply({}, event, defaults[type]),
   415|             handler;
   416|         if (type === 'type') {
   417|             handler = me._inputSpecialKeys[target.tagName];
   418|             if (handler) {
   419|                 return me.injectTypeInputEvent(target, event, handler);
   420|             }
   421|             return me.injectTypeEvent(target, event);
   422|         }
   423|         if (type === 'focus' && target.focus) {
   424|             target.focus();
   425|             return true;
   426|         }
   427|         if (type === 'blur' && target.blur) {
   428|             target.blur();
   429|             return true;
   430|         }
   431|         if (type === 'scroll') {
   432|             target.scrollLeft = event.pos[0];
   433|             target.scrollTop = event.pos[1];
   434|             return true;
   435|         }
   436|         if (type === 'mduclick') {
   437|             return me.injectEvent(target, Ext.applyIf({ type: 'mousedown' }, event)) &&
   438|                    me.injectEvent(target, Ext.applyIf({ type: 'mouseup' }, event)) &&
   439|                    me.injectEvent(target, Ext.applyIf({ type: 'click' }, event));
   440|         }
   441|         if (mouseEvents[type]) {
   442|             return Player.injectMouseEvent(target, options, me.attachTo);
   443|         }
   444|         if (keyEvents[type]) {
   445|             return Player.injectKeyEvent(target, options, me.attachTo);
   446|         }
   447|         if (uiEvents[type]) {
   448|             return Player.injectUIEvent(target, type,
   449|                 options.bubbles,
   450|                 options.cancelable,
   451|                 options.view || me.attachTo,
   452|                 options.detail);
   453|         }
   454|         return false;
   455|     },
   456|     injectTypeEvent: function(target, event) {
   457|         var me = this,
   458|             text = event.text,
   459|             xlat = [],
   460|             ch, chUp, i, n, upper;
   461|         if (text) {
   462|             delete event.text;
   463|             upper = text.toUpperCase();
   464|             for (i = 0, n = text.length; i < n; ++i) {
   465|                 ch = text.charCodeAt(i);
   466|                 chUp = upper.charCodeAt(i);
   467|                 xlat.push(
   468|                     Ext.applyIf({ type: 'keydown', charCode: chUp, keyCode: chUp }, event),
   469|                     Ext.applyIf({ type: 'keypress', charCode: ch, keyCode: ch }, event),
   470|                     Ext.applyIf({ type: 'keyup', charCode: chUp, keyCode: chUp }, event)
   471|                 );
   472|             }
   473|         }
   474|         else {
   475|             xlat.push(
   476|                 Ext.applyIf({ type: 'keydown', charCode: event.keyCode }, event),
   477|                 Ext.applyIf({ type: 'keyup', charCode: event.keyCode }, event)
   478|             );
   479|         }
   480|         for (i = 0, n = xlat.length; i < n; ++i) {
   481|             me.injectEvent(target, xlat[i]);
   482|         }
   483|         return true;
   484|     },
   485|     injectTypeInputEvent: function(target, event, handler) {
   486|         var me = this,
   487|             text = event.text,
   488|             sel, n;
   489|         if (handler) {
   490|             sel = me.getTextSelection(target);
   491|             if (text) {
   492|                 n = sel[0];
   493|                 target.value = target.value.substring(0, n) + text +
   494|                                target.value.substring(sel[1]);
   495|                 n += text.length;
   496|                 me.setTextSelection(target, n, n);
   497|             }
   498|             else {
   499|                 if (!(handler = handler[event.keyCode])) {
   500|                     if ('caret' in event) {
   501|                         me.setTextSelection(target, event.caret, event.caret);
   502|                     }
   503|                     else if (event.selection) {
   504|                         me.setTextSelection(target, event.selection[0], event.selection[1]);
   505|                     }
   506|                     return me.injectTypeEvent(target, event);
   507|                 }
   508|                 handler.call(this, target, sel[0], sel[1]);
   509|                 return true;
   510|             }
   511|         }
   512|         return true;
   513|     },
   514|     playEvent: function(eventDescriptor) {
   515|         var me = this,
   516|             target = me.getElementFromXPath(eventDescriptor.target),
   517|             event;
   518|         if (!target) {
   519|             return false;
   520|         }
   521|         if (!me.playEventHook(eventDescriptor, 'beforeplay')) {
   522|             return false;
   523|         }
   524|         if (!eventDescriptor.injected) {
   525|             eventDescriptor.injected = true;
   526|             event = me.translateEvent(eventDescriptor, target);
   527|             me.injectEvent(target, event);
   528|         }
   529|         return me.playEventHook(eventDescriptor, 'afterplay');
   530|     },
   531|     playEventHook: function(eventDescriptor, hookName) {
   532|         var me = this,
   533|             doneName = hookName + '.done',
   534|             firedName = hookName + '.fired',
   535|             hook = eventDescriptor[hookName];
   536|         if (hook && !eventDescriptor[doneName]) {
   537|             if (!eventDescriptor[firedName]) {
   538|                 eventDescriptor[firedName] = true;
   539|                 me.makeToken(eventDescriptor, doneName);
   540|                 if (me.eventScope && Ext.isString(hook)) {
   541|                     hook = me.eventScope[hook];
   542|                 }
   543|                 if (hook) {
   544|                     hook.call(me.eventScope || me, eventDescriptor);
   545|                 }
   546|             }
   547|             return false;
   548|         }
   549|         return true;
   550|     },
   551|     schedule: function() {
   552|         var me = this;
   553|         if (!me.timer) {
   554|             me.timer = Ext.defer(me.timerFn, 10);
   555|         }
   556|     },
   557|     _translateAcross: [
   558|         'type',
   559|         'button',
   560|         'charCode',
   561|         'keyCode',
   562|         'caret',
   563|         'pos',
   564|         'text',
   565|         'selection'
   566|     ],
   567|     translateEvent: function(eventDescriptor, target) {
   568|         var me = this,
   569|             event = {},
   570|             modKeys = eventDescriptor.modKeys || '',
   571|             names = me._translateAcross,
   572|             i = names.length,
   573|             name, xy;
   574|         while (i--) {
   575|             name = names[i];
   576|             if (name in eventDescriptor) {
   577|                 event[name] = eventDescriptor[name];
   578|             }
   579|         }
   580|         event.altKey = modKeys.indexOf('A') > 0;
   581|         event.ctrlKey = modKeys.indexOf('C') > 0;
   582|         event.metaKey = modKeys.indexOf('M') > 0;
   583|         event.shiftKey = modKeys.indexOf('S') > 0;
   584|         if (target && 'x' in eventDescriptor) {
   585|             xy = Ext.fly(target).getXY();
   586|             xy[0] += eventDescriptor.x;
   587|             xy[1] += eventDescriptor.y;
   588|         }
   589|         else if ('x' in eventDescriptor) {
   590|             xy = [ eventDescriptor.x, eventDescriptor.y ];
   591|         }
   592|         else if ('px' in eventDescriptor) {
   593|             xy = [ eventDescriptor.px, eventDescriptor.py ];
   594|         }
   595|         if (xy) {
   596|             event.clientX = event.screenX = xy[0];
   597|             event.clientY = event.screenY = xy[1];
   598|         }
   599|         if (eventDescriptor.key) {
   600|             event.keyCode = me.specialKeysByName[eventDescriptor.key];
   601|         }
   602|         if (eventDescriptor.type === 'wheel') {
   603|             if ('onwheel' in me.attachTo.document) {
   604|                 event.wheelX = eventDescriptor.dx;
   605|                 event.wheelY = eventDescriptor.dy;
   606|             }
   607|             else {
   608|                 event.type = 'mousewheel';
   609|                 event.wheelDeltaX = -40 * eventDescriptor.dx;
   610|                 event.wheelDeltaY = event.wheelDelta = -40 * eventDescriptor.dy;
   611|             }
   612|         }
   613|         return event;
   614|     },
   615|     onStart: function() {
   616|         var me = this;
   617|         me.queueIndex = 0;
   618|         me.schedule();
   619|     },
   620|     onStop: function() {
   621|         var me = this;
   622|         if (me.timer) {
   623|             Ext.undefer(me.timer);
   624|             me.timer = null;
   625|         }
   626|     },
   627|     onTick: function() {
   628|         var me = this;
   629|         me.timer = null;
   630|         if (me.processEvents()) {
   631|             me.schedule();
   632|         }
   633|     },
   634|     statics: {
   635|         ieButtonCodeMap: {
   636|             0: 1,
   637|             1: 4,
   638|             2: 2
   639|         },
   640|         /**
   641|          * Injects a key event using the given event information to populate the event
   642|          * object.
   643|          * 
   644|          * **Note:** `keydown` causes Safari 2.x to crash.
   645|          * 
   646|          * @param {HTMLElement} target The target of the given event.
   647|          * @param {Object} options Object object containing all of the event injection
   648|          * options.
   649|          * @param {String} options.type The type of event to fire. This can be any one of
   650|          * the following: `keyup`, `keydown` and `keypress`.
   651|          * @param {Boolean} [options.bubbles=true] `tru` if the event can be bubbled up.
   652|          * DOM Level 3 specifies that all key events bubble by default.
   653|          * @param {Boolean} [options.cancelable=true] `true` if the event can be canceled
   654|          * using `preventDefault`. DOM Level 3 specifies that all key events can be
   655|          * cancelled.
   656|          * @param {Boolean} [options.ctrlKey=false] `true` if one of the CTRL keys is
   657|          * pressed while the event is firing.
   658|          * @param {Boolean} [options.altKey=false] `true` if one of the ALT keys is
   659|          * pressed while the event is firing.
   660|          * @param {Boolean} [options.shiftKey=false] `true` if one of the SHIFT keys is
   661|          * pressed while the event is firing.
   662|          * @param {Boolean} [options.metaKey=false] `true` if one of the META keys is
   663|          * pressed while the event is firing.
   664|          * @param {Number} [options.keyCode=0] The code for the key that is in use.
   665|          * @param {Number} [options.charCode=0] The Unicode code for the character 
   666|          * associated with the key being used.
   667|          * @param {Window} [view=window] The view containing the target. This is typically
   668|          * the window object.
   669|          * @private
   670|          */
   671|         injectKeyEvent: function(target, options, view) {
   672|             var type = options.type,
   673|                 customEvent = null;
   674|             if (type === 'textevent') {
   675|                 type = 'keypress';
   676|             }
   677|             view = view || window;
   678|             if (doc.createEvent) {
   679|                 try {
   680|                     customEvent = doc.createEvent("KeyEvents");
   681|                     customEvent.initKeyEvent(type, options.bubbles, options.cancelable,
   682|                             view, options.ctrlKey, options.altKey, options.shiftKey,
   683|                             options.metaKey, options.keyCode, options.charCode);
   684|                 }
   685|                 catch (ex) {
   686|                     try {
   687|                         customEvent = doc.createEvent("Events");
   688|                     }
   689|                     catch (uierror) {
   690|                         customEvent = doc.createEvent("UIEvents");
   691|                     }
   692|                     finally {
   693|                         customEvent.initEvent(type, options.bubbles, options.cancelable);
   694|                         customEvent.view = view;
   695|                         customEvent.altKey = options.altKey;
   696|                         customEvent.ctrlKey = options.ctrlKey;
   697|                         customEvent.shiftKey = options.shiftKey;
   698|                         customEvent.metaKey = options.metaKey;
   699|                         customEvent.keyCode = options.keyCode;
   700|                         customEvent.charCode = options.charCode;
   701|                     }
   702|                 }
   703|                 target.dispatchEvent(customEvent);
   704|             }
   705|             else if (doc.createEventObject) { // IE
   706|                 customEvent = doc.createEventObject();
   707|                 customEvent.bubbles = options.bubbles;
   708|                 customEvent.cancelable = options.cancelable;
   709|                 customEvent.view = view;
   710|                 customEvent.ctrlKey = options.ctrlKey;
   711|                 customEvent.altKey = options.altKey;
   712|                 customEvent.shiftKey = options.shiftKey;
   713|                 customEvent.metaKey = options.metaKey;
   714|                 customEvent.keyCode = (options.charCode > 0) ? options.charCode : options.keyCode;
   715|                 target.fireEvent("on" + type, customEvent);
   716|             }
   717|             else {
   718|                 return false;
   719|             }
   720|             return true;
   721|         },
   722|         /**
   723|          * Injects a mouse event using the given event information to populate the event
   724|          * object.
   725|          *
   726|          * @param {HTMLElement} target The target of the given event.
   727|          * @param {Object} options Object object containing all of the event injection
   728|          * options.
   729|          * @param {String} options.type The type of event to fire. This can be any one of
   730|          * the following: `click`, `dblclick`, `mousedown`, `mouseup`, `mouseout`,
   731|          * `mouseover` and `mousemove`.
   732|          * @param {Boolean} [options.bubbles=true] `tru` if the event can be bubbled up.
   733|          * DOM Level 2 specifies that all mouse events bubble by default.
   734|          * @param {Boolean} [options.cancelable=true] `true` if the event can be canceled
   735|          * using `preventDefault`. DOM Level 2 specifies that all mouse events except
   736|          * `mousemove` can be cancelled. This defaults to `false` for `mousemove`.
   737|          * @param {Boolean} [options.ctrlKey=false] `true` if one of the CTRL keys is
   738|          * pressed while the event is firing.
   739|          * @param {Boolean} [options.altKey=false] `true` if one of the ALT keys is
   740|          * pressed while the event is firing.
   741|          * @param {Boolean} [options.shiftKey=false] `true` if one of the SHIFT keys is
   742|          * pressed while the event is firing.
   743|          * @param {Boolean} [options.metaKey=false] `true` if one of the META keys is
   744|          * pressed while the event is firing.
   745|          * @param {Number} [options.detail=1] The number of times the mouse button has 
   746|          * been used.
   747|          * @param {Number} [options.screenX=0] The x-coordinate on the screen at which point
   748|          * the event occurred.
   749|          * @param {Number} [options.screenY=0] The y-coordinate on the screen at which point
   750|          * the event occurred.
   751|          * @param {Number} [options.clientX=0] The x-coordinate on the client at which point
   752|          * the event occurred.
   753|          * @param {Number} [options.clientY=0] The y-coordinate on the client at which point
   754|          * the event occurred.
   755|          * @param {Number} [options.button=0] The button being pressed while the event is
   756|          * executing. The value should be 0 for the primary mouse button (typically the
   757|          * left button), 1 for the tertiary mouse button (typically the middle button),
   758|          * and 2 for the secondary mouse button (typically the right button).
   759|          * @param {HTMLElement} [options.relatedTarget=null] For `mouseout` events, this
   760|          * is the element that the mouse has moved to. For `mouseover` events, this is
   761|          * the element that the mouse has moved from. This argument is ignored for all
   762|          * other events.
   763|          * @param {Window} [view=window] The view containing the target. This is typically
   764|          * the window object.
   765|          * @private
   766|          */
   767|         injectMouseEvent: function(target, options, view) {
   768|             var type = options.type,
   769|                 customEvent = null;
   770|             view = view || window;
   771|             if (doc.createEvent) {
   772|                 customEvent = doc.createEvent("MouseEvents");
   773|                 if (customEvent.initMouseEvent) {
   774|                     customEvent.initMouseEvent(type, options.bubbles, options.cancelable,
   775|                             view, options.detail, options.screenX, options.screenY,
   776|                             options.clientX, options.clientY, options.ctrlKey,
   777|                             options.altKey, options.shiftKey, options.metaKey,
   778|                             options.button, options.relatedTarget);
   779|                 }
   780|                 else { // Safari
   781|                     customEvent = doc.createEvent("UIEvents");
   782|                     customEvent.initEvent(type, options.bubbles, options.cancelable);
   783|                     customEvent.view = view;
   784|                     customEvent.detail = options.detail;
   785|                     customEvent.screenX = options.screenX;
   786|                     customEvent.screenY = options.screenY;
   787|                     customEvent.clientX = options.clientX;
   788|                     customEvent.clientY = options.clientY;
   789|                     customEvent.ctrlKey = options.ctrlKey;
   790|                     customEvent.altKey = options.altKey;
   791|                     customEvent.metaKey = options.metaKey;
   792|                     customEvent.shiftKey = options.shiftKey;
   793|                     customEvent.button = options.button;
   794|                     customEvent.relatedTarget = options.relatedTarget;
   795|                 }
   796|                 /*
   797|                  * Check to see if relatedTarget has been assigned. Firefox
   798|                  * versions less than 2.0 don't allow it to be assigned via
   799|                  * initMouseEvent() and the property is readonly after event
   800|                  * creation, so in order to keep YAHOO.util.getRelatedTarget()
   801|                  * working, assign to the IE proprietary toElement property
   802|                  * for mouseout event and fromElement property for mouseover
   803|                  * event.
   804|                  */
   805|                 if (options.relatedTarget && !customEvent.relatedTarget) {
   806|                     if (type === "mouseout") {
   807|                         customEvent.toElement = options.relatedTarget;
   808|                     }
   809|                     else if (type === "mouseover") {
   810|                         customEvent.fromElement = options.relatedTarget;
   811|                     }
   812|                 }
   813|                 target.dispatchEvent(customEvent);
   814|             }
   815|             else if (doc.createEventObject) { // IE
   816|                 customEvent = doc.createEventObject();
   817|                 customEvent.bubbles = options.bubbles;
   818|                 customEvent.cancelable = options.cancelable;
   819|                 customEvent.view = view;
   820|                 customEvent.detail = options.detail;
   821|                 customEvent.screenX = options.screenX;
   822|                 customEvent.screenY = options.screenY;
   823|                 customEvent.clientX = options.clientX;
   824|                 customEvent.clientY = options.clientY;
   825|                 customEvent.ctrlKey = options.ctrlKey;
   826|                 customEvent.altKey = options.altKey;
   827|                 customEvent.metaKey = options.metaKey;
   828|                 customEvent.shiftKey = options.shiftKey;
   829|                 customEvent.button = Player.ieButtonCodeMap[options.button] || 0;
   830|                 /*
   831|                  * Have to use relatedTarget because IE won't allow assignment
   832|                  * to toElement or fromElement on generic events. This keeps
   833|                  * YAHOO.util.customEvent.getRelatedTarget() functional.
   834|                  */
   835|                 customEvent.relatedTarget = options.relatedTarget;
   836|                 target.fireEvent('on' + type, customEvent);
   837|             }
   838|             else {
   839|                 return false;
   840|             }
   841|             return true;
   842|         },
   843|         /**
   844|          * Injects a UI event using the given event information to populate the event
   845|          * object.
   846|          * 
   847|          * @param {HTMLElement} target The target of the given event.
   848|          * @param {Object} options
   849|          * @param {String} options.type The type of event to fire. This can be any one of
   850|          * the following: `click`, `dblclick`, `mousedown`, `mouseup`, `mouseout`,
   851|          * `mouseover` and `mousemove`.
   852|          * @param {Boolean} [options.bubbles=true] `tru` if the event can be bubbled up.
   853|          * DOM Level 2 specifies that all mouse events bubble by default.
   854|          * @param {Boolean} [options.cancelable=true] `true` if the event can be canceled
   855|          * using `preventDefault`. DOM Level 2 specifies that all mouse events except
   856|          * `mousemove` can be canceled. This defaults to `false` for `mousemove`.
   857|          * @param {Number} [options.detail=1] The number of times the mouse button has been
   858|          * used.
   859|          * @param {Window} [view=window] The view containing the target. This is typically
   860|          * the window object.
   861|          * @private
   862|          */
   863|         injectUIEvent: function(target, options, view) {
   864|             var customEvent = null;
   865|             view = view || window;
   866|             if (doc.createEvent) {
   867|                 customEvent = doc.createEvent("UIEvents");
   868|                 customEvent.initUIEvent(options.type, options.bubbles, options.cancelable,
   869|                         view, options.detail);
   870|                 target.dispatchEvent(customEvent);
   871|             }
   872|             else if (doc.createEventObject) { // IE
   873|                 customEvent = doc.createEventObject();
   874|                 customEvent.bubbles = options.bubbles;
   875|                 customEvent.cancelable = options.cancelable;
   876|                 customEvent.view = view;
   877|                 customEvent.detail = options.detail;
   878|                 target.fireEvent("on" + options.type, customEvent);
   879|             }
   880|             else {
   881|                 return false;
   882|             }
   883|             return true;
   884|         }
   885|     } // statics
   886| };
   887| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/event/Recorder.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-408 ---
     1| /**
     2|  * @extends Ext.ux.event.Driver
     3|  * Event recorder.
     4|  */
     5| Ext.define('Ext.ux.event.Recorder', function(Recorder) {
     6|     var eventsToRecord, eventKey;
     7|     function apply() {
     8|         var a = arguments,
     9|             n = a.length,
    10|             obj = { kind: 'other' },
    11|             i;
    12|         for (i = 0; i < n; ++i) {
    13|             Ext.apply(obj, arguments[i]);
    14|         }
    15|         if (obj.alt && !obj.event) {
    16|             obj.event = obj.alt;
    17|         }
    18|         return obj;
    19|     }
    20|     function key(extra) {
    21|         return apply({
    22|             kind: 'keyboard',
    23|             modKeys: true,
    24|             key: true
    25|         }, extra);
    26|     }
    27|     function mouse(extra) {
    28|         return apply({
    29|             kind: 'mouse',
    30|             button: true,
    31|             modKeys: true,
    32|             xy: true
    33|         }, extra);
    34|     }
    35|     eventsToRecord = {
    36|         keydown: key(),
    37|         keypress: key(),
    38|         keyup: key(),
    39|         dragmove: mouse({ alt: 'mousemove', pageCoords: true, whileDrag: true }),
    40|         mousemove: mouse({ pageCoords: true }),
    41|         mouseover: mouse(),
    42|         mouseout: mouse(),
    43|         click: mouse(),
    44|         wheel: mouse({ wheel: true }),
    45|         mousedown: mouse({ press: true }),
    46|         mouseup: mouse({ release: true }),
    47|         scroll: apply({ listen: false }),
    48|         focus: apply(),
    49|         blur: apply()
    50|     };
    51|     for (eventKey in eventsToRecord) {
    52|         if (!eventsToRecord[eventKey].event) {
    53|             eventsToRecord[eventKey].event = eventKey;
    54|         }
    55|     }
    56|     eventsToRecord.wheel.event = null; // must detect later
    57|     return {
    58|         extend: 'Ext.ux.event.Driver',
    59|         /**
    60|          * @event add
    61|          * Fires when an event is added to the recording.
    62|          * @param {Ext.ux.event.Recorder} this
    63|          * @param {Object} eventDescriptor The event descriptor.
    64|          */
    65|         /**
    66|          * @event coalesce
    67|          * Fires when an event is coalesced. This edits the tail of the recorded
    68|          * event list.
    69|          * @param {Ext.ux.event.Recorder} this
    70|          * @param {Object} eventDescriptor The event descriptor that was coalesced.
    71|          */
    72|         eventsToRecord: eventsToRecord,
    73|         ignoreIdRegEx: /ext-gen(?:\d+)/,
    74|         inputRe: /^(input|textarea)$/i,
    75|         constructor: function(config) {
    76|             var me = this,
    77|                 events = config && config.eventsToRecord;
    78|             if (events) {
    79|                 me.eventsToRecord = Ext.apply(Ext.apply({}, me.eventsToRecord), // duplicate
    80|                                               events); // and merge
    81|                 delete config.eventsToRecord; // don't smash
    82|             }
    83|             me.callParent(arguments);
    84|             me.clear();
    85|             me.modKeys = [];
    86|             me.attachTo = me.attachTo || window;
    87|         },
    88|         clear: function() {
    89|             this.eventsRecorded = [];
    90|         },
    91|         listenToEvent: function(event) {
    92|             var me = this,
    93|                 el = me.attachTo.document.body,
    94|                 fn = function() {
    95|                     return me.onEvent.apply(me, arguments);
    96|                 },
    97|                 cleaner = {};
    98|             if (el.attachEvent && el.ownerDocument.documentMode < 10) {
    99|                 event = 'on' + event;
   100|                 el.attachEvent(event, fn);
   101|                 cleaner.destroy = function() {
   102|                     if (fn) {
   103|                         el.detachEvent(event, fn);
   104|                         fn = null;
   105|                     }
   106|                 };
   107|             }
   108|             else {
   109|                 el.addEventListener(event, fn, true);
   110|                 cleaner.destroy = function() {
   111|                     if (fn) {
   112|                         el.removeEventListener(event, fn, true);
   113|                         fn = null;
   114|                     }
   115|                 };
   116|             }
   117|             return cleaner;
   118|         },
   119|         coalesce: function(rec, ev) {
   120|             var me = this,
   121|                 events = me.eventsRecorded,
   122|                 length = events.length,
   123|                 tail = length && events[length - 1],
   124|                 tail2 = (length > 1) && events[length - 2],
   125|                 tail3 = (length > 2) && events[length - 3];
   126|             if (!tail) {
   127|                 return false;
   128|             }
   129|             if (rec.type === 'mousemove') {
   130|                 if (tail.type === 'mousemove' && rec.ts - tail.ts < 200) {
   131|                     rec.ts = tail.ts;
   132|                     events[length - 1] = rec;
   133|                     return true;
   134|                 }
   135|             }
   136|             else if (rec.type === 'click') {
   137|                 if (tail2 && tail.type === 'mouseup' && tail2.type === 'mousedown') {
   138|                     if (rec.button === tail.button && rec.button === tail2.button &&
   139|                             rec.target === tail.target && rec.target === tail2.target &&
   140|                             me.samePt(rec, tail) && me.samePt(rec, tail2)) {
   141|                         events.pop(); // remove mouseup
   142|                         tail2.type = 'mduclick';
   143|                         return true;
   144|                     }
   145|                 }
   146|             }
   147|             else if (rec.type === 'keyup') {
   148|                 if (tail2 && tail.type === 'keypress' && tail2.type === 'keydown') {
   149|                     if (rec.target === tail.target && rec.target === tail2.target) {
   150|                         events.pop(); // remove keypress
   151|                         tail2.type = 'type';
   152|                         tail2.text = String.fromCharCode(tail.charCode);
   153|                         delete tail2.charCode;
   154|                         delete tail2.keyCode;
   155|                         if (tail3 && tail3.type === 'type') {
   156|                             if (tail3.text && tail3.target === tail2.target) {
   157|                                 tail3.text += tail2.text;
   158|                                 events.pop();
   159|                             }
   160|                         }
   161|                         return true;
   162|                     }
   163|                 }
   164|                 else if (me.completeKeyStroke(tail, rec)) {
   165|                     tail.type = 'type';
   166|                     me.completeSpecialKeyStroke(ev.target, tail, rec);
   167|                     return true;
   168|                 }
   169|                 else if (tail.type === 'scroll' && me.completeKeyStroke(tail2, rec)) {
   170|                     tail2.type = 'type';
   171|                     me.completeSpecialKeyStroke(ev.target, tail2, rec);
   172|                     events.pop();
   173|                     events.pop();
   174|                     events.push(tail, tail2);
   175|                     return true;
   176|                 }
   177|             }
   178|             return false;
   179|         },
   180|         completeKeyStroke: function(down, up) {
   181|             if (down && down.type === 'keydown' && down.keyCode === up.keyCode) {
   182|                 delete down.charCode;
   183|                 return true;
   184|             }
   185|             return false;
   186|         },
   187|         completeSpecialKeyStroke: function(target, down, up) {
   188|             var key = this.specialKeysByCode[up.keyCode];
   189|             if (key && this.inputRe.test(target.tagName)) {
   190|                 delete down.keyCode;
   191|                 down.key = key;
   192|                 down.selection = this.getTextSelection(target);
   193|                 if (down.selection[0] === down.selection[1]) {
   194|                     down.caret = down.selection[0];
   195|                     delete down.selection;
   196|                 }
   197|                 return true;
   198|             }
   199|             return false;
   200|         },
   201|         getElementXPath: function(el) {
   202|             var me = this,
   203|                 good = false,
   204|                 xpath = [],
   205|                 count,
   206|                 sibling,
   207|                 t,
   208|                 tag;
   209|             for (t = el; t; t = t.parentNode) {
   210|                 if (t === me.attachTo.document.body) {
   211|                     xpath.unshift('~');
   212|                     good = true;
   213|                     break;
   214|                 }
   215|                 if (t.id && !me.ignoreIdRegEx.test(t.id)) {
   216|                     xpath.unshift('#' + t.id);
   217|                     good = true;
   218|                     break;
   219|                 }
   220|                 for (count = 1, sibling = t; !!(sibling = sibling.previousSibling);) {
   221|                     if (sibling.tagName === t.tagName) {
   222|                         ++count;
   223|                     }
   224|                 }
   225|                 tag = t.tagName.toLowerCase();
   226|                 if (count < 2) {
   227|                     xpath.unshift(tag);
   228|                 }
   229|                 else {
   230|                     xpath.unshift(tag + '[' + count + ']');
   231|                 }
   232|             }
   233|             return good ? xpath.join('/') : null;
   234|         },
   235|         getRecordedEvents: function() {
   236|             return this.eventsRecorded;
   237|         },
   238|         onEvent: function(ev) {
   239|             var me = this,
   240|                 e = new Ext.event.Event(ev),
   241|                 info = me.eventsToRecord[e.type],
   242|                 root,
   243|                 modKeys, elXY,
   244|                 rec = {
   245|                     type: e.type,
   246|                     ts: me.getTimestamp(),
   247|                     target: me.getElementXPath(e.target)
   248|                 },
   249|                 xy;
   250|             if (!info || !rec.target) {
   251|                 return;
   252|             }
   253|             root = e.target.ownerDocument;
   254|             root = root.defaultView || root.parentWindow; // Standards || IE
   255|             if (root !== me.attachTo) {
   256|                 return;
   257|             }
   258|             if (me.eventsToRecord.scroll) {
   259|                 me.syncScroll(e.target);
   260|             }
   261|             if (info.xy) {
   262|                 xy = e.getXY();
   263|                 if (info.pageCoords || !rec.target) {
   264|                     rec.px = xy[0];
   265|                     rec.py = xy[1];
   266|                 }
   267|                 else {
   268|                     elXY = Ext.fly(e.getTarget()).getXY();
   269|                     xy[0] -= elXY[0];
   270|                     xy[1] -= elXY[1];
   271|                     rec.x = xy[0];
   272|                     rec.y = xy[1];
   273|                 }
   274|             }
   275|             if (info.button) {
   276|                 if ('buttons' in ev) {
   277|                     rec.button = ev.buttons; // LEFT=1, RIGHT=2, MIDDLE=4, etc.
   278|                 }
   279|                 else {
   280|                     rec.button = ev.button;
   281|                 }
   282|                 if (!rec.button && info.whileDrag) {
   283|                     return;
   284|                 }
   285|             }
   286|             if (info.wheel) {
   287|                 rec.type = 'wheel';
   288|                 if (info.event === 'wheel') {
   289|                     rec.dx = ev.deltaX;
   290|                     rec.dy = ev.deltaY;
   291|                 }
   292|                 else if (typeof ev.wheelDeltaX === 'number') {
   293|                     rec.dx = -1 / 40 * ev.wheelDeltaX;
   294|                     rec.dy = -1 / 40 * ev.wheelDeltaY;
   295|                 }
   296|                 else if (ev.wheelDelta) {
   297|                     rec.dy = -1 / 40 * ev.wheelDelta;
   298|                 }
   299|                 else if (ev.detail) {
   300|                     rec.dy = ev.detail;
   301|                 }
   302|             }
   303|             if (info.modKeys) {
   304|                 me.modKeys[0] = e.altKey ? 'A' : '';
   305|                 me.modKeys[1] = e.ctrlKey ? 'C' : '';
   306|                 me.modKeys[2] = e.metaKey ? 'M' : '';
   307|                 me.modKeys[3] = e.shiftKey ? 'S' : '';
   308|                 modKeys = me.modKeys.join('');
   309|                 if (modKeys) {
   310|                     rec.modKeys = modKeys;
   311|                 }
   312|             }
   313|             if (info.key) {
   314|                 rec.charCode = e.getCharCode();
   315|                 rec.keyCode = e.getKey();
   316|             }
   317|             if (me.coalesce(rec, e)) {
   318|                 me.fireEvent('coalesce', me, rec);
   319|             }
   320|             else {
   321|                 me.eventsRecorded.push(rec);
   322|                 me.fireEvent('add', me, rec);
   323|             }
   324|         },
   325|         onStart: function() {
   326|             var me = this,
   327|                 ddm = me.attachTo.Ext.dd.DragDropManager,
   328|                 evproto = me.attachTo.Ext.EventObjectImpl.prototype,
   329|                 special = [];
   330|             Recorder.prototype.eventsToRecord.wheel.event =
   331|                     ('onwheel' in me.attachTo.document) ? 'wheel' : 'mousewheel';
   332|             me.listeners = [];
   333|             Ext.Object.each(me.eventsToRecord, function(name, value) {
   334|                 if (value && value.listen !== false) {
   335|                     if (!value.event) {
   336|                         value.event = name;
   337|                     }
   338|                     if (value.alt && value.alt !== name) {
   339|                         if (!me.eventsToRecord[value.alt]) {
   340|                             special.push(value);
   341|                         }
   342|                     }
   343|                     else {
   344|                         me.listeners.push(me.listenToEvent(value.event));
   345|                     }
   346|                 }
   347|             });
   348|             Ext.each(special, function(info) {
   349|                 me.eventsToRecord[info.alt] = info;
   350|                 me.listeners.push(me.listenToEvent(info.alt));
   351|             });
   352|             me.ddmStopEvent = ddm.stopEvent;
   353|             ddm.stopEvent = Ext.Function.createSequence(ddm.stopEvent, function(e) {
   354|                 me.onEvent(e);
   355|             });
   356|             me.evStopEvent = evproto.stopEvent;
   357|             evproto.stopEvent = Ext.Function.createSequence(evproto.stopEvent, function() {
   358|                 me.onEvent(this);
   359|             });
   360|         },
   361|         onStop: function() {
   362|             var me = this;
   363|             Ext.destroy(me.listeners);
   364|             me.listeners = null;
   365|             me.attachTo.Ext.dd.DragDropManager.stopEvent = me.ddmStopEvent;
   366|             me.attachTo.Ext.EventObjectImpl.prototype.stopEvent = me.evStopEvent;
   367|         },
   368|         samePt: function(pt1, pt2) {
   369|             return pt1.x === pt2.x && pt1.y === pt2.y;
   370|         },
   371|         syncScroll: function(el) {
   372|             var me = this,
   373|                 ts = me.getTimestamp(),
   374|                 oldX, oldY, x, y, scrolled, rec, p;
   375|             for (p = el; p; p = p.parentNode) {
   376|                 oldX = p.$lastScrollLeft;
   377|                 oldY = p.$lastScrollTop;
   378|                 x = p.scrollLeft;
   379|                 y = p.scrollTop;
   380|                 scrolled = false;
   381|                 if (oldX !== x) {
   382|                     if (x) {
   383|                         scrolled = true;
   384|                     }
   385|                     p.$lastScrollLeft = x;
   386|                 }
   387|                 if (oldY !== y) {
   388|                     if (y) {
   389|                         scrolled = true;
   390|                     }
   391|                     p.$lastScrollTop = y;
   392|                 }
   393|                 if (scrolled) {
   394|                     me.eventsRecorded.push(rec = {
   395|                         type: 'scroll',
   396|                         target: me.getElementXPath(p),
   397|                         ts: ts,
   398|                         pos: [ x, y ]
   399|                     });
   400|                     me.fireEvent('add', me, rec);
   401|                 }
   402|                 if (p.tagName === 'BODY') {
   403|                     break;
   404|                 }
   405|             }
   406|         }
   407|     };
   408| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/gauge/Gauge.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1045 ---
     1| /**
     2|  * Displays a value within the given interval as a gauge. For example:
     3|  *
     4|  *     @example
     5|  *     Ext.create({
     6|  *         xtype: 'panel',
     7|  *         renderTo: document.body,
     8|  *         width: 200,
     9|  *         height: 200,
    10|  *         layout: 'fit',
    11|  *         items: {
    12|  *             xtype: 'gauge',
    13|  *             padding: 20,
    14|  *             value: 55,
    15|  *             minValue: 40,
    16|  *             maxValue: 80
    17|  *         }
    18|  *     });
    19|  *
    20|  * It's also possible to use gauges to create loading indicators:
    21|  *
    22|  *     @example
    23|  *     Ext.create({
    24|  *         xtype: 'panel',
    25|  *         renderTo: document.body,
    26|  *         width: 200,
    27|  *         height: 200,
    28|  *         layout: 'fit',
    29|  *         items: {
    30|  *             xtype: 'gauge',
    31|  *             padding: 20,
    32|  *             trackStart: 0,
    33|  *             trackLength: 360,
    34|  *             value: 20,
    35|  *             valueStyle: {
    36|  *                 round: true
    37|  *             },
    38|  *             textTpl: 'Loading...',
    39|  *             animation: {
    40|  *                 easing: 'linear',
    41|  *                 duration: 100000
    42|  *             }
    43|  *         }
    44|  *     }).items.first().setAngleOffset(360 * 100);
    45|  * 
    46|  * Gauges can contain needles as well.
    47|  * 
    48|  *      @example
    49|  *      Ext.create({
    50|  *         xtype: 'panel',
    51|  *         renderTo: document.body,
    52|  *         width: 200,
    53|  *         height: 200,
    54|  *         layout: 'fit',
    55|  *         items: {
    56|  *             xtype: 'gauge',
    57|  *             padding: 20,
    58|  *             value: 55,
    59|  *             minValue: 40,
    60|  *             maxValue: 80,
    61|  *             needle: 'wedge'
    62|  *         }
    63|  *     });
    64|  * 
    65|  */
    66| Ext.define('Ext.ux.gauge.Gauge', {
    67|     alternateClassName: 'Ext.ux.Gauge',
    68|     extend: 'Ext.Gadget',
    69|     xtype: 'gauge',
    70|     requires: [
    71|         'Ext.ux.gauge.needle.Abstract',
    72|         'Ext.util.Region'
    73|     ],
    74|     config: {
    75|         /**
    76|          * @cfg {Number/String} padding
    77|          * Gauge sector padding in pixels or percent of width/height, whichever is smaller.
    78|          */
    79|         padding: 10,
    80|         /**
    81|          * @cfg {Number} trackStart
    82|          * The angle in the [0, 360) interval at which the gauge's track sector starts.
    83|          * E.g. 0 for 3 o-clock, 90 for 6 o-clock, 180 for 9 o-clock, 270 for noon.
    84|          */
    85|         trackStart: 135,
    86|         /**
    87|          * @cfg {Number} trackLength
    88|          * The angle in the (0, 360] interval to add to the {@link #trackStart} angle
    89|          * to determine the angle at which the track ends.
    90|          */
    91|         trackLength: 270,
    92|         /**
    93|          * @cfg {Number} angleOffset
    94|          * The angle at which the {@link #minValue} starts in case of a circular gauge.
    95|          */
    96|         angleOffset: 0,
    97|         /**
    98|          * @cfg {Number} minValue
    99|          * The minimum value that the gauge can represent.
   100|          */
   101|         minValue: 0,
   102|         /**
   103|          * @cfg {Number} maxValue
   104|          * The maximum value that the gauge can represent.
   105|          */
   106|         maxValue: 100,
   107|         /**
   108|          * @cfg {Number} value
   109|          * The current value of the gauge.
   110|          */
   111|         value: 50,
   112|         /**
   113|          * @cfg {Ext.ux.gauge.needle.Abstract} needle
   114|          * A config object for the needle to be used by the gauge.
   115|          * The needle will track the current {@link #value}.
   116|          * The default needle type is 'diamond', so if a config like
   117|          *
   118|          *     needle: {
   119|          *         outerRadius: '100%'
   120|          *     }
   121|          *
   122|          * is used, the app/view still has to require
   123|          * the `Ext.ux.gauge.needle.Diamond` class.
   124|          * If a type is specified explicitly
   125|          *
   126|          *     needle: {
   127|          *         type: 'arrow'
   128|          *     }
   129|          *
   130|          * it's straightforward which class should be required.
   131|          */
   132|         needle: null,
   133|         needleDefaults: {
   134|             cached: true,
   135|             $value: {
   136|                 type: 'diamond'
   137|             }
   138|         },
   139|         /**
   140|          * @cfg {Boolean} [clockwise=true]
   141|          * `true` - {@link #cfg!value} increments in a clockwise fashion
   142|          * `false` - {@link #cfg!value} increments in an anticlockwise fashion
   143|          */
   144|         clockwise: true,
   145|         /**
   146|          * @cfg {Ext.XTemplate} textTpl
   147|          * The template for the text in the center of the gauge.
   148|          * The available data values are:
   149|          * - `value` - The {@link #cfg!value} of the gauge.
   150|          * - `percent` - The value as a percentage between 0 and 100.
   151|          * - `minValue` - The value of the {@link #cfg!minValue} config.
   152|          * - `maxValue` - The value of the {@link #cfg!maxValue} config.
   153|          * - `delta` - The delta between the {@link #cfg!minValue} and {@link #cfg!maxValue}.
   154|          */
   155|         textTpl: ['<tpl>{value:number("0.00")}%</tpl>'],
   156|         /**
   157|          * @cfg {String} [textAlign='c-c']
   158|          * If the gauge has a donut hole, the text will be centered inside it.
   159|          * Otherwise, the text will be centered in the middle of the gauge's
   160|          * bounding box. This config allows to alter the position of the text
   161|          * in the latter case. See the docs for the `align` option to the
   162|          * {@link Ext.util.Region#alignTo} method for possible ways of alignment
   163|          * of the text to the guage's bounding box.
   164|          */
   165|         textAlign: 'c-c',
   166|         /**
   167|          * @cfg {Object} textOffset
   168|          * This config can be used to displace the {@link #textTpl text} from its default
   169|          * position in the center of the gauge by providing values for horizontal and
   170|          * vertical displacement.
   171|          * @cfg {Number} textOffset.dx Horizontal displacement.
   172|          * @cfg {Number} textOffset.dy Vertical displacement.
   173|          */
   174|         textOffset: {
   175|             dx: 0,
   176|             dy: 0
   177|         },
   178|         /**
   179|          * @cfg {Object} trackStyle
   180|          * Track sector styles.
   181|          * @cfg {String/Object[]} trackStyle.fill Track sector fill color. Defaults to CSS value.
   182|          * It's also possible to have a linear gradient fill that starts at the top-left corner
   183|          * of the gauge and ends at its bottom-right corner, by providing an array of color stop
   184|          * objects. For example:
   185|          *
   186|          *     trackStyle: {
   187|          *         fill: [{
   188|          *             offset: 0,
   189|          *             color: 'green',
   190|          *             opacity: 0.8
   191|          *         }, {
   192|          *             offset: 1,
   193|          *             color: 'gold'
   194|          *         }]
   195|          *     }
   196|          *
   197|          * @cfg {Number} trackStyle.fillOpacity Track sector fill opacity. Defaults to CSS value.
   198|          * @cfg {String} trackStyle.stroke Track sector stroke color. Defaults to CSS value.
   199|          * @cfg {Number} trackStyle.strokeOpacity Track sector stroke opacity.
   200|          * Defaults to CSS value.
   201|          * @cfg {Number} trackStyle.strokeWidth Track sector stroke width. Defaults to CSS value.
   202|          * @cfg {Number/String} [trackStyle.outerRadius='100%'] The outer radius of the track
   203|          * sector.
   204|          * For example:
   205|          *
   206|          *     outerRadius: '90%',      // 90% of the maximum radius
   207|          *     outerRadius: 100,        // radius of 100 pixels
   208|          *     outerRadius: '70% + 5',  // 70% of the maximum radius plus 5 pixels
   209|          *     outerRadius: '80% - 10', // 80% of the maximum radius minus 10 pixels
   210|          *
   211|          * @cfg {Number/String} [trackStyle.innerRadius='50%'] The inner radius of the track sector.
   212|          * See the `trackStyle.outerRadius` config documentation for more information.
   213|          * @cfg {Boolean} [trackStyle.round=false] Whether to round the track sector edges or not.
   214|          */
   215|         trackStyle: {
   216|             outerRadius: '100%',
   217|             innerRadius: '100% - 20',
   218|             round: false
   219|         },
   220|         /**
   221|          * @cfg {Object} valueStyle
   222|          * Value sector styles.
   223|          * @cfg {String/Object[]} valueStyle.fill Value sector fill color. Defaults to CSS value.
   224|          * See the `trackStyle.fill` config documentation for more information.
   225|          * @cfg {Number} valueStyle.fillOpacity Value sector fill opacity. Defaults to CSS value.
   226|          * @cfg {String} valueStyle.stroke Value sector stroke color. Defaults to CSS value.
   227|          * @cfg {Number} valueStyle.strokeOpacity Value sector stroke opacity. Defaults to
   228|          * CSS value.
   229|          * @cfg {Number} valueStyle.strokeWidth Value sector stroke width. Defaults to CSS value.
   230|          * @cfg {Number/String} [valueStyle.outerRadius='100% - 4'] The outer radius of the value
   231|          * sector.
   232|          * See the `trackStyle.outerRadius` config documentation for more information.
   233|          * @cfg {Number/String} [valueStyle.innerRadius='50% + 4'] The inner radius of the value
   234|          * sector.
   235|          * See the `trackStyle.outerRadius` config documentation for more information.
   236|          * @cfg {Boolean} [valueStyle.round=false] Whether to round the value sector edges or not.
   237|          */
   238|         valueStyle: {
   239|             outerRadius: '100% - 2',
   240|             innerRadius: '100% - 18',
   241|             round: false
   242|         },
   243|         /**
   244|          * @cfg {Object/Boolean} [animation=true]
   245|          * The animation applied to the gauge on changes to the {@link #value}
   246|          * and the {@link #angleOffset} configs. Defaults to 1 second animation
   247|          * with the  'out' easing.
   248|          * @cfg {Number} animation.duration The duraction of the animation.
   249|          * @cfg {String} animation.easing The easing function to use for the animation.
   250|          * Possible values are:
   251|          * - `linear` - no easing, no acceleration
   252|          * - `in` - accelerating from zero velocity
   253|          * - `out` - (default) decelerating to zero velocity
   254|          * - `inOut` - acceleration until halfway, then deceleration
   255|          */
   256|         animation: true
   257|     },
   258|     baseCls: Ext.baseCSSPrefix + 'gauge',
   259|     template: [{
   260|         reference: 'bodyElement',
   261|         children: [{
   262|             reference: 'textElement',
   263|             cls: Ext.baseCSSPrefix + 'gauge-text'
   264|         }]
   265|     }],
   266|     defaultBindProperty: 'value',
   267|     pathAttributes: {
   268|         fill: true,
   269|         fillOpacity: true,
   270|         stroke: true,
   271|         strokeOpacity: true,
   272|         strokeWidth: true
   273|     },
   274|     easings: {
   275|         linear: Ext.identityFn,
   276|         'in': function(t) {
   277|             return t * t * t;
   278|         },
   279|         out: function(t) {
   280|             return (--t) * t * t + 1;
   281|         },
   282|         inOut: function(t) {
   283|             return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
   284|         }
   285|     },
   286|     resizeDelay: 0,   // in milliseconds
   287|     resizeTimerId: 0,
   288|     size: null,       // cached size
   289|     svgNS: 'http://www.w3.org/2000/svg',
   290|     svg: null,        // SVG document
   291|     defs: null,       // the `defs` section of the SVG document
   292|     trackArc: null,
   293|     valueArc: null,
   294|     trackGradient: null,
   295|     valueGradient: null,
   296|     fx: null,         // either the `value` or the `angleOffset` animation
   297|     fxValue: 0,       // the actual value rendered/animated
   298|     fxAngleOffset: 0,
   299|     constructor: function(config) {
   300|         var me = this;
   301|         me.fitSectorInRectCache = {
   302|             startAngle: null,
   303|             lengthAngle: null,
   304|             minX: null,
   305|             maxX: null,
   306|             minY: null,
   307|             maxY: null
   308|         };
   309|         me.interpolator = me.createInterpolator();
   310|         me.callParent([config]);
   311|         me.el.on('resize', 'onElementResize', me);
   312|     },
   313|     doDestroy: function() {
   314|         var me = this;
   315|         Ext.undefer(me.resizeTimerId);
   316|         me.el.un('resize', 'onElementResize', me);
   317|         me.stopAnimation();
   318|         me.setNeedle(null);
   319|         me.trackGradient = Ext.destroy(me.trackGradient);
   320|         me.valueGradient = Ext.destroy(me.valueGradient);
   321|         me.defs = Ext.destroy(me.defs);
   322|         me.svg = Ext.destroy(me.svg);
   323|         me.callParent();
   324|     },
   325|     afterComponentLayout: function(width, height, oldWidth, oldHeight) {
   326|         this.callParent([width, height, oldWidth, oldHeight]);
   327|         if (Ext.isIE9) {
   328|             this.handleResize();
   329|         }
   330|     },
   331|     onElementResize: function(element, size) {
   332|         this.handleResize(size);
   333|     },
   334|     handleResize: function(size, instantly) {
   335|         var me = this,
   336|             el = me.element;
   337|         if (!(el && (size = size || el.getSize()) && size.width && size.height)) {
   338|             return;
   339|         }
   340|         me.resizeTimerId = Ext.undefer(me.resizeTimerId);
   341|         if (!instantly && me.resizeDelay) {
   342|             me.resizeTimerId = Ext.defer(me.handleResize, me.resizeDelay, me, [size, true]);
   343|             return;
   344|         }
   345|         me.size = size;
   346|         me.resizeHandler(size);
   347|     },
   348|     updateMinValue: function(minValue) {
   349|         var me = this;
   350|         me.interpolator.setDomain(minValue, me.getMaxValue());
   351|         if (!me.isConfiguring) {
   352|             me.render();
   353|         }
   354|     },
   355|     updateMaxValue: function(maxValue) {
   356|         var me = this;
   357|         me.interpolator.setDomain(me.getMinValue(), maxValue);
   358|         if (!me.isConfiguring) {
   359|             me.render();
   360|         }
   361|     },
   362|     updateAngleOffset: function(angleOffset, oldAngleOffset) {
   363|         var me = this,
   364|             animation = me.getAnimation();
   365|         me.fxAngleOffset = angleOffset;
   366|         if (me.isConfiguring) {
   367|             return;
   368|         }
   369|         if (animation.duration) {
   370|             me.animate(
   371|                 oldAngleOffset, angleOffset,
   372|                 animation.duration, me.easings[animation.easing],
   373|                 function(angleOffset) {
   374|                     me.fxAngleOffset = angleOffset;
   375|                     me.render();
   376|                 }
   377|             );
   378|         }
   379|         else {
   380|             me.render();
   381|         }
   382|     },
   383|     applyTrackStart: function(trackStart) {
   384|         if (trackStart < 0 || trackStart >= 360) {
   385|             Ext.raise("'trackStart' should be within [0, 360).");
   386|         }
   387|         return trackStart;
   388|     },
   389|     applyTrackLength: function(trackLength) {
   390|         if (trackLength <= 0 || trackLength > 360) {
   391|             Ext.raise("'trackLength' should be within (0, 360].");
   392|         }
   393|         return trackLength;
   394|     },
   395|     updateTrackStart: function(trackStart) {
   396|         var me = this;
   397|         if (!me.isConfiguring) {
   398|             me.render();
   399|         }
   400|     },
   401|     updateTrackLength: function(trackLength) {
   402|         var me = this;
   403|         me.interpolator.setRange(0, trackLength);
   404|         if (!me.isConfiguring) {
   405|             me.render();
   406|         }
   407|     },
   408|     applyPadding: function(padding) {
   409|         var ratio;
   410|         if (typeof padding === 'string') {
   411|             ratio = parseFloat(padding) / 100;
   412|             return function(x) {
   413|                 return x * ratio;
   414|             };
   415|         }
   416|         return function() {
   417|             return padding;
   418|         };
   419|     },
   420|     updatePadding: function() {
   421|         if (!this.isConfiguring) {
   422|             this.render();
   423|         }
   424|     },
   425|     applyValue: function(value) {
   426|         var minValue = this.getMinValue(),
   427|             maxValue = this.getMaxValue();
   428|         return Math.min(Math.max(value, minValue), maxValue);
   429|     },
   430|     updateValue: function(value, oldValue) {
   431|         var me = this,
   432|             animation = me.getAnimation();
   433|         me.fxValue = value;
   434|         if (me.isConfiguring) {
   435|             return;
   436|         }
   437|         me.writeText();
   438|         if (animation.duration) {
   439|             me.animate(
   440|                 oldValue, value,
   441|                 animation.duration, me.easings[animation.easing],
   442|                 function(value) {
   443|                     me.fxValue = value;
   444|                     me.render();
   445|                 }
   446|             );
   447|         }
   448|         else {
   449|             me.render();
   450|         }
   451|     },
   452|     applyTextTpl: function(textTpl) {
   453|         if (textTpl && !textTpl.isTemplate) {
   454|             textTpl = new Ext.XTemplate(textTpl);
   455|         }
   456|         return textTpl;
   457|     },
   458|     applyTextOffset: function(offset) {
   459|         offset = offset || {};
   460|         offset.dx = offset.dx || 0;
   461|         offset.dy = offset.dy || 0;
   462|         return offset;
   463|     },
   464|     updateTextTpl: function() {
   465|         this.writeText();
   466|         if (!this.isConfiguring) {
   467|             this.centerText(); // text will be centered on first size
   468|         }
   469|     },
   470|     writeText: function(options) {
   471|         var me = this,
   472|             value = me.getValue(),
   473|             minValue = me.getMinValue(),
   474|             maxValue = me.getMaxValue(),
   475|             delta = maxValue - minValue,
   476|             textTpl = me.getTextTpl();
   477|         textTpl.overwrite(me.textElement, {
   478|             value: value,
   479|             percent: (value - minValue) / delta * 100,
   480|             minValue: minValue,
   481|             maxValue: maxValue,
   482|             delta: delta
   483|         });
   484|     },
   485|     centerText: function(cx, cy, sectorRegion, innerRadius, outerRadius) {
   486|         var textElement = this.textElement,
   487|             textAlign = this.getTextAlign(),
   488|             alignedRegion, textBox;
   489|         if (Ext.Number.isEqual(innerRadius, 0, 0.1) ||
   490|             sectorRegion.isOutOfBound({ x: cx, y: cy })) {
   491|             alignedRegion = textElement.getRegion().alignTo({
   492|                 align: textAlign, // align text region's center to sector region's center
   493|                 target: sectorRegion
   494|             });
   495|             textElement.setLeft(alignedRegion.left);
   496|             textElement.setTop(alignedRegion.top);
   497|         }
   498|         else {
   499|             textBox = textElement.getBox();
   500|             textElement.setLeft(cx - textBox.width / 2);
   501|             textElement.setTop(cy - textBox.height / 2);
   502|         }
   503|     },
   504|     camelCaseRe: /([a-z])([A-Z])/g,
   505|     /**
   506|      * @private
   507|      */
   508|     camelToHyphen: function(name) {
   509|         return name.replace(this.camelCaseRe, '$1-$2').toLowerCase();
   510|     },
   511|     applyTrackStyle: function(trackStyle) {
   512|         var me = this,
   513|             trackGradient;
   514|         trackStyle.innerRadius = me.getRadiusFn(trackStyle.innerRadius);
   515|         trackStyle.outerRadius = me.getRadiusFn(trackStyle.outerRadius);
   516|         if (Ext.isArray(trackStyle.fill)) {
   517|             trackGradient = me.getTrackGradient();
   518|             me.setGradientStops(trackGradient, trackStyle.fill);
   519|             trackStyle.fill = 'url(#' + trackGradient.dom.getAttribute('id') + ')';
   520|         }
   521|         return trackStyle;
   522|     },
   523|     updateTrackStyle: function(trackStyle) {
   524|         var me = this,
   525|             trackArc = Ext.fly(me.getTrackArc()),
   526|             name;
   527|         for (name in trackStyle) {
   528|             if (name in me.pathAttributes) {
   529|                 trackArc.setStyle(me.camelToHyphen(name), trackStyle[name]);
   530|             }
   531|             else {
   532|                 trackArc.setStyle(name, trackStyle[name]);
   533|             }
   534|         }
   535|     },
   536|     applyValueStyle: function(valueStyle) {
   537|         var me = this,
   538|             valueGradient;
   539|         valueStyle.innerRadius = me.getRadiusFn(valueStyle.innerRadius);
   540|         valueStyle.outerRadius = me.getRadiusFn(valueStyle.outerRadius);
   541|         if (Ext.isArray(valueStyle.fill)) {
   542|             valueGradient = me.getValueGradient();
   543|             me.setGradientStops(valueGradient, valueStyle.fill);
   544|             valueStyle.fill = 'url(#' + valueGradient.dom.getAttribute('id') + ')';
   545|         }
   546|         return valueStyle;
   547|     },
   548|     updateValueStyle: function(valueStyle) {
   549|         var me = this,
   550|             valueArc = Ext.fly(me.getValueArc()),
   551|             name;
   552|         for (name in valueStyle) {
   553|             if (name in me.pathAttributes) {
   554|                 valueArc.setStyle(me.camelToHyphen(name), valueStyle[name]);
   555|             }
   556|             else {
   557|                 valueArc.setStyle(name, valueStyle[name]);
   558|             }
   559|         }
   560|     },
   561|     /**
   562|      * @private
   563|      */
   564|     getRadiusFn: function(radius) {
   565|         var result, pos, ratio,
   566|             increment = 0;
   567|         if (Ext.isNumber(radius)) {
   568|             result = function() {
   569|                 return radius;
   570|             };
   571|         }
   572|         else if (Ext.isString(radius)) {
   573|             radius = radius.replace(/ /g, '');
   574|             ratio = parseFloat(radius) / 100;
   575|             pos = radius.search('%'); // E.g. '100% - 4'
   576|             if (pos < radius.length - 1) {
   577|                 increment = parseFloat(radius.substr(pos + 1));
   578|             }
   579|             result = function(radius) {
   580|                 return radius * ratio + increment;
   581|             };
   582|             result.ratio = ratio;
   583|         }
   584|         return result;
   585|     },
   586|     getSvg: function() {
   587|         var me = this,
   588|             svg = me.svg;
   589|         if (!svg) {
   590|             svg = me.svg = Ext.get(document.createElementNS(me.svgNS, 'svg'));
   591|             me.bodyElement.append(svg);
   592|         }
   593|         return svg;
   594|     },
   595|     getTrackArc: function() {
   596|         var me = this,
   597|             trackArc = me.trackArc;
   598|         if (!trackArc) {
   599|             trackArc = me.trackArc = document.createElementNS(me.svgNS, 'path');
   600|             me.getSvg().append(trackArc, true);
   601|             trackArc.setAttribute('class', Ext.baseCSSPrefix + 'gauge-track');
   602|         }
   603|         return trackArc;
   604|     },
   605|     getValueArc: function() {
   606|         var me = this,
   607|             valueArc = me.valueArc;
   608|         me.getTrackArc(); // make sure the track arc is created first for proper draw order
   609|         if (!valueArc) {
   610|             valueArc = me.valueArc = document.createElementNS(me.svgNS, 'path');
   611|             me.getSvg().append(valueArc, true);
   612|             valueArc.setAttribute('class', Ext.baseCSSPrefix + 'gauge-value');
   613|         }
   614|         return valueArc;
   615|     },
   616|     applyNeedle: function(needle, oldNeedle) {
   617|         this.getValueArc();
   618|         return Ext.Factory.gaugeNeedle.update(oldNeedle, needle,
   619|                                               this, 'createNeedle', 'needleDefaults');
   620|     },
   621|     createNeedle: function(config) {
   622|         return Ext.apply({
   623|             gauge: this
   624|         }, config);
   625|     },
   626|     getDefs: function() {
   627|         var me = this,
   628|             defs = me.defs;
   629|         if (!defs) {
   630|             defs = me.defs = Ext.get(document.createElementNS(me.svgNS, 'defs'));
   631|             me.getSvg().appendChild(defs);
   632|         }
   633|         return defs;
   634|     },
   635|     /**
   636|      * @private
   637|      */
   638|     setGradientSize: function(gradient, x1, y1, x2, y2) {
   639|         gradient.setAttribute('x1', x1);
   640|         gradient.setAttribute('y1', y1);
   641|         gradient.setAttribute('x2', x2);
   642|         gradient.setAttribute('y2', y2);
   643|     },
   644|     /**
   645|      * @private
   646|      */
   647|     resizeGradients: function(size) {
   648|         var me = this,
   649|             trackGradient = me.getTrackGradient(),
   650|             valueGradient = me.getValueGradient(),
   651|             x1 = 0,
   652|             y1 = size.height / 2,
   653|             x2 = size.width,
   654|             y2 = size.height / 2;
   655|         me.setGradientSize(trackGradient.dom, x1, y1, x2, y2);
   656|         me.setGradientSize(valueGradient.dom, x1, y1, x2, y2);
   657|     },
   658|     /**
   659|      * @private
   660|      */
   661|     setGradientStops: function(gradient, stops) {
   662|         var ln = stops.length,
   663|             i, stopCfg, stopEl;
   664|         while (gradient.firstChild) {
   665|             gradient.removeChild(gradient.firstChild);
   666|         }
   667|         for (i = 0; i < ln; i++) {
   668|             stopCfg = stops[i];
   669|             stopEl = document.createElementNS(this.svgNS, 'stop');
   670|             gradient.appendChild(stopEl);
   671|             stopEl.setAttribute('offset', stopCfg.offset);
   672|             stopEl.setAttribute('stop-color', stopCfg.color);
   673|             if ('opacity' in stopCfg) {
   674|                 stopEl.setAttribute('stop-opacity', stopCfg.opacity);
   675|             }
   676|         }
   677|     },
   678|     getTrackGradient: function() {
   679|         var me = this,
   680|             trackGradient = me.trackGradient;
   681|         if (!trackGradient) {
   682|             trackGradient = me.trackGradient =
   683|                 Ext.get(document.createElementNS(me.svgNS, 'linearGradient'));
   684|             trackGradient.dom.setAttribute('gradientUnits', 'userSpaceOnUse');
   685|             me.getDefs().appendChild(trackGradient);
   686|             Ext.get(trackGradient); // assign unique ID
   687|         }
   688|         return trackGradient;
   689|     },
   690|     getValueGradient: function() {
   691|         var me = this,
   692|             valueGradient = me.valueGradient;
   693|         if (!valueGradient) {
   694|             valueGradient = me.valueGradient =
   695|                 Ext.get(document.createElementNS(me.svgNS, 'linearGradient'));
   696|             valueGradient.dom.setAttribute('gradientUnits', 'userSpaceOnUse');
   697|             me.getDefs().appendChild(valueGradient);
   698|             Ext.get(valueGradient); // assign unique ID
   699|         }
   700|         return valueGradient;
   701|     },
   702|     getArcPoint: function(centerX, centerY, radius, degrees) {
   703|         var radians = degrees / 180 * Math.PI;
   704|         return [
   705|             centerX + radius * Math.cos(radians),
   706|             centerY + radius * Math.sin(radians)
   707|         ];
   708|     },
   709|     isCircle: function(startAngle, endAngle) {
   710|         return Ext.Number.isEqual(Math.abs(endAngle - startAngle), 360, 0.001);
   711|     },
   712|     getArcPath: function(centerX, centerY, innerRadius, outerRadius, startAngle, endAngle, round) {
   713|         var me = this,
   714|             isCircle = me.isCircle(startAngle, endAngle),
   715|             endAngle = endAngle - 0.01, // eslint-disable-line no-redeclare
   716|             innerStartPoint = me.getArcPoint(centerX, centerY, innerRadius, startAngle),
   717|             innerEndPoint = me.getArcPoint(centerX, centerY, innerRadius, endAngle),
   718|             outerStartPoint = me.getArcPoint(centerX, centerY, outerRadius, startAngle),
   719|             outerEndPoint = me.getArcPoint(centerX, centerY, outerRadius, endAngle),
   720|             large = endAngle - startAngle <= 180 ? 0 : 1,
   721|             path = [
   722|                 'M', innerStartPoint[0], innerStartPoint[1],
   723|                 'A', innerRadius, innerRadius, 0, large, 1, innerEndPoint[0], innerEndPoint[1]
   724|             ],
   725|             capRadius = (outerRadius - innerRadius) / 2;
   726|         if (isCircle) {
   727|             path.push('M', outerEndPoint[0], outerEndPoint[1]);
   728|         }
   729|         else {
   730|             if (round) {
   731|                 path.push('A', capRadius, capRadius, 0, 0, 0, outerEndPoint[0], outerEndPoint[1]);
   732|             }
   733|             else {
   734|                 path.push('L', outerEndPoint[0], outerEndPoint[1]);
   735|             }
   736|         }
   737|         path.push('A', outerRadius, outerRadius, 0, large, 0, outerStartPoint[0],
   738|                   outerStartPoint[1]);
   739|         if (round && !isCircle) {
   740|             path.push('A', capRadius, capRadius, 0, 0, 0, innerStartPoint[0], innerStartPoint[1]);
   741|         }
   742|         path.push('Z');
   743|         return path.join(' ');
   744|     },
   745|     resizeHandler: function(size) {
   746|         var me = this,
   747|             svg = me.getSvg();
   748|         svg.setSize(size);
   749|         me.resizeGradients(size);
   750|         me.render();
   751|     },
   752|     /**
   753|      * @private
   754|      * Creates a linear interpolator function that itself has a few methods:
   755|      * - `setDomain(from, to)`
   756|      * - `setRange(from, to)`
   757|      * - `getDomain` - returns the domain as a [from, to] array
   758|      * - `getRange` - returns the range as a [from, to] array
   759|      * @param {Boolean} [rangeCheck=false]
   760|      * Whether to allow out of bounds values for domain and range.
   761|      * @return {Function} The interpolator function:
   762|      * `interpolator(domainValue, isInvert)`.
   763|      * If the `isInvert` parameter is `true`, the start of domain will correspond
   764|      * to the end of range. This is useful, for example, when you want to render
   765|      * increasing domain values counter-clockwise instead of clockwise.
   766|      */
   767|     createInterpolator: function(rangeCheck) {
   768|         var domainStart = 0,
   769|             domainDelta = 1,
   770|             rangeStart = 0,
   771|             rangeEnd = 1,
   772|             interpolator = function(x, invert) {
   773|                 var t = 0;
   774|                 if (domainDelta) {
   775|                     t = (x - domainStart) / domainDelta;
   776|                     if (rangeCheck) {
   777|                         t = Math.max(0, t);
   778|                         t = Math.min(1, t);
   779|                     }
   780|                     if (invert) {
   781|                         t = 1 - t;
   782|                     }
   783|                 }
   784|                 return (1 - t) * rangeStart + t * rangeEnd;
   785|             };
   786|         interpolator.setDomain = function(a, b) {
   787|             domainStart = a;
   788|             domainDelta = b - a;
   789|             return this;
   790|         };
   791|         interpolator.setRange = function(a, b) {
   792|             rangeStart = a;
   793|             rangeEnd = b;
   794|             return this;
   795|         };
   796|         interpolator.getDomain = function() {
   797|             return [domainStart, domainStart + domainDelta];
   798|         };
   799|         interpolator.getRange = function() {
   800|             return [rangeStart, rangeEnd];
   801|         };
   802|         return interpolator;
   803|     },
   804|     applyAnimation: function(animation) {
   805|         if (true === animation) {
   806|             animation = {};
   807|         }
   808|         else if (false === animation) {
   809|             animation = {
   810|                 duration: 0
   811|             };
   812|         }
   813|         if (!('duration' in animation)) {
   814|             animation.duration = 1000;
   815|         }
   816|         if (!(animation.easing in this.easings)) {
   817|             animation.easing = 'out';
   818|         }
   819|         return animation;
   820|     },
   821|     updateAnimation: function() {
   822|         this.stopAnimation();
   823|     },
   824|     /**
   825|      * @private
   826|      * @param {Number} from
   827|      * @param {Number} to
   828|      * @param {Number} duration
   829|      * @param {Function} easing
   830|      * @param {Function} fn Function to execute on every frame of animation.
   831|      * The function takes a single parameter - the value in the [from, to]
   832|      * range, interpolated based on current time and easing function.
   833|      * With certain easings, the value may overshoot the range slighly.
   834|      * @param {Object} scope
   835|      */
   836|     animate: function(from, to, duration, easing, fn, scope) {
   837|         var me = this,
   838|             start = Ext.now(),
   839|             interpolator = me.createInterpolator().setRange(from, to);
   840|         function frame() {
   841|             var now = Ext.AnimationQueue.frameStartTime,
   842|                 t = Math.min(now - start, duration) / duration,
   843|                 value = interpolator(easing(t));
   844|             if (scope) {
   845|                 if (typeof fn === 'string') {
   846|                     scope[fn].call(scope, value);
   847|                 }
   848|                 else {
   849|                     fn.call(scope, value);
   850|                 }
   851|             }
   852|             else {
   853|                 fn(value);
   854|             }
   855|             if (t >= 1) {
   856|                 Ext.AnimationQueue.stop(frame, scope);
   857|                 me.fx = null;
   858|             }
   859|         }
   860|         me.stopAnimation();
   861|         Ext.AnimationQueue.start(frame, scope);
   862|         me.fx = {
   863|             frame: frame,
   864|             scope: scope
   865|         };
   866|     },
   867|     /**
   868|      * Stops the current {@link #value} or {@link #angleOffset} animation.
   869|      */
   870|     stopAnimation: function() {
   871|         var me = this;
   872|         if (me.fx) {
   873|             Ext.AnimationQueue.stop(me.fx.frame, me.fx.scope);
   874|             me.fx = null;
   875|         }
   876|     },
   877|     unitCircleExtrema: {
   878|         0: [1, 0],
   879|         90: [0, 1],
   880|         180: [-1, 0],
   881|         270: [0, -1],
   882|         360: [1, 0],
   883|         450: [0, 1],
   884|         540: [-1, 0],
   885|         630: [0, -1]
   886|     },
   887|     /**
   888|      * @private
   889|      */
   890|     getUnitSectorExtrema: function(startAngle, lengthAngle) {
   891|         var extrema = this.unitCircleExtrema,
   892|             points = [],
   893|             angle;
   894|         for (angle in extrema) {
   895|             if (angle > startAngle && angle < startAngle + lengthAngle) {
   896|                 points.push(extrema[angle]);
   897|             }
   898|         }
   899|         return points;
   900|     },
   901|     /**
   902|      * @private
   903|      * Given a rect with a known width and height, find the maximum radius of the donut
   904|      * sector that can fit into it, as well as the center point of such a sector.
   905|      * The end and start angles of the sector are also known, as well as the relationship
   906|      * between the inner and outer radii.
   907|      */
   908|     fitSectorInRect: function(width, height, startAngle, lengthAngle, ratio) {
   909|         if (Ext.Number.isEqual(lengthAngle, 360, 0.001)) {
   910|             return {
   911|                 cx: width / 2,
   912|                 cy: height / 2,
   913|                 radius: Math.min(width, height) / 2,
   914|                 region: new Ext.util.Region(0, width, height, 0)
   915|             };
   916|         }
   917|         var me = this,
   918|             points, xx, yy, minX, maxX, minY, maxY,
   919|             cache = me.fitSectorInRectCache,
   920|             sameAngles = cache.startAngle === startAngle && cache.lengthAngle === lengthAngle;
   921|         if (sameAngles) {
   922|             minX = cache.minX;
   923|             maxX = cache.maxX;
   924|             minY = cache.minY;
   925|             maxY = cache.maxY;
   926|         }
   927|         else {
   928|             points = me.getUnitSectorExtrema(startAngle, lengthAngle).concat([
   929|                 me.getArcPoint(0, 0, 1, startAngle),
   930|                 me.getArcPoint(0, 0, ratio, startAngle),
   931|                 me.getArcPoint(0, 0, 1, startAngle + lengthAngle),
   932|                 me.getArcPoint(0, 0, ratio, startAngle + lengthAngle)
   933|             ]);
   934|             xx = points.map(function(point) {
   935|                 return point[0];
   936|             });
   937|             yy = points.map(function(point) {
   938|                 return point[1];
   939|             });
   940|             minX = Math.min.apply(null, xx);
   941|             maxX = Math.max.apply(null, xx);
   942|             minY = Math.min.apply(null, yy);
   943|             maxY = Math.max.apply(null, yy);
   944|             cache.startAngle = startAngle;
   945|             cache.lengthAngle = lengthAngle;
   946|             cache.minX = minX;
   947|             cache.maxX = maxX;
   948|             cache.minY = minY;
   949|             cache.maxY = maxY;
   950|         }
   951|         var sectorWidth = maxX - minX,
   952|             sectorHeight = maxY - minY,
   953|             scaleX = width / sectorWidth,
   954|             scaleY = height / sectorHeight,
   955|             scale = Math.min(scaleX, scaleY),
   956|             sectorRegion = new Ext.util.Region(minY * scale, maxX * scale, maxY * scale,
   957|                                                minX * scale),
   958|             rectRegion = new Ext.util.Region(0, width, height, 0),
   959|             alignedRegion = sectorRegion.alignTo({
   960|                 align: 'c-c', // align sector region's center to rect region's center
   961|                 target: rectRegion
   962|             }),
   963|             dx = alignedRegion.left - minX * scale,
   964|             dy = alignedRegion.top - minY * scale;
   965|         return {
   966|             cx: dx,
   967|             cy: dy,
   968|             radius: scale,
   969|             region: alignedRegion
   970|         };
   971|     },
   972|     /**
   973|      * @private
   974|      */
   975|     fitSectorInPaddedRect: function(width, height, padding, startAngle, lengthAngle, ratio) {
   976|         var result = this.fitSectorInRect(
   977|             width - padding * 2,
   978|             height - padding * 2,
   979|             startAngle, lengthAngle, ratio
   980|         );
   981|         result.cx += padding;
   982|         result.cy += padding;
   983|         result.region.translateBy(padding, padding);
   984|         return result;
   985|     },
   986|     /**
   987|      * @private
   988|      */
   989|     normalizeAngle: function(angle) {
   990|         return (angle % 360 + 360) % 360;
   991|     },
   992|     render: function() {
   993|         if (!this.size) {
   994|             return;
   995|         }
   996|         var me = this,
   997|             textOffset = me.getTextOffset(),
   998|             trackArc = me.getTrackArc(),
   999|             valueArc = me.getValueArc(),
  1000|             needle = me.getNeedle(),
  1001|             clockwise = me.getClockwise(),
  1002|             value = me.fxValue,
  1003|             angleOffset = me.fxAngleOffset,
  1004|             trackLength = me.getTrackLength(),
  1005|             width = me.size.width,
  1006|             height = me.size.height,
  1007|             paddingFn = me.getPadding(),
  1008|             padding = paddingFn(Math.min(width, height)),
  1009|             trackStart = me.normalizeAngle(me.getTrackStart() + angleOffset),
  1010|             trackEnd = trackStart + trackLength,
  1011|             valueLength = me.interpolator(value),
  1012|             trackStyle = me.getTrackStyle(),
  1013|             valueStyle = me.getValueStyle(),
  1014|             sector = me.fitSectorInPaddedRect(
  1015|                 width, height, padding, trackStart, trackLength, trackStyle.innerRadius.ratio
  1016|             ),
  1017|             cx = sector.cx,
  1018|             cy = sector.cy,
  1019|             radius = sector.radius,
  1020|             trackInnerRadius = Math.max(0, trackStyle.innerRadius(radius)),
  1021|             trackOuterRadius = Math.max(0, trackStyle.outerRadius(radius)),
  1022|             valueInnerRadius = Math.max(0, valueStyle.innerRadius(radius)),
  1023|             valueOuterRadius = Math.max(0, valueStyle.outerRadius(radius)),
  1024|             trackPath = me.getArcPath(
  1025|                 cx, cy, trackInnerRadius, trackOuterRadius, trackStart, trackEnd, trackStyle.round
  1026|             ),
  1027|             valuePath = me.getArcPath(
  1028|                 cx, cy, valueInnerRadius, valueOuterRadius,
  1029|                 clockwise ? trackStart : trackEnd - valueLength,
  1030|                 clockwise ? trackStart + valueLength : trackEnd,
  1031|                 valueStyle.round
  1032|             );
  1033|         me.centerText(
  1034|             cx + textOffset.dx, cy + textOffset.dy,
  1035|             sector.region, trackInnerRadius, trackOuterRadius
  1036|         );
  1037|         trackArc.setAttribute('d', trackPath);
  1038|         valueArc.setAttribute('d', valuePath);
  1039|         if (needle) {
  1040|             needle.setRadius(radius);
  1041|             needle.setTransform(cx, cy, -90 + trackStart + valueLength);
  1042|         }
  1043|         me.fireEvent('render', me);
  1044|     }
  1045| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/gauge/needle/Abstract.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-170 ---
     1| /**
     2|  * Describes a gauge needle as a shape defined in SVG path syntax.
     3|  *
     4|  * Note: this class and its subclasses are not supposed to be instantiated directly
     5|  * - an object should be passed the gauge's {@link Ext.ux.gauge.Gauge#needle}
     6|  * config instead. Needle instances are also not supposed to be moved
     7|  * between gauges.
     8|  */
     9| Ext.define('Ext.ux.gauge.needle.Abstract', {
    10|     mixins: [
    11|         'Ext.mixin.Factoryable'
    12|     ],
    13|     alias: 'gauge.needle.abstract',
    14|     isNeedle: true,
    15|     config: {
    16|         /**
    17|          * The generator function for the needle's shape.
    18|          * Because the gauge component is resizable, and it is generally
    19|          * desirable to resize the needle along with the gauge, the needle's
    20|          * shape should have an ability to grow, typically non-uniformly,
    21|          * which necessitates a generator function that will update the needle's
    22|          * path, so that its proportions are appropriate for the current gauge size.
    23|          *
    24|          * The generator function is given two parameters: the inner and outer
    25|          * radius of the needle. For example, for a straight arrow, the path
    26|          * definition is expected to have the base of the needle at the origin
    27|          * - (0, 0) coordinates - and point downwards. The needle will be automatically
    28|          * translated to the center of the gauge and rotated to represent the current
    29|          * gauge {@link Ext.ux.gauge.Gauge#value value}.
    30|          *
    31|          * @param {Function} path The path generator function.
    32|          * @param {Number} path.innerRadius The function's first parameter.
    33|          * @param {Number} path.outerRadius The function's second parameter.
    34|          * @return {String} path.return The shape of the needle in the SVG path syntax returned by
    35|          * the generator function.
    36|          */
    37|         path: null,
    38|         /**
    39|          * The inner radius of the needle. This works just like the `innerRadius`
    40|          * config of the {@link Ext.ux.gauge.Gauge#trackStyle}.
    41|          * The default value is `25` to make sure the needle doesn't overlap with
    42|          * the value of the gauge shown at its center by default.
    43|          *
    44|          * @param {Number/String} [innerRadius=25]
    45|          */
    46|         innerRadius: 25,
    47|         /**
    48|          * The outer radius of the needle. This works just like the `outerRadius`
    49|          * config of the {@link Ext.ux.gauge.Gauge#trackStyle}.
    50|          *
    51|          * @param {Number/String} [outerRadius='100% - 20']
    52|          */
    53|         outerRadius: '100% - 20',
    54|         /**
    55|          * The shape generated by the {@link #path} function is used as the value
    56|          * for the `d` attribute of the SVG `<path>` element. This element
    57|          * has the default class name of `.x-gauge-needle`, so that CSS can be used
    58|          * to give all gauge needles some common styling. To style a particular needle,
    59|          * one can use this config to add styles to the needle's `<path>` element directly,
    60|          * or use a custom {@link Ext.ux.gauge.Gauge#cls class} for the needle's gauge
    61|          * and style the needle from there.
    62|          *
    63|          * This config is not supposed to be updated manually, the styles should
    64|          * always be updated by the means of the `setStyle` call. For example,
    65|          * this is not allowed:
    66|          *
    67|          *     gauge.getStyle().fill = 'red';      // WRONG!
    68|          *     gauge.setStyle({ 'fill': 'red' });  // correct
    69|          *
    70|          * Subsequent calls to the `setStyle` will add to the styles set previously
    71|          * or overwrite their values, but won't remove them. If you'd like to style
    72|          * from a clean slate, setting the style to `null` first will remove the styles
    73|          * previously set:
    74|          *
    75|          *     gauge.getNeedle().setStyle(null);
    76|          *
    77|          * If an SVG shape was produced by a designer rather than programmatically,
    78|          * in other words, the {@link #path} function returns the same shape regardless
    79|          * of the parameters it was given, the uniform scaling of said shape is the only
    80|          * option, if one wants to use gauges of different sizes. In this case,
    81|          * it's possible to specify the desired scale by using the `transform` style,
    82|          * for example:
    83|          *
    84|          *     transform: 'scale(0.35)'
    85|          *
    86|          * @param {Object} style
    87|          */
    88|         style: null,
    89|         /**
    90|          * @private
    91|          * @param {Number} radius
    92|          */
    93|         radius: 0,
    94|         /**
    95|          * @private
    96|          * Expected in the initial config, required during construction.
    97|          * @param {Ext.ux.gauge.Gauge} gauge
    98|          */
    99|         gauge: null
   100|     },
   101|     constructor: function(config) {
   102|         this.initConfig(config);
   103|     },
   104|     applyInnerRadius: function(innerRadius) {
   105|         return this.getGauge().getRadiusFn(innerRadius);
   106|     },
   107|     applyOuterRadius: function(outerRadius) {
   108|         return this.getGauge().getRadiusFn(outerRadius);
   109|     },
   110|     updateRadius: function() {
   111|         this.regeneratePath();
   112|     },
   113|     setTransform: function(centerX, centerY, rotation) {
   114|         var needleGroup = this.getNeedleGroup();
   115|         needleGroup.setStyle(
   116|             'transform',
   117|             'translate(' + centerX + 'px,' + centerY + 'px) ' + 'rotate(' + rotation + 'deg)'
   118|         );
   119|     },
   120|     applyPath: function(path) {
   121|         return Ext.isFunction(path) ? path : null;
   122|     },
   123|     updatePath: function(path) {
   124|         this.regeneratePath(path);
   125|     },
   126|     regeneratePath: function(path) {
   127|         path = path || this.getPath();
   128|         var me = this,
   129|             radius = me.getRadius(),
   130|             inner = me.getInnerRadius()(radius),
   131|             outer = me.getOuterRadius()(radius),
   132|             d = outer > inner ? path(inner, outer) : '';
   133|         me.getNeedlePath().dom.setAttribute('d', d);
   134|     },
   135|     getNeedleGroup: function() {
   136|         var gauge = this.getGauge(),
   137|             group = this.needleGroup;
   138|         if (!group) {
   139|             group = this.needleGroup = Ext.get(document.createElementNS(gauge.svgNS, 'g'));
   140|             gauge.getSvg().appendChild(group);
   141|         }
   142|         return group;
   143|     },
   144|     getNeedlePath: function() {
   145|         var me = this,
   146|             pathElement = me.pathElement;
   147|         if (!pathElement) {
   148|             pathElement = me.pathElement =
   149|                 Ext.get(document.createElementNS(me.getGauge().svgNS, 'path'));
   150|             pathElement.dom.setAttribute('class', Ext.baseCSSPrefix + 'gauge-needle');
   151|             me.getNeedleGroup().appendChild(pathElement);
   152|         }
   153|         return pathElement;
   154|     },
   155|     updateStyle: function(style) {
   156|         var pathElement = this.getNeedlePath();
   157|         if (Ext.isObject(style)) {
   158|             pathElement.setStyle(style);
   159|         }
   160|         else {
   161|             pathElement.dom.removeAttribute('style');
   162|         }
   163|     },
   164|     destroy: function() {
   165|         var me = this;
   166|         me.pathElement = Ext.destroy(me.pathElement);
   167|         me.needleGroup = Ext.destroy(me.needleGroup);
   168|         me.setGauge(null);
   169|     }
   170| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/gauge/needle/Arrow.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-14 ---
     1| Ext.define('Ext.ux.gauge.needle.Arrow', {
     2|     extend: 'Ext.ux.gauge.needle.Abstract',
     3|     alias: 'gauge.needle.arrow',
     4|     config: {
     5|         path: function(ir, or) {
     6|             return or - ir > 30
     7|                 ? "M0," + (ir + 5) + " L-4," + ir + " L-4," + (ir + 10) + " L-1," +
     8|                   (ir + 15) + " L-1," + (or - 7) + " L-5," + (or - 10) + " L0," + or +
     9|                   " L5," + (or - 10) + " L1," + (or - 7) + " L1," + (ir + 15) +
    10|                   " L4," + (ir + 10) + " L4," + ir + " Z"
    11|                 : '';
    12|         }
    13|     }
    14| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/gauge/needle/Diamond.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| Ext.define('Ext.ux.gauge.needle.Diamond', {
     2|     extend: 'Ext.ux.gauge.needle.Abstract',
     3|     alias: 'gauge.needle.diamond',
     4|     config: {
     5|         path: function(ir, or) {
     6|             return or - ir > 10
     7|                 ? 'M0,' + ir + ' L-4,' + (ir + 5) + ' L0,' + or + ' L4,' + (ir + 5) + ' Z'
     8|                 : '';
     9|         }
    10|     }
    11| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/gauge/needle/Rectangle.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| Ext.define('Ext.ux.gauge.needle.Rectangle', {
     2|     extend: 'Ext.ux.gauge.needle.Abstract',
     3|     alias: 'gauge.needle.rectangle',
     4|     config: {
     5|         path: function(ir, or) {
     6|             return or - ir > 10
     7|                 ? "M-2," + ir + " L2," + ir + " L2," + or + " L-2," + or + " Z"
     8|                 : '';
     9|         }
    10|     }
    11| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/gauge/needle/Spike.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| Ext.define('Ext.ux.gauge.needle.Spike', {
     2|     extend: 'Ext.ux.gauge.needle.Abstract',
     3|     alias: 'gauge.needle.spike',
     4|     config: {
     5|         path: function(ir, or) {
     6|             return or - ir > 10
     7|                 ? "M0," + (ir + 5) + " L-4," + ir + " L0," + or + " L4," + ir + " Z"
     8|                 : '';
     9|         }
    10|     }
    11| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/gauge/needle/Wedge.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-9 ---
     1| Ext.define('Ext.ux.gauge.needle.Wedge', {
     2|     extend: 'Ext.ux.gauge.needle.Abstract',
     3|     alias: 'gauge.needle.wedge',
     4|     config: {
     5|         path: function(ir, or) {
     6|             return or - ir > 10 ? "M-4," + ir + " L0," + or + " L4," + ir + " Z" : '';
     7|         }
     8|     }
     9| });


# ====================================================================
# FILE: bundles/AdminBundle/Resources/public/extjs/ext-ux/src/rating/Picker.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-414 ---
     1| /**
     2|  * A ratings picker based on `Ext.Gadget`.
     3|  *
     4|  *      @example
     5|  *      Ext.create({
     6|  *          xtype: 'rating',
     7|  *          renderTo: Ext.getBody(),
     8|  *          listeners: {
     9|  *              change: function (picker, value) {
    10|  *                 console.log('Rating ' + value);
    11|  *              }
    12|  *          }
    13|  *      });
    14|  */
    15| Ext.define('Ext.ux.rating.Picker', {
    16|     extend: 'Ext.Gadget',
    17|     xtype: 'rating',
    18|     focusable: true,
    19|     /*
    20|      * The "cachedConfig" block is basically the same as "config" except that these
    21|      * values are applied specially to the first instance of the class. After processing
    22|      * these configs, the resulting values are stored on the class `prototype` and the
    23|      * template DOM element also reflects these default values.
    24|      */
    25|     cachedConfig: {
    26|         /**
    27|          * @cfg {String} [family]
    28|          * The CSS `font-family` to use for displaying the `{@link #glyphs}`.
    29|          */
    30|         family: 'monospace',
    31|         /**
    32|          * @cfg {String/String[]/Number[]} [glyphs]
    33|          * Either a string containing the two glyph characters, or an array of two strings
    34|          * containing the individual glyph characters or an array of two numbers with the
    35|          * character codes for the individual glyphs.
    36|          *
    37|          * For example:
    38|          *
    39|          *      @example
    40|          *      Ext.create({
    41|          *          xtype: 'rating',
    42|          *          renderTo: Ext.getBody(),
    43|          *          glyphs: [ 9671, 9670 ], // '',
    44|          *          listeners: {
    45|          *              change: function (picker, value) {
    46|          *                 console.log('Rating ' + value);
    47|          *              }
    48|          *          }
    49|          *      });
    50|          */
    51|         glyphs: '',
    52|         /**
    53|          * @cfg {Number} [minimum=1]
    54|          * The minimum allowed `{@link #value}` (rating).
    55|          */
    56|         minimum: 1,
    57|         /**
    58|          * @cfg {Number} [limit]
    59|          * The maximum allowed `{@link #value}` (rating).
    60|          */
    61|         limit: 5,
    62|         /**
    63|          * @cfg {String/Object} [overStyle]
    64|          * Optional styles to apply to the rating glyphs when `{@link #trackOver}` is
    65|          * enabled.
    66|          */
    67|         overStyle: null,
    68|         /**
    69|          * @cfg {Number} [rounding=1]
    70|          * The rounding to apply to values. Common choices are 0.5 (for half-steps) or
    71|          * 0.25 (for quarter steps).
    72|          */
    73|         rounding: 1,
    74|         /**
    75|          * @cfg {String} [scale="125%"]
    76|          * The CSS `font-size` to apply to the glyphs. This value defaults to 125% because
    77|          * glyphs in the stock font tend to be too small. When using specially designed
    78|          * "icon fonts" you may want to set this to 100%.
    79|          */
    80|         scale: '125%',
    81|         /**
    82|          * @cfg {String/Object} [selectedStyle]
    83|          * Optional styles to apply to the rating value glyphs.
    84|          */
    85|         selectedStyle: null,
    86|         /**
    87|          * @cfg {Object/String/String[]/Ext.XTemplate/Function} tip
    88|          * A template or a function that produces the tooltip text. The `Object`, `String`
    89|          * and `String[]` forms are converted to an `Ext.XTemplate`. If a function is given,
    90|          * it will be called with an object parameter and should return the tooltip text.
    91|          * The object contains these properties:
    92|          *
    93|          *   - component: The rating component requesting the tooltip.
    94|          *   - tracking: The current value under the mouse cursor.
    95|          *   - trackOver: The value of the `{@link #trackOver}` config.
    96|          *   - value: The current value.
    97|          *
    98|          * Templates can use these properties to generate the proper text.
    99|          */
   100|         tip: null,
   101|         /**
   102|          * @cfg {Boolean} [trackOver=true]
   103|          * Determines if mouse movements should temporarily update the displayed value.
   104|          * The actual `value` is only updated on `click` but this rather acts as the
   105|          * "preview" of the value prior to click.
   106|          */
   107|         trackOver: true,
   108|         /**
   109|          * @cfg {Number} value
   110|          * The rating value. This value is bounded by `minimum` and `limit` and is also
   111|          * adjusted by the `rounding`.
   112|          */
   113|         value: null,
   114|         /**
   115|          * @cfg {String} tooltipText
   116|          * The current tooltip text. This value is set into the DOM by the updater (hence
   117|          * only when it changes). This is intended for use by the tip manager
   118|          * (`{@link Ext.tip.QuickTipManager}`). Developers should never need to set this
   119|          * config since it is handled by virtue of setting other configs (such as the
   120|          * {@link #tooltip} or the {@link #value}.).
   121|          * @private
   122|          */
   123|         tooltipText: null,
   124|         /**
   125|          * @cfg {Number} trackingValue
   126|          * This config is used to when `trackOver` is `true` and represents the tracked
   127|          * value. This config is maintained by our `mousemove` handler. This should not
   128|          * need to be set directly by user code.
   129|          * @private
   130|          */
   131|         trackingValue: null
   132|     },
   133|     config: {
   134|         /**
   135|          * @cfg {Boolean/Object} [animate=false]
   136|          * Specifies an animation to use when changing the `{@link #value}`. When setting
   137|          * this config, it is probably best to set `{@link #trackOver}` to `false`.
   138|          */
   139|         animate: null
   140|     },
   141|     element: {
   142|         cls: 'u' + Ext.baseCSSPrefix + 'rating-picker',
   143|         reference: 'element',
   144|         children: [{
   145|             reference: 'innerEl',
   146|             cls: 'u' + Ext.baseCSSPrefix + 'rating-picker-inner',
   147|             listeners: {
   148|                 click: 'onClick',
   149|                 mousemove: 'onMouseMove',
   150|                 mouseenter: 'onMouseEnter',
   151|                 mouseleave: 'onMouseLeave'
   152|             },
   153|             children: [{
   154|                 reference: 'valueEl',
   155|                 cls: 'u' + Ext.baseCSSPrefix + 'rating-picker-value'
   156|             }, {
   157|                 reference: 'trackerEl',
   158|                 cls: 'u' + Ext.baseCSSPrefix + 'rating-picker-tracker'
   159|             }]
   160|         }]
   161|     },
   162|     defaultBindProperty: 'value',
   163|     twoWayBindable: 'value',
   164|     overCls: 'u' + Ext.baseCSSPrefix + 'rating-picker-over',
   165|     trackOverCls: 'u' + Ext.baseCSSPrefix + 'rating-picker-track-over',
   166|     applyGlyphs: function(value) {
   167|         if (typeof value === 'string') {
   168|             if (value.length !== 2) {
   169|                 Ext.raise('Expected 2 characters for "glyphs" not "' + value + '".');
   170|             }
   171|             value = [ value.charAt(0), value.charAt(1) ];
   172|         }
   173|         else if (typeof value[0] === 'number') {
   174|             value = [
   175|                 String.fromCharCode(value[0]),
   176|                 String.fromCharCode(value[1])
   177|             ];
   178|         }
   179|         return value;
   180|     },
   181|     applyOverStyle: function(style) {
   182|         this.trackerEl.applyStyles(style);
   183|     },
   184|     applySelectedStyle: function(style) {
   185|         this.valueEl.applyStyles(style);
   186|     },
   187|     applyTip: function(tip) {
   188|         if (tip && typeof tip !== 'function') {
   189|             if (!tip.isTemplate) {
   190|                 tip = new Ext.XTemplate(tip);
   191|             }
   192|             tip = tip.apply.bind(tip);
   193|         }
   194|         return tip;
   195|     },
   196|     applyTrackingValue: function(value) {
   197|         return this.applyValue(value); // same rounding as normal value
   198|     },
   199|     applyValue: function(v) {
   200|         var rounding, limit, min;
   201|         if (v !== null) {
   202|             rounding = this.getRounding();
   203|             limit = this.getLimit();
   204|             min = this.getMinimum();
   205|             v = Math.round(Math.round(v / rounding) * rounding * 1000) / 1000;
   206|             v = (v < min) ? min : (v > limit ? limit : v);
   207|         }
   208|         return v;
   209|     },
   210|     onClick: function(event) {
   211|         var value = this.valueFromEvent(event);
   212|         this.setValue(value);
   213|     },
   214|     onMouseEnter: function() {
   215|         this.element.addCls(this.overCls);
   216|     },
   217|     onMouseLeave: function() {
   218|         this.element.removeCls(this.overCls);
   219|     },
   220|     onMouseMove: function(event) {
   221|         var value = this.valueFromEvent(event);
   222|         this.setTrackingValue(value);
   223|     },
   224|     updateFamily: function(family) {
   225|         this.element.setStyle('fontFamily', "'" + family + "'");
   226|     },
   227|     updateGlyphs: function() {
   228|         this.refreshGlyphs();
   229|     },
   230|     updateLimit: function() {
   231|         this.refreshGlyphs();
   232|     },
   233|     updateScale: function(size) {
   234|         this.element.setStyle('fontSize', size);
   235|     },
   236|     updateTip: function() {
   237|         this.refreshTip();
   238|     },
   239|     updateTooltipText: function(text) {
   240|         this.setTooltip(text);  // modern only (replaced by classic override)
   241|     },
   242|     updateTrackingValue: function(value) {
   243|         var me = this,
   244|             trackerEl = me.trackerEl,
   245|             newWidth = me.valueToPercent(value);
   246|         trackerEl.setStyle('width', newWidth);
   247|         me.refreshTip();
   248|     },
   249|     updateTrackOver: function(trackOver) {
   250|         this.element.toggleCls(this.trackOverCls, trackOver);
   251|     },
   252|     updateValue: function(value, oldValue) {
   253|         var me = this,
   254|             animate = me.getAnimate(),
   255|             valueEl = me.valueEl,
   256|             newWidth = me.valueToPercent(value),
   257|             column, record;
   258|         if (me.isConfiguring || !animate) {
   259|             valueEl.setStyle('width', newWidth);
   260|         }
   261|         else {
   262|             valueEl.stopAnimation();
   263|             valueEl.animate(Ext.merge({
   264|                 from: { width: me.valueToPercent(oldValue) },
   265|                 to: { width: newWidth }
   266|             }, animate));
   267|         }
   268|         me.refreshTip();
   269|         if (!me.isConfiguring) {
   270|             if (me.hasListeners.change) {
   271|                 me.fireEvent('change', me, value, oldValue);
   272|             }
   273|             column = me.getWidgetColumn && me.getWidgetColumn();
   274|             record = column && me.getWidgetRecord && me.getWidgetRecord();
   275|             if (record && column.dataIndex) {
   276|                 record.set(column.dataIndex, value);
   277|             }
   278|         }
   279|     },
   280|     afterCachedConfig: function() {
   281|         this.refresh();
   282|         return this.callParent(arguments);
   283|     },
   284|     initConfig: function(instanceConfig) {
   285|         this.isConfiguring = true;
   286|         this.callParent([ instanceConfig ]);
   287|         this.refresh();
   288|     },
   289|     setConfig: function() {
   290|         var me = this;
   291|         me.isReconfiguring = true;
   292|         me.callParent(arguments);
   293|         me.isReconfiguring = false;
   294|         me.refresh();
   295|         return me;
   296|     },
   297|     privates: {
   298|         /**
   299|          * This method returns the DOM text node into which glyphs are placed.
   300|          * @param {HTMLElement} dom The DOM node parent of the text node.
   301|          * @return {HTMLElement} The text node.
   302|          * @private
   303|          */
   304|         getGlyphTextNode: function(dom) {
   305|             var node = dom.lastChild;
   306|             if (!node || node.nodeType !== 3) {
   307|                 node = dom.ownerDocument.createTextNode('');
   308|                 dom.appendChild(node);
   309|             }
   310|             return node;
   311|         },
   312|         getTooltipData: function() {
   313|             var me = this;
   314|             return {
   315|                 component: me,
   316|                 tracking: me.getTrackingValue(),
   317|                 trackOver: me.getTrackOver(),
   318|                 value: me.getValue()
   319|             };
   320|         },
   321|         /**
   322|          * Forcibly refreshes both glyph and tooltip rendering.
   323|          * @private
   324|          */
   325|         refresh: function() {
   326|             var me = this;
   327|             if (me.invalidGlyphs) {
   328|                 me.refreshGlyphs(true);
   329|             }
   330|             if (me.invalidTip) {
   331|                 me.refreshTip(true);
   332|             }
   333|         },
   334|         /**
   335|          * Refreshes the glyph text rendering unless we are currently performing a
   336|          * bulk config change (initConfig or setConfig).
   337|          * @param {Boolean} now Pass `true` to force the refresh to happen now.
   338|          * @private
   339|          */
   340|         refreshGlyphs: function(now) {
   341|             var me = this,
   342|                 later = !now && (me.isConfiguring || me.isReconfiguring),
   343|                 el, glyphs, limit, on, off, trackerEl, valueEl;
   344|             if (!later) {
   345|                 el = me.getGlyphTextNode(me.innerEl.dom);
   346|                 valueEl = me.getGlyphTextNode(me.valueEl.dom);
   347|                 trackerEl = me.getGlyphTextNode(me.trackerEl.dom);
   348|                 glyphs = me.getGlyphs();
   349|                 limit = me.getLimit();
   350|                 for (on = off = ''; limit--;) {
   351|                     off += glyphs[0];
   352|                     on += glyphs[1];
   353|                 }
   354|                 el.nodeValue = off;
   355|                 valueEl.nodeValue = on;
   356|                 trackerEl.nodeValue = on;
   357|             }
   358|             me.invalidGlyphs = later;
   359|         },
   360|         /**
   361|          * Refreshes the tooltip text rendering unless we are currently performing a
   362|          * bulk config change (initConfig or setConfig).
   363|          * @param {Boolean} now Pass `true` to force the refresh to happen now.
   364|          * @private
   365|          */
   366|         refreshTip: function(now) {
   367|             var me = this,
   368|                 later = !now && (me.isConfiguring || me.isReconfiguring),
   369|                 data, text, tooltip;
   370|             if (!later) {
   371|                 tooltip = me.getTip();
   372|                 if (tooltip) {
   373|                     data = me.getTooltipData();
   374|                     text = tooltip(data);
   375|                     me.setTooltipText(text);
   376|                 }
   377|             }
   378|             me.invalidTip = later;
   379|         },
   380|         /**
   381|          * Convert the coordinates of the given `Event` into a rating value.
   382|          * @param {Ext.event.Event} event The event.
   383|          * @return {Number} The rating based on the given event coordinates.
   384|          * @private
   385|          */
   386|         valueFromEvent: function(event) {
   387|             var me = this,
   388|                 el = me.innerEl,
   389|                 ex = event.getX(),
   390|                 rounding = me.getRounding(),
   391|                 cx = el.getX(),
   392|                 x = ex - cx,
   393|                 w = el.getWidth(),
   394|                 limit = me.getLimit(),
   395|                 v;
   396|             if (me.getInherited().rtl) {
   397|                 x = w - x;
   398|             }
   399|             v = x / w * limit;
   400|             v = Math.ceil(v / rounding) * rounding;
   401|             return v;
   402|         },
   403|         /**
   404|          * Convert the given rating into a width percentage.
   405|          * @param {Number} value The rating value to convert.
   406|          * @return {String} The width percentage to represent the given value.
   407|          * @private
   408|          */
   409|         valueToPercent: function(value) {
   410|             value = (value / this.getLimit()) * 100;
   411|             return value + '%';
   412|         }
   413|     }
   414| });

