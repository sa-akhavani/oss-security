# ====================================================================
# FILE: src/Reports/ElementsInUseReport.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-148 ---
     1| <?php
     2| namespace DNADesign\Elemental\Reports;
     3| use DNADesign\Elemental\Models\BaseElement;
     4| use InvalidArgumentException;
     5| use Psr\Log\LoggerInterface;
     6| use SilverStripe\Core\Injector\Injector;
     7| use SilverStripe\Forms\GridField\GridField;
     8| use SilverStripe\ORM\DataList;
     9| use SilverStripe\Reports\Report;
    10| use SilverStripe\View\ArrayData;
    11| use SilverStripe\View\Requirements;
    12| use SilverStripe\Core\Convert;
    13| class ElementsInUseReport extends Report
    14| {
    15|     /**
    16|      * The string used in GET params to filter the records in this report by element type
    17|      *
    18|      * @var string
    19|      */
    20|     const CLASS_NAME_FILTER_KEY = 'ClassName';
    21|     public function title()
    22|     {
    23|         return _t(__CLASS__ . '.ReportTitle', 'Content blocks in use');
    24|     }
    25|     public function sourceRecords($params = [])
    26|     {
    27|         $elements = BaseElement::get()->exclude(['ClassName' => BaseElement::class]);
    28|         if (isset($params[static::CLASS_NAME_FILTER_KEY])) {
    29|             $className = $this->unsanitiseClassName($params[static::CLASS_NAME_FILTER_KEY]);
    30|             $elements = $elements->filter(['ClassName' => $className]);
    31|         }
    32|         return $elements;
    33|     }
    34|     public function columns()
    35|     {
    36|         return [
    37|             'Icon' => [
    38|                 'title' => '',
    39|                 'formatting' => function ($value, BaseElement $item) {
    40|                     return $item->getIcon();
    41|                 },
    42|             ],
    43|             'Title' => [
    44|                 'title' => _t(__CLASS__ . '.Title', 'Title'),
    45|                 'formatting' => function ($value, BaseElement $item) {
    46|                     if (!empty($value)) {
    47|                         if ($link = $item->CMSEditLink()) {
    48|                             return $this->getEditLink($value, $link);
    49|                         }
    50|                         return $value;
    51|                     }
    52|                     return '<span class="element__note">' . _t(__CLASS__ . '.None', 'None') . '</span>';
    53|                 },
    54|             ],
    55|             'ElementSummary' => [
    56|                 'title' => _t(__CLASS__ . '.Summary', 'Summary'),
    57|                 'casting' => 'HTMLText->RAW',
    58|                 'formatting' => function ($value, BaseElement $item) {
    59|                     try {
    60|                         return Convert::raw2xml($item->getSummary());
    61|                     } catch (InvalidArgumentException $exception) {
    62|                         Injector::inst()->get(LoggerInterface::class)->debug(
    63|                             'Element #' . $item->ID . ' threw exception in ElementInUseReport via getSummary(): '
    64|                             . $exception->getMessage()
    65|                         );
    66|                         return '';
    67|                     }
    68|                 },
    69|             ],
    70|             'Type' => [
    71|                 'title' => _t(__CLASS__ . '.Type', 'Type'),
    72|                 'formatting' => function ($value, BaseElement $item) {
    73|                     return $item->getTypeNice();
    74|                 },
    75|             ],
    76|             'Page.Title' => [
    77|                 'title' => _t(__CLASS__ . '.Page', 'Page'),
    78|                 'formatting' => function ($value, BaseElement $item) {
    79|                     if ($value) {
    80|                         if ($link = $item->getPage()->CMSEditLink()) {
    81|                             return $this->getEditLink($value, $link);
    82|                         }
    83|                     }
    84|                     return Convert::raw2xml($item->getPageTitle());
    85|                 },
    86|             ],
    87|         ];
    88|     }
    89|     /**
    90|      * Helper method to return the link to edit an element
    91|      *
    92|      * @param string $value
    93|      * @param string $link
    94|      * @return string
    95|      */
    96|     protected function getEditLink($value, $link)
    97|     {
    98|         return sprintf(
    99|             '<a class="grid-field__link" href="%s" title="%s">%s</a>',
   100|             $link,
   101|             $value,
   102|             $value
   103|         );
   104|     }
   105|     /**
   106|      * Add elemental CSS and a unique class name to the GridField
   107|      *
   108|      * @return GridField
   109|      */
   110|     public function getReportField()
   111|     {
   112|         Requirements::css('dnadesign/silverstripe-elemental:client/dist/styles/bundle.css');
   113|         /** @var GridField $field */
   114|         $field = parent::getReportField();
   115|         $field->addExtraClass('elemental-report__grid-field');
   116|         return $field;
   117|     }
   118|     /**
   119|      * When used with silverstripe/reports >= 4.4, this method will automatically be added as breadcrumbs
   120|      * leading up to this report.
   121|      *
   122|      * @return ArrayData[]
   123|      */
   124|     public function getBreadcrumbs()
   125|     {
   126|         $params = $this->getSourceParams();
   127|         if (!isset($params[static::CLASS_NAME_FILTER_KEY])) {
   128|             return [];
   129|         }
   130|         $report = ElementTypeReport::create();
   131|         return [ArrayData::create([
   132|             'Title' => $report->title(),
   133|             'Link' => $report->getLink(),
   134|         ])];
   135|     }
   136|     /**
   137|      * Unsanitise a model class' name from a URL param
   138|      *
   139|      * See {@link \SilverStripe\Admin\ModelAdmin::unsanitiseClassName}
   140|      *
   141|      * @param string $class
   142|      * @return string
   143|      */
   144|     protected function unsanitiseClassName($class)
   145|     {
   146|         return str_replace('-', '\\', $class ?? '');
   147|     }
   148| }

