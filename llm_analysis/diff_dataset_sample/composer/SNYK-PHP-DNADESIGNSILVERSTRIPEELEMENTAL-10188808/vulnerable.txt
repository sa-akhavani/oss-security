# ====================================================================
# FILE: src/Reports/ElementsInUseReport.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-111 ---
     1| <?php
     2| namespace DNADesign\Elemental\Reports;
     3| use DNADesign\Elemental\Models\BaseElement;
     4| use SilverStripe\Forms\GridField\GridField;
     5| use SilverStripe\ORM\DataList;
     6| use SilverStripe\Reports\Report;
     7| use SilverStripe\View\Requirements;
     8| class ElementsInUseReport extends Report
     9| {
    10|     public function title()
    11|     {
    12|         return _t(__CLASS__ . '.ReportTitle', 'Content blocks in use');
    13|     }
    14|     public function sourceRecords($params = [])
    15|     {
    16|         /** @var DataList $elements */
    17|         $elements = BaseElement::get()->exclude(['ClassName' => BaseElement::class]);
    18|         if (isset($params['ClassName'])) {
    19|             $className = $this->unsanitiseClassName($params['ClassName']);
    20|             $elements = $elements->filter(['ClassName' => $className]);
    21|         }
    22|         return $elements;
    23|     }
    24|     public function columns()
    25|     {
    26|         return [
    27|             'Icon' => [
    28|                 'title' => '',
    29|                 'formatting' => function ($value, BaseElement $item) {
    30|                     return $item->getIcon();
    31|                 },
    32|             ],
    33|             'Title' => [
    34|                 'title' => _t(__CLASS__ . '.Title', 'Title'),
    35|                 'formatting' => function ($value, BaseElement $item) {
    36|                     $value = $item->Title;
    37|                     if (!empty($value)) {
    38|                         if ($item->CMSEditLink()) {
    39|                             return $this->getEditLink($value, $item);
    40|                         }
    41|                         return $value;
    42|                     }
    43|                     return '<span class="element__note">' . _t(__CLASS__ . '.None', 'None') . '</span>';
    44|                 },
    45|             ],
    46|             'Summary' => [
    47|                 'title' => _t(__CLASS__ . '.Summary', 'Summary'),
    48|                 'casting' => 'HTMLText->RAW',
    49|                 'formatting' => function ($value, BaseElement $item) {
    50|                     return $item->getSummary();
    51|                 },
    52|             ],
    53|             'Type' => [
    54|                 'title' => _t(__CLASS__ . '.Type', 'Type'),
    55|                 'formatting' => function ($value, BaseElement $item) {
    56|                     return $item->getTypeNice();
    57|                 },
    58|             ],
    59|             'Page.Title' => [
    60|                 'title' => _t(__CLASS__ . '.Page', 'Page'),
    61|                 'formatting' => function ($value, BaseElement $item) {
    62|                     if ($value) {
    63|                         return $this->getEditLink($value, $item);
    64|                     }
    65|                     return $item->getPageTitle();
    66|                 },
    67|             ],
    68|         ];
    69|     }
    70|     /**
    71|      * Helper method to return the link to edit an element
    72|      *
    73|      * @param string $value
    74|      * @param BaseElement $item
    75|      * @return string
    76|      */
    77|     protected function getEditLink($value, $item)
    78|     {
    79|         return sprintf(
    80|             '<a class="grid-field__link" href="%s" title="%s">%s</a>',
    81|             $item->CMSEditLink(),
    82|             $value,
    83|             $value
    84|         );
    85|     }
    86|     /**
    87|      * Add elemental CSS and a unique class name to the GridField
    88|      *
    89|      * @return GridField
    90|      */
    91|     public function getReportField()
    92|     {
    93|         Requirements::css('dnadesign/silverstripe-elemental:client/dist/styles/bundle.css');
    94|         /** @var GridField $field */
    95|         $field = parent::getReportField();
    96|         $field->addExtraClass('elemental-report__grid-field');
    97|         return $field;
    98|     }
    99|     /**
   100|      * Unsanitise a model class' name from a URL param
   101|      *
   102|      * See {@link \SilverStripe\Admin\ModelAdmin::unsanitiseClassName}
   103|      *
   104|      * @param string $class
   105|      * @return string
   106|      */
   107|     protected function unsanitiseClassName($class)
   108|     {
   109|         return str_replace('-', '\\', $class);
   110|     }
   111| }

