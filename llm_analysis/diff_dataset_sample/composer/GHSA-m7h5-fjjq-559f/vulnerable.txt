# ====================================================================
# FILE: ThinkPHP/Common/functions.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 257-306 ---
   257|     if (strpos($name, '.')) {
   258|         list($method, $name) = explode('.', $name, 2);
   259|     } else {
   260|         $method = 'param';
   261|     }
   262|     switch (strtolower($method)) {
   263|         case 'get':
   264|             $input = &$_GET;
   265|             break;
   266|         case 'post':
   267|             $input = &$_POST;
   268|             break;
   269|         case 'put':
   270|             if (is_null($_PUT)) {
   271|                 parse_str(file_get_contents('php://input'), $_PUT);
   272|             }
   273|             $input = $_PUT;
   274|             break;
   275|         case 'param':
   276|             switch ($_SERVER['REQUEST_METHOD']) {
   277|             case 'POST':
   278|                     $input = $_POST;
   279|                     break;
   280|             case 'PUT':
   281|                     if (is_null($_PUT)) {
   282|                         parse_str(file_get_contents('php://input'), $_PUT);
   283|                     }
   284|                     $input = $_PUT;
   285|                     break;
   286|             default:
   287|                     $input = $_GET;
   288|             }
   289|             break;
   290|         case 'path':
   291|             $input = array();
   292|             if (!empty($_SERVER['PATH_INFO'])) {
   293|                 $depr  = C('URL_PATHINFO_DEPR');
   294|                 $input = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
   295|             }
   296|             break;
   297|         case 'request':
   298|             $input = &$_REQUEST;
   299|             break;
   300|         case 'session':
   301|             $input = &$_SESSION;
   302|             break;
   303|         case 'cookie':
   304|             $input = &$_COOKIE;
   305|             break;
   306|         case 'server':

# --- HUNK 2: Lines 326-391 ---
   326|                 $data = array_map_recursive($filter, $data); // 参数过滤
   327|             }
   328|         }
   329|     } elseif (isset($input[$name])) {
   330|         $data    = $input[$name];
   331|         $filters = isset($filter) ? $filter : C('DEFAULT_FILTER');
   332|         if ($filters) {
   333|             if (is_string($filters)) {
   334|                 if (0 === strpos($filters, '/')) {
   335|                     if (1 !== preg_match($filters, (string) $data)) {
   336|                         return isset($default) ? $default : null;
   337|                     }
   338|                 } else {
   339|                     $filters = explode(',', $filters);
   340|                 }
   341|             } elseif (is_int($filters)) {
   342|                 $filters = array($filters);
   343|             }
   344|             if (is_array($filters)) {
   345|                 foreach ($filters as $filter) {
   346|                     if (function_exists($filter)) {
   347|                         $data = is_array($data) ? array_map_recursive($filter, $data) : $filter($data); // 参数过滤
   348|                     } else {
   349|                         $data = filter_var($data, is_int($filter) ? $filter : filter_id($filter));
   350|                         if (false === $data) {
   351|                             return isset($default) ? $default : null;
   352|                         }
   353|                     }
   354|                 }
   355|             }
   356|         }
   357|         if (!empty($type)) {
   358|             switch (strtolower($type)) {
   359|                 case 'a':    // 数组
   360|                     $data = (array) $data;
   361|                     break;
   362|                 case 'd':    // 数字
   363|                     $data = (int) $data;
   364|                     break;
   365|                 case 'f':    // 浮点
   366|                     $data = (float) $data;
   367|                     break;
   368|                 case 'b':    // 布尔
   369|                     $data = (boolean) $data;
   370|                     break;
   371|                 case 's':// 字符串
   372|                 default:
   373|                     $data = (string) $data;
   374|             }
   375|         }
   376|     } else {
   377|         $data = isset($default) ? $default : null;
   378|     }
   379|     is_array($data) && array_walk_recursive($data, 'think_filter');
   380|     return $data;
   381| }
   382| function array_map_recursive($filter, $data)
   383| {
   384|     $result = array();
   385|     foreach ($data as $key => $val) {
   386|         $result[$key] = is_array($val)
   387|         ? array_map_recursive($filter, $val)
   388|         : call_user_func($filter, $val);
   389|     }
   390|     return $result;
   391| }

# --- HUNK 3: Lines 918-1011 ---
   918|             if ($maps = C('URL_ACTION_MAP')) {
   919|                 if (isset($maps[strtolower($var[$varController])])) {
   920|                     $maps = $maps[strtolower($var[$varController])];
   921|                     if ($action = array_search(strtolower($var[$varAction]), $maps)) {
   922|                         $var[$varAction] = $action;
   923|                     }
   924|                 }
   925|             }
   926|             if ($maps = C('URL_CONTROLLER_MAP')) {
   927|                 if ($controller = array_search(strtolower($var[$varController]), $maps)) {
   928|                     $var[$varController] = $controller;
   929|                 }
   930|             }
   931|             if ($urlCase) {
   932|                 $var[$varController] = parse_name($var[$varController]);
   933|             }
   934|             $module = '';
   935|             if (!empty($path)) {
   936|                 $var[$varModule] = implode($depr, $path);
   937|             } else {
   938|                 if (C('MULTI_MODULE')) {
   939|                     if (MODULE_NAME != C('DEFAULT_MODULE') || !C('MODULE_ALLOW_LIST')) {
   940|                         $var[$varModule] = MODULE_NAME;
   941|                     }
   942|                 }
   943|             }
   944|             if ($maps = C('URL_MODULE_MAP')) {
   945|                 if ($_module = array_search(strtolower($var[$varModule]), $maps)) {
   946|                     $var[$varModule] = $_module;
   947|                 }
   948|             }
   949|             if (isset($var[$varModule])) {
   950|                 $module = $var[$varModule];
   951|                 unset($var[$varModule]);
   952|             }
   953|         }
   954|     }
   955|     if (C('URL_MODEL') == 0) {
   956|         $url = __APP__ . '?' . C('VAR_MODULE') . "={$module}&" . http_build_query(array_reverse($var));
   957|         if ($urlCase) {
   958|             $url = strtolower($url);
   959|         }
   960|         if (!empty($vars)) {
   961|             $vars = http_build_query($vars);
   962|             $url .= '&' . $vars;
   963|         }
   964|     } else {
   965|         if (isset($route)) {
   966|             $url = __APP__ . '/' . rtrim($url, $depr);
   967|         } else {
   968|             $module = (defined('BIND_MODULE') && BIND_MODULE == $module) ? '' : $module;
   969|             $url    = __APP__ . '/' . ($module ? $module . MODULE_PATHINFO_DEPR : '') . implode($depr, array_reverse($var));
   970|         }
   971|         if ($urlCase) {
   972|             $url = strtolower($url);
   973|         }
   974|         if (!empty($vars)) {
   975|             foreach ($vars as $var => $val) {
   976|                 if ('' !== trim($val)) {
   977|                     $url .= $depr . $var . $depr . urlencode($val);
   978|                 }
   979|             }
   980|         }
   981|         if ($suffix) {
   982|             $suffix = true === $suffix ? C('URL_HTML_SUFFIX') : $suffix;
   983|             if ($pos = strpos($suffix, '|')) {
   984|                 $suffix = substr($suffix, 0, $pos);
   985|             }
   986|             if ($suffix && '/' != substr($url, -1)) {
   987|                 $url .= '.' . ltrim($suffix, '.');
   988|             }
   989|         }
   990|     }
   991|     if (isset($anchor)) {
   992|         $url .= '#' . $anchor;
   993|     }
   994|     if ($domain) {
   995|         $url = (is_ssl() ? 'https://' : 'http://') . $domain . $url;
   996|     }
   997|     return $url;
   998| }
   999| /**
  1000|  * 渲染输出Widget
  1001|  * @param string $name Widget名称
  1002|  * @param array $data 传入的参数
  1003|  * @return void
  1004|  */
  1005| function W($name, $data = array())
  1006| {
  1007|     return R($name, $data, 'Widget');
  1008| }
  1009| /**
  1010|  * 判断是否SSL协议
  1011|  * @return boolean

# --- HUNK 4: Lines 1496-1523 ---
  1496|         413 => 'Request Entity Too Large',
  1497|         414 => 'Request-URI Too Long',
  1498|         415 => 'Unsupported Media Type',
  1499|         416 => 'Requested Range Not Satisfiable',
  1500|         417 => 'Expectation Failed',
  1501|         500 => 'Internal Server Error',
  1502|         501 => 'Not Implemented',
  1503|         502 => 'Bad Gateway',
  1504|         503 => 'Service Unavailable',
  1505|         504 => 'Gateway Timeout',
  1506|         505 => 'HTTP Version Not Supported',
  1507|         509 => 'Bandwidth Limit Exceeded',
  1508|     );
  1509|     if (isset($_status[$code])) {
  1510|         header('HTTP/1.1 ' . $code . ' ' . $_status[$code]);
  1511|         header('Status:' . $code . ' ' . $_status[$code]);
  1512|     }
  1513| }
  1514| function think_filter(&$value)
  1515| {
  1516|     if (preg_match('/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i', $value)) {
  1517|         $value .= ' ';
  1518|     }
  1519| }
  1520| function in_array_case($value, $array)
  1521| {
  1522|     return in_array(strtolower($value), array_map('strtolower', $array));
  1523| }


# ====================================================================
# FILE: ThinkPHP/Conf/convention.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 61-101 ---
    61|     'DATA_CACHE_PREFIX'      => '', // 缓存前缀
    62|     'DATA_CACHE_TYPE'        => 'File', // 数据缓存类型,支持:File|Db|Apc|Memcache|Shmop|Sqlite|Xcache|Apachenote|Eaccelerator
    63|     'DATA_CACHE_PATH'        => TEMP_PATH, // 缓存路径设置 (仅对File方式缓存有效)
    64|     'DATA_CACHE_KEY'         => '', // 缓存文件KEY (仅对File方式缓存有效)
    65|     'DATA_CACHE_SUBDIR'      => false, // 使用子目录缓存 (自动根据缓存标识的哈希创建子目录)
    66|     'DATA_PATH_LEVEL'        => 1, // 子目录缓存级别
    67|     /* 错误设置 */
    68|     'ERROR_MESSAGE'          => '页面错误！请稍后再试～', //错误显示信息,非调试模式有效
    69|     'ERROR_PAGE'             => '', // 错误定向页面
    70|     'SHOW_ERROR_MSG'         => false, // 显示错误信息
    71|     'TRACE_MAX_RECORD'       => 100, // 每个级别的错误信息 最大记录数
    72|     /* 日志设置 */
    73|     'LOG_RECORD'             => false, // 默认不记录日志
    74|     'LOG_TYPE'               => 'File', // 日志记录类型 默认为文件方式
    75|     'LOG_LEVEL'              => 'EMERG,ALERT,CRIT,ERR', // 允许记录的日志级别
    76|     'LOG_FILE_SIZE'          => 2097152, // 日志文件大小限制
    77|     'LOG_EXCEPTION_RECORD'   => false, // 是否记录异常信息日志
    78|     /* SESSION设置 */
    79|     'SESSION_AUTO_START'     => true, // 是否自动开启Session
    80|     'SESSION_OPTIONS'        => array(), // session 配置数组 支持type name id path expire domain 等参数
    81|     'SESSION_TYPE'           => '', // session hander类型 默认无需设置 除非扩展了session hander驱动
    82|     'SESSION_PREFIX'         => '', // session 前缀
    83|     /* 模板引擎设置 */
    84|     'TMPL_CONTENT_TYPE'      => 'text/html', // 默认模板输出类型
    85|     'TMPL_ACTION_ERROR'      => THINK_PATH . 'Tpl/dispatch_jump.tpl', // 默认错误跳转对应的模板文件
    86|     'TMPL_ACTION_SUCCESS'    => THINK_PATH . 'Tpl/dispatch_jump.tpl', // 默认成功跳转对应的模板文件
    87|     'TMPL_EXCEPTION_FILE'    => THINK_PATH . 'Tpl/think_exception.tpl', // 异常页面的模板文件
    88|     'TMPL_DETECT_THEME'      => false, // 自动侦测模板主题
    89|     'TMPL_TEMPLATE_SUFFIX'   => '.html', // 默认模板文件后缀
    90|     'TMPL_FILE_DEPR'         => '/', //模板文件CONTROLLER_NAME与ACTION_NAME之间的分割符
    91|     'TMPL_ENGINE_TYPE'       => 'Think', // 默认模板引擎 以下设置仅对使用Think模板引擎有效
    92|     'TMPL_CACHFILE_SUFFIX'   => '.php', // 默认模板缓存后缀
    93|     'TMPL_DENY_FUNC_LIST'    => 'echo,exit', // 模板引擎禁用函数
    94|     'TMPL_DENY_PHP'          => false, // 默认模板引擎是否禁用PHP原生代码
    95|     'TMPL_L_DELIM'           => '{', // 模板引擎普通标签开始标记
    96|     'TMPL_R_DELIM'           => '}', // 模板引擎普通标签结束标记
    97|     'TMPL_VAR_IDENTIFY'      => 'array', // 模板变量识别。留空自动判断,参数为'obj'则表示对象
    98|     'TMPL_STRIP_SPACE'       => true, // 是否去除模板文件里面的html空格与换行
    99|     'TMPL_CACHE_ON'          => true, // 是否开启模板编译缓存,设为false则每次都会重新编译
   100|     'TMPL_CACHE_PREFIX'      => '', // 模板缓存前缀标识，可以动态改变
   101|     'TMPL_CACHE_TIME'        => 0, // 模板缓存有效期 0 为永久，(以数字为值，单位:秒)


# ====================================================================
# FILE: ThinkPHP/Library/Behavior/BuildLiteBehavior.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| namespace Behavior;
     3| use Think\Hook as Hook;
     4| class BuildLiteBehavior
     5| {
     6|     public function run(&$params)
     7|     {
     8|         if (!defined('BUILD_LITE_FILE')) {
     9|             return;
    10|         }
    11|         $litefile = C('RUNTIME_LITE_FILE', null, RUNTIME_PATH . 'lite.php');
    12|         if (is_file($litefile)) {
    13|             return;
    14|         }
    15|         $defs    = get_defined_constants(true);
    16|         $content = 'namespace {$GLOBALS[\'_beginTime\'] = microtime(TRUE);';
    17|         if (MEMORY_LIMIT_ON) {
    18|             $content .= '$GLOBALS[\'_startUseMems\'] = memory_get_usage();';
    19|         }
    20|         unset($defs['user']['BUILD_LITE_FILE']);
    21|         $content .= $this->buildArrayDefine($defs['user']) . '}';
    22|         $filelist = is_file(CONF_PATH . 'lite.php') ?
    23|         include CONF_PATH . 'lite.php' :
    24|         array(
    25|             THINK_PATH . 'Common/functions.php',
    26|             COMMON_PATH . 'Common/function.php',
    27|             CORE_PATH . 'Think' . EXT,
    28|             CORE_PATH . 'Hook' . EXT,


# ====================================================================
# FILE: ThinkPHP/Library/Org/Net/Http.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 127-188 ---
   127|      * @param string $showname 下载显示的文件名
   128|      * @param string $content  下载的内容
   129|      * @param integer $expire  下载内容浏览器缓存时间
   130|      * @return void
   131|      */
   132|     public static function download($filename, $showname = '', $content = '', $expire = 180)
   133|     {
   134|         if (is_file($filename)) {
   135|             $length = filesize($filename);
   136|         } elseif (is_file(UPLOAD_PATH . $filename)) {
   137|             $filename = UPLOAD_PATH . $filename;
   138|             $length   = filesize($filename);
   139|         } elseif ('' != $content) {
   140|             $length = strlen($content);
   141|         } else {
   142|             E($filename . L('下载文件不存在！'));
   143|         }
   144|         if (empty($showname)) {
   145|             $showname = $filename;
   146|         }
   147|         $showname = basename($showname);
   148|         if (!empty($filename)) {
   149|             $finfo = new \finfo(FILEINFO_MIME);
   150|             $type  = $finfo->file($filename);
   151|         } else {
   152|             $type = "application/octet-stream";
   153|         }
   154|         header("Pragma: public");
   155|         header("Cache-control: max-age=" . $expire);
   156|         header("Expires: " . gmdate("D, d M Y H:i:s", time() + $expire) . "GMT");
   157|         header("Last-Modified: " . gmdate("D, d M Y H:i:s", time()) . "GMT");
   158|         header("Content-Disposition: attachment; filename=" . $showname);
   159|         header("Content-Length: " . $length);
   160|         header("Content-type: " . $type);
   161|         header('Content-Encoding: none');
   162|         header("Content-Transfer-Encoding: binary");
   163|         if ('' == $content) {
   164|             readfile($filename);
   165|         } else {
   166|             echo ($content);
   167|         }
   168|         exit();
   169|     }
   170|     /**
   171|      * 显示HTTP Header 信息
   172|      * @return string
   173|      */
   174|     public static function getHeaderInfo($header = '', $echo = true)
   175|     {
   176|         ob_start();
   177|         $headers = getallheaders();
   178|         if (!empty($header)) {
   179|             $info = $headers[$header];
   180|             echo ($header . ':' . $info . "\n");
   181|         } else {
   182|             foreach ($headers as $key => $val) {
   183|                 echo ("$key:$val\n");
   184|             }
   185|         }
   186|         $output = ob_get_clean();
   187|         if ($echo) {
   188|             echo (nl2br($output));


# ====================================================================
# FILE: ThinkPHP/Library/Org/Net/IpLocation.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-63 ---
    23|      * 最后一条IP记录的偏移地址
    24|      *
    25|      * @var int
    26|      */
    27|     private $lastip;
    28|     /**
    29|      * IP记录的总条数（不包含版本信息记录）
    30|      *
    31|      * @var int
    32|      */
    33|     private $totalip;
    34|     /**
    35|      * 构造函数，打开 QQWry.Dat 文件并初始化类中的信息
    36|      *
    37|      * @param string $filename
    38|      * @return IpLocation
    39|      */
    40|     public function __construct($filename = "UTFWry.dat")
    41|     {
    42|         $this->fp = 0;
    43|         if (($this->fp = fopen(dirname(__FILE__) . '/' . $filename, 'rb')) !== false) {
    44|             $this->firstip = $this->getlong();
    45|             $this->lastip  = $this->getlong();
    46|             $this->totalip = ($this->lastip - $this->firstip) / 7;
    47|         }
    48|     }
    49|     /**
    50|      * 返回读取的长整型数
    51|      *
    52|      * @access private
    53|      * @return int
    54|      */
    55|     private function getlong()
    56|     {
    57|         $result = unpack('Vlong', fread($this->fp, 4));
    58|         return $result['long'];
    59|     }
    60|     /**
    61|      * 返回读取的3个字节的长整型数
    62|      *
    63|      * @access private


# ====================================================================
# FILE: ThinkPHP/Library/Think/App.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| <?php
     2| namespace Think;
     3| /**
     4|  * ThinkPHP 应用程序类 执行应用过程管理
     5|  */
     6| class App
     7| {
     8|     /**
     9|      * 应用程序初始化
    10|      * @access public
    11|      * @return void
    12|      */
    13|     public static function init()
    14|     {
    15|         load_ext_file(COMMON_PATH);
    16|         C('LOG_PATH', realpath(LOG_PATH) . '/Common/');
    17|         define('NOW_TIME', $_SERVER['REQUEST_TIME']);
    18|         define('REQUEST_METHOD', $_SERVER['REQUEST_METHOD']);
    19|         define('IS_GET', REQUEST_METHOD == 'GET' ? true : false);
    20|         define('IS_POST', REQUEST_METHOD == 'POST' ? true : false);
    21|         define('IS_PUT', REQUEST_METHOD == 'PUT' ? true : false);
    22|         define('IS_DELETE', REQUEST_METHOD == 'DELETE' ? true : false);
    23|         Dispatcher::dispatch();
    24|         if (C('REQUEST_VARS_FILTER')) {
    25|             array_walk_recursive($_GET, 'think_filter');
    26|             array_walk_recursive($_POST, 'think_filter');
    27|             array_walk_recursive($_REQUEST, 'think_filter');
    28|         }
    29|         Hook::listen('url_dispatch');
    30|         define('IS_AJAX', ((isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') || !empty($_POST[C('VAR_AJAX_SUBMIT')]) || !empty($_GET[C('VAR_AJAX_SUBMIT')])) ? true : false);
    31|         C('TMPL_EXCEPTION_FILE', realpath(C('TMPL_EXCEPTION_FILE')));
    32|         return;
    33|     }
    34|     /**
    35|      * 执行应用程序

# --- HUNK 2: Lines 103-169 ---
   103|                     case 'PUT':
   104|                         parse_str(file_get_contents('php://input'), $vars);
   105|                         break;
   106|                     default:
   107|                         $vars = $_GET;
   108|                 }
   109|                 $params         = $method->getParameters();
   110|                 $paramsBindType = C('URL_PARAMS_BIND_TYPE');
   111|                 foreach ($params as $param) {
   112|                     $name = $param->getName();
   113|                     if (1 == $paramsBindType && !empty($vars)) {
   114|                         $args[] = array_shift($vars);
   115|                     } elseif (0 == $paramsBindType && isset($vars[$name])) {
   116|                         $args[] = $vars[$name];
   117|                     } elseif ($param->isDefaultValueAvailable()) {
   118|                         $args[] = $param->getDefaultValue();
   119|                     } else {
   120|                         E(L('_PARAM_ERROR_') . ':' . $name);
   121|                     }
   122|                 }
   123|                 if (C('URL_PARAMS_SAFE')) {
   124|                     $filters = C('URL_PARAMS_FILTER') ?: C('DEFAULT_FILTER');
   125|                     if ($filters) {
   126|                         $filters = explode(',', $filters);
   127|                         foreach ($filters as $filter) {
   128|                             $args = array_map_recursive($filter, $args); // 参数过滤
   129|                         }
   130|                     }
   131|                 }
   132|                 array_walk_recursive($args, 'think_filter');
   133|                 $method->invokeArgs($module, $args);
   134|             } else {
   135|                 $method->invoke($module);
   136|             }
   137|             if ($class->hasMethod('_after_' . $action)) {
   138|                 $after = $class->getMethod('_after_' . $action);
   139|                 if ($after->isPublic()) {
   140|                     $after->invoke($module);
   141|                 }
   142|             }
   143|         } else {
   144|             throw new \ReflectionException();
   145|         }
   146|     }
   147|     /**
   148|      * 运行应用实例 入口文件使用的快捷方法
   149|      * @access public
   150|      * @return void
   151|      */
   152|     public static function run()
   153|     {
   154|         Hook::listen('app_init');
   155|         App::init();
   156|         Hook::listen('app_begin');
   157|         if (!IS_CLI) {
   158|             session(C('SESSION_OPTIONS'));
   159|         }
   160|         G('initTime');
   161|         App::exec();
   162|         Hook::listen('app_end');
   163|         return;
   164|     }
   165|     public static function logo()
   166|     {
   167|         return 'iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjVERDVENkZGQjkyNDExRTE5REY3RDQ5RTQ2RTRDQUJCIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjVERDVENzAwQjkyNDExRTE5REY3RDQ5RTQ2RTRDQUJCIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NURENUQ2RkRCOTI0MTFFMTlERjdENDlFNDZFNENBQkIiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NURENUQ2RkVCOTI0MTFFMTlERjdENDlFNDZFNENBQkIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5fx6IRAAAMCElEQVR42sxae3BU1Rk/9+69+8xuNtkHJAFCSIAkhMgjCCJQUi0GtEIVbP8Qq9LH2No6TmfaztjO2OnUdvqHFMfOVFTqIK0vUEEeqUBARCsEeYQkEPJoEvIiELLvvc9z+p27u2F3s5tsBB1OZiebu5dzf7/v/L7f952zMM8cWIwY+Mk2ulCp92Fnq3XvnzArr2NZnYNldDp0Gw+/OEQ4+obQn5D+4Ubb22+YOGsWi/Todh8AHglKEGkEsnHBQ162511GZFgW6ZCBM9/W4H3iNSQqIe09O196dLKX7d1O39OViP/wthtkND62if/wj/DbMpph8BY/m9xy8BoBmQk+mHqZQGNy4JYRwCoRbwa8l4JXw6M+orJxpU0U6ToKy/5bQsAiTeokGKkTx46RRxxEUgrwGgF4MWNNEJCGgYTvpgnY1IJWg5RzfqLgvcIgktX0i8dmMlFA8qCQ5L0Z/WObPLUxT1i4lWSYDISoEfBYGvM+LlMQQdkLHoWRRZ8zYQI62Thswe5WTORGwNXDcGjqeOA9AF7B8rhzsxMBEoJ8oJKaqPu4hblHMCMPwl9XeNWyb8xkB/DDGYKfMAE6aFL7xesZ389JlgG3XHEMI6UPDOP6JHHu67T2pwNPI69mCP4rEaBDUAJaKc/AOuXiwH07VCS3w5+UQMAuF/WqGI+yFIwVNBwemBD4r0wgQiKoFZa00sEYTwss32lA1tPwVxtc8jQ5/gWCwmGCyUD8vRT0sHBFW4GJDvZmrJFWRY1EkrGA6ZB8/10fOZSSj0E6F+BSP7xidiIzhBmKB09lEwHPkG+UQIyEN44EBiT5vrv2uJXyPQqSqO930fxvcvwbR/+JAkD9EfASgI9EHlp6YiHO4W+cAB20SnrFqxBbNljiXf1Pl1K2S0HCWfiog3YlAD5RGwwxK6oUjTweuVigLjyB0mX410mAFnMoVK1lvvUvgt8fUJH0JVyjuvcmg4dE5mUiFtD24AZ4qBVELxXKS+pMxN43kSdzNwudJ+bQbLlmnxvPOQoCugSap1GnSRoG8KOiKbH+rIA0lEeSAg3y6eeQ6XI2nrYnrPM89bUTgI0Pdqvl50vlNbtZxDUBcLBK0kPd5jPziyLdojJIN0pq5/mdzwL4UVvVInV5ncQEPNOUxa9d0TU+CW5l+FoI0GSDKHVVSOs+0KOsZoxwOzSZNFGv0mQ9avyLCh2Hpm+70Y0YJoJVgmQv822wnDC8Miq6VjJ5IFed0QD1YiAbT+nQE8v/RMZfmgmcCRHIIu7Bmcp39oM9fqEychcA747KxQ/AEyqQonl7hATtJmnhO2XYtgcia01aSbVMenAXrIomPcLgEBA4liGBzFZAT8zBYqW6brI67wg8sFVhxBhwLwBP2+tqBQqqK7VJKGh/BRrfTr6nWL7nYBaZdBJHqrX3kPEPap56xwE/GvjJTRMADeMCdcGpGXL1Xh4ZL8BDOlWkUpegfi0CeDzeA5YITzEnddv+IXL+UYCmqIvqC9UlUC/ki9FipwVjunL3yX7dOTLeXmVMAhbsGporPfyOBTm/BJ23gTVehsvXRnSewagUfpBXF3p5pygKS7OceqTjb7h2vjr/XKm0ZofKSI2Q/J102wHzatZkJPYQ5JoKsuK+EoHJakVzubzuLQDepCKllTZi9AG0DYg9ZLxhFaZsOu7bvlmVI5oPXJMQJcHxHClSln1apFTvAimeg48u0RWFeZW4lVcjbQWZuIQK1KozZfIDO6CSQmQQXdpBaiKZyEWThVK1uEc6v7V7uK0ysduExPZx4vysDR+4SelhBYm0R6LBuR4PXts8MYMcJPsINo4YZCDLj0sgB0/vLpPXvA2Tn42Cv5rsLulGubzW0sEd3d4W/mJt2Kck+DzDMijfPLOjyrDhXSh852B+OvflqAkoyXO1cYfujtc/i3jJSAwhgfFlp20laMLOku/bC7prgqW7lCn4auE5NhcXPd3M7x70+IceSgZvNljCd9k3fLjYsPElqLR14PXQZqD2ZNkkrAB79UeJUebFQmXpf8ZcAQt2XrMQdyNUVBqZoUzAFyp3V3xi/MubUA/mCT4Fhf038PC8XplhWnCmnK/ZzyC2BSTRSqKVOuY2kB8Jia0lvvRIVoP+vVWJbYarf6p655E2/nANBMCWkgD49DA0VAMyI1OLFMYCXiU9bmzi9/y5i/vsaTpHPHidTofzLbM65vMPva9HlovgXp0AvjtaqYMfDD0/4mAsYE92pxa+9k1QgCnRVObCpojpzsKTPvayPetTEgBdwnssjuc0kOBFX+q3HwRQxdrOLAqeYRjkMk/trTSu2Z9Lik7CfF0AvjtqAhS4NHobGXUnB5DQs8hG8p/wMX1r4+8xkmyvQ50JVq72TVeXbz3HvpWaQJi57hJYTw4kGbtS+C2TigQUtZUX+X27QQq2ePBZBru/0lxTm8fOOQ5yaZOZMAV+he4FqIMB+LQB0UgMSajANX29j+vbmly8ipRvHeSQoQOkM5iFXcPQCVwDMs5RBCQmaPOyvbNd6uwvQJ183BZQG3Zc+Eiv7vQOKu8YeDmMcJlt2ckyftVeMIGLBCmdMHl/tFILYwGPjXWO3zOfSq/+om+oa7Mlh2fpSsRGLp7RAW3FUVjNHgiMhyE6zBFjM2BdkdJGO7nP1kJXWAtBuBpPIAu7f+hhu7bFXIuC5xWrf0X2xreykOsUyKkF2gwadbrXDcXrfKxR43zGcSj4t/cCgr+a1iy6EjE5GYktUCl9fwfMeylyooGF48bN2IGLTw8x7StS7sj8TF9FmPGWQhm3rRR+o9lhvjJvSYAdfDUevI1M6bnX/OwWaDMOQ8RPgKRo0eulBTdT8AW2kl8e9L7UHghHwMfLiZPNoSpx0yugpQZaFqKWqxVSM3a2pN1SAhC2jf94I7ybBI7EL5A2Wvu5ht3xsoEt4+Ay/abXgCQAxyOeDsDlTCQzy75ohcGgv9Tra9uiymRUYTLrswOLlCdfAQf7HPDQQ4ErAH5EDXB9cMxWYpjtXApRncojS0sbV/cCgHTHwGNBJy+1PQE2x56FpaVR7wfQGZ37V+V+19EiHNvR6q1fRUjqvbjbMq1/qfHxbTrE10ePY2gPFk48D2CVMTf1AF4PXvyYR9dV6Wf7H413m3xTWQvYGhQ7mfYwA5mAX+18Vue05v/8jG/fZX/IW5MKPKtjSYlt0ellxh+/BOCPAwYaeVr0QofZFxJWVWC8znG70au6llVmktsF0bfHF6k8fvZ5esZJbwHwwnjg59tXz6sL/P0NUZDuSNu1mnJ8Vab17+cy005A9wtOpp3i0bZdpJLUil00semAwN45LgEViZYe3amNye0B6A9chviSlzXVsFtyN5/1H3gaNmMpn8Fz0GpYFp6Zw615H/LpUuRQQDMCL82n5DpBSawkvzIdN2ypiT8nSLth8Pk9jnjwdFzH3W4XW6KMBfwB569NdcGX93mC16tTflcArcYUc/mFuYbV+8zY0SAjAVoNErNgWjtwumJ3wbn/HlBFYdxHvSkJJEc+Ngal9opSwyo9YlITX2C/P/+gf8sxURSLR+mcZUmeqaS9wrh6vxW5zxFCOqFi90RbDWq/YwZmnu1+a6OvdpvRqkNxxe44lyl4OobEnpKA6Uox5EfH9xzPs/HRKrTPWdIQrK1VZDU7ETiD3Obpl+8wPPCRBbkbwNtpW9AbBe5L1SMlj3tdTxk/9W47JUmqS5HU+JzYymUKXjtWVmT9RenIhgXc+nroWLyxXJhmL112OdB8GCsk4f8oZJucnvmmtR85mBn10GZ0EKSCMUSAR3ukcXd5s7LvLD3me61WkuTCpJzYAyRurMB44EdEJzTfU271lUJC03YjXJXzYOGZwN4D8eB5jlfLrdWfzGRW7icMPfiSO6Oe7s20bmhdgLX4Z23B+s3JgQESzUDiMboSzDMHFpNMwccGePauhfwjzwnI2wu9zKGgEFg80jcZ7MHllk07s1H+5yojtUQTlH4nFdLKTGwDmPbIklOb1L1zO4T6N8NCuDLFLS/C63c0eNRimZ++s5BMBHxU11jHchI9oFVUxRh/eMDzHEzGYu0Lg8gJ7oS/tFCwoic44fyUtix0n/46vP4bf+//BRgAYwDDar4ncHIAAAAASUVORK5CYII=';
   168|     }
   169| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Cache/Driver/Memcached.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-77 ---
    37|     public function get($name)
    38|     {
    39|         N('cache_read', 1);
    40|         return $this->handler->get($this->options['prefix'] . $name);
    41|     }
    42|     /**
    43|      * 写入缓存
    44|      * @access public
    45|      * @param string $name 缓存变量名
    46|      * @param mixed $value  存储数据
    47|      * @param integer $expire  有效时间（秒）
    48|      * @return boolean
    49|      */
    50|     public function set($name, $value, $expire = null)
    51|     {
    52|         N('cache_write', 1);
    53|         if (is_null($expire)) {
    54|             $expire = $this->options['expire'];
    55|         }
    56|         $name = $this->options['prefix'] . $name;
    57|         if ($this->handler->set($name, $value, time() + $expire)) {
    58|             if ($this->options['length'] > 0) {
    59|                 $this->queue($name);
    60|             }
    61|             return true;
    62|         }
    63|         return false;
    64|     }
    65|     /**
    66|      * 删除缓存
    67|      * @access public
    68|      * @param string $name 缓存变量名
    69|      * @return boolean
    70|      */
    71|     public function rm($name, $ttl = false)
    72|     {
    73|         $name = $this->options['prefix'] . $name;
    74|         return false === $ttl ?
    75|         $this->handler->delete($name) :
    76|         $this->handler->delete($name, $ttl);
    77|     }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Cache/Driver/Redis.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-53 ---
     3| use Think\Cache;
     4| /**
     5|  * Redis缓存驱动
     6|  * 要求安装phpredis扩展：https://github.com/nicolasff/phpredis
     7|  */
     8| class Redis extends Cache
     9| {
    10|     /**
    11|      * 架构函数
    12|      * @param array $options 缓存参数
    13|      * @access public
    14|      */
    15|     public function __construct($options = array())
    16|     {
    17|         if (!extension_loaded('redis')) {
    18|             E(L('_NOT_SUPPORT_') . ':redis');
    19|         }
    20|         $options = array_merge(array(
    21|             'host'       => C('REDIS_HOST') ?: '127.0.0.1',
    22|             'port'       => C('REDIS_PORT') ?: 6379,
    23|             'timeout'    => C('DATA_CACHE_TIMEOUT') ?: false,
    24|             'persistent' => false,
    25|         ), $options);
    26|         $this->options           = $options;
    27|         $this->options['expire'] = isset($options['expire']) ? $options['expire'] : C('DATA_CACHE_TIME');
    28|         $this->options['prefix'] = isset($options['prefix']) ? $options['prefix'] : C('DATA_CACHE_PREFIX');
    29|         $this->options['length'] = isset($options['length']) ? $options['length'] : 0;
    30|         $func                    = $options['persistent'] ? 'pconnect' : 'connect';
    31|         $this->handler           = new \Redis; false === $options['timeout'] ?
    32|         $this->handler->$func($options['host'], $options['port']) :
    33|         $this->handler->$func($options['host'], $options['port'], $options['timeout']);
    34|     }
    35|     /**
    36|      * 读取缓存
    37|      * @access public
    38|      * @param string $name 缓存变量名
    39|      * @return mixed
    40|      */
    41|     public function get($name)
    42|     {
    43|         N('cache_read', 1);
    44|         $value    = $this->handler->get($this->options['prefix'] . $name);
    45|         $jsonData = json_decode($value, true);
    46|         return (null === $jsonData) ? $value : $jsonData; //检测是否为JSON数据 true 返回JSON解析数组, false返回源数据
    47|     }
    48|     /**
    49|      * 写入缓存
    50|      * @access public
    51|      * @param string $name 缓存变量名
    52|      * @param mixed $value  存储数据
    53|      * @param integer $expire  有效时间（秒）


# ====================================================================
# FILE: ThinkPHP/Library/Think/Controller/RestController.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 56-116 ---
    56|                 App::invokeAction($this, $fun);
    57|             } elseif ($this->_type == $this->defaultType && method_exists($this, $method . '_' . $this->_method)) {
    58|                 $fun = $method . '_' . $this->_method;
    59|                 App::invokeAction($this, $fun);
    60|             } elseif (method_exists($this, '_empty')) {
    61|                 $this->_empty($method, $args);
    62|             } elseif (file_exists_case($this->view->parseTemplate())) {
    63|                 $this->display();
    64|             } else {
    65|                 E(L('_ERROR_ACTION_') . ':' . ACTION_NAME);
    66|             }
    67|         }
    68|     }
    69|     /**
    70|      * 获取当前请求的Accept头信息
    71|      * @return string
    72|      */
    73|     protected function getAcceptType()
    74|     {
    75|         $type = array(
    76|             'xml'  => 'application/xml,text/xml,application/x-xml',
    77|             'json' => 'application/json,text/x-json,application/jsonrequest,text/json',
    78|             'js'   => 'text/javascript,application/javascript,application/x-javascript',
    79|             'css'  => 'text/css',
    80|             'rss'  => 'application/rss+xml',
    81|             'yaml' => 'application/x-yaml,text/yaml',
    82|             'atom' => 'application/atom+xml',
    83|             'pdf'  => 'application/pdf',
    84|             'text' => 'text/plain',
    85|             'png'  => 'image/png',
    86|             'jpg'  => 'image/jpg,image/jpeg,image/pjpeg',
    87|             'gif'  => 'image/gif',
    88|             'csv'  => 'text/csv',
    89|             'html' => 'text/html,application/xhtml+xml,*/*',
    90|         );
    91|         foreach ($type as $key => $val) {
    92|             $array = explode(',', $val);
    93|             foreach ($array as $k => $v) {
    94|                 if (stristr($_SERVER['HTTP_ACCEPT'], $v)) {
    95|                     return $key;
    96|                 }
    97|             }
    98|         }
    99|         return false;
   100|     }
   101|     protected function sendHttpStatus($code)
   102|     {
   103|         static $_status = array(
   104|             100 => 'Continue',
   105|             101 => 'Switching Protocols',
   106|             200 => 'OK',
   107|             201 => 'Created',
   108|             202 => 'Accepted',
   109|             203 => 'Non-Authoritative Information',
   110|             204 => 'No Content',
   111|             205 => 'Reset Content',
   112|             206 => 'Partial Content',
   113|             300 => 'Multiple Choices',
   114|             301 => 'Moved Permanently',
   115|             302 => 'Moved Temporarily ', // 1.1
   116|             303 => 'See Other',

# --- HUNK 2: Lines 143-192 ---
   143|             505 => 'HTTP Version Not Supported',
   144|             509 => 'Bandwidth Limit Exceeded',
   145|         );
   146|         if (isset($_status[$code])) {
   147|             header('HTTP/1.1 ' . $code . ' ' . $_status[$code]);
   148|             header('Status:' . $code . ' ' . $_status[$code]);
   149|         }
   150|     }
   151|     /**
   152|      * 编码数据
   153|      * @access protected
   154|      * @param mixed $data 要返回的数据
   155|      * @param String $type 返回类型 JSON XML
   156|      * @return string
   157|      */
   158|     protected function encodeData($data, $type = '')
   159|     {
   160|         if (empty($data)) {
   161|             return '';
   162|         }
   163|         if ('json' == $type) {
   164|             $data = json_encode($data);
   165|         } elseif ('xml' == $type) {
   166|             $data = xml_encode($data);
   167|         } elseif ('php' == $type) {
   168|             $data = serialize($data);
   169|         } // 默认直接输出
   170|         $this->setContentType($type);
   171|         return $data;
   172|     }
   173|     /**
   174|      * 设置页面输出的CONTENT_TYPE和编码
   175|      * @access public
   176|      * @param string $type content_type 类型对应的扩展名
   177|      * @param string $charset 页面输出编码
   178|      * @return void
   179|      */
   180|     public function setContentType($type, $charset = '')
   181|     {
   182|         if (headers_sent()) {
   183|             return;
   184|         }
   185|         if (empty($charset)) {
   186|             $charset = C('DEFAULT_CHARSET');
   187|         }
   188|         $type = strtolower($type);
   189|         if (isset($this->allowOutputType[$type])) //过滤content_type
   190|         {
   191|             header('Content-Type: ' . $this->allowOutputType[$type] . '; charset=' . $charset);
   192|         }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 88-122 ---
    88|      * DSN解析
    89|      * 格式： mysql://username:passwd@localhost:3306/DbName?param1=val1&param2=val2#utf8
    90|      * @static
    91|      * @access private
    92|      * @param string $dsnStr
    93|      * @return array
    94|      */
    95|     private static function parseDsn($dsnStr)
    96|     {
    97|         if (empty($dsnStr)) {return false;}
    98|         $info = parse_url($dsnStr);
    99|         if (!$info) {
   100|             return false;
   101|         }
   102|         $dsn = array(
   103|             'type'     => $info['scheme'],
   104|             'username' => isset($info['user']) ? $info['user'] : '',
   105|             'password' => isset($info['pass']) ? $info['pass'] : '',
   106|             'hostname' => isset($info['host']) ? $info['host'] : '',
   107|             'hostport' => isset($info['port']) ? $info['port'] : '',
   108|             'database' => isset($info['path']) ? substr($info['path'], 1) : '',
   109|             'charset'  => isset($info['fragment']) ? $info['fragment'] : 'utf8',
   110|         );
   111|         if (isset($info['query'])) {
   112|             parse_str($info['query'], $dsn['params']);
   113|         } else {
   114|             $dsn['params'] = array();
   115|         }
   116|         return $dsn;
   117|     }
   118|     public static function __callStatic($method, $params)
   119|     {
   120|         return call_user_func_array(array(self::$_instance, $method), $params);
   121|     }
   122| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver.class.php
# Total hunks: 12
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| namespace Think\Db;
     3| use PDO;
     4| use Think\Config;
     5| use Think\Debug;
     6| abstract class Driver
     7| {
     8|     protected $PDOStatement = null;
     9|     protected $model = '_think_';
    10|     protected $queryStr = '';
    11|     protected $modelSql = array();
    12|     protected $lastInsID = null;
    13|     protected $numRows = 0;
    14|     protected $transTimes = 0;
    15|     protected $error = '';
    16|     protected $linkID = array();
    17|     protected $_linkID = null;
    18|     protected $config = array(
    19|         'type'           => '', // 数据库类型
    20|         'hostname'       => '127.0.0.1', // 服务器地址
    21|         'database'       => '', // 数据库名
    22|         'username'       => '', // 用户名
    23|         'password'       => '', // 密码
    24|         'hostport'       => '', // 端口
    25|         'dsn'            => '', //
    26|         'params'         => array(), // 数据库连接参数
    27|         'charset'        => 'utf8', // 数据库编码默认采用utf8
    28|         'prefix'         => '', // 数据库表前缀
    29|         'debug'          => false, // 数据库调试模式
    30|         'deploy'         => 0, // 数据库部署方式:0 集中式(单一服务器),1 分布式(主从服务器)
    31|         'rw_separate'    => false, // 数据库读写是否分离 主从式有效
    32|         'master_num'     => 1, // 读写分离后 主服务器数量
    33|         'slave_no'       => '', // 指定从服务器序号

# --- HUNK 2: Lines 91-135 ---
    91|      * 解析pdo连接的dsn信息
    92|      * @access public
    93|      * @param array $config 连接信息
    94|      * @return string
    95|      */
    96|     protected function parseDsn($config)
    97|     {}
    98|     /**
    99|      * 释放查询结果
   100|      * @access public
   101|      */
   102|     public function free()
   103|     {
   104|         $this->PDOStatement = null;
   105|     }
   106|     /**
   107|      * 执行查询 返回数据集
   108|      * @access public
   109|      * @param string $str  sql指令
   110|      * @param boolean $fetchSql  不执行只是获取SQL
   111|      * @return mixed
   112|      */
   113|     public function query($str, $fetchSql = false)
   114|     {
   115|         $this->initConnect(false);
   116|         if (!$this->_linkID) {
   117|             return false;
   118|         }
   119|         $this->queryStr = $str;
   120|         if (!empty($this->bind)) {
   121|             $that           = $this;
   122|             $this->queryStr = strtr($this->queryStr, array_map(function ($val) use ($that) {return '\'' . $that->escapeString($val) . '\'';}, $this->bind));
   123|         }
   124|         if ($fetchSql) {
   125|             return $this->queryStr;
   126|         }
   127|         if (!empty($this->PDOStatement)) {
   128|             $this->free();
   129|         }
   130|         $this->queryTimes++;
   131|         N('db_query', 1); // 兼容代码
   132|         $this->debug(true);
   133|         $this->PDOStatement = $this->_linkID->prepare($str);
   134|         if (false === $this->PDOStatement) {
   135|             $this->error();

# --- HUNK 3: Lines 210-281 ---
   210|                 }
   211|                 return $this->numRows;
   212|             }
   213|         } catch (\PDOException $e) {
   214|             $this->error();
   215|             return false;
   216|         }
   217|     }
   218|     /**
   219|      * 启动事务
   220|      * @access public
   221|      * @return void
   222|      */
   223|     public function startTrans()
   224|     {
   225|         $this->initConnect(true);
   226|         if (!$this->_linkID) {
   227|             return false;
   228|         }
   229|         if (0 == $this->transTimes) {
   230|             $this->_linkID->beginTransaction();
   231|         }
   232|         $this->transTimes++;
   233|         return;
   234|     }
   235|     /**
   236|      * 用于非自动提交状态下面的查询提交
   237|      * @access public
   238|      * @return boolean
   239|      */
   240|     public function commit()
   241|     {
   242|         if ($this->transTimes > 0) {
   243|             $result           = $this->_linkID->commit();
   244|             $this->transTimes = 0;
   245|             if (!$result) {
   246|                 $this->error();
   247|                 return false;
   248|             }
   249|         }
   250|         return true;
   251|     }
   252|     /**
   253|      * 事务回滚
   254|      * @access public
   255|      * @return boolean
   256|      */
   257|     public function rollback()
   258|     {
   259|         if ($this->transTimes > 0) {
   260|             $result           = $this->_linkID->rollback();
   261|             $this->transTimes = 0;
   262|             if (!$result) {
   263|                 $this->error();
   264|                 return false;
   265|             }
   266|         }
   267|         return true;
   268|     }
   269|     /**
   270|      * 获得所有的查询数据
   271|      * @access private
   272|      * @return array
   273|      */
   274|     private function getResult()
   275|     {
   276|         $result        = $this->PDOStatement->fetchAll(PDO::FETCH_ASSOC);
   277|         $this->numRows = count($result);
   278|         return $result;
   279|     }
   280|     /**
   281|      * 获得查询次数

# --- HUNK 4: Lines 329-402 ---
   329|         }
   330|     }
   331|     /**
   332|      * 设置锁机制
   333|      * @access protected
   334|      * @return string
   335|      */
   336|     protected function parseLock($lock = false)
   337|     {
   338|         return $lock ? ' FOR UPDATE ' : '';
   339|     }
   340|     /**
   341|      * set分析
   342|      * @access protected
   343|      * @param array $data
   344|      * @return string
   345|      */
   346|     protected function parseSet($data)
   347|     {
   348|         foreach ($data as $key => $val) {
   349|             if (is_array($val) && 'exp' == $val[0]) {
   350|                 $set[] = $this->parseKey($key) . '=' . $val[1];
   351|             } elseif (is_null($val)) {
   352|                 $set[] = $this->parseKey($key) . '=NULL';
   353|             } elseif (is_scalar($val)) {
   354|                 if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
   355|                     $set[] = $this->parseKey($key) . '=' . $this->escapeString($val);
   356|                 } else {
   357|                     $name  = count($this->bind);
   358|                     $set[] = $this->parseKey($key) . '=:' . $name;
   359|                     $this->bindParam($name, $val);
   360|                 }
   361|             }
   362|         }
   363|         return ' SET ' . implode(',', $set);
   364|     }
   365|     /**
   366|      * 参数绑定
   367|      * @access protected
   368|      * @param string $name 绑定参数名
   369|      * @param mixed $value 绑定值
   370|      * @return void
   371|      */
   372|     protected function bindParam($name, $value)
   373|     {
   374|         $this->bind[':' . $name] = $value;
   375|     }
   376|     /**
   377|      * 字段名分析
   378|      * @access protected
   379|      * @param string $key
   380|      * @return string
   381|      */
   382|     protected function parseKey(&$key)
   383|     {
   384|         return $key;
   385|     }
   386|     /**
   387|      * value分析
   388|      * @access protected
   389|      * @param mixed $value
   390|      * @return string
   391|      */
   392|     protected function parseValue($value)
   393|     {
   394|         if (is_string($value)) {
   395|             $value = strpos($value, ':') === 0 && in_array($value, array_keys($this->bind)) ? $this->escapeString($value) : '\'' . $this->escapeString($value) . '\'';
   396|         } elseif (isset($value[0]) && is_string($value[0]) && strtolower($value[0]) == 'exp') {
   397|             $value = $this->escapeString($value[1]);
   398|         } elseif (is_array($value)) {
   399|             $value = array_map(array($this, 'parseValue'), $value);
   400|         } elseif (is_bool($value)) {
   401|             $value = $value ? '1' : '0';
   402|         } elseif (is_null($value)) {

# --- HUNK 5: Lines 432-473 ---
   432|     }
   433|     /**
   434|      * table分析
   435|      * @access protected
   436|      * @param mixed $table
   437|      * @return string
   438|      */
   439|     protected function parseTable($tables)
   440|     {
   441|         if (is_array($tables)) {
   442|             $array = array();
   443|             foreach ($tables as $table => $alias) {
   444|                 if (!is_numeric($table)) {
   445|                     $array[] = $this->parseKey($table) . ' ' . $this->parseKey($alias);
   446|                 } else {
   447|                     $array[] = $this->parseKey($alias);
   448|                 }
   449|             }
   450|             $tables = $array;
   451|         } elseif (is_string($tables)) {
   452|             $tables = explode(',', $tables);
   453|             array_walk($tables, array(&$this, 'parseKey'));
   454|         }
   455|         return implode(',', $tables);
   456|     }
   457|     /**
   458|      * where分析
   459|      * @access protected
   460|      * @param mixed $where
   461|      * @return string
   462|      */
   463|     protected function parseWhere($where)
   464|     {
   465|         $whereStr = '';
   466|         if (is_string($where)) {
   467|             $whereStr = $where;
   468|         } else {
   469|             $operate = isset($where['_logic']) ? strtoupper($where['_logic']) : '';
   470|             if (in_array($operate, array('AND', 'OR', 'XOR'))) {
   471|                 $operate = ' ' . $operate . ' ';
   472|                 unset($where['_logic']);
   473|             } else {

# --- HUNK 6: Lines 602-676 ---
   602|                 } else {
   603|                     $op = ' AND ';
   604|                 }
   605|                 $array = array();
   606|                 foreach ($where as $field => $data) {
   607|                     $array[] = $this->parseKey($field) . ' = ' . $this->parseValue($data);
   608|                 }
   609|                 $whereStr = implode($op, $array);
   610|                 break;
   611|         }
   612|         return '( ' . $whereStr . ' )';
   613|     }
   614|     /**
   615|      * limit分析
   616|      * @access protected
   617|      * @param mixed $lmit
   618|      * @return string
   619|      */
   620|     protected function parseLimit($limit)
   621|     {
   622|         return !empty($limit) ? ' LIMIT ' . $limit . ' ' : '';
   623|     }
   624|     /**
   625|      * join分析
   626|      * @access protected
   627|      * @param mixed $join
   628|      * @return string
   629|      */
   630|     protected function parseJoin($join)
   631|     {
   632|         $joinStr = '';
   633|         if (!empty($join)) {
   634|             $joinStr = ' ' . implode(' ', $join) . ' ';
   635|         }
   636|         return $joinStr;
   637|     }
   638|     /**
   639|      * order分析
   640|      * @access protected
   641|      * @param mixed $order
   642|      * @return string
   643|      */
   644|     protected function parseOrder($order)
   645|     {
   646|         if (is_array($order)) {
   647|             $array = array();
   648|             foreach ($order as $key => $val) {
   649|                 if (is_numeric($key)) {
   650|                     $array[] = $this->parseKey($val);
   651|                 } else {
   652|                     $array[] = $this->parseKey($key) . ' ' . $val;
   653|                 }
   654|             }
   655|             $order = implode(',', $array);
   656|         }
   657|         return !empty($order) ? ' ORDER BY ' . $order : '';
   658|     }
   659|     /**
   660|      * group分析
   661|      * @access protected
   662|      * @param mixed $group
   663|      * @return string
   664|      */
   665|     protected function parseGroup($group)
   666|     {
   667|         return !empty($group) ? ' GROUP BY ' . $group : '';
   668|     }
   669|     /**
   670|      * having分析
   671|      * @access protected
   672|      * @param string $having
   673|      * @return string
   674|      */
   675|     protected function parseHaving($having)
   676|     {

# --- HUNK 7: Lines 751-869 ---
   751|      * @return string
   752|      */
   753|     protected function parseDuplicate($duplicate)
   754|     {
   755|         return '';
   756|     }
   757|     /**
   758|      * 插入记录
   759|      * @access public
   760|      * @param mixed $data 数据
   761|      * @param array $options 参数表达式
   762|      * @param boolean $replace 是否replace
   763|      * @return false | integer
   764|      */
   765|     public function insert($data, $options = array(), $replace = false)
   766|     {
   767|         $values      = $fields      = array();
   768|         $this->model = $options['model'];
   769|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   770|         foreach ($data as $key => $val) {
   771|             if (is_array($val) && 'exp' == $val[0]) {
   772|                 $fields[] = $this->parseKey($key);
   773|                 $values[] = $val[1];
   774|             } elseif (is_null($val)) {
   775|                 $fields[] = $this->parseKey($key);
   776|                 $values[] = 'NULL';
   777|             } elseif (is_scalar($val)) {
   778|                 $fields[] = $this->parseKey($key);
   779|                 if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
   780|                     $values[] = $this->parseValue($val);
   781|                 } else {
   782|                     $name     = count($this->bind);
   783|                     $values[] = ':' . $name;
   784|                     $this->bindParam($name, $val);
   785|                 }
   786|             }
   787|         }
   788|         $replace = (is_numeric($replace) && $replace > 0) ? true : $replace;
   789|         $sql     = (true === $replace ? 'REPLACE' : 'INSERT') . ' INTO ' . $this->parseTable($options['table']) . ' (' . implode(',', $fields) . ') VALUES (' . implode(',', $values) . ')' . $this->parseDuplicate($replace);
   790|         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
   791|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   792|     }
   793|     /**
   794|      * 批量插入记录
   795|      * @access public
   796|      * @param mixed $dataSet 数据集
   797|      * @param array $options 参数表达式
   798|      * @param boolean $replace 是否replace
   799|      * @return false | integer
   800|      */
   801|     public function insertAll($dataSet, $options = array(), $replace = false)
   802|     {
   803|         $values      = array();
   804|         $this->model = $options['model'];
   805|         if (!is_array($dataSet[0])) {
   806|             return false;
   807|         }
   808|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   809|         $fields = array_map(array($this, 'parseKey'), array_keys($dataSet[0]));
   810|         foreach ($dataSet as $data) {
   811|             $value = array();
   812|             foreach ($data as $key => $val) {
   813|                 if (is_array($val) && 'exp' == $val[0]) {
   814|                     $value[] = $val[1];
   815|                 } elseif (is_null($val)) {
   816|                     $value[] = 'NULL';
   817|                 } elseif (is_scalar($val)) {
   818|                     if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
   819|                         $value[] = $this->parseValue($val);
   820|                     } else {
   821|                         $name    = count($this->bind);
   822|                         $value[] = ':' . $name;
   823|                         $this->bindParam($name, $val);
   824|                     }
   825|                 }
   826|             }
   827|             $values[] = 'SELECT ' . implode(',', $value);
   828|         }
   829|         $sql = 'INSERT INTO ' . $this->parseTable($options['table']) . ' (' . implode(',', $fields) . ') ' . implode(' UNION ALL ', $values);
   830|         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
   831|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   832|     }
   833|     /**
   834|      * 通过Select方式插入记录
   835|      * @access public
   836|      * @param string $fields 要插入的数据表字段名
   837|      * @param string $table 要插入的数据表名
   838|      * @param array $option  查询数据参数
   839|      * @return false | integer
   840|      */
   841|     public function selectInsert($fields, $table, $options = array())
   842|     {
   843|         $this->model = $options['model'];
   844|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   845|         if (is_string($fields)) {
   846|             $fields = explode(',', $fields);
   847|         }
   848|         array_walk($fields, array($this, 'parseKey'));
   849|         $sql = 'INSERT INTO ' . $this->parseTable($table) . ' (' . implode(',', $fields) . ') ';
   850|         $sql .= $this->buildSelectSql($options);
   851|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   852|     }
   853|     /**
   854|      * 更新记录
   855|      * @access public
   856|      * @param mixed $data 数据
   857|      * @param array $options 表达式
   858|      * @return false | integer
   859|      */
   860|     public function update($data, $options)
   861|     {
   862|         $this->model = $options['model'];
   863|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   864|         $table = $this->parseTable($options['table']);
   865|         $sql   = 'UPDATE ' . $table . $this->parseSet($data);
   866|         if (strpos($table, ',')) {
   867|             $sql .= $this->parseJoin(!empty($options['join']) ? $options['join'] : '');
   868|         }
   869|         $sql .= $this->parseWhere(!empty($options['where']) ? $options['where'] : '');

# --- HUNK 8: Lines 894-934 ---
   894|         }
   895|         $sql .= $this->parseWhere(!empty($options['where']) ? $options['where'] : '');
   896|         if (!strpos($table, ',')) {
   897|             $sql .= $this->parseOrder(!empty($options['order']) ? $options['order'] : '')
   898|             . $this->parseLimit(!empty($options['limit']) ? $options['limit'] : '');
   899|         }
   900|         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
   901|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   902|     }
   903|     /**
   904|      * 查找记录
   905|      * @access public
   906|      * @param array $options 表达式
   907|      * @return mixed
   908|      */
   909|     public function select($options = array())
   910|     {
   911|         $this->model = $options['model'];
   912|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   913|         $sql    = $this->buildSelectSql($options);
   914|         $result = $this->query($sql, !empty($options['fetch_sql']) ? true : false);
   915|         return $result;
   916|     }
   917|     /**
   918|      * 生成查询SQL
   919|      * @access public
   920|      * @param array $options 表达式
   921|      * @return string
   922|      */
   923|     public function buildSelectSql($options = array())
   924|     {
   925|         if (isset($options['page'])) {
   926|             list($page, $listRows) = $options['page'];
   927|             $page                  = $page > 0 ? $page : 1;
   928|             $listRows              = $listRows > 0 ? $listRows : (is_numeric($options['limit']) ? $options['limit'] : 20);
   929|             $offset                = $listRows * ($page - 1);
   930|             $options['limit']      = $offset . ',' . $listRows;
   931|         }
   932|         $sql = $this->parseSql($this->selectSql, $options);
   933|         return $sql;
   934|     }

# --- HUNK 9: Lines 1015-1054 ---
  1015|     protected function debug($start)
  1016|     {
  1017|         if ($this->config['debug']) {
  1018|             if ($start) {
  1019|                 G('queryStartTime');
  1020|             } else {
  1021|                 $this->modelSql[$this->model] = $this->queryStr;
  1022|                 G('queryEndTime');
  1023|                 trace($this->queryStr . ' [ RunTime:' . G('queryStartTime', 'queryEndTime') . 's ]', '', 'SQL');
  1024|             }
  1025|         }
  1026|     }
  1027|     /**
  1028|      * 初始化数据库连接
  1029|      * @access protected
  1030|      * @param boolean $master 主服务器
  1031|      * @return void
  1032|      */
  1033|     protected function initConnect($master = true)
  1034|     {
  1035|         if (!empty($this->config['deploy']))
  1036|         {
  1037|             $this->_linkID = $this->multiConnect($master);
  1038|         } else
  1039|         if (!$this->_linkID) {
  1040|             $this->_linkID = $this->connect();
  1041|         }
  1042|     }
  1043|     /**
  1044|      * 连接分布式服务器
  1045|      * @access protected
  1046|      * @param boolean $master 主服务器
  1047|      * @return void
  1048|      */
  1049|     protected function multiConnect($master = false)
  1050|     {
  1051|         $_config['username'] = explode(',', $this->config['username']);
  1052|         $_config['password'] = explode(',', $this->config['password']);
  1053|         $_config['hostname'] = explode(',', $this->config['hostname']);
  1054|         $_config['hostport'] = explode(',', $this->config['hostport']);


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Firebird.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 123-143 ---
   123|     }
   124|     /**
   125|      * limit
   126|      * @access public
   127|      * @param $limit limit表达式
   128|      * @return string
   129|      */
   130|     public function parseLimit($limit)
   131|     {
   132|         $limitStr = '';
   133|         if (!empty($limit)) {
   134|             $limit = explode(',', $limit);
   135|             if (count($limit) > 1) {
   136|                 $limitStr = ' FIRST ' . $limit[1] . ' SKIP ' . $limit[0] . ' ';
   137|             } else {
   138|                 $limitStr = ' FIRST ' . $limit[0] . ' ';
   139|             }
   140|         }
   141|         return $limitStr;
   142|     }
   143| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Mongo.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 220-261 ---
   220|             $this->switchCollection($options['table']);
   221|         }
   222|         $this->model = $options['model'];
   223|         $this->executeTimes++;
   224|         N('db_write', 1); // 兼容代码
   225|         try {
   226|             $this->debug(true);
   227|             $result = $this->_collection->batchInsert($dataList);
   228|             $this->debug(false);
   229|             return $result;
   230|         } catch (\MongoCursorException $e) {
   231|             E($e->getMessage());
   232|         }
   233|     }
   234|     /**
   235|      * 生成下一条记录ID 用于自增非MongoId主键
   236|      * @access public
   237|      * @param string $pk 主键名
   238|      * @return integer
   239|      */
   240|     public function getMongoNextId($pk)
   241|     {
   242|         if ($this->config['debug']) {
   243|             $this->queryStr = $this->_dbName . '.' . $this->_collectionName . '.find({},{' . $pk . ':1}).sort({' . $pk . ':-1}).limit(1)';
   244|         }
   245|         try {
   246|             $this->debug(true);
   247|             $result = $this->_collection->find(array(), array($pk => 1))->sort(array($pk => -1))->limit(1);
   248|             $this->debug(false);
   249|         } catch (\MongoCursorException $e) {
   250|             E($e->getMessage());
   251|         }
   252|         $data = $result->getNext();
   253|         return isset($data[$pk]) ? $data[$pk] + 1 : 1;
   254|     }
   255|     /**
   256|      * 更新记录
   257|      * @access public
   258|      * @param mixed $data 数据
   259|      * @param array $options 表达式
   260|      * @return bool
   261|      */

# --- HUNK 2: Lines 455-496 ---
   455|         $cache = isset($options['cache']) ? $options['cache'] : false;
   456|         if ($cache) {
   457|             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
   458|             $value = S($key, '', '', $cache['type']);
   459|             if (false !== $value) {
   460|                 return $value;
   461|             }
   462|         }
   463|         $this->model = $options['model'];
   464|         $this->queryTimes++;
   465|         N('db_query', 1); // 兼容代码
   466|         $query = $this->parseWhere(isset($options['where']) ? $options['where'] : array());
   467|         if ($this->config['debug']) {
   468|             $this->queryStr = $this->_dbName . '.' . $this->_collectionName . '.group({key:' . json_encode($keys) . ',cond:' .
   469|             json_encode($options['condition']) . ',reduce:' .
   470|             json_encode($reduce) . ',initial:' .
   471|             json_encode($initial) . '})';
   472|         }
   473|         try {
   474|             $this->debug(true);
   475|             $option = array('condition' => $options['condition'], 'finalize' => $options['finalize'], 'maxTimeMS' => $options['maxTimeMS']);
   476|             $group  = $this->_collection->group($keys, $initial, $reduce, $options);
   477|             $this->debug(false);
   478|             if ($cache && $group['ok']) {
   479|                 S($key, $group, $cache['expire'], $cache['type']);
   480|             }
   481|             return $group;
   482|         } catch (\MongoCursorException $e) {
   483|             E($e->getMessage());
   484|         }
   485|     }
   486|     /**
   487|      * 取得数据表的字段信息
   488|      * @access public
   489|      * @return array
   490|      */
   491|     public function getFields($collection = '')
   492|     {
   493|         if (!empty($collection) && $collection != $this->_collectionName) {
   494|             $this->switchCollection($collection, '', false);
   495|         }
   496|         $this->queryTimes++;

# --- HUNK 3: Lines 551-591 ---
   551|      * @access public
   552|      * @return object MongoCollection
   553|      */
   554|     public function getCollection()
   555|     {
   556|         return $this->_collection;
   557|     }
   558|     /**
   559|      * set分析
   560|      * @access protected
   561|      * @param array $data
   562|      * @return string
   563|      */
   564|     protected function parseSet($data)
   565|     {
   566|         $result = array();
   567|         foreach ($data as $key => $val) {
   568|             if (is_array($val)) {
   569|                 switch ($val[0]) {
   570|                     case 'inc':
   571|                         $result['$inc'][$key] = (int) $val[1];
   572|                         break;
   573|                     case 'set':
   574|                     case 'unset':
   575|                     case 'push':
   576|                     case 'pushall':
   577|                     case 'addtoset':
   578|                     case 'pop':
   579|                     case 'pull':
   580|                     case 'pullall':
   581|                         $result['$' . $val[0]][$key] = $val[1];
   582|                         break;
   583|                     default:
   584|                         $result['$set'][$key] = $val;
   585|                 }
   586|             } else {
   587|                 $result['$set'][$key] = $val;
   588|             }
   589|         }
   590|         return $result;
   591|     }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Mysql.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 60-108 ---
    60|         return $info;
    61|     }
    62|     /**
    63|      * 取得数据库的表信息
    64|      * @access public
    65|      */
    66|     public function getTables($dbName = '')
    67|     {
    68|         $sql    = !empty($dbName) ? 'SHOW TABLES FROM ' . $dbName : 'SHOW TABLES ';
    69|         $result = $this->query($sql);
    70|         $info   = array();
    71|         foreach ($result as $key => $val) {
    72|             $info[$key] = current($val);
    73|         }
    74|         return $info;
    75|     }
    76|     /**
    77|      * 字段和表名处理
    78|      * @access protected
    79|      * @param string $key
    80|      * @return string
    81|      */
    82|     protected function parseKey(&$key)
    83|     {
    84|         $key = trim($key);
    85|         if (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)`.\s]/', $key)) {
    86|             $key = '`' . $key . '`';
    87|         }
    88|         return $key;
    89|     }
    90|     /**
    91|      * 批量插入记录
    92|      * @access public
    93|      * @param mixed $dataSet 数据集
    94|      * @param array $options 参数表达式
    95|      * @param boolean $replace 是否replace
    96|      * @return false | integer
    97|      */
    98|     public function insertAll($dataSet, $options = array(), $replace = false)
    99|     {
   100|         $values      = array();
   101|         $this->model = $options['model'];
   102|         if (!is_array($dataSet[0])) {
   103|             return false;
   104|         }
   105|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   106|         $fields = array_map(array($this, 'parseKey'), array_keys($dataSet[0]));
   107|         foreach ($dataSet as $data) {
   108|             $value = array();

# --- HUNK 2: Lines 136-176 ---
   136|      */
   137|     protected function parseDuplicate($duplicate)
   138|     {
   139|         if (is_bool($duplicate) || empty($duplicate)) {
   140|             return '';
   141|         }
   142|         if (is_string($duplicate)) {
   143|             $duplicate = explode(',', $duplicate);
   144|         } elseif (is_object($duplicate)) {
   145|             $duplicate = get_class_vars($duplicate);
   146|         }
   147|         $updates = array();
   148|         foreach ((array) $duplicate as $key => $val) {
   149|             if (is_numeric($key)) {
   150|                 $updates[] = $this->parseKey($val) . "=VALUES(" . $this->parseKey($val) . ")";
   151|             } else {
   152|                 if (is_scalar($val)) // 兼容标量传值方式
   153|                 {
   154|                     $val = array('value', $val);
   155|                 }
   156|                 if (!isset($val[1])) {
   157|                     continue;
   158|                 }
   159|                 switch ($val[0]) {
   160|                     case 'exp': // 表达式
   161|                         $updates[] = $this->parseKey($key) . "=($val[1])";
   162|                         break;
   163|                     case 'value': // 值
   164|                     default:
   165|                         $name      = count($this->bind);
   166|                         $updates[] = $this->parseKey($key) . "=:" . $name;
   167|                         $this->bindParam($name, $val[1]);
   168|                         break;
   169|                 }
   170|             }
   171|         }
   172|         if (empty($updates)) {
   173|             return '';
   174|         }
   175|         return " ON DUPLICATE KEY UPDATE " . join(', ', $updates);
   176|     }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Oracle.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 142-162 ---
   142|             if (count($limit) > 1) {
   143|                 $limitStr = "(numrow>" . $limit[0] . ") AND (numrow<=" . ($limit[0] + $limit[1]) . ")";
   144|             } else {
   145|                 $limitStr = "(numrow>0 AND numrow<=" . $limit[0] . ")";
   146|             }
   147|         }
   148|         return $limitStr ? ' WHERE ' . $limitStr : '';
   149|     }
   150|     /**
   151|      * 设置锁机制
   152|      * @access protected
   153|      * @return string
   154|      */
   155|     protected function parseLock($lock = false)
   156|     {
   157|         if (!$lock) {
   158|             return '';
   159|         }
   160|         return ' FOR UPDATE NOWAIT ';
   161|     }
   162| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Pgsql.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 11-51 ---
    11|      * @access public
    12|      * @param array $config 连接信息
    13|      * @return string
    14|      */
    15|     protected function parseDsn($config)
    16|     {
    17|         $dsn = 'pgsql:dbname=' . $config['database'] . ';host=' . $config['hostname'];
    18|         if (!empty($config['hostport'])) {
    19|             $dsn .= ';port=' . $config['hostport'];
    20|         }
    21|         return $dsn;
    22|     }
    23|     /**
    24|      * 取得数据表的字段信息
    25|      * @access public
    26|      * @return array
    27|      */
    28|     public function getFields($tableName)
    29|     {
    30|         list($tableName) = explode(' ', $tableName);
    31|         $result          = $this->query('select fields_name as "field",fields_type as "type",fields_not_null as "null",fields_key_name as "key",fields_default as "default",fields_default as "extra" from table_msg(' . $tableName . ');');
    32|         $info            = array();
    33|         if ($result) {
    34|             foreach ($result as $key => $val) {
    35|                 $info[$val['field']] = array(
    36|                     'name'    => $val['field'],
    37|                     'type'    => $val['type'],
    38|                     'notnull' => (bool) ('' === $val['null']), // not null is empty, null is yes
    39|                     'default' => $val['default'],
    40|                     'primary' => (strtolower($val['key']) == 'pri'),
    41|                     'autoinc' => (strtolower($val['extra']) == 'auto_increment'),
    42|                 );
    43|             }
    44|         }
    45|         return $info;
    46|     }
    47|     /**
    48|      * 取得数据库的表信息
    49|      * @access public
    50|      * @return array
    51|      */

# --- HUNK 2: Lines 60-80 ---
    60|     }
    61|     /**
    62|      * limit分析
    63|      * @access protected
    64|      * @param mixed $lmit
    65|      * @return string
    66|      */
    67|     public function parseLimit($limit)
    68|     {
    69|         $limitStr = '';
    70|         if (!empty($limit)) {
    71|             $limit = explode(',', $limit);
    72|             if (count($limit) > 1) {
    73|                 $limitStr .= ' LIMIT ' . $limit[1] . ' OFFSET ' . $limit[0] . ' ';
    74|             } else {
    75|                 $limitStr .= ' LIMIT ' . $limit[0] . ' ';
    76|             }
    77|         }
    78|         return $limitStr;
    79|     }
    80| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Sqlite.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 12-58 ---
    12|      * @param array $config 连接信息
    13|      * @return string
    14|      */
    15|     protected function parseDsn($config)
    16|     {
    17|         $dsn = 'sqlite:' . $config['database'];
    18|         return $dsn;
    19|     }
    20|     /**
    21|      * 取得数据表的字段信息
    22|      * @access public
    23|      * @return array
    24|      */
    25|     public function getFields($tableName)
    26|     {
    27|         list($tableName) = explode(' ', $tableName);
    28|         $result          = $this->query('PRAGMA table_info( ' . $tableName . ' )');
    29|         $info            = array();
    30|         if ($result) {
    31|             foreach ($result as $key => $val) {
    32|                 $info[$val['field']] = array(
    33|                     'name'    => $val['field'],
    34|                     'type'    => $val['type'],
    35|                     'notnull' => (bool) ('' === $val['null']), // not null is empty, null is yes
    36|                     'default' => $val['default'],
    37|                     'primary' => (strtolower($val['dey']) == 'pri'),
    38|                     'autoinc' => (strtolower($val['extra']) == 'auto_increment'),
    39|                 );
    40|             }
    41|         }
    42|         return $info;
    43|     }
    44|     /**
    45|      * 取得数据库的表信息
    46|      * @access public
    47|      * @return array
    48|      */
    49|     public function getTables($dbName = '')
    50|     {
    51|         $result = $this->query("SELECT name FROM sqlite_master WHERE type='table' "
    52|             . "UNION ALL SELECT name FROM sqlite_temp_master "
    53|             . "WHERE type='table' ORDER BY name");
    54|         $info = array();
    55|         foreach ($result as $key => $val) {
    56|             $info[$key] = current($val);
    57|         }
    58|         return $info;

# --- HUNK 2: Lines 68-88 ---
    68|         return str_ireplace("'", "''", $str);
    69|     }
    70|     /**
    71|      * limit
    72|      * @access public
    73|      * @return string
    74|      */
    75|     public function parseLimit($limit)
    76|     {
    77|         $limitStr = '';
    78|         if (!empty($limit)) {
    79|             $limit = explode(',', $limit);
    80|             if (count($limit) > 1) {
    81|                 $limitStr .= ' LIMIT ' . $limit[1] . ' OFFSET ' . $limit[0] . ' ';
    82|             } else {
    83|                 $limitStr .= ' LIMIT ' . $limit[0] . ' ';
    84|             }
    85|         }
    86|         return $limitStr;
    87|     }
    88| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Sqlsrv.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 69-117 ---
    69|             FROM INFORMATION_SCHEMA.TABLES
    70|             WHERE TABLE_TYPE = 'BASE TABLE'
    71|             ");
    72|         $info = array();
    73|         foreach ($result as $key => $val) {
    74|             $info[$key] = current($val);
    75|         }
    76|         return $info;
    77|     }
    78|     /**
    79|      * order分析
    80|      * @access protected
    81|      * @param mixed $order
    82|      * @return string
    83|      */
    84|     protected function parseOrder($order)
    85|     {
    86|         return !empty($order) ? ' ORDER BY ' . $order : ' ORDER BY rand()';
    87|     }
    88|     /**
    89|      * 字段名分析
    90|      * @access protected
    91|      * @param string $key
    92|      * @return string
    93|      */
    94|     protected function parseKey(&$key)
    95|     {
    96|         $key = trim($key);
    97|         if (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)\[.\s]/', $key)) {
    98|             $key = '[' . $key . ']';
    99|         }
   100|         return $key;
   101|     }
   102|     /**
   103|      * limit
   104|      * @access public
   105|      * @param mixed $limit
   106|      * @return string
   107|      */
   108|     public function parseLimit($limit)
   109|     {
   110|         if (empty($limit)) {
   111|             return '';
   112|         }
   113|         $limit = explode(',', $limit);
   114|         if (count($limit) > 1) {
   115|             $limitStr = '(T1.ROW_NUMBER BETWEEN ' . $limit[0] . ' + 1 AND ' . $limit[0] . ' + ' . $limit[1] . ')';
   116|         } else {
   117|             $limitStr = '(T1.ROW_NUMBER BETWEEN 1 AND ' . $limit[0] . ")";


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Lite.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| <?php
     2| namespace Think\Db;
     3| use PDO;
     4| use Think\Config;
     5| use Think\Debug;
     6| class Lite
     7| {
     8|     protected $PDOStatement = null;
     9|     protected $model = '_think_';
    10|     protected $queryStr = '';
    11|     protected $modelSql = array();
    12|     protected $lastInsID = null;
    13|     protected $numRows = 0;
    14|     protected $transTimes = 0;
    15|     protected $error = '';
    16|     protected $linkID = array();
    17|     protected $_linkID = null;
    18|     protected $config = array(
    19|         'type'        => '', // 数据库类型
    20|         'hostname'    => '127.0.0.1', // 服务器地址
    21|         'database'    => '', // 数据库名
    22|         'username'    => '', // 用户名
    23|         'password'    => '', // 密码
    24|         'hostport'    => '', // 端口
    25|         'dsn'         => '', //
    26|         'params'      => array(), // 数据库连接参数
    27|         'charset'     => 'utf8', // 数据库编码默认采用utf8
    28|         'prefix'      => '', // 数据库表前缀
    29|         'debug'       => false, // 数据库调试模式
    30|         'deploy'      => 0, // 数据库部署方式:0 集中式(单一服务器),1 分布式(主从服务器)
    31|         'rw_separate' => false, // 数据库读写是否分离 主从式有效
    32|         'master_num'  => 1, // 读写分离后 主服务器数量
    33|         'slave_no'    => '', // 指定从服务器序号

# --- HUNK 2: Lines 183-254 ---
   183|         } else {
   184|             $this->numRows = $this->PDOStatement->rowCount();
   185|             if (preg_match("/^\s*(INSERT\s+INTO|REPLACE\s+INTO)\s+/i", $str)) {
   186|                 $this->lastInsID = $this->_linkID->lastInsertId();
   187|             }
   188|             return $this->numRows;
   189|         }
   190|     }
   191|     /**
   192|      * 启动事务
   193|      * @access public
   194|      * @return void
   195|      */
   196|     public function startTrans()
   197|     {
   198|         $this->initConnect(true);
   199|         if (!$this->_linkID) {
   200|             return false;
   201|         }
   202|         if (0 == $this->transTimes) {
   203|             $this->_linkID->beginTransaction();
   204|         }
   205|         $this->transTimes++;
   206|         return;
   207|     }
   208|     /**
   209|      * 用于非自动提交状态下面的查询提交
   210|      * @access public
   211|      * @return boolean
   212|      */
   213|     public function commit()
   214|     {
   215|         if ($this->transTimes > 0) {
   216|             $result           = $this->_linkID->commit();
   217|             $this->transTimes = 0;
   218|             if (!$result) {
   219|                 $this->error();
   220|                 return false;
   221|             }
   222|         }
   223|         return true;
   224|     }
   225|     /**
   226|      * 事务回滚
   227|      * @access public
   228|      * @return boolean
   229|      */
   230|     public function rollback()
   231|     {
   232|         if ($this->transTimes > 0) {
   233|             $result           = $this->_linkID->rollback();
   234|             $this->transTimes = 0;
   235|             if (!$result) {
   236|                 $this->error();
   237|                 return false;
   238|             }
   239|         }
   240|         return true;
   241|     }
   242|     /**
   243|      * 获得所有的查询数据
   244|      * @access private
   245|      * @return array
   246|      */
   247|     private function getResult()
   248|     {
   249|         $result        = $this->PDOStatement->fetchAll(PDO::FETCH_ASSOC);
   250|         $this->numRows = count($result);
   251|         return $result;
   252|     }
   253|     /**
   254|      * 获得查询次数

# --- HUNK 3: Lines 357-396 ---
   357|     protected function debug($start)
   358|     {
   359|         if ($this->config['debug']) {
   360|             if ($start) {
   361|                 G('queryStartTime');
   362|             } else {
   363|                 $this->modelSql[$this->model] = $this->queryStr;
   364|                 G('queryEndTime');
   365|                 trace($this->queryStr . ' [ RunTime:' . G('queryStartTime', 'queryEndTime') . 's ]', '', 'SQL');
   366|             }
   367|         }
   368|     }
   369|     /**
   370|      * 初始化数据库连接
   371|      * @access protected
   372|      * @param boolean $master 主服务器
   373|      * @return void
   374|      */
   375|     protected function initConnect($master = true)
   376|     {
   377|         if (!empty($this->config['deploy']))
   378|         {
   379|             $this->_linkID = $this->multiConnect($master);
   380|         } else
   381|         if (!$this->_linkID) {
   382|             $this->_linkID = $this->connect();
   383|         }
   384|     }
   385|     /**
   386|      * 连接分布式服务器
   387|      * @access protected
   388|      * @param boolean $master 主服务器
   389|      * @return void
   390|      */
   391|     protected function multiConnect($master = false)
   392|     {
   393|         $_config['username'] = explode(',', $this->config['username']);
   394|         $_config['password'] = explode(',', $this->config['password']);
   395|         $_config['hostname'] = explode(',', $this->config['hostname']);
   396|         $_config['hostport'] = explode(',', $this->config['hostport']);


# ====================================================================
# FILE: ThinkPHP/Library/Think/Dispatcher.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-273 ---
     1| <?php
     2| namespace Think;
     3| /**
     4|  * ThinkPHP内置的Dispatcher类
     5|  * 完成URL解析、路由和调度
     6|  */
     7| class Dispatcher
     8| {
     9|     /**
    10|      * URL映射到控制器
    11|      * @access public
    12|      * @return void
    13|      */
    14|     public static function dispatch()
    15|     {
    16|         $varPath       = C('VAR_PATHINFO');
    17|         $varAddon      = C('VAR_ADDON');
    18|         $varModule     = C('VAR_MODULE');
    19|         $varController = C('VAR_CONTROLLER');
    20|         $varAction     = C('VAR_ACTION');
    21|         $urlCase       = C('URL_CASE_INSENSITIVE');
    22|         if (isset($_GET[$varPath])) {
    23|             $_SERVER['PATH_INFO'] = $_GET[$varPath];
    24|             unset($_GET[$varPath]);
    25|         } elseif (IS_CLI) {
    26|             $_SERVER['PATH_INFO'] = isset($_SERVER['argv'][1]) ? $_SERVER['argv'][1] : '';
    27|         }
    28|         if (C('APP_SUB_DOMAIN_DEPLOY')) {
    29|             $rules = C('APP_SUB_DOMAIN_RULES');
    30|             if (isset($rules[$_SERVER['HTTP_HOST']])) {
    31|                 define('APP_DOMAIN', $_SERVER['HTTP_HOST']); // 当前完整域名
    32|                 $rule = $rules[APP_DOMAIN];
    33|             } else {
    34|                 if (strpos(C('APP_DOMAIN_SUFFIX'), '.')) {
    35|                     $domain = array_slice(explode('.', $_SERVER['HTTP_HOST']), 0, -3);
    36|                 } else {
    37|                     $domain = array_slice(explode('.', $_SERVER['HTTP_HOST']), 0, -2);
    38|                 }
    39|                 if (!empty($domain)) {
    40|                     $subDomain = implode('.', $domain);
    41|                     define('SUB_DOMAIN', $subDomain); // 当前完整子域名
    42|                     $domain2 = array_pop($domain); // 二级域名
    43|                     if ($domain) {
    44|                         $domain3 = array_pop($domain);
    45|                     }
    46|                     if (isset($rules[$subDomain])) {
    47|                         $rule = $rules[$subDomain];
    48|                     } elseif (isset($rules['*.' . $domain2]) && !empty($domain3)) {
    49|                         $rule      = $rules['*.' . $domain2];
    50|                         $panDomain = $domain3;
    51|                     } elseif (isset($rules['*']) && !empty($domain2) && 'www' != $domain2) {
    52|                         $rule      = $rules['*'];
    53|                         $panDomain = $domain2;
    54|                     }
    55|                 }
    56|             }
    57|             if (!empty($rule)) {
    58|                 if (is_array($rule)) {
    59|                     list($rule, $vars) = $rule;
    60|                 }
    61|                 $array = explode('/', $rule);
    62|                 define('BIND_MODULE', array_shift($array));
    63|                 if (!empty($array)) {
    64|                     $controller = array_shift($array);
    65|                     if ($controller) {
    66|                         define('BIND_CONTROLLER', $controller);
    67|                     }
    68|                 }
    69|                 if (isset($vars)) {
    70|                     parse_str($vars, $parms);
    71|                     if (isset($panDomain)) {
    72|                         $pos = array_search('*', $parms);
    73|                         if (false !== $pos) {
    74|                             $parms[$pos] = $panDomain;
    75|                         }
    76|                     }
    77|                     $_GET = array_merge($_GET, $parms);
    78|                 }
    79|             }
    80|         }
    81|         if (!isset($_SERVER['PATH_INFO'])) {
    82|             $types = explode(',', C('URL_PATHINFO_FETCH'));
    83|             foreach ($types as $type) {
    84|                 if (0 === strpos($type, ':')) {
    85|                     $_SERVER['PATH_INFO'] = call_user_func(substr($type, 1));
    86|                     break;
    87|                 } elseif (!empty($_SERVER[$type])) {
    88|                     $_SERVER['PATH_INFO'] = (0 === strpos($_SERVER[$type], $_SERVER['SCRIPT_NAME'])) ?
    89|                     substr($_SERVER[$type], strlen($_SERVER['SCRIPT_NAME'])) : $_SERVER[$type];
    90|                     break;
    91|                 }
    92|             }
    93|         }
    94|         $depr = C('URL_PATHINFO_DEPR');
    95|         define('MODULE_PATHINFO_DEPR', $depr);
    96|         if (empty($_SERVER['PATH_INFO'])) {
    97|             $_SERVER['PATH_INFO'] = '';
    98|             define('__INFO__', '');
    99|             define('__EXT__', '');
   100|         } else {
   101|             define('__INFO__', trim($_SERVER['PATH_INFO'], '/'));
   102|             define('__EXT__', strtolower(pathinfo($_SERVER['PATH_INFO'], PATHINFO_EXTENSION)));
   103|             $_SERVER['PATH_INFO'] = __INFO__;
   104|             if (!defined('BIND_MODULE') && (!C('URL_ROUTER_ON') || !Route::check())) {
   105|                 if (__INFO__ && C('MULTI_MODULE')) {
   106|                     $paths                = explode($depr, __INFO__, 2);
   107|                     $_GET[$varModule]     = preg_replace('/\.' . __EXT__ . '$/i', '', $paths[0]);
   108|                     $_SERVER['PATH_INFO'] = isset($paths[1]) ? $paths[1] : '';
   109|                 }
   110|             }
   111|         }
   112|         define('__SELF__', strip_tags($_SERVER[C('URL_REQUEST_URI')]));
   113|         define('MODULE_NAME', defined('BIND_MODULE') ? BIND_MODULE : self::getModule($varModule));
   114|         if (MODULE_NAME && !in_array_case(MODULE_NAME, C('MODULE_DENY_LIST')) && is_dir(APP_PATH . MODULE_NAME)) {
   115|             define('MODULE_PATH', APP_PATH . MODULE_NAME . '/');
   116|             C('CACHE_PATH', CACHE_PATH . MODULE_NAME . '/');
   117|             C('LOG_PATH', realpath(LOG_PATH) . '/' . MODULE_NAME . '/');
   118|             Hook::listen('module_check');
   119|             if (is_file(MODULE_PATH . 'Conf/config' . CONF_EXT)) {
   120|                 C(load_config(MODULE_PATH . 'Conf/config' . CONF_EXT));
   121|             }
   122|             if ('common' != APP_MODE && is_file(MODULE_PATH . 'Conf/config_' . APP_MODE . CONF_EXT)) {
   123|                 C(load_config(MODULE_PATH . 'Conf/config_' . APP_MODE . CONF_EXT));
   124|             }
   125|             if (APP_STATUS && is_file(MODULE_PATH . 'Conf/' . APP_STATUS . CONF_EXT)) {
   126|                 C(load_config(MODULE_PATH . 'Conf/' . APP_STATUS . CONF_EXT));
   127|             }
   128|             if (is_file(MODULE_PATH . 'Conf/alias.php')) {
   129|                 Think::addMap(include MODULE_PATH . 'Conf/alias.php');
   130|             }
   131|             if (is_file(MODULE_PATH . 'Conf/tags.php')) {
   132|                 Hook::import(include MODULE_PATH . 'Conf/tags.php');
   133|             }
   134|             if (is_file(MODULE_PATH . 'Common/function.php')) {
   135|                 include MODULE_PATH . 'Common/function.php';
   136|             }
   137|             $urlCase = C('URL_CASE_INSENSITIVE');
   138|             load_ext_file(MODULE_PATH);
   139|         } else {
   140|             E(L('_MODULE_NOT_EXIST_') . ':' . MODULE_NAME);
   141|         }
   142|         if (!defined('__APP__')) {
   143|             $urlMode = C('URL_MODEL');
   144|             if (URL_COMPAT == $urlMode) {
   145|                 define('PHP_FILE', _PHP_FILE_ . '?' . $varPath . '=');
   146|             } elseif (URL_REWRITE == $urlMode) {
   147|                 $url = dirname(_PHP_FILE_);
   148|                 if ('/' == $url || '\\' == $url) {
   149|                     $url = '';
   150|                 }
   151|                 define('PHP_FILE', $url);
   152|             } else {
   153|                 define('PHP_FILE', _PHP_FILE_);
   154|             }
   155|             define('__APP__', strip_tags(PHP_FILE));
   156|         }
   157|         $moduleName = defined('MODULE_ALIAS') ? MODULE_ALIAS : MODULE_NAME;
   158|         define('__MODULE__', (defined('BIND_MODULE') || !C('MULTI_MODULE')) ? __APP__ : __APP__ . '/' . ($urlCase ? strtolower($moduleName) : $moduleName));
   159|         if ('' != $_SERVER['PATH_INFO'] && (!C('URL_ROUTER_ON') || !Route::check())) {
   160|             Hook::listen('path_info');
   161|             if (C('URL_DENY_SUFFIX') && preg_match('/\.(' . trim(C('URL_DENY_SUFFIX'), '.') . ')$/i', $_SERVER['PATH_INFO'])) {
   162|                 send_http_status(404);
   163|                 exit;
   164|             }
   165|             $_SERVER['PATH_INFO'] = preg_replace(C('URL_HTML_SUFFIX') ? '/\.(' . trim(C('URL_HTML_SUFFIX'), '.') . ')$/i' : '/\.' . __EXT__ . '$/i', '', $_SERVER['PATH_INFO']);
   166|             $depr  = C('URL_PATHINFO_DEPR');
   167|             $paths = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
   168|             if (!defined('BIND_CONTROLLER')) {
   169|                 if (C('CONTROLLER_LEVEL') > 1) {
   170|                     $_GET[$varController] = implode('/', array_slice($paths, 0, C('CONTROLLER_LEVEL')));
   171|                     $paths                = array_slice($paths, C('CONTROLLER_LEVEL'));
   172|                 } else {
   173|                     $_GET[$varController] = array_shift($paths);
   174|                 }
   175|             }
   176|             if (!defined('BIND_ACTION')) {
   177|                 $_GET[$varAction] = array_shift($paths);
   178|             }
   179|             $var = array();
   180|             if (C('URL_PARAMS_BIND') && 1 == C('URL_PARAMS_BIND_TYPE')) {
   181|                 $var = $paths;
   182|             } else {
   183|                 preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {$var[$match[1]] = strip_tags($match[2]);}, implode('/', $paths));
   184|             }
   185|             $_GET = array_merge($var, $_GET);
   186|         }
   187|         define('CONTROLLER_PATH', self::getSpace($varAddon, $urlCase));
   188|         define('CONTROLLER_NAME', defined('BIND_CONTROLLER') ? BIND_CONTROLLER : self::getController($varController, $urlCase));
   189|         define('ACTION_NAME', defined('BIND_ACTION') ? BIND_ACTION : self::getAction($varAction, $urlCase));
   190|         $controllerName = defined('CONTROLLER_ALIAS') ? CONTROLLER_ALIAS : CONTROLLER_NAME;
   191|         define('__CONTROLLER__', __MODULE__ . $depr . (defined('BIND_CONTROLLER') ? '' : ($urlCase ? parse_name($controllerName) : $controllerName)));
   192|         define('__ACTION__', __CONTROLLER__ . $depr . (defined('ACTION_ALIAS') ? ACTION_ALIAS : ACTION_NAME));
   193|         $_REQUEST = array_merge($_POST, $_GET, $_COOKIE); // -- 加了$_COOKIE.  保证哦..
   194|     }
   195|     /**
   196|      * 获得控制器的命名空间路径 便于插件机制访问
   197|      */
   198|     private static function getSpace($var, $urlCase)
   199|     {
   200|         $space = !empty($_GET[$var]) ? strip_tags($_GET[$var]) : '';
   201|         unset($_GET[$var]);
   202|         return $space;
   203|     }
   204|     /**
   205|      * 获得实际的控制器名称
   206|      */
   207|     private static function getController($var, $urlCase)
   208|     {
   209|         $controller = (!empty($_GET[$var]) ? $_GET[$var] : C('DEFAULT_CONTROLLER'));
   210|         unset($_GET[$var]);
   211|         if ($maps = C('URL_CONTROLLER_MAP')) {
   212|             if (isset($maps[strtolower($controller)])) {
   213|                 define('CONTROLLER_ALIAS', strtolower($controller));
   214|                 return ucfirst($maps[CONTROLLER_ALIAS]);
   215|             } elseif (array_search(strtolower($controller), $maps)) {
   216|                 return '';
   217|             }
   218|         }
   219|         if ($urlCase) {
   220|             $controller = parse_name($controller, 1);
   221|         }
   222|         return strip_tags(ucfirst($controller));
   223|     }
   224|     /**
   225|      * 获得实际的操作名称
   226|      */
   227|     private static function getAction($var, $urlCase)
   228|     {
   229|         $action = !empty($_POST[$var]) ?
   230|         $_POST[$var] :
   231|         (!empty($_GET[$var]) ? $_GET[$var] : C('DEFAULT_ACTION'));
   232|         unset($_POST[$var], $_GET[$var]);
   233|         if ($maps = C('URL_ACTION_MAP')) {
   234|             if (isset($maps[strtolower(CONTROLLER_NAME)])) {
   235|                 $maps = $maps[strtolower(CONTROLLER_NAME)];
   236|                 if (isset($maps[strtolower($action)])) {
   237|                     define('ACTION_ALIAS', strtolower($action));
   238|                     if (is_array($maps[ACTION_ALIAS])) {
   239|                         parse_str($maps[ACTION_ALIAS][1], $vars);
   240|                         $_GET = array_merge($_GET, $vars);
   241|                         return $maps[ACTION_ALIAS][0];
   242|                     } else {
   243|                         return $maps[ACTION_ALIAS];
   244|                     }
   245|                 } elseif (array_search(strtolower($action), $maps)) {
   246|                     return '';
   247|                 }
   248|             }
   249|         }
   250|         return strip_tags($urlCase ? strtolower($action) : $action);
   251|     }
   252|     /**
   253|      * 获得实际的模块名称
   254|      */
   255|     private static function getModule($var)
   256|     {
   257|         $module = (!empty($_GET[$var]) ? $_GET[$var] : C('DEFAULT_MODULE'));
   258|         unset($_GET[$var]);
   259|         $allowList = C('MODULE_ALLOW_LIST'); // 允许的模块列表
   260|         if (!empty($allowList) && is_array($allowList) && !in_array_case($module, $allowList)) {
   261|             E(L('_MODULE_NOT_EXIST_') . ':' . strip_tags(ucfirst($module)));
   262|         }
   263|         if ($maps = C('URL_MODULE_MAP')) {
   264|             if (isset($maps[strtolower($module)])) {
   265|                 define('MODULE_ALIAS', strtolower($module));
   266|                 return ucfirst($maps[MODULE_ALIAS]);
   267|             } elseif (array_search(strtolower($module), $maps)) {
   268|                 return '';
   269|             }
   270|         }
   271|         return strip_tags(ucfirst($module));
   272|     }
   273| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Image/Driver/Gd.class.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 10-50 ---
    10|     private $img;
    11|     /**
    12|      * 图像信息，包括width,height,type,mime,size
    13|      * @var array
    14|      */
    15|     private $info;
    16|     /**
    17|      * 构造方法，可用于打开一张图像
    18|      * @param string $imgname 图像路径
    19|      */
    20|     public function __construct($imgname = null)
    21|     {
    22|         $imgname && $this->open($imgname);
    23|     }
    24|     /**
    25|      * 打开一张图像
    26|      * @param  string $imgname 图像路径
    27|      */
    28|     public function open($imgname)
    29|     {
    30|         if (!is_file($imgname)) {
    31|             E('不存在的图像文件');
    32|         }
    33|         $info = getimagesize($imgname);
    34|         if (false === $info || (IMAGETYPE_GIF === $info[2] && empty($info['bits']))) {
    35|             E('非法图像文件');
    36|         }
    37|         $this->info = array(
    38|             'width'  => $info[0],
    39|             'height' => $info[1],
    40|             'type'   => image_type_to_extension($info[2], false),
    41|             'mime'   => $info['mime'],
    42|         );
    43|         empty($this->img) || imagedestroy($this->img);
    44|         if ('gif' == $this->info['type']) {
    45|             $class     = 'Think\\Image\\Driver\\GIF';
    46|             $this->gif = new $class($imgname);
    47|             $this->img = imagecreatefromstring($this->gif->image());
    48|         } else {
    49|             $fun       = "imagecreatefrom{$this->info['type']}";
    50|             $this->img = $fun($imgname);

# --- HUNK 2: Lines 55-94 ---
    55|      * @param  string  $imgname   图像保存名称
    56|      * @param  string  $type      图像类型
    57|      * @param  integer $quality   图像质量
    58|      * @param  boolean $interlace 是否对JPEG类型图像设置隔行扫描
    59|      */
    60|     public function save($imgname, $type = null, $quality = 80, $interlace = true)
    61|     {
    62|         if (empty($this->img)) {
    63|             E('没有可以被保存的图像资源');
    64|         }
    65|         if (is_null($type)) {
    66|             $type = $this->info['type'];
    67|         } else {
    68|             $type = strtolower($type);
    69|         }
    70|         if ('jpeg' == $type || 'jpg' == $type) {
    71|             imageinterlace($this->img, $interlace);
    72|             imagejpeg($this->img, $imgname, $quality);
    73|         } elseif ('gif' == $type && !empty($this->gif)) {
    74|             $this->gif->save($imgname);
    75|         } else {
    76|             $fun = 'image' . $type;
    77|             $fun($this->img, $imgname);
    78|         }
    79|     }
    80|     /**
    81|      * 返回图像宽度
    82|      * @return integer 图像宽度
    83|      */
    84|     public function width()
    85|     {
    86|         if (empty($this->img)) {
    87|             E('没有指定图像资源');
    88|         }
    89|         return $this->info['width'];
    90|     }
    91|     /**
    92|      * 返回图像高度
    93|      * @return integer 图像高度
    94|      */

# --- HUNK 3: Lines 135-174 ---
   135|     /**
   136|      * 裁剪图像
   137|      * @param  integer $w      裁剪区域宽度
   138|      * @param  integer $h      裁剪区域高度
   139|      * @param  integer $x      裁剪区域x坐标
   140|      * @param  integer $y      裁剪区域y坐标
   141|      * @param  integer $width  图像保存宽度
   142|      * @param  integer $height 图像保存高度
   143|      */
   144|     public function crop($w, $h, $x = 0, $y = 0, $width = null, $height = null)
   145|     {
   146|         if (empty($this->img)) {
   147|             E('没有可以被裁剪的图像资源');
   148|         }
   149|         empty($width) && $width   = $w;
   150|         empty($height) && $height = $h;
   151|         do {
   152|             $img = imagecreatetruecolor($width, $height);
   153|             $color = imagecolorallocate($img, 255, 255, 255);
   154|             imagefill($img, 0, 0, $color);
   155|             imagecopyresampled($img, $this->img, 0, 0, $x, $y, $width, $height, $w, $h);
   156|             imagedestroy($this->img); //销毁原图
   157|             $this->img = $img;
   158|         } while (!empty($this->gif) && $this->gifNext());
   159|         $this->info['width']  = $width;
   160|         $this->info['height'] = $height;
   161|     }
   162|     /**
   163|      * 生成缩略图
   164|      * @param  integer $width  缩略图最大宽度
   165|      * @param  integer $height 缩略图最大高度
   166|      * @param  integer $type   缩略图裁剪类型
   167|      */
   168|     public function thumb($width, $height, $type = Image::IMAGE_THUMB_SCALE)
   169|     {
   170|         if (empty($this->img)) {
   171|             E('没有可以被缩略的图像资源');
   172|         }
   173|         $w = $this->info['width'];
   174|         $h = $this->info['height'];

# --- HUNK 4: Lines 206-246 ---
   206|                 $h = $height / $scale;
   207|                 $x = $this->info['width'] - $w;
   208|                 $y = $this->info['height'] - $h;
   209|                 break;
   210|             /* 填充 */
   211|             case Image::IMAGE_THUMB_FILLED:
   212|                 if ($w < $width && $h < $height) {
   213|                     $scale = 1;
   214|                 } else {
   215|                     $scale = min($width / $w, $height / $h);
   216|                 }
   217|                 $neww = $w * $scale;
   218|                 $newh = $h * $scale;
   219|                 $posx = ($width - $w * $scale) / 2;
   220|                 $posy = ($height - $h * $scale) / 2;
   221|                 do {
   222|                     $img = imagecreatetruecolor($width, $height);
   223|                     $color = imagecolorallocate($img, 255, 255, 255);
   224|                     imagefill($img, 0, 0, $color);
   225|                     imagecopyresampled($img, $this->img, $posx, $posy, $x, $y, $neww, $newh, $w, $h);
   226|                     imagedestroy($this->img); //销毁原图
   227|                     $this->img = $img;
   228|                 } while (!empty($this->gif) && $this->gifNext());
   229|                 $this->info['width']  = $width;
   230|                 $this->info['height'] = $height;
   231|                 return;
   232|             /* 固定 */
   233|             case Image::IMAGE_THUMB_FIXED:
   234|                 $x = $y = 0;
   235|                 break;
   236|             default:
   237|                 E('不支持的缩略图裁剪类型');
   238|         }
   239|         /* 裁剪图像 */
   240|         $this->crop($w, $h, $x, $y, $width, $height);
   241|     }
   242|     /**
   243|      * 添加水印
   244|      * @param  string  $source 水印图片路径
   245|      * @param  integer $locate 水印位置
   246|      * @param  integer $alpha  水印透明度

# --- HUNK 5: Lines 290-330 ---
   290|             case Image::IMAGE_WATER_SOUTH:
   291|                 $x = ($this->info['width'] - $info[0]) / 2;
   292|                 $y = $this->info['height'] - $info[1];
   293|                 break;
   294|             /* 右居中水印 */
   295|             case Image::IMAGE_WATER_EAST:
   296|                 $x = $this->info['width'] - $info[0];
   297|                 $y = ($this->info['height'] - $info[1]) / 2;
   298|                 break;
   299|             /* 上居中水印 */
   300|             case Image::IMAGE_WATER_NORTH:
   301|                 $x = ($this->info['width'] - $info[0]) / 2;
   302|                 $y = 0;
   303|                 break;
   304|             /* 左居中水印 */
   305|             case Image::IMAGE_WATER_WEST:
   306|                 $x = 0;
   307|                 $y = ($this->info['height'] - $info[1]) / 2;
   308|                 break;
   309|             default:
   310|                 /* 自定义水印坐标 */
   311|                 if (is_array($locate)) {
   312|                     list($x, $y) = $locate;
   313|                 } else {
   314|                     E('不支持的水印位置类型');
   315|                 }
   316|         }
   317|         do {
   318|             $src = imagecreatetruecolor($info[0], $info[1]);
   319|             $color = imagecolorallocate($src, 255, 255, 255);
   320|             imagefill($src, 0, 0, $color);
   321|             imagecopy($src, $this->img, 0, 0, $x, $y, $info[0], $info[1]);
   322|             imagecopy($src, $water, 0, 0, 0, 0, $info[0], $info[1]);
   323|             imagecopymerge($this->img, $src, $x, $y, 0, 0, $info[0], $info[1], $alpha);
   324|             imagedestroy($src);
   325|         } while (!empty($this->gif) && $this->gifNext());
   326|         imagedestroy($water);
   327|     }
   328|     /**
   329|      * 图像添加文字
   330|      * @param  string  $text   添加的文字

# --- HUNK 6: Lines 378-418 ---
   378|                 break;
   379|             /* 下居中文字 */
   380|             case Image::IMAGE_WATER_SOUTH:
   381|                 $x += ($this->info['width'] - $w) / 2;
   382|                 $y += $this->info['height'] - $h;
   383|                 break;
   384|             /* 右居中文字 */
   385|             case Image::IMAGE_WATER_EAST:
   386|                 $x += $this->info['width'] - $w;
   387|                 $y += ($this->info['height'] - $h) / 2;
   388|                 break;
   389|             /* 上居中文字 */
   390|             case Image::IMAGE_WATER_NORTH:
   391|                 $x += ($this->info['width'] - $w) / 2;
   392|                 break;
   393|             /* 左居中文字 */
   394|             case Image::IMAGE_WATER_WEST:
   395|                 $y += ($this->info['height'] - $h) / 2;
   396|                 break;
   397|             default:
   398|                 /* 自定义文字坐标 */
   399|                 if (is_array($locate)) {
   400|                     list($posx, $posy) = $locate;
   401|                     $x += $posx;
   402|                     $y += $posy;
   403|                 } else {
   404|                     E('不支持的文字位置类型');
   405|                 }
   406|         }
   407|         /* 设置偏移量 */
   408|         if (is_array($offset)) {
   409|             $offset        = array_map('intval', $offset);
   410|             list($ox, $oy) = $offset;
   411|         } else {
   412|             $offset = intval($offset);
   413|             $ox     = $oy     = $offset;
   414|         }
   415|         /* 设置颜色 */
   416|         if (is_string($color) && 0 === strpos($color, '#')) {
   417|             $color = str_split(substr($color, 1), 2);
   418|             $color = array_map('hexdec', $color);


# ====================================================================
# FILE: ThinkPHP/Library/Think/Image/Driver/Imagick.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 40-81 ---
    40|         );
    41|     }
    42|     /**
    43|      * 保存图像
    44|      * @param  string  $imgname   图像保存名称
    45|      * @param  string  $type      图像类型
    46|      * @param  integer $quality   JPEG图像质量
    47|      * @param  boolean $interlace 是否对JPEG类型图像设置隔行扫描
    48|      */
    49|     public function save($imgname, $type = null, $quality = 80, $interlace = true)
    50|     {
    51|         if (empty($this->img)) {
    52|             E('没有可以被保存的图像资源');
    53|         }
    54|         if (is_null($type)) {
    55|             $type = $this->info['type'];
    56|         } else {
    57|             $type = strtolower($type);
    58|             $this->img->setImageFormat($type);
    59|         }
    60|         if ('jpeg' == $type || 'jpg' == $type) {
    61|             $this->img->setImageInterlaceScheme(1);
    62|         }
    63|         $this->img->setImageCompressionQuality($quality);
    64|         $this->img->stripImage();
    65|         $imgname = realpath(dirname($imgname)) . '/' . basename($imgname); //强制绝对路径
    66|         if ('gif' == $type) {
    67|             $this->img->writeImages($imgname, true);
    68|         } else {
    69|             $this->img->writeImage($imgname);
    70|         }
    71|     }
    72|     /**
    73|      * 返回图像宽度
    74|      * @return integer 图像宽度
    75|      */
    76|     public function width()
    77|     {
    78|         if (empty($this->img)) {
    79|             E('没有指定图像资源');
    80|         }
    81|         return $this->info['width'];


# ====================================================================
# FILE: ThinkPHP/Library/Think/Model.class.php
# Total hunks: 10
# ====================================================================
# --- HUNK 1: Lines 15-143 ---
    15|     protected $db = null;
    16|     private $_db = array();
    17|     protected $pk = 'id';
    18|     protected $autoinc = false;
    19|     protected $tablePrefix = null;
    20|     protected $name = '';
    21|     protected $dbName = '';
    22|     protected $connection = '';
    23|     protected $tableName = '';
    24|     protected $trueTableName = '';
    25|     protected $error = '';
    26|     protected $fields = array();
    27|     protected $data = array();
    28|     protected $options   = array();
    29|     protected $_validate = array(); // 自动验证定义
    30|     protected $_auto     = array(); // 自动完成定义
    31|     protected $_map      = array(); // 字段映射定义
    32|     protected $_scope    = array(); // 命名范围定义
    33|     protected $autoCheckFields = true;
    34|     protected $patchValidate = false;
    35|     protected $methods = array('strict', 'order', 'alias', 'having', 'group', 'lock', 'distinct', 'auto', 'filter', 'validate', 'result', 'token', 'index', 'force');
    36|     /**
    37|      * 架构函数
    38|      * 取得DB类的实例对象 字段检查
    39|      * @access public
    40|      * @param string $name 模型名称
    41|      * @param string $tablePrefix 表前缀
    42|      * @param mixed $connection 数据库连接信息
    43|      */
    44|     public function __construct($name = '', $tablePrefix = '', $connection = '')
    45|     {
    46|         $this->_initialize();
    47|         if (!empty($name)) {
    48|             if (strpos($name, '.')) {
    49|                 list($this->dbName, $this->name) = explode('.', $name);
    50|             } else {
    51|                 $this->name = $name;
    52|             }
    53|         } elseif (empty($this->name)) {
    54|             $this->name = $this->getModelName();
    55|         }
    56|         if (is_null($tablePrefix)) {
    57|             $this->tablePrefix = '';
    58|         } elseif ('' != $tablePrefix) {
    59|             $this->tablePrefix = $tablePrefix;
    60|         } elseif (!isset($this->tablePrefix)) {
    61|             $this->tablePrefix = C('DB_PREFIX');
    62|         }
    63|         $this->db(0, empty($this->connection) ? $connection : $this->connection, true);
    64|     }
    65|     /**
    66|      * 自动检测数据表信息
    67|      * @access protected
    68|      * @return void
    69|      */
    70|     protected function _checkTableInfo()
    71|     {
    72|         if (empty($this->fields)) {
    73|             if (C('DB_FIELDS_CACHE')) {
    74|                 $db     = $this->dbName ?: C('DB_NAME');
    75|                 $fields = F('_fields/' . strtolower($db . '.' . $this->tablePrefix . $this->name));
    76|                 if ($fields) {
    77|                     $this->fields = $fields;
    78|                     if (!empty($fields['_pk'])) {
    79|                         $this->pk = $fields['_pk'];
    80|                     }
    81|                     return;
    82|                 }
    83|             }
    84|             $this->flush();
    85|         }
    86|     }
    87|     /**
    88|      * 获取字段信息并缓存
    89|      * @access public
    90|      * @return void
    91|      */
    92|     public function flush()
    93|     {
    94|         $this->db->setModel($this->name);
    95|         $fields = $this->db->getFields($this->getTableName());
    96|         if (!$fields) {
    97|             return false;
    98|         }
    99|         $this->fields = array_keys($fields);
   100|         unset($this->fields['_pk']);
   101|         foreach ($fields as $key => $val) {
   102|             $type[$key] = $val['type'];
   103|             if ($val['primary']) {
   104|                 if (isset($this->fields['_pk']) && null != $this->fields['_pk']) {
   105|                     if (is_string($this->fields['_pk'])) {
   106|                         $this->pk            = array($this->fields['_pk']);
   107|                         $this->fields['_pk'] = $this->pk;
   108|                     }
   109|                     $this->pk[]            = $key;
   110|                     $this->fields['_pk'][] = $key;
   111|                 } else {
   112|                     $this->pk            = $key;
   113|                     $this->fields['_pk'] = $key;
   114|                 }
   115|                 if ($val['autoinc']) {
   116|                     $this->autoinc = true;
   117|                 }
   118|             }
   119|         }
   120|         $this->fields['_type'] = $type;
   121|         if (C('DB_FIELDS_CACHE')) {
   122|             $db = $this->dbName ?: C('DB_NAME');
   123|             F('_fields/' . strtolower($db . '.' . $this->tablePrefix . $this->name), $this->fields);
   124|         }
   125|     }
   126|     /**
   127|      * 设置数据对象的值
   128|      * @access public
   129|      * @param string $name 名称
   130|      * @param mixed $value 值
   131|      * @return void
   132|      */
   133|     public function __set($name, $value)
   134|     {
   135|         $this->data[$name] = $value;
   136|     }
   137|     /**
   138|      * 获取数据对象的值
   139|      * @access public
   140|      * @param string $name 名称
   141|      * @return mixed
   142|      */
   143|     public function __get($name)

# --- HUNK 2: Lines 390-512 ---
   390|      * @access public
   391|      * @param mixed $options 表达式
   392|      * @return mixed
   393|      */
   394|     public function delete($options = array())
   395|     {
   396|         $pk = $this->getPk();
   397|         if (empty($options) && empty($this->options['where'])) {
   398|             if (!empty($this->data) && isset($this->data[$pk])) {
   399|                 return $this->delete($this->data[$pk]);
   400|             } else {
   401|                 return false;
   402|             }
   403|         }
   404|         if (is_numeric($options) || is_string($options)) {
   405|             if (strpos($options, ',')) {
   406|                 $where[$pk] = array('IN', $options);
   407|             } else {
   408|                 $where[$pk] = $options;
   409|             }
   410|             $options          = array();
   411|             $options['where'] = $where;
   412|         }
   413|         if (is_array($options) && (count($options) > 0) && is_array($pk)) {
   414|             $count = 0;
   415|             foreach (array_keys($options) as $key) {
   416|                 if (is_int($key)) {
   417|                     $count++;
   418|                 }
   419|             }
   420|             if (count($pk) == $count) {
   421|                 $i = 0;
   422|                 foreach ($pk as $field) {
   423|                     $where[$field] = $options[$i];
   424|                     unset($options[$i++]);
   425|                 }
   426|                 $options['where'] = $where;
   427|             } else {
   428|                 return false;
   429|             }
   430|         }
   431|         $options = $this->_parseOptions($options);
   432|         if (empty($options['where'])) {
   433|             return false;
   434|         }
   435|         if (is_array($options['where']) && isset($options['where'][$pk])) {
   436|             $pkValue = $options['where'][$pk];
   437|         }
   438|         if (false === $this->_before_delete($options)) {
   439|             return false;
   440|         }
   441|         $result = $this->db->delete($options);
   442|         if (false !== $result && is_numeric($result)) {
   443|             $data = array();
   444|             if (isset($pkValue)) {
   445|                 $data[$pk] = $pkValue;
   446|             }
   447|             $this->_after_delete($data, $options);
   448|         }
   449|         return $result;
   450|     }
   451|     protected function _before_delete($options)
   452|     {}
   453|     protected function _after_delete($data, $options)
   454|     {}
   455|     /**
   456|      * 查询数据集
   457|      * @access public
   458|      * @param array $options 表达式参数
   459|      * @return mixed
   460|      */
   461|     public function select($options = array())
   462|     {
   463|         $pk = $this->getPk();
   464|         if (is_string($options) || is_numeric($options)) {
   465|             if (strpos($options, ',')) {
   466|                 $where[$pk] = array('IN', $options);
   467|             } else {
   468|                 $where[$pk] = $options;
   469|             }
   470|             $options          = array();
   471|             $options['where'] = $where;
   472|         } elseif (is_array($options) && (count($options) > 0) && is_array($pk)) {
   473|             $count = 0;
   474|             foreach (array_keys($options) as $key) {
   475|                 if (is_int($key)) {
   476|                     $count++;
   477|                 }
   478|             }
   479|             if (count($pk) == $count) {
   480|                 $i = 0;
   481|                 foreach ($pk as $field) {
   482|                     $where[$field] = $options[$i];
   483|                     unset($options[$i++]);
   484|                 }
   485|                 $options['where'] = $where;
   486|             } else {
   487|                 return false;
   488|             }
   489|         } elseif (false === $options) {
   490|             $options['fetch_sql'] = true;
   491|         }
   492|         $options = $this->_parseOptions($options);
   493|         if (isset($options['cache'])) {
   494|             $cache = $options['cache'];
   495|             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
   496|             $data  = S($key, '', $cache);
   497|             if (false !== $data) {
   498|                 return $data;
   499|             }
   500|         }
   501|         $resultSet = $this->db->select($options);
   502|         if (false === $resultSet) {
   503|             return false;
   504|         }
   505|         if (!empty($resultSet)) {
   506|             if (is_string($resultSet)) {
   507|                 return $resultSet;
   508|             }
   509|             $resultSet = array_map(array($this, '_read_data'), $resultSet);
   510|             $this->_after_select($resultSet, $options);
   511|             if (isset($options['index'])) {
   512|                 $index = explode(',', $options['index']);

# --- HUNK 3: Lines 548-592 ---
   548|         if (is_array($options)) {
   549|             $options = array_merge($this->options, $options);
   550|         }
   551|         if (!isset($options['table'])) {
   552|             $options['table'] = $this->getTableName();
   553|             $fields           = $this->fields;
   554|         } else {
   555|             $fields = $this->getDbFields();
   556|         }
   557|         if (!empty($options['alias'])) {
   558|             $options['table'] .= ' ' . $options['alias'];
   559|         }
   560|         $options['model'] = $this->name;
   561|         if (isset($options['where']) && is_array($options['where']) && !empty($fields) && !isset($options['join'])) {
   562|             foreach ($options['where'] as $key => $val) {
   563|                 $key = trim($key);
   564|                 if (in_array($key, $fields, true)) {
   565|                     if (is_scalar($val)) {
   566|                         $this->_parseType($options['where'], $key);
   567|                     }
   568|                 } elseif (!is_numeric($key) && '_' != substr($key, 0, 1) && false === strpos($key, '.') && false === strpos($key, '(') && false === strpos($key, '|') && false === strpos($key, '&')) {
   569|                     if (!empty($this->options['strict'])) {
   570|                         E(L('_ERROR_QUERY_EXPRESS_') . ':[' . $key . '=>' . $val . ']');
   571|                     }
   572|                     unset($options['where'][$key]);
   573|                 }
   574|             }
   575|         }
   576|         $this->options = array();
   577|         $this->_options_filter($options);
   578|         return $options;
   579|     }
   580|     protected function _options_filter(&$options)
   581|     {}
   582|     /**
   583|      * 数据类型检测
   584|      * @access protected
   585|      * @param mixed $data 数据
   586|      * @param string $key 字段名
   587|      * @return void
   588|      */
   589|     protected function _parseType(&$data, $key)
   590|     {
   591|         if (!isset($this->options['bind'][':' . $key]) && isset($this->fields['_type'][$key])) {
   592|             $fieldType = strtolower($this->fields['_type'][$key]);

# --- HUNK 4: Lines 611-697 ---
   611|         if (!empty($this->_map) && C('READ_DATA_MAP')) {
   612|             foreach ($this->_map as $key => $val) {
   613|                 if (isset($data[$val])) {
   614|                     $data[$key] = $data[$val];
   615|                     unset($data[$val]);
   616|                 }
   617|             }
   618|         }
   619|         return $data;
   620|     }
   621|     /**
   622|      * 查询数据
   623|      * @access public
   624|      * @param mixed $options 表达式参数
   625|      * @return mixed
   626|      */
   627|     public function find($options = array())
   628|     {
   629|         if (is_numeric($options) || is_string($options)) {
   630|             $where[$this->getPk()] = $options;
   631|             $options               = array();
   632|             $options['where']      = $where;
   633|         }
   634|         $pk = $this->getPk();
   635|         if (is_array($options) && (count($options) > 0) && is_array($pk)) {
   636|             $count = 0;
   637|             foreach (array_keys($options) as $key) {
   638|                 if (is_int($key)) {
   639|                     $count++;
   640|                 }
   641|             }
   642|             if (count($pk) == $count) {
   643|                 $i = 0;
   644|                 foreach ($pk as $field) {
   645|                     $where[$field] = $options[$i];
   646|                     unset($options[$i++]);
   647|                 }
   648|                 $options['where'] = $where;
   649|             } else {
   650|                 return false;
   651|             }
   652|         }
   653|         $options['limit'] = 1;
   654|         $options = $this->_parseOptions($options);
   655|         if (isset($options['cache'])) {
   656|             $cache = $options['cache'];
   657|             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
   658|             $data  = S($key, '', $cache);
   659|             if (false !== $data) {
   660|                 $this->data = $data;
   661|                 return $data;
   662|             }
   663|         }
   664|         $resultSet = $this->db->select($options);
   665|         if (false === $resultSet) {
   666|             return false;
   667|         }
   668|         if (empty($resultSet)) {
   669|             return null;
   670|         }
   671|         if (is_string($resultSet)) {
   672|             return $resultSet;
   673|         }
   674|         $data = $this->_read_data($resultSet[0]);
   675|         $this->_after_find($data, $options);
   676|         if (!empty($this->options['result'])) {
   677|             return $this->returnResult($data, $this->options['result']);
   678|         }
   679|         $this->data = $data;
   680|         if (isset($cache)) {
   681|             S($key, $data, $cache);
   682|         }
   683|         return $this->data;
   684|     }
   685|     protected function _after_find(&$result, $options)
   686|     {}
   687|     protected function returnResult($data, $type = '')
   688|     {
   689|         if ($type) {
   690|             if (is_callable($type)) {
   691|                 return call_user_func($type, $data);
   692|             }
   693|             switch (strtolower($type)) {
   694|                 case 'json':
   695|                     return json_encode($data);
   696|                 case 'xml':
   697|                     return xml_encode($data);

# --- HUNK 5: Lines 786-831 ---
   786|         }
   787|         return $this->setField($field, array('exp', $field . '-' . $step));
   788|     }
   789|     /**
   790|      * 延时更新检查 返回false表示需要延时
   791|      * 否则返回实际写入的数值
   792|      * @access public
   793|      * @param string $guid  写入标识
   794|      * @param integer $step  写入步进值
   795|      * @param integer $lazyTime  延时时间(s)
   796|      * @return false|integer
   797|      */
   798|     protected function lazyWrite($guid, $step, $lazyTime)
   799|     {
   800|         if (false !== ($value = S($guid))) {
   801|             if (NOW_TIME > S($guid . '_time') + $lazyTime) {
   802|                 S($guid, null);
   803|                 S($guid . '_time', null);
   804|                 return $value + $step;
   805|             } else {
   806|                 S($guid, $value + $step);
   807|                 return false;
   808|             }
   809|         } else {
   810|             S($guid, $step);
   811|             S($guid . '_time', NOW_TIME);
   812|             return false;
   813|         }
   814|     }
   815|     /**
   816|      * 获取一条记录的某个字段值
   817|      * @access public
   818|      * @param string $field  字段名
   819|      * @param string $spea  字段数据间隔符号 NULL返回数组
   820|      * @return mixed
   821|      */
   822|     public function getField($field, $sepa = null)
   823|     {
   824|         $options['field'] = $field;
   825|         $options          = $this->_parseOptions($options);
   826|         if (isset($options['cache'])) {
   827|             $cache = $options['cache'];
   828|             $key   = is_string($cache['key']) ? $cache['key'] : md5($sepa . serialize($options));
   829|             $data  = S($key, '', $cache);
   830|             if (false !== $data) {
   831|                 return $data;

# --- HUNK 6: Lines 897-936 ---
   897|     public function create($data = '', $type = '')
   898|     {
   899|         if (empty($data)) {
   900|             $data = I('post.');
   901|         } elseif (is_object($data)) {
   902|             $data = get_object_vars($data);
   903|         }
   904|         if (empty($data) || !is_array($data)) {
   905|             $this->error = L('_DATA_TYPE_INVALID_');
   906|             return false;
   907|         }
   908|         $type = $type ?: (!empty($data[$this->getPk()]) ? self::MODEL_UPDATE : self::MODEL_INSERT);
   909|         $data = $this->parseFieldsMap($data, 0);
   910|         if (isset($this->options['field'])) {
   911|             $fields = $this->options['field'];
   912|             unset($this->options['field']);
   913|         } elseif (self::MODEL_INSERT == $type && isset($this->insertFields)) {
   914|             $fields = $this->insertFields;
   915|         } elseif (self::MODEL_UPDATE == $type && isset($this->updateFields)) {
   916|             $fields = $this->updateFields;
   917|         }
   918|         if (isset($fields)) {
   919|             if (is_string($fields)) {
   920|                 $fields = explode(',', $fields);
   921|             }
   922|             if (C('TOKEN_ON')) {
   923|                 $fields[] = C('TOKEN_NAME', null, '__hash__');
   924|             }
   925|             foreach ($data as $key => $val) {
   926|                 if (!in_array($key, $fields)) {
   927|                     unset($data[$key]);
   928|                 }
   929|             }
   930|         }
   931|         if (!$this->autoValidation($data, $type)) {
   932|             return false;
   933|         }
   934|         if (!$this->autoCheckToken($data)) {
   935|             $this->error = L('_TOKEN_ERROR_');
   936|             return false;


# ====================================================================
# FILE: ThinkPHP/Library/Think/Model/MongoModel.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 91-201 ---
    91|         $this->options['where'] = array_merge((array) $this->options['where'], $where);
    92|         $command = array(
    93|             "distinct" => $this->options['table'],
    94|             "key"      => $field,
    95|             "query"    => $this->options['where'],
    96|         );
    97|         $result = $this->command($command);
    98|         return isset($result['values']) ? $result['values'] : false;
    99|     }
   100|     /**
   101|      * 获取下一ID 用于自动增长型
   102|      * @access public
   103|      * @param string $pk 字段名 默认为主键
   104|      * @return mixed
   105|      */
   106|     public function getMongoNextId($pk = '')
   107|     {
   108|         if (empty($pk)) {
   109|             $pk = $this->getPk();
   110|         }
   111|         return $this->db->getMongoNextId($pk);
   112|     }
   113|     /**
   114|      * 新增数据
   115|      * @access public
   116|      * @param mixed $data 数据
   117|      * @param array $options 表达式
   118|      * @param boolean $replace 是否replace
   119|      * @return mixed
   120|      */
   121|     public function add($data = '', $options = array(), $replace = false)
   122|     {
   123|         if (empty($data)) {
   124|             if (!empty($this->data)) {
   125|                 $data = $this->data;
   126|                 $this->data = array();
   127|             } else {
   128|                 $this->error = L('_DATA_TYPE_INVALID_');
   129|                 return false;
   130|             }
   131|         }
   132|         $options = $this->_parseOptions($options);
   133|         $data = $this->_facade($data);
   134|         if (false === $this->_before_insert($data, $options)) {
   135|             return false;
   136|         }
   137|         $result = $this->db->insert($data, $options, $replace);
   138|         if (false !== $result) {
   139|             $this->_after_insert($data, $options);
   140|             if (isset($data[$this->getPk()])) {
   141|                 return $data[$this->getPk()];
   142|             }
   143|         }
   144|         return $result;
   145|     }
   146|     protected function _before_insert(&$data, $options)
   147|     {
   148|         if ($this->_autoinc && self::TYPE_INT == $this->_idType) {
   149|             $pk = $this->getPk();
   150|             if (!isset($data[$pk])) {
   151|                 $data[$pk] = $this->db->getMongoNextId($pk);
   152|             }
   153|         }
   154|     }
   155|     public function clear()
   156|     {
   157|         return $this->db->clear();
   158|     }
   159|     protected function _after_select(&$resultSet, $options)
   160|     {
   161|         array_walk($resultSet, array($this, 'checkMongoId'));
   162|     }
   163|     /**
   164|      * 获取MongoId
   165|      * @access protected
   166|      * @param array $result 返回数据
   167|      * @return array
   168|      */
   169|     protected function checkMongoId(&$result)
   170|     {
   171|         if (is_object($result['_id'])) {
   172|             $result['_id'] = $result['_id']->__toString();
   173|         }
   174|         return $result;
   175|     }
   176|     protected function _options_filter(&$options)
   177|     {
   178|         $id = $this->getPk();
   179|         if (isset($options['where'][$id]) && is_scalar($options['where'][$id]) && self::TYPE_OBJECT == $this->_idType) {
   180|             $options['where'][$id] = new \MongoId($options['where'][$id]);
   181|         }
   182|     }
   183|     /**
   184|      * 查询数据
   185|      * @access public
   186|      * @param mixed $options 表达式参数
   187|      * @return mixed
   188|      */
   189|     public function find($options = array())
   190|     {
   191|         if (is_numeric($options) || is_string($options)) {
   192|             $id               = $this->getPk();
   193|             $where[$id]       = $options;
   194|             $options          = array();
   195|             $options['where'] = $where;
   196|         }
   197|         $options = $this->_parseOptions($options);
   198|         $result  = $this->db->find($options);
   199|         if (false === $result) {
   200|             return false;
   201|         }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Model/ViewModel.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 12-52 ---
    12|      * @access protected
    13|      * @return void
    14|      */
    15|     protected function _checkTableInfo()
    16|     {}
    17|     /**
    18|      * 得到完整的数据表名
    19|      * @access public
    20|      * @return string
    21|      */
    22|     public function getTableName()
    23|     {
    24|         if (empty($this->trueTableName)) {
    25|             $tableName = '';
    26|             foreach ($this->viewFields as $key => $view) {
    27|                 if (isset($view['_table'])) {
    28|                     $tableName .= $view['_table'];
    29|                     $prefix    = $this->tablePrefix;
    30|                     $tableName = preg_replace_callback("/__([A-Z_-]+)__/sU", function ($match) use ($prefix) {return $prefix . strtolower($match[1]);}, $tableName);
    31|                 } else {
    32|                     $class = $key . 'Model';
    33|                     $Model = class_exists($class) ? new $class() : M($key);
    34|                     $tableName .= $Model->getTableName();
    35|                 }
    36|                 $tableName .= !empty($view['_as']) ? ' ' . $view['_as'] : ' ' . $key;
    37|                 $tableName .= !empty($view['_on']) ? ' ON ' . $view['_on'] : '';
    38|                 $type = !empty($view['_type']) ? $view['_type'] : '';
    39|                 $tableName .= ' ' . strtoupper($type) . ' JOIN ';
    40|                 $len = strlen($type . '_JOIN ');
    41|             }
    42|             $tableName           = substr($tableName, 0, -$len);
    43|             $this->trueTableName = $tableName;
    44|         }
    45|         return $this->trueTableName;
    46|     }
    47|     /**
    48|      * 表达式过滤方法
    49|      * @access protected
    50|      * @param string $options 表达式
    51|      * @return void
    52|      */

# --- HUNK 2: Lines 67-128 ---
    67|             $options['order'] = $this->checkOrder($options['order']);
    68|         }
    69|     }
    70|     /**
    71|      * 检查是否定义了所有字段
    72|      * @access protected
    73|      * @param string $name 模型名称
    74|      * @param array $fields 字段数组
    75|      * @return array
    76|      */
    77|     private function _checkFields($name, $fields)
    78|     {
    79|         if (false !== $pos = array_search('*', $fields)) {
    80|             $fields = array_merge($fields, M($name)->getDbFields());
    81|             unset($fields[$pos]);
    82|         }
    83|         return $fields;
    84|     }
    85|     /**
    86|      * 检查条件中的视图字段
    87|      * @access protected
    88|      * @param mixed $data 条件表达式
    89|      * @return array
    90|      */
    91|     protected function checkCondition($where)
    92|     {
    93|         if (is_array($where)) {
    94|             $view = array();
    95|             foreach ($this->viewFields as $key => $val) {
    96|                 $k   = isset($val['_as']) ? $val['_as'] : $key;
    97|                 $val = $this->_checkFields($key, $val);
    98|                 foreach ($where as $name => $value) {
    99|                     if (false !== $field = array_search($name, $val, true)) {
   100|                         $_key        = is_numeric($field) ? $k . '.' . $name : $k . '.' . $field;
   101|                         $view[$_key] = $value;
   102|                         unset($where[$name]);
   103|                     }
   104|                 }
   105|             }
   106|             $where = array_merge($where, $view);
   107|         }
   108|         return $where;
   109|     }
   110|     /**
   111|      * 检查Order表达式中的视图字段
   112|      * @access protected
   113|      * @param string $order 字段
   114|      * @return string
   115|      */
   116|     protected function checkOrder($order = '')
   117|     {
   118|         if (is_string($order) && !empty($order)) {
   119|             $orders = explode(',', $order);
   120|             $_order = array();
   121|             foreach ($orders as $order) {
   122|                 $array = explode(' ', trim($order));
   123|                 $field = $array[0];
   124|                 $sort  = isset($array[1]) ? $array[1] : 'ASC';
   125|                 foreach ($this->viewFields as $name => $val) {
   126|                     $k   = isset($val['_as']) ? $val['_as'] : $name;
   127|                     $val = $this->_checkFields($name, $val);
   128|                     if (false !== $_field = array_search($field, $val, true)) {


# ====================================================================
# FILE: ThinkPHP/Library/Think/Route.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-256 ---
     1| <?php
     2| namespace Think;
     3| /**
     4|  * ThinkPHP路由解析类
     5|  */
     6| class Route
     7| {
     8|     public static function check()
     9|     {
    10|         $depr = C('URL_PATHINFO_DEPR');
    11|         $regx = preg_replace('/\.' . __EXT__ . '$/i', '', trim($_SERVER['PATH_INFO'], $depr));
    12|         if ('/' != $depr) {
    13|             $regx = str_replace($depr, '/', $regx);
    14|         }
    15|         $maps = C('URL_MAP_RULES');
    16|         if (isset($maps[$regx])) {
    17|             $var  = self::parseUrl($maps[$regx]);
    18|             $_GET = array_merge($var, $_GET);
    19|             return true;
    20|         }
    21|         $routes = C('URL_ROUTE_RULES');
    22|         if (!empty($routes)) {
    23|             foreach ($routes as $rule => $route) {
    24|                 if (is_numeric($rule)) {
    25|                     $rule = array_shift($route);
    26|                 }
    27|                 if (is_array($route) && isset($route[2])) {
    28|                     $options = $route[2];
    29|                     if (isset($options['ext']) && __EXT__ != $options['ext']) {
    30|                         continue;
    31|                     }
    32|                     if (isset($options['method']) && REQUEST_METHOD != strtoupper($options['method'])) {
    33|                         continue;
    34|                     }
    35|                     if (!empty($options['callback']) && is_callable($options['callback'])) {
    36|                         if (false === call_user_func($options['callback'])) {
    37|                             continue;
    38|                         }
    39|                     }
    40|                 }
    41|                 if (0 === strpos($rule, '/') && preg_match($rule, $regx, $matches)) {
    42|                     if ($route instanceof \Closure) {
    43|                         $result = self::invokeRegx($route, $matches);
    44|                         return is_bool($result) ? $result : exit;
    45|                     } else {
    46|                         return self::parseRegex($matches, $route, $regx);
    47|                     }
    48|                 } else {
    49|                     $len1 = substr_count($regx, '/');
    50|                     $len2 = substr_count($rule, '/');
    51|                     if ($len1 >= $len2 || strpos($rule, '[')) {
    52|                         if ('$' == substr($rule, -1, 1)) {
    53|                             if ($len1 != $len2) {
    54|                                 continue;
    55|                             } else {
    56|                                 $rule = substr($rule, 0, -1);
    57|                             }
    58|                         }
    59|                         $match = self::checkUrlMatch($regx, $rule);
    60|                         if (false !== $match) {
    61|                             if ($route instanceof \Closure) {
    62|                                 $result = self::invokeRule($route, $match);
    63|                                 return is_bool($result) ? $result : exit;
    64|                             } else {
    65|                                 return self::parseRule($rule, $route, $regx);
    66|                             }
    67|                         }
    68|                     }
    69|                 }
    70|             }
    71|         }
    72|         return false;
    73|     }
    74|     private static function checkUrlMatch($regx, $rule)
    75|     {
    76|         $m1  = explode('/', $regx);
    77|         $m2  = explode('/', $rule);
    78|         $var = array();
    79|         foreach ($m2 as $key => $val) {
    80|             if (0 === strpos($val, '[:')) {
    81|                 $val = substr($val, 1, -1);
    82|             }
    83|             if (':' == substr($val, 0, 1)) {
    84|                 if ($pos = strpos($val, '|')) {
    85|                     $val = substr($val, 1, $pos - 1);
    86|                 }
    87|                 if (strpos($val, '\\')) {
    88|                     $type = substr($val, -1);
    89|                     if ('d' == $type) {
    90|                         if (isset($m1[$key]) && !is_numeric($m1[$key])) {
    91|                             return false;
    92|                         }
    93|                     }
    94|                     $name = substr($val, 1, -2);
    95|                 } elseif ($pos = strpos($val, '^')) {
    96|                     $array = explode('-', substr(strstr($val, '^'), 1));
    97|                     if (in_array($m1[$key], $array)) {
    98|                         return false;
    99|                     }
   100|                     $name = substr($val, 1, $pos - 1);
   101|                 } else {
   102|                     $name = substr($val, 1);
   103|                 }
   104|                 $var[$name] = isset($m1[$key]) ? $m1[$key] : '';
   105|             } elseif (0 !== strcasecmp($val, $m1[$key])) {
   106|                 return false;
   107|             }
   108|         }
   109|         return $var;
   110|     }
   111|     private static function parseUrl($url)
   112|     {
   113|         $var = array();
   114|         if (false !== strpos($url, '?')) {
   115|             $info = parse_url($url);
   116|             $path = explode('/', $info['path']);
   117|             parse_str($info['query'], $var);
   118|         } elseif (strpos($url, '/')) {
   119|             $path = explode('/', $url);
   120|         } else {
   121|             parse_str($url, $var);
   122|         }
   123|         if (isset($path)) {
   124|             $var[C('VAR_ACTION')] = array_pop($path);
   125|             if (!empty($path)) {
   126|                 $var[C('VAR_CONTROLLER')] = array_pop($path);
   127|             }
   128|             if (!empty($path)) {
   129|                 $var[C('VAR_MODULE')] = array_pop($path);
   130|             }
   131|         }
   132|         return $var;
   133|     }
   134|     private static function parseRule($rule, $route, $regx)
   135|     {
   136|         $url = is_array($route) ? $route[0] : $route;
   137|         $paths = explode('/', $regx);
   138|         $matches = array();
   139|         $rule    = explode('/', $rule);
   140|         foreach ($rule as $item) {
   141|             $fun = '';
   142|             if (0 === strpos($item, '[:')) {
   143|                 $item = substr($item, 1, -1);
   144|             }
   145|             if (0 === strpos($item, ':')) {
   146|                 if ($pos = strpos($item, '|')) {
   147|                     $fun  = substr($item, $pos + 1);
   148|                     $item = substr($item, 0, $pos);
   149|                 }
   150|                 if ($pos = strpos($item, '^')) {
   151|                     $var = substr($item, 1, $pos - 1);
   152|                 } elseif (strpos($item, '\\')) {
   153|                     $var = substr($item, 1, -2);
   154|                 } else {
   155|                     $var = substr($item, 1);
   156|                 }
   157|                 $matches[$var] = !empty($fun) ? $fun(array_shift($paths)) : array_shift($paths);
   158|             } else {
   159|                 array_shift($paths);
   160|             }
   161|         }
   162|         if (0 === strpos($url, '/') || 0 === strpos($url, 'http')) {
   163|             if (strpos($url, ':')) { // 传递动态参数
   164|                 $values = array_values($matches);
   165|                 $url    = preg_replace_callback('/:(\d+)/', function ($match) use ($values) {return $values[$match[1] - 1];}, $url);
   166|             }
   167|             header("Location: $url", true, (is_array($route) && isset($route[1])) ? $route[1] : 301);
   168|             exit;
   169|         } else {
   170|             $var = self::parseUrl($url);
   171|             $values = array_values($matches);
   172|             foreach ($var as $key => $val) {
   173|                 if (0 === strpos($val, ':')) {
   174|                     $var[$key] = $values[substr($val, 1) - 1];
   175|                 }
   176|             }
   177|             $var = array_merge($matches, $var);
   178|             if (!empty($paths)) {
   179|                 preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {$var[strtolower($match[1])] = strip_tags($match[2]);}, implode('/', $paths));
   180|             }
   181|             if (is_array($route) && isset($route[1])) {
   182|                 if (is_array($route[1])) {
   183|                     $params = $route[1];
   184|                 } else {
   185|                     parse_str($route[1], $params);
   186|                 }
   187|                 $var = array_merge($var, $params);
   188|             }
   189|             $_GET = array_merge($var, $_GET);
   190|         }
   191|         return true;
   192|     }
   193|     private static function parseRegex($matches, $route, $regx)
   194|     {
   195|         $url = is_array($route) ? $route[0] : $route;
   196|         $url = preg_replace_callback('/:(\d+)/', function ($match) use ($matches) {return $matches[$match[1]];}, $url);
   197|         if (0 === strpos($url, '/') || 0 === strpos($url, 'http')) {
   198|             header("Location: $url", true, (is_array($route) && isset($route[1])) ? $route[1] : 301);
   199|             exit;
   200|         } else {
   201|             $var = self::parseUrl($url);
   202|             foreach ($var as $key => $val) {
   203|                 if (strpos($val, '|')) {
   204|                     list($val, $fun) = explode('|', $val);
   205|                     $var[$key]       = $fun($val);
   206|                 }
   207|             }
   208|             $regx = substr_replace($regx, '', 0, strlen($matches[0]));
   209|             if ($regx) {
   210|                 preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {
   211|                     $var[strtolower($match[1])] = strip_tags($match[2]);
   212|                 }, $regx);
   213|             }
   214|             if (is_array($route) && isset($route[1])) {
   215|                 if (is_array($route[1])) {
   216|                     $params = $route[1];
   217|                 } else {
   218|                     parse_str($route[1], $params);
   219|                 }
   220|                 $var = array_merge($var, $params);
   221|             }
   222|             $_GET = array_merge($var, $_GET);
   223|         }
   224|         return true;
   225|     }
   226|     private static function invokeRegx($closure, $var = array())
   227|     {
   228|         $reflect = new \ReflectionFunction($closure);
   229|         $params  = $reflect->getParameters();
   230|         $args    = array();
   231|         array_shift($var);
   232|         foreach ($params as $param) {
   233|             if (!empty($var)) {
   234|                 $args[] = array_shift($var);
   235|             } elseif ($param->isDefaultValueAvailable()) {
   236|                 $args[] = $param->getDefaultValue();
   237|             }
   238|         }
   239|         return $reflect->invokeArgs($args);
   240|     }
   241|     private static function invokeRule($closure, $var = array())
   242|     {
   243|         $reflect = new \ReflectionFunction($closure);
   244|         $params  = $reflect->getParameters();
   245|         $args    = array();
   246|         foreach ($params as $param) {
   247|             $name = $param->getName();
   248|             if (isset($var[$name])) {
   249|                 $args[] = $var[$name];
   250|             } elseif ($param->isDefaultValueAvailable()) {
   251|                 $args[] = $param->getDefaultValue();
   252|             }
   253|         }
   254|         return $reflect->invokeArgs($args);
   255|     }
   256| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Storage.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-29 ---
     3| class Storage
     4| {
     5|     /**
     6|      * 操作句柄
     7|      * @var string
     8|      * @access protected
     9|      */
    10|     protected static $handler;
    11|     /**
    12|      * 连接分布式文件系统
    13|      * @access public
    14|      * @param string $type 文件类型
    15|      * @param array $options  配置数组
    16|      * @return void
    17|      */
    18|     public static function connect($type = 'File', $options = array())
    19|     {
    20|         $class         = 'Think\\Storage\\Driver\\' . ucwords($type);
    21|         self::$handler = new $class($options);
    22|     }
    23|     public static function __callstatic($method, $args)
    24|     {
    25|         if (method_exists(self::$handler, $method)) {
    26|             return call_user_func_array(array(self::$handler, $method), $args);
    27|         }
    28|     }
    29| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Think.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-48 ---
     6| class Think
     7| {
     8|     private static $_map = array();
     9|     private static $_instance = array();
    10|     /**
    11|      * 应用程序初始化
    12|      * @access public
    13|      * @return void
    14|      */
    15|     public static function start()
    16|     {
    17|         spl_autoload_register('Think\Think::autoload');
    18|         register_shutdown_function('Think\Think::fatalError');
    19|         set_error_handler('Think\Think::appError');
    20|         set_exception_handler('Think\Think::appException');
    21|         Storage::connect(STORAGE_TYPE);
    22|         $runtimefile = RUNTIME_PATH . APP_MODE . '~runtime.php';
    23|         if (!APP_DEBUG && Storage::has($runtimefile)) {
    24|             Storage::load($runtimefile);
    25|         } else {
    26|             if (Storage::has($runtimefile)) {
    27|                 Storage::unlink($runtimefile);
    28|             }
    29|             $content = '';
    30|             $mode = include is_file(CONF_PATH . 'core.php') ? CONF_PATH . 'core.php' : MODE_PATH . APP_MODE . '.php';
    31|             foreach ($mode['core'] as $file) {
    32|                 if (is_file($file)) {
    33|                     include $file;
    34|                     if (!APP_DEBUG) {
    35|                         $content .= compile($file);
    36|                     }
    37|                 }
    38|             }
    39|             foreach ($mode['config'] as $key => $file) {
    40|                 is_numeric($key) ? C(load_config($file)) : C($key, load_config($file));
    41|             }
    42|             if ('common' != APP_MODE && is_file(CONF_PATH . 'config_' . APP_MODE . CONF_EXT)) {
    43|                 C(load_config(CONF_PATH . 'config_' . APP_MODE . CONF_EXT));
    44|             }
    45|             if (isset($mode['alias'])) {
    46|                 self::addMap(is_array($mode['alias']) ? $mode['alias'] : include $mode['alias']);
    47|             }
    48|             if (is_file(CONF_PATH . 'alias.php')) {


# ====================================================================
# FILE: ThinkPHP/Library/Think/View.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 87-135 ---
    87|      * 解析和获取模板内容 用于输出
    88|      * @access public
    89|      * @param string $templateFile 模板文件名
    90|      * @param string $content 模板输出内容
    91|      * @param string $prefix 模板缓存前缀
    92|      * @return string
    93|      */
    94|     public function fetch($templateFile = '', $content = '', $prefix = '')
    95|     {
    96|         if (empty($content)) {
    97|             $templateFile = $this->parseTemplate($templateFile);
    98|             if (!is_file($templateFile)) {
    99|                 E(L('_TEMPLATE_NOT_EXIST_') . ':' . $templateFile);
   100|             }
   101|         } else {
   102|             defined('THEME_PATH') or define('THEME_PATH', $this->getThemePath());
   103|         }
   104|         ob_start();
   105|         ob_implicit_flush(0);
   106|         if ('php' == strtolower(C('TMPL_ENGINE_TYPE'))) {
   107|             $_content = $content;
   108|             extract($this->tVar, EXTR_OVERWRITE);
   109|             empty($_content) ? include $templateFile : eval('?>' . $_content);
   110|         } else {
   111|             $params = array('var' => $this->tVar, 'file' => $templateFile, 'content' => $content, 'prefix' => $prefix);
   112|             Hook::listen('view_parse', $params);
   113|         }
   114|         $content = ob_get_clean();
   115|         Hook::listen('view_filter', $content);
   116|         return $content;
   117|     }
   118|     /**
   119|      * 自动定位模板文件
   120|      * @access protected
   121|      * @param string $template 模板文件规则
   122|      * @return string
   123|      */
   124|     public function parseTemplate($template = '')
   125|     {
   126|         if (is_file($template)) {
   127|             return $template;
   128|         }
   129|         $depr     = C('TMPL_FILE_DEPR');
   130|         $template = str_replace(':', $depr, $template);
   131|         $module = MODULE_NAME;
   132|         if (strpos($template, '@')) {
   133|             list($module, $template) = explode('@', $template);
   134|         }
   135|         defined('THEME_PATH') or define('THEME_PATH', $this->getThemePath($module));


# ====================================================================
# FILE: ThinkPHP/ThinkPHP.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| <?php
     2| $GLOBALS['_beginTime'] = microtime(true);
     3| define('MEMORY_LIMIT_ON', function_exists('memory_get_usage'));
     4| if (MEMORY_LIMIT_ON) {
     5|     $GLOBALS['_startUseMems'] = memory_get_usage();
     6| }
     7| const THINK_VERSION = '3.2.3';
     8| const URL_COMMON   = 0; //普通模式
     9| const URL_PATHINFO = 1; //PATHINFO模式
    10| const URL_REWRITE  = 2; //REWRITE模式
    11| const URL_COMPAT   = 3; // 兼容模式
    12| const EXT = '.class.php';
    13| defined('THINK_PATH') or define('THINK_PATH', __DIR__ . '/');
    14| defined('APP_PATH') or define('APP_PATH', dirname($_SERVER['SCRIPT_FILENAME']) . '/');
    15| defined('APP_STATUS') or define('APP_STATUS', ''); // 应用状态 加载对应的配置文件
    16| defined('APP_DEBUG') or define('APP_DEBUG', false); // 是否调试模式
    17| if (function_exists('saeAutoLoader')) {
    18|     defined('APP_MODE') or define('APP_MODE', 'sae');
    19|     defined('STORAGE_TYPE') or define('STORAGE_TYPE', 'Sae');
    20| } else {
    21|     defined('APP_MODE') or define('APP_MODE', 'common'); // 应用模式 默认为普通模式
    22|     defined('STORAGE_TYPE') or define('STORAGE_TYPE', 'File'); // 存储类型 默认为File
    23| }
    24| defined('RUNTIME_PATH') or define('RUNTIME_PATH', APP_PATH . 'Runtime/'); // 系统运行时目录
    25| defined('LIB_PATH') or define('LIB_PATH', realpath(THINK_PATH . 'Library') . '/'); // 系统核心类库目录
    26| defined('CORE_PATH') or define('CORE_PATH', LIB_PATH . 'Think/'); // Think类库目录
    27| defined('BEHAVIOR_PATH') or define('BEHAVIOR_PATH', LIB_PATH . 'Behavior/'); // 行为类库目录

