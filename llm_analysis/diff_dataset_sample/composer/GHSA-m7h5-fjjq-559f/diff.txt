--- a/ThinkPHP/Common/functions.php
+++ b/ThinkPHP/Common/functions.php
@@ -267,30 +267,30 @@
             $input = &$_POST;
             break;
         case 'put':
             if (is_null($_PUT)) {
                 parse_str(file_get_contents('php://input'), $_PUT);
             }
             $input = $_PUT;
             break;
         case 'param':
             switch ($_SERVER['REQUEST_METHOD']) {
-                case 'POST':
+            case 'POST':
                     $input = $_POST;
                     break;
-                case 'PUT':
+            case 'PUT':
                     if (is_null($_PUT)) {
                         parse_str(file_get_contents('php://input'), $_PUT);
                     }
                     $input = $_PUT;
                     break;
-                default:
+            default:
                     $input = $_GET;
             }
             break;
         case 'path':
             $input = array();
             if (!empty($_SERVER['PATH_INFO'])) {
                 $depr  = C('URL_PATHINFO_DEPR');
                 $input = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
             }
             break;
@@ -336,47 +336,46 @@
                         return isset($default) ? $default : null;
                     }
                 } else {
                     $filters = explode(',', $filters);
                 }
             } elseif (is_int($filters)) {
                 $filters = array($filters);
             }
             if (is_array($filters)) {
                 foreach ($filters as $filter) {
-                    $filter = trim($filter);
                     if (function_exists($filter)) {
                         $data = is_array($data) ? array_map_recursive($filter, $data) : $filter($data); // 参数过滤
                     } else {
                         $data = filter_var($data, is_int($filter) ? $filter : filter_id($filter));
                         if (false === $data) {
                             return isset($default) ? $default : null;
                         }
                     }
                 }
             }
         }
         if (!empty($type)) {
             switch (strtolower($type)) {
-                case 'a': // 数组
+                case 'a':    // 数组
                     $data = (array) $data;
                     break;
-                case 'd': // 数字
+                case 'd':    // 数字
                     $data = (int) $data;
                     break;
-                case 'f': // 浮点
+                case 'f':    // 浮点
                     $data = (float) $data;
                     break;
-                case 'b': // 布尔
+                case 'b':    // 布尔
                     $data = (boolean) $data;
                     break;
-                case 's': // 字符串
+                case 's':// 字符串
                 default:
                     $data = (string) $data;
             }
         }
     } else {
         $data = isset($default) ? $default : null;
     }
     is_array($data) && array_walk_recursive($data, 'think_filter');
     return $data;
 }
@@ -929,67 +928,52 @@
                     $var[$varController] = $controller;
                 }
             }
             if ($urlCase) {
                 $var[$varController] = parse_name($var[$varController]);
             }
             $module = '';
             if (!empty($path)) {
                 $var[$varModule] = implode($depr, $path);
             } else {
-                if (CONTROLLER_PATH) {
-                    $var[$varModule] = MODULE_NAME;
-                    $varAddon        = C('VAR_ADDON');
-                    if (MODULE_NAME != C('DEFAULT_MODULE')) {
-                        $var[$varController] = MODULE_NAME;
-                    }
-                    $vars = array_merge(array($varAddon => CONTROLLER_PATH), $vars);
-                } elseif (C('MULTI_MODULE')) {
+                if (C('MULTI_MODULE')) {
                     if (MODULE_NAME != C('DEFAULT_MODULE') || !C('MODULE_ALLOW_LIST')) {
                         $var[$varModule] = MODULE_NAME;
                     }
                 }
             }
             if ($maps = C('URL_MODULE_MAP')) {
                 if ($_module = array_search(strtolower($var[$varModule]), $maps)) {
                     $var[$varModule] = $_module;
                 }
             }
             if (isset($var[$varModule])) {
-                $module = defined('BIND_MODULE') && BIND_MODULE == $var[$varModule] ? '' : $var[$varModule];
+                $module = $var[$varModule];
                 unset($var[$varModule]);
             }
         }
     }
-    if (0 == C('URL_MODEL')) {
+    if (C('URL_MODEL') == 0) {
         $url = __APP__ . '?' . C('VAR_MODULE') . "={$module}&" . http_build_query(array_reverse($var));
         if ($urlCase) {
             $url = strtolower($url);
         }
         if (!empty($vars)) {
             $vars = http_build_query($vars);
             $url .= '&' . $vars;
         }
     } else {
         if (isset($route)) {
             $url = __APP__ . '/' . rtrim($url, $depr);
         } else {
-            $path = implode($depr, array_reverse($var));
-            if (C('URL_ROUTER_ON')) {
-                $url = Think\Route::reverse($path, $vars, $depr, $suffix);
-                if (!$url) {
-                    $url = $path;
-                }
-            } else {
-                $url = $path;
-            }
-            $url = __APP__ . '/' . ($module ? $module . MODULE_PATHINFO_DEPR : '') . $url;
+            $module = (defined('BIND_MODULE') && BIND_MODULE == $module) ? '' : $module;
+            $url    = __APP__ . '/' . ($module ? $module . MODULE_PATHINFO_DEPR : '') . implode($depr, array_reverse($var));
         }
         if ($urlCase) {
             $url = strtolower($url);
         }
         if (!empty($vars)) {
             foreach ($vars as $var => $val) {
                 if ('' !== trim($val)) {
                     $url .= $depr . $var . $depr . urlencode($val);
                 }
             }
@@ -997,21 +981,21 @@
         if ($suffix) {
             $suffix = true === $suffix ? C('URL_HTML_SUFFIX') : $suffix;
             if ($pos = strpos($suffix, '|')) {
                 $suffix = substr($suffix, 0, $pos);
             }
             if ($suffix && '/' != substr($url, -1)) {
                 $url .= '.' . ltrim($suffix, '.');
             }
         }
     }
-    if (!empty($anchor)) {
+    if (isset($anchor)) {
         $url .= '#' . $anchor;
     }
     if ($domain) {
         $url = (is_ssl() ? 'https://' : 'http://') . $domain . $url;
     }
     return $url;
 }
 /**
  * 渲染输出Widget
  * @param string $name Widget名称
@@ -1522,18 +1506,18 @@
         505 => 'HTTP Version Not Supported',
         509 => 'Bandwidth Limit Exceeded',
     );
     if (isset($_status[$code])) {
         header('HTTP/1.1 ' . $code . ' ' . $_status[$code]);
         header('Status:' . $code . ' ' . $_status[$code]);
     }
 }
 function think_filter(&$value)
 {
-    if (preg_match('/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN|BIND)$/i', $value)) {
+    if (preg_match('/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i', $value)) {
         $value .= ' ';
     }
 }
 function in_array_case($value, $array)
 {
     return in_array(strtolower($value), array_map('strtolower', $array));
 }

--- a/ThinkPHP/Conf/convention.php
+++ b/ThinkPHP/Conf/convention.php
@@ -71,21 +71,21 @@
     'TRACE_MAX_RECORD'       => 100, // 每个级别的错误信息 最大记录数
     /* 日志设置 */
     'LOG_RECORD'             => false, // 默认不记录日志
     'LOG_TYPE'               => 'File', // 日志记录类型 默认为文件方式
     'LOG_LEVEL'              => 'EMERG,ALERT,CRIT,ERR', // 允许记录的日志级别
     'LOG_FILE_SIZE'          => 2097152, // 日志文件大小限制
     'LOG_EXCEPTION_RECORD'   => false, // 是否记录异常信息日志
     /* SESSION设置 */
     'SESSION_AUTO_START'     => true, // 是否自动开启Session
     'SESSION_OPTIONS'        => array(), // session 配置数组 支持type name id path expire domain 等参数
-    'SESSION_TYPE'           => '', // session handler类型 默认无需设置 除非扩展了session handler驱动
+    'SESSION_TYPE'           => '', // session hander类型 默认无需设置 除非扩展了session hander驱动
     'SESSION_PREFIX'         => '', // session 前缀
     /* 模板引擎设置 */
     'TMPL_CONTENT_TYPE'      => 'text/html', // 默认模板输出类型
     'TMPL_ACTION_ERROR'      => THINK_PATH . 'Tpl/dispatch_jump.tpl', // 默认错误跳转对应的模板文件
     'TMPL_ACTION_SUCCESS'    => THINK_PATH . 'Tpl/dispatch_jump.tpl', // 默认成功跳转对应的模板文件
     'TMPL_EXCEPTION_FILE'    => THINK_PATH . 'Tpl/think_exception.tpl', // 异常页面的模板文件
     'TMPL_DETECT_THEME'      => false, // 自动侦测模板主题
     'TMPL_TEMPLATE_SUFFIX'   => '.html', // 默认模板文件后缀
     'TMPL_FILE_DEPR'         => '/', //模板文件CONTROLLER_NAME与ACTION_NAME之间的分割符
     'TMPL_ENGINE_TYPE'       => 'Think', // 默认模板引擎 以下设置仅对使用Think模板引擎有效

--- a/ThinkPHP/Library/Behavior/BuildLiteBehavior.class.php
+++ b/ThinkPHP/Library/Behavior/BuildLiteBehavior.class.php
@@ -1,18 +1,18 @@
 <?php
 namespace Behavior;
 use Think\Hook as Hook;
 class BuildLiteBehavior
 {
     public function run(&$params)
     {
-        if (!defined('BUILD_LITE_FILE') || BUILD_LITE_FILE == false) {
+        if (!defined('BUILD_LITE_FILE')) {
             return;
         }
         $litefile = C('RUNTIME_LITE_FILE', null, RUNTIME_PATH . 'lite.php');
         if (is_file($litefile)) {
             return;
         }
         $defs    = get_defined_constants(true);
         $content = 'namespace {$GLOBALS[\'_beginTime\'] = microtime(TRUE);';
         if (MEMORY_LIMIT_ON) {
             $content .= '$GLOBALS[\'_startUseMems\'] = memory_get_usage();';

--- a/ThinkPHP/Library/Org/Net/Http.class.php
+++ b/ThinkPHP/Library/Org/Net/Http.class.php
@@ -137,51 +137,42 @@
             $filename = UPLOAD_PATH . $filename;
             $length   = filesize($filename);
         } elseif ('' != $content) {
             $length = strlen($content);
         } else {
             E($filename . L('下载文件不存在！'));
         }
         if (empty($showname)) {
             $showname = $filename;
         }
-        $showname = self::get_basename($showname);;
+        $showname = basename($showname);
         if (!empty($filename)) {
             $finfo = new \finfo(FILEINFO_MIME);
             $type  = $finfo->file($filename);
         } else {
             $type = "application/octet-stream";
         }
         header("Pragma: public");
         header("Cache-control: max-age=" . $expire);
         header("Expires: " . gmdate("D, d M Y H:i:s", time() + $expire) . "GMT");
         header("Last-Modified: " . gmdate("D, d M Y H:i:s", time()) . "GMT");
         header("Content-Disposition: attachment; filename=" . $showname);
         header("Content-Length: " . $length);
         header("Content-type: " . $type);
         header('Content-Encoding: none');
         header("Content-Transfer-Encoding: binary");
-        ob_clean(); // 清空缓冲区
-        flush();  // 刷新输出缓冲
         if ('' == $content) {
             readfile($filename);
         } else {
             echo ($content);
         }
         exit();
-    }
-    /**
-     * 获取文件的名称，兼容中文名
-     * @return string
-     */
-    static public function get_basename($filename){
-        return preg_replace('/^.+[\\\\\\/]/', '', $filename);
     }
     /**
      * 显示HTTP Header 信息
      * @return string
      */
     public static function getHeaderInfo($header = '', $echo = true)
     {
         ob_start();
         $headers = getallheaders();
         if (!empty($header)) {

--- a/ThinkPHP/Library/Org/Net/IpLocation.class.php
+++ b/ThinkPHP/Library/Org/Net/IpLocation.class.php
@@ -33,24 +33,21 @@
     private $totalip;
     /**
      * 构造函数，打开 QQWry.Dat 文件并初始化类中的信息
      *
      * @param string $filename
      * @return IpLocation
      */
     public function __construct($filename = "UTFWry.dat")
     {
         $this->fp = 0;
-        if(!is_file($filename)) {
-            $filename = dirname(__FILE__) . '/' . $filename;
-        }
-        if (($this->fp = fopen($filename, 'rb')) !== false) {
+        if (($this->fp = fopen(dirname(__FILE__) . '/' . $filename, 'rb')) !== false) {
             $this->firstip = $this->getlong();
             $this->lastip  = $this->getlong();
             $this->totalip = ($this->lastip - $this->firstip) / 7;
         }
     }
     /**
      * 返回读取的长整型数
      *
      * @access private
      * @return int

--- a/ThinkPHP/Library/Think/App.class.php
+++ b/ThinkPHP/Library/Think/App.class.php
@@ -5,20 +5,21 @@
  */
 class App
 {
     /**
      * 应用程序初始化
      * @access public
      * @return void
      */
     public static function init()
     {
+        load_ext_file(COMMON_PATH);
         C('LOG_PATH', realpath(LOG_PATH) . '/Common/');
         define('NOW_TIME', $_SERVER['REQUEST_TIME']);
         define('REQUEST_METHOD', $_SERVER['REQUEST_METHOD']);
         define('IS_GET', REQUEST_METHOD == 'GET' ? true : false);
         define('IS_POST', REQUEST_METHOD == 'POST' ? true : false);
         define('IS_PUT', REQUEST_METHOD == 'PUT' ? true : false);
         define('IS_DELETE', REQUEST_METHOD == 'DELETE' ? true : false);
         Dispatcher::dispatch();
         if (C('REQUEST_VARS_FILTER')) {
             array_walk_recursive($_GET, 'think_filter');
@@ -112,22 +113,22 @@
                     if (1 == $paramsBindType && !empty($vars)) {
                         $args[] = array_shift($vars);
                     } elseif (0 == $paramsBindType && isset($vars[$name])) {
                         $args[] = $vars[$name];
                     } elseif ($param->isDefaultValueAvailable()) {
                         $args[] = $param->getDefaultValue();
                     } else {
                         E(L('_PARAM_ERROR_') . ':' . $name);
                     }
                 }
-                if (C('URL_PARAMS_FILTER')) {
-                    $filters = C('URL_PARAMS_FILTER_TYPE') ?: C('DEFAULT_FILTER');
+                if (C('URL_PARAMS_SAFE')) {
+                    $filters = C('URL_PARAMS_FILTER') ?: C('DEFAULT_FILTER');
                     if ($filters) {
                         $filters = explode(',', $filters);
                         foreach ($filters as $filter) {
                             $args = array_map_recursive($filter, $args); // 参数过滤
                         }
                     }
                 }
                 array_walk_recursive($args, 'think_filter');
                 $method->invokeArgs($module, $args);
             } else {
@@ -143,21 +144,20 @@
             throw new \ReflectionException();
         }
     }
     /**
      * 运行应用实例 入口文件使用的快捷方法
      * @access public
      * @return void
      */
     public static function run()
     {
-        load_ext_file(COMMON_PATH);
         Hook::listen('app_init');
         App::init();
         Hook::listen('app_begin');
         if (!IS_CLI) {
             session(C('SESSION_OPTIONS'));
         }
         G('initTime');
         App::exec();
         Hook::listen('app_end');
         return;

--- a/ThinkPHP/Library/Think/Cache/Driver/Memcached.class.php
+++ b/ThinkPHP/Library/Think/Cache/Driver/Memcached.class.php
@@ -47,22 +47,21 @@
      * @param integer $expire  有效时间（秒）
      * @return boolean
      */
     public function set($name, $value, $expire = null)
     {
         N('cache_write', 1);
         if (is_null($expire)) {
             $expire = $this->options['expire'];
         }
         $name = $this->options['prefix'] . $name;
-        $expire = $expire == 0 ? 0 : time() + $expire;
-        if ($this->handler->set($name, $value, $expire)) {
+        if ($this->handler->set($name, $value, time() + $expire)) {
             if ($this->options['length'] > 0) {
                 $this->queue($name);
             }
             return true;
         }
         return false;
     }
     /**
      * 删除缓存
      * @access public

--- a/ThinkPHP/Library/Think/Cache/Driver/Redis.class.php
+++ b/ThinkPHP/Library/Think/Cache/Driver/Redis.class.php
@@ -13,36 +13,31 @@
      * @access public
      */
     public function __construct($options = array())
     {
         if (!extension_loaded('redis')) {
             E(L('_NOT_SUPPORT_') . ':redis');
         }
         $options = array_merge(array(
             'host'       => C('REDIS_HOST') ?: '127.0.0.1',
             'port'       => C('REDIS_PORT') ?: 6379,
-            'password'   => C('REDIS_PASSWORD') ?: '',
             'timeout'    => C('DATA_CACHE_TIMEOUT') ?: false,
             'persistent' => false,
         ), $options);
         $this->options           = $options;
         $this->options['expire'] = isset($options['expire']) ? $options['expire'] : C('DATA_CACHE_TIME');
         $this->options['prefix'] = isset($options['prefix']) ? $options['prefix'] : C('DATA_CACHE_PREFIX');
         $this->options['length'] = isset($options['length']) ? $options['length'] : 0;
         $func                    = $options['persistent'] ? 'pconnect' : 'connect';
-        $this->handler           = new \Redis;
-        false === $options['timeout'] ?
+        $this->handler           = new \Redis; false === $options['timeout'] ?
         $this->handler->$func($options['host'], $options['port']) :
         $this->handler->$func($options['host'], $options['port'], $options['timeout']);
-        if ('' != $options['password']) {
-            $this->handler->auth($options['password']);
-        }
     }
     /**
      * 读取缓存
      * @access public
      * @param string $name 缓存变量名
      * @return mixed
      */
     public function get($name)
     {
         N('cache_read', 1);

--- a/ThinkPHP/Library/Think/Controller/RestController.class.php
+++ b/ThinkPHP/Library/Think/Controller/RestController.class.php
@@ -66,42 +66,41 @@
             }
         }
     }
     /**
      * 获取当前请求的Accept头信息
      * @return string
      */
     protected function getAcceptType()
     {
         $type = array(
-            'html' => 'text/html,application/xhtml+xml,*/*',
             'xml'  => 'application/xml,text/xml,application/x-xml',
             'json' => 'application/json,text/x-json,application/jsonrequest,text/json',
             'js'   => 'text/javascript,application/javascript,application/x-javascript',
             'css'  => 'text/css',
             'rss'  => 'application/rss+xml',
             'yaml' => 'application/x-yaml,text/yaml',
             'atom' => 'application/atom+xml',
             'pdf'  => 'application/pdf',
             'text' => 'text/plain',
             'png'  => 'image/png',
             'jpg'  => 'image/jpg,image/jpeg,image/pjpeg',
             'gif'  => 'image/gif',
             'csv'  => 'text/csv',
+            'html' => 'text/html,application/xhtml+xml,*/*',
         );
         foreach ($type as $key => $val) {
             $array = explode(',', $val);
             foreach ($array as $k => $v) {
-            	if(array_key_exists('HTTP_ACCEPT',$_SERVER))
-	                if (stristr($_SERVER['HTTP_ACCEPT'], $v)) {
-	                    return $key;
-	                }
+                if (stristr($_SERVER['HTTP_ACCEPT'], $v)) {
+                    return $key;
+                }
             }
         }
         return false;
     }
     protected function sendHttpStatus($code)
     {
         static $_status = array(
             100 => 'Continue',
             101 => 'Switching Protocols',
             200 => 'OK',
@@ -154,66 +153,30 @@
      * @access protected
      * @param mixed $data 要返回的数据
      * @param String $type 返回类型 JSON XML
      * @return string
      */
     protected function encodeData($data, $type = '')
     {
         if (empty($data)) {
             return '';
         }
-        if('json' == $type) {
-            if(version_compare(PHP_VERSION,'5.4.0','<')) {
-                $this->arrayRecursive($data, 'urlencode', true);
-                $data = urldecode(json_encode($data));
-            } else {
-                $data = json_encode($data,JSON_UNESCAPED_UNICODE);
-            }
+        if ('json' == $type) {
+            $data = json_encode($data);
         } elseif ('xml' == $type) {
             $data = xml_encode($data);
         } elseif ('php' == $type) {
             $data = serialize($data);
         } // 默认直接输出
         $this->setContentType($type);
         return $data;
     }
-    /**************************************************************
-     *
-     *    使用特定function对数组中所有元素做处理
-     *    @param  string|array  &$array     要处理的字符串或者数组
-     *    @param  string  $function   要执行的函数
-     *    @return boolean $apply_to_keys_also     是否也应用到key上
-     *    @access protected
-     *
-     *************************************************************/
-    protected function arrayRecursive(&$array, $function, $apply_to_keys_also = false)
-    {
-        static $recursive_counter = 0;
-        if (++$recursive_counter > 1000) {
-            die('possible deep recursion attack');
-        }
-        foreach ($array as $key => $value) {
-            if (is_array($value)) {
-                $this->arrayRecursive($array[$key], $function, $apply_to_keys_also);
-            } elseif(is_string($value)) {
-                $array[$key] = $function($value);
-            }
-            if ($apply_to_keys_also && is_string($key)) {
-                $new_key = $function($key);
-                if ($new_key != $key) {
-                    $array[$new_key] = $array[$key];
-                    unset($array[$key]);
-                }
-            }
-        }
-        $recursive_counter--;
-    }
     /**
      * 设置页面输出的CONTENT_TYPE和编码
      * @access public
      * @param string $type content_type 类型对应的扩展名
      * @param string $charset 页面输出编码
      * @return void
      */
     public function setContentType($type, $charset = '')
     {
         if (headers_sent()) {

--- a/ThinkPHP/Library/Think/Db.class.php
+++ b/ThinkPHP/Library/Think/Db.class.php
@@ -98,21 +98,21 @@
         $info = parse_url($dsnStr);
         if (!$info) {
             return false;
         }
         $dsn = array(
             'type'     => $info['scheme'],
             'username' => isset($info['user']) ? $info['user'] : '',
             'password' => isset($info['pass']) ? $info['pass'] : '',
             'hostname' => isset($info['host']) ? $info['host'] : '',
             'hostport' => isset($info['port']) ? $info['port'] : '',
-            'database' => isset($info['path']) ? ltrim($info['path'], '/') : '',
+            'database' => isset($info['path']) ? substr($info['path'], 1) : '',
             'charset'  => isset($info['fragment']) ? $info['fragment'] : 'utf8',
         );
         if (isset($info['query'])) {
             parse_str($info['query'], $dsn['params']);
         } else {
             $dsn['params'] = array();
         }
         return $dsn;
     }
     public static function __callStatic($method, $params)

--- a/ThinkPHP/Library/Think/Db/Driver.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver.class.php
@@ -4,21 +4,20 @@
 use Think\Config;
 use Think\Debug;
 abstract class Driver
 {
     protected $PDOStatement = null;
     protected $model = '_think_';
     protected $queryStr = '';
     protected $modelSql = array();
     protected $lastInsID = null;
     protected $numRows = 0;
-    protected $transPDO = null;
     protected $transTimes = 0;
     protected $error = '';
     protected $linkID = array();
     protected $_linkID = null;
     protected $config = array(
         'type'           => '', // 数据库类型
         'hostname'       => '127.0.0.1', // 服务器地址
         'database'       => '', // 数据库名
         'username'       => '', // 用户名
         'password'       => '', // 密码
@@ -102,26 +101,25 @@
      */
     public function free()
     {
         $this->PDOStatement = null;
     }
     /**
      * 执行查询 返回数据集
      * @access public
      * @param string $str  sql指令
      * @param boolean $fetchSql  不执行只是获取SQL
-     * @param boolean $master  是否在主服务器读操作
      * @return mixed
      */
-    public function query($str, $fetchSql = false, $master = false)
-    {
-        $this->initConnect($master);
+    public function query($str, $fetchSql = false)
+    {
+        $this->initConnect(false);
         if (!$this->_linkID) {
             return false;
         }
         $this->queryStr = $str;
         if (!empty($this->bind)) {
             $that           = $this;
             $this->queryStr = strtr($this->queryStr, array_map(function ($val) use ($that) {return '\'' . $that->escapeString($val) . '\'';}, $this->bind));
         }
         if ($fetchSql) {
             return $this->queryStr;
@@ -222,57 +220,52 @@
      * @access public
      * @return void
      */
     public function startTrans()
     {
         $this->initConnect(true);
         if (!$this->_linkID) {
             return false;
         }
         if (0 == $this->transTimes) {
-            $this->transPdo = $this->_linkID;
             $this->_linkID->beginTransaction();
         }
         $this->transTimes++;
         return;
     }
     /**
      * 用于非自动提交状态下面的查询提交
      * @access public
      * @return boolean
      */
     public function commit()
     {
-        if (1 == $this->transTimes) {
+        if ($this->transTimes > 0) {
             $result           = $this->_linkID->commit();
             $this->transTimes = 0;
-            $this->transPdo   = null;
             if (!$result) {
                 $this->error();
                 return false;
             }
-        } else {
-            $this->transTimes = $this->transTimes <= 0 ? 0 : $this->transTimes - 1;
         }
         return true;
     }
     /**
      * 事务回滚
      * @access public
      * @return boolean
      */
     public function rollback()
     {
         if ($this->transTimes > 0) {
             $result           = $this->_linkID->rollback();
             $this->transTimes = 0;
-            $this->transPdo   = null;
             if (!$result) {
                 $this->error();
                 return false;
             }
         }
         return true;
     }
     /**
      * 获得所有的查询数据
      * @access private
@@ -346,55 +339,54 @@
     }
     /**
      * set分析
      * @access protected
      * @param array $data
      * @return string
      */
     protected function parseSet($data)
     {
         foreach ($data as $key => $val) {
-            if (isset($val[0]) && 'exp' == $val[0]) {
+            if (is_array($val) && 'exp' == $val[0]) {
                 $set[] = $this->parseKey($key) . '=' . $val[1];
             } elseif (is_null($val)) {
                 $set[] = $this->parseKey($key) . '=NULL';
             } elseif (is_scalar($val)) {
                 if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
-                    $set[] = $this->parseKey($key) . '=' . $val;
+                    $set[] = $this->parseKey($key) . '=' . $this->escapeString($val);
                 } else {
                     $name  = count($this->bind);
-                    $set[] = $this->parseKey($key) . '=:' . $key . '_' . $name;
-                    $this->bindParam($key . '_' . $name, $val);
+                    $set[] = $this->parseKey($key) . '=:' . $name;
+                    $this->bindParam($name, $val);
                 }
             }
         }
         return ' SET ' . implode(',', $set);
     }
     /**
      * 参数绑定
      * @access protected
      * @param string $name 绑定参数名
      * @param mixed $value 绑定值
      * @return void
      */
     protected function bindParam($name, $value)
     {
         $this->bind[':' . $name] = $value;
     }
     /**
-     * 字段和表名处理
+     * 字段名分析
      * @access protected
      * @param string $key
-     * @param bool   $strict
-     * @return string
-     */
-    protected function parseKey($key, $strict = false)
+     * @return string
+     */
+    protected function parseKey(&$key)
     {
         return $key;
     }
     /**
      * value分析
      * @access protected
      * @param mixed $value
      * @return string
      */
     protected function parseValue($value)
@@ -450,21 +442,22 @@
             $array = array();
             foreach ($tables as $table => $alias) {
                 if (!is_numeric($table)) {
                     $array[] = $this->parseKey($table) . ' ' . $this->parseKey($alias);
                 } else {
                     $array[] = $this->parseKey($alias);
                 }
             }
             $tables = $array;
         } elseif (is_string($tables)) {
-            $tables = array_map(array($this, 'parseKey'), explode(',', $tables));
+            $tables = explode(',', $tables);
+            array_walk($tables, array(&$this, 'parseKey'));
         }
         return implode(',', $tables);
     }
     /**
      * where分析
      * @access protected
      * @param mixed $where
      * @return string
      */
     protected function parseWhere($where)
@@ -619,21 +612,21 @@
         return '( ' . $whereStr . ' )';
     }
     /**
      * limit分析
      * @access protected
      * @param mixed $lmit
      * @return string
      */
     protected function parseLimit($limit)
     {
-        return (!empty($limit) && false === strpos($limit, '(')) ? ' LIMIT ' . $limit . ' ' : '';
+        return !empty($limit) ? ' LIMIT ' . $limit . ' ' : '';
     }
     /**
      * join分析
      * @access protected
      * @param mixed $join
      * @return string
      */
     protected function parseJoin($join)
     {
         $joinStr = '';
@@ -643,47 +636,31 @@
         return $joinStr;
     }
     /**
      * order分析
      * @access protected
      * @param mixed $order
      * @return string
      */
     protected function parseOrder($order)
     {
-        if (empty($order)) {
-            return '';
-        }
-        $array = array();
         if (is_array($order)) {
+            $array = array();
             foreach ($order as $key => $val) {
                 if (is_numeric($key)) {
-                    if (false === strpos($val, '(')) {
-                        $array[] = $this->parseKey($val);
-                    }
-                } elseif (false === strpos($key, ')') && false === strpos($key, '#')) {
-                    $sort    = in_array(strtolower($val), array('asc', 'desc')) ? ' ' . $val : '';
-                    $array[] = $this->parseKey($key, true) . $sort;
-                }
-            }
-        } elseif ('[RAND]' == $order) {
-            $array[] = $this->parseRand();
-        } else {
-            foreach (explode(',', $order) as $val) {
-                if (preg_match('/\s+(ASC|DESC)$/i', rtrim($val), $match, PREG_OFFSET_CAPTURE)) {
-                    $array[] = $this->parseKey(ltrim(substr($val, 0, $match[0][1]))) . ' ' . $match[1][0];
-                } elseif (false === strpos($val, '(')) {
                     $array[] = $this->parseKey($val);
-                }
-            }
-        }
-        $order = implode(',', $array);
+                } else {
+                    $array[] = $this->parseKey($key) . ' ' . $val;
+                }
+            }
+            $order = implode(',', $array);
+        }
         return !empty($order) ? ' ORDER BY ' . $order : '';
     }
     /**
      * group分析
      * @access protected
      * @param mixed $group
      * @return string
      */
     protected function parseGroup($group)
     {
@@ -784,34 +761,34 @@
      * @param array $options 参数表达式
      * @param boolean $replace 是否replace
      * @return false | integer
      */
     public function insert($data, $options = array(), $replace = false)
     {
         $values      = $fields      = array();
         $this->model = $options['model'];
         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
         foreach ($data as $key => $val) {
-            if (isset($val[0]) && 'exp' == $val[0]) {
+            if (is_array($val) && 'exp' == $val[0]) {
                 $fields[] = $this->parseKey($key);
                 $values[] = $val[1];
             } elseif (is_null($val)) {
                 $fields[] = $this->parseKey($key);
                 $values[] = 'NULL';
             } elseif (is_scalar($val)) {
                 $fields[] = $this->parseKey($key);
                 if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
-                    $values[] = $val;
+                    $values[] = $this->parseValue($val);
                 } else {
                     $name     = count($this->bind);
-                    $values[] = ':' . $key . '_' . $name;
-                    $this->bindParam($key . '_' . $name, $val);
+                    $values[] = ':' . $name;
+                    $this->bindParam($name, $val);
                 }
             }
         }
         $replace = (is_numeric($replace) && $replace > 0) ? true : $replace;
         $sql     = (true === $replace ? 'REPLACE' : 'INSERT') . ' INTO ' . $this->parseTable($options['table']) . ' (' . implode(',', $fields) . ') VALUES (' . implode(',', $values) . ')' . $this->parseDuplicate($replace);
         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
     }
     /**
      * 批量插入记录
@@ -832,25 +809,25 @@
         $fields = array_map(array($this, 'parseKey'), array_keys($dataSet[0]));
         foreach ($dataSet as $data) {
             $value = array();
             foreach ($data as $key => $val) {
                 if (is_array($val) && 'exp' == $val[0]) {
                     $value[] = $val[1];
                 } elseif (is_null($val)) {
                     $value[] = 'NULL';
                 } elseif (is_scalar($val)) {
                     if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
-                        $value[] = $val;
+                        $value[] = $this->parseValue($val);
                     } else {
                         $name    = count($this->bind);
-                        $value[] = ':' . $key . '_' . $name;
-                        $this->bindParam($key . '_' . $name, $val);
+                        $value[] = ':' . $name;
+                        $this->bindParam($name, $val);
                     }
                 }
             }
             $values[] = 'SELECT ' . implode(',', $value);
         }
         $sql = 'INSERT INTO ' . $this->parseTable($options['table']) . ' (' . implode(',', $fields) . ') ' . implode(' UNION ALL ', $values);
         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
     }
     /**
@@ -861,22 +838,22 @@
      * @param array $option  查询数据参数
      * @return false | integer
      */
     public function selectInsert($fields, $table, $options = array())
     {
         $this->model = $options['model'];
         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
         if (is_string($fields)) {
             $fields = explode(',', $fields);
         }
-        $fields = array_map(array($this, 'parseKey'), $fields);
-        $sql    = 'INSERT INTO ' . $this->parseTable($table) . ' (' . implode(',', $fields) . ') ';
+        array_walk($fields, array($this, 'parseKey'));
+        $sql = 'INSERT INTO ' . $this->parseTable($table) . ' (' . implode(',', $fields) . ') ';
         $sql .= $this->buildSelectSql($options);
         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
     }
     /**
      * 更新记录
      * @access public
      * @param mixed $data 数据
      * @param array $options 表达式
      * @return false | integer
      */
@@ -927,21 +904,21 @@
      * 查找记录
      * @access public
      * @param array $options 表达式
      * @return mixed
      */
     public function select($options = array())
     {
         $this->model = $options['model'];
         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
         $sql    = $this->buildSelectSql($options);
-        $result = $this->query($sql, !empty($options['fetch_sql']) ? true : false, !empty($options['master']) ? true : false);
+        $result = $this->query($sql, !empty($options['fetch_sql']) ? true : false);
         return $result;
     }
     /**
      * 生成查询SQL
      * @access public
      * @param array $options 表达式
      * @return string
      */
     public function buildSelectSql($options = array())
     {
@@ -1048,23 +1025,20 @@
         }
     }
     /**
      * 初始化数据库连接
      * @access protected
      * @param boolean $master 主服务器
      * @return void
      */
     protected function initConnect($master = true)
     {
-        if ($this->transPDO) {
-            return $this->transPDO;
-        }
         if (!empty($this->config['deploy']))
         {
             $this->_linkID = $this->multiConnect($master);
         } else
         if (!$this->_linkID) {
             $this->_linkID = $this->connect();
         }
     }
     /**
      * 连接分布式服务器

--- a/ThinkPHP/Library/Think/Db/Driver/Firebird.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver/Firebird.class.php
@@ -133,20 +133,11 @@
         if (!empty($limit)) {
             $limit = explode(',', $limit);
             if (count($limit) > 1) {
                 $limitStr = ' FIRST ' . $limit[1] . ' SKIP ' . $limit[0] . ' ';
             } else {
                 $limitStr = ' FIRST ' . $limit[0] . ' ';
             }
         }
         return $limitStr;
     }
-    /**
-     * 随机排序
-     * @access protected
-     * @return string
-     */
-    protected function parseRand()
-    {
-        return 'rand()';
-    }
 }

--- a/ThinkPHP/Library/Think/Db/Driver/Mongo.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver/Mongo.class.php
@@ -230,25 +230,22 @@
         } catch (\MongoCursorException $e) {
             E($e->getMessage());
         }
     }
     /**
      * 生成下一条记录ID 用于自增非MongoId主键
      * @access public
      * @param string $pk 主键名
      * @return integer
      */
-    public function getMongoNextId($pk,$options=array())
-    {
-        if (isset($options['table'])) {
-            $this->switchCollection($options['table']);
-        }
+    public function getMongoNextId($pk)
+    {
         if ($this->config['debug']) {
             $this->queryStr = $this->_dbName . '.' . $this->_collectionName . '.find({},{' . $pk . ':1}).sort({' . $pk . ':-1}).limit(1)';
         }
         try {
             $this->debug(true);
             $result = $this->_collection->find(array(), array($pk => 1))->sort(array($pk => -1))->limit(1);
             $this->debug(false);
         } catch (\MongoCursorException $e) {
             E($e->getMessage());
         }
@@ -468,25 +465,22 @@
         N('db_query', 1); // 兼容代码
         $query = $this->parseWhere(isset($options['where']) ? $options['where'] : array());
         if ($this->config['debug']) {
             $this->queryStr = $this->_dbName . '.' . $this->_collectionName . '.group({key:' . json_encode($keys) . ',cond:' .
             json_encode($options['condition']) . ',reduce:' .
             json_encode($reduce) . ',initial:' .
             json_encode($initial) . '})';
         }
         try {
             $this->debug(true);
-            $option = array();
-            isset($options['condition'])&&$option['condition']=$options['condition'];
-            isset($options['finalize'])&&$option['finalize']=$options['condition'];
-            isset($options['maxTimeMS'])&&$option['maxTimeMS']=$options['condition'];
-            $group = $this->_collection->group($keys,$initial,$reduce,$option); 
+            $option = array('condition' => $options['condition'], 'finalize' => $options['finalize'], 'maxTimeMS' => $options['maxTimeMS']);
+            $group  = $this->_collection->group($keys, $initial, $reduce, $options);
             $this->debug(false);
             if ($cache && $group['ok']) {
                 S($key, $group, $cache['expire'], $cache['type']);
             }
             return $group;
         } catch (\MongoCursorException $e) {
             E($e->getMessage());
         }
     }
     /**
@@ -567,21 +561,21 @@
      * @param array $data
      * @return string
      */
     protected function parseSet($data)
     {
         $result = array();
         foreach ($data as $key => $val) {
             if (is_array($val)) {
                 switch ($val[0]) {
                     case 'inc':
-                        $result['$inc'][$key] = (float) $val[1];
+                        $result['$inc'][$key] = (int) $val[1];
                         break;
                     case 'set':
                     case 'unset':
                     case 'push':
                     case 'pushall':
                     case 'addtoset':
                     case 'pop':
                     case 'pull':
                     case 'pullall':
                         $result['$' . $val[0]][$key] = $val[1];

--- a/ThinkPHP/Library/Think/Db/Driver/Mysql.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver/Mysql.class.php
@@ -70,39 +70,29 @@
         $info   = array();
         foreach ($result as $key => $val) {
             $info[$key] = current($val);
         }
         return $info;
     }
     /**
      * 字段和表名处理
      * @access protected
      * @param string $key
-     * @param bool   $strict
      * @return string
      */
-    protected function parseKey($key, $strict = false)
+    protected function parseKey(&$key)
     {
         $key = trim($key);
-        if ($strict || (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)`.\s]/', $key))) {
+        if (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)`.\s]/', $key)) {
             $key = '`' . $key . '`';
         }
         return $key;
-    }
-    /**
-     * 随机排序
-     * @access protected
-     * @return string
-     */
-    protected function parseRand()
-    {
-        return 'rand()';
     }
     /**
      * 批量插入记录
      * @access public
      * @param mixed $dataSet 数据集
      * @param array $options 参数表达式
      * @param boolean $replace 是否replace
      * @return false | integer
      */
     public function insertAll($dataSet, $options = array(), $replace = false)
@@ -156,21 +146,21 @@
         }
         $updates = array();
         foreach ((array) $duplicate as $key => $val) {
             if (is_numeric($key)) {
                 $updates[] = $this->parseKey($val) . "=VALUES(" . $this->parseKey($val) . ")";
             } else {
                 if (is_scalar($val)) // 兼容标量传值方式
                 {
                     $val = array('value', $val);
                 }
-                if (!isset($val[1]) && !is_null($val[1])) {
+                if (!isset($val[1])) {
                     continue;
                 }
                 switch ($val[0]) {
                     case 'exp': // 表达式
                         $updates[] = $this->parseKey($key) . "=($val[1])";
                         break;
                     case 'value': // 值
                     default:
                         $name      = count($this->bind);
                         $updates[] = $this->parseKey($key) . "=:" . $name;

--- a/ThinkPHP/Library/Think/Db/Driver/Oracle.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver/Oracle.class.php
@@ -152,20 +152,11 @@
      * @access protected
      * @return string
      */
     protected function parseLock($lock = false)
     {
         if (!$lock) {
             return '';
         }
         return ' FOR UPDATE NOWAIT ';
     }
-    /**
-     * 随机排序
-     * @access protected
-     * @return string
-     */
-    protected function parseRand()
-    {
-        return 'DBMS_RANDOM.value';
-    }
 }

--- a/ThinkPHP/Library/Think/Db/Driver/Pgsql.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver/Pgsql.class.php
@@ -21,21 +21,21 @@
         return $dsn;
     }
     /**
      * 取得数据表的字段信息
      * @access public
      * @return array
      */
     public function getFields($tableName)
     {
         list($tableName) = explode(' ', $tableName);
-        $result          = $this->query('select fields_name as "field",fields_type as "type",fields_not_null as "null",fields_key_name as "key",fields_default as "default",fields_default as "extra" from table_msg(\'' . $tableName . '\');');
+        $result          = $this->query('select fields_name as "field",fields_type as "type",fields_not_null as "null",fields_key_name as "key",fields_default as "default",fields_default as "extra" from table_msg(' . $tableName . ');');
         $info            = array();
         if ($result) {
             foreach ($result as $key => $val) {
                 $info[$val['field']] = array(
                     'name'    => $val['field'],
                     'type'    => $val['type'],
                     'notnull' => (bool) ('' === $val['null']), // not null is empty, null is yes
                     'default' => $val['default'],
                     'primary' => (strtolower($val['key']) == 'pri'),
                     'autoinc' => (strtolower($val['extra']) == 'auto_increment'),
@@ -70,20 +70,11 @@
         if (!empty($limit)) {
             $limit = explode(',', $limit);
             if (count($limit) > 1) {
                 $limitStr .= ' LIMIT ' . $limit[1] . ' OFFSET ' . $limit[0] . ' ';
             } else {
                 $limitStr .= ' LIMIT ' . $limit[0] . ' ';
             }
         }
         return $limitStr;
     }
-    /**
-     * 随机排序
-     * @access protected
-     * @return string
-     */
-    protected function parseRand()
-    {
-        return 'RANDOM()';
-    }
 }

--- a/ThinkPHP/Library/Think/Db/Driver/Sqlite.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver/Sqlite.class.php
@@ -22,27 +22,27 @@
      * @access public
      * @return array
      */
     public function getFields($tableName)
     {
         list($tableName) = explode(' ', $tableName);
         $result          = $this->query('PRAGMA table_info( ' . $tableName . ' )');
         $info            = array();
         if ($result) {
             foreach ($result as $key => $val) {
-                $info[$val['name']] = array(
-                    'name'    => $val['name'],
+                $info[$val['field']] = array(
+                    'name'    => $val['field'],
                     'type'    => $val['type'],
-                    'notnull' => (bool) (1 === $val['notnull']),
-                    'default' => $val['dflt_value'],
-                    'primary' => '1' == $val['pk'],
-                    'autoinc' => false,
+                    'notnull' => (bool) ('' === $val['null']), // not null is empty, null is yes
+                    'default' => $val['default'],
+                    'primary' => (strtolower($val['dey']) == 'pri'),
+                    'autoinc' => (strtolower($val['extra']) == 'auto_increment'),
                 );
             }
         }
         return $info;
     }
     /**
      * 取得数据库的表信息
      * @access public
      * @return array
      */
@@ -78,20 +78,11 @@
         if (!empty($limit)) {
             $limit = explode(',', $limit);
             if (count($limit) > 1) {
                 $limitStr .= ' LIMIT ' . $limit[1] . ' OFFSET ' . $limit[0] . ' ';
             } else {
                 $limitStr .= ' LIMIT ' . $limit[0] . ' ';
             }
         }
         return $limitStr;
     }
-    /**
-     * 随机排序
-     * @access protected
-     * @return string
-     */
-    protected function parseRand()
-    {
-        return 'RANDOM()';
-    }
 }

--- a/ThinkPHP/Library/Think/Db/Driver/Sqlsrv.class.php
+++ b/ThinkPHP/Library/Think/Db/Driver/Sqlsrv.class.php
@@ -79,30 +79,29 @@
      * order分析
      * @access protected
      * @param mixed $order
      * @return string
      */
     protected function parseOrder($order)
     {
         return !empty($order) ? ' ORDER BY ' . $order : ' ORDER BY rand()';
     }
     /**
-     * 字段和表名处理
+     * 字段名分析
      * @access protected
      * @param string $key
-     * @param bool   $strict
      * @return string
      */
-    protected function parseKey($key, $strict = false)
+    protected function parseKey(&$key)
     {
         $key = trim($key);
-        if ($strict || (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)\[.\s]/', $key))) {
+        if (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)\[.\s]/', $key)) {
             $key = '[' . $key . ']';
         }
         return $key;
     }
     /**
      * limit
      * @access public
      * @param mixed $limit
      * @return string
      */

--- a/ThinkPHP/Library/Think/Db/Lite.class.php
+++ b/ThinkPHP/Library/Think/Db/Lite.class.php
@@ -4,21 +4,20 @@
 use Think\Config;
 use Think\Debug;
 class Lite
 {
     protected $PDOStatement = null;
     protected $model = '_think_';
     protected $queryStr = '';
     protected $modelSql = array();
     protected $lastInsID = null;
     protected $numRows = 0;
-    protected $transPDO = null;
     protected $transTimes = 0;
     protected $error = '';
     protected $linkID = array();
     protected $_linkID = null;
     protected $config = array(
         'type'        => '', // 数据库类型
         'hostname'    => '127.0.0.1', // 服务器地址
         'database'    => '', // 数据库名
         'username'    => '', // 用户名
         'password'    => '', // 密码
@@ -194,57 +193,52 @@
      * @access public
      * @return void
      */
     public function startTrans()
     {
         $this->initConnect(true);
         if (!$this->_linkID) {
             return false;
         }
         if (0 == $this->transTimes) {
-            $this->transPdo = $this->_linkID;
             $this->_linkID->beginTransaction();
         }
         $this->transTimes++;
         return;
     }
     /**
      * 用于非自动提交状态下面的查询提交
      * @access public
      * @return boolean
      */
     public function commit()
     {
-        if ($this->transTimes == 1) {
-            $result = $this->_linkID->commit();
+        if ($this->transTimes > 0) {
+            $result           = $this->_linkID->commit();
             $this->transTimes = 0;
-            $this->transPdo = null;
             if (!$result) {
                 $this->error();
                 return false;
             }
-        } else {
-            $this->transTimes--;
         }
         return true;
     }
     /**
      * 事务回滚
      * @access public
      * @return boolean
      */
     public function rollback()
     {
         if ($this->transTimes > 0) {
-            $result = $this->_linkID->rollback();
+            $result           = $this->_linkID->rollback();
             $this->transTimes = 0;
-            $this->transPdo = null;
             if (!$result) {
                 $this->error();
                 return false;
             }
         }
         return true;
     }
     /**
      * 获得所有的查询数据
      * @access private
@@ -373,23 +367,20 @@
         }
     }
     /**
      * 初始化数据库连接
      * @access protected
      * @param boolean $master 主服务器
      * @return void
      */
     protected function initConnect($master = true)
     {
-        if ($this->transPDO) {
-            return $this->transPDO;
-        }
         if (!empty($this->config['deploy']))
         {
             $this->_linkID = $this->multiConnect($master);
         } else
         if (!$this->_linkID) {
             $this->_linkID = $this->connect();
         }
     }
     /**
      * 连接分布式服务器

--- a/ThinkPHP/Library/Think/Dispatcher.class.php
+++ b/ThinkPHP/Library/Think/Dispatcher.class.php
@@ -6,53 +6,57 @@
  */
 class Dispatcher
 {
     /**
      * URL映射到控制器
      * @access public
      * @return void
      */
     public static function dispatch()
     {
-        $varPath = C('VAR_PATHINFO');
-        $urlCase = C('URL_CASE_INSENSITIVE');
-        if (isset($_GET[$varPath])) { // 判断URL里面是否有兼容模式参数
+        $varPath       = C('VAR_PATHINFO');
+        $varAddon      = C('VAR_ADDON');
+        $varModule     = C('VAR_MODULE');
+        $varController = C('VAR_CONTROLLER');
+        $varAction     = C('VAR_ACTION');
+        $urlCase       = C('URL_CASE_INSENSITIVE');
+        if (isset($_GET[$varPath])) {
             $_SERVER['PATH_INFO'] = $_GET[$varPath];
             unset($_GET[$varPath]);
-        } elseif (IS_CLI) { // CLI模式下 index.php module/controller/action/params/...
+        } elseif (IS_CLI) {
             $_SERVER['PATH_INFO'] = isset($_SERVER['argv'][1]) ? $_SERVER['argv'][1] : '';
         }
         if (C('APP_SUB_DOMAIN_DEPLOY')) {
             $rules = C('APP_SUB_DOMAIN_RULES');
-            if (isset($rules[$_SERVER['HTTP_HOST']])) { // 完整域名或者IP配置
+            if (isset($rules[$_SERVER['HTTP_HOST']])) {
                 define('APP_DOMAIN', $_SERVER['HTTP_HOST']); // 当前完整域名
                 $rule = $rules[APP_DOMAIN];
             } else {
-                if (strpos(C('APP_DOMAIN_SUFFIX'), '.')) { // com.cn net.cn
+                if (strpos(C('APP_DOMAIN_SUFFIX'), '.')) {
                     $domain = array_slice(explode('.', $_SERVER['HTTP_HOST']), 0, -3);
                 } else {
                     $domain = array_slice(explode('.', $_SERVER['HTTP_HOST']), 0, -2);
                 }
                 if (!empty($domain)) {
                     $subDomain = implode('.', $domain);
                     define('SUB_DOMAIN', $subDomain); // 当前完整子域名
                     $domain2 = array_pop($domain); // 二级域名
                     if ($domain) {
                         $domain3 = array_pop($domain);
                     }
                     if (isset($rules[$subDomain])) {
                         $rule = $rules[$subDomain];
                     } elseif (isset($rules['*.' . $domain2]) && !empty($domain3)) {
-                        $rule = $rules['*.' . $domain2];
+                        $rule      = $rules['*.' . $domain2];
                         $panDomain = $domain3;
                     } elseif (isset($rules['*']) && !empty($domain2) && 'www' != $domain2) {
-                        $rule = $rules['*'];
+                        $rule      = $rules['*'];
                         $panDomain = $domain2;
                     }
                 }
             }
             if (!empty($rule)) {
                 if (is_array($rule)) {
                     list($rule, $vars) = $rule;
                 }
                 $array = explode('/', $rule);
                 define('BIND_MODULE', array_shift($array));
@@ -75,193 +79,164 @@
             }
         }
         if (!isset($_SERVER['PATH_INFO'])) {
             $types = explode(',', C('URL_PATHINFO_FETCH'));
             foreach ($types as $type) {
                 if (0 === strpos($type, ':')) {
                     $_SERVER['PATH_INFO'] = call_user_func(substr($type, 1));
                     break;
                 } elseif (!empty($_SERVER[$type])) {
                     $_SERVER['PATH_INFO'] = (0 === strpos($_SERVER[$type], $_SERVER['SCRIPT_NAME'])) ?
-                        substr($_SERVER[$type], strlen($_SERVER['SCRIPT_NAME'])) : $_SERVER[$type];
+                    substr($_SERVER[$type], strlen($_SERVER['SCRIPT_NAME'])) : $_SERVER[$type];
                     break;
                 }
             }
         }
         $depr = C('URL_PATHINFO_DEPR');
         define('MODULE_PATHINFO_DEPR', $depr);
         if (empty($_SERVER['PATH_INFO'])) {
             $_SERVER['PATH_INFO'] = '';
             define('__INFO__', '');
             define('__EXT__', '');
-            $paths = array();
         } else {
+            define('__INFO__', trim($_SERVER['PATH_INFO'], '/'));
             define('__EXT__', strtolower(pathinfo($_SERVER['PATH_INFO'], PATHINFO_EXTENSION)));
-            if ($denySuffix = C('URL_DENY_SUFFIX')) {
-                if (in_array(__EXT__, explode('|', strtolower(str_replace('.', '', $denySuffix))))) {
-                    send_http_status(404);
-                    exit;
-                }
-            }
-            define('__INFO__', trim($_SERVER['PATH_INFO'], '/'));
-            $_SERVER['PATH_INFO'] = preg_replace('/\.' . __EXT__ . '$/i', '', __INFO__);
-            $paths = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
+            $_SERVER['PATH_INFO'] = __INFO__;
+            if (!defined('BIND_MODULE') && (!C('URL_ROUTER_ON') || !Route::check())) {
+                if (__INFO__ && C('MULTI_MODULE')) {
+                    $paths                = explode($depr, __INFO__, 2);
+                    $_GET[$varModule]     = preg_replace('/\.' . __EXT__ . '$/i', '', $paths[0]);
+                    $_SERVER['PATH_INFO'] = isset($paths[1]) ? $paths[1] : '';
+                }
+            }
         }
         define('__SELF__', strip_tags($_SERVER[C('URL_REQUEST_URI')]));
-        define('MODULE_NAME', self::getModule($paths));
-        if (MODULE_NAME && is_dir(APP_PATH . MODULE_NAME)) {
+        define('MODULE_NAME', defined('BIND_MODULE') ? BIND_MODULE : self::getModule($varModule));
+        if (MODULE_NAME && !in_array_case(MODULE_NAME, C('MODULE_DENY_LIST')) && is_dir(APP_PATH . MODULE_NAME)) {
             define('MODULE_PATH', APP_PATH . MODULE_NAME . '/');
             C('CACHE_PATH', CACHE_PATH . MODULE_NAME . '/');
             C('LOG_PATH', realpath(LOG_PATH) . '/' . MODULE_NAME . '/');
             Hook::listen('module_check');
             if (is_file(MODULE_PATH . 'Conf/config' . CONF_EXT)) {
                 C(load_config(MODULE_PATH . 'Conf/config' . CONF_EXT));
             }
             if ('common' != APP_MODE && is_file(MODULE_PATH . 'Conf/config_' . APP_MODE . CONF_EXT)) {
                 C(load_config(MODULE_PATH . 'Conf/config_' . APP_MODE . CONF_EXT));
             }
             if (APP_STATUS && is_file(MODULE_PATH . 'Conf/' . APP_STATUS . CONF_EXT)) {
                 C(load_config(MODULE_PATH . 'Conf/' . APP_STATUS . CONF_EXT));
             }
             if (is_file(MODULE_PATH . 'Conf/alias.php')) {
                 Think::addMap(include MODULE_PATH . 'Conf/alias.php');
             }
             if (is_file(MODULE_PATH . 'Conf/tags.php')) {
                 Hook::import(include MODULE_PATH . 'Conf/tags.php');
             }
-            if (is_file(MODULE_PATH . 'Common/function.php'))
+            if (is_file(MODULE_PATH . 'Common/function.php')) {
                 include MODULE_PATH . 'Common/function.php';
+            }
+            $urlCase = C('URL_CASE_INSENSITIVE');
             load_ext_file(MODULE_PATH);
-            Hook::listen('module_config');
         } else {
             E(L('_MODULE_NOT_EXIST_') . ':' . MODULE_NAME);
         }
         if (!defined('__APP__')) {
             $urlMode = C('URL_MODEL');
             if (URL_COMPAT == $urlMode) {
                 define('PHP_FILE', _PHP_FILE_ . '?' . $varPath . '=');
             } elseif (URL_REWRITE == $urlMode) {
                 $url = dirname(_PHP_FILE_);
                 if ('/' == $url || '\\' == $url) {
                     $url = '';
                 }
                 define('PHP_FILE', $url);
             } else {
                 define('PHP_FILE', _PHP_FILE_);
             }
             define('__APP__', strip_tags(PHP_FILE));
         }
         $moduleName = defined('MODULE_ALIAS') ? MODULE_ALIAS : MODULE_NAME;
         define('__MODULE__', (defined('BIND_MODULE') || !C('MULTI_MODULE')) ? __APP__ : __APP__ . '/' . ($urlCase ? strtolower($moduleName) : $moduleName));
-        define('CONTROLLER_NAME', self::getController($paths, $urlCase));
-        define('ACTION_NAME', self::getAction($paths, $urlCase));
-        if ($paths) {
+        if ('' != $_SERVER['PATH_INFO'] && (!C('URL_ROUTER_ON') || !Route::check())) {
+            Hook::listen('path_info');
+            if (C('URL_DENY_SUFFIX') && preg_match('/\.(' . trim(C('URL_DENY_SUFFIX'), '.') . ')$/i', $_SERVER['PATH_INFO'])) {
+                send_http_status(404);
+                exit;
+            }
+            $_SERVER['PATH_INFO'] = preg_replace(C('URL_HTML_SUFFIX') ? '/\.(' . trim(C('URL_HTML_SUFFIX'), '.') . ')$/i' : '/\.' . __EXT__ . '$/i', '', $_SERVER['PATH_INFO']);
+            $depr  = C('URL_PATHINFO_DEPR');
+            $paths = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
+            if (!defined('BIND_CONTROLLER')) {
+                if (C('CONTROLLER_LEVEL') > 1) {
+                    $_GET[$varController] = implode('/', array_slice($paths, 0, C('CONTROLLER_LEVEL')));
+                    $paths                = array_slice($paths, C('CONTROLLER_LEVEL'));
+                } else {
+                    $_GET[$varController] = array_shift($paths);
+                }
+            }
+            if (!defined('BIND_ACTION')) {
+                $_GET[$varAction] = array_shift($paths);
+            }
             $var = array();
             if (C('URL_PARAMS_BIND') && 1 == C('URL_PARAMS_BIND_TYPE')) {
                 $var = $paths;
             } else {
-                preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {
-                    $var[$match[1]] = strip_tags($match[2]);
-                }, implode('/', $paths));
+                preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {$var[$match[1]] = strip_tags($match[2]);}, implode('/', $paths));
             }
             $_GET = array_merge($var, $_GET);
         }
-        define('CONTROLLER_PATH', self::getSpace($urlCase));
+        define('CONTROLLER_PATH', self::getSpace($varAddon, $urlCase));
+        define('CONTROLLER_NAME', defined('BIND_CONTROLLER') ? BIND_CONTROLLER : self::getController($varController, $urlCase));
+        define('ACTION_NAME', defined('BIND_ACTION') ? BIND_ACTION : self::getAction($varAction, $urlCase));
         $controllerName = defined('CONTROLLER_ALIAS') ? CONTROLLER_ALIAS : CONTROLLER_NAME;
         define('__CONTROLLER__', __MODULE__ . $depr . (defined('BIND_CONTROLLER') ? '' : ($urlCase ? parse_name($controllerName) : $controllerName)));
         define('__ACTION__', __CONTROLLER__ . $depr . (defined('ACTION_ALIAS') ? ACTION_ALIAS : ACTION_NAME));
-        $_REQUEST = array_merge($_POST, $_GET);
+        $_REQUEST = array_merge($_POST, $_GET, $_COOKIE); // -- 加了$_COOKIE.  保证哦..
     }
     /**
      * 获得控制器的命名空间路径 便于插件机制访问
-     * @param  boolean $urlCase 是否转换成小写
-     * @return string
-     */
-    private static function getSpace($urlCase)
-    {
-        $var = C('VAR_ADDON');
+     */
+    private static function getSpace($var, $urlCase)
+    {
         $space = !empty($_GET[$var]) ? strip_tags($_GET[$var]) : '';
         unset($_GET[$var]);
         return $space;
     }
     /**
      * 获得实际的控制器名称
-     * @param  array $paths path_info数组
-     * @param  boolean $urlCase 是否转换成小写
-     * @return string
-     */
-    private static function getController(&$paths, $urlCase)
-    {
-        if (defined('BIND_CONTROLLER')) {
-            return BIND_CONTROLLER;
-        } else {
-            if ($paths && C('URL_ROUTER_ON') && Route::check($paths)) {
-                $depr = C('URL_PATHINFO_DEPR');
-                $paths = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
-            }
-            if ($paths) {
-                Hook::listen('path_info');
-                if (C('CONTROLLER_LEVEL') > 1) {// 控制器层次
-                    $controller = implode('/', array_slice($paths, 0, C('CONTROLLER_LEVEL')));
-                    $paths = array_slice($paths, C('CONTROLLER_LEVEL'));
-                } else {
-                    $controller = array_shift($paths);
-                }
-            } else {
-                $var = C('VAR_CONTROLLER');
-                if (!empty($_GET[$var])) {
-                    $controller = $_GET[$var];
-                    unset($_GET[$var]);
-                } else {
-                    $controller = C('DEFAULT_CONTROLLER');
-                }
-            }
-        }
+     */
+    private static function getController($var, $urlCase)
+    {
+        $controller = (!empty($_GET[$var]) ? $_GET[$var] : C('DEFAULT_CONTROLLER'));
+        unset($_GET[$var]);
         if ($maps = C('URL_CONTROLLER_MAP')) {
             if (isset($maps[strtolower($controller)])) {
                 define('CONTROLLER_ALIAS', strtolower($controller));
                 return ucfirst($maps[CONTROLLER_ALIAS]);
             } elseif (array_search(strtolower($controller), $maps)) {
                 return '';
             }
         }
         if ($urlCase) {
             $controller = parse_name($controller, 1);
         }
         return strip_tags(ucfirst($controller));
     }
     /**
      * 获得实际的操作名称
-     * @param  array $paths path_info数组
-     * @param  boolean $urlCase 是否转换成小写
-     * @return string
-     */
-    private static function getAction(&$paths, $urlCase)
-    {
-        if (defined('BIND_ACTION')) {
-            return BIND_ACTION;
-        } else {
-            if ($paths) {
-                $action = array_shift($paths);
-            } else {
-                $var = C('VAR_ACTION');
-                if (!empty($_GET[$var])) {
-                    $action = $_GET[$var];
-                    unset($_GET[$var]);
-                } elseif (!empty($_POST[$var])) {
-                    $action = $_POST[$var];
-                    unset($_POST[$var]);
-                } else {
-                    $action = C('DEFAULT_ACTION');
-                }
-            }
-        }
+     */
+    private static function getAction($var, $urlCase)
+    {
+        $action = !empty($_POST[$var]) ?
+        $_POST[$var] :
+        (!empty($_GET[$var]) ? $_GET[$var] : C('DEFAULT_ACTION'));
+        unset($_POST[$var], $_GET[$var]);
         if ($maps = C('URL_ACTION_MAP')) {
             if (isset($maps[strtolower(CONTROLLER_NAME)])) {
                 $maps = $maps[strtolower(CONTROLLER_NAME)];
                 if (isset($maps[strtolower($action)])) {
                     define('ACTION_ALIAS', strtolower($action));
                     if (is_array($maps[ACTION_ALIAS])) {
                         parse_str($maps[ACTION_ALIAS][1], $vars);
                         $_GET = array_merge($_GET, $vars);
                         return $maps[ACTION_ALIAS][0];
                     } else {
@@ -269,49 +244,30 @@
                     }
                 } elseif (array_search(strtolower($action), $maps)) {
                     return '';
                 }
             }
         }
         return strip_tags($urlCase ? strtolower($action) : $action);
     }
     /**
      * 获得实际的模块名称
-     * @param  array $paths path_info数组
-     * @return string
-     */
-    private static function getModule(&$paths)
-    {
-        if (defined('BIND_MODULE')) {
-            return BIND_MODULE;
-        } else {
-            if ($paths && C('URL_ROUTER_ON') && Route::check($paths)) {
-                $paths = explode(MODULE_PATHINFO_DEPR, trim($_SERVER['PATH_INFO'], MODULE_PATHINFO_DEPR));
-            }
-            if ($paths && C('MULTI_MODULE')) { // 获取模块名
-                $allowList = C('MODULE_ALLOW_LIST'); // 允许的模块列表
-                if (empty($allowList) || (is_array($allowList) && in_array_case($paths[0], $allowList))) {
-                    $module = array_shift($paths);
-                    $_SERVER['PATH_INFO'] = implode(MODULE_PATHINFO_DEPR, $paths);
-                }
-            } else {
-                $var = C('VAR_MODULE');
-                if (!empty($_GET[$var])) {
-                    $module = $_GET[$var];
-                    unset($_GET[$var]);
-                }
-            }
-            if (empty($module)) {
-                $module = C('DEFAULT_MODULE');
-            }
+     */
+    private static function getModule($var)
+    {
+        $module = (!empty($_GET[$var]) ? $_GET[$var] : C('DEFAULT_MODULE'));
+        unset($_GET[$var]);
+        $allowList = C('MODULE_ALLOW_LIST'); // 允许的模块列表
+        if (!empty($allowList) && is_array($allowList) && !in_array_case($module, $allowList)) {
+            E(L('_MODULE_NOT_EXIST_') . ':' . strip_tags(ucfirst($module)));
         }
         if ($maps = C('URL_MODULE_MAP')) {
             if (isset($maps[strtolower($module)])) {
                 define('MODULE_ALIAS', strtolower($module));
                 return ucfirst($maps[MODULE_ALIAS]);
-            } elseif (array_search(strtolower($module), $maps) || in_array_case($module, C('MODULE_DENY_LIST'))) {
+            } elseif (array_search(strtolower($module), $maps)) {
                 return '';
             }
         }
         return strip_tags(ucfirst($module));
     }
 }

--- a/ThinkPHP/Library/Think/Image/Driver/Gd.class.php
+++ b/ThinkPHP/Library/Think/Image/Driver/Gd.class.php
@@ -20,21 +20,21 @@
     public function __construct($imgname = null)
     {
         $imgname && $this->open($imgname);
     }
     /**
      * 打开一张图像
      * @param  string $imgname 图像路径
      */
     public function open($imgname)
     {
-        if (substr($imgname, 0, 4) != 'http' && !is_file($imgname)) {
+        if (!is_file($imgname)) {
             E('不存在的图像文件');
         }
         $info = getimagesize($imgname);
         if (false === $info || (IMAGETYPE_GIF === $info[2] && empty($info['bits']))) {
             E('非法图像文件');
         }
         $this->info = array(
             'width'  => $info[0],
             'height' => $info[1],
             'type'   => image_type_to_extension($info[2], false),
@@ -65,23 +65,20 @@
         if (is_null($type)) {
             $type = $this->info['type'];
         } else {
             $type = strtolower($type);
         }
         if ('jpeg' == $type || 'jpg' == $type) {
             imageinterlace($this->img, $interlace);
             imagejpeg($this->img, $imgname, $quality);
         } elseif ('gif' == $type && !empty($this->gif)) {
             $this->gif->save($imgname);
-        } elseif ('png' == $type) {
-            imagesavealpha($this->img, true);
-            imagepng($this->img, $imgname, $quality / 10);
         } else {
             $fun = 'image' . $type;
             $fun($this->img, $imgname);
         }
     }
     /**
      * 返回图像宽度
      * @return integer 图像宽度
      */
     public function width()
@@ -148,23 +145,20 @@
     {
         if (empty($this->img)) {
             E('没有可以被裁剪的图像资源');
         }
         empty($width) && $width   = $w;
         empty($height) && $height = $h;
         do {
             $img = imagecreatetruecolor($width, $height);
             $color = imagecolorallocate($img, 255, 255, 255);
             imagefill($img, 0, 0, $color);
-            if ('png' == $this->info['type']) {
-                imagealphablending($img, false);
-            }
             imagecopyresampled($img, $this->img, 0, 0, $x, $y, $width, $height, $w, $h);
             imagedestroy($this->img); //销毁原图
             $this->img = $img;
         } while (!empty($this->gif) && $this->gifNext());
         $this->info['width']  = $width;
         $this->info['height'] = $height;
     }
     /**
      * 生成缩略图
      * @param  integer $width  缩略图最大宽度
@@ -222,21 +216,21 @@
                 }
                 $neww = $w * $scale;
                 $newh = $h * $scale;
                 $posx = ($width - $w * $scale) / 2;
                 $posy = ($height - $h * $scale) / 2;
                 do {
                     $img = imagecreatetruecolor($width, $height);
                     $color = imagecolorallocate($img, 255, 255, 255);
                     imagefill($img, 0, 0, $color);
                     imagecopyresampled($img, $this->img, $posx, $posy, $x, $y, $neww, $newh, $w, $h);
-                    imagedestroy($this->img);     //销毁原图
+                    imagedestroy($this->img); //销毁原图
                     $this->img = $img;
                 } while (!empty($this->gif) && $this->gifNext());
                 $this->info['width']  = $width;
                 $this->info['height'] = $height;
                 return;
             /* 固定 */
             case Image::IMAGE_THUMB_FIXED:
                 $x = $y = 0;
                 break;
             default:
@@ -306,21 +300,21 @@
             case Image::IMAGE_WATER_NORTH:
                 $x = ($this->info['width'] - $info[0]) / 2;
                 $y = 0;
                 break;
             /* 左居中水印 */
             case Image::IMAGE_WATER_WEST:
                 $x = 0;
                 $y = ($this->info['height'] - $info[1]) / 2;
                 break;
             default:
-            /* 自定义水印坐标 */
+                /* 自定义水印坐标 */
                 if (is_array($locate)) {
                     list($x, $y) = $locate;
                 } else {
                     E('不支持的水印位置类型');
                 }
         }
         do {
             $src = imagecreatetruecolor($info[0], $info[1]);
             $color = imagecolorallocate($src, 255, 255, 255);
             imagefill($src, 0, 0, $color);
@@ -394,21 +388,21 @@
                 break;
             /* 上居中文字 */
             case Image::IMAGE_WATER_NORTH:
                 $x += ($this->info['width'] - $w) / 2;
                 break;
             /* 左居中文字 */
             case Image::IMAGE_WATER_WEST:
                 $y += ($this->info['height'] - $h) / 2;
                 break;
             default:
-            /* 自定义文字坐标 */
+                /* 自定义文字坐标 */
                 if (is_array($locate)) {
                     list($posx, $posy) = $locate;
                     $x += $posx;
                     $y += $posy;
                 } else {
                     E('不支持的文字位置类型');
                 }
         }
         /* 设置偏移量 */
         if (is_array($offset)) {

--- a/ThinkPHP/Library/Think/Image/Driver/Imagick.class.php
+++ b/ThinkPHP/Library/Think/Image/Driver/Imagick.class.php
@@ -50,22 +50,22 @@
     {
         if (empty($this->img)) {
             E('没有可以被保存的图像资源');
         }
         if (is_null($type)) {
             $type = $this->info['type'];
         } else {
             $type = strtolower($type);
             $this->img->setImageFormat($type);
         }
-        if ('jpeg' == $type || 'jpg' == $type || 'png' == $type) {
-            $this->img->setImageInterlaceScheme(\Imagick::INTERLACE_PLANE);
+        if ('jpeg' == $type || 'jpg' == $type) {
+            $this->img->setImageInterlaceScheme(1);
         }
         $this->img->setImageCompressionQuality($quality);
         $this->img->stripImage();
         $imgname = realpath(dirname($imgname)) . '/' . basename($imgname); //强制绝对路径
         if ('gif' == $type) {
             $this->img->writeImages($imgname, true);
         } else {
             $this->img->writeImage($imgname);
         }
     }

--- a/ThinkPHP/Library/Think/Model.class.php
+++ b/ThinkPHP/Library/Think/Model.class.php
@@ -25,21 +25,21 @@
     protected $error = '';
     protected $fields = array();
     protected $data = array();
     protected $options   = array();
     protected $_validate = array(); // 自动验证定义
     protected $_auto     = array(); // 自动完成定义
     protected $_map      = array(); // 字段映射定义
     protected $_scope    = array(); // 命名范围定义
     protected $autoCheckFields = true;
     protected $patchValidate = false;
-    protected $methods = array('strict', 'order', 'alias', 'having', 'group', 'lock', 'distinct', 'auto', 'filter', 'validate', 'result', 'token', 'index', 'force', 'master');
+    protected $methods = array('strict', 'order', 'alias', 'having', 'group', 'lock', 'distinct', 'auto', 'filter', 'validate', 'result', 'token', 'index', 'force');
     /**
      * 架构函数
      * 取得DB类的实例对象 字段检查
      * @access public
      * @param string $name 模型名称
      * @param string $tablePrefix 表前缀
      * @param mixed $connection 数据库连接信息
      */
     public function __construct($name = '', $tablePrefix = '', $connection = '')
     {
@@ -51,55 +51,55 @@
                 $this->name = $name;
             }
         } elseif (empty($this->name)) {
             $this->name = $this->getModelName();
         }
         if (is_null($tablePrefix)) {
             $this->tablePrefix = '';
         } elseif ('' != $tablePrefix) {
             $this->tablePrefix = $tablePrefix;
         } elseif (!isset($this->tablePrefix)) {
-            $this->tablePrefix = !empty($this->connection) && !is_null(C($this->connection . '.DB_PREFIX')) ? C($this->connection . '.DB_PREFIX') : C('DB_PREFIX');
+            $this->tablePrefix = C('DB_PREFIX');
         }
         $this->db(0, empty($this->connection) ? $connection : $this->connection, true);
     }
     /**
      * 自动检测数据表信息
      * @access protected
      * @return void
      */
     protected function _checkTableInfo()
     {
         if (empty($this->fields)) {
             if (C('DB_FIELDS_CACHE')) {
-                $fields = F('_fields/' . strtolower($this->getTableName()));
+                $db     = $this->dbName ?: C('DB_NAME');
+                $fields = F('_fields/' . strtolower($db . '.' . $this->tablePrefix . $this->name));
                 if ($fields) {
                     $this->fields = $fields;
                     if (!empty($fields['_pk'])) {
                         $this->pk = $fields['_pk'];
                     }
                     return;
                 }
             }
             $this->flush();
         }
     }
     /**
      * 获取字段信息并缓存
      * @access public
      * @return void
      */
     public function flush()
     {
         $this->db->setModel($this->name);
-        $tableName = $this->getTableName();
-        $fields    = $this->db->getFields($tableName);
+        $fields = $this->db->getFields($this->getTableName());
         if (!$fields) {
             return false;
         }
         $this->fields = array_keys($fields);
         unset($this->fields['_pk']);
         foreach ($fields as $key => $val) {
             $type[$key] = $val['type'];
             if ($val['primary']) {
                 if (isset($this->fields['_pk']) && null != $this->fields['_pk']) {
                     if (is_string($this->fields['_pk'])) {
@@ -112,21 +112,22 @@
                     $this->pk            = $key;
                     $this->fields['_pk'] = $key;
                 }
                 if ($val['autoinc']) {
                     $this->autoinc = true;
                 }
             }
         }
         $this->fields['_type'] = $type;
         if (C('DB_FIELDS_CACHE')) {
-            F('_fields/' . strtolower($tableName), $this->fields);
+            $db = $this->dbName ?: C('DB_NAME');
+            F('_fields/' . strtolower($db . '.' . $this->tablePrefix . $this->name), $this->fields);
         }
     }
     /**
      * 设置数据对象的值
      * @access public
      * @param string $name 名称
      * @param mixed $value 值
      * @return void
      */
     public function __set($name, $value)
@@ -399,41 +400,42 @@
             } else {
                 return false;
             }
         }
         if (is_numeric($options) || is_string($options)) {
             if (strpos($options, ',')) {
                 $where[$pk] = array('IN', $options);
             } else {
                 $where[$pk] = $options;
             }
-            $this->options['where'] = $where;
+            $options          = array();
+            $options['where'] = $where;
         }
         if (is_array($options) && (count($options) > 0) && is_array($pk)) {
             $count = 0;
             foreach (array_keys($options) as $key) {
                 if (is_int($key)) {
                     $count++;
                 }
             }
             if (count($pk) == $count) {
                 $i = 0;
                 foreach ($pk as $field) {
                     $where[$field] = $options[$i];
                     unset($options[$i++]);
                 }
-                $this->options['where'] = $where;
+                $options['where'] = $where;
             } else {
                 return false;
             }
         }
-        $options = $this->_parseOptions();
+        $options = $this->_parseOptions($options);
         if (empty($options['where'])) {
             return false;
         }
         if (is_array($options['where']) && isset($options['where'][$pk])) {
             $pkValue = $options['where'][$pk];
         }
         if (false === $this->_before_delete($options)) {
             return false;
         }
         $result = $this->db->delete($options);
@@ -458,42 +460,43 @@
      */
     public function select($options = array())
     {
         $pk = $this->getPk();
         if (is_string($options) || is_numeric($options)) {
             if (strpos($options, ',')) {
                 $where[$pk] = array('IN', $options);
             } else {
                 $where[$pk] = $options;
             }
-            $this->options['where'] = $where;
+            $options          = array();
+            $options['where'] = $where;
         } elseif (is_array($options) && (count($options) > 0) && is_array($pk)) {
             $count = 0;
             foreach (array_keys($options) as $key) {
                 if (is_int($key)) {
                     $count++;
                 }
             }
             if (count($pk) == $count) {
                 $i = 0;
                 foreach ($pk as $field) {
                     $where[$field] = $options[$i];
                     unset($options[$i++]);
                 }
-                $this->options['where'] = $where;
+                $options['where'] = $where;
             } else {
                 return false;
             }
         } elseif (false === $options) {
-            $this->options['fetch_sql'] = true;
-        }
-        $options = $this->_parseOptions();
+            $options['fetch_sql'] = true;
+        }
+        $options = $this->_parseOptions($options);
         if (isset($options['cache'])) {
             $cache = $options['cache'];
             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
             $data  = S($key, '', $cache);
             if (false !== $data) {
                 return $data;
             }
         }
         $resultSet = $this->db->select($options);
         if (false === $resultSet) {
@@ -555,20 +558,25 @@
             $options['table'] .= ' ' . $options['alias'];
         }
         $options['model'] = $this->name;
         if (isset($options['where']) && is_array($options['where']) && !empty($fields) && !isset($options['join'])) {
             foreach ($options['where'] as $key => $val) {
                 $key = trim($key);
                 if (in_array($key, $fields, true)) {
                     if (is_scalar($val)) {
                         $this->_parseType($options['where'], $key);
                     }
+                } elseif (!is_numeric($key) && '_' != substr($key, 0, 1) && false === strpos($key, '.') && false === strpos($key, '(') && false === strpos($key, '|') && false === strpos($key, '&')) {
+                    if (!empty($this->options['strict'])) {
+                        E(L('_ERROR_QUERY_EXPRESS_') . ':[' . $key . '=>' . $val . ']');
+                    }
+                    unset($options['where'][$key]);
                 }
             }
         }
         $this->options = array();
         $this->_options_filter($options);
         return $options;
     }
     protected function _options_filter(&$options)
     {}
     /**
@@ -613,43 +621,44 @@
     /**
      * 查询数据
      * @access public
      * @param mixed $options 表达式参数
      * @return mixed
      */
     public function find($options = array())
     {
         if (is_numeric($options) || is_string($options)) {
             $where[$this->getPk()] = $options;
-            $this->options['where'] = $where;
+            $options               = array();
+            $options['where']      = $where;
         }
         $pk = $this->getPk();
         if (is_array($options) && (count($options) > 0) && is_array($pk)) {
             $count = 0;
             foreach (array_keys($options) as $key) {
                 if (is_int($key)) {
                     $count++;
                 }
             }
             if (count($pk) == $count) {
                 $i = 0;
                 foreach ($pk as $field) {
                     $where[$field] = $options[$i];
                     unset($options[$i++]);
                 }
-                $this->options['where'] = $where;
+                $options['where'] = $where;
             } else {
                 return false;
             }
         }
-        $this->options['limit'] = 1;
-        $options = $this->_parseOptions();
+        $options['limit'] = 1;
+        $options = $this->_parseOptions($options);
         if (isset($options['cache'])) {
             $cache = $options['cache'];
             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
             $data  = S($key, '', $cache);
             if (false !== $data) {
                 $this->data = $data;
                 return $data;
             }
         }
         $resultSet = $this->db->select($options);
@@ -657,22 +666,22 @@
             return false;
         }
         if (empty($resultSet)) {
             return null;
         }
         if (is_string($resultSet)) {
             return $resultSet;
         }
         $data = $this->_read_data($resultSet[0]);
         $this->_after_find($data, $options);
-        if (!empty($options['result'])) {
-            return $this->returnResult($data, $options['result']);
+        if (!empty($this->options['result'])) {
+            return $this->returnResult($data, $this->options['result']);
         }
         $this->data = $data;
         if (isset($cache)) {
             S($key, $data, $cache);
         }
         return $this->data;
     }
     protected function _after_find(&$result, $options)
     {}
     protected function returnResult($data, $type = '')
@@ -787,26 +796,26 @@
      * @return false|integer
      */
     protected function lazyWrite($guid, $step, $lazyTime)
     {
         if (false !== ($value = S($guid))) {
             if (NOW_TIME > S($guid . '_time') + $lazyTime) {
                 S($guid, null);
                 S($guid . '_time', null);
                 return $value + $step;
             } else {
-                S($guid, $value + $step, 0);
+                S($guid, $value + $step);
                 return false;
             }
         } else {
-            S($guid, $step, 0);
-            S($guid . '_time', NOW_TIME, 0);
+            S($guid, $step);
+            S($guid . '_time', NOW_TIME);
             return false;
         }
     }
     /**
      * 获取一条记录的某个字段值
      * @access public
      * @param string $field  字段名
      * @param string $spea  字段数据间隔符号 NULL返回数组
      * @return mixed
      */
@@ -898,29 +907,20 @@
         }
         $type = $type ?: (!empty($data[$this->getPk()]) ? self::MODEL_UPDATE : self::MODEL_INSERT);
         $data = $this->parseFieldsMap($data, 0);
         if (isset($this->options['field'])) {
             $fields = $this->options['field'];
             unset($this->options['field']);
         } elseif (self::MODEL_INSERT == $type && isset($this->insertFields)) {
             $fields = $this->insertFields;
         } elseif (self::MODEL_UPDATE == $type && isset($this->updateFields)) {
             $fields = $this->updateFields;
-            $pk     = $this->getPk();
-            if (is_string($pk)) {
-                array_push($fields, $pk);
-            }
-            if (is_array($pk)) {
-                foreach ($pk as $pkTemp) {
-                    array_push($fields, $pkTemp);
-                }
-            }
         }
         if (isset($fields)) {
             if (is_string($fields)) {
                 $fields = explode(',', $fields);
             }
             if (C('TOKEN_ON')) {
                 $fields[] = C('TOKEN_NAME', null, '__hash__');
             }
             foreach ($data as $key => $val) {
                 if (!in_array($key, $fields)) {

--- a/ThinkPHP/Library/Think/Model/MongoModel.class.php
+++ b/ThinkPHP/Library/Think/Model/MongoModel.class.php
@@ -101,22 +101,21 @@
      * 获取下一ID 用于自动增长型
      * @access public
      * @param string $pk 字段名 默认为主键
      * @return mixed
      */
     public function getMongoNextId($pk = '')
     {
         if (empty($pk)) {
             $pk = $this->getPk();
         }
-        $options = $this->_parseOptions();
-        return $this->db->getMongoNextId($pk,$options);
+        return $this->db->getMongoNextId($pk);
     }
     /**
      * 新增数据
      * @access public
      * @param mixed $data 数据
      * @param array $options 表达式
      * @param boolean $replace 是否replace
      * @return mixed
      */
     public function add($data = '', $options = array(), $replace = false)
@@ -142,21 +141,21 @@
                 return $data[$this->getPk()];
             }
         }
         return $result;
     }
     protected function _before_insert(&$data, $options)
     {
         if ($this->_autoinc && self::TYPE_INT == $this->_idType) {
             $pk = $this->getPk();
             if (!isset($data[$pk])) {
-                $data[$pk] = $this->db->getMongoNextId($pk, $options);
+                $data[$pk] = $this->db->getMongoNextId($pk);
             }
         }
     }
     public function clear()
     {
         return $this->db->clear();
     }
     protected function _after_select(&$resultSet, $options)
     {
         array_walk($resultSet, array($this, 'checkMongoId'));
@@ -173,53 +172,20 @@
             $result['_id'] = $result['_id']->__toString();
         }
         return $result;
     }
     protected function _options_filter(&$options)
     {
         $id = $this->getPk();
         if (isset($options['where'][$id]) && is_scalar($options['where'][$id]) && self::TYPE_OBJECT == $this->_idType) {
             $options['where'][$id] = new \MongoId($options['where'][$id]);
         }
-    }
-    /**
-     * 查询多行数据
-     * @access public
-     * @param mixed $options 表达式参数
-     * @return mixed
-     */
-    public function select($options = array())
-    {
-        if( is_numeric($options) || is_string($options)) {
-            $id = $this->getPk();
-            $where[$id] = $options;
-            $options = array();
-            $options['where'] = $where;
-        }
-        $options = $this->_parseOptions($options);
-        $result = $this->db->select($options);
-        if(false === $result) {
-            return false;
-        }
-        if(empty($result)) {// 查询结果为空
-            return null;
-        }
-        else{
-            $this->checkMongoId($result);
-        }
-        $data = array();
-        foreach($result as $v){
-            $data[] = $v;
-        }
-        $this->data = $data;
-        $this->_after_select($this->data, $options);
-        return $this->data;
     }
     /**
      * 查询数据
      * @access public
      * @param mixed $options 表达式参数
      * @return mixed
      */
     public function find($options = array())
     {
         if (is_numeric($options) || is_string($options)) {

--- a/ThinkPHP/Library/Think/Model/ViewModel.class.php
+++ b/ThinkPHP/Library/Think/Model/ViewModel.class.php
@@ -22,21 +22,21 @@
     public function getTableName()
     {
         if (empty($this->trueTableName)) {
             $tableName = '';
             foreach ($this->viewFields as $key => $view) {
                 if (isset($view['_table'])) {
                     $tableName .= $view['_table'];
                     $prefix    = $this->tablePrefix;
                     $tableName = preg_replace_callback("/__([A-Z_-]+)__/sU", function ($match) use ($prefix) {return $prefix . strtolower($match[1]);}, $tableName);
                 } else {
-                    $class = parse_res_name($key, C('DEFAULT_M_LAYER'));
+                    $class = $key . 'Model';
                     $Model = class_exists($class) ? new $class() : M($key);
                     $tableName .= $Model->getTableName();
                 }
                 $tableName .= !empty($view['_as']) ? ' ' . $view['_as'] : ' ' . $key;
                 $tableName .= !empty($view['_on']) ? ' ON ' . $view['_on'] : '';
                 $type = !empty($view['_type']) ? $view['_type'] : '';
                 $tableName .= ' ' . strtoupper($type) . ' JOIN ';
                 $len = strlen($type . '_JOIN ');
             }
             $tableName           = substr($tableName, 0, -$len);
@@ -77,92 +77,42 @@
     private function _checkFields($name, $fields)
     {
         if (false !== $pos = array_search('*', $fields)) {
             $fields = array_merge($fields, M($name)->getDbFields());
             unset($fields[$pos]);
         }
         return $fields;
     }
     /**
      * 检查条件中的视图字段
-     * @param $where 条件表达式
+     * @access protected
+     * @param mixed $data 条件表达式
      * @return array
      */
     protected function checkCondition($where)
     {
         if (is_array($where)) {
-            $fields = $field_map_table = array();
+            $view = array();
             foreach ($this->viewFields as $key => $val) {
-                $table_alias = isset($val['_as']) ? $val['_as'] : $key;
-                $val         = $this->_checkFields($key, $val);
-                foreach ($val as $as_name => $v) {
-                    if (is_numeric($as_name)) {
-                        $fields[]          = $v; //所有表字段集合
-                        $field_map_table[] = $table_alias; //所有表字段对应表名集合
-                    } else {
-                        $fields[$as_name]          = $v;
-                        $field_map_table[$as_name] = $table_alias;
-                    }
-                }
-            }
-            $where = $this->_parseWhere($where, $fields, $field_map_table);
+                $k   = isset($val['_as']) ? $val['_as'] : $key;
+                $val = $this->_checkFields($key, $val);
+                foreach ($where as $name => $value) {
+                    if (false !== $field = array_search($name, $val, true)) {
+                        $_key        = is_numeric($field) ? $k . '.' . $name : $k . '.' . $field;
+                        $view[$_key] = $value;
+                        unset($where[$name]);
+                    }
+                }
+            }
+            $where = array_merge($where, $view);
         }
         return $where;
-    }
-    /**
-     * 解析where表达式
-     * @param $where
-     * @param $fields
-     * @param $field_map_table
-     * @return array
-     */
-    private function _parseWhere($where, $fields, $field_map_table)
-    {
-        $view = array();
-        foreach ($where as $name => $val) {
-            if ('_complex' == $name) {
-                foreach ($val as $k => $v) {
-                    if (false === strpos(substr($k, 0, 1), '_')) {
-                        if (false !== $field = array_search($k, $fields, true)) { // 存在视图字段
-                            $k = is_numeric($field) ? $field_map_table[$field] . '.' . $k : $field_map_table[$field] . '.' . $field; //字段别名
-                        }
-                    } else if (is_array($v)) {
-                        $v = $this->_parseWhere($val[$k], $fields, $field_map_table);
-                    }
-                    $view[$name][$k] = $v;
-                }
-            } else {
-                if (strpos($name, '|')) {
-                    $arr = explode('|', $name);
-                    foreach ($arr as $k => $v) {
-                        if (false !== $field = array_search($v, $fields, true)) {
-                            $arr[$k] = is_numeric($field) ? $field_map_table[$field] . '.' . $v : $field_map_table[$field] . '.' . $field;
-                        }
-                    }
-                    $view[implode('|', $arr)] = $val;
-                } else if (strpos($name, '&')) {
-                    $arr = explode('&', $name);
-                    foreach ($arr as $k => $v) {
-                        if (false !== $field = array_search($v, $fields, true)) {
-                            $arr[$k] = is_numeric($field) ? $field_map_table[$field] . '.' . $v : $field_map_table[$field] . '.' . $field;
-                        }
-                    }
-                    $view[implode('&', $arr)] = $val;
-                } else {
-                    if (false !== $field = array_search($name, $fields, true)) {
-                        $name = is_numeric($field) ? $field_map_table[$field] . '.' . $name : $field_map_table[$field] . '.' . $field;
-                    }
-                    $view[$name] = $val;
-                }
-            }
-        }
-        return $view;
     }
     /**
      * 检查Order表达式中的视图字段
      * @access protected
      * @param string $order 字段
      * @return string
      */
     protected function checkOrder($order = '')
     {
         if (is_string($order) && !empty($order)) {

--- a/ThinkPHP/Library/Think/Route.class.php
+++ b/ThinkPHP/Library/Think/Route.class.php
@@ -1,410 +1,256 @@
 <?php
 namespace Think;
 /**
  * ThinkPHP路由解析类
  */
 class Route
 {
-    /**
-     * 路由检测
-     * @param  array $paths path_info数组
-     * @return boolean
-     */
-    public static function check($paths = array())
-    {
-        $rules = self::ruleCache();
-        if (!empty($paths)) {
-            $regx = implode('/', $paths);
-        } else {
-            $depr = C('URL_PATHINFO_DEPR');
-            $regx = preg_replace('/\.' . __EXT__ . '$/i', '', trim($_SERVER['PATH_INFO'], $depr));
-            if (!$regx) {
-                return false;
-            }
-            if ('/' != $depr) {
-                $regx = str_replace($depr, '/', $regx);
-            }
-        }
-        if (isset($rules[0][$regx])) {
-            $route = $rules[0][$regx];
-            $_SERVER['PATH_INFO'] = $route[0];
-            $args = array_pop($route);
-            if (!empty($route[1])) {
-                $args = array_merge($args, $route[1]);
-            }
-            $_GET = array_merge($args, $_GET);
+    public static function check()
+    {
+        $depr = C('URL_PATHINFO_DEPR');
+        $regx = preg_replace('/\.' . __EXT__ . '$/i', '', trim($_SERVER['PATH_INFO'], $depr));
+        if ('/' != $depr) {
+            $regx = str_replace($depr, '/', $regx);
+        }
+        $maps = C('URL_MAP_RULES');
+        if (isset($maps[$regx])) {
+            $var  = self::parseUrl($maps[$regx]);
+            $_GET = array_merge($var, $_GET);
             return true;
         }
-        if (!empty($rules[1])) {
-            foreach ($rules[1] as $rule => $route) {
-                $args = array_pop($route);
-                if (isset($route[2])) {
-                    if (!self::checkOption($route[2], __EXT__)) {
+        $routes = C('URL_ROUTE_RULES');
+        if (!empty($routes)) {
+            foreach ($routes as $rule => $route) {
+                if (is_numeric($rule)) {
+                    $rule = array_shift($route);
+                }
+                if (is_array($route) && isset($route[2])) {
+                    $options = $route[2];
+                    if (isset($options['ext']) && __EXT__ != $options['ext']) {
                         continue;
                     }
-                }
-                if ($matches = self::checkUrlMatch($rule, $args, $regx)) {
-                    if ($route[0] instanceof \Closure) {
-                        $result = self::invoke($route[0], $matches);
+                    if (isset($options['method']) && REQUEST_METHOD != strtoupper($options['method'])) {
+                        continue;
+                    }
+                    if (!empty($options['callback']) && is_callable($options['callback'])) {
+                        if (false === call_user_func($options['callback'])) {
+                            continue;
+                        }
+                    }
+                }
+                if (0 === strpos($rule, '/') && preg_match($rule, $regx, $matches)) {
+                    if ($route instanceof \Closure) {
+                        $result = self::invokeRegx($route, $matches);
                         return is_bool($result) ? $result : exit;
                     } else {
-                        if (strpos($route[0], ':')) {
-                            $matches = array_values($matches);
-                            $route[0] = preg_replace_callback('/:(\d+)/', function ($match) use (&$matches) {
-                                return $matches[$match[1] - 1];
-                            }, $route[0]);
-                        }
-                        if ('/' == substr($rule, 0, 1)) {
-                            $rule_params = array();
-                            foreach($route[1] as $param_key => $param)
-                            {
-                                list($param_name,$param_value) = explode('=', $param,2);
-                                if(!is_null($param_value))
-                                {
-                                    if(preg_match('/^:(\d*)$/',$param_value, $match_index))
-                                    {
-                                        $match_index = $match_index[1]-1;
-                                        $param_value = $matches[$match_index];
-                                    }
-                                    $rule_params[$param_name] = $param_value;
-                                    unset($route[1][$param_key]);
-                                }
+                        return self::parseRegex($matches, $route, $regx);
+                    }
+                } else {
+                    $len1 = substr_count($regx, '/');
+                    $len2 = substr_count($rule, '/');
+                    if ($len1 >= $len2 || strpos($rule, '[')) {
+                        if ('$' == substr($rule, -1, 1)) {
+                            if ($len1 != $len2) {
+                                continue;
+                            } else {
+                                $rule = substr($rule, 0, -1);
                             }
-                            $route[1] = $rule_params;
-                        }
-                        if ('/' == substr($route[0], 0, 1)) {
-                            header("Location: $route[0]", true, $route[1]);
-                            exit;
-                        } else {
-                            $depr = C('URL_PATHINFO_DEPR');
-                            if ('/' != $depr) {
-                                $route[0] = str_replace('/', $depr, $route[0]);
+                        }
+                        $match = self::checkUrlMatch($regx, $rule);
+                        if (false !== $match) {
+                            if ($route instanceof \Closure) {
+                                $result = self::invokeRule($route, $match);
+                                return is_bool($result) ? $result : exit;
+                            } else {
+                                return self::parseRule($rule, $route, $regx);
                             }
-                            $_SERVER['PATH_INFO'] = $route[0];
-                            if (!empty($route[1])) {
-                                $_GET = array_merge($route[1], $_GET);
-                            }
-                            return true;
                         }
                     }
                 }
             }
         }
         return false;
     }
-    /**
-     * 路由反向解析
-     * @param  string $path 控制器/方法
-     * @param  array $vars url参数
-     * @param  string $depr 分隔符
-     * @param  string|true $suffix url后缀
-     * @return string|false
-     */
-    public static function reverse($path, &$vars, $depr, $suffix = true)
-    {
-        static $_rules;
-        if (is_null($_rules)) {
-            if ($rules = self::ruleCache()) {
-                foreach ($rules as $i => $rules2) {
-                    foreach ($rules2 as $rule => $route) {
-                        if (is_array($route) && is_string($route[0]) && '/' != substr($route[0], 0, 1)) {
-                            $_rules[$i][$route[0]][$rule] = $route;
-                        }
-                    }
-                }
-            }
-        }
-        if (isset($_rules[0][$path])) {
-            foreach ($_rules[0][$path] as $rule => $route) {
-                $args = array_pop($route);
-                if (count($vars) == count($args) && !empty($vars) && !array_diff($vars, $args)) {
-                    return str_replace('/', $depr, $rule);
-                }
-            }
-        }
-        if (isset($_rules[1][$path])) {
-            foreach ($_rules[1][$path] as $rule => $route) {
-                $args = array_pop($route);
-                $array = array();
-                if (isset($route[2])) {
-                    if (!self::checkOption($route[2], $suffix)) {
-                        continue;
-                    }
-                }
-                if ('/' != substr($rule, 0, 1)) {
-                    foreach ($args as $key => $val) {
-                        $flag = false;
-                        if ($val[0] == 0) {
-                            $array[$key] = $key;
-                            continue;
-                        }
-                        if (isset($vars[$key])) {
-                            if (!empty($val[2])) {
-                                if ($val[2] == 'int') {
-                                    if (!is_numeric($vars[$key]) || !preg_match('/^\d*$/',$vars[$key])) {
-                                        break;
-                                    }
-                                } else {
-                                    if (in_array($vars[$key], $val[2])) {
-                                        break;
-                                    }
-                                }
-                            }
-                            $flag = true;
-                            $array[$key] = $vars[$key];
-                        } elseif ($val[0] == 1) {
-                            break;
-                        }
-                    }
-                    if (!empty($flag)) {
-                        foreach (array_keys($array) as $key) {
-                            $array[$key] = urlencode($array[$key]);
-                            unset($vars[$key]);
-                        }
-                        return implode($depr, $array);
-                    }
-                } else {
-                    $keys = !empty($args) ? array_keys($args) : array_keys($vars);
-                    $temp_vars = $vars;
-                    $str = preg_replace_callback('/\(.*?\)/', function ($match) use (&$temp_vars, &$keys) {
-                        $k = array_shift($keys);
-                        $re_var = '';
-                        if(isset($temp_vars[$k]))
-                        {
-                            $re_var = $temp_vars[$k];
-                            unset($temp_vars[$k]);
-                        }
-                        return urlencode($re_var);
-                    }, $rule);
-                    $str = substr($str, 1, -1);
-                    $str = rtrim(ltrim($str, '^'), '$');
-                    $str = str_replace('\\', '', $str);
-                    if (preg_match($rule, $str, $matches)) {
-                        $vars = $temp_vars;
-                        return str_replace('/', $depr, $str);
-                    }
-                }
-            }
-        }
-        return false;
-    }
-    /**
-     * 读取规则缓存
-     * @param  boolean $update 是否更新
-     * @return array
-     */
-    public static function ruleCache($update = false)
-    {
-        $result = array();
-        $module = defined('MODULE_NAME') ? '_' . MODULE_NAME : '';
-        if (APP_DEBUG || $update || !$result = S('url_route_rules' . $module)) {
-            $result[0] = C('URL_MAP_RULES');
-            if (!empty($result[0])) {
-                foreach ($result[0] as $rule => $route) {
-                    if (!is_array($route)) {
-                        $route = array($route);
-                    }
-                    if (strpos($route[0], '?')) {
-                        list($route[0], $args) = explode('?', $route[0], 2);
-                        parse_str($args, $args);
-                    } else {
-                        $args = array();
-                    }
-                    if (!empty($route[1]) && is_string($route[1])) {
-                        parse_str($route[1], $route[1]);
-                    }
-                    $route[] = $args;
-                    $result[0][$rule] = $route;
-                }
-            }
-            $result[1] = C('URL_ROUTE_RULES');
-            if (!empty($result[1])) {
-                foreach ($result[1] as $rule => $route) {
-                    if (!is_array($route)) {
-                        $route = array($route);
-                    } elseif (is_numeric($rule)) {
-                        $rule = array_shift($route);
-                    }
-                    if (!empty($route)) {
-                        $args = array();
-                        if (is_string($route[0])) {
-                            if (0 === strpos($route[0], '/') || 0 === strpos($route[0], 'http')) {
-                                if (!isset($route[1])) {
-                                    $route[1] = 301;
-                                }
-                            } else {
-                                if (!empty($route[1]) && is_string($route[1])) {
-                                    parse_str($route[1], $route[1]);
-                                }
-                                if (strpos($route[0], '?')) {
-                                    list($route[0], $params) = explode('?', $route[0], 2);
-                                    if (!empty($params)) {
-                                        foreach (explode('&', $params) as $key => $val) {
-                                            if (0 === strpos($val, ':')) {
-                                                $val = substr($val, 1);
-                                                $args[$key] = strpos($val, '|') ? explode('|', $val, 2) : array($val);
-                                            } else {
-                                                $route[1][$key] = $val;
-                                            }
-                                        }
-                                    }
-                                }
-                            }
-                        }
-                        if ('/' != substr($rule, 0, 1)) {
-                            foreach (explode('/', rtrim($rule, '$')) as $item) {
-                                $filter = $fun = '';
-                                $type = 0;
-                                if (0 === strpos($item, '[:')) {
-                                    $type = 2;
-                                    $item = substr($item, 1, -1);
-                                }
-                                if (0 === strpos($item, ':')) {
-                                    $type = $type ?: 1;
-                                    if ($pos = strpos($item, '|')) {
-                                        $fun = substr($item, $pos + 1);
-                                        $item = substr($item, 1, $pos - 1);
-                                    }
-                                    if ($pos = strpos($item, '^')) {
-                                        $filter = explode('-', substr($item, $pos + 1));
-                                        $item = substr($item, 1, $pos - 1);
-                                    } elseif (strpos($item, '\\')) {
-                                        if ('d' == substr($item, -1)) {
-                                            $filter = 'int';
-                                        }
-                                        $item = substr($item, 1, -2);
-                                    } else {
-                                        $item = substr($item, 1);
-                                    }
-                                }
-                                $args[$item] = array($type, $fun, $filter);
-                            }
-                        }
-                        $route[] = $args;
-                        $result[1][$rule] = $route;
-                    } else {
-                        unset($result[1][$rule]);
-                    }
-                }
-            }
-            S('url_route_rules' . $module, $result);
-        }
-        return $result;
-    }
-    /**
-     * 路由参数检测
-     * @param  array $options 路由参数
-     * @param  string|true $suffix URL后缀
-     * @return boolean
-     */
-    private static function checkOption($options, $suffix = true)
-    {
-        if (isset($options['ext'])) {
-            if ($suffix) {
-                $suffix = $suffix === true ? C('URL_HTML_SUFFIX') : $suffix;
-                if ($pos = strpos($suffix, '|')) {
-                    $suffix = substr($suffix, 0, $pos);
-                }
-            }
-            if ($suffix != $options['ext']) {
+    private static function checkUrlMatch($regx, $rule)
+    {
+        $m1  = explode('/', $regx);
+        $m2  = explode('/', $rule);
+        $var = array();
+        foreach ($m2 as $key => $val) {
+            if (0 === strpos($val, '[:')) {
+                $val = substr($val, 1, -1);
+            }
+            if (':' == substr($val, 0, 1)) {
+                if ($pos = strpos($val, '|')) {
+                    $val = substr($val, 1, $pos - 1);
+                }
+                if (strpos($val, '\\')) {
+                    $type = substr($val, -1);
+                    if ('d' == $type) {
+                        if (isset($m1[$key]) && !is_numeric($m1[$key])) {
+                            return false;
+                        }
+                    }
+                    $name = substr($val, 1, -2);
+                } elseif ($pos = strpos($val, '^')) {
+                    $array = explode('-', substr(strstr($val, '^'), 1));
+                    if (in_array($m1[$key], $array)) {
+                        return false;
+                    }
+                    $name = substr($val, 1, $pos - 1);
+                } else {
+                    $name = substr($val, 1);
+                }
+                $var[$name] = isset($m1[$key]) ? $m1[$key] : '';
+            } elseif (0 !== strcasecmp($val, $m1[$key])) {
                 return false;
             }
         }
-        if (isset($options['method']) && REQUEST_METHOD != strtoupper($options['method'])) {
-            return false;
-        }
-        if (!empty($options['callback']) && is_callable($options['callback'])) {
-            if (false === call_user_func($options['callback'])) {
-                return false;
-            }
+        return $var;
+    }
+    private static function parseUrl($url)
+    {
+        $var = array();
+        if (false !== strpos($url, '?')) {
+            $info = parse_url($url);
+            $path = explode('/', $info['path']);
+            parse_str($info['query'], $var);
+        } elseif (strpos($url, '/')) {
+            $path = explode('/', $url);
+        } else {
+            parse_str($url, $var);
+        }
+        if (isset($path)) {
+            $var[C('VAR_ACTION')] = array_pop($path);
+            if (!empty($path)) {
+                $var[C('VAR_CONTROLLER')] = array_pop($path);
+            }
+            if (!empty($path)) {
+                $var[C('VAR_MODULE')] = array_pop($path);
+            }
+        }
+        return $var;
+    }
+    private static function parseRule($rule, $route, $regx)
+    {
+        $url = is_array($route) ? $route[0] : $route;
+        $paths = explode('/', $regx);
+        $matches = array();
+        $rule    = explode('/', $rule);
+        foreach ($rule as $item) {
+            $fun = '';
+            if (0 === strpos($item, '[:')) {
+                $item = substr($item, 1, -1);
+            }
+            if (0 === strpos($item, ':')) {
+                if ($pos = strpos($item, '|')) {
+                    $fun  = substr($item, $pos + 1);
+                    $item = substr($item, 0, $pos);
+                }
+                if ($pos = strpos($item, '^')) {
+                    $var = substr($item, 1, $pos - 1);
+                } elseif (strpos($item, '\\')) {
+                    $var = substr($item, 1, -2);
+                } else {
+                    $var = substr($item, 1);
+                }
+                $matches[$var] = !empty($fun) ? $fun(array_shift($paths)) : array_shift($paths);
+            } else {
+                array_shift($paths);
+            }
+        }
+        if (0 === strpos($url, '/') || 0 === strpos($url, 'http')) {
+            if (strpos($url, ':')) { // 传递动态参数
+                $values = array_values($matches);
+                $url    = preg_replace_callback('/:(\d+)/', function ($match) use ($values) {return $values[$match[1] - 1];}, $url);
+            }
+            header("Location: $url", true, (is_array($route) && isset($route[1])) ? $route[1] : 301);
+            exit;
+        } else {
+            $var = self::parseUrl($url);
+            $values = array_values($matches);
+            foreach ($var as $key => $val) {
+                if (0 === strpos($val, ':')) {
+                    $var[$key] = $values[substr($val, 1) - 1];
+                }
+            }
+            $var = array_merge($matches, $var);
+            if (!empty($paths)) {
+                preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {$var[strtolower($match[1])] = strip_tags($match[2]);}, implode('/', $paths));
+            }
+            if (is_array($route) && isset($route[1])) {
+                if (is_array($route[1])) {
+                    $params = $route[1];
+                } else {
+                    parse_str($route[1], $params);
+                }
+                $var = array_merge($var, $params);
+            }
+            $_GET = array_merge($var, $_GET);
         }
         return true;
     }
-    /**
-     * 检测URL和路由规则是否匹配
-     * @param  string $rule 路由规则
-     * @param  array $args 路由动态变量
-     * @param  string $regx URL地址
-     * @return array|false
-     */
-    private static function checkUrlMatch(&$rule, &$args, &$regx)
-    {
-        $params = array();
-        if ('/' == substr($rule, 0, 1)) {
-            if (preg_match($rule, $regx, $matches)) {
-                if ($args) { // 存在动态变量
-                    foreach ($args as $key => $val) {
-                        $params[$key] = isset($val[1]) ? $val[1]($matches[$val[0]]) : $matches[$val[0]];
-                    }
-                    $regx = substr_replace($regx, '', 0, strlen($matches[0]));
-                }
-                array_shift($matches);
-                return $matches;
-            } else {
-                return false;
-            }
+    private static function parseRegex($matches, $route, $regx)
+    {
+        $url = is_array($route) ? $route[0] : $route;
+        $url = preg_replace_callback('/:(\d+)/', function ($match) use ($matches) {return $matches[$match[1]];}, $url);
+        if (0 === strpos($url, '/') || 0 === strpos($url, 'http')) {
+            header("Location: $url", true, (is_array($route) && isset($route[1])) ? $route[1] : 301);
+            exit;
         } else {
-            $paths = explode('/', $regx);
-            if ('$' == substr($rule, -1) && count($args) != count($paths)) {
-                return false;
-            }
-            foreach ($args as $key => $val) {
-                $var = array_shift($paths) ?: '';
-                if ($val[0] == 0) {
-                    if (0 !== strcasecmp($key, $var)) {
-                        return false;
-                    }
-                } else {
-                    if (isset($val[2])) {
-                        if ($val[2] == 'int') {
-                            if (!preg_match('/^\d*$/',$var)) {
-                                return false;
-                            }
-                        } else {
-                            if (in_array($var, $val[2])) {
-                                return false;
-                            }
-                        }
-                    }
-                    if (!empty($var)) {
-                        $params[$key] = !empty($val[1]) ? $val[1]($var) : $var;
-                    } elseif ($val[0] == 1) {
-                        return false;
-                    }
-                }
-            }
-            $matches = $params;
-            $regx = implode('/', $paths);
-        }
-        if ($regx) {
-            preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$params) {
-                $params[strtolower($match[1])] = strip_tags($match[2]);
-            }, $regx);
-        }
-        $_GET = array_merge($params, $_GET);
-        return $matches;
-    }
-    /**
-     * 执行闭包方法 支持参数调用
-     * @param  function $closure 闭包函数
-     * @param  array $var 传给闭包的参数
-     * @return boolean
-     */
-    private static function invoke($closure, $var = array())
+            $var = self::parseUrl($url);
+            foreach ($var as $key => $val) {
+                if (strpos($val, '|')) {
+                    list($val, $fun) = explode('|', $val);
+                    $var[$key]       = $fun($val);
+                }
+            }
+            $regx = substr_replace($regx, '', 0, strlen($matches[0]));
+            if ($regx) {
+                preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {
+                    $var[strtolower($match[1])] = strip_tags($match[2]);
+                }, $regx);
+            }
+            if (is_array($route) && isset($route[1])) {
+                if (is_array($route[1])) {
+                    $params = $route[1];
+                } else {
+                    parse_str($route[1], $params);
+                }
+                $var = array_merge($var, $params);
+            }
+            $_GET = array_merge($var, $_GET);
+        }
+        return true;
+    }
+    private static function invokeRegx($closure, $var = array())
     {
         $reflect = new \ReflectionFunction($closure);
-        $params = $reflect->getParameters();
-        $args = array();
-        foreach ($params as $i => $param) {
+        $params  = $reflect->getParameters();
+        $args    = array();
+        array_shift($var);
+        foreach ($params as $param) {
+            if (!empty($var)) {
+                $args[] = array_shift($var);
+            } elseif ($param->isDefaultValueAvailable()) {
+                $args[] = $param->getDefaultValue();
+            }
+        }
+        return $reflect->invokeArgs($args);
+    }
+    private static function invokeRule($closure, $var = array())
+    {
+        $reflect = new \ReflectionFunction($closure);
+        $params  = $reflect->getParameters();
+        $args    = array();
+        foreach ($params as $param) {
             $name = $param->getName();
             if (isset($var[$name])) {
                 $args[] = $var[$name];
-            } elseif (isset($var[$i])) {
-                $args[] = $var[$i];
             } elseif ($param->isDefaultValueAvailable()) {
                 $args[] = $param->getDefaultValue();
             }
         }
         return $reflect->invokeArgs($args);
     }
 }

--- a/ThinkPHP/Library/Think/Storage.class.php
+++ b/ThinkPHP/Library/Think/Storage.class.php
@@ -13,17 +13,17 @@
      * @access public
      * @param string $type 文件类型
      * @param array $options  配置数组
      * @return void
      */
     public static function connect($type = 'File', $options = array())
     {
         $class         = 'Think\\Storage\\Driver\\' . ucwords($type);
         self::$handler = new $class($options);
     }
-    public static function __callStatic($method, $args)
+    public static function __callstatic($method, $args)
     {
         if (method_exists(self::$handler, $method)) {
             return call_user_func_array(array(self::$handler, $method), $args);
         }
     }
 }

--- a/ThinkPHP/Library/Think/Think.class.php
+++ b/ThinkPHP/Library/Think/Think.class.php
@@ -16,23 +16,23 @@
     {
         spl_autoload_register('Think\Think::autoload');
         register_shutdown_function('Think\Think::fatalError');
         set_error_handler('Think\Think::appError');
         set_exception_handler('Think\Think::appException');
         Storage::connect(STORAGE_TYPE);
         $runtimefile = RUNTIME_PATH . APP_MODE . '~runtime.php';
         if (!APP_DEBUG && Storage::has($runtimefile)) {
             Storage::load($runtimefile);
         } else {
-            /*if (Storage::has($runtimefile)) {
+            if (Storage::has($runtimefile)) {
                 Storage::unlink($runtimefile);
-            }*/
+            }
             $content = '';
             $mode = include is_file(CONF_PATH . 'core.php') ? CONF_PATH . 'core.php' : MODE_PATH . APP_MODE . '.php';
             foreach ($mode['core'] as $file) {
                 if (is_file($file)) {
                     include $file;
                     if (!APP_DEBUG) {
                         $content .= compile($file);
                     }
                 }
             }

--- a/ThinkPHP/Library/Think/View.class.php
+++ b/ThinkPHP/Library/Think/View.class.php
@@ -97,47 +97,29 @@
             $templateFile = $this->parseTemplate($templateFile);
             if (!is_file($templateFile)) {
                 E(L('_TEMPLATE_NOT_EXIST_') . ':' . $templateFile);
             }
         } else {
             defined('THEME_PATH') or define('THEME_PATH', $this->getThemePath());
         }
         ob_start();
         ob_implicit_flush(0);
         if ('php' == strtolower(C('TMPL_ENGINE_TYPE'))) {
-            if (empty($content)) {
-                if (isset($this->tVar['templateFile'])) {
-                    $__template__ = $templateFile;
-                    extract($this->tVar, EXTR_OVERWRITE);
-                    include $__template__;
-                } else {
-                    extract($this->tVar, EXTR_OVERWRITE);
-                    include $templateFile;
-                }
-            } elseif (isset($this->tVar['content'])) {
-                $__content__ = $content;
-                extract($this->tVar, EXTR_OVERWRITE);
-                eval('?>' . $__content__);
-            } else {
-                extract($this->tVar, EXTR_OVERWRITE);
-                eval('?>' . $content);
-            }
+            $_content = $content;
+            extract($this->tVar, EXTR_OVERWRITE);
+            empty($_content) ? include $templateFile : eval('?>' . $_content);
         } else {
             $params = array('var' => $this->tVar, 'file' => $templateFile, 'content' => $content, 'prefix' => $prefix);
             Hook::listen('view_parse', $params);
         }
         $content = ob_get_clean();
         Hook::listen('view_filter', $content);
-        if (APP_DEBUG && C('PARSE_VAR')) {
-            $parseVar = empty($this->tVar) ? json_encode(array()) : json_encode($this->tVar);
-            $content  = $content . '<script type="text/javascript">var PARSE_VAR = ' . $parseVar . ';</script>';
-        }
         return $content;
     }
     /**
      * 自动定位模板文件
      * @access protected
      * @param string $template 模板文件规则
      * @return string
      */
     public function parseTemplate($template = '')
     {

--- a/ThinkPHP/ThinkPHP.php
+++ b/ThinkPHP/ThinkPHP.php
@@ -1,17 +1,17 @@
 <?php
 $GLOBALS['_beginTime'] = microtime(true);
 define('MEMORY_LIMIT_ON', function_exists('memory_get_usage'));
 if (MEMORY_LIMIT_ON) {
     $GLOBALS['_startUseMems'] = memory_get_usage();
 }
-const THINK_VERSION = '3.2.4';
+const THINK_VERSION = '3.2.3';
 const URL_COMMON   = 0; //普通模式
 const URL_PATHINFO = 1; //PATHINFO模式
 const URL_REWRITE  = 2; //REWRITE模式
 const URL_COMPAT   = 3; // 兼容模式
 const EXT = '.class.php';
 defined('THINK_PATH') or define('THINK_PATH', __DIR__ . '/');
 defined('APP_PATH') or define('APP_PATH', dirname($_SERVER['SCRIPT_FILENAME']) . '/');
 defined('APP_STATUS') or define('APP_STATUS', ''); // 应用状态 加载对应的配置文件
 defined('APP_DEBUG') or define('APP_DEBUG', false); // 是否调试模式
 if (function_exists('saeAutoLoader')) {
