# ====================================================================
# FILE: ThinkPHP/Common/functions.php
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 257-306 ---
   257|     if (strpos($name, '.')) {
   258|         list($method, $name) = explode('.', $name, 2);
   259|     } else {
   260|         $method = 'param';
   261|     }
   262|     switch (strtolower($method)) {
   263|         case 'get':
   264|             $input = &$_GET;
   265|             break;
   266|         case 'post':
   267|             $input = &$_POST;
   268|             break;
   269|         case 'put':
   270|             if (is_null($_PUT)) {
   271|                 parse_str(file_get_contents('php://input'), $_PUT);
   272|             }
   273|             $input = $_PUT;
   274|             break;
   275|         case 'param':
   276|             switch ($_SERVER['REQUEST_METHOD']) {
   277|                 case 'POST':
   278|                     $input = $_POST;
   279|                     break;
   280|                 case 'PUT':
   281|                     if (is_null($_PUT)) {
   282|                         parse_str(file_get_contents('php://input'), $_PUT);
   283|                     }
   284|                     $input = $_PUT;
   285|                     break;
   286|                 default:
   287|                     $input = $_GET;
   288|             }
   289|             break;
   290|         case 'path':
   291|             $input = array();
   292|             if (!empty($_SERVER['PATH_INFO'])) {
   293|                 $depr  = C('URL_PATHINFO_DEPR');
   294|                 $input = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
   295|             }
   296|             break;
   297|         case 'request':
   298|             $input = &$_REQUEST;
   299|             break;
   300|         case 'session':
   301|             $input = &$_SESSION;
   302|             break;
   303|         case 'cookie':
   304|             $input = &$_COOKIE;
   305|             break;
   306|         case 'server':

# --- HUNK 2: Lines 326-392 ---
   326|                 $data = array_map_recursive($filter, $data); // 参数过滤
   327|             }
   328|         }
   329|     } elseif (isset($input[$name])) {
   330|         $data    = $input[$name];
   331|         $filters = isset($filter) ? $filter : C('DEFAULT_FILTER');
   332|         if ($filters) {
   333|             if (is_string($filters)) {
   334|                 if (0 === strpos($filters, '/')) {
   335|                     if (1 !== preg_match($filters, (string) $data)) {
   336|                         return isset($default) ? $default : null;
   337|                     }
   338|                 } else {
   339|                     $filters = explode(',', $filters);
   340|                 }
   341|             } elseif (is_int($filters)) {
   342|                 $filters = array($filters);
   343|             }
   344|             if (is_array($filters)) {
   345|                 foreach ($filters as $filter) {
   346|                     $filter = trim($filter);
   347|                     if (function_exists($filter)) {
   348|                         $data = is_array($data) ? array_map_recursive($filter, $data) : $filter($data); // 参数过滤
   349|                     } else {
   350|                         $data = filter_var($data, is_int($filter) ? $filter : filter_id($filter));
   351|                         if (false === $data) {
   352|                             return isset($default) ? $default : null;
   353|                         }
   354|                     }
   355|                 }
   356|             }
   357|         }
   358|         if (!empty($type)) {
   359|             switch (strtolower($type)) {
   360|                 case 'a': // 数组
   361|                     $data = (array) $data;
   362|                     break;
   363|                 case 'd': // 数字
   364|                     $data = (int) $data;
   365|                     break;
   366|                 case 'f': // 浮点
   367|                     $data = (float) $data;
   368|                     break;
   369|                 case 'b': // 布尔
   370|                     $data = (boolean) $data;
   371|                     break;
   372|                 case 's': // 字符串
   373|                 default:
   374|                     $data = (string) $data;
   375|             }
   376|         }
   377|     } else {
   378|         $data = isset($default) ? $default : null;
   379|     }
   380|     is_array($data) && array_walk_recursive($data, 'think_filter');
   381|     return $data;
   382| }
   383| function array_map_recursive($filter, $data)
   384| {
   385|     $result = array();
   386|     foreach ($data as $key => $val) {
   387|         $result[$key] = is_array($val)
   388|         ? array_map_recursive($filter, $val)
   389|         : call_user_func($filter, $val);
   390|     }
   391|     return $result;
   392| }

# --- HUNK 3: Lines 919-1027 ---
   919|             if ($maps = C('URL_ACTION_MAP')) {
   920|                 if (isset($maps[strtolower($var[$varController])])) {
   921|                     $maps = $maps[strtolower($var[$varController])];
   922|                     if ($action = array_search(strtolower($var[$varAction]), $maps)) {
   923|                         $var[$varAction] = $action;
   924|                     }
   925|                 }
   926|             }
   927|             if ($maps = C('URL_CONTROLLER_MAP')) {
   928|                 if ($controller = array_search(strtolower($var[$varController]), $maps)) {
   929|                     $var[$varController] = $controller;
   930|                 }
   931|             }
   932|             if ($urlCase) {
   933|                 $var[$varController] = parse_name($var[$varController]);
   934|             }
   935|             $module = '';
   936|             if (!empty($path)) {
   937|                 $var[$varModule] = implode($depr, $path);
   938|             } else {
   939|                 if (CONTROLLER_PATH) {
   940|                     $var[$varModule] = MODULE_NAME;
   941|                     $varAddon        = C('VAR_ADDON');
   942|                     if (MODULE_NAME != C('DEFAULT_MODULE')) {
   943|                         $var[$varController] = MODULE_NAME;
   944|                     }
   945|                     $vars = array_merge(array($varAddon => CONTROLLER_PATH), $vars);
   946|                 } elseif (C('MULTI_MODULE')) {
   947|                     if (MODULE_NAME != C('DEFAULT_MODULE') || !C('MODULE_ALLOW_LIST')) {
   948|                         $var[$varModule] = MODULE_NAME;
   949|                     }
   950|                 }
   951|             }
   952|             if ($maps = C('URL_MODULE_MAP')) {
   953|                 if ($_module = array_search(strtolower($var[$varModule]), $maps)) {
   954|                     $var[$varModule] = $_module;
   955|                 }
   956|             }
   957|             if (isset($var[$varModule])) {
   958|                 $module = defined('BIND_MODULE') && BIND_MODULE == $var[$varModule] ? '' : $var[$varModule];
   959|                 unset($var[$varModule]);
   960|             }
   961|         }
   962|     }
   963|     if (0 == C('URL_MODEL')) {
   964|         $url = __APP__ . '?' . C('VAR_MODULE') . "={$module}&" . http_build_query(array_reverse($var));
   965|         if ($urlCase) {
   966|             $url = strtolower($url);
   967|         }
   968|         if (!empty($vars)) {
   969|             $vars = http_build_query($vars);
   970|             $url .= '&' . $vars;
   971|         }
   972|     } else {
   973|         if (isset($route)) {
   974|             $url = __APP__ . '/' . rtrim($url, $depr);
   975|         } else {
   976|             $path = implode($depr, array_reverse($var));
   977|             if (C('URL_ROUTER_ON')) {
   978|                 $url = Think\Route::reverse($path, $vars, $depr, $suffix);
   979|                 if (!$url) {
   980|                     $url = $path;
   981|                 }
   982|             } else {
   983|                 $url = $path;
   984|             }
   985|             $url = __APP__ . '/' . ($module ? $module . MODULE_PATHINFO_DEPR : '') . $url;
   986|         }
   987|         if ($urlCase) {
   988|             $url = strtolower($url);
   989|         }
   990|         if (!empty($vars)) {
   991|             foreach ($vars as $var => $val) {
   992|                 if ('' !== trim($val)) {
   993|                     $url .= $depr . $var . $depr . urlencode($val);
   994|                 }
   995|             }
   996|         }
   997|         if ($suffix) {
   998|             $suffix = true === $suffix ? C('URL_HTML_SUFFIX') : $suffix;
   999|             if ($pos = strpos($suffix, '|')) {
  1000|                 $suffix = substr($suffix, 0, $pos);
  1001|             }
  1002|             if ($suffix && '/' != substr($url, -1)) {
  1003|                 $url .= '.' . ltrim($suffix, '.');
  1004|             }
  1005|         }
  1006|     }
  1007|     if (!empty($anchor)) {
  1008|         $url .= '#' . $anchor;
  1009|     }
  1010|     if ($domain) {
  1011|         $url = (is_ssl() ? 'https://' : 'http://') . $domain . $url;
  1012|     }
  1013|     return $url;
  1014| }
  1015| /**
  1016|  * 渲染输出Widget
  1017|  * @param string $name Widget名称
  1018|  * @param array $data 传入的参数
  1019|  * @return void
  1020|  */
  1021| function W($name, $data = array())
  1022| {
  1023|     return R($name, $data, 'Widget');
  1024| }
  1025| /**
  1026|  * 判断是否SSL协议
  1027|  * @return boolean

# --- HUNK 4: Lines 1512-1539 ---
  1512|         413 => 'Request Entity Too Large',
  1513|         414 => 'Request-URI Too Long',
  1514|         415 => 'Unsupported Media Type',
  1515|         416 => 'Requested Range Not Satisfiable',
  1516|         417 => 'Expectation Failed',
  1517|         500 => 'Internal Server Error',
  1518|         501 => 'Not Implemented',
  1519|         502 => 'Bad Gateway',
  1520|         503 => 'Service Unavailable',
  1521|         504 => 'Gateway Timeout',
  1522|         505 => 'HTTP Version Not Supported',
  1523|         509 => 'Bandwidth Limit Exceeded',
  1524|     );
  1525|     if (isset($_status[$code])) {
  1526|         header('HTTP/1.1 ' . $code . ' ' . $_status[$code]);
  1527|         header('Status:' . $code . ' ' . $_status[$code]);
  1528|     }
  1529| }
  1530| function think_filter(&$value)
  1531| {
  1532|     if (preg_match('/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN|BIND)$/i', $value)) {
  1533|         $value .= ' ';
  1534|     }
  1535| }
  1536| function in_array_case($value, $array)
  1537| {
  1538|     return in_array(strtolower($value), array_map('strtolower', $array));
  1539| }


# ====================================================================
# FILE: ThinkPHP/Conf/convention.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 61-101 ---
    61|     'DATA_CACHE_PREFIX'      => '', // 缓存前缀
    62|     'DATA_CACHE_TYPE'        => 'File', // 数据缓存类型,支持:File|Db|Apc|Memcache|Shmop|Sqlite|Xcache|Apachenote|Eaccelerator
    63|     'DATA_CACHE_PATH'        => TEMP_PATH, // 缓存路径设置 (仅对File方式缓存有效)
    64|     'DATA_CACHE_KEY'         => '', // 缓存文件KEY (仅对File方式缓存有效)
    65|     'DATA_CACHE_SUBDIR'      => false, // 使用子目录缓存 (自动根据缓存标识的哈希创建子目录)
    66|     'DATA_PATH_LEVEL'        => 1, // 子目录缓存级别
    67|     /* 错误设置 */
    68|     'ERROR_MESSAGE'          => '页面错误！请稍后再试～', //错误显示信息,非调试模式有效
    69|     'ERROR_PAGE'             => '', // 错误定向页面
    70|     'SHOW_ERROR_MSG'         => false, // 显示错误信息
    71|     'TRACE_MAX_RECORD'       => 100, // 每个级别的错误信息 最大记录数
    72|     /* 日志设置 */
    73|     'LOG_RECORD'             => false, // 默认不记录日志
    74|     'LOG_TYPE'               => 'File', // 日志记录类型 默认为文件方式
    75|     'LOG_LEVEL'              => 'EMERG,ALERT,CRIT,ERR', // 允许记录的日志级别
    76|     'LOG_FILE_SIZE'          => 2097152, // 日志文件大小限制
    77|     'LOG_EXCEPTION_RECORD'   => false, // 是否记录异常信息日志
    78|     /* SESSION设置 */
    79|     'SESSION_AUTO_START'     => true, // 是否自动开启Session
    80|     'SESSION_OPTIONS'        => array(), // session 配置数组 支持type name id path expire domain 等参数
    81|     'SESSION_TYPE'           => '', // session handler类型 默认无需设置 除非扩展了session handler驱动
    82|     'SESSION_PREFIX'         => '', // session 前缀
    83|     /* 模板引擎设置 */
    84|     'TMPL_CONTENT_TYPE'      => 'text/html', // 默认模板输出类型
    85|     'TMPL_ACTION_ERROR'      => THINK_PATH . 'Tpl/dispatch_jump.tpl', // 默认错误跳转对应的模板文件
    86|     'TMPL_ACTION_SUCCESS'    => THINK_PATH . 'Tpl/dispatch_jump.tpl', // 默认成功跳转对应的模板文件
    87|     'TMPL_EXCEPTION_FILE'    => THINK_PATH . 'Tpl/think_exception.tpl', // 异常页面的模板文件
    88|     'TMPL_DETECT_THEME'      => false, // 自动侦测模板主题
    89|     'TMPL_TEMPLATE_SUFFIX'   => '.html', // 默认模板文件后缀
    90|     'TMPL_FILE_DEPR'         => '/', //模板文件CONTROLLER_NAME与ACTION_NAME之间的分割符
    91|     'TMPL_ENGINE_TYPE'       => 'Think', // 默认模板引擎 以下设置仅对使用Think模板引擎有效
    92|     'TMPL_CACHFILE_SUFFIX'   => '.php', // 默认模板缓存后缀
    93|     'TMPL_DENY_FUNC_LIST'    => 'echo,exit', // 模板引擎禁用函数
    94|     'TMPL_DENY_PHP'          => false, // 默认模板引擎是否禁用PHP原生代码
    95|     'TMPL_L_DELIM'           => '{', // 模板引擎普通标签开始标记
    96|     'TMPL_R_DELIM'           => '}', // 模板引擎普通标签结束标记
    97|     'TMPL_VAR_IDENTIFY'      => 'array', // 模板变量识别。留空自动判断,参数为'obj'则表示对象
    98|     'TMPL_STRIP_SPACE'       => true, // 是否去除模板文件里面的html空格与换行
    99|     'TMPL_CACHE_ON'          => true, // 是否开启模板编译缓存,设为false则每次都会重新编译
   100|     'TMPL_CACHE_PREFIX'      => '', // 模板缓存前缀标识，可以动态改变
   101|     'TMPL_CACHE_TIME'        => 0, // 模板缓存有效期 0 为永久，(以数字为值，单位:秒)


# ====================================================================
# FILE: ThinkPHP/Library/Behavior/BuildLiteBehavior.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| namespace Behavior;
     3| use Think\Hook as Hook;
     4| class BuildLiteBehavior
     5| {
     6|     public function run(&$params)
     7|     {
     8|         if (!defined('BUILD_LITE_FILE') || BUILD_LITE_FILE == false) {
     9|             return;
    10|         }
    11|         $litefile = C('RUNTIME_LITE_FILE', null, RUNTIME_PATH . 'lite.php');
    12|         if (is_file($litefile)) {
    13|             return;
    14|         }
    15|         $defs    = get_defined_constants(true);
    16|         $content = 'namespace {$GLOBALS[\'_beginTime\'] = microtime(TRUE);';
    17|         if (MEMORY_LIMIT_ON) {
    18|             $content .= '$GLOBALS[\'_startUseMems\'] = memory_get_usage();';
    19|         }
    20|         unset($defs['user']['BUILD_LITE_FILE']);
    21|         $content .= $this->buildArrayDefine($defs['user']) . '}';
    22|         $filelist = is_file(CONF_PATH . 'lite.php') ?
    23|         include CONF_PATH . 'lite.php' :
    24|         array(
    25|             THINK_PATH . 'Common/functions.php',
    26|             COMMON_PATH . 'Common/function.php',
    27|             CORE_PATH . 'Think' . EXT,
    28|             CORE_PATH . 'Hook' . EXT,


# ====================================================================
# FILE: ThinkPHP/Library/Org/Net/Http.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 127-197 ---
   127|      * @param string $showname 下载显示的文件名
   128|      * @param string $content  下载的内容
   129|      * @param integer $expire  下载内容浏览器缓存时间
   130|      * @return void
   131|      */
   132|     public static function download($filename, $showname = '', $content = '', $expire = 180)
   133|     {
   134|         if (is_file($filename)) {
   135|             $length = filesize($filename);
   136|         } elseif (is_file(UPLOAD_PATH . $filename)) {
   137|             $filename = UPLOAD_PATH . $filename;
   138|             $length   = filesize($filename);
   139|         } elseif ('' != $content) {
   140|             $length = strlen($content);
   141|         } else {
   142|             E($filename . L('下载文件不存在！'));
   143|         }
   144|         if (empty($showname)) {
   145|             $showname = $filename;
   146|         }
   147|         $showname = self::get_basename($showname);;
   148|         if (!empty($filename)) {
   149|             $finfo = new \finfo(FILEINFO_MIME);
   150|             $type  = $finfo->file($filename);
   151|         } else {
   152|             $type = "application/octet-stream";
   153|         }
   154|         header("Pragma: public");
   155|         header("Cache-control: max-age=" . $expire);
   156|         header("Expires: " . gmdate("D, d M Y H:i:s", time() + $expire) . "GMT");
   157|         header("Last-Modified: " . gmdate("D, d M Y H:i:s", time()) . "GMT");
   158|         header("Content-Disposition: attachment; filename=" . $showname);
   159|         header("Content-Length: " . $length);
   160|         header("Content-type: " . $type);
   161|         header('Content-Encoding: none');
   162|         header("Content-Transfer-Encoding: binary");
   163|         ob_clean(); // 清空缓冲区
   164|         flush();  // 刷新输出缓冲
   165|         if ('' == $content) {
   166|             readfile($filename);
   167|         } else {
   168|             echo ($content);
   169|         }
   170|         exit();
   171|     }
   172|     /**
   173|      * 获取文件的名称，兼容中文名
   174|      * @return string
   175|      */
   176|     static public function get_basename($filename){
   177|         return preg_replace('/^.+[\\\\\\/]/', '', $filename);
   178|     }
   179|     /**
   180|      * 显示HTTP Header 信息
   181|      * @return string
   182|      */
   183|     public static function getHeaderInfo($header = '', $echo = true)
   184|     {
   185|         ob_start();
   186|         $headers = getallheaders();
   187|         if (!empty($header)) {
   188|             $info = $headers[$header];
   189|             echo ($header . ':' . $info . "\n");
   190|         } else {
   191|             foreach ($headers as $key => $val) {
   192|                 echo ("$key:$val\n");
   193|             }
   194|         }
   195|         $output = ob_get_clean();
   196|         if ($echo) {
   197|             echo (nl2br($output));


# ====================================================================
# FILE: ThinkPHP/Library/Org/Net/IpLocation.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-66 ---
    23|      * 最后一条IP记录的偏移地址
    24|      *
    25|      * @var int
    26|      */
    27|     private $lastip;
    28|     /**
    29|      * IP记录的总条数（不包含版本信息记录）
    30|      *
    31|      * @var int
    32|      */
    33|     private $totalip;
    34|     /**
    35|      * 构造函数，打开 QQWry.Dat 文件并初始化类中的信息
    36|      *
    37|      * @param string $filename
    38|      * @return IpLocation
    39|      */
    40|     public function __construct($filename = "UTFWry.dat")
    41|     {
    42|         $this->fp = 0;
    43|         if(!is_file($filename)) {
    44|             $filename = dirname(__FILE__) . '/' . $filename;
    45|         }
    46|         if (($this->fp = fopen($filename, 'rb')) !== false) {
    47|             $this->firstip = $this->getlong();
    48|             $this->lastip  = $this->getlong();
    49|             $this->totalip = ($this->lastip - $this->firstip) / 7;
    50|         }
    51|     }
    52|     /**
    53|      * 返回读取的长整型数
    54|      *
    55|      * @access private
    56|      * @return int
    57|      */
    58|     private function getlong()
    59|     {
    60|         $result = unpack('Vlong', fread($this->fp, 4));
    61|         return $result['long'];
    62|     }
    63|     /**
    64|      * 返回读取的3个字节的长整型数
    65|      *
    66|      * @access private


# ====================================================================
# FILE: ThinkPHP/Library/Think/App.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| <?php
     2| namespace Think;
     3| /**
     4|  * ThinkPHP 应用程序类 执行应用过程管理
     5|  */
     6| class App
     7| {
     8|     /**
     9|      * 应用程序初始化
    10|      * @access public
    11|      * @return void
    12|      */
    13|     public static function init()
    14|     {
    15|         C('LOG_PATH', realpath(LOG_PATH) . '/Common/');
    16|         define('NOW_TIME', $_SERVER['REQUEST_TIME']);
    17|         define('REQUEST_METHOD', $_SERVER['REQUEST_METHOD']);
    18|         define('IS_GET', REQUEST_METHOD == 'GET' ? true : false);
    19|         define('IS_POST', REQUEST_METHOD == 'POST' ? true : false);
    20|         define('IS_PUT', REQUEST_METHOD == 'PUT' ? true : false);
    21|         define('IS_DELETE', REQUEST_METHOD == 'DELETE' ? true : false);
    22|         Dispatcher::dispatch();
    23|         if (C('REQUEST_VARS_FILTER')) {
    24|             array_walk_recursive($_GET, 'think_filter');
    25|             array_walk_recursive($_POST, 'think_filter');
    26|             array_walk_recursive($_REQUEST, 'think_filter');
    27|         }
    28|         Hook::listen('url_dispatch');
    29|         define('IS_AJAX', ((isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') || !empty($_POST[C('VAR_AJAX_SUBMIT')]) || !empty($_GET[C('VAR_AJAX_SUBMIT')])) ? true : false);
    30|         C('TMPL_EXCEPTION_FILE', realpath(C('TMPL_EXCEPTION_FILE')));
    31|         return;
    32|     }
    33|     /**
    34|      * 执行应用程序

# --- HUNK 2: Lines 102-169 ---
   102|                     case 'PUT':
   103|                         parse_str(file_get_contents('php://input'), $vars);
   104|                         break;
   105|                     default:
   106|                         $vars = $_GET;
   107|                 }
   108|                 $params         = $method->getParameters();
   109|                 $paramsBindType = C('URL_PARAMS_BIND_TYPE');
   110|                 foreach ($params as $param) {
   111|                     $name = $param->getName();
   112|                     if (1 == $paramsBindType && !empty($vars)) {
   113|                         $args[] = array_shift($vars);
   114|                     } elseif (0 == $paramsBindType && isset($vars[$name])) {
   115|                         $args[] = $vars[$name];
   116|                     } elseif ($param->isDefaultValueAvailable()) {
   117|                         $args[] = $param->getDefaultValue();
   118|                     } else {
   119|                         E(L('_PARAM_ERROR_') . ':' . $name);
   120|                     }
   121|                 }
   122|                 if (C('URL_PARAMS_FILTER')) {
   123|                     $filters = C('URL_PARAMS_FILTER_TYPE') ?: C('DEFAULT_FILTER');
   124|                     if ($filters) {
   125|                         $filters = explode(',', $filters);
   126|                         foreach ($filters as $filter) {
   127|                             $args = array_map_recursive($filter, $args); // 参数过滤
   128|                         }
   129|                     }
   130|                 }
   131|                 array_walk_recursive($args, 'think_filter');
   132|                 $method->invokeArgs($module, $args);
   133|             } else {
   134|                 $method->invoke($module);
   135|             }
   136|             if ($class->hasMethod('_after_' . $action)) {
   137|                 $after = $class->getMethod('_after_' . $action);
   138|                 if ($after->isPublic()) {
   139|                     $after->invoke($module);
   140|                 }
   141|             }
   142|         } else {
   143|             throw new \ReflectionException();
   144|         }
   145|     }
   146|     /**
   147|      * 运行应用实例 入口文件使用的快捷方法
   148|      * @access public
   149|      * @return void
   150|      */
   151|     public static function run()
   152|     {
   153|         load_ext_file(COMMON_PATH);
   154|         Hook::listen('app_init');
   155|         App::init();
   156|         Hook::listen('app_begin');
   157|         if (!IS_CLI) {
   158|             session(C('SESSION_OPTIONS'));
   159|         }
   160|         G('initTime');
   161|         App::exec();
   162|         Hook::listen('app_end');
   163|         return;
   164|     }
   165|     public static function logo()
   166|     {
   167|         return 'iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjVERDVENkZGQjkyNDExRTE5REY3RDQ5RTQ2RTRDQUJCIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjVERDVENzAwQjkyNDExRTE5REY3RDQ5RTQ2RTRDQUJCIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NURENUQ2RkRCOTI0MTFFMTlERjdENDlFNDZFNENBQkIiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NURENUQ2RkVCOTI0MTFFMTlERjdENDlFNDZFNENBQkIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5fx6IRAAAMCElEQVR42sxae3BU1Rk/9+69+8xuNtkHJAFCSIAkhMgjCCJQUi0GtEIVbP8Qq9LH2No6TmfaztjO2OnUdvqHFMfOVFTqIK0vUEEeqUBARCsEeYQkEPJoEvIiELLvvc9z+p27u2F3s5tsBB1OZiebu5dzf7/v/L7f952zMM8cWIwY+Mk2ulCp92Fnq3XvnzArr2NZnYNldDp0Gw+/OEQ4+obQn5D+4Ubb22+YOGsWi/Todh8AHglKEGkEsnHBQ162511GZFgW6ZCBM9/W4H3iNSQqIe09O196dLKX7d1O39OViP/wthtkND62if/wj/DbMpph8BY/m9xy8BoBmQk+mHqZQGNy4JYRwCoRbwa8l4JXw6M+orJxpU0U6ToKy/5bQsAiTeokGKkTx46RRxxEUgrwGgF4MWNNEJCGgYTvpgnY1IJWg5RzfqLgvcIgktX0i8dmMlFA8qCQ5L0Z/WObPLUxT1i4lWSYDISoEfBYGvM+LlMQQdkLHoWRRZ8zYQI62Thswe5WTORGwNXDcGjqeOA9AF7B8rhzsxMBEoJ8oJKaqPu4hblHMCMPwl9XeNWyb8xkB/DDGYKfMAE6aFL7xesZ389JlgG3XHEMI6UPDOP6JHHu67T2pwNPI69mCP4rEaBDUAJaKc/AOuXiwH07VCS3w5+UQMAuF/WqGI+yFIwVNBwemBD4r0wgQiKoFZa00sEYTwss32lA1tPwVxtc8jQ5/gWCwmGCyUD8vRT0sHBFW4GJDvZmrJFWRY1EkrGA6ZB8/10fOZSSj0E6F+BSP7xidiIzhBmKB09lEwHPkG+UQIyEN44EBiT5vrv2uJXyPQqSqO930fxvcvwbR/+JAkD9EfASgI9EHlp6YiHO4W+cAB20SnrFqxBbNljiXf1Pl1K2S0HCWfiog3YlAD5RGwwxK6oUjTweuVigLjyB0mX410mAFnMoVK1lvvUvgt8fUJH0JVyjuvcmg4dE5mUiFtD24AZ4qBVELxXKS+pMxN43kSdzNwudJ+bQbLlmnxvPOQoCugSap1GnSRoG8KOiKbH+rIA0lEeSAg3y6eeQ6XI2nrYnrPM89bUTgI0Pdqvl50vlNbtZxDUBcLBK0kPd5jPziyLdojJIN0pq5/mdzwL4UVvVInV5ncQEPNOUxa9d0TU+CW5l+FoI0GSDKHVVSOs+0KOsZoxwOzSZNFGv0mQ9avyLCh2Hpm+70Y0YJoJVgmQv822wnDC8Miq6VjJ5IFed0QD1YiAbT+nQE8v/RMZfmgmcCRHIIu7Bmcp39oM9fqEychcA747KxQ/AEyqQonl7hATtJmnhO2XYtgcia01aSbVMenAXrIomPcLgEBA4liGBzFZAT8zBYqW6brI67wg8sFVhxBhwLwBP2+tqBQqqK7VJKGh/BRrfTr6nWL7nYBaZdBJHqrX3kPEPap56xwE/GvjJTRMADeMCdcGpGXL1Xh4ZL8BDOlWkUpegfi0CeDzeA5YITzEnddv+IXL+UYCmqIvqC9UlUC/ki9FipwVjunL3yX7dOTLeXmVMAhbsGporPfyOBTm/BJ23gTVehsvXRnSewagUfpBXF3p5pygKS7OceqTjb7h2vjr/XKm0ZofKSI2Q/J102wHzatZkJPYQ5JoKsuK+EoHJakVzubzuLQDepCKllTZi9AG0DYg9ZLxhFaZsOu7bvlmVI5oPXJMQJcHxHClSln1apFTvAimeg48u0RWFeZW4lVcjbQWZuIQK1KozZfIDO6CSQmQQXdpBaiKZyEWThVK1uEc6v7V7uK0ysduExPZx4vysDR+4SelhBYm0R6LBuR4PXts8MYMcJPsINo4YZCDLj0sgB0/vLpPXvA2Tn42Cv5rsLulGubzW0sEd3d4W/mJt2Kck+DzDMijfPLOjyrDhXSh852B+OvflqAkoyXO1cYfujtc/i3jJSAwhgfFlp20laMLOku/bC7prgqW7lCn4auE5NhcXPd3M7x70+IceSgZvNljCd9k3fLjYsPElqLR14PXQZqD2ZNkkrAB79UeJUebFQmXpf8ZcAQt2XrMQdyNUVBqZoUzAFyp3V3xi/MubUA/mCT4Fhf038PC8XplhWnCmnK/ZzyC2BSTRSqKVOuY2kB8Jia0lvvRIVoP+vVWJbYarf6p655E2/nANBMCWkgD49DA0VAMyI1OLFMYCXiU9bmzi9/y5i/vsaTpHPHidTofzLbM65vMPva9HlovgXp0AvjtaqYMfDD0/4mAsYE92pxa+9k1QgCnRVObCpojpzsKTPvayPetTEgBdwnssjuc0kOBFX+q3HwRQxdrOLAqeYRjkMk/trTSu2Z9Lik7CfF0AvjtqAhS4NHobGXUnB5DQs8hG8p/wMX1r4+8xkmyvQ50JVq72TVeXbz3HvpWaQJi57hJYTw4kGbtS+C2TigQUtZUX+X27QQq2ePBZBru/0lxTm8fOOQ5yaZOZMAV+he4FqIMB+LQB0UgMSajANX29j+vbmly8ipRvHeSQoQOkM5iFXcPQCVwDMs5RBCQmaPOyvbNd6uwvQJ183BZQG3Zc+Eiv7vQOKu8YeDmMcJlt2ckyftVeMIGLBCmdMHl/tFILYwGPjXWO3zOfSq/+om+oa7Mlh2fpSsRGLp7RAW3FUVjNHgiMhyE6zBFjM2BdkdJGO7nP1kJXWAtBuBpPIAu7f+hhu7bFXIuC5xWrf0X2xreykOsUyKkF2gwadbrXDcXrfKxR43zGcSj4t/cCgr+a1iy6EjE5GYktUCl9fwfMeylyooGF48bN2IGLTw8x7StS7sj8TF9FmPGWQhm3rRR+o9lhvjJvSYAdfDUevI1M6bnX/OwWaDMOQ8RPgKRo0eulBTdT8AW2kl8e9L7UHghHwMfLiZPNoSpx0yugpQZaFqKWqxVSM3a2pN1SAhC2jf94I7ybBI7EL5A2Wvu5ht3xsoEt4+Ay/abXgCQAxyOeDsDlTCQzy75ohcGgv9Tra9uiymRUYTLrswOLlCdfAQf7HPDQQ4ErAH5EDXB9cMxWYpjtXApRncojS0sbV/cCgHTHwGNBJy+1PQE2x56FpaVR7wfQGZ37V+V+19EiHNvR6q1fRUjqvbjbMq1/qfHxbTrE10ePY2gPFk48D2CVMTf1AF4PXvyYR9dV6Wf7H413m3xTWQvYGhQ7mfYwA5mAX+18Vue05v/8jG/fZX/IW5MKPKtjSYlt0ellxh+/BOCPAwYaeVr0QofZFxJWVWC8znG70au6llVmktsF0bfHF6k8fvZ5esZJbwHwwnjg59tXz6sL/P0NUZDuSNu1mnJ8Vab17+cy005A9wtOpp3i0bZdpJLUil00semAwN45LgEViZYe3amNye0B6A9chviSlzXVsFtyN5/1H3gaNmMpn8Fz0GpYFp6Zw615H/LpUuRQQDMCL82n5DpBSawkvzIdN2ypiT8nSLth8Pk9jnjwdFzH3W4XW6KMBfwB569NdcGX93mC16tTflcArcYUc/mFuYbV+8zY0SAjAVoNErNgWjtwumJ3wbn/HlBFYdxHvSkJJEc+Ngal9opSwyo9YlITX2C/P/+gf8sxURSLR+mcZUmeqaS9wrh6vxW5zxFCOqFi90RbDWq/YwZmnu1+a6OvdpvRqkNxxe44lyl4OobEnpKA6Uox5EfH9xzPs/HRKrTPWdIQrK1VZDU7ETiD3Obpl+8wPPCRBbkbwNtpW9AbBe5L1SMlj3tdTxk/9W47JUmqS5HU+JzYymUKXjtWVmT9RenIhgXc+nroWLyxXJhmL112OdB8GCsk4f8oZJucnvmmtR85mBn10GZ0EKSCMUSAR3ukcXd5s7LvLD3me61WkuTCpJzYAyRurMB44EdEJzTfU271lUJC03YjXJXzYOGZwN4D8eB5jlfLrdWfzGRW7icMPfiSO6Oe7s20bmhdgLX4Z23B+s3JgQESzUDiMboSzDMHFpNMwccGePauhfwjzwnI2wu9zKGgEFg80jcZ7MHllk07s1H+5yojtUQTlH4nFdLKTGwDmPbIklOb1L1zO4T6N8NCuDLFLS/C63c0eNRimZ++s5BMBHxU11jHchI9oFVUxRh/eMDzHEzGYu0Lg8gJ7oS/tFCwoic44fyUtix0n/46vP4bf+//BRgAYwDDar4ncHIAAAAASUVORK5CYII=';
   168|     }
   169| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Cache/Driver/Memcached.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-78 ---
    37|     public function get($name)
    38|     {
    39|         N('cache_read', 1);
    40|         return $this->handler->get($this->options['prefix'] . $name);
    41|     }
    42|     /**
    43|      * 写入缓存
    44|      * @access public
    45|      * @param string $name 缓存变量名
    46|      * @param mixed $value  存储数据
    47|      * @param integer $expire  有效时间（秒）
    48|      * @return boolean
    49|      */
    50|     public function set($name, $value, $expire = null)
    51|     {
    52|         N('cache_write', 1);
    53|         if (is_null($expire)) {
    54|             $expire = $this->options['expire'];
    55|         }
    56|         $name = $this->options['prefix'] . $name;
    57|         $expire = $expire == 0 ? 0 : time() + $expire;
    58|         if ($this->handler->set($name, $value, $expire)) {
    59|             if ($this->options['length'] > 0) {
    60|                 $this->queue($name);
    61|             }
    62|             return true;
    63|         }
    64|         return false;
    65|     }
    66|     /**
    67|      * 删除缓存
    68|      * @access public
    69|      * @param string $name 缓存变量名
    70|      * @return boolean
    71|      */
    72|     public function rm($name, $ttl = false)
    73|     {
    74|         $name = $this->options['prefix'] . $name;
    75|         return false === $ttl ?
    76|         $this->handler->delete($name) :
    77|         $this->handler->delete($name, $ttl);
    78|     }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Cache/Driver/Redis.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-58 ---
     3| use Think\Cache;
     4| /**
     5|  * Redis缓存驱动
     6|  * 要求安装phpredis扩展：https://github.com/nicolasff/phpredis
     7|  */
     8| class Redis extends Cache
     9| {
    10|     /**
    11|      * 架构函数
    12|      * @param array $options 缓存参数
    13|      * @access public
    14|      */
    15|     public function __construct($options = array())
    16|     {
    17|         if (!extension_loaded('redis')) {
    18|             E(L('_NOT_SUPPORT_') . ':redis');
    19|         }
    20|         $options = array_merge(array(
    21|             'host'       => C('REDIS_HOST') ?: '127.0.0.1',
    22|             'port'       => C('REDIS_PORT') ?: 6379,
    23|             'password'   => C('REDIS_PASSWORD') ?: '',
    24|             'timeout'    => C('DATA_CACHE_TIMEOUT') ?: false,
    25|             'persistent' => false,
    26|         ), $options);
    27|         $this->options           = $options;
    28|         $this->options['expire'] = isset($options['expire']) ? $options['expire'] : C('DATA_CACHE_TIME');
    29|         $this->options['prefix'] = isset($options['prefix']) ? $options['prefix'] : C('DATA_CACHE_PREFIX');
    30|         $this->options['length'] = isset($options['length']) ? $options['length'] : 0;
    31|         $func                    = $options['persistent'] ? 'pconnect' : 'connect';
    32|         $this->handler           = new \Redis;
    33|         false === $options['timeout'] ?
    34|         $this->handler->$func($options['host'], $options['port']) :
    35|         $this->handler->$func($options['host'], $options['port'], $options['timeout']);
    36|         if ('' != $options['password']) {
    37|             $this->handler->auth($options['password']);
    38|         }
    39|     }
    40|     /**
    41|      * 读取缓存
    42|      * @access public
    43|      * @param string $name 缓存变量名
    44|      * @return mixed
    45|      */
    46|     public function get($name)
    47|     {
    48|         N('cache_read', 1);
    49|         $value    = $this->handler->get($this->options['prefix'] . $name);
    50|         $jsonData = json_decode($value, true);
    51|         return (null === $jsonData) ? $value : $jsonData; //检测是否为JSON数据 true 返回JSON解析数组, false返回源数据
    52|     }
    53|     /**
    54|      * 写入缓存
    55|      * @access public
    56|      * @param string $name 缓存变量名
    57|      * @param mixed $value  存储数据
    58|      * @param integer $expire  有效时间（秒）


# ====================================================================
# FILE: ThinkPHP/Library/Think/Controller/RestController.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 56-117 ---
    56|                 App::invokeAction($this, $fun);
    57|             } elseif ($this->_type == $this->defaultType && method_exists($this, $method . '_' . $this->_method)) {
    58|                 $fun = $method . '_' . $this->_method;
    59|                 App::invokeAction($this, $fun);
    60|             } elseif (method_exists($this, '_empty')) {
    61|                 $this->_empty($method, $args);
    62|             } elseif (file_exists_case($this->view->parseTemplate())) {
    63|                 $this->display();
    64|             } else {
    65|                 E(L('_ERROR_ACTION_') . ':' . ACTION_NAME);
    66|             }
    67|         }
    68|     }
    69|     /**
    70|      * 获取当前请求的Accept头信息
    71|      * @return string
    72|      */
    73|     protected function getAcceptType()
    74|     {
    75|         $type = array(
    76|             'html' => 'text/html,application/xhtml+xml,*/*',
    77|             'xml'  => 'application/xml,text/xml,application/x-xml',
    78|             'json' => 'application/json,text/x-json,application/jsonrequest,text/json',
    79|             'js'   => 'text/javascript,application/javascript,application/x-javascript',
    80|             'css'  => 'text/css',
    81|             'rss'  => 'application/rss+xml',
    82|             'yaml' => 'application/x-yaml,text/yaml',
    83|             'atom' => 'application/atom+xml',
    84|             'pdf'  => 'application/pdf',
    85|             'text' => 'text/plain',
    86|             'png'  => 'image/png',
    87|             'jpg'  => 'image/jpg,image/jpeg,image/pjpeg',
    88|             'gif'  => 'image/gif',
    89|             'csv'  => 'text/csv',
    90|         );
    91|         foreach ($type as $key => $val) {
    92|             $array = explode(',', $val);
    93|             foreach ($array as $k => $v) {
    94|             	if(array_key_exists('HTTP_ACCEPT',$_SERVER))
    95| 	                if (stristr($_SERVER['HTTP_ACCEPT'], $v)) {
    96| 	                    return $key;
    97| 	                }
    98|             }
    99|         }
   100|         return false;
   101|     }
   102|     protected function sendHttpStatus($code)
   103|     {
   104|         static $_status = array(
   105|             100 => 'Continue',
   106|             101 => 'Switching Protocols',
   107|             200 => 'OK',
   108|             201 => 'Created',
   109|             202 => 'Accepted',
   110|             203 => 'Non-Authoritative Information',
   111|             204 => 'No Content',
   112|             205 => 'Reset Content',
   113|             206 => 'Partial Content',
   114|             300 => 'Multiple Choices',
   115|             301 => 'Moved Permanently',
   116|             302 => 'Moved Temporarily ', // 1.1
   117|             303 => 'See Other',

# --- HUNK 2: Lines 144-229 ---
   144|             505 => 'HTTP Version Not Supported',
   145|             509 => 'Bandwidth Limit Exceeded',
   146|         );
   147|         if (isset($_status[$code])) {
   148|             header('HTTP/1.1 ' . $code . ' ' . $_status[$code]);
   149|             header('Status:' . $code . ' ' . $_status[$code]);
   150|         }
   151|     }
   152|     /**
   153|      * 编码数据
   154|      * @access protected
   155|      * @param mixed $data 要返回的数据
   156|      * @param String $type 返回类型 JSON XML
   157|      * @return string
   158|      */
   159|     protected function encodeData($data, $type = '')
   160|     {
   161|         if (empty($data)) {
   162|             return '';
   163|         }
   164|         if('json' == $type) {
   165|             if(version_compare(PHP_VERSION,'5.4.0','<')) {
   166|                 $this->arrayRecursive($data, 'urlencode', true);
   167|                 $data = urldecode(json_encode($data));
   168|             } else {
   169|                 $data = json_encode($data,JSON_UNESCAPED_UNICODE);
   170|             }
   171|         } elseif ('xml' == $type) {
   172|             $data = xml_encode($data);
   173|         } elseif ('php' == $type) {
   174|             $data = serialize($data);
   175|         } // 默认直接输出
   176|         $this->setContentType($type);
   177|         return $data;
   178|     }
   179|     /**************************************************************
   180|      *
   181|      *    使用特定function对数组中所有元素做处理
   182|      *    @param  string|array  &$array     要处理的字符串或者数组
   183|      *    @param  string  $function   要执行的函数
   184|      *    @return boolean $apply_to_keys_also     是否也应用到key上
   185|      *    @access protected
   186|      *
   187|      *************************************************************/
   188|     protected function arrayRecursive(&$array, $function, $apply_to_keys_also = false)
   189|     {
   190|         static $recursive_counter = 0;
   191|         if (++$recursive_counter > 1000) {
   192|             die('possible deep recursion attack');
   193|         }
   194|         foreach ($array as $key => $value) {
   195|             if (is_array($value)) {
   196|                 $this->arrayRecursive($array[$key], $function, $apply_to_keys_also);
   197|             } elseif(is_string($value)) {
   198|                 $array[$key] = $function($value);
   199|             }
   200|             if ($apply_to_keys_also && is_string($key)) {
   201|                 $new_key = $function($key);
   202|                 if ($new_key != $key) {
   203|                     $array[$new_key] = $array[$key];
   204|                     unset($array[$key]);
   205|                 }
   206|             }
   207|         }
   208|         $recursive_counter--;
   209|     }
   210|     /**
   211|      * 设置页面输出的CONTENT_TYPE和编码
   212|      * @access public
   213|      * @param string $type content_type 类型对应的扩展名
   214|      * @param string $charset 页面输出编码
   215|      * @return void
   216|      */
   217|     public function setContentType($type, $charset = '')
   218|     {
   219|         if (headers_sent()) {
   220|             return;
   221|         }
   222|         if (empty($charset)) {
   223|             $charset = C('DEFAULT_CHARSET');
   224|         }
   225|         $type = strtolower($type);
   226|         if (isset($this->allowOutputType[$type])) //过滤content_type
   227|         {
   228|             header('Content-Type: ' . $this->allowOutputType[$type] . '; charset=' . $charset);
   229|         }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 88-122 ---
    88|      * DSN解析
    89|      * 格式： mysql://username:passwd@localhost:3306/DbName?param1=val1&param2=val2#utf8
    90|      * @static
    91|      * @access private
    92|      * @param string $dsnStr
    93|      * @return array
    94|      */
    95|     private static function parseDsn($dsnStr)
    96|     {
    97|         if (empty($dsnStr)) {return false;}
    98|         $info = parse_url($dsnStr);
    99|         if (!$info) {
   100|             return false;
   101|         }
   102|         $dsn = array(
   103|             'type'     => $info['scheme'],
   104|             'username' => isset($info['user']) ? $info['user'] : '',
   105|             'password' => isset($info['pass']) ? $info['pass'] : '',
   106|             'hostname' => isset($info['host']) ? $info['host'] : '',
   107|             'hostport' => isset($info['port']) ? $info['port'] : '',
   108|             'database' => isset($info['path']) ? ltrim($info['path'], '/') : '',
   109|             'charset'  => isset($info['fragment']) ? $info['fragment'] : 'utf8',
   110|         );
   111|         if (isset($info['query'])) {
   112|             parse_str($info['query'], $dsn['params']);
   113|         } else {
   114|             $dsn['params'] = array();
   115|         }
   116|         return $dsn;
   117|     }
   118|     public static function __callStatic($method, $params)
   119|     {
   120|         return call_user_func_array(array(self::$_instance, $method), $params);
   121|     }
   122| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver.class.php
# Total hunks: 12
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| <?php
     2| namespace Think\Db;
     3| use PDO;
     4| use Think\Config;
     5| use Think\Debug;
     6| abstract class Driver
     7| {
     8|     protected $PDOStatement = null;
     9|     protected $model = '_think_';
    10|     protected $queryStr = '';
    11|     protected $modelSql = array();
    12|     protected $lastInsID = null;
    13|     protected $numRows = 0;
    14|     protected $transPDO = null;
    15|     protected $transTimes = 0;
    16|     protected $error = '';
    17|     protected $linkID = array();
    18|     protected $_linkID = null;
    19|     protected $config = array(
    20|         'type'           => '', // 数据库类型
    21|         'hostname'       => '127.0.0.1', // 服务器地址
    22|         'database'       => '', // 数据库名
    23|         'username'       => '', // 用户名
    24|         'password'       => '', // 密码
    25|         'hostport'       => '', // 端口
    26|         'dsn'            => '', //
    27|         'params'         => array(), // 数据库连接参数
    28|         'charset'        => 'utf8', // 数据库编码默认采用utf8
    29|         'prefix'         => '', // 数据库表前缀
    30|         'debug'          => false, // 数据库调试模式
    31|         'deploy'         => 0, // 数据库部署方式:0 集中式(单一服务器),1 分布式(主从服务器)
    32|         'rw_separate'    => false, // 数据库读写是否分离 主从式有效
    33|         'master_num'     => 1, // 读写分离后 主服务器数量
    34|         'slave_no'       => '', // 指定从服务器序号

# --- HUNK 2: Lines 92-137 ---
    92|      * 解析pdo连接的dsn信息
    93|      * @access public
    94|      * @param array $config 连接信息
    95|      * @return string
    96|      */
    97|     protected function parseDsn($config)
    98|     {}
    99|     /**
   100|      * 释放查询结果
   101|      * @access public
   102|      */
   103|     public function free()
   104|     {
   105|         $this->PDOStatement = null;
   106|     }
   107|     /**
   108|      * 执行查询 返回数据集
   109|      * @access public
   110|      * @param string $str  sql指令
   111|      * @param boolean $fetchSql  不执行只是获取SQL
   112|      * @param boolean $master  是否在主服务器读操作
   113|      * @return mixed
   114|      */
   115|     public function query($str, $fetchSql = false, $master = false)
   116|     {
   117|         $this->initConnect($master);
   118|         if (!$this->_linkID) {
   119|             return false;
   120|         }
   121|         $this->queryStr = $str;
   122|         if (!empty($this->bind)) {
   123|             $that           = $this;
   124|             $this->queryStr = strtr($this->queryStr, array_map(function ($val) use ($that) {return '\'' . $that->escapeString($val) . '\'';}, $this->bind));
   125|         }
   126|         if ($fetchSql) {
   127|             return $this->queryStr;
   128|         }
   129|         if (!empty($this->PDOStatement)) {
   130|             $this->free();
   131|         }
   132|         $this->queryTimes++;
   133|         N('db_query', 1); // 兼容代码
   134|         $this->debug(true);
   135|         $this->PDOStatement = $this->_linkID->prepare($str);
   136|         if (false === $this->PDOStatement) {
   137|             $this->error();

# --- HUNK 3: Lines 212-288 ---
   212|                 }
   213|                 return $this->numRows;
   214|             }
   215|         } catch (\PDOException $e) {
   216|             $this->error();
   217|             return false;
   218|         }
   219|     }
   220|     /**
   221|      * 启动事务
   222|      * @access public
   223|      * @return void
   224|      */
   225|     public function startTrans()
   226|     {
   227|         $this->initConnect(true);
   228|         if (!$this->_linkID) {
   229|             return false;
   230|         }
   231|         if (0 == $this->transTimes) {
   232|             $this->transPdo = $this->_linkID;
   233|             $this->_linkID->beginTransaction();
   234|         }
   235|         $this->transTimes++;
   236|         return;
   237|     }
   238|     /**
   239|      * 用于非自动提交状态下面的查询提交
   240|      * @access public
   241|      * @return boolean
   242|      */
   243|     public function commit()
   244|     {
   245|         if (1 == $this->transTimes) {
   246|             $result           = $this->_linkID->commit();
   247|             $this->transTimes = 0;
   248|             $this->transPdo   = null;
   249|             if (!$result) {
   250|                 $this->error();
   251|                 return false;
   252|             }
   253|         } else {
   254|             $this->transTimes = $this->transTimes <= 0 ? 0 : $this->transTimes - 1;
   255|         }
   256|         return true;
   257|     }
   258|     /**
   259|      * 事务回滚
   260|      * @access public
   261|      * @return boolean
   262|      */
   263|     public function rollback()
   264|     {
   265|         if ($this->transTimes > 0) {
   266|             $result           = $this->_linkID->rollback();
   267|             $this->transTimes = 0;
   268|             $this->transPdo   = null;
   269|             if (!$result) {
   270|                 $this->error();
   271|                 return false;
   272|             }
   273|         }
   274|         return true;
   275|     }
   276|     /**
   277|      * 获得所有的查询数据
   278|      * @access private
   279|      * @return array
   280|      */
   281|     private function getResult()
   282|     {
   283|         $result        = $this->PDOStatement->fetchAll(PDO::FETCH_ASSOC);
   284|         $this->numRows = count($result);
   285|         return $result;
   286|     }
   287|     /**
   288|      * 获得查询次数

# --- HUNK 4: Lines 336-410 ---
   336|         }
   337|     }
   338|     /**
   339|      * 设置锁机制
   340|      * @access protected
   341|      * @return string
   342|      */
   343|     protected function parseLock($lock = false)
   344|     {
   345|         return $lock ? ' FOR UPDATE ' : '';
   346|     }
   347|     /**
   348|      * set分析
   349|      * @access protected
   350|      * @param array $data
   351|      * @return string
   352|      */
   353|     protected function parseSet($data)
   354|     {
   355|         foreach ($data as $key => $val) {
   356|             if (isset($val[0]) && 'exp' == $val[0]) {
   357|                 $set[] = $this->parseKey($key) . '=' . $val[1];
   358|             } elseif (is_null($val)) {
   359|                 $set[] = $this->parseKey($key) . '=NULL';
   360|             } elseif (is_scalar($val)) {
   361|                 if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
   362|                     $set[] = $this->parseKey($key) . '=' . $val;
   363|                 } else {
   364|                     $name  = count($this->bind);
   365|                     $set[] = $this->parseKey($key) . '=:' . $key . '_' . $name;
   366|                     $this->bindParam($key . '_' . $name, $val);
   367|                 }
   368|             }
   369|         }
   370|         return ' SET ' . implode(',', $set);
   371|     }
   372|     /**
   373|      * 参数绑定
   374|      * @access protected
   375|      * @param string $name 绑定参数名
   376|      * @param mixed $value 绑定值
   377|      * @return void
   378|      */
   379|     protected function bindParam($name, $value)
   380|     {
   381|         $this->bind[':' . $name] = $value;
   382|     }
   383|     /**
   384|      * 字段和表名处理
   385|      * @access protected
   386|      * @param string $key
   387|      * @param bool   $strict
   388|      * @return string
   389|      */
   390|     protected function parseKey($key, $strict = false)
   391|     {
   392|         return $key;
   393|     }
   394|     /**
   395|      * value分析
   396|      * @access protected
   397|      * @param mixed $value
   398|      * @return string
   399|      */
   400|     protected function parseValue($value)
   401|     {
   402|         if (is_string($value)) {
   403|             $value = strpos($value, ':') === 0 && in_array($value, array_keys($this->bind)) ? $this->escapeString($value) : '\'' . $this->escapeString($value) . '\'';
   404|         } elseif (isset($value[0]) && is_string($value[0]) && strtolower($value[0]) == 'exp') {
   405|             $value = $this->escapeString($value[1]);
   406|         } elseif (is_array($value)) {
   407|             $value = array_map(array($this, 'parseValue'), $value);
   408|         } elseif (is_bool($value)) {
   409|             $value = $value ? '1' : '0';
   410|         } elseif (is_null($value)) {

# --- HUNK 5: Lines 440-480 ---
   440|     }
   441|     /**
   442|      * table分析
   443|      * @access protected
   444|      * @param mixed $table
   445|      * @return string
   446|      */
   447|     protected function parseTable($tables)
   448|     {
   449|         if (is_array($tables)) {
   450|             $array = array();
   451|             foreach ($tables as $table => $alias) {
   452|                 if (!is_numeric($table)) {
   453|                     $array[] = $this->parseKey($table) . ' ' . $this->parseKey($alias);
   454|                 } else {
   455|                     $array[] = $this->parseKey($alias);
   456|                 }
   457|             }
   458|             $tables = $array;
   459|         } elseif (is_string($tables)) {
   460|             $tables = array_map(array($this, 'parseKey'), explode(',', $tables));
   461|         }
   462|         return implode(',', $tables);
   463|     }
   464|     /**
   465|      * where分析
   466|      * @access protected
   467|      * @param mixed $where
   468|      * @return string
   469|      */
   470|     protected function parseWhere($where)
   471|     {
   472|         $whereStr = '';
   473|         if (is_string($where)) {
   474|             $whereStr = $where;
   475|         } else {
   476|             $operate = isset($where['_logic']) ? strtoupper($where['_logic']) : '';
   477|             if (in_array($operate, array('AND', 'OR', 'XOR'))) {
   478|                 $operate = ' ' . $operate . ' ';
   479|                 unset($where['_logic']);
   480|             } else {

# --- HUNK 6: Lines 609-699 ---
   609|                 } else {
   610|                     $op = ' AND ';
   611|                 }
   612|                 $array = array();
   613|                 foreach ($where as $field => $data) {
   614|                     $array[] = $this->parseKey($field) . ' = ' . $this->parseValue($data);
   615|                 }
   616|                 $whereStr = implode($op, $array);
   617|                 break;
   618|         }
   619|         return '( ' . $whereStr . ' )';
   620|     }
   621|     /**
   622|      * limit分析
   623|      * @access protected
   624|      * @param mixed $lmit
   625|      * @return string
   626|      */
   627|     protected function parseLimit($limit)
   628|     {
   629|         return (!empty($limit) && false === strpos($limit, '(')) ? ' LIMIT ' . $limit . ' ' : '';
   630|     }
   631|     /**
   632|      * join分析
   633|      * @access protected
   634|      * @param mixed $join
   635|      * @return string
   636|      */
   637|     protected function parseJoin($join)
   638|     {
   639|         $joinStr = '';
   640|         if (!empty($join)) {
   641|             $joinStr = ' ' . implode(' ', $join) . ' ';
   642|         }
   643|         return $joinStr;
   644|     }
   645|     /**
   646|      * order分析
   647|      * @access protected
   648|      * @param mixed $order
   649|      * @return string
   650|      */
   651|     protected function parseOrder($order)
   652|     {
   653|         if (empty($order)) {
   654|             return '';
   655|         }
   656|         $array = array();
   657|         if (is_array($order)) {
   658|             foreach ($order as $key => $val) {
   659|                 if (is_numeric($key)) {
   660|                     if (false === strpos($val, '(')) {
   661|                         $array[] = $this->parseKey($val);
   662|                     }
   663|                 } elseif (false === strpos($key, ')') && false === strpos($key, '#')) {
   664|                     $sort    = in_array(strtolower($val), array('asc', 'desc')) ? ' ' . $val : '';
   665|                     $array[] = $this->parseKey($key, true) . $sort;
   666|                 }
   667|             }
   668|         } elseif ('[RAND]' == $order) {
   669|             $array[] = $this->parseRand();
   670|         } else {
   671|             foreach (explode(',', $order) as $val) {
   672|                 if (preg_match('/\s+(ASC|DESC)$/i', rtrim($val), $match, PREG_OFFSET_CAPTURE)) {
   673|                     $array[] = $this->parseKey(ltrim(substr($val, 0, $match[0][1]))) . ' ' . $match[1][0];
   674|                 } elseif (false === strpos($val, '(')) {
   675|                     $array[] = $this->parseKey($val);
   676|                 }
   677|             }
   678|         }
   679|         $order = implode(',', $array);
   680|         return !empty($order) ? ' ORDER BY ' . $order : '';
   681|     }
   682|     /**
   683|      * group分析
   684|      * @access protected
   685|      * @param mixed $group
   686|      * @return string
   687|      */
   688|     protected function parseGroup($group)
   689|     {
   690|         return !empty($group) ? ' GROUP BY ' . $group : '';
   691|     }
   692|     /**
   693|      * having分析
   694|      * @access protected
   695|      * @param string $having
   696|      * @return string
   697|      */
   698|     protected function parseHaving($having)
   699|     {

# --- HUNK 7: Lines 774-892 ---
   774|      * @return string
   775|      */
   776|     protected function parseDuplicate($duplicate)
   777|     {
   778|         return '';
   779|     }
   780|     /**
   781|      * 插入记录
   782|      * @access public
   783|      * @param mixed $data 数据
   784|      * @param array $options 参数表达式
   785|      * @param boolean $replace 是否replace
   786|      * @return false | integer
   787|      */
   788|     public function insert($data, $options = array(), $replace = false)
   789|     {
   790|         $values      = $fields      = array();
   791|         $this->model = $options['model'];
   792|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   793|         foreach ($data as $key => $val) {
   794|             if (isset($val[0]) && 'exp' == $val[0]) {
   795|                 $fields[] = $this->parseKey($key);
   796|                 $values[] = $val[1];
   797|             } elseif (is_null($val)) {
   798|                 $fields[] = $this->parseKey($key);
   799|                 $values[] = 'NULL';
   800|             } elseif (is_scalar($val)) {
   801|                 $fields[] = $this->parseKey($key);
   802|                 if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
   803|                     $values[] = $val;
   804|                 } else {
   805|                     $name     = count($this->bind);
   806|                     $values[] = ':' . $key . '_' . $name;
   807|                     $this->bindParam($key . '_' . $name, $val);
   808|                 }
   809|             }
   810|         }
   811|         $replace = (is_numeric($replace) && $replace > 0) ? true : $replace;
   812|         $sql     = (true === $replace ? 'REPLACE' : 'INSERT') . ' INTO ' . $this->parseTable($options['table']) . ' (' . implode(',', $fields) . ') VALUES (' . implode(',', $values) . ')' . $this->parseDuplicate($replace);
   813|         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
   814|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   815|     }
   816|     /**
   817|      * 批量插入记录
   818|      * @access public
   819|      * @param mixed $dataSet 数据集
   820|      * @param array $options 参数表达式
   821|      * @param boolean $replace 是否replace
   822|      * @return false | integer
   823|      */
   824|     public function insertAll($dataSet, $options = array(), $replace = false)
   825|     {
   826|         $values      = array();
   827|         $this->model = $options['model'];
   828|         if (!is_array($dataSet[0])) {
   829|             return false;
   830|         }
   831|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   832|         $fields = array_map(array($this, 'parseKey'), array_keys($dataSet[0]));
   833|         foreach ($dataSet as $data) {
   834|             $value = array();
   835|             foreach ($data as $key => $val) {
   836|                 if (is_array($val) && 'exp' == $val[0]) {
   837|                     $value[] = $val[1];
   838|                 } elseif (is_null($val)) {
   839|                     $value[] = 'NULL';
   840|                 } elseif (is_scalar($val)) {
   841|                     if (0 === strpos($val, ':') && in_array($val, array_keys($this->bind))) {
   842|                         $value[] = $val;
   843|                     } else {
   844|                         $name    = count($this->bind);
   845|                         $value[] = ':' . $key . '_' . $name;
   846|                         $this->bindParam($key . '_' . $name, $val);
   847|                     }
   848|                 }
   849|             }
   850|             $values[] = 'SELECT ' . implode(',', $value);
   851|         }
   852|         $sql = 'INSERT INTO ' . $this->parseTable($options['table']) . ' (' . implode(',', $fields) . ') ' . implode(' UNION ALL ', $values);
   853|         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
   854|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   855|     }
   856|     /**
   857|      * 通过Select方式插入记录
   858|      * @access public
   859|      * @param string $fields 要插入的数据表字段名
   860|      * @param string $table 要插入的数据表名
   861|      * @param array $option  查询数据参数
   862|      * @return false | integer
   863|      */
   864|     public function selectInsert($fields, $table, $options = array())
   865|     {
   866|         $this->model = $options['model'];
   867|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   868|         if (is_string($fields)) {
   869|             $fields = explode(',', $fields);
   870|         }
   871|         $fields = array_map(array($this, 'parseKey'), $fields);
   872|         $sql    = 'INSERT INTO ' . $this->parseTable($table) . ' (' . implode(',', $fields) . ') ';
   873|         $sql .= $this->buildSelectSql($options);
   874|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   875|     }
   876|     /**
   877|      * 更新记录
   878|      * @access public
   879|      * @param mixed $data 数据
   880|      * @param array $options 表达式
   881|      * @return false | integer
   882|      */
   883|     public function update($data, $options)
   884|     {
   885|         $this->model = $options['model'];
   886|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   887|         $table = $this->parseTable($options['table']);
   888|         $sql   = 'UPDATE ' . $table . $this->parseSet($data);
   889|         if (strpos($table, ',')) {
   890|             $sql .= $this->parseJoin(!empty($options['join']) ? $options['join'] : '');
   891|         }
   892|         $sql .= $this->parseWhere(!empty($options['where']) ? $options['where'] : '');

# --- HUNK 8: Lines 917-957 ---
   917|         }
   918|         $sql .= $this->parseWhere(!empty($options['where']) ? $options['where'] : '');
   919|         if (!strpos($table, ',')) {
   920|             $sql .= $this->parseOrder(!empty($options['order']) ? $options['order'] : '')
   921|             . $this->parseLimit(!empty($options['limit']) ? $options['limit'] : '');
   922|         }
   923|         $sql .= $this->parseComment(!empty($options['comment']) ? $options['comment'] : '');
   924|         return $this->execute($sql, !empty($options['fetch_sql']) ? true : false);
   925|     }
   926|     /**
   927|      * 查找记录
   928|      * @access public
   929|      * @param array $options 表达式
   930|      * @return mixed
   931|      */
   932|     public function select($options = array())
   933|     {
   934|         $this->model = $options['model'];
   935|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   936|         $sql    = $this->buildSelectSql($options);
   937|         $result = $this->query($sql, !empty($options['fetch_sql']) ? true : false, !empty($options['master']) ? true : false);
   938|         return $result;
   939|     }
   940|     /**
   941|      * 生成查询SQL
   942|      * @access public
   943|      * @param array $options 表达式
   944|      * @return string
   945|      */
   946|     public function buildSelectSql($options = array())
   947|     {
   948|         if (isset($options['page'])) {
   949|             list($page, $listRows) = $options['page'];
   950|             $page                  = $page > 0 ? $page : 1;
   951|             $listRows              = $listRows > 0 ? $listRows : (is_numeric($options['limit']) ? $options['limit'] : 20);
   952|             $offset                = $listRows * ($page - 1);
   953|             $options['limit']      = $offset . ',' . $listRows;
   954|         }
   955|         $sql = $this->parseSql($this->selectSql, $options);
   956|         return $sql;
   957|     }

# --- HUNK 9: Lines 1038-1080 ---
  1038|     protected function debug($start)
  1039|     {
  1040|         if ($this->config['debug']) {
  1041|             if ($start) {
  1042|                 G('queryStartTime');
  1043|             } else {
  1044|                 $this->modelSql[$this->model] = $this->queryStr;
  1045|                 G('queryEndTime');
  1046|                 trace($this->queryStr . ' [ RunTime:' . G('queryStartTime', 'queryEndTime') . 's ]', '', 'SQL');
  1047|             }
  1048|         }
  1049|     }
  1050|     /**
  1051|      * 初始化数据库连接
  1052|      * @access protected
  1053|      * @param boolean $master 主服务器
  1054|      * @return void
  1055|      */
  1056|     protected function initConnect($master = true)
  1057|     {
  1058|         if ($this->transPDO) {
  1059|             return $this->transPDO;
  1060|         }
  1061|         if (!empty($this->config['deploy']))
  1062|         {
  1063|             $this->_linkID = $this->multiConnect($master);
  1064|         } else
  1065|         if (!$this->_linkID) {
  1066|             $this->_linkID = $this->connect();
  1067|         }
  1068|     }
  1069|     /**
  1070|      * 连接分布式服务器
  1071|      * @access protected
  1072|      * @param boolean $master 主服务器
  1073|      * @return void
  1074|      */
  1075|     protected function multiConnect($master = false)
  1076|     {
  1077|         $_config['username'] = explode(',', $this->config['username']);
  1078|         $_config['password'] = explode(',', $this->config['password']);
  1079|         $_config['hostname'] = explode(',', $this->config['hostname']);
  1080|         $_config['hostport'] = explode(',', $this->config['hostport']);


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Firebird.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 123-152 ---
   123|     }
   124|     /**
   125|      * limit
   126|      * @access public
   127|      * @param $limit limit表达式
   128|      * @return string
   129|      */
   130|     public function parseLimit($limit)
   131|     {
   132|         $limitStr = '';
   133|         if (!empty($limit)) {
   134|             $limit = explode(',', $limit);
   135|             if (count($limit) > 1) {
   136|                 $limitStr = ' FIRST ' . $limit[1] . ' SKIP ' . $limit[0] . ' ';
   137|             } else {
   138|                 $limitStr = ' FIRST ' . $limit[0] . ' ';
   139|             }
   140|         }
   141|         return $limitStr;
   142|     }
   143|     /**
   144|      * 随机排序
   145|      * @access protected
   146|      * @return string
   147|      */
   148|     protected function parseRand()
   149|     {
   150|         return 'rand()';
   151|     }
   152| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Mongo.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 220-264 ---
   220|             $this->switchCollection($options['table']);
   221|         }
   222|         $this->model = $options['model'];
   223|         $this->executeTimes++;
   224|         N('db_write', 1); // 兼容代码
   225|         try {
   226|             $this->debug(true);
   227|             $result = $this->_collection->batchInsert($dataList);
   228|             $this->debug(false);
   229|             return $result;
   230|         } catch (\MongoCursorException $e) {
   231|             E($e->getMessage());
   232|         }
   233|     }
   234|     /**
   235|      * 生成下一条记录ID 用于自增非MongoId主键
   236|      * @access public
   237|      * @param string $pk 主键名
   238|      * @return integer
   239|      */
   240|     public function getMongoNextId($pk,$options=array())
   241|     {
   242|         if (isset($options['table'])) {
   243|             $this->switchCollection($options['table']);
   244|         }
   245|         if ($this->config['debug']) {
   246|             $this->queryStr = $this->_dbName . '.' . $this->_collectionName . '.find({},{' . $pk . ':1}).sort({' . $pk . ':-1}).limit(1)';
   247|         }
   248|         try {
   249|             $this->debug(true);
   250|             $result = $this->_collection->find(array(), array($pk => 1))->sort(array($pk => -1))->limit(1);
   251|             $this->debug(false);
   252|         } catch (\MongoCursorException $e) {
   253|             E($e->getMessage());
   254|         }
   255|         $data = $result->getNext();
   256|         return isset($data[$pk]) ? $data[$pk] + 1 : 1;
   257|     }
   258|     /**
   259|      * 更新记录
   260|      * @access public
   261|      * @param mixed $data 数据
   262|      * @param array $options 表达式
   263|      * @return bool
   264|      */

# --- HUNK 2: Lines 458-502 ---
   458|         $cache = isset($options['cache']) ? $options['cache'] : false;
   459|         if ($cache) {
   460|             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
   461|             $value = S($key, '', '', $cache['type']);
   462|             if (false !== $value) {
   463|                 return $value;
   464|             }
   465|         }
   466|         $this->model = $options['model'];
   467|         $this->queryTimes++;
   468|         N('db_query', 1); // 兼容代码
   469|         $query = $this->parseWhere(isset($options['where']) ? $options['where'] : array());
   470|         if ($this->config['debug']) {
   471|             $this->queryStr = $this->_dbName . '.' . $this->_collectionName . '.group({key:' . json_encode($keys) . ',cond:' .
   472|             json_encode($options['condition']) . ',reduce:' .
   473|             json_encode($reduce) . ',initial:' .
   474|             json_encode($initial) . '})';
   475|         }
   476|         try {
   477|             $this->debug(true);
   478|             $option = array();
   479|             isset($options['condition'])&&$option['condition']=$options['condition'];
   480|             isset($options['finalize'])&&$option['finalize']=$options['condition'];
   481|             isset($options['maxTimeMS'])&&$option['maxTimeMS']=$options['condition'];
   482|             $group = $this->_collection->group($keys,$initial,$reduce,$option); 
   483|             $this->debug(false);
   484|             if ($cache && $group['ok']) {
   485|                 S($key, $group, $cache['expire'], $cache['type']);
   486|             }
   487|             return $group;
   488|         } catch (\MongoCursorException $e) {
   489|             E($e->getMessage());
   490|         }
   491|     }
   492|     /**
   493|      * 取得数据表的字段信息
   494|      * @access public
   495|      * @return array
   496|      */
   497|     public function getFields($collection = '')
   498|     {
   499|         if (!empty($collection) && $collection != $this->_collectionName) {
   500|             $this->switchCollection($collection, '', false);
   501|         }
   502|         $this->queryTimes++;

# --- HUNK 3: Lines 557-597 ---
   557|      * @access public
   558|      * @return object MongoCollection
   559|      */
   560|     public function getCollection()
   561|     {
   562|         return $this->_collection;
   563|     }
   564|     /**
   565|      * set分析
   566|      * @access protected
   567|      * @param array $data
   568|      * @return string
   569|      */
   570|     protected function parseSet($data)
   571|     {
   572|         $result = array();
   573|         foreach ($data as $key => $val) {
   574|             if (is_array($val)) {
   575|                 switch ($val[0]) {
   576|                     case 'inc':
   577|                         $result['$inc'][$key] = (float) $val[1];
   578|                         break;
   579|                     case 'set':
   580|                     case 'unset':
   581|                     case 'push':
   582|                     case 'pushall':
   583|                     case 'addtoset':
   584|                     case 'pop':
   585|                     case 'pull':
   586|                     case 'pullall':
   587|                         $result['$' . $val[0]][$key] = $val[1];
   588|                         break;
   589|                     default:
   590|                         $result['$set'][$key] = $val;
   591|                 }
   592|             } else {
   593|                 $result['$set'][$key] = $val;
   594|             }
   595|         }
   596|         return $result;
   597|     }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Mysql.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 60-118 ---
    60|         return $info;
    61|     }
    62|     /**
    63|      * 取得数据库的表信息
    64|      * @access public
    65|      */
    66|     public function getTables($dbName = '')
    67|     {
    68|         $sql    = !empty($dbName) ? 'SHOW TABLES FROM ' . $dbName : 'SHOW TABLES ';
    69|         $result = $this->query($sql);
    70|         $info   = array();
    71|         foreach ($result as $key => $val) {
    72|             $info[$key] = current($val);
    73|         }
    74|         return $info;
    75|     }
    76|     /**
    77|      * 字段和表名处理
    78|      * @access protected
    79|      * @param string $key
    80|      * @param bool   $strict
    81|      * @return string
    82|      */
    83|     protected function parseKey($key, $strict = false)
    84|     {
    85|         $key = trim($key);
    86|         if ($strict || (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)`.\s]/', $key))) {
    87|             $key = '`' . $key . '`';
    88|         }
    89|         return $key;
    90|     }
    91|     /**
    92|      * 随机排序
    93|      * @access protected
    94|      * @return string
    95|      */
    96|     protected function parseRand()
    97|     {
    98|         return 'rand()';
    99|     }
   100|     /**
   101|      * 批量插入记录
   102|      * @access public
   103|      * @param mixed $dataSet 数据集
   104|      * @param array $options 参数表达式
   105|      * @param boolean $replace 是否replace
   106|      * @return false | integer
   107|      */
   108|     public function insertAll($dataSet, $options = array(), $replace = false)
   109|     {
   110|         $values      = array();
   111|         $this->model = $options['model'];
   112|         if (!is_array($dataSet[0])) {
   113|             return false;
   114|         }
   115|         $this->parseBind(!empty($options['bind']) ? $options['bind'] : array());
   116|         $fields = array_map(array($this, 'parseKey'), array_keys($dataSet[0]));
   117|         foreach ($dataSet as $data) {
   118|             $value = array();

# --- HUNK 2: Lines 146-186 ---
   146|      */
   147|     protected function parseDuplicate($duplicate)
   148|     {
   149|         if (is_bool($duplicate) || empty($duplicate)) {
   150|             return '';
   151|         }
   152|         if (is_string($duplicate)) {
   153|             $duplicate = explode(',', $duplicate);
   154|         } elseif (is_object($duplicate)) {
   155|             $duplicate = get_class_vars($duplicate);
   156|         }
   157|         $updates = array();
   158|         foreach ((array) $duplicate as $key => $val) {
   159|             if (is_numeric($key)) {
   160|                 $updates[] = $this->parseKey($val) . "=VALUES(" . $this->parseKey($val) . ")";
   161|             } else {
   162|                 if (is_scalar($val)) // 兼容标量传值方式
   163|                 {
   164|                     $val = array('value', $val);
   165|                 }
   166|                 if (!isset($val[1]) && !is_null($val[1])) {
   167|                     continue;
   168|                 }
   169|                 switch ($val[0]) {
   170|                     case 'exp': // 表达式
   171|                         $updates[] = $this->parseKey($key) . "=($val[1])";
   172|                         break;
   173|                     case 'value': // 值
   174|                     default:
   175|                         $name      = count($this->bind);
   176|                         $updates[] = $this->parseKey($key) . "=:" . $name;
   177|                         $this->bindParam($name, $val[1]);
   178|                         break;
   179|                 }
   180|             }
   181|         }
   182|         if (empty($updates)) {
   183|             return '';
   184|         }
   185|         return " ON DUPLICATE KEY UPDATE " . join(', ', $updates);
   186|     }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Oracle.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 142-171 ---
   142|             if (count($limit) > 1) {
   143|                 $limitStr = "(numrow>" . $limit[0] . ") AND (numrow<=" . ($limit[0] + $limit[1]) . ")";
   144|             } else {
   145|                 $limitStr = "(numrow>0 AND numrow<=" . $limit[0] . ")";
   146|             }
   147|         }
   148|         return $limitStr ? ' WHERE ' . $limitStr : '';
   149|     }
   150|     /**
   151|      * 设置锁机制
   152|      * @access protected
   153|      * @return string
   154|      */
   155|     protected function parseLock($lock = false)
   156|     {
   157|         if (!$lock) {
   158|             return '';
   159|         }
   160|         return ' FOR UPDATE NOWAIT ';
   161|     }
   162|     /**
   163|      * 随机排序
   164|      * @access protected
   165|      * @return string
   166|      */
   167|     protected function parseRand()
   168|     {
   169|         return 'DBMS_RANDOM.value';
   170|     }
   171| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Pgsql.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 11-51 ---
    11|      * @access public
    12|      * @param array $config 连接信息
    13|      * @return string
    14|      */
    15|     protected function parseDsn($config)
    16|     {
    17|         $dsn = 'pgsql:dbname=' . $config['database'] . ';host=' . $config['hostname'];
    18|         if (!empty($config['hostport'])) {
    19|             $dsn .= ';port=' . $config['hostport'];
    20|         }
    21|         return $dsn;
    22|     }
    23|     /**
    24|      * 取得数据表的字段信息
    25|      * @access public
    26|      * @return array
    27|      */
    28|     public function getFields($tableName)
    29|     {
    30|         list($tableName) = explode(' ', $tableName);
    31|         $result          = $this->query('select fields_name as "field",fields_type as "type",fields_not_null as "null",fields_key_name as "key",fields_default as "default",fields_default as "extra" from table_msg(\'' . $tableName . '\');');
    32|         $info            = array();
    33|         if ($result) {
    34|             foreach ($result as $key => $val) {
    35|                 $info[$val['field']] = array(
    36|                     'name'    => $val['field'],
    37|                     'type'    => $val['type'],
    38|                     'notnull' => (bool) ('' === $val['null']), // not null is empty, null is yes
    39|                     'default' => $val['default'],
    40|                     'primary' => (strtolower($val['key']) == 'pri'),
    41|                     'autoinc' => (strtolower($val['extra']) == 'auto_increment'),
    42|                 );
    43|             }
    44|         }
    45|         return $info;
    46|     }
    47|     /**
    48|      * 取得数据库的表信息
    49|      * @access public
    50|      * @return array
    51|      */

# --- HUNK 2: Lines 60-89 ---
    60|     }
    61|     /**
    62|      * limit分析
    63|      * @access protected
    64|      * @param mixed $lmit
    65|      * @return string
    66|      */
    67|     public function parseLimit($limit)
    68|     {
    69|         $limitStr = '';
    70|         if (!empty($limit)) {
    71|             $limit = explode(',', $limit);
    72|             if (count($limit) > 1) {
    73|                 $limitStr .= ' LIMIT ' . $limit[1] . ' OFFSET ' . $limit[0] . ' ';
    74|             } else {
    75|                 $limitStr .= ' LIMIT ' . $limit[0] . ' ';
    76|             }
    77|         }
    78|         return $limitStr;
    79|     }
    80|     /**
    81|      * 随机排序
    82|      * @access protected
    83|      * @return string
    84|      */
    85|     protected function parseRand()
    86|     {
    87|         return 'RANDOM()';
    88|     }
    89| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Sqlite.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 12-58 ---
    12|      * @param array $config 连接信息
    13|      * @return string
    14|      */
    15|     protected function parseDsn($config)
    16|     {
    17|         $dsn = 'sqlite:' . $config['database'];
    18|         return $dsn;
    19|     }
    20|     /**
    21|      * 取得数据表的字段信息
    22|      * @access public
    23|      * @return array
    24|      */
    25|     public function getFields($tableName)
    26|     {
    27|         list($tableName) = explode(' ', $tableName);
    28|         $result          = $this->query('PRAGMA table_info( ' . $tableName . ' )');
    29|         $info            = array();
    30|         if ($result) {
    31|             foreach ($result as $key => $val) {
    32|                 $info[$val['name']] = array(
    33|                     'name'    => $val['name'],
    34|                     'type'    => $val['type'],
    35|                     'notnull' => (bool) (1 === $val['notnull']),
    36|                     'default' => $val['dflt_value'],
    37|                     'primary' => '1' == $val['pk'],
    38|                     'autoinc' => false,
    39|                 );
    40|             }
    41|         }
    42|         return $info;
    43|     }
    44|     /**
    45|      * 取得数据库的表信息
    46|      * @access public
    47|      * @return array
    48|      */
    49|     public function getTables($dbName = '')
    50|     {
    51|         $result = $this->query("SELECT name FROM sqlite_master WHERE type='table' "
    52|             . "UNION ALL SELECT name FROM sqlite_temp_master "
    53|             . "WHERE type='table' ORDER BY name");
    54|         $info = array();
    55|         foreach ($result as $key => $val) {
    56|             $info[$key] = current($val);
    57|         }
    58|         return $info;

# --- HUNK 2: Lines 68-97 ---
    68|         return str_ireplace("'", "''", $str);
    69|     }
    70|     /**
    71|      * limit
    72|      * @access public
    73|      * @return string
    74|      */
    75|     public function parseLimit($limit)
    76|     {
    77|         $limitStr = '';
    78|         if (!empty($limit)) {
    79|             $limit = explode(',', $limit);
    80|             if (count($limit) > 1) {
    81|                 $limitStr .= ' LIMIT ' . $limit[1] . ' OFFSET ' . $limit[0] . ' ';
    82|             } else {
    83|                 $limitStr .= ' LIMIT ' . $limit[0] . ' ';
    84|             }
    85|         }
    86|         return $limitStr;
    87|     }
    88|     /**
    89|      * 随机排序
    90|      * @access protected
    91|      * @return string
    92|      */
    93|     protected function parseRand()
    94|     {
    95|         return 'RANDOM()';
    96|     }
    97| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Driver/Sqlsrv.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 69-118 ---
    69|             FROM INFORMATION_SCHEMA.TABLES
    70|             WHERE TABLE_TYPE = 'BASE TABLE'
    71|             ");
    72|         $info = array();
    73|         foreach ($result as $key => $val) {
    74|             $info[$key] = current($val);
    75|         }
    76|         return $info;
    77|     }
    78|     /**
    79|      * order分析
    80|      * @access protected
    81|      * @param mixed $order
    82|      * @return string
    83|      */
    84|     protected function parseOrder($order)
    85|     {
    86|         return !empty($order) ? ' ORDER BY ' . $order : ' ORDER BY rand()';
    87|     }
    88|     /**
    89|      * 字段和表名处理
    90|      * @access protected
    91|      * @param string $key
    92|      * @param bool   $strict
    93|      * @return string
    94|      */
    95|     protected function parseKey($key, $strict = false)
    96|     {
    97|         $key = trim($key);
    98|         if ($strict || (!is_numeric($key) && !preg_match('/[,\'\"\*\(\)\[.\s]/', $key))) {
    99|             $key = '[' . $key . ']';
   100|         }
   101|         return $key;
   102|     }
   103|     /**
   104|      * limit
   105|      * @access public
   106|      * @param mixed $limit
   107|      * @return string
   108|      */
   109|     public function parseLimit($limit)
   110|     {
   111|         if (empty($limit)) {
   112|             return '';
   113|         }
   114|         $limit = explode(',', $limit);
   115|         if (count($limit) > 1) {
   116|             $limitStr = '(T1.ROW_NUMBER BETWEEN ' . $limit[0] . ' + 1 AND ' . $limit[0] . ' + ' . $limit[1] . ')';
   117|         } else {
   118|             $limitStr = '(T1.ROW_NUMBER BETWEEN 1 AND ' . $limit[0] . ")";


# ====================================================================
# FILE: ThinkPHP/Library/Think/Db/Lite.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| <?php
     2| namespace Think\Db;
     3| use PDO;
     4| use Think\Config;
     5| use Think\Debug;
     6| class Lite
     7| {
     8|     protected $PDOStatement = null;
     9|     protected $model = '_think_';
    10|     protected $queryStr = '';
    11|     protected $modelSql = array();
    12|     protected $lastInsID = null;
    13|     protected $numRows = 0;
    14|     protected $transPDO = null;
    15|     protected $transTimes = 0;
    16|     protected $error = '';
    17|     protected $linkID = array();
    18|     protected $_linkID = null;
    19|     protected $config = array(
    20|         'type'        => '', // 数据库类型
    21|         'hostname'    => '127.0.0.1', // 服务器地址
    22|         'database'    => '', // 数据库名
    23|         'username'    => '', // 用户名
    24|         'password'    => '', // 密码
    25|         'hostport'    => '', // 端口
    26|         'dsn'         => '', //
    27|         'params'      => array(), // 数据库连接参数
    28|         'charset'     => 'utf8', // 数据库编码默认采用utf8
    29|         'prefix'      => '', // 数据库表前缀
    30|         'debug'       => false, // 数据库调试模式
    31|         'deploy'      => 0, // 数据库部署方式:0 集中式(单一服务器),1 分布式(主从服务器)
    32|         'rw_separate' => false, // 数据库读写是否分离 主从式有效
    33|         'master_num'  => 1, // 读写分离后 主服务器数量
    34|         'slave_no'    => '', // 指定从服务器序号

# --- HUNK 2: Lines 184-260 ---
   184|         } else {
   185|             $this->numRows = $this->PDOStatement->rowCount();
   186|             if (preg_match("/^\s*(INSERT\s+INTO|REPLACE\s+INTO)\s+/i", $str)) {
   187|                 $this->lastInsID = $this->_linkID->lastInsertId();
   188|             }
   189|             return $this->numRows;
   190|         }
   191|     }
   192|     /**
   193|      * 启动事务
   194|      * @access public
   195|      * @return void
   196|      */
   197|     public function startTrans()
   198|     {
   199|         $this->initConnect(true);
   200|         if (!$this->_linkID) {
   201|             return false;
   202|         }
   203|         if (0 == $this->transTimes) {
   204|             $this->transPdo = $this->_linkID;
   205|             $this->_linkID->beginTransaction();
   206|         }
   207|         $this->transTimes++;
   208|         return;
   209|     }
   210|     /**
   211|      * 用于非自动提交状态下面的查询提交
   212|      * @access public
   213|      * @return boolean
   214|      */
   215|     public function commit()
   216|     {
   217|         if ($this->transTimes == 1) {
   218|             $result = $this->_linkID->commit();
   219|             $this->transTimes = 0;
   220|             $this->transPdo = null;
   221|             if (!$result) {
   222|                 $this->error();
   223|                 return false;
   224|             }
   225|         } else {
   226|             $this->transTimes--;
   227|         }
   228|         return true;
   229|     }
   230|     /**
   231|      * 事务回滚
   232|      * @access public
   233|      * @return boolean
   234|      */
   235|     public function rollback()
   236|     {
   237|         if ($this->transTimes > 0) {
   238|             $result = $this->_linkID->rollback();
   239|             $this->transTimes = 0;
   240|             $this->transPdo = null;
   241|             if (!$result) {
   242|                 $this->error();
   243|                 return false;
   244|             }
   245|         }
   246|         return true;
   247|     }
   248|     /**
   249|      * 获得所有的查询数据
   250|      * @access private
   251|      * @return array
   252|      */
   253|     private function getResult()
   254|     {
   255|         $result        = $this->PDOStatement->fetchAll(PDO::FETCH_ASSOC);
   256|         $this->numRows = count($result);
   257|         return $result;
   258|     }
   259|     /**
   260|      * 获得查询次数

# --- HUNK 3: Lines 363-405 ---
   363|     protected function debug($start)
   364|     {
   365|         if ($this->config['debug']) {
   366|             if ($start) {
   367|                 G('queryStartTime');
   368|             } else {
   369|                 $this->modelSql[$this->model] = $this->queryStr;
   370|                 G('queryEndTime');
   371|                 trace($this->queryStr . ' [ RunTime:' . G('queryStartTime', 'queryEndTime') . 's ]', '', 'SQL');
   372|             }
   373|         }
   374|     }
   375|     /**
   376|      * 初始化数据库连接
   377|      * @access protected
   378|      * @param boolean $master 主服务器
   379|      * @return void
   380|      */
   381|     protected function initConnect($master = true)
   382|     {
   383|         if ($this->transPDO) {
   384|             return $this->transPDO;
   385|         }
   386|         if (!empty($this->config['deploy']))
   387|         {
   388|             $this->_linkID = $this->multiConnect($master);
   389|         } else
   390|         if (!$this->_linkID) {
   391|             $this->_linkID = $this->connect();
   392|         }
   393|     }
   394|     /**
   395|      * 连接分布式服务器
   396|      * @access protected
   397|      * @param boolean $master 主服务器
   398|      * @return void
   399|      */
   400|     protected function multiConnect($master = false)
   401|     {
   402|         $_config['username'] = explode(',', $this->config['username']);
   403|         $_config['password'] = explode(',', $this->config['password']);
   404|         $_config['hostname'] = explode(',', $this->config['hostname']);
   405|         $_config['hostport'] = explode(',', $this->config['hostport']);


# ====================================================================
# FILE: ThinkPHP/Library/Think/Dispatcher.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-317 ---
     1| <?php
     2| namespace Think;
     3| /**
     4|  * ThinkPHP内置的Dispatcher类
     5|  * 完成URL解析、路由和调度
     6|  */
     7| class Dispatcher
     8| {
     9|     /**
    10|      * URL映射到控制器
    11|      * @access public
    12|      * @return void
    13|      */
    14|     public static function dispatch()
    15|     {
    16|         $varPath = C('VAR_PATHINFO');
    17|         $urlCase = C('URL_CASE_INSENSITIVE');
    18|         if (isset($_GET[$varPath])) { // 判断URL里面是否有兼容模式参数
    19|             $_SERVER['PATH_INFO'] = $_GET[$varPath];
    20|             unset($_GET[$varPath]);
    21|         } elseif (IS_CLI) { // CLI模式下 index.php module/controller/action/params/...
    22|             $_SERVER['PATH_INFO'] = isset($_SERVER['argv'][1]) ? $_SERVER['argv'][1] : '';
    23|         }
    24|         if (C('APP_SUB_DOMAIN_DEPLOY')) {
    25|             $rules = C('APP_SUB_DOMAIN_RULES');
    26|             if (isset($rules[$_SERVER['HTTP_HOST']])) { // 完整域名或者IP配置
    27|                 define('APP_DOMAIN', $_SERVER['HTTP_HOST']); // 当前完整域名
    28|                 $rule = $rules[APP_DOMAIN];
    29|             } else {
    30|                 if (strpos(C('APP_DOMAIN_SUFFIX'), '.')) { // com.cn net.cn
    31|                     $domain = array_slice(explode('.', $_SERVER['HTTP_HOST']), 0, -3);
    32|                 } else {
    33|                     $domain = array_slice(explode('.', $_SERVER['HTTP_HOST']), 0, -2);
    34|                 }
    35|                 if (!empty($domain)) {
    36|                     $subDomain = implode('.', $domain);
    37|                     define('SUB_DOMAIN', $subDomain); // 当前完整子域名
    38|                     $domain2 = array_pop($domain); // 二级域名
    39|                     if ($domain) {
    40|                         $domain3 = array_pop($domain);
    41|                     }
    42|                     if (isset($rules[$subDomain])) {
    43|                         $rule = $rules[$subDomain];
    44|                     } elseif (isset($rules['*.' . $domain2]) && !empty($domain3)) {
    45|                         $rule = $rules['*.' . $domain2];
    46|                         $panDomain = $domain3;
    47|                     } elseif (isset($rules['*']) && !empty($domain2) && 'www' != $domain2) {
    48|                         $rule = $rules['*'];
    49|                         $panDomain = $domain2;
    50|                     }
    51|                 }
    52|             }
    53|             if (!empty($rule)) {
    54|                 if (is_array($rule)) {
    55|                     list($rule, $vars) = $rule;
    56|                 }
    57|                 $array = explode('/', $rule);
    58|                 define('BIND_MODULE', array_shift($array));
    59|                 if (!empty($array)) {
    60|                     $controller = array_shift($array);
    61|                     if ($controller) {
    62|                         define('BIND_CONTROLLER', $controller);
    63|                     }
    64|                 }
    65|                 if (isset($vars)) {
    66|                     parse_str($vars, $parms);
    67|                     if (isset($panDomain)) {
    68|                         $pos = array_search('*', $parms);
    69|                         if (false !== $pos) {
    70|                             $parms[$pos] = $panDomain;
    71|                         }
    72|                     }
    73|                     $_GET = array_merge($_GET, $parms);
    74|                 }
    75|             }
    76|         }
    77|         if (!isset($_SERVER['PATH_INFO'])) {
    78|             $types = explode(',', C('URL_PATHINFO_FETCH'));
    79|             foreach ($types as $type) {
    80|                 if (0 === strpos($type, ':')) {
    81|                     $_SERVER['PATH_INFO'] = call_user_func(substr($type, 1));
    82|                     break;
    83|                 } elseif (!empty($_SERVER[$type])) {
    84|                     $_SERVER['PATH_INFO'] = (0 === strpos($_SERVER[$type], $_SERVER['SCRIPT_NAME'])) ?
    85|                         substr($_SERVER[$type], strlen($_SERVER['SCRIPT_NAME'])) : $_SERVER[$type];
    86|                     break;
    87|                 }
    88|             }
    89|         }
    90|         $depr = C('URL_PATHINFO_DEPR');
    91|         define('MODULE_PATHINFO_DEPR', $depr);
    92|         if (empty($_SERVER['PATH_INFO'])) {
    93|             $_SERVER['PATH_INFO'] = '';
    94|             define('__INFO__', '');
    95|             define('__EXT__', '');
    96|             $paths = array();
    97|         } else {
    98|             define('__EXT__', strtolower(pathinfo($_SERVER['PATH_INFO'], PATHINFO_EXTENSION)));
    99|             if ($denySuffix = C('URL_DENY_SUFFIX')) {
   100|                 if (in_array(__EXT__, explode('|', strtolower(str_replace('.', '', $denySuffix))))) {
   101|                     send_http_status(404);
   102|                     exit;
   103|                 }
   104|             }
   105|             define('__INFO__', trim($_SERVER['PATH_INFO'], '/'));
   106|             $_SERVER['PATH_INFO'] = preg_replace('/\.' . __EXT__ . '$/i', '', __INFO__);
   107|             $paths = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
   108|         }
   109|         define('__SELF__', strip_tags($_SERVER[C('URL_REQUEST_URI')]));
   110|         define('MODULE_NAME', self::getModule($paths));
   111|         if (MODULE_NAME && is_dir(APP_PATH . MODULE_NAME)) {
   112|             define('MODULE_PATH', APP_PATH . MODULE_NAME . '/');
   113|             C('CACHE_PATH', CACHE_PATH . MODULE_NAME . '/');
   114|             C('LOG_PATH', realpath(LOG_PATH) . '/' . MODULE_NAME . '/');
   115|             Hook::listen('module_check');
   116|             if (is_file(MODULE_PATH . 'Conf/config' . CONF_EXT)) {
   117|                 C(load_config(MODULE_PATH . 'Conf/config' . CONF_EXT));
   118|             }
   119|             if ('common' != APP_MODE && is_file(MODULE_PATH . 'Conf/config_' . APP_MODE . CONF_EXT)) {
   120|                 C(load_config(MODULE_PATH . 'Conf/config_' . APP_MODE . CONF_EXT));
   121|             }
   122|             if (APP_STATUS && is_file(MODULE_PATH . 'Conf/' . APP_STATUS . CONF_EXT)) {
   123|                 C(load_config(MODULE_PATH . 'Conf/' . APP_STATUS . CONF_EXT));
   124|             }
   125|             if (is_file(MODULE_PATH . 'Conf/alias.php')) {
   126|                 Think::addMap(include MODULE_PATH . 'Conf/alias.php');
   127|             }
   128|             if (is_file(MODULE_PATH . 'Conf/tags.php')) {
   129|                 Hook::import(include MODULE_PATH . 'Conf/tags.php');
   130|             }
   131|             if (is_file(MODULE_PATH . 'Common/function.php'))
   132|                 include MODULE_PATH . 'Common/function.php';
   133|             load_ext_file(MODULE_PATH);
   134|             Hook::listen('module_config');
   135|         } else {
   136|             E(L('_MODULE_NOT_EXIST_') . ':' . MODULE_NAME);
   137|         }
   138|         if (!defined('__APP__')) {
   139|             $urlMode = C('URL_MODEL');
   140|             if (URL_COMPAT == $urlMode) {
   141|                 define('PHP_FILE', _PHP_FILE_ . '?' . $varPath . '=');
   142|             } elseif (URL_REWRITE == $urlMode) {
   143|                 $url = dirname(_PHP_FILE_);
   144|                 if ('/' == $url || '\\' == $url) {
   145|                     $url = '';
   146|                 }
   147|                 define('PHP_FILE', $url);
   148|             } else {
   149|                 define('PHP_FILE', _PHP_FILE_);
   150|             }
   151|             define('__APP__', strip_tags(PHP_FILE));
   152|         }
   153|         $moduleName = defined('MODULE_ALIAS') ? MODULE_ALIAS : MODULE_NAME;
   154|         define('__MODULE__', (defined('BIND_MODULE') || !C('MULTI_MODULE')) ? __APP__ : __APP__ . '/' . ($urlCase ? strtolower($moduleName) : $moduleName));
   155|         define('CONTROLLER_NAME', self::getController($paths, $urlCase));
   156|         define('ACTION_NAME', self::getAction($paths, $urlCase));
   157|         if ($paths) {
   158|             $var = array();
   159|             if (C('URL_PARAMS_BIND') && 1 == C('URL_PARAMS_BIND_TYPE')) {
   160|                 $var = $paths;
   161|             } else {
   162|                 preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$var) {
   163|                     $var[$match[1]] = strip_tags($match[2]);
   164|                 }, implode('/', $paths));
   165|             }
   166|             $_GET = array_merge($var, $_GET);
   167|         }
   168|         define('CONTROLLER_PATH', self::getSpace($urlCase));
   169|         $controllerName = defined('CONTROLLER_ALIAS') ? CONTROLLER_ALIAS : CONTROLLER_NAME;
   170|         define('__CONTROLLER__', __MODULE__ . $depr . (defined('BIND_CONTROLLER') ? '' : ($urlCase ? parse_name($controllerName) : $controllerName)));
   171|         define('__ACTION__', __CONTROLLER__ . $depr . (defined('ACTION_ALIAS') ? ACTION_ALIAS : ACTION_NAME));
   172|         $_REQUEST = array_merge($_POST, $_GET);
   173|     }
   174|     /**
   175|      * 获得控制器的命名空间路径 便于插件机制访问
   176|      * @param  boolean $urlCase 是否转换成小写
   177|      * @return string
   178|      */
   179|     private static function getSpace($urlCase)
   180|     {
   181|         $var = C('VAR_ADDON');
   182|         $space = !empty($_GET[$var]) ? strip_tags($_GET[$var]) : '';
   183|         unset($_GET[$var]);
   184|         return $space;
   185|     }
   186|     /**
   187|      * 获得实际的控制器名称
   188|      * @param  array $paths path_info数组
   189|      * @param  boolean $urlCase 是否转换成小写
   190|      * @return string
   191|      */
   192|     private static function getController(&$paths, $urlCase)
   193|     {
   194|         if (defined('BIND_CONTROLLER')) {
   195|             return BIND_CONTROLLER;
   196|         } else {
   197|             if ($paths && C('URL_ROUTER_ON') && Route::check($paths)) {
   198|                 $depr = C('URL_PATHINFO_DEPR');
   199|                 $paths = explode($depr, trim($_SERVER['PATH_INFO'], $depr));
   200|             }
   201|             if ($paths) {
   202|                 Hook::listen('path_info');
   203|                 if (C('CONTROLLER_LEVEL') > 1) {// 控制器层次
   204|                     $controller = implode('/', array_slice($paths, 0, C('CONTROLLER_LEVEL')));
   205|                     $paths = array_slice($paths, C('CONTROLLER_LEVEL'));
   206|                 } else {
   207|                     $controller = array_shift($paths);
   208|                 }
   209|             } else {
   210|                 $var = C('VAR_CONTROLLER');
   211|                 if (!empty($_GET[$var])) {
   212|                     $controller = $_GET[$var];
   213|                     unset($_GET[$var]);
   214|                 } else {
   215|                     $controller = C('DEFAULT_CONTROLLER');
   216|                 }
   217|             }
   218|         }
   219|         if ($maps = C('URL_CONTROLLER_MAP')) {
   220|             if (isset($maps[strtolower($controller)])) {
   221|                 define('CONTROLLER_ALIAS', strtolower($controller));
   222|                 return ucfirst($maps[CONTROLLER_ALIAS]);
   223|             } elseif (array_search(strtolower($controller), $maps)) {
   224|                 return '';
   225|             }
   226|         }
   227|         if ($urlCase) {
   228|             $controller = parse_name($controller, 1);
   229|         }
   230|         return strip_tags(ucfirst($controller));
   231|     }
   232|     /**
   233|      * 获得实际的操作名称
   234|      * @param  array $paths path_info数组
   235|      * @param  boolean $urlCase 是否转换成小写
   236|      * @return string
   237|      */
   238|     private static function getAction(&$paths, $urlCase)
   239|     {
   240|         if (defined('BIND_ACTION')) {
   241|             return BIND_ACTION;
   242|         } else {
   243|             if ($paths) {
   244|                 $action = array_shift($paths);
   245|             } else {
   246|                 $var = C('VAR_ACTION');
   247|                 if (!empty($_GET[$var])) {
   248|                     $action = $_GET[$var];
   249|                     unset($_GET[$var]);
   250|                 } elseif (!empty($_POST[$var])) {
   251|                     $action = $_POST[$var];
   252|                     unset($_POST[$var]);
   253|                 } else {
   254|                     $action = C('DEFAULT_ACTION');
   255|                 }
   256|             }
   257|         }
   258|         if ($maps = C('URL_ACTION_MAP')) {
   259|             if (isset($maps[strtolower(CONTROLLER_NAME)])) {
   260|                 $maps = $maps[strtolower(CONTROLLER_NAME)];
   261|                 if (isset($maps[strtolower($action)])) {
   262|                     define('ACTION_ALIAS', strtolower($action));
   263|                     if (is_array($maps[ACTION_ALIAS])) {
   264|                         parse_str($maps[ACTION_ALIAS][1], $vars);
   265|                         $_GET = array_merge($_GET, $vars);
   266|                         return $maps[ACTION_ALIAS][0];
   267|                     } else {
   268|                         return $maps[ACTION_ALIAS];
   269|                     }
   270|                 } elseif (array_search(strtolower($action), $maps)) {
   271|                     return '';
   272|                 }
   273|             }
   274|         }
   275|         return strip_tags($urlCase ? strtolower($action) : $action);
   276|     }
   277|     /**
   278|      * 获得实际的模块名称
   279|      * @param  array $paths path_info数组
   280|      * @return string
   281|      */
   282|     private static function getModule(&$paths)
   283|     {
   284|         if (defined('BIND_MODULE')) {
   285|             return BIND_MODULE;
   286|         } else {
   287|             if ($paths && C('URL_ROUTER_ON') && Route::check($paths)) {
   288|                 $paths = explode(MODULE_PATHINFO_DEPR, trim($_SERVER['PATH_INFO'], MODULE_PATHINFO_DEPR));
   289|             }
   290|             if ($paths && C('MULTI_MODULE')) { // 获取模块名
   291|                 $allowList = C('MODULE_ALLOW_LIST'); // 允许的模块列表
   292|                 if (empty($allowList) || (is_array($allowList) && in_array_case($paths[0], $allowList))) {
   293|                     $module = array_shift($paths);
   294|                     $_SERVER['PATH_INFO'] = implode(MODULE_PATHINFO_DEPR, $paths);
   295|                 }
   296|             } else {
   297|                 $var = C('VAR_MODULE');
   298|                 if (!empty($_GET[$var])) {
   299|                     $module = $_GET[$var];
   300|                     unset($_GET[$var]);
   301|                 }
   302|             }
   303|             if (empty($module)) {
   304|                 $module = C('DEFAULT_MODULE');
   305|             }
   306|         }
   307|         if ($maps = C('URL_MODULE_MAP')) {
   308|             if (isset($maps[strtolower($module)])) {
   309|                 define('MODULE_ALIAS', strtolower($module));
   310|                 return ucfirst($maps[MODULE_ALIAS]);
   311|             } elseif (array_search(strtolower($module), $maps) || in_array_case($module, C('MODULE_DENY_LIST'))) {
   312|                 return '';
   313|             }
   314|         }
   315|         return strip_tags(ucfirst($module));
   316|     }
   317| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Image/Driver/Gd.class.php
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 10-50 ---
    10|     private $img;
    11|     /**
    12|      * 图像信息，包括width,height,type,mime,size
    13|      * @var array
    14|      */
    15|     private $info;
    16|     /**
    17|      * 构造方法，可用于打开一张图像
    18|      * @param string $imgname 图像路径
    19|      */
    20|     public function __construct($imgname = null)
    21|     {
    22|         $imgname && $this->open($imgname);
    23|     }
    24|     /**
    25|      * 打开一张图像
    26|      * @param  string $imgname 图像路径
    27|      */
    28|     public function open($imgname)
    29|     {
    30|         if (substr($imgname, 0, 4) != 'http' && !is_file($imgname)) {
    31|             E('不存在的图像文件');
    32|         }
    33|         $info = getimagesize($imgname);
    34|         if (false === $info || (IMAGETYPE_GIF === $info[2] && empty($info['bits']))) {
    35|             E('非法图像文件');
    36|         }
    37|         $this->info = array(
    38|             'width'  => $info[0],
    39|             'height' => $info[1],
    40|             'type'   => image_type_to_extension($info[2], false),
    41|             'mime'   => $info['mime'],
    42|         );
    43|         empty($this->img) || imagedestroy($this->img);
    44|         if ('gif' == $this->info['type']) {
    45|             $class     = 'Think\\Image\\Driver\\GIF';
    46|             $this->gif = new $class($imgname);
    47|             $this->img = imagecreatefromstring($this->gif->image());
    48|         } else {
    49|             $fun       = "imagecreatefrom{$this->info['type']}";
    50|             $this->img = $fun($imgname);

# --- HUNK 2: Lines 55-97 ---
    55|      * @param  string  $imgname   图像保存名称
    56|      * @param  string  $type      图像类型
    57|      * @param  integer $quality   图像质量
    58|      * @param  boolean $interlace 是否对JPEG类型图像设置隔行扫描
    59|      */
    60|     public function save($imgname, $type = null, $quality = 80, $interlace = true)
    61|     {
    62|         if (empty($this->img)) {
    63|             E('没有可以被保存的图像资源');
    64|         }
    65|         if (is_null($type)) {
    66|             $type = $this->info['type'];
    67|         } else {
    68|             $type = strtolower($type);
    69|         }
    70|         if ('jpeg' == $type || 'jpg' == $type) {
    71|             imageinterlace($this->img, $interlace);
    72|             imagejpeg($this->img, $imgname, $quality);
    73|         } elseif ('gif' == $type && !empty($this->gif)) {
    74|             $this->gif->save($imgname);
    75|         } elseif ('png' == $type) {
    76|             imagesavealpha($this->img, true);
    77|             imagepng($this->img, $imgname, $quality / 10);
    78|         } else {
    79|             $fun = 'image' . $type;
    80|             $fun($this->img, $imgname);
    81|         }
    82|     }
    83|     /**
    84|      * 返回图像宽度
    85|      * @return integer 图像宽度
    86|      */
    87|     public function width()
    88|     {
    89|         if (empty($this->img)) {
    90|             E('没有指定图像资源');
    91|         }
    92|         return $this->info['width'];
    93|     }
    94|     /**
    95|      * 返回图像高度
    96|      * @return integer 图像高度
    97|      */

# --- HUNK 3: Lines 138-180 ---
   138|     /**
   139|      * 裁剪图像
   140|      * @param  integer $w      裁剪区域宽度
   141|      * @param  integer $h      裁剪区域高度
   142|      * @param  integer $x      裁剪区域x坐标
   143|      * @param  integer $y      裁剪区域y坐标
   144|      * @param  integer $width  图像保存宽度
   145|      * @param  integer $height 图像保存高度
   146|      */
   147|     public function crop($w, $h, $x = 0, $y = 0, $width = null, $height = null)
   148|     {
   149|         if (empty($this->img)) {
   150|             E('没有可以被裁剪的图像资源');
   151|         }
   152|         empty($width) && $width   = $w;
   153|         empty($height) && $height = $h;
   154|         do {
   155|             $img = imagecreatetruecolor($width, $height);
   156|             $color = imagecolorallocate($img, 255, 255, 255);
   157|             imagefill($img, 0, 0, $color);
   158|             if ('png' == $this->info['type']) {
   159|                 imagealphablending($img, false);
   160|             }
   161|             imagecopyresampled($img, $this->img, 0, 0, $x, $y, $width, $height, $w, $h);
   162|             imagedestroy($this->img); //销毁原图
   163|             $this->img = $img;
   164|         } while (!empty($this->gif) && $this->gifNext());
   165|         $this->info['width']  = $width;
   166|         $this->info['height'] = $height;
   167|     }
   168|     /**
   169|      * 生成缩略图
   170|      * @param  integer $width  缩略图最大宽度
   171|      * @param  integer $height 缩略图最大高度
   172|      * @param  integer $type   缩略图裁剪类型
   173|      */
   174|     public function thumb($width, $height, $type = Image::IMAGE_THUMB_SCALE)
   175|     {
   176|         if (empty($this->img)) {
   177|             E('没有可以被缩略的图像资源');
   178|         }
   179|         $w = $this->info['width'];
   180|         $h = $this->info['height'];

# --- HUNK 4: Lines 212-252 ---
   212|                 $h = $height / $scale;
   213|                 $x = $this->info['width'] - $w;
   214|                 $y = $this->info['height'] - $h;
   215|                 break;
   216|             /* 填充 */
   217|             case Image::IMAGE_THUMB_FILLED:
   218|                 if ($w < $width && $h < $height) {
   219|                     $scale = 1;
   220|                 } else {
   221|                     $scale = min($width / $w, $height / $h);
   222|                 }
   223|                 $neww = $w * $scale;
   224|                 $newh = $h * $scale;
   225|                 $posx = ($width - $w * $scale) / 2;
   226|                 $posy = ($height - $h * $scale) / 2;
   227|                 do {
   228|                     $img = imagecreatetruecolor($width, $height);
   229|                     $color = imagecolorallocate($img, 255, 255, 255);
   230|                     imagefill($img, 0, 0, $color);
   231|                     imagecopyresampled($img, $this->img, $posx, $posy, $x, $y, $neww, $newh, $w, $h);
   232|                     imagedestroy($this->img);     //销毁原图
   233|                     $this->img = $img;
   234|                 } while (!empty($this->gif) && $this->gifNext());
   235|                 $this->info['width']  = $width;
   236|                 $this->info['height'] = $height;
   237|                 return;
   238|             /* 固定 */
   239|             case Image::IMAGE_THUMB_FIXED:
   240|                 $x = $y = 0;
   241|                 break;
   242|             default:
   243|                 E('不支持的缩略图裁剪类型');
   244|         }
   245|         /* 裁剪图像 */
   246|         $this->crop($w, $h, $x, $y, $width, $height);
   247|     }
   248|     /**
   249|      * 添加水印
   250|      * @param  string  $source 水印图片路径
   251|      * @param  integer $locate 水印位置
   252|      * @param  integer $alpha  水印透明度

# --- HUNK 5: Lines 296-336 ---
   296|             case Image::IMAGE_WATER_SOUTH:
   297|                 $x = ($this->info['width'] - $info[0]) / 2;
   298|                 $y = $this->info['height'] - $info[1];
   299|                 break;
   300|             /* 右居中水印 */
   301|             case Image::IMAGE_WATER_EAST:
   302|                 $x = $this->info['width'] - $info[0];
   303|                 $y = ($this->info['height'] - $info[1]) / 2;
   304|                 break;
   305|             /* 上居中水印 */
   306|             case Image::IMAGE_WATER_NORTH:
   307|                 $x = ($this->info['width'] - $info[0]) / 2;
   308|                 $y = 0;
   309|                 break;
   310|             /* 左居中水印 */
   311|             case Image::IMAGE_WATER_WEST:
   312|                 $x = 0;
   313|                 $y = ($this->info['height'] - $info[1]) / 2;
   314|                 break;
   315|             default:
   316|             /* 自定义水印坐标 */
   317|                 if (is_array($locate)) {
   318|                     list($x, $y) = $locate;
   319|                 } else {
   320|                     E('不支持的水印位置类型');
   321|                 }
   322|         }
   323|         do {
   324|             $src = imagecreatetruecolor($info[0], $info[1]);
   325|             $color = imagecolorallocate($src, 255, 255, 255);
   326|             imagefill($src, 0, 0, $color);
   327|             imagecopy($src, $this->img, 0, 0, $x, $y, $info[0], $info[1]);
   328|             imagecopy($src, $water, 0, 0, 0, 0, $info[0], $info[1]);
   329|             imagecopymerge($this->img, $src, $x, $y, 0, 0, $info[0], $info[1], $alpha);
   330|             imagedestroy($src);
   331|         } while (!empty($this->gif) && $this->gifNext());
   332|         imagedestroy($water);
   333|     }
   334|     /**
   335|      * 图像添加文字
   336|      * @param  string  $text   添加的文字

# --- HUNK 6: Lines 384-424 ---
   384|                 break;
   385|             /* 下居中文字 */
   386|             case Image::IMAGE_WATER_SOUTH:
   387|                 $x += ($this->info['width'] - $w) / 2;
   388|                 $y += $this->info['height'] - $h;
   389|                 break;
   390|             /* 右居中文字 */
   391|             case Image::IMAGE_WATER_EAST:
   392|                 $x += $this->info['width'] - $w;
   393|                 $y += ($this->info['height'] - $h) / 2;
   394|                 break;
   395|             /* 上居中文字 */
   396|             case Image::IMAGE_WATER_NORTH:
   397|                 $x += ($this->info['width'] - $w) / 2;
   398|                 break;
   399|             /* 左居中文字 */
   400|             case Image::IMAGE_WATER_WEST:
   401|                 $y += ($this->info['height'] - $h) / 2;
   402|                 break;
   403|             default:
   404|             /* 自定义文字坐标 */
   405|                 if (is_array($locate)) {
   406|                     list($posx, $posy) = $locate;
   407|                     $x += $posx;
   408|                     $y += $posy;
   409|                 } else {
   410|                     E('不支持的文字位置类型');
   411|                 }
   412|         }
   413|         /* 设置偏移量 */
   414|         if (is_array($offset)) {
   415|             $offset        = array_map('intval', $offset);
   416|             list($ox, $oy) = $offset;
   417|         } else {
   418|             $offset = intval($offset);
   419|             $ox     = $oy     = $offset;
   420|         }
   421|         /* 设置颜色 */
   422|         if (is_string($color) && 0 === strpos($color, '#')) {
   423|             $color = str_split(substr($color, 1), 2);
   424|             $color = array_map('hexdec', $color);


# ====================================================================
# FILE: ThinkPHP/Library/Think/Image/Driver/Imagick.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 40-81 ---
    40|         );
    41|     }
    42|     /**
    43|      * 保存图像
    44|      * @param  string  $imgname   图像保存名称
    45|      * @param  string  $type      图像类型
    46|      * @param  integer $quality   JPEG图像质量
    47|      * @param  boolean $interlace 是否对JPEG类型图像设置隔行扫描
    48|      */
    49|     public function save($imgname, $type = null, $quality = 80, $interlace = true)
    50|     {
    51|         if (empty($this->img)) {
    52|             E('没有可以被保存的图像资源');
    53|         }
    54|         if (is_null($type)) {
    55|             $type = $this->info['type'];
    56|         } else {
    57|             $type = strtolower($type);
    58|             $this->img->setImageFormat($type);
    59|         }
    60|         if ('jpeg' == $type || 'jpg' == $type || 'png' == $type) {
    61|             $this->img->setImageInterlaceScheme(\Imagick::INTERLACE_PLANE);
    62|         }
    63|         $this->img->setImageCompressionQuality($quality);
    64|         $this->img->stripImage();
    65|         $imgname = realpath(dirname($imgname)) . '/' . basename($imgname); //强制绝对路径
    66|         if ('gif' == $type) {
    67|             $this->img->writeImages($imgname, true);
    68|         } else {
    69|             $this->img->writeImage($imgname);
    70|         }
    71|     }
    72|     /**
    73|      * 返回图像宽度
    74|      * @return integer 图像宽度
    75|      */
    76|     public function width()
    77|     {
    78|         if (empty($this->img)) {
    79|             E('没有指定图像资源');
    80|         }
    81|         return $this->info['width'];


# ====================================================================
# FILE: ThinkPHP/Library/Think/Model.class.php
# Total hunks: 10
# ====================================================================
# --- HUNK 1: Lines 15-142 ---
    15|     protected $db = null;
    16|     private $_db = array();
    17|     protected $pk = 'id';
    18|     protected $autoinc = false;
    19|     protected $tablePrefix = null;
    20|     protected $name = '';
    21|     protected $dbName = '';
    22|     protected $connection = '';
    23|     protected $tableName = '';
    24|     protected $trueTableName = '';
    25|     protected $error = '';
    26|     protected $fields = array();
    27|     protected $data = array();
    28|     protected $options   = array();
    29|     protected $_validate = array(); // 自动验证定义
    30|     protected $_auto     = array(); // 自动完成定义
    31|     protected $_map      = array(); // 字段映射定义
    32|     protected $_scope    = array(); // 命名范围定义
    33|     protected $autoCheckFields = true;
    34|     protected $patchValidate = false;
    35|     protected $methods = array('strict', 'order', 'alias', 'having', 'group', 'lock', 'distinct', 'auto', 'filter', 'validate', 'result', 'token', 'index', 'force', 'master');
    36|     /**
    37|      * 架构函数
    38|      * 取得DB类的实例对象 字段检查
    39|      * @access public
    40|      * @param string $name 模型名称
    41|      * @param string $tablePrefix 表前缀
    42|      * @param mixed $connection 数据库连接信息
    43|      */
    44|     public function __construct($name = '', $tablePrefix = '', $connection = '')
    45|     {
    46|         $this->_initialize();
    47|         if (!empty($name)) {
    48|             if (strpos($name, '.')) {
    49|                 list($this->dbName, $this->name) = explode('.', $name);
    50|             } else {
    51|                 $this->name = $name;
    52|             }
    53|         } elseif (empty($this->name)) {
    54|             $this->name = $this->getModelName();
    55|         }
    56|         if (is_null($tablePrefix)) {
    57|             $this->tablePrefix = '';
    58|         } elseif ('' != $tablePrefix) {
    59|             $this->tablePrefix = $tablePrefix;
    60|         } elseif (!isset($this->tablePrefix)) {
    61|             $this->tablePrefix = !empty($this->connection) && !is_null(C($this->connection . '.DB_PREFIX')) ? C($this->connection . '.DB_PREFIX') : C('DB_PREFIX');
    62|         }
    63|         $this->db(0, empty($this->connection) ? $connection : $this->connection, true);
    64|     }
    65|     /**
    66|      * 自动检测数据表信息
    67|      * @access protected
    68|      * @return void
    69|      */
    70|     protected function _checkTableInfo()
    71|     {
    72|         if (empty($this->fields)) {
    73|             if (C('DB_FIELDS_CACHE')) {
    74|                 $fields = F('_fields/' . strtolower($this->getTableName()));
    75|                 if ($fields) {
    76|                     $this->fields = $fields;
    77|                     if (!empty($fields['_pk'])) {
    78|                         $this->pk = $fields['_pk'];
    79|                     }
    80|                     return;
    81|                 }
    82|             }
    83|             $this->flush();
    84|         }
    85|     }
    86|     /**
    87|      * 获取字段信息并缓存
    88|      * @access public
    89|      * @return void
    90|      */
    91|     public function flush()
    92|     {
    93|         $this->db->setModel($this->name);
    94|         $tableName = $this->getTableName();
    95|         $fields    = $this->db->getFields($tableName);
    96|         if (!$fields) {
    97|             return false;
    98|         }
    99|         $this->fields = array_keys($fields);
   100|         unset($this->fields['_pk']);
   101|         foreach ($fields as $key => $val) {
   102|             $type[$key] = $val['type'];
   103|             if ($val['primary']) {
   104|                 if (isset($this->fields['_pk']) && null != $this->fields['_pk']) {
   105|                     if (is_string($this->fields['_pk'])) {
   106|                         $this->pk            = array($this->fields['_pk']);
   107|                         $this->fields['_pk'] = $this->pk;
   108|                     }
   109|                     $this->pk[]            = $key;
   110|                     $this->fields['_pk'][] = $key;
   111|                 } else {
   112|                     $this->pk            = $key;
   113|                     $this->fields['_pk'] = $key;
   114|                 }
   115|                 if ($val['autoinc']) {
   116|                     $this->autoinc = true;
   117|                 }
   118|             }
   119|         }
   120|         $this->fields['_type'] = $type;
   121|         if (C('DB_FIELDS_CACHE')) {
   122|             F('_fields/' . strtolower($tableName), $this->fields);
   123|         }
   124|     }
   125|     /**
   126|      * 设置数据对象的值
   127|      * @access public
   128|      * @param string $name 名称
   129|      * @param mixed $value 值
   130|      * @return void
   131|      */
   132|     public function __set($name, $value)
   133|     {
   134|         $this->data[$name] = $value;
   135|     }
   136|     /**
   137|      * 获取数据对象的值
   138|      * @access public
   139|      * @param string $name 名称
   140|      * @return mixed
   141|      */
   142|     public function __get($name)

# --- HUNK 2: Lines 389-509 ---
   389|      * @access public
   390|      * @param mixed $options 表达式
   391|      * @return mixed
   392|      */
   393|     public function delete($options = array())
   394|     {
   395|         $pk = $this->getPk();
   396|         if (empty($options) && empty($this->options['where'])) {
   397|             if (!empty($this->data) && isset($this->data[$pk])) {
   398|                 return $this->delete($this->data[$pk]);
   399|             } else {
   400|                 return false;
   401|             }
   402|         }
   403|         if (is_numeric($options) || is_string($options)) {
   404|             if (strpos($options, ',')) {
   405|                 $where[$pk] = array('IN', $options);
   406|             } else {
   407|                 $where[$pk] = $options;
   408|             }
   409|             $this->options['where'] = $where;
   410|         }
   411|         if (is_array($options) && (count($options) > 0) && is_array($pk)) {
   412|             $count = 0;
   413|             foreach (array_keys($options) as $key) {
   414|                 if (is_int($key)) {
   415|                     $count++;
   416|                 }
   417|             }
   418|             if (count($pk) == $count) {
   419|                 $i = 0;
   420|                 foreach ($pk as $field) {
   421|                     $where[$field] = $options[$i];
   422|                     unset($options[$i++]);
   423|                 }
   424|                 $this->options['where'] = $where;
   425|             } else {
   426|                 return false;
   427|             }
   428|         }
   429|         $options = $this->_parseOptions();
   430|         if (empty($options['where'])) {
   431|             return false;
   432|         }
   433|         if (is_array($options['where']) && isset($options['where'][$pk])) {
   434|             $pkValue = $options['where'][$pk];
   435|         }
   436|         if (false === $this->_before_delete($options)) {
   437|             return false;
   438|         }
   439|         $result = $this->db->delete($options);
   440|         if (false !== $result && is_numeric($result)) {
   441|             $data = array();
   442|             if (isset($pkValue)) {
   443|                 $data[$pk] = $pkValue;
   444|             }
   445|             $this->_after_delete($data, $options);
   446|         }
   447|         return $result;
   448|     }
   449|     protected function _before_delete($options)
   450|     {}
   451|     protected function _after_delete($data, $options)
   452|     {}
   453|     /**
   454|      * 查询数据集
   455|      * @access public
   456|      * @param array $options 表达式参数
   457|      * @return mixed
   458|      */
   459|     public function select($options = array())
   460|     {
   461|         $pk = $this->getPk();
   462|         if (is_string($options) || is_numeric($options)) {
   463|             if (strpos($options, ',')) {
   464|                 $where[$pk] = array('IN', $options);
   465|             } else {
   466|                 $where[$pk] = $options;
   467|             }
   468|             $this->options['where'] = $where;
   469|         } elseif (is_array($options) && (count($options) > 0) && is_array($pk)) {
   470|             $count = 0;
   471|             foreach (array_keys($options) as $key) {
   472|                 if (is_int($key)) {
   473|                     $count++;
   474|                 }
   475|             }
   476|             if (count($pk) == $count) {
   477|                 $i = 0;
   478|                 foreach ($pk as $field) {
   479|                     $where[$field] = $options[$i];
   480|                     unset($options[$i++]);
   481|                 }
   482|                 $this->options['where'] = $where;
   483|             } else {
   484|                 return false;
   485|             }
   486|         } elseif (false === $options) {
   487|             $this->options['fetch_sql'] = true;
   488|         }
   489|         $options = $this->_parseOptions();
   490|         if (isset($options['cache'])) {
   491|             $cache = $options['cache'];
   492|             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
   493|             $data  = S($key, '', $cache);
   494|             if (false !== $data) {
   495|                 return $data;
   496|             }
   497|         }
   498|         $resultSet = $this->db->select($options);
   499|         if (false === $resultSet) {
   500|             return false;
   501|         }
   502|         if (!empty($resultSet)) {
   503|             if (is_string($resultSet)) {
   504|                 return $resultSet;
   505|             }
   506|             $resultSet = array_map(array($this, '_read_data'), $resultSet);
   507|             $this->_after_select($resultSet, $options);
   508|             if (isset($options['index'])) {
   509|                 $index = explode(',', $options['index']);

# --- HUNK 3: Lines 545-584 ---
   545|         if (is_array($options)) {
   546|             $options = array_merge($this->options, $options);
   547|         }
   548|         if (!isset($options['table'])) {
   549|             $options['table'] = $this->getTableName();
   550|             $fields           = $this->fields;
   551|         } else {
   552|             $fields = $this->getDbFields();
   553|         }
   554|         if (!empty($options['alias'])) {
   555|             $options['table'] .= ' ' . $options['alias'];
   556|         }
   557|         $options['model'] = $this->name;
   558|         if (isset($options['where']) && is_array($options['where']) && !empty($fields) && !isset($options['join'])) {
   559|             foreach ($options['where'] as $key => $val) {
   560|                 $key = trim($key);
   561|                 if (in_array($key, $fields, true)) {
   562|                     if (is_scalar($val)) {
   563|                         $this->_parseType($options['where'], $key);
   564|                     }
   565|                 }
   566|             }
   567|         }
   568|         $this->options = array();
   569|         $this->_options_filter($options);
   570|         return $options;
   571|     }
   572|     protected function _options_filter(&$options)
   573|     {}
   574|     /**
   575|      * 数据类型检测
   576|      * @access protected
   577|      * @param mixed $data 数据
   578|      * @param string $key 字段名
   579|      * @return void
   580|      */
   581|     protected function _parseType(&$data, $key)
   582|     {
   583|         if (!isset($this->options['bind'][':' . $key]) && isset($this->fields['_type'][$key])) {
   584|             $fieldType = strtolower($this->fields['_type'][$key]);

# --- HUNK 4: Lines 603-688 ---
   603|         if (!empty($this->_map) && C('READ_DATA_MAP')) {
   604|             foreach ($this->_map as $key => $val) {
   605|                 if (isset($data[$val])) {
   606|                     $data[$key] = $data[$val];
   607|                     unset($data[$val]);
   608|                 }
   609|             }
   610|         }
   611|         return $data;
   612|     }
   613|     /**
   614|      * 查询数据
   615|      * @access public
   616|      * @param mixed $options 表达式参数
   617|      * @return mixed
   618|      */
   619|     public function find($options = array())
   620|     {
   621|         if (is_numeric($options) || is_string($options)) {
   622|             $where[$this->getPk()] = $options;
   623|             $this->options['where'] = $where;
   624|         }
   625|         $pk = $this->getPk();
   626|         if (is_array($options) && (count($options) > 0) && is_array($pk)) {
   627|             $count = 0;
   628|             foreach (array_keys($options) as $key) {
   629|                 if (is_int($key)) {
   630|                     $count++;
   631|                 }
   632|             }
   633|             if (count($pk) == $count) {
   634|                 $i = 0;
   635|                 foreach ($pk as $field) {
   636|                     $where[$field] = $options[$i];
   637|                     unset($options[$i++]);
   638|                 }
   639|                 $this->options['where'] = $where;
   640|             } else {
   641|                 return false;
   642|             }
   643|         }
   644|         $this->options['limit'] = 1;
   645|         $options = $this->_parseOptions();
   646|         if (isset($options['cache'])) {
   647|             $cache = $options['cache'];
   648|             $key   = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
   649|             $data  = S($key, '', $cache);
   650|             if (false !== $data) {
   651|                 $this->data = $data;
   652|                 return $data;
   653|             }
   654|         }
   655|         $resultSet = $this->db->select($options);
   656|         if (false === $resultSet) {
   657|             return false;
   658|         }
   659|         if (empty($resultSet)) {
   660|             return null;
   661|         }
   662|         if (is_string($resultSet)) {
   663|             return $resultSet;
   664|         }
   665|         $data = $this->_read_data($resultSet[0]);
   666|         $this->_after_find($data, $options);
   667|         if (!empty($options['result'])) {
   668|             return $this->returnResult($data, $options['result']);
   669|         }
   670|         $this->data = $data;
   671|         if (isset($cache)) {
   672|             S($key, $data, $cache);
   673|         }
   674|         return $this->data;
   675|     }
   676|     protected function _after_find(&$result, $options)
   677|     {}
   678|     protected function returnResult($data, $type = '')
   679|     {
   680|         if ($type) {
   681|             if (is_callable($type)) {
   682|                 return call_user_func($type, $data);
   683|             }
   684|             switch (strtolower($type)) {
   685|                 case 'json':
   686|                     return json_encode($data);
   687|                 case 'xml':
   688|                     return xml_encode($data);

# --- HUNK 5: Lines 777-822 ---
   777|         }
   778|         return $this->setField($field, array('exp', $field . '-' . $step));
   779|     }
   780|     /**
   781|      * 延时更新检查 返回false表示需要延时
   782|      * 否则返回实际写入的数值
   783|      * @access public
   784|      * @param string $guid  写入标识
   785|      * @param integer $step  写入步进值
   786|      * @param integer $lazyTime  延时时间(s)
   787|      * @return false|integer
   788|      */
   789|     protected function lazyWrite($guid, $step, $lazyTime)
   790|     {
   791|         if (false !== ($value = S($guid))) {
   792|             if (NOW_TIME > S($guid . '_time') + $lazyTime) {
   793|                 S($guid, null);
   794|                 S($guid . '_time', null);
   795|                 return $value + $step;
   796|             } else {
   797|                 S($guid, $value + $step, 0);
   798|                 return false;
   799|             }
   800|         } else {
   801|             S($guid, $step, 0);
   802|             S($guid . '_time', NOW_TIME, 0);
   803|             return false;
   804|         }
   805|     }
   806|     /**
   807|      * 获取一条记录的某个字段值
   808|      * @access public
   809|      * @param string $field  字段名
   810|      * @param string $spea  字段数据间隔符号 NULL返回数组
   811|      * @return mixed
   812|      */
   813|     public function getField($field, $sepa = null)
   814|     {
   815|         $options['field'] = $field;
   816|         $options          = $this->_parseOptions($options);
   817|         if (isset($options['cache'])) {
   818|             $cache = $options['cache'];
   819|             $key   = is_string($cache['key']) ? $cache['key'] : md5($sepa . serialize($options));
   820|             $data  = S($key, '', $cache);
   821|             if (false !== $data) {
   822|                 return $data;

# --- HUNK 6: Lines 888-936 ---
   888|     public function create($data = '', $type = '')
   889|     {
   890|         if (empty($data)) {
   891|             $data = I('post.');
   892|         } elseif (is_object($data)) {
   893|             $data = get_object_vars($data);
   894|         }
   895|         if (empty($data) || !is_array($data)) {
   896|             $this->error = L('_DATA_TYPE_INVALID_');
   897|             return false;
   898|         }
   899|         $type = $type ?: (!empty($data[$this->getPk()]) ? self::MODEL_UPDATE : self::MODEL_INSERT);
   900|         $data = $this->parseFieldsMap($data, 0);
   901|         if (isset($this->options['field'])) {
   902|             $fields = $this->options['field'];
   903|             unset($this->options['field']);
   904|         } elseif (self::MODEL_INSERT == $type && isset($this->insertFields)) {
   905|             $fields = $this->insertFields;
   906|         } elseif (self::MODEL_UPDATE == $type && isset($this->updateFields)) {
   907|             $fields = $this->updateFields;
   908|             $pk     = $this->getPk();
   909|             if (is_string($pk)) {
   910|                 array_push($fields, $pk);
   911|             }
   912|             if (is_array($pk)) {
   913|                 foreach ($pk as $pkTemp) {
   914|                     array_push($fields, $pkTemp);
   915|                 }
   916|             }
   917|         }
   918|         if (isset($fields)) {
   919|             if (is_string($fields)) {
   920|                 $fields = explode(',', $fields);
   921|             }
   922|             if (C('TOKEN_ON')) {
   923|                 $fields[] = C('TOKEN_NAME', null, '__hash__');
   924|             }
   925|             foreach ($data as $key => $val) {
   926|                 if (!in_array($key, $fields)) {
   927|                     unset($data[$key]);
   928|                 }
   929|             }
   930|         }
   931|         if (!$this->autoValidation($data, $type)) {
   932|             return false;
   933|         }
   934|         if (!$this->autoCheckToken($data)) {
   935|             $this->error = L('_TOKEN_ERROR_');
   936|             return false;


# ====================================================================
# FILE: ThinkPHP/Library/Think/Model/MongoModel.class.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 91-235 ---
    91|         $this->options['where'] = array_merge((array) $this->options['where'], $where);
    92|         $command = array(
    93|             "distinct" => $this->options['table'],
    94|             "key"      => $field,
    95|             "query"    => $this->options['where'],
    96|         );
    97|         $result = $this->command($command);
    98|         return isset($result['values']) ? $result['values'] : false;
    99|     }
   100|     /**
   101|      * 获取下一ID 用于自动增长型
   102|      * @access public
   103|      * @param string $pk 字段名 默认为主键
   104|      * @return mixed
   105|      */
   106|     public function getMongoNextId($pk = '')
   107|     {
   108|         if (empty($pk)) {
   109|             $pk = $this->getPk();
   110|         }
   111|         $options = $this->_parseOptions();
   112|         return $this->db->getMongoNextId($pk,$options);
   113|     }
   114|     /**
   115|      * 新增数据
   116|      * @access public
   117|      * @param mixed $data 数据
   118|      * @param array $options 表达式
   119|      * @param boolean $replace 是否replace
   120|      * @return mixed
   121|      */
   122|     public function add($data = '', $options = array(), $replace = false)
   123|     {
   124|         if (empty($data)) {
   125|             if (!empty($this->data)) {
   126|                 $data = $this->data;
   127|                 $this->data = array();
   128|             } else {
   129|                 $this->error = L('_DATA_TYPE_INVALID_');
   130|                 return false;
   131|             }
   132|         }
   133|         $options = $this->_parseOptions($options);
   134|         $data = $this->_facade($data);
   135|         if (false === $this->_before_insert($data, $options)) {
   136|             return false;
   137|         }
   138|         $result = $this->db->insert($data, $options, $replace);
   139|         if (false !== $result) {
   140|             $this->_after_insert($data, $options);
   141|             if (isset($data[$this->getPk()])) {
   142|                 return $data[$this->getPk()];
   143|             }
   144|         }
   145|         return $result;
   146|     }
   147|     protected function _before_insert(&$data, $options)
   148|     {
   149|         if ($this->_autoinc && self::TYPE_INT == $this->_idType) {
   150|             $pk = $this->getPk();
   151|             if (!isset($data[$pk])) {
   152|                 $data[$pk] = $this->db->getMongoNextId($pk, $options);
   153|             }
   154|         }
   155|     }
   156|     public function clear()
   157|     {
   158|         return $this->db->clear();
   159|     }
   160|     protected function _after_select(&$resultSet, $options)
   161|     {
   162|         array_walk($resultSet, array($this, 'checkMongoId'));
   163|     }
   164|     /**
   165|      * 获取MongoId
   166|      * @access protected
   167|      * @param array $result 返回数据
   168|      * @return array
   169|      */
   170|     protected function checkMongoId(&$result)
   171|     {
   172|         if (is_object($result['_id'])) {
   173|             $result['_id'] = $result['_id']->__toString();
   174|         }
   175|         return $result;
   176|     }
   177|     protected function _options_filter(&$options)
   178|     {
   179|         $id = $this->getPk();
   180|         if (isset($options['where'][$id]) && is_scalar($options['where'][$id]) && self::TYPE_OBJECT == $this->_idType) {
   181|             $options['where'][$id] = new \MongoId($options['where'][$id]);
   182|         }
   183|     }
   184|     /**
   185|      * 查询多行数据
   186|      * @access public
   187|      * @param mixed $options 表达式参数
   188|      * @return mixed
   189|      */
   190|     public function select($options = array())
   191|     {
   192|         if( is_numeric($options) || is_string($options)) {
   193|             $id = $this->getPk();
   194|             $where[$id] = $options;
   195|             $options = array();
   196|             $options['where'] = $where;
   197|         }
   198|         $options = $this->_parseOptions($options);
   199|         $result = $this->db->select($options);
   200|         if(false === $result) {
   201|             return false;
   202|         }
   203|         if(empty($result)) {// 查询结果为空
   204|             return null;
   205|         }
   206|         else{
   207|             $this->checkMongoId($result);
   208|         }
   209|         $data = array();
   210|         foreach($result as $v){
   211|             $data[] = $v;
   212|         }
   213|         $this->data = $data;
   214|         $this->_after_select($this->data, $options);
   215|         return $this->data;
   216|     }
   217|     /**
   218|      * 查询数据
   219|      * @access public
   220|      * @param mixed $options 表达式参数
   221|      * @return mixed
   222|      */
   223|     public function find($options = array())
   224|     {
   225|         if (is_numeric($options) || is_string($options)) {
   226|             $id               = $this->getPk();
   227|             $where[$id]       = $options;
   228|             $options          = array();
   229|             $options['where'] = $where;
   230|         }
   231|         $options = $this->_parseOptions($options);
   232|         $result  = $this->db->find($options);
   233|         if (false === $result) {
   234|             return false;
   235|         }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Model/ViewModel.class.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 12-52 ---
    12|      * @access protected
    13|      * @return void
    14|      */
    15|     protected function _checkTableInfo()
    16|     {}
    17|     /**
    18|      * 得到完整的数据表名
    19|      * @access public
    20|      * @return string
    21|      */
    22|     public function getTableName()
    23|     {
    24|         if (empty($this->trueTableName)) {
    25|             $tableName = '';
    26|             foreach ($this->viewFields as $key => $view) {
    27|                 if (isset($view['_table'])) {
    28|                     $tableName .= $view['_table'];
    29|                     $prefix    = $this->tablePrefix;
    30|                     $tableName = preg_replace_callback("/__([A-Z_-]+)__/sU", function ($match) use ($prefix) {return $prefix . strtolower($match[1]);}, $tableName);
    31|                 } else {
    32|                     $class = parse_res_name($key, C('DEFAULT_M_LAYER'));
    33|                     $Model = class_exists($class) ? new $class() : M($key);
    34|                     $tableName .= $Model->getTableName();
    35|                 }
    36|                 $tableName .= !empty($view['_as']) ? ' ' . $view['_as'] : ' ' . $key;
    37|                 $tableName .= !empty($view['_on']) ? ' ON ' . $view['_on'] : '';
    38|                 $type = !empty($view['_type']) ? $view['_type'] : '';
    39|                 $tableName .= ' ' . strtoupper($type) . ' JOIN ';
    40|                 $len = strlen($type . '_JOIN ');
    41|             }
    42|             $tableName           = substr($tableName, 0, -$len);
    43|             $this->trueTableName = $tableName;
    44|         }
    45|         return $this->trueTableName;
    46|     }
    47|     /**
    48|      * 表达式过滤方法
    49|      * @access protected
    50|      * @param string $options 表达式
    51|      * @return void
    52|      */

# --- HUNK 2: Lines 67-178 ---
    67|             $options['order'] = $this->checkOrder($options['order']);
    68|         }
    69|     }
    70|     /**
    71|      * 检查是否定义了所有字段
    72|      * @access protected
    73|      * @param string $name 模型名称
    74|      * @param array $fields 字段数组
    75|      * @return array
    76|      */
    77|     private function _checkFields($name, $fields)
    78|     {
    79|         if (false !== $pos = array_search('*', $fields)) {
    80|             $fields = array_merge($fields, M($name)->getDbFields());
    81|             unset($fields[$pos]);
    82|         }
    83|         return $fields;
    84|     }
    85|     /**
    86|      * 检查条件中的视图字段
    87|      * @param $where 条件表达式
    88|      * @return array
    89|      */
    90|     protected function checkCondition($where)
    91|     {
    92|         if (is_array($where)) {
    93|             $fields = $field_map_table = array();
    94|             foreach ($this->viewFields as $key => $val) {
    95|                 $table_alias = isset($val['_as']) ? $val['_as'] : $key;
    96|                 $val         = $this->_checkFields($key, $val);
    97|                 foreach ($val as $as_name => $v) {
    98|                     if (is_numeric($as_name)) {
    99|                         $fields[]          = $v; //所有表字段集合
   100|                         $field_map_table[] = $table_alias; //所有表字段对应表名集合
   101|                     } else {
   102|                         $fields[$as_name]          = $v;
   103|                         $field_map_table[$as_name] = $table_alias;
   104|                     }
   105|                 }
   106|             }
   107|             $where = $this->_parseWhere($where, $fields, $field_map_table);
   108|         }
   109|         return $where;
   110|     }
   111|     /**
   112|      * 解析where表达式
   113|      * @param $where
   114|      * @param $fields
   115|      * @param $field_map_table
   116|      * @return array
   117|      */
   118|     private function _parseWhere($where, $fields, $field_map_table)
   119|     {
   120|         $view = array();
   121|         foreach ($where as $name => $val) {
   122|             if ('_complex' == $name) {
   123|                 foreach ($val as $k => $v) {
   124|                     if (false === strpos(substr($k, 0, 1), '_')) {
   125|                         if (false !== $field = array_search($k, $fields, true)) { // 存在视图字段
   126|                             $k = is_numeric($field) ? $field_map_table[$field] . '.' . $k : $field_map_table[$field] . '.' . $field; //字段别名
   127|                         }
   128|                     } else if (is_array($v)) {
   129|                         $v = $this->_parseWhere($val[$k], $fields, $field_map_table);
   130|                     }
   131|                     $view[$name][$k] = $v;
   132|                 }
   133|             } else {
   134|                 if (strpos($name, '|')) {
   135|                     $arr = explode('|', $name);
   136|                     foreach ($arr as $k => $v) {
   137|                         if (false !== $field = array_search($v, $fields, true)) {
   138|                             $arr[$k] = is_numeric($field) ? $field_map_table[$field] . '.' . $v : $field_map_table[$field] . '.' . $field;
   139|                         }
   140|                     }
   141|                     $view[implode('|', $arr)] = $val;
   142|                 } else if (strpos($name, '&')) {
   143|                     $arr = explode('&', $name);
   144|                     foreach ($arr as $k => $v) {
   145|                         if (false !== $field = array_search($v, $fields, true)) {
   146|                             $arr[$k] = is_numeric($field) ? $field_map_table[$field] . '.' . $v : $field_map_table[$field] . '.' . $field;
   147|                         }
   148|                     }
   149|                     $view[implode('&', $arr)] = $val;
   150|                 } else {
   151|                     if (false !== $field = array_search($name, $fields, true)) {
   152|                         $name = is_numeric($field) ? $field_map_table[$field] . '.' . $name : $field_map_table[$field] . '.' . $field;
   153|                     }
   154|                     $view[$name] = $val;
   155|                 }
   156|             }
   157|         }
   158|         return $view;
   159|     }
   160|     /**
   161|      * 检查Order表达式中的视图字段
   162|      * @access protected
   163|      * @param string $order 字段
   164|      * @return string
   165|      */
   166|     protected function checkOrder($order = '')
   167|     {
   168|         if (is_string($order) && !empty($order)) {
   169|             $orders = explode(',', $order);
   170|             $_order = array();
   171|             foreach ($orders as $order) {
   172|                 $array = explode(' ', trim($order));
   173|                 $field = $array[0];
   174|                 $sort  = isset($array[1]) ? $array[1] : 'ASC';
   175|                 foreach ($this->viewFields as $name => $val) {
   176|                     $k   = isset($val['_as']) ? $val['_as'] : $name;
   177|                     $val = $this->_checkFields($name, $val);
   178|                     if (false !== $_field = array_search($field, $val, true)) {


# ====================================================================
# FILE: ThinkPHP/Library/Think/Route.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-410 ---
     1| <?php
     2| namespace Think;
     3| /**
     4|  * ThinkPHP路由解析类
     5|  */
     6| class Route
     7| {
     8|     /**
     9|      * 路由检测
    10|      * @param  array $paths path_info数组
    11|      * @return boolean
    12|      */
    13|     public static function check($paths = array())
    14|     {
    15|         $rules = self::ruleCache();
    16|         if (!empty($paths)) {
    17|             $regx = implode('/', $paths);
    18|         } else {
    19|             $depr = C('URL_PATHINFO_DEPR');
    20|             $regx = preg_replace('/\.' . __EXT__ . '$/i', '', trim($_SERVER['PATH_INFO'], $depr));
    21|             if (!$regx) {
    22|                 return false;
    23|             }
    24|             if ('/' != $depr) {
    25|                 $regx = str_replace($depr, '/', $regx);
    26|             }
    27|         }
    28|         if (isset($rules[0][$regx])) {
    29|             $route = $rules[0][$regx];
    30|             $_SERVER['PATH_INFO'] = $route[0];
    31|             $args = array_pop($route);
    32|             if (!empty($route[1])) {
    33|                 $args = array_merge($args, $route[1]);
    34|             }
    35|             $_GET = array_merge($args, $_GET);
    36|             return true;
    37|         }
    38|         if (!empty($rules[1])) {
    39|             foreach ($rules[1] as $rule => $route) {
    40|                 $args = array_pop($route);
    41|                 if (isset($route[2])) {
    42|                     if (!self::checkOption($route[2], __EXT__)) {
    43|                         continue;
    44|                     }
    45|                 }
    46|                 if ($matches = self::checkUrlMatch($rule, $args, $regx)) {
    47|                     if ($route[0] instanceof \Closure) {
    48|                         $result = self::invoke($route[0], $matches);
    49|                         return is_bool($result) ? $result : exit;
    50|                     } else {
    51|                         if (strpos($route[0], ':')) {
    52|                             $matches = array_values($matches);
    53|                             $route[0] = preg_replace_callback('/:(\d+)/', function ($match) use (&$matches) {
    54|                                 return $matches[$match[1] - 1];
    55|                             }, $route[0]);
    56|                         }
    57|                         if ('/' == substr($rule, 0, 1)) {
    58|                             $rule_params = array();
    59|                             foreach($route[1] as $param_key => $param)
    60|                             {
    61|                                 list($param_name,$param_value) = explode('=', $param,2);
    62|                                 if(!is_null($param_value))
    63|                                 {
    64|                                     if(preg_match('/^:(\d*)$/',$param_value, $match_index))
    65|                                     {
    66|                                         $match_index = $match_index[1]-1;
    67|                                         $param_value = $matches[$match_index];
    68|                                     }
    69|                                     $rule_params[$param_name] = $param_value;
    70|                                     unset($route[1][$param_key]);
    71|                                 }
    72|                             }
    73|                             $route[1] = $rule_params;
    74|                         }
    75|                         if ('/' == substr($route[0], 0, 1)) {
    76|                             header("Location: $route[0]", true, $route[1]);
    77|                             exit;
    78|                         } else {
    79|                             $depr = C('URL_PATHINFO_DEPR');
    80|                             if ('/' != $depr) {
    81|                                 $route[0] = str_replace('/', $depr, $route[0]);
    82|                             }
    83|                             $_SERVER['PATH_INFO'] = $route[0];
    84|                             if (!empty($route[1])) {
    85|                                 $_GET = array_merge($route[1], $_GET);
    86|                             }
    87|                             return true;
    88|                         }
    89|                     }
    90|                 }
    91|             }
    92|         }
    93|         return false;
    94|     }
    95|     /**
    96|      * 路由反向解析
    97|      * @param  string $path 控制器/方法
    98|      * @param  array $vars url参数
    99|      * @param  string $depr 分隔符
   100|      * @param  string|true $suffix url后缀
   101|      * @return string|false
   102|      */
   103|     public static function reverse($path, &$vars, $depr, $suffix = true)
   104|     {
   105|         static $_rules;
   106|         if (is_null($_rules)) {
   107|             if ($rules = self::ruleCache()) {
   108|                 foreach ($rules as $i => $rules2) {
   109|                     foreach ($rules2 as $rule => $route) {
   110|                         if (is_array($route) && is_string($route[0]) && '/' != substr($route[0], 0, 1)) {
   111|                             $_rules[$i][$route[0]][$rule] = $route;
   112|                         }
   113|                     }
   114|                 }
   115|             }
   116|         }
   117|         if (isset($_rules[0][$path])) {
   118|             foreach ($_rules[0][$path] as $rule => $route) {
   119|                 $args = array_pop($route);
   120|                 if (count($vars) == count($args) && !empty($vars) && !array_diff($vars, $args)) {
   121|                     return str_replace('/', $depr, $rule);
   122|                 }
   123|             }
   124|         }
   125|         if (isset($_rules[1][$path])) {
   126|             foreach ($_rules[1][$path] as $rule => $route) {
   127|                 $args = array_pop($route);
   128|                 $array = array();
   129|                 if (isset($route[2])) {
   130|                     if (!self::checkOption($route[2], $suffix)) {
   131|                         continue;
   132|                     }
   133|                 }
   134|                 if ('/' != substr($rule, 0, 1)) {
   135|                     foreach ($args as $key => $val) {
   136|                         $flag = false;
   137|                         if ($val[0] == 0) {
   138|                             $array[$key] = $key;
   139|                             continue;
   140|                         }
   141|                         if (isset($vars[$key])) {
   142|                             if (!empty($val[2])) {
   143|                                 if ($val[2] == 'int') {
   144|                                     if (!is_numeric($vars[$key]) || !preg_match('/^\d*$/',$vars[$key])) {
   145|                                         break;
   146|                                     }
   147|                                 } else {
   148|                                     if (in_array($vars[$key], $val[2])) {
   149|                                         break;
   150|                                     }
   151|                                 }
   152|                             }
   153|                             $flag = true;
   154|                             $array[$key] = $vars[$key];
   155|                         } elseif ($val[0] == 1) {
   156|                             break;
   157|                         }
   158|                     }
   159|                     if (!empty($flag)) {
   160|                         foreach (array_keys($array) as $key) {
   161|                             $array[$key] = urlencode($array[$key]);
   162|                             unset($vars[$key]);
   163|                         }
   164|                         return implode($depr, $array);
   165|                     }
   166|                 } else {
   167|                     $keys = !empty($args) ? array_keys($args) : array_keys($vars);
   168|                     $temp_vars = $vars;
   169|                     $str = preg_replace_callback('/\(.*?\)/', function ($match) use (&$temp_vars, &$keys) {
   170|                         $k = array_shift($keys);
   171|                         $re_var = '';
   172|                         if(isset($temp_vars[$k]))
   173|                         {
   174|                             $re_var = $temp_vars[$k];
   175|                             unset($temp_vars[$k]);
   176|                         }
   177|                         return urlencode($re_var);
   178|                     }, $rule);
   179|                     $str = substr($str, 1, -1);
   180|                     $str = rtrim(ltrim($str, '^'), '$');
   181|                     $str = str_replace('\\', '', $str);
   182|                     if (preg_match($rule, $str, $matches)) {
   183|                         $vars = $temp_vars;
   184|                         return str_replace('/', $depr, $str);
   185|                     }
   186|                 }
   187|             }
   188|         }
   189|         return false;
   190|     }
   191|     /**
   192|      * 读取规则缓存
   193|      * @param  boolean $update 是否更新
   194|      * @return array
   195|      */
   196|     public static function ruleCache($update = false)
   197|     {
   198|         $result = array();
   199|         $module = defined('MODULE_NAME') ? '_' . MODULE_NAME : '';
   200|         if (APP_DEBUG || $update || !$result = S('url_route_rules' . $module)) {
   201|             $result[0] = C('URL_MAP_RULES');
   202|             if (!empty($result[0])) {
   203|                 foreach ($result[0] as $rule => $route) {
   204|                     if (!is_array($route)) {
   205|                         $route = array($route);
   206|                     }
   207|                     if (strpos($route[0], '?')) {
   208|                         list($route[0], $args) = explode('?', $route[0], 2);
   209|                         parse_str($args, $args);
   210|                     } else {
   211|                         $args = array();
   212|                     }
   213|                     if (!empty($route[1]) && is_string($route[1])) {
   214|                         parse_str($route[1], $route[1]);
   215|                     }
   216|                     $route[] = $args;
   217|                     $result[0][$rule] = $route;
   218|                 }
   219|             }
   220|             $result[1] = C('URL_ROUTE_RULES');
   221|             if (!empty($result[1])) {
   222|                 foreach ($result[1] as $rule => $route) {
   223|                     if (!is_array($route)) {
   224|                         $route = array($route);
   225|                     } elseif (is_numeric($rule)) {
   226|                         $rule = array_shift($route);
   227|                     }
   228|                     if (!empty($route)) {
   229|                         $args = array();
   230|                         if (is_string($route[0])) {
   231|                             if (0 === strpos($route[0], '/') || 0 === strpos($route[0], 'http')) {
   232|                                 if (!isset($route[1])) {
   233|                                     $route[1] = 301;
   234|                                 }
   235|                             } else {
   236|                                 if (!empty($route[1]) && is_string($route[1])) {
   237|                                     parse_str($route[1], $route[1]);
   238|                                 }
   239|                                 if (strpos($route[0], '?')) {
   240|                                     list($route[0], $params) = explode('?', $route[0], 2);
   241|                                     if (!empty($params)) {
   242|                                         foreach (explode('&', $params) as $key => $val) {
   243|                                             if (0 === strpos($val, ':')) {
   244|                                                 $val = substr($val, 1);
   245|                                                 $args[$key] = strpos($val, '|') ? explode('|', $val, 2) : array($val);
   246|                                             } else {
   247|                                                 $route[1][$key] = $val;
   248|                                             }
   249|                                         }
   250|                                     }
   251|                                 }
   252|                             }
   253|                         }
   254|                         if ('/' != substr($rule, 0, 1)) {
   255|                             foreach (explode('/', rtrim($rule, '$')) as $item) {
   256|                                 $filter = $fun = '';
   257|                                 $type = 0;
   258|                                 if (0 === strpos($item, '[:')) {
   259|                                     $type = 2;
   260|                                     $item = substr($item, 1, -1);
   261|                                 }
   262|                                 if (0 === strpos($item, ':')) {
   263|                                     $type = $type ?: 1;
   264|                                     if ($pos = strpos($item, '|')) {
   265|                                         $fun = substr($item, $pos + 1);
   266|                                         $item = substr($item, 1, $pos - 1);
   267|                                     }
   268|                                     if ($pos = strpos($item, '^')) {
   269|                                         $filter = explode('-', substr($item, $pos + 1));
   270|                                         $item = substr($item, 1, $pos - 1);
   271|                                     } elseif (strpos($item, '\\')) {
   272|                                         if ('d' == substr($item, -1)) {
   273|                                             $filter = 'int';
   274|                                         }
   275|                                         $item = substr($item, 1, -2);
   276|                                     } else {
   277|                                         $item = substr($item, 1);
   278|                                     }
   279|                                 }
   280|                                 $args[$item] = array($type, $fun, $filter);
   281|                             }
   282|                         }
   283|                         $route[] = $args;
   284|                         $result[1][$rule] = $route;
   285|                     } else {
   286|                         unset($result[1][$rule]);
   287|                     }
   288|                 }
   289|             }
   290|             S('url_route_rules' . $module, $result);
   291|         }
   292|         return $result;
   293|     }
   294|     /**
   295|      * 路由参数检测
   296|      * @param  array $options 路由参数
   297|      * @param  string|true $suffix URL后缀
   298|      * @return boolean
   299|      */
   300|     private static function checkOption($options, $suffix = true)
   301|     {
   302|         if (isset($options['ext'])) {
   303|             if ($suffix) {
   304|                 $suffix = $suffix === true ? C('URL_HTML_SUFFIX') : $suffix;
   305|                 if ($pos = strpos($suffix, '|')) {
   306|                     $suffix = substr($suffix, 0, $pos);
   307|                 }
   308|             }
   309|             if ($suffix != $options['ext']) {
   310|                 return false;
   311|             }
   312|         }
   313|         if (isset($options['method']) && REQUEST_METHOD != strtoupper($options['method'])) {
   314|             return false;
   315|         }
   316|         if (!empty($options['callback']) && is_callable($options['callback'])) {
   317|             if (false === call_user_func($options['callback'])) {
   318|                 return false;
   319|             }
   320|         }
   321|         return true;
   322|     }
   323|     /**
   324|      * 检测URL和路由规则是否匹配
   325|      * @param  string $rule 路由规则
   326|      * @param  array $args 路由动态变量
   327|      * @param  string $regx URL地址
   328|      * @return array|false
   329|      */
   330|     private static function checkUrlMatch(&$rule, &$args, &$regx)
   331|     {
   332|         $params = array();
   333|         if ('/' == substr($rule, 0, 1)) {
   334|             if (preg_match($rule, $regx, $matches)) {
   335|                 if ($args) { // 存在动态变量
   336|                     foreach ($args as $key => $val) {
   337|                         $params[$key] = isset($val[1]) ? $val[1]($matches[$val[0]]) : $matches[$val[0]];
   338|                     }
   339|                     $regx = substr_replace($regx, '', 0, strlen($matches[0]));
   340|                 }
   341|                 array_shift($matches);
   342|                 return $matches;
   343|             } else {
   344|                 return false;
   345|             }
   346|         } else {
   347|             $paths = explode('/', $regx);
   348|             if ('$' == substr($rule, -1) && count($args) != count($paths)) {
   349|                 return false;
   350|             }
   351|             foreach ($args as $key => $val) {
   352|                 $var = array_shift($paths) ?: '';
   353|                 if ($val[0] == 0) {
   354|                     if (0 !== strcasecmp($key, $var)) {
   355|                         return false;
   356|                     }
   357|                 } else {
   358|                     if (isset($val[2])) {
   359|                         if ($val[2] == 'int') {
   360|                             if (!preg_match('/^\d*$/',$var)) {
   361|                                 return false;
   362|                             }
   363|                         } else {
   364|                             if (in_array($var, $val[2])) {
   365|                                 return false;
   366|                             }
   367|                         }
   368|                     }
   369|                     if (!empty($var)) {
   370|                         $params[$key] = !empty($val[1]) ? $val[1]($var) : $var;
   371|                     } elseif ($val[0] == 1) {
   372|                         return false;
   373|                     }
   374|                 }
   375|             }
   376|             $matches = $params;
   377|             $regx = implode('/', $paths);
   378|         }
   379|         if ($regx) {
   380|             preg_replace_callback('/(\w+)\/([^\/]+)/', function ($match) use (&$params) {
   381|                 $params[strtolower($match[1])] = strip_tags($match[2]);
   382|             }, $regx);
   383|         }
   384|         $_GET = array_merge($params, $_GET);
   385|         return $matches;
   386|     }
   387|     /**
   388|      * 执行闭包方法 支持参数调用
   389|      * @param  function $closure 闭包函数
   390|      * @param  array $var 传给闭包的参数
   391|      * @return boolean
   392|      */
   393|     private static function invoke($closure, $var = array())
   394|     {
   395|         $reflect = new \ReflectionFunction($closure);
   396|         $params = $reflect->getParameters();
   397|         $args = array();
   398|         foreach ($params as $i => $param) {
   399|             $name = $param->getName();
   400|             if (isset($var[$name])) {
   401|                 $args[] = $var[$name];
   402|             } elseif (isset($var[$i])) {
   403|                 $args[] = $var[$i];
   404|             } elseif ($param->isDefaultValueAvailable()) {
   405|                 $args[] = $param->getDefaultValue();
   406|             }
   407|         }
   408|         return $reflect->invokeArgs($args);
   409|     }
   410| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Storage.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-29 ---
     3| class Storage
     4| {
     5|     /**
     6|      * 操作句柄
     7|      * @var string
     8|      * @access protected
     9|      */
    10|     protected static $handler;
    11|     /**
    12|      * 连接分布式文件系统
    13|      * @access public
    14|      * @param string $type 文件类型
    15|      * @param array $options  配置数组
    16|      * @return void
    17|      */
    18|     public static function connect($type = 'File', $options = array())
    19|     {
    20|         $class         = 'Think\\Storage\\Driver\\' . ucwords($type);
    21|         self::$handler = new $class($options);
    22|     }
    23|     public static function __callStatic($method, $args)
    24|     {
    25|         if (method_exists(self::$handler, $method)) {
    26|             return call_user_func_array(array(self::$handler, $method), $args);
    27|         }
    28|     }
    29| }


# ====================================================================
# FILE: ThinkPHP/Library/Think/Think.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-48 ---
     6| class Think
     7| {
     8|     private static $_map = array();
     9|     private static $_instance = array();
    10|     /**
    11|      * 应用程序初始化
    12|      * @access public
    13|      * @return void
    14|      */
    15|     public static function start()
    16|     {
    17|         spl_autoload_register('Think\Think::autoload');
    18|         register_shutdown_function('Think\Think::fatalError');
    19|         set_error_handler('Think\Think::appError');
    20|         set_exception_handler('Think\Think::appException');
    21|         Storage::connect(STORAGE_TYPE);
    22|         $runtimefile = RUNTIME_PATH . APP_MODE . '~runtime.php';
    23|         if (!APP_DEBUG && Storage::has($runtimefile)) {
    24|             Storage::load($runtimefile);
    25|         } else {
    26|             /*if (Storage::has($runtimefile)) {
    27|                 Storage::unlink($runtimefile);
    28|             }*/
    29|             $content = '';
    30|             $mode = include is_file(CONF_PATH . 'core.php') ? CONF_PATH . 'core.php' : MODE_PATH . APP_MODE . '.php';
    31|             foreach ($mode['core'] as $file) {
    32|                 if (is_file($file)) {
    33|                     include $file;
    34|                     if (!APP_DEBUG) {
    35|                         $content .= compile($file);
    36|                     }
    37|                 }
    38|             }
    39|             foreach ($mode['config'] as $key => $file) {
    40|                 is_numeric($key) ? C(load_config($file)) : C($key, load_config($file));
    41|             }
    42|             if ('common' != APP_MODE && is_file(CONF_PATH . 'config_' . APP_MODE . CONF_EXT)) {
    43|                 C(load_config(CONF_PATH . 'config_' . APP_MODE . CONF_EXT));
    44|             }
    45|             if (isset($mode['alias'])) {
    46|                 self::addMap(is_array($mode['alias']) ? $mode['alias'] : include $mode['alias']);
    47|             }
    48|             if (is_file(CONF_PATH . 'alias.php')) {


# ====================================================================
# FILE: ThinkPHP/Library/Think/View.class.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 87-153 ---
    87|      * 解析和获取模板内容 用于输出
    88|      * @access public
    89|      * @param string $templateFile 模板文件名
    90|      * @param string $content 模板输出内容
    91|      * @param string $prefix 模板缓存前缀
    92|      * @return string
    93|      */
    94|     public function fetch($templateFile = '', $content = '', $prefix = '')
    95|     {
    96|         if (empty($content)) {
    97|             $templateFile = $this->parseTemplate($templateFile);
    98|             if (!is_file($templateFile)) {
    99|                 E(L('_TEMPLATE_NOT_EXIST_') . ':' . $templateFile);
   100|             }
   101|         } else {
   102|             defined('THEME_PATH') or define('THEME_PATH', $this->getThemePath());
   103|         }
   104|         ob_start();
   105|         ob_implicit_flush(0);
   106|         if ('php' == strtolower(C('TMPL_ENGINE_TYPE'))) {
   107|             if (empty($content)) {
   108|                 if (isset($this->tVar['templateFile'])) {
   109|                     $__template__ = $templateFile;
   110|                     extract($this->tVar, EXTR_OVERWRITE);
   111|                     include $__template__;
   112|                 } else {
   113|                     extract($this->tVar, EXTR_OVERWRITE);
   114|                     include $templateFile;
   115|                 }
   116|             } elseif (isset($this->tVar['content'])) {
   117|                 $__content__ = $content;
   118|                 extract($this->tVar, EXTR_OVERWRITE);
   119|                 eval('?>' . $__content__);
   120|             } else {
   121|                 extract($this->tVar, EXTR_OVERWRITE);
   122|                 eval('?>' . $content);
   123|             }
   124|         } else {
   125|             $params = array('var' => $this->tVar, 'file' => $templateFile, 'content' => $content, 'prefix' => $prefix);
   126|             Hook::listen('view_parse', $params);
   127|         }
   128|         $content = ob_get_clean();
   129|         Hook::listen('view_filter', $content);
   130|         if (APP_DEBUG && C('PARSE_VAR')) {
   131|             $parseVar = empty($this->tVar) ? json_encode(array()) : json_encode($this->tVar);
   132|             $content  = $content . '<script type="text/javascript">var PARSE_VAR = ' . $parseVar . ';</script>';
   133|         }
   134|         return $content;
   135|     }
   136|     /**
   137|      * 自动定位模板文件
   138|      * @access protected
   139|      * @param string $template 模板文件规则
   140|      * @return string
   141|      */
   142|     public function parseTemplate($template = '')
   143|     {
   144|         if (is_file($template)) {
   145|             return $template;
   146|         }
   147|         $depr     = C('TMPL_FILE_DEPR');
   148|         $template = str_replace(':', $depr, $template);
   149|         $module = MODULE_NAME;
   150|         if (strpos($template, '@')) {
   151|             list($module, $template) = explode('@', $template);
   152|         }
   153|         defined('THEME_PATH') or define('THEME_PATH', $this->getThemePath($module));


# ====================================================================
# FILE: ThinkPHP/ThinkPHP.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-27 ---
     1| <?php
     2| $GLOBALS['_beginTime'] = microtime(true);
     3| define('MEMORY_LIMIT_ON', function_exists('memory_get_usage'));
     4| if (MEMORY_LIMIT_ON) {
     5|     $GLOBALS['_startUseMems'] = memory_get_usage();
     6| }
     7| const THINK_VERSION = '3.2.4';
     8| const URL_COMMON   = 0; //普通模式
     9| const URL_PATHINFO = 1; //PATHINFO模式
    10| const URL_REWRITE  = 2; //REWRITE模式
    11| const URL_COMPAT   = 3; // 兼容模式
    12| const EXT = '.class.php';
    13| defined('THINK_PATH') or define('THINK_PATH', __DIR__ . '/');
    14| defined('APP_PATH') or define('APP_PATH', dirname($_SERVER['SCRIPT_FILENAME']) . '/');
    15| defined('APP_STATUS') or define('APP_STATUS', ''); // 应用状态 加载对应的配置文件
    16| defined('APP_DEBUG') or define('APP_DEBUG', false); // 是否调试模式
    17| if (function_exists('saeAutoLoader')) {
    18|     defined('APP_MODE') or define('APP_MODE', 'sae');
    19|     defined('STORAGE_TYPE') or define('STORAGE_TYPE', 'Sae');
    20| } else {
    21|     defined('APP_MODE') or define('APP_MODE', 'common'); // 应用模式 默认为普通模式
    22|     defined('STORAGE_TYPE') or define('STORAGE_TYPE', 'File'); // 存储类型 默认为File
    23| }
    24| defined('RUNTIME_PATH') or define('RUNTIME_PATH', APP_PATH . 'Runtime/'); // 系统运行时目录
    25| defined('LIB_PATH') or define('LIB_PATH', realpath(THINK_PATH . 'Library') . '/'); // 系统核心类库目录
    26| defined('CORE_PATH') or define('CORE_PATH', LIB_PATH . 'Think/'); // Think类库目录
    27| defined('BEHAVIOR_PATH') or define('BEHAVIOR_PATH', LIB_PATH . 'Behavior/'); // 行为类库目录

