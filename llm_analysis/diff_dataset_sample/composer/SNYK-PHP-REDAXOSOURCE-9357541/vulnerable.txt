# ====================================================================
# FILE: redaxo/src/addons/cronjob/lib/manager.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 59-99 ---
    59|      * @param rex_cronjob|class-string<rex_cronjob> $cronjob
    60|      * @param string $name
    61|      * @param array $params
    62|      * @param bool $log
    63|      * @param int|null $id
    64|      * @return bool
    65|      */
    66|     public function tryExecute($cronjob, $name = '', $params = [], $log = true, $id = null)
    67|     {
    68|         if (!$cronjob instanceof rex_cronjob) {
    69|             $success = false;
    70|             if (is_object($cronjob)) {
    71|                 $message = 'Invalid cronjob class "' . $cronjob::class . '"';
    72|             } else {
    73|                 $message = 'Class "' . $cronjob . '" not found';
    74|             }
    75|         } else {
    76|             $this->name = $name;
    77|             $this->id = $id;
    78|             $this->cronjob = $cronjob;
    79|             $type = $cronjob->getType();
    80|             if (is_array($params)) {
    81|                 foreach ($params as $key => $value) {
    82|                     $cronjob->setParam(str_replace($type . '_', '', $key), $value);
    83|                 }
    84|             }
    85|             $message = '';
    86|             try {
    87|                 $success = $cronjob->execute();
    88|                 $message = $cronjob->getMessage();
    89|             } catch (Throwable $t) {
    90|                 $success = false;
    91|                 $message = $t->getMessage();
    92|             }
    93|             if ('' == $message && !$success) {
    94|                 $message = 'Unknown error';
    95|             }
    96|         }
    97|         if ($log) {
    98|             $this->log($success, $message);
    99|         }


# ====================================================================
# FILE: redaxo/src/addons/media_manager/boot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-13 ---
     1| <?php
     2| /**
     3|  * media_manager Addon.
     4|  *
     5|  * @author markus.staab[at]redaxo[dot]de Markus Staab
     6|  * @author jan.kristinus[at]redaxo[dot]de Jan Kristinus
     7|  */
     8| rex_extension::register('PACKAGES_INCLUDED', [rex_media_manager::class, 'init'], rex_extension::EARLY);
     9| if (rex::isBackend()) {
    10|     rex_extension::register('MEDIA_UPDATED', [rex_media_manager::class, 'mediaUpdated']);
    11|     rex_extension::register('MEDIA_DELETED', [rex_media_manager::class, 'mediaUpdated']);
    12|     rex_extension::register('MEDIA_IS_IN_USE', [rex_media_manager::class, 'mediaIsInUse']);
    13| }


# ====================================================================
# FILE: redaxo/src/addons/mediapool/lib/mediapool.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 95-135 ---
    95|         $blockedExtensions = self::getBlockedExtensions();
    96|         foreach ($blockedExtensions as $blockedExtension) {
    97|             if (str_ends_with($filename, '.' . $blockedExtension) // Prüfe ob der String mit der verbotenen Endung endet
    98|                 || str_ends_with($filename, '.' . $blockedExtension . '.' . $fileExt) // prüfe ob es keine doppelte Endung der Form *.php.ext gibt
    99|             ) {
   100|                 return false;
   101|             }
   102|         }
   103|         $allowedExtensions = self::getAllowedExtensions($args);
   104|         return !count($allowedExtensions) || in_array($fileExt, $allowedExtensions);
   105|     }
   106|     /**
   107|      * Checks file against optional property `allowed_mime_types`.
   108|      *
   109|      * @param string $path Path to the physical file
   110|      * @param string|null $filename Optional filename, will be used for extracting the file extension.
   111|      *                              If not given, the extension is extracted from `$path`.
   112|      */
   113|     public static function isAllowedMimeType(string $path, ?string $filename = null): bool
   114|     {
   115|         $allowedMimetypes = rex_addon::get('mediapool')->getProperty('allowed_mime_types');
   116|         if (!$allowedMimetypes) {
   117|             return true;
   118|         }
   119|         $extension = mb_strtolower(rex_file::extension($filename ?: $path));
   120|         if (!isset($allowedMimetypes[$extension])) {
   121|             return false;
   122|         }
   123|         $mimeType = rex_file::mimeType($path);
   124|         return in_array($mimeType, $allowedMimetypes[$extension]);
   125|     }
   126|     /**
   127|      * Get allowed mediatype extensions given via media widget "types" param.
   128|      *
   129|      * @param array $args widget params
   130|      *
   131|      * @return array allowedExtensions
   132|      */
   133|     public static function getAllowedExtensions(array $args = []): array
   134|     {
   135|         $blockedExtensions = self::getBlockedExtensions();

# --- HUNK 2: Lines 137-157 ---
   137|         if (isset($args['types'])) {
   138|             foreach (explode(',', $args['types']) as $ext) {
   139|                 $ext = ltrim($ext, '.');
   140|                 $ext = mb_strtolower($ext);
   141|                 if (!in_array($ext, $blockedExtensions)) { // allowedExtensions cannot override any blockedExtensions entry from master
   142|                     $allowedExtensions[] = $ext;
   143|                 }
   144|             }
   145|         }
   146|         return $allowedExtensions;
   147|     }
   148|     /**
   149|      * Get global blocked mediatype extensions.
   150|      *
   151|      * @return array blocked mediatype extensions
   152|      */
   153|     public static function getBlockedExtensions(): array
   154|     {
   155|         return rex_addon::get('mediapool')->getProperty('blocked_extensions');
   156|     }
   157| }


# ====================================================================
# FILE: redaxo/src/addons/mediapool/lib/service_media.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 136-175 ---
   136|             $error = $file['error'] ?? null;
   137|             if (UPLOAD_ERR_INI_SIZE === $error) {
   138|                 throw new rex_api_exception(rex_i18n::msg('pool_file_upload_error_size', rex_formatter::bytes(rex_ini_get('upload_max_filesize'))));
   139|             }
   140|             if ($error) {
   141|                 throw new rex_api_exception(rex_i18n::msg('pool_file_upload_error'));
   142|             }
   143|             $file['path'] = $file['tmp_name'] ?? null;
   144|             if (empty($file['path'])) {
   145|                 throw new rex_api_exception(rex_i18n::msg('pool_file_not_found'));
   146|             }
   147|             $filetype = rex_file::mimeType($file['path']);
   148|             $srcFile = $file['path'];
   149|             $dstFile = rex_path::media($filename);
   150|             $extensionNew = mb_strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
   151|             $extensionOld = mb_strtolower(pathinfo($filename, PATHINFO_EXTENSION));
   152|             if (
   153|                 $extensionNew == $extensionOld
   154|                 || in_array($extensionNew, ['jpg', 'jpeg']) && in_array($extensionOld, ['jpg', 'jpeg'])
   155|             ) {
   156|                 if (!rex_file::move($srcFile, $dstFile)) {
   157|                     throw new rex_api_exception(rex_i18n::msg('pool_file_movefailed'));
   158|                 }
   159|                 @chmod($dstFile, rex::getFilePerm());
   160|                 self::sanitizeMedia($dstFile, $filetype);
   161|                 $saveObject->setValue('filetype', $filetype);
   162|                 $saveObject->setValue('filesize', filesize($dstFile));
   163|                 $saveObject->setValue('originalname', $file['name']);
   164|                 if ($size = @getimagesize($dstFile)) {
   165|                     $saveObject->setValue('width', $size[0]);
   166|                     $saveObject->setValue('height', $size[1]);
   167|                 }
   168|                 @chmod($dstFile, rex::getFilePerm());
   169|             } else {
   170|                 throw new rex_api_exception(rex_i18n::msg('pool_file_upload_errortype'));
   171|             }
   172|         }
   173|         $saveObject->addGlobalUpdateFields();
   174|         $saveObject->update();
   175|         rex_media_cache::delete($filename);


# ====================================================================
# FILE: redaxo/src/addons/metainfo/lib/table_manager.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 36-113 ---
    36|     {
    37|         return $this->tableName;
    38|     }
    39|     /**
    40|      * @param string $name
    41|      * @param string $type
    42|      * @param int|null $length
    43|      * @param string|null $default
    44|      * @param bool $nullable
    45|      * @return bool
    46|      */
    47|     public function addColumn($name, $type, $length, $default = null, $nullable = true)
    48|     {
    49|         $sql = rex_sql::factory($this->DBID);
    50|         $qry = 'ALTER TABLE ' . $sql->escapeIdentifier($this->getTableName()) . ' ADD ';
    51|         $qry .= $sql->escapeIdentifier($name);
    52|         if (!ctype_alpha($type)) {
    53|             throw new InvalidArgumentException('Invalid column type "' . $type . '"');
    54|         }
    55|         /** @psalm-taint-escape sql */
    56|         $type = ' ' . $type;
    57|         $qry .= $type;
    58|         if (0 != $length) {
    59|             $qry .= '(' . (int) $length . ')';
    60|         }
    61|         if ('text' !== $type && null !== $default) {
    62|             $qry .= ' DEFAULT ' . $sql->escape($default);
    63|         }
    64|         if (!$nullable) {
    65|             $qry .= ' NOT NULL';
    66|         }
    67|         try {
    68|             $sql->setQuery($qry);
    69|             return true;
    70|         } catch (rex_sql_exception) {
    71|             return false;
    72|         }
    73|     }
    74|     /**
    75|      * @param string $oldname
    76|      * @param string $name
    77|      * @param string $type
    78|      * @param int|null $length
    79|      * @param string|null $default
    80|      * @param bool $nullable
    81|      * @return bool
    82|      */
    83|     public function editColumn($oldname, $name, $type, $length, $default = null, $nullable = true)
    84|     {
    85|         $sql = rex_sql::factory($this->DBID);
    86|         $qry = 'ALTER TABLE ' . $sql->escapeIdentifier($this->getTableName()) . ' CHANGE ';
    87|         $qry .= $sql->escapeIdentifier($oldname) . ' ' . $sql->escapeIdentifier($name);
    88|         if (!ctype_alpha($type)) {
    89|             throw new InvalidArgumentException('Invalid column type "' . $type . '"');
    90|         }
    91|         /** @psalm-taint-escape sql */
    92|         $type = ' ' . $type;
    93|         $qry .= $type;
    94|         if (0 != $length) {
    95|             $qry .= '(' . (int) $length . ')';
    96|         }
    97|         if ('text' !== $type && null !== $default) {
    98|             $qry .= ' DEFAULT ' . $sql->escape($default);
    99|         }
   100|         if (!$nullable) {
   101|             $qry .= ' NOT NULL';
   102|         }
   103|         try {
   104|             $sql->setQuery($qry);
   105|             return true;
   106|         } catch (rex_sql_exception) {
   107|             return false;
   108|         }
   109|     }
   110|     /**
   111|      * @param string $name
   112|      * @return bool
   113|      */


# ====================================================================
# FILE: redaxo/src/addons/metainfo/uninstall.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| <?php
     2| /**
     3|  * MetaForm Addon.
     4|  *
     5|  * @author markus[dot]staab[at]redaxo[dot]de Markus Staab
     6|  */
     7| $curDir = __DIR__;
     8| require_once $curDir . '/extensions/extension_cleanup.php';
     9| rex_metainfo_cleanup(['force' => true]);
    10| rex_sql_table::get(rex::getTable('metainfo_field'))->drop();
    11| rex_sql_table::get(rex::getTable('metainfo_type'))->drop();


# ====================================================================
# FILE: redaxo/src/addons/project/boot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| $addon = rex_addon::get('project');
     3| /*
     4| rex_addon::get('mediapool')->setProperty('allowed_mime_types', [
     5|     'gif'   => ['image/gif'],
     6|     'jpg'   => ['image/jpeg', 'image/pjpeg'],
     7|     'jpeg'  => ['image/jpeg', 'image/pjpeg'],
     8|     'png'   => ['image/png'],
     9|     'eps'   => ['application/postscript'],
    10|     'tif'   => ['image/tiff'],
    11|     'tiff'  => ['image/tiff'],
    12|     'svg'   => ['image/svg+xml'],
    13|     'pdf'   => ['application/pdf'],
    14|     'xls'   => ['application/vnd.ms-excel'],
    15|     'xlsx'  => ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],
    16|     'xlsm'  => ['application/vnd.ms-excel.sheet.macroEnabled.12'],
    17|     'doc'   => ['application/msword'],
    18|     'docx'  => ['application/vnd.openxmlformats-officedocument.wordprocessingml.document'],
    19|     'docm'  => ['application/vnd.ms-word.document.macroEnabled.12'],
    20|     'dot'   => ['application/msword'],
    21|     'dotx'  => ['application/vnd.openxmlformats-officedocument.wordprocessingml.template'],
    22|     'dotm'  => ['application/vnd.ms-word.template.macroEnabled.12'],
    23|     'ppt'   => ['application/vnd.ms-powerpoint'],
    24|     'pptx'  => ['application/vnd.openxmlformats-officedocument.presentationml.presentation'],
    25|     'pptm'  => ['application/vnd.ms-powerpoint.presentation.macroEnabled.12'],
    26|     'pot'   => ['application/vnd.ms-powerpoint'],
    27|     'potx'  => ['application/vnd.openxmlformats-officedocument.presentationml.template'],
    28|     'potm'  => ['application/vnd.ms-powerpoint.template.macroEnabled.12'],
    29|     'pps'   => ['application/vnd.ms-powerpoint'],
    30|     'ppsx'  => ['application/vnd.openxmlformats-officedocument.presentationml.slideshow'],
    31|     'ppsm'  => ['application/vnd.ms-powerpoint.slideshow.macroEnabled.12'],
    32|     'rtf'   => ['application/rtf'],
    33|     'txt'   => ['text/plain', 'application/octet-stream'],
    34|     'csv'   => ['text/plain', 'application/octet-stream'],
    35|     'zip'   => ['application/x-zip-compressed','application/zip'],
    36|     'gz'    => ['application/x-gzip'],
    37|     'tar'   => ['application/x-tar'],
    38|     'mov'   => ['video/quicktime'],
    39|     'movie' => ['video/quicktime'],
    40|     'mp3'   => ['audio/mpeg'],
    41|     'mpe'   => ['video/mpeg'],
    42|     'mpeg'  => ['video/mpeg'],
    43|     'mpg'   => ['video/mpeg'],
    44| ]);
    45| */


# ====================================================================
# FILE: redaxo/src/addons/structure/boot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 21-62 ---
    21| rex_perm::register('article2category[]', null, rex_perm::OPTIONS);
    22| rex_complex_perm::register('structure', rex_structure_perm::class);
    23| require_once __DIR__ . '/functions/function_rex_url.php';
    24| $addon->setProperty('start_article_id', $addon->getConfig('start_article_id', 1));
    25| $addon->setProperty('notfound_article_id', $addon->getConfig('notfound_article_id', 1));
    26| if (0 == rex_request('article_id', 'int')) {
    27|     $addon->setProperty('article_id', rex_article::getSiteStartArticleId());
    28| } else {
    29|     $articleId = rex_request('article_id', 'int');
    30|     $articleId = rex_article::get($articleId) ? $articleId : rex_article::getNotfoundArticleId();
    31|     $addon->setProperty('article_id', $articleId);
    32| }
    33| if (rex::isBackend() && rex::getUser()) {
    34|     rex_view::addJsFile($addon->getAssetsUrl('linkmap.js'), [rex_view::JS_IMMUTABLE => true]);
    35|     if ('system' == rex_be_controller::getCurrentPagePart(1)) {
    36|         rex_system_setting::register(new rex_system_setting_article_id('start_article_id'));
    37|         rex_system_setting::register(new rex_system_setting_article_id('notfound_article_id'));
    38|     }
    39| }
    40| rex_extension::register('CLANG_ADDED', static function (rex_extension_point $ep) {
    41|     $firstLang = rex_sql::factory();
    42|     $firstLang->setQuery('select * from ' . rex::getTablePrefix() . 'article where clang_id=?', [rex_clang::getStartId()]);
    43|     $fields = $firstLang->getFieldnames();
    44|     $newLang = rex_sql::factory();
    45|     foreach ($firstLang as $firstLangArt) {
    46|         $newLang->setTable(rex::getTablePrefix() . 'article');
    47|         foreach ($fields as $value) {
    48|             if ('pid' == $value) {
    49|                 echo '';
    50|             } // nix passiert
    51|             elseif ('clang_id' == $value) {
    52|                 $newLang->setValue('clang_id', $ep->getParam('clang')->getId());
    53|             } elseif ('status' == $value) {
    54|                 $newLang->setValue('status', '0');
    55|             } // Alle neuen Artikel offline
    56|             else {
    57|                 $newLang->setValue($value, $firstLangArt->getValue($value));
    58|             }
    59|         }
    60|         $newLang->insert();
    61|     }
    62| });


# ====================================================================
# FILE: redaxo/src/addons/structure/lib/service_article.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 7-48 ---
     7|     /**
     8|      * Erstellt einen neuen Artikel.
     9|      *
    10|      * @param array $data Array mit den Daten des Artikels
    11|      *
    12|      * @throws rex_api_exception
    13|      *
    14|      * @return string Eine Statusmeldung
    15|      */
    16|     public static function addArticle($data)
    17|     {
    18|         if (!is_array($data)) {
    19|             throw new rex_api_exception('Expecting $data to be an array!');
    20|         }
    21|         self::reqKey($data, 'category_id');
    22|         self::reqKey($data, 'priority');
    23|         self::reqKey($data, 'name');
    24|         if ($data['priority'] <= 0) {
    25|             $data['priority'] = 1;
    26|         }
    27|         $parent = rex_category::get($data['category_id']);
    28|         if ($parent) {
    29|             $path = $parent->getPath();
    30|             $path .= $parent->getId() . '|';
    31|         } else {
    32|             $path = '|';
    33|         }
    34|         if (rex_plugin::get('structure', 'content')->isAvailable()) {
    35|             $templates = rex_template::getTemplatesForCategory($data['category_id']);
    36|             if (!isset($templates[$data['template_id']])) {
    37|                 $data['template_id'] = 0;
    38|                 if (count($templates) > 0) {
    39|                     $data['template_id'] = key($templates);
    40|                 }
    41|             }
    42|         }
    43|         $message = rex_i18n::msg('article_added');
    44|         $AART = rex_sql::factory();
    45|         $user = self::getUser();
    46|         foreach (rex_clang::getAllIds() as $key) {
    47|             $category = rex_category::get($data['category_id'], $key);
    48|             $categoryName = '';


# ====================================================================
# FILE: redaxo/src/addons/structure/lib/service_category.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 4-45 ---
     4|  *
     5|  * @package redaxo\structure
     6|  */
     7| class rex_category_service
     8| {
     9|     /**
    10|      * Erstellt eine neue Kategorie.
    11|      *
    12|      * @param int $categoryId KategorieId in der die neue Kategorie erstellt werden soll
    13|      * @param array $data Array mit den Daten der Kategorie
    14|      *
    15|      * @throws rex_api_exception
    16|      *
    17|      * @return string Eine Statusmeldung
    18|      */
    19|     public static function addCategory($categoryId, array $data)
    20|     {
    21|         $message = '';
    22|         self::reqKey($data, 'catpriority');
    23|         self::reqKey($data, 'catname');
    24|         $parent = rex_category::get($categoryId);
    25|         if ($parent) {
    26|             $path = $parent->getPath();
    27|             $path .= $parent->getId() . '|';
    28|         } else {
    29|             $path = '|';
    30|         }
    31|         if ($data['catpriority'] <= 0) {
    32|             $data['catpriority'] = 1;
    33|         }
    34|         if (!isset($data['name'])) {
    35|             $data['name'] = $data['catname'];
    36|         }
    37|         if (!isset($data['status'])) {
    38|             $data['status'] = 0;
    39|         }
    40|         $templates = [];
    41|         $contentAvailable = rex_plugin::get('structure', 'content')->isAvailable();
    42|         if ($contentAvailable) {
    43|             $startpageTemplates = [];
    44|             if ('' != $categoryId) {
    45|                 $sql = rex_sql::factory();


# ====================================================================
# FILE: redaxo/src/addons/structure/plugins/content/boot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| /**
     3|  * Page Content Addon.
     4|  *
     5|  * @author markus[dot]staab[at]redaxo[dot]de Markus Staab
     6|  */
     7| rex_perm::register('moveSlice[]', null, rex_perm::OPTIONS);
     8| rex_perm::register('publishSlice[]', null, rex_perm::OPTIONS);
     9| rex_complex_perm::register('modules', rex_module_perm::class);
    10| if (rex::isBackend()) {
    11|     rex_extension::register('PAGE_CHECKED', static function () {
    12|         if ('content' == rex_be_controller::getCurrentPagePart(1)) {
    13|             rex_be_controller::getPageObject('structure')->setIsActive(true);
    14|         }
    15|     });
    16|     if ('system' == rex_be_controller::getCurrentPagePart(1)) {
    17|         rex_system_setting::register(new rex_system_setting_default_template_id());
    18|     }
    19|     if ('content' == rex_be_controller::getCurrentPagePart(1)) {
    20|         rex_view::addJsFile(rex_url::pluginAssets('structure', 'content', 'content.js'), [rex_view::JS_IMMUTABLE => true]);
    21|     }
    22|     rex_extension::register('CLANG_DELETED', static function (rex_extension_point $ep) {
    23|         $del = rex_sql::factory();
    24|         $del->setQuery('delete from ' . rex::getTablePrefix() . 'article_slice where clang_id=?', [$ep->getParam('clang')->getId()]);
    25|     });
    26| } else {
    27|     rex_extension::register('FE_OUTPUT', static function (rex_extension_point $ep) {
    28|         $clangId = rex_get('clang', 'int');
    29|         if ($clangId && !rex_clang::exists($clangId)) {
    30|             rex_redirect(rex_article::getNotfoundArticleId(), rex_clang::getStartId());
    31|         }
    32|         $content = $ep->getSubject();
    33|         $article = new rex_article_content();
    34|         $article->setCLang(rex_clang::getCurrentId());
    35|         if (!$article->setArticleId(rex_article::getCurrentId())) {
    36|             if (!rex::isDebugMode() && !rex_backend_login::hasSession()) {
    37|                 throw new rex_exception('Article with id ' . rex_article::getCurrentId() . ' does not exist');
    38|             }
    39|             $fragment = new rex_fragment([
    40|                 'content' => '<p><b>Article with ID ' . rex_article::getCurrentId() . ' not found.</b><br />If this is a fresh setup, an article must be created first.<br />Enter <a href="' . rex_url::backendController() . '">REDAXO</a>.</p>',
    41|             ]);
    42|             $content .= $fragment->parse('core/fe_ooops.php');
    43|             rex_response::sendPage($content);
    44|             exit;
    45|         }


# ====================================================================
# FILE: redaxo/src/addons/structure/plugins/history/boot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 51-107 ---
    51|             }
    52|             rex_article_slice_history::checkTables();
    53|             $escapeSql = rex_sql::factory();
    54|             $sliceDate = ' AND ' . rex::getTablePrefix() . 'article_slice.history_date = ' . $escapeSql->escape($historyDate);
    55|             return 'SELECT ' . rex::getTablePrefix() . 'module.id, ' . rex::getTablePrefix() . 'module.key,' . rex::getTablePrefix() . 'module.name, ' . rex::getTablePrefix() . 'module.output, ' . rex::getTablePrefix() . 'module.input, ' . rex::getTablePrefix() . 'article_slice.*, ' . rex::getTablePrefix() . 'article.parent_id
    56|                 FROM
    57|                     ' . rex_article_slice_history::getTable() . ' as ' . rex::getTablePrefix() . 'article_slice
    58|                 LEFT JOIN ' . rex::getTablePrefix() . 'module ON ' . rex::getTablePrefix() . 'article_slice.module_id=' . rex::getTablePrefix() . 'module.id
    59|                 LEFT JOIN ' . rex::getTablePrefix() . 'article ON ' . rex::getTablePrefix() . 'article_slice.article_id=' . rex::getTablePrefix() . 'article.id
    60|                 WHERE
    61|                     ' . rex::getTablePrefix() . "article_slice.clang_id='" . $article->getClangId() . "' AND
    62|                     " . rex::getTablePrefix() . "article.clang_id='" . $article->getClangId() . "' AND
    63|                     " . rex::getTablePrefix() . 'article_slice.revision=0
    64|                     ' . $articleLimit . '
    65|                     ' . $sliceDate . '
    66|                     ORDER BY ' . rex::getTablePrefix() . 'article_slice.priority';
    67|         }
    68|         return null;
    69|     });
    70| }
    71| if (rex::isBackend() && rex::getUser()?->hasPerm('history[article_rollback]')) {
    72|     rex_extension::register(
    73|         ['ART_SLICES_COPY', 'SLICE_ADD', 'SLICE_UPDATE', 'SLICE_MOVE', 'SLICE_DELETE'],
    74|         static function (rex_extension_point $ep) {
    75|             $type = match ($ep->getName()) {
    76|                 'ART_SLICES_COPY' => 'slices_copy',
    77|                 'SLICE_MOVE' => 'slice_' . $ep->getParam('direction'),
    78|                 default => strtolower($ep->getName()),
    79|             };
    80|             $articleId = $ep->getParam('article_id');
    81|             $clangId = $ep->getParam('clang_id');
    82|             $sliceRevision = $ep->getParam('slice_revision');
    83|             if (0 == $sliceRevision) {
    84|                 rex_article_slice_history::makeSnapshot($articleId, $clangId, $type);
    85|             }
    86|         },
    87|     );
    88|     rex_view::addCssFile($plugin->getAssetsUrl('noUiSlider/nouislider.css'));
    89|     rex_view::addJsFile($plugin->getAssetsUrl('noUiSlider/nouislider.js'), [rex_view::JS_IMMUTABLE => true]);
    90|     rex_view::addCssFile($plugin->getAssetsUrl('history.css'));
    91|     rex_view::addJsFile($plugin->getAssetsUrl('history.js'), [rex_view::JS_IMMUTABLE => true]);
    92|     switch (rex_request('rex_history_function', 'string')) {
    93|         case 'snap':
    94|             $articleId = rex_request('history_article_id', 'int');
    95|             $clangId = rex_request('history_clang_id', 'int');
    96|             $historyDate = rex_request('history_date', 'string');
    97|             rex_article_slice_history::restoreSnapshot($historyDate, $articleId, $clangId);
    98|         case 'layer':
    99|             $articleId = rex_request('history_article_id', 'int');
   100|             $clangId = rex_request('history_clang_id', 'int');
   101|             $versions = rex_article_slice_history::getSnapshots($articleId, $clangId);
   102|             $select1 = [];
   103|             $select1[] = '<option value="0" selected="selected" data-revision="0">' . $plugin->i18n('current_version') . '</option>';
   104|             if (rex_plugin::get('structure', 'version')->isAvailable()) {
   105|                 $select1[] = '<option value="1" data-revision="1">' . rex_i18n::msg('version_workingversion') . '</option>';
   106|             }
   107|             $select2 = [];


# ====================================================================
# FILE: redaxo/src/core/assets/standard.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 373-413 ---
   373|             rex.cookie_params.domain,
   374|             rex.cookie_params.secure,
   375|             rex.cookie_params.samesite.toLowerCase()
   376|         );
   377|         var allowedUrl = 'index.php';
   378|         var urls = [
   379|             'bin/console',
   380|             allowedUrl,
   381|             'data/.redaxo',
   382|             allowedUrl,
   383|             'src/core/boot.php',
   384|             allowedUrl,
   385|             'cache/.redaxo'
   386|         ];
   387|         $.each(urls, function (i, url) {
   388|             $.ajax({
   389|                 url: url + '?redaxo-security-self-test',
   390|                 cache: false,
   391|                 success: function (data) {
   392|                     if (i % 2 == 0) {
   393|                         $('#rex-js-page-main').prepend('<div class="alert alert-danger" style="margin-top: 20px;">The folder <code>redaxo/' + url + '</code> is insecure. Please protect this folder.</div>');
   394|                         setCookie('rex_htaccess_check', '');
   395|                     }
   396|                 }
   397|             });
   398|         });
   399|     }
   400| });
   401| function setCookie(name, value, expires, path, domain, secure, samesite) {
   402|     if (typeof expires != undefined && expires == "never") {
   403|         expires = new Date();
   404|         expires.setTime(expires.getTime() + (1000 * 60 * 60 * 24 * 3000));
   405|         expires = expires.toGMTString();
   406|     }
   407|     document.cookie = name + "=" + escape(value)
   408|         + ((expires) ? "; expires=" + expires : "")
   409|         + ((path) ? "; path=" + path : "")
   410|         + ((domain) ? "; domain=" + domain : "")
   411|         + ((secure) ? "; secure" : "")
   412|         + ((samesite) ? "; samesite=" + samesite : "");
   413| }


# ====================================================================
# FILE: redaxo/src/core/boot.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 41-81 ---
    41| }
    42| rex_path::init($pathProvider);
    43| require_once rex_path::core('lib/autoload.php');
    44| rex_autoload::register();
    45| rex_autoload::addDirectory(rex_path::core('lib'));
    46| mb_internal_encoding('UTF-8');
    47| if (isset($REX['URL_PROVIDER']) && is_object($REX['URL_PROVIDER'])) {
    48|     /** @var rex_path_default_provider */
    49|     $urlProvider = $REX['URL_PROVIDER'];
    50| } else {
    51|     $urlProvider = new rex_path_default_provider($REX['HTDOCS_PATH'], $REX['BACKEND_FOLDER'], false);
    52| }
    53| rex_url::init($urlProvider);
    54| rex::setProperty('timer', new rex_timer($_SERVER['REQUEST_TIME_FLOAT'] ?? null));
    55| rex::setProperty('redaxo', $REX['REDAXO']);
    56| rex_i18n::addDirectory(rex_path::core('lang'));
    57| rex_fragment::addDirectory(rex_path::core('fragments/'));
    58| require_once rex_path::core('functions/function_rex_escape.php');
    59| require_once rex_path::core('functions/function_rex_globals.php');
    60| require_once rex_path::core('functions/function_rex_other.php');
    61| rex::setProperty('version', '5.18.2');
    62| $cacheFile = rex_path::coreCache('config.yml.cache');
    63| $configFile = rex_path::coreData('config.yml');
    64| $cacheMtime = @filemtime($cacheFile);
    65| if ($cacheMtime && $cacheMtime >= @filemtime($configFile)) {
    66|     $config = rex_file::getCache($cacheFile);
    67| } else {
    68|     $config = array_merge(
    69|         rex_file::getConfig(rex_path::core('default.config.yml')),
    70|         rex_file::getConfig($configFile)
    71|     );
    72|     rex_file::putCache($cacheFile, $config);
    73| }
    74| /**
    75|  * @var string $key
    76|  * @var mixed $value
    77|  */
    78| foreach ($config as $key => $value) {
    79|     if (in_array($key, ['fileperm', 'dirperm'])) {
    80|         $value = octdec((string) $value);
    81|     }


# ====================================================================
# FILE: redaxo/src/core/lib/api_function.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 139-196 ---
   139|      * @return void
   140|      */
   141|     public static function handleCall()
   142|     {
   143|         if ($factoryClass = static::getExplicitFactoryClass()) {
   144|             $factoryClass::handleCall();
   145|             return;
   146|         }
   147|         $apiFunc = self::factory();
   148|         if (null != $apiFunc) {
   149|             if (!$apiFunc->published) {
   150|                 if (!rex::isBackend()) {
   151|                     throw new rex_http_exception(new rex_api_exception('the api function ' . $apiFunc::class . ' is not published, therefore can only be called from the backend!'), rex_response::HTTP_FORBIDDEN);
   152|                 }
   153|                 if (!rex::getUser()) {
   154|                     throw new rex_http_exception(new rex_api_exception('missing backend session to call api function ' . $apiFunc::class . '!'), rex_response::HTTP_UNAUTHORIZED);
   155|                 }
   156|             }
   157|             $urlResult = rex_get(self::REQ_RESULT_PARAM, 'string');
   158|             if ($urlResult) {
   159|                 $result = rex_api_result::fromJSON($urlResult);
   160|                 $apiFunc->result = $result;
   161|             } else {
   162|                 if ($apiFunc->requiresCsrfProtection() && !rex_csrf_token::factory($apiFunc::class)->isValid()) {
   163|                     $result = new rex_api_result(false, rex_i18n::msg('csrf_token_invalid'));
   164|                     $apiFunc->result = $result;
   165|                     return;
   166|                 }
   167|                 try {
   168|                     $result = $apiFunc->execute();
   169|                     if (!($result instanceof rex_api_result)) {
   170|                         throw new rex_exception('Illegal result returned from api-function ' . rex_get(self::REQ_CALL_PARAM) . '. Expected a instance of rex_api_result but got "' . get_debug_type($result) . '".');
   171|                     }
   172|                     $apiFunc->result = $result;
   173|                     if ($result->requiresReboot()) {
   174|                         $context = rex_context::fromGet();
   175|                         $context->setParam(self::REQ_RESULT_PARAM, $result->toJSON());
   176|                         rex_response::sendRedirect($context->getUrl([], false));
   177|                     }
   178|                 } catch (rex_api_exception $e) {
   179|                     $message = $e->getMessage();
   180|                     $result = new rex_api_result(false, $message);
   181|                     $apiFunc->result = $result;
   182|                 }
   183|             }
   184|         }
   185|     }
   186|     /**
   187|      * @return bool
   188|      */
   189|     public static function hasMessage()
   190|     {
   191|         $apiFunc = self::factory();
   192|         if (!$apiFunc) {
   193|             return false;
   194|         }
   195|         $result = $apiFunc->getResult();
   196|         return $result && null !== $result->getMessage();

# --- HUNK 2: Lines 300-347 ---
   300|     }
   301|     /**
   302|      * Returns end-user friendly statusmessage.
   303|      *
   304|      * @return string|null a statusmessage
   305|      */
   306|     public function getMessage()
   307|     {
   308|         return $this->message;
   309|     }
   310|     /**
   311|      * Returns whether the api function was executed successfully.
   312|      *
   313|      * @return bool true on success, false on error
   314|      */
   315|     public function isSuccessfull()
   316|     {
   317|         return $this->succeeded;
   318|     }
   319|     /**
   320|      * @return false|string
   321|      */
   322|     public function toJSON()
   323|     {
   324|         return json_encode([
   325|             'succeeded' => $this->succeeded,
   326|             'message' => $this->message,
   327|         ]);
   328|     }
   329|     /**
   330|      * @param string $json
   331|      * @return self
   332|      */
   333|     public static function fromJSON($json)
   334|     {
   335|         $json = json_decode($json, true);
   336|         if (!is_array($json)) {
   337|             throw new rex_exception('Unable to decode json into an array.');
   338|         }
   339|         return new self(
   340|             rex_type::bool($json['succeeded'] ?? null),
   341|             rex_type::nullOrString($json['message'] ?? null),
   342|         );
   343|     }
   344| }
   345| /**
   346|  * Exception-Type to indicate exceptions in an api function.
   347|  * The messages of this exception will be displayed to the end-user.


# ====================================================================
# FILE: redaxo/src/core/lib/console/application.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-58 ---
     1| <?php
     2| use Symfony\Component\Console\Application;
     3| use Symfony\Component\Console\Command\Command;
     4| use Symfony\Component\Console\Input\InputInterface;
     5| use Symfony\Component\Console\Output\OutputInterface;
     6| use Symfony\Component\Console\Style\SymfonyStyle;
     7| /**
     8|  * @package redaxo\core
     9|  */
    10| class rex_console_application extends Application
    11| {
    12|     public function __construct()
    13|     {
    14|         parent::__construct('REDAXO', rex::getVersion());
    15|     }
    16|     public function doRun(InputInterface $input, OutputInterface $output)
    17|     {
    18|         try {
    19|             $this->checkConsoleUser($input, $output);
    20|             return parent::doRun($input, $output);
    21|         } catch (Exception $e) {
    22|             throw $e;
    23|         } catch (Throwable $e) {
    24|             $message = $e->getMessage();
    25|             if ($e instanceof ParseError) {
    26|                 $message = 'Parse error: ' . $message;
    27|                 $severity = E_PARSE;
    28|             } elseif ($e instanceof TypeError) {
    29|                 $message = 'Type error: ' . $message;
    30|                 $severity = E_RECOVERABLE_ERROR;
    31|             } else {
    32|                 $message = 'Fatal error: ' . $message;
    33|                 $severity = E_ERROR;
    34|             }
    35|             throw new ErrorException($message, 0, $severity, $e->getFile(), $e->getLine(), $e->getPrevious());
    36|         }
    37|     }
    38|     protected function doRunCommand(Command $command, InputInterface $input, OutputInterface $output)
    39|     {
    40|         if ($command instanceof rex_console_command) {
    41|             $this->loadPackages($command);
    42|         }
    43|         $exitCode = parent::doRunCommand($command, $input, $output);
    44|         rex_extension::registerPoint(new rex_extension_point_console_shutdown($command, $input, $output, $exitCode));
    45|         return $exitCode;
    46|     }
    47|     /**
    48|      * @return void
    49|      */
    50|     private function loadPackages(rex_console_command $command)
    51|     {
    52|         if ($command instanceof rex_command_standalone) {
    53|             return;
    54|         }
    55|         if ($command instanceof rex_command_only_setup_packages) {
    56|             if (rex::isSetup()) {
    57|                 foreach (rex_package::getSetupPackages() as $package) {
    58|                     $package->enlist();


# ====================================================================
# FILE: redaxo/src/core/pages/setup.step3.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 79-119 ---
    79| $formElements = [];
    80| $n = [];
    81| $n['label'] = '<label>' . rex_i18n::msg('setup_311') . '</label>';
    82| $n['field'] = '<input type="checkbox" name="redaxo_db_create" value="1"' . $dbCreateChecked . ' />';
    83| $formElements[] = $n;
    84| $fragment = new rex_fragment();
    85| $fragment->setVar('elements', $formElements, false);
    86| $content .= $fragment->parse('core/form/checkbox.php');
    87| $content .= '</fieldset><fieldset><legend>' . rex_i18n::msg('setup_security') . '</legend>';
    88| $formElements = [];
    89| if (!rex_request::isHttps()) {
    90|     $n = [];
    91|     $n['field'] = '<label class="form-control-static"><i class="fa fa-warning"></i> ' . rex_i18n::msg('https_only_over_https') . '</label>';
    92|     $formElements[] = $n;
    93| }
    94| $n = [];
    95| $n['label'] = '<label>' . rex_i18n::msg('https_activate_redirect_for') . '</label>';
    96| $n['field'] = $httpsRedirectSel->get();
    97| $formElements[] = $n;
    98| $n = [];
    99| $n['field'] = '<p>' . rex_i18n::msg('hsts_more_information') . '</p>';
   100| $formElements[] = $n;
   101| $fragment = new rex_fragment();
   102| $fragment->setVar('elements', $formElements, false);
   103| $content .= $fragment->parse('core/form/form.php');
   104| $content .= '</fieldset>';
   105| $formElements = [];
   106| $n = [];
   107| $n['field'] = '<button class="btn btn-setup" type="submit" value="' . rex_i18n::msg('system_update') . '">' . $submitMessage . '</button>';
   108| $formElements[] = $n;
   109| $fragment = new rex_fragment();
   110| $fragment->setVar('elements', $formElements, false);
   111| $buttons = $fragment->parse('core/form/submit.php');
   112| echo $headline;
   113| echo implode('', $errorArray);
   114| $fragment = new rex_fragment();
   115| $fragment->setVar('title', rex_i18n::msg('setup_316'), false);
   116| $fragment->setVar('body', $content, false);
   117| $fragment->setVar('buttons', $buttons, false);
   118| $content = $fragment->parse('core/page/section.php');
   119| echo '<form action="' . $context->getUrl(['step' => 4]) . '" method="post">' . $content . '</form>';


# ====================================================================
# FILE: redaxo/src/core/pages/system.settings.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 13-84 ---
    13|         header('Location:' . $url);
    14|         exit;
    15|     }
    16|     $error[] = rex_i18n::msg('setup_error2');
    17| } elseif ('generate' == $func) {
    18|     $success = rex_delete_cache();
    19| } elseif ('updateassets' == $func && !rex::isLiveMode()) {
    20|     rex_dir::copy(rex_path::core('assets'), rex_path::coreAssets());
    21|     $success = 'Updated assets';
    22| } elseif ('debugmode' == $func && !rex::isLiveMode()) {
    23|     $configFile = rex_path::coreData('config.yml');
    24|     $config = array_merge(
    25|         rex_file::getConfig(rex_path::core('default.config.yml')),
    26|         rex_file::getConfig($configFile),
    27|     );
    28|     if (!is_array($config['debug'])) {
    29|         $config['debug'] = [];
    30|     }
    31|     $config['debug']['enabled'] = !rex::isDebugMode();
    32|     rex::setProperty('debug', $config['debug']);
    33|     if (rex_file::putConfig($configFile, $config) > 0) {
    34|         rex_response::sendRedirect(rex_url::currentBackendPage(['rex_debug_updated' => true], false));
    35|     }
    36| } elseif ('updateinfos' == $func) {
    37|     $configFile = rex_path::coreData('config.yml');
    38|     $config = array_merge(
    39|         rex_file::getConfig(rex_path::core('default.config.yml')),
    40|         rex_file::getConfig($configFile),
    41|     );
    42|     $settings = rex_post('settings', 'array', []);
    43|     foreach (['server', 'servername', 'error_email', 'lang'] as $key) {
    44|         if (!isset($settings[$key]) || !$settings[$key]) {
    45|             $error[] = rex_i18n::msg($key . '_required');
    46|             continue;
    47|         }
    48|         $config[$key] = $settings[$key];
    49|         try {
    50|             rex::setProperty($key, $settings[$key]);
    51|         } catch (InvalidArgumentException) {
    52|             $error[] = rex_i18n::msg($key . '_invalid');
    53|         }
    54|     }
    55|     foreach (rex_system_setting::getAll() as $setting) {
    56|         $key = $setting->getKey();
    57|         if (isset($settings[$key])) {
    58|             if (true !== ($msg = $setting->setValue($settings[$key]))) {
    59|                 $error[] = $msg;
    60|             }
    61|         }
    62|     }
    63|     if (empty($error)) {
    64|         if (rex_file::putConfig($configFile, $config) > 0) {
    65|             $success = rex_i18n::msg('info_updated');
    66|         }
    67|     }
    68| } elseif ('update_editor' === $func) {
    69|     $editor = rex_post('editor', [
    70|         ['name', 'string', null],
    71|         ['basepath', 'string', null],
    72|         ['update_cookie', 'bool', false],
    73|         ['delete_cookie', 'bool', false],
    74|     ]);
    75|     $editor['name'] = $editor['name'] ?: null;
    76|     $editor['basepath'] = $editor['basepath'] ?: null;
    77|     $cookieOptions = ['samesite' => 'strict'];
    78|     if ($editor['delete_cookie']) {
    79|         rex_response::clearCookie('editor', $cookieOptions);
    80|         rex_response::clearCookie('editor_basepath', $cookieOptions);
    81|         unset($_COOKIE['editor']);
    82|         unset($_COOKIE['editor_basepath']);
    83|         $success = rex_i18n::msg('system_editor_success_cookie_deleted');
    84|     } elseif ($editor['update_cookie']) {


# ====================================================================
# FILE: redaxo/src/core/update.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 60-79 ---
    60| if (rex_version::compare(rex::getVersion(), '5.15.0-dev', '<') && $user = rex::getUser()) {
    61|     try {
    62|         rex_sql::factory()
    63|             ->setTable(rex::getTable('user_session'))
    64|             ->setValue('session_id', session_id())
    65|             ->setValue('user_id', $user->getId())
    66|             ->setValue('ip', rex_request::server('REMOTE_ADDR', 'string'))
    67|             ->setValue('useragent', rex_request::server('HTTP_USER_AGENT', 'string'))
    68|             ->setValue('starttime', rex_sql::datetime())
    69|             ->setValue('last_activity', rex_sql::datetime())
    70|             ->insert();
    71|     } catch (rex_sql_exception $exception) {
    72|         if (rex_sql::ERROR_VIOLATE_UNIQUE_KEY !== $exception->getErrorCode()) {
    73|             throw $exception;
    74|         }
    75|     }
    76| }
    77| if (rex_version::compare(rex::getVersion(), '5.16.0', '<')) {
    78|     class_exists(LogLevel::class);
    79| }

