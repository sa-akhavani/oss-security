# ====================================================================
# FILE: phpmyfaq/404.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| /**
     3|  * 404 error page
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2019-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2019-01-25
    15|  */
    16| use phpMyFAQ\Enums\SessionActionType;
    17| use phpMyFAQ\Template\TwigWrapper;
    18| if (!defined('IS_VALID_PHPMYFAQ')) {
    19|     http_response_code(400);
    20|     exit();
    21| }
    22| $faqConfig = $container->get('phpmyfaq.configuration');
    23| $user = $container->get('phpmyfaq.user.current_user');
    24| $faqSession = $container->get('phpmyfaq.session');
    25| $faqSession->setCurrentUser($user);
    26| $faqSession->userTracking(SessionActionType::NOT_FOUND->value, 0);
    27| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    28| $twigTemplate = $twig->loadTemplate('./404.twig');


# ====================================================================
# FILE: phpmyfaq/add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-115 ---
     1| <?php
     2| /**
     3|  * This is the page there a user can add a FAQ record.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2002-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2002-09-16
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Enums\Forms\FormIds;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Forms;
    21| use phpMyFAQ\Helper\CategoryHelper as HelperCategory;
    22| use phpMyFAQ\Question;
    23| use phpMyFAQ\Strings;
    24| use phpMyFAQ\System;
    25| use phpMyFAQ\Template\TwigWrapper;
    26| use phpMyFAQ\Translation;
    27| use Symfony\Component\HttpFoundation\RedirectResponse;
    28| use Symfony\Component\HttpFoundation\Request;
    29| if (!defined('IS_VALID_PHPMYFAQ')) {
    30|     http_response_code(400);
    31|     exit();
    32| }
    33| $request = Request::createFromGlobals();
    34| $faqSystem = new System();
    35| $faqConfig = $container->get('phpmyfaq.configuration');
    36| $user = $container->get('phpmyfaq.user.current_user');
    37| $faqSession = $container->get('phpmyfaq.session');
    38| $faqSession->setCurrentUser($user);
    39| if (-1 === $user->getUserId() && !$faqConfig->get('records.allowNewFaqsForGuests')) {
    40|     $response = new RedirectResponse($faqSystem->getSystemUri($faqConfig) . 'login');
    41|     $response->send();
    42| }
    43| if (-1 !== $user->getUserId() && !$user->perm->hasPermission($user->getUserId(), PermissionType::FAQ_ADD->value)) {
    44|     $response = new RedirectResponse($faqSystem->getSystemUri($faqConfig));
    45|     $response->send();
    46| }
    47| $captcha = $container->get('phpmyfaq.captcha');
    48| $captcha->setSessionId($sids);
    49| $questionObject = new Question($faqConfig);
    50| $faqSession->userTracking('new_entry', 0);
    51| $selectedQuestion = Filter::filterVar($request->query->get('question'), FILTER_VALIDATE_INT);
    52| $selectedCategory = Filter::filterVar($request->query->get('cat'), FILTER_VALIDATE_INT, -1);
    53| $question = '';
    54| $readonly = '';
    55| $displayFullForm = false;
    56| if (!is_null($selectedQuestion)) {
    57|     $questionData = $questionObject->get($selectedQuestion);
    58|     $question = Strings::htmlentities($questionData['question']);
    59|     if (Strings::strlen($question) !== 0) {
    60|         $readonly = ' readonly';
    61|     }
    62|     $displayFullForm = true;
    63| }
    64| $category->buildCategoryTree();
    65| $categoryHelper = new HelperCategory();
    66| $categoryHelper->setCategory($category);
    67| $captchaHelper = $container->get('phpmyfaq.captcha.helper.captcha_helper');
    68| $forms = new Forms($faqConfig);
    69| $formData = $forms->getFormData(FormIds::ADD_NEW_FAQ->value);
    70| $category = new Category($faqConfig);
    71| $categories = $category->getAllCategoryIds();
    72| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    73| $twigTemplate = $twig->loadTemplate('./add.twig');
    74| $templateVars = [
    75|     ... $templateVars,
    76|     'title' => sprintf('%s - %s', Translation::get('msgAddContent'), $faqConfig->getTitle()),
    77|     'metaDescription' => sprintf('%s | %s', Translation::get('msgNewContentHeader'), $faqConfig->getTitle()),
    78|     'msgNewContentHeader' => Translation::get('msgNewContentHeader'),
    79|     'msgNewContentAddon' => Translation::get('msgNewContentAddon'),
    80|     'lang' => $Language->getLanguage(),
    81|     'openQuestionID' => $selectedQuestion,
    82|     'defaultContentMail' => ($user->getUserId() > 0) ? $user->getUserData('email') : '',
    83|     'defaultContentName' => ($user->getUserId() > 0) ? $user->getUserData('display_name') : '',
    84|     'msgNewContentName' => Translation::get('msgNewContentName'),
    85|     'msgNewContentMail' => Translation::get('msgNewContentMail'),
    86|     'msgNewContentCategory' => Translation::get('msgNewContentCategory'),
    87|     'renderCategoryOptions' => $categoryHelper->renderOptions($selectedCategory),
    88|     'msgNewContentTheme' => Translation::get('msgNewContentTheme'),
    89|     'readonly' => $readonly,
    90|     'printQuestion' => $question,
    91|     'msgNewContentArticle' => Translation::get('msgNewContentArticle'),
    92|     'msgNewContentKeywords' => Translation::get('msgNewContentKeywords'),
    93|     'msgNewContentLink' => Translation::get('msgNewContentLink'),
    94|     'captchaFieldset' =>
    95|         $captchaHelper->renderCaptcha($captcha, 'add', Translation::get('msgCaptcha'), $user->isLoggedIn()),
    96|     'msgNewContentSubmit' => Translation::get('msgNewContentSubmit'),
    97|     'enableWysiwygEditor' => $faqConfig->get('main.enableWysiwygEditorFrontend'),
    98|     'currentTimestamp' => $request->server->get('REQUEST_TIME'),
    99|     'msgSeparateKeywordsWithCommas' => Translation::get('msgSeparateKeywordsWithCommas'),
   100|     'noCategories' => empty($categories),
   101|     'msgFormDisabledDueToMissingCategories' => Translation::get('msgFormDisabledDueToMissingCategories'),
   102|     'displayFullForm' => $displayFullForm,
   103| ];
   104| foreach ($formData as $input) {
   105|     $active = sprintf('id%d_active', (int)$input->input_id);
   106|     $label = sprintf('id%d_label', (int)$input->input_id);
   107|     $required = sprintf('id%d_required', (int)$input->input_id);
   108|     $templateVars = [
   109|         ...$templateVars,
   110|         $active => (bool)$input->input_active,
   111|         $label => $input->input_label,
   112|         $required => ((int)$input->input_required !== 0) ? 'required' : ''
   113|     ];
   114| }
   115| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/admin/attachments.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| /**
     3|  * Frontend for handling with attachments.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Anatoliy Belsky <ab@php.net>
    11|  * @copyright 2010-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2010-12-13
    15|  */
    16| use phpMyFAQ\Attachment\AttachmentCollection;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Pagination;
    21| use phpMyFAQ\Session\Token;
    22| use phpMyFAQ\Template\Extensions\FormatBytesTwigExtension;
    23| use phpMyFAQ\Template\TwigWrapper;
    24| use phpMyFAQ\Translation;
    25| use phpMyFAQ\User\CurrentUser;
    26| use Symfony\Component\HttpFoundation\Request;
    27| if (!defined('IS_VALID_PHPMYFAQ')) {
    28|     http_response_code(400);
    29|     exit();
    30| }
    31| $request = Request::createFromGlobals();
    32| $faqConfig = Configuration::getConfigurationInstance();
    33| $user = CurrentUser::getCurrentUser($faqConfig);
    34| if ($user->perm->hasPermission($user->getUserId(), PermissionType::ATTACHMENT_DELETE->value)) {
    35|     $page = Filter::filterVar($request->query->get('page'), FILTER_VALIDATE_INT);
    36|     $page = max(1, $page);
    37|     $attachmentCollection = new AttachmentCollection($faqConfig);
    38|     $itemsPerPage = 24;
    39|     $allCrumbs = $attachmentCollection->getBreadcrumbs();
    40|     $crumbs = array_slice($allCrumbs, ($page - 1) * $itemsPerPage, $itemsPerPage);
    41|     $baseUrl = sprintf(
    42|         '%sadmin/?action=attachments&amp;page=%d',
    43|         $faqConfig->getDefaultUrl(),
    44|         $page
    45|     );
    46|     $pagination = new Pagination(
    47|         [
    48|             'baseUrl' => $baseUrl,
    49|             'total' => is_countable($allCrumbs) ? count($allCrumbs) : 0,
    50|             'perPage' => $itemsPerPage,
    51|         ]
    52|     );
    53|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    54|     $twig->addExtension(new FormatBytesTwigExtension());
    55|     $template = $twig->loadTemplate('@admin/content/attachments.twig');
    56|     $templateVars = [
    57|         'adminHeaderAttachments' => Translation::get('ad_menu_attachment_admin'),
    58|         'adminMsgAttachmentsFilename' => Translation::get('msgAttachmentsFilename'),
    59|         'adminMsgTransToolLanguage' => Translation::get('msgTransToolLanguage'),
    60|         'adminMsgAttachmentsFilesize' => Translation::get('msgAttachmentsFilesize'),
    61|         'adminMsgAttachmentsMimeType' => Translation::get('msgAttachmentsMimeType'),
    62|         'csrfTokenDeletion' => Token::getInstance()->getTokenString('delete-attachment'),
    63|         'csrfTokenRefresh' => Token::getInstance()->getTokenString('refresh-attachment'),
    64|         'attachments' => $crumbs,
    65|         'adminMsgButtonDelete' => Translation::get('ad_gen_delete'),
    66|         'adminMsgFaqTitle' => Translation::get('ad_entry_faq_record'),
    67|         'adminAttachmentPagination' => $pagination->render()
    68|     ];
    69|     echo $template->render($templateVars);
    70| } else {
    71|     require __DIR__ . '/no-permission.php';
    72| }


# ====================================================================
# FILE: phpmyfaq/admin/backup.import.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-186 ---
     1| <?php
     2| /**
     3|  * The import function to import the phpMyFAQ backups.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Administration\Backup;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Database;
    19| use phpMyFAQ\Database\DatabaseHelper;
    20| use phpMyFAQ\Enums\PermissionType;
    21| use phpMyFAQ\Filter;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Strings;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User\CurrentUser;
    27| use Symfony\Component\HttpFoundation\Request;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $faqConfig = Configuration::getConfigurationInstance();
    33| $user = CurrentUser::getCurrentUser($faqConfig);
    34| $csrfToken = Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
    35| if (
    36|     $user->perm->hasPermission($user->getUserId(), PermissionType::RESTORE->value) &&
    37|     Token::getInstance()->verifyToken('restore', $csrfToken)
    38| ) {
    39|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    40|     $template = $twig->loadTemplate('@admin/backup/import.twig');
    41|     $templateVars = [
    42|         'adminHeaderRestore' => Translation::get('ad_csv_rest')
    43|     ];
    44|     $request = Request::createFromGlobals();
    45|     $file = $request->files->get('userfile');
    46|     if ($file && $file->isValid()) {
    47|         $ok = 1;
    48|         $fileInfo = new finfo(FILEINFO_MIME_ENCODING);
    49|         $dbHelper = new DatabaseHelper($faqConfig);
    50|         $backup = new Backup($faqConfig, $dbHelper);
    51|         if ('utf-8' !== $fileInfo->file($file->getPathname())) {
    52|             $templateVars = [
    53|                 ...$templateVars,
    54|                 'errorMessageWrongEncoding' => 'This file is not UTF-8 encoded.'
    55|             ];
    56|             $ok = 0;
    57|         }
    58|         $handle = fopen($file->getPathname(), 'r');
    59|         $backupData = fgets($handle, 65536);
    60|         $versionFound = Strings::substr($backupData, 0, 9);
    61|         $versionExpected = '-- pmf' . substr($faqConfig->getVersion(), 0, 3);
    62|         $queries = [];
    63|         $fileName = $file->getClientOriginalName();
    64|         try {
    65|             $verification = $backup->verifyBackup(file_get_contents($file->getPathname()), $fileName);
    66|             if ($verification) {
    67|                 $ok = 1;
    68|             } else {
    69|                 $templateVars = [
    70|                     ...$templateVars,
    71|                     'errorMessageNoVerification' => 'This file is not a verified backup file.'
    72|                 ];
    73|                 $ok = 0;
    74|             }
    75|         } catch (SodiumException) {
    76|             $templateVars = [
    77|                 ...$templateVars,
    78|                 'errorMessageNoVerification' => 'This file cannot be verified.'
    79|             ];
    80|             $ok = 0;
    81|         }
    82|         if ($versionFound !== $versionExpected) {
    83|             $templateVars = [
    84|                 ...$templateVars,
    85|                 'errorMessageVersionMisMatch' => sprintf(
    86|                     '%s (Version check failure: "%s" found, "%s" expected)',
    87|                     Translation::get('ad_csv_no'),
    88|                     $versionFound,
    89|                     $versionExpected
    90|                 )
    91|             ];
    92|             $ok = 0;
    93|         }
    94|         if ($ok === 1) {
    95|             $backupData = trim(Strings::substr($backupData, 11));
    96|             $tables = explode(' ', $backupData);
    97|             $numTables = count($tables);
    98|             for ($h = 0; $h < $numTables; ++$h) {
    99|                 $queries[] = sprintf('DELETE FROM %s', $tables[$h]);
   100|             }
   101|             $ok = 1;
   102|         }
   103|         if ($ok === 1) {
   104|             $tablePrefix = '';
   105|             $templateVars = [
   106|                 ...$templateVars,
   107|                 'prepareMessage' => Translation::get('ad_csv_prepare')
   108|             ];
   109|             while ($backupData = fgets($handle, 65536)) {
   110|                 $backupData = trim($backupData);
   111|                 $backupPrefixPattern = '-- pmftableprefix:';
   112|                 $backupPrefixPatternLength = Strings::strlen($backupPrefixPattern);
   113|                 if (Strings::substr($backupData, 0, $backupPrefixPatternLength) === $backupPrefixPattern) {
   114|                     $tablePrefix = trim(Strings::substr($backupData, $backupPrefixPatternLength));
   115|                 }
   116|                 if ((Strings::substr($backupData, 0, 2) != '--') && ($backupData != '')) {
   117|                     $queries[] = trim(Strings::substr($backupData, 0, -1));
   118|                 }
   119|             }
   120|             $k = 0;
   121|             $g = 0;
   122|             $templateVars = [
   123|                 ...$templateVars,
   124|                 'processMessage' => Translation::get('ad_csv_process')
   125|             ];
   126|             $numTables = count($queries);
   127|             $kg = '';
   128|             for ($i = 0; $i < $numTables; ++$i) {
   129|                 $queries[$i] = DatabaseHelper::alignTablePrefix($queries[$i], $tablePrefix, Database::getTablePrefix());
   130|                 $kg = $faqConfig->getDb()->query($queries[$i]);
   131|                 if (!$kg) {
   132|                     $templateVars = [
   133|                         ...$templateVars,
   134|                         'errorMessageQueryFailed' => sprintf(
   135|                             '<strong>Query</strong>: "%s" failed (Reason: %s)',
   136|                             Strings::htmlspecialchars($queries[$i], ENT_QUOTES),
   137|                             $faqConfig->getDb()->error()
   138|                         )
   139|                     ];
   140|                     ++$k;
   141|                 } else {
   142|                     printf(
   143|                         '<!-- Query: "%s" okay</div> -->%s',
   144|                         Strings::htmlspecialchars($queries[$i], ENT_QUOTES),
   145|                         "\n"
   146|                     );
   147|                     ++$g;
   148|                 }
   149|             }
   150|             $templateVars = [
   151|                 ...$templateVars,
   152|                 'successMessage' => sprintf(
   153|                     '%d %s %d %s',
   154|                     $g,
   155|                     Translation::get('ad_csv_of'),
   156|                     $numTables,
   157|                     Translation::get('ad_csv_suc')
   158|                 )
   159|             ];
   160|         } else {
   161|             $templateVars = [
   162|                 ...$templateVars,
   163|                 'errorMessageImportNotPossible' => Translation::get('ad_csv_no')
   164|             ];
   165|         }
   166|     } else {
   167|         $errorMessage = match ($file->getError()) {
   168|             1 => 'The uploaded file exceeds the upload_max_filesize directive in php.ini.',
   169|             2 => 'The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the ' . 'HTML form.',
   170|             3 => 'The uploaded file was only partially uploaded.',
   171|             4 => 'No file was uploaded.',
   172|             6 => 'Missing a temporary folder.',
   173|             7 => 'Failed to write file to disk.',
   174|             8 => 'A PHP extension stopped the file upload.',
   175|             default => 'Undefined error.',
   176|         };
   177|         $templateVars = [
   178|             ...$templateVars,
   179|             'errorMessageUpload' => Translation::get('ad_csv_no'),
   180|             'errorMessageUploadDetails' => $errorMessage
   181|         ];
   182|     }
   183|     echo $template->render($templateVars);
   184| } else {
   185|     require __DIR__ . '/no-permission.php';
   186| }


# ====================================================================
# FILE: phpmyfaq/admin/backup.main.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| <?php
     2| /**
     3|  * Frontend for Backup and Restore.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Session\Token;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use phpMyFAQ\User\CurrentUser;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = Configuration::getConfigurationInstance();
    27| $user = CurrentUser::getCurrentUser($faqConfig);
    28| if ($user->perm->hasPermission($user->getUserId(), PermissionType::BACKUP->value)) {
    29|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    30|     $template = $twig->loadTemplate('@admin/backup/main.twig');
    31|     $templateVars = [
    32|         'adminHeaderBackup' => Translation::get('ad_csv_backup'),
    33|         'adminBackupCardHeader' => Translation::get('ad_csv_head'),
    34|         'adminBackupCardBody' => Translation::get('ad_csv_make'),
    35|         'adminBackupLinkData' => Translation::get('ad_csv_linkdat'),
    36|         'adminBackupLinkLogs' => Translation::get('ad_csv_linklog'),
    37|         'csrfToken' => Token::getInstance()->getTokenString('restore'),
    38|         'adminRestoreCardHeader' => Translation::get('ad_csv_head2'),
    39|         'adminRestoreCardBody' => Translation::get('ad_csv_restore'),
    40|         'adminRestoreLabel' => Translation::get('ad_csv_file'),
    41|         'adminRestoreButton' => Translation::get('ad_csv_ok'),
    42|     ];
    43|     echo $template->render($templateVars);
    44| } else {
    45|     require __DIR__ . '/no-permission.php';
    46| }


# ====================================================================
# FILE: phpmyfaq/admin/category.add.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-90 ---
     1| <?php
     2| /**
     3|  * Adds a new (sub-)category, a new sub-category inherits the permissions from
     4|  * its parent category.
     5|  *
     6|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     7|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     8|  * obtain one at https://mozilla.org/MPL/2.0/.
     9|  *
    10|  * @package   phpMyFAQ
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @copyright 2003-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2003-12-20
    16|  */
    17| use phpMyFAQ\Category\Permission;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Helper\UserHelper;
    21| use phpMyFAQ\Language\LanguageCodes;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Translation;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| if (!defined('IS_VALID_PHPMYFAQ')) {
    26|     http_response_code(400);
    27|     exit();
    28| }
    29| $faqConfig = $container->get('phpmyfaq.configuration');
    30| $currentUser = $container->get('phpmyfaq.user.current_user');
    31| if ($currentUser->perm->hasPermission($currentUser->getUserId(), PermissionType::CATEGORY_ADD->value)) {
    32|     $category = $container->get('phpmyfaq.admin.category');
    33|     $category->setUser($currentUser->getUserId());
    34|     $category->setGroups($currentAdminGroups);
    35|     $category->setLanguage($faqConfig->getLanguage()->getLanguage());
    36|     $category->loadCategories();
    37|     $categoryPermission = $container->get('phpmyfaq.category.permission');
    38|     $userHelper = new UserHelper($currentUser);
    39|     $parentId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT, 0);
    40|     $templateVars = [
    41|         'csrfTokenInput' => Token::getInstance()->getTokenInput('save-category'),
    42|         'faqLangCode' => $faqLangCode,
    43|         'parentId' => $parentId,
    44|         'ad_categ_new' => Translation::get('ad_categ_new'),
    45|         'msgCategoryMatrix' => Translation::get('msgCategoryMatrix'),
    46|         'userOptions' => $userHelper->getAllUserOptions(),
    47|         'ad_categ_title' => Translation::get('ad_categ_titel'),
    48|         'ad_categ_owner' => Translation::get('ad_categ_owner'),
    49|         'ad_categ_desc' => Translation::get('ad_categ_desc'),
    50|         'ad_category_image' => Translation::get('ad_category_image'),
    51|         'ad_user_active' => Translation::get('ad_user_active'),
    52|         'ad_user_show_home' => Translation::get('ad_user_show_home'),
    53|         'permLevel' => $faqConfig->get('security.permLevel'),
    54|         'ad_entry_all_users' => Translation::get('ad_entry_all_users'),
    55|         'ad_entry_restricted_users' => Translation::get('ad_entry_restricted_users'),
    56|         'ad_entry_userpermission' => Translation::get('ad_entry_userpermission'),
    57|         'ad_categ_add' => Translation::get('ad_categ_add'),
    58|         'ad_entry_grouppermission' => Translation::get('ad_entry_grouppermission'),
    59|         'ad_entry_all_groups' => Translation::get('ad_entry_all_groups'),
    60|         'ad_entry_restricted_groups' => Translation::get('ad_entry_restricted_groups'),
    61|         'msgSerpTitle' => Translation::get('msgSerpTitle'),
    62|         'msgSerpDescription' => Translation::get('msgSerpDescription'),
    63|         'restricted_groups' => ($faqConfig->get('security.permLevel') === 'medium') ?
    64|             $currentUser->perm->getAllGroupsOptions([], $user) : '',
    65|     ];
    66|     if ($parentId > 0) {
    67|         $userAllowed = $categoryPermission->get(Permission::USER, [$parentId]);
    68|         $groupsAllowed = $categoryPermission->get(Permission::GROUP, [$parentId]);
    69|         $templateVars = [
    70|             ...$templateVars,
    71|             'categoryNameLangCode' => LanguageCodes::get($category->categoryName[$parentId]['lang']),
    72|             'userAllowed' => $categoryPermission->get(Permission::USER, [$parentId])[0],
    73|             'groupsAllowed' => $categoryPermission->get(Permission::GROUP, [$parentId]),
    74|             'categoryName' => $category->categoryName[$parentId]['name'],
    75|             'msgMainCategory' => Translation::get('msgMainCategory'),
    76|         ];
    77|     }
    78|     if ($faqConfig->get('security.permLevel') !== 'basic') {
    79|         $templateVars = [
    80|             ...$templateVars,
    81|             'groupsOptions' => $currentUser->perm->getAllGroupsOptions([], $currentUser),
    82|             'ad_categ_moderator' => Translation::get('ad_categ_moderator')
    83|         ];
    84|     }
    85|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    86|     $template = $twig->loadTemplate('@admin/content/category.add.twig');
    87|     echo $template->render($templateVars);
    88| } else {
    89|     require __DIR__ . '/no-permission.php';
    90| }


# ====================================================================
# FILE: phpmyfaq/admin/category.edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-122 ---
     1| <?php
     2| /**
     3|  * Edits a category.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-03-10
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Category\Permission;
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Entity\SeoEntity;
    20| use phpMyFAQ\Enums\PermissionType;
    21| use phpMyFAQ\Enums\SeoType;
    22| use phpMyFAQ\Filter;
    23| use phpMyFAQ\Helper\UserHelper;
    24| use phpMyFAQ\Seo;
    25| use phpMyFAQ\Session\Token;
    26| use phpMyFAQ\Strings;
    27| use phpMyFAQ\Template\TwigWrapper;
    28| use phpMyFAQ\Translation;
    29| use phpMyFAQ\User\CurrentUser;
    30| if (!defined('IS_VALID_PHPMYFAQ')) {
    31|     http_response_code(400);
    32|     exit();
    33| }
    34| $faqConfig = Configuration::getConfigurationInstance();
    35| $currentUser = CurrentUser::getCurrentUser($faqConfig);
    36| $currentUserId = $currentUser->getUserId();
    37| if ($currentUser->perm->hasPermission($currentUser->getUserId(), PermissionType::CATEGORY_EDIT->value)) {
    38|     $categoryId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT, 0);
    39|     $category = new Category($faqConfig, [], false);
    40|     $category
    41|         ->setUser($currentAdminUser)
    42|         ->setGroups($currentAdminGroups)
    43|         ->setLanguage($faqLangCode);
    44|     $categoryPermission = new Permission($faqConfig);
    45|     $userHelper = new UserHelper($currentUser);
    46|     $categoryData = $category->getCategoryData($categoryId);
    47|     $seo = new Seo($faqConfig);
    48|     $seoEntity = new SeoEntity();
    49|     $seoEntity->setType(SeoType::CATEGORY);
    50|     $seoEntity->setReferenceId($categoryId);
    51|     $seoEntity->setReferenceLanguage($categoryData->getLang());
    52|     $seoData = $seo->get($seoEntity);
    53|     $userPermission = $categoryPermission->get(Permission::USER, [$categoryId]);
    54|     if ($userPermission[0] == -1) {
    55|         $allUsers = true;
    56|         $restrictedUsers = false;
    57|     } else {
    58|         $allUsers = false;
    59|         $restrictedUsers = true;
    60|     }
    61|     $groupPermission = $categoryPermission->get(Permission::GROUP, [$categoryId]);
    62|     if ($groupPermission[0] == -1) {
    63|         $allGroups = true;
    64|         $restrictedGroups = false;
    65|     } else {
    66|         $allGroups = false;
    67|         $restrictedGroups = true;
    68|     }
    69|     $header = Translation::get('ad_categ_edit_1') . ' "' . $categoryData->getName() . '" ' .
    70|         Translation::get('ad_categ_edit_2');
    71|     $allGroupsOptions = '';
    72|     $restrictedGroupsOptions = '';
    73|     if ($faqConfig->get('security.permLevel') !== 'basic') {
    74|         $allGroupsOptions = $currentUser->perm->getAllGroupsOptions([$categoryData->getGroupId()], $currentUser);
    75|         $restrictedGroupsOptions = $currentUser->perm->getAllGroupsOptions($groupPermission, $currentUser);
    76|     }
    77|     $templateVars = [
    78|         'header' => $header,
    79|         'categoryId' => $categoryId,
    80|         'categoryLanguage' => $categoryData->getLang(),
    81|         'parentId' => $categoryData->getParentId(),
    82|         'csrfInputToken' => Token::getInstance()->getTokenInput('update-category'),
    83|         'categoryImage' => $categoryData->getImage(),
    84|         'categoryNameLabel' => Translation::get('ad_categ_titel'),
    85|         'categoryName' => $categoryData->getName(),
    86|         'categoryDescriptionLabel' => Translation::get('ad_categ_desc'),
    87|         'categoryDescription' => $categoryData->getDescription(),
    88|         'categoryActiveLabel' => Translation::get('ad_user_active'),
    89|         'categoryActive' => 1 === (int)$categoryData->getActive() ? 'checked' : '',
    90|         'categoryShowHomeLabel' => Translation::get('ad_user_show_home'),
    91|         'categoryShowHome' => 1 === (int)$categoryData->getShowHome() ? 'checked' : '',
    92|         'categoryImageLabel' => Translation::get('ad_category_image'),
    93|         'categoryImageReset' => 'Reset category image',
    94|         'categoryOwnerLabel' => Translation::get('ad_categ_owner'),
    95|         'categoryOwnerOptions' => $userHelper->getAllUserOptions($categoryData->getUserId()),
    96|         'isMediumPermission' => $faqConfig->get('security.permLevel') !== 'basic',
    97|         'categoryModeratorLabel' => Translation::get('ad_categ_moderator'),
    98|         'allGroupsOptions' => $allGroupsOptions,
    99|         'categoryGroupPermissionLabel' => Translation::get('ad_entry_grouppermission'),
   100|         'allGroups' => $allGroups ? 'checked' : '',
   101|         'categoryGroupPermissionAllLabel' => Translation::get('ad_entry_all_groups'),
   102|         'restrictedGroups' => $restrictedGroups ? 'checked' : '',
   103|         'restrictedGroupsLabel' => Translation::get('ad_entry_restricted_groups'),
   104|         'restrictedGroupsOptions' => $restrictedGroupsOptions,
   105|         'userPermissionLabel' => Translation::get('ad_entry_userpermission'),
   106|         'allUsers' => $allUsers ? 'checked' : '',
   107|         'allUsersLabel' => Translation::get('ad_entry_all_users'),
   108|         'restrictedUsers' => $restrictedUsers ? 'checked' : '',
   109|         'restrictedUsersLabel' => Translation::get('ad_entry_restricted_users'),
   110|         'allUsersOptions' => $userHelper->getAllUserOptions($categoryData->getUserId()),
   111|         'msgSerpTitle' => Translation::get('msgSerpTitle'),
   112|         'serpTitle' => $seoData->getTitle(),
   113|         'msgSerpDescription' => Translation::get('msgSerpDescription'),
   114|         'serpDescription' => $seoData->getDescription(),
   115|         'buttonUpdate' => Translation::get('ad_gen_save'),
   116|     ];
   117|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   118|     $template = $twig->loadTemplate('@admin/content/category.edit.twig');
   119|     echo $template->render($templateVars);
   120| } else {
   121|     require __DIR__ . '/no-permission.php';
   122| }


# ====================================================================
# FILE: phpmyfaq/admin/category.main.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-301 ---
     1| <?php
     2| /**
     3|  * List all categories in the admin section.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at http://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-12-20
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Category\Image;
    18| use phpMyFAQ\Category\Order;
    19| use phpMyFAQ\Category\Permission;
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Database;
    22| use phpMyFAQ\Entity\CategoryEntity;
    23| use phpMyFAQ\Entity\SeoEntity;
    24| use phpMyFAQ\Enums\PermissionType;
    25| use phpMyFAQ\Enums\SeoType;
    26| use phpMyFAQ\Filter;
    27| use phpMyFAQ\Seo;
    28| use phpMyFAQ\Session\Token;
    29| use phpMyFAQ\Template\TwigWrapper;
    30| use phpMyFAQ\Translation;
    31| use phpMyFAQ\User\CurrentUser;
    32| use Symfony\Component\HttpFoundation\File\UploadedFile;
    33| use Symfony\Component\HttpFoundation\Request;
    34| if (!defined('IS_VALID_PHPMYFAQ')) {
    35|     http_response_code(400);
    36|     exit();
    37| }
    38| $faqConfig = Configuration::getConfigurationInstance();
    39| $currentUser = CurrentUser::getCurrentUser($faqConfig);
    40| $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
    41| $request = Request::createFromGlobals();
    42| $uploadedFile = $request->files->get('image') ?? [];
    43| $categoryImage = new Image($faqConfig);
    44| if ($uploadedFile instanceof UploadedFile) {
    45|     $categoryImage->setUploadedFile($uploadedFile);
    46| }
    47| $categoryPermission = new Permission($faqConfig);
    48| $seo = new Seo($faqConfig);
    49| if ($currentUser->perm->hasPermission($currentUser->getUserId(), PermissionType::CATEGORY_EDIT->value)) {
    50|     $templateVars = [
    51|         'msgHeaderCategoryMain' => Translation::get('msgHeaderCategoryOverview'),
    52|     ];
    53|     if ($action === 'savecategory' && Token::getInstance()->verifyToken('save-category', $csrfToken)) {
    54|         $category = new Category($faqConfig, [], false);
    55|         $category->setUser($currentAdminUser);
    56|         $category->setGroups($currentAdminGroups);
    57|         $parentId = Filter::filterInput(INPUT_POST, 'parent_id', FILTER_VALIDATE_INT);
    58|         $categoryId = $faqConfig->getDb()->nextId(Database::getTablePrefix() . 'faqcategories', 'id');
    59|         $categoryLang = Filter::filterInput(INPUT_POST, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);
    60|         $categoryEntity = new CategoryEntity();
    61|         $categoryEntity
    62|             ->setParentId($parentId)
    63|             ->setLang($categoryLang)
    64|             ->setName(Filter::filterInput(INPUT_POST, 'name', FILTER_SANITIZE_SPECIAL_CHARS))
    65|             ->setDescription(Filter::filterInput(INPUT_POST, 'description', FILTER_SANITIZE_SPECIAL_CHARS))
    66|             ->setUserId(Filter::filterInput(INPUT_POST, 'user_id', FILTER_VALIDATE_INT))
    67|             ->setGroupId(Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT) ?? -1)
    68|             ->setActive(Filter::filterInput(INPUT_POST, 'active', FILTER_VALIDATE_INT) ?? false)
    69|             ->setImage($categoryImage->getFileName($categoryId, $categoryLang))
    70|             ->setParentId($parentId)
    71|             ->setShowHome(Filter::filterInput(INPUT_POST, 'show_home', FILTER_VALIDATE_INT));
    72|         $permissions = [];
    73|         if ('all' === Filter::filterInput(INPUT_POST, 'userpermission', FILTER_SANITIZE_SPECIAL_CHARS)) {
    74|             $permissions += [
    75|                 'restricted_user' => [
    76|                     -1,
    77|                 ],
    78|             ];
    79|         } else {
    80|             $permissions += [
    81|                 'restricted_user' => [
    82|                     Filter::filterInput(INPUT_POST, 'restricted_users', FILTER_VALIDATE_INT),
    83|                 ],
    84|             ];
    85|         }
    86|         if ('all' === Filter::filterInput(INPUT_POST, 'grouppermission', FILTER_SANITIZE_SPECIAL_CHARS)) {
    87|             $permissions += [
    88|                 'restricted_groups' => [
    89|                     -1,
    90|                 ],
    91|             ];
    92|         } else {
    93|             $permissions += Filter::filterInputArray(
    94|                 INPUT_POST,
    95|                 [
    96|                     'restricted_groups' => [
    97|                         'filter' => FILTER_VALIDATE_INT,
    98|                         'flags' => FILTER_REQUIRE_ARRAY,
    99|                     ],
   100|                 ]
   101|             );
   102|         }
   103|         if ($category->checkIfCategoryExists($categoryEntity) > 0) {
   104|             $templateVars = [
   105|                 ...$templateVars,
   106|                 'isError' => true,
   107|                 'errorMessage' => Translation::get('ad_categ_existing'),
   108|             ];
   109|         }
   110|         $categoryId = $category->create($categoryEntity);
   111|         if ($categoryId) {
   112|             $categoryPermission->add(Permission::USER, [$categoryId], $permissions['restricted_user']);
   113|             $categoryPermission->add(
   114|                 Permission::GROUP,
   115|                 [$categoryId],
   116|                 $permissions['restricted_groups']
   117|             );
   118|             if ($categoryImage->getFileName($categoryId, $categoryLang)) {
   119|                 try {
   120|                     $categoryImage->upload();
   121|                 } catch (Exception $exception) {
   122|                     $templateVars = [
   123|                         ...$templateVars,
   124|                         'isWarning' => true,
   125|                         'warningMessage' => $exception->getMessage(),
   126|                     ];
   127|                 }
   128|             }
   129|             $categoryOrder = new Order($faqConfig);
   130|             $categoryOrder->add($categoryId, $parentId);
   131|             $languages = Filter::filterInput(INPUT_POST, 'used_translated_languages', FILTER_SANITIZE_SPECIAL_CHARS);
   132|             $seoEntity = new SeoEntity();
   133|             $seoEntity
   134|                 ->setType(SeoType::CATEGORY)
   135|                 ->setReferenceId($categoryId)
   136|                 ->setReferenceLanguage($categoryLang)
   137|                 ->setTitle(Filter::filterInput(INPUT_POST, 'serpTitle', FILTER_SANITIZE_SPECIAL_CHARS))
   138|                 ->setDescription(Filter::filterInput(INPUT_POST, 'serpDescription', FILTER_SANITIZE_SPECIAL_CHARS));
   139|             $seo->create($seoEntity);
   140|             $templateVars = [
   141|                 ...$templateVars,
   142|                 'isSuccess' => true,
   143|                 'successMessage' => Translation::get('ad_categ_added')
   144|             ];
   145|         } else {
   146|             $templateVars = [
   147|                 ...$templateVars,
   148|                 'isError' => true,
   149|                 'errorMessage' => $faqConfig->getDb()->error(),
   150|             ];
   151|         }
   152|     }
   153|     if ($action === 'updatecategory' && Token::getInstance()->verifyToken('update-category', $csrfToken)) {
   154|         $category = new Category($faqConfig, [], false);
   155|         $category->setUser($currentAdminUser);
   156|         $category->setGroups($currentAdminGroups);
   157|         $parentId = Filter::filterInput(INPUT_POST, 'parent_id', FILTER_VALIDATE_INT);
   158|         $categoryId = Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);
   159|         $categoryLang = Filter::filterInput(INPUT_POST, 'catlang', FILTER_SANITIZE_SPECIAL_CHARS);
   160|         $existingImage = Filter::filterInput(INPUT_POST, 'existing_image', FILTER_SANITIZE_SPECIAL_CHARS);
   161|         $existingImage = is_null($existingImage) ? '' : $existingImage;
   162|         $image = count($uploadedFile) ? $categoryImage->getFileName(
   163|             $categoryId,
   164|             $categoryLang
   165|         ) : $existingImage;
   166|         $categoryEntity = new CategoryEntity();
   167|         $categoryEntity
   168|             ->setId($categoryId)
   169|             ->setLang($categoryLang)
   170|             ->setParentId($parentId)
   171|             ->setName(Filter::filterInput(INPUT_POST, 'name', FILTER_SANITIZE_SPECIAL_CHARS))
   172|             ->setDescription(Filter::filterInput(INPUT_POST, 'description', FILTER_SANITIZE_SPECIAL_CHARS))
   173|             ->setUserId(Filter::filterInput(INPUT_POST, 'user_id', FILTER_VALIDATE_INT))
   174|             ->setGroupId(Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT) ?? -1)
   175|             ->setActive(Filter::filterInput(INPUT_POST, 'active', FILTER_VALIDATE_INT))
   176|             ->setImage($image)
   177|             ->setShowHome(Filter::filterInput(INPUT_POST, 'show_home', FILTER_VALIDATE_INT));
   178|         $permissions = [];
   179|         if ('all' === Filter::filterInput(INPUT_POST, 'userpermission', FILTER_SANITIZE_SPECIAL_CHARS)) {
   180|             $permissions += [
   181|                 'restricted_user' => [
   182|                     -1,
   183|                 ],
   184|             ];
   185|         } else {
   186|             $permissions += [
   187|                 'restricted_user' => [
   188|                     Filter::filterInput(INPUT_POST, 'restricted_users', FILTER_VALIDATE_INT),
   189|                 ],
   190|             ];
   191|         }
   192|         if ('all' === Filter::filterInput(INPUT_POST, 'grouppermission', FILTER_SANITIZE_SPECIAL_CHARS)) {
   193|             $permissions += [
   194|                 'restricted_groups' => [
   195|                     -1,
   196|                 ],
   197|             ];
   198|         } else {
   199|             $permissions += Filter::filterInputArray(
   200|                 INPUT_POST,
   201|                 [
   202|                     'restricted_groups' => [
   203|                         'filter' => FILTER_VALIDATE_INT,
   204|                         'flags' => FILTER_REQUIRE_ARRAY,
   205|                     ],
   206|                 ]
   207|             );
   208|         }
   209|         if (!$category->hasLanguage($categoryEntity->getId(), $categoryEntity->getLang())) {
   210|             if (
   211|                 $category->create($categoryEntity) && $categoryPermission->add(
   212|                     Permission::USER,
   213|                     [$categoryEntity->getId()],
   214|                     $permissions['restricted_user']
   215|                 ) && $categoryPermission->add(
   216|                     Permission::GROUP,
   217|                     [$categoryEntity->getId()],
   218|                     $permissions['restricted_groups']
   219|                 )
   220|             ) {
   221|                 $seoEntity = new SeoEntity();
   222|                 $seoEntity
   223|                     ->setType(SeoType::CATEGORY)
   224|                     ->setReferenceId($categoryEntity->getId())
   225|                     ->setReferenceLanguage($categoryEntity->getLang())
   226|                     ->setTitle(Filter::filterInput(INPUT_POST, 'serpTitle', FILTER_SANITIZE_SPECIAL_CHARS))
   227|                     ->setDescription(Filter::filterInput(INPUT_POST, 'serpDescription', FILTER_SANITIZE_SPECIAL_CHARS));
   228|                 if ($seo->get(clone $seoEntity)->getId() === null) {
   229|                     $seo->create($seoEntity);
   230|                 } else {
   231|                     $seo->update($seoEntity);
   232|                 }
   233|                 $templateVars = [
   234|                     ...$templateVars,
   235|                     'isSuccess' => true,
   236|                     'successMessage' => Translation::get('ad_categ_translated')
   237|                 ];
   238|             } else {
   239|                 $templateVars = [
   240|                     ...$templateVars,
   241|                     'isError' => true,
   242|                     'errorMessage' => $faqConfig->getDb()->error(),
   243|                 ];
   244|             }
   245|         } else {
   246|             if ($category->update($categoryEntity)) {
   247|                 $categoryPermission->delete(Permission::USER, [$categoryEntity->getId()]);
   248|                 $categoryPermission->delete(Permission::GROUP, [$categoryEntity->getId()]);
   249|                 $categoryPermission->add(
   250|                     Permission::USER,
   251|                     [$categoryEntity->getId()],
   252|                     $permissions['restricted_user']
   253|                 );
   254|                 $categoryPermission->add(
   255|                     Permission::GROUP,
   256|                     [$categoryEntity->getId()],
   257|                     $permissions['restricted_groups']
   258|                 );
   259|                 if ($categoryImage->getFileName($categoryId, $categoryLang)) {
   260|                     try {
   261|                         $categoryImage->upload();
   262|                     } catch (Exception $exception) {
   263|                         $templateVars = [
   264|                             ...$templateVars,
   265|                             'isWarning' => true,
   266|                             'warningMessage' => $exception->getMessage(),
   267|                         ];
   268|                     }
   269|                 }
   270|                 $seoEntity = new SeoEntity();
   271|                 $seoEntity
   272|                     ->setType(SeoType::CATEGORY)
   273|                     ->setReferenceId($categoryId)
   274|                     ->setReferenceLanguage($categoryLang)
   275|                     ->setTitle(Filter::filterInput(INPUT_POST, 'serpTitle', FILTER_SANITIZE_SPECIAL_CHARS))
   276|                     ->setDescription(Filter::filterInput(INPUT_POST, 'serpDescription', FILTER_SANITIZE_SPECIAL_CHARS));
   277|                 if ($seo->get(clone $seoEntity)->getId() === null) {
   278|                     $seo->create($seoEntity);
   279|                 } else {
   280|                     $seo->update($seoEntity);
   281|                 }
   282|                 $templateVars = [
   283|                     ...$templateVars,
   284|                     'isSuccess' => true,
   285|                     'successMessage' => Translation::get('ad_categ_updated')
   286|                 ];
   287|             } else {
   288|                 $templateVars = [
   289|                     ...$templateVars,
   290|                     'isError' => true,
   291|                     'errorMessage' => $faqConfig->getDb()->error(),
   292|                 ];
   293|             }
   294|         }
   295|     }
   296|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   297|     $template = $twig->loadTemplate('@admin/content/category.main.twig');
   298|     echo $template->render($templateVars);
   299| } else {
   300|     require __DIR__ . '/no-permission.php';
   301| }


# ====================================================================
# FILE: phpmyfaq/admin/category.overview.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-44 ---
     1| <?php
     2| /**
     3|  * List all categories in the admin section with drag and drop support for sorting.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at http://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2023-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2013-12-30
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Category\Order;
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Session\Token;
    20| use phpMyFAQ\Template\TwigWrapper;
    21| use Symfony\Component\HttpFoundation\Request;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $request = Request::createFromGlobals();
    27| $faqConfig = Configuration::getConfigurationInstance();
    28| $category = new Category($faqConfig, [], false);
    29| $category->buildCategoryTree();
    30| $categoryInfo = $category->getAllCategories();
    31| $categoryOrder = new Order($faqConfig);
    32| $orderedCategories = $categoryOrder->getAllCategories();
    33| $categoryTree = $categoryOrder->getCategoryTree($orderedCategories);
    34| if (empty($categoryTree)) {
    35|     $categoryTree = $category->buildAdminCategoryTree($categoryInfo);
    36| }
    37| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    38| $template = $twig->loadTemplate('@admin/content/category.overview.twig');
    39| $templateVars = [
    40|     'csrfTokenInput' => Token::getInstance()->getTokenInput('category'),
    41|     'categoryTree' => $categoryTree,
    42|     'categoryInfo' => $categoryInfo,
    43| ];
    44| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/category.showstructure.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-110 ---
     1| <?php
     2| /**
     3|  * Builds a table of all categories in all languages.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Rudi Ferrari <bookcrossers@gmx.de>
    12|  * @author    Jan Harms <model_railroader@gmx-topmail.de>
    13|  * @copyright 2006-2024 phpMyFAQ Team
    14|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    15|  * @link      https://www.phpmyfaq.de
    16|  * @since     2006-09-18
    17|  */
    18| use phpMyFAQ\Category;
    19| use phpMyFAQ\Entity\CategoryEntity;
    20| use phpMyFAQ\Enums\PermissionType;
    21| use phpMyFAQ\Filter;
    22| use phpMyFAQ\Language\LanguageCodes;
    23| use phpMyFAQ\Template\TwigWrapper;
    24| use phpMyFAQ\Translation;
    25| use Symfony\Component\HttpFoundation\Request;
    26| if (!defined('IS_VALID_PHPMYFAQ')) {
    27|     http_response_code(400);
    28|     exit();
    29| }
    30| $request = Request::createFromGlobals();
    31| if ($user->perm->hasPermission($user->getUserId(), PermissionType::CATEGORY_EDIT->value)) {
    32|     $templateVars = [];
    33|     $category = new Category($faqConfig, [], false);
    34|     $category->setUser($currentAdminUser);
    35|     $category->setGroups($currentAdminGroups);
    36|     $currentLanguage = LanguageCodes::get($faqLangCode);
    37|     $allLanguages = [];
    38|     $all_lang = [];
    39|     $showCategory = Filter::filterInput(INPUT_POST, 'showCategory', FILTER_SANITIZE_SPECIAL_CHARS);
    40|     if ($showCategory === 'yes') {
    41|         $categoryEntity = new CategoryEntity();
    42|         $categoryEntity
    43|             ->setId(Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT))
    44|             ->setLang(Filter::filterInput(INPUT_POST, 'lang', FILTER_SANITIZE_SPECIAL_CHARS))
    45|             ->setParentId(Filter::filterInput(INPUT_POST, 'parent_id', FILTER_VALIDATE_INT))
    46|             ->setName(Filter::filterInput(INPUT_POST, 'name', FILTER_SANITIZE_SPECIAL_CHARS))
    47|             ->setDescription(Filter::filterInput(INPUT_POST, 'description', FILTER_SANITIZE_SPECIAL_CHARS))
    48|             ->setUserId(Filter::filterInput(INPUT_POST, 'user_id', FILTER_VALIDATE_INT));
    49|         if ($category->create($categoryEntity)) {
    50|             $templateVars = [
    51|                 ...$templateVars,
    52|                 'message' => Translation::get('ad_categ_translated'),
    53|                 'message_typ' => 'success'
    54|             ];
    55|         } else {
    56|             $templateVars = [
    57|                 ...$templateVars,
    58|                 'message_heading' => Translation::get('ad_adus_dberr'),
    59|                 'error' => $faqConfig->getDb()->error(),
    60|                 'message_typ' => 'danger'
    61|             ];
    62|         }
    63|     }
    64|     $category->getMissingCategories();
    65|     $category->buildCategoryTree();
    66|     $allLanguages = $faqConfig->getLanguage()->isLanguageAvailable(0, $table = 'faqcategories');
    67|     foreach ($allLanguages as $lang) {
    68|         $all_lang[$lang] = LanguageCodes::get($lang);
    69|     }
    70|     asort($all_lang);
    71|     $translations = [];
    72|     foreach ($category->getCategoryTree() as $cat) {
    73|         $id_languages = $category->getCategoryLanguagesTranslated($cat['id']);
    74|         $spokenLanguage = [];
    75|         $translation_array = [];
    76|         foreach ($id_languages as $lang => $title) {
    77|             $translation_array[] = $lang;
    78|         }
    79|         $translations[$cat['id']] = $translation_array;
    80|     }
    81|     $all_lang_codes = [LanguageCodes::getKey($currentLanguage)];
    82|     foreach ($all_lang as $language) {
    83|         if ($language !== $currentLanguage) {
    84|             $all_lang_codes[] = LanguageCodes::getKey($language);
    85|         }
    86|     }
    87|     $templateVars = [
    88|         ...$templateVars,
    89|         'currentLanguage' => $currentLanguage,
    90|         'allLangs' => $all_lang,
    91|         'allLangCodes' => $all_lang_codes,
    92|         'categoryTree' => $category->getCategoryTree(),
    93|         'basePath' => $request->getBasePath(),
    94|         'faqlangcode' => $faqLangCode,
    95|         'msgCategoryRemark_overview' => Translation::get('msgCategoryRemark_overview'),
    96|         'ad_categ_title' => Translation::get('ad_categ_titel'),
    97|         'ad_categ_translate' => Translation::get('ad_categ_translate'),
    98|         'ad_menu_categ_structure' => Translation::get('ad_menu_categ_structure'),
    99|         'msgAddCategory' => Translation::get('msgAddCategory'),
   100|         'msgHeaderCategoryOverview' => Translation::get('msgHeaderCategoryOverview'),
   101|         'msgCategory' => Translation::get('msgCategory'),
   102|         'translations' => $translations,
   103|         'ad_categ_translated' => Translation::get('ad_categ_translated')
   104|     ];
   105|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   106|     $template = $twig->loadTemplate('@admin/content/category.showstructure.twig');
   107|     echo $template->render($templateVars);
   108| } else {
   109|     require __DIR__ . '/no-permission.php';
   110| }


# ====================================================================
# FILE: phpmyfaq/admin/category.translate.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| /**
     3|  * Category translation frontend
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Rudi Ferrari <bookcrossers@gmx.de>
    12|  * @copyright 2006-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2006-09-10
    16|  */
    17| use phpMyFAQ\Category;
    18| use phpMyFAQ\Category\Permission;
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Helper\UserHelper;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\TwigWrapper;
    24| use phpMyFAQ\Translation;
    25| if (!defined('IS_VALID_PHPMYFAQ')) {
    26|     http_response_code(400);
    27|     exit();
    28| }
    29| if ($user->perm->hasPermission($user->getUserId(), PermissionType::CATEGORY_EDIT->value)) {
    30|     $category = new Category($faqConfig, [], false);
    31|     $category->setUser($currentAdminUser);
    32|     $category->setGroups($currentAdminGroups);
    33|     $category->getMissingCategories();
    34|     $categoryPermission = new Permission($faqConfig);
    35|     $userHelper = new UserHelper($user);
    36|     $id = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT);
    37|     $header = sprintf(
    38|         '%s %s: <em>%s</em>',
    39|         Translation::get('ad_categ_trans_1'),
    40|         Translation::get('ad_categ_trans_2'),
    41|         $category->categoryName[$id]['name']
    42|     );
    43|     $selectedLanguage = Filter::filterInput(INPUT_GET, 'trlang', FILTER_SANITIZE_SPECIAL_CHARS, $faqLangCode);
    44|     if ($selectedLanguage !== $faqLangCode) {
    45|         $action = 'showcategory';
    46|         $showcat = 'yes';
    47|     } else {
    48|         $action = 'updatecategory';
    49|         $showcat = 'no';
    50|     }
    51|     $userPermission = $categoryPermission->get(Permission::USER, [$id]);
    52|     $groupPermission = $categoryPermission->get(Permission::GROUP, [$id]);
    53|     $templateVars = [
    54|         'categoryName' => $category->categoryName[$id]['name'],
    55|         'ad_categ_trans_1' => Translation::get('ad_categ_trans_1'),
    56|         'ad_categ_trans_2' => Translation::get('ad_categ_trans_2'),
    57|         'categoryId' => $id,
    58|         'category' => $category->categoryName[$id],
    59|         'showcat' => $showcat,
    60|         'permLevel' => $faqConfig->get('security.permLevel'),
    61|         'groupPermission' => $groupPermission[0],
    62|         'userPermission' => $userPermission[0],
    63|         'csrf' => Token::getInstance()->getTokenString('update-category'),
    64|         'ad_categ_title' => Translation::get('ad_categ_titel'),
    65|         'ad_categ_lang' => Translation::get('ad_categ_lang'),
    66|         'langToTranslate' => $category->getCategoryLanguagesToTranslate($id, $selectedLanguage),
    67|         'ad_categ_desc' => Translation::get('ad_categ_desc'),
    68|         'ad_categ_owner' => Translation::get('ad_categ_owner'),
    69|         'userOptions' => $userHelper->getAllUserOptions($category->categoryName[$id]['user_id']),
    70|         'ad_categ_transalready' => Translation::get('ad_categ_transalready'),
    71|         'langTranslated' => $category->getCategoryLanguagesTranslated($id),
    72|         'ad_categ_translatecateg' => Translation::get('ad_categ_translatecateg')
    73|     ];
    74|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    75|     $template = $twig->loadTemplate('@admin/content/category.translate.twig');
    76|     echo $template->render($templateVars);
    77| } else {
    78|     require __DIR__ . '/no-permission.php';
    79| }


# ====================================================================
# FILE: phpmyfaq/admin/comments.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /**
     3|  * Shows all comments in the categories and provides a link to delete comments.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2007-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2007-03-04
    15|  */
    16| use phpMyFAQ\Comments;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Date;
    19| use phpMyFAQ\Entity\CommentType;
    20| use phpMyFAQ\Enums\PermissionType;
    21| use phpMyFAQ\Faq;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\Extensions\FaqTwigExtension;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\User\CurrentUser;
    26| use Twig\Extra\Intl\IntlExtension;
    27| if (!defined('IS_VALID_PHPMYFAQ')) {
    28|     http_response_code(400);
    29|     exit();
    30| }
    31| $faqConfig = Configuration::getConfigurationInstance();
    32| $user = CurrentUser::getCurrentUser($faqConfig);
    33| [$currentAdminUser, $currentAdminGroups] = CurrentUser::getCurrentUserGroupId($user);
    34| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    35| $twig->addExtension(new IntlExtension());
    36| $twig->addExtension(new FaqTwigExtension());
    37| $template = $twig->loadTemplate('@admin/content/comments.twig');
    38| if ($user->perm->hasPermission($user->getUserId(), PermissionType::COMMENT_DELETE->value)) {
    39|     $comment = new Comments($faqConfig);
    40|     $faq = new Faq($faqConfig);
    41|     $date = new Date($faqConfig);
    42|     $faqComments = $comment->getAllComments();
    43|     $newsComments = $comment->getAllComments(CommentType::NEWS);
    44|     $templateVars = [
    45|         'currentLocale' => $faqConfig->getLanguage()->getLanguage(),
    46|         'faqComments' => $faqComments,
    47|         'newsComments' => $newsComments,
    48|         'csrfToken' => Token::getInstance()->getTokenString('delete-comment'),
    49|     ];
    50|     echo $template->render($templateVars);
    51| } else {
    52|     require __DIR__ . '/no-permission.php';
    53| }


# ====================================================================
# FILE: phpmyfaq/admin/configuration.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| <?php
     2| /**
     3|  * The main configuration frontend.
     4|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     5|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     6|  * obtain one at https://mozilla.org/MPL/2.0/.
     7|  *
     8|  * @package   phpMyFAQ
     9|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    10|  * @author    Matteo Scaramuccia <matteo@scaramuccia.com>
    11|  * @copyright 2005-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2005-12-26
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Session\Token;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use phpMyFAQ\User\CurrentUser;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = Configuration::getConfigurationInstance();
    27| $user = CurrentUser::getCurrentUser($faqConfig);
    28| if ($user->perm->hasPermission($user->getUserId(), PermissionType::CONFIGURATION_EDIT->value)) {
    29|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    30|     $template = $twig->loadTemplate('@admin/configuration/main.twig');
    31|     $templateVars = [
    32|         'adminHeaderConfiguration' => Translation::get('ad_config_edit'),
    33|         'csrfToken' => Token::getInstance()->getTokenString('configuration'),
    34|         'language' => $faqLangCode,
    35|         'adminConfigurationButtonReset' => Translation::get('ad_config_reset'),
    36|         'adminConfigurationButtonSave' => Translation::get('ad_config_save'),
    37|     ];
    38|     echo $template->render($templateVars);
    39| } else {
    40|     require __DIR__ . '/no-permission.php';
    41| }


# ====================================================================
# FILE: phpmyfaq/admin/dashboard.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-110 ---
     1| <?php
     2| /**
     3|  * The start page with some information about the FAQ.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Alexander M. Turek <me@derrabus.de>
    12|  * @copyright 2005-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2013-02-05
    16|  */
    17| use phpMyFAQ\Administration\Api;
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Database;
    20| use phpMyFAQ\Enums\PermissionType;
    21| use phpMyFAQ\Filter;
    22| use phpMyFAQ\Session;
    23| use phpMyFAQ\System;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User\CurrentUser;
    27| use Symfony\Contracts\HttpClient\Exception\DecodingExceptionInterface;
    28| use Symfony\Contracts\HttpClient\Exception\TransportExceptionInterface;
    29| if (!defined('IS_VALID_PHPMYFAQ')) {
    30|     http_response_code(400);
    31|     exit();
    32| }
    33| $faqConfig = Configuration::getConfigurationInstance();
    34| $faqTableInfo = $faqConfig->getDb()->getTableStatus(Database::getTablePrefix());
    35| $user = CurrentUser::getCurrentUser($faqConfig);
    36| $userId = $user->getUserId();
    37| $faqSystem = new System();
    38| $faqSession = new Session($faqConfig);
    39| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    40| $template = $twig->loadTemplate('@admin/dashboard.twig');
    41| $templateVars = [
    42|     'isDebugMode' => DEBUG,
    43|     'isMaintenanceMode' => $faqConfig->get('main.maintenanceMode'),
    44|     'isDevelopmentVersion' => System::isDevelopmentVersion(),
    45|     'currentVersionApp' => System::getVersion(),
    46|     'msgAdminWarningDevelopmentVersion' => sprintf(
    47|         Translation::get('msgAdminWarningDevelopmentVersion'),
    48|         System::getVersion(),
    49|         System::getGitHubIssuesUrl()
    50|     ),
    51|     'adminDashboardInfoNumVisits' => $faqSession->getNumberOfSessions(),
    52|     'adminDashboardInfoNumFaqs' => $faqTableInfo[Database::getTablePrefix() . 'faqdata'],
    53|     'adminDashboardInfoNumComments' => $faqTableInfo[Database::getTablePrefix() . 'faqcomments'],
    54|     'adminDashboardInfoNumQuestions' => $faqTableInfo[Database::getTablePrefix() . 'faqquestions'],
    55|     'adminDashboardInfoUser' => Translation::get('msgNews'),
    56|     'adminDashboardInfoNumUser' => $faqTableInfo[Database::getTablePrefix() . 'faquser'] - 1,
    57|     'adminDashboardHeaderVisits' => Translation::get('ad_stat_report_visits'),
    58|     'hasUserTracking' => $faqConfig->get('main.enableUserTracking'),
    59|     'adminDashboardHeaderInactiveFaqs' => Translation::get('ad_record_inactive'),
    60|     'adminDashboardInactiveFaqs' => $faq->getInactiveFaqsData(),
    61|     'hasPermissionEditConfig' => $user->perm->hasPermission($userId, PermissionType::CONFIGURATION_EDIT->value),
    62|     'showVersion' => $faqConfig->get('main.enableAutoUpdateHint'),
    63|     'documentationUrl' => System::getDocumentationUrl(),
    64| ];
    65| if (version_compare($faqConfig->getVersion(), System::getVersion(), '<')) {
    66|     $templateVars = [
    67|         ...$templateVars,
    68|         'hasVersionConflict' => true,
    69|         'currentVersionDatabase' => $faqConfig->getVersion()
    70|     ];
    71| }
    72| if ($user->perm->hasPermission($userId, PermissionType::CONFIGURATION_EDIT->value)) {
    73|     $api = new Api($faqConfig, $faqSystem);
    74|     $version = Filter::filterInput(INPUT_POST, 'param', FILTER_SANITIZE_SPECIAL_CHARS);
    75|     if (!$faqConfig->get('main.enableAutoUpdateHint')) {
    76|         if ($version === 'version') {
    77|             $shouldUpdate = false;
    78|             $errorMessage = '';
    79|             $versions = [];
    80|             try {
    81|                 $versions = $api->getVersions();
    82|                 if (-1 === version_compare($versions['installed'], $versions['stable'])) {
    83|                     $templateVars = [
    84|                         ...$templateVars,
    85|                         'adminDashboardShouldUpdateMessage' => true,
    86|                         'adminDashboardLatestVersionMessage' => Translation::get('ad_you_should_update'),
    87|                         'adminDashboardVersions' => $versions,
    88|                     ];
    89|                 } else {
    90|                     $templateVars = [
    91|                         ...$templateVars,
    92|                         'adminDashboardShouldUpdateMessage' => false,
    93|                         'adminDashboardLatestVersionMessage' => Translation::get('ad_xmlrpc_latest'),
    94|                         'adminDashboardVersions' => $versions,
    95|                     ];
    96|                 }
    97|             } catch (DecodingExceptionInterface | TransportExceptionInterface | Exception $e) {
    98|                 $templateVars = [
    99|                     ...$templateVars,
   100|                     'adminDashboardErrorMessage' => $e->getMessage()
   101|                 ];
   102|             }
   103|         }
   104|     }
   105|     $templateVars = [
   106|         ...$templateVars,
   107|         'showVersion' => $faqConfig->get('main.enableAutoUpdateHint') || ($version === 'version'),
   108|     ];
   109| }
   110| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/elasticsearch.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-46 ---
     1| <?php
     2| /**
     3|  * phpMyFAQ Elasticsearch information.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2015-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2015-12-25
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Instance\Elasticsearch;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use phpMyFAQ\User\CurrentUser;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = Configuration::getConfigurationInstance();
    27| $user = CurrentUser::getCurrentUser($faqConfig);
    28| if (
    29|     $user->perm->hasPermission($user->getUserId(), PermissionType::CONFIGURATION_EDIT->value) &&
    30|     $faqConfig->get('search.enableElasticsearch')
    31| ) {
    32|     $elasticsearch = new Elasticsearch($faqConfig);
    33|     $esConfigData = $faqConfig->getElasticsearchConfig();
    34|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    35|     $template = $twig->loadTemplate('@admin/configuration/elasticsearch.twig');
    36|     $templateVars = [
    37|         'adminHeaderElasticsearch' => Translation::get('ad_menu_elasticsearch'),
    38|         'adminElasticsearchButtonCreate' => Translation::get('ad_es_create_index'),
    39|         'adminElasticsearchButtonIndex' => Translation::get('ad_es_bulk_index'),
    40|         'adminElasticsearchButtonDelete' => Translation::get('ad_es_drop_index'),
    41|         'adminElasticsearchStats' => Translation::get('ad_menu_searchstats'),
    42|     ];
    43|     echo $template->render($templateVars);
    44| } else {
    45|     require __DIR__ . '/no-permission.php';
    46| }


# ====================================================================
# FILE: phpmyfaq/admin/export.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-65 ---
     1| <?php
     2| /**
     3|  * JSON, and PDF export
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Matteo Scaramuccia <matteo@phpmyfaq.de>
    12|  * @copyright 2003-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2003-04-17
    16|  */
    17| use phpMyFAQ\Category;
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Database;
    20| use phpMyFAQ\Enums\PermissionType;
    21| use phpMyFAQ\Helper\CategoryHelper;
    22| use phpMyFAQ\Template\TwigWrapper;
    23| use phpMyFAQ\Translation;
    24| use phpMyFAQ\User\CurrentUser;
    25| use Symfony\Component\HttpFoundation\HeaderUtils;
    26| if (!defined('IS_VALID_PHPMYFAQ')) {
    27|     http_response_code(400);
    28|     exit();
    29| }
    30| $faqConfig = Configuration::getConfigurationInstance();
    31| $user = CurrentUser::getCurrentUser($faqConfig);
    32| [$currentAdminUser, $currentAdminGroups] = CurrentUser::getCurrentUserGroupId($user);
    33| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    34| $template = $twig->loadTemplate('@admin/import-export/export.twig');
    35| if ($user->perm->hasPermission($user->getUserId(), PermissionType::EXPORT->value)) {
    36|     $category = new Category($faqConfig, [], false);
    37|     $category->setUser($currentAdminUser);
    38|     $category->setGroups($currentAdminGroups);
    39|     $category->buildCategoryTree();
    40|     $categoryHelper = new CategoryHelper();
    41|     $categoryHelper->setCategory($category);
    42|     $templateVars = [
    43|         'adminHeaderExport' => Translation::get('ad_menu_export'),
    44|         'hasNoFaqs' => Database::checkOnEmptyTable('faqdata'),
    45|         'errorMessageNoFaqs' => Translation::get('msgErrorNoRecords'),
    46|         'hasCategories' => !Database::checkOnEmptyTable('faqcategories'),
    47|         'headerCategories' => Translation::get('ad_export_which_cat'),
    48|         'msgCategory' => Translation::get('ad_entry_category'),
    49|         'msgAllCategories' => Translation::get('msgShowAllCategories'),
    50|         'categoryOptions' => $categoryHelper->renderOptions(0),
    51|         'msgWithSubCategories' => Translation::get('ad_export_cat_downwards'),
    52|         'headerExportType' => Translation::get('ad_export_type'),
    53|         'msgChooseExportType' => Translation::get('ad_export_type_choose'),
    54|         'msgViewType' => Translation::get('ad_export_download_view'),
    55|         'msgDownloadType' => HeaderUtils::DISPOSITION_ATTACHMENT,
    56|         'msgDownload' => Translation::get('ad_export_download'),
    57|         'msgInlineType' => HeaderUtils::DISPOSITION_INLINE,
    58|         'msgInline' => Translation::get('ad_export_view'),
    59|         'buttonReset' => Translation::get('ad_config_reset'),
    60|         'buttonExport' => Translation::get('ad_menu_export'),
    61|     ];
    62|     echo $template->render($templateVars);
    63| } else {
    64|     require __DIR__ . '/no-permission.php';
    65| }


# ====================================================================
# FILE: phpmyfaq/admin/faqs.editor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-378 ---
     1| <?php
     2| /**
     3|  * The FAQ record editor.
     4|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     5|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     6|  * obtain one at https://mozilla.org/MPL/2.0/.
     7|  *
     8|  * @package   phpMyFAQ
     9|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    10|  * @copyright 2003-2024 phpMyFAQ Team
    11|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    12|  * @link      https://www.phpmyfaq.de
    13|  * @since     2003-02-23
    14|  */
    15| use phpMyFAQ\Administration\AdminLog;
    16| use phpMyFAQ\Administration\Changelog;
    17| use phpMyFAQ\Administration\Revision;
    18| use phpMyFAQ\Attachment\AttachmentFactory;
    19| use phpMyFAQ\Category;
    20| use phpMyFAQ\Category\Relation;
    21| use phpMyFAQ\Configuration;
    22| use phpMyFAQ\Database;
    23| use phpMyFAQ\Date;
    24| use phpMyFAQ\Entity\SeoEntity;
    25| use phpMyFAQ\Enums\PermissionType;
    26| use phpMyFAQ\Enums\SeoType;
    27| use phpMyFAQ\Faq;
    28| use phpMyFAQ\Faq\Permission;
    29| use phpMyFAQ\Filter;
    30| use phpMyFAQ\Helper\CategoryHelper;
    31| use phpMyFAQ\Helper\LanguageHelper;
    32| use phpMyFAQ\Helper\UserHelper;
    33| use phpMyFAQ\Link;
    34| use phpMyFAQ\Question;
    35| use phpMyFAQ\Seo;
    36| use phpMyFAQ\Session\Token;
    37| use phpMyFAQ\Tags;
    38| use phpMyFAQ\Template\Extensions\FormatBytesTwigExtension;
    39| use phpMyFAQ\Template\Extensions\IsoDateTwigExtension;
    40| use phpMyFAQ\Template\Extensions\UserNameTwigExtension;
    41| use phpMyFAQ\Template\TwigWrapper;
    42| use phpMyFAQ\Translation;
    43| use phpMyFAQ\User\CurrentUser;
    44| if (!defined('IS_VALID_PHPMYFAQ')) {
    45|     http_response_code(400);
    46|     exit();
    47| }
    48| $faqConfig = Configuration::getConfigurationInstance();
    49| $user = CurrentUser::getCurrentUser($faqConfig);
    50| $currentUserId = $user->getUserId();
    51| if (
    52|     (
    53|     $user->perm->hasPermission($currentUserId, PermissionType::FAQ_EDIT->value) ||
    54|     $user->perm->hasPermission($currentUserId, PermissionType::FAQ_EDIT->value)) &&
    55|     !Database::checkOnEmptyTable('faqcategories')
    56| ) {
    57|     $category = new Category($faqConfig, [], false);
    58|     if ($faqConfig->get('main.enableCategoryRestrictions')) {
    59|         $category = new Category($faqConfig, $currentAdminGroups, true);
    60|     }
    61|     $category->setUser($currentAdminUser);
    62|     $category->setGroups($currentAdminGroups);
    63|     $category->buildCategoryTree();
    64|     $categoryRelation = new Relation($faqConfig, $category);
    65|     $categoryHelper = new CategoryHelper();
    66|     $categoryHelper->setCategory($category);
    67|     $faq = new Faq($faqConfig);
    68|     $faqPermission = new Permission($faqConfig);
    69|     $questionObject = new Question($faqConfig);
    70|     $changelog = new Changelog($faqConfig);
    71|     $userHelper = new UserHelper($user);
    72|     $tagging = new Tags($faqConfig);
    73|     $seo = new Seo($faqConfig);
    74|     $logging = new AdminLog($faqConfig);
    75|     $date = new Date($faqConfig);
    76|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    77|     $twig->addExtension(new FormatBytesTwigExtension());
    78|     $twig->addExtension(new IsoDateTwigExtension());
    79|     $twig->addExtension(new UserNameTwigExtension());
    80|     $template = $twig->loadTemplate('@admin/content/faq.editor.twig');
    81|     $selectedCategory = '';
    82|     $queryString = '';
    83|     $categories = [];
    84|     $faqData = [
    85|         'id' => 0,
    86|         'lang' => $faqLangCode,
    87|         'revision_id' => 0,
    88|         'title' => '',
    89|         'dateStart' => '',
    90|         'dateEnd' => '',
    91|     ];
    92|     if ('takequestion' === $action) {
    93|         $questionId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    94|         $question = $questionObject->get($questionId);
    95|         $selectedCategory = $question['category_id'];
    96|         $faqData['title'] = $question['question'];
    97|         $notifyUser = $question['username'];
    98|         $notifyEmail = $question['email'];
    99|         $categories = [
   100|             'category_id' => $selectedCategory,
   101|             'category_lang' => $faqData['lang'],
   102|         ];
   103|     } else {
   104|         $questionId = 0;
   105|         $notifyUser = '';
   106|         $notifyEmail = '';
   107|     }
   108|     if ('editentry' === $action) {
   109|         $id = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
   110|         $lang = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);
   111|         $translateTo = Filter::filterInput(INPUT_GET, 'translateTo', FILTER_SANITIZE_SPECIAL_CHARS);
   112|         $categoryId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT);
   113|         $logging->log($user, 'admin-edit-faq ' . $id);
   114|         if (!is_null($translateTo)) {
   115|             $faqData['lang'] = $lang = $translateTo;
   116|             $selectedCategory = $categoryId;
   117|         }
   118|         if ((!isset($selectedCategory) && !isset($faqData['title'])) || !is_null($id)) {
   119|             $logging = new AdminLog($faqConfig);
   120|             $logging->log($user, 'admin-edit-faq ' . $id);
   121|             $categories = $categoryRelation->getCategories($id, $lang);
   122|             if (count($categories) === 0) {
   123|                 $categories = [
   124|                     'category_id' => $selectedCategory,
   125|                     'category_lang' => $faqData['lang'],
   126|                 ];
   127|             }
   128|             $faq->getFaq($id, null, true);
   129|             $faqData = $faq->faqRecord;
   130|             if (!is_null($translateTo)) {
   131|                 $faqData['lang'] = $translateTo; // once again
   132|             }
   133|             $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));
   134|         } else {
   135|             $queryString = 'insertentry';
   136|             if (isset($categoryId)) {
   137|                 $categories = ['category_id' => $categoryId, 'category_lang' => $lang];
   138|             }
   139|         }
   140|     } elseif ('copyentry' === $action) {
   141|         $logging->log($user, 'admin-copy-faq');
   142|         $faqData['id'] = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
   143|         $faqData['lang'] = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);
   144|         $categories = $categoryRelation->getCategories($faqData['id'], $faqData['lang']);
   145|         $faq->getFaq($faqData['id'], null, true);
   146|         $faqData = $faq->faqRecord;
   147|         $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));
   148|         $faqData['id'] = 0;
   149|         $faqData['revision_id'] = 0;
   150|         $queryString = 'insertentry';
   151|     } else {
   152|         $logging->log($user, 'admin-add-faq');
   153|         $queryString = 'insertentry';
   154|         if (!is_array($categories)) {
   155|             $categories = [];
   156|         }
   157|     }
   158|     $selectedRevisionId = Filter::filterInput(INPUT_POST, 'selectedRevisionId', FILTER_VALIDATE_INT);
   159|     if (is_null($selectedRevisionId)) {
   160|         $selectedRevisionId = $faqData['revision_id'];
   161|     }
   162|     $userPermission = $faqPermission->get(Permission::USER, $faqData['id']);
   163|     if (count($userPermission) == 0 || $userPermission[0] == -1) {
   164|         $allUsers = true;
   165|         $restrictedUsers = false;
   166|         $userPermission[0] = -1;
   167|     } else {
   168|         $allUsers = false;
   169|         $restrictedUsers = true;
   170|     }
   171|     $groupPermission = $faqPermission->get(Permission::GROUP, $faqData['id']);
   172|     if (count($groupPermission) == 0 || $groupPermission[0] == -1) {
   173|         $allGroups = true;
   174|         $restrictedGroups = false;
   175|         $groupPermission[0] = -1;
   176|     } else {
   177|         $allGroups = false;
   178|         $restrictedGroups = true;
   179|     }
   180|     $seoEntity = new SeoEntity();
   181|     $seoEntity
   182|         ->setType(SeoType::FAQ)
   183|         ->setReferenceId($faqData['id'])
   184|         ->setReferenceLanguage($faqData['lang']);
   185|     $seoData = $seo->get($seoEntity);
   186|     $faqData['serp-title'] = $seoData->getTitle();
   187|     $faqData['serp-description'] = $seoData->getDescription();
   188|     $faqData['title'] = ($faqData['title'] ?? '');
   189|     $faqData['content'] = (isset($faqData['content']) ? trim($faqData['content']) : '');
   190|     $faqData['tags'] = $faqData['tags'] ?? '';
   191|     $faqData['keywords'] = ($faqData['keywords'] ?? '');
   192|     $faqData['author'] = ($faqData['author'] ?? $user->getUserData('display_name'));
   193|     $faqData['email'] = ($faqData['email'] ?? $user->getUserData(
   194|         'email'
   195|     ));
   196|     $faqData['isoDate'] = ($faqData['date'] ?? date('Y-m-d H:i'));
   197|     $faqData['date'] = (isset($faqData['date']) ? $date->format($faqData['date']) : $date->format(date('Y-m-d H:i')));
   198|     $faqData['changed'] ??= '';
   199|     if (isset($faqData['comment']) && $faqData['comment'] == 'y') {
   200|         $faqData['comment'] = ' checked';
   201|     } elseif ($faqConfig->get('records.defaultAllowComments')) {
   202|         $faqData['comment'] = ' checked';
   203|     } else {
   204|         $faqData['comment'] = '';
   205|     }
   206|     $templateVars = [
   207|         'ad_record_faq' => Translation::get('ad_record_faq'),
   208|         'ad_menu_faq_meta' => Translation::get('ad_menu_faq_meta'),
   209|         'ad_record_permissions' => Translation::get('ad_record_permissions'),
   210|         'ad_admin_notes' => Translation::get('ad_admin_notes'),
   211|         'ad_entry_changelog' => Translation::get('ad_entry_changelog'),
   212|     ];
   213|     if (0 !== $faqData['id'] && 'copyentry' !== $action) {
   214|         $currentRevision = sprintf('%s 1.%d', Translation::get('ad_entry_revision'), $selectedRevisionId);
   215|         $faqUrl = sprintf(
   216|             '%sindex.php?action=faq&cat=%s&id=%d&artlang=%s',
   217|             $faqConfig->getDefaultUrl(),
   218|             $category->getCategoryIdFromFaq($faqData['id']),
   219|             $faqData['id'],
   220|             $faqData['lang']
   221|         );
   222|         $link = new Link($faqUrl, $faqConfig);
   223|         $link->itemTitle = $faqData['title'];
   224|         $templateVars = [
   225|             ...$templateVars,
   226|             'adminFaqEditorHeader' => Translation::get('ad_entry_edit_1') . ' ' . Translation::get('ad_entry_edit_2'),
   227|             'editExistingFaq' => true,
   228|             'currentRevision' => $currentRevision,
   229|             'faqUrl' => $link->toString(),
   230|             'ad_view_faq' => Translation::get('ad_view_faq'),
   231|         ];
   232|     } else {
   233|         $templateVars = [
   234|             ...$templateVars,
   235|             'adminFaqEditorHeader' => Translation::get('ad_entry_add'),
   236|             'editExistingFaq' => false,
   237|         ];
   238|     }
   239|     if ($user->perm->hasPermission($currentUserId, PermissionType::REVISION_UPDATE->value) && $action === 'editentry') {
   240|         $faqRevision = new Revision($faqConfig);
   241|         $revisions = $faqRevision->get($faqData['id'], $faqData['lang'], $faqData['author']);
   242|         if (isset($selectedRevisionId) && isset($faqData['revision_id']) && $selectedRevisionId !== $faqData['revision_id']) {
   243|             $faq->getFaq($faqData['id'], $selectedRevisionId, true);
   244|             $faqData = $faq->faqRecord;
   245|             $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));
   246|             $faqData['revision_id'] = $selectedRevisionId;
   247|         }
   248|         $templateVars = [
   249|             ...$templateVars,
   250|             'numberOfRevisions' => count($revisions),
   251|             'faqId' => $faqData['id'],
   252|             'faqLang' => $faqData['lang'],
   253|             'faqRevisionId' => $faqData['revision_id'],
   254|             'ad_changerev' => Translation::get('ad_changerev'),
   255|             'revisions' => $revisions,
   256|             'selectedRevisionId' => $selectedRevisionId,
   257|             'ad_entry_revision' => Translation::get('ad_entry_revision'),
   258|         ];
   259|     }
   260|     if (isset($faqData['active']) && $faqData['active'] === 'yes') {
   261|         $isActive = ' checked';
   262|         $isInActive = null;
   263|     } else {
   264|         $isActive = null;
   265|         $isInActive = ' checked';
   266|     }
   267|     if ($faqConfig->get('records.defaultActivation') && $queryString === 'insertentry') {
   268|         $isActive = ' checked';
   269|         $isInActive = null;
   270|     }
   271|     $attList = AttachmentFactory::fetchByRecordId(
   272|         $faqConfig,
   273|         $faqData['id']
   274|     );
   275|     $templateVars = [
   276|         ...$templateVars,
   277|         'isEditorEnabled' => $faqConfig->get('main.enableWysiwygEditor'),
   278|         'isMarkdownEditorEnabled' => $faqConfig->get('main.enableMarkdownEditor'),
   279|         'isBasicPermission' => $faqConfig->get('security.permLevel') === 'basic',
   280|         'defaultUrl' => $faqConfig->getDefaultUrl(),
   281|         'faqRevisionId' => $faqData['revision_id'],
   282|         'faqData' => $faqData,
   283|         'openQuestionId' => $questionId,
   284|         'notifyUser' => $notifyUser,
   285|         'notifyEmail' => $notifyEmail,
   286|         'csrfToken' => Token::getInstance()->getTokenString('edit-faq'),
   287|         'ad_entry_theme' => Translation::get('ad_entry_theme'),
   288|         'msgNoHashAllowed' => Translation::get('msgNoHashAllowed'),
   289|         'msgShowHelp' => Translation::get('msgShowHelp'),
   290|         'ad_entry_content' => Translation::get('ad_entry_content'),
   291|         'ad_entry_category' => Translation::get('ad_entry_category'),
   292|         'categoryOptions' => $categoryHelper->renderOptions($categories),
   293|         'ad_entry_locale' => Translation::get('ad_entry_locale'),
   294|         'languageOptions' => LanguageHelper::renderSelectLanguage($faqData['lang'], false, [], 'lang'),
   295|         'hasPermissionForAddAttachments' => $user->perm->hasPermission(
   296|             $currentUserId,
   297|             PermissionType::ATTACHMENT_ADD->value
   298|         ),
   299|         'hasPermissionForDeleteAttachments' => $user->perm->hasPermission(
   300|             $currentUserId,
   301|             PermissionType::ATTACHMENT_DELETE->value
   302|         ),
   303|         'ad_menu_attachments' => Translation::get('ad_menu_attachments'),
   304|         'csrfTokenDeleteAttachment' => Token::getInstance()->getTokenString('delete-attachment'),
   305|         'attachments' => $attList,
   306|         'ad_att_add' => Translation::get('ad_att_add'),
   307|         'ad_entry_tags' => Translation::get('ad_entry_tags'),
   308|         'ad_entry_keywords' => Translation::get('ad_entry_keywords'),
   309|         'ad_entry_author' => Translation::get('ad_entry_author'),
   310|         'msgEmail' => Translation::get('msgEmail'),
   311|         'msgSeoCenter' => Translation::get('seoCenter'),
   312|         'msgSerp' => Translation::get('msgSerp'),
   313|         'msgSerpTitle' => Translation::get('msgSerpTitle'),
   314|         'msgSerpDescription' => Translation::get('msgSerpDescription'),
   315|         'ad_entry_grouppermission' => Translation::get('ad_entry_grouppermission'),
   316|         'ad_entry_all_groups' => Translation::get('ad_entry_all_groups'),
   317|         'allGroups' => $allGroups,
   318|         'restrictedGroups' => $restrictedGroups,
   319|         'ad_entry_restricted_groups' => Translation::get('ad_entry_restricted_groups'),
   320|         'groupPermissionOptions' => ($faqConfig->get('security.permLevel') === 'medium') ?
   321|             $user->perm->getAllGroupsOptions($groupPermission, $user) : '',
   322|         'ad_entry_userpermission' => Translation::get('ad_entry_userpermission'),
   323|         'allUsers' => $allUsers,
   324|         'ad_entry_all_users' => Translation::get('ad_entry_all_users'),
   325|         'restrictedUsers' => $restrictedUsers,
   326|         'ad_entry_restricted_users' => Translation::get('ad_entry_restricted_users'),
   327|         'userPermissionOptions' => $userHelper->getAllUserOptions($userPermission[0], true),
   328|         'ad_entry_changelog' => Translation::get('ad_entry_changelog'),
   329|         'ad_entry_date' => Translation::get('ad_entry_date'),
   330|         'ad_entry_changed' => Translation::get('ad_entry_changed'),
   331|         'ad_admin_notes_hint' => Translation::get('ad_admin_notes_hint'),
   332|         'ad_admin_notes' => Translation::get('ad_admin_notes'),
   333|         'ad_entry_changelog_history' => Translation::get('ad_entry_changelog_history'),
   334|         'changelogs' => $changelog->getByFaqId($faqData['id']),
   335|         'ad_entry_revision' => Translation::get('ad_entry_revision'),
   336|         'ad_gen_reset' => Translation::get('ad_gen_reset'),
   337|         'ad_entry_save' => Translation::get('ad_entry_save'),
   338|         'msgUpdateFaqDate' => Translation::get('msgUpdateFaqDate'),
   339|         'msgKeepFaqDate' => Translation::get('msgKeepFaqDate'),
   340|         'msgEditFaqDat' => Translation::get('msgEditFaqDat'),
   341|         'ad_entry_status' => Translation::get('ad_entry_status'),
   342|         'hasPermissionForApprove' => $user->perm->hasPermission($currentUserId, PermissionType::FAQ_APPROVE->value),
   343|         'isActive' => $isActive,
   344|         'isInActive' => $isInActive,
   345|         'ad_entry_visibility' => Translation::get('ad_entry_visibility'),
   346|         'ad_entry_not_visibility' => Translation::get('ad_entry_not_visibility'),
   347|         'canBeNewRevision' => $queryString !== 'insertentry' && !$faqConfig->get('records.enableAutoRevisions'),
   348|         'ad_entry_new_revision' => Translation::get('ad_entry_new_revision'),
   349|         'ad_gen_yes' => Translation::get('ad_gen_yes'),
   350|         'ad_gen_no' => Translation::get('ad_gen_no'),
   351|         'ad_entry_sticky' => Translation::get('ad_entry_sticky'),
   352|         'ad_entry_allowComments' => Translation::get('ad_entry_allowComments'),
   353|         'ad_entry_solution_id' => Translation::get('ad_entry_solution_id'),
   354|         'nextSolutionId' => $faq->getNextSolutionId(),
   355|         'nextFaqId' => 0 === $faqData['id'] ? $faqConfig->getDb()->nextId(
   356|             Database::getTablePrefix() . 'faqdata',
   357|             'id'
   358|         ) : $faqData['id'],
   359|         'ad_att_addto' => Translation::get('ad_att_addto'),
   360|         'ad_att_addto_2' => Translation::get('ad_att_addto_2'),
   361|         'ad_att_att' => Translation::get('ad_att_att'),
   362|         'maxAttachmentSize' => $faqConfig->get('records.maxAttachmentSize'),
   363|         'csrfTokenUploadAttachment' => Token::getInstance()->getTokenString('upload-attachment'),
   364|         'msgAttachmentsFilesize' => Translation::get('msgAttachmentsFilesize'),
   365|         'ad_att_butt' => Translation::get('ad_att_butt'),
   366|     ];
   367|     echo $template->render($templateVars);
   368| } elseif (
   369|     $user->perm->hasPermission($currentUserId, PermissionType::FAQ_EDIT->value) &&
   370|     !Database::checkOnEmptyTable('faqcategories')
   371| ) {
   372|     require __DIR__ . '/no-permission.php';
   373| } elseif (
   374|     $user->perm->hasPermission($currentUserId, PermissionType::FAQ_EDIT->value) &&
   375|     Database::checkOnEmptyTable('faqcategories')
   376| ) {
   377|     echo Translation::get('no_cats');
   378| }


# ====================================================================
# FILE: phpmyfaq/admin/faqs.overview.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| <?php
     2| /**
     3|  * List of records ordered by categories.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2020-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2020-11-21
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Category\Relation;
    18| use phpMyFAQ\Comments;
    19| use phpMyFAQ\Configuration;
    20| use phpMyFAQ\Session\Token;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use phpMyFAQ\Translation;
    23| use phpMyFAQ\User\CurrentUser;
    24| if (!defined('IS_VALID_PHPMYFAQ')) {
    25|     http_response_code(400);
    26|     exit();
    27| }
    28| $faqConfig = Configuration::getConfigurationInstance();
    29| $user = CurrentUser::getCurrentUser($faqConfig);
    30| [ $currentAdminUser, $currentAdminGroups ] = CurrentUser::getCurrentUserGroupId($user);
    31| $category = new Category($faqConfig, $currentAdminGroups, true);
    32| $category->setUser($currentAdminUser);
    33| $category->setGroups($currentAdminGroups);
    34| $category->buildCategoryTree();
    35| $categoryRelation = new Relation($faqConfig, $category);
    36| $categoryRelation->setGroups($currentAdminGroups);
    37| $comments = new Comments($faqConfig);
    38| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    39| $template = $twig->loadTemplate('@admin/content/faq.overview.twig');
    40| $templateVars = [
    41|     'csrfTokenSearch' => Token::getInstance()->getTokenInput('edit-faq'),
    42|     'csrfTokenOverview' => Token::getInstance()->getTokenString('faq-overview'),
    43|     'categories' => $category->getCategoryTree(),
    44|     'numberOfRecords' => $categoryRelation->getNumberOfFaqsPerCategory(),
    45|     'numberOfComments' => $comments->getNumberOfCommentsByCategory(),
    46|     'msgComments' => Translation::get('ad_start_comments'),
    47|     'msgQuestion' => Translation::get('ad_entry_theme'),
    48|     'msgDate' => Translation::get('ad_entry_date'),
    49|     'msgSticky' => Translation::get('ad_entry_sticky'),
    50|     'msgActive' => Translation::get('ad_record_active'),
    51| ];
    52| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/footer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| /**
     3|  * Footer of the admin area.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Matteo Scaramuccia <matteo@phpmyfaq.de>
    12|  * @copyright 2003-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2003-02-26
    16|  */
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\System;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use phpMyFAQ\User\CurrentUser;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = Configuration::getConfigurationInstance();
    27| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    28| $template = $twig->loadTemplate('@admin/footer.twig');
    29| $templateVars = [
    30|     'msgSessionExpiringSoon' => Translation::get('msgSessionExpiringSoon'),
    31|     'msgModalSessionWarning' => sprintf(Translation::get('ad_session_expiring'), PMF_AUTH_TIMEOUT_WARNING),
    32|     'msgNoLogMeOut' => Translation::get('msgNoLogMeOut'),
    33|     'msgYesKeepMeLoggedIn' => Translation::get('msgYesKeepMeLoggedIn'),
    34|     'msgPoweredBy' => System::getPoweredByString(),
    35|     'documentationUrl' => System::getDocumentationUrl(),
    36|     'phpMyFaqUrl' => System::PHPMYFAQ_URL,
    37|     'isUserLoggedIn' => $user->isLoggedIn(),
    38|     'currentLanguage' => $faqLangCode,
    39|     'currentTimeStamp' => time(),
    40|     'currentYear' => date('Y'),
    41| ];
    42| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/forms.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-54 ---
     1| <?php
     2| /**
     3|  * Edit forms
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Jan Harms <modelrailroader@gmx-topmail.de>
    12|  * @copyright 2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2024-03-09
    16|  */
    17| use phpMyFAQ\Forms;
    18| use phpMyFAQ\Template\TwigWrapper;
    19| use phpMyFAQ\Translation;
    20| use phpMyFAQ\Session\Token;
    21| use phpMyFAQ\Enums\Forms\FormIds;
    22| use phpMyFAQ\User\CurrentUser;
    23| use phpMyFAQ\Enums\PermissionType;
    24| if (!defined('IS_VALID_PHPMYFAQ')) {
    25|     http_response_code(400);
    26|     exit();
    27| }
    28| $user = CurrentUser::getCurrentUser($faqConfig);
    29| if ($user->perm->hasPermission($user->getUserId(), PermissionType::FORMS_EDIT->value)) {
    30|     $forms = new Forms($faqConfig);
    31|     $translation = new Translation();
    32|     $templateVars = [
    33|         'msgEditForms' => Translation::get('msgEditForms'),
    34|         'formDataAskQuestion' => $forms->getFormData(FormIds::ASK_QUESTION->value),
    35|         'formDataAddContent' => $forms->getFormData(FormIds::ADD_NEW_FAQ->value),
    36|         'msgQuestion' => Translation::get('msgQuestion'),
    37|         'msgAddContent' => Translation::get('msgAddContent'),
    38|         'csrfActivate' => Token::getInstance()->getTokenString('activate-input'),
    39|         'csrfRequired' => Token::getInstance()->getTokenString('require-input'),
    40|         'ad_entry_id' => Translation::get('ad_entry_id'),
    41|         'msgInputLabel' => Translation::get('msgInputLabel'),
    42|         'msgInputType' => Translation::get('msgInputType'),
    43|         'ad_entry_active' => Translation::get('ad_entry_active'),
    44|         'msgRequiredInputField' => Translation::get('msgRequiredInputField'),
    45|         'msgFormsEditTranslations' => Translation::get('msgFormsEditTranslations'),
    46|         'ad_categ_translate' => Translation::get('ad_categ_translate'),
    47|         'msgHintDeactivateForms' => Translation::get('msgHintDeactivateForms')
    48|     ];
    49|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    50|     $template = $twig->loadTemplate('@admin/configuration/forms.twig');
    51|     echo $template->render($templateVars);
    52| } else {
    53|     require __DIR__ . '/no-permission.php';
    54| }


# ====================================================================
# FILE: phpmyfaq/admin/forms.translations.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /**
     3|  * Edit forms
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Jan Harms <modelrailroader@gmx-topmail.de>
    12|  * @copyright 2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2024-03-09
    16|  */
    17| use phpMyFAQ\Forms;
    18| use phpMyFAQ\Template\TwigWrapper;
    19| use phpMyFAQ\Translation;
    20| use phpMyFAQ\Session\Token;
    21| use phpMyFAQ\User\CurrentUser;
    22| use phpMyFAQ\Enums\PermissionType;
    23| use phpMyFAQ\Filter;
    24| use phpMyFAQ\Language\LanguageCodes;
    25| use Twig\TwigFilter;
    26| if (!defined('IS_VALID_PHPMYFAQ')) {
    27|     http_response_code(400);
    28|     exit();
    29| }
    30| $user = CurrentUser::getCurrentUser($faqConfig);
    31| if ($user->perm->hasPermission($user->getUserId(), PermissionType::FORMS_EDIT->value)) {
    32|     $forms = new Forms($faqConfig);
    33|     $formId = Filter::filterInput(INPUT_GET, 'formid', FILTER_SANITIZE_NUMBER_INT);
    34|     $inputId = Filter::filterInput(INPUT_GET, 'inputid', FILTER_SANITIZE_NUMBER_INT);
    35|     $languages = [];
    36|     foreach (LanguageCodes::getAllSupported() as $code => $language) {
    37|         if (!in_array($code, $forms->getTranslatedLanguages($formId, $inputId))) {
    38|             $languages[] = $language;
    39|         }
    40|     }
    41|     $filter = new TwigFilter('languageCode', function ($string) {
    42|         if ($string === 'default') {
    43|             return $string;
    44|         } else {
    45|             return LanguageCodes::get($string);
    46|         }
    47|     });
    48|     $templateVars = [
    49|         'translations' => $forms->getTranslations($formId, $inputId),
    50|         'ad_entry_locale' => Translation::get('ad_entry_locale'),
    51|         'msgInputLabel' => Translation::get('msgInputLabel'),
    52|         'ad_sess_pageviews' => Translation::get('ad_sess_pageviews'),
    53|         'msgFormsEditTranslations' => Translation::get('msgFormsEditTranslations'),
    54|         'csrfTokenEditTranslation' => Token::getInstance()->getTokenString('edit-translation'),
    55|         'csrfTokenDeleteTranslation' => Token::getInstance()->getTokenString('delete-translation'),
    56|         'languages' => $languages,
    57|         'msgSelectLanguage' => Translation::get('msgSelectLanguage'),
    58|         'msgTranslationText' => Translation::get('msgTranslationText'),
    59|         'msgAddTranslation' => Translation::get('msgAddTranslation'),
    60|         'csrfTokenAddTranslation' => Token::getInstance()->getTokenString('add-translation'),
    61|         'formId' => $formId,
    62|         'inputId' => $inputId,
    63|         'msgEditForms' => Translation::get('msgEditForms')
    64|     ];
    65|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    66|     $twig->addFilter($filter);
    67|     $template = $twig->loadTemplate('@admin/configuration/forms.translations.twig');
    68|     echo $template->render($templateVars);
    69| } else {
    70|     require __DIR__ . '/no-permission.php';
    71| }


# ====================================================================
# FILE: phpmyfaq/admin/glossary.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| <?php
     2| /**
     3|  * The main glossary index file.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2005-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2005-09-15
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Glossary;
    19| use phpMyFAQ\Session\Token;
    20| use phpMyFAQ\Template\TwigWrapper;
    21| use phpMyFAQ\Translation;
    22| use phpMyFAQ\User\CurrentUser;
    23| if (!defined('IS_VALID_PHPMYFAQ')) {
    24|     http_response_code(400);
    25|     exit();
    26| }
    27| $faqConfig = Configuration::getConfigurationInstance();
    28| $user = CurrentUser::getCurrentUser($faqConfig);
    29| if (
    30|     $user->perm->hasPermission($user->getUserId(), PermissionType::GLOSSARY_ADD->value) ||
    31|     $user->perm->hasPermission($user->getUserId(), PermissionType::GLOSSARY_EDIT->value) ||
    32|     $user->perm->hasPermission($user->getUserId(), PermissionType::GLOSSARY_DELETE->value)
    33| ) {
    34|     $glossary = new Glossary($faqConfig);
    35|     $glossary->setLanguage($faqLangCode);
    36|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    37|     $template = $twig->loadTemplate('@admin/content/glossary.twig');
    38|     $templateVars = [
    39|         'adminHeaderGlossary' => Translation::get('ad_menu_glossary'),
    40|         'msgAddGlossary' => Translation::get('ad_glossary_add'),
    41|         'msgGlossaryItem' => Translation::get('ad_glossary_item'),
    42|         'msgGlossaryDefinition' => Translation::get('ad_glossary_definition'),
    43|         'glossaryItems' => $glossary->fetchAll(),
    44|         'buttonDelete' => Translation::get('msgDelete'),
    45|         'csrfTokenDelete' => Token::getInstance()->getTokenString('delete-glossary'),
    46|         'currentLanguage' => $faqLangCode,
    47|         'addGlossaryTitle' => Translation::get('ad_glossary_add'),
    48|         'addGlossaryCsrfTokenInput' => Token::getInstance()->getTokenInput('add-glossary'),
    49|         'closeModal' => Translation::get('ad_att_close'),
    50|         'saveModal' => Translation::get('ad_gen_save'),
    51|         'updateGlossaryTitle' => Translation::get('ad_glossary_edit'),
    52|         'updateGlossaryCsrfToken' => Token::getInstance()->getTokenString('update-glossary'),
    53|     ];
    54|     echo $template->render($templateVars);
    55| } else {
    56|     require __DIR__ . '/no-permission.php';
    57| }


# ====================================================================
# FILE: phpmyfaq/admin/group.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-289 ---
     1| <?php
     2| /**
     3|  * Displays the group management frontend.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Lars Tiedemann <php@larstiedemann.de>
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @author    Charles Boin <c.boin@h-tube.com>
    13|  * @copyright 2005-2024 phpMyFAQ Team
    14|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    15|  * @link      https://www.phpmyfaq.de
    16|  * @since     2005-12-15
    17|  */
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Session\Token;
    22| use phpMyFAQ\Strings;
    23| use phpMyFAQ\Template\Extensions\PermissionTranslationTwigExtension;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User;
    27| use phpMyFAQ\User\CurrentUser;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $faqConfig = Configuration::getConfigurationInstance();
    33| $user = CurrentUser::getCurrentUser($faqConfig);
    34| $templateVars = [];
    35| if (
    36|     !$user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_ADD->value) &&
    37|     !$user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_DELETE->value) &&
    38|     !$user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_EDIT->value)
    39| ) {
    40|     require __DIR__ . '/no-permission.php';
    41| }
    42| $defaultGroupAction = 'list';
    43| $groupActionList = [
    44|     'update_members',
    45|     'update_rights',
    46|     'update_data',
    47|     'delete_confirm',
    48|     'delete',
    49|     'addsave',
    50|     'add',
    51|     'list',
    52|     'import-ldap-groups',
    53| ];
    54| $groupAction = Filter::filterInput(INPUT_GET, 'group_action', FILTER_SANITIZE_SPECIAL_CHARS, $defaultGroupAction);
    55| $currentUser = new CurrentUser($faqConfig);
    56| if (isset($_POST['group_action_deleteConfirm'])) {
    57|     $groupAction = 'delete_confirm';
    58| }
    59| if (isset($_POST['cancel'])) {
    60|     $groupAction = $defaultGroupAction;
    61| }
    62| if (!in_array($groupAction, $groupActionList)) {
    63| }
    64| if (
    65|     $groupAction == 'update_members' &&
    66|     $user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_EDIT->value)
    67| ) {
    68|     $message = '';
    69|     $groupAction = $defaultGroupAction;
    70|     $groupId = Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT);
    71|     $groupMembers = $_POST['group_members'] ?? [];
    72|     if ($groupId == 0) {
    73|         $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_user_error_noId'));
    74|     } else {
    75|         $user = new User($faqConfig);
    76|         $perm = $user->perm;
    77|         if (!$perm->removeAllUsersFromGroup($groupId)) {
    78|             $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_msg_mysqlerr'));
    79|         }
    80|         foreach ($groupMembers as $memberId) {
    81|             $perm->addToGroup((int)$memberId, $groupId);
    82|         }
    83|         $message .= sprintf(
    84|             '<p class="alert alert-success">%s <strong>%s</strong> %s</p>',
    85|             Translation::get('ad_msg_savedsuc_1'),
    86|             $perm->getGroupName($groupId),
    87|             Translation::get('ad_msg_savedsuc_2')
    88|         );
    89|     }
    90| }
    91| if (
    92|     $groupAction == 'update_rights' &&
    93|     $user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_EDIT->value)
    94| ) {
    95|     $message = '';
    96|     $groupAction = $defaultGroupAction;
    97|     $groupId = Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT);
    98|     if ($groupId == 0) {
    99|         $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_user_error_noId'));
   100|     } else {
   101|         $user = new User($faqConfig);
   102|         $perm = $user->perm;
   103|         $groupRights = $_POST['group_rights'] ?? [];
   104|         if (!$perm->refuseAllGroupRights($groupId)) {
   105|             $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_msg_mysqlerr'));
   106|         }
   107|         foreach ($groupRights as $rightId) {
   108|             $perm->grantGroupRight($groupId, (int)$rightId);
   109|         }
   110|         $message .= sprintf(
   111|             '<p class="alert alert-success">%s <strong>%s</strong> %s</p>',
   112|             Translation::get('ad_msg_savedsuc_1'),
   113|             $perm->getGroupName($groupId),
   114|             Translation::get('ad_msg_savedsuc_2')
   115|         );
   116|     }
   117| }
   118| if (
   119|     $groupAction == 'update_data' &&
   120|     $user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_EDIT->value)
   121| ) {
   122|     $message = '';
   123|     $groupAction = $defaultGroupAction;
   124|     $groupId = Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT);
   125|     if ($groupId == 0) {
   126|         $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_user_error_noId'));
   127|     } else {
   128|         $groupData = [];
   129|         $dataFields = ['name', 'description', 'auto_join'];
   130|         foreach ($dataFields as $field) {
   131|             $groupData[$field] = Filter::filterInput(INPUT_POST, $field, FILTER_SANITIZE_SPECIAL_CHARS, '');
   132|         }
   133|         $user = new User($faqConfig);
   134|         $perm = $user->perm;
   135|         if (!$perm->changeGroup($groupId, $groupData)) {
   136|             $message .= sprintf(
   137|                 '<div class="alert alert-danger">%s %s</div>',
   138|                 Translation::get('ad_msg_mysqlerr'),
   139|                 $faqConfig->getDb()->error()
   140|             );
   141|         } else {
   142|             $message .= sprintf(
   143|                 '<p class="alert alert-success">%s <strong>%s</strong> %s</p>',
   144|                 Translation::get('ad_msg_savedsuc_1'),
   145|                 $perm->getGroupName($groupId),
   146|                 Translation::get('ad_msg_savedsuc_2')
   147|             );
   148|         }
   149|     }
   150| }
   151| if (
   152|     $groupAction == 'delete_confirm' &&
   153|     $user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_DELETE->value)
   154| ) {
   155|     $message = '';
   156|     $user = new CurrentUser($faqConfig);
   157|     $perm = $user->perm;
   158|     $groupId = Filter::filterInput(INPUT_POST, 'group_list_select', FILTER_VALIDATE_INT, 0);
   159|     if ($groupId <= 0) {
   160|         $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_user_error_noId'));
   161|         $groupAction = $defaultGroupAction;
   162|     } else {
   163|         $groupData = $perm->getGroupData($groupId);
   164|         $showDeleteGroupForm = true;
   165|         $templateVars = [
   166|             ...$templateVars,
   167|             'ad_group_deleteGroup' => Translation::get('ad_group_deleteGroup'),
   168|             'groupName' => Strings::htmlentities($groupData['name']),
   169|             'ad_group_deleteQuestion' => Translation::get('ad_group_deleteQuestion'),
   170|             'groupId' => $groupId,
   171|             'csrfDeleteGroup' => Token::getInstance()->getTokenString('delete-group'),
   172|             'ad_gen_no' => Translation::get('ad_gen_no'),
   173|             'ad_gen_yes' => Translation::get('ad_gen_yes'),
   174|             'showDeleteGroupForm' => $showDeleteGroupForm
   175|         ];
   176|     }
   177| }
   178| if ($groupAction == 'delete' && $user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_DELETE->value)) {
   179|     $message = '';
   180|     $user = new User($faqConfig);
   181|     $groupId = Filter::filterInput(INPUT_POST, 'group_id', FILTER_VALIDATE_INT);
   182|     $csrfOkay = true;
   183|     $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
   184|     if (!Token::getInstance()->verifyToken('delete-group', $csrfToken)) {
   185|         $csrfOkay = false;
   186|     }
   187|     $groupAction = $defaultGroupAction;
   188|     if ($groupId <= 0) {
   189|         $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_user_error_noId'));
   190|     } else {
   191|         if (!$user->perm->deleteGroup($groupId) && !$csrfOkay) {
   192|             $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_group_error_delete'));
   193|         } else {
   194|             $message .= sprintf('<div class="alert alert-danger">%s</div>', Translation::get('ad_group_deleted'));
   195|         }
   196|         $userError = $user->error();
   197|         if ($userError != '') {
   198|             $message .= sprintf('<p class="alert alert-danger">%s</p>', $userError);
   199|         }
   200|     }
   201| }
   202| if ($groupAction == 'addsave' && $user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_ADD->value)) {
   203|     $user = new User($faqConfig);
   204|     $message = '';
   205|     $messages = [];
   206|     $groupName = Filter::filterInput(INPUT_POST, 'group_name', FILTER_SANITIZE_SPECIAL_CHARS, '');
   207|     $groupDescription = Filter::filterInput(INPUT_POST, 'group_description', FILTER_SANITIZE_SPECIAL_CHARS, '');
   208|     $groupAutoJoin = Filter::filterInput(INPUT_POST, 'group_auto_join', FILTER_SANITIZE_SPECIAL_CHARS, '');
   209|     $csrfOkay = true;
   210|     $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
   211|     if (!Token::getInstance()->verifyToken('add-group', $csrfToken)) {
   212|         $csrfOkay = false;
   213|     }
   214|     if ($groupName == '') {
   215|         $messages[] = Translation::get('ad_group_error_noName');
   216|     }
   217|     if (count($messages) == 0 && $csrfOkay) {
   218|         $groupData = [
   219|             'name' => $groupName,
   220|             'description' => $groupDescription,
   221|             'auto_join' => $groupAutoJoin,
   222|         ];
   223|         if ($user->perm->addGroup($groupData) <= 0) {
   224|             $messages[] = Translation::get('ad_adus_dberr');
   225|         }
   226|     }
   227|     if (count($messages) === 0) {
   228|         $groupAction = $defaultGroupAction;
   229|         $message = sprintf('<div class="alert alert-success">%s</div>', Translation::get('ad_group_suc'));
   230|     } else {
   231|         $groupAction = 'add';
   232|         $message = '<p class="alert alert-danger">';
   233|         foreach ($messages as $err) {
   234|             $message .= $err . '<br>';
   235|         }
   236|         $message .= '</p>';
   237|     }
   238| }
   239| if (!isset($message)) {
   240|     $message = '';
   241| }
   242| if ($groupAction == 'add' && $user->perm->hasPermission($user->getUserId(), PermissionType::GROUP_ADD->value)) {
   243|     $user = new CurrentUser($faqConfig);
   244|     $templateVars = [
   245|         ...$templateVars,
   246|         'ad_group_add' => Translation::get('ad_group_add'),
   247|         'csrfAddGroup' => Token::getInstance()->getTokenString('add-group'),
   248|         'ad_group_name' => Translation::get('ad_group_name'),
   249|         'groupName' => $groupName ?? '',
   250|         'ad_group_description' => Translation::get('ad_group_description'),
   251|         'groupDescription' => $groupDescription ?? '',
   252|         'ad_group_autoJoin' => Translation::get('ad_group_autoJoin'),
   253|         'autoJoinCheckbox' => ((isset($groupAutoJoin) && $groupAutoJoin) ? ' checked' : ''),
   254|         'ad_gen_cancel' => Translation::get('ad_gen_cancel'),
   255|         'ad_gen_save' => Translation::get('ad_gen_save'),
   256|         'groupAction' => $groupAction
   257|     ];
   258| }
   259| if ('list' === $groupAction) {
   260|     $templateVars = [
   261|         ...$templateVars,
   262|         'ad_menu_group_administration' => Translation::get('ad_menu_group_administration'),
   263|         'ad_group_add_link' => Translation::get('ad_group_add_link'),
   264|         'message' => $message,
   265|         'ad_groups' => Translation::get('ad_groups'),
   266|         'ad_gen_delete' => Translation::get('ad_gen_delete'),
   267|         'ad_group_details' => Translation::get('ad_group_details'),
   268|         'ad_group_name' => Translation::get('ad_group_name'),
   269|         'groupName' => $groupName ?? '',
   270|         'ad_group_description' => Translation::get('ad_group_description'),
   271|         'groupDescription' => $groupDescription ?? '',
   272|         'autoJoinCheckbox' => ((isset($groupAutoJoin) && $groupAutoJoin) ? ' checked' : ''),
   273|         'ad_group_autoJoin' => Translation::get('ad_group_autoJoin'),
   274|         'ad_gen_save' => Translation::get('ad_gen_save'),
   275|         'ad_group_membership' => Translation::get('ad_group_membership'),
   276|         'ad_group_addMember' => Translation::get('ad_group_addMember'),
   277|         'ad_group_members' => Translation::get('ad_group_members'),
   278|         'ad_group_removeMember' => Translation::get('ad_group_removeMember'),
   279|         'ad_group_rights' => Translation::get('ad_group_rights'),
   280|         'ad_user_checkall' => Translation::get('ad_user_checkall'),
   281|         'ad_user_uncheckall' => Translation::get('ad_user_uncheckall'),
   282|         'rightData' => $user->perm->getAllRightsData(),
   283|         'groupAction' => $groupAction
   284|     ];
   285| }
   286| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   287| $twig->addExtension(new PermissionTranslationTwigExtension());
   288| $template = $twig->loadTemplate('@admin/user/group.twig');
   289| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/header.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-275 ---
     1| <?php
     2| /**
     3|  * Header of the admin area.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-26
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Helper\AdministrationHelper;
    19| use phpMyFAQ\Helper\LanguageHelper;
    20| use phpMyFAQ\Services\Gravatar;
    21| use phpMyFAQ\Session\Token;
    22| use phpMyFAQ\System;
    23| use phpMyFAQ\Template\TwigWrapper;
    24| use phpMyFAQ\Translation;
    25| use phpMyFAQ\User\CurrentUser;
    26| if (!defined('IS_VALID_PHPMYFAQ')) {
    27|     http_response_code(400);
    28|     exit();
    29| }
    30| $dashboardPage = true;
    31| $contentPage = false;
    32| $userPage = false;
    33| $statisticsPage = false;
    34| $exportsPage = false;
    35| $backupPage = false;
    36| $configurationPage = false;
    37| $faqConfig = Configuration::getConfigurationInstance();
    38| $user = CurrentUser::getCurrentUser($faqConfig);
    39| $adminHelper = new AdministrationHelper();
    40| $adminHelper->setUser($user);
    41| $secLevelEntries['user'] = $adminHelper->addMenuEntry(
    42|     'add_user+edit_user+delete_user',
    43|     'user',
    44|     'ad_menu_user_administration',
    45|     $action
    46| );
    47| if ($faqConfig->get('security.permLevel') !== 'basic') {
    48|     $secLevelEntries['user'] .= $adminHelper->addMenuEntry(
    49|         'addgroup+editgroup+delgroup',
    50|         'group',
    51|         'ad_menu_group_administration',
    52|         $action
    53|     );
    54| }
    55| $secLevelEntries['content'] = $adminHelper->addMenuEntry(
    56|     'addcateg+editcateg+delcateg',
    57|     'category-overview',
    58|     'msgHeaderCategoryOverview',
    59|     $action
    60| );
    61| $secLevelEntries['content'] .= $adminHelper->addMenuEntry(
    62|     PermissionType::FAQ_ADD->value,
    63|     'editentry',
    64|     'ad_entry_add',
    65|     $action
    66| );
    67| $secLevelEntries['content'] .= $adminHelper->addMenuEntry(
    68|     'edit_faq+delete_faq',
    69|     'faqs-overview',
    70|     'msgHeaderFAQOverview',
    71|     $action
    72| );
    73| $secLevelEntries['content'] .= $adminHelper->addMenuEntry(
    74|     PermissionType::FAQ_EDIT->value,
    75|     'stickyfaqs',
    76|     'stickyRecordsHeader',
    77|     $action
    78| );
    79| $secLevelEntries['content'] .= $adminHelper->addMenuEntry('delquestion', 'question', 'ad_menu_open', $action);
    80| $secLevelEntries['content'] .= $adminHelper->addMenuEntry('delcomment', 'comments', 'ad_menu_comments', $action);
    81| $secLevelEntries['content'] .= $adminHelper->addMenuEntry(
    82|     'addattachment+editattachment+delattachment',
    83|     'attachments',
    84|     'ad_menu_attachments',
    85|     $action
    86| );
    87| $secLevelEntries['content'] .= $adminHelper->addMenuEntry(
    88|     PermissionType::FAQ_EDIT->value,
    89|     'tags',
    90|     'ad_entry_tags',
    91|     $action
    92| );
    93| $secLevelEntries['content'] .= $adminHelper->addMenuEntry(
    94|     'addglossary+editglossary+delglossary',
    95|     'glossary',
    96|     'ad_menu_glossary',
    97|     $action
    98| );
    99| $secLevelEntries['content'] .= $adminHelper->addMenuEntry(
   100|     'addnews+editnews+delnews',
   101|     'news',
   102|     'ad_menu_news_edit',
   103|     $action
   104| );
   105| $secLevelEntries['statistics'] = $adminHelper->addMenuEntry(
   106|     PermissionType::STATISTICS_VIEWLOGS->value,
   107|     'statistics',
   108|     'ad_menu_stat',
   109|     $action
   110| );
   111| $secLevelEntries['statistics'] .= $adminHelper->addMenuEntry(
   112|     PermissionType::STATISTICS_VIEWLOGS->value,
   113|     'viewsessions',
   114|     'ad_menu_session',
   115|     $action
   116| );
   117| $secLevelEntries['statistics'] .= $adminHelper->addMenuEntry(
   118|     PermissionType::STATISTICS_ADMINLOG->value,
   119|     'adminlog',
   120|     'ad_menu_adminlog',
   121|     $action
   122| );
   123| $secLevelEntries['statistics'] .= $adminHelper->addMenuEntry(
   124|     PermissionType::STATISTICS_VIEWLOGS->value,
   125|     'searchstats',
   126|     'ad_menu_searchstats',
   127|     $action
   128| );
   129| $secLevelEntries['statistics'] .= $adminHelper->addMenuEntry('reports', 'reports', 'ad_menu_reports', $action);
   130| $secLevelEntries['imports_exports'] = $adminHelper->addMenuEntry(
   131|     PermissionType::FAQ_ADD->value,
   132|     'importcsv',
   133|     'msgImportRecords',
   134|     $action
   135| );
   136| $secLevelEntries['imports_exports'] .= $adminHelper->addMenuEntry('export', 'export', 'ad_menu_export', $action);
   137| $secLevelEntries['backup'] = $adminHelper->addMenuEntry('editconfig', 'backup', 'ad_menu_backup', $action);
   138| $secLevelEntries['config'] = $adminHelper->addMenuEntry('editconfig', 'config', 'ad_menu_editconfig', $action);
   139| $secLevelEntries['config'] .= $adminHelper->addMenuEntry('forms_edit', 'forms', 'msgEditForms', $action);
   140| $secLevelEntries['config'] .= $adminHelper->addMenuEntry(
   141|     'editinstances+addinstances+delinstances',
   142|     'instances',
   143|     'ad_menu_instances',
   144|     $action
   145| );
   146| $secLevelEntries['config'] .= $adminHelper->addMenuEntry(
   147|     'editconfig',
   148|     'stopwordsconfig',
   149|     'ad_menu_stopwordsconfig',
   150|     $action
   151| );
   152| if ($faqConfig->get('upgrade.onlineUpdateEnabled')) {
   153|     $secLevelEntries['config'] .= $adminHelper->addMenuEntry('editconfig', 'upgrade', 'ad_menu_upgrade', $action);
   154| }
   155| if ($faqConfig->get('search.enableElasticsearch')) {
   156|     $secLevelEntries['config'] .= $adminHelper->addMenuEntry(
   157|         'editconfig',
   158|         'elasticsearch',
   159|         'ad_menu_elasticsearch',
   160|         $action
   161|     );
   162| }
   163| $secLevelEntries['config'] .= $adminHelper->addMenuEntry('editconfig', 'system', 'ad_system_info', $action);
   164| switch ($action) {
   165|     case 'user':
   166|     case 'group':
   167|     case 'passwd':
   168|     case 'cookies':
   169|         $userPage = true;
   170|         break;
   171|     case 'category-overview':
   172|     case 'addcategory':
   173|     case 'savecategory':
   174|     case 'editcategory':
   175|     case 'translatecategory':
   176|     case 'updatecategory':
   177|     case 'showcategory':
   178|     case 'faqs-overview':
   179|     case 'editentry':
   180|     case 'copyentry':
   181|     case 'glossary':
   182|     case 'saveglossary':
   183|     case 'updateglossary':
   184|     case 'deleteglossary':
   185|     case 'addglossary':
   186|     case 'editglossary':
   187|     case 'news':
   188|     case 'add-news':
   189|     case 'edit-news':
   190|     case 'save-news':
   191|     case 'update-news':
   192|     case 'delete-news':
   193|     case 'question':
   194|     case 'takequestion':
   195|     case 'comments':
   196|     case 'attachments':
   197|     case 'tags':
   198|     case 'delete-tag':
   199|     case 'stickyfaqs':
   200|         $contentPage = true;
   201|         break;
   202|     case 'statistics':
   203|     case 'viewsessions':
   204|     case 'sessionbrowse':
   205|     case 'sessionsuche':
   206|     case 'adminlog':
   207|     case 'searchstats':
   208|     case 'reports':
   209|     case 'reportview':
   210|         $statisticsPage = true;
   211|         break;
   212|     case 'export':
   213|     case 'importcsv':
   214|         $exportsPage = true;
   215|         break;
   216|     case 'backup':
   217|         $backupPage = true;
   218|         break;
   219|     case 'config':
   220|     case 'stopwordsconfig':
   221|     case 'upgrade':
   222|     case 'instances':
   223|     case 'system':
   224|     case 'elasticsearch':
   225|     case 'forms':
   226|         $configurationPage = true;
   227|         break;
   228|     default:
   229|         $dashboardPage = true;
   230|         break;
   231| }
   232| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   233| $template = $twig->loadTemplate('@admin/header.twig');
   234| if ($faqConfig->get('main.enableGravatarSupport')) {
   235|     $avatar = new Gravatar();
   236|     $gravatarImage = $avatar->getImage(
   237|         $user->getUserData('email'),
   238|         ['size' => 24, 'class' => 'img-profile rounded-circle']
   239|     );
   240| }
   241| $templateVars = [
   242|     'metaLanguage' => Translation::get('metaLanguage'),
   243|     'layoutMode' => 'light',
   244|     'pageTitle' => $faqConfig->getTitle() . ' - ' . System::getPoweredByString(),
   245|     'baseHref' => $faqConfig->getDefaultUrl() . 'admin/',
   246|     'version' => System::getVersion(),
   247|     'currentYear' => date('Y'),
   248|     'metaRobots' => $faqConfig->get('seo.metaTagsAdmin'),
   249|     'templateSetName' => TwigWrapper::getTemplateSetName(),
   250|     'pageDirection' => Translation::get('direction'),
   251|     'userHasAccessPermission' => $adminHelper->canAccessContent($user),
   252|     'msgSessionExpiration' => Translation::get('ad_session_expiration'),
   253|     'pageAction' => isset($action) ? '?action=' . $action : '',
   254|     'renderedLanguageSelection' => LanguageHelper::renderSelectLanguage($faqLangCode, true),
   255|     'userName' => $user->getUserData('display_name'),
   256|     'hasGravatarSupport' => $faqConfig->get('main.enableGravatarSupport'),
   257|     'gravatarImage' => $gravatarImage ?? '',
   258|     'msgChangePassword' => Translation::get('ad_menu_passwd'),
   259|     'csrfTokenLogout' => Token::getInstance()->getTokenString('admin-logout'),
   260|     'msgLogout' => Translation::get('admin_mainmenu_logout'),
   261|     'secondLevelEntries' => $secLevelEntries,
   262|     'menuUsers' => Translation::get('admin_mainmenu_users'),
   263|     'menuContent' => Translation::get('admin_mainmenu_content'),
   264|     'menuStatistics' => Translation::get('admin_mainmenu_statistics'),
   265|     'menuImportsExports' => Translation::get('admin_mainmenu_imports_exports'),
   266|     'menuBackup' => Translation::get('admin_mainmenu_backup'),
   267|     'menuConfiguration' => Translation::get('admin_mainmenu_configuration'),
   268|     'userPage' => $userPage,
   269|     'contentPage' => $contentPage,
   270|     'statisticsPage' => $statisticsPage,
   271|     'exportsPage' => $exportsPage,
   272|     'backupPage' => $backupPage,
   273|     'configurationPage' => $configurationPage,
   274| ];
   275| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/import.csv.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-56 ---
     1| <?php
     2| /**
     3|  * Frontend for importing records from a csv file.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Session\Token;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use phpMyFAQ\User\CurrentUser;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = Configuration::getConfigurationInstance();
    27| $user = CurrentUser::getCurrentUser($faqConfig);
    28| if ($user->perm->hasPermission($user->getUserId(), PermissionType::FAQ_ADD->value)) {
    29|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    30|     $template = $twig->loadTemplate('@admin/import-export/import.csv.twig');
    31|     $templateVars = [
    32|         'adminHeaderImport' => Translation::get('msgImportRecords'),
    33|         'adminHeaderCSVImport' => Translation::get('msgImportCSVFile'),
    34|         'adminBodyCSVImport' => Translation::get('msgImportCSVFileBody'),
    35|         'adminImportLabel' => Translation::get('ad_csv_file'),
    36|         'adminCSVImport' => Translation::get('msgImport'),
    37|         'adminHeaderCSVImportColumns' => Translation::get('msgColumnStructure'),
    38|         'categoryId' => Translation::get('ad_categ_categ'),
    39|         'question' => Translation::get('ad_entry_topic'),
    40|         'answer' => Translation::get('ad_entry_content'),
    41|         'keywords' => Translation::get('ad_entry_keywords'),
    42|         'author' => Translation::get('ad_entry_author'),
    43|         'email' => Translation::get('msgEmail'),
    44|         'languageCode' => Translation::get('msgLanguageCode'),
    45|         'seperateWithCommas' => Translation::get('msgSeperateWithCommas'),
    46|         'tags' => Translation::get('ad_entry_tags'),
    47|         'msgImportRecordsColumnStructure' => Translation::get('msgImportRecordsColumnStructure'),
    48|         'csrfToken' => Token::getInstance()->getTokenString('importfaqs'),
    49|         'is_active' => Translation::get('ad_entry_active'),
    50|         'is_sticky' => Translation::get('ad_entry_sticky'),
    51|         'trueFalse' => Translation::get('msgCSVImportTrueOrFalse')
    52|     ];
    53|     echo $template->render($templateVars);
    54| } else {
    55|     require __DIR__ . '/no-permission.php';
    56| }


# ====================================================================
# FILE: phpmyfaq/admin/index.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-317 ---
     1| <?php
     2| /**
     3|  * The main admin backend index file.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Bastian Poettner <bastian@poettner.net>
    12|  * @author    Meikel Katzengreis <meikel@katzengreis.com>
    13|  * @author    Minoru TODA <todam@netjapan.co.jp>
    14|  * @author    Matteo Scaramuccia <matteo@phpmyfaq.de>
    15|  * @copyright 2002-2024 phpMyFAQ Team
    16|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    17|  * @link      https://www.phpmyfaq.de
    18|  * @since     2002-09-16
    19|  */
    20| use phpMyFAQ\Administration\AdminLog;
    21| use phpMyFAQ\Attachment\AttachmentFactory;
    22| use phpMyFAQ\Faq;
    23| use phpMyFAQ\Filter;
    24| use phpMyFAQ\Language;
    25| use phpMyFAQ\Session\Token;
    26| use phpMyFAQ\Strings;
    27| use phpMyFAQ\System;
    28| use phpMyFAQ\Template\TwigWrapper;
    29| use phpMyFAQ\Translation;
    30| use phpMyFAQ\User\CurrentUser;
    31| use phpMyFAQ\User\TwoFactor;
    32| use phpMyFAQ\User\UserAuthentication;
    33| use Symfony\Component\Config\FileLocator;
    34| use Symfony\Component\DependencyInjection\ContainerBuilder;
    35| use Symfony\Component\DependencyInjection\Loader\PhpFileLoader;
    36| use Symfony\Component\HttpFoundation\Request;
    37| use Symfony\Component\HttpFoundation\Response;
    38| define('PMF_ROOT_DIR', dirname(__DIR__));
    39| const IS_VALID_PHPMYFAQ = null;
    40| require PMF_ROOT_DIR . '/src/Bootstrap.php';
    41| $response = new Response();
    42| $request = Request::createFromGlobals();
    43| $container = new ContainerBuilder();
    44| $loader = new PhpFileLoader($container, new FileLocator(__DIR__));
    45| try {
    46|     $loader->load('../src/services.php');
    47| } catch (Exception $e) {
    48|     echo $e->getMessage();
    49| }
    50| $faqConfig = $container->get('phpmyfaq.configuration');
    51| $Language = $container->get('phpmyfaq.language');
    52| $faqLangCode = $Language->setLanguage($faqConfig->get('main.languageDetection'), $faqConfig->get('main.language'));
    53| $faqConfig->setLanguage($Language);
    54| if (!Language::isASupportedLanguage($faqLangCode)) {
    55|     $faqLangCode = 'en';
    56| }
    57| try {
    58|     Translation::create()
    59|             ->setLanguagesDir(PMF_TRANSLATION_DIR)
    60|             ->setDefaultLanguage('en')
    61|             ->setCurrentLanguage($faqLangCode)
    62|             ->setMultiByteLanguage();
    63| } catch (Exception $e) {
    64|     echo '<strong>Error:</strong> ' . $e->getMessage();
    65| }
    66| Strings::init($faqLangCode);
    67| TwigWrapper::setTemplateSetName($faqConfig->get('layout.templateSet'));
    68| AttachmentFactory::init(
    69|     $faqConfig->get('records.defaultAttachmentEncKey'),
    70|     $faqConfig->get('records.enableAttachmentEncryption')
    71| );
    72| $faqSystem = new System();
    73| $faq = new Faq($faqConfig);
    74| $action = Filter::filterInput(INPUT_GET, 'action', FILTER_SANITIZE_SPECIAL_CHARS);
    75| if (is_null($action)) {
    76|     $action = Filter::filterInput(INPUT_POST, 'action', FILTER_SANITIZE_SPECIAL_CHARS);
    77| }
    78| if (!is_null($action)) {
    79|     $action = Strings::htmlentities($action);
    80| }
    81| $redirectAction = Filter::filterInput(INPUT_POST, 'redirect-action', FILTER_SANITIZE_SPECIAL_CHARS);
    82| if (is_null($action) && '' !== $redirectAction && 'logout' !== $redirectAction) {
    83|     $action = $redirectAction;
    84| }
    85| $error = '';
    86| $faqusername = Filter::filterVar($request->request->get('faqusername'), FILTER_SANITIZE_SPECIAL_CHARS);
    87| $faqpassword = Filter::filterVar($request->request->get('faqpassword'), FILTER_SANITIZE_SPECIAL_CHARS, FILTER_FLAG_NO_ENCODE_QUOTES);
    88| $rememberMe = Filter::filterVar($request->request->get('faqrememberme'), FILTER_VALIDATE_BOOLEAN);
    89| $token = Filter::filterVar($request->request->get('token'), FILTER_SANITIZE_SPECIAL_CHARS);
    90| $userid = Filter::filterVar($request->request->get('userid'), FILTER_VALIDATE_INT);
    91| if (!is_null($token) && !is_null($userid)) {
    92|     $user = new CurrentUser($faqConfig);
    93|     $user->getUserById($userid);
    94|     if (strlen((string) $token) === 6 && is_numeric((string) $token)) {
    95|         $tfa = new TwoFactor($faqConfig, $user);
    96|         $res = $tfa->validateToken($token, $userid);
    97|         if (!$res) {
    98|             $error = Translation::get('msgTwofactorErrorToken');
    99|             $action = 'twofactor';
   100|         } else {
   101|             $user->twoFactorSuccess();
   102|             require 'header.php';
   103|             require 'dashboard.php';
   104|             exit();
   105|         }
   106|     } else {
   107|         $error = Translation::get('msgTwofactorErrorToken');
   108|         $action = 'twofactor';
   109|     }
   110| }
   111| if (!isset($user)) {
   112|     $user = new CurrentUser($faqConfig);
   113| }
   114| if ($faqConfig->get('security.ssoSupport') && $request->server->get('REMOTE_USER') !== null) {
   115|     $faqusername = trim((string) $request->server->get('REMOTE_USER'));
   116|     $faqpassword = '';
   117| }
   118| if ($faqusername !== '' && ($faqpassword !== '' || $faqConfig->get('security.ssoSupport'))) {
   119|     $userAuth = new UserAuthentication($faqConfig, $user);
   120|     $userAuth->setRememberMe($faqremember ?? false);
   121|     try {
   122|         $user = $userAuth->authenticate($faqusername, $faqpassword);
   123|         $userid = $user->getUserId();
   124|         if ($userAuth->hasTwoFactorAuthentication()) {
   125|             $action = 'twofactor';
   126|         }
   127|     } catch (Exception $e) {
   128|         $logging = new AdminLog($faqConfig);
   129|         $logging->log($user, 'Login-error\nLogin: ' . $faqusername . '\nErrors: ' . implode(', ', $user->errors));
   130|         $action = 'login';
   131|         $error = $e->getMessage();
   132|     }
   133| } else {
   134|     $user = CurrentUser::getCurrentUser($faqConfig);
   135| }
   136| if (isset($userAuth)) {
   137|     if ($userAuth instanceof UserAuthentication) {
   138|         if ($userAuth->hasTwoFactorAuthentication()) {
   139|             $action = 'twofactor';
   140|         }
   141|     }
   142| }
   143| $csrfToken = Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
   144| if (
   145|     $csrfToken &&
   146|     Token::getInstance()->verifyToken('admin-logout', $csrfToken) &&
   147|     $action === 'logout' &&
   148|     $user->isLoggedIn()
   149| ) {
   150|     $user->deleteFromSession(true);
   151|     $ssoLogout = $faqConfig->get('security.ssoLogoutRedirect');
   152|     if ($faqConfig->get('security.ssoSupport') && !empty($ssoLogout)) {
   153|         $response->isRedirect($ssoLogout);
   154|         $response->send();
   155|         exit();
   156|     }
   157| }
   158| [$currentAdminUser, $currentAdminGroups] = CurrentUser::getCurrentUserGroupId($user);
   159| switch ($action) {
   160|     case 'reportexport':
   161|         require 'report.export.php';
   162|         exit();
   163| }
   164| require 'header.php';
   165| if ($action === 'twofactor') {
   166|     require 'twofactor.php';
   167|     exit();
   168| }
   169| $numRights = $user->perm->getUserRightsCount($user);
   170| if ($user->isLoggedIn() && $user->getUserId() > 0 && ($numRights > 0 || $user->isSuperAdmin())) {
   171|     if (!is_null($action)) {
   172|         switch ($action) {
   173|             case 'user':
   174|                 require 'user.php';
   175|                 break;
   176|             case 'group':
   177|                 require 'group.php';
   178|                 break;
   179|             case 'faqs-overview':
   180|                 require 'faqs.overview.php';
   181|                 break;
   182|             case 'viewinactive':
   183|             case 'viewactive':
   184|             case 'takequestion':
   185|             case 'editentry':
   186|             case 'copyentry':
   187|                 require 'faqs.editor.php';
   188|                 break;
   189|             case 'question':
   190|                 require 'open-questions.php';
   191|                 break;
   192|             case 'comments':
   193|                 require 'comments.php';
   194|                 break;
   195|             case 'stickyfaqs':
   196|                 require 'stickyfaqs.php';
   197|                 break;
   198|             case 'tags':
   199|             case 'delete-tag':
   200|                 require 'tags.php';
   201|                 break;
   202|             case 'news':
   203|             case 'add-news':
   204|             case 'edit-news':
   205|             case 'save-news':
   206|             case 'update-news':
   207|             case 'delete-news':
   208|                 require 'news.php';
   209|                 break;
   210|             case 'savecategory':
   211|             case 'updatecategory':
   212|                 require 'category.main.php';
   213|                 break;
   214|             case 'category-overview':
   215|                 require 'category.overview.php';
   216|                 break;
   217|             case 'addcategory':
   218|                 require 'category.add.php';
   219|                 break;
   220|             case 'editcategory':
   221|                 require 'category.edit.php';
   222|                 break;
   223|             case 'translatecategory':
   224|                 require 'category.translate.php';
   225|                 break;
   226|             case 'showcategory':
   227|                 require 'category.showstructure.php';
   228|                 break;
   229|             case 'glossary':
   230|                 require 'glossary.php';
   231|                 break;
   232|             case 'passwd':
   233|                 require 'password.change.php';
   234|                 break;
   235|             case 'adminlog':
   236|                 require 'statistics.admin-log.php';
   237|                 break;
   238|             case 'viewsessions':
   239|             case 'clear-visits':
   240|                 require 'statistics.sessions.php';
   241|                 break;
   242|             case 'sessionbrowse':
   243|                 require 'statistics.sessions.day.php';
   244|                 break;
   245|             case 'viewsession':
   246|                 require 'statistics.show.php';
   247|                 break;
   248|             case 'clear-statistics':
   249|             case 'statistics':
   250|                 require 'statistics.ratings.php';
   251|                 break;
   252|             case 'truncatesearchterms':
   253|             case 'searchstats':
   254|                 require 'statistics.search.php';
   255|                 break;
   256|             case 'reports':
   257|                 require 'report.main.php';
   258|                 break;
   259|             case 'reportview':
   260|                 require 'report.view.php';
   261|                 break;
   262|             case 'config':
   263|                 require 'configuration.php';
   264|                 break;
   265|             case 'system':
   266|                 require 'system.php';
   267|                 break;
   268|             case 'update-instance':
   269|             case 'instances':
   270|                 require 'instances.php';
   271|                 break;
   272|             case 'edit-instance':
   273|                 require 'instances.edit.php';
   274|                 break;
   275|             case 'stopwordsconfig':
   276|                 require 'stopwords.php';
   277|                 break;
   278|             case 'elasticsearch':
   279|                 require 'elasticsearch.php';
   280|                 break;
   281|             case 'upgrade':
   282|                 require 'upgrade.php';
   283|                 break;
   284|             case 'backup':
   285|                 require 'backup.main.php';
   286|                 break;
   287|             case 'restore':
   288|                 require 'backup.import.php';
   289|                 break;
   290|             case 'importcsv':
   291|                 require 'import.csv.php';
   292|                 break;
   293|             case 'export':
   294|                 require 'export.php';
   295|                 break;
   296|             case 'attachments':
   297|                 require 'attachments.php';
   298|                 break;
   299|             case 'forms':
   300|                 require 'forms.php';
   301|                 break;
   302|             case 'forms-translations':
   303|                 require 'forms.translations.php';
   304|                 break;
   305|             default:
   306|                 echo 'Dave, this conversation can serve no purpose anymore. Goodbye.';
   307|                 break;
   308|         }
   309|     } else {
   310|         require 'dashboard.php';
   311|     }
   312| } elseif ($user->isLoggedIn() && $numRights === 0) {
   313|     require __DIR__ . '/no-permission.php';
   314| } else {
   315|     require 'login.php';
   316| }
   317| require 'footer.php';


# ====================================================================
# FILE: phpmyfaq/admin/instances.edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| /**
     3|  * Frontend to edit an instance.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-04-16
    15|  */
    16| use phpMyFAQ\Enums\PermissionType;
    17| use phpMyFAQ\Filter;
    18| use phpMyFAQ\Instance;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| if (!defined('IS_VALID_PHPMYFAQ')) {
    22|     http_response_code(400);
    23|     exit();
    24| }
    25| if ($user->perm->hasPermission($user->getUserId(), PermissionType::INSTANCE_EDIT->value)) {
    26|     $instanceId = Filter::filterInput(INPUT_GET, 'instance_id', FILTER_VALIDATE_INT);
    27|     $instance = new Instance($faqConfig);
    28|     $instanceData = $instance->getById($instanceId, 'array');
    29|     $templateVars = [
    30|         'ad_menu_instances' => Translation::get('ad_menu_instances'),
    31|         'instanceConfig' => $instance->getInstanceConfig($instanceData->id),
    32|         'ad_instance_url' => Translation::get('ad_instance_url'),
    33|         'ad_instance_button' => Translation::get('ad_instance_button'),
    34|         'ad_instance_path' => Translation::get('ad_instance_path'),
    35|         'ad_instance_name' => Translation::get('ad_instance_name'),
    36|         'ad_instance_config' => Translation::get('ad_instance_config'),
    37|         'ad_entry_back' => Translation::get('ad_entry_back'),
    38|         'instance' => $instanceData
    39|     ];
    40|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    41|     $template = $twig->loadTemplate('@admin/configuration/instances.edit.twig');
    42|     echo $template->render($templateVars);
    43| } else {
    44|     require __DIR__ . '/no-permission.php';
    45| }


# ====================================================================
# FILE: phpmyfaq/admin/instances.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-108 ---
     1| <?php
     2| /**
     3|  * The main multi-site instances frontend.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-03-16
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Entity\InstanceEntity;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filesystem;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Instance;
    22| use phpMyFAQ\Instance\Client;
    23| use phpMyFAQ\Session\Token;
    24| use phpMyFAQ\System;
    25| use phpMyFAQ\Template\TwigWrapper;
    26| use phpMyFAQ\Translation;
    27| use phpMyFAQ\User\CurrentUser;
    28| use Symfony\Component\HttpFoundation\Request;
    29| if (!defined('IS_VALID_PHPMYFAQ')) {
    30|     http_response_code(400);
    31|     exit();
    32| }
    33| $faqConfig = Configuration::getConfigurationInstance();
    34| $user = CurrentUser::getCurrentUser($faqConfig);
    35| if ($user->perm->hasPermission($user->getUserId(), PermissionType::INSTANCE_EDIT->value)) {
    36|     $fileSystem = new Filesystem(PMF_ROOT_DIR);
    37|     $instance = new Instance($faqConfig);
    38|     $currentClient = new Client($faqConfig);
    39|     $currentClient->setFileSystem($fileSystem);
    40|     $instanceId = Filter::filterInput(INPUT_POST, 'instance_id', FILTER_VALIDATE_INT);
    41|     $templateVars = [];
    42|     if ('update-instance' === $action && is_integer($instanceId)) {
    43|         $system = new System();
    44|         $updatedClient = new Client($faqConfig);
    45|         $moveInstance = false;
    46|         $instance->setId($instanceId);
    47|         $updatedData = new InstanceEntity();
    48|         $updatedData->setUrl(Filter::filterInput(INPUT_POST, 'url', FILTER_VALIDATE_URL));
    49|         $updatedData->setInstance(Filter::filterInput(INPUT_POST, 'instance', FILTER_SANITIZE_SPECIAL_CHARS));
    50|         $updatedData->setComment(Filter::filterInput(INPUT_POST, 'comment', FILTER_SANITIZE_SPECIAL_CHARS));
    51|         $originalData = $currentClient->getById($instanceId);
    52|         if ($originalData->url !== $updatedData->getUrl() && !$instance->getConfig('isMaster')) {
    53|             $moveInstance = true;
    54|         }
    55|         if (is_null($updatedData->getUrl())) {
    56|             $templateVars = [
    57|                 ... $templateVars,
    58|                 'updateError' => $faqConfig->getDb()->error(),
    59|             ];
    60|         } else {
    61|             if ($updatedClient->update($instanceId, $updatedData)) {
    62|                 if ($moveInstance) {
    63|                     $updatedClient->moveClientFolder($originalData->url, $updatedData->getUrl());
    64|                     $updatedClient->deleteClientFolder($originalData->url);
    65|                 }
    66|                 $templateVars = [
    67|                     ... $templateVars,
    68|                     'updateSuccess' => Translation::get('ad_config_saved'),
    69|                 ];
    70|             } else {
    71|                 $templateVars = [
    72|                     ... $templateVars,
    73|                     'updateError' => $faqConfig->getDb()->error(),
    74|                 ];
    75|             }
    76|         }
    77|     }
    78|     $mainConfig = [];
    79|     foreach ($instance->getAll() as $site) {
    80|         $mainConfig[$site->id] = $instance->getInstanceConfig($site->id)['isMaster'];
    81|     }
    82|     $templateVars = [
    83|         ... $templateVars,
    84|         'userPermInstanceAdd' => $user->perm->hasPermission($user->getUserId(), PermissionType::INSTANCE_ADD->value),
    85|         'multisiteFolderIsWritable' => is_writable(PMF_ROOT_DIR . DIRECTORY_SEPARATOR . 'multisite'),
    86|         'ad_instance_add' => Translation::get('ad_instance_add'),
    87|         'allInstances' => $instance->getAll(),
    88|         'csrfTokenDeleteInstance' => Token::getInstance()->getTokenString('delete-instance'),
    89|         'csrfTokenAddInstance' => Token::getInstance()->getTokenString('add-instance'),
    90|         'mainConfig' => $mainConfig,
    91|         'requestHost' => Request::createFromGlobals()->getHost(),
    92|         'ad_instance_button' => Translation::get('ad_instance_button'),
    93|         'ad_instance_hint' => Translation::get('ad_instance_hint'),
    94|         'ad_instance_admin' => Translation::get('ad_instance_admin'),
    95|         'ad_instance_password' => Translation::get('ad_instance_password'),
    96|         'ad_instance_email' => Translation::get('ad_instance_email'),
    97|         'ad_instance_name' => Translation::get('ad_instance_name'),
    98|         'ad_instance_path' => Translation::get('ad_instance_path'),
    99|         'ad_instance_url' => Translation::get('ad_instance_url'),
   100|         'ad_instance_error_notwritable' => Translation::get('ad_instance_error_notwritable'),
   101|         'ad_menu_instances' => Translation::get('ad_menu_instances')
   102|     ];
   103|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   104|     $template = $twig->loadTemplate('@admin/configuration/instances.twig');
   105|     echo $template->render($templateVars);
   106| } else {
   107|     require __DIR__ . '/no-permission.php';
   108| }


# ====================================================================
# FILE: phpmyfaq/admin/login.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-53 ---
     1| <?php
     2| /**
     3|  * The login form.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Alexander M. Turek <me@derrabus.de>
    12|  * @copyright 2013-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2013-02-05
    16|  */
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Strings;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use Symfony\Component\HttpFoundation\Request;
    22| $faqConfig = Configuration::getConfigurationInstance();
    23| if (isset($error) && 0 < strlen((string) $error)) {
    24|     $errorMessage = $error;
    25| } else {
    26|     $errorMessage = '';
    27| }
    28| $request = Request::createFromGlobals();
    29| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    30| $template = $twig->loadTemplate('@admin/login.twig');
    31| $templateVars = [
    32|     'isSecure' => $request->isSecure() || !$faqConfig->get('security.useSslForLogins'),
    33|     'isError' => isset($error) && 0 < strlen((string) $error),
    34|     'errorMessage' => $errorMessage,
    35|     'loginMessage' => Translation::get('ad_auth_insert'),
    36|     'isLogout' => $request->query->get('action') === 'logout',
    37|     'logoutMessage' => Translation::get('ad_logout'),
    38|     'loginUrl' => $faqConfig->getDefaultUrl() . 'admin/index.php',
    39|     'redirectAction' => Strings::htmlentities($request->query->get('action') ?? '') ,
    40|     'msgUsername' => Translation::get('ad_auth_user'),
    41|     'msgPassword' => Translation::get('ad_auth_passwd'),
    42|     'msgRememberMe' => Translation::get('rememberMe'),
    43|     'msgLostPassword' => Translation::get('lostPassword'),
    44|     'msgLoginUser' => Translation::get('msgLoginUser'),
    45|     'hasRegistrationEnabled' => $faqConfig->get('security.enableRegistration'),
    46|     'msgRegistration' => Translation::get('msgRegistration'),
    47|     'hasSignInWithMicrosoftActive' => $faqConfig->isSignInWithMicrosoftActive(),
    48|     'msgSignInWithMicrosoft' => Translation::get('msgSignInWithMicrosoft'),
    49|     'secureUrl' => sprintf('https://%s%s', $request->getHost(), $request->getRequestUri()),
    50|     'msgNotSecure' => Translation::get('msgSecureSwitch'),
    51|     'isWebAuthnEnabled' => $faqConfig->get('security.enableWebAuthnSupport'),
    52| ];
    53| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/media.browser.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-74 ---
     1| <?php
     2| /**
     3|  * Media browser backend for TinyMCE v6
     4|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     5|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     6|  * obtain one at https://mozilla.org/MPL/2.0/.
     7|  *
     8|  * @package   phpMyFAQ
     9|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    10|  * @copyright 2015-2024 phpMyFAQ Team
    11|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    12|  * @link      https://www.phpmyfaq.de
    13|  * @since     2015-10-18
    14|  */
    15| use phpMyFAQ\Language;
    16| use phpMyFAQ\Strings;
    17| use phpMyFAQ\Template\TwigWrapper;
    18| use phpMyFAQ\Translation;
    19| use phpMyFAQ\User\CurrentUser;
    20| use Symfony\Component\Config\FileLocator;
    21| use Symfony\Component\DependencyInjection\ContainerBuilder;
    22| use Symfony\Component\DependencyInjection\Loader\PhpFileLoader;
    23| define('PMF_ROOT_DIR', dirname(__DIR__));
    24| const IS_VALID_PHPMYFAQ = null;
    25| require PMF_ROOT_DIR . '/src/Bootstrap.php';
    26| $container = new ContainerBuilder();
    27| $loader = new PhpFileLoader($container, new FileLocator(__DIR__));
    28| try {
    29|     $loader->load('../src/services.php');
    30| } catch (\Exception $e) {
    31|     echo $e->getMessage();
    32| }
    33| $faqConfig = $container->get('phpmyfaq.configuration');
    34| $user = CurrentUser::getCurrentUser($faqConfig);
    35| $Language = $container->get('phpmyfaq.language');
    36| $faqLangCode = $Language->setLanguage($faqConfig->get('main.languageDetection'), $faqConfig->get('main.language'));
    37| $faqConfig->setLanguage($Language);
    38| if (!Language::isASupportedLanguage($faqLangCode)) {
    39|     $faqLangCode = 'en';
    40| }
    41| try {
    42|     Translation::create()
    43|         ->setLanguagesDir(PMF_TRANSLATION_DIR)
    44|         ->setDefaultLanguage('en')
    45|         ->setCurrentLanguage($faqLangCode)
    46|         ->setMultiByteLanguage();
    47| } catch (Exception $e) {
    48|     echo '<strong>Error:</strong> ' . $e->getMessage();
    49| }
    50| Strings::init($faqLangCode);
    51| $allowedExtensions = ['png', 'gif', 'jpg', 'jpeg', 'mov', 'mpg', 'mp4', 'ogg', 'wmv', 'avi', 'webm'];
    52| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    53| $template = $twig->loadTemplate('@admin/content/media.browser.twig');
    54| $images = [];
    55| if (is_dir(PMF_CONTENT_DIR . '/user/images')) {
    56|     $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator(PMF_CONTENT_DIR . '/user/images'));
    57|     foreach ($files as $file) {
    58|         if ($file->isDir() || !in_array(strtolower($file->getExtension()), $allowedExtensions)) {
    59|             continue;
    60|         }
    61|         $path = str_replace(dirname(__DIR__) . '/', '', (string)$file->getPath());
    62|         $images[] = $faqConfig->getDefaultUrl() . $path . '/' . $file->getFilename();
    63|     }
    64| }
    65| $templateVars = [
    66|     'metaLanguage' => Translation::get('metaLanguage'),
    67|     'notAuthenticated' => !$user->isLoggedIn(),
    68|     'msgNotAuthenticated' => Translation::get('err_NotAuth'),
    69|     'msgMediaSearch' => Translation::get('ad_media_name_search'),
    70|     'isImageDirectoryMissing' => !is_dir(PMF_CONTENT_DIR . '/user/images'),
    71|     'msgImageDirectoryMissing' => sprintf(Translation::get('ad_dir_missing'), '/images'),
    72|     'images' => $images,
    73| ];
    74| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/news.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-121 ---
     1| <?php
     2| /**
     3|  * The main administration file for the news.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Matteo Scaramuccia <matteo@phpmyfaq.de>
    12|  * @copyright 2003-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2003-02-23
    16|  */
    17| use phpMyFAQ\Comments;
    18| use phpMyFAQ\Entity\CommentType;
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Helper\LanguageHelper;
    22| use phpMyFAQ\News;
    23| use phpMyFAQ\Session\Token;
    24| use phpMyFAQ\Template\Extensions\FormatDateTwigExtension;
    25| use phpMyFAQ\Template\Extensions\IsoDateTwigExtension;
    26| use phpMyFAQ\Template\TwigWrapper;
    27| use phpMyFAQ\Translation;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $news = new News($faqConfig);
    33| $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
    34| $templateVars = [
    35|     'action' => $action,
    36|     'permissionAddNews' => $user->perm->hasPermission($user->getUserId(), PermissionType::NEWS_ADD),
    37|     'permissionEditNews' => $user->perm->hasPermission($user->getUserId(), PermissionType::NEWS_EDIT),
    38|     'permissionDeleteNews' => $user->perm->hasPermission($user->getUserId(), PermissionType::NEWS_DELETE),
    39|     'defaultUrl' => $faqConfig->getDefaultUrl(),
    40|     'enableWysiwyg' => $faqConfig->get('main.enableWysiwygEditor'),
    41|     'ad_news_add' => Translation::get('ad_news_add'),
    42|     'csrfToken_saveNews' => Token::getInstance()->getTokenString('save-news'),
    43|     'ad_news_author_name' => Translation::get('ad_news_author_name'),
    44|     'ad_news_set_active' => Translation::get('ad_news_set_active'),
    45|     'ad_news_link_url' => Translation::get('ad_news_link_url'),
    46|     'ad_news_link_title' => Translation::get('ad_news_link_title'),
    47|     'ad_news_link_target' => Translation::get('ad_news_link_target'),
    48|     'ad_news_link_window' => Translation::get('ad_news_link_window'),
    49|     'ad_news_link_faq' => Translation::get('ad_news_link_faq'),
    50|     'ad_news_link_parent' => Translation::get('ad_news_link_parent'),
    51|     'selectLanguage' => LanguageHelper::renderSelectLanguage($faqLangCode, false, [], 'langTo'),
    52|     'ad_news_expiration_window' => Translation::get('ad_news_expiration_window'),
    53|     'ad_news_from' => Translation::get('ad_news_from'),
    54|     'ad_news_to' => Translation::get('ad_news_to'),
    55|     'ad_entry_back' => Translation::get('ad_entry_back'),
    56|     'ad_menu_news_add' => Translation::get('ad_menu_news_add'),
    57|     'ad_news_headline' => Translation::get('ad_news_headline'),
    58|     'ad_news_date' => Translation::get('ad_news_date'),
    59|     'ad_news_update' => Translation::get('ad_news_update'),
    60|     'ad_news_delete' => Translation::get('ad_news_delete'),
    61|     'ad_news_nodata' => Translation::get('ad_news_nodata'),
    62|     'ad_news_edit' => Translation::get('ad_news_edit'),
    63|     'ad_news_header' => Translation::get('ad_news_header'),
    64|     'ad_news_text' => Translation::get('ad_news_text'),
    65|     'ad_news_allowComments' => Translation::get('ad_news_allowComments'),
    66|     'ad_entry_locale' => Translation::get('ad_entry_locale'),
    67|     'ad_entry_comment' => Translation::get('ad_entry_comment'),
    68|     'ad_entry_commentby' => Translation::get('ad_entry_commentby'),
    69|     'newsCommentDate' => Translation::get('newsCommentDate'),
    70|     'ad_news_insertfail' => Translation::get('ad_news_insertfail'),
    71|     'msgNews' => Translation::get('msgNews'),
    72|     'ad_news_data' => Translation::get('ad_news_data'),
    73|     'ad_news_del' => Translation::get('ad_news_del'),
    74|     'ad_news_nodelete' => Translation::get('ad_news_nodelete'),
    75|     'ad_news_yesdelete' => Translation::get('ad_news_yesdelete'),
    76|     'ad_news_delsuc' => Translation::get('ad_news_delsuc'),
    77|     'ad_news_updatesuc' => Translation::get('ad_news_updatesuc'),
    78|     'msgDeleteNews' => Translation::get('msgDeleteNews'),
    79|     'csrfToken_deleteNews' => Token::getInstance()->getTokenString('delete-news'),
    80|     'csrfToken_updateNews' => Token::getInstance()->getTokenString('update-news'),
    81|     'ad_entry_active' => Translation::get('ad_entry_active'),
    82|     'csrfToken_activateNews' => Token::getInstance()->getTokenString('activate-news')
    83| ];
    84| if ('add-news' == $action && $user->perm->hasPermission($user->getUserId(), PermissionType::NEWS_ADD)) {
    85|     $templateVars = [
    86|         ...$templateVars,
    87|         'userEmail' => $user->getUserData('email'),
    88|         'userName' => $user->getUserData('display_name')
    89|     ];
    90| } elseif ('news' == $action && $user->perm->hasPermission($user->getUserId(), PermissionType::NEWS_EDIT)) {
    91|     $newsHeaders = $news->getHeader();
    92|     $templateVars = [
    93|         ...$templateVars,
    94|         'news' => $newsHeaders,
    95|     ];
    96| } elseif ('edit-news' == $action && $user->perm->hasPermission($user->getUserId(), PermissionType::NEWS_EDIT)) {
    97|     $id = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    98|     $newsData = $news->get($id, true);
    99|     $newsId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
   100|     $oComment = new Comments($faqConfig);
   101|     $comments = $oComment->getCommentsData($newsId, CommentType::NEWS);
   102|     $templateVars = [
   103|         ...$templateVars,
   104|         'newsData' => $newsData,
   105|         'newsDataContent' => (isset($newsData['content']) ? htmlspecialchars(
   106|             (string)$newsData['content'],
   107|             ENT_QUOTES
   108|         ) : ''),
   109|         'comments' => $comments,
   110|         'newsId' => $newsId,
   111|         'commentTypeNews' => CommentType::NEWS
   112|     ];
   113| } else {
   114|     require __DIR__ . '/no-permission.php';
   115|     exit();
   116| }
   117| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   118| $twig->addExtension(new IsoDateTwigExtension());
   119| $twig->addExtension(new FormatDateTwigExtension());
   120| $template = $twig->loadTemplate('@admin/content/news.twig');
   121| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/no-permission.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| <?php
     2| /**
     3|  * The error page if a user has no permission to view the requested resource.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2023-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2023-06-11
    15|  */
    16| use phpMyFAQ\Template\TwigWrapper;
    17| use phpMyFAQ\Translation;
    18| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    19| $template = $twig->loadTemplate('@admin/no-permission.twig');
    20| echo $template->render(
    21|     [
    22|         'adminHeaderNoPermission' => Translation::get('ad_entryins_fail'),
    23|         'msgNoPermission' => Translation::get('err_NotAuth')
    24|     ]
    25| );


# ====================================================================
# FILE: phpmyfaq/admin/open-questions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-76 ---
     1| <?php
     2| /**
     3|  * Delete open questions.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package phpMyFAQ
    10|  * @author Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link https://www.phpmyfaq.de
    14|  * @since 2003-02-24
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Date;
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Question;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\Extensions\CategoryNameTwigExtension;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User\CurrentUser;
    27| use Twig\Extra\Intl\IntlExtension;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $faqConfig = Configuration::getConfigurationInstance();
    33| $user = CurrentUser::getCurrentUser($faqConfig);
    34| if ($user->perm->hasPermission($user->getUserId(), PermissionType::QUESTION_DELETE->value)) {
    35|     $category = new Category($faqConfig, [], false);
    36|     $question = new Question($faqConfig);
    37|     $category->setUser($currentAdminUser);
    38|     $category->setGroups($currentAdminGroups);
    39|     $date = new Date($faqConfig);
    40|     $questionId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    41|     $csrfToken = Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
    42|     if ($csrfToken && Token::getInstance()->verifyToken('toggle-question-visibility', $csrfToken)) {
    43|         $csrfChecked = true;
    44|     } else {
    45|         $csrfChecked = false;
    46|     }
    47|     $toggle = Filter::filterInput(INPUT_GET, 'is_visible', FILTER_SANITIZE_SPECIAL_CHARS);
    48|     if ($csrfChecked && $toggle === 'toggle') {
    49|         $isVisible = $question->getVisibility($questionId);
    50|         $question->setVisibility($questionId, ($isVisible == 'N' ? 'Y' : 'N'));
    51|     }
    52|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    53|     $twig->addExtension(new IntlExtension());
    54|     $twig->addExtension(new CategoryNameTwigExtension());
    55|     $template = $twig->loadTemplate('@admin/content/open-questions.twig');
    56|     $openQuestions = $question->getAll();
    57|     $templateVars = [
    58|         'msgOpenQuestions' => Translation::get('msgOpenQuestions'),
    59|         'csrfTokenDeleteQuestion' => Token::getInstance()->getTokenString('delete-questions'),
    60|         'currentLocale' => $faqConfig->getLanguage()->getLanguage(),
    61|         'msgAuthor' => Translation::get('ad_entry_author'),
    62|         'msgQuestion' => Translation::get('ad_entry_theme'),
    63|         'msgVisibility' => Translation::get('ad_entry_visibility'),
    64|         'questions' => $openQuestions,
    65|         'yes' => Translation::get('ad_gen_yes'),
    66|         'no' => Translation::get('ad_gen_no'),
    67|         'enableCloseQuestion' => $faqConfig->get('records.enableCloseQuestion'),
    68|         'msg2answerFAQ' => Translation::get('msg2answerFAQ'),
    69|         'msgTakeQuestion' => Translation::get('ad_ques_take'),
    70|         'csrfTokenToggleVisibility' => Token::getInstance()->getTokenString('toggle-question-visibility'),
    71|         'msgDeleteAllOpenQuestions' => Translation::get('msgDelete'),
    72|     ];
    73|     echo $template->render($templateVars);
    74| } else {
    75|     require __DIR__ . '/no-permission.php';
    76| }


# ====================================================================
# FILE: phpmyfaq/admin/password.change.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-75 ---
     1| <?php
     2| /**
     3|  * Form to change the password of the current user.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-23
    15|  */
    16| use phpMyFAQ\Auth;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Session\Token;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use phpMyFAQ\Translation;
    23| use phpMyFAQ\User\CurrentUser;
    24| if (!defined('IS_VALID_PHPMYFAQ')) {
    25|     http_response_code(400);
    26|     exit();
    27| }
    28| $faqConfig = Configuration::getConfigurationInstance();
    29| $user = CurrentUser::getCurrentUser($faqConfig);
    30| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    31| $template = $twig->loadTemplate('@admin/user/password.change.twig');
    32| if ($user->perm->hasPermission($user->getUserId(), PermissionType::PASSWORD_CHANGE->value)) {
    33|     $save = Filter::filterInput(INPUT_POST, 'save', FILTER_SANITIZE_SPECIAL_CHARS);
    34|     $csrfToken = Filter::filterInput(INPUT_POST, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
    35|     $successMessage = $errorMessage = '';
    36|     if (!is_null($save) && Token::getInstance()->verifyToken('password', $csrfToken)) {
    37|         $auth = new Auth($faqConfig);
    38|         $authSource = $auth->selectAuth($user->getAuthSource('name'));
    39|         $authSource->getEncryptionContainer($user->getAuthData('encType'));
    40|         $authSource->setReadOnly($user->getAuthData('readOnly'));
    41|         $oldPassword = Filter::filterInput(INPUT_POST, 'faqpassword_old', FILTER_SANITIZE_SPECIAL_CHARS);
    42|         $newPassword = Filter::filterInput(INPUT_POST, 'faqpassword', FILTER_SANITIZE_SPECIAL_CHARS);
    43|         $retypedPassword = Filter::filterInput(INPUT_POST, 'faqpassword_confirm', FILTER_SANITIZE_SPECIAL_CHARS);
    44|         if (strlen((string) $newPassword) <= 7 || strlen((string) $retypedPassword) <= 7) {
    45|             $errorMessage = Translation::get('ad_passwd_fail');
    46|         } else {
    47|             if (
    48|                 ($authSource->checkCredentials(
    49|                     $user->getLogin(),
    50|                     $oldPassword
    51|                 )) && ($newPassword == $retypedPassword)
    52|             ) {
    53|                 if (!$user->changePassword($newPassword)) {
    54|                     $errorMessage = Translation::get('ad_passwd_fail');
    55|                 }
    56|                 $successMessage = Translation::get('ad_passwdsuc');
    57|             } else {
    58|                 $errorMessage = Translation::get('ad_passwd_fail');
    59|             }
    60|         }
    61|     }
    62|     $templateVars = [
    63|         'adminHeaderPasswordChange' => Translation::get('ad_passwd_cop'),
    64|         'successMessage' => $successMessage,
    65|         'errorMessage' => $errorMessage,
    66|         'csrfToken' => Token::getInstance()->getTokenString('password'),
    67|         'adminMsgOldPassword' => Translation::get('ad_passwd_old'),
    68|         'adminMsgNewPassword' => Translation::get('ad_passwd_new'),
    69|         'adminMsgNewPasswordConfirm' => Translation::get('ad_passwd_con'),
    70|         'adminMsgButtonNewPassword' => Translation::get('ad_passwd_change')
    71|     ];
    72|     echo $template->render($templateVars);
    73| } else {
    74|     require __DIR__ . '/no-permission.php';
    75| }


# ====================================================================
# FILE: phpmyfaq/admin/report.main.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| <?php
     2| /**
     3|  * The reporting page.
     4|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     5|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     6|  * obtain one at https://mozilla.org/MPL/2.0/.
     7|  *
     8|  * @package   phpMyFAQ
     9|  * @author    Gustavo Solt <gustavo.solt@mayflower.de>
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2011-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2011-01-12
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Session\Token;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use phpMyFAQ\User\CurrentUser;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = Configuration::getConfigurationInstance();
    27| $user = CurrentUser::getCurrentUser($faqConfig);
    28| if ($user->perm->hasPermission($user->getUserId(), PermissionType::REPORTS->value)) {
    29|     $templateVars = [
    30|         'ad_menu_reports' => Translation::get('ad_menu_reports'),
    31|         'csrfTokenInput' => Token::getInstance()->getTokenInput('create-report'),
    32|         'ad_stat_report_make_report' => Translation::get('ad_stat_report_make_report'),
    33|         'ad_stat_report_fields' => Translation::get('ad_stat_report_fields'),
    34|         'ad_stat_report_category' => Translation::get('ad_stat_report_category'),
    35|         'ad_stat_report_sub_category' => Translation::get('ad_stat_report_sub_category'),
    36|         'ad_stat_report_translations' => Translation::get('ad_stat_report_translations'),
    37|         'ad_stat_report_language' => Translation::get('ad_stat_report_language'),
    38|         'ad_stat_report_id' => Translation::get('ad_stat_report_id'),
    39|         'ad_stat_report_sticky' => Translation::get('ad_stat_report_sticky'),
    40|         'ad_stat_report_title' => Translation::get('ad_stat_report_title'),
    41|         'ad_stat_report_creation_date' => Translation::get('ad_stat_report_creation_date'),
    42|         'ad_stat_report_owner' => Translation::get('ad_stat_report_owner'),
    43|         'ad_stat_report_last_modified_person' => Translation::get('ad_stat_report_last_modified_person'),
    44|         'ad_stat_report_url' => Translation::get('ad_stat_report_url'),
    45|         'ad_stat_report_visits' => Translation::get('ad_stat_report_visits')
    46|     ];
    47|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    48|     $template = $twig->loadTemplate('@admin/statistics/report.main.twig');
    49|     echo $template->render($templateVars);
    50| } else {
    51|     require __DIR__ . '/no-permission.php';
    52| }


# ====================================================================
# FILE: phpmyfaq/admin/session.keepalive.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-61 ---
     1| <?php
     2| /**
     3|  * A dummy page used within an IFRAME for warning the user about his next
     4|  * session expiration and to give him the contextual possibility for
     5|  * refreshing the session by clicking <OK>.
     6|  *
     7|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     8|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     9|  * obtain one at https://mozilla.org/MPL/2.0/.
    10|  *
    11|  * @package   phpMyFAQ
    12|  * @author    Matteo Scaramuccia <matteo@phpmyfaq.de>
    13|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    14|  * @author    Uwe Pries <uwe.pries@digartis.de>
    15|  * @copyright 2006-2024 phpMyFAQ Team
    16|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    17|  * @link      https://www.phpmyfaq.de
    18|  * @since     2006-05-08
    19|  */
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Filter;
    22| use phpMyFAQ\Language;
    23| use phpMyFAQ\Session\Token;
    24| use phpMyFAQ\Strings;
    25| use phpMyFAQ\System;
    26| use phpMyFAQ\Template\TwigWrapper;
    27| use phpMyFAQ\Translation;
    28| use phpMyFAQ\User\CurrentUser;
    29| define('PMF_ROOT_DIR', dirname(__DIR__));
    30| const IS_VALID_PHPMYFAQ = null;
    31| require PMF_ROOT_DIR . '/src/Bootstrap.php';
    32| require PMF_ROOT_DIR . '/translations/language_en.php';
    33| $faqConfig = Configuration::getConfigurationInstance();
    34| $language = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);
    35| if (!is_null($language) && Language::isASupportedLanguage($language)) {
    36|     require PMF_ROOT_DIR . '/translations/language_' . $language . '.php';
    37| }
    38| try {
    39|     Translation::create()
    40|         ->setLanguagesDir(PMF_TRANSLATION_DIR)
    41|         ->setDefaultLanguage('en')
    42|         ->setCurrentLanguage($language);
    43| } catch (Exception $e) {
    44|     echo '<strong>Error:</strong> ' . $e->getMessage();
    45| }
    46| Strings::init($language);
    47| $user = CurrentUser::getCurrentUser($faqConfig);
    48| $refreshTime = (PMF_AUTH_TIMEOUT - PMF_AUTH_TIMEOUT_WARNING) * 60;
    49| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    50| $template = $twig->loadTemplate('@admin/session-keepalive.twig');
    51| $templateVars = [
    52|     'metaLanguage' => Translation::get('metaLanguage'),
    53|     'phpMyFAQVersion' => System::getVersion(),
    54|     'currentYear' => date('Y'),
    55|     'isUserLoggedIn' => $user->isLoggedIn() && ($refreshTime > 0),
    56|     'csrfToken' => Token::getInstance()->getTokenString('admin-logout'),
    57|     'msgConfirm' => sprintf(Translation::get('ad_session_expiring'), PMF_AUTH_TIMEOUT_WARNING),
    58|     'sessionTimeout' => PMF_AUTH_TIMEOUT,
    59|     'refreshTime' => $refreshTime,
    60| ];
    61| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/statistics.admin-log.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-75 ---
     1| <?php
     2| /**
     3|  * Overview of actions in the admin section.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-23
    15|  */
    16| use phpMyFAQ\Administration\AdminLog;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Date;
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Pagination;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\Extensions\UserNameTwigExtension;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User\CurrentUser;
    27| use Twig\Extra\Intl\IntlExtension;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $faqConfig = Configuration::getConfigurationInstance();
    33| $user = CurrentUser::getCurrentUser($faqConfig);
    34| if ($user->perm->hasPermission($user->getUserId(), PermissionType::STATISTICS_ADMINLOG->value)) {
    35|     $logging = new AdminLog($faqConfig);
    36|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    37|     $twig->addExtension(new IntlExtension());
    38|     $twig->addExtension(new UserNameTwigExtension());
    39|     $template = $twig->loadTemplate('@admin/statistics/admin-log.twig');
    40|     $date = new Date($faqConfig);
    41|     $itemsPerPage = 15;
    42|     $pages = Filter::filterInput(INPUT_GET, 'pages', FILTER_VALIDATE_INT);
    43|     $page = Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT, 1);
    44|     if (is_null($pages)) {
    45|         $pages = round(($logging->getNumberOfEntries() + ($itemsPerPage / 3)) / $itemsPerPage, 0);
    46|     }
    47|     $baseUrl = sprintf('%sadmin/?action=adminlog&amp;page=%d', $faqConfig->getDefaultUrl(), $page);
    48|     $options = [
    49|         'baseUrl' => $baseUrl,
    50|         'total' => $logging->getNumberOfEntries(),
    51|         'perPage' => $itemsPerPage,
    52|         'pageParamName' => 'page',
    53|     ];
    54|     $pagination = new Pagination($options);
    55|     $loggingData = $logging->getAll();
    56|     $totalItems = count($loggingData);
    57|     $totalPages = ceil($totalItems / $itemsPerPage);
    58|     $offset = ($page - 1) * $itemsPerPage;
    59|     $currentItems = array_slice($loggingData, $offset, $itemsPerPage);
    60|     $templateVars = [
    61|         'headerAdminLog' => Translation::get('ad_menu_adminlog'),
    62|         'buttonDeleteAdminLog' => Translation::get('ad_adminlog_del_older_30d'),
    63|         'csrfDeleteAdminLogToken' => Token::getInstance()->getTokenString('delete-adminlog'),
    64|         'currentLocale' => $faqConfig->getLanguage()->getLanguage(),
    65|         'pagination' => $pagination->render(),
    66|         'msgId' => Translation::get('ad_categ_id'),
    67|         'msgDate' => Translation::get('ad_adminlog_date'),
    68|         'msgUser' => Translation::get('ad_adminlog_user'),
    69|         'msgIp' => Translation::get('ad_adminlog_ip'),
    70|         'loggingData' => $currentItems,
    71|     ];
    72|     echo $template->render($templateVars);
    73| } else {
    74|     require __DIR__ . '/no-permission.php';
    75| }


# ====================================================================
# FILE: phpmyfaq/admin/statistics.ratings.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-78 ---
     1| <?php
     2| /**
     3|  * The page with the ratings.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Administration\RatingData;
    17| use phpMyFAQ\Category;
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Rating;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\TwigWrapper;
    24| use phpMyFAQ\Translation;
    25| use phpMyFAQ\User\CurrentUser;
    26| if (!defined('IS_VALID_PHPMYFAQ')) {
    27|     http_response_code(400);
    28|     exit();
    29| }
    30| $faqConfig = Configuration::getConfigurationInstance();
    31| $user = CurrentUser::getCurrentUser($faqConfig);
    32| [ $currentAdminUser, $currentAdminGroups ] = CurrentUser::getCurrentUserGroupId($user);
    33| if ($user->perm->hasPermission($user->getUserId(), PermissionType::STATISTICS_VIEWLOGS->value)) {
    34|     $csrfToken = Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_SPECIAL_CHARS);
    35|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    36|     $template = $twig->loadTemplate('@admin/statistics/ratings.twig');
    37|     $category = new Category($faqConfig, [], false);
    38|     $category->setUser($currentAdminUser);
    39|     $category->setGroups($currentAdminGroups);
    40|     $ratingData = new RatingData($faqConfig);
    41|     $ratings = new Rating($faqConfig);
    42|     if ($csrfToken && !Token::getInstance()->verifyToken('clear-statistics', $csrfToken)) {
    43|         $clearStatistics = false;
    44|     } else {
    45|         $clearStatistics = true;
    46|     }
    47|     if ('clear-statistics' === $action && $clearStatistics) {
    48|         if ($ratings->deleteAll()) {
    49|             $deletedStatistics = true;
    50|         } else {
    51|             $deletedStatistics = false;
    52|         }
    53|     }
    54|     $data = $ratingData->getAll();
    55|     $numberOfRatings = is_countable($data) ? count($data) : 0;
    56|     $currentCategory = 0;
    57|     $templateVars = [
    58|         'adminHeaderRatings' => Translation::get('ad_rs'),
    59|         'csrfToken' => Token::getInstance()->getTokenString('clear-statistics'),
    60|         'buttonDeleteAllVotings' => Translation::get('ad_delete_all_votings'),
    61|         'isDeleteAllVotings' => 'clear-statistics' === $action && $clearStatistics,
    62|         'isDeletedStatistics' => $deletedStatistics ?? false,
    63|         'msgDeleteAllVotings' => Translation::get('msgDeleteAllVotings'),
    64|         'msgDeleteAllVotingsError' => Translation::get('msgDeleteAllVotingsError'),
    65|         'currentCategory' => $currentCategory,
    66|         'ratingData' => $data,
    67|         'numberOfRatings' => $numberOfRatings,
    68|         'categoryNames' => $category->categoryName,
    69|         'green' => Translation::get('ad_rs_green'),
    70|         'greenNote' => Translation::get('ad_rs_ahtf'),
    71|         'red' => Translation::get('ad_rs_red'),
    72|         'redNote' => Translation::get('ad_rs_altt'),
    73|         'msgNoRatings' => Translation::get('ad_rs_no')
    74|     ];
    75|     echo $template->render($templateVars);
    76| } else {
    77|     require __DIR__ . '/no-permission.php';
    78| }


# ====================================================================
# FILE: phpmyfaq/admin/statistics.search.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| /**
     3|  * Frontend for search log statistics.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Anatoliy Belsky <anatoliy.belsky@mayflower.de>
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @copyright 2003-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2003-03-30
    16|  */
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Pagination;
    21| use phpMyFAQ\Search;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\Extensions\LanguageCodeTwigExtension;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User\CurrentUser;
    27| use Symfony\Component\HttpFoundation\Request;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $faqConfig = Configuration::getConfigurationInstance();
    33| $user = CurrentUser::getCurrentUser($faqConfig);
    34| $request = Request::createFromGlobals();
    35| if ($user->perm->hasPermission($user->getUserId(), PermissionType::STATISTICS_VIEWLOGS->value)) {
    36|     $perPage = 10;
    37|     $pages = Filter::filterVar($request->query->get('pages'), FILTER_VALIDATE_INT);
    38|     $page = Filter::filterVar($request->query->get('page'), FILTER_VALIDATE_INT, 1);
    39|     $search = new Search($faqConfig);
    40|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    41|     $twig->addExtension(new LanguageCodeTwigExtension());
    42|     $template = $twig->loadTemplate('@admin/statistics/search.twig');
    43|     $searchesCount = $search->getSearchesCount();
    44|     $searchesList = $search->getMostPopularSearches($searchesCount + 1, true);
    45|     if (is_null($pages)) {
    46|         $pages = round(((is_countable($searchesList) ? count($searchesList) : 0) + ($perPage / 3)) / $perPage, 0);
    47|     }
    48|     $start = ($page - 1) * $perPage;
    49|     $end = $start + $perPage;
    50|     $baseUrl = sprintf(
    51|         '%sadmin/?action=searchstats&amp;page=%d',
    52|         $faqConfig->getDefaultUrl(),
    53|         $page
    54|     );
    55|     $options = [
    56|         'baseUrl' => $request->getUri(),
    57|         'total' => is_countable($searchesList) ? count($searchesList) : 0,
    58|         'perPage' => $perPage,
    59|         'pageParamName' => 'page',
    60|     ];
    61|     $pagination = new Pagination($options);
    62|     $templateVars = [
    63|         'ad_menu_searchstats' => Translation::get('ad_menu_searchstats'),
    64|         'csrfToken' => Token::getInstance()->getTokenString('truncate-search-terms'),
    65|         'ad_searchterm_del' => Translation::get('ad_searchterm_del'),
    66|         'ad_searchstats_search_term' => Translation::get('ad_searchstats_search_term'),
    67|         'ad_searchstats_search_term_count' => Translation::get('ad_searchstats_search_term_count'),
    68|         'ad_searchstats_search_term_lang' => Translation::get('ad_searchstats_search_term_lang'),
    69|         'ad_searchstats_search_term_percentage' => Translation::get('ad_searchstats_search_term_percentage'),
    70|         'pagination' => $pagination->render(),
    71|         'searchesCount' => $searchesCount,
    72|         'searchesList' => $searchesList,
    73|         'csrfTokenDelete' => Token::getInstance()->getTokenString('delete-searchterm'),
    74|         'ad_news_delete' => Translation::get('ad_news_delete'),
    75|     ];
    76|     echo $template->render($templateVars);
    77| } else {
    78|     require __DIR__ . '/no-permission.php';
    79| }


# ====================================================================
# FILE: phpmyfaq/admin/statistics.sessions.day.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| <?php
     2| /**
     3|  * Sessions per day.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Date;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Session;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use phpMyFAQ\Translation;
    23| use phpMyFAQ\User\CurrentUser;
    24| use Symfony\Component\HttpFoundation\Request;
    25| use Twig\Extension\CoreExtension;
    26| if (!defined('IS_VALID_PHPMYFAQ')) {
    27|     http_response_code(400);
    28|     exit();
    29| }
    30| $faqConfig = Configuration::getConfigurationInstance();
    31| $user = CurrentUser::getCurrentUser($faqConfig);
    32| $request = Request::createFromGlobals();
    33| if ($user->perm->hasPermission($user->getUserId(), PermissionType::STATISTICS_VIEWLOGS->value)) {
    34|     $perPage = 50;
    35|     $day = Filter::filterVar($request->request->get('day'), FILTER_VALIDATE_INT);
    36|     $firstHour = strtotime('midnight', $day);
    37|     $lastHour = strtotime('tomorrow', $firstHour) - 1;
    38|     $session = new Session($faqConfig);
    39|     $sessionData = $session->getSessionsByDate($firstHour, $lastHour);
    40|     $date = new Date($faqConfig);
    41|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    42|     $twig->getExtension(CoreExtension::class)->setDateFormat('Y-m-d H:i', '%d days');
    43|     $template = $twig->loadTemplate('@admin/statistics/sessions.day.twig');
    44|     $templateVars = [
    45|         'adminHeaderSessionsPerDay' => Translation::get('ad_sess_session'),
    46|         'currentDay' => date('Y-m-d', $day),
    47|         'msgIpAddress' => Translation::get('ad_sess_ip'),
    48|         'msgSessionDate' => Translation::get('ad_sess_s_date'),
    49|         'msgSession' => Translation::get('ad_sess_session'),
    50|         'sessionData' => $sessionData,
    51|     ];
    52|     echo $template->render($templateVars);
    53| } else {
    54|     require __DIR__ . '/no-permission.php';
    55| }


# ====================================================================
# FILE: phpmyfaq/admin/statistics.sessions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-99 ---
     1| <?php
     2| /**
     3|  * The main statistics page.
     4|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     5|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     6|  * obtain one at https://mozilla.org/MPL/2.0/.
     7|  *
     8|  * @package   phpMyFAQ
     9|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    10|  * @author    Matteo Scaramuccia <matteo@scaramuccia.com>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Date;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Helper\StatisticsHelper;
    21| use phpMyFAQ\Session;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\TwigWrapper;
    24| use phpMyFAQ\Translation;
    25| use phpMyFAQ\User\CurrentUser;
    26| use phpMyFAQ\Visits;
    27| use Symfony\Component\HttpFoundation\Request;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $faqConfig = Configuration::getConfigurationInstance();
    33| $user = CurrentUser::getCurrentUser($faqConfig);
    34| $request = Request::createFromGlobals();
    35| if ($user->perm->hasPermission($user->getUserId(), PermissionType::STATISTICS_VIEWLOGS->value)) {
    36|     $session = new Session($faqConfig);
    37|     $date = new Date($faqConfig);
    38|     $visits = new Visits($faqConfig);
    39|     $statisticsHelper = new StatisticsHelper($session, $visits, $date);
    40|     $stats = $statisticsHelper->getTrackingFilesStatistics();
    41|     $visitsPerDay = $session->getNumberOfSessions();
    42|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    43|     $template = $twig->loadTemplate('@admin/statistics/sessions.twig');
    44|     $statdelete = Filter::filterVar($request->request->get('statdelete'), FILTER_SANITIZE_SPECIAL_CHARS);
    45|     $month = Filter::filterVar($request->request->get('month'), FILTER_SANITIZE_SPECIAL_CHARS);
    46|     $csrfTokenFromPost = Filter::filterVar($request->request->get('csrf'), FILTER_SANITIZE_SPECIAL_CHARS);
    47|     $csrfTokenFromGet = Filter::filterVar($request->query->get('csrf'), FILTER_SANITIZE_SPECIAL_CHARS);
    48|     if ($csrfTokenFromPost && !Token::getInstance()->verifyToken('sessions', $csrfTokenFromPost)) {
    49|         $statdelete = null;
    50|     }
    51|     if ($csrfTokenFromGet && !Token::getInstance()->verifyToken('clear-visits', $csrfTokenFromGet)) {
    52|         $clearVisits = false;
    53|     } else {
    54|         $clearVisits = true;
    55|     }
    56|     if ($statdelete == 'delete' && $month !== '') {
    57|         $hasMessage = $statisticsHelper->deleteTrackingFiles($month);
    58|         $message = Translation::get('ad_adminlog_delete_success');
    59|     }
    60|     if ('clear-visits' === $action && $clearVisits) {
    61|         $hasMessage = $statisticsHelper->clearAllVisits();
    62|         $message = Translation::get('ad_reset_visits_success');
    63|     }
    64|     $templateVars = [
    65|         'adminHeaderSessions' => Translation::get('ad_stat_sess'),
    66|         'csrfTokenClearVisits' => Token::getInstance()->getTokenString('clear-visits'),
    67|         'msgClearVisits' => Translation::get('ad_clear_all_visits'),
    68|         'hasMessage' => $hasMessage ?? false,
    69|         'message' => $message ?? '',
    70|         'msgDays' => Translation::get('ad_stat_days'),
    71|         'numberOfDays' => $stats->numberOfDays,
    72|         'msgVisits' => Translation::get('ad_stat_vis'),
    73|         'numberOfVisits' => $visitsPerDay,
    74|         'msgVisitsPerDay' => Translation::get('ad_stat_vpd'),
    75|         'visitsPerDay' => ($stats->numberOfDays != 0) ? round(($visitsPerDay / $stats->numberOfDays), 2) : 0,
    76|         'msgFirstDate' =>  Translation::get('ad_stat_fien'),
    77|         'firstDate' =>  $statisticsHelper->getFirstTrackingDate($stats->firstDate),
    78|         'msgLastDate' => Translation::get('ad_stat_laen'),
    79|         'lastDate' => $statisticsHelper->getLastTrackingDate($stats->lastDate),
    80|         'msgSessionBrowse' => Translation::get('ad_stat_browse'),
    81|         'renderedDaySelector' => $statisticsHelper->renderDaySelector(),
    82|         'buttonOkay' => Translation::get('ad_stat_ok'),
    83|         'msgSessionManagement' => Translation::get('ad_stat_management'),
    84|         'csrfTokenSessions' => Token::getInstance()->getTokenInput('sessions'),
    85|         'msgChooseMonth' => Translation::get('ad_stat_choose'),
    86|         'renderedMonthSelector' => $statisticsHelper->renderMonthSelector(),
    87|         'buttonDeleteMonth' => Translation::get('ad_stat_delete'),
    88|         'msgExportSessions' => Translation::get('msgExportSessions'),
    89|         'msgExportSessionsAsCSV' => Translation::get('msgExportSessionsAsCSV'),
    90|         'csrfTokenExport' => Token::getInstance()->getTokenString('export-sessions'),
    91|         'dateToday' => date('Y-m-d'),
    92|         'msgExportSessionsFrom' => Translation::get('msgExportSessionsFrom'),
    93|         'msgExportSessionsTo' => Translation::get('msgExportSessionsTo'),
    94|         'datePickerMinDate' => date('Y-m-d', $stats->firstDate),
    95|     ];
    96|     echo $template->render($templateVars);
    97| } else {
    98|     require __DIR__ . '/no-permission.php';
    99| }


# ====================================================================
# FILE: phpmyfaq/admin/statistics.show.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| <?php
     2| /**
     3|  * Show the session.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Filter;
    19| use phpMyFAQ\Session;
    20| use phpMyFAQ\Template\TwigWrapper;
    21| use phpMyFAQ\Translation;
    22| use phpMyFAQ\User\CurrentUser;
    23| if (!defined('IS_VALID_PHPMYFAQ')) {
    24|     http_response_code(400);
    25|     exit();
    26| }
    27| $faqConfig = Configuration::getConfigurationInstance();
    28| $user = CurrentUser::getCurrentUser($faqConfig);
    29| $sessionId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    30| if ($user->perm->hasPermission($user->getUserId(), PermissionType::STATISTICS_VIEWLOGS->value)) {
    31|     $session = new Session($faqConfig);
    32|     $time = $session->getTimeFromSessionId($sessionId);
    33|     $trackingData = explode("\n", file_get_contents(PMF_CONTENT_DIR . '/core/data/tracking' . date('dmY', $time)));
    34|     $templateVars = [
    35|         'ad_sess_session' => Translation::get('ad_sess_session'),
    36|         'sessionId' => $sessionId,
    37|         'ad_sess_back' => Translation::get('ad_sess_back'),
    38|         'ad_sess_referer' => Translation::get('ad_sess_referer'),
    39|         'ad_sess_browser' => Translation::get('ad_sess_browser'),
    40|         'ad_sess_ip' => Translation::get('ad_sess_ip'),
    41|         'trackingData' => $trackingData
    42|     ];
    43|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    44|     $template = $twig->loadTemplate('@admin/statistics/statistics.show.twig');
    45|     echo $template->render($templateVars);
    46| } else {
    47|     require __DIR__ . '/no-permission.php';
    48| }


# ====================================================================
# FILE: phpmyfaq/admin/stickyfaqs.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| /**
     3|  * Shows the function for ordering sticky faqs customly.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Jan Harms <model_railroader@gmx-topmail.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2023-12-27
    15|  */
    16| use phpMyFAQ\Faq;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Template\TwigWrapper;
    19| use phpMyFAQ\Translation;
    20| use phpMyFAQ\Session\Token;
    21| if (!defined('IS_VALID_PHPMYFAQ')) {
    22|     http_response_code(400);
    23|     exit();
    24| }
    25| $faqConfig = Configuration::getConfigurationInstance();
    26| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    27| $template = $twig->loadTemplate('@admin/content/stickyfaqs.twig');
    28| $faq = new Faq($faqConfig);
    29| $stickyData = $faq->getStickyFaqsData();
    30| $templateVars = [
    31|     'stickyFAQsHeader' => Translation::get('stickyRecordsHeader'),
    32|     'stickyData' => $stickyData,
    33|     'sortableDisabled' => ($faqConfig->get('records.orderStickyFaqsCustom') === false) ? 'sortable-disabled' : '',
    34|     'orderingStickyFaqsActivated' => $faqConfig->get('records.orderStickyFaqsCustom'),
    35|     'alertMessageStickyFaqsDeactivated' => Translation::get('msgOrderStickyFaqsCustomDeactivated'),
    36|     'alertMessageNoStickyRecords' => Translation::get('msgNoStickyFaqs'),
    37|     'csrfToken' => Token::getInstance()->getTokenString('order-stickyfaqs')
    38| ];
    39| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/stopwords.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-50 ---
     1| <?php
     2| /**
     3|  * The main stop words configuration frontend.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Anatoliy Belsky <ab@php.net>
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @copyright 2009-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2009-04-01
    16|  */
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Language\LanguageCodes;
    20| use phpMyFAQ\Session\Token;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use phpMyFAQ\Translation;
    23| use phpMyFAQ\User\CurrentUser;
    24| if (!defined('IS_VALID_PHPMYFAQ')) {
    25|     http_response_code(400);
    26|     exit();
    27| }
    28| $faqConfig = Configuration::getConfigurationInstance();
    29| $user = CurrentUser::getCurrentUser($faqConfig);
    30| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    31| $template = $twig->loadTemplate('@admin/configuration/stopwords.twig');
    32| $sortedLanguageCodes = [];
    33| if ($user->perm->hasPermission($user->getUserId(), PermissionType::CONFIGURATION_EDIT->value)) {
    34|     $sortedLanguageCodes = LanguageCodes::getAll();
    35|     asort($sortedLanguageCodes);
    36|     reset($sortedLanguageCodes);
    37| }
    38| $templateVars = [
    39|     'adminHeaderStopWords' => Translation::get('ad_menu_stopwordsconfig'),
    40|     'hasPermission' => $user->perm->hasPermission($user->getUserId(), PermissionType::CONFIGURATION_EDIT),
    41|     'msgDescription' => Translation::get('ad_stopwords_desc'),
    42|     'csrfToken' => Token::getInstance()->getTokenInput('stopwords'),
    43|     'msgStopWordsLabel' => Translation::get('ad_stopwords_desc'),
    44|     'sortedLanguageCodes' => $sortedLanguageCodes,
    45|     'buttonAdd' => Translation::get('ad_config_stopword_input'),
    46| ];
    47| echo $template->render($templateVars);
    48| if (!$user->perm->hasPermission($user->getUserId(), PermissionType::CONFIGURATION_EDIT->value)) {
    49|     require __DIR__ . '/no-permission.php';
    50| }


# ====================================================================
# FILE: phpmyfaq/admin/system.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| <?php
     2| /**
     3|  * phpMyFAQ System Information page.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Matteo Scaramuccia <matteo@phpmyfaq.de>
    12|  * @copyright 2013-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2013-01-02
    16|  */
    17| use Elastic\Elasticsearch\Exception\ClientResponseException;
    18| use Elastic\Elasticsearch\Exception\ServerResponseException;
    19| use Elastic\Transport\Exception\NoNodeAvailableException;
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Database;
    22| use phpMyFAQ\Enums\PermissionType;
    23| use phpMyFAQ\System;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User\CurrentUser;
    27| use Symfony\Component\HttpFoundation\Request;
    28| if (!defined('IS_VALID_PHPMYFAQ')) {
    29|     http_response_code(400);
    30|     exit();
    31| }
    32| $request = Request::createFromGlobals();
    33| $faqConfig = Configuration::getConfigurationInstance();
    34| $user = CurrentUser::getCurrentUser($faqConfig);
    35| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    36| $template = $twig->loadTemplate('@admin/configuration/system.twig');
    37| if ($user->perm->hasPermission($user->getUserId(), PermissionType::CONFIGURATION_EDIT->value)) {
    38|     $faqSystem = new System();
    39|     if ($faqConfig->get('search.enableElasticsearch')) {
    40|         try {
    41|             $esFullInformation = $faqConfig->getElasticsearch()->info();
    42|             $esInformation = $esFullInformation['version']['number'];
    43|         } catch (ClientResponseException | ServerResponseException | NoNodeAvailableException $e) {
    44|             $faqConfig->getLogger()->error('Error while fetching Elasticsearch information', [$e->getMessage()]);
    45|             $esInformation = 'n/a';
    46|         }
    47|     } else {
    48|         $esInformation = 'n/a';
    49|     }
    50|     $templateVars = [
    51|         'adminHeaderSystemInfo' => Translation::get('ad_system_info'),
    52|         'systemInformation' => [
    53|             'phpMyFAQ Version' => $faqSystem->getVersion(),
    54|             'phpMyFAQ API Version' => $faqSystem->getApiVersion(),
    55|             'phpMyFAQ Plugin API Version' => $faqSystem->getPluginVersion(),
    56|             'phpMyFAQ Installation Path' => dirname((string) $request->server->get('SCRIPT_FILENAME'), 2),
    57|             'Web server software' => $request->server->get('SERVER_SOFTWARE'),
    58|             'Web server document root' => $request->server->get('DOCUMENT_ROOT'),
    59|             'Web server Interface' => strtoupper(PHP_SAPI),
    60|             'PHP Version' => PHP_VERSION,
    61|             'PHP Extensions' => implode(', ', get_loaded_extensions()),
    62|             'PHP Session path' => session_save_path(),
    63|             'Database Server' => Database::getType(),
    64|             'Database Server Version' => $faqConfig->getDb()->serverVersion(),
    65|             'Database Client Version' => $faqConfig->getDb()->clientVersion(),
    66|             'Elasticsearch Version' => $esInformation
    67|         ]
    68|     ];
    69|     echo $template->render($templateVars);
    70| } else {
    71|     require __DIR__ . '/no-permission.php';
    72| }


# ====================================================================
# FILE: phpmyfaq/admin/tags.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| <?php
     2| /**
     3|  * Administration frontend for Tags.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-24
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Filter;
    19| use phpMyFAQ\Session\Token;
    20| use phpMyFAQ\Tags;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use phpMyFAQ\Translation;
    23| use phpMyFAQ\User\CurrentUser;
    24| if (!defined('IS_VALID_PHPMYFAQ')) {
    25|     http_response_code(400);
    26|     exit();
    27| }
    28| $faqConfig = Configuration::getConfigurationInstance();
    29| $user = CurrentUser::getCurrentUser($faqConfig);
    30| $tagId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    31| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    32| $template = $twig->loadTemplate('@admin/content/tags.twig');
    33| $tags = new Tags($faqConfig);
    34| if ('delete-tag' === $action) {
    35|     $tagId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    36|     if ($tags->delete($tagId)) {
    37|         $deleteSuccess = true;
    38|     } else {
    39|         $deleteSuccess = false;
    40|     }
    41| }
    42| $tagData = $tags->getAllTags();
    43| $templateVars = [
    44|     'adminHeaderTags' => Translation::get('ad_entry_tags'),
    45|     'csrfToken' => Token::getInstance()->getTokenInput('tags'),
    46|     'isDelete' => 'delete-tag' === $action,
    47|     'isDeleteSuccess' => $deleteSuccess ?? false,
    48|     'msgDeleteSuccess' => Translation::get('ad_tag_delete_success'),
    49|     'msgDeleteError' => Translation::get('ad_tag_delete_error'),
    50|     'tags' => $tagData,
    51|     'noTags' => Translation::get('ad_news_nodata'),
    52|     'buttonEdit' => Translation::get('ad_user_edit'),
    53|     'msgConfirm' => Translation::get('ad_user_del_3'),
    54|     'buttonDelete' => Translation::get('msgDelete'),
    55| ];
    56| echo $template->render($templateVars);
    57| if (!$user->perm->hasPermission($user->getUserId(), PermissionType::FAQ_EDIT->value)) {
    58|     require __DIR__ . '/no-permission.php';
    59| }


# ====================================================================
# FILE: phpmyfaq/admin/twofactor.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| /**
     3|  * The 2fa-form for entering the token for two-factor-authentication.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Jan Harms <model_railroader@gmx-topmail.de>
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @copyright 2023-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2023-03-11
    16|  */
    17| use phpMyFAQ\Translation;
    18| use phpMyFAQ\Template\TwigWrapper;
    19| use phpMyFAQ\Configuration;
    20| use Symfony\Component\HttpFoundation\Request;
    21| $request = Request::createFromGlobals();
    22| $faqConfig = Configuration::getConfigurationInstance();
    23| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    24| $template = $twig->loadTemplate('@admin/user/twofactor.twig');
    25| $templateVars = [
    26|     'msgTwofactorEnabled' => Translation::get('msgTwofactorEnabled'),
    27|     'msgTwofactorCheck' => Translation::get('msgTwofactorCheck'),
    28|     'msgEnterTwofactorToken' => Translation::get('msgEnterTwofactorToken'),
    29|     'requestIsSecure' => $request->isSecure(),
    30|     'security.useSslForLogins' => $faqConfig->get('security.useSslForLogins'),
    31|     'actionIsLogout' => $request->query->get('action') === 'logout',
    32|     'ad_logout' => Translation::get('ad_logout'),
    33|     'error' => $error,
    34|     'requestHost' => $request->getHost(),
    35|     'requestUri' => $request->getRequestUri(),
    36|     'msgSecureSwitch' => Translation::get('msgSecureSwitch'),
    37|     'systemUri' => $faqConfig->getDefaultUrl()
    38| ];
    39| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/admin/upgrade.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-58 ---
     1| <?php
     2| /**
     3|  * The upgrade administration view
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2023-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2023-07-01
    15|  */
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Enums\PermissionType;
    18| use phpMyFAQ\Enums\ReleaseType;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use phpMyFAQ\User\CurrentUser;
    22| use Symfony\Component\HttpFoundation\Request;
    23| if (!defined('IS_VALID_PHPMYFAQ')) {
    24|     http_response_code(400);
    25|     exit();
    26| }
    27| $request = Request::createFromGlobals();
    28| $faqConfig = Configuration::getConfigurationInstance();
    29| $user = CurrentUser::getCurrentUser($faqConfig);
    30| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    31| $template = $twig->loadTemplate('@admin/configuration/upgrade.twig');
    32| if (
    33|     $faqConfig->get('upgrade.onlineUpdateEnabled') &&
    34|     $user->perm->hasPermission($user->getUserId(), PermissionType::CONFIGURATION_EDIT->value)
    35| ) {
    36|     $templateVars = [
    37|         'adminHeaderUpgrade' => Translation::get('ad_menu_upgrade'),
    38|         'headerCheckHealth' => Translation::get('headerCheckHealth'),
    39|         'msgHealthCheck' => Translation::get('msgHealthCheck'),
    40|         'buttonCheckHealth' => Translation::get('buttonCheckHealth'),
    41|         'headerCheckUpdates' => Translation::get('headerCheckUpdates'),
    42|         'msgUpdateCheck' => Translation::get('msgUpdateCheck'),
    43|         'buttonCheckUpdates' => Translation::get('buttonCheckUpdates'),
    44|         'headerExtractPackage' => Translation::get('headerExtractPackage'),
    45|         'msgExtractPackage' => Translation::get('msgExtractPackage'),
    46|         'buttonExtractPackage' => Translation::get('buttonExtractPackage'),
    47|         'headerInstallDownloadedPackage' => Translation::get('headerInstallDownloadedPackage'),
    48|         'msgExtractToFileSystem' => Translation::get('msgExtractToFileSystem'),
    49|         'msgInstallDownloadedPackage' => Translation::get('msgInstallDownloadedPackage'),
    50|         'isOnNightlies' => $faqConfig->get('upgrade.releaseEnvironment') === ReleaseType::NIGHTLY->value,
    51|         'releaseEnvironment' => ucfirst((string) $faqConfig->get('upgrade.releaseEnvironment')),
    52|         'dateLastChecked' => $faqConfig->get('upgrade.dateLastChecked'),
    53|         'versionCurrent' => $faqConfig->get('main.currentVersion'),
    54|     ];
    55|     echo $template->render($templateVars);
    56| } else {
    57|     require __DIR__ . '/no-permission.php';
    58| }


# ====================================================================
# FILE: phpmyfaq/admin/user.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-166 ---
     1| <?php
     2| /**
     3|  * Displays the user management frontend.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Lars Tiedemann <php@larstiedemann.de>
    11|  * @author    Uwe Pries <uwe.pries@digartis.de>
    12|  * @author    Sarah Hermann <sayh@gmx.de>
    13|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    14|  * @copyright 2005-2024 phpMyFAQ Team
    15|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    16|  * @link      https://www.phpmyfaq.de
    17|  * @since     2005-12-15
    18|  */
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Pagination;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Template\Extensions\PermissionTranslationTwigExtension;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| use phpMyFAQ\Translation;
    26| use phpMyFAQ\User\CurrentUser;
    27| if (!defined('IS_VALID_PHPMYFAQ')) {
    28|     http_response_code(400);
    29|     exit();
    30| }
    31| if (
    32|     !$user->perm->hasPermission($user->getUserId(), PermissionType::USER_EDIT->value) ||
    33|     !$user->perm->hasPermission($user->getUserId(), PermissionType::USER_DELETE->value) ||
    34|     !$user->perm->hasPermission($user->getUserId(), PermissionType::USER_ADD->value)
    35| ) {
    36|     require __DIR__ . '/no-permission.php';
    37|     exit();
    38| }
    39| $templateVars = [];
    40| $userId = Filter::filterInput(INPUT_GET, 'user_id', FILTER_VALIDATE_INT);
    41| $selectSize = 10;
    42| $defaultUserAction = 'list';
    43| $userActionList = [
    44|     'list',
    45|     'listallusers'
    46| ];
    47| $userAction = Filter::filterInput(INPUT_GET, 'user_action', FILTER_SANITIZE_SPECIAL_CHARS, $defaultUserAction);
    48| $currentUser = new CurrentUser($faqConfig);
    49| if ($userAction == 'listallusers') {
    50|     if (!$user->perm->hasPermission($user->getUserId(), PermissionType::USER_EDIT->value)) {
    51|         require __DIR__ . '/no-permission.php';
    52|         exit();
    53|     }
    54|     $allUsers = $user->getAllUsers(false);
    55|     $numUsers = is_countable($allUsers) ? count($allUsers) : 0;
    56|     $page = Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT, 0);
    57|     $perPage = 10;
    58|     $numPages = ceil($numUsers / $perPage);
    59|     $lastPage = $page * $perPage;
    60|     $firstPage = $lastPage - $perPage;
    61|     $baseUrl = sprintf(
    62|         '%sadmin/?action=user&amp;user_action=listallusers&amp;page=%d',
    63|         $faqConfig->getDefaultUrl(),
    64|         $page
    65|     );
    66|     $options = [
    67|         'baseUrl' => $baseUrl,
    68|         'total' => $numUsers,
    69|         'perPage' => $perPage,
    70|         'pageParamName' => 'page',
    71|     ];
    72|     $pagination = new Pagination($options);
    73|     $counter = $displayedCounter = 0;
    74|     $users = [];
    75|     foreach ($allUsers as $listedUserId) {
    76|         $user->getUserById($listedUserId, true);
    77|         $tempUser = [];
    78|         if ($displayedCounter >= $perPage) {
    79|             continue;
    80|         }
    81|         ++$counter;
    82|         if ($counter <= $firstPage) {
    83|             continue;
    84|         }
    85|         ++$displayedCounter;
    86|         $tempUser = [
    87|             'display_name' => $user->getUserData('display_name'),
    88|             'id' => $user->getUserId(),
    89|             'email' => $user->getUserData('email'),
    90|             'status' => $user->getStatus(),
    91|             'isSuperAdmin' => $user->isSuperAdmin(),
    92|             'isVisible' => $user->getUserData('is_visible'),
    93|             'login' => $user->getLogin()
    94|         ];
    95|         $users[] = $tempUser;
    96|     }
    97|     $user = CurrentUser::getCurrentUser($faqConfig);
    98|     $templateVars = [
    99|         ...$templateVars,
   100|         'perPage' => $perPage,
   101|         'numUsers' => $numUsers,
   102|         'pagination' => $pagination->render(),
   103|         'users' => $users,
   104|         'userIsSuperAdmin' => $user->isSuperAdmin()
   105|     ];
   106| }
   107| $templateVars = [
   108|     ...$templateVars,
   109|     'userAction' => $userAction,
   110|     'ad_user' => Translation::get('ad_user'),
   111|     'permissionAddUser' => $currentUser->perm->hasPermission($user->getUserId(), PermissionType::USER_ADD->value),
   112|     'ad_user_add' => Translation::get('ad_user_add'),
   113|     'permissionEditUser' => $currentUser->perm->hasPermission($user->getUserId(), PermissionType::USER_EDIT->value),
   114|     'list_all_users' => Translation::get('list_all_users'),
   115|     'userId' => $userId,
   116|     'msgSearch' => Translation::get('msgSearch'),
   117|     'ad_auth_user' => Translation::get('ad_auth_user'),
   118|     'ad_user_profou' => Translation::get('ad_user_profou'),
   119|     'csrfToken_updateUserData' => Token::getInstance()->getTokenString('update-user-data'),
   120|     'msgAuthenticationSource' => Translation::get('msgAuthenticationSource'),
   121|     'ad_user_status' => Translation::get('ad_user_status'),
   122|     'ad_user_active' => Translation::get('ad_user_active'),
   123|     'ad_user_blocked' => Translation::get('ad_user_blocked'),
   124|     'ad_user_protected' => Translation::get('ad_user_protected'),
   125|     'msgRealname' => Translation::get('msgRealname'),
   126|     'msgEmail' => Translation::get('msgEmail'),
   127|     'ad_user_is_superadmin' => Translation::get('ad_user_is_superadmin'),
   128|     'ad_user_overwrite_passwd' => Translation::get('ad_user_overwrite_passwd'),
   129|     'ad_user_overwrite_twofactor' => Translation::get('ad_user_overwrite_twofactor'),
   130|     'ad_user_delete' => Translation::get('ad_user_delete'),
   131|     'ad_gen_save' => Translation::get('ad_gen_save'),
   132|     'csrfToken_updateUserRights' => Token::getInstance()->getTokenString('update-user-rights'),
   133|     'ad_user_rights' => Translation::get('ad_user_rights'),
   134|     'ad_user_checkall' => Translation::get('ad_user_checkall'),
   135|     'ad_user_uncheckall' => Translation::get('ad_user_uncheckall'),
   136|     'userRights' => $user->perm->getAllRightsData(),
   137|     'msgExportUsersAsCSV' => Translation::get('msgExportUsersAsCSV'),
   138|     'msgNewContentName' => Translation::get('msgNewContentName'),
   139|     'msgNewContentMail' => Translation::get('msgNewContentMail'),
   140|     'ad_user_is_visible' => Translation::get('ad_user_is_visible'),
   141|     'ad_user_edit' => Translation::get('ad_user_edit'),
   142|     'csrfToken_activateUser' => Token::getInstance()->getTokenString('activate-user'),
   143|     'ad_news_set_active' => Translation::get('ad_news_set_active'),
   144|     'permissionDeleteUser' =>
   145|         $currentUser->perm->hasPermission($user->getUserId(), PermissionType::USER_DELETE->value),
   146|     'csrfToken_deleteUser' => Token::getInstance()->getTokenString('delete-user'),
   147|     'ad_adus_adduser' => Translation::get('ad_adus_adduser'),
   148|     'csrfToken_addUser' => Token::getInstance()->getTokenString('add-user'),
   149|     'ad_adus_name' => Translation::get('ad_adus_name'),
   150|     'ad_add_user_change_password' => Translation::get('ad_add_user_change_password'),
   151|     'ad_adus_password' => Translation::get('ad_adus_password'),
   152|     'ad_passwd_con' => Translation::get('ad_passwd_con'),
   153|     'ad_gen_cancel' => Translation::get('ad_gen_cancel'),
   154|     'ad_menu_passwd' => Translation::get('ad_menu_passwd'),
   155|     'csrfToken_overwritePassword' => Token::getInstance()->getTokenString('overwrite-password'),
   156|     'ad_passwd_new' => Translation::get('ad_passwd_new'),
   157|     'msgWarning' => Translation::get('msgWarning'),
   158|     'ad_gen_yes' => Translation::get('ad_gen_yes'),
   159|     'ad_gen_no' => Translation::get('ad_gen_no'),
   160|     'ad_user_deleteUser' => Translation::get('ad_user_deleteUser'),
   161|     'msgUserList' => Translation::get('msgUserList')
   162| ];
   163| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
   164| $twig->addExtension(new PermissionTranslationTwigExtension());
   165| $template = $twig->loadTemplate('@admin/user/users.twig');
   166| echo $template->render($templateVars);


# ====================================================================
# FILE: phpmyfaq/ask.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| <?php
     2| /**
     3|  * Page for adding new questions.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2002-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2002-09-17
    15|  */
    16| use phpMyFAQ\Enums\Forms\FormIds;
    17| use phpMyFAQ\Filter;
    18| use phpMyFAQ\Forms;
    19| use phpMyFAQ\Helper\CategoryHelper as HelperCategory;
    20| use phpMyFAQ\Template\TwigWrapper;
    21| use phpMyFAQ\Translation;
    22| use Symfony\Component\HttpFoundation\RedirectResponse;
    23| use Symfony\Component\HttpFoundation\Request;
    24| if (!defined('IS_VALID_PHPMYFAQ')) {
    25|     http_response_code(400);
    26|     exit();
    27| }
    28| $request = Request::createFromGlobals();
    29| $faqConfig = $container->get('phpmyfaq.configuration');
    30| $user = $container->get('phpmyfaq.user.current_user');
    31| $faqSession = $container->get('phpmyfaq.session');
    32| $faqSession->setCurrentUser($user);
    33| if ((-1 === $user->getUserId() && !$faqConfig->get('records.allowQuestionsForGuests'))) {
    34|     $response = new RedirectResponse($faqConfig->getDefaultUrl() . 'login');
    35|     $response->send();
    36| }
    37| $captcha = $container->get('phpmyfaq.captcha');
    38| $captcha->setSessionId($sids);
    39| $faqSession->userTracking('ask_question', 0);
    40| $category->buildCategoryTree();
    41| $categoryId = Filter::filterVar($request->query->get('category_id'), FILTER_VALIDATE_INT, 0);
    42| $categoryHelper = new HelperCategory();
    43| $categoryHelper->setCategory($category);
    44| $captchaHelper = $container->get('phpmyfaq.captcha.helper.captcha_helper');
    45| $forms = new Forms($faqConfig);
    46| $formData = $forms->getFormData(FormIds::ASK_QUESTION->value);
    47| $categories = $category->getAllCategoryIds();
    48| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    49| $twigTemplate = $twig->loadTemplate('./ask.twig');
    50| $templateVars = [
    51|     ... $templateVars,
    52|     'title' => sprintf('%s - %s', Translation::get('msgQuestion'), $faqConfig->getTitle()),
    53|     'metaDescription' => sprintf(Translation::get('msgQuestionMetaDesc'), $faqConfig->getTitle()),
    54|     'msgMatchingQuestions' => Translation::get('msgMatchingQuestions'),
    55|     'msgFinishSubmission' => Translation::get('msgFinishSubmission'),
    56|     'lang' => $Language->getLanguage(),
    57|     'defaultContentMail' => ($user->getUserId() > 0) ? $user->getUserData('email') : '',
    58|     'defaultContentName' => ($user->getUserId() > 0) ? $user->getUserData('display_name') : '',
    59|     'renderCategoryOptions' => $categoryHelper->renderOptions($categoryId),
    60|     'captchaFieldset' =>
    61|         $captchaHelper->renderCaptcha($captcha, 'ask', Translation::get('msgCaptcha'), $user->isLoggedIn()),
    62|     'msgNewContentSubmit' => Translation::get('msgNewContentSubmit'),
    63|     'noCategories' => empty($categories),
    64|     'msgFormDisabledDueToMissingCategories' => Translation::get('msgFormDisabledDueToMissingCategories')
    65| ];
    66| foreach ($formData as $input) {
    67|     if ((int)$input->input_active !== 0) {
    68|         $label = sprintf('id%d_label', (int)$input->input_id);
    69|         $required = sprintf('id%d_required', (int)$input->input_id);
    70|         $templateVars = [
    71|             ...$templateVars,
    72|             $label => $input->input_label,
    73|             $required => ((int)$input->input_required !== 0) ? 'required' : ''
    74|         ];
    75|     }
    76| }
    77| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/assets/src/configuration/update.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-147 ---
     1| /**
     2|  * Update functions
     3|  *
     4|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     5|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     6|  * obtain one at https://mozilla.org/MPL/2.0/.
     7|  *
     8|  * @package   phpMyFAQ
     9|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    10|  * @copyright 2023-2024 phpMyFAQ Team
    11|  * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    12|  * @link      https://www.phpmyfaq.de
    13|  * @since     2023-10-22
    14|  */
    15| export const handleUpdateNextStepButton = () => {
    16|   const nextStepButton = document.getElementById('phpmyfaq-update-next-step-button');
    17|   const nextStep = document.getElementById('phpmyfaq-update-next-step');
    18|   if (nextStepButton && nextStep) {
    19|     nextStepButton.addEventListener('click', (event) => {
    20|       event.preventDefault();
    21|       window.location.replace(`?step=${nextStep.value}`);
    22|     });
    23|   }
    24| };
    25| export const handleUpdateInformation = async () => {
    26|   if (window.location.href.endsWith('/update/')) {
    27|     const installedVersion = document.getElementById('phpmyfaq-update-installed-version');
    28|     try {
    29|       const response = await fetch('../api/setup/check', {
    30|         method: 'POST',
    31|         headers: {
    32|           Accept: 'application/json, text/plain, */*',
    33|           'Content-Type': 'application/json',
    34|         },
    35|         body: installedVersion.value,
    36|       });
    37|       if (!response.ok) {
    38|         let errorMessage = await response.json();
    39|         throw new Error(errorMessage.message);
    40|       }
    41|       const button = document.getElementById('phpmyfaq-update-next-step-button');
    42|       const alert = document.getElementById('phpmyfaq-update-check-success');
    43|       alert.classList.remove('d-none');
    44|       button.classList.remove('disabled');
    45|       button.disabled = false;
    46|     } catch (errorMessage) {
    47|       if (errorMessage instanceof SyntaxError) {
    48|         errorMessage =
    49|           'The requested resource was not found on the server. ' +
    50|           'Please check your server configuration, especially the RewriteBase in your .htaccess configuration.';
    51|       } else {
    52|         errorMessage = errorMessage.message;
    53|       }
    54|       const alert = document.getElementById('phpmyfaq-update-check-alert');
    55|       const alertResult = document.getElementById('phpmyfaq-update-check-result');
    56|       alert.classList.remove('d-none');
    57|       alertResult.innerText = errorMessage;
    58|     }
    59|   }
    60| };
    61| export const handleConfigBackup = async () => {
    62|   if (window.location.href.endsWith('/update/?step=2')) {
    63|     const installedVersion = document.getElementById('phpmyfaq-update-installed-version');
    64|     try {
    65|       const response = await fetch('../api/setup/backup', {
    66|         method: 'POST',
    67|         headers: {
    68|           Accept: 'application/json, text/plain, */*',
    69|           'Content-Type': 'application/json',
    70|         },
    71|         body: installedVersion.value,
    72|       });
    73|       if (!response.ok) {
    74|         throw new Error('Network response was not ok');
    75|       }
    76|       const data = await response.json();
    77|       const downloadLink = document.getElementById('phpmyfaq-update-backup-download-link');
    78|       downloadLink.href = data.backupFile;
    79|     } catch (error) {
    80|       const errorMessage =
    81|         error.cause && error.cause.response ? await error.cause.response.json() : { error: 'Unknown error' };
    82|       return errorMessage.error;
    83|     }
    84|   }
    85| };
    86| export const handleDatabaseUpdate = async () => {
    87|   if (window.location.href.endsWith('/update/?step=3')) {
    88|     const installedVersion = document.getElementById('phpmyfaq-update-installed-version');
    89|     try {
    90|       const response = await fetch('../api/setup/update-database', {
    91|         method: 'POST',
    92|         headers: {
    93|           Accept: 'application/json, text/plain, */*',
    94|           'Content-Type': 'application/json',
    95|         },
    96|         body: installedVersion.value,
    97|       });
    98|       const progressBarInstallation = document.getElementById('result-update');
    99|       const reader = response.body.getReader();
   100|       async function pump() {
   101|         const { done, value } = await reader.read();
   102|         const decodedValue = new TextDecoder().decode(value);
   103|         if (done) {
   104|           progressBarInstallation.style.width = '100%';
   105|           progressBarInstallation.innerText = '100%';
   106|           progressBarInstallation.classList.remove('progress-bar-animated');
   107|           const alert = document.getElementById('phpmyfaq-update-database-success');
   108|           alert.classList.remove('d-none');
   109|           return;
   110|         } else {
   111|           let value;
   112|           try {
   113|             value = JSON.parse(decodedValue);
   114|           } catch (error) {
   115|             console.error('Failed to parse JSON:', error);
   116|             const alert = document.getElementById('phpmyfaq-update-database-error');
   117|             const errorMessage = document.getElementById('error-messages');
   118|             alert.classList.remove('d-none');
   119|             errorMessage.innerText = `Error: ${error.message}\nFull Error: ${decodedValue}`;
   120|             return;
   121|           }
   122|           if (value.progress) {
   123|             progressBarInstallation.style.width = value.progress;
   124|             progressBarInstallation.innerText = value.progress;
   125|           }
   126|           if (value.error) {
   127|             progressBarInstallation.style.width = '100%';
   128|             progressBarInstallation.innerText = '100%';
   129|             progressBarInstallation.classList.remove('progress-bar-animated');
   130|             const alert = document.getElementById('phpmyfaq-update-database-error');
   131|             const errorMessage = document.getElementById('error-messages');
   132|             alert.classList.remove('d-none');
   133|             errorMessage.innerHTML = value.error;
   134|             return;
   135|           }
   136|         }
   137|         await pump();
   138|       }
   139|       await pump();
   140|     } catch (error) {
   141|       console.error('Error details:', error);
   142|       const alert = document.getElementById('phpmyfaq-update-database-error');
   143|       alert.classList.remove('d-none');
   144|       alert.innerText = `Error: ${error.message}`;
   145|     }
   146|   }
   147| };


# ====================================================================
# FILE: phpmyfaq/attachment.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-102 ---
     1| <?php
     2| /**
     3|  * Handle attachment downloads.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package phpMyFAQ
    10|  * @author Anatoliy Belsky <ab@php.net>
    11|  * @copyright 2009-2024 phpMyFAQ Team
    12|  * @license https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link https://www.phpmyfaq.de
    14|  * @since 2009-06-23
    15|  */
    16| use phpMyFAQ\Attachment\AttachmentException;
    17| use phpMyFAQ\Attachment\AttachmentFactory;
    18| use phpMyFAQ\Faq\Permission;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Permission\MediumPermission;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use phpMyFAQ\Translation;
    23| use Symfony\Component\Config\FileLocator;
    24| use Symfony\Component\DependencyInjection\ContainerBuilder;
    25| use Symfony\Component\DependencyInjection\Loader\PhpFileLoader;
    26| use Symfony\Component\HttpFoundation\Request;
    27| if (!defined('IS_VALID_PHPMYFAQ')) {
    28|     http_response_code(400);
    29|     exit();
    30| }
    31| set_time_limit(0);
    32| if (headers_sent()) {
    33|     die();
    34| }
    35| $attachmentErrors = [];
    36| $container = new ContainerBuilder();
    37| $loader = new PhpFileLoader($container, new FileLocator(__DIR__));
    38| try {
    39|     $loader->load('src/services.php');
    40| } catch (\Exception $e) {
    41|     echo $e->getMessage();
    42| }
    43| $faqConfig = $container->get('phpmyfaq.configuration');
    44| $request = Request::createFromGlobals();
    45| $user = $container->get('phpmyfaq.user.current_user');
    46| $id = Filter::filterVar($request->query->get('id'), FILTER_VALIDATE_INT);
    47| $faqPermission = new Permission($faqConfig);
    48| $userPermission = [];
    49| $groupPermission = [];
    50| try {
    51|     $attachment = AttachmentFactory::create($id);
    52|     $userPermission = $faqPermission->get(Permission::USER, $attachment->getRecordId());
    53|     $groupPermission = $faqPermission->get(Permission::GROUP, $attachment->getRecordId());
    54| } catch (AttachmentException $attachmentException) {
    55|     $attachmentErrors[] = Translation::get('msgAttachmentInvalid') . ' (' . $attachmentException->getMessage() . ')';
    56| }
    57| if ($user->perm instanceof MediumPermission) {
    58|     if ($groupPermission !== []) {
    59|         foreach ($user->perm->getUserGroups($user->getUserId()) as $userGroups) {
    60|             if (in_array($userGroups, $groupPermission)) {
    61|                 $groupPermission = true;
    62|                 break;
    63|             }
    64|         }
    65|     } else {
    66|         $groupPermission = false;
    67|     }
    68| } else {
    69|     $groupPermission = true;
    70| }
    71| $userPermission = in_array($user->getUserId(), $userPermission);
    72| $permission = [];
    73| if ($user->isLoggedIn()) {
    74|     $allRights = $user->perm->getAllRightsData();
    75|     foreach ($allRights as $right) {
    76|         $permission[$right['name']] = false;
    77|     }
    78|     $allUserRights = $user->perm->getAllUserRights($user->getUserId());
    79|     foreach ($allRights as $allRight) {
    80|         if (in_array($allRight['right_id'], $allUserRights)) {
    81|             $permission[$allRight['name']] = true;
    82|         }
    83|     }
    84| }
    85| if (
    86|     $attachment && $attachment->getRecordId() > 0 && ($faqConfig->get('records.allowDownloadsForGuests') ||
    87|         (($groupPermission || ($groupPermission && $userPermission)) && isset($permission['dlattachment'])))
    88| ) {
    89|     try {
    90|         $attachment->rawOut();
    91|     } catch (AttachmentException|ErrorException $e) {
    92|         $attachmentErrors[] = $e->getMessage();
    93|     }
    94| } else {
    95|     $attachmentErrors[] = Translation::get('msgAttachmentInvalid');
    96| }
    97| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    98| $twigTemplate = $twig->loadTemplate('./attachment.twig');
    99| $templateVars = [
   100|     'attachmentErrors' => $attachmentErrors,
   101| ];
   102| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/bookmarks.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| <?php
     2| /**
     3|  * Shows the page with the user's bookmarks.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Jan Harms <model_railroader@gmx-topmail.de>
    12|  * @copyright 2002-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2023-07-20
    16|  */
    17| use phpMyFAQ\Template\TwigWrapper;
    18| use phpMyFAQ\Bookmark;
    19| use phpMyFAQ\Translation;
    20| use phpMyFAQ\Session\Token;
    21| use Symfony\Component\HttpFoundation\RedirectResponse;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = $container->get('phpmyfaq.configuration');
    27| $user = $container->get('phpmyfaq.user.current_user');
    28| if ($user->isLoggedIn()) {
    29|     $bookmark = new Bookmark($faqConfig, $user);
    30|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    31|     $twigTemplate = $twig->loadTemplate('./bookmarks.twig');
    32|     $templateVars = [
    33|         ... $templateVars,
    34|         'title' => sprintf('%s - %s', Translation::get('msgBookmarks'), $faqConfig->getTitle()),
    35|         'bookmarksList' => $bookmark->getBookmarkList(),
    36|         'csrfTokenDeleteBookmark' => Token::getInstance()->getTokenString('delete-bookmark'),
    37|         'csrfTokenDeleteAllBookmarks' => Token::getInstance()->getTokenString('delete-all-bookmarks')
    38|     ];
    39|     return $templateVars;
    40| } else {
    41|     $response = new RedirectResponse($faqConfig->getDefaultUrl());
    42|     $response->send();
    43| }


# ====================================================================
# FILE: phpmyfaq/contact.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| <?php
     2| /**
     3|  * Contact page.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2002-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2002-09-16
    15|  */
    16| use phpMyFAQ\Template\TwigWrapper;
    17| use phpMyFAQ\Translation;
    18| if (!defined('IS_VALID_PHPMYFAQ')) {
    19|     http_response_code(400);
    20|     exit();
    21| }
    22| $faqConfig = $container->get('phpmyfaq.configuration');
    23| $user = $container->get('phpmyfaq.user.current_user');
    24| $faqSession = $container->get('phpmyfaq.session');
    25| $faqSession->setCurrentUser($user);
    26| $faqSession->userTracking('contact', 0);
    27| $captcha = $container->get('phpmyfaq.captcha');
    28| $captcha->setSessionId($sids);
    29| $captchaHelper = $container->get('phpmyfaq.captcha.helper.captcha_helper');
    30| if ($faqConfig->get('layout.contactInformationHTML')) {
    31|     $contactText = html_entity_decode((string) $faqConfig->get('main.contactInformation'));
    32| } else {
    33|     $contactText = nl2br($faqConfig->get('main.contactInformation'));
    34| }
    35| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    36| $twigTemplate = $twig->loadTemplate('./contact.twig');
    37| $templateVars = [
    38|     ... $templateVars,
    39|     'title' => sprintf('%s - %s', Translation::get('msgContact'), $faqConfig->getTitle()),
    40|     'msgContactOwnText' => $contactText,
    41|     'privacyURL' => $faqConfig->get('main.privacyURL'),
    42|     'lang' => $Language->getLanguage(),
    43|     'defaultContentMail' => ($user->getUserId() > 0) ? $user->getUserData('email') : '',
    44|     'defaultContentName' => ($user->getUserId() > 0) ? $user->getUserData('display_name') : '',
    45|     'version' => $faqConfig->getVersion(),
    46|     'captchaFieldset' =>
    47|         $captchaHelper->renderCaptcha($captcha, 'contact', Translation::get('msgCaptcha'), $user->isLoggedIn()),
    48| ];
    49| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/faq.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-299 ---
     1| <?php
     2| /**
     3|  * Shows the page with the FAQ record and - when available - the user comments.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Lars Tiedemann <larstiedemann@yahoo.de>
    12|  * @copyright 2002-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2002-08-27
    16|  */
    17| use League\CommonMark\CommonMarkConverter;
    18| use phpMyFAQ\Attachment\AttachmentException;
    19| use phpMyFAQ\Attachment\AttachmentFactory;
    20| use phpMyFAQ\Captcha\Helper\CaptchaHelper;
    21| use phpMyFAQ\Comments;
    22| use phpMyFAQ\Date;
    23| use phpMyFAQ\Entity\CommentType;
    24| use phpMyFAQ\Entity\SeoEntity;
    25| use phpMyFAQ\Enums\PermissionType;
    26| use phpMyFAQ\Enums\SeoType;
    27| use phpMyFAQ\Faq\Permission;
    28| use phpMyFAQ\Filter;
    29| use phpMyFAQ\Glossary;
    30| use phpMyFAQ\Helper\AttachmentHelper;
    31| use phpMyFAQ\Helper\CommentHelper;
    32| use phpMyFAQ\Helper\FaqHelper as HelperFaq;
    33| use phpMyFAQ\Helper\SearchHelper;
    34| use phpMyFAQ\Link;
    35| use phpMyFAQ\Rating;
    36| use phpMyFAQ\Relation;
    37| use phpMyFAQ\Search\SearchResultSet;
    38| use phpMyFAQ\Seo;
    39| use phpMyFAQ\Services;
    40| use phpMyFAQ\Session\Token;
    41| use phpMyFAQ\Strings;
    42| use phpMyFAQ\Tags;
    43| use phpMyFAQ\Template\TwigWrapper;
    44| use phpMyFAQ\Translation;
    45| use phpMyFAQ\User\CurrentUser;
    46| use phpMyFAQ\Utils;
    47| use phpMyFAQ\Visits;
    48| use Symfony\Component\HttpFoundation\Request;
    49| use Symfony\Component\HttpFoundation\Response;
    50| if (!defined('IS_VALID_PHPMYFAQ')) {
    51|     http_response_code(400);
    52|     exit();
    53| }
    54| $faqConfig = $container->get('phpmyfaq.configuration');
    55| $user = $container->get('phpmyfaq.user.current_user');
    56| $glossary = new Glossary($faqConfig);
    57| $tagging = new Tags($faqConfig);
    58| $relation = new Relation($faqConfig);
    59| $rating = new Rating($faqConfig);
    60| $comment = new Comments($faqConfig);
    61| $faqHelper = new HelperFaq($faqConfig);
    62| $faqPermission = new Permission($faqConfig);
    63| $seo = new Seo($faqConfig);
    64| $attachmentHelper = new AttachmentHelper();
    65| $faqSession = $container->get('phpmyfaq.session');
    66| $faqSession->setCurrentUser($user);
    67| $converter = new CommonMarkConverter([
    68|     'html_input' => 'strip',
    69|     'allow_unsafe_links' => false,
    70| ]);
    71| if (is_null($user)) {
    72|     $user = new CurrentUser($faqConfig);
    73| }
    74| $templateVars = [
    75|     ... $templateVars
    76| ];
    77| $faqSearchResult = new SearchResultSet($user, $faqPermission, $faqConfig);
    78| $captcha = $container->get('phpmyfaq.captcha');
    79| $captcha->setSessionId($sids);
    80| $currentCategory = $cat;
    81| $request = Request::createFromGlobals();
    82| $faqId = Filter::filterVar($request->query->get('id'), FILTER_VALIDATE_INT, 0);
    83| $solutionId = Filter::filterVar($request->query->get('solution_id'), FILTER_VALIDATE_INT);
    84| $highlight = Filter::filterVar($request->query->get('highlight'), FILTER_SANITIZE_SPECIAL_CHARS);
    85| $bookmarkAction = Filter::filterVar($request->query->get('bookmark_action'), FILTER_SANITIZE_SPECIAL_CHARS);
    86| $bookmark = $container->get('phpmyfaq.bookmark');
    87| if ($bookmarkAction === 'add' && isset($faqId)) {
    88|     $bookmark->add($faqId);
    89| }
    90| if ($bookmarkAction === 'remove' && isset($faqId)) {
    91|     $bookmark->remove($faqId);
    92| }
    93| if (0 === (int)$solutionId) {
    94|     $faq->getFaq($faqId);
    95| } else {
    96|     $faq->getFaqBySolutionId($solutionId);
    97| }
    98| if (isset($faq->faqRecord['id'])) {
    99|     $faqId = $faq->faqRecord['id'];
   100| }
   101| $faqSession->userTracking('article_view', $faqId);
   102| $faqVisits = new Visits($faqConfig);
   103| $faqVisits->logViews((int) $faqId);
   104| $question = $faq->getQuestion($faqId);
   105| if ($faqConfig->get('main.enableMarkdownEditor')) {
   106|     $answer = $converter->convert($faq->faqRecord['content'])->getContent();
   107| } else {
   108|     $answer = $faqHelper->rewriteLanguageMarkupClass($faq->faqRecord['content']);
   109| }
   110| $answer = $faqHelper->cleanUpContent($answer);
   111| $currentUrl = sprintf('//%s%s', $request->getHost(), $request->getRequestUri());
   112| $answer = $faqHelper->rewriteUrlFragments($answer, $currentUrl);
   113| $answer = $glossary->insertItemsIntoContent($answer);
   114| $categoryName = $category->getPath($currentCategory, ' &raquo; ', true);
   115| if (
   116|     !is_null($highlight) && $highlight != '/' && $highlight != '<' && $highlight != '>' && Strings::strlen(
   117|         $highlight
   118|     ) > 3
   119| ) {
   120|     $highlight = str_replace("'", '', (string) $highlight);
   121|     $highlight = str_replace(['^', '.', '?', '*', '+', '{', '}', '(', ')', '[', ']'], '', $highlight);
   122|     $highlight = preg_quote($highlight, '/');
   123|     $searchItems = explode(' ', $highlight);
   124|     foreach ($searchItems as $searchItem) {
   125|         if (Strings::strlen($searchItem) > 2) {
   126|             $question = Utils::setHighlightedString($question, $searchItem);
   127|             $answer = Utils::setHighlightedString($answer, $searchItem);
   128|         }
   129|     }
   130| }
   131| if ($faqConfig->get('records.disableAttachments') && 'yes' == $faq->faqRecord['active']) {
   132|     try {
   133|         $attList = AttachmentFactory::fetchByRecordId($faqConfig, $faqId);
   134|         $answer .= $attachmentHelper->renderAttachmentList($attList);
   135|     } catch (AttachmentException) {
   136|     }
   137| }
   138| $renderedCategoryPath = '';
   139| $multiCategories = $category->getCategoriesFromFaq($faqId);
   140| if ((is_countable($multiCategories) ? count($multiCategories) : 0) > 1) {
   141|     foreach ($multiCategories as $multiCategory) {
   142|         $path = $category->getPath($multiCategory['id'], ' &raquo; ', true, 'breadcrumb-related-categories');
   143|         if ('' === trim($path)) {
   144|             continue;
   145|         }
   146|         $renderedCategoryPath .= $path;
   147|     }
   148| }
   149| try {
   150|     $faqSearchResult->reviewResultSet(
   151|         $relation->getAllRelatedByQuestion($faq->faqRecord['title'], $faq->faqRecord['keywords'])
   152|     );
   153| } catch (Exception) {
   154| }
   155| $searchHelper = new SearchHelper($faqConfig);
   156| $relatedFaqs = $searchHelper->renderRelatedFaqs($faqSearchResult, $faqId);
   157| $expired = (date('YmdHis') > $faq->faqRecord['dateEnd']);
   158| $numComments = $comment->getNumberOfComments();
   159| $comments = $comment->getCommentsData($faqId, CommentType::FAQ);
   160| $commentHelper = new CommentHelper();
   161| $commentHelper->setConfiguration($faqConfig);
   162| if (
   163|     (-1 === $user->getUserId() && !$faqConfig->get('records.allowCommentsForGuests')) ||
   164|     ($faq->faqRecord['active'] === 'no') || ('n' === $faq->faqRecord['comment']) || $expired
   165| ) {
   166|     $commentMessage = Translation::get('msgWriteNoComment');
   167| } else {
   168|     $commentMessage = sprintf(
   169|         '%s<a href="#" data-bs-toggle="modal" data-bs-target="#pmf-modal-add-comment">%s</a>',
   170|         Translation::get('msgYouCan'),
   171|         Translation::get('msgWriteComment')
   172|     );
   173|     $templateVars = [
   174|         ... $templateVars,
   175|         'numberOfComments' => sprintf('%d %s', $numComments[$faqId] ?? 0, Translation::get('ad_start_comments')),
   176|         'writeCommentMsg' => $commentMessage
   177|     ];
   178| }
   179| if (-1 !== $user->getUserId()) {
   180|     $templateVars = [
   181|         ...$templateVars,
   182|         'bookmarkIcon' => $bookmark->isFaqBookmark($faqId) ? 'bi bi-bookmark-fill' : 'bi bi-bookmark',
   183|         'msgAddBookmark' =>
   184|             $bookmark->isFaqBookmark($faqId) ? Translation::get('removeBookmark') : Translation::get('msgAddBookmark'),
   185|         'isFaqBookmark' => $bookmark->isFaqBookmark($faqId)
   186|     ];
   187| }
   188| $availableLanguages = $faqConfig->getLanguage()->isLanguageAvailable($faq->faqRecord['id']);
   189| if (!empty($availableLanguages) && (is_countable($availableLanguages) ? count($availableLanguages) : 0) > 1) {
   190|     $templateVars = [
   191|         ...$templateVars,
   192|         'msgChangeLanguage' => Translation::get('msgLanguageSubmit')
   193|     ];
   194| }
   195| if (
   196|     $user->perm->hasPermission($user->getUserId(), PermissionType::FAQ_EDIT->value) &&
   197|     !empty($faq->faqRecord['notes'])
   198| ) {
   199|     $templateVars = [
   200|         ...$templateVars,
   201|         'notesHeader' => Translation::get('ad_admin_notes'),
   202|         'notes' => $faq->faqRecord['notes']
   203|     ];
   204| }
   205| if ('-' !== $tagging->getAllLinkTagsById($faqId)) {
   206|     $templateVars = [
   207|         ...$templateVars,
   208|         'renderTagsHeader' => Translation::get('msg_tags'),
   209|         'renderTags' =>  $tagging->getAllLinkTagsById($faqId),
   210|     ];
   211| }
   212| if ('' !== $renderedCategoryPath) {
   213|     $templateVars = [
   214|         ...$templateVars,
   215|         'renderRelatedCategoriesHeader' => Translation::get('msgArticleCategories'),
   216|         'renderRelatedCategories' => $renderedCategoryPath,
   217|     ];
   218| }
   219| if ('' !== $relatedFaqs) {
   220|     $templateVars = [
   221|         ...$templateVars,
   222|         'renderRelatedArticlesHeader' => Translation::get('msg_related_articles'),
   223|         'renderRelatedArticles' => $relatedFaqs,
   224|     ];
   225| }
   226| $date = new Date($faqConfig);
   227| $captchaHelper = CaptchaHelper::getInstance($faqConfig);
   228| $faqServices = new Services($faqConfig);
   229| $faqServices->setCategoryId($cat);
   230| $faqServices->setFaqId($id);
   231| $faqServices->setLanguage($lang);
   232| $faqServices->setQuestion($faq->getQuestion($id));
   233| if (!$category->categoryHasLinkToFaq($faqId, $currentCategory)) {
   234|     $response = new Response();
   235|     $response->setStatusCode(Response::HTTP_NOT_FOUND);
   236| }
   237| $author = $user->getUserVisibilityByEmail($faq->faqRecord['email']) ? $faq->faqRecord['author'] : 'n/a';
   238| $seoEntity = new SeoEntity();
   239| $seoEntity
   240|     ->setType(SeoType::FAQ)
   241|     ->setReferenceId($faq->faqRecord['id'])
   242|     ->setReferenceLanguage($faq->faqRecord['lang']);
   243| $seoData = $seo->get($seoEntity);
   244| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
   245| $twigTemplate = $twig->loadTemplate('./faq.twig');
   246| $templateVars = [
   247|     ...$templateVars,
   248|     'title' => sprintf('%s - %s', $seoData->getTitle() ?? $question, $faqConfig->getTitle()),
   249|     'metaDescription' => $seoData->getDescription(),
   250|     'solutionId' => $faq->faqRecord['solution_id'],
   251|     'solutionIdLink' => Link::getSystemRelativeUri() . '?solution_id=' . $faq->faqRecord['solution_id'],
   252|     'question' => $question,
   253|     'answer' => $answer,
   254|     'faqDate' => $date->format($faq->faqRecord['date']),
   255|     'faqAuthor' => Strings::htmlentities($author),
   256|     'msgPdf' => Translation::get('msgPDF'),
   257|     'msgPrintFaq' => Translation::get('msgPrintArticle'),
   258|     'enableSendToFriend' => $faqConfig->get('main.enableSendToFriend'),
   259|     'msgShareText' => Translation::get('msgShareText'),
   260|     'msgShareViaWhatsapp' => Translation::get('msgShareViaWhatsapp'),
   261|     'msgSend2Friend' => Translation::get('msgSend2Friend'),
   262|     'linkToPdf' => $faqServices->getPdfLink(),
   263|     'msgAverageVote' => Translation::get('msgAverageVote'),
   264|     'renderVotingResult' => $rating->get($faqId),
   265|     'switchLanguage' => $faqHelper->renderChangeLanguageSelector($faq, $currentCategory),
   266|     'msgVoteBad' => Translation::get('msgVoteBad'),
   267|     'msgVoteGood' => Translation::get('msgVoteGood'),
   268|     'msgVoteSubmit' => Translation::get('msgVoteSubmit'),
   269|     'msgWriteComment' => Translation::get('msgWriteComment'),
   270|     'id' => $faqId,
   271|     'lang' => $lang,
   272|     'msgCommentHeader' => Translation::get('msgCommentHeader'),
   273|     'msgNewContentName' => Translation::get('msgNewContentName'),
   274|     'msgNewContentMail' => Translation::get('msgNewContentMail'),
   275|     'defaultContentMail' => ($user->getUserId() > 0) ? $user->getUserData('email') : '',
   276|     'defaultContentName' => ($user->getUserId() > 0) ? $user->getUserData('display_name') : '',
   277|     'msgYourComment' => Translation::get('msgYourComment'),
   278|     'msgCancel' => Translation::get('ad_gen_cancel'),
   279|     'msgNewContentSubmit' => Translation::get('msgNewContentSubmit'),
   280|     'csrfTokenAddComment' => Token::getInstance()->getTokenString('add-comment'),
   281|     'captchaFieldset' => $captchaHelper->renderCaptcha(
   282|         $captcha,
   283|         'writecomment',
   284|         Translation::get('msgCaptcha'),
   285|         $user->isLoggedIn()
   286|     ),
   287|     'renderComments' => $commentHelper->getComments($comments),
   288|     'msg_about_faq' => Translation::get('msg_about_faq'),
   289|     'userId' => $user->getUserId(),
   290|     'permissionEditFaq' => $user->perm->hasPermission($user->getUserId(), PermissionType::FAQ_EDIT->value),
   291|     'ad_entry_edit_1' => Translation::get('ad_entry_edit_1'),
   292|     'ad_entry_edit_2' => Translation::get('ad_entry_edit_2'),
   293|     'bookmarkAction' => $bookmarkAction ?? '',
   294|     'msgBookmarkAdded' => Translation::get('msgBookmarkAdded'),
   295|     'msgBookmarkRemoved' => Translation::get('msgBookmarkRemoved'),
   296|     'csrfTokenRemoveBookmark' => Token::getInstance()->getTokenString('delete-bookmark'),
   297|     'csrfTokenAddBookmark' => Token::getInstance()->getTokenString('add-bookmark')
   298| ];
   299| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/glossary.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-59 ---
     1| <?php
     2| /**
     3|  * This is the page there a user can view all glossary items.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-09-03
    15|  */
    16| use phpMyFAQ\Filter;
    17| use phpMyFAQ\Glossary;
    18| use phpMyFAQ\Pagination;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use Symfony\Component\HttpFoundation\Request;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = $container->get('phpmyfaq.configuration');
    27| $user = $container->get('phpmyfaq.user.current_user');
    28| $faqSession = $container->get('phpmyfaq.session');
    29| $faqSession->setCurrentUser($user);
    30| $faqSession->userTracking('glossary', 0);
    31| $request = Request::createFromGlobals();
    32| $page = Filter::filterVar($request->query->get('page'), FILTER_VALIDATE_INT, 1);
    33| $glossary = new Glossary($faqConfig);
    34| $glossaryItems = $glossary->fetchAll();
    35| $numItems = is_countable($glossaryItems) ? count($glossaryItems) : 0;
    36| $itemsPerPage = 8;
    37| $baseUrl = sprintf(
    38|     '%sindex.php?action=glossary&amp;page=%d',
    39|     $faqConfig->getDefaultUrl(),
    40|     $page
    41| );
    42| $options = [
    43|     'baseUrl' => $baseUrl,
    44|     'total' => is_countable($glossaryItems) ? count($glossaryItems) : 0,
    45|     'perPage' => $itemsPerPage,
    46|     'pageParamName' => 'page',
    47| ];
    48| $pagination = new Pagination($options);
    49| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    50| $twigTemplate = $twig->loadTemplate('./glossary.twig');
    51| $templateVars = [
    52|     ... $templateVars,
    53|     'title' => sprintf('%s - %s', Translation::get('ad_menu_glossary'), $faqConfig->getTitle()),
    54|     'metaDescription' => sprintf(Translation::get('msgGlossaryMetaDesc'), $faqConfig->getTitle()),
    55|     'pageHeader' => Translation::get('ad_menu_glossary'),
    56|     'glossaryItems' => array_slice($glossaryItems, ($page - 1) * $itemsPerPage, $itemsPerPage),
    57|     'pagination' => $pagination->render(),
    58| ];
    59| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/login.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-55 ---
     1| <?php
     2| /**
     3|  * This is the page there a user can log in.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-02-12
    15|  */
    16| use phpMyFAQ\Template\TwigWrapper;
    17| use phpMyFAQ\Translation;
    18| if (!defined('IS_VALID_PHPMYFAQ')) {
    19|     http_response_code(400);
    20|     exit();
    21| }
    22| $faqConfig = $container->get('phpmyfaq.configuration');
    23| $user = $container->get('phpmyfaq.user.current_user');
    24| $faqSession = $container->get('phpmyfaq.session');
    25| $faqSession->setCurrentUser($user);
    26| $faqSession->userTracking('login', 0);
    27| $loginMessage = '';
    28| if (!is_null($error)) {
    29|     $loginMessage = '<div class="alert alert-danger" role="alert">' . $error . '</div>';
    30| }
    31| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    32| $twigTemplate = $twig->loadTemplate('./login.twig');
    33| $templateVars = [
    34|     ... $templateVars,
    35|     'title' => sprintf('%s - %s', Translation::get('msgLoginUser'), $faqConfig->getTitle()),
    36|     'loginHeader' => Translation::get('msgLoginUser'),
    37|     'sendPassword' => Translation::get('lostPassword'),
    38|     'loginMessage' => $loginMessage,
    39|     'writeLoginPath' => $faqConfig->getDefaultUrl(),
    40|     'faqloginaction' => $action,
    41|     'login' => Translation::get('ad_auth_ok'),
    42|     'username' => Translation::get('ad_auth_user'),
    43|     'password' => Translation::get('ad_auth_passwd'),
    44|     'rememberMe' => Translation::get('rememberMe'),
    45|     'msgTwofactorEnabled' => Translation::get('msgTwofactorEnabled'),
    46|     'msgTwofactorTokenModelTitle' => Translation::get('msgTwofactorTokenModelTitle'),
    47|     'msgEnterTwofactorToken' => Translation::get('msgEnterTwofactorToken'),
    48|     'msgTwofactorCheck' => Translation::get('msgTwofactorCheck'),
    49|     'userid' => $userId,
    50|     'enableRegistration' => $faqConfig->get('security.enableRegistration'),
    51|     'registerUser' => Translation::get('msgRegistration'),
    52|     'useSignInWithMicrosoft' => $faqConfig->isSignInWithMicrosoftActive(),
    53|     'isWebAuthnEnabled' => $faqConfig->get('security.enableWebAuthnSupport'),
    54| ];
    55| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/news.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-132 ---
     1| <?php
     2| /**
     3|  * Shows the page with the news record and - when available - the user
     4|  * comments.
     5|  *
     6|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     7|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     8|  * obtain one at https://mozilla.org/MPL/2.0/.
     9|  *
    10|  * @package   phpMyFAQ
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @author    Matteo Scaramuccia <matteo@scaramuccia.com>
    13|  * @copyright 2006-2024 phpMyFAQ Team
    14|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    15|  * @link      https://www.phpmyfaq.de
    16|  * @since     2006-07-23
    17|  */
    18| use phpMyFAQ\Captcha\Helper\CaptchaHelper;
    19| use phpMyFAQ\Comments;
    20| use phpMyFAQ\Date;
    21| use phpMyFAQ\Entity\CommentType;
    22| use phpMyFAQ\Enums\PermissionType;
    23| use phpMyFAQ\Filter;
    24| use phpMyFAQ\Glossary;
    25| use phpMyFAQ\Helper\CommentHelper;
    26| use phpMyFAQ\Helper\FaqHelper;
    27| use phpMyFAQ\News;
    28| use phpMyFAQ\Session\Token;
    29| use phpMyFAQ\Strings;
    30| use phpMyFAQ\Template\TwigWrapper;
    31| use phpMyFAQ\Translation;
    32| use Symfony\Component\HttpFoundation\Request;
    33| if (!defined('IS_VALID_PHPMYFAQ')) {
    34|     http_response_code(400);
    35|     exit();
    36| }
    37| $faqConfig = $container->get('phpmyfaq.configuration');
    38| $user = $container->get('phpmyfaq.user.current_user');
    39| $faqSession = $container->get('phpmyfaq.session');
    40| $faqSession->setCurrentUser($user);
    41| $captcha = $container->get('phpmyfaq.captcha');
    42| $captcha->setSessionId($sids);
    43| $comment = new Comments($faqConfig);
    44| $request = Request::createFromGlobals();
    45| $newsId = Filter::filterVar($request->query->get('newsid'), FILTER_VALIDATE_INT);
    46| $oNews = new News($faqConfig);
    47| $faqSession->userTracking('news_view', $newsId);
    48| $newsMainHeader = $faqConfig->getTitle() . Translation::get('msgNews');
    49| $news = $oNews->get($newsId);
    50| $newsContent = $news['content'];
    51| $newsHeader = $news['header'];
    52| $oGlossary = new Glossary($faqConfig);
    53| $newsContent = $oGlossary->insertItemsIntoContent($newsContent ?? '');
    54| $newsHeader = $oGlossary->insertItemsIntoContent($newsHeader ?? '');
    55| $helper = new FaqHelper($faqConfig);
    56| $newsContent = $helper->cleanUpContent($newsContent);
    57| if (strlen((string) $news['link']) > 0) {
    58|     $newsContent .= sprintf(
    59|         '</p><p>%s<a href="%s" target="%s">%s</a>',
    60|         Translation::get('msgInfo'),
    61|         Strings::htmlentities($news['link']),
    62|         $news['target'],
    63|         Strings::htmlentities($news['linkTitle'])
    64|     );
    65| }
    66| $editThisEntry = '';
    67| if ($user->perm->hasPermission($user->getUserId(), PermissionType::NEWS_EDIT)) {
    68|     $editThisEntry = sprintf(
    69|         '<a href="./admin/index.php?action=news&amp;do=edit&amp;id=%d">%s</a>',
    70|         $newsId,
    71|         Translation::get('ad_menu_news_edit')
    72|     );
    73| }
    74| if (
    75|     (-1 === $user->getUserId() && !$faqConfig->get('records.allowCommentsForGuests')) ||
    76|     (!$news['active']) || (!$news['allowComments'])
    77| ) {
    78|     $commentMessage = Translation::get('msgWriteNoComment');
    79| } else {
    80|     $commentMessage = sprintf(
    81|         '<a href="#" data-bs-toggle="modal" data-bs-target="#pmf-modal-add-comment">%s</a>',
    82|         Translation::get('newsWriteComment')
    83|     );
    84| }
    85| if ($news['active']) {
    86|     $date = new Date($faqConfig);
    87|     $newsDate = sprintf(
    88|         '%s<span id="newsLastUpd">%s</span>',
    89|         Translation::get('msgLastUpdateArticle'),
    90|         $date->format($news['date'])
    91|     );
    92| } else {
    93|     $newsDate = '';
    94| }
    95| $captchaHelper = CaptchaHelper::getInstance($faqConfig);
    96| $commentHelper = new CommentHelper();
    97| $commentHelper->setConfiguration($faqConfig);
    98| $comment = new Comments($faqConfig);
    99| $comments = $comment->getCommentsData($newsId, CommentType::NEWS);
   100| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
   101| $twigTemplate = $twig->loadTemplate('./news.twig');
   102| $templateVars = [
   103|     ... $templateVars,
   104|     'writeNewsHeader' => $newsMainHeader,
   105|     'newsHeader' => $newsHeader,
   106|     'mainPageContent' => $newsContent,
   107|     'writeDateMsg' => $newsDate,
   108|     'msgAboutThisNews' => Translation::get('msgAboutThisNews'),
   109|     'writeAuthor' => ($news['active']) ? Translation::get('msgAuthor') . ': ' . $news['authorName'] : '',
   110|     'editThisEntry' => $editThisEntry,
   111|     'writeCommentMsg' => $commentMessage,
   112|     'msgWriteComment' => Translation::get('newsWriteComment'),
   113|     'newsId' => $newsId,
   114|     'newsLang' => $news['lang'],
   115|     'msgCommentHeader' => Translation::get('msgCommentHeader'),
   116|     'msgNewContentName' => Translation::get('msgNewContentName'),
   117|     'msgNewContentMail' => Translation::get('msgNewContentMail'),
   118|     'defaultContentMail' => ($user->getUserId() > 0) ? $user->getUserData('email') : '',
   119|     'defaultContentName' => ($user->getUserId() > 0) ? $user->getUserData('display_name') : '',
   120|     'msgYourComment' => Translation::get('msgYourComment'),
   121|     'csrfInput' => Token::getInstance()->getTokenInput('add-comment'),
   122|     'msgCancel' => Translation::get('ad_gen_cancel'),
   123|     'msgNewContentSubmit' => Translation::get('msgNewContentSubmit'),
   124|     'captchaFieldset' => $captchaHelper->renderCaptcha(
   125|         $captcha,
   126|         'writecomment',
   127|         Translation::get('msgCaptcha'),
   128|         $user->isLoggedIn()
   129|     ),
   130|     'renderComments' => $commentHelper->getComments($comments),
   131| ];
   132| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/open-questions.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-51 ---
     1| <?php
     2| /**
     3|  * Open questions frontend.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2002-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2002-09-17
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Helper\QuestionHelper;
    18| use phpMyFAQ\Template\TwigWrapper;
    19| use phpMyFAQ\Translation;
    20| if (!defined('IS_VALID_PHPMYFAQ')) {
    21|     http_response_code(400);
    22|     exit();
    23| }
    24| $faqConfig = $container->get('phpmyfaq.configuration');
    25| $user = $container->get('phpmyfaq.user.current_user');
    26| $faqSession = $container->get('phpmyfaq.session');
    27| $faqSession->setCurrentUser($user);
    28| $faqSession->userTracking('open_questions', 0);
    29| $category = new Category($faqConfig);
    30| $questionHelper = new QuestionHelper();
    31| $questionHelper
    32|     ->setConfiguration($faqConfig)
    33|     ->setCategory($category);
    34| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    35| $twigTemplate = $twig->loadTemplate('./open-questions.twig');
    36| $templateVars = [
    37|     ... $templateVars,
    38|     'title' => sprintf('%s - %s', Translation::get('msgOpenQuestions'), $faqConfig->getTitle()),
    39|     'metaDescription' => sprintf(Translation::get('msgOpenQuestionsMetaDesc'), $faqConfig->getTitle()),
    40|     'pageHeader' => Translation::get('msgOpenQuestions'),
    41|     'msgQuestionText' => Translation::get('msgQuestionText'),
    42|     'msgDate_User' => Translation::get('msgDate_User'),
    43|     'msgQuestion2' => Translation::get('msgQuestion2'),
    44|     'openQuestions' => $questionHelper->getOpenQuestions(),
    45|     'isCloseQuestionEnabled' => $faqConfig->get('records.enableCloseQuestion'),
    46|     'msgQuestionsWaiting' => Translation::get('msgQuestionsWaiting'),
    47|     'msgNoQuestionsAvailable' => Translation::get('msgNoQuestionsAvailable'),
    48|     'msg2answerFAQ' => Translation::get('msg2answerFAQ'),
    49|     'msg2answer' => Translation::get('msg2answer')
    50| ];
    51| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/overview.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-48 ---
     1| <?php
     2| /**
     3|  * FAQ overview page.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2015-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2015-09-27
    15|  */
    16| use phpMyFAQ\Helper\FaqHelper;
    17| use phpMyFAQ\Template\Extensions\CategoryNameTwigExtension;
    18| use phpMyFAQ\Template\Extensions\CreateLinkTwigExtension;
    19| use phpMyFAQ\Template\Extensions\FaqTwigExtension;
    20| use phpMyFAQ\Template\TwigWrapper;
    21| use phpMyFAQ\Translation;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = $container->get('phpmyfaq.configuration');
    27| $user = $container->get('phpmyfaq.user.current_user');
    28| $faqSession = $container->get('phpmyfaq.session');
    29| $faqSession->setCurrentUser($user);
    30| $faqSession->userTracking('overview', 0);
    31| $faqHelper = new FaqHelper($faqConfig);
    32| $faq->setUser($user->getUserId());
    33| $faq->setGroups($currentGroups);
    34| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    35| $twig->addExtension(new CategoryNameTwigExtension());
    36| $twig->addExtension(new CreateLinkTwigExtension());
    37| $twig->addExtension(new FaqTwigExtension());
    38| $twigTemplate = $twig->loadTemplate('./overview.twig');
    39| $templateVars = [
    40|     ... $templateVars,
    41|     'title' => sprintf('%s - %s', Translation::get('faqOverview'), $faqConfig->getTitle()),
    42|     'metaDescription' => sprintf(Translation::get('msgOverviewMetaDesc'), $faqConfig->getTitle()),
    43|     'pageHeader' => Translation::get('faqOverview'),
    44|     'faqOverview' => $faqHelper->createOverview($category, $faq, $faqLangCode),
    45|     'msgAuthor' => Translation::get('msgAuthor'),
    46|     'msgLastUpdateArticle' => Translation::get('msgLastUpdateArticle')
    47| ];
    48| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/password.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| <?php
     2| /**
     3|  * This is the page there a user can request a new password.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-03-26
    15|  */
    16| use phpMyFAQ\Template\TwigWrapper;
    17| if (!defined('IS_VALID_PHPMYFAQ')) {
    18|     http_response_code(400);
    19|     exit();
    20| }
    21| $faqConfig = $container->get('phpmyfaq.configuration');
    22| $faqSession = $container->get('phpmyfaq.session');
    23| $faqSession->userTracking('forgot_password', 0);
    24| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    25| $twigTemplate = $twig->loadTemplate('./password.twig');
    26| $templateVars = [
    27|     ... $templateVars,
    28|     'lang' => $faqConfig->getLanguage()->getLanguage(),
    29| ];
    30| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/register.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| <?php
     2| /**
     3|  * This module is for user registration.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Elger Thiele <elger@phpmyfaq.de>
    12|  * @copyright 2008-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2008-01-25
    16|  */
    17| use phpMyFAQ\Template\TwigWrapper;
    18| use phpMyFAQ\Translation;
    19| use Symfony\Component\HttpFoundation\RedirectResponse;
    20| use Symfony\Component\HttpFoundation\Request;
    21| if (!defined('IS_VALID_PHPMYFAQ')) {
    22|     http_response_code(400);
    23|     exit();
    24| }
    25| $request = Request::createFromGlobals();
    26| $faqConfig = $container->get('phpmyfaq.configuration');
    27| $user = $container->get('phpmyfaq.user.current_user');
    28| if (!$faqConfig->get('security.enableRegistration')) {
    29|     $redirect = new RedirectResponse($faqConfig->getDefaultUrl());
    30|     $redirect->send();
    31| }
    32| $faqSession = $container->get('phpmyfaq.session');
    33| $faqSession->setCurrentUser($user);
    34| $faqSession->userTracking('registration', 0);
    35| $captcha = $container->get('phpmyfaq.captcha');
    36| $captcha->setSessionId($sids);
    37| $captchaHelper = $container->get('phpmyfaq.captcha.helper.captcha_helper');
    38| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    39| $twigTemplate = $twig->loadTemplate('./register.twig');
    40| $templateVars = [
    41|     ... $templateVars,
    42|     'title' => sprintf('%s - %s', Translation::get('msgRegistration'), $faqConfig->getTitle()),
    43|     'lang' => $faqLangCode,
    44|     'isWebAuthnEnabled' => $faqConfig->get('security.enableWebAuthnSupport'),
    45|     'captchaFieldset' => $captchaHelper->renderCaptcha(
    46|         $captcha,
    47|         'register',
    48|         Translation::get('msgCaptcha'),
    49|         $user->isLoggedIn()
    50|     ),
    51| ];
    52| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/request-removal.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| <?php
     2| /**
     3|  * Request removal page.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2018-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2018-02-03
    15|  */
    16| use phpMyFAQ\Session\Token;
    17| use phpMyFAQ\Template\TwigWrapper;
    18| if (!defined('IS_VALID_PHPMYFAQ')) {
    19|     http_response_code(400);
    20|     exit();
    21| }
    22| $faqConfig = $container->get('phpmyfaq.configuration');
    23| $user = $container->get('phpmyfaq.user.current_user');
    24| $faqSession = $container->get('phpmyfaq.session');
    25| $faqSession->setCurrentUser($user);
    26| $faqSession->userTracking('request_removal', 0);
    27| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    28| $twigTemplate = $twig->loadTemplate('./request-removal.twig');
    29| $templateVars = [
    30|     ... $templateVars,
    31|     'privacyURL' => $faqConfig->get('main.privacyURL'),
    32|     'csrf' => Token::getInstance()->getTokenInput('request-removal'),
    33|     'lang' => $Language->getLanguage(),
    34|     'userId' => $user->getUserId(),
    35|     'defaultContentMail' => ($user->getUserId() > 0) ? $user->getUserData('email') : '',
    36|     'defaultContentName' => ($user->getUserId() > 0) ? $user->getUserData('display_name') : '',
    37|     'defaultLoginName' => ($user->getUserId() > 0) ? $user->getLogin() : '',
    38| ];
    39| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/search.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-241 ---
     1| <?php
     2| /**
     3|  * The fulltext search page.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2002-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2002-09-16
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Faq;
    18| use phpMyFAQ\Faq\Permission;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Helper\CategoryHelper;
    21| use phpMyFAQ\Helper\SearchHelper;
    22| use phpMyFAQ\Helper\TagsHelper;
    23| use phpMyFAQ\Language\Plurals;
    24| use phpMyFAQ\Pagination;
    25| use phpMyFAQ\Search;
    26| use phpMyFAQ\Search\SearchResultSet;
    27| use phpMyFAQ\Strings;
    28| use phpMyFAQ\Tags;
    29| use phpMyFAQ\Template\Extensions\TagNameTwigExtension;
    30| use phpMyFAQ\Template\TwigWrapper;
    31| use phpMyFAQ\Translation;
    32| use Symfony\Component\HttpFoundation\Request;
    33| use Symfony\Component\HttpFoundation\Response;
    34| if (!defined('IS_VALID_PHPMYFAQ')) {
    35|     http_response_code(400);
    36|     exit();
    37| }
    38| $faqConfig = $container->get('phpmyfaq.configuration');
    39| $user = $container->get('phpmyfaq.user.current_user');
    40| $faqSession = $container->get('phpmyfaq.session');
    41| $faqSession->setCurrentUser($user);
    42| $faqSession->userTracking('fulltext_search', 0);
    43| $faq = new Faq($faqConfig);
    44| $faq->setUser($currentUser);
    45| $faq->setGroups($currentGroups);
    46| $category = new Category($faqConfig);
    47| $plurals = new Plurals();
    48| $request = Request::createFromGlobals();
    49| $inputLanguage = Filter::filterVar($request->query->get('pmf-all-languages'), FILTER_SANITIZE_SPECIAL_CHARS);
    50| $inputCategory = Filter::filterVar($request->query->get('pmf-search-category'), FILTER_VALIDATE_INT, '%');
    51| $inputSearchTerm = Filter::filterVar($request->query->get('search'), FILTER_SANITIZE_SPECIAL_CHARS);
    52| $inputSearchTerm = Strings::substr($inputSearchTerm, 0, 255);
    53| $inputTag = Filter::filterVar($request->query->get('tagging_id'), FILTER_SANITIZE_SPECIAL_CHARS);
    54| if (!is_null($inputTag)) {
    55|     $inputTag = str_replace(' ', '', (string) $inputTag);
    56|     $inputTag = str_replace(',,', ',', $inputTag);
    57| }
    58| $searchTerm = Filter::filterVar($request->request->get('search'), FILTER_SANITIZE_SPECIAL_CHARS);
    59| $searchTerm = Strings::substr($searchTerm, 0, 255);
    60| $page = Filter::filterVar($request->query->get('seite'), FILTER_VALIDATE_INT, 1);
    61| if ($inputLanguage !== '') {
    62|     $allLanguages = true;
    63|     $languages = '&amp;langs=all';
    64| } else {
    65|     $allLanguages = false;
    66|     $languages = '';
    67| }
    68| if ($allLanguages) {
    69|     $category->transform(0);
    70| }
    71| $faqSearch = new Search($faqConfig);
    72| $faqPermission = new Permission($faqConfig);
    73| $faqSearchResult = new SearchResultSet($user, $faqPermission, $faqConfig);
    74| $tagging = new Tags($faqConfig);
    75| $tagHelper = new TagsHelper();
    76| $tagSearch = false;
    77| if ('' !== $inputTag) {
    78|     $tagSearch = true;
    79|     $tags = [];
    80|     $tagIds = explode(',', (string) $inputTag);
    81|     $relTags = '';
    82|     $tagHelper->setTaggingIds($tagIds);
    83|     foreach ($tagIds as $tagId) {
    84|         if (isset($tags[$tagId])) {
    85|             continue;
    86|         }
    87|         if (!is_numeric($tagId)) {
    88|             continue;
    89|         }
    90|         $tags[$tagId] = $tagging->getTagNameById($tagId);
    91|     }
    92|     $recordIds = $tagging->getFaqsByIntersectionTags($tags);
    93|     if (0 === (is_countable($recordIds) ? count($recordIds) : 0)) {
    94|         $searchResult = '';
    95|     } else {
    96|         $relatedTags = [];
    97|         foreach ($recordIds as $recordId) {
    98|             $resultTags = $tagging->getAllTagsById($recordId);
    99|             foreach (array_keys($resultTags) as $resultTagId) {
   100|                 if (isset($tags[$resultTagId])) {
   101|                     continue;
   102|                 }
   103|                 if (isset($relatedTags[$resultTagId])) {
   104|                     ++$relatedTags[$resultTagId];
   105|                 } else {
   106|                     $relatedTags[$resultTagId] = 1;
   107|                 }
   108|             }
   109|         }
   110|         uasort($relatedTags, static fn($a, $b) => $b - $a);
   111|         $numTags = 0;
   112|         foreach ($relatedTags as $tagId => $relevance) {
   113|             $relTags .= $tagHelper->renderRelatedTag($tagId, $tagging->getTagNameById($tagId), $relevance);
   114|             if ($numTags++ > 20) {
   115|                 break;
   116|             }
   117|         }
   118|         $searchResult = $faq->renderFaqsByFaqIds($recordIds);
   119|     }
   120| } else {
   121|     $searchResult = '';
   122|     $relTags = '';
   123|     $tags = [];
   124| }
   125| if ($inputSearchTerm !== '' || $searchTerm !== '') {
   126|     $searchResults = [];
   127|     if ($inputSearchTerm !== '') {
   128|         $inputSearchTerm = $faqConfig->getDb()->escape(strip_tags($inputSearchTerm));
   129|     }
   130|     if ($searchTerm !== '') {
   131|         $inputSearchTerm = $faqConfig->getDb()->escape(strip_tags($searchTerm));
   132|     }
   133|     $faqSearch->setCategory($category);
   134|     $faqSearch->setCategoryId((int) $inputCategory);
   135|     try {
   136|         $searchResults = $faqSearch->search($inputSearchTerm, $allLanguages);
   137|     } catch (Exception $exception) {
   138|         $faqConfig->getLogger()->debug($exception->getMessage());
   139|     }
   140|     foreach ($searchResults as $faqKey => $faqValue) {
   141|         $checkedFaq = $faq->getFaqResult($faqValue->id, $faqValue->lang);
   142|         if (0 === $faqConfig->getDb()->numRows($checkedFaq)) {
   143|             unset($searchResults[$faqKey]);
   144|         }
   145|     }
   146|     $faqSearchResult->reviewResultSet($searchResults);
   147|     $inputSearchTerm = stripslashes($inputSearchTerm);
   148|     try {
   149|         $faqSearch->logSearchTerm($inputSearchTerm);
   150|     } catch (Exception $exception) {
   151|         $faqConfig->getLogger()->debug($exception->getMessage());
   152|     }
   153| }
   154| $inputCategory = ('%' == $inputCategory) ? 0 : $inputCategory;
   155| $faqSession->userTracking('fulltext_search', $inputSearchTerm);
   156| $numOfResults = $faqSearchResult->getNumberOfResults();
   157| if (
   158|     is_numeric($inputSearchTerm) &&
   159|     PMF_SOLUTION_ID_START_VALUE <= $inputSearchTerm &&
   160|     0 < $numOfResults &&
   161|     $faqConfig->get('search.searchForSolutionId')
   162| ) {
   163|     $response = new Response();
   164|     $response->isRedirect($faqConfig->getDefaultUrl() . 'solution_id_' . $inputSearchTerm . '.html');
   165|     $response->send();
   166|     exit();
   167| }
   168| $category->buildCategoryTree();
   169| $mostPopularSearchData = $faqSearch->getMostPopularSearches($faqConfig->get('search.numberSearchTerms'));
   170| $baseUrl = sprintf(
   171|     '%ssearch.html?search=%s&amp;seite=%d%s&amp;pmf-search-category=%d',
   172|     $faqConfig->getDefaultUrl(),
   173|     urlencode($inputSearchTerm),
   174|     $page,
   175|     $languages,
   176|     $inputCategory
   177| );
   178| $options = [
   179|     'baseUrl' => $baseUrl,
   180|     'total' => $numOfResults,
   181|     'perPage' => $faqConfig->get('records.numberOfRecordsPerPage'),
   182|     'pageParamName' => 'seite',
   183|     'layoutTpl' => '<ul class="pagination justify-content-center">{LAYOUT_CONTENT}</ul>',
   184| ];
   185| $faqPagination = new Pagination($options);
   186| $categoryHelper = new CategoryHelper();
   187| $categoryHelper->setCategory($category);
   188| $searchHelper = new SearchHelper($faqConfig);
   189| $searchHelper->setSearchTerm($inputSearchTerm);
   190| $searchHelper->setCategory($category);
   191| $searchHelper->setPagination($faqPagination);
   192| $searchHelper->setPlurals(new Plurals());
   193| $searchHelper->setSessionId($sids);
   194| $searchResults = [];
   195| if ('' == $searchResult && !is_null($inputSearchTerm)) {
   196|     try {
   197|         $searchResults = $searchHelper->getSearchResult($faqSearchResult, $page);
   198|     } catch (Exception) {
   199|     }
   200| }
   201| $confPerPage = $faqConfig->get('records.numberOfRecordsPerPage');
   202| $totalPages = (int)ceil($numOfResults / $confPerPage);
   203| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
   204| $twig->addExtension(new TagNameTwigExtension());
   205| $twigTemplate = $twig->loadTemplate('./search.twig');
   206| $pageHeader = ($tagSearch ? Translation::get('msgTagSearch') : Translation::get('msgAdvancedSearch'));
   207| $templateVars = [
   208|     ... $templateVars,
   209|     'title' => sprintf('%s - %s', $pageHeader, $faqConfig->getTitle()),
   210|     'pageHeader' => $pageHeader,
   211|     'isTagSearch' => $tagSearch,
   212|     'renderCategoryOptions' => $categoryHelper->renderOptions($inputCategory),
   213|     'msgSearch' => Translation::get('msgSearch'),
   214|     'msgAdvancedSearch' => ($tagSearch ? Translation::get('msgTagSearch') : Translation::get('msgAdvancedSearch')),
   215|     'msgCurrentTags' => Translation::get('msg_tags'),
   216|     'numberOfSearchResults' => $numOfResults,
   217|     'totalPages' => $totalPages,
   218|     'msgPage' => Translation::get('msgPage'),
   219|     'currentPage' => $page,
   220|     'from' => Translation::get('msgVoteFrom'),
   221|     'msgSearchResults' => $plurals->GetMsg('plmsgSearchAmount', $numOfResults),
   222|     'searchTerm' => $searchTerm,
   223|     'searchTags' =>  ($tagSearch ? $tagHelper->renderTagList($tags) : ''),
   224|     'msgSearchWord' => Translation::get('msgSearchWord'),
   225|     'searchResults' => $searchResults,
   226|     'formActionUrl' => '?action=search',
   227|     'searchString' => $inputSearchTerm,
   228|     'searchOnAllLanguages' => Translation::get('msgSearchOnAllLanguages'),
   229|     'checkedAllLanguages' => $allLanguages ? ' checked' : '',
   230|     'selectCategories' => Translation::get('msgSelectCategories'),
   231|     'allCategories' => Translation::get('msgAllCategories'),
   232|     'noSearchResults' => Translation::get('msgErrorNoRecords'),
   233|     'pagination' => $faqPagination->render(),
   234|     'msgMostPopularSearches' => Translation::get('msgMostPopularSearches'),
   235|     'mostPopularSearches' => $mostPopularSearchData,
   236|     'relatedTagsHeader' => Translation::get('msgRelatedTags'),
   237|     'relatedTags' => $relTags,
   238|     'msgTags' => Translation::get('msgPopularTags'),
   239|     'tagList' => $tagging->getPopularTags(),
   240| ];
   241| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/show.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-126 ---
     1| <?php
     2| /**
     3|  * Frontend for categories or list of records.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2002-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2002-08-27
    15|  */
    16| use phpMyFAQ\Category;
    17| use phpMyFAQ\Filter;
    18| use phpMyFAQ\Helper\CategoryHelper;
    19| use phpMyFAQ\Language\Plurals;
    20| use phpMyFAQ\Link;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use phpMyFAQ\Translation;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use Symfony\Component\HttpFoundation\Response;
    25| if (!defined('IS_VALID_PHPMYFAQ')) {
    26|     http_response_code(400);
    27|     exit();
    28| }
    29| $request = Request::createFromGlobals();
    30| $faqConfig = $container->get('phpmyfaq.configuration');
    31| $user = $container->get('phpmyfaq.user.current_user');
    32| $faqSession = $container->get('phpmyfaq.session');
    33| $faqSession->setCurrentUser($user);
    34| $selectedCategoryId = Filter::filterVar($request->query->get('cat'), FILTER_VALIDATE_INT);
    35| $subCategoryContent = null;
    36| if ($selectedCategoryId === 0) {
    37|     $selectedCategoryId = null;
    38| }
    39| if (!is_null($selectedCategoryId) && !isset($category->categoryName[$selectedCategoryId])) {
    40|     $response = new Response();
    41|     $response->setStatusCode(Response::HTTP_NOT_FOUND);
    42| }
    43| $categoryHelper = new CategoryHelper();
    44| $categoryHelper->setPlurals(new Plurals());
    45| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    46| $twigTemplate = $twig->loadTemplate('./show.twig');
    47| if (!is_null($selectedCategoryId) && isset($category->categoryName[$selectedCategoryId])) {
    48|     $faqSession->userTracking('show_category', $selectedCategoryId);
    49|     $categoryData = $category->getCategoryData($selectedCategoryId);
    50|     $records = $faq->renderFaqsByCategoryId(
    51|         $selectedCategoryId,
    52|         $faqConfig->get('records.orderby'),
    53|         $faqConfig->get('records.sortby')
    54|     );
    55|     if (empty($records) || $category->getChildNodes((int) $selectedCategoryId)) {
    56|         $subCategory = new Category($faqConfig, $currentGroups, true);
    57|         $subCategory->setUser($currentUser);
    58|         $subCategory->transform($selectedCategoryId);
    59|         $categoryHelper
    60|             ->setConfiguration($faqConfig)
    61|             ->setCategory($subCategory);
    62|         if (empty($records)) {
    63|             $records = sprintf('<div class="mb-5 alert alert-info">%s</div>', Translation::get('msgErrorNoRecords'));
    64|         }
    65|         if ((is_countable($category->getChildNodes((int) $selectedCategoryId)) ? count($category->getChildNodes((int) $selectedCategoryId)) : 0) !== 0) {
    66|             $categoryFaqsHeader = Translation::get('msgSubCategories');
    67|             $subCategoryContent = $categoryHelper->renderCategoryTree($selectedCategoryId);
    68|             $templateVars = [
    69|                 ... $templateVars,
    70|                 'categorySubsHeader' => $categoryFaqsHeader
    71|             ];
    72|         }
    73|     }
    74|     $up = '';
    75|     if ($categoryData->getId() !== 0) {
    76|         $url = sprintf(
    77|             '%sindex.php?%saction=show&amp;cat=%d',
    78|             $faqConfig->getDefaultUrl(),
    79|             $sids,
    80|             $categoryData->getParentId()
    81|         );
    82|         $text = $category->categoryName[$categoryData->getParentId()]['name'] ?? Translation::get('msgCategoryUp');
    83|         $link = new Link($url, $faqConfig);
    84|         $link->itemTitle = $text;
    85|         $link->text = $text;
    86|         $link->tooltip = Translation::get('msgCategoryUp');
    87|         $up = sprintf('<i class="bi bi-arrow-90deg-up"></i> %s', $link->toHtmlAnchor());
    88|     }
    89|     if (!is_null($categoryData->getImage()) && strlen((string) $categoryData->getImage()) > 0) {
    90|         $categoryImage = $faqConfig->getDefaultUrl() . 'content/user/images/' . $categoryData->getImage();
    91|     }
    92|     $categoryHeader = Translation::get('msgEntriesIn') . $categoryData->getName();
    93|     $templateVars = [
    94|         ... $templateVars,
    95|         'categoryFaqsHeader' => $categoryData->getName(),
    96|         'categoryDescription' => $categoryData->getDescription() ?? '',
    97|         'categorySubsHeader' => Translation::get('msgSubCategories'),
    98|         'categoryImage' => $categoryImage ?? null,
    99|         'categoryContent' => $records,
   100|         'subCategoryContent' => $subCategoryContent,
   101|         'categoryLevelUp' => $up,
   102|     ];
   103| } else {
   104|     $selectedCategoryId = 0;
   105|     $faqSession->userTracking('show_all_categories', 0);
   106|     $categoryHelper
   107|         ->setConfiguration($faqConfig)
   108|         ->setCategory($category);
   109|     $categoryHeader = Translation::get('msgFullCategories');
   110|     $templateVars = [
   111|         ... $templateVars,
   112|         'categoryFaqsHeader' => Translation::get('msgShowAllCategories'),
   113|         'categoryDescription' => Translation::get('msgCategoryDescription'),
   114|         'categorySubsHeader' => Translation::get('msgSubCategories'),
   115|         'categoryContent' => $categoryHelper->renderCategoryTree($selectedCategoryId),
   116|         'subCategoryContent' => Translation::get('msgSubCategoryContent'),
   117|         'categoryLevelUp' => '',
   118|     ];
   119| }
   120| $templateVars = [
   121|     ... $templateVars,
   122|     'title' => sprintf('%s - %s', $categoryHeader, $faqConfig->getTitle()),
   123|     'metaDescription' => sprintf(Translation::get('msgCategoryMetaDesc'), $faqConfig->getTitle()),
   124|     'categoryHeader' => $categoryHeader,
   125| ];
   126| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/sitemap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-52 ---
     1| <?php
     2| /**
     3|  * Sitemap frontend.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thomas Zeithaml <seo@annatom.de>
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @copyright 2005-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2005-08-21
    16|  */
    17| use phpMyFAQ\Filter;
    18| use phpMyFAQ\Strings;
    19| use phpMyFAQ\Template\TwigWrapper;
    20| use phpMyFAQ\Translation;
    21| use Symfony\Component\HttpFoundation\Request;
    22| if (!defined('IS_VALID_PHPMYFAQ')) {
    23|     http_response_code(400);
    24|     exit();
    25| }
    26| $faqConfig = $container->get('phpmyfaq.configuration');
    27| $user = $container->get('phpmyfaq.user.current_user');
    28| $faqSession = $container->get('phpmyfaq.session');
    29| $faqSession->setCurrentUser($user);
    30| $faqSession->userTracking('sitemap', 0);
    31| $request = Request::createFromGlobals();
    32| $letter = Filter::filterVar($request->query->get('letter'), FILTER_SANITIZE_SPECIAL_CHARS);
    33| if (!is_null($letter) && (1 == Strings::strlen($letter))) {
    34|     $currLetter = strtoupper(Strings::substr($letter, 0, 1));
    35| } else {
    36|     $currLetter = '';
    37| }
    38| $siteMap = $container->get('phpmyfaq.sitemap');
    39| $siteMap->setUser($currentUser);
    40| $siteMap->setGroups($currentGroups);
    41| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    42| $twigTemplate = $twig->loadTemplate('./sitemap.twig');
    43| $templateVars = [
    44|     ... $templateVars,
    45|     'title' => sprintf('%s - %s', Translation::get('msgSitemap'), $faqConfig->getTitle()),
    46|     'metaDescription' => sprintf(Translation::get('msgSitemapMetaDesc'), $faqConfig->getTitle()),
    47|     'pageHeader' => $currLetter === '' || $currLetter === '0' ? Translation::get('msgSitemap') : $currLetter,
    48|     'letters' => $siteMap->getAllFirstLetters(),
    49|     'faqs' => $siteMap->getFaqsFromLetter($currLetter),
    50|     'writeCurrentLetter' => $currLetter === '' || $currLetter === '0' ? Translation::get('msgSitemap') : $currLetter,
    51| ];
    52| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Auth/AuthEntraId.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-164 ---
     1| <?php
     2| /**
     3|  * Manages user authentication with Microsoft Entra ID.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2022-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2022-09-09
    15|  */
    16| namespace phpMyFAQ\Auth;
    17| use phpMyFAQ\Auth;
    18| use phpMyFAQ\Auth\Azure\OAuth;
    19| use phpMyFAQ\Configuration;
    20| use phpMyFAQ\Core\Exception;
    21| use phpMyFAQ\Enums\AuthenticationSourceType;
    22| use phpMyFAQ\Session;
    23| use phpMyFAQ\User;
    24| use SensitiveParameter;
    25| use Symfony\Component\HttpFoundation\RedirectResponse;
    26| /**q
    27|  * Class AuthEntraId
    28|  *
    29|  * @package phpMyFAQ\Auth
    30|  */
    31| class AuthEntraId extends Auth implements AuthDriverInterface
    32| {
    33|     private readonly Session $session;
    34|     private string $oAuthVerifier = '';
    35|     private string $oAuthChallenge;
    36|     /** @var string */
    37|     private const ENTRAID_CHALLENGE_METHOD = 'S256';
    38|     /** @var string URL to logout */
    39|     private const ENTRAID_LOGOUT_URL = 'https://login.microsoftonline.com/common/wsfederation?wa=wsignout1.0';
    40|     /**
    41|      * @inheritDoc
    42|      */
    43|     public function __construct(Configuration $configuration, private readonly OAuth $oAuth)
    44|     {
    45|         $this->configuration = $configuration;
    46|         $this->session = new Session($configuration);
    47|         parent::__construct($configuration);
    48|     }
    49|     /**
    50|      * @inheritDoc
    51|      * @throws Exception
    52|      */
    53|     public function create(string $login, #[SensitiveParameter] string $password, string $domain = ''): mixed
    54|     {
    55|         $result = false;
    56|         $user = new User($this->configuration);
    57|         try {
    58|             $result = $user->createUser($login, '', $domain);
    59|         } catch (\Exception $e) {
    60|             $this->configuration->getLogger()->info($e->getMessage());
    61|         }
    62|         $user->setStatus('active');
    63|         $user->setAuthSource(AuthenticationSourceType::AUTH_AZURE->value);
    64|         $user->setUserData(
    65|             [
    66|                 'display_name' => $this->oAuth->getName(),
    67|                 'email' => $this->oAuth->getMail(),
    68|             ]
    69|         );
    70|         return $result;
    71|     }
    72|     /**
    73|      * @inheritDoc
    74|      */
    75|     public function update(string $login, #[SensitiveParameter] string $password): bool
    76|     {
    77|         return true;
    78|     }
    79|     /**
    80|      * @inheritDoc
    81|      */
    82|     public function delete(string $login): bool
    83|     {
    84|         return true;
    85|     }
    86|     /**
    87|      * @inheritDoc
    88|      * @throws Exception
    89|      */
    90|     public function checkCredentials(
    91|         string $login,
    92|         ?array $optionalData = []
    93|     ): bool {
    94|         $this->create($login, '');
    95|         return true;
    96|     }
    97|     /**
    98|      * @inheritDoc
    99|      */
   100|     public function isValidLogin(string $login, ?array $optionalData = []): int
   101|     {
   102|         if ($login === $this->oAuth->getMail()) {
   103|             return 1;
   104|         }
   105|         return 0;
   106|     }
   107|     /**
   108|      * Method to authorize against Entra ID
   109|      *
   110|      * @throws \Exception
   111|      */
   112|     public function authorize(): void
   113|     {
   114|         $this->createOAuthChallenge();
   115|         $this->session->setCurrentSessionKey();
   116|         $this->session->set(Session::PMF_AZURE_AD_OAUTH_VERIFIER, $this->oAuthVerifier);
   117|         $this->session->setCookie(Session::PMF_AZURE_AD_OAUTH_VERIFIER, $this->oAuthVerifier, 7200, false);
   118|         $oAuthURL = sprintf(
   119|             'https://login.microsoftonline.com/%s/oauth2/v2.0/authorize' .
   120|             '?response_type=code&client_id=%s&redirect_uri=%s&scope=%s&code_challenge=%s&code_challenge_method=%s',
   121|             AAD_OAUTH_TENANTID,
   122|             AAD_OAUTH_CLIENTID,
   123|             urlencode($this->configuration->getDefaultUrl() . 'services/azure/callback.php'),
   124|             AAD_OAUTH_SCOPE,
   125|             $this->oAuthChallenge,
   126|             self::ENTRAID_CHALLENGE_METHOD
   127|         );
   128|         $redirectResponse = new RedirectResponse($oAuthURL);
   129|         $redirectResponse->send();
   130|     }
   131|     /**
   132|      * Logout
   133|      *
   134|      */
   135|     public function logout(): void
   136|     {
   137|         $redirectResponse = new RedirectResponse(self::ENTRAID_LOGOUT_URL);
   138|         $redirectResponse->send();
   139|     }
   140|     /**
   141|      * Method to generate code verifier and code challenge for oAuth login.
   142|      * See RFC7636 for details.
   143|      *
   144|      * @throws \Exception
   145|      */
   146|     private function createOAuthChallenge(): void
   147|     {
   148|         $verifier = $this->oAuthVerifier;
   149|         if ($this->oAuthVerifier === '' || $this->oAuthVerifier === '0') {
   150|             $chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-._~';
   151|             $charLen = strlen($chars) - 1;
   152|             $verifier = '';
   153|             for ($i = 0; $i < 128; ++$i) {
   154|                 $verifier .= $chars[random_int(0, $charLen)];
   155|             }
   156|             $this->oAuthVerifier = $verifier;
   157|         }
   158|         $this->oAuthChallenge = str_replace(
   159|             '=',
   160|             '',
   161|             strtr(base64_encode(pack('H*', hash('sha256', $verifier))), '+/', '-_')
   162|         );
   163|     }
   164| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Auth/AuthLdap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-159 ---
     1| <?php
     2| /**
     3|  * Manages user authentication with LDAP server.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Alberto Cabello <alberto@unex.es>
    11|  * @author    Lars Scheithauer <larsscheithauer@googlemail.com>
    12|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    13|  * @copyright 2009-2024 phpMyFAQ Team
    14|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    15|  * @link      https://www.phpmyfaq.de
    16|  * @since     2009-03-01
    17|  */
    18| namespace phpMyFAQ\Auth;
    19| use phpMyFAQ\Auth;
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Core\Exception;
    22| use phpMyFAQ\Enums\AuthenticationSourceType;
    23| use phpMyFAQ\Ldap as LdapCore;
    24| use phpMyFAQ\User;
    25| use SensitiveParameter;
    26| /**
    27|  * Class AuthLdap
    28|  *
    29|  * @package phpMyFAQ\Auth
    30|  */
    31| class AuthLdap extends Auth implements AuthDriverInterface
    32| {
    33|     private ?LdapCore $ldapCore = null;
    34|     /** @var string[] Array of LDAP servers */
    35|     private readonly array $ldapServer;
    36|     /** @var int Active LDAP server */
    37|     private int $activeServer = 0;
    38|     /** @var bool */
    39|     private readonly mixed $multipleServers;
    40|     /**
    41|      * @inheritDoc
    42|      * @throws Exception
    43|      */
    44|     public function __construct(Configuration $configuration)
    45|     {
    46|         $this->configuration = $configuration;
    47|         $this->ldapServer = $this->configuration->getLdapServer();
    48|         $this->multipleServers = $this->configuration->get('ldap.ldap_use_multiple_servers');
    49|         parent::__construct($this->configuration);
    50|         if (0 === (is_countable($this->ldapServer) ? count($this->ldapServer) : 0)) {
    51|             throw new AuthException('An error occurred while contacting LDAP: No configuration found.');
    52|         }
    53|         $this->ldapCore = new LdapCore($this->configuration);
    54|         $this->connect($this->activeServer);
    55|     }
    56|     /**
    57|      * @inheritDoc
    58|      * @throws Exception
    59|      */
    60|     public function create(string $login, #[SensitiveParameter] string $password, string $domain = ''): bool
    61|     {
    62|         $user = new User($this->configuration);
    63|         $result = $user->createUser($login, '', $domain);
    64|         $this->connect($this->activeServer);
    65|         $user->setStatus('active');
    66|         $user->setAuthSource(AuthenticationSourceType::AUTH_LDAP->value);
    67|         $user->setUserData(
    68|             [
    69|                 'display_name' => $this->ldapCore->getCompleteName($login),
    70|                 'email' => $this->ldapCore->getMail($login)
    71|             ]
    72|         );
    73|         return $result;
    74|     }
    75|     /**
    76|      * @inheritDoc
    77|      */
    78|     public function update(string $login, #[SensitiveParameter] string $password): bool
    79|     {
    80|         return true;
    81|     }
    82|     /**
    83|      * @inheritDoc
    84|      */
    85|     public function delete(string $login): bool
    86|     {
    87|         return true;
    88|     }
    89|     /**
    90|      * @inheritDoc
    91|      * @throws AuthException|Exception
    92|      */
    93|     public function checkCredentials(
    94|         string $login,
    95|         ?array $optionalData = null
    96|     ): bool {
    97|         if ('' === trim($password)) {
    98|             throw new AuthException(User::ERROR_USER_INCORRECT_PASSWORD);
    99|         }
   100|         if ($this->multipleServers) {
   101|             foreach (array_keys($this->ldapServer) as $key) {
   102|                 $this->connect($key);
   103|                 $this->activeServer = (int)$key;
   104|                 break;
   105|             }
   106|         }
   107|         $bindLogin = $login;
   108|         if ($this->configuration->get('ldap.ldap_use_domain_prefix')) {
   109|             if (array_key_exists('domain', $optionalData)) {
   110|                 $bindLogin = $optionalData['domain'] . '\\' . $login;
   111|             }
   112|         } else {
   113|             $this->connect($this->activeServer);
   114|             $bindLogin = $this->ldapCore->getDn($login);
   115|         }
   116|         $this->ldapCore = new LdapCore($this->configuration);
   117|         $this->ldapCore->connect(
   118|             $this->ldapServer[$this->activeServer]['ldap_server'],
   119|             $this->ldapServer[$this->activeServer]['ldap_port'],
   120|             $this->ldapServer[$this->activeServer]['ldap_base'],
   121|             $bindLogin,
   122|             htmlspecialchars_decode($password)
   123|         );
   124|         if (!$this->ldapCore->bind($bindLogin, htmlspecialchars_decode($password))) {
   125|             throw new AuthException($this->ldapCore->error);
   126|         }
   127|         $this->create($login, htmlspecialchars_decode($password));
   128|         return true;
   129|     }
   130|     /**
   131|      * @inheritDoc
   132|      */
   133|     public function isValidLogin(string $login, ?array $optionalData = null): int
   134|     {
   135|         if ($this->multipleServers) {
   136|             foreach (array_keys($this->ldapServer) as $key) {
   137|                 $this->connect($key);
   138|                 $this->activeServer = (int)$key;
   139|                 break;
   140|             }
   141|         }
   142|         $this->connect($this->activeServer);
   143|         return strlen((string) $this->ldapCore->getCompleteName($login));
   144|     }
   145|     private function connect(int $activeServer = 0): void
   146|     {
   147|         $this->ldapCore->connect(
   148|             $this->ldapServer[$activeServer]['ldap_server'],
   149|             $this->ldapServer[$activeServer]['ldap_port'],
   150|             $this->ldapServer[$activeServer]['ldap_base'],
   151|             $this->ldapServer[$activeServer]['ldap_user'],
   152|             $this->ldapServer[$activeServer]['ldap_password']
   153|         );
   154|         if ($this->ldapCore->error) {
   155|             $this->configuration->getLogger()->error($this->ldapCore->error);
   156|             $this->errors[] = $this->ldapCore->error;
   157|         }
   158|     }
   159| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Category/Image.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-129 ---
     1| <?php
     2| /**
     3|  * The category image class.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2016-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2016-09-08
    15|  */
    16| namespace phpMyFAQ\Category;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Core\Exception;
    19| use Symfony\Component\HttpFoundation\File\UploadedFile;
    20| /**
    21|  * Class CategoryImage
    22|  *
    23|  * @package phpMyFAQ\Category
    24|  */
    25| class Image
    26| {
    27|     /** @var string */
    28|     private const UPLOAD_DIR = PMF_CONTENT_DIR . '/user/images/';
    29|     private bool $isUpload = false;
    30|     private UploadedFile $uploadedFile;
    31|     private string $fileName = '';
    32|     /**
    33|      * Constructor.
    34|      *
    35|      * @param Configuration $configuration Configuration object
    36|      */
    37|     public function __construct(private readonly Configuration $configuration)
    38|     {
    39|     }
    40|     /**
    41|      * Sets the uploaded file
    42|      */
    43|     public function setUploadedFile(UploadedFile $uploadedFile): Image
    44|     {
    45|         if ($uploadedFile->isValid()) {
    46|             $this->isUpload = true;
    47|         }
    48|         $this->uploadedFile = $uploadedFile;
    49|         return $this;
    50|     }
    51|     /**
    52|      * Returns the filename for the given category ID and language.
    53|      */
    54|     public function getFileName(int $categoryId, string $categoryName): string
    55|     {
    56|         if ($this->isUpload) {
    57|             $this->setFileName(
    58|                 sprintf(
    59|                     'category-%d-%s.%s',
    60|                     $categoryId,
    61|                     $categoryName,
    62|                     $this->getFileExtension($this->uploadedFile->getMimeType())
    63|                 )
    64|             );
    65|         }
    66|         return $this->fileName;
    67|     }
    68|     /**
    69|      * Returns the filename.
    70|      */
    71|     public function setFileName(string $fileName): Image
    72|     {
    73|         $this->fileName = $fileName;
    74|         return $this;
    75|     }
    76|     /**
    77|      * Returns the image file extension from a given MIME type.
    78|      */
    79|     private function getFileExtension(string $mimeType): string
    80|     {
    81|         $mapping = [
    82|             'image/gif' => 'gif',
    83|             'image/jpeg' => 'jpg',
    84|             'image/png' => 'png',
    85|             'image/webp' => 'webp',
    86|         ];
    87|         return $mapping[$mimeType] ?? 'png';
    88|     }
    89|     /**
    90|      * Checks for valid image MIME types, returns true if valid
    91|      */
    92|     private function isValidMimeType(string $contentType): bool
    93|     {
    94|         $types = ['image/jpeg','image/gif','image/png', 'image/webp'];
    95|         return in_array($contentType, $types);
    96|     }
    97|     /**
    98|      * Uploads the current file and moves it into the images/ folder.
    99|      *
   100|      * @throws Exception
   101|      */
   102|     public function upload(): bool
   103|     {
   104|         if (
   105|             $this->isUpload && $this->uploadedFile->isValid()
   106|             && $this->uploadedFile->getSize() < $this->configuration->get('records.maxAttachmentSize')
   107|         ) {
   108|             if (false === $this->uploadedFile->getSize()) {
   109|                 throw new Exception('Cannot detect image size');
   110|             }
   111|             if (!$this->isValidMimeType($this->uploadedFile->getClientMimeType())) {
   112|                 throw new Exception('Image MIME type validation failed.');
   113|             }
   114|             $this->uploadedFile->move(self::UPLOAD_DIR, $this->fileName);
   115|             return true;
   116|         }
   117|         throw new Exception('Uploaded image is too big');
   118|     }
   119|     /**
   120|      * Deletes the current file, returns true, if no file is available.
   121|      */
   122|     public function delete(): bool
   123|     {
   124|         if (is_file(self::UPLOAD_DIR . $this->fileName)) {
   125|             return unlink(self::UPLOAD_DIR . $this->fileName);
   126|         }
   127|         return true;
   128|     }
   129| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Controller/Administration/ConfigurationTabController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-255 ---
     1| <?php
     2| /**
     3|  * The Admin Configuration Tab Controller
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2023-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2023-10-30
    15|  */
    16| namespace phpMyFAQ\Controller\Administration;
    17| use phpMyFAQ\Controller\AbstractController;
    18| use phpMyFAQ\Core\Exception;
    19| use phpMyFAQ\Enums\PermissionType;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Helper\AdministrationHelper;
    22| use phpMyFAQ\Helper\LanguageHelper;
    23| use phpMyFAQ\Helper\PermissionHelper;
    24| use phpMyFAQ\Session\Token;
    25| use phpMyFAQ\Strings;
    26| use phpMyFAQ\System;
    27| use phpMyFAQ\Template\TemplateException;
    28| use phpMyFAQ\Translation;
    29| use Symfony\Component\HttpFoundation\Exception\BadRequestException;
    30| use Symfony\Component\HttpFoundation\JsonResponse;
    31| use Symfony\Component\HttpFoundation\Request;
    32| use Symfony\Component\HttpFoundation\Response;
    33| use Symfony\Component\Routing\Annotation\Route;
    34| class ConfigurationTabController extends AbstractController
    35| {
    36|     /**
    37|      * @throws TemplateException
    38|      * @throws Exception
    39|      */
    40|     public function list(Request $request): Response
    41|     {
    42|         $this->userHasPermission(PermissionType::CONFIGURATION_EDIT);
    43|         $language = $this->container->get('phpmyfaq.language');
    44|         $currentLanguage = $language->setLanguageByAcceptLanguage();
    45|         try {
    46|             Translation::create()
    47|                 ->setLanguagesDir(PMF_LANGUAGE_DIR)
    48|                 ->setDefaultLanguage('en')
    49|                 ->setCurrentLanguage($currentLanguage)
    50|                 ->setMultiByteLanguage();
    51|         } catch (Exception $exception) {
    52|             throw new BadRequestException($exception->getMessage());
    53|         }
    54|         $mode = $request->get('mode');
    55|         $configurationList = Translation::getConfigurationItems($mode);
    56|         return $this->render(
    57|             '@admin/configuration/tab-list.twig',
    58|             [
    59|                 'mode' => $mode,
    60|                 'configurationList' => $configurationList,
    61|                 'configurationData' => $this->configuration->getAll(),
    62|                 'specialCases' => [
    63|                     'ldapSupport' => extension_loaded('ldap'),
    64|                     'useSslForLogins' => Request::createFromGlobals()->isSecure(),
    65|                     'useSslOnly' => Request::createFromGlobals()->isSecure(),
    66|                     'ssoSupport' => Request::createFromGlobals()->server->get('REMOTE_USER'),
    67|                     'buttonTes'
    68|                 ]
    69|             ]
    70|         );
    71|     }
    72|     /**
    73|      * @throws Exception
    74|      */
    75|     public function save(Request $request): JsonResponse
    76|     {
    77|         $this->userHasPermission(PermissionType::CONFIGURATION_EDIT);
    78|         $csrfToken = $request->get('pmf-csrf-token');
    79|         $configurationData = $request->get('edit');
    80|         $oldConfigurationData = $this->configuration->getAll();
    81|         if (!Token::getInstance()->verifyToken('configuration', $csrfToken)) {
    82|             return $this->json(['error' => Translation::get('err_NotAuth')], Response::HTTP_UNAUTHORIZED);
    83|         } else {
    84|             $newConfigValues = [];
    85|             $escapeValues = [
    86|                 'main.contactInformation',
    87|                 'main.customPdfHeader',
    88|                 'main.customPdfFooter',
    89|                 'main.titleFAQ',
    90|             ];
    91|             if (isset($configurationData['main.enableMarkdownEditor'])) {
    92|                 $configurationData['main.enableWysiwygEditor'] = false; // Disable WYSIWYG editor if Markdown is enabled
    93|             }
    94|             if (isset($configurationData['main.currentVersion'])) {
    95|                 unset($configurationData['main.currentVersion']); // don't update the version number
    96|             }
    97|             if (isset($configurationData['records.attachmentsPath'])) {
    98|                 if (false !== realpath($configurationData['records.attachmentsPath'])) {
    99|                     $configurationData['records.attachmentsPath'] = str_replace(
   100|                         Request::createFromGlobals()->server->get('DOCUMENT_ROOT') . DIRECTORY_SEPARATOR,
   101|                         '',
   102|                         realpath($configurationData['records.attachmentsPath'])
   103|                     );
   104|                 } else {
   105|                     unset($configurationData['records.attachmentsPath']);
   106|                 }
   107|             }
   108|             if (
   109|                 isset($configurationData['main.referenceURL']) &&
   110|                 is_null(Filter::filterVar($configurationData['main.referenceURL'], FILTER_VALIDATE_URL))
   111|             ) {
   112|                 unset($configurationData['main.referenceURL']);
   113|             }
   114|             $newConfigClass = [];
   115|             foreach ($configurationData as $key => $value) {
   116|                 $newConfigValues[$key] = (string) $value;
   117|                 if (isset($escapeValues[$key])) {
   118|                     $newConfigValues[$key] = Strings::htmlspecialchars($value, ENT_QUOTES);
   119|                 }
   120|                 $keyArray = array_values(explode('.', (string) $key));
   121|                 $newConfigClass = array_shift($keyArray);
   122|             }
   123|             foreach ($oldConfigurationData as $key => $value) {
   124|                 $keyArray = array_values(explode('.', (string) $key));
   125|                 $oldConfigClass = array_shift($keyArray);
   126|                 if (isset($newConfigValues[$key])) {
   127|                     continue;
   128|                 }
   129|                 if ($oldConfigClass === $newConfigClass && $value === 'true') {
   130|                     $newConfigValues[$key] = 'false';
   131|                 } else {
   132|                     $newConfigValues[$key] = $value;
   133|                 }
   134|             }
   135|             if ($oldConfigurationData['main.referenceURL'] !== $newConfigValues['main.referenceURL']) {
   136|                 $this->configuration->replaceMainReferenceUrl(
   137|                     $oldConfigurationData['main.referenceURL'],
   138|                     $newConfigValues['main.referenceURL']
   139|                 );
   140|             }
   141|             $this->configuration->update($newConfigValues);
   142|             return $this->json(['success' => Translation::get('ad_config_saved')], Response::HTTP_OK);
   143|         }
   144|     }
   145|     /**
   146|      * @throws Exception
   147|      */
   148|     public function translations(): Response
   149|     {
   150|         $this->userIsAuthenticated();
   151|         $response = new Response();
   152|         $languages = LanguageHelper::getAvailableLanguages();
   153|         if ($languages !== []) {
   154|             return $response->setContent(LanguageHelper::renderLanguageOptions(
   155|                 str_replace(
   156|                     [ 'language_', '.php', ],
   157|                     '',
   158|                     (string) $this->configuration->get('main.language')
   159|                 ),
   160|                 false,
   161|                 true
   162|             ));
   163|         }
   164|         return $response->setContent('<option value="language_en.php">English</option>');
   165|     }
   166|     /**
   167|      * @throws Exception
   168|      */
   169|     public function templates(): Response
   170|     {
   171|         $this->userIsAuthenticated();
   172|         $response = new Response();
   173|         $faqSystem = new System();
   174|         $templates = $faqSystem->getAvailableTemplates();
   175|         $htmlString = '';
   176|         foreach ($templates as $template => $selected) {
   177|             $htmlString .= sprintf(
   178|                 '<option%s>%s</option>',
   179|                 ($selected === true ? ' selected' : ''),
   180|                 $template
   181|             );
   182|         }
   183|         return $response->setContent($htmlString);
   184|     }
   185|     /**
   186|      * @throws Exception
   187|      */
   188|     public function faqsSortingKey(Request $request): Response
   189|     {
   190|         $this->userIsAuthenticated();
   191|         return new Response(
   192|             AdministrationHelper::sortingKeyOptions($request->get('current'))
   193|         );
   194|     }
   195|     /**
   196|      * @throws Exception
   197|      */
   198|     public function faqsSortingOrder(Request $request): Response
   199|     {
   200|         $this->userIsAuthenticated();
   201|         return new Response(
   202|             AdministrationHelper::sortingOrderOptions($request->get('current'))
   203|         );
   204|     }
   205|     /**
   206|      * @throws Exception
   207|      */
   208|     public function faqsSortingPopular(Request $request): Response
   209|     {
   210|         $this->userIsAuthenticated();
   211|         return new Response(
   212|             AdministrationHelper::sortingPopularFaqsOptions($request->get('current'))
   213|         );
   214|     }
   215|     /**
   216|      * @throws Exception
   217|      */
   218|     public function permLevel(Request $request): Response
   219|     {
   220|         $this->userIsAuthenticated();
   221|         return new Response(
   222|             PermissionHelper::permOptions($request->get('current'))
   223|         );
   224|     }
   225|     /**
   226|      * @throws Exception
   227|      */
   228|     public function releaseEnvironment(Request $request): Response
   229|     {
   230|         $this->userIsAuthenticated();
   231|         return new Response(
   232|             AdministrationHelper::renderReleaseTypeOptions($request->get('current'))
   233|         );
   234|     }
   235|     /**
   236|      * @throws Exception
   237|      */
   238|     public function searchRelevance(Request $request): Response
   239|     {
   240|         $this->userIsAuthenticated();
   241|         return new Response(
   242|             AdministrationHelper::searchRelevanceOptions($request->get('current'))
   243|         );
   244|     }
   245|     /**
   246|      * @throws Exception
   247|      */
   248|     public function seoMetaTags(Request $request): Response
   249|     {
   250|         $this->userIsAuthenticated();
   251|         return new Response(
   252|             AdministrationHelper::renderMetaRobotsDropdown($request->get('current'))
   253|         );
   254|     }
   255| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Controller/Frontend/SetupController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-141 ---
     1| <?php
     2| /**
     3|  * The Setup Controller
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2024-06-01
    15|  */
    16| namespace phpMyFAQ\Controller\Frontend;
    17| use Elastic\Elasticsearch\Exception\AuthenticationException;
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Core\Exception;
    20| use phpMyFAQ\Filter;
    21| use phpMyFAQ\Language\LanguageCodes;
    22| use phpMyFAQ\Setup\Installer;
    23| use phpMyFAQ\Setup\Update;
    24| use phpMyFAQ\System;
    25| use phpMyFAQ\Template\TemplateException;
    26| use phpMyFAQ\Template\TwigWrapper;
    27| use Symfony\Component\HttpFoundation\Request;
    28| use Symfony\Component\HttpFoundation\Response;
    29| use Symfony\Component\Routing\Annotation\Route;
    30| class SetupController
    31| {
    32|     /**
    33|      * @throws TemplateException
    34|      * @throws \Exception
    35|      */
    36|     public function index(Request $request): Response
    37|     {
    38|         $system = new System();
    39|         $installer = new Installer($system);
    40|         $checkBasicError = '';
    41|         try {
    42|             $installer->checkBasicStuff();
    43|         } catch (Exception $e) {
    44|             $checkBasicError = $e->getMessage();
    45|         }
    46|         try {
    47|             $installer->checkInitialRewriteBasePath($request);
    48|         } catch (Exception $e) {
    49|             $checkBasicError = $e->getMessage();
    50|         }
    51|         return $this->render(
    52|             '@setup/index.twig',
    53|             [
    54|                 'newVersion' => System::getVersion(),
    55|                 'setupType' => 'Setup',
    56|                 'currentYear' => date('Y'),
    57|                 'currentLanguage' => 'en',
    58|                 'documentationUrl' => System::getDocumentationUrl(),
    59|                 'checkBasicError' => $checkBasicError,
    60|                 'nonCriticalSettings' => $installer->checkNoncriticalSettings(),
    61|                 'filePermissions' => $installer->checkFilesystemPermissions(),
    62|                 'supportedDatabases' => $system->getSupportedSafeDatabases(),
    63|                 'currentPath' => dirname(__DIR__, 4),
    64|                 'isLdapEnabled' => $installer->hasLdapSupport(),
    65|                 'isElasticsearchEnabled' => $installer->hasElasticsearchSupport(),
    66|                 'supportedTranslations' => LanguageCodes::getAllSupported(),
    67|             ]
    68|         );
    69|     }
    70|     /**
    71|      * @throws TemplateException
    72|      * @throws \Exception
    73|      */
    74|     public function install(): Response
    75|     {
    76|         $system = new System();
    77|         $installer = new Installer($system);
    78|         $installationError = '';
    79|         try {
    80|             $installer->startInstall();
    81|         } catch (Exception | AuthenticationException $e) {
    82|             $installationError = $e->getMessage();
    83|         }
    84|         return $this->render(
    85|             '@setup/install.twig',
    86|             [
    87|                 'newVersion' => System::getVersion(),
    88|                 'setupType' => 'Setup',
    89|                 'currentYear' => date('Y'),
    90|                 'documentationUrl' => System::getDocumentationUrl(),
    91|                 'installationError' => $installationError,
    92|             ]
    93|         );
    94|     }
    95|     /**
    96|      * @throws TemplateException
    97|      * @throws Exception
    98|      * @throws \Exception
    99|      */
   100|     public function update(Request $request): Response
   101|     {
   102|         $currentStep = Filter::filterVar($request->get('step'), FILTER_VALIDATE_INT);
   103|         $configuration = Configuration::getConfigurationInstance();
   104|         $update = new Update(new System(), $configuration);
   105|         $checkBasicError = '';
   106|         try {
   107|             $update->checkInitialRewriteBasePath($request);
   108|         } catch (Exception $e) {
   109|             $checkBasicError = $e->getMessage();
   110|         }
   111|         return $this->render(
   112|             '@setup/update.twig',
   113|             [
   114|                 'currentStep' => $currentStep ?? 1,
   115|                 'installedVersion' => $configuration->getVersion(),
   116|                 'newVersion' => System::getVersion(),
   117|                 'checkBasicError' => $checkBasicError,
   118|                 'currentYear' => date('Y'),
   119|                 'documentationUrl' => System::getDocumentationUrl(),
   120|                 'configTableNotAvailable' => $update->isConfigTableNotAvailable($configuration->getDb()),
   121|             ]
   122|         );
   123|     }
   124|     /**
   125|      * Returns a Twig rendered template as response.
   126|      *
   127|      * @param string        $pathToTwigFile
   128|      * @param string[]      $templateVars
   129|      * @param Response|null $response
   130|      * @return Response
   131|      * @throws Exception
   132|      */
   133|     public function render(string $pathToTwigFile, array $templateVars = [], ?Response $response = null): Response
   134|     {
   135|         $response ??= new Response();
   136|         $twigWrapper = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates', true);
   137|         $template = $twigWrapper->loadTemplate($pathToTwigFile);
   138|         $response->setContent($template->render($templateVars));
   139|         return $response;
   140|     }
   141| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Controller/SitemapController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-45 ---
     1| <?php
     2| /**
     3|  * The XML Sitemap Controller
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2024-06-16
    15|  */
    16| namespace phpMyFAQ\Controller;
    17| use phpMyFAQ\Core\Exception;
    18| use phpMyFAQ\Template\TemplateException;
    19| use Symfony\Component\HttpFoundation\Response;
    20| class SitemapController extends AbstractController
    21| {
    22|     private const PMF_SITEMAP_GOOGLE_MAX_URLS = 50000;
    23|     /**
    24|      * @throws TemplateException|Exception|\Exception
    25|      */
    26|     public function index(): Response
    27|     {
    28|         $response = new Response();
    29|         $faqStatistics = $this->container->get('phpmyfaq.faq.statistics');
    30|         $items = $faqStatistics->getTopTenData(self::PMF_SITEMAP_GOOGLE_MAX_URLS - 1);
    31|         $urls = [];
    32|         foreach ($items as $item) {
    33|             $urls[] = [
    34|                 'loc' => $item['url'],
    35|                 'lastmod' => $item['date'],
    36|                 'priority' => '1.00',
    37|             ];
    38|         }
    39|         $xml = $this->renderView('./sitemap.xml.twig', ['urls' => $urls]);
    40|         $response->headers->set('Content-Type', 'text/xml');
    41|         $response->setStatusCode(Response::HTTP_OK);
    42|         $response->setContent($xml);
    43|         return $response;
    44|     }
    45| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Controller/WebAuthnController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-122 ---
     1| <?php
     2| /**
     3|  * The WebAuthn Controller
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2024-09-11
    15|  */
    16| namespace phpMyFAQ\Controller;
    17| use phpMyFAQ\Core\Exception;
    18| use phpMyFAQ\Helper\LanguageHelper;
    19| use phpMyFAQ\System;
    20| use phpMyFAQ\Template\TwigWrapper;
    21| use phpMyFAQ\Translation;
    22| use phpMyFAQ\User\CurrentUser;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use Symfony\Component\HttpFoundation\Response;
    25| use Symfony\Component\Routing\Annotation\Route;
    26| class WebAuthnController extends AbstractController
    27| {
    28|     public function __construct()
    29|     {
    30|         parent::__construct();
    31|     }
    32|     /**
    33|      * @throws Exception
    34|      */
    35|     public function index(Request $request): Response
    36|     {
    37|         $system = new System();
    38|         $user = CurrentUser::getCurrentUser($this->configuration);
    39|         $topNavigation = [
    40|             [
    41|                 'name' => Translation::get('msgShowAllCategories'),
    42|                 'link' => './show-categories.html',
    43|                 'active' => '',
    44|             ],
    45|             [
    46|                 'name' => Translation::get('msgAddContent'),
    47|                 'link' => './add-faq.html',
    48|                 'active' => '',
    49|             ],
    50|             [
    51|                 'name' => Translation::get('msgQuestion'),
    52|                 'link' => './add-question.html',
    53|                 'active' => '',
    54|             ],
    55|             [
    56|                 'name' => Translation::get('msgOpenQuestions'),
    57|                 'link' => './open-questions.html',
    58|                 'active' => '',
    59|             ],
    60|         ];
    61|         $footerNavigation = [
    62|             [
    63|                 'name' => Translation::get('faqOverview'),
    64|                 'link' => './overview.html',
    65|                 'active' => '',
    66|             ],
    67|             [
    68|                 'name' => Translation::get('msgSitemap'),
    69|                 'link' => './sitemap/A/' . $this->configuration->getDefaultLanguage() . '.html',
    70|                 'active' => '',
    71|             ],
    72|             [
    73|                 'name' => Translation::get('ad_menu_glossary'),
    74|                 'link' => './glossary.html',
    75|                 'active' => '',
    76|             ],
    77|             [
    78|                 'name' => Translation::get('msgContact'),
    79|                 'link' => './contact.html',
    80|                 'active' => '',
    81|             ],
    82|         ];
    83|         return $this->render(
    84|             '/webauthn.twig',
    85|             [
    86|                 'isMaintenanceMode' => $this->configuration->get('main.maintenanceMode'),
    87|                 'isCompletelySecured' => $this->configuration->get('security.enableLoginOnly'),
    88|                 'isDebugEnabled' => DEBUG,
    89|                 'richSnippetsEnabled' => $this->configuration->get('seo.enableRichSnippets'),
    90|                 'tplSetName' => TwigWrapper::getTemplateSetName(),
    91|                 'msgLoginUser' => Translation::get('msgLoginUser'),
    92|                 'isUserLoggedIn' => $user->isLoggedIn(),
    93|                 'title' => Translation::get('msgLoginUser'),
    94|                 'baseHref' => $system->getSystemUri($this->configuration),
    95|                 'customCss' => $this->configuration->getCustomCss(),
    96|                 'version' => $this->configuration->getVersion(),
    97|                 'header' => str_replace('"', '', $this->configuration->getTitle()),
    98|                 'metaPublisher' => $this->configuration->get('main.metaPublisher'),
    99|                 'metaLanguage' => Translation::get('metaLanguage'),
   100|                 'phpmyfaqVersion' => $this->configuration->getVersion(),
   101|                 'stylesheet' => Translation::get('direction') == 'rtl' ? 'style.rtl' : 'style',
   102|                 'currentPageUrl' => $request->getSchemeAndHttpHost() . $request->getRequestUri(),
   103|                 'dir' => Translation::get('direction'),
   104|                 'searchBox' => Translation::get('msgSearch'),
   105|                 'faqHome' => $this->configuration->getDefaultUrl(),
   106|                 'topNavigation' => $topNavigation,
   107|                 'footerNavigation' => $footerNavigation,
   108|                 'languageBox' => Translation::get('msgLanguageSubmit'),
   109|                 'switchLanguages' =>
   110|                     LanguageHelper::renderSelectLanguage($this->configuration->getDefaultLanguage(), true),
   111|                 'copyright' => System::getPoweredByString(true),
   112|                 'isUserRegistrationEnabled' => $this->configuration->get('security.enableRegistration'),
   113|                 'msgRegisterUser' => Translation::get('msgRegisterUser'),
   114|                 'isPrivacyLinkEnabled' => $this->configuration->get('layout.enablePrivacyLink'),
   115|                 'urlPrivacyLink' => $this->configuration->get('main.privacyURL'),
   116|                 'msgPrivacyNote' => Translation::get('msgPrivacyNote'),
   117|                 'isCookieConsentEnabled' => $this->configuration->get('layout.enableCookieConsent'),
   118|                 'cookiePreferences' => Translation::get('cookiePreferences')
   119|             ]
   120|         );
   121|     }
   122| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Helper/FaqHelper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-172 ---
     1| <?php
     2| /**
     3|  * Helper class for phpMyFAQ FAQs.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL wasn't distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ\Helper
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2010-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2010-11-12
    15|  */
    16| namespace phpMyFAQ\Helper;
    17| use League\CommonMark\CommonMarkConverter;
    18| use League\CommonMark\Exception\CommonMarkException;
    19| use phpMyFAQ\Category;
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Entity\FaqEntity;
    22| use phpMyFAQ\Faq;
    23| use phpMyFAQ\Language\LanguageCodes;
    24| use phpMyFAQ\Link;
    25| use phpMyFAQ\Utils;
    26| use Symfony\Component\HtmlSanitizer\HtmlSanitizer;
    27| use Symfony\Component\HtmlSanitizer\HtmlSanitizerConfig;
    28| use Symfony\Component\HttpFoundation\Request;
    29| /**
    30|  * Class FaqHelper
    31|  *
    32|  * @package phpMyFAQ\Helper
    33|  */
    34| class FaqHelper extends AbstractHelper
    35| {
    36|     /**
    37|      * Constructor.
    38|      */
    39|     public function __construct(Configuration $configuration)
    40|     {
    41|         $this->configuration = $configuration;
    42|     }
    43|     /**
    44|      * Rewrites the CSS class generated by TinyMCE for HighlightJS.
    45|      */
    46|     public function rewriteLanguageMarkupClass(string $answer): string
    47|     {
    48|         return str_replace('class="language-markup"', 'class="language-html"', $answer);
    49|     }
    50|     /**
    51|      * Extends URL fragments (e.g. <a href="#foo">) with the full default URL.
    52|      */
    53|     public function rewriteUrlFragments(string $answer, string $currentUrl): string
    54|     {
    55|         return str_replace('href="#', 'href="' . $currentUrl . '#', $answer);
    56|     }
    57|     /**
    58|      * Renders a select box with all translations of a FAQ.
    59|      *
    60|      * @param Faq $faq
    61|      * @param int $categoryId
    62|      * @return string
    63|      * @todo This method should be moved to a Twig macro.
    64|      * @deprecated Rewrite this method to use Twig, will be removed in v4.1
    65|      */
    66|     public function renderChangeLanguageSelector(Faq $faq, int $categoryId): string
    67|     {
    68|         $html = '';
    69|         $faqUrl = sprintf(
    70|             '?action=faq&amp;cat=%d&amp;id=%d&amp;artlang=%%s',
    71|             $categoryId,
    72|             $faq->faqRecord['id']
    73|         );
    74|         $oLink = new Link($this->configuration->getDefaultUrl() . $faqUrl, $this->configuration);
    75|         $oLink->itemTitle = $faq->faqRecord['title'];
    76|         $availableLanguages = $this->configuration->getLanguage()->isLanguageAvailable($faq->faqRecord['id']);
    77|         if ((is_countable($availableLanguages) ? count($availableLanguages) : 0) > 1) {
    78|             $html = '<form method="post">';
    79|             $html .= '<select class="form-select" name="language" ';
    80|             $html .= 'onchange="top.location.href = this.options[this.selectedIndex].value;">';
    81|             foreach ($availableLanguages as $availableLanguage) {
    82|                 $html .= sprintf('<option value="%s"', sprintf($oLink->toString(), $availableLanguage));
    83|                 $html .= ($faq->faqRecord['lang'] === $availableLanguage ? ' selected' : '');
    84|                 $html .= sprintf('>%s</option>', LanguageCodes::get($availableLanguage));
    85|             }
    86|             $html .= '</select></form>';
    87|         }
    88|         return $html;
    89|     }
    90|     /**
    91|      * Renders a preview of the answer
    92|      *
    93|      * @param string $answer The answer to be previewed
    94|      * @param int    $wordCount The number of words to display in the preview
    95|      * @return string The preview of the answer
    96|      * @throws CommonMarkException
    97|      */
    98|     public function renderAnswerPreview(string $answer, int $wordCount): string
    99|     {
   100|         if ($this->configuration->get('main.enableMarkdownEditor')) {
   101|             $markdownConverter = new CommonMarkConverter([
   102|                 'html_input' => 'strip',
   103|                 'allow_unsafe_links' => false,
   104|             ]);
   105|             $cleanedAnswer = $markdownConverter->convert($answer)->getContent();
   106|             return Utils::chopString(strip_tags($cleanedAnswer), $wordCount);
   107|         }
   108|         return Utils::chopString(strip_tags($answer), $wordCount);
   109|     }
   110|     /**
   111|      * Creates an overview with all categories with their FAQs.
   112|      *
   113|      * @param Category $category
   114|      * @param Faq      $faq
   115|      * @param string   $language
   116|      * @return array
   117|      */
   118|     public function createOverview(Category $category, Faq $faq, string $language = ''): array
   119|     {
   120|         $category->transform(0);
   121|         $faq->getAllFaqs(FAQ_SORTING_TYPE_CATID_FAQID, ['lang' => $language, 'active' => 'yes']);
   122|         return $faq->faqRecords;
   123|     }
   124|     /**
   125|      * Returns the URL for a given FAQ Entity and category ID.
   126|      */
   127|     public function createFaqUrl(FaqEntity $faqEntity, int $categoryId): string
   128|     {
   129|         return sprintf(
   130|             '%s?action=faq&cat=%d&id=%d&artlang=%s',
   131|             $this->configuration->getDefaultUrl() . 'index.php',
   132|             $categoryId,
   133|             $faqEntity->getId(),
   134|             $faqEntity->getLanguage()
   135|         );
   136|     }
   137|     /**
   138|      * Remove <script> tags, we don't need them
   139|      */
   140|     public function cleanUpContent(string $content): string
   141|     {
   142|         $contentLength = strlen($content);
   143|         $allowedMediaHosts = $this->configuration->getAllowedMediaHosts();
   144|         $allowedMediaHosts[] = Request::createFromGlobals()->getHost();
   145|         $htmlSanitizer = new HtmlSanitizer(
   146|             (new HtmlSanitizerConfig())
   147|                 ->withMaxInputLength($contentLength + 1)
   148|                 ->allowSafeElements()
   149|                 ->allowRelativeLinks()
   150|                 ->allowStaticElements()
   151|                 ->allowRelativeMedias()
   152|                 ->forceHttpsUrls($this->configuration->get('security.useSslOnly'))
   153|                 ->allowElement('iframe', ['title', 'src', 'width', 'height', 'allow', 'allowfullscreen'])
   154|                 ->allowMediaSchemes(['https', 'http', 'mailto', 'data'])
   155|                 ->allowMediaHosts($allowedMediaHosts)
   156|         );
   157|         $sanitizedContent = $htmlSanitizer->sanitize($content);
   158|         $sanitizedContent = preg_replace('/<iframe\b(?:(?!src)[^>])*>\s*<\/iframe>/i', '', $sanitizedContent);
   159|         return preg_replace_callback(
   160|             '/style\s*=\s*"([^"]*)"/i',
   161|             function ($matches) {
   162|                 $styles = explode(';', $matches[1]);
   163|                 $filteredStyles = array_filter($styles, function ($style) {
   164|                     return stripos(trim($style), 'overflow:') !== 0; // Exclude 'overflow' properties
   165|                 });
   166|                 $newStyle = implode('; ', $filteredStyles);
   167|                 return $newStyle ? 'style="' . $newStyle . '"' : ''; // Remove style attribute if empty
   168|             },
   169|             $sanitizedContent
   170|         );
   171|     }
   172| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Session.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-401 ---
     1| <?php
     2| /**
     3|  * The main Session class.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2007-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2007-03-31
    15|  */
    16| namespace phpMyFAQ;
    17| use Exception;
    18| use phpMyFAQ\Enums\SessionActionType;
    19| use phpMyFAQ\User\CurrentUser;
    20| use Random\RandomException;
    21| use stdClass;
    22| use Symfony\Component\HttpFoundation\IpUtils;
    23| use Symfony\Component\HttpFoundation\Request;
    24| /**
    25|  * Class Session
    26|  *
    27|  * @package phpMyFAQ
    28|  */
    29| class Session
    30| {
    31|     /** @var string Name of the "remember me" cookie */
    32|     final public const PMF_COOKIE_NAME_REMEMBERME = 'pmf_rememberme';
    33|     /** @var string Name of the session cookie */
    34|     final public const PMF_COOKIE_NAME_SESSIONID = 'pmf_sid';
    35|     /** @var string Name of the session GET parameter */
    36|     final public const PMF_GET_KEY_NAME_SESSIONID = 'sid';
    37|     /** @var string EntraID session key */
    38|     final public const PMF_AZURE_AD_SESSIONKEY = 'phpmyfaq_aad_sessionkey';
    39|     /** @var string */
    40|     final public const PMF_AZURE_AD_OAUTH_VERIFIER = 'phpmyfaq_azure_ad_oauth_verifier';
    41|     /** @var string */
    42|     final public const PMF_AZURE_AD_JWT = 'phpmyfaq_azure_ad_jwt';
    43|     private ?int $currentSessionId = null;
    44|     private string $currentSessionKey;
    45|     private ?CurrentUser $currentUser = null;
    46|     public function __construct(private readonly Configuration $configuration)
    47|     {
    48|         $this->createCurrentSessionKey();
    49|     }
    50|     /**
    51|      * Returns the current session ID.
    52|      */
    53|     public function getCurrentSessionId(): ?int
    54|     {
    55|         return $this->currentSessionId;
    56|     }
    57|     /**
    58|      * Sets the current session ID.
    59|      */
    60|     public function setCurrentSessionId(int $currentSessionId): Session
    61|     {
    62|         $this->currentSessionId = $currentSessionId;
    63|         return $this;
    64|     }
    65|     /**
    66|      * Sets current User object
    67|      */
    68|     public function setCurrentUser(CurrentUser $currentUser): Session
    69|     {
    70|         $this->currentUser = $currentUser;
    71|         return $this;
    72|     }
    73|     /**
    74|      * Returns the current UUID session key
    75|      */
    76|     public function getCurrentSessionKey(): ?string
    77|     {
    78|         return $this->currentSessionKey ?? $this->get(self::PMF_AZURE_AD_SESSIONKEY);
    79|     }
    80|     /**
    81|      * Sets the current UUID session key
    82|      *
    83|      * @throws Exception
    84|      */
    85|     public function setCurrentSessionKey(): Session
    86|     {
    87|         if (!isset($this->currentSessionKey)) {
    88|             $this->createCurrentSessionKey();
    89|         }
    90|         $this->set(self::PMF_AZURE_AD_SESSIONKEY, $this->currentSessionKey);
    91|         return $this;
    92|     }
    93|     /**
    94|      * Creates the current UUID session key
    95|      */
    96|     public function createCurrentSessionKey(): void
    97|     {
    98|         $this->currentSessionKey = $this->uuid();
    99|     }
   100|     public function set(string $key, string $value): void
   101|     {
   102|         $_SESSION[$key] = $value;
   103|     }
   104|     public function get(string $key): string
   105|     {
   106|         return $_SESSION[$key] ?? '';
   107|     }
   108|     /**
   109|      * Returns the timestamp of a session.
   110|      *
   111|      * @param int $sessionId Session ID
   112|      */
   113|     public function getTimeFromSessionId(int $sessionId): int
   114|     {
   115|         $timestamp = 0;
   116|         $query = sprintf('SELECT time FROM %sfaqsessions WHERE sid = %d', Database::getTablePrefix(), $sessionId);
   117|         $result = $this->configuration->getDb()->query($query);
   118|         if ($result) {
   119|             $res = $this->configuration->getDb()->fetchObject($result);
   120|             $timestamp = $res->time;
   121|         }
   122|         return $timestamp;
   123|     }
   124|     /**
   125|      * Returns all session from a date.
   126|      *
   127|      * @param int $firstHour First hour
   128|      * @param int $lastHour Last hour
   129|      *
   130|      * @return array<int, string[]>
   131|      */
   132|     public function getSessionsByDate(int $firstHour, int $lastHour): array
   133|     {
   134|         $sessions = [];
   135|         $query = sprintf(
   136|             'SELECT sid, ip, time FROM %sfaqsessions WHERE time > %d AND time < %d ORDER BY time',
   137|             Database::getTablePrefix(),
   138|             $firstHour,
   139|             $lastHour
   140|         );
   141|         $result = $this->configuration->getDb()->query($query);
   142|         while ($row = $this->configuration->getDb()->fetchObject($result)) {
   143|             $sessions[$row->sid] = [
   144|                 'ip' => $row->ip,
   145|                 'time' => $row->time,
   146|             ];
   147|         }
   148|         return $sessions;
   149|     }
   150|     /**
   151|      * Returns the number of sessions.
   152|      */
   153|     public function getNumberOfSessions(): int
   154|     {
   155|         $num = 0;
   156|         $query = sprintf('SELECT COUNT(sid) as num_sessions FROM %sfaqsessions', Database::getTablePrefix());
   157|         $result = $this->configuration->getDb()->query($query);
   158|         if ($result) {
   159|             $row = $this->configuration->getDb()->fetchObject($result);
   160|             $num = $row->num_sessions;
   161|         }
   162|         return $num;
   163|     }
   164|     /**
   165|      * Deletes the sessions for a given timespan.
   166|      *
   167|      * @param int $first First session ID
   168|      * @param int $last Last session ID
   169|      */
   170|     public function deleteSessions(int $first, int $last): bool
   171|     {
   172|         $query = sprintf(
   173|             'DELETE FROM %sfaqsessions WHERE time >= %d AND time <= %d',
   174|             Database::getTablePrefix(),
   175|             $first,
   176|             $last
   177|         );
   178|         $this->configuration->getDb()->query($query);
   179|         return true;
   180|     }
   181|     /**
   182|      * Deletes all entries in the table.
   183|      */
   184|     public function deleteAllSessions(): mixed
   185|     {
   186|         $query = sprintf('DELETE FROM %sfaqsessions', Database::getTablePrefix());
   187|         return $this->configuration->getDb()->query($query);
   188|     }
   189|     /**
   190|      * Checks the Session ID.
   191|      *
   192|      * @param int    $sessionIdToCheck Session ID
   193|      * @param string $ipAddress IP
   194|      */
   195|     public function checkSessionId(int $sessionIdToCheck, string $ipAddress): void
   196|     {
   197|         $query = sprintf(
   198|             "SELECT sid FROM %sfaqsessions WHERE sid = %d AND ip = '%s' AND time > %d",
   199|             Database::getTablePrefix(),
   200|             $sessionIdToCheck,
   201|             $ipAddress,
   202|             Request::createFromGlobals()->server->get('REQUEST_TIME') - 86400
   203|         );
   204|         $result = $this->configuration->getDb()->query($query);
   205|         if ($this->configuration->getDb()->numRows($result) == 0) {
   206|             $this->userTracking(SessionActionType::OLD_SESSION->value, $sessionIdToCheck);
   207|         } else {
   208|             $this->setCurrentSessionId($sessionIdToCheck);
   209|             $query = sprintf(
   210|                 "UPDATE %sfaqsessions SET time = %d, user_id = %d WHERE sid = %d AND ip = '%s'",
   211|                 Database::getTablePrefix(),
   212|                 Request::createFromGlobals()->server->get('REQUEST_TIME'),
   213|                 $this->currentUser->getUserId(),
   214|                 $sessionIdToCheck,
   215|                 $ipAddress
   216|             );
   217|             $this->configuration->getDb()->query($query);
   218|         }
   219|     }
   220|     /**
   221|      * Returns the botIgnoreList as an array.
   222|      *
   223|      * @return array<string>
   224|      */
   225|     private function getBotIgnoreList(): array
   226|     {
   227|         return explode(',', (string) $this->configuration->get('main.botIgnoreList'));
   228|     }
   229|     /**
   230|      * Tracks the user and log what he did.
   231|      *
   232|      * @param string          $action Action string
   233|      * @param int|string|null $data
   234|      */
   235|     public function userTracking(string $action, int|string|null $data = null): void
   236|     {
   237|         if (!$this->configuration->get('main.enableUserTracking')) {
   238|             return;
   239|         }
   240|         $request = Request::createFromGlobals();
   241|         $bots = 0;
   242|         $banned = false;
   243|         $this->currentSessionId = Filter::filterVar(
   244|             $request->query->get(self::PMF_GET_KEY_NAME_SESSIONID),
   245|             FILTER_VALIDATE_INT
   246|         );
   247|         $cookieId = Filter::filterVar($request->query->get(self::PMF_COOKIE_NAME_SESSIONID), FILTER_VALIDATE_INT);
   248|         if (!is_null($cookieId)) {
   249|             $this->setCurrentSessionId($cookieId);
   250|         }
   251|         if ($action === SessionActionType::OLD_SESSION->value) {
   252|             $this->setCurrentSessionId(0);
   253|         }
   254|         foreach ($this->getBotIgnoreList() as $bot) {
   255|             if (Strings::strstr($request->headers->get('user-agent'), $bot)) {
   256|                 ++$bots;
   257|             }
   258|         }
   259|         $remoteAddress = Request::createFromGlobals()->getClientIp();
   260|         $localAddresses = ['127.0.0.1', '::1'];
   261|         if (in_array($remoteAddress, $localAddresses) && $request->headers->has('X-Forwarded-For')) {
   262|             $remoteAddress = $request->headers->get('X-Forwarded-For');
   263|         }
   264|         $remoteAddress = preg_replace('([^0-9a-z:.]+)i', '', (string) $remoteAddress);
   265|         $remoteAddress = IpUtils::anonymize($remoteAddress);
   266|         $network = new Network($this->configuration);
   267|         if ($network->isBanned($remoteAddress)) {
   268|             $banned = true;
   269|         }
   270|         if (0 === $bots && false === $banned) {
   271|             if ($this->currentSessionId === null) {
   272|                 $this->currentSessionId = $this->configuration->getDb()->nextId(
   273|                     Database::getTablePrefix() . 'faqsessions',
   274|                     'sid'
   275|                 );
   276|                 if (!is_null($cookieId) && (!$cookieId != $this->getCurrentSessionId())) {
   277|                     self::setCookie(self::PMF_COOKIE_NAME_SESSIONID, $this->getCurrentSessionId());
   278|                 }
   279|                 $query = sprintf(
   280|                     "INSERT INTO %sfaqsessions (sid, user_id, ip, time) VALUES (%d, %d, '%s', %d)",
   281|                     Database::getTablePrefix(),
   282|                     $this->getCurrentSessionId(),
   283|                     isset($this->currentUser) ? $this->currentUser->getUserId() : 0,
   284|                     $remoteAddress,
   285|                     $request->server->get('REQUEST_TIME')
   286|                 );
   287|                 $this->configuration->getDb()->query($query);
   288|             }
   289|             $data = $this->getCurrentSessionId() . ';' .
   290|                 str_replace(';', ',', $action) . ';' .
   291|                 $data . ';' .
   292|                 $remoteAddress . ';' .
   293|                 str_replace(';', ',', $request->server->get('QUERY_STRING') ?? '') . ';' .
   294|                 str_replace(';', ',', $request->server->get('HTTP_REFERER') ?? '') . ';' .
   295|                 str_replace(';', ',', urldecode((string) $request->server->get('HTTP_USER_AGENT'))) . ';' .
   296|                 $request->server->get('REQUEST_TIME') . ";\n";
   297|             $file = PMF_ROOT_DIR . '/content/core/data/tracking' . date('dmY');
   298|             if (!is_file($file)) {
   299|                 touch($file);
   300|             }
   301|             if (!is_writable($file)) {
   302|                 $this->configuration->getLogger()->error('Cannot write to ' . $file);
   303|             }
   304|             file_put_contents($file, $data, FILE_APPEND | LOCK_EX);
   305|         }
   306|     }
   307|     /**
   308|      * Store the Session ID into a persistent cookie expiring
   309|      * 3600 seconds after the page request.
   310|      *
   311|      * @param string          $name Cookie name
   312|      * @param int|string|null $sessionId Session ID
   313|      * @param int             $timeout Cookie timeout
   314|      */
   315|     public function setCookie(string $name, int|string|null $sessionId, int $timeout = 3600, bool $strict = true): bool
   316|     {
   317|         $request = Request::createFromGlobals();
   318|         return setcookie(
   319|             $name,
   320|             $sessionId ?? '',
   321|             [
   322|                 'expires' => $request->server->get('REQUEST_TIME') + $timeout,
   323|                 'path' => dirname($request->server->get('SCRIPT_NAME')),
   324|                 'domain' => parse_url($this->configuration->getDefaultUrl(), PHP_URL_HOST),
   325|                 'samesite' => $strict ? 'strict' : '',
   326|                 'secure' => $request->isSecure(),
   327|                 'httponly' => true,
   328|             ]
   329|         );
   330|     }
   331|     /**
   332|      * Returns the value of a cookie.
   333|      *
   334|      * @param string $name Cookie name
   335|      */
   336|     public function getCookie(string $name): string
   337|     {
   338|         $request = Request::createFromGlobals();
   339|         return $request->cookies->get($name, '');
   340|     }
   341|     /**
   342|      * Calculates the number of visits per day the last 30 days.
   343|      *
   344|      * @return array<int, stdClass>
   345|      */
   346|     public function getLast30DaysVisits(): array
   347|     {
   348|         $stats = [];
   349|         $visits = [];
   350|         $completeData = [];
   351|         $startDate = strtotime('-1 month');
   352|         $endDate = Request::createFromGlobals()->server->get('REQUEST_TIME');
   353|         $query = sprintf(
   354|             'SELECT time FROM %sfaqsessions WHERE time > %d AND time < %d;',
   355|             Database::getTablePrefix(),
   356|             $startDate,
   357|             $endDate
   358|         );
   359|         $result = $this->configuration->getDb()->query($query);
   360|         while ($row = $this->configuration->getDb()->fetchObject($result)) {
   361|             $visits[] = $row->time;
   362|         }
   363|         for ($date = $startDate; $date <= $endDate; $date += 86400) {
   364|             $stats[date('Y-m-d', $date)] = 0;
   365|         }
   366|         foreach ($visits as $visitDate) {
   367|             if (isset($stats[date('Y-m-d', $visitDate)])) {
   368|                 ++$stats[date('Y-m-d', $visitDate)];
   369|             }
   370|         }
   371|         foreach (array_keys($stats) as $date) {
   372|             $visit = new stdClass();
   373|             $visit->date = $date;
   374|             $visit->number = $stats[$date];
   375|             $completeData[] = $visit;
   376|         }
   377|         return $completeData;
   378|     }
   379|     /**
   380|      * Returns a UUID Version 4 compatible universally unique identifier.
   381|      */
   382|     public function uuid(): string
   383|     {
   384|         try {
   385|             return sprintf(
   386|                 '%04x%04x-%04x-%04x-%04x-%04x%04x%04x',
   387|                 random_int(0, 0xffff),
   388|                 random_int(0, 0xffff),
   389|                 random_int(0, 0xffff),
   390|                 random_int(0, 0x0fff) | 0x4000,
   391|                 random_int(0, 0x3fff) | 0x8000,
   392|                 random_int(0, 0xffff),
   393|                 random_int(0, 0xffff),
   394|                 random_int(0, 0xffff)
   395|             );
   396|         } catch (RandomException $e) {
   397|             $this->configuration->getLogger()->error('Cannot generate UUID: ' . $e->getMessage());
   398|             return '';
   399|         }
   400|     }
   401| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Setup/Installer.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1016 ---
     1| <?php
     2| /**
     3|  * The Installer class installs phpMyFAQ. Classy.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Florian Anderiasch <florian@phpmyfaq.net>
    11|  * @copyright 2012-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-08-27
    15|  */
    16| namespace phpMyFAQ\Setup;
    17| use Composer\Autoload\ClassLoader;
    18| use Elastic\Elasticsearch\ClientBuilder;
    19| use Elastic\Elasticsearch\Exception\AuthenticationException;
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Configuration\DatabaseConfiguration;
    22| use phpMyFAQ\Configuration\ElasticsearchConfiguration;
    23| use phpMyFAQ\Core\Exception;
    24| use phpMyFAQ\Database;
    25| use phpMyFAQ\Database\DatabaseDriver;
    26| use phpMyFAQ\Entity\InstanceEntity;
    27| use phpMyFAQ\Enums\PermissionType;
    28| use phpMyFAQ\Enums\ReleaseType;
    29| use phpMyFAQ\Filter;
    30| use phpMyFAQ\Forms;
    31| use phpMyFAQ\Instance;
    32| use phpMyFAQ\Instance\Database as InstanceDatabase;
    33| use phpMyFAQ\Instance\Database\Stopwords;
    34| use phpMyFAQ\Instance\Elasticsearch;
    35| use phpMyFAQ\Instance\Main;
    36| use phpMyFAQ\Instance\Setup;
    37| use phpMyFAQ\Ldap;
    38| use phpMyFAQ\Link;
    39| use phpMyFAQ\System;
    40| use phpMyFAQ\User;
    41| use SplFileObject;
    42| use Symfony\Component\HttpFoundation\Request;
    43| use Tivie\HtaccessParser\Exception\SyntaxException;
    44| use Tivie\HtaccessParser\Parser;
    45| use const Tivie\HtaccessParser\Token\TOKEN_DIRECTIVE;
    46| /**
    47|  * Class Installer
    48|  *
    49|  * @package phpMyFAQ
    50|  */
    51| class Installer extends Setup
    52| {
    53|     /**
    54|      * Array with user rights.
    55|      * @var array<array>
    56|      */
    57|     protected array $mainRights = [
    58|         [
    59|             'name' => PermissionType::USER_ADD->value,
    60|             'description' => 'Right to add user accounts',
    61|         ],
    62|         [
    63|             'name' => PermissionType::USER_EDIT->value,
    64|             'description' => 'Right to edit user accounts',
    65|         ],
    66|         [
    67|             'name' => PermissionType::USER_DELETE->value,
    68|             'description' => 'Right to delete user accounts',
    69|         ],
    70|         [
    71|             'name' => PermissionType::FAQ_ADD->value,
    72|             'description' => 'Right to add faq entries',
    73|         ],
    74|         [
    75|             'name' => PermissionType::FAQ_EDIT->value,
    76|             'description' => 'Right to edit faq entries',
    77|         ],
    78|         [
    79|             'name' => PermissionType::FAQ_DELETE->value,
    80|             'description' => 'Right to delete faq entries',
    81|         ],
    82|         [
    83|             'name' => PermissionType::STATISTICS_VIEWLOGS->value,
    84|             'description' => 'Right to view logfiles',
    85|         ],
    86|         [
    87|             'name' => PermissionType::STATISTICS_ADMINLOG->value,
    88|             'description' => 'Right to view admin log',
    89|         ],
    90|         [
    91|             'name' => PermissionType::COMMENT_DELETE->value,
    92|             'description' => 'Right to delete comments',
    93|         ],
    94|         [
    95|             'name' => PermissionType::NEWS_ADD->value,
    96|             'description' => 'Right to add news',
    97|         ],
    98|         [
    99|             'name' => PermissionType::NEWS_EDIT->value,
   100|             'description' => 'Right to edit news',
   101|         ],
   102|         [
   103|             'name' => PermissionType::NEWS_DELETE->value,
   104|             'description' => 'Right to delete news',
   105|         ],
   106|         [
   107|             'name' => PermissionType::CATEGORY_ADD->value,
   108|             'description' => 'Right to add categories',
   109|         ],
   110|         [
   111|             'name' => PermissionType::CATEGORY_EDIT->value,
   112|             'description' => 'Right to edit categories',
   113|         ],
   114|         [
   115|             'name' => PermissionType::CATEGORY_DELETE->value,
   116|             'description' => 'Right to delete categories',
   117|         ],
   118|         [
   119|             'name' => PermissionType::PASSWORD_CHANGE->value,
   120|             'description' => 'Right to change passwords',
   121|         ],
   122|         [
   123|             'name' => PermissionType::CONFIGURATION_EDIT->value,
   124|             'description' => 'Right to edit configuration',
   125|         ],
   126|         [
   127|             'name' => PermissionType::VIEW_ADMIN_LINK->value,
   128|             'description' => 'Right to see the link to the admin section'
   129|         ],
   130|         [
   131|             'name' => PermissionType::BACKUP->value,
   132|             'description' => 'Right to save backups',
   133|         ],
   134|         [
   135|             'name' => PermissionType::RESTORE->value,
   136|             'description' => 'Right to load backups',
   137|         ],
   138|         [
   139|             'name' => PermissionType::QUESTION_DELETE->value,
   140|             'description' => 'Right to delete questions',
   141|         ],
   142|         [
   143|             'name' => PermissionType::GLOSSARY_ADD->value,
   144|             'description' => 'Right to add glossary entries',
   145|         ],
   146|         [
   147|             'name' => PermissionType::GLOSSARY_EDIT->value,
   148|             'description' => 'Right to edit glossary entries',
   149|         ],
   150|         [
   151|             'name' => PermissionType::GLOSSARY_DELETE->value,
   152|             'description' => 'Right to delete glossary entries',
   153|         ],
   154|         [
   155|             'name' => PermissionType::REVISION_UPDATE->value,
   156|             'description' => 'Right to edit revisions',
   157|         ],
   158|         [
   159|             'name' => PermissionType::GROUP_ADD->value,
   160|             'description' => 'Right to add group accounts',
   161|         ],
   162|         [
   163|             'name' => PermissionType::GROUP_EDIT->value,
   164|             'description' => 'Right to edit group accounts',
   165|         ],
   166|         [
   167|             'name' => PermissionType::GROUP_DELETE->value,
   168|             'description' => 'Right to delete group accounts',
   169|         ],
   170|         [
   171|             'name' => 'addtranslation',
   172|             'description' => 'Right to add translation',
   173|         ],
   174|         [
   175|             'name' => 'edittranslation',
   176|             'description' => 'Right to edit translations',
   177|         ],
   178|         [
   179|             'name' => 'deltranslation',
   180|             'description' => 'Right to delete translations',
   181|         ],
   182|         [
   183|             'name' => 'approverec',
   184|             'description' => 'Right to approve records',
   185|         ],
   186|         [
   187|             'name' => PermissionType::ATTACHMENT_ADD->value,
   188|             'description' => 'Right to add attachments',
   189|         ],
   190|         [
   191|             'name' => 'editattachment',
   192|             'description' => 'Right to edit attachments',
   193|         ],
   194|         [
   195|             'name' => 'delattachment',
   196|             'description' => 'Right to delete attachments',
   197|         ],
   198|         [
   199|             'name' => 'dlattachment',
   200|             'description' => 'Right to download attachments',
   201|         ],
   202|         [
   203|             'name' => 'reports',
   204|             'description' => 'Right to generate reports',
   205|         ],
   206|         [
   207|             'name' => 'addfaq',
   208|             'description' => 'Right to add FAQs in frontend',
   209|         ],
   210|         [
   211|             'name' => 'addquestion',
   212|             'description' => 'Right to add questions in frontend',
   213|         ],
   214|         [
   215|             'name' => PermissionType::COMMENT_ADD->value,
   216|             'description' => 'Right to add comments in frontend',
   217|         ],
   218|         [
   219|             'name' => 'editinstances',
   220|             'description' => 'Right to edit multi-site instances',
   221|         ],
   222|         [
   223|             'name' => 'addinstances',
   224|             'description' => 'Right to add multi-site instances',
   225|         ],
   226|         [
   227|             'name' => 'delinstances',
   228|             'description' => 'Right to delete multi-site instances',
   229|         ],
   230|         [
   231|             'name' => 'export',
   232|             'description' => 'Right to export the complete FAQ',
   233|         ],
   234|         [
   235|             'name' => 'view_faqs',
   236|             'description' => 'Right to view FAQs'
   237|         ],
   238|         [
   239|             'name' => 'view_categories',
   240|             'description' => 'Right to view categories'
   241|         ],
   242|         [
   243|             'name' => 'view_news',
   244|             'description' => 'Right to view news'
   245|         ],
   246|         [
   247|             'name' => 'administrate_groups',
   248|             'description' => 'Right to administrate groups'
   249|         ],
   250|         [
   251|             'name' => 'forms_edit',
   252|             'description' => 'Right to edit forms'
   253|         ]
   254|     ];
   255|     /**
   256|      * Configuration array.
   257|      *
   258|      * @var array<string, string>
   259|      */
   260|     protected array $mainConfig = [
   261|         'main.currentVersion' => null,
   262|         'main.currentApiVersion' => null,
   263|         'main.language' => '__PHPMYFAQ_LANGUAGE__',
   264|         'main.languageDetection' => 'true',
   265|         'main.phpMyFAQToken' => null,
   266|         'main.referenceURL' => '__PHPMYFAQ_REFERENCE_URL__',
   267|         'main.administrationMail' => 'webmaster@example.org',
   268|         'main.contactInformation' => '',
   269|         'main.enableAdminLog' => 'true',
   270|         'main.enableUserTracking' => 'true',
   271|         'main.metaDescription' => 'phpMyFAQ should be the answer for all questions in life',
   272|         'main.metaPublisher' => '__PHPMYFAQ_PUBLISHER__',
   273|         'main.titleFAQ' => 'phpMyFAQ Codename Pallas',
   274|         'main.enableWysiwygEditor' => 'true',
   275|         'main.enableWysiwygEditorFrontend' => 'false',
   276|         'main.enableMarkdownEditor' => 'false',
   277|         'main.dateFormat' => 'Y-m-d H:i',
   278|         'main.maintenanceMode' => 'false',
   279|         'main.enableGravatarSupport' => 'false',
   280|         'main.customPdfHeader' => '',
   281|         'main.customPdfFooter' => '',
   282|         'main.enableSmartAnswering' => 'true',
   283|         'main.enableCategoryRestrictions' => 'true',
   284|         'main.enableSendToFriend' => 'true',
   285|         'main.privacyURL' => '',
   286|         'main.enableAutoUpdateHint' => 'true',
   287|         'main.enableAskQuestions' => 'false',
   288|         'main.enableNotifications' => 'false',
   289|         'main.botIgnoreList' => 'nustcrape,webpost,GoogleBot,msnbot,crawler,scooter,bravobrian,archiver,' .
   290|         'w3c,controler,wget,bot,spider,Yahoo! Slurp,htdig,gsa-crawler,AirControler,Uptime-Kuma,facebookcatalog/1.0,' .
   291|         'facebookexternalhit/1.1 (+http://www.facebook.com/externalhit_uatext.php),facebookexternalhit/1.1',
   292|         'records.numberOfRecordsPerPage' => '10',
   293|         'records.numberOfShownNewsEntries' => '3',
   294|         'records.defaultActivation' => 'false',
   295|         'records.defaultAllowComments' => 'false',
   296|         'records.enableVisibilityQuestions' => 'false',
   297|         'records.numberOfRelatedArticles' => '5',
   298|         'records.orderby' => 'id',
   299|         'records.sortby' => 'DESC',
   300|         'records.orderingPopularFaqs' => 'visits',
   301|         'records.disableAttachments' => 'true',
   302|         'records.maxAttachmentSize' => '100000',
   303|         'records.attachmentsPath' => 'content/user/attachments',
   304|         'records.attachmentsStorageType' => '0',
   305|         'records.enableAttachmentEncryption' => 'false',
   306|         'records.defaultAttachmentEncKey' => '',
   307|         'records.enableCloseQuestion' => 'false',
   308|         'records.enableDeleteQuestion' => 'false',
   309|         'records.randomSort' => 'false',
   310|         'records.allowCommentsForGuests' => 'true',
   311|         'records.allowQuestionsForGuests' => 'true',
   312|         'records.allowNewFaqsForGuests' => 'true',
   313|         'records.hideEmptyCategories' => 'false',
   314|         'records.allowDownloadsForGuests' => 'false',
   315|         'records.numberMaxStoredRevisions' => '10',
   316|         'records.enableAutoRevisions' => 'false',
   317|         'records.orderStickyFaqsCustom' => 'false',
   318|         'records.allowedMediaHosts' => 'www.youtube.com',
   319|         'search.numberSearchTerms' => '10',
   320|         'search.relevance' => 'thema,content,keywords',
   321|         'search.enableRelevance' => 'false',
   322|         'search.enableHighlighting' => 'true',
   323|         'search.searchForSolutionId' => 'true',
   324|         'search.enableElasticsearch' => 'false',
   325|         'security.permLevel' => 'basic',
   326|         'security.ipCheck' => 'false',
   327|         'security.enableLoginOnly' => 'false',
   328|         'security.bannedIPs' => '',
   329|         'security.ssoSupport' => 'false',
   330|         'security.ssoLogoutRedirect' => '',
   331|         'security.useSslForLogins' => 'false',
   332|         'security.useSslOnly' => 'false',
   333|         'security.forcePasswordUpdate' => 'false',
   334|         'security.enableRegistration' => 'true',
   335|         'security.domainWhiteListForRegistrations' => '',
   336|         'security.enableSignInWithMicrosoft' => 'false',
   337|         'security.enableGoogleReCaptchaV2' => 'false',
   338|         'security.googleReCaptchaV2SiteKey' => '',
   339|         'security.googleReCaptchaV2SecretKey' => '',
   340|         'security.loginWithEmailAddress' => 'false',
   341|         'security.enableWebAuthnSupport' => 'false',
   342|         'spam.checkBannedWords' => 'true',
   343|         'spam.enableCaptchaCode' => null,
   344|         'spam.enableSafeEmail' => 'true',
   345|         'spam.manualActivation' => 'true',
   346|         'spam.mailAddressInExport' => 'true',
   347|         'seo.title' => 'phpMyFAQ Codename Pallas',
   348|         'seo.description' => 'phpMyFAQ should be the answer for all questions in life',
   349|         'seo.enableXMLSitemap' => 'true',
   350|         'seo.enableRichSnippets' => 'false',
   351|         'seo.metaTagsHome' => 'index, follow',
   352|         'seo.metaTagsFaqs' => 'index, follow',
   353|         'seo.metaTagsCategories' => 'index, follow',
   354|         'seo.metaTagsPages' => 'index, follow',
   355|         'seo.metaTagsAdmin' => 'noindex, nofollow',
   356|         'mail.noReplySenderAddress' => '',
   357|         'mail.remoteSMTP' => 'false',
   358|         'mail.remoteSMTPServer' => '',
   359|         'mail.remoteSMTPUsername' => '',
   360|         'mail.remoteSMTPPassword' => '',
   361|         'mail.remoteSMTPPort' => '25',
   362|         'mail.remoteSMTPDisableTLSPeerVerification' => 'false',
   363|         'ldap.ldapSupport' => 'false',
   364|         'ldap.ldap_mapping.name' => 'cn',
   365|         'ldap.ldap_mapping.username' => 'samAccountName',
   366|         'ldap.ldap_mapping.mail' => 'mail',
   367|         'ldap.ldap_mapping.memberOf' => '',
   368|         'ldap.ldap_use_domain_prefix' => 'true',
   369|         'ldap.ldap_options.LDAP_OPT_PROTOCOL_VERSION' => '3',
   370|         'ldap.ldap_options.LDAP_OPT_REFERRALS' => '0',
   371|         'ldap.ldap_use_memberOf' => 'false',
   372|         'ldap.ldap_use_sasl' => 'false',
   373|         'ldap.ldap_use_multiple_servers' => 'false',
   374|         'ldap.ldap_use_anonymous_login' => 'false',
   375|         'ldap.ldap_use_dynamic_login' => 'false',
   376|         'ldap.ldap_dynamic_login_attribute' => 'uid',
   377|         'api.enableAccess' => 'true',
   378|         'api.apiClientToken' => '',
   379|         'upgrade.dateLastChecked' => '',
   380|         'upgrade.lastDownloadedPackage' => '',
   381|         'upgrade.onlineUpdateEnabled' => 'false',
   382|         'upgrade.releaseEnvironment' => '__PHPMYFAQ_RELEASE__',
   383|         'layout.templateSet' => 'default',
   384|         'layout.enablePrivacyLink' => 'true',
   385|         'layout.enableCookieConsent' => 'true',
   386|         'layout.contactInformationHTML' => 'false',
   387|         'layout.customCss' => '',
   388|     ];
   389|     /**
   390|      * Array with form inputs
   391|      * @var array<array>
   392|      */
   393|     public array $formInputs = [
   394|         [
   395|             'form_id' => 1,
   396|             'input_id' => 1,
   397|             'input_type' => 'title',
   398|             'input_label' => 'msgQuestion',
   399|             'input_active' => 1,
   400|             'input_required' => -1,
   401|             'input_lang' => 'default'
   402|         ],
   403|         [
   404|             'form_id' => 1,
   405|             'input_id' => 2,
   406|             'input_type' => 'message',
   407|             'input_label' => 'msgNewQuestion',
   408|             'input_active' => 1,
   409|             'input_required' => -1,
   410|             'input_lang' => 'default'
   411|         ],
   412|         [
   413|             'form_id' => 1,
   414|             'input_id' => 3,
   415|             'input_type' => 'text',
   416|             'input_label' => 'msgNewContentName',
   417|             'input_active' => 1,
   418|             'input_required' => 1,
   419|             'input_lang' => 'default'
   420|         ],
   421|         [
   422|             'form_id' => 1,
   423|             'input_id' => 4,
   424|             'input_type' => 'email',
   425|             'input_label' => 'msgNewContentMail',
   426|             'input_active' => 1,
   427|             'input_required' => 1,
   428|             'input_lang' => 'default'
   429|         ],
   430|         [
   431|             'form_id' => 1,
   432|             'input_id' => 5,
   433|             'input_type' => 'select',
   434|             'input_label' => 'msgNewContentCategory',
   435|             'input_active' => 1,
   436|             'input_required' => 1,
   437|             'input_lang' => 'default'
   438|         ],
   439|         [
   440|             'form_id' => 1,
   441|             'input_id' => 6,
   442|             'input_type' => 'textarea',
   443|             'input_label' => 'msgAskYourQuestion',
   444|             'input_active' => -1,
   445|             'input_required' => -1,
   446|             'input_lang' => 'default'
   447|         ],
   448|         [
   449|             'form_id' => 2,
   450|             'input_id' => 1,
   451|             'input_type' => 'title',
   452|             'input_label' => 'msgNewContentHeader',
   453|             'input_active' => 1,
   454|             'input_required' => -1,
   455|             'input_lang' => 'default'
   456|         ],
   457|         [
   458|             'form_id' => 2,
   459|             'input_id' => 2,
   460|             'input_type' => 'message',
   461|             'input_label' => 'msgNewContentAddon',
   462|             'input_active' => 1,
   463|             'input_required' => -1,
   464|             'input_lang' => 'default'
   465|         ],
   466|         [
   467|             'form_id' => 2,
   468|             'input_id' => 3,
   469|             'input_type' => 'text',
   470|             'input_label' => 'msgNewContentName',
   471|             'input_active' => 1,
   472|             'input_required' => 1,
   473|             'input_lang' => 'default'
   474|         ],
   475|         [
   476|             'form_id' => 2,
   477|             'input_id' => 4,
   478|             'input_type' => 'email',
   479|             'input_label' => 'msgNewContentMail',
   480|             'input_active' => 1,
   481|             'input_required' => 1,
   482|             'input_lang' => 'default'
   483|         ],
   484|         [
   485|             'form_id' => 2,
   486|             'input_id' => 5,
   487|             'input_type' => 'select',
   488|             'input_label' => 'msgNewContentCategory',
   489|             'input_active' => 1,
   490|             'input_required' => 1,
   491|             'input_lang' => 'default'
   492|         ],
   493|         [
   494|             'form_id' => 2,
   495|             'input_id' => 6,
   496|             'input_type' => 'textarea',
   497|             'input_label' => 'msgNewContentTheme',
   498|             'input_active' => -1,
   499|             'input_required' => -1,
   500|             'input_lang' => 'default'
   501|         ],
   502|         [
   503|             'form_id' => 2,
   504|             'input_id' => 7,
   505|             'input_type' => 'textarea',
   506|             'input_label' => 'msgNewContentArticle',
   507|             'input_active' => 1,
   508|             'input_required' => 1,
   509|             'input_lang' => 'default'
   510|         ],
   511|         [
   512|             'form_id' => 2,
   513|             'input_id' => 8,
   514|             'input_type' => 'text',
   515|             'input_label' => 'msgNewContentKeywords',
   516|             'input_active' => 1,
   517|             'input_required' => 1,
   518|             'input_lang' => 'default'
   519|         ],
   520|         [
   521|             'form_id' => 2,
   522|             'input_id' => 9,
   523|             'input_type' => 'title',
   524|             'input_label' => 'msgNewContentLink',
   525|             'input_active' => 1,
   526|             'input_required' => 1,
   527|             'input_lang' => 'default'
   528|         ]
   529|     ];
   530|     /**
   531|      * Constructor.
   532|      *
   533|      * @throws \Exception
   534|      */
   535|     public function __construct(private readonly System $system)
   536|     {
   537|         parent::__construct();
   538|         $dynMainConfig = [
   539|             'main.currentVersion' => System::getVersion(),
   540|             'main.currentApiVersion' => System::getApiVersion(),
   541|             'main.phpMyFAQToken' => bin2hex(random_bytes(16)),
   542|             'spam.enableCaptchaCode' => (extension_loaded('gd') ? 'true' : 'false'),
   543|             'upgrade.releaseEnvironment' =>
   544|                 System::isDevelopmentVersion() ? ReleaseType::DEVELOPMENT->value : ReleaseType::STABLE->value
   545|         ];
   546|         $this->mainConfig = array_merge($this->mainConfig, $dynMainConfig);
   547|     }
   548|     /**
   549|      * Removes the database.php and the ldap.php if an installation failed.
   550|      */
   551|     public static function cleanFailedInstallationFiles(): void
   552|     {
   553|         if (file_exists(PMF_ROOT_DIR . '/content/core/config/database.php')) {
   554|             unlink(PMF_ROOT_DIR . '/content/core/config/database.php');
   555|         }
   556|         if (file_exists(PMF_ROOT_DIR . '/content/core/config/ldap.php')) {
   557|             unlink(PMF_ROOT_DIR . '/content/core/config/ldap.php');
   558|         }
   559|     }
   560|     /**
   561|      * Check the necessary stuff and throw an exception if something is wrong.
   562|      * @throws Exception
   563|      */
   564|     public function checkBasicStuff(): void
   565|     {
   566|         if (!$this->checkMinimumPhpVersion()) {
   567|             throw new Exception(sprintf('Sorry, but you need PHP %s or later!', System::VERSION_MINIMUM_PHP));
   568|         }
   569|         if (!function_exists('date_default_timezone_set')) {
   570|             throw new Exception('Sorry, but setting a default timezone does not work in your environment!');
   571|         }
   572|         if (!$this->system->checkDatabase()) {
   573|             throw new Exception('No supported database detected!');
   574|         }
   575|         if (!$this->system->checkRequiredExtensions()) {
   576|             throw new Exception(
   577|                 sprintf(
   578|                     'Some required PHP extensions are missing: %s',
   579|                     implode(', ', $this->system->getMissingExtensions())
   580|                 )
   581|             );
   582|         }
   583|         if (!$this->system->checkInstallation()) {
   584|             throw new Exception(
   585|                 'Looks like phpMyFAQ is already installed! Please use the <a href="../update">update</a>.'
   586|             );
   587|         }
   588|     }
   589|     /**
   590|      * Checks if the file permissions are okay.
   591|      */
   592|     public function checkFilesystemPermissions(): string|null
   593|     {
   594|         $instanceSetup = new Setup();
   595|         $instanceSetup->setRootDir(PMF_ROOT_DIR);
   596|         $dirs = [
   597|             '/content/core/config',
   598|             '/content/core/data',
   599|             '/content/core/logs',
   600|             '/content/user/images',
   601|             '/content/user/attachments',
   602|         ];
   603|         $failedDirs = $instanceSetup->checkDirs($dirs);
   604|         $numDirs = count($failedDirs);
   605|         $hints = '';
   606|         if (1 <= $numDirs) {
   607|             $hints .= sprintf(
   608|                 '<p class="alert alert-danger">The following %s could not be created or %s not writable:</p><ul>',
   609|                 (1 < $numDirs) ? 'directories' : 'directory',
   610|                 (1 < $numDirs) ? 'are' : 'is'
   611|             );
   612|             foreach ($failedDirs as $failedDir) {
   613|                 $hints .= "<li>{$failedDir}</li>\n";
   614|             }
   615|             $hints .= sprintf(
   616|                 '</ul><p class="alert alert-danger">Please create %s manually and/or change access to chmod 775 (or ' .
   617|                 'greater if necessary).</p>',
   618|                 (1 < $numDirs) ? 'them' : 'it'
   619|             );
   620|             return $hints;
   621|         }
   622|         return null;
   623|     }
   624|     /**
   625|      * Checks some non-critical settings and print some hints.
   626|      *
   627|      * @return string[]
   628|      */
   629|     public function checkNoncriticalSettings(): array
   630|     {
   631|         $hints = [];
   632|         if (!$this->system->getHttpsStatus()) {
   633|             $hints[] = '<p class="alert alert-warning">HTTPS support is not enabled in your web server.' .
   634|                 ' To ensure the security of your data and protect against potential vulnerabilities,' .
   635|                 ' we highly recommend enabling HTTPS. Please configure your web server to support HTTPS as soon as' .
   636|                 ' possible.</p>';
   637|         }
   638|         if (!extension_loaded('gd')) {
   639|             $hints[] = '<p class="alert alert-warning">You don\'t have GD support enabled in your PHP installation. ' .
   640|                 "Please enable GD support in your php.ini file otherwise you can't use Captchas for spam protection." .
   641|                 "</p>";
   642|         }
   643|         if (!function_exists('imagettftext')) {
   644|             $hints[] = '<p class="alert alert-warning">You don\'t have Freetype support enabled in the GD extension ' .
   645|                 ' of your PHP installation. Please enable Freetype support in GD extension otherwise the Captchas ' .
   646|                 'for spam protection will be quite easy to break.</p>';
   647|         }
   648|         if (!extension_loaded('curl') || !extension_loaded('openssl')) {
   649|             $hints[] = '<p class="alert alert-warning">You don\'t have cURL and/or OpenSSL support enabled in your ' .
   650|                 "PHP installation. Please enable cURL and/or OpenSSL support in your php.ini file otherwise you " .
   651|                 " can't use Elasticsearch.</p>";
   652|         }
   653|         if (!extension_loaded('fileinfo')) {
   654|             $hints[] = '<p class="alert alert-warning">You don\'t have Fileinfo support enabled in your PHP ' .
   655|                 "installation. Please enable Fileinfo support in your php.ini file otherwise you can't use our " .
   656|                 'backup/restore functionality.</p>';
   657|         }
   658|         if (!extension_loaded('sodium')) {
   659|             $hints[] = '<p class="alert alert-warning">You don\'t have Sodium support enabled in your PHP ' .
   660|                 "installation. Please enable Sodium support in your php.ini file otherwise you can't use our " .
   661|                 'backup/restore functionality.</p>';
   662|         }
   663|         return $hints;
   664|     }
   665|     /**
   666|      * @throws Exception
   667|      */
   668|     public function checkInitialRewriteBasePath(Request $request): bool
   669|     {
   670|         $basePath = $request->getBasePath();
   671|         $basePath = rtrim($basePath, 'setup');
   672|         $htaccessPath = PMF_ROOT_DIR . '/.htaccess';
   673|         $file = new SplFileObject($htaccessPath);
   674|         $parser = new Parser();
   675|         try {
   676|             $htaccess = $parser->parse($file);
   677|         } catch (SyntaxException $e) {
   678|             throw new Exception('Syntax error in .htaccess file: ' . $e->getMessage());
   679|         } catch (\Tivie\HtaccessParser\Exception\Exception $e) {
   680|             throw new Exception('Error parsing .htaccess file: ' . $e->getMessage());
   681|         }
   682|         $rewriteBase = $htaccess->search('RewriteBase', TOKEN_DIRECTIVE);
   683|         $rewriteBase->removeArgument($rewriteBase->getArguments()[0]);
   684|         $rewriteBase->setArguments((array)$basePath);
   685|         $output = (string) $htaccess;
   686|         return file_put_contents($htaccessPath, $output);
   687|     }
   688|     /**
   689|      * Starts the installation.
   690|      *
   691|      * @param array|null $setup
   692|      * @throws Exception|AuthenticationException
   693|      */
   694|     public function startInstall(array|null $setup = null): void
   695|     {
   696|         $ldapSetup = [];
   697|         $query = [];
   698|         $uninstall = [];
   699|         $dbSetup = [];
   700|         $dbSetup['dbPrefix'] = Filter::filterInput(INPUT_POST, 'sqltblpre', FILTER_SANITIZE_SPECIAL_CHARS, '');
   701|         if ('' !== $dbSetup['dbPrefix']) {
   702|             Database::setTablePrefix($dbSetup['dbPrefix']);
   703|         }
   704|         if (!isset($setup['dbType'])) {
   705|             $dbSetup['dbType'] = Filter::filterInput(INPUT_POST, 'sql_type', FILTER_SANITIZE_SPECIAL_CHARS);
   706|         } else {
   707|             $dbSetup['dbType'] = $setup['dbType'];
   708|         }
   709|         if (!is_null($dbSetup['dbType'])) {
   710|             $dbSetup['dbType'] = trim((string) $dbSetup['dbType']);
   711|             if (!file_exists(PMF_SRC_DIR . '/phpMyFAQ/Instance/Database/' . ucfirst($dbSetup['dbType']) . '.php')) {
   712|                 throw new Exception(sprintf('Installation Error: Invalid server type: %s', $dbSetup['dbType']));
   713|             }
   714|         } else {
   715|             throw new Exception('Installation Error: Please select a database type.');
   716|         }
   717|         $dbSetup['dbServer'] = Filter::filterInput(INPUT_POST, 'sql_server', FILTER_SANITIZE_SPECIAL_CHARS, '');
   718|         if (is_null($dbSetup['dbServer']) && !System::isSqlite($dbSetup['dbType'])) {
   719|             throw new Exception('Installation Error: Please add a database server.');
   720|         }
   721|         if (!isset($setup['dbType'])) {
   722|             $dbSetup['dbPort'] = Filter::filterInput(INPUT_POST, 'sql_port', FILTER_VALIDATE_INT);
   723|         } else {
   724|             $dbSetup['dbPort'] = $setup['dbPort'];
   725|         }
   726|         if (is_null($dbSetup['dbPort']) && ! System::isSqlite($dbSetup['dbType'])) {
   727|             throw new Exception('Installation Error: Please add a valid database port.');
   728|         }
   729|         $dbSetup['dbUser'] = Filter::filterInput(INPUT_POST, 'sql_user', FILTER_SANITIZE_SPECIAL_CHARS, '');
   730|         if (is_null($dbSetup['dbUser']) && !System::isSqlite($dbSetup['dbType'])) {
   731|             throw new Exception('Installation Error: Please add a database username.');
   732|         }
   733|         $dbSetup['dbPassword'] = Filter::filterInput(INPUT_POST, 'sql_password', FILTER_SANITIZE_SPECIAL_CHARS, '');
   734|         if (is_null($dbSetup['dbPassword']) && !System::isSqlite($dbSetup['dbType'])) {
   735|             $dbSetup['dbPassword'] = '';
   736|         }
   737|         if (!isset($setup['dbType'])) {
   738|             $dbSetup['dbDatabaseName'] = Filter::filterInput(INPUT_POST, 'sql_db', FILTER_SANITIZE_SPECIAL_CHARS);
   739|         } else {
   740|             $dbSetup['dbDatabaseName'] = $setup['dbDatabaseName'];
   741|         }
   742|         if (is_null($dbSetup['dbDatabaseName']) && !System::isSqlite($dbSetup['dbType'])) {
   743|             throw new Exception('Installation Error: Please add a database name.');
   744|         }
   745|         if (System::isSqlite($dbSetup['dbType'])) {
   746|             $dbSetup['dbServer'] = Filter::filterInput(
   747|                 INPUT_POST,
   748|                 'sql_sqlitefile',
   749|                 FILTER_SANITIZE_SPECIAL_CHARS,
   750|                 $setup['dbServer'] ?? null
   751|             );
   752|             if (is_null($dbSetup['dbServer'])) {
   753|                 throw new Exception('Installation Error: Please add a SQLite database filename.');
   754|             }
   755|         }
   756|         Database::setTablePrefix($dbSetup['dbPrefix']);
   757|         $db = Database::factory($dbSetup['dbType']);
   758|         $db->connect(
   759|             $dbSetup['dbServer'],
   760|             $dbSetup['dbUser'],
   761|             $dbSetup['dbPassword'],
   762|             $dbSetup['dbDatabaseName'],
   763|             $dbSetup['dbPort']
   764|         );
   765|         $configuration = new Configuration($db);
   766|         $ldapEnabled = Filter::filterInput(INPUT_POST, 'ldap_enabled', FILTER_SANITIZE_SPECIAL_CHARS);
   767|         if (extension_loaded('ldap') && !is_null($ldapEnabled)) {
   768|             $ldapSetup['ldapServer'] = Filter::filterInput(INPUT_POST, 'ldap_server', FILTER_SANITIZE_SPECIAL_CHARS);
   769|             if (is_null($ldapSetup['ldapServer'])) {
   770|                 throw new Exception('LDAP Installation Error: Please add a LDAP server.');
   771|             }
   772|             $ldapSetup['ldapPort'] = Filter::filterInput(INPUT_POST, 'ldap_port', FILTER_VALIDATE_INT);
   773|             if (is_null($ldapSetup['ldapPort'])) {
   774|                 throw new Exception('LDAP Installation Error: Please add a LDAP port.');
   775|             }
   776|             $ldapSetup['ldapBase'] = Filter::filterInput(INPUT_POST, 'ldap_base', FILTER_SANITIZE_SPECIAL_CHARS);
   777|             if (is_null($ldapSetup['ldapBase'])) {
   778|                 throw new Exception('LDAP Installation Error: Please add a LDAP base search DN.');
   779|             }
   780|             $ldapSetup['ldapUser'] = Filter::filterInput(INPUT_POST, 'ldap_user', FILTER_SANITIZE_SPECIAL_CHARS);
   781|             $ldapSetup['ldapPassword'] = Filter::filterInput(
   782|                 INPUT_POST,
   783|                 'ldap_password',
   784|                 FILTER_SANITIZE_SPECIAL_CHARS
   785|             );
   786|             foreach ($this->mainConfig as $configKey => $configValue) {
   787|                 if (str_contains($configKey, 'ldap.')) {
   788|                     $configuration->set($configKey, $configValue);
   789|                 }
   790|             }
   791|             $ldap = new Ldap($configuration);
   792|             $ldapConnection = $ldap->connect(
   793|                 $ldapSetup['ldapServer'],
   794|                 $ldapSetup['ldapPort'],
   795|                 $ldapSetup['ldapBase'],
   796|                 $ldapSetup['ldapUser'],
   797|                 $ldapSetup['ldapPassword']
   798|             );
   799|             if (!$ldapConnection) {
   800|                 throw new Exception(sprintf('LDAP Installation Error: %s.', $ldap->error()));
   801|             }
   802|         }
   803|         $esEnabled = Filter::filterInput(INPUT_POST, 'elasticsearch_enabled', FILTER_SANITIZE_SPECIAL_CHARS);
   804|         if (!is_null($esEnabled)) {
   805|             $esSetup = [];
   806|             $esHostFilter = [
   807|                 'elasticsearch_server' => [
   808|                     'filter' => FILTER_SANITIZE_SPECIAL_CHARS,
   809|                     'flags' => FILTER_REQUIRE_ARRAY
   810|                 ]
   811|             ];
   812|             $esHosts = Filter::filterInputArray(INPUT_POST, $esHostFilter);
   813|             if (is_null($esHosts)) {
   814|                 throw new Exception('Elasticsearch Installation Error: Please add at least one Elasticsearch host.');
   815|             }
   816|             $esSetup['hosts'] = $esHosts['elasticsearch_server'];
   817|             $esSetup['index'] = Filter::filterInput(INPUT_POST, 'elasticsearch_index', FILTER_SANITIZE_SPECIAL_CHARS);
   818|             if (is_null($esSetup['index'])) {
   819|                 throw new Exception('Elasticsearch Installation Error: Please add an Elasticsearch index name.');
   820|             }
   821|             $classLoader = new ClassLoader();
   822|             $classLoader->addPsr4('Elasticsearch\\', PMF_SRC_DIR . '/libs/elasticsearch/src/Elasticsearch');
   823|             $classLoader->addPsr4('Monolog\\', PMF_SRC_DIR . '/libs/monolog/src/Monolog');
   824|             $classLoader->addPsr4('Psr\\', PMF_SRC_DIR . '/libs/psr/log/Psr');
   825|             $classLoader->addPsr4('React\\Promise\\', PMF_SRC_DIR . '/libs/react/promise/src');
   826|             $classLoader->register();
   827|             $esHosts = array_values($esHosts['elasticsearch_server']);
   828|             $esClient = ClientBuilder::create()->setHosts($esHosts)->build();
   829|             if (!$esClient) {
   830|                 throw new Exception('Elasticsearch Installation Error: No connection to Elasticsearch.');
   831|             }
   832|         } else {
   833|             $esSetup = [];
   834|         }
   835|         if (!isset($setup['loginname'])) {
   836|             $loginName = Filter::filterInput(INPUT_POST, 'loginname', FILTER_SANITIZE_SPECIAL_CHARS);
   837|         } else {
   838|             $loginName = $setup['loginname'];
   839|         }
   840|         if (is_null($loginName)) {
   841|             throw new Exception('Installation Error: Please add a login name for your account.');
   842|         }
   843|         if (!isset($setup['password'])) {
   844|             $password = Filter::filterInput(INPUT_POST, 'password', FILTER_SANITIZE_SPECIAL_CHARS);
   845|         } else {
   846|             $password = $setup['password'];
   847|         }
   848|         if (is_null($password)) {
   849|             throw new Exception('Installation Error: Please add a password for your account.');
   850|         }
   851|         if (!isset($setup['password_retyped'])) {
   852|             $passwordRetyped = Filter::filterInput(INPUT_POST, 'password_retyped', FILTER_SANITIZE_SPECIAL_CHARS);
   853|         } else {
   854|             $passwordRetyped = $setup['password_retyped'];
   855|         }
   856|         if (is_null($passwordRetyped)) {
   857|             throw new Exception('Installation Error: Please add a retyped password.');
   858|         }
   859|         if (strlen((string) $password) <= 7 || strlen((string) $passwordRetyped) <= 7) {
   860|             throw new Exception(
   861|                 'Installation Error: Your password and retyped password are too short. Please set your password ' .
   862|                 'and your retyped password with a minimum of 8 characters.'
   863|             );
   864|         }
   865|         if ($password !== $passwordRetyped) {
   866|             throw new Exception(
   867|                 'Installation Error: Your password and retyped password are not equal. Please check your password ' .
   868|                 'and your retyped password.'
   869|             );
   870|         }
   871|         $language = Filter::filterInput(INPUT_POST, 'language', FILTER_SANITIZE_SPECIAL_CHARS, 'en');
   872|         $realname = Filter::filterInput(INPUT_POST, 'realname', FILTER_SANITIZE_SPECIAL_CHARS, '');
   873|         $email = Filter::filterInput(INPUT_POST, 'email', FILTER_SANITIZE_EMAIL, '');
   874|         $permLevel = Filter::filterInput(INPUT_POST, 'permLevel', FILTER_SANITIZE_SPECIAL_CHARS, 'basic');
   875|         $rootDir = $setup['rootDir'] ?? PMF_ROOT_DIR;
   876|         $instanceSetup = new Setup();
   877|         $instanceSetup->setRootDir($rootDir);
   878|         if (!$instanceSetup->createDatabaseFile($dbSetup)) {
   879|             self::cleanFailedInstallationFiles();
   880|             throw new Exception('Installation Error: Setup cannot write to ./content/core/config/database.php.');
   881|         }
   882|         if (
   883|             extension_loaded('ldap') &&
   884|             !is_null($ldapEnabled) &&
   885|             count($ldapSetup) &&
   886|             !$instanceSetup->createLdapFile($ldapSetup, '')
   887|         ) {
   888|             self::cleanFailedInstallationFiles();
   889|             throw new Exception('LDAP Installation Error: Setup cannot write to ./content/core/config/ldap.php.');
   890|         }
   891|         if (!is_null($esEnabled) && count($esSetup) && !$instanceSetup->createElasticsearchFile($esSetup, '')) {
   892|             self::cleanFailedInstallationFiles();
   893|             throw new Exception(
   894|                 'Elasticsearch Installation Error: Setup cannot write to ./content/core/config/elasticsearch.php.'
   895|             );
   896|         }
   897|         $databaseConfiguration = new DatabaseConfiguration($rootDir . '/content/core/config/database.php');
   898|         try {
   899|             $db = Database::factory($dbSetup['dbType']);
   900|         } catch (Exception $exception) {
   901|             self::cleanFailedInstallationFiles();
   902|             throw new Exception(sprintf('Database Installation Error: %s', $exception->getMessage()));
   903|         }
   904|         $db->connect(
   905|             $databaseConfiguration->getServer(),
   906|             $databaseConfiguration->getUser(),
   907|             $databaseConfiguration->getPassword(),
   908|             $databaseConfiguration->getDatabase(),
   909|             $databaseConfiguration->getPort()
   910|         );
   911|         if (!$db instanceof DatabaseDriver) {
   912|             self::cleanFailedInstallationFiles();
   913|             throw new Exception(sprintf('Database Installation Error: %s', $db->error()));
   914|         }
   915|         try {
   916|             $databaseInstaller = InstanceDatabase::factory($configuration, $dbSetup['dbType']);
   917|             $databaseInstaller->createTables($dbSetup['dbPrefix']);
   918|         } catch (Exception $exception) {
   919|             self::cleanFailedInstallationFiles();
   920|             throw new Exception(sprintf('Database Installation Error: %s', $exception->getMessage()));
   921|         }
   922|         $stopWords = new Stopwords($configuration);
   923|         $stopWords->executeInsertQueries($dbSetup['dbPrefix']);
   924|         $this->system->setDatabase($db);
   925|         if (!System::isSqlite($dbSetup['dbType'])) {
   926|             $this->system->dropTables($uninstall);
   927|         }
   928|         $count = 0;
   929|         foreach ($query as $executeQuery) {
   930|             $result = @$db->query($executeQuery);
   931|             if (!$result) {
   932|                 $this->system->dropTables($uninstall);
   933|                 self::cleanFailedInstallationFiles();
   934|                 throw new Exception(
   935|                     sprintf(
   936|                         'Installation Error: Please install your version of phpMyFAQ once again: %s (%s)',
   937|                         $db->error(),
   938|                         htmlentities($executeQuery)
   939|                     )
   940|                 );
   941|             }
   942|             usleep(1000);
   943|             ++$count;
   944|             if ($count % 10 === 0) {
   945|                 echo '| ';
   946|             }
   947|         }
   948|         $link = new Link('', $configuration);
   949|         $this->mainConfig['main.metaPublisher'] = $realname;
   950|         $this->mainConfig['main.administrationMail'] = $email;
   951|         $this->mainConfig['main.language'] = $language;
   952|         $this->mainConfig['security.permLevel'] = $permLevel;
   953|         foreach ($this->mainConfig as $name => $value) {
   954|             $configuration->add($name, $value);
   955|         }
   956|         $configuration->update(['main.referenceURL' => $setup['mainUrl'] ?? $link->getSystemUri('/setup/index.php')]);
   957|         $configuration->add('security.salt', md5($configuration->getDefaultUrl()));
   958|         $user = new User($configuration);
   959|         if (!$user->createUser($loginName, $password, '', 1)) {
   960|             self::cleanFailedInstallationFiles();
   961|             throw new Exception(
   962|                 sprintf('Fatal Installation Error: Could not create the admin user: %s', $user->error())
   963|             );
   964|         }
   965|         $user->setStatus('protected');
   966|         $adminData = [
   967|             'display_name' => $realname,
   968|             'email' => $email,
   969|         ];
   970|         $user->setUserData($adminData);
   971|         $user->setSuperAdmin(true);
   972|         foreach ($this->mainRights as $mainRight) {
   973|             $user->perm->grantUserRight(1, $user->perm->addRight($mainRight));
   974|         }
   975|         $forms = new Forms($configuration);
   976|         foreach ($this->formInputs as $input) {
   977|             $forms->insertInputIntoDatabase($input);
   978|         }
   979|         $instanceSetup->createAnonymousUser($configuration);
   980|         $instanceEntity = new InstanceEntity();
   981|         $instanceEntity
   982|             ->setUrl($link->getSystemUri($_SERVER['SCRIPT_NAME']))
   983|             ->setInstance($link->getSystemRelativeUri('setup/index.php'))
   984|             ->setComment('phpMyFAQ ' . System::getVersion());
   985|         $faqInstance = new Instance($configuration);
   986|         $faqInstance->create($instanceEntity);
   987|         $faqMainInstance = new Main($configuration);
   988|         $faqMainInstance->createMain($faqInstance);
   989|         if (!is_null($esEnabled) && is_file($rootDir . '/config/elasticsearch.php')) {
   990|             $elasticsearchConfiguration = new ElasticsearchConfiguration($rootDir . '/config/elasticsearch.php');
   991|             $configuration->setElasticsearchConfig($elasticsearchConfiguration);
   992|             $esClient = ClientBuilder::create()->setHosts($elasticsearchConfiguration->getHosts())->build();
   993|             $configuration->setElasticsearch($esClient);
   994|             $faqInstanceElasticsearch = new Elasticsearch($configuration);
   995|             $faqInstanceElasticsearch->createIndex();
   996|         }
   997|         $configurator = new EnvironmentConfigurator($configuration);
   998|         $configurator->adjustRewriteBaseHtaccess();
   999|     }
  1000|     /**
  1001|      * Checks the minimum required PHP version, defined in System class.
  1002|      * Returns true if it's okay.
  1003|      */
  1004|     public function checkMinimumPhpVersion(): bool
  1005|     {
  1006|         return version_compare(PHP_VERSION, System::VERSION_MINIMUM_PHP) >= 0;
  1007|     }
  1008|     public function hasLdapSupport(): bool
  1009|     {
  1010|         return extension_loaded('ldap');
  1011|     }
  1012|     public function hasElasticsearchSupport(): bool
  1013|     {
  1014|         return extension_loaded('curl') && extension_loaded('openssl');
  1015|     }
  1016| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Setup/Update.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-739 ---
     1| <?php
     2| /**
     3|  * The Update class updates phpMyFAQ. Classy.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2023-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2023-04-03
    15|  */
    16| namespace phpMyFAQ\Setup;
    17| use phpMyFAQ\Configuration;
    18| use phpMyFAQ\Core\Exception;
    19| use phpMyFAQ\Database;
    20| use phpMyFAQ\Database\DatabaseDriver;
    21| use phpMyFAQ\Enums\ReleaseType;
    22| use phpMyFAQ\Filesystem;
    23| use phpMyFAQ\Forms;
    24| use phpMyFAQ\Setup;
    25| use phpMyFAQ\System;
    26| use phpMyFAQ\User;
    27| use RecursiveDirectoryIterator;
    28| use RecursiveIteratorIterator;
    29| use SplFileObject;
    30| use Symfony\Component\HttpFoundation\Request;
    31| use Tivie\HtaccessParser\Exception\SyntaxException;
    32| use Tivie\HtaccessParser\Parser;
    33| use ZipArchive;
    34| use const Tivie\HtaccessParser\Token\TOKEN_DIRECTIVE;
    35| class Update extends Setup
    36| {
    37|     private string $version;
    38|     /** @var string[] */
    39|     private array $queries = [];
    40|     private bool $dryRun = false;
    41|     /** @var string[] */
    42|     private array $dryRunQueries = [];
    43|     public function __construct(protected System $system, private readonly Configuration $configuration)
    44|     {
    45|         parent::__construct($this->system);
    46|     }
    47|     public function setVersion(string $version): void
    48|     {
    49|         $this->version = $version;
    50|     }
    51|     /**
    52|      * Checks if the "faqconfig" table is available
    53|      */
    54|     public function isConfigTableNotAvailable(DatabaseDriver $databaseDriver): bool
    55|     {
    56|         $query = sprintf('SELECT * FROM %s%s', Database::getTablePrefix(), 'faqconfig');
    57|         $result = $databaseDriver->query($query);
    58|         return $databaseDriver->numRows($result) === 0;
    59|     }
    60|     /**
    61|      * Creates a backup of the current config files
    62|      * @throws Exception
    63|      */
    64|     public function createConfigBackup(string $configDir): string
    65|     {
    66|         $outputZipFile = $configDir . DIRECTORY_SEPARATOR . $this->getBackupFilename();
    67|         $zipArchive = new ZipArchive();
    68|         if ($zipArchive->open($outputZipFile, ZipArchive::CREATE | ZipArchive::OVERWRITE) !== true) {
    69|             throw new Exception('Cannot create config backup file.');
    70|         }
    71|         $files = new RecursiveIteratorIterator(
    72|             new RecursiveDirectoryIterator($configDir),
    73|             RecursiveIteratorIterator::SELF_FIRST
    74|         );
    75|         foreach ($files as $file) {
    76|             $file = realpath($file);
    77|             if (str_contains($file, $configDir . DIRECTORY_SEPARATOR)) {
    78|                 if (is_dir($file)) {
    79|                     $zipArchive->addEmptyDir(
    80|                         str_replace($configDir . DIRECTORY_SEPARATOR, '', $file . DIRECTORY_SEPARATOR)
    81|                     );
    82|                 } elseif (is_file($file)) {
    83|                     $zipArchive->addFile($file, str_replace($configDir . DIRECTORY_SEPARATOR, '', $file));
    84|                 }
    85|             }
    86|         }
    87|         $zipArchive->close();
    88|         if (!file_exists($outputZipFile)) {
    89|             throw new Exception('Cannot store config backup file.');
    90|         }
    91|         return $this->configuration->getDefaultUrl() . 'content/core/config/' . $this->getBackupFilename();
    92|     }
    93|     /**
    94|      * @throws Exception
    95|      */
    96|     public function checkInitialRewriteBasePath(Request $request): bool
    97|     {
    98|         $basePath = $request->getBasePath();
    99|         $basePath = rtrim($basePath, 'update');
   100|         $htaccessPath = PMF_ROOT_DIR . '/.htaccess';
   101|         $file = new SplFileObject($htaccessPath);
   102|         $parser = new Parser();
   103|         try {
   104|             $htaccess = $parser->parse($file);
   105|         } catch (SyntaxException $e) {
   106|             throw new Exception('Syntax error in .htaccess file: ' . $e->getMessage());
   107|         } catch (\Tivie\HtaccessParser\Exception\Exception $e) {
   108|             throw new Exception('Error parsing .htaccess file: ' . $e->getMessage());
   109|         }
   110|         $rewriteBase = $htaccess->search('RewriteBase', TOKEN_DIRECTIVE);
   111|         $rewriteBase->removeArgument($rewriteBase->getArguments()[0]);
   112|         $rewriteBase->setArguments((array)$basePath);
   113|         $output = (string) $htaccess;
   114|         return file_put_contents($htaccessPath, $output);
   115|     }
   116|     /**
   117|      * @throws Exception
   118|      * @throws \Exception
   119|      */
   120|     public function applyUpdates(callable $progressCallback): bool
   121|     {
   122|         $this->applyUpdates310Alpha();
   123|         $this->applyUpdates310Alpha3();
   124|         $this->applyUpdates310Beta();
   125|         $this->applyUpdates310RC();
   126|         $this->applyUpdates320Alpha();
   127|         $this->applyUpdates320Beta();
   128|         $this->applyUpdates320Beta2();
   129|         $this->applyUpdates320RC();
   130|         $this->applyUpdates323();
   131|         $this->applyUpdates400Alpha();
   132|         $this->applyUpdates400Alpha2();
   133|         $this->applyUpdates400Alpha3();
   134|         $this->applyUpdates400Beta2();
   135|         $this->optimizeTables();
   136|         $this->executeQueries($progressCallback);
   137|         $this->updateVersion();
   138|         return true;
   139|     }
   140|     public function optimizeTables(): void
   141|     {
   142|         switch (Database::getType()) {
   143|             case 'mysqli':
   144|                 $this->configuration->getDb()->getTableNames(Database::getTablePrefix());
   145|                 foreach ($this->configuration->getDb()->tableNames as $tableName) {
   146|                     $this->queries[] = 'OPTIMIZE TABLE ' . $tableName;
   147|                 }
   148|                 break;
   149|             case 'pgsql':
   150|                 $this->queries[] = 'VACUUM ANALYZE;';
   151|                 break;
   152|         }
   153|     }
   154|     public function setDryRun(bool $dryRun): void
   155|     {
   156|         $this->dryRun = $dryRun;
   157|     }
   158|     public function getDryRunQueries(): array
   159|     {
   160|         return $this->dryRunQueries;
   161|     }
   162|     /**
   163|      * @throws Exception
   164|      */
   165|     private function executeQueries(callable $progressCallback): void
   166|     {
   167|         if ($this->dryRun) {
   168|             foreach ($this->queries as $query) {
   169|                 array_push($this->dryRunQueries, $query);
   170|             }
   171|         } else {
   172|             foreach ($this->queries as $query) {
   173|                 try {
   174|                     $this->configuration->getDb()->query($query);
   175|                     $progressCallback($query);
   176|                 } catch (Exception $exception) {
   177|                     throw new Exception($exception->getMessage());
   178|                 }
   179|             }
   180|         }
   181|     }
   182|     private function applyUpdates310Alpha(): void
   183|     {
   184|         if (version_compare($this->version, '3.1.0-alpha', '<')) {
   185|             if ('sqlite3' === Database::getType()) {
   186|                 $this->queries[] = sprintf(
   187|                     'ALTER TABLE %sfaquserdata ADD COLUMN is_visible INT(1) DEFAULT 0',
   188|                     Database::getTablePrefix()
   189|                 );
   190|             } else {
   191|                 $this->queries[] = sprintf(
   192|                     'ALTER TABLE %sfaquserdata ADD is_visible INTEGER DEFAULT 0',
   193|                     Database::getTablePrefix()
   194|                 );
   195|             }
   196|             $this->configuration->delete('main.enableRssFeeds');
   197|             $this->configuration->add('api.enableAccess', true);
   198|             $this->configuration->add('api.apiClientToken', '');
   199|             $this->configuration->add('security.domainWhiteListForRegistrations', '');
   200|         }
   201|     }
   202|     private function applyUpdates310Alpha3(): void
   203|     {
   204|         if (version_compare($this->version, '3.1.0-alpha.3', '<')) {
   205|             $this->configuration->add('main.loginWithEmailAddress', false);
   206|         }
   207|     }
   208|     private function applyUpdates310Beta(): void
   209|     {
   210|         if (version_compare($this->version, '3.1.0-beta', '<')) {
   211|             $this->queries[] = match (Database::getType()) {
   212|                 'mysqli' => sprintf(
   213|                     'CREATE TABLE %sfaqcategory_order 
   214|                     (category_id int(11) NOT NULL, position int(11) NOT NULL, PRIMARY KEY (category_id))',
   215|                     Database::getTablePrefix()
   216|                 ),
   217|                 'pgsql', 'sqlite3', 'sqlsrv' => sprintf(
   218|                     'CREATE TABLE %sfaqcategory_order 
   219|                     (category_id INTEGER NOT NULL, position INTEGER NOT NULL, PRIMARY KEY (category_id))',
   220|                     Database::getTablePrefix()
   221|                 ),
   222|             };
   223|         }
   224|     }
   225|     private function applyUpdates310RC(): void
   226|     {
   227|         if (version_compare($this->version, '3.1.0-RC', '<')) {
   228|             $this->configuration->delete('records.autosaveActive');
   229|             $this->configuration->delete('records.autosaveSecs');
   230|         }
   231|     }
   232|     private function applyUpdates320Alpha(): void
   233|     {
   234|         if (version_compare($this->version, '3.2.0-alpha', '<')) {
   235|             $this->configuration->add('security.enableSignInWithMicrosoft', false);
   236|             if ('sqlite3' === Database::getType()) {
   237|                 $this->queries[] = sprintf(
   238|                     'ALTER TABLE %sfaquser 
   239|                         ADD COLUMN refresh_token TEXT NULL DEFAULT NULL,
   240|                         ADD COLUMN access_token TEXT NULL DEFAULT NULL,
   241|                         ADD COLUMN code_verifier VARCHAR(255) NULL DEFAULT NULL,
   242|                         ADD COLUMN jwt TEXT NULL DEFAULT NULL;',
   243|                     Database::getTablePrefix()
   244|                 );
   245|                 $this->queries[] = sprintf(
   246|                     'ALTER TABLE %sfaquserdata
   247|                         ADD COLUMN twofactor_enabled INT(1) NULL DEFAULT 0,
   248|                         ADD COLUMN secret VARCHAR(128) NULL DEFAULT NULL',
   249|                     Database::getTablePrefix()
   250|                 );
   251|             } else {
   252|                 $this->queries[] = sprintf(
   253|                     'ALTER TABLE %sfaquser 
   254|                         ADD refresh_token TEXT NULL DEFAULT NULL,
   255|                         ADD access_token TEXT NULL DEFAULT NULL,
   256|                         ADD code_verifier VARCHAR(255) NULL DEFAULT NULL,
   257|                         ADD jwt TEXT NULL DEFAULT NULL;',
   258|                     Database::getTablePrefix()
   259|                 );
   260|                 $this->queries[] = sprintf(
   261|                     'ALTER TABLE %sfaquserdata
   262|                         ADD twofactor_enabled INT NULL DEFAULT 0,
   263|                         ADD secret VARCHAR(128) NULL DEFAULT NULL',
   264|                     Database::getTablePrefix()
   265|                 );
   266|             }
   267|             $this->queries[] = sprintf(
   268|                 'CREATE TABLE %sfaqbackup (
   269|                     id INT NOT NULL,
   270|                     filename VARCHAR(255) NOT NULL,
   271|                     authkey VARCHAR(255) NOT NULL,
   272|                     authcode VARCHAR(255) NOT NULL,
   273|                     created timestamp NOT NULL,
   274|                     PRIMARY KEY (id))',
   275|                 Database::getTablePrefix()
   276|             );
   277|             if ('mysqli' === Database::getType()) {
   278|                 $this->queries[] = sprintf('ALTER TABLE %sfaqdata ENGINE=INNODB', Database::getTablePrefix());
   279|             }
   280|             $this->configuration->add('main.enableAskQuestions', true);
   281|             $this->configuration->add('main.enableNotifications', true);
   282|             $this->configuration->rename('security.loginWithEmailAddress', 'security.loginWithEmailAddress');
   283|             if ($this->configuration->get('security.permLevel') === 'large') {
   284|                 $this->configuration->set('security.permLevel', 'medium');
   285|             }
   286|             $this->configuration->add('security.enableGoogleReCaptchaV2', false);
   287|             $this->configuration->add('security.googleReCaptchaV2SiteKey', '');
   288|             $this->configuration->add('security.googleReCaptchaV2SecretKey', '');
   289|             $this->queries[] = sprintf('DROP TABLE %sfaqsections', Database::getTablePrefix());
   290|             $this->queries[] = sprintf('DROP TABLE %sfaqsection_category', Database::getTablePrefix());
   291|             $this->queries[] = sprintf('DROP TABLE %sfaqsection_group', Database::getTablePrefix());
   292|             $this->queries[] = sprintf('DROP TABLE %sfaqsection_news', Database::getTablePrefix());
   293|         }
   294|     }
   295|     private function applyUpdates320Beta(): void
   296|     {
   297|         if (version_compare($this->version, '3.2.0-beta', '<')) {
   298|             $this->configuration->add('mail.remoteSMTPDisableTLSPeerVerification', false);
   299|             $this->configuration->delete('main.enableLinkVerification');
   300|             $this->queries[] = sprintf(
   301|                 'ALTER TABLE %sfaqdata DROP COLUMN links_state, DROP COLUMN links_check_date',
   302|                 Database::getTablePrefix()
   303|             );
   304|             $this->queries[] = sprintf(
   305|                 'ALTER TABLE %sfaqdata_revisions DROP COLUMN links_state, DROP COLUMN links_check_date',
   306|                 Database::getTablePrefix()
   307|             );
   308|             switch (Database::getType()) {
   309|                 case 'mysqli':
   310|                     $this->queries[] = sprintf(
   311|                         'ALTER TABLE %sfaqconfig MODIFY config_value TEXT DEFAULT NULL',
   312|                         Database::getTablePrefix()
   313|                     );
   314|                     break;
   315|                 case 'pgsql':
   316|                     $this->queries[] = sprintf(
   317|                         'ALTER TABLE %sfaqconfig ALTER COLUMN config_value TYPE TEXT',
   318|                         Database::getTablePrefix()
   319|                     );
   320|                     break;
   321|                 case 'sqlite3':
   322|                     $this->queries[] = sprintf(
   323|                         'CREATE TABLE %sfaqconfig_new (
   324|                             config_name VARCHAR(255) NOT NULL default \'\', 
   325|                             config_value TEXT DEFAULT NULL, PRIMARY KEY (config_name)
   326|                          )',
   327|                         Database::getTablePrefix()
   328|                     );
   329|                     $this->queries[] = sprintf(
   330|                         'INSERT INTO %sfaqconfig_new SELECT config_name, config_value FROM %sfaqconfig',
   331|                         Database::getTablePrefix(),
   332|                         Database::getTablePrefix()
   333|                     );
   334|                     $this->queries[] = sprintf(
   335|                         'DROP TABLE %sfaqconfig',
   336|                         Database::getTablePrefix()
   337|                     );
   338|                     $this->queries[] = sprintf(
   339|                         'ALTER TABLE %sfaqconfig_new RENAME TO %sfaqconfig',
   340|                         Database::getTablePrefix(),
   341|                         Database::getTablePrefix()
   342|                     );
   343|                     break;
   344|                 case 'sqlsrv':
   345|                     $this->queries[] = sprintf(
   346|                         'ALTER TABLE %sfaqconfig ALTER COLUMN config_value TEXT',
   347|                         Database::getTablePrefix()
   348|                     );
   349|                     break;
   350|             }
   351|         }
   352|     }
   353|     private function applyUpdates320Beta2(): void
   354|     {
   355|         if (version_compare($this->version, '3.2.0-beta.2', '<')) {
   356|             $this->configuration->add('main.contactInformationHTML', false);
   357|             $this->configuration->rename('main.contactInformations', 'main.contactInformation');
   358|         }
   359|     }
   360|     private function applyUpdates320RC(): void
   361|     {
   362|         if (version_compare($this->version, '3.2.0-RC', '<')) {
   363|             $this->configuration->add('spam.mailAddressInExport', true);
   364|         }
   365|     }
   366|     private function applyUpdates323(): void
   367|     {
   368|         if (version_compare($this->version, '3.2.3', '<')) {
   369|             switch (Database::getType()) {
   370|                 case 'mysqli':
   371|                     $this->queries[] = sprintf(
   372|                         'ALTER TABLE %sfaquser CHANGE ip ip VARCHAR(64) NULL DEFAULT NULL',
   373|                         Database::getTablePrefix()
   374|                     );
   375|                     break;
   376|                 case 'pgsql':
   377|                     $this->queries[] = sprintf(
   378|                         'ALTER TABLE %sfaquser ALTER COLUMN ip TYPE VARCHAR(64)',
   379|                         Database::getTablePrefix()
   380|                     );
   381|                     break;
   382|                 case 'sqlite3':
   383|                     $this->queries[] = sprintf(
   384|                         'CREATE TABLE %sfaquser_new (
   385|                         user_id INTEGER NOT NULL,
   386|                         login VARCHAR(128) NOT NULL,
   387|                         session_id VARCHAR(150) NULL,
   388|                         session_timestamp INTEGER NULL,
   389|                         ip VARCHAR(64) NULL,
   390|                         account_status VARCHAR(50) NULL,
   391|                         last_login VARCHAR(14) NULL,
   392|                         auth_source VARCHAR(100) NULL,
   393|                         member_since VARCHAR(14) NULL,
   394|                         remember_me VARCHAR(150) NULL,
   395|                         success INT(1) NULL DEFAULT 1,
   396|                         is_superadmin INT(1) NULL DEFAULT 0,
   397|                         login_attempts INT(1) NULL DEFAULT 0,
   398|                         refresh_token TEXT NULL DEFAULT NULL,
   399|                         access_token TEXT NULL DEFAULT NULL,
   400|                         code_verifier VARCHAR(255) NULL DEFAULT NULL,
   401|                         jwt TEXT NULL DEFAULT NULL,
   402|                         PRIMARY KEY (user_id))',
   403|                         Database::getTablePrefix()
   404|                     );
   405|                     $this->queries[] = sprintf(
   406|                         'INSERT INTO %sfaquser_new SELECT * FROM %sfaquser',
   407|                         Database::getTablePrefix(),
   408|                         Database::getTablePrefix(),
   409|                     );
   410|                     $this->queries[] = sprintf(
   411|                         'DROP TABLE %sfaquser',
   412|                         Database::getTablePrefix()
   413|                     );
   414|                     $this->queries[] = sprintf(
   415|                         'ALTER TABLE %sfaquser_new RENAME TO %sfaquser',
   416|                         Database::getTablePrefix(),
   417|                         Database::getTablePrefix(),
   418|                     );
   419|                     break;
   420|                 case 'sqlsrv':
   421|                     $this->queries[] = sprintf(
   422|                         'ALTER TABLE %sfaquser ALTER COLUMN ip VARCHAR(64)',
   423|                         Database::getTablePrefix()
   424|                     );
   425|                     break;
   426|             }
   427|         }
   428|     }
   429|     /**
   430|      * @throws Exception
   431|      */
   432|     private function applyUpdates400Alpha(): void
   433|     {
   434|         if (version_compare($this->version, '4.0.0-alpha', '<')) {
   435|             $fileSystem = new Filesystem(PMF_ROOT_DIR);
   436|             $fileSystem->copy(
   437|                 PMF_LEGACY_CONFIG_DIR . '/database.php',
   438|                 PMF_CONFIG_DIR . '/database.php'
   439|             );
   440|             if (file_exists(PMF_LEGACY_CONFIG_DIR . '/azure.php')) {
   441|                 $fileSystem->copy(
   442|                     PMF_LEGACY_CONFIG_DIR . '/azure.php',
   443|                     PMF_CONFIG_DIR . '/azure.php'
   444|                 );
   445|             }
   446|             if (file_exists(PMF_LEGACY_CONFIG_DIR . '/elasticsearch.php')) {
   447|                 $fileSystem->copy(
   448|                     PMF_LEGACY_CONFIG_DIR . '/elasticsearch.php',
   449|                     PMF_CONFIG_DIR . '/elasticsearch.php'
   450|                 );
   451|             }
   452|             if (file_exists(PMF_LEGACY_CONFIG_DIR . '/ldap.php')) {
   453|                 $fileSystem->copy(
   454|                     PMF_LEGACY_CONFIG_DIR . '/ldap.php',
   455|                     PMF_CONFIG_DIR . '/ldap.php'
   456|                 );
   457|             }
   458|             $fileSystem->recursiveCopy(
   459|                 PMF_ROOT_DIR . '/data',
   460|                 PMF_ROOT_DIR . '/content/core'
   461|             );
   462|             $fileSystem->recursiveCopy(
   463|                 PMF_ROOT_DIR . '/logs',
   464|                 PMF_ROOT_DIR . '/content/core'
   465|             );
   466|             $fileSystem->recursiveCopy(
   467|                 PMF_ROOT_DIR . '/attachments',
   468|                 PMF_ROOT_DIR . '/content/user'
   469|             );
   470|             $fileSystem->recursiveCopy(
   471|                 PMF_ROOT_DIR . '/images',
   472|                 PMF_ROOT_DIR . '/content/user'
   473|             );
   474|             $this->configuration->add('upgrade.onlineUpdateEnabled', true);
   475|             $this->configuration->add('upgrade.releaseEnvironment', ReleaseType::DEVELOPMENT->value);
   476|             $this->configuration->add('upgrade.dateLastChecked', '');
   477|             $this->configuration->add('upgrade.lastDownloadedPackage', '');
   478|             $this->configuration->delete('main.enableRewriteRules');
   479|             $this->configuration->delete('socialnetworks.enableTwitterSupport');
   480|             $this->configuration->delete('socialnetworks.twitterConsumerKey');
   481|             $this->configuration->delete('socialnetworks.twitterConsumerSecret');
   482|             $this->configuration->delete('socialnetworks.twitterAccessTokenKey');
   483|             $this->configuration->delete('socialnetworks.twitterAccessTokenSecret');
   484|             $this->configuration->delete('socialnetworks.disableAll');
   485|             $this->configuration->delete('mail.remoteSMTPEncryption');
   486|             $this->queries[] = match (Database::getType()) {
   487|                 'mysqli' => sprintf(
   488|                     'CREATE TABLE %sfaqbookmarks (userid int(11) DEFAULT NULL, faqid int(11) DEFAULT NULL)',
   489|                     Database::getTablePrefix()
   490|                 ),
   491|                 'pgsql', 'sqlite3', 'sqlsrv' => sprintf(
   492|                     'CREATE TABLE %sfaqbookmarks (userid INTEGER DEFAULT NULL, faqid INTEGER DEFAULT NULL)',
   493|                     Database::getTablePrefix()
   494|                 ),
   495|             };
   496|             $this->queries[] = match (Database::getType()) {
   497|                 'mysqli' => sprintf(
   498|                     'ALTER TABLE %sfaqdata ADD COLUMN sticky_order int(10) DEFAULT NULL',
   499|                     Database::getTablePrefix()
   500|                 ),
   501|                 'pgsql', 'sqlite3', 'sqlsrv' => sprintf(
   502|                     'ALTER TABLE %sfaqdata ADD COLUMN sticky_order integer DEFAULT NULL',
   503|                     Database::getTablePrefix()
   504|                 ),
   505|             };
   506|             $this->queries[] = match (Database::getType()) {
   507|                 'mysqli' => sprintf(
   508|                     'ALTER TABLE %sfaqdata_revisions ADD COLUMN sticky_order int(10) DEFAULT NULL',
   509|                     Database::getTablePrefix()
   510|                 ),
   511|                 'pgsql', 'sqlite3', 'sqlsrv' => sprintf(
   512|                     'ALTER TABLE %sfaqdata_revisions ADD COLUMN sticky_order integer DEFAULT NULL',
   513|                     Database::getTablePrefix()
   514|                 ),
   515|             };
   516|             $this->configuration->add('records.orderStickyFaqsCustom', 'false');
   517|             $this->queries[] = sprintf('DROP TABLE %sfaqmeta', Database::getTablePrefix());
   518|             $this->configuration->add('main.botIgnoreList', 'nustcrape,webpost,GoogleBot,msnbot,crawler,scooter,
   519|             bravobrian,archiver,w3c,controler,wget,bot,spider,Yahoo! Slurp,htdig,gsa-crawler,AirControler,Uptime-Kuma');
   520|             $this->configuration->add('main.enableCookieConsent', true);
   521|             switch (Database::getType()) {
   522|                 case 'mysqli':
   523|                     $this->queries[] = sprintf(
   524|                         'ALTER TABLE %sfaqcategory_order ADD COLUMN parent_id int(11) DEFAULT NULL AFTER category_id',
   525|                         Database::getTablePrefix()
   526|                     );
   527|                     break;
   528|                 case 'sqlsrv':
   529|                     $this->queries[] = sprintf(
   530|                         'ALTER TABLE %sfaqcategory_order ADD COLUMN parent_id INTEGER DEFAULT NULL AFTER category_id',
   531|                         Database::getTablePrefix()
   532|                     );
   533|                     break;
   534|                 case 'sqlite3':
   535|                 case 'pgsql':
   536|                     $this->queries[] = sprintf(
   537|                         'CREATE TABLE %sfaqcategory_order_new (
   538|                             category_id INTEGER NOT NULL,
   539|                             parent_id INTEGER DEFAULT NULL,
   540|                             position INTEGER NOT NULL,
   541|                             PRIMARY KEY (category_id))',
   542|                         Database::getTablePrefix()
   543|                     );
   544|                     $this->queries[] = sprintf(
   545|                         'INSERT INTO %sfaqcategory_order_new SELECT * FROM %sfaqcategory_order',
   546|                         Database::getTablePrefix(),
   547|                         Database::getTablePrefix()
   548|                     );
   549|                     $this->queries[] = sprintf(
   550|                         'DROP TABLE %sfaqcategory_order',
   551|                         Database::getTablePrefix()
   552|                     );
   553|                     $this->queries[] = sprintf(
   554|                         'ALTER TABLE %sfaqcategory_order_new RENAME TO %sfaqcategory_order',
   555|                         Database::getTablePrefix(),
   556|                         Database::getTablePrefix()
   557|                     );
   558|                     break;
   559|             }
   560|         }
   561|     }
   562|     /**
   563|      * @throws Exception
   564|      * @throws \Exception
   565|      */
   566|     private function applyUpdates400Alpha2(): void
   567|     {
   568|         if (version_compare($this->version, '4.0.0-alpha.2', '<')) {
   569|             $this->configuration->delete('main.optionalMailAddress');
   570|             $user = new User($this->configuration);
   571|             $rightData = [
   572|                 'name' => 'forms_edit',
   573|                 'description' => 'Right to edit forms'
   574|             ];
   575|             $user->perm->grantUserRight(1, $user->perm->addRight($rightData));
   576|             switch (Database::getType()) {
   577|                 case 'mysqli':
   578|                     $this->queries[] = sprintf(
   579|                         'CREATE TABLE %sfaqforms (
   580|                         form_id INT(1) NOT NULL,
   581|                         input_id INT(11) NOT NULL,
   582|                         input_type VARCHAR(1000) NOT NULL,
   583|                         input_label VARCHAR(100) NOT NULL,
   584|                         input_active INT(1) NOT NULL,
   585|                         input_required INT(1) NOT NULL,
   586|                         input_lang VARCHAR(11) NOT NULL)',
   587|                         Database::getTablePrefix()
   588|                     );
   589|                     break;
   590|                 case 'sqlsrv':
   591|                     $this->queries[] = sprintf(
   592|                         'CREATE TABLE %sfaqforms (
   593|                         form_id INTEGER NOT NULL,
   594|                         input_id INTEGER NOT NULL,
   595|                         input_type NVARCHAR(1000) NOT NULL,
   596|                         input_label NVARCHAR(100) NOT NULL,
   597|                         input_active INTEGER NOT NULL,
   598|                         input_required INTEGER NOT NULL,
   599|                         input_lang NVARCHAR(11) NOT NULL)',
   600|                         Database::getTablePrefix()
   601|                     );
   602|                     break;
   603|                 case 'sqlite3':
   604|                 case 'pgsql':
   605|                     $this->queries[] = sprintf(
   606|                         'CREATE TABLE %sfaqforms (
   607|                         form_id INTEGER NOT NULL,
   608|                         input_id INTEGER NOT NULL,
   609|                         input_type VARCHAR(1000) NOT NULL,
   610|                         input_label VARCHAR(100) NOT NULL,
   611|                         input_active INTEGER NOT NULL,
   612|                         input_required INTEGER NOT NULL,
   613|                         input_lang VARCHAR(11) NOT NULL)',
   614|                         Database::getTablePrefix()
   615|                     );
   616|                     break;
   617|             }
   618|             $forms = new Forms($this->configuration);
   619|             $installer = new Installer(new System());
   620|             foreach ($installer->formInputs as $input) {
   621|                 $this->queries[] = $forms->getInsertQueries($input);
   622|             }
   623|         }
   624|     }
   625|     /**
   626|      * @throws \Exception
   627|      */
   628|     private function applyUpdates400Alpha3(): void
   629|     {
   630|         if (version_compare($this->version, '4.0.0-alpha.3', '<')) {
   631|             switch (Database::getType()) {
   632|                 case 'mysqli':
   633|                     $this->queries[] = sprintf(
   634|                         'CREATE TABLE %sfaqseo (
   635|                             id INT(11) NOT NULL,
   636|                             type VARCHAR(32) NOT NULL,
   637|                             reference_id INT(11) NOT NULL,
   638|                             reference_language VARCHAR(5) NOT NULL,
   639|                             title TEXT DEFAULT NULL,
   640|                             description TEXT DEFAULT NULL,
   641|                             slug TEXT DEFAULT NULL,
   642|                             created DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
   643|                             PRIMARY KEY (id)) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB',
   644|                         Database::getTablePrefix()
   645|                     );
   646|                     break;
   647|                 case 'sqlsrv':
   648|                     $this->queries[] = sprintf(
   649|                         'CREATE TABLE %sfaqseo (
   650|                             id INT NOT NULL,
   651|                             type VARCHAR(32) NOT NULL,
   652|                             reference_id INT NOT NULL,
   653|                             reference_language VARCHAR(5) NOT NULL,
   654|                             title TEXT NULL,
   655|                             description TEXT NULL,
   656|                             slug TEXT NULL,
   657|                             created DATE NOT NULL DEFAULT GETDATE(),
   658|                             PRIMARY KEY (id))',
   659|                         Database::getTablePrefix()
   660|                     );
   661|                     break;
   662|                 case 'sqlite3':
   663|                     $this->queries[] = sprintf(
   664|                         'CREATE TABLE %sfaqseo (
   665|                             id INT NOT NULL,
   666|                             type VARCHAR(32) NOT NULL,
   667|                             reference_id INT NOT NULL,
   668|                             reference_language VARCHAR(5) NOT NULL,
   669|                             title TEXT NULL,
   670|                             description TEXT NULL,
   671|                             slug TEXT NULL,
   672|                             created DATE NOT NULL DEFAULT (date(\'now\')),
   673|                             PRIMARY KEY (id))',
   674|                         Database::getTablePrefix()
   675|                     );
   676|                     break;
   677|                 case 'pgsql':
   678|                     $this->queries[] = sprintf(
   679|                         'CREATE TABLE %sfaqseo (
   680|                             id INTEGER NOT NULL,
   681|                             type VARCHAR(32) NOT NULL,
   682|                             reference_id INTEGER NOT NULL,
   683|                             reference_language VARCHAR(5) NOT NULL,
   684|                             title TEXT,
   685|                             description TEXT,
   686|                             slug TEXT NULL,
   687|                             created DATE NOT NULL DEFAULT CURRENT_DATE,
   688|                             PRIMARY KEY (id))',
   689|                         Database::getTablePrefix()
   690|                     );
   691|                     break;
   692|             }
   693|             $this->configuration->update(['main.botIgnoreList' => 'nustcrape,webpost,GoogleBot,msnbot,crawler,scooter,
   694|             bravobrian,archiver,w3c,controler,wget,bot,spider,Yahoo! Slurp,htdig,gsa-crawler,AirControler,Uptime-Kuma,
   695|             facebookcatalog/1.0,facebookexternalhit/1.1 (+http://www.facebook.com/externalhit_uatext.php),
   696|             facebookexternalhit/1.1']);
   697|             $this->configuration->add('mail.noReplySenderAddress', '');
   698|             $this->configuration->add('records.allowedMediaHosts', 'www.youtube.com');
   699|             $this->configuration->add('seo.title', $this->configuration->get('main.titleFAQ'));
   700|             $this->configuration->add('seo.description', $this->configuration->get('main.metaDescription'));
   701|             $this->configuration->add('layout.enablePrivacyLink', 'true');
   702|             $this->configuration->add('layout.customCss', '');
   703|             $this->configuration->add('seo.enableRichSnippets', 'false');
   704|             $this->configuration->delete('main.urlValidateInterval');
   705|             $this->configuration->delete('main.enableGzipCompression');
   706|             $this->configuration->delete('main.metaKeywords');
   707|             $this->configuration->delete('main.send2friendText');
   708|             $this->configuration->rename('main.templateSet', 'layout.templateSet');
   709|             $this->configuration->rename('main.enableCookieConsent', 'layout.enableCookieConsent');
   710|             $this->configuration->rename('main.contactInformationHTML', 'layout.contactInformationHTML');
   711|         }
   712|     }
   713|     private function applyUpdates400Beta2(): void
   714|     {
   715|         if (version_compare($this->version, '4.0.0-beta.2', '<')) {
   716|             $this->configuration->add('security.enableWebAuthnSupport', false);
   717|             if ('sqlite3' === Database::getType()) {
   718|                 $this->queries[] = sprintf(
   719|                     'ALTER TABLE %sfaquser ADD COLUMN webauthnkeys TEXT NULL DEFAULT NULL;',
   720|                     Database::getTablePrefix()
   721|                 );
   722|             } else {
   723|                 $this->queries[] = sprintf(
   724|                     'ALTER TABLE %sfaquser ADD webauthnkeys TEXT NULL DEFAULT NULL;',
   725|                     Database::getTablePrefix()
   726|                 );
   727|             }
   728|         }
   729|     }
   730|     private function updateVersion(): void
   731|     {
   732|         $this->configuration->update(['main.currentApiVersion' => System::getApiVersion()]);
   733|         $this->configuration->update(['main.currentVersion' => System::getVersion()]);
   734|     }
   735|     private function getBackupFilename(): string
   736|     {
   737|         return sprintf('phpmyfaq-config-backup.%s.zip', date('Y-m-d'));
   738|     }
   739| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/System.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-366 ---
     1| <?php
     2| /**
     3|  * Class for checking system requirements.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2010-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2010-01-13
    15|  */
    16| namespace phpMyFAQ;
    17| use DateTime;
    18| use DirectoryIterator;
    19| use Exception;
    20| use phpMyFAQ\Database\DatabaseDriver;
    21| use phpMyFAQ\Template\TwigWrapper;
    22| use RecursiveDirectoryIterator;
    23| use RecursiveIteratorIterator;
    24| use Symfony\Component\HttpFoundation\Request;
    25| use UnexpectedValueException;
    26| /**
    27|  * Class System
    28|  *
    29|  * @package phpMyFAQ
    30|  */
    31| class System
    32| {
    33|     /**
    34|      * Major version.
    35|      */
    36|     private const VERSION_MAJOR = 4;
    37|     /**
    38|      * Minor version.
    39|      */
    40|     private const VERSION_MINOR = 0;
    41|     /**
    42|      * Patch level.
    43|      */
    44|     private const VERSION_PATCH_LEVEL = 2;
    45|     /**
    46|      * Pre-release version.
    47|      */
    48|     private const VERSION_PRE_RELEASE = '';
    49|     /**
    50|      * API version.
    51|      */
    52|     private const VERSION_API = '3.0';
    53|     /**
    54|      * Plugin version.
    55|      */
    56|     private const PLUGIN_VERSION = '0.1.0';
    57|     /**
    58|      * Minimum required PHP version.
    59|      */
    60|     final public const VERSION_MINIMUM_PHP = '8.2.0';
    61|     /**
    62|      * phpMyFAQ homepage URL
    63|      */
    64|     final public const PHPMYFAQ_URL = 'https://www.phpmyfaq.de/';
    65|     /**
    66|      * GitHub Issues URL
    67|      */
    68|     final public const GITHUB_ISSUES_URL = 'https://github.com/thorsten/phpMyFAQ/issues';
    69|     /**
    70|      * Array of required PHP extensions.
    71|      *
    72|      * @var array<string>
    73|      */
    74|     private array $requiredExtensions = [
    75|         'curl',
    76|         'fileinfo',
    77|         'filter',
    78|         'gd',
    79|         'json',
    80|         'sodium',
    81|         'xml',
    82|         'zip',
    83|     ];
    84|     /**
    85|      * Array of missing PHP extensions.
    86|      *
    87|      * @var array<string>
    88|      */
    89|     private array $missingExtensions = [];
    90|     /**
    91|      * Supported databases for phpMyFAQ.
    92|      *
    93|      * @var array<string, array<int, string>>
    94|      */
    95|     private array $supportedDatabases = [
    96|         'mysqli' => [
    97|             self::VERSION_MINIMUM_PHP,
    98|             'MySQL v8 / MariaDB v10 / Percona Server v8 / Galera Cluster v4 for MySQL',
    99|         ],
   100|         'pgsql' => [
   101|             self::VERSION_MINIMUM_PHP,
   102|             'PostgreSQL v10 or later',
   103|         ],
   104|         'sqlite3' => [
   105|             self::VERSION_MINIMUM_PHP,
   106|             'SQLite 3',
   107|         ],
   108|         'sqlsrv' => [
   109|             self::VERSION_MINIMUM_PHP,
   110|             'MS SQL Server 2016 or later',
   111|         ],
   112|     ];
   113|     /**
   114|      * Database handle.
   115|      */
   116|     private ?DatabaseDriver $database = null;
   117|     /**
   118|      * Returns the current version of phpMyFAQ for installation and
   119|      * version in the database.
   120|      * Releases will be numbered with the follow format:
   121|      * <major>.<minor>.<patch>[-<prerelease>]
   122|      */
   123|     public static function getVersion(): string
   124|     {
   125|         $version = sprintf('%d.%d.%d', self::VERSION_MAJOR, self::VERSION_MINOR, self::VERSION_PATCH_LEVEL);
   126|         return $version . (self::isDevelopmentVersion() ? '-' . self::VERSION_PRE_RELEASE : '');
   127|     }
   128|     /**
   129|      * Returns the current major version of phpMyFAQ
   130|      */
   131|     public static function getMajorVersion(): string
   132|     {
   133|         return sprintf('%d.%d', self::VERSION_MAJOR, self::VERSION_MINOR);
   134|     }
   135|     /**
   136|      * Returns the current API version of phpMyFAQ for installation and
   137|      * version in the database.
   138|      */
   139|     public static function getApiVersion(): string
   140|     {
   141|         return self::VERSION_API;
   142|     }
   143|     /**
   144|      * Returns the current plugin version of phpMyFAQ
   145|      */
   146|     public static function getPluginVersion(): string
   147|     {
   148|         return self::PLUGIN_VERSION;
   149|     }
   150|     public static function getPoweredByString(bool $withLink = false): string
   151|     {
   152|         if ($withLink) {
   153|             return sprintf(
   154|                 'powered with  and  by <a class="%s" target="_blank" href="%s">phpMyFAQ</a> %s',
   155|                 'link-light text-decoration-none',
   156|                 self::PHPMYFAQ_URL,
   157|                 self::getVersion()
   158|             );
   159|         }
   160|         return sprintf('powered with  and  by phpMyFAQ %s', self::getVersion());
   161|     }
   162|     /**
   163|      * Returns the URL of the documentation
   164|      */
   165|     public static function getDocumentationUrl(): string
   166|     {
   167|         return sprintf('%sdocs/%s', self::PHPMYFAQ_URL, self::getMajorVersion());
   168|     }
   169|     public static function getGitHubIssuesUrl(): string
   170|     {
   171|         return self::GITHUB_ISSUES_URL;
   172|     }
   173|     /**
   174|      * Returns true or false on SQLite3.
   175|      *
   176|      * @static
   177|      */
   178|     public static function isSqlite(string $dbType): bool
   179|     {
   180|         return 'sqlite3' === $dbType;
   181|     }
   182|     public static function isDevelopmentVersion(): bool
   183|     {
   184|         return strlen(self::VERSION_PRE_RELEASE) > 0;
   185|     }
   186|     public function getDatabase(): ?DatabaseDriver
   187|     {
   188|         return $this->database;
   189|     }
   190|     public function setDatabase(DatabaseDriver $databaseDriver): System
   191|     {
   192|         $this->database = $databaseDriver;
   193|         return $this;
   194|     }
   195|     /**
   196|      * Returns all available templates as array.
   197|      *
   198|      * @return array<string, bool>
   199|      */
   200|     public function getAvailableTemplates(): array
   201|     {
   202|         $templates = [];
   203|         $systemFolder = ['admin', 'setup'];
   204|         foreach (new DirectoryIterator(PMF_ROOT_DIR . '/assets/templates/') as $item) {
   205|             $basename = $item->getBasename();
   206|             if ($item->isDot()) {
   207|                 continue;
   208|             }
   209|             if (!$item->isDir()) {
   210|                 continue;
   211|             }
   212|             if (in_array($basename, $systemFolder)) {
   213|                 continue;
   214|             }
   215|             $templates[$basename] = TwigWrapper::getTemplateSetName() === $basename;
   216|         }
   217|         return $templates;
   218|     }
   219|     /**
   220|      * Returns the locally supported databases.
   221|      *
   222|      * @return array<string, string>
   223|      */
   224|     public function getSupportedSafeDatabases(): array
   225|     {
   226|         $databases = [];
   227|         foreach ($this->getSupportedDatabases() as $extension => $database) {
   228|             if (!extension_loaded($extension)) {
   229|                 continue;
   230|             }
   231|             if (version_compare(PHP_VERSION, $database[0]) < 0) {
   232|                 continue;
   233|             }
   234|             $databases[$extension] = $database[1];
   235|         }
   236|         return $databases;
   237|     }
   238|     /**
   239|      * Returns the supported databases.
   240|      *
   241|      * @return array<string, array<int, string>>
   242|      */
   243|     public function getSupportedDatabases(): array
   244|     {
   245|         return $this->supportedDatabases;
   246|     }
   247|     /**
   248|      * Checks if the system URI is running with http or https.
   249|      */
   250|     public function getSystemUri(Configuration $configuration): string
   251|     {
   252|         $mainUrl = $configuration->getDefaultUrl();
   253|         if (isset($_ENV['REQUEST_SCHEME']) && 'https' === $_ENV['REQUEST_SCHEME'] && !str_contains($mainUrl, 'https')) {
   254|             $mainUrl = str_replace('http://', 'https://', $mainUrl);
   255|         }
   256|         if (!str_ends_with($mainUrl, '/')) {
   257|             $mainUrl .= '/';
   258|         }
   259|         return $mainUrl;
   260|     }
   261|     /**
   262|      * Returns true, if phpMyFAQ is running on HTTPS
   263|      */
   264|     public function getHttpsStatus(): bool
   265|     {
   266|         return Request::createFromGlobals()->isSecure();
   267|     }
   268|     /**
   269|      * Checks for installed database extensions, if the first supported
   270|      * extension is enabled, return true.
   271|      */
   272|     public function checkDatabase(): bool
   273|     {
   274|         foreach (array_keys($this->supportedDatabases) as $extension) {
   275|             if (extension_loaded($extension)) {
   276|                 return true;
   277|             }
   278|         }
   279|         return false;
   280|     }
   281|     /**
   282|      * Checks for required PHP extensions.
   283|      */
   284|     public function checkRequiredExtensions(): bool
   285|     {
   286|         foreach ($this->requiredExtensions as $requiredExtension) {
   287|             if (!extension_loaded($requiredExtension)) {
   288|                 $this->missingExtensions[] = $requiredExtension;
   289|             }
   290|         }
   291|         return count($this->missingExtensions) <= 0;
   292|     }
   293|     /**
   294|      * Checks for an installed phpMyFAQ version
   295|      */
   296|     public function checkInstallation(): bool
   297|     {
   298|         return !is_file(PMF_ROOT_DIR . '/content/core/config/database.php');
   299|     }
   300|     /**
   301|      * Returns all missing extensions.
   302|      *
   303|      * @return array<string>
   304|      */
   305|     public function getMissingExtensions(): array
   306|     {
   307|         return $this->missingExtensions;
   308|     }
   309|     /**
   310|      * Creates a JSON object with all .php files of phpMyFAQ with their sha1 hashes.
   311|      *
   312|      * @throws Exception
   313|      */
   314|     public function createHashes(): string
   315|     {
   316|         $dateTime = new DateTime();
   317|         $files = new RecursiveIteratorIterator(
   318|             new RecursiveDirectoryIterator(PMF_ROOT_DIR),
   319|             RecursiveIteratorIterator::SELF_FIRST
   320|         );
   321|         $hashes = [
   322|             'created' => $dateTime->format('Y-m-d H:i:sP'),
   323|         ];
   324|         $ignoredFiles = [
   325|             '/content/core/config/azure.php' => false,
   326|             '/content/core/config/constants.php' => false,
   327|             '/content/core/config/constants_elasticsearch.php' => false,
   328|             '/content/core/config/database.php' => false,
   329|             '/content/core/config/elasticsearch.php' => false,
   330|             '/content/core/config/ldap.php' => false,
   331|         ];
   332|         $current = '';
   333|         try {
   334|             foreach ($files as $file) {
   335|                 if (
   336|                     'php' === pathinfo((string) $file->getFilename(), PATHINFO_EXTENSION) &&
   337|                     !str_contains((string)$file->getPath(), '/tests/') &&
   338|                     !str_contains((string)$file->getPath(), '/multisites/') &&
   339|                     !str_contains((string)$file->getPath(), '/upgrades/')
   340|                 ) {
   341|                     $current = str_replace(PMF_ROOT_DIR, '', (string) $file->getPathname());
   342|                     if (isset($ignoredFiles[$current])) {
   343|                         continue;
   344|                     }
   345|                     $hashes[$current] = sha1(file_get_contents($file->getPathname()));
   346|                 }
   347|             }
   348|         } catch (UnexpectedValueException $exception) {
   349|             $hashes[$current . ' failed'] = $exception->getMessage();
   350|         }
   351|         return json_encode($hashes, JSON_THROW_ON_ERROR);
   352|     }
   353|     /**
   354|      * Drops all given tables
   355|      *
   356|      * @param array<string> $queries
   357|      */
   358|     public function dropTables(array $queries): void
   359|     {
   360|         if ($this->database instanceof DatabaseDriver) {
   361|             foreach ($queries as $query) {
   362|                 $this->database->query($query);
   363|             }
   364|         }
   365|     }
   366| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Template/TwigWrapper.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-106 ---
     1| <?php
     2| /**
     3|  * This class is just a wrapper for Twig v3
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ\Template
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2023-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2023-05-27
    15|  */
    16| namespace phpMyFAQ\Template;
    17| use phpMyFAQ\Core\Exception;
    18| use phpMyFAQ\System;
    19| use phpMyFAQ\Template\Extensions\PluginTwigExtension;
    20| use phpMyFAQ\Template\Extensions\TranslateTwigExtension;
    21| use Twig\Environment;
    22| use Twig\Error\LoaderError;
    23| use Twig\Error\RuntimeError;
    24| use Twig\Error\SyntaxError;
    25| use Twig\Extension\DebugExtension;
    26| use Twig\Extension\ExtensionInterface;
    27| use Twig\Loader\FilesystemLoader;
    28| use Twig\TemplateWrapper;
    29| use Twig\TwigFilter;
    30| use Twig\TwigFunction;
    31| class TwigWrapper
    32| {
    33|     private Environment $twigEnvironment;
    34|     private bool $isSetup;
    35|     /** @var string Name of an active template set. */
    36|     private static string $templateSetName = 'default';
    37|     /**
    38|      * @throws LoaderError
    39|      */
    40|     public function __construct(string $templatePath, bool $isSetup = false)
    41|     {
    42|         $this->isSetup = $isSetup;
    43|         $filesystemLoader = new FilesystemLoader();
    44|         $filesystemLoader->addPath($templatePath . '/' . self::$templateSetName);
    45|         $filesystemLoader->addPath($templatePath . '/admin', 'admin');
    46|         $filesystemLoader->addPath($templatePath . '/setup', 'setup');
    47|         $this->twigEnvironment = new Environment(
    48|             $filesystemLoader,
    49|             [
    50|                 'debug' => System::isDevelopmentVersion()
    51|             ]
    52|         );
    53|         $this->twigEnvironment->addExtension(new TranslateTwigExtension());
    54|         if (!$this->isSetup) {
    55|             $this->twigEnvironment->addExtension(new PluginTwigExtension());
    56|         }
    57|         if (System::isDevelopmentVersion() || DEBUG) {
    58|             $this->twigEnvironment->addExtension(new DebugExtension());
    59|         }
    60|     }
    61|     public function setSetup(bool $isSetup): void
    62|     {
    63|         $this->isSetup = $isSetup;
    64|     }
    65|     /**
    66|      * @throws Exception
    67|      */
    68|     public function loadTemplate(string $templateFile): TemplateWrapper
    69|     {
    70|         try {
    71|             return $this->twigEnvironment->load($templateFile);
    72|         } catch (LoaderError | RuntimeError | SyntaxError $exception) {
    73|             throw new Exception($exception->getMessage());
    74|         }
    75|     }
    76|     public function addExtension(ExtensionInterface $extension): void
    77|     {
    78|         $this->twigEnvironment->addExtension($extension);
    79|     }
    80|     public function addFunction(TwigFunction $twigFunction): void
    81|     {
    82|         $this->twigEnvironment->addFunction($twigFunction);
    83|     }
    84|     public function getExtension(string $class): ExtensionInterface
    85|     {
    86|         return $this->twigEnvironment->getExtension($class); /** @phpstan-ignore-line */
    87|     }
    88|     public function addFilter(TwigFilter $filter): void
    89|     {
    90|         $this->twigEnvironment->addFilter($filter);
    91|     }
    92|     /**
    93|      * Returns the name of the actual template set.
    94|      */
    95|     public static function getTemplateSetName(): string
    96|     {
    97|         return self::$templateSetName;
    98|     }
    99|     /**
   100|      * Set the template set name to use.
   101|      */
   102|     public static function setTemplateSetName(string $tplSetName): void
   103|     {
   104|         self::$templateSetName = $tplSetName;
   105|     }
   106| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/User.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-836 ---
     1| <?php
     2| /**
     3|  * Creates a new user object.
     4|  *
     5|  * A user are recognized by the session-id using getUserBySessionId(), by his
     6|  * using getUserById() or by his nickname (login) using getUserByLogin(). New
     7|  * are created using createNewUser().
     8|  *
     9|  * This Source Code Form is subject to the terms of the Mozilla Public License,
    10|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
    11|  * obtain one at https://mozilla.org/MPL/2.0/.
    12|  *
    13|  * @package   phpMyFAQ
    14|  * @author    Lars Tiedemann <php@larstiedemann.de>
    15|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    16|  * @author    Sarah Hermann <sayh@gmx.de>
    17|  * @copyright 2005-2024 phpMyFAQ Team
    18|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    19|  * @link      https://www.phpmyfaq.de
    20|  * @since     2005-09-17
    21|  */
    22| namespace phpMyFAQ;
    23| use Exception;
    24| use phpMyFAQ\Auth\AuthDriverInterface;
    25| use phpMyFAQ\Permission\BasicPermission;
    26| use phpMyFAQ\Permission\MediumPermission;
    27| use phpMyFAQ\Permission\PermissionInterface;
    28| use phpMyFAQ\User\UserData;
    29| use Symfony\Component\HttpFoundation\Request;
    30| use Symfony\Component\Mailer\Exception\TransportExceptionInterface;
    31| if (!defined('PMF_ENCRYPTION_TYPE')) {
    32|     define('PMF_ENCRYPTION_TYPE', 'hash');
    33| }
    34| /**
    35|  * Class User
    36|  *
    37|  * @package phpMyFAQ
    38|  */
    39| class User
    40| {
    41|     final public const ERROR_USER_ADD = 'Account could not be created. ';
    42|     final public const ERROR_USER_CANNOT_CREATE_USER = 'User account could not be created. ';
    43|     final public const ERROR_USER_CANNOT_CREATE_USERDATA = 'Entry for user data could not be created. ';
    44|     final public const ERROR_USER_CANNOT_DELETE_USER = 'User account could not be deleted. ';
    45|     final public const ERROR_USER_CANNOT_DELETE_USERDATA = 'Entry for user data could not be deleted. ';
    46|     final public const ERROR_USER_CHANGE = 'Account could not be updated. ';
    47|     final public const ERROR_USER_DELETE = 'Account could not be deleted. ';
    48|     final public const ERROR_USER_INCORRECT_LOGIN = 'The login name could not be found. ';
    49|     final public const ERROR_USER_INCORRECT_PASSWORD = 'The password is not correct.';
    50|     final public const ERROR_USER_INVALID_STATUS = 'Undefined user status.';
    51|     final public const ERROR_USER_LOGINNAME_TOO_SHORT = 'The chosen login name is too short.';
    52|     final public const ERROR_USER_LOGIN_NOT_UNIQUE = 'The Login name already exists.';
    53|     final public const ERROR_USER_LOGIN_INVALID = 'The chosen login is invalid. A valid login has at least four ' .
    54|         'characters. Only letters, numbers and underscore _ are allowed. The first letter must be a letter. ';
    55|     final public const ERROR_USER_NO_USERID = 'No user-ID found. ';
    56|     final public const ERROR_USER_NO_USERLOGINDATA = 'No user login data found. ';
    57|     final public const ERROR_USER_NOT_FOUND = 'User account could not be found. ';
    58|     final public const ERROR_USER_NO_AUTH_WRITABLE = 'No authentication object is writable.';
    59|     final public const ERROR_USER_TOO_MANY_FAILED_LOGINS = 'You exceeded the maximum amounts of login attempts and ' .
    60|         'are temporarily blocked. Please try again later.';
    61|     final public const STATUS_USER_PROTECTED = 'User account is protected. ';
    62|     final public const STATUS_USER_BLOCKED = 'User account is blocked. ';
    63|     final public const STATUS_USER_ACTIVE = 'User account is active. ';
    64|     public PermissionInterface $perm;
    65|     public ?UserData $userdata = null;
    66|     /**
    67|      * Public array that contains error messages.
    68|      * @var array<string>
    69|      */
    70|     public array $errors = [];
    71|     /**
    72|      * authentication container.
    73|      * @var array<string, Auth|AuthDriverInterface>
    74|      */
    75|     protected array $authContainer = [];
    76|     /**
    77|      * Default Authentication properties.
    78|      *
    79|      * @var array<string, array<string, string>|string|false>
    80|      */
    81|     private array $authData = [
    82|         'authSource' => [
    83|             'name' => 'database',
    84|             'type' => 'local',
    85|         ],
    86|         'encType' => PMF_ENCRYPTION_TYPE,
    87|         'readOnly' => false,
    88|     ];
    89|     private string $login = '';
    90|     private int $loginMinLength = 2;
    91|     /**
    92|      * regular expression to find invalid login strings
    93|      * (default: /^[a-z0-9][\w\.\-@]+/is ).
    94|      */
    95|     private string $validUsername = '/^[a-z0-9][\w.\-@]+/i';
    96|     private int $userId = -1;
    97|     private string $status = '';
    98|     /** Is the user a super admin? */
    99|     private bool $isSuperAdmin = false;
   100|     /** @var string $authSource Authentication, e.g. local, ldap, azure, sso, ... */
   101|     private string $authSource = 'local';
   102|     /**
   103|      * array of allowed values for status.
   104|      *
   105|      * @var array<string>
   106|      */
   107|     private array $allowedStatus = [
   108|         'active' => self::STATUS_USER_ACTIVE,
   109|         'blocked' => self::STATUS_USER_BLOCKED,
   110|         'protected' => self::STATUS_USER_PROTECTED,
   111|     ];
   112|     /**
   113|      * Constructor.
   114|      *
   115|      * @throws Core\Exception
   116| */
   117|     public function __construct(protected ?Configuration $configuration)
   118|     {
   119|         $permission = Permission::createPermission(
   120|             $this->configuration->get('security.permLevel'),
   121|             $this->configuration
   122|         );
   123|         if (!$this->addPerm($permission)) {
   124|             return;
   125|         }
   126|         $this->authContainer = [];
   127|         $auth = new Auth($this->configuration);
   128|         $selectedAuth = $auth->selectAuth($this->getAuthSource('name'));
   129|         $selectedAuth->getEncryptionContainer($this->getAuthData('encType'));
   130|         $selectedAuth->setReadOnly($this->getAuthData('readOnly'));
   131|         if (!$this->addAuth($selectedAuth, $this->getAuthSource('type'))) {
   132|             return;
   133|         }
   134|         /** @phpstan-ignore-next-line */
   135|         foreach ($this->authContainer as $name => $authObject) {
   136|             if (!$this->addAuth($authObject, $name)) {
   137|                 break;
   138|             }
   139|         }
   140|         $this->userdata = new UserData($this->configuration);
   141|     }
   142|     /**
   143|      * Adds a permission object to the user.
   144|      *
   145|      * @param PermissionInterface $permission Permission object
   146|      */
   147|     public function addPerm(PermissionInterface $permission): bool
   148|     {
   149|         $this->perm = $permission;
   150|         return true;
   151|     }
   152|     /**
   153|      * Returns a specific entry from the auth data source array.
   154|      */
   155|     public function getAuthSource(string $key): ?string
   156|     {
   157|         return $this->authData['authSource'][$key] ?? null;
   158|     }
   159|     public function getUserAuthSource(): string
   160|     {
   161|         return $this->authSource;
   162|     }
   163|     /**
   164|      * Returns a specific entry from the auth data array.
   165|      */
   166|     public function getAuthData(string $key): mixed
   167|     {
   168|         return $this->authData[$key] ?? null;
   169|     }
   170|     /**
   171|      * adds a new authentication object to the user object.
   172|      *
   173|      * @param Auth   $authDriver Driver object
   174|      * @param string $name       Auth name
   175|      */
   176|     public function addAuth(Auth $authDriver, string $name): bool
   177|     {
   178|         if ($this->checkAuth($authDriver)) {
   179|             $this->authContainer[$name] = $authDriver;
   180|             return true;
   181|         }
   182|         return false;
   183|     }
   184|     /**
   185|      * Returns true if auth is a valid authentication object.
   186|      *
   187|      * @param Auth $auth Auth object
   188|      */
   189|     protected function checkAuth(Auth $auth): bool
   190|     {
   191|         return method_exists($auth, 'checkCredentials');
   192|     }
   193|     /**
   194|      * Loads basic user information from the database selecting the user with
   195|      * specified cookie information.
   196|      */
   197|     public function getUserByCookie(string $cookie): bool
   198|     {
   199|         $select = sprintf(
   200|             "
   201|             SELECT
   202|                 user_id,
   203|                 login,
   204|                 account_status
   205|             FROM
   206|                 %sfaquser
   207|             WHERE
   208|                 remember_me = '%s' AND account_status != 'blocked'",
   209|             Database::getTablePrefix(),
   210|             $this->configuration->getDb()->escape($cookie),
   211|         );
   212|         $res = $this->configuration->getDb()->query($select);
   213|         if ($this->configuration->getDb()->numRows($res) !== 1) {
   214|             $this->errors[] = self::ERROR_USER_INCORRECT_LOGIN;
   215|             return false;
   216|         }
   217|         $user = $this->configuration->getDb()->fetchArray($res);
   218|         if (-1 === $user['user_id']) {
   219|             return false;
   220|         }
   221|         $this->userId = (int)$user['user_id'];
   222|         $this->login = (string)$user['login'];
   223|         $this->status = (string)$user['account_status'];
   224|         if (!$this->userdata instanceof UserData) {
   225|             $this->userdata = new UserData($this->configuration);
   226|         }
   227|         $this->userdata->load($this->getUserId());
   228|         return true;
   229|     }
   230|     /**
   231|      * Returns the User ID of the user.
   232|      */
   233|     public function getUserId(): int
   234|     {
   235|         if (isset($this->userId)) {
   236|             return $this->userId;
   237|         }
   238|         $this->userId = -1;
   239|         $this->errors[] = self::ERROR_USER_NO_USERID;
   240|         return -1;
   241|     }
   242|     /**
   243|      * Checks if display name is already used. Returns true, if already in use.
   244|      */
   245|     public function checkDisplayName(string $name): bool
   246|     {
   247|         if (!$this->userdata instanceof UserData) {
   248|             $this->userdata = new UserData($this->configuration);
   249|         }
   250|         return $name === $this->userdata->fetch('display_name', $name);
   251|     }
   252|     /**
   253|      * Checks if email address is already used. Returns true, if already in use.
   254|      */
   255|     public function checkMailAddress(string $name): bool
   256|     {
   257|         if (!$this->userdata instanceof UserData) {
   258|             $this->userdata = new UserData($this->configuration);
   259|         }
   260|         return $name === $this->userdata->fetch('email', $name);
   261|     }
   262|     /**
   263|      * Search users by login.
   264|      *
   265|      * @param string $search Login name
   266|      * @return array<string[]>
   267|      */
   268|     public function searchUsers(string $search): array
   269|     {
   270|         $select = sprintf(
   271|             "SELECT login, user_id, account_status FROM %sfaquser WHERE login LIKE '%s'",
   272|             Database::getTablePrefix(),
   273|             $this->configuration->getDb()->escape($search . '%'),
   274|         );
   275|         $res = $this->configuration->getDb()->query($select);
   276|         if (!$res) {
   277|             return [];
   278|         }
   279|         $result = [];
   280|         while ($row = $this->configuration->getDb()->fetchArray($res)) {
   281|             $result[] = $row;
   282|         }
   283|         return $result;
   284|     }
   285|     /**
   286|      * Creates a new user and stores basic data in the database.
   287|      *
   288|      * @throws Core\Exception
   289|      * @throws Exception
   290|      */
   291|     public function createUser(string $login, string $pass = '', string $domain = '', int $userId = 0): bool
   292|     {
   293|         foreach ($this->authContainer as $auth) {
   294|             if (!$this->checkAuth($auth)) {
   295|                 return false;
   296|             }
   297|         }
   298|         if (!$this->isValidLogin($login)) {
   299|             throw new Exception(self::ERROR_USER_LOGINNAME_TOO_SHORT);
   300|         }
   301|         if ($this->getUserByLogin($login, false)) {
   302|             throw new Exception(self::ERROR_USER_LOGIN_NOT_UNIQUE);
   303|         }
   304|         if (0 === $userId) {
   305|             $this->userId = $this->configuration->getDb()->nextId(Database::getTablePrefix() . 'faquser', 'user_id');
   306|         } else {
   307|             $this->userId = $userId;
   308|         }
   309|         $insert = sprintf(
   310|             "INSERT INTO %sfaquser (user_id, login, session_timestamp, member_since) VALUES (%d, '%s', %d, '%s')",
   311|             Database::getTablePrefix(),
   312|             $this->getUserId(),
   313|             $this->configuration->getDb()->escape($login),
   314|             Request::createFromGlobals()->server->get('REQUEST_TIME'),
   315|             date('YmdHis', Request::createFromGlobals()->server->get('REQUEST_TIME')),
   316|         );
   317|         $this->configuration->getDb()->query($insert);
   318|         if (!$this->userdata instanceof UserData) {
   319|             $this->userdata = new UserData($this->configuration);
   320|         }
   321|         $data = $this->userdata->add($this->getUserId());
   322|         if (!$data) {
   323|             throw new Exception(self::ERROR_USER_CANNOT_CREATE_USERDATA);
   324|         }
   325|         if ($pass === '') {
   326|             $pass = $this->createPassword();
   327|         }
   328|         $success = false;
   329|         foreach ($this->authContainer as $name => $auth) {
   330|             if ($auth->setReadOnly()) {
   331|                 continue;
   332|             }
   333|             if (!$auth->create($login, $pass, $domain)) {
   334|                 throw new Exception(self::ERROR_USER_CANNOT_CREATE_USER . 'in Auth ' . $name);
   335|             } else {
   336|                 $success = true;
   337|             }
   338|         }
   339|         if (!$success) {
   340|             return false;
   341|         }
   342|         if ($this->perm instanceof MediumPermission) {
   343|             $this->perm->autoJoin($this->userId);
   344|         }
   345|         return $this->getUserByLogin($login, false);
   346|     }
   347|     /**
   348|      * Returns true if login is a valid login string.
   349|      * $this->loginMinLength defines the minimum length of the login string.
   350|      * If login has more characters than allowed, false is returned.
   351|      * $this->login_invalidRegExp is a regular expression.
   352|      * If login matches this false is returned.
   353|      *
   354|      * @param string $login Login name
   355|      */
   356|     public function isValidLogin(string $login): bool
   357|     {
   358|         if (strlen($login) < $this->loginMinLength || !preg_match($this->validUsername, $login)) {
   359|             $this->errors[] = self::ERROR_USER_LOGIN_INVALID;
   360|             return false;
   361|         }
   362|         return true;
   363|     }
   364|     /**
   365|      * loads basic user information from the database selecting the user with
   366|      * specified login.
   367|      *
   368|      * @param string $login Login name
   369|      * @param bool   $raiseError Raise error?
   370|      * @throws Exception
   371|      */
   372|     public function getUserByLogin(string $login, bool $raiseError = true): bool
   373|     {
   374|         $select = sprintf(
   375|             "SELECT user_id, login, account_status, is_superadmin, auth_source FROM %sfaquser WHERE login = '%s'",
   376|             Database::getTablePrefix(),
   377|             $this->configuration->getDb()->escape($login),
   378|         );
   379|         $result = $this->configuration->getDb()->query($select);
   380|         if ($this->configuration->getDb()->numRows($result) !== 1) {
   381|             if ($raiseError) {
   382|                 throw new Core\Exception(self::ERROR_USER_INCORRECT_LOGIN);
   383|             }
   384|             return false;
   385|         }
   386|         $this->extractUserFromResult($result);
   387|         if (!$this->userdata instanceof UserData) {
   388|             $this->userdata = new UserData($this->configuration);
   389|         }
   390|         $this->userdata->load($this->getUserId());
   391|         return true;
   392|     }
   393|     /**
   394|      * Returns a new password.
   395|      *
   396|      * @throws Exception
   397|      */
   398|     public function createPassword(int $minimumLength = 8, bool $allowUnderscore = true): string
   399|     {
   400|         $consonants = ['b', 'c', 'd', 'f', 'g', 'h', 'j', 'k', 'm', 'n', 'p', 'r', 's', 't', 'v', 'w', 'x', 'y', 'z'];
   401|         $vowels = ['a', 'e', 'i', 'u'];
   402|         $newPassword = '';
   403|         $nextChar = '';
   404|         $skipped = false;
   405|         while (strlen($newPassword) < $minimumLength) {
   406|             $caseFunc = random_int(0, 1) !== 0 ? 'strtoupper' : 'strtolower';
   407|             switch (random_int(0, $skipped ? 3 : ($allowUnderscore ? 5 : 4))) {
   408|                 case 0:
   409|                 case 1:
   410|                     $nextChar = $caseFunc($consonants[random_int(0, 18)]);
   411|                     break;
   412|                 case 2:
   413|                 case 3:
   414|                     $nextChar = $caseFunc($vowels[random_int(0, 3)]);
   415|                     break;
   416|                 case 4:
   417|                     $nextChar = (string)random_int(2, 9);
   418|                     break;
   419|                 case 5:
   420|                     $newPassword .= '_';
   421|                     continue 2;
   422|             }
   423|             $skipped = false;
   424|             if (!str_contains($newPassword, $nextChar)) {
   425|                 $newPassword .= $nextChar;
   426|             } else {
   427|                 $skipped = true;
   428|             }
   429|         }
   430|         return $newPassword;
   431|     }
   432|     /**
   433|      * deletes the user from the database.
   434|      */
   435|     public function deleteUser(): bool
   436|     {
   437|         if (!isset($this->userId) || $this->userId == 0) {
   438|             $this->errors[] = self::ERROR_USER_NO_USERID;
   439|             return false;
   440|         }
   441|         if (!isset($this->login) || strlen($this->login) == 0) {
   442|             $this->errors[] = self::ERROR_USER_LOGIN_INVALID;
   443|             return false;
   444|         }
   445|         if (
   446|             isset($this->allowedStatus[$this->status]) &&
   447|             $this->allowedStatus[$this->status] === self::STATUS_USER_PROTECTED
   448|         ) {
   449|             $this->errors[] = self::ERROR_USER_CANNOT_DELETE_USER . self::STATUS_USER_PROTECTED;
   450|             return false;
   451|         }
   452|         /** @phpstan-ignore-next-line */
   453|         $this->perm->refuseAllUserRights($this->userId);
   454|         $delete = sprintf(
   455|             'DELETE FROM %sfaquser WHERE user_id = %d',
   456|             Database::getTablePrefix(),
   457|             $this->userId,
   458|         );
   459|         $res = $this->configuration->getDb()->query($delete);
   460|         if (!$res) {
   461|             $this->errors[] = self::ERROR_USER_CANNOT_DELETE_USER . 'error: ' . $this->configuration->getDb()->error();
   462|             return false;
   463|         }
   464|         if (!$this->userdata instanceof UserData) {
   465|             $this->userdata = new UserData($this->configuration);
   466|         }
   467|         $data = $this->userdata->delete($this->getUserId());
   468|         if (!$data) {
   469|             $this->errors[] = self::ERROR_USER_CANNOT_DELETE_USERDATA;
   470|             return false;
   471|         }
   472|         $readOnly = 0;
   473|         $authCount = 0;
   474|         $delete = [];
   475|         foreach ($this->authContainer as $auth) {
   476|             ++$authCount;
   477|             if ($auth->setReadOnly()) {
   478|                 ++$readOnly;
   479|                 continue;
   480|             }
   481|             $delete[] = $auth->delete($this->login);
   482|         }
   483|         if ($readOnly === $authCount) {
   484|             $this->errors[] = self::ERROR_USER_NO_AUTH_WRITABLE;
   485|         }
   486|         return in_array(true, $delete);
   487|     }
   488|     /**
   489|      * Returns a string with error messages.
   490|      * The string returned by error() contains messages for all errors that during object processing.
   491|      * New lines separate messages.
   492|      * Error messages are stored in the public array errors.
   493|      */
   494|     public function error(): string
   495|     {
   496|         $message = '';
   497|         foreach ($this->errors as $error) {
   498|             $message .= $error . "<br>\n";
   499|         }
   500|         $this->errors = [];
   501|         return $message;
   502|     }
   503|     /**
   504|      * Returns the data aof the auth container.
   505|      *
   506|      * @return AuthDriverInterface[]
   507|      */
   508|     public function getAuthContainer(): array
   509|     {
   510|         return $this->authContainer;
   511|     }
   512|     /**
   513|      * Returns an array with the user-IDs of all users found in
   514|      * the database. By default, the Anonymous User will not be returned.
   515|      *
   516|      * @param bool $withoutAnonymous Without anonymous?
   517|      * @param bool $allowBlockedUsers Allow blocked users as well, e.g. in admin
   518|      * @return array<int>
   519|      */
   520|     public function getAllUsers(bool $withoutAnonymous = true, bool $allowBlockedUsers = true): array
   521|     {
   522|         $query = sprintf(
   523|             'SELECT user_id FROM %sfaquser WHERE 1 = 1 %s %s ORDER BY user_id ASC',
   524|             Database::getTablePrefix(),
   525|             ($withoutAnonymous ? 'AND user_id <> -1' : ''),
   526|             ($allowBlockedUsers ? '' : "AND account_status != 'blocked'"),
   527|         );
   528|         $result = $this->configuration->getDb()->query($query);
   529|         if (!$result) {
   530|             return [];
   531|         }
   532|         $users = [];
   533|         if ($this->configuration->getDb()->numRows($result) === 0) {
   534|             return $result;
   535|         }
   536|         while ($row = $this->configuration->getDb()->fetchArray($result)) {
   537|             $users[] = (int) $row['user_id'];
   538|         }
   539|         return $users;
   540|     }
   541|     /**
   542|      * Loads basic user information from the database selecting the user with
   543|      * specified user-ID.
   544|      *
   545|      * @param int  $userId User ID
   546|      * @param bool $allowBlockedUsers Allow blocked users as well, e.g. in admin
   547|      */
   548|     public function getUserById(int $userId, bool $allowBlockedUsers = false): bool
   549|     {
   550|         $select = sprintf(
   551|             '
   552|             SELECT
   553|                 user_id,
   554|                 login,
   555|                 account_status,
   556|                 is_superadmin,
   557|                 auth_source
   558|             FROM
   559|                 %sfaquser
   560|             WHERE
   561|                 user_id = %d ' . ($allowBlockedUsers ? '' : "AND account_status != 'blocked'"),
   562|             Database::getTablePrefix(),
   563|             $userId,
   564|         );
   565|         $result = $this->configuration->getDb()->query($select);
   566|         if ($this->configuration->getDb()->numRows($result) != 1) {
   567|             $this->errors[] = self::ERROR_USER_NO_USERID . 'error(): ' . $this->configuration->getDb()->error();
   568|             return false;
   569|         }
   570|         $this->extractUserFromResult($result);
   571|         if ('db' === $this->getAuthSource('name')) {
   572|             $select = sprintf(
   573|                 "SELECT pass FROM %sfaquserlogin WHERE login = '%s'",
   574|                 Database::getTablePrefix(),
   575|                 $this->login,
   576|             );
   577|             $res = $this->configuration->getDb()->query($select);
   578|             if ($this->configuration->getDb()->numRows($res) != 1) {
   579|                 $this->errors[] =
   580|                     self::ERROR_USER_NO_USERLOGINDATA . 'error: ' . $this->configuration->getDb()->error();
   581|                 return false;
   582|             }
   583|         }
   584|         if (!$this->userdata instanceof UserData) {
   585|             $this->userdata = new UserData($this->configuration);
   586|         }
   587|         $this->userdata->load($this->getUserId());
   588|         return true;
   589|     }
   590|     /**
   591|      * Returns the data of the current user.
   592|      *
   593|      * @param string $field Field
   594|      * @return array<string>|string|int|null
   595|      */
   596|     public function getUserData(string $field = '*'): array|int|string|null
   597|     {
   598|         if (!($this->userdata instanceof UserData)) {
   599|             $this->userdata = new UserData($this->configuration);
   600|         }
   601|         return $this->userdata->get($field);
   602|     }
   603|     /**
   604|      * Adds user data.
   605|      *
   606|      * @param array<string> $data Array with user data
   607|      */
   608|     public function setUserData(array $data): bool
   609|     {
   610|         if (!($this->userdata instanceof UserData)) {
   611|             $this->userdata = new UserData($this->configuration);
   612|         }
   613|         $this->userdata->load($this->getUserId());
   614|         return $this->userdata->set(array_keys($data), array_values($data));
   615|     }
   616|     /**
   617|      * returns the user's login.
   618|      */
   619|     public function getLogin(): string
   620|     {
   621|         return $this->login;
   622|     }
   623|     /**
   624|      * Returns the user ID from the given email address
   625|      */
   626|     public function getUserIdByEmail(string $email): int
   627|     {
   628|         if (!$this->userdata instanceof UserData) {
   629|             $this->userdata = new UserData($this->configuration);
   630|         }
   631|         $userData = $this->userdata->fetchAll('email', $email);
   632|         return $userData['user_id'];
   633|     }
   634|     /**
   635|      * Returns true or false for the visibility for the given email
   636|      * address, if the user is not a registered user, the method
   637|      * returns false for anonymous users
   638|      */
   639|     public function getUserVisibilityByEmail(string $email): bool
   640|     {
   641|         if (!$this->userdata instanceof UserData) {
   642|             $this->userdata = new UserData($this->configuration);
   643|         }
   644|         $userData = $this->userdata->fetchAll('email', $email);
   645|         return !isset($userData['is_visible']) || $userData['is_visible'];
   646|     }
   647|     /**
   648|      * Returns true on success.
   649|      * This will change a users' status to active, and send an email with a new password.
   650|      *
   651|      * @throws Exception|TransportExceptionInterface
   652|      */
   653|     public function activateUser(): bool
   654|     {
   655|         if ($this->getStatus() == 'blocked') {
   656|             $newPassword = $this->createPassword();
   657|             $this->changePassword($newPassword);
   658|             $subject = '[%sitename%] Login name / activation';
   659|             $message = sprintf(
   660|                 "Name: %s<br>Login name: %s<br>New password: %s",
   661|                 $this->getUserData('display_name'),
   662|                 $this->getLogin(),
   663|                 $newPassword,
   664|             );
   665|             if ($this->mailUser($subject, $message) !== 0) {
   666|                 return $this->setStatus('active');
   667|             }
   668|             return true;
   669|         }
   670|         return false;
   671|     }
   672|     /**
   673|      * returns the user's status.
   674|      */
   675|     public function getStatus(): string
   676|     {
   677|         if (!isset($this->status)) {
   678|             return '';
   679|         }
   680|         if (strlen($this->status) <= 0) {
   681|             return '';
   682|         }
   683|         return $this->status;
   684|     }
   685|     /**
   686|      * Sets the user's status and updates the database entry.
   687|      *
   688|      * @param string $status Status
   689|      */
   690|     public function setStatus(string $status): bool
   691|     {
   692|         $status = strtolower($status);
   693|         if (!in_array($status, array_keys($this->allowedStatus))) {
   694|             $this->errors[] = self::ERROR_USER_INVALID_STATUS;
   695|             return false;
   696|         }
   697|         $this->status = $status;
   698|         $update = sprintf(
   699|             "UPDATE %sfaquser SET account_status = '%s' WHERE user_id = %d",
   700|             Database::getTablePrefix(),
   701|             $this->configuration->getDb()->escape($status),
   702|             $this->userId,
   703|         );
   704|         $res = $this->configuration->getDb()->query($update);
   705|         return (bool) $res;
   706|     }
   707|     /**
   708|      * Sets the auth container
   709|      */
   710|     public function setAuthSource(string $authSource): bool
   711|     {
   712|         $update = sprintf(
   713|             "UPDATE %sfaquser SET auth_source = '%s' WHERE user_id = %d",
   714|             Database::getTablePrefix(),
   715|             $this->configuration->getDb()->escape($authSource),
   716|             $this->getUserId(),
   717|         );
   718|         return (bool) $this->configuration->getDb()->query($update);
   719|     }
   720|     /**
   721|      * changes the user's password. If $pass is omitted, a new
   722|      * password is generated using the createPassword() method.
   723|      *
   724|      * @param string $pass Password
   725|      * @throws Exception
   726|      */
   727|     public function changePassword(string $pass = ''): bool
   728|     {
   729|         foreach ($this->authContainer as $auth) {
   730|             if (!$this->checkAuth($auth)) {
   731|                 return false;
   732|             }
   733|         }
   734|         $login = $this->getLogin();
   735|         if ($pass == '') {
   736|             $pass = $this->createPassword();
   737|         }
   738|         $success = false;
   739|         foreach ($this->authContainer as $auth) {
   740|             if ($auth->setReadOnly()) {
   741|                 continue;
   742|             }
   743|             if (!$auth->update($login, $pass)) {
   744|                 continue;
   745|             }
   746|             $success = true;
   747|         }
   748|         return $success;
   749|     }
   750|     /**
   751|      * Sends mail to the current user.
   752|      *
   753|      * @throws Core\Exception|TransportExceptionInterface
   754|      */
   755|     public function mailUser(string $subject, string $message): int
   756|     {
   757|         $mail = new Mail($this->configuration);
   758|         $mail->addTo($this->getUserData('email'));
   759|         $mail->subject = $subject;
   760|         $mail->message = $message;
   761|         $result = $mail->send();
   762|         unset($mail);
   763|         return $result;
   764|     }
   765|     /**
   766|      * Returns true, if a user is a super admin.
   767|      */
   768|     public function isSuperAdmin(): bool
   769|     {
   770|         return $this->isSuperAdmin;
   771|     }
   772|     /**
   773|      * Sets the users "is_superadmin" flag and updates the database entry.
   774|      */
   775|     public function setSuperAdmin(bool $isSuperAdmin): bool
   776|     {
   777|         $this->isSuperAdmin = $isSuperAdmin;
   778|         $update = sprintf(
   779|             "UPDATE %sfaquser SET is_superadmin = %d WHERE user_id = %d",
   780|             Database::getTablePrefix(),
   781|             (int)$this->isSuperAdmin,
   782|             $this->userId,
   783|         );
   784|         $res = $this->configuration->getDb()->query($update);
   785|         return (bool) $res;
   786|     }
   787|     /**
   788|      * Terminates the session ID of user
   789|      */
   790|     public function terminateSessionId(): bool
   791|     {
   792|         $update = sprintf(
   793|             "UPDATE %sfaquser SET session_id = '' WHERE user_id = %d",
   794|             Database::getTablePrefix(),
   795|             $this->userId,
   796|         );
   797|         return (bool) $this->configuration->getDb()->query($update);
   798|     }
   799|     /**
   800|      * @param mixed $result
   801|      * @return void
   802|      */
   803|     public function extractUserFromResult(mixed $result): void
   804|     {
   805|         $user = $this->configuration->getDb()->fetchArray($result);
   806|         $this->userId = (int)$user['user_id'];
   807|         $this->login = (string)$user['login'];
   808|         $this->status = (string)$user['account_status'];
   809|         $this->isSuperAdmin = (bool)$user['is_superadmin'];
   810|         $this->authSource = (string) $user['auth_source'];
   811|     }
   812|     public function setWebAuthnKeys(string $webAuthnKeys): bool
   813|     {
   814|          $query = sprintf(
   815|              "UPDATE %sfaquser SET webauthnkeys = '%s' WHERE user_id = %d",
   816|              Database::getTablePrefix(),
   817|              $this->configuration->getDb()->escape($webAuthnKeys),
   818|              $this->getUserId(),
   819|          );
   820|          return (bool) $this->configuration->getDb()->query($query);
   821|     }
   822|     public function getWebAuthnKeys(): string
   823|     {
   824|         $select = sprintf(
   825|             "SELECT webauthnkeys FROM %sfaquser WHERE user_id = %d",
   826|             Database::getTablePrefix(),
   827|             $this->getUserId(),
   828|         );
   829|         $result = $this->configuration->getDb()->query($select);
   830|         if ($this->configuration->getDb()->numRows($result) === 1) {
   831|             $user = $this->configuration->getDb()->fetchArray($result);
   832|             return (string) $user['webauthnkeys'];
   833|         }
   834|         return '';
   835|     }
   836| }


# ====================================================================
# FILE: phpmyfaq/startpage.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-79 ---
     1| <?php
     2| /**
     3|  * The main start page with the start page categories, the Top 10 and the latest messages.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2002-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2002-08-23
    15|  */
    16| use phpMyFAQ\Category\Startpage;
    17| use phpMyFAQ\Faq\Statistics;
    18| use phpMyFAQ\Helper\CategoryHelper;
    19| use phpMyFAQ\Language\Plurals;
    20| use phpMyFAQ\News;
    21| use phpMyFAQ\Strings;
    22| use phpMyFAQ\Template\Extensions\TagNameTwigExtension;
    23| use phpMyFAQ\Template\TwigWrapper;
    24| use phpMyFAQ\Translation;
    25| use Symfony\Component\HttpFoundation\Request;
    26| if (!defined('IS_VALID_PHPMYFAQ')) {
    27|     http_response_code(400);
    28|     exit();
    29| }
    30| $faqConfig = $container->get('phpmyfaq.configuration');
    31| $news = new News($faqConfig);
    32| $categoryHelper = new CategoryHelper();
    33| $plr = new Plurals();
    34| $faqStatistics = new Statistics($faqConfig);
    35| $request = Request::createFromGlobals();
    36| $writeNewsHeader = Translation::get('newsArchive');
    37| $startPageCategory = new Startpage($faqConfig);
    38| $startPageCategory
    39|     ->setLanguage($faqLangCode)
    40|     ->setUser($currentUser)
    41|     ->setGroups($currentGroups);
    42| $startPageCategories = $startPageCategory->getCategories();
    43| $param = $faqConfig->get('records.orderingPopularFaqs') == 'visits' ? 'visits' : 'voted';
    44| $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    45| $twig->addExtension(new TagNameTwigExtension());
    46| $twigTemplate = $twig->loadTemplate('./startpage.twig');
    47| $templateVars = [
    48|     ... $templateVars,
    49|     'baseHref' => $faqSystem->getSystemUri($faqConfig),
    50|     'title' => $faqConfig->getTitle(),
    51|     'pageHeader' => $faqConfig->getTitle(),
    52|     'startPageCategories' => (is_countable($startPageCategories) ? count($startPageCategories) : 0) > 0,
    53|     'startPageCategoryDecks' => $startPageCategories,
    54|     'stickyRecordsHeader' => Translation::get('stickyRecordsHeader'),
    55|     'stickyRecordsList' => $faq->getStickyFaqsData(),
    56|     'writeTopTenHeader' => Translation::get('msgTopTen'),
    57|     'topRecordsList' => $faqStatistics->getTopTen($param),
    58|     'errorMsgTopTen' => Translation::get('err_noTopTen'),
    59|     'writeNewestHeader' => Translation::get('msgLatestArticles'),
    60|     'latestRecordsList' => $faqStatistics->getLatest(),
    61|     'errorMsgLatest' => Translation::get('msgErrorNoRecords'),
    62|     'msgTrendingFAQs' => Translation::get('msgTrendingFAQs'),
    63|     'trendingRecordsList' => $faqStatistics->getTrending(),
    64|     'errorMsgTrendingFaqs' => Translation::get('msgErrorNoRecords'),
    65|     'msgNewsHeader' => $writeNewsHeader,
    66|     'newsList' => $news->getAll(),
    67|     'writeNumberOfArticles' => $plr->getMsg('plmsgHomeArticlesOnline', $faqStatistics->totalFaqs($faqLangCode)),
    68|     'msgTags' => Translation::get('msgPopularTags'),
    69|     'tagsList' => $oTag->getPopularTags(12),
    70|     'formActionUrl' => '?' . $sids . 'action=search',
    71|     'searchBox' => Translation::get('msgSearch'),
    72|     'categoryId' => ($cat === 0) ? '%' : (int)$cat,
    73|     'msgSearch' => sprintf(
    74|         '<a class="help" href="%sindex.php?action=search">%s</a>',
    75|         Strings::htmlentities($faqSystem->getSystemUri($faqConfig)),
    76|         Translation::get('msgAdvancedSearch')
    77|     )
    78| ];
    79| return $templateVars;


# ====================================================================
# FILE: phpmyfaq/ucp.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-100 ---
     1| <?php
     2| /**
     3|  * User Control Panel.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2024 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-01-12
    15|  */
    16| use phpMyFAQ\Session\Token;
    17| use phpMyFAQ\Strings;
    18| use phpMyFAQ\Template\TwigWrapper;
    19| use phpMyFAQ\Translation;
    20| use phpMyFAQ\User\TwoFactor;
    21| use RobThree\Auth\TwoFactorAuthException;
    22| use Symfony\Component\HttpFoundation\RedirectResponse;
    23| if (!defined('IS_VALID_PHPMYFAQ')) {
    24|     http_response_code(400);
    25|     exit();
    26| }
    27| $faqConfig = $container->get('phpmyfaq.configuration');
    28| $user = $container->get('phpmyfaq.user.current_user');
    29| if ($user->isLoggedIn()) {
    30|     $faqSession = $container->get('phpmyfaq.session');
    31|     $faqSession->setCurrentUser($user);
    32|     $faqSession->userTracking('user_control_panel', $user->getUserId());
    33|     if ($faqConfig->get('main.enableGravatarSupport')) {
    34|         $gravatar = $container->get('phpmyfaq.services.gravatar');
    35|         $gravatarImg = sprintf(
    36|             '<a target="_blank" href="https://www.gravatar.com">%s</a>',
    37|             $gravatar->getImage(
    38|                 $user->getUserData('email'),
    39|                 ['class' => 'img-responsive rounded-circle', 'size' => 125]
    40|             )
    41|         );
    42|     } else {
    43|         $gravatarImg = '';
    44|     }
    45|     $qrCode = '';
    46|     try {
    47|         $twoFactor = new TwoFactor($faqConfig, $user);
    48|         $secret = $twoFactor->getSecret($user);
    49|         if ('' === $secret || is_null($secret)) {
    50|             try {
    51|                 $secret = $twoFactor->generateSecret();
    52|             } catch (TwoFactorAuthException $e) {
    53|                 $faqConfig->getLogger()->error('Cannot generate 2FA secret: ' . $e->getMessage());
    54|             }
    55|             $twoFactor->saveSecret($secret);
    56|         }
    57|         $qrCode = $twoFactor->getQrCode($secret);
    58|     } catch (TwoFactorAuthException | Exception $e) {
    59|     }
    60|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates/');
    61|     $twigTemplate = $twig->loadTemplate('./ucp.twig');
    62|     $templateVars = [
    63|         ... $templateVars,
    64|         'headerUserControlPanel' => Translation::get('headerUserControlPanel'),
    65|         'ucpGravatarImage' => $gravatarImg,
    66|         'msgHeaderUserData' => Translation::get('headerUserControlPanel'),
    67|         'userid' => $user->getUserId(),
    68|         'csrf' => Token::getInstance()->getTokenInput('ucp'),
    69|         'lang' => $faqConfig->getLanguage()->getLanguage(),
    70|         'readonly' => $user->isLocalUser() ? '' : 'readonly disabled',
    71|         'msgRealName' => Translation::get('ad_user_name'),
    72|         'realname' => Strings::htmlentities($user->getUserData('display_name')),
    73|         'msgEmail' => Translation::get('msgNewContentMail'),
    74|         'email' => Strings::htmlentities($user->getUserData('email')),
    75|         'msgIsVisible' => Translation::get('msgUserDataVisible'),
    76|         'checked' => (int)$user->getUserData('is_visible') === 1 ? 'checked' : '',
    77|         'msgPassword' => Translation::get('ad_auth_passwd'),
    78|         'msgConfirm' => Translation::get('ad_user_confirm'),
    79|         'msgSave' => Translation::get('msgSave'),
    80|         'msgCancel' => Translation::get('msgCancel'),
    81|         'twofactor_enabled' => (bool)$user->getUserData('twofactor_enabled'),
    82|         'msgTwofactorEnabled' => Translation::get('msgTwofactorEnabled'),
    83|         'msgTwofactorConfig' => Translation::get('msgTwofactorConfig'),
    84|         'msgTwofactorConfigModelTitle' => Translation::get('msgTwofactorConfigModelTitle'),
    85|         'twofactor_secret' => $secret ?? '',
    86|         'qr_code_secret' => $qrCode,
    87|         'qr_code_secret_alt' => Translation::get('qr_code_secret_alt'),
    88|         'msgTwofactorNewSecret' => Translation::get('msgTwofactorNewSecret'),
    89|         'msgWarning' => Translation::get('msgWarning'),
    90|         'ad_gen_yes' => Translation::get('ad_gen_yes'),
    91|         'ad_gen_no' => Translation::get('ad_gen_no'),
    92|         'msgConfirmTwofactorConfig' => Translation::get('msgConfirmTwofactorConfig'),
    93|         'csrfTokenRemoveTwofactor' => Token::getInstance()->getTokenString('remove-twofactor'),
    94|         'msgGravatarNotConnected' => Translation::get('msgGravatarNotConnected')
    95|     ];
    96|     return $templateVars;
    97| } else {
    98|     $response = new RedirectResponse($faqConfig->getDefaultUrl());
    99|     $response->send();
   100| }


# ====================================================================
# FILE: scripts/version.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| if [ -z "${PMF_VERSION}" ]; then
     2|     PMF_VERSION="4.0.2"
     3| fi

