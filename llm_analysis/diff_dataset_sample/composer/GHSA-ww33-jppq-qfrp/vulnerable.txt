# ====================================================================
# FILE: phpmyfaq/admin/instances.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-217 ---
     1| <?php
     2| /**
     3|  * The main multi-site instances frontend.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2023 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-03-16
    15|  */
    16| use phpMyFAQ\Component\Alert;
    17| use phpMyFAQ\Entity\InstanceEntity;
    18| use phpMyFAQ\Filesystem;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Instance;
    21| use phpMyFAQ\Instance\Client;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Strings;
    24| use phpMyFAQ\System;
    25| use phpMyFAQ\Translation;
    26| use Symfony\Component\HttpFoundation\Request;
    27| if (!defined('IS_VALID_PHPMYFAQ')) {
    28|     http_response_code(400);
    29|     exit();
    30| }
    31| ?>
    32|     <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    33|         <h1 class="h2">
    34|             <i aria-hidden="true" class="fa fa-wrench fa-fw"></i> <?= Translation::get('ad_menu_instances') ?>
    35|         </h1>
    36|         <?php if ($user->perm->hasPermission($user->getUserId(), 'addinstances') &&
    37|             is_writable(PMF_ROOT_DIR . DIRECTORY_SEPARATOR . 'multisite')
    38|         ) : ?>
    39|         <div class="btn-toolbar mb-2 mb-md-0">
    40|             <div class="btn-group mr-2">
    41|                 <a class="btn btn-sm btn-success" data-bs-toggle="modal" href="#pmf-modal-add-instance">
    42|                     <i aria-hidden="true" class="fa fa-plus"></i> <?= Translation::get('ad_instance_add') ?>
    43|                 </a>
    44|             </div>
    45|         </div>
    46|         <?php endif; ?>
    47|     </div>
    48|   <div class="row">
    49|   <div class="col-lg-12">
    50| <?php
    51| if ($user->perm->hasPermission($user->getUserId(), 'editinstances')) {
    52|     $fileSystem = new Filesystem(PMF_ROOT_DIR);
    53|     $instance = new Instance($faqConfig);
    54|     $currentClient = new Client($faqConfig);
    55|     $currentClient->setFileSystem($fileSystem);
    56|     $instanceId = Filter::filterInput(INPUT_POST, 'instance_id', FILTER_VALIDATE_INT);
    57|     if (!$currentClient->isMultiSiteWriteable()) {
    58|         echo Alert::danger('ad_instance_error_notwritable');
    59|     }
    60|     if ('update-instance' === $action && is_integer($instanceId)) {
    61|         $system = new System();
    62|         $updatedClient = new Client($faqConfig);
    63|         $moveInstance = false;
    64|         $instance->setId($instanceId);
    65|         $updatedData = new InstanceEntity();
    66|         $updatedData->setUrl(Filter::filterInput(INPUT_POST, 'url', FILTER_VALIDATE_URL));
    67|         $updatedData->setInstance(Filter::filterInput(INPUT_POST, 'instance', FILTER_SANITIZE_SPECIAL_CHARS));
    68|         $updatedData->setComment(Filter::filterInput(INPUT_POST, 'comment', FILTER_SANITIZE_SPECIAL_CHARS));
    69|         $originalData = $currentClient->getInstanceById($instanceId);
    70|         if ($originalData->url !== $updatedData->getUrl() && !$instance->getConfig('isMaster')) {
    71|             $moveInstance = true;
    72|         }
    73|         if (is_null($updatedData->getUrl())) {
    74|             echo Alert::danger('ad_entryins_fail', $faqConfig->getDb()->error());
    75|         } else {
    76|             if ($updatedClient->updateInstance($instanceId, $updatedData)) {
    77|                 if ($moveInstance) {
    78|                     $updatedClient->moveClientFolder($originalData->url, $updatedData->getUrl());
    79|                     $updatedClient->deleteClientFolder($originalData->url);
    80|                 }
    81|                 echo Alert::success('ad_config_saved');
    82|             } else {
    83|                 echo Alert::danger('ad_entryins_fail', $faqConfig->getDb()->error());
    84|             }
    85|         }
    86|     }
    87|     ?>
    88|   <table class="table">
    89|     <thead>
    90|     <tr>
    91|       <th>#</th>
    92|       <th><?= Translation::get('ad_instance_url') ?></th>
    93|       <th><?= Translation::get('ad_instance_path') ?></th>
    94|       <th colspan="3"><?= Translation::get('ad_instance_name') ?></th>
    95|     </tr>
    96|     </thead>
    97|     <tbody>
    98|     <?php
    99|     foreach ($instance->getAllInstances() as $site) :
   100|         $currentInstance = new Instance($faqConfig);
   101|         $currentInstance->getInstanceById($site->id);
   102|         $currentInstance->setId($site->id);
   103|         ?>
   104|       <tr id="row-instance-<?= $site->id ?>">
   105|         <td><?= $site->id ?></td>
   106|         <td>
   107|           <a href="<?= Strings::htmlentities($site->url . $site->instance, ENT_QUOTES) ?>">
   108|                 <?= Strings::htmlentities($site->url, ENT_QUOTES) ?>
   109|           </a>
   110|         </td>
   111|         <td><?= Strings::htmlentities($site->instance, ENT_QUOTES) ?></td>
   112|         <td><?= Strings::htmlentities($site->comment, ENT_QUOTES) ?></td>
   113|         <td>
   114|           <a href="?action=edit-instance&instance_id=<?= $site->id ?>" class="btn btn-info">
   115|             <i aria-hidden="true" class="fa fa-pencil"></i>
   116|           </a>
   117|         </td>
   118|         <td>
   119|             <?php
   120|             if (!$currentInstance->getConfig('isMaster')) {
   121|                 $csrfToken = Token::getInstance()->getTokenString('delete-instance');
   122|             ?>
   123|               <button data-delete-instance-id="<?= $site->id ?>" type="button"
   124|                  class="btn btn-danger pmf-instance-delete"
   125|                  data-csrf-token="<?= $csrfToken ?>">
   126|                 <i aria-hidden="true" class="fa fa-trash" data-delete-instance-id="<?= $site->id ?>"
   127|                    data-csrf-token="<?= $csrfToken ?>"></i>
   128|               </button>
   129|             <?php } ?>
   130|         </td>
   131|       </tr>
   132|     <?php endforeach; ?>
   133|     </tbody>
   134|   </table>
   135|   <div class="modal fade" id="pmf-modal-add-instance">
   136|     <div class="modal-dialog modal-lg">
   137|       <div class="modal-content">
   138|         <div class="modal-header">
   139|           <h4><?= Translation::get('ad_instance_add') ?></h4>
   140|             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
   141|         </div>
   142|         <div class="modal-body">
   143|           <form action="#" method="post" accept-charset="utf-8" class="needs-validation" novalidate>
   144|             <?= Token::getInstance()->getTokenInput('add-instance') ?>
   145|             <div class="form-group row">
   146|               <label class="col-form-label col-lg-4" for="url">
   147|                   <?= Translation::get('ad_instance_url') ?>:
   148|               </label>
   149|               <div class="col-lg-8">
   150|                 <div class="input-group">
   151|                   <div class="input-group-prepend">
   152|                     <div class="input-group-text">https://</div>
   153|                   </div>
   154|                   <input class="form-control mb-2" type="text" name="url" id="url" required>
   155|                   <div class="input-group-append">
   156|                     <div class="input-group-text">.<?= Request::createFromGlobals()->getHost() ?></div>
   157|                   </div>
   158|                 </div>
   159|               </div>
   160|             </div>
   161|             <div class="form-group row">
   162|               <label class="col-form-label col-lg-4" for="instance">
   163|                   <?= Translation::get('ad_instance_path') ?>:
   164|               </label>
   165|               <div class="col-lg-8">
   166|                 <input class="form-control mb-2" type="text" name="instance" id="instance" required>
   167|               </div>
   168|             </div>
   169|             <div class="form-group row">
   170|               <label class="col-form-label col-lg-4" for="comment">
   171|                   <?= Translation::get('ad_instance_name') ?>:
   172|               </label>
   173|               <div class="col-lg-8">
   174|                 <input class="form-control mb-2" type="text" name="comment" id="comment" required>
   175|               </div>
   176|             </div>
   177|             <div class="form-group row">
   178|               <label class="col-form-label col-lg-4" for="email">
   179|                   <?= Translation::get('ad_instance_email') ?>:
   180|               </label>
   181|               <div class="col-lg-8">
   182|                 <input class="form-control mb-2" type="email" name="email" id="email" required>
   183|               </div>
   184|             </div>
   185|             <div class="form-group row">
   186|               <label class="col-form-label col-lg-4" for="admin">
   187|                   <?= Translation::get('ad_instance_admin') ?>:
   188|               </label>
   189|               <div class="col-lg-8">
   190|                 <input class="form-control mb-2" type="text" name="admin" id="admin" required>
   191|               </div>
   192|             </div>
   193|             <div class="form-group row">
   194|               <label class="col-form-label col-lg-4" for="password">
   195|                   <?= Translation::get('ad_instance_password') ?>:
   196|               </label>
   197|               <div class="col-lg-8">
   198|                 <input class="form-control mb-2" type="password" autocomplete="off" name="password" id="password" required>
   199|               </div>
   200|             </div>
   201|           </form>
   202|         </div>
   203|         <div class="modal-footer">
   204|           <p class="text-sm-start"><?= Translation::get('ad_instance_hint') ?></p>
   205|           <button class="btn btn-primary pmf-instance-add" type="submit">
   206|               <?= Translation::get('ad_instance_button') ?>
   207|           </button>
   208|         </div>
   209|       </div>
   210|     </div>
   211|   </div>
   212|   </div>
   213|   </div>
   214|     <?php
   215| } else {
   216|     print Translation::get('err_NotAuth');
   217| }


# ====================================================================
# FILE: phpmyfaq/admin/record.edit.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-854 ---
     1| <?php
     2| /**
     3|  * The FAQ record editor.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2003-2023 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2003-02-23
    15|  */
    16| use phpMyFAQ\Attachment\AttachmentFactory;
    17| use phpMyFAQ\Category;
    18| use phpMyFAQ\Category\CategoryRelation;
    19| use phpMyFAQ\Changelog;
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Database;
    22| use phpMyFAQ\Date;
    23| use phpMyFAQ\Faq;
    24| use phpMyFAQ\Faq\FaqPermission;
    25| use phpMyFAQ\Filter;
    26| use phpMyFAQ\Helper\CategoryHelper;
    27| use phpMyFAQ\Helper\LanguageHelper;
    28| use phpMyFAQ\Helper\UserHelper;
    29| use phpMyFAQ\Link;
    30| use phpMyFAQ\AdminLog;
    31| use phpMyFAQ\Question;
    32| use phpMyFAQ\Revision;
    33| use phpMyFAQ\Session\Token;
    34| use phpMyFAQ\Strings;
    35| use phpMyFAQ\Tags;
    36| use phpMyFAQ\Translation;
    37| use phpMyFAQ\User;
    38| use phpMyFAQ\User\CurrentUser;
    39| use phpMyFAQ\Utils;
    40| if (!defined('IS_VALID_PHPMYFAQ')) {
    41|     http_response_code(400);
    42|     exit();
    43| }
    44| $faqConfig = Configuration::getConfigurationInstance();
    45| $currentUserId = CurrentUser::getCurrentUser($faqConfig)->getUserId();
    46| if (
    47|     ($user->perm->hasPermission($currentUserId, 'edit_faq') ||
    48|      $user->perm->hasPermission($currentUserId, 'add_faq')) && !Database::checkOnEmptyTable('faqcategories')
    49| ) {
    50|     $category = new Category($faqConfig, [], false);
    51|     if ($faqConfig->get('main.enableCategoryRestrictions')) {
    52|         $category = new Category($faqConfig, $currentAdminGroups, true);
    53|     }
    54|     $category->setUser($currentAdminUser);
    55|     $category->setGroups($currentAdminGroups);
    56|     $category->buildCategoryTree();
    57|     $categoryRelation = new CategoryRelation($faqConfig, $category);
    58|     $categoryHelper = new CategoryHelper();
    59|     $categoryHelper->setCategory($category);
    60|     $faq = new Faq($faqConfig);
    61|     $faqPermission = new FaqPermission($faqConfig);
    62|     $questionObject = new Question($faqConfig);
    63|     $changelog = new Changelog($faqConfig);
    64|     $userHelper = new UserHelper($user);
    65|     $selectedCategory = '';
    66|     $categories = [];
    67|     $faqData = [
    68|         'id' => 0,
    69|         'lang' => $faqLangCode,
    70|         'revision_id' => 0,
    71|         'title' => '',
    72|         'dateStart' => '',
    73|         'dateEnd' => '',
    74|     ];
    75|     $tagging = new Tags($faqConfig);
    76|     $date = new Date($faqConfig);
    77|     if ('takequestion' === $action) {
    78|         $questionId = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
    79|         $question = $questionObject->getQuestion($questionId);
    80|         $selectedCategory = $question['category_id'];
    81|         $faqData['title'] = $question['question'];
    82|         $notifyUser = $question['username'];
    83|         $notifyEmail = $question['email'];
    84|         $categories = [
    85|             'category_id' => $selectedCategory,
    86|             'category_lang' => $faqData['lang'],
    87|         ];
    88|     } else {
    89|         $questionId = 0;
    90|         $notifyUser = '';
    91|         $notifyEmail = '';
    92|     }
    93|     if ('editpreview' === $action) {
    94|         $faqData['id'] = Filter::filterInput(INPUT_POST, 'id', FILTER_VALIDATE_INT);
    95|         if (!is_null($faqData['id'])) {
    96|             $queryString = 'saveentry&id=' . $faqData['id'];
    97|         } else {
    98|             $queryString = 'insertentry';
    99|         }
   100|         $faqData['lang'] = Filter::filterInput(INPUT_POST, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);
   101|         $selectedCategory = Filter::filterInputArray(
   102|             INPUT_POST,
   103|             [
   104|                 'rubrik' => [
   105|                     'filter' => FILTER_VALIDATE_INT,
   106|                     'flags' => FILTER_REQUIRE_ARRAY,
   107|                 ],
   108|             ]
   109|         );
   110|         if (is_array($selectedCategory)) {
   111|             foreach ($selectedCategory as $cats) {
   112|                 $categories[] = ['category_id' => $cats, 'category_lang' => $faqData['lang']];
   113|             }
   114|         }
   115|         $faqData['active'] = Filter::filterInput(INPUT_POST, 'active', FILTER_SANITIZE_SPECIAL_CHARS);
   116|         $faqData['keywords'] = Filter::filterInput(INPUT_POST, 'keywords', FILTER_SANITIZE_SPECIAL_CHARS);
   117|         $faqData['title'] = Filter::filterInput(INPUT_POST, 'thema', FILTER_SANITIZE_SPECIAL_CHARS);
   118|         $faqData['content'] = Filter::filterInput(INPUT_POST, 'content', FILTER_SANITIZE_SPECIAL_CHARS);
   119|         $faqData['author'] = Filter::filterInput(INPUT_POST, 'author', FILTER_SANITIZE_SPECIAL_CHARS);
   120|         $faqData['email'] = Filter::filterInput(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
   121|         $faqData['comment'] = Filter::filterInput(INPUT_POST, 'comment', FILTER_SANITIZE_SPECIAL_CHARS);
   122|         $faqData['solution_id'] = Filter::filterInput(INPUT_POST, 'solution_id', FILTER_VALIDATE_INT);
   123|         $faqData['revision_id'] = Filter::filterInput(INPUT_POST, 'revision_id', FILTER_VALIDATE_INT, 0);
   124|         $faqData['sticky'] = Filter::filterInput(INPUT_POST, 'sticky', FILTER_VALIDATE_INT);
   125|         $faqData['tags'] = Filter::filterInput(INPUT_POST, 'tags', FILTER_SANITIZE_SPECIAL_CHARS);
   126|         $faqData['changed'] = Filter::filterInput(INPUT_POST, 'changed', FILTER_SANITIZE_SPECIAL_CHARS);
   127|         $faqData['dateStart'] = Filter::filterInput(INPUT_POST, 'dateStart', FILTER_SANITIZE_SPECIAL_CHARS);
   128|         $faqData['dateEnd'] = Filter::filterInput(INPUT_POST, 'dateEnd', FILTER_SANITIZE_SPECIAL_CHARS);
   129|         $faqData['content'] = html_entity_decode((string) $faqData['content']);
   130|     } elseif ('editentry' === $action) {
   131|         $id = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
   132|         $lang = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);
   133|         $translateTo = Filter::filterInput(INPUT_GET, 'translateTo', FILTER_SANITIZE_SPECIAL_CHARS);
   134|         $categoryId = Filter::filterInput(INPUT_GET, 'cat', FILTER_VALIDATE_INT);
   135|         if (!is_null($translateTo)) {
   136|             $faqData['lang'] = $lang = $translateTo;
   137|             $selectedCategory = $categoryId;
   138|         }
   139|         if ((!isset($selectedCategory) && !isset($faqData['title'])) || !is_null($id)) {
   140|             $logging = new AdminLog($faqConfig);
   141|             $logging->log($user, 'admin-edit-faq ' . $id);
   142|             $categories = $categoryRelation->getCategories($id, $lang);
   143|             if (count($categories) === 0) {
   144|                 $categories = [
   145|                     'category_id' => $selectedCategory,
   146|                     'category_lang' => $faqData['lang'],
   147|                 ];
   148|             }
   149|             $faq->getRecord($id, null, true);
   150|             $faqData = $faq->faqRecord;
   151|             if (!is_null($translateTo)) {
   152|                 $faqData['lang'] = $translateTo; // once again
   153|             }
   154|             $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));
   155|             $queryString = 'saveentry&amp;id=' . $faqData['id'];
   156|         } else {
   157|             $queryString = 'insertentry';
   158|             if (isset($categoryId)) {
   159|                 $categories = ['category_id' => $categoryId, 'category_lang' => $lang];
   160|             }
   161|         }
   162|     } elseif ('copyentry' === $action) {
   163|         $faqData['id'] = Filter::filterInput(INPUT_GET, 'id', FILTER_VALIDATE_INT);
   164|         $faqData['lang'] = Filter::filterInput(INPUT_GET, 'lang', FILTER_SANITIZE_SPECIAL_CHARS);
   165|         $categories = $categoryRelation->getCategories($faqData['id'], $faqData['lang']);
   166|         $faq->getRecord($faqData['id'], null, true);
   167|         $faqData = $faq->faqRecord;
   168|         $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));
   169|         $queryString = 'insertentry';
   170|     } else {
   171|         $logging = new AdminLog($faqConfig);
   172|         $logging->log($user, 'admin-add-faq');
   173|         $queryString = 'insertentry';
   174|         if (!is_array($categories)) {
   175|             $categories = [];
   176|         }
   177|     }
   178|     $selectedRevisionId = Filter::filterInput(INPUT_POST, 'revisionid_selected', FILTER_VALIDATE_INT);
   179|     if (is_null($selectedRevisionId)) {
   180|         $selectedRevisionId = $faqData['revision_id'];
   181|     }
   182|     $userPermission = $faqPermission->get(FaqPermission::USER, $faqData['id']);
   183|     if (count($userPermission) == 0 || $userPermission[0] == -1) {
   184|         $allUsers = true;
   185|         $restrictedUsers = false;
   186|         $userPermission[0] = -1;
   187|     } else {
   188|         $allUsers = false;
   189|         $restrictedUsers = true;
   190|     }
   191|     $groupPermission = $faqPermission->get(FaqPermission::GROUP, $faqData['id']);
   192|     if (empty($groupPermission) || in_array(-1, $groupPermission, true)) {
   193|         $allGroups = true;
   194|         $restrictedGroups = false;
   195|         $groupPermission[0] = -1;
   196|     } else {
   197|         $allGroups = false;
   198|         $restrictedGroups = true;
   199|     }
   200|     $faqData['title'] = (isset($faqData['title']) ? Strings::htmlentities($faqData['title'], ENT_HTML5 | ENT_COMPAT) : '');
   201|     $faqData['content'] =
   202|         (isset($faqData['content']) ? trim(Strings::htmlentities($faqData['content'], ENT_COMPAT, 'utf-8', true)) : '');
   203|     $faqData['tags'] = (isset($faqData['tags']) ? Strings::htmlentities($faqData['tags']) : '');
   204|     $faqData['keywords'] = (isset($faqData['keywords']) ? Strings::htmlentities($faqData['keywords']) : '');
   205|     $faqData['author'] = (isset($faqData['author']) ? Strings::htmlentities(
   206|         $faqData['author']
   207|     ) : $user->getUserData('display_name'));
   208|     $faqData['email'] = (isset($faqData['email']) ? Strings::htmlentities($faqData['email']) : $user->getUserData(
   209|         'email'
   210|     ));
   211|     $faqData['isoDate'] = ($faqData['date'] ?? date('Y-m-d H:i'));
   212|     $faqData['date'] = (isset($faqData['date']) ? $date->format($faqData['date']) : $date->format(date('Y-m-d H:i')));
   213|     $faqData['changed'] ??= '';
   214|     if (isset($faqData['comment']) && $faqData['comment'] == 'y') {
   215|         $faqData['comment'] = ' checked';
   216|     } elseif ($faqConfig->get('records.defaultAllowComments')) {
   217|         $faqData['comment'] = ' checked';
   218|     } else {
   219|         $faqData['comment'] = '';
   220|     }
   221|     if (0 !== $faqData['id'] && 'copyentry' !== $action) {
   222|         $currentRevision = sprintf('%s 1.%d', Translation::get('ad_entry_revision'), $selectedRevisionId);
   223|         $faqUrl = sprintf(
   224|             '%sindex.php?action=faq&cat=%s&id=%d&artlang=%s',
   225|             $faqConfig->getDefaultUrl(),
   226|             $category->getCategoryIdFromFaq($faqData['id']),
   227|             $faqData['id'],
   228|             $faqData['lang']
   229|         );
   230|         $link = new Link($faqUrl, $faqConfig);
   231|         $link->itemTitle = $faqData['title'];
   232|         ?>
   233|         <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
   234|             <h1 class="h2">
   235|                 <i aria-hidden="true" class="fa fa-edit"></i>
   236|                 <?= Translation::get('ad_entry_edit_1') ?>
   237|                 <?= Translation::get('ad_entry_edit_2') ?>
   238|             </h1>
   239|             <div class="btn-toolbar mb-2 mb-md-0">
   240|                 <div class="btn-group mr-2">
   241|               <span class="btn btn-sm btn-info">
   242|                 <i class="fa fa-hashtag" aria-hidden="true"></i>
   243|                 <?= $currentRevision ?>
   244|               </span>
   245|                     <a href="<?= $link->toString() ?>" class="btn btn-sm btn-success">
   246|                         <i class="fa fa-arrow-alt-circle-right" aria-hidden="true"></i>
   247|                         <?= Translation::get('ad_view_faq') ?>
   248|                     </a>
   249|                 </div>
   250|             </div>
   251|         </div>
   252|     <?php } else { ?>
   253|         <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
   254|             <h1 class="h2">
   255|                 <i aria-hidden="true" class="fa fa-edit"></i>
   256|                 <?= Translation::get('ad_entry_add') ?>
   257|             </h1>
   258|         </div>
   259|     <?php } ?>
   260|         <div class="row">
   261|             <div class="col-lg-9">
   262|                 <div class="card mb-4">
   263|                     <div class="card-header">
   264|                         <ul class="nav nav-tabs card-header-tabs" id="nav-tab" role="tablist">
   265|                             <li class="nav-item">
   266|                                 <a class="nav-link active" data-bs-toggle="tab" href="#tab-question-answer" role="tab">
   267|                                     <i class="fa fa-pencil-square-o"></i> <?= Translation::get('ad_record_faq') ?>
   268|                                 </a>
   269|                             </li>
   270|                             <li class="nav-item">
   271|                                 <a class="nav-link" data-bs-toggle="tab" href="#tab-meta-data" role="tab">
   272|                                     <i class="fa fa-database"></i> <?= Translation::get('ad_menu_faq_meta') ?>
   273|                                 </a>
   274|                             </li>
   275|                             <li class="nav-item">
   276|                                 <a class="nav-link" data-bs-toggle="tab" href="#tab-permissions" role="tab">
   277|                                     <i class="fa fa-unlock-alt"></i> <?= Translation::get('ad_record_permissions') ?>
   278|                                 </a>
   279|                             </li>
   280|                             <li class="nav-item">
   281|                                 <a class="nav-link" data-bs-toggle="tab" href="#tab-notes-changelog" role="tab">
   282|                                     <i class="fa fa-sticky-note-o"></i>
   283|                                     <?= Translation::get('ad_admin_notes') . ' / ' . Translation::get('ad_entry_changelog') ?>
   284|                                 </a>
   285|                             </li>
   286|                         </ul>
   287|                     </div>
   288|                     <div class="card-body">
   289|                         <div class="tab-content">
   290|                             <div class="tab-pane active" id="tab-question-answer">
   291|                                 <!-- Revision -->
   292|                                 <?php
   293|                                 if ($user->perm->hasPermission($currentUserId, 'changebtrevs') && $action === 'editentry') {
   294|                                     $faqRevision = new Revision($faqConfig);
   295|                                     $revisions = $faqRevision->get($faqData['id'], $faqData['lang'], $faqData['author']);
   296|                                     if (count($revisions)) { ?>
   297|                                         <div class="form-group mb-2">
   298|                                             <form id="selectRevision" name="selectRevision" method="post"
   299|                                                   action="?action=editentry&amp;id=<?= $faqData['id'] ?>&amp;lang=<?= $faqData['lang'] ?>">
   300|                                                 <select name="revisionid_selected" onchange="this.form.submit();"
   301|                                                         class="form-select">
   302|                                                     <option value="<?= $faqData['revision_id'] ?>">
   303|                                                         <?= Translation::get('ad_changerev') ?>
   304|                                                     </option>
   305|                                                     <?php foreach ($revisions as $revisionData) { ?>
   306|                                                         <option value="<?= $revisionData['revision_id'] ?>" <?php if ($selectedRevisionId == $revisionData['revision_id']) {
   307|                                                             echo 'selected';
   308|                                                                        }
   309|                                                                         ?>>
   310|                                                             <?php printf(
   311|                                                                 '%s 1.%d: %s - %s',
   312|                                                                 Translation::get('ad_entry_revision'),
   313|                                                                 $revisionData['revision_id'],
   314|                                                                 Date::createIsoDate($revisionData['updated']),
   315|                                                                 $revisionData['author']
   316|                                                             );
   317|                                                             ?>
   318|                                                         </option>
   319|                                                         <?php
   320|                                                     }
   321|                                                     ?>
   322|                                                 </select>
   323|                                             </form>
   324|                                         </div>
   325|                                     <?php }
   326|                                     if (
   327|                                         isset($selectedRevisionId) &&
   328|                                         isset($faqData['revision_id']) &&
   329|                                         $selectedRevisionId !== $faqData['revision_id']
   330|                                     ) {
   331|                                         $faq->language = $faqData['lang'];
   332|                                         $faq->getRecord($faqData['id'], $selectedRevisionId, true);
   333|                                         $faqData = $faq->faqRecord;
   334|                                         $faqData['tags'] = implode(', ', $tagging->getAllTagsById($faqData['id']));
   335|                                         $faqData['revision_id'] = $selectedRevisionId;
   336|                                     }
   337|                                 }
   338|                                 ?>
   339|                               <form id="faqEditor" action="?action=<?= $queryString ?>" method="post"
   340|                                     data-pmf-enable-editor="<?= $faqConfig->get('main.enableWysiwygEditor') ?>"
   341|                                     data-pmf-editor-language="en"
   342|                                     data-pmf-default-url="<?= $faqConfig->getDefaultUrl() ?>">
   343|                                 <input type="hidden" name="revision_id" id="revision_id" value="<?= $faqData['revision_id'] ?>">
   344|                                 <input type="hidden" name="record_id" id="record_id" value="<?= $faqData['id'] ?>">
   345|                                 <input type="hidden" name="openQuestionId" id="openQuestionId" value="<?= $questionId ?>">
   346|                                   <input type="hidden" name="notifyUser" id="notifyUser"
   347|                                          value="<?= Strings::htmlentities($notifyUser) ?>">
   348|                                   <input type="hidden" name="notifyEmail" id="notifyEmail"
   349|                                          value="<?= Strings::htmlentities($notifyEmail) ?>">
   350|                                 <?= Token::getInstance()->getTokenInput('edit-faq') ?>
   351|                                 <!-- Question -->
   352|                                 <div class="form-group mb-2">
   353|                                     <input type="text" name="question" id="question"
   354|                                            class="form-control form-control-lg"
   355|                                            placeholder="<?= Translation::get('ad_entry_theme') ?>"
   356|                                            value="<?= $faqData['title'] ?>">
   357|                                 </div>
   358|                                 <!-- Answer -->
   359|                                 <?php if ($faqConfig->get('main.enableWysiwygEditor')): ?>
   360|                                     <div class="row">
   361|                                         <div class="col-lg-12">
   362|                                             <noscript>Please enable JavaScript to use the WYSIWYG editor!</noscript>
   363|                                             <textarea id="editor" name="answer" class="form-control" rows="7"
   364|                                                       placeholder="<?= Translation::get('ad_entry_content') ?>"
   365|                                             ><?= $faqData['content'] ?></textarea>
   366|                                         </div>
   367|                                     </div>
   368|                                 <?php endif; ?>
   369|                                 <?php if ($faqConfig->get('main.enableMarkdownEditor')) : ?>
   370|                                     <div class="row">
   371|                                       <div class="col-lg-12">
   372|                                         <ul class="nav nav-tabs mb-2" id="markdown-tabs">
   373|                                           <li class="nav-item">
   374|                                             <a class="nav-link active" data-bs-toggle="tab" href="#text">Text</a>
   375|                                           </li>
   376|                                           <li class="nav-item">
   377|                                             <a class="nav-link" data-bs-toggle="tab" href="#preview" data-markdown-tab="preview">Preview</a>
   378|                                           </li>
   379|                                         </ul>
   380|                                         <div class="tab-content">
   381|                                           <div class="tab-pane active" id="text">
   382|                                             <div class="row">
   383|                                               <div class="col-lg-12">
   384|                                                 <textarea id="answer-markdown" name="answer" class="form-control"
   385|                                                           rows="7" placeholder="<?= Translation::get('ad_entry_content') ?>"
   386|                                                 ><?= $faqData['content'] ?></textarea>
   387|                                               </div>
   388|                                             </div>
   389|                                           </div>
   390|                                           <div class="tab-pane" id="preview">
   391|                                             <article id="markdown-preview"></article>
   392|                                           </div>
   393|                                         </div>
   394|                                       </div>
   395|                                     </div>
   396|                                 <?php endif; ?>
   397|                             </div>
   398|                             <div class="tab-pane" id="tab-meta-data">
   399|                                 <!-- Categories -->
   400|                                 <div class="row mb-2">
   401|                                     <label class="col-lg-2 col-form-label" for="phpmyfaq-categories">
   402|                                         <?= Translation::get('ad_entry_category') ?>
   403|                                     </label>
   404|                                     <div class="col-lg-10">
   405|                                         <select name="rubrik[]" id="phpmyfaq-categories" size="5" multiple
   406|                                                 class="form-control">
   407|                                             <?= $categoryHelper->renderOptions($categories) ?>
   408|                                         </select>
   409|                                     </div>
   410|                                 </div>
   411|                                 <!-- Language -->
   412|                                 <div class="row mb-2">
   413|                                     <label class="col-lg-2 col-form-label" for="lang">
   414|                                         <?= Translation::get('ad_entry_locale') ?>:
   415|                                     </label>
   416|                                     <div class="col-lg-10">
   417|                                         <?= LanguageHelper::renderSelectLanguage($faqData['lang'], false, [], 'lang') ?>
   418|                                     </div>
   419|                                 </div>
   420|                                 <!-- Attachments -->
   421|                                 <?php if ($user->perm->hasPermission($currentUserId, 'addattachment')) : ?>
   422|                                     <div class="row mb-2">
   423|                                         <label class="col-lg-2 col-form-label">
   424|                                             <?= Translation::get('ad_menu_attachments') ?>:
   425|                                         </label>
   426|                                         <div class="col-lg-10">
   427|                                             <ul class="list-unstyled adminAttachments">
   428|                                                 <?php
   429|                                                 $attList = AttachmentFactory::fetchByRecordId(
   430|                                                     $faqConfig,
   431|                                                     $faqData['id']
   432|                                                 );
   433|                                                 foreach ($attList as $att) {
   434|                                                     printf(
   435|                                                         '<li><a href="../%s">%s</a> ',
   436|                                                         $att->buildUrl(),
   437|                                                         Strings::htmlentities($att->getFilename())
   438|                                                     );
   439|                                                     if ($user->perm->hasPermission($currentUserId, 'delattachment')) {
   440|                                                         printf(
   441|                                                             '<a class="badge bg-danger" href="?action=delatt&amp;record_id=%d&amp;id=%d&amp;lang=%s"><i aria-hidden="true" class="fa fa-trash"></i></a>',
   442|                                                             $faqData['id'],
   443|                                                             $att->getId(),
   444|                                                             $faqData['lang']
   445|                                                         );
   446|                                                     }
   447|                                                     echo "</li>\n";
   448|                                                 }
   449|                                                 ?>
   450|                                             </ul>
   451|                                             <?php
   452|                                             printf(
   453|                                                 '<button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#attachmentModal">%s</button>',
   454|                                                 Translation::get('ad_att_add')
   455|                                             );
   456|                                             ?>
   457|                                         </div>
   458|                                     </div>
   459|                                 <?php endif; ?>
   460|                                 <!-- Tags -->
   461|                                 <div class="row mb-2">
   462|                                     <label class="col-lg-2 col-form-label" for="tags">
   463|                                         <?= Translation::get('ad_entry_tags') ?>:
   464|                                     </label>
   465|                                     <div class="col-lg-10">
   466|                                         <input type="text" name="tags" id="tags" value="<?= $faqData['tags'] ?>"
   467|                                                autocomplete="off"
   468|                                                class="form-control pmf-tags-autocomplete">
   469|                                         <small id="tagsHelp"
   470|                                                class="form-text visually-hidden"><?= Translation::get('msgShowHelp') ?></small>
   471|                                     </div>
   472|                                 </div>
   473|                                 <!-- Keywords -->
   474|                                 <div class="row mb-2">
   475|                                     <label class="col-lg-2 col-form-label" for="keywords">
   476|                                         <?= Translation::get('ad_entry_keywords') ?>:
   477|                                     </label>
   478|                                     <div class="col-lg-10">
   479|                                         <input type="text" name="keywords" id="keywords" maxlength="255"
   480|                                                class="form-control" autocomplete="off"
   481|                                                value="<?= $faqData['keywords'] ?>">
   482|                                         <small id="keywordsHelp"
   483|                                                class="form-text visually-hidden"><?= Translation::get('msgShowHelp') ?></small>
   484|                                     </div>
   485|                                 </div>
   486|                                 <!-- Author -->
   487|                                 <div class="row mb-2">
   488|                                     <label class="col-lg-2 col-form-label" for="author">
   489|                                         <?= Translation::get('ad_entry_author') ?>
   490|                                     </label>
   491|                                     <div class="col-lg-10">
   492|                                         <input type="text" name="author" id="author" value="<?= $faqData['author'] ?>"
   493|                                                class="form-control">
   494|                                     </div>
   495|                                 </div>
   496|                                 <!-- E-Mail -->
   497|                                 <div class="row mb-2">
   498|                                     <label class="col-lg-2 col-form-label" for="email">
   499|                                         <?= Translation::get('ad_entry_email') ?>
   500|                                     </label>
   501|                                     <div class="col-lg-10">
   502|                                         <input type="email" name="email" id="email" value="<?= $faqData['email'] ?>"
   503|                                                class="form-control">
   504|                                     </div>
   505|                                 </div>
   506|                             </div>
   507|                             <div class="tab-pane" id="tab-permissions">
   508|                                 <!-- Permissions -->
   509|                                 <?php if ($faqConfig->get('security.permLevel') !== 'basic') : ?>
   510|                                     <fieldset class="form-group">
   511|                                         <div class="row">
   512|                                             <legend class="col-lg-2 col-form-label pt-0">
   513|                                               <?= Translation::get('ad_entry_grouppermission') ?>
   514|                                             </legend>
   515|                                             <div class="col-lg-10">
   516|                                               <div class="form-check">
   517|                                                 <input type="radio" id="allgroups" name="grouppermission"
   518|                                                        value="all" class="form-check-input"
   519|                                                   <?php echo($allGroups ? 'checked' : ''); ?>>
   520|                                                 <label class="form-check-label" for="allgroups">
   521|                                                   <?= Translation::get('ad_entry_all_groups') ?>
   522|                                                 </label>
   523|                                               </div>
   524|                                               <div class="form-check">
   525|                                                 <input type="radio" id="restrictedgroups" name="grouppermission"
   526|                                                        class="form-check-input"
   527|                                                        value="restricted" <?php echo($restrictedGroups ? 'checked' : ''); ?>>
   528|                                                 <label for="selected-groups" class="form-check-label"
   529|                                                        for="restrictedgroups">
   530|                                                   <?= Translation::get('ad_entry_restricted_groups') ?>
   531|                                                 </label>
   532|                                                 <select id="selected-groups" name="restricted_groups[]" size="3"
   533|                                                         class="form-control" multiple>
   534|                                                     <?= $user->perm->getAllGroupsOptions($groupPermission, $user) ?>
   535|                                                 </select>
   536|                                               </div>
   537|                                             </div>
   538|                                         </div>
   539|                                     </fieldset>
   540|                                 <?php else : ?>
   541|                                     <input type="hidden" name="grouppermission" value="all">
   542|                                 <?php endif; ?>
   543|                                 <fieldset class="form-group">
   544|                                     <div class="row">
   545|                                         <legend class="col-lg-2 col-form-label pt-0">
   546|                                             <?= Translation::get('ad_entry_userpermission') ?>
   547|                                         </legend>
   548|                                         <div class="col-lg-10">
   549|                                             <div class="form-check">
   550|                                                 <input type="radio" id="allusers" name="userpermission" value="all"
   551|                                                        class="form-check-input"
   552|                                                        <?= $allUsers ? 'checked' : '' ?>>
   553|                                                 <label class="form-check-label" for="allusers">
   554|                                                     <?= Translation::get('ad_entry_all_users') ?>
   555|                                                 </label>
   556|                                             </div>
   557|                                             <div class="form-check">
   558|                                                 <input type="radio" id="restrictedusers" name="userpermission"
   559|                                                        class="form-check-input"
   560|                                                        value="restricted" <?= $restrictedUsers ? 'checked' : '' ?>>
   561|                                                 <label class="form-check-label" for="restrictedusers">
   562|                                                     <?= Translation::get('ad_entry_restricted_users') ?>
   563|                                                 </label>
   564|                                                 <select name="restricted_users" id="selected-user" class="form-select">
   565|                                                     <?= $userHelper->getAllUserOptions($userPermission[0], false) ?>
   566|                                                 </select>
   567|                                             </div>
   568|                                         </div>
   569|                                     </div>
   570|                                 </fieldset>
   571|                             </div>
   572|                             <div class="tab-pane" id="tab-notes-changelog">
   573|                                 <h6 class="card-title sr-only">
   574|                                     <?= Translation::get('ad_entry_changelog') ?>
   575|                                 </h6>
   576|                                 <div class="row mb-2">
   577|                                     <label class="col-lg-2 col-form-label" for="changelog-date">
   578|                                         <?= Translation::get('ad_entry_date') ?>
   579|                                     </label>
   580|                                     <div class="col-lg-10">
   581|                                         <input type="text" readonly class="form-control-plaintext" id="changelog-date"
   582|                                                value="<?= $faqData['date'] ?>">
   583|                                     </div>
   584|                                 </div>
   585|                                 <div class="row mb-2">
   586|                                     <label class="col-lg-2 col-form-label" for="changed">
   587|                                         <?= Translation::get('ad_entry_changed') ?>
   588|                                     </label>
   589|                                     <div class="col-lg-10">
   590|                                         <textarea name="changed" id="changed" rows="3" class="form-control"
   591|                                         ><?= $faqData['changed'] ?></textarea>
   592|                                     </div>
   593|                                 </div>
   594|                                 <h6 class="card-title">
   595|                                     <label for="notes">
   596|                                         <?php printf(Translation::get('ad_admin_notes_hint'), Translation::get('ad_admin_notes')) ?>
   597|                                     </label>
   598|                                 </h6>
   599|                                 <div class="row mb-2">
   600|                                     <div class="col-lg-10 offset-lg-2">
   601|                                         <textarea id="notes" name="notes" class="form-control" rows="3"
   602|                                         ><?= $faqData['notes'] ?? '' ?></textarea>
   603|                                     </div>
   604|                                 </div>
   605|                                 <div class="row mb-2">
   606|                                     <div class="col-lg-2">
   607|                                         <h6 class="card-title">
   608|                                             <?= Translation::get('ad_entry_changelog_history') ?>
   609|                                         </h6>
   610|                                     </div>
   611|                                     <div class="col-lg-10">
   612|                                         <ul>
   613|                                             <?php foreach ($changelog->getByFaqId($faqData['id']) as $entry) {
   614|                                                 $entryUser = new User($faqConfig);
   615|                                                 $entryUser->getUserById($entry['user']);
   616|                                                 ?>
   617|                                                 <li class="small pt-0">
   618|                                                     <?php printf(
   619|                                                         '<i class="fa fa-hand-o-right"></i> %s  1.%d <i class="fa fa-calendar"></i> %s <i class="fa fa-user"></i> %s',
   620|                                                         Translation::get('ad_entry_revision'),
   621|                                                         $entry['revision_id'],
   622|                                                         $date->format(date('Y-m-d H:i', $entry['date'])),
   623|                                                         $entryUser->getUserData('display_name')
   624|                                                     );
   625|                                                     ?>
   626|                                                     <br>
   627|                                                     <?= Strings::htmlentities($entry['changelog'] ?? '') ?>
   628|                                                 </li>
   629|                                             <?php } ?>
   630|                                         </ul>
   631|                                     </div>
   632|                                 </div>
   633|                             </div>
   634|                         </div>
   635|                     </div>
   636|                 </div>
   637|             </div>
   638|             <!-- Sidebar -->
   639|             <div class="col-lg-3">
   640|                 <div id="accordion" role="tablist">
   641|                     <div class="card mb-4">
   642|                         <div class="card-header text-center" role="tab" id="pmf-heading-date">
   643|                             <?php if ($selectedRevisionId === $faqData['revision_id']) : ?>
   644|                                 <button class="btn btn-lg btn-info" type="reset">
   645|                                     <?= Translation::get('ad_gen_reset') ?>
   646|                                 </button>
   647|                                 <button class="btn btn-lg btn-primary" type="submit">
   648|                                     <?= Translation::get('ad_entry_save') ?>
   649|                                 </button>
   650|                             <?php endif ?>
   651|                         </div>
   652|                         <div class="card-body">
   653|                             <h5 class="mb-0">
   654|                                 <?= Translation::get('ad_entry_date') ?>
   655|                             </h5>
   656|                             <div class="form-group">
   657|                                 <div class="form-check">
   658|                                     <input type="radio" id="updateDate" checked name="recordDateHandling"
   659|                                            class="form-check-input" value="updateDate"
   660|                                            onchange="setRecordDate(this.id);">
   661|                                     <label class="form-check-label" for="updateDate">
   662|                                         <?= Translation::get('msgUpdateFaqDate') ?>
   663|                                     </label>
   664|                                 </div>
   665|                                 <div class="form-check">
   666|                                     <input type="radio" id="keepDate" name="recordDateHandling" class="form-check-input"
   667|                                            onchange="setRecordDate(this.id);" value="keepDate">
   668|                                     <label class="form-check-label" for="keepDate">
   669|                                         <?= Translation::get('msgKeepFaqDate') ?>
   670|                                     </label>
   671|                                 </div>
   672|                                 <div class="form-check">
   673|                                     <input type="radio" id="manualDate" name="recordDateHandling"
   674|                                            class="form-check-input" value="manualDate"
   675|                                            onchange="setRecordDate(this.id);">
   676|                                     <label class="form-check-label" for="manualDate">
   677|                                         <?= Translation::get('msgEditFaqDat') ?>
   678|                                     </label>
   679|                                 </div>
   680|                                 <div id="recordDateInputContainer" class="invisible mb-2">
   681|                                     <input type="datetime-local" name="date" id="date" class="form-control"
   682|                                            placeholder="<?= $faqData['date'] ?>">
   683|                                 </div>
   684|                             </div>
   685|                             <h5 class="mb-0">
   686|                                 <?= Translation::get('ad_entry_status') ?>
   687|                             </h5>
   688|                             <div class="form-group">
   689|                                 <!-- active or not -->
   690|                                 <?php if ($user->perm->hasPermission($currentUserId, 'approverec')) :
   691|                                     if (isset($faqData['active']) && $faqData['active'] === 'yes') {
   692|                                         $isActive = ' checked';
   693|                                         $isInActive = null;
   694|                                     } else {
   695|                                         $isActive = null;
   696|                                         $isInActive = ' checked';
   697|                                     }
   698|                                     if ($faqConfig->get('records.defaultActivation') && $queryString === 'insertentry') {
   699|                                         $isActive = ' checked';
   700|                                         $isInActive = null;
   701|                                     }
   702|                                     ?>
   703|                                     <div class="form-check">
   704|                                         <input type="radio" id="active" name="active" value="yes"
   705|                                                class="form-check-input"
   706|                                             <?php if (isset($isActive)) {
   707|                                                 echo $isActive;
   708|                                             } ?>>
   709|                                         <label class="form-check-label" for="active">
   710|                                             <?= Translation::get('ad_entry_visibility') ?>
   711|                                         </label>
   712|                                     </div>
   713|                                     <div class="form-check">
   714|                                         <input type="radio" id="inactive" name="active" value="no"
   715|                                                class="form-check-input"
   716|                                             <?php if (isset($isInActive)) {
   717|                                                 echo $isInActive;
   718|                                             } ?>>
   719|                                         <label class="form-check-label" for="inactive">
   720|                                           <?= Translation::get('ad_entry_not_visibility') ?>
   721|                                         </label>
   722|                                     </div>
   723|                                 <?php else : ?>
   724|                                     <div class="form-check">
   725|                                         <input type="radio" id="inactive" name="active" value="no"
   726|                                                class="form-check-input" checked>
   727|                                         <label class="form-check-label" for="inactive">
   728|                                             <?= Translation::get('ad_entry_not_visibility') ?>
   729|                                         </label>
   730|                                     </div>
   731|                                 <?php endif; ?>
   732|                             </div>
   733|                             <?php if ($queryString != 'insertentry' && !$faqConfig->get('records.enableAutoRevisions')) : ?>
   734|                               <h5 class="mb-0">
   735|                                   <?= Translation::get('ad_entry_new_revision') ?>
   736|                               </h5>
   737|                               <div class="form-group">
   738|                                 <div class="form-check">
   739|                                   <input type="radio" name="revision" id="revision" value="yes"
   740|                                          class="form-check-input">
   741|                                   <label class="form-check-label"
   742|                                          for="revision"><?= Translation::get('ad_gen_yes') ?></label>
   743|                                 </div>
   744|                                 <div class="form-check">
   745|                                   <input type="radio" name="revision" id="no-revision" value="no"
   746|                                          checked class="form-check-input">
   747|                                   <label class="form-check-label"
   748|                                          for="no-revision"><?= Translation::get('ad_gen_no') ?></label>
   749|                                 </div>
   750|                               </div>
   751|                             <?php endif ?>
   752|                             <div class="form-group">
   753|                                 <!-- sticky or not -->
   754|                                 <div class="form-check">
   755|                                     <input type="checkbox" id="sticky" name="sticky" class="form-check-input"
   756|                                         <?php echo(isset($faqData['sticky']) && $faqData['sticky'] ? 'checked' : '') ?>>
   757|                                     <label class="form-check-label"
   758|                                            for="sticky"><?= Translation::get('ad_entry_sticky') ?></label>
   759|                                 </div>
   760|                                 <!-- comments allowed or not -->
   761|                                 <div class="form-check">
   762|                                     <input type="checkbox" name="comment" id="comment" value="y"
   763|                                            class="form-check-input"
   764|                                            <?= $faqData['comment'] ?>>
   765|                                     <label class="form-check-label"
   766|                                            for="comment"><?= Translation::get('ad_entry_allowComments') ?></label>
   767|                                 </div>
   768|                             </div>
   769|                             <div class="form-group">
   770|                                 <!-- solution id -->
   771|                                 <label class="col-form-label" for="solution_id">
   772|                                     <?= Translation::get('ad_entry_solution_id') ?>:
   773|                                 </label>
   774|                                 <input type="number" name="solution_id" id="solution_id" size="5" class="form-control"
   775|                                        readonly
   776|                                        value="<?= $faqData['solution_id'] ?? $faq->getNextSolutionId() ?>">
   777|                             </div>
   778|                         </div>
   779|                     </div>
   780|                 </div>
   781|             </div>
   782|         </div>
   783|     </form>
   784|     <!-- Attachment Upload Dialog -->
   785|     <?php
   786|     if (0 === $faqData['id']) {
   787|         $faqData['id'] = $faqConfig->getDb()->nextId(
   788|             Database::getTablePrefix() . 'faqdata',
   789|             'id'
   790|         );
   791|     }
   792|     ?>
   793|   <div class="modal fade" id="attachmentModal" tabindex="-1" role="dialog" aria-labelledby="attachmentModalLabel"
   794|        aria-hidden="true">
   795|     <div class="modal-dialog" role="document">
   796|       <div class="modal-content">
   797|         <div class="modal-header">
   798|           <h5 class="modal-title" id="attachmentModalLabel">
   799|               <?= Translation::get('ad_att_addto') . ' ' . Translation::get('ad_att_addto_2') ?>
   800|             (max <?= Utils::formatBytes($faqConfig->get('records.maxAttachmentSize')) ?>)
   801|           </h5>
   802|             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
   803|         </div>
   804|         <div class="modal-body">
   805|           <form action="api/attachment.php?action=upload" enctype="multipart/form-data" method="post"
   806|                 id="attachmentForm" novalidate>
   807|             <fieldset>
   808|               <input type="hidden" name="MAX_FILE_SIZE" value="<?= $faqConfig->get('records.maxAttachmentSize') ?>">
   809|               <input type="hidden" name="record_id" id="attachment_record_id" value="<?= $faqData['id'] ?>">
   810|               <input type="hidden" name="record_lang" id="attachment_record_lang" value="<?= $faqData['lang'] ?>">
   811|               <input type="hidden" name="save" value="true">
   812|               <?= Token::getInstance()->getTokenInput('upload-attachment') ?>
   813|               <div class="mb-2">
   814|                 <label class="form-label" for="filesToUpload">
   815|                   <?= Translation::get('ad_att_att') ?>
   816|                 </label>
   817|                 <input type="file" class="form-control" name="filesToUpload[]" id="filesToUpload" multiple>
   818|                 <div class="invalid-feedback">
   819|                   The file is too big.
   820|                 </div>
   821|               </div>
   822|               <div class="pmf-attachment-upload-files invisible mb-2">
   823|                 <?= Translation::get('msgAttachmentsFilesize') ?>:
   824|                 <output id="filesize"></output>
   825|               </div>
   826|             </fieldset>
   827|           </form>
   828|         </div>
   829|         <div class="modal-footer">
   830|           <button type="button" class="btn btn-primary" id="pmf-attachment-modal-upload">
   831|               <?= Translation::get('ad_att_butt') ?>
   832|           </button>
   833|         </div>
   834|       </div>
   835|     </div>
   836|   </div>
   837|     <script>
   838|       function setRecordDate(how) {
   839|         if ('updateDate' === how) {
   840|           document.getElementById('date').value = '';
   841|         } else if ('keepDate' === how) {
   842|           document.getElementById('date').value = '<?= $faqData['isoDate'] ?>';
   843|         } else if ('manualDate' === how) {
   844|           document.getElementById('recordDateInputContainer').classList.remove('invisible');
   845|           document.getElementById('date').value = '';
   846|         }
   847|       }
   848|     </script>
   849|     <?php
   850| } elseif ($user->perm->hasPermission($currentUserId, 'edit_faq') && !Database::checkOnEmptyTable('faqcategories')) {
   851|     echo Translation::get('err_NotAuth');
   852| } elseif ($user->perm->hasPermission($currentUserId, 'edit_faq') && Database::checkOnEmptyTable('faqcategories')) {
   853|     echo Translation::get('no_cats');
   854| }


# ====================================================================
# FILE: phpmyfaq/api.service.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-865 ---
     1| <?php
     2| /**
     3|  * The API Service Layer.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2010-2023 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2010-09-15
    15|  */
    16| const IS_VALID_PHPMYFAQ = null;
    17| use phpMyFAQ\Captcha\Captcha;
    18| use phpMyFAQ\Category;
    19| use phpMyFAQ\Comments;
    20| use phpMyFAQ\Configuration;
    21| use phpMyFAQ\Entity\Comment;
    22| use phpMyFAQ\Entity\CommentType;
    23| use phpMyFAQ\Entity\FaqEntity;
    24| use phpMyFAQ\Faq;
    25| use phpMyFAQ\Faq\FaqMetaData;
    26| use phpMyFAQ\Faq\FaqPermission;
    27| use phpMyFAQ\Filter;
    28| use phpMyFAQ\Helper\CategoryHelper;
    29| use phpMyFAQ\Helper\FaqHelper;
    30| use phpMyFAQ\Helper\QuestionHelper;
    31| use phpMyFAQ\Helper\RegistrationHelper;
    32| use phpMyFAQ\Language;
    33| use phpMyFAQ\Language\Plurals;
    34| use phpMyFAQ\Link;
    35| use phpMyFAQ\Mail;
    36| use phpMyFAQ\Network;
    37| use phpMyFAQ\News;
    38| use phpMyFAQ\Notification;
    39| use phpMyFAQ\Question;
    40| use phpMyFAQ\Rating;
    41| use phpMyFAQ\Search;
    42| use phpMyFAQ\Search\SearchResultSet;
    43| use phpMyFAQ\Session;
    44| use phpMyFAQ\Session\Token;
    45| use phpMyFAQ\StopWords;
    46| use phpMyFAQ\Strings;
    47| use phpMyFAQ\Translation;
    48| use phpMyFAQ\User;
    49| use phpMyFAQ\User\CurrentUser;
    50| use phpMyFAQ\Utils;
    51| use Symfony\Component\HttpFoundation\JsonResponse;
    52| use Symfony\Component\HttpFoundation\Request;
    53| use Symfony\Component\HttpFoundation\Response;
    54| use Symfony\Component\Mailer\Exception\TransportExceptionInterface;
    55| require 'src/Bootstrap.php';
    56| $response = new JsonResponse();
    57| $request = Request::createFromGlobals();
    58| $faqConfig = Configuration::getConfigurationInstance();
    59| $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
    60| $apiLanguage = Filter::filterVar($postData['lang'], FILTER_SANITIZE_SPECIAL_CHARS);
    61| $currentToken = Filter::filterVar($postData['csrf'] ?? '', FILTER_SANITIZE_SPECIAL_CHARS);
    62| $action = Filter::filterVar($request->get('action'), FILTER_SANITIZE_SPECIAL_CHARS);
    63| if ($faqConfig->get('security.enableGoogleReCaptchaV2')) {
    64|     $code = Filter::filterVar($postData['g-recaptcha-response'] ?? '', FILTER_SANITIZE_SPECIAL_CHARS);
    65| } else {
    66|     $code = Filter::filterVar($postData['captcha'] ?? '', FILTER_SANITIZE_SPECIAL_CHARS);
    67| }
    68| $Language = new Language($faqConfig);
    69| $languageCode = $Language->setLanguage($faqConfig->get('main.languageDetection'), $faqConfig->get('main.language'));
    70| require_once 'lang/language_en.php';
    71| $faqConfig->setLanguage($Language);
    72| if (Language::isASupportedLanguage($apiLanguage)) {
    73|     $languageCode = trim((string) $apiLanguage);
    74|     require_once 'lang/language_' . $languageCode . '.php';
    75| } else {
    76|     $languageCode = 'en';
    77|     require_once 'lang/language_en.php';
    78| }
    79| try {
    80|     Translation::create()
    81|         ->setLanguagesDir(PMF_LANGUAGE_DIR)
    82|         ->setDefaultLanguage('en')
    83|         ->setCurrentLanguage($languageCode);
    84| } catch (Exception $e) {
    85|     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
    86|     $response->setData(['error' => $e->getMessage()]);
    87| }
    88| Strings::init($languageCode);
    89| $user = CurrentUser::getCurrentUser($faqConfig);
    90| $faqSession = new Session($faqConfig);
    91| $faqSession->setCurrentUser($user);
    92| $network = new Network($faqConfig);
    93| $stopWords = new StopWords($faqConfig);
    94| $faqHelper = new FaqHelper($faqConfig);
    95| if ($network->isBanned($request->server->get('REMOTE_ADDR'))) {
    96|     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
    97|     $response->setData(['error' => Translation::get('err_bannedIP')]);
    98| }
    99| $captcha = Captcha::getInstance($faqConfig);
   100| $captcha->setUserIsLoggedIn($user->isLoggedIn());
   101| $fatalError = false;
   102| if (
   103|     'add-voting' !== $action && 'submit-user-data' !== $action && 'change-password' !== $action &&
   104|     'submit-request-removal' !== $action && !$captcha->checkCaptchaCode($code ?? '')
   105| ) {
   106|     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   107|     $response->setData(['error' => Translation::get('msgCaptcha')]);
   108|     $fatalError = true;
   109| }
   110| if (
   111|     !$user->isLoggedIn() && $faqConfig->get('security.enableLoginOnly') && 'submit-request-removal' !== $action &&
   112|     'change-password' !== $action && 'save-registration' !== $action
   113| ) {
   114|     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   115|     $response->setData(['error' => Translation::get('ad_msg_noauth')]);
   116|     $fatalError = true;
   117| }
   118| if ($fatalError) {
   119|     $response->send();
   120|     exit();
   121| }
   122| switch ($action) {
   123|     case 'add-comment':
   124|         if (
   125|             !$faqConfig->get('records.allowCommentsForGuests') &&
   126|             !$user->perm->hasPermission($user->getUserId(), 'addcomment')
   127|         ) {
   128|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   129|             $response->setData(['error' => Translation::get('err_NotAuth')]);
   130|             break;
   131|         }
   132|         $faq = new Faq($faqConfig);
   133|         $oComment = new Comments($faqConfig);
   134|         $category = new Category($faqConfig);
   135|         $type = Filter::filterVar($postData['type'], FILTER_SANITIZE_SPECIAL_CHARS);
   136|         $faqId = Filter::filterVar($postData['id'] ?? null, FILTER_VALIDATE_INT, 0);
   137|         $newsId = Filter::filterVar($postData['newsId'] ?? null, FILTER_VALIDATE_INT);
   138|         $username = Filter::filterVar($postData['user'], FILTER_SANITIZE_SPECIAL_CHARS);
   139|         $mailer = Filter::filterVar($postData['mail'], FILTER_VALIDATE_EMAIL);
   140|         $comment = Filter::filterVar($postData['comment_text'], FILTER_SANITIZE_SPECIAL_CHARS);
   141|         switch ($type) {
   142|             case 'news':
   143|                 $id = $newsId;
   144|                 break;
   145|             case 'faq':
   146|                 $id = $faqId;
   147|                 break;
   148|         }
   149|         if (!$faqConfig->get('main.optionalMailAddress') && is_null($mailer)) {
   150|             $mailer = $faqConfig->getAdminEmail();
   151|         }
   152|         if (!$user->isLoggedIn()) {
   153|             $user = new User($faqConfig);
   154|             if (true === $user->checkDisplayName($username) && true === $user->checkMailAddress($mailer)) {
   155|                 $response->setStatusCode(Response::HTTP_CONFLICT);
   156|                 $response->setData(['error' => Translation::get('err_SaveComment')]);
   157|                 $faqConfig->getLogger()->error('Name and mail already used by registered user.');
   158|                 break;
   159|             }
   160|         }
   161|         if (
   162|             !is_null($username) && !is_null($mailer) && !is_null($comment) && $stopWords->checkBannedWord($comment) &&
   163|             !$faq->commentDisabled($id, $languageCode, $type) && !$faq->isActive($id, $languageCode, $type)
   164|         ) {
   165|             try {
   166|                 $faqSession->userTracking('save_comment', $id);
   167|             } catch (Exception $exception) {
   168|                 $faqConfig->getLogger()->error('Tracking of save new comment', ['exception' => $exception->getMessage()]);
   169|             }
   170|             $commentEntity = new Comment();
   171|             $commentEntity
   172|                 ->setRecordId($id)
   173|                 ->setType($type)
   174|                 ->setUsername($username)
   175|                 ->setEmail($mailer)
   176|                 ->setComment(nl2br(strip_tags((string) $comment)))
   177|                 ->setDate($request->server->get('REQUEST_TIME'));
   178|             if ($oComment->addComment($commentEntity)) {
   179|                 $emailTo = $faqConfig->getAdminEmail();
   180|                 $title = '';
   181|                 $urlToContent = '';
   182|                 if ('faq' == $type) {
   183|                     $faq->getRecord($id);
   184|                     if ($faq->faqRecord['email'] != '') {
   185|                         $emailTo = $faq->faqRecord['email'];
   186|                     }
   187|                     $title = $faq->getRecordTitle($id);
   188|                     $faqUrl = sprintf(
   189|                         '%s?action=faq&cat=%d&id=%d&artlang=%s',
   190|                         $faqConfig->getDefaultUrl(),
   191|                         $category->getCategoryIdFromFaq($faq->faqRecord['id']),
   192|                         $faq->faqRecord['id'],
   193|                         $faq->faqRecord['lang']
   194|                     );
   195|                     $oLink = new Link($faqUrl, $faqConfig);
   196|                     $oLink->itemTitle = $faq->faqRecord['title'];
   197|                     $urlToContent = $oLink->toString();
   198|                 } else {
   199|                     $news = new News($faqConfig);
   200|                     $newsData = $news->getNewsEntry($id);
   201|                     if ($newsData['authorEmail'] != '') {
   202|                         $emailTo = $newsData['authorEmail'];
   203|                     }
   204|                     $title = $newsData['header'];
   205|                     $link = sprintf(
   206|                         '%s?action=news&newsid=%d&newslang=%s',
   207|                         $faqConfig->getDefaultUrl(),
   208|                         $newsData['id'],
   209|                         $newsData['lang']
   210|                     );
   211|                     $oLink = new Link($link, $faqConfig);
   212|                     $oLink->itemTitle = $newsData['header'];
   213|                     $urlToContent = $oLink->toString();
   214|                 }
   215|                 $commentMail =
   216|                     'User: ' . $commentEntity->getUsername() . ', mailto:' . $commentEntity->getEmail() . "\n" .
   217|                     'Title: ' . $title . "\n" .
   218|                     'New comment posted here: ' . $urlToContent .
   219|                     "\n\n" .
   220|                     wordwrap((string) $comment, 72);
   221|                 $send = [];
   222|                 $mailer = new Mail($faqConfig);
   223|                 $mailer->setReplyTo($commentEntity->getEmail(), $commentEntity->getUsername());
   224|                 $mailer->addTo($emailTo);
   225|                 $send[$emailTo] = 1;
   226|                 $send[$faqConfig->getAdminEmail()] = 1;
   227|                 if ($type === CommentType::FAQ) {
   228|                     $category = new Category($faqConfig);
   229|                     $categories = $category->getCategoryIdsFromFaq($faq->faqRecord['id']);
   230|                     foreach ($categories as $_category) {
   231|                         $userId = $category->getOwner($_category);
   232|                         $catUser = new User($faqConfig);
   233|                         $catUser->getUserById($userId);
   234|                         $catOwnerEmail = $catUser->getUserData('email');
   235|                         if ($catOwnerEmail !== '') {
   236|                             if (!isset($send[$catOwnerEmail]) && $catOwnerEmail !== $emailTo) {
   237|                                 $mailer->addCc($catOwnerEmail);
   238|                                 $send[$catOwnerEmail] = 1;
   239|                             }
   240|                         }
   241|                     }
   242|                 }
   243|                 $mailer->subject = $faqConfig->getTitle() . ': New comment for "' . $title . '"';
   244|                 $mailer->message = strip_tags($commentMail);
   245|                 $result = $mailer->send();
   246|                 unset($mailer);
   247|                 $response->setStatusCode(Response::HTTP_OK);
   248|                 $response->setData(['success' => Translation::get('msgCommentThanks')]);
   249|             } else {
   250|                 try {
   251|                     $faqSession->userTracking('error_save_comment', $id);
   252|                 } catch (Exception) {
   253|                 }
   254|                 $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   255|                 $response->setData(['error' => Translation::get('err_SaveComment')]);
   256|             }
   257|         } else {
   258|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   259|             $response->setData(['error' => 'Please add your name, your e-mail address and a comment!']);
   260|         }
   261|         break;
   262|     case 'add-faq':
   263|         if (
   264|             !$faqConfig->get('records.allowNewFaqsForGuests') &&
   265|             !$user->perm->hasPermission($user->getUserId(), 'addfaq')
   266|         ) {
   267|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   268|             $response->setData(['error' => Translation::get('err_NotAuth')]);
   269|             break;
   270|         }
   271|         $faq = new Faq($faqConfig);
   272|         $category = new Category($faqConfig);
   273|         $questionObject = new Question($faqConfig);
   274|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   275|         $author = trim((string) Filter::filterVar($postData['name'], FILTER_SANITIZE_SPECIAL_CHARS));
   276|         $email = trim((string) Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL));
   277|         $question = Filter::filterVar($postData['question'], FILTER_SANITIZE_SPECIAL_CHARS);
   278|         $question = trim(strip_tags((string) $question));
   279|         if ($faqConfig->get('main.enableWysiwygEditorFrontend')) {
   280|             $answer = Filter::filterVar($postData['answer'], FILTER_SANITIZE_SPECIAL_CHARS);
   281|             $answer = trim(html_entity_decode((string) $answer));
   282|         } else {
   283|             $answer = Filter::filterVar($postData['answer'], FILTER_SANITIZE_SPECIAL_CHARS);
   284|             $answer = strip_tags((string) $answer);
   285|             $answer = trim(nl2br($answer));
   286|         }
   287|         $contentLink = Filter::filterVar($postData['contentlink'], FILTER_VALIDATE_URL);
   288|         $keywords = Filter::filterVar($postData['keywords'], FILTER_SANITIZE_SPECIAL_CHARS);
   289|         if (isset($postData['rubrik[]'])) {
   290|             if (is_string($postData['rubrik[]'])) {
   291|                 $postData['rubrik[]'] = [ $postData['rubrik[]'] ];
   292|             }
   293|             $categories = Filter::filterArray(
   294|                 $postData['rubrik[]']
   295|             );
   296|         }
   297|         if (isset($postData['faqid']) && isset($postData['lang']) && isset($postData['translated_answer'])) {
   298|             $faqId = Filter::filterVar($postData['faqid'], FILTER_VALIDATE_INT);
   299|             $faqLanguage = Filter::filterVar($postData['lang'], FILTER_SANITIZE_SPECIAL_CHARS);
   300|             $answer = trim((string) Filter::filterVar($postData['translated_answer'], FILTER_SANITIZE_SPECIAL_CHARS));
   301|         }
   302|         if (
   303|             !is_null($author) && !is_null($email) && !empty($question) &&
   304|             $stopWords->checkBannedWord(strip_tags($question)) &&
   305|             !empty($answer) && $stopWords->checkBannedWord(strip_tags($answer))
   306|         ) {
   307|             $isNew = true;
   308|             $newLanguage = '';
   309|             if (!isset($faqId)) {
   310|                 $isNew = false;
   311|                 try {
   312|                     $faqSession->userTracking('save_new_translation_entry', 0);
   313|                 } catch (Exception) {
   314|                 }
   315|             } else {
   316|                 try {
   317|                     $faqSession->userTracking('save_new_entry', 0);
   318|                 } catch (Exception) {
   319|                 }
   320|             }
   321|             $isTranslation = false;
   322|             if (isset($faqLanguage) && !is_null($faqLanguage)) {
   323|                 $isTranslation = true;
   324|                 $newLanguage = $faqLanguage;
   325|             }
   326|             if (!is_null($contentLink) && Strings::substr($contentLink, 7) !== '') {
   327|                 $answer = sprintf(
   328|                     '%s<br><div id="newFAQContentLink">%s<a href="https://%s" target="_blank">%s</a></div>',
   329|                     $answer,
   330|                     Translation::get('msgInfo'),
   331|                     Strings::substr($contentLink, 7),
   332|                     Strings::htmlentities($contentLink)
   333|                 );
   334|             }
   335|             $autoActivate = $faqConfig->get('records.defaultActivation');
   336|             $faqEntity = new FaqEntity();
   337|             $faqEntity
   338|                 ->setLanguage(($isTranslation === true ? $newLanguage : $languageCode))
   339|                 ->setQuestion($question)
   340|                 ->setActive($autoActivate)
   341|                 ->setSticky(false)
   342|                 ->setAnswer($answer)
   343|                 ->setKeywords($keywords)
   344|                 ->setAuthor($author)
   345|                 ->setEmail($email)
   346|                 ->setComment(true)
   347|                 ->setNotes('');
   348|             if (!$isNew && isset($faqId)) {
   349|                 $faqEntity->setId($faqId);
   350|                 $categories = $category->getCategoryIdsFromFaq($faqId);
   351|             }
   352|             $recordId = $faq->create($faqEntity);
   353|             $openQuestionId = Filter::filterInput(INPUT_POST, 'openQuestionID', FILTER_VALIDATE_INT);
   354|             if ($openQuestionId) {
   355|                 if ($faqConfig->get('records.enableDeleteQuestion')) {
   356|                     $questionObject->deleteQuestion($openQuestionId);
   357|                 } else { // adds this faq record id to the related open question
   358|                     $questionObject->updateQuestionAnswer($openQuestionId, $recordId, $categories[0]);
   359|                 }
   360|             }
   361|             $faqMetaData = new FaqMetaData($faqConfig);
   362|             $faqMetaData
   363|                 ->setFaqId($recordId)
   364|                 ->setFaqLanguage($faqEntity->getLanguage())
   365|                 ->setCategories($categories)
   366|                 ->save();
   367|             $categoryHelper = new CategoryHelper();
   368|             $categoryHelper
   369|                 ->setCategory($category)
   370|                 ->setConfiguration($faqConfig);
   371|             $moderators = $categoryHelper->getModerators($categories);
   372|             try {
   373|                 $notification = new Notification($faqConfig);
   374|                 $notification->sendNewFaqAdded($moderators, $recordId, $faqEntity->getLanguage());
   375|             } catch (Exception | TransportExceptionInterface $e) {
   376|                 $faqConfig->getLogger()->info('Notification could not be sent: ', [ $e->getMessage() ]);
   377|             }
   378|             if ($faqConfig->get('records.defaultActivation')) {
   379|                 $link = [
   380|                     'link' => $faqHelper->createFaqUrl($faqEntity, $categories[0]),
   381|                     'info' => Translation::get('msgRedirect')
   382|                 ];
   383|             } else {
   384|                 $link = [];
   385|             }
   386|             $response->setStatusCode(Response::HTTP_OK);
   387|             $response->setData([
   388|                 'success' =>
   389|                     ($isNew ? Translation::get('msgNewContentThanks') : Translation::get('msgNewTranslationThanks')),
   390|                 ... $link
   391|             ]);
   392|         } else {
   393|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   394|             $response->setData(['error' => Translation::get('err_SaveEntries')]);
   395|         }
   396|         break;
   397|     case 'ask-question':
   398|         if (
   399|             !$faqConfig->get('records.allowQuestionsForGuests') &&
   400|             !$faqConfig->get('main.enableAskQuestions') &&
   401|             !$user->perm->hasPermission($user->getUserId(), 'addquestion')
   402|         ) {
   403|             $response->setStatusCode(Response::HTTP_UNAUTHORIZED);
   404|             $response->setData(['error' => Translation::get('err_NotAuth')]);
   405|             break;
   406|         }
   407|         $faq = new Faq($faqConfig);
   408|         $cat = new Category($faqConfig);
   409|         $questionObject = new Question($faqConfig);
   410|         $categories = $cat->getAllCategories();
   411|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   412|         $author = trim((string) Filter::filterVar($postData['name'], FILTER_SANITIZE_SPECIAL_CHARS));
   413|         $email = trim((string) Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL));
   414|         $ucategory = Filter::filterVar($postData['category'], FILTER_VALIDATE_INT);
   415|         $question = Filter::filterVar($postData['question'], FILTER_SANITIZE_SPECIAL_CHARS);
   416|         $question = trim(strip_tags((string) $question));
   417|         $save = Filter::filterVar($postData['save'] ?? 0, FILTER_VALIDATE_INT);
   418|         if (!$faqConfig->get('main.optionalMailAddress') && is_null($email)) {
   419|             $email = $faqConfig->getAdminEmail();
   420|         }
   421|         if (false === $faqConfig->get('main.enableSmartAnswering')) {
   422|             $save = true;
   423|         }
   424|         if (!empty($author) && !empty($email) && !empty($question) && $stopWords->checkBannedWord($question)) {
   425|             if ($faqConfig->get('records.enableVisibilityQuestions')) {
   426|                 $visibility = 'Y';
   427|             } else {
   428|                 $visibility = 'N';
   429|             }
   430|             $questionData = [
   431|                 'username' => $author,
   432|                 'email' => $email,
   433|                 'category_id' => $ucategory,
   434|                 'question' => Strings::htmlentities($question),
   435|                 'is_visible' => $visibility
   436|             ];
   437|             if (false === (bool)$save) {
   438|                 $cleanQuestion = $stopWords->clean($question);
   439|                 $user = new CurrentUser($faqConfig);
   440|                 $faqSearch = new Search($faqConfig);
   441|                 $faqSearch->setCategory(new Category($faqConfig));
   442|                 $faqSearch->setCategoryId((int) $ucategory);
   443|                 $faqPermission = new FaqPermission($faqConfig);
   444|                 $faqSearchResult = new SearchResultSet($user, $faqPermission, $faqConfig);
   445|                 $plr = new Plurals();
   446|                 $searchResult = [];
   447|                 $mergedResult = [];
   448|                 foreach ($cleanQuestion as $word) {
   449|                     if (!empty($word)) {
   450|                         try {
   451|                             $searchResult[] = $faqSearch->search($word, false);
   452|                         } catch (Exception $e) {
   453|                         }
   454|                     }
   455|                 }
   456|                 foreach ($searchResult as $resultSet) {
   457|                     foreach ($resultSet as $result) {
   458|                         $mergedResult[] = $result;
   459|                     }
   460|                 }
   461|                 $faqSearchResult->reviewResultSet($mergedResult);
   462|                 if (0 < $faqSearchResult->getNumberOfResults()) {
   463|                     $smartAnswer = sprintf(
   464|                         '<h5>%s</h5>',
   465|                         $plr->getMsg('plmsgSearchAmount', $faqSearchResult->getNumberOfResults())
   466|                     );
   467|                     $smartAnswer .= '<ul>';
   468|                     foreach ($faqSearchResult->getResultSet() as $result) {
   469|                         $url = sprintf(
   470|                             '%sindex.php?action=faq&cat=%d&id=%d&artlang=%s',
   471|                             $faqConfig->getDefaultUrl(),
   472|                             $result->category_id,
   473|                             $result->id,
   474|                             $result->lang
   475|                         );
   476|                         $oLink = new Link($url, $faqConfig);
   477|                         $oLink->text = Utils::chopString($result->question, 15);
   478|                         $oLink->itemTitle = $result->question;
   479|                         try {
   480|                             $smartAnswer .= sprintf(
   481|                                 '<li>%s<br><small class="pmf-search-preview">%s...</small></li>',
   482|                                 $oLink->toHtmlAnchor(),
   483|                                 $faqHelper->renderAnswerPreview($result->answer, 10)
   484|                             );
   485|                         } catch (Exception) {
   486|                         }
   487|                     }
   488|                     $smartAnswer .= '</ul>';
   489|                     $response->setData(['result' => $smartAnswer]);
   490|                 } else {
   491|                     $questionObject->addQuestion($questionData);
   492|                     $questionHelper = new QuestionHelper($faqConfig, $cat);
   493|                     try {
   494|                         $questionHelper->sendSuccessMail($questionData, $categories);
   495|                     } catch (Exception | TransportExceptionInterface $exception) {
   496|                         $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   497|                         $response->setData(['error' => $exception->getMessage()]);
   498|                     }
   499|                     $response->setStatusCode(Response::HTTP_OK);
   500|                     $response->setData(['success' => Translation::get('msgAskThx4Mail')]);
   501|                 }
   502|             } else {
   503|                 $questionObject->addQuestion($questionData);
   504|                 $questionHelper = new QuestionHelper($faqConfig, $cat);
   505|                 try {
   506|                     $questionHelper->sendSuccessMail($questionData, $categories);
   507|                 } catch (Exception | TransportExceptionInterface $exception) {
   508|                     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   509|                     $response->setData(['error' => $exception->getMessage()]);
   510|                 }
   511|                 $response->setStatusCode(Response::HTTP_OK);
   512|                 $response->setData(['success' => Translation::get('msgAskThx4Mail')]);
   513|             }
   514|         } else {
   515|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   516|             $response->setData(['error' => Translation::get('err_SaveQuestion')]);
   517|         }
   518|         break;
   519|     case 'save-registration':
   520|         $registration = new RegistrationHelper($faqConfig);
   521|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   522|         $fullName = trim((string) Filter::filterVar($postData['realname'], FILTER_SANITIZE_SPECIAL_CHARS));
   523|         $userName = trim((string) Filter::filterVar($postData['name'], FILTER_SANITIZE_SPECIAL_CHARS));
   524|         $email = trim((string) Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL));
   525|         $isVisible = Filter::filterVar($postData['is_visible'], FILTER_SANITIZE_SPECIAL_CHARS) ?? false;
   526|         if (!$registration->isDomainAllowed($email)) {
   527|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   528|             $response->setData(['error' => 'The domain is not whitelisted.']);
   529|             break;
   530|         }
   531|         if (!is_null($userName) && !is_null($email) && !is_null($fullName)) {
   532|             try {
   533|                 $response->setData($registration->createUser($userName, $fullName, $email, $isVisible));
   534|             } catch (Exception | TransportExceptionInterface $exception) {
   535|                 $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   536|                 $response->setData(['error' => $exception->getMessage()]);
   537|             }
   538|         } else {
   539|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   540|             $response->setData(['error' => Translation::get('err_sendMail')]);
   541|         }
   542|         break;
   543|     case 'add-voting':
   544|         $faq = new Faq($faqConfig);
   545|         $rating = new Rating($faqConfig);
   546|         $faqId = Filter::filterVar($postData['id'] ?? null, FILTER_VALIDATE_INT, 0);
   547|         $vote = Filter::filterVar($postData['value'], FILTER_VALIDATE_INT);
   548|         $userIp = Filter::filterVar($request->server->get('REMOTE_ADDR'), FILTER_VALIDATE_IP);
   549|         if (isset($vote) && $rating->check($faqId, $userIp) && $vote > 0 && $vote < 6) {
   550|             try {
   551|                 $faqSession->userTracking('save_voting', $faqId);
   552|             } catch (Exception) {
   553|             }
   554|             $votingData = [
   555|                 'record_id' => $faqId,
   556|                 'vote' => $vote,
   557|                 'user_ip' => $userIp,
   558|             ];
   559|             if (!$rating->getNumberOfVotings($faqId)) {
   560|                 $rating->addVoting($votingData);
   561|             } else {
   562|                 $rating->update($votingData);
   563|             }
   564|             $response->setStatusCode(Response::HTTP_OK);
   565|             $response->setData([
   566|                 'success' => Translation::get('msgVoteThanks'),
   567|                 'rating' => $rating->getVotingResult($faqId),
   568|             ]);
   569|         } elseif (!$rating->check($faqId, $userIp)) {
   570|             try {
   571|                 $faqSession->userTracking('error_save_voting', $faqId);
   572|             } catch (Exception $exception) {
   573|                 $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   574|                 $response->setData(['error' => $exception->getMessage()]);
   575|             }
   576|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   577|             $response->setData(['error' => Translation::get('err_VoteTooMuch')]);
   578|         } else {
   579|             try {
   580|                 $faqSession->userTracking('error_save_voting', $faqId);
   581|             } catch (Exception $exception) {
   582|                 $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   583|                 $response->setData(['error' => $exception->getMessage()]);
   584|             }
   585|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   586|             $response->setData(['error' => Translation::get('err_noVote')]);
   587|         }
   588|         break;
   589|     case 'submit-contact':
   590|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   591|         $author = trim((string) Filter::filterVar($postData['name'], FILTER_SANITIZE_SPECIAL_CHARS));
   592|         $email = Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL);
   593|         $question = trim((string) Filter::filterVar($postData['question'], FILTER_SANITIZE_SPECIAL_CHARS));
   594|         if (!$faqConfig->get('main.optionalMailAddress') && is_null($email)) {
   595|             $email = $faqConfig->getAdminEmail();
   596|         }
   597|         if (!empty($author) && !empty($email) && !empty($question) && $stopWords->checkBannedWord($question)) {
   598|             $question = sprintf(
   599|                 "%s: %s\n%s: %s\n\n %s",
   600|                 Translation::get('msgNewContentName'),
   601|                 $author,
   602|                 Translation::get('msgNewContentMail'),
   603|                 $email,
   604|                 $question
   605|             );
   606|             $mailer = new Mail($faqConfig);
   607|             try {
   608|                 $mailer->setReplyTo($email, $author);
   609|                 $mailer->addTo($faqConfig->getAdminEmail());
   610|                 $mailer->subject = Utils::resolveMarkers('Feedback: %sitename%', $faqConfig);
   611|                 $mailer->message = $question;
   612|                 $mailer->send();
   613|                 unset($mailer);
   614|                 $response->setStatusCode(Response::HTTP_OK);
   615|                 $response->setData(['success' => Translation::get('msgMailContact')]);
   616|             } catch (Exception | TransportExceptionInterface $e) {
   617|                 $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   618|                 $response->setData(['error' => $e->getMessage()]);
   619|             }
   620|         } else {
   621|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   622|             $response->setData(['error' => Translation::get('err_sendMail')]);
   623|         }
   624|         break;
   625|     case 'sendtofriends':
   626|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   627|         $author = trim((string) Filter::filterVar($postData['name'], FILTER_SANITIZE_SPECIAL_CHARS));
   628|         $email = Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL);
   629|         $attached = trim((string) Filter::filterVar($postData['message'], FILTER_SANITIZE_SPECIAL_CHARS));
   630|         $mailto = Filter::filterArray($postData['mailto[]']);
   631|         $faqLanguage = trim((string) Filter::filterVar($postData['lang'], FILTER_SANITIZE_SPECIAL_CHARS));
   632|         $faqId = trim((string) Filter::filterVar($postData['faqId'], FILTER_VALIDATE_INT));
   633|         $categoryId = trim((string) Filter::filterVar($postData['categoryId'], FILTER_VALIDATE_INT));
   634|         if (is_array($mailto) && count($mailto) > 5) {
   635|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   636|             $response->setData(['error' => Translation::get('err_sendMail')]);
   637|             break;
   638|         }
   639|         if (
   640|             !is_null($author) && !is_null($email) && is_array($mailto) &&
   641|             $stopWords->checkBannedWord(Strings::htmlspecialchars($attached))
   642|         ) {
   643|             $send2friendLink = sprintf(
   644|                 '%sindex.php?action=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
   645|                 $faqConfig->getDefaultUrl(),
   646|                 $categoryId,
   647|                 $faqId,
   648|                 urlencode($faqLanguage)
   649|             );
   650|             foreach ($mailto as $recipient) {
   651|                 $recipient = trim(strip_tags((string) $recipient));
   652|                 if (!empty($recipient)) {
   653|                     $mailer = new Mail($faqConfig);
   654|                     try {
   655|                         $mailer->setReplyTo($email, $author);
   656|                         $mailer->addTo($recipient);
   657|                     } catch (Exception $exception) {
   658|                         $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   659|                         $response->setData(['error' => $exception->getMessage()]);
   660|                     }
   661|                     $mailer->subject = Translation::get('msgS2FMailSubject') . $author;
   662|                     $mailer->message = sprintf(
   663|                         "%s\r\n\r\n%s\r\n%s\r\n\r\n%s",
   664|                         $faqConfig->get('main.send2friendText'),
   665|                         Translation::get('msgS2FText2'),
   666|                         $send2friendLink,
   667|                         strip_tags($attached)
   668|                     );
   669|                     $result = $mailer->send();
   670|                     unset($mailer);
   671|                     usleep(250);
   672|                 }
   673|             }
   674|             $response->setStatusCode(Response::HTTP_OK);
   675|             $response->setData(['success' => Translation::get('msgS2FThx')]);
   676|         } else {
   677|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   678|             $response->setData(['error' => Translation::get('err_sendMail')]);
   679|         }
   680|         break;
   681|     case 'submit-user-data':
   682|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   683|         $csrfToken = Filter::filterVar($postData[Token::PMF_SESSION_NAME], FILTER_SANITIZE_SPECIAL_CHARS);
   684|         if (!Token::getInstance()->verifyToken('ucp', $csrfToken)) {
   685|             $response->setStatusCode(Response::HTTP_UNAUTHORIZED);
   686|             $response->setData(['error' => Translation::get('ad_msg_noauth')]);
   687|             break;
   688|         }
   689|         $userId = Filter::filterVar($postData['userid'], FILTER_VALIDATE_INT);
   690|         $userName = trim((string) Filter::filterVar($postData['name'], FILTER_SANITIZE_SPECIAL_CHARS));
   691|         $email = Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL);
   692|         $isVisible = Filter::filterVar($postData['is_visible'], FILTER_SANITIZE_SPECIAL_CHARS);
   693|         $password = trim((string) Filter::filterVar($postData['faqpassword'], FILTER_SANITIZE_SPECIAL_CHARS));
   694|         $confirm = trim((string) Filter::filterVar($postData['faqpassword_confirm'], FILTER_SANITIZE_SPECIAL_CHARS));
   695|         $twoFactorEnabled = Filter::filterVar($postData['twofactor_enabled'] ?? 'off', FILTER_SANITIZE_SPECIAL_CHARS);
   696|         $deleteSecret = Filter::filterVar($postData['newsecret'] ?? '', FILTER_SANITIZE_SPECIAL_CHARS);
   697|         $user = CurrentUser::getFromSession($faqConfig);
   698|         $isAzureAdUser = $user->getUserAuthSource() === 'azure';
   699|         $isLdapUser = $user->getUserAuthSource() === 'ldap';
   700|         if ($deleteSecret === 'on') {
   701|             $secret = '';
   702|         } else {
   703|             $secret = $user->getUserData('secret');
   704|         }
   705|         if ($userId !== $user->getUserId()) {
   706|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   707|             $response->setData(['error' => 'User ID mismatch!']);
   708|             break;
   709|         }
   710|         if (!$isAzureAdUser && !$isLdapUser) {
   711|             if ($password !== $confirm) {
   712|                 $response->setStatusCode(Response::HTTP_CONFLICT);
   713|                 $response->setData(['error' => Translation::get('ad_user_error_passwordsDontMatch')]);
   714|                 break;
   715|             }
   716|             if (strlen($password) <= 7 || strlen($confirm) <= 7) {
   717|                 $response->setStatusCode(Response::HTTP_CONFLICT);
   718|                 $response->setData(['error' => Translation::get('ad_passwd_fail')]);
   719|                 break;
   720|             } else {
   721|                 $userData = [
   722|                     'display_name' => $userName,
   723|                     'email' => $email,
   724|                     'is_visible' => $isVisible === 'on' ? 1 : 0,
   725|                     'twofactor_enabled' => $twoFactorEnabled === 'on' ? 1 : 0,
   726|                     'secret' => $secret
   727|                 ];
   728|                 $success = $user->setUserData($userData);
   729|                 foreach ($user->getAuthContainer() as $auth) {
   730|                     if ($auth->setReadOnly()) {
   731|                         continue;
   732|                     }
   733|                     if (!$auth->update($user->getLogin(), $password)) {
   734|                         $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   735|                         $response->setData(['error' => $auth->error()]);
   736|                         $success = false;
   737|                     } else {
   738|                         $success = true;
   739|                     }
   740|                 }
   741|             }
   742|         } else {
   743|             $userData = [
   744|                 'is_visible' => $isVisible === 'on' ? 1 : 0,
   745|                 'twofactor_enabled' => $twoFactorEnabled === 'on' ? 1 : 0,
   746|                 'secret' => $secret
   747|             ];
   748|             $success = $user->setUserData($userData);
   749|         }
   750|         if ($success) {
   751|             $response->setStatusCode(Response::HTTP_OK);
   752|             $response->setData(['success' => Translation::get('ad_entry_savedsuc')]);
   753|         } else {
   754|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   755|             $response->setData(['error' => Translation::get('ad_entry_savedfail')]);
   756|         }
   757|         break;
   758|     case 'change-password':
   759|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   760|         $username = trim((string) Filter::filterVar($postData['username'], FILTER_SANITIZE_SPECIAL_CHARS));
   761|         $email = trim((string) Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL));
   762|         if (!empty($username) && !empty($email)) {
   763|             $user = new CurrentUser($faqConfig);
   764|             $loginExist = $user->getUserByLogin($username);
   765|             if ($loginExist && ($email == $user->getUserData('email'))) {
   766|                 try {
   767|                     $newPassword = $user->createPassword();
   768|                 } catch (Exception $exception) {
   769|                     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   770|                     $response->setData(['error' => $exception->getMessage()]);
   771|                 }
   772|                 try {
   773|                     $user->changePassword($newPassword);
   774|                 } catch (Exception $exception) {
   775|                     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   776|                     $response->setData(['error' => $exception->getMessage()]);
   777|                 }
   778|                 $text = Translation::get('lostpwd_text_1') . "\nUsername: " . $username . "\nNew Password: " .
   779|                     $newPassword . "\n\n" . Translation::get('lostpwd_text_2');
   780|                 $mailer = new Mail($faqConfig);
   781|                 try {
   782|                     $mailer->addTo($email);
   783|                 } catch (Exception $exception) {
   784|                     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   785|                     $response->setData(['error' => $exception->getMessage()]);
   786|                 }
   787|                 $mailer->subject = Utils::resolveMarkers('[%sitename%] Username / password request', $faqConfig);
   788|                 $mailer->message = $text;
   789|                 try {
   790|                     $result = $mailer->send();
   791|                 } catch (Exception | TransportExceptionInterface $exception) {
   792|                     $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   793|                     $response->setData(['error' => $exception->getMessage()]);
   794|                 }
   795|                 unset($mailer);
   796|                 $response->setStatusCode(Response::HTTP_OK);
   797|                 $response->setData(['success' => Translation::get('lostpwd_mail_okay')]);
   798|             } else {
   799|                 $response->setStatusCode(Response::HTTP_CONFLICT);
   800|                 $response->setData(['error' => Translation::get('lostpwd_err_1')]);
   801|             }
   802|         } else {
   803|             $response->setStatusCode(Response::HTTP_CONFLICT);
   804|             $response->setData(['error' => Translation::get('lostpwd_err_2')]);
   805|         }
   806|         break;
   807|     case 'submit-request-removal':
   808|         $postData = json_decode(file_get_contents('php://input'), true, 512, JSON_THROW_ON_ERROR);
   809|         $csrfToken = Filter::filterVar($postData[Token::PMF_SESSION_NAME], FILTER_SANITIZE_SPECIAL_CHARS);
   810|         if (!Token::getInstance()->verifyToken('request-removal', $csrfToken)) {
   811|             $response->setStatusCode(Response::HTTP_UNAUTHORIZED);
   812|             $response->setData(['error' => Translation::get('ad_msg_noauth')]);
   813|             break;
   814|         }
   815|         $userId = Filter::filterVar($postData['userId'], FILTER_VALIDATE_INT);
   816|         $author = trim((string) Filter::filterVar($postData['name'], FILTER_SANITIZE_SPECIAL_CHARS));
   817|         $loginName = trim((string) Filter::filterVar($postData['loginname'], FILTER_SANITIZE_SPECIAL_CHARS));
   818|         $email = trim((string) Filter::filterVar($postData['email'], FILTER_VALIDATE_EMAIL));
   819|         $question = trim((string) Filter::filterVar($postData['question'], FILTER_SANITIZE_SPECIAL_CHARS));
   820|         if (!$faqConfig->get('main.optionalMailAddress') && is_null($email)) {
   821|             $email = $faqConfig->getAdminEmail();
   822|         }
   823|         $user = new User($faqConfig);
   824|         if (
   825|             !$user->getUserById($userId) ||
   826|             $userId !== $user->getUserId() ||
   827|             $loginName !== $user->getLogin() ||
   828|             $email !== $user->getUserData('email')
   829|         ) {
   830|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   831|             $response->setData(['error' => Translation::get('ad_user_error_loginInvalid')]);
   832|             break;
   833|         }
   834|         if (!empty($author) && !empty($email) && !empty($question) && $stopWords->checkBannedWord($question)) {
   835|             $question = sprintf(
   836|                 "%s %s\n%s %s\n%s %s\n\n %s",
   837|                 Translation::get('ad_user_loginname'),
   838|                 $loginName,
   839|                 Translation::get('msgNewContentName'),
   840|                 $author,
   841|                 Translation::get('msgNewContentMail'),
   842|                 $email,
   843|                 $question
   844|             );
   845|             $mailer = new Mail($faqConfig);
   846|             try {
   847|                 $mailer->setReplyTo($email, $author);
   848|                 $mailer->addTo($faqConfig->getAdminEmail());
   849|                 $mailer->subject = $faqConfig->getTitle() . ': Remove User Request';
   850|                 $mailer->message = $question;
   851|                 $result = $mailer->send();
   852|                 unset($mailer);
   853|                 $response->setStatusCode(Response::HTTP_OK);
   854|                 $response->setData(['success' => Translation::get('msgMailContact')]);
   855|             } catch (Exception | TransportExceptionInterface $exception) {
   856|                 $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   857|                 $response->setData(['error' => $exception->getMessage()]);
   858|             }
   859|         } else {
   860|             $response->setStatusCode(Response::HTTP_BAD_REQUEST);
   861|             $response->setData(['error' => Translation::get('err_sendMail')]);
   862|         }
   863|         break;
   864| }
   865| $response->send();


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Auth/AuthSso.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-95 ---
     1| <?php
     2| /**
     3|  * Manages user authentication with Apache's SSO authentication, e.g. mod_sspi or mod_auth_kerb.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2011-2023 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2011-06-22
    15|  */
    16| namespace phpMyFAQ\Auth;
    17| use phpMyFAQ\Auth;
    18| use phpMyFAQ\Configuration;
    19| use phpMyFAQ\Core\Exception;
    20| use phpMyFAQ\Enums\AuthenticationSourceType;
    21| use phpMyFAQ\User;
    22| /**
    23|  * Class Sso
    24|  *
    25|  * @package phpMyFAQ\Auth
    26|  */
    27| class AuthSso extends Auth implements AuthDriverInterface
    28| {
    29|     /**
    30|      * @inheritDoc
    31|      * @throws Exception
    32|      */
    33|     public function create(string $login, string $password, string $domain = ''): bool
    34|     {
    35|         if ($this->config->isLdapActive()) {
    36|             $authLdap = new AuthLdap($this->config);
    37|             return $authLdap->create($login, '', $domain);
    38|         } else {
    39|             $user = new User($this->config);
    40|             $result = $user->createUser($login, '', $domain);
    41|             $user->setStatus('active');
    42|             $user->setAuthSource(AuthenticationSourceType::AUTH_SSO->value);
    43|             $user->setUserData([ 'display_name' => $login ]);
    44|             return $result;
    45|         }
    46|     }
    47|     /**
    48|      * @inheritDoc
    49|      */
    50|     public function update(string $login, string $password): bool
    51|     {
    52|         return true;
    53|     }
    54|     /**
    55|      * @inheritDoc
    56|      */
    57|     public function delete(string $login): bool
    58|     {
    59|         return true;
    60|     }
    61|     /**
    62|      * @inheritDoc
    63|      * @throws Exception
    64|      */
    65|     public function checkCredentials(string $login, string $password, array $optionalData = null): bool
    66|     {
    67|         if (!isset($_SERVER['REMOTE_USER'])) {
    68|             return false;
    69|         } else {
    70|             $remoteUser = explode('\\', (string) $_SERVER['REMOTE_USER']);
    71|             if (is_array($remoteUser) && count($remoteUser) > 1) {
    72|                 $user = $remoteUser[1];
    73|             } else {
    74|                 $remoteUser = explode('@', (string) $_SERVER['REMOTE_USER']);
    75|                 if (is_array($remoteUser) && count($remoteUser) > 1) {
    76|                     $user = $remoteUser[0];
    77|                 } else {
    78|                     $user = $_SERVER['REMOTE_USER'];
    79|                 }
    80|             }
    81|             if ($user === $login) {
    82|                 return true;
    83|             } else {
    84|                 return false;
    85|             }
    86|         }
    87|     }
    88|     /**
    89|      * @inheritDoc
    90|      */
    91|     public function isValidLogin(string $login, array $optionalData = null): int
    92|     {
    93|         return isset($_SERVER['REMOTE_USER']) ? 1 : 0;
    94|     }
    95| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Database/Mysqli.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-312 ---
     1| <?php
     2| /**
     3|  * The phpMyFAQ\Database\Mysqli class provides methods and functions for MySQL and
     4|  * MariaDB databases.
     5|  *
     6|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     7|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     8|  * obtain one at https://mozilla.org/MPL/2.0/.
     9|  *
    10|  * @package   phpMyFAQ
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @author    David Soria Parra <dsoria@gmx.net>
    13|  * @copyright 2005-2023 phpMyFAQ Team
    14|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    15|  * @link      https://www.phpmyfaq.de
    16|  */
    17| namespace phpMyFAQ\Database;
    18| use mysqli_result;
    19| use mysqli_sql_exception;
    20| use phpMyFAQ\Database;
    21| use phpMyFAQ\Core\Exception;
    22| use phpMyFAQ\Utils;
    23| /**
    24|  * Class Mysqli
    25|  *
    26|  * @package phpMyFAQ\Database
    27|  */
    28| class Mysqli implements DatabaseDriver
    29| {
    30|     /**
    31|      * @var string[] Tables.
    32|      */
    33|     public array $tableNames = [];
    34|     /**
    35|      * The connection object.
    36|      *
    37|      * @var \mysqli|bool
    38|      */
    39|     private \mysqli|bool $conn = false;
    40|     /**
    41|      * The query log string.
    42|      */
    43|     private string $sqllog = '';
    44|     /**
    45|      * Connects to the database.
    46|      *
    47|      * @param string $host Hostname or path to socket
    48|      * @param string $user Username
    49|      * @param string $password Password
    50|      * @param string $database Database name
    51|      * @param int|null $port
    52|      * @return null|bool true, if connected, otherwise false
    53|      * @throws Exception
    54|      */
    55|     public function connect(
    56|         string $host,
    57|         string $user,
    58|         string $password,
    59|         string $database = '',
    60|         int $port = null
    61|     ): ?bool {
    62|         try {
    63|             if (str_starts_with($host, '/')) {
    64|                 $this->conn = new \mysqli(null, $user, $password, null, $port, $host);
    65|             } else {
    66|                 $this->conn = new \mysqli($host, $user, $password, null, $port);
    67|             }
    68|         } catch (mysqli_sql_exception $exception) {
    69|             throw new Exception($exception->getMessage());
    70|         }
    71|         if ($this->conn->connect_error) {
    72|             Database::errorPage($this->conn->connect_errno . ': ' . $this->conn->connect_error);
    73|             die();
    74|         }
    75|         if (!$this->conn->set_charset('utf8mb4')) {
    76|             Database::errorPage($this->error());
    77|         }
    78|         if ('' !== $database) {
    79|             try {
    80|                 $this->conn->select_db($database);
    81|             } catch (mysqli_sql_exception) {
    82|                 throw new Exception('Cannot connect to database ' . $database);
    83|             }
    84|         }
    85|         return true;
    86|     }
    87|     /**
    88|      * Returns the error string.
    89|      */
    90|     public function error(): string
    91|     {
    92|         return $this->conn->error;
    93|     }
    94|     /**
    95|      * Escapes a string for use in a query.
    96|      */
    97|     public function escape(string $string): string
    98|     {
    99|         return $this->conn->real_escape_string($string);
   100|     }
   101|     /**
   102|      * Fetch a result row as an associative array.
   103|      */
   104|     public function fetchArray(mixed $result): ?array
   105|     {
   106|         return $result->fetch_assoc();
   107|     }
   108|     /**
   109|      * Fetch a result row.
   110|      */
   111|     public function fetchRow(mixed $result): mixed
   112|     {
   113|         return $result->fetch_row()[0] ?? false;
   114|     }
   115|     /**
   116|      * Fetches a complete result as an object.
   117|      *
   118|      * @param mixed $result Result set
   119|      * @throws Exception
   120|      */
   121|     public function fetchAll(mixed $result): ?array
   122|     {
   123|         $ret = [];
   124|         if (false === $result) {
   125|             throw new Exception('Error while fetching result: ' . $this->error());
   126|         }
   127|         while ($row = $this->fetchObject($result)) {
   128|             $ret[] = $row;
   129|         }
   130|         return $ret;
   131|     }
   132|     /**
   133|      * Fetch a result row as an object.
   134|      * This function fetches a result row as an object.
   135|      *
   136|      * @throws Exception
   137|      */
   138|     public function fetchObject(mixed $result): mixed
   139|     {
   140|         return $result->fetch_object();
   141|     }
   142|     /**
   143|      * Number of rows in a result.
   144|      */
   145|     public function numRows(mixed $result): int
   146|     {
   147|         if ($result instanceof mysqli_result) {
   148|             return $result->num_rows;
   149|         } else {
   150|             return 0;
   151|         }
   152|     }
   153|     /**
   154|      * Logs the queries.
   155|      */
   156|     public function log(): string
   157|     {
   158|         return $this->sqllog;
   159|     }
   160|     /**
   161|      * This function returns the table status.
   162|      *
   163|      * @param string $prefix Table prefix
   164|      * @return string[]
   165|      */
   166|     public function getTableStatus(string $prefix = ''): array
   167|     {
   168|         $status = [];
   169|         foreach ($this->getTableNames($prefix) as $table) {
   170|             $status[$table] = $this->getOne('SELECT count(*) FROM ' . $table);
   171|         }
   172|         return $status;
   173|     }
   174|     /**
   175|      * Returns an array with all table names.
   176|      *
   177|      * @todo Have to be refactored because of https://github.com/thorsten/phpMyFAQ/issues/965
   178|      *
   179|      * @param string $prefix Table prefix
   180|      *
   181|      * @return string[]
   182|      */
   183|     public function getTableNames(string $prefix = ''): array
   184|     {
   185|         return $this->tableNames = [
   186|             $prefix . 'faqadminlog',
   187|             $prefix . 'faqattachment',
   188|             $prefix . 'faqattachment_file',
   189|             $prefix . 'faqbackup',
   190|             $prefix . 'faqcaptcha',
   191|             $prefix . 'faqcategories',
   192|             $prefix . 'faqcategoryrelations',
   193|             $prefix . 'faqcategory_group',
   194|             $prefix . 'faqcategory_news',
   195|             $prefix . 'faqcategory_order',
   196|             $prefix . 'faqcategory_user',
   197|             $prefix . 'faqchanges',
   198|             $prefix . 'faqcomments',
   199|             $prefix . 'faqconfig',
   200|             $prefix . 'faqdata',
   201|             $prefix . 'faqdata_group',
   202|             $prefix . 'faqdata_revisions',
   203|             $prefix . 'faqdata_tags',
   204|             $prefix . 'faqdata_user',
   205|             $prefix . 'faqglossary',
   206|             $prefix . 'faqgroup',
   207|             $prefix . 'faqgroup_right',
   208|             $prefix . 'faqinstances',
   209|             $prefix . 'faqinstances_config',
   210|             $prefix . 'faqmeta',
   211|             $prefix . 'faqnews',
   212|             $prefix . 'faqquestions',
   213|             $prefix . 'faqright',
   214|             $prefix . 'faqsearches',
   215|             $prefix . 'faqsessions',
   216|             $prefix . 'faqstopwords',
   217|             $prefix . 'faqtags',
   218|             $prefix . 'faquser',
   219|             $prefix . 'faquserdata',
   220|             $prefix . 'faquserlogin',
   221|             $prefix . 'faquser_group',
   222|             $prefix . 'faquser_right',
   223|             $prefix . 'faqvisits',
   224|             $prefix . 'faqvoting',
   225|         ];
   226|     }
   227|     /**
   228|      * Returns just one row.
   229|      */
   230|     private function getOne(string $query): string
   231|     {
   232|         $row = $this->conn->query($query)->fetch_row();
   233|         return $row[0];
   234|     }
   235|     /**
   236|      * This function is a replacement for MySQL's auto-increment so that
   237|      * we don't need it anymore.
   238|      *
   239|      * @param string $table The name of the table
   240|      * @param string $id    The name of the ID column
   241|      */
   242|     public function nextId(string $table, string $id): int
   243|     {
   244|         $select = sprintf(
   245|             '
   246|            SELECT
   247|                MAX(%s) AS current_id
   248|            FROM
   249|                %s',
   250|             $id,
   251|             $table
   252|         );
   253|         $result = $this->query($select);
   254|         if ($result instanceof mysqli_result) {
   255|             $current = $result->fetch_row();
   256|         } else {
   257|             $current = [0];
   258|         }
   259|         return $current[0] + 1;
   260|     }
   261|     /**
   262|      * This function sends a query to the database.
   263|      *
   264|      *
   265|      * @return mysqli_result $result
   266|      */
   267|     public function query(string $query, int $offset = 0, int $rowcount = 0): mixed
   268|     {
   269|         $this->sqllog .= Utils::debug($query);
   270|         if (0 < $rowcount) {
   271|             $query .= sprintf(' LIMIT %d,%d', $offset, $rowcount);
   272|         }
   273|         $result = $this->conn->query($query);
   274|         if (false === $result) {
   275|             $this->sqllog .= $this->conn->errno . ': ' . $this->error();
   276|         }
   277|         return $result;
   278|     }
   279|     /**
   280|      * Returns the client version string.
   281|      */
   282|     public function clientVersion(): string
   283|     {
   284|         return mysqli_get_client_info();
   285|     }
   286|     /**
   287|      * Returns the server version string.
   288|      */
   289|     public function serverVersion(): string
   290|     {
   291|         return $this->conn->server_info;
   292|     }
   293|     /**
   294|      * Closes the connection to the database.
   295|      */
   296|     public function close(): void
   297|     {
   298|         if ($this->conn) {
   299|             $this->conn->close();
   300|         }
   301|     }
   302|     public function __destruct()
   303|     {
   304|         if ($this->conn) {
   305|             $this->conn->close();
   306|         }
   307|     }
   308|     public function now(): string
   309|     {
   310|         return 'NOW()';
   311|     }
   312| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Database/Pgsql.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-291 ---
     1| <?php
     2| /**
     3|  * The phpMyFAQ\Db_Pgsql class provides methods and functions for a PostgreSQL
     4|  * database.
     5|  *
     6|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     7|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     8|  * obtain one at https://mozilla.org/MPL/2.0/.
     9|  *
    10|  * @package   phpMyFAQ
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @author    Tom Rochester <tom.rochester@gmail.com>
    13|  * @copyright 2003-2023 phpMyFAQ Team
    14|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    15|  * @link      https://www.phpmyfaq.de
    16|  */
    17| namespace phpMyFAQ\Database;
    18| use Exception;
    19| use PgSql\Connection;
    20| use PgSql\Result;
    21| use phpMyFAQ\Database;
    22| use phpMyFAQ\Utils;
    23| /**
    24|  * Class Pgsql
    25|  *
    26|  * @package phpMyFAQ\Database
    27|  */
    28| class Pgsql implements DatabaseDriver
    29| {
    30|     /**
    31|      * The query log string.
    32|      *
    33|      * @var string
    34|      */
    35|     public $sqllog = '';
    36|     /**
    37|      * Tables.
    38|      *
    39|      * @var string[]
    40|      */
    41|     public array $tableNames = [];
    42|     /**
    43|      * The connection resource.
    44|      */
    45|     private Connection|null $conn = null;
    46|     /**
    47|      * Connects to the database.
    48|      *
    49|      * @param string $host Database hostname
    50|      * @param string $user Database username
    51|      * @param string $password Password
    52|      * @param string $database Database name
    53|      * @return null|bool true, if connected, otherwise false
    54|      */
    55|     public function connect(
    56|         string $host,
    57|         string $user,
    58|         string $password,
    59|         string $database = '',
    60|         int $port = null
    61|     ): ?bool {
    62|         $connectionString = sprintf(
    63|             'host=%s port=%d dbname=%s user=%s password=%s',
    64|             $host,
    65|             $port,
    66|             $database,
    67|             $user,
    68|             $password
    69|         );
    70|         $this->conn = pg_connect($connectionString);
    71|         if (empty($database) || !$this->conn) {
    72|             Database::errorPage(pg_last_error($this->conn));
    73|             die();
    74|         }
    75|         return true;
    76|     }
    77|     /**
    78|      * This function sends a query to the database.
    79|      *
    80|      * @return bool|Result $result
    81|      */
    82|     public function query(string $query, int $offset = 0, int $rowcount = 0): bool|Result
    83|     {
    84|         $this->sqllog .= Utils::debug($query);
    85|         if (0 < $rowcount) {
    86|             $query .= sprintf(' LIMIT %d OFFSET %d', $rowcount, $offset);
    87|         }
    88|         $result = pg_query($this->conn, $query);
    89|         if (!$result) {
    90|             $this->sqllog .= $this->error();
    91|         }
    92|         if (pg_result_status($result) === PGSQL_COMMAND_OK) {
    93|             return true;
    94|         }
    95|         return $result;
    96|     }
    97|     /**
    98|      * Returns the error string.
    99|      */
   100|     public function error(): string
   101|     {
   102|         return pg_last_error($this->conn);
   103|     }
   104|     /**
   105|      * Escapes a string for use in a query.
   106|      */
   107|     public function escape(string $string): string
   108|     {
   109|         return pg_escape_string($this->conn, $string);
   110|     }
   111|     /**
   112|      * Fetches a complete result as an object.
   113|      *
   114|      * @param mixed $result Resultset
   115|      * @throws Exception
   116|      */
   117|     public function fetchAll(mixed $result): ?array
   118|     {
   119|         $ret = [];
   120|         if (false === $result) {
   121|             throw new Exception('Error while fetching result: ' . $this->error());
   122|         }
   123|         while ($row = $this->fetchObject($result)) {
   124|             $ret[] = $row;
   125|         }
   126|         return $ret;
   127|     }
   128|     /**
   129|      * Fetch a result row as an object.
   130|      *
   131|      * @return false|object
   132|      */
   133|     public function fetchObject(mixed $result): mixed
   134|     {
   135|         return pg_fetch_object($result);
   136|     }
   137|     /**
   138|      * Fetch a result row.
   139|      */
   140|     public function fetchRow(mixed $result): array|false
   141|     {
   142|         return pg_fetch_row($result);
   143|     }
   144|     /**
   145|      * Number of rows in a result.
   146|      */
   147|     public function numRows(mixed $result): int
   148|     {
   149|         return pg_num_rows($result);
   150|     }
   151|     /**
   152|      * Logs the queries.
   153|      */
   154|     public function log(): string
   155|     {
   156|         return $this->sqllog;
   157|     }
   158|     /**
   159|      * This function returns the table status.
   160|      *
   161|      * @param string $prefix Table prefix
   162|      */
   163|     public function getTableStatus(string $prefix = ''): array
   164|     {
   165|         $select = 'SELECT relname FROM pg_stat_user_tables ORDER BY relname;';
   166|         $arr = [];
   167|         $result = $this->query($select);
   168|         while ($row = $this->fetchArray($result)) {
   169|             $count = $this->getOne('SELECT count(1) FROM ' . $row['relname'] . ';');
   170|             $arr[$row['relname']] = $count;
   171|         }
   172|         return $arr;
   173|     }
   174|     /**
   175|      * Fetch a result row as an object.
   176|      */
   177|     public function fetchArray(mixed $result): ?array
   178|     {
   179|         $result = pg_fetch_array($result, null, PGSQL_ASSOC);
   180|         if ($result) {
   181|             return $result;
   182|         }
   183|         return [];
   184|     }
   185|     /**
   186|      * Returns just one row.
   187|      */
   188|     private function getOne(string $query): string
   189|     {
   190|         $row = pg_fetch_row($this->query($query));
   191|         return $row[0];
   192|     }
   193|     /**
   194|      * Returns the next ID of a table.
   195|      *
   196|      * @param string $table the name of the table
   197|      * @param string $id    the name of the ID column
   198|      */
   199|     public function nextId(string $table, string $id): int
   200|     {
   201|         return (int) $this->getOne("SELECT nextval('" . $table . '_' . $id . "_seq') as current_id;");
   202|     }
   203|     /**
   204|      * This function returns the client version string.
   205|      */
   206|     public function clientVersion(): string
   207|     {
   208|         $pg_version = pg_version($this->conn);
   209|         if (isset($pg_version['client'])) {
   210|             return $pg_version['client'];
   211|         } else {
   212|             return 'n/a';
   213|         }
   214|     }
   215|     /**
   216|      * Returns the server version string.
   217|      */
   218|     public function serverVersion(): string
   219|     {
   220|         $pg_version = pg_version($this->conn);
   221|         if (isset($pg_version['server_version'])) {
   222|             return $pg_version['server_version'];
   223|         } else {
   224|             return 'n/a';
   225|         }
   226|     }
   227|     /**
   228|      * Returns an array with all table names.
   229|      *
   230|      * @todo Have to be refactored because of https://github.com/thorsten/phpMyFAQ/issues/965
   231|      *
   232|      * @param string $prefix Table prefix
   233|      *
   234|      * @return string[]
   235|      */
   236|     public function getTableNames(string $prefix = ''): array
   237|     {
   238|         return $this->tableNames = [
   239|             $prefix . 'faqadminlog',
   240|             $prefix . 'faqattachment',
   241|             $prefix . 'faqattachment_file',
   242|             $prefix . 'faqbackup',
   243|             $prefix . 'faqcaptcha',
   244|             $prefix . 'faqcategories',
   245|             $prefix . 'faqcategoryrelations',
   246|             $prefix . 'faqcategory_group',
   247|             $prefix . 'faqcategory_news',
   248|             $prefix . 'faqcategory_order',
   249|             $prefix . 'faqcategory_user',
   250|             $prefix . 'faqchanges',
   251|             $prefix . 'faqcomments',
   252|             $prefix . 'faqconfig',
   253|             $prefix . 'faqdata',
   254|             $prefix . 'faqdata_group',
   255|             $prefix . 'faqdata_revisions',
   256|             $prefix . 'faqdata_tags',
   257|             $prefix . 'faqdata_user',
   258|             $prefix . 'faqglossary',
   259|             $prefix . 'faqgroup',
   260|             $prefix . 'faqgroup_right',
   261|             $prefix . 'faqinstances',
   262|             $prefix . 'faqinstances_config',
   263|             $prefix . 'faqmeta',
   264|             $prefix . 'faqnews',
   265|             $prefix . 'faqquestions',
   266|             $prefix . 'faqright',
   267|             $prefix . 'faqsearches',
   268|             $prefix . 'faqsessions',
   269|             $prefix . 'faqstopwords',
   270|             $prefix . 'faqtags',
   271|             $prefix . 'faquser',
   272|             $prefix . 'faquserdata',
   273|             $prefix . 'faquserlogin',
   274|             $prefix . 'faquser_group',
   275|             $prefix . 'faquser_right',
   276|             $prefix . 'faqvisits',
   277|             $prefix . 'faqvoting',
   278|         ];
   279|     }
   280|     /**
   281|      * Closes the connection to the database.
   282|      */
   283|     public function close(): bool
   284|     {
   285|         return pg_close($this->conn);
   286|     }
   287|     public function now(): string
   288|     {
   289|         return 'CURRENT_TIMESTAMP';
   290|     }
   291| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Database/Sqlite3.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-280 ---
     1| <?php
     2| /**
     3|  * The Sqlite3 class provides methods and functions for a SQLite v3 database.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2012-2023 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2012-03-02
    15|  */
    16| namespace phpMyFAQ\Database;
    17| use phpMyFAQ\Core\Exception;
    18| use phpMyFAQ\Utils;
    19| /**
    20|  * Class Sqlite3
    21|  *
    22|  * @package phpMyFAQ\Database
    23|  */
    24| class Sqlite3 implements DatabaseDriver
    25| {
    26|     /**
    27|      * @var string[] Tables.
    28|      */
    29|     public array $tableNames = [];
    30|     /**
    31|      * The connection object.
    32|      *
    33|      * @var \SQLite3|bool
    34|      */
    35|     private \Sqlite3|bool $conn = false;
    36|     /**
    37|      * The query log string.
    38|      *
    39|      *
    40|      * @see query()
    41|      */
    42|     private string $sqllog = '';
    43|     /** @var string */
    44|     private const ERROR_MESSAGE =
    45|         'Do not call numRows() after you\'ve fetched one or more result records, because ' .
    46|         'phpMyFAQ\Database\Sqlite3::numRows() has to reset the results at its end.';
    47|     /**
    48|      * Connects to the database.
    49|      *
    50|      * @param int|null $port
    51|      */
    52|     public function connect(
    53|         string $host,
    54|         string $user,
    55|         string $password,
    56|         string $database = '',
    57|         int $port = null
    58|     ): ?bool {
    59|         $this->conn = new \Sqlite3($host);
    60|         return true;
    61|     }
    62|     /**
    63|      * Escapes a string for use in a query.
    64|      */
    65|     public function escape(string $string): string
    66|     {
    67|         return \SQLite3::escapeString($string);
    68|     }
    69|     /**
    70|      * Fetch a result row as an object.
    71|      *
    72|      * @return object|null or NULL if there are no more results
    73|      */
    74|     public function fetchObject(mixed $result): ?object
    75|     {
    76|         $return = $result->fetchArray(SQLITE3_ASSOC);
    77|         return $return
    78|             ? (object)$return
    79|             : null;
    80|     }
    81|     /**
    82|      * Fetch a result row as an array.
    83|      */
    84|     public function fetchArray(mixed $result): ?array
    85|     {
    86|         $fetchedData = $result->fetchArray();
    87|         return is_array($fetchedData) ? $fetchedData : [];
    88|     }
    89|     /**
    90|      * Fetch a result row.
    91|      */
    92|     public function fetchRow(mixed $result): mixed
    93|     {
    94|         return $result->fetchSingle();
    95|     }
    96|     /**
    97|      * Fetches a complete result as an object.
    98|      *
    99|      * @param mixed $result Resultset
   100|      * @return array|null of stdClass
   101|      * @throws Exception
   102|      */
   103|     public function fetchAll(mixed $result): ?array
   104|     {
   105|         $ret = [];
   106|         if (false === $result) {
   107|             throw new Exception('Error while fetching result: ' . $this->error());
   108|         }
   109|         while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
   110|             $ret[] = (object)$row;
   111|         }
   112|         return $ret;
   113|     }
   114|     /**
   115|      * Returns the error string.
   116|      */
   117|     public function error(): string
   118|     {
   119|         if (0 === $this->conn->lastErrorCode()) {
   120|             return '';
   121|         }
   122|         return $this->conn->lastErrorMsg();
   123|     }
   124|     /**
   125|      * Logs the queries.
   126|      */
   127|     public function log(): string
   128|     {
   129|         return $this->sqllog;
   130|     }
   131|     /**
   132|      * This function returns the table status.
   133|      *
   134|      * @param string $prefix Table prefix
   135|      */
   136|     public function getTableStatus(string $prefix = ''): array
   137|     {
   138|         $arr = [];
   139|         $result = $this->query("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
   140|         while ($row = $this->fetchAssoc($result)) {
   141|             $num_result = $this->query('SELECT * FROM ' . $row['name']);
   142|             $arr[$row['name']] = $this->numRows($num_result);
   143|         }
   144|         return $arr;
   145|     }
   146|     /**
   147|      * This function sends a query to the database.
   148|      *
   149|      * @return \SQLite3Result|bool $result
   150|      */
   151|     public function query(string $query, int $offset = 0, int $rowcount = 0): \SQLite3Result|bool
   152|     {
   153|         $this->sqllog .= Utils::debug($query);
   154|         if (0 < $rowcount) {
   155|             $query .= sprintf(' LIMIT %d,%d', $offset, $rowcount);
   156|         }
   157|         $result = $this->conn->query($query);
   158|         if (!$result) {
   159|             $this->sqllog .= $this->error();
   160|         }
   161|         return $result;
   162|     }
   163|     /**
   164|      * Fetch a result row as an associate array.
   165|      */
   166|     public function fetchAssoc(mixed $result): array
   167|     {
   168|         $fetchedData = $result->fetchArray(SQLITE3_ASSOC);
   169|         return is_array($fetchedData) ? $fetchedData : [];
   170|     }
   171|     /**
   172|      * Number of rows in a result.
   173|      */
   174|     public function numRows(mixed $result): int
   175|     {
   176|         !isset($result->fetchedByPMF) || !$result->fetchedByPMF || die(self::ERROR_MESSAGE);
   177|         $numberOfRows = 0;
   178|         while ($result->fetchArray(SQLITE3_NUM)) {
   179|             ++$numberOfRows;
   180|         }
   181|         $result->reset();
   182|         return $numberOfRows;
   183|     }
   184|     /**
   185|      * Returns an array with all table names.
   186|      *
   187|      * @todo Have to be refactored because of https://github.com/thorsten/phpMyFAQ/issues/965
   188|      *
   189|      * @param string $prefix Table prefix
   190|      *
   191|      * @return string[]
   192|      */
   193|     public function getTableNames(string $prefix = ''): array
   194|     {
   195|         return $this->tableNames = [
   196|             $prefix . 'faqadminlog',
   197|             $prefix . 'faqattachment',
   198|             $prefix . 'faqattachment_file',
   199|             $prefix . 'faqbackup',
   200|             $prefix . 'faqcaptcha',
   201|             $prefix . 'faqcategories',
   202|             $prefix . 'faqcategoryrelations',
   203|             $prefix . 'faqcategory_group',
   204|             $prefix . 'faqcategory_news',
   205|             $prefix . 'faqcategory_order',
   206|             $prefix . 'faqcategory_user',
   207|             $prefix . 'faqchanges',
   208|             $prefix . 'faqcomments',
   209|             $prefix . 'faqconfig',
   210|             $prefix . 'faqdata',
   211|             $prefix . 'faqdata_group',
   212|             $prefix . 'faqdata_revisions',
   213|             $prefix . 'faqdata_tags',
   214|             $prefix . 'faqdata_user',
   215|             $prefix . 'faqglossary',
   216|             $prefix . 'faqgroup',
   217|             $prefix . 'faqgroup_right',
   218|             $prefix . 'faqinstances',
   219|             $prefix . 'faqinstances_config',
   220|             $prefix . 'faqmeta',
   221|             $prefix . 'faqnews',
   222|             $prefix . 'faqquestions',
   223|             $prefix . 'faqright',
   224|             $prefix . 'faqsearches',
   225|             $prefix . 'faqsessions',
   226|             $prefix . 'faqstopwords',
   227|             $prefix . 'faqtags',
   228|             $prefix . 'faquser',
   229|             $prefix . 'faquserdata',
   230|             $prefix . 'faquserlogin',
   231|             $prefix . 'faquser_group',
   232|             $prefix . 'faquser_right',
   233|             $prefix . 'faqvisits',
   234|             $prefix . 'faqvoting',
   235|         ];
   236|     }
   237|     /**
   238|      * Returns the next ID of a table.
   239|      *
   240|      * @param string $table the name of the table
   241|      * @param string $id the name of the ID column
   242|      */
   243|     public function nextId(string $table, string $id): int
   244|     {
   245|         $result = (int)$this->conn->querySingle(
   246|             sprintf(
   247|                 'SELECT max(%s) AS current_id FROM %s',
   248|                 $id,
   249|                 $table
   250|             )
   251|         );
   252|         return ($result + 1);
   253|     }
   254|     /**
   255|      * Returns the library version string.
   256|      */
   257|     public function serverVersion(): string
   258|     {
   259|         return $this->clientVersion();
   260|     }
   261|     /**
   262|      * Returns the library version string.
   263|      */
   264|     public function clientVersion(): string
   265|     {
   266|         $version = \Sqlite3::version();
   267|         return $version['versionString'];
   268|     }
   269|     /**
   270|      * Closes the connection to the database.
   271|      */
   272|     public function close(): bool
   273|     {
   274|         return $this->conn->close();
   275|     }
   276|     public function now(): string
   277|     {
   278|         return "DATETIME('now', 'localtime')";
   279|     }
   280| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Database/Sqlsrv.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-321 ---
     1| <?php
     2| /**
     3|  * The phpMyFAQ\Db_Sqlsrv class provides methods and functions for SQL Server Driver
     4|  * for PHP from Microsoft for Microsoft SQL Server 2012 or later.
     5|  *
     6|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     7|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     8|  * obtain one at https://mozilla.org/MPL/2.0/.
     9|  *
    10|  * @package   phpMyFAQ
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @copyright 2009-2023 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2009-02-18
    16|  */
    17| namespace phpMyFAQ\Database;
    18| use Exception;
    19| use phpMyFAQ\Database;
    20| use phpMyFAQ\Utils;
    21| /**
    22|  * Class Sqlsrv
    23|  *
    24|  * @package phpMyFAQ\Database
    25|  */
    26| class Sqlsrv implements DatabaseDriver
    27| {
    28|     /** @var string[] Tables */
    29|     public array $tableNames = [];
    30|     /** @var resource|bool */
    31|     private $conn = false;
    32|     /** The query log string. */
    33|     private string $sqllog = '';
    34|     /**
    35|      * Connection options array.
    36|      */
    37|     private array $connectionOptions = [];
    38|     /**
    39|      * Connects to the database.
    40|      * This function connects to a MySQL database
    41|      *
    42|      * @param string   $host A string specifying the name of the server to which a connection is being established
    43|      * @param string   $user Specifies the User ID to be used when connecting with SQL Server Authentication
    44|      * @param string   $password Specifies the password associated with the User ID to be used when connecting with
    45|      *                         SQL Server Authentication
    46|      * @param string   $database Specifies the name of the database in use for the connection being established
    47|      * @param int|null $port
    48|      * @return bool|null true, if connected, otherwise false
    49|      */
    50|     public function connect(
    51|         string $host,
    52|         string $user,
    53|         string $password,
    54|         string $database = '',
    55|         int $port = null
    56|     ): ?bool {
    57|         $this->setConnectionOptions($user, $password, $database);
    58|         $this->conn = sqlsrv_connect($host . ', ' . $port, $this->connectionOptions);
    59|         if (!$this->conn) {
    60|             Database::errorPage($this->formatErrors(sqlsrv_errors()));
    61|             die();
    62|         }
    63|         return true;
    64|     }
    65|     /**
    66|      * Escapes a string for use in a query.
    67|      *
    68|      * @param string $string String
    69|      */
    70|     public function escape(string $string): string
    71|     {
    72|         return str_replace("'", "''", $string);
    73|     }
    74|     /**
    75|      * Fetch a result row as an assoc array.
    76|      *
    77|      * @param mixed $result Resultset
    78|      */
    79|     public function fetchArray(mixed $result): ?array
    80|     {
    81|         $fetchedData = sqlsrv_fetch_array($result, SQLSRV_FETCH_ASSOC);
    82|         return is_array($fetchedData) ? $fetchedData : [];
    83|     }
    84|     /**
    85|      * Fetch a result row.
    86|      */
    87|     public function fetchRow(mixed $result): mixed
    88|     {
    89|         return $this->fetchArray($result)[0];
    90|     }
    91|     /**
    92|      * Fetches a complete result as an object.
    93|      *
    94|      * @param mixed $result Resultset
    95|      * @throws Exception
    96|      */
    97|     public function fetchAll(mixed $result): ?array
    98|     {
    99|         $ret = [];
   100|         if (false === $result) {
   101|             throw new Exception('Error while fetching result: ' . $this->error());
   102|         }
   103|         while ($row = $this->fetchObject($result)) {
   104|             $ret[] = $row;
   105|         }
   106|         return $ret;
   107|     }
   108|     /**
   109|      * Returns the error string.
   110|      */
   111|     public function error(): string
   112|     {
   113|         $errors = sqlsrv_errors();
   114|         if (null !== $errors) {
   115|             return $errors[0]['SQLSTATE'] . ': ' . $errors[0]['message'];
   116|         }
   117|         return '';
   118|     }
   119|     /**
   120|      * Fetch a result row as an object.
   121|      *
   122|      * @param mixed $result Results
   123|      */
   124|     public function fetchObject(mixed $result): mixed
   125|     {
   126|         return sqlsrv_fetch_object($result);
   127|     }
   128|     /**
   129|      * Number of rows in a result.
   130|      *
   131|      * @param mixed $result Resultset
   132|      */
   133|     public function numRows(mixed $result): int
   134|     {
   135|         return sqlsrv_num_rows($result);
   136|     }
   137|     /**
   138|      * Logs the queries.
   139|      */
   140|     public function log(): string
   141|     {
   142|         return $this->sqllog;
   143|     }
   144|     /**
   145|      * This function returns the table status.
   146|      *
   147|      * @param string $prefix Table prefix
   148|      */
   149|     public function getTableStatus(string $prefix = ''): array
   150|     {
   151|         $tables = [];
   152|         $query = "
   153|             SELECT
   154|                 obj.name AS table_name,
   155|                 idx.rows AS table_rows
   156|             FROM
   157|                 sysobjects obj, sysindexes idx
   158|             WHERE
   159|                     idx.id = OBJECT_ID(obj.name)
   160|                 AND idx.indid < 2
   161|                 AND obj.xtype = 'U'
   162|             ORDER BY obj.name";
   163|         $result = $this->query($query);
   164|         while ($row = $this->fetchObject($result)) {
   165|             $tables[$row->table_name] = $row->table_rows;
   166|         }
   167|         return $tables;
   168|     }
   169|     /**
   170|      * This function sends a query to the database.
   171|      *
   172|      *
   173|      * @return mixed $result
   174|      */
   175|     public function query(string $query, int $offset = 0, int $rowcount = 0): mixed
   176|     {
   177|         $this->sqllog .= Utils::debug($query);
   178|         $options = ['Scrollable' => SQLSRV_CURSOR_KEYSET];
   179|         if (0 < $rowcount) {
   180|             $query .= sprintf(' OFFSET %d ROWS FETCH NEXT %d ROWS ONLY', $offset, $rowcount);
   181|         }
   182|         $result = sqlsrv_query($this->conn, $query, [], $options);
   183|         if (!$result) {
   184|             $this->sqllog .= $this->error();
   185|         }
   186|         return $result;
   187|     }
   188|     /**
   189|      * Returns the next ID of a table.
   190|      *
   191|      * @param string $table the name of the table
   192|      * @param string $id    the name of the ID column
   193|      */
   194|     public function nextId(string $table, string $id): int
   195|     {
   196|         $select = sprintf(
   197|             '
   198|            SELECT 
   199|                max(%s) as current_id
   200|            FROM 
   201|                %s',
   202|             $id,
   203|             $table
   204|         );
   205|         $result = $this->query($select);
   206|         sqlsrv_fetch($result);
   207|         return (sqlsrv_get_field($result, 0) + 1);
   208|     }
   209|     /**
   210|      * Returns the library version string.
   211|      */
   212|     public function clientVersion(): string
   213|     {
   214|         $client_info = sqlsrv_client_info($this->conn);
   215|         return $client_info['DriverODBCVer'] . ' ' . $client_info['DriverVer'];
   216|     }
   217|     /**
   218|      * Returns the library version string.
   219|      */
   220|     public function serverVersion(): string
   221|     {
   222|         $server_info = sqlsrv_server_info($this->conn);
   223|         return $server_info['SQLServerVersion'];
   224|     }
   225|     /**
   226|      * Returns an array with all table names.
   227|      *
   228|      * @todo Have to be refactored because of https://github.com/thorsten/phpMyFAQ/issues/965
   229|      *
   230|      * @param string $prefix Table prefix
   231|      */
   232|     public function getTableNames(string $prefix = ''): array
   233|     {
   234|         return $this->tableNames = [
   235|             $prefix . 'faqadminlog',
   236|             $prefix . 'faqattachment',
   237|             $prefix . 'faqattachment_file',
   238|             $prefix . 'faqbackup',
   239|             $prefix . 'faqcaptcha',
   240|             $prefix . 'faqcategories',
   241|             $prefix . 'faqcategoryrelations',
   242|             $prefix . 'faqcategory_group',
   243|             $prefix . 'faqcategory_news',
   244|             $prefix . 'faqcategory_order',
   245|             $prefix . 'faqcategory_user',
   246|             $prefix . 'faqchanges',
   247|             $prefix . 'faqcomments',
   248|             $prefix . 'faqconfig',
   249|             $prefix . 'faqdata',
   250|             $prefix . 'faqdata_group',
   251|             $prefix . 'faqdata_revisions',
   252|             $prefix . 'faqdata_tags',
   253|             $prefix . 'faqdata_user',
   254|             $prefix . 'faqglossary',
   255|             $prefix . 'faqgroup',
   256|             $prefix . 'faqgroup_right',
   257|             $prefix . 'faqinstances',
   258|             $prefix . 'faqinstances_config',
   259|             $prefix . 'faqmeta',
   260|             $prefix . 'faqnews',
   261|             $prefix . 'faqquestions',
   262|             $prefix . 'faqright',
   263|             $prefix . 'faqsearches',
   264|             $prefix . 'faqsessions',
   265|             $prefix . 'faqstopwords',
   266|             $prefix . 'faqtags',
   267|             $prefix . 'faquser',
   268|             $prefix . 'faquserdata',
   269|             $prefix . 'faquserlogin',
   270|             $prefix . 'faquser_group',
   271|             $prefix . 'faquser_right',
   272|             $prefix . 'faqvisits',
   273|             $prefix . 'faqvoting',
   274|         ];
   275|     }
   276|     /**
   277|      * Closes the connection to the database.
   278|      */
   279|     public function close(): void
   280|     {
   281|         sqlsrv_close($this->conn);
   282|     }
   283|     public function now(): string
   284|     {
   285|         return 'GETDATE()';
   286|     }
   287|     /**
   288|      * Sets the connection options.
   289|      *
   290|      * @param string $user Specifies the User ID to be used when connecting with SQL Server Authentication
   291|      * @param string $password Specifies the password associated with the User ID to be used when connecting with
   292|      *                         SQL Server Authentication
   293|      * @param string $database Specifies the name of the database in use for the connection being established
   294|      */
   295|     private function setConnectionOptions(string $user, string $password, string $database): void
   296|     {
   297|         $this->connectionOptions = [
   298|             'UID' => $user,
   299|             'PWD' => $password,
   300|             'Database' => $database,
   301|             'CharacterSet' => 'UTF-8',
   302|             'TrustServerCertificate' => true, // even trust self-signed certificates
   303|         ];
   304|     }
   305|     /**
   306|      * Formats the error output
   307|      */
   308|     private function formatErrors(array $errors): string
   309|     {
   310|         $error = '<h3>SQL Error:</h3>' . 'MS SQL Error information: <br/>';
   311|         foreach ($errors as $error) {
   312|             $error .= sprintf(
   313|                 'SQLSTATE: %s<br/>Code: %s<br/>Message: %s<br/>',
   314|                 $error['SQLSTATE'],
   315|                 $error['code'],
   316|                 $error['message']
   317|             );
   318|         }
   319|         return $error;
   320|     }
   321| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Faq.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2326 ---
     1| <?php
     2| /**
     3|  * The main FAQ class. Yes, it's very huge.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @author    Matteo Scaramuccia <matteo@scaramuccia.com>
    12|  * @author    Georgi Korchev <korchev@yahoo.com>
    13|  * @author    Adrianna Musiol <musiol@imageaccess.de>
    14|  * @author    Peter Caesar <p.caesar@osmaco.de>
    15|  * @copyright 2005-2023 phpMyFAQ Team
    16|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    17|  * @link      https://www.phpmyfaq.de
    18|  * @since     2005-12-20
    19|  */
    20| namespace phpMyFAQ;
    21| use DateTimeInterface;
    22| use Exception;
    23| use phpMyFAQ\Attachment\AttachmentFactory;
    24| use phpMyFAQ\Entity\FaqEntity;
    25| use phpMyFAQ\Helper\FaqHelper;
    26| use phpMyFAQ\Instance\Elasticsearch;
    27| use phpMyFAQ\Language\Plurals;
    28| /*
    29|  * SQL constants definitions
    30|  */
    31| define('FAQ_SQL_ACTIVE_YES', 'yes');
    32| define('FAQ_SQL_ACTIVE_NO', 'no');
    33| /*
    34|  * Query type definitions
    35|  */
    36| define('FAQ_QUERY_TYPE_DEFAULT', 'faq_default');
    37| define('FAQ_QUERY_TYPE_APPROVAL', 'faq_approval');
    38| define('FAQ_QUERY_TYPE_EXPORT_PDF', 'faq_export_pdf');
    39| define('FAQ_QUERY_TYPE_EXPORT_XHTML', 'faq_export_xhtml');
    40| define('FAQ_QUERY_TYPE_EXPORT_XML', 'faq_export_xml');
    41| /*
    42|  * Sorting type definitions
    43|  */
    44| define('FAQ_SORTING_TYPE_NONE', 0);
    45| define('FAQ_SORTING_TYPE_CATID_FAQID', 1);
    46| define('FAQ_SORTING_TYPE_FAQTITLE_FAQID', 2);
    47| define('FAQ_SORTING_TYPE_DATE_FAQID', 3);
    48| define('FAQ_SORTING_TYPE_FAQID', 4);
    49| /**
    50|  * Class Faq
    51|  *
    52|  * @package phpMyFAQ
    53|  */
    54| class Faq
    55| {
    56|     /**
    57|      * The current FAQ record.
    58|      */
    59|     public array $faqRecord = [];
    60|     /**
    61|      * All current FAQ records in an array.
    62|      */
    63|     public array $faqRecords = [];
    64|     /**
    65|      * Plural form support.
    66|      */
    67|     private readonly Plurals $plurals;
    68|     /**
    69|      * Users.
    70|      */
    71|     private int $user = -1;
    72|     /**
    73|      * Groups.
    74|      *
    75|      * @var int[]
    76|      */
    77|     private array $groups = [-1];
    78|     /**
    79|      * Flag for Group support.
    80|      */
    81|     private bool $groupSupport = false;
    82|     /**
    83|      * Constructor.
    84|      */
    85|     public function __construct(private readonly Configuration $config)
    86|     {
    87|         $this->plurals = new Plurals();
    88|         if ($this->config->get('security.permLevel') !== 'basic') {
    89|             $this->groupSupport = true;
    90|         }
    91|     }
    92|     public function setUser(int $userId = -1): Faq
    93|     {
    94|         $this->user = $userId;
    95|         return $this;
    96|     }
    97|     /**
    98|      * @param int[] $groups
    99|      */
   100|     public function setGroups(array $groups): Faq
   101|     {
   102|         $this->groups = $groups;
   103|         return $this;
   104|     }
   105|     /**
   106|      * This function returns all not expired records from one category.
   107|      *
   108|      * @param int    $categoryId Entity ID
   109|      * @param string $orderBy    Order by
   110|      * @param string $sortBy     Sort by
   111|      *
   112|      * @throws Exception
   113|      */
   114|     public function getAllFaqsByCategoryId(
   115|         int $categoryId,
   116|         string $orderBy = 'id',
   117|         string $sortBy = 'ASC',
   118|         bool $preview = true
   119|     ): array {
   120|         global $sids;
   121|         $faqData = [];
   122|         if ($orderBy == 'visits') {
   123|             $currentTable = 'fv';
   124|         } else {
   125|             $currentTable = 'fd';
   126|         }
   127|         $now = date('YmdHis');
   128|         $query = sprintf(
   129|             "
   130|             SELECT
   131|                 fd.id AS id,
   132|                 fd.lang AS lang,
   133|                 fd.thema AS thema,
   134|                 fd.content AS record_content,
   135|                 fd.updated AS updated,
   136|                 fcr.category_id AS category_id,
   137|                 fv.visits AS visits,
   138|                 fd.created AS created
   139|             FROM
   140|                 %sfaqdata AS fd
   141|             LEFT JOIN
   142|                 %sfaqcategoryrelations AS fcr
   143|             ON
   144|                 fd.id = fcr.record_id
   145|             AND
   146|                 fd.lang = fcr.record_lang
   147|             LEFT JOIN
   148|                 %sfaqvisits AS fv
   149|             ON
   150|                 fd.id = fv.id
   151|             AND
   152|                 fv.lang = fd.lang
   153|             LEFT JOIN
   154|                 %sfaqdata_group AS fdg
   155|             ON
   156|                 fd.id = fdg.record_id
   157|             LEFT JOIN
   158|                 %sfaqdata_user AS fdu
   159|             ON
   160|                 fd.id = fdu.record_id
   161|             WHERE
   162|                 fd.date_start <= '%s'
   163|             AND
   164|                 fd.date_end   >= '%s'
   165|             AND
   166|                 fd.active = 'yes'
   167|             AND
   168|                 fcr.category_id = %d
   169|             AND
   170|                 fd.lang = '%s'
   171|                 %s
   172|             ORDER BY
   173|                 %s.%s %s",
   174|             Database::getTablePrefix(),
   175|             Database::getTablePrefix(),
   176|             Database::getTablePrefix(),
   177|             Database::getTablePrefix(),
   178|             Database::getTablePrefix(),
   179|             $now,
   180|             $now,
   181|             $categoryId,
   182|             $this->config->getLanguage()->getLanguage(),
   183|             $this->queryPermission($this->groupSupport),
   184|             $currentTable,
   185|             $this->config->getDb()->escape($orderBy),
   186|             $this->config->getDb()->escape($sortBy)
   187|         );
   188|         $result = $this->config->getDb()->query($query);
   189|         $num = $this->config->getDb()->numRows($result);
   190|         if ($num > 0) {
   191|             $faqHelper = new FaqHelper($this->config);
   192|             while (($row = $this->config->getDb()->fetchObject($result))) {
   193|                 if (empty($row->visits)) {
   194|                     $visits = 0;
   195|                 } else {
   196|                     $visits = $row->visits;
   197|                 }
   198|                 $url = sprintf(
   199|                     '%sindex.php?%saction=faq&cat=%d&id=%d&artlang=%s',
   200|                     $this->config->getDefaultUrl(),
   201|                     $sids,
   202|                     $row->category_id,
   203|                     $row->id,
   204|                     $row->lang
   205|                 );
   206|                 $oLink = new Link($url, $this->config);
   207|                 $oLink->itemTitle = $oLink->text = $oLink->tooltip = $row->thema;
   208|                 if ($preview) {
   209|                     $faqData[] = [
   210|                         'record_id' => $row->id,
   211|                         'record_lang' => $row->lang,
   212|                         'category_id' => $row->category_id,
   213|                         'record_title' => $row->thema,
   214|                         'record_preview' => $faqHelper->renderAnswerPreview($row->record_content, 25),
   215|                         'record_link' => $oLink->toString(),
   216|                         'record_updated' => $row->updated,
   217|                         'visits' => $visits,
   218|                         'record_created' => $row->created,
   219|                     ];
   220|                 } else {
   221|                     $faqData[] = [
   222|                         'faq_id' => $row->id,
   223|                         'faq_lang' => $row->lang,
   224|                         'category_id' => $row->category_id,
   225|                         'question' => $row->thema,
   226|                         'answer' => $row->record_content,
   227|                         'link' => $oLink->toString(),
   228|                         'updated' => $row->updated,
   229|                         'visits' => $visits,
   230|                         'created' => $row->created,
   231|                     ];
   232|                 }
   233|             }
   234|         } else {
   235|             return $faqData;
   236|         }
   237|         return $faqData;
   238|     }
   239|     /**
   240|      * Returns a part of a query to check permissions.
   241|      *
   242|      *
   243|      */
   244|     protected function queryPermission(bool $hasGroupSupport = false): string
   245|     {
   246|         if ($hasGroupSupport) {
   247|             if (-1 === $this->user) {
   248|                 return sprintf(
   249|                     'AND fdg.group_id IN (%s)',
   250|                     implode(', ', $this->groups)
   251|                 );
   252|             } else {
   253|                 return sprintf(
   254|                     'AND ( fdu.user_id = %d OR fdg.group_id IN (%s) )',
   255|                     $this->user,
   256|                     implode(', ', $this->groups)
   257|                 );
   258|             }
   259|         }
   260|         if (-1 !== $this->user) {
   261|             return sprintf(
   262|                 'AND ( fdu.user_id = %d OR fdu.user_id = -1 )',
   263|                 $this->user
   264|             );
   265|         } else {
   266|             return 'AND fdu.user_id = -1';
   267|         }
   268|     }
   269|     /**
   270|      * This function returns all not expired records from one category.
   271|      *
   272|      * @param int    $categoryId Entity ID
   273|      * @param string $orderBy    Order by
   274|      * @param string $sortBy     Sort by
   275|      */
   276|     public function renderRecordsByCategoryId(int $categoryId, string $orderBy = 'id', string $sortBy = 'ASC'): string
   277|     {
   278|         global $sids;
   279|         $numPerPage = $this->config->get('records.numberOfRecordsPerPage');
   280|         $page = Filter::filterInput(INPUT_GET, 'seite', FILTER_VALIDATE_INT, 1);
   281|         $output = '';
   282|         $title = '';
   283|         if ($orderBy == 'visits') {
   284|             $currentTable = 'fv';
   285|         } else {
   286|             $currentTable = 'fd';
   287|         }
   288|         if (true === $this->config->get('records.randomSort')) {
   289|             $order = '';
   290|         } else {
   291|             $order = sprintf(
   292|                 'ORDER BY fd.sticky DESC, %s.%s %s',
   293|                 $currentTable,
   294|                 $this->config->getDb()->escape($orderBy),
   295|                 $this->config->getDb()->escape($sortBy)
   296|             );
   297|         }
   298|         $now = date('YmdHis');
   299|         $query = sprintf(
   300|             "
   301|             SELECT
   302|                 fd.id AS id,
   303|                 fd.lang AS lang,
   304|                 fd.sticky AS sticky,
   305|                 fd.thema AS question,
   306|                 fd.content as answer,
   307|                 fcr.category_id AS category_id,
   308|                 fv.visits AS visits
   309|             FROM
   310|                 %sfaqdata AS fd
   311|             LEFT JOIN
   312|                 %sfaqcategoryrelations AS fcr
   313|             ON
   314|                 fd.id = fcr.record_id
   315|             AND
   316|                 fd.lang = fcr.record_lang
   317|             LEFT JOIN
   318|                 %sfaqvisits AS fv
   319|             ON
   320|                 fd.id = fv.id
   321|             AND
   322|                 fv.lang = fd.lang
   323|             LEFT JOIN
   324|                 %sfaqdata_group AS fdg
   325|             ON
   326|                 fd.id = fdg.record_id
   327|             LEFT JOIN
   328|                 %sfaqdata_user AS fdu
   329|             ON
   330|                 fd.id = fdu.record_id
   331|             WHERE
   332|                 fd.date_start <= '%s'
   333|             AND
   334|                 fd.date_end   >= '%s'
   335|             AND
   336|                 fd.active = 'yes'
   337|             AND
   338|                 fcr.category_id = %d
   339|             AND
   340|                 fd.lang = '%s'
   341|             %s
   342|             %s",
   343|             Database::getTablePrefix(),
   344|             Database::getTablePrefix(),
   345|             Database::getTablePrefix(),
   346|             Database::getTablePrefix(),
   347|             Database::getTablePrefix(),
   348|             $now,
   349|             $now,
   350|             $categoryId,
   351|             $this->config->getLanguage()->getLanguage(),
   352|             $this->queryPermission($this->groupSupport),
   353|             $order
   354|         );
   355|         $result = $this->config->getDb()->query($query);
   356|         $num = $this->config->getDb()->numRows($result);
   357|         $pages = (int)ceil($num / $numPerPage);
   358|         if ($page == 1) {
   359|             $first = 0;
   360|         } else {
   361|             $first = $page * $numPerPage - $numPerPage;
   362|         }
   363|         if ($num > 0) {
   364|             if ($pages > 1) {
   365|                 $output .= sprintf(
   366|                     '<p>%s <strong>%d</strong> %s <strong>%d</strong> %s</p>',
   367|                     Translation::get('msgPage'),
   368|                     $page,
   369|                     Translation::get('msgVoteFrom'),
   370|                     $pages,
   371|                     Translation::get('msgPages')
   372|                 );
   373|             }
   374|             $output .= '<ul class="list-group list-group-flush mb-4">';
   375|             $counter = 0;
   376|             $displayedCounter = 0;
   377|             $renderedItems = [];
   378|             while (($row = $this->config->getDb()->fetchObject($result)) && $displayedCounter < $numPerPage) {
   379|                 ++$counter;
   380|                 if ($counter <= $first) {
   381|                     continue;
   382|                 }
   383|                 ++$displayedCounter;
   384|                 if (empty($row->visits)) {
   385|                     $visits = 0;
   386|                 } else {
   387|                     $visits = $row->visits;
   388|                 }
   389|                 $title = Strings::htmlentities($row->question);
   390|                 $url = sprintf(
   391|                     '%sindex.php?%saction=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
   392|                     $this->config->getDefaultUrl(),
   393|                     $sids,
   394|                     $row->category_id,
   395|                     $row->id,
   396|                     $row->lang
   397|                 );
   398|                 $oLink = new Link($url, $this->config);
   399|                 $oLink->itemTitle = $oLink->text = $oLink->tooltip = $title;
   400|                 $oLink->class = 'text-decoration-none';
   401|                 if (true === $this->config->get('records.randomSort')) {
   402|                     $row->sticky = 0;
   403|                 }
   404|                 $renderedItems[$row->id] = sprintf(
   405|                     '<li class="list-group-item d-flex justify-content-between align-items-start %s">',
   406|                     ($row->sticky) ? 'list-group-item-primary rounded mb-3' : ''
   407|                 );
   408|                 $renderedItems[$row->id] .= sprintf(
   409|                     '<div class="ms-2 me-auto"><div class="fw-bold">%s</div><div class="small">%s</div></div>',
   410|                     $oLink->toHtmlAnchor(),
   411|                     Utils::chopString(strip_tags((string) $row->answer), 20)
   412|                 );
   413|                 $renderedItems[$row->id] .= sprintf(
   414|                     '<span id="viewsPerRecord" class="badge bg-primary rounded-pill">%s</span></li>',
   415|                     $this->plurals->getMsg('plmsgViews', $visits)
   416|                 );
   417|             }
   418|             if (true === $this->config->get('records.randomSort')) {
   419|                 shuffle($renderedItems);
   420|             }
   421|             $output .= implode("\n", $renderedItems);
   422|             $output .= '</ul>';
   423|         } else {
   424|             return false;
   425|         }
   426|         if ($pages > 1) {
   427|             if ($this->config->get('main.enableRewriteRules')) {
   428|                 $link = new Link($this->config->getDefaultUrl(), $this->config);
   429|                 $useRewrite = true;
   430|                 $rewriteUrl = sprintf(
   431|                     '%scategory/%d/%%d/%s.html',
   432|                     $this->config->getDefaultUrl(),
   433|                     $categoryId,
   434|                     $link->getSEOItemTitle($title)
   435|                 );
   436|             } else {
   437|                 $useRewrite = false;
   438|                 $rewriteUrl = '';
   439|             }
   440|             $baseUrl = sprintf(
   441|                 '%sindex.php?%saction=show&amp;cat=%d&amp;seite=%d',
   442|                 $this->config->getDefaultUrl(),
   443|                 (empty($sids) ? '' : $sids),
   444|                 $categoryId,
   445|                 $page
   446|             );
   447|             $options = [
   448|                 'baseUrl' => $baseUrl,
   449|                 'total' => $num,
   450|                 'perPage' => $this->config->get('records.numberOfRecordsPerPage'),
   451|                 'useRewrite' => $useRewrite,
   452|                 'rewriteUrl' => $rewriteUrl,
   453|                 'pageParamName' => 'seite'
   454|             ];
   455|             $pagination = new Pagination($options);
   456|             $output .= $pagination->render();
   457|         }
   458|         return $output;
   459|     }
   460|     /**
   461|      * This function returns all not expired records from the given record ids.
   462|      *
   463|      * @param array  $recordIds Array of record ids
   464|      * @param string $orderBy   Order by
   465|      * @param string $sortBy    Sort by
   466|      */
   467|     public function renderRecordsByFaqIds(array $recordIds, string $orderBy = 'fd.id', string $sortBy = 'ASC'): string
   468|     {
   469|         global $sids;
   470|         $records = implode(', ', $recordIds);
   471|         $page = Filter::filterInput(INPUT_GET, 'seite', FILTER_VALIDATE_INT, 1);
   472|         $taggingId = Filter::filterInput(INPUT_GET, 'tagging_id', FILTER_VALIDATE_INT);
   473|         $output = '';
   474|         $now = date('YmdHis');
   475|         $query = sprintf(
   476|             "
   477|             SELECT
   478|                 fd.id AS id,
   479|                 fd.lang AS lang,
   480|                 fd.thema AS thema,
   481|                 fcr.category_id AS category_id,
   482|                 fv.visits AS visits
   483|             FROM
   484|                 %sfaqdata AS fd
   485|             LEFT JOIN
   486|                 %sfaqcategoryrelations AS fcr
   487|             ON
   488|                 fd.id = fcr.record_id
   489|             AND
   490|                 fd.lang = fcr.record_lang
   491|             LEFT JOIN
   492|                 %sfaqvisits AS fv
   493|             ON
   494|                 fd.id = fv.id
   495|             AND
   496|                 fv.lang = fd.lang
   497|             LEFT JOIN
   498|                 %sfaqdata_group AS fdg
   499|             ON
   500|                 fd.id = fdg.record_id
   501|             LEFT JOIN
   502|                 %sfaqdata_user AS fdu
   503|             ON
   504|                 fd.id = fdu.record_id
   505|             WHERE
   506|                 fd.date_start <= '%s'
   507|             AND
   508|                 fd.date_end   >= '%s'
   509|             AND
   510|                 fd.active = 'yes'
   511|             AND
   512|                 fd.id IN (%s)
   513|             AND
   514|                 fd.lang = '%s'
   515|                 %s
   516|             ORDER BY
   517|                 %s %s",
   518|             Database::getTablePrefix(),
   519|             Database::getTablePrefix(),
   520|             Database::getTablePrefix(),
   521|             Database::getTablePrefix(),
   522|             Database::getTablePrefix(),
   523|             $now,
   524|             $now,
   525|             $records,
   526|             $this->config->getLanguage()->getLanguage(),
   527|             $this->queryPermission($this->groupSupport),
   528|             $this->config->getDb()->escape($orderBy),
   529|             $this->config->getDb()->escape($sortBy)
   530|         );
   531|         $result = $this->config->getDb()->query($query);
   532|         $num = $this->config->getDb()->numRows($result);
   533|         $pages = ceil($num / $this->config->get('records.numberOfRecordsPerPage'));
   534|         if ($page == 1) {
   535|             $first = 0;
   536|         } else {
   537|             $first = ($page * $this->config->get('records.numberOfRecordsPerPage')) -
   538|                 $this->config->get('records.numberOfRecordsPerPage');
   539|         }
   540|         if ($num > 0) {
   541|             if ($pages > 1) {
   542|                 $output .= sprintf(
   543|                     '<p><strong>%s %s %s</strong></p>',
   544|                     Translation::get('msgPage') . $page,
   545|                     Translation::get('msgVoteFrom'),
   546|                     $pages . Translation::get('msgPages')
   547|                 );
   548|             }
   549|             $output .= '<ul class="phpmyfaq_ul">';
   550|             $counter = 0;
   551|             $displayedCounter = 0;
   552|             $lastFaqId = 0;
   553|             while (
   554|                 ($row = $this->config->getDb()->fetchObject($result)) &&
   555|                 $displayedCounter < $this->config->get('records.numberOfRecordsPerPage')
   556|             ) {
   557|                 ++$counter;
   558|                 if ($counter <= $first) {
   559|                     continue;
   560|                 }
   561|                 ++$displayedCounter;
   562|                 if ($lastFaqId == $row->id) {
   563|                     continue; // Don't show multiple FAQs
   564|                 }
   565|                 if (empty($row->visits)) {
   566|                     $visits = 0;
   567|                 } else {
   568|                     $visits = $row->visits;
   569|                 }
   570|                 $title = $row->thema;
   571|                 $url = sprintf(
   572|                     '%sindex.php?%saction=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
   573|                     $this->config->getDefaultUrl(),
   574|                     $sids,
   575|                     $row->category_id,
   576|                     $row->id,
   577|                     $row->lang
   578|                 );
   579|                 $oLink = new Link($url, $this->config);
   580|                 $oLink->itemTitle = $row->thema;
   581|                 $oLink->text = $title;
   582|                 $oLink->tooltip = $title;
   583|                 $listItem = sprintf(
   584|                     '<li>%s<br><small>(%s)</small></li>',
   585|                     $oLink->toHtmlAnchor(),
   586|                     $this->plurals->GetMsg('plmsgViews', $visits)
   587|                 );
   588|                 $output .= $listItem;
   589|                 $lastFaqId = $row->id;
   590|             }
   591|             $output .= '</ul><span id="totFaqRecords" style="display: none;">' . $num . '</span>';
   592|         } else {
   593|             return false;
   594|         }
   595|         if ($num > $this->config->get('records.numberOfRecordsPerPage')) {
   596|             $output .= '<p class="text-center"><strong>';
   597|             if (!isset($page)) {
   598|                 $page = 1;
   599|             }
   600|             $vor = $page - 1;
   601|             $next = $page + 1;
   602|             if ($vor != 0) {
   603|                 $url = $sids . '&amp;action=search&amp;tagging_id=' . $taggingId . '&amp;seite=' . $vor;
   604|                 $oLink = new Link($this->config->getDefaultUrl() . '?' . $url, $this->config);
   605|                 $oLink->itemTitle = 'tag';
   606|                 $oLink->text = Translation::get('msgPrevious');
   607|                 $oLink->tooltip = Translation::get('msgPrevious');
   608|                 $output .= '[ ' . $oLink->toHtmlAnchor() . ' ]';
   609|             }
   610|             $output .= ' ';
   611|             if ($next <= $pages) {
   612|                 $url = $sids . '&amp;action=search&amp;tagging_id=' . $taggingId . '&amp;seite=' . $next;
   613|                 $oLink = new Link($this->config->getDefaultUrl() . '?' . $url, $this->config);
   614|                 $oLink->itemTitle = 'tag';
   615|                 $oLink->text = Translation::get('msgNext');
   616|                 $oLink->tooltip = Translation::get('msgNext');
   617|                 $output .= '[ ' . $oLink->toHtmlAnchor() . ' ]';
   618|             }
   619|             $output .= '</strong></p>';
   620|         }
   621|         return $output;
   622|     }
   623|     /**
   624|      * Returns an array with all data from a FAQ record.
   625|      *
   626|      * @param int      $faqId FAQ ID
   627|      * @param int|null $faqRevisionId Revision ID
   628|      * @param bool     $isAdmin Must be true if it is called by an admin/author context
   629|      */
   630|     public function getRecord(int $faqId, int $faqRevisionId = null, bool $isAdmin = false)
   631|     {
   632|         $currentLanguage = $this->config->getLanguage()->getLanguage();
   633|         $defaultLanguage = $this->config->getDefaultLanguage();
   634|         $result = $this->getRecordResult($faqId, $currentLanguage, $faqRevisionId, $isAdmin);
   635|         if (0 === $this->config->getDb()->numRows($result)) {
   636|             $result = $this->getRecordResult($faqId, $defaultLanguage, $faqRevisionId, $isAdmin);
   637|         }
   638|         if ($row = $this->config->getDb()->fetchObject($result)) {
   639|             $question = nl2br((string) $row->thema);
   640|             $answer = $row->content;
   641|             $active = ('yes' === $row->active);
   642|             $expired = (date('YmdHis') > $row->date_end);
   643|             if (!$isAdmin) {
   644|                 if (!$active) {
   645|                     $answer = Translation::get('err_inactiveArticle');
   646|                 }
   647|                 if ($expired) {
   648|                     $answer = Translation::get('err_expiredArticle');
   649|                 }
   650|             }
   651|             $this->faqRecord = [
   652|                 'id' => $row->id,
   653|                 'lang' => $row->lang,
   654|                 'solution_id' => $row->solution_id,
   655|                 'revision_id' => $row->revision_id,
   656|                 'active' => $row->active,
   657|                 'sticky' => $row->sticky,
   658|                 'keywords' => $row->keywords,
   659|                 'title' => $question,
   660|                 'content' => $answer,
   661|                 'author' => $row->author,
   662|                 'email' => $row->email,
   663|                 'comment' => $row->comment,
   664|                 'date' => Date::createIsoDate($row->updated),
   665|                 'dateStart' => $row->date_start,
   666|                 'dateEnd' => $row->date_end,
   667|                 'notes' => $row->notes,
   668|                 'created' => $row->created,
   669|             ];
   670|         } else {
   671|             $this->faqRecord = [
   672|                 'id' => $faqId,
   673|                 'lang' => $currentLanguage,
   674|                 'solution_id' => 42,
   675|                 'revision_id' => $faqRevisionId,
   676|                 'active' => 'no',
   677|                 'sticky' => 0,
   678|                 'keywords' => '',
   679|                 'title' => '',
   680|                 'content' => Translation::get('msgAccessDenied'),
   681|                 'author' => '',
   682|                 'email' => '',
   683|                 'comment' => '',
   684|                 'date' => Date::createIsoDate(date('YmdHis')),
   685|                 'dateStart' => '',
   686|                 'dateEnd' => '',
   687|                 'notes' => '',
   688|                 'created' => date('c'),
   689|             ];
   690|         }
   691|     }
   692|     /**
   693|      * Executes a query to retrieve a single FAQ.
   694|      *
   695|      * @param int|null $faqRevisionId
   696|      */
   697|     public function getRecordResult(
   698|         int $faqId,
   699|         string $faqLanguage,
   700|         int $faqRevisionId = null,
   701|         bool $isAdmin = false
   702|     ): mixed {
   703|         $query = sprintf(
   704|             "SELECT
   705|                  id, lang, solution_id, revision_id, active, sticky, keywords,
   706|                  thema, content, author, email, comment, updated, date_start, 
   707|                  date_end, created, notes
   708|             FROM
   709|                 %s%s fd
   710|             LEFT JOIN
   711|                 %sfaqdata_group fdg
   712|             ON
   713|                 fd.id = fdg.record_id
   714|             LEFT JOIN
   715|                 %sfaqdata_user fdu
   716|             ON
   717|                 fd.id = fdu.record_id
   718|             WHERE
   719|                 fd.id = %d
   720|             %s
   721|             AND
   722|                 fd.lang = '%s'
   723|                 %s",
   724|             Database::getTablePrefix(),
   725|             isset($faqRevisionId) ? 'faqdata_revisions' : 'faqdata',
   726|             Database::getTablePrefix(),
   727|             Database::getTablePrefix(),
   728|             $faqId,
   729|             isset($faqRevisionId) ? 'AND revision_id = ' . $faqRevisionId : '',
   730|             $faqLanguage,
   731|             ($isAdmin) ? 'AND 1=1' : $this->queryPermission($this->groupSupport)
   732|         );
   733|         return $this->config->getDb()->query($query);
   734|     }
   735|     /**
   736|      * Return records from given IDs
   737|      *
   738|      * @throws Exception
   739|      */
   740|     public function getRecordsByIds(array $faqIds): array
   741|     {
   742|         $faqRecords = [];
   743|         $query = sprintf(
   744|             "SELECT
   745|                  fd.id AS id,
   746|                  fd.lang AS lang,
   747|                  fd.thema AS question,
   748|                  fd.content AS answer,
   749|                  fd.updated AS updated,
   750|                  fd.created AS created,
   751|                  fcr.category_id AS category_id,
   752|                  fv.visits AS visits
   753|             FROM
   754|                 %sfaqdata fd
   755|             LEFT JOIN
   756|                 %sfaqcategoryrelations fcr
   757|             ON
   758|                 fd.id = fcr.record_id
   759|             AND
   760|                 fd.lang = fcr.record_lang
   761|             LEFT JOIN
   762|                 %sfaqdata_group fdg
   763|             ON
   764|                 fd.id = fdg.record_id
   765|             LEFT JOIN
   766|                 %sfaqvisits AS fv
   767|             ON
   768|                 fd.id = fv.id
   769|             AND
   770|                 fv.lang = fd.lang
   771|             LEFT JOIN
   772|                 %sfaqdata_user fdu
   773|             ON
   774|                 fd.id = fdu.record_id
   775|             WHERE
   776|                 fd.id IN (%s)
   777|             AND
   778|                 fd.lang = '%s'
   779|                 %s",
   780|             Database::getTablePrefix(),
   781|             Database::getTablePrefix(),
   782|             Database::getTablePrefix(),
   783|             Database::getTablePrefix(),
   784|             Database::getTablePrefix(),
   785|             implode(',', $faqIds),
   786|             $this->config->getLanguage()->getLanguage(),
   787|             $this->queryPermission($this->groupSupport)
   788|         );
   789|         $result = $this->config->getDb()->query($query);
   790|         $faqHelper = new FaqHelper($this->config);
   791|         while ($row = $this->config->getDb()->fetchObject($result)) {
   792|             if (empty($row->visits)) {
   793|                 $visits = 0;
   794|             } else {
   795|                 $visits = $row->visits;
   796|             }
   797|             $url = sprintf(
   798|                 '%sindex.php?action=faq&cat=%d&id=%d&artlang=%s',
   799|                 $this->config->getDefaultUrl(),
   800|                 $row->category_id,
   801|                 $row->id,
   802|                 $row->lang
   803|             );
   804|             $oLink = new Link($url, $this->config);
   805|             $oLink->itemTitle = $oLink->text = $oLink->tooltip = $row->question;
   806|             $faqRecords[] = [
   807|                 'record_id' => (int)$row->id,
   808|                 'record_lang' => $row->lang,
   809|                 'category_id' => (int)$row->category_id,
   810|                 'record_title' => $row->question,
   811|                 'record_preview' => $faqHelper->renderAnswerPreview($row->answer, 25),
   812|                 'record_link' => $oLink->toString(),
   813|                 'record_updated' => Date::createIsoDate($row->updated) . ':00',
   814|                 'visits' => (int)$visits,
   815|                 'record_created' => $row->created
   816|             ];
   817|         }
   818|         return $faqRecords;
   819|     }
   820|     /**
   821|      * Creates a new FAQ.
   822|      */
   823|     public function create(FaqEntity $faq): int
   824|     {
   825|         if (is_null($faq->getId())) {
   826|             $faq->setId($this->config->getDb()->nextId(Database::getTablePrefix() . 'faqdata', 'id'));
   827|         }
   828|         $query = sprintf(
   829|             "INSERT INTO %sfaqdata 
   830|             (id, lang, solution_id, revision_id, active, sticky, keywords, thema, content, author, email, comment, 
   831|             updated, date_start, date_end, created, notes)
   832|             VALUES
   833|             (%d, '%s', %d, %d, '%s', %d, '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s')",
   834|             Database::getTablePrefix(),
   835|             $faq->getId(),
   836|             $this->config->getDb()->escape($faq->getLanguage()),
   837|             $this->getNextSolutionId(),
   838|             0,
   839|             $faq->isActive() ? 'yes' : 'no',
   840|             $faq->isSticky() ? 1 : 0,
   841|             $this->config->getDb()->escape($faq->getKeywords()),
   842|             $this->config->getDb()->escape($faq->getQuestion()),
   843|             $this->config->getDb()->escape($faq->getAnswer()),
   844|             $this->config->getDb()->escape($faq->getAuthor()),
   845|             $this->config->getDb()->escape($faq->getEmail()),
   846|             $faq->isComment() ? 'y' : 'n',
   847|             date('YmdHis'),
   848|             '00000000000000',
   849|             '99991231235959',
   850|             date('Y-m-d H:i:s'),
   851|             $this->config->getDb()->escape($faq->getNotes())
   852|         );
   853|         $this->config->getDb()->query($query);
   854|         return $faq->getId();
   855|     }
   856|     /**
   857|      * Gets the latest solution id for a FAQ record.
   858|      */
   859|     public function getNextSolutionId(): int
   860|     {
   861|         $latestId = 0;
   862|         $query = sprintf('SELECT MAX(solution_id) AS solution_id FROM %sfaqdata', Database::getTablePrefix());
   863|         $result = $this->config->getDb()->query($query);
   864|         if ($result && $row = $this->config->getDb()->fetchObject($result)) {
   865|             $latestId = $row->solution_id;
   866|         }
   867|         if ($latestId < PMF_SOLUTION_ID_START_VALUE) {
   868|             $nextSolutionId = PMF_SOLUTION_ID_START_VALUE;
   869|         } else {
   870|             $nextSolutionId = $latestId + PMF_SOLUTION_ID_INCREMENT_VALUE;
   871|         }
   872|         return $nextSolutionId;
   873|     }
   874|     public function update(FaqEntity $faq): bool
   875|     {
   876|         $query = sprintf(
   877|             "UPDATE %sfaqdata SET
   878|             revision_id = %d,
   879|             active = '%s',
   880|             sticky = %d,
   881|             keywords = '%s',
   882|             thema = '%s',
   883|             content = '%s',
   884|             author = '%s',
   885|             email = '%s',
   886|             comment = '%s',
   887|             date_start = '%s',
   888|             date_end = '%s',
   889|             notes = '%s'",
   890|             Database::getTablePrefix(),
   891|             $faq->getRevisionId(),
   892|             $faq->isActive() ? 'yes' : 'no',
   893|             $faq->isSticky() ? 1 : 0,
   894|             $this->config->getDb()->escape($faq->getKeywords()),
   895|             $this->config->getDb()->escape($faq->getQuestion()),
   896|             $this->config->getDb()->escape($faq->getAnswer()),
   897|             $this->config->getDb()->escape($faq->getAuthor()),
   898|             $this->config->getDb()->escape($faq->getEmail()),
   899|             $faq->isComment() ? 'y' : 'n',
   900|             $faq->getValidFrom()->format('YmdHis'),
   901|             $faq->getValidTo()->format('YmdHis'),
   902|             $this->config->getDb()->escape($faq->getNotes())
   903|         );
   904|         if ($faq->getUpdatedDate() !== null) {
   905|             $query .= sprintf(", updated = '%s'", $faq->getUpdatedDate()->format('YmdHis'));
   906|         }
   907|         $query .= sprintf(
   908|             " WHERE id = %d AND lang = '%s'",
   909|             $faq->getId(),
   910|             $this->config->getDb()->escape($faq->getLanguage())
   911|         );
   912|         return (bool) $this->config->getDb()->query($query);
   913|     }
   914|     /**
   915|      * Deletes a record and all the dependencies.
   916|      *
   917|      * @param int    $recordId   Record id
   918|      * @param string $recordLang Record language
   919|      * @throws Attachment\AttachmentException
   920|      * @throws Attachment\Filesystem\File\FileException
   921|      */
   922|     public function deleteRecord(int $recordId, string $recordLang): bool
   923|     {
   924|         $solutionId = $this->getSolutionIdFromId($recordId, $recordLang);
   925|         $queries = [sprintf(
   926|             "DELETE FROM %sfaqchanges WHERE beitrag = %d AND lang = '%s'",
   927|             Database::getTablePrefix(),
   928|             $recordId,
   929|             $this->config->getDb()->escape($recordLang)
   930|         ), sprintf(
   931|             "DELETE FROM %sfaqcategoryrelations WHERE record_id = %d AND record_lang = '%s'",
   932|             Database::getTablePrefix(),
   933|             $recordId,
   934|             $this->config->getDb()->escape($recordLang)
   935|         ), sprintf(
   936|             "DELETE FROM %sfaqdata WHERE id = %d AND lang = '%s'",
   937|             Database::getTablePrefix(),
   938|             $recordId,
   939|             $this->config->getDb()->escape($recordLang)
   940|         ), sprintf(
   941|             "DELETE FROM %sfaqdata_revisions WHERE id = %d AND lang = '%s'",
   942|             Database::getTablePrefix(),
   943|             $recordId,
   944|             $this->config->getDb()->escape($recordLang)
   945|         ), sprintf(
   946|             "DELETE FROM %sfaqvisits WHERE id = %d AND lang = '%s'",
   947|             Database::getTablePrefix(),
   948|             $recordId,
   949|             $this->config->getDb()->escape($recordLang)
   950|         ), sprintf(
   951|             'DELETE FROM %sfaqdata_user WHERE record_id = %d',
   952|             Database::getTablePrefix(),
   953|             $recordId
   954|         ), sprintf(
   955|             'DELETE FROM %sfaqdata_group WHERE record_id = %d',
   956|             Database::getTablePrefix(),
   957|             $recordId
   958|         ), sprintf(
   959|             'DELETE FROM %sfaqdata_tags WHERE record_id = %d',
   960|             Database::getTablePrefix(),
   961|             $recordId
   962|         ), sprintf(
   963|             'DELETE FROM %sfaqdata_tags WHERE %sfaqdata_tags.record_id NOT IN (SELECT %sfaqdata.id FROM %sfaqdata)',
   964|             Database::getTablePrefix(),
   965|             Database::getTablePrefix(),
   966|             Database::getTablePrefix(),
   967|             Database::getTablePrefix()
   968|         ), sprintf(
   969|             'DELETE FROM %sfaqcomments WHERE id = %d',
   970|             Database::getTablePrefix(),
   971|             $recordId
   972|         ), sprintf(
   973|             'DELETE FROM %sfaqvoting WHERE artikel = %d',
   974|             Database::getTablePrefix(),
   975|             $recordId
   976|         )];
   977|         foreach ($queries as $query) {
   978|             $this->config->getDb()->query($query);
   979|         }
   980|         $attachments = AttachmentFactory::fetchByRecordId($this->config, $recordId);
   981|         foreach ($attachments as $attachment) {
   982|             $currentAttachment = AttachmentFactory::create($attachment->getId());
   983|             $currentAttachment->delete();
   984|         }
   985|         if ($this->config->get('search.enableElasticsearch')) {
   986|             $esInstance = new Elasticsearch($this->config);
   987|             $esInstance->delete($solutionId);
   988|         }
   989|         return true;
   990|     }
   991|     /**
   992|      * Returns the solution ID from a given ID and language
   993|      */
   994|     public function getSolutionIdFromId(int $faqId, string $faqLang): int
   995|     {
   996|         $query = sprintf(
   997|             "
   998|             SELECT
   999|                 solution_id
  1000|             FROM
  1001|                 %sfaqdata
  1002|             WHERE
  1003|                 id = %d
  1004|                 AND
  1005|                 lang = '%s'",
  1006|             Database::getTablePrefix(),
  1007|             $faqId,
  1008|             $this->config->getDb()->escape($faqLang)
  1009|         );
  1010|         $result = $this->config->getDb()->query($query);
  1011|         if ($row = $this->config->getDb()->fetchObject($result)) {
  1012|             return $row->solution_id;
  1013|         }
  1014|         return $this->getNextSolutionId();
  1015|     }
  1016|     /**
  1017|      * Checks if a record is already translated.
  1018|      *
  1019|      * @param int    $recordId   Record id
  1020|      * @param string $recordLang Record language
  1021|      */
  1022|     public function hasTranslation(int $recordId, string $recordLang): bool
  1023|     {
  1024|         $query = sprintf(
  1025|             "
  1026|             SELECT
  1027|                 id, lang
  1028|             FROM
  1029|                 %sfaqdata
  1030|             WHERE
  1031|                 id = %d
  1032|             AND
  1033|                 lang = '%s'",
  1034|             Database::getTablePrefix(),
  1035|             $recordId,
  1036|             $this->config->getDb()->escape($recordLang)
  1037|         );
  1038|         $result = $this->config->getDb()->query($query);
  1039|         if ($this->config->getDb()->numRows($result)) {
  1040|             return true;
  1041|         }
  1042|         return false;
  1043|     }
  1044|     public function isActive(int $recordId, string $recordLang, string $commentType = 'faq'): bool
  1045|     {
  1046|         if ('news' === $commentType) {
  1047|             $table = 'faqnews';
  1048|         } else {
  1049|             $table = 'faqdata';
  1050|         }
  1051|         $query = sprintf(
  1052|             "
  1053|             SELECT
  1054|                 active
  1055|             FROM
  1056|                 %s%s
  1057|             WHERE
  1058|                 id = %d
  1059|             AND
  1060|                 lang = '%s'",
  1061|             Database::getTablePrefix(),
  1062|             $table,
  1063|             $recordId,
  1064|             $this->config->getDb()->escape($recordLang)
  1065|         );
  1066|         $result = $this->config->getDb()->query($query);
  1067|         if ($row = $this->config->getDb()->fetchObject($result)) {
  1068|             return !(($row->active === 'y' || $row->active === 'yes'));
  1069|         } else {
  1070|             return true;
  1071|         }
  1072|     }
  1073|     /**
  1074|      * Checks, if comments are disabled for the FAQ record.
  1075|      *
  1076|      * @param int    $recordId    Id of FAQ or news entry
  1077|      * @param string $recordLang  Language
  1078|      * @param string $commentType Type of comment: faq or news
  1079|      * @return bool true, if comments are disabled
  1080|      */
  1081|     public function commentDisabled(int $recordId, string $recordLang, string $commentType = 'faq'): bool
  1082|     {
  1083|         if ('news' === $commentType) {
  1084|             $table = 'faqnews';
  1085|         } else {
  1086|             $table = 'faqdata';
  1087|         }
  1088|         $query = sprintf(
  1089|             "
  1090|             SELECT
  1091|                 comment
  1092|             FROM
  1093|                 %s%s
  1094|             WHERE
  1095|                 id = %d
  1096|             AND
  1097|                 lang = '%s'",
  1098|             Database::getTablePrefix(),
  1099|             $table,
  1100|             $recordId,
  1101|             $this->config->getDb()->escape($recordLang)
  1102|         );
  1103|         $result = $this->config->getDb()->query($query);
  1104|         if ($row = $this->config->getDb()->fetchObject($result)) {
  1105|             return !(($row->comment === 'y'));
  1106|         } else {
  1107|             return true;
  1108|         }
  1109|     }
  1110|     /**
  1111|      * Returns an array with all data from a FAQ record.
  1112|      *
  1113|      * @param int $solutionId Solution ID
  1114|      */
  1115|     public function getRecordBySolutionId(int $solutionId): void
  1116|     {
  1117|         $query = sprintf(
  1118|             'SELECT
  1119|                 fd.*, COALESCE(fdg.group_id, -1) AS group_id, fdu.user_id
  1120|             FROM
  1121|                 %sfaqdata fd
  1122|             LEFT JOIN (
  1123|                 SELECT record_id, group_id FROM %sfaqdata_group fdg WHERE fdg.group_id <> -1
  1124|                 UNION ALL
  1125|                 SELECT fd.id AS record_id, -1 AS group_id FROM %sfaqdata fd WHERE fd.solution_id = %d
  1126|             ) AS fdg
  1127|             ON
  1128|                 fd.id = fdg.record_id
  1129|             LEFT JOIN
  1130|                 %sfaqdata_user fdu
  1131|             ON
  1132|                 fd.id = fdu.record_id
  1133|             WHERE
  1134|                 fd.solution_id = %d
  1135|                 %s',
  1136|             Database::getTablePrefix(),
  1137|             Database::getTablePrefix(),
  1138|             Database::getTablePrefix(),
  1139|             $solutionId,
  1140|             Database::getTablePrefix(),
  1141|             $solutionId,
  1142|             $this->queryPermission($this->groupSupport)
  1143|         );
  1144|         $result = $this->config->getDb()->query($query);
  1145|         if ($row = $this->config->getDb()->fetchObject($result)) {
  1146|             $question = nl2br((string) $row->thema);
  1147|             $content = $row->content;
  1148|             $active = ('yes' == $row->active);
  1149|             $expired = (date('YmdHis') > $row->date_end);
  1150|             if (!$active) {
  1151|                 $content = Translation::get('err_inactiveArticle');
  1152|             }
  1153|             if ($expired) {
  1154|                 $content = Translation::get('err_expiredArticle');
  1155|             }
  1156|             $this->faqRecord = [
  1157|                 'id' => $row->id,
  1158|                 'lang' => $row->lang,
  1159|                 'solution_id' => $row->solution_id,
  1160|                 'revision_id' => $row->revision_id,
  1161|                 'active' => $row->active,
  1162|                 'sticky' => $row->sticky,
  1163|                 'keywords' => $row->keywords,
  1164|                 'title' => $question,
  1165|                 'content' => $content,
  1166|                 'author' => $row->author,
  1167|                 'email' => $row->email,
  1168|                 'comment' => $row->comment,
  1169|                 'date' => Date::createIsoDate($row->updated),
  1170|                 'dateStart' => $row->date_start,
  1171|                 'dateEnd' => $row->date_end,
  1172|                 'notes' => $row->notes
  1173|             ];
  1174|         }
  1175|     }
  1176|     /**
  1177|      * Gets the record ID from a given solution ID.
  1178|      *
  1179|      * @param int $solutionId Solution ID
  1180|      */
  1181|     public function getIdFromSolutionId(int $solutionId): array
  1182|     {
  1183|         $query = sprintf(
  1184|             '
  1185|             SELECT
  1186|                 fd.id,
  1187|                 fd.lang,
  1188|                 fd.thema AS question,
  1189|                 fd.content,
  1190|                 fcr.category_id AS category_id
  1191|             FROM
  1192|                 %sfaqdata fd
  1193|             LEFT JOIN
  1194|                 %sfaqcategoryrelations fcr
  1195|             ON
  1196|                 fd.id = fcr.record_id
  1197|             AND
  1198|                 fd.lang = fcr.record_lang
  1199|             WHERE
  1200|                 fd.solution_id = %d',
  1201|             Database::getTablePrefix(),
  1202|             Database::getTablePrefix(),
  1203|             $solutionId
  1204|         );
  1205|         $result = $this->config->getDb()->query($query);
  1206|         if ($row = $this->config->getDb()->fetchObject($result)) {
  1207|             return [
  1208|                 'id' => $row->id,
  1209|                 'lang' => $row->lang,
  1210|                 'question' => $row->question,
  1211|                 'content' => $row->content,
  1212|                 'category_id' => $row->category_id
  1213|             ];
  1214|         }
  1215|         return [];
  1216|     }
  1217|     /**
  1218|      * Returns an array with all data from all FAQ records.
  1219|      *
  1220|      * @param int        $sortType  Sorting type
  1221|      * @param array|null $condition Condition
  1222|      * @param ?string     $sortOrder Sorting order
  1223|      */
  1224|     public function getAllRecords(
  1225|         int $sortType = FAQ_SORTING_TYPE_CATID_FAQID,
  1226|         array $condition = null,
  1227|         ?string $sortOrder = 'ASC'
  1228|     ): void {
  1229|         $where = '';
  1230|         if (!is_null($condition)) {
  1231|             $num = count($condition);
  1232|             $where = 'WHERE ';
  1233|             foreach ($condition as $field => $data) {
  1234|                 --$num;
  1235|                 $where .= $field;
  1236|                 if (is_array($data)) {
  1237|                     $where .= ' IN (';
  1238|                     $separator = '';
  1239|                     foreach ($data as $value) {
  1240|                         $where .= $separator . "'" . $this->config->getDb()->escape($value) . "'";
  1241|                         $separator = ', ';
  1242|                     }
  1243|                     $where .= ')';
  1244|                 } else {
  1245|                     $where .= " = '" . $this->config->getDb()->escape($data) . "'";
  1246|                 }
  1247|                 if ($num > 0) {
  1248|                     $where .= ' AND ';
  1249|                 }
  1250|             }
  1251|         }
  1252|         $orderBy = match ($sortType) {
  1253|             FAQ_SORTING_TYPE_CATID_FAQID => sprintf('ORDER BY fcr.category_id, fd.id %s', $sortOrder),
  1254|             FAQ_SORTING_TYPE_FAQID => sprintf('ORDER BY fd.id %s', $sortOrder),
  1255|             FAQ_SORTING_TYPE_FAQTITLE_FAQID => sprintf('ORDER BY fcr.category_id, fd.thema %s', $sortOrder),
  1256|             FAQ_SORTING_TYPE_DATE_FAQID => sprintf('ORDER BY fcr.category_id, fd.updated %s', $sortOrder),
  1257|             default => '',
  1258|         };
  1259|         $groupBy = ' group by fd.id, fcr.category_id,fd.solution_id,fd.revision_id,fd.active,fd.sticky,fd.keywords,' .
  1260|             'fd.thema,fd.content,fd.author,fd.email,fd.comment,fd.updated,' .
  1261|             'fd.date_start,fd.date_end,fd.sticky,fd.created,fd.notes,fd.lang ';
  1262|         $query = sprintf(
  1263|             '
  1264|             SELECT
  1265|                 fd.id AS id,
  1266|                 fd.lang AS lang,
  1267|                 fcr.category_id AS category_id,
  1268|                 fd.solution_id AS solution_id,
  1269|                 fd.revision_id AS revision_id,
  1270|                 fd.active AS active,
  1271|                 fd.sticky AS sticky,
  1272|                 fd.keywords AS keywords,
  1273|                 fd.thema AS thema,
  1274|                 fd.content AS content,
  1275|                 fd.author AS author,
  1276|                 fd.email AS email,
  1277|                 fd.comment AS comment,
  1278|                 fd.updated AS updated,
  1279|                 fd.date_start AS date_start,
  1280|                 fd.date_end AS date_end,
  1281|                 fd.sticky AS sticky,
  1282|                 fd.created AS created,
  1283|                 fd.notes AS notes
  1284|             FROM
  1285|                 %sfaqdata fd
  1286|             LEFT JOIN
  1287|                 %sfaqcategoryrelations fcr
  1288|             ON
  1289|                 fd.id = fcr.record_id
  1290|             AND
  1291|                 fd.lang = fcr.record_lang
  1292|             LEFT JOIN
  1293|                 %sfaqdata_group AS fdg
  1294|             ON
  1295|                 fd.id = fdg.record_id
  1296|             LEFT JOIN
  1297|                 %sfaqdata_user AS fdu
  1298|             ON
  1299|                 fd.id = fdu.record_id
  1300|             %s
  1301|             %s
  1302|             %s
  1303|             %s',
  1304|             Database::getTablePrefix(),
  1305|             Database::getTablePrefix(),
  1306|             Database::getTablePrefix(),
  1307|             Database::getTablePrefix(),
  1308|             $where,
  1309|             $this->queryPermission($this->groupSupport),
  1310|             $groupBy,
  1311|             $orderBy
  1312|         );
  1313|         $result = $this->config->getDb()->query($query);
  1314|         while ($row = $this->config->getDb()->fetchObject($result)) {
  1315|             $content = $row->content;
  1316|             $active = ('yes' == $row->active);
  1317|             $expired = (date('YmdHis') > $row->date_end);
  1318|             if (!$active) {
  1319|                 $content = Translation::get('err_inactiveArticle');
  1320|             }
  1321|             if ($expired) {
  1322|                 $content = Translation::get('err_expiredArticle');
  1323|             }
  1324|             $this->faqRecords[] = [
  1325|                 'id' => $row->id,
  1326|                 'category_id' => $row->category_id,
  1327|                 'lang' => $row->lang,
  1328|                 'solution_id' => $row->solution_id,
  1329|                 'revision_id' => $row->revision_id,
  1330|                 'active' => $row->active,
  1331|                 'sticky' => $row->sticky,
  1332|                 'keywords' => $row->keywords,
  1333|                 'title' => $row->thema,
  1334|                 'content' => $content,
  1335|                 'author' => $row->author,
  1336|                 'email' => $row->email,
  1337|                 'comment' => $row->comment,
  1338|                 'updated' => Date::createIsoDate($row->updated, 'Y-m-d H:i:s'),
  1339|                 'dateStart' => $row->date_start,
  1340|                 'dateEnd' => $row->date_end,
  1341|                 'created' => $row->created,
  1342|                 'notes' => $row->notes
  1343|             ];
  1344|         }
  1345|     }
  1346|     /**
  1347|      * Returns the FAQ record title from the ID and language.
  1348|      *
  1349|      * @param int $id Record id
  1350|      */
  1351|     public function getRecordTitle(int $id): string
  1352|     {
  1353|         if (isset($this->faqRecord['id']) && ($this->faqRecord['id'] == $id)) {
  1354|             return $this->faqRecord['title'];
  1355|         }
  1356|         $question = '';
  1357|         $query = sprintf(
  1358|             "SELECT thema AS question FROM %sfaqdata WHERE id = %d AND lang = '%s'",
  1359|             Database::getTablePrefix(),
  1360|             $id,
  1361|             $this->config->getLanguage()->getLanguage()
  1362|         );
  1363|         $result = $this->config->getDb()->query($query);
  1364|         if ($this->config->getDb()->numRows($result) > 0) {
  1365|             while ($row = $this->config->getDb()->fetchObject($result)) {
  1366|                 $question = Strings::htmlentities($row->question);
  1367|             }
  1368|         } else {
  1369|             $question = Translation::get('no_cats');
  1370|         }
  1371|         return $question;
  1372|     }
  1373|     /**
  1374|      * Returns the keywords of a FAQ record from the ID and language.
  1375|      *
  1376|      * @param int $id record id
  1377|      */
  1378|     public function getRecordKeywords(int $id): string
  1379|     {
  1380|         if (isset($this->faqRecord['id']) && ($this->faqRecord['id'] == $id)) {
  1381|             return $this->faqRecord['keywords'];
  1382|         }
  1383|         $query = sprintf(
  1384|             "SELECT
  1385|                 keywords
  1386|             FROM
  1387|                 %sfaqdata
  1388|             WHERE id = %d AND lang = '%s'",
  1389|             Database::getTablePrefix(),
  1390|             $id,
  1391|             $this->config->getLanguage()->getLanguage()
  1392|         );
  1393|         $result = $this->config->getDb()->query($query);
  1394|         if ($this->config->getDb()->numRows($result) > 0) {
  1395|             $row = $this->config->getDb()->fetchObject($result);
  1396|             return Strings::htmlspecialchars($row->keywords, ENT_QUOTES, 'utf-8');
  1397|         } else {
  1398|             return '';
  1399|         }
  1400|     }
  1401|     /**
  1402|      * Returns a answer preview of the FAQ record.
  1403|      *
  1404|      * @param int $recordId  FAQ record ID
  1405|      * @param int $wordCount Number of words, default: 12
  1406|      */
  1407|     public function getRecordPreview(int $recordId, int $wordCount = 12): string
  1408|     {
  1409|         if (isset($this->faqRecord['id']) && ((int)$this->faqRecord['id'] === $recordId)) {
  1410|             $answerPreview = $this->faqRecord['content'];
  1411|             return Utils::makeShorterText($answerPreview, $wordCount);
  1412|         }
  1413|         $query = sprintf(
  1414|             "
  1415|             SELECT
  1416|                 content as answer
  1417|             FROM
  1418|                 %sfaqdata
  1419|             WHERE 
  1420|                 id = %d 
  1421|             AND 
  1422|                 lang = '%s'",
  1423|             Database::getTablePrefix(),
  1424|             $recordId,
  1425|             $this->config->getLanguage()->getLanguage()
  1426|         );
  1427|         $result = $this->config->getDb()->query($query);
  1428|         if ($this->config->getDb()->numRows($result) > 0) {
  1429|             $row = $this->config->getDb()->fetchObject($result);
  1430|             $answerPreview = strip_tags((string) $row->answer);
  1431|         } else {
  1432|             $answerPreview = $this->config->get('main.metaDescription');
  1433|         }
  1434|         return Utils::makeShorterText($answerPreview, $wordCount);
  1435|     }
  1436|     /**
  1437|      * Returns the number of activated and not expired records, optionally
  1438|      * not limited to the current language.
  1439|      *
  1440|      * @param string|null $language Language
  1441|      */
  1442|     public function getNumberOfRecords(string $language = null): int
  1443|     {
  1444|         $now = date('YmdHis');
  1445|         $query = sprintf(
  1446|             "
  1447|             SELECT
  1448|                 id
  1449|             FROM
  1450|                 %sfaqdata
  1451|             WHERE
  1452|                 active = 'yes'
  1453|             %s
  1454|             AND
  1455|                 date_start <= '%s'
  1456|             AND
  1457|                 date_end >= '%s'",
  1458|             Database::getTablePrefix(),
  1459|             null === $language ? '' : "AND lang = '" . $this->config->getDb()->escape($language) . "'",
  1460|             $now,
  1461|             $now
  1462|         );
  1463|         $num = $this->config->getDb()->numRows($this->config->getDb()->query($query));
  1464|         if ($num > 0) {
  1465|             return $num;
  1466|         } else {
  1467|             return 0;
  1468|         }
  1469|     }
  1470|     /**
  1471|      * This function generates a list with the most voted or most visited records.
  1472|      *
  1473|      * @param string $type Type definition visits/voted
  1474|      */
  1475|     public function getTopTen(string $type = 'visits'): array
  1476|     {
  1477|         if ('visits' === $type) {
  1478|             $result = $this->getTopTenData(PMF_NUMBER_RECORDS_TOPTEN, 0, $this->config->getLanguage()->getLanguage());
  1479|         } else {
  1480|             $result = $this->getTopVotedData(PMF_NUMBER_RECORDS_TOPTEN, $this->config->getLanguage()->getLanguage());
  1481|         }
  1482|         $output = [];
  1483|         if (count($result) > 0) {
  1484|             foreach ($result as $row) {
  1485|                 if ('visits' == $type) {
  1486|                     $output['title'][] = Strings::htmlentities(Utils::makeShorterText($row['question'], 8));
  1487|                     $output['preview'][] = Strings::htmlentities($row['question']);
  1488|                     $output['url'][] = Strings::htmlentities($row['url']);
  1489|                     $output['visits'][] = $this->plurals->GetMsg('plmsgViews', $row['visits']);
  1490|                 } else {
  1491|                     $output['title'][] = Strings::htmlentities(Utils::makeShorterText($row['question'], 8));
  1492|                     $output['preview'][] = Strings::htmlentities($row['question']);
  1493|                     $output['url'][] = Strings::htmlentities($row['url']);
  1494|                     $output['voted'][] = sprintf(
  1495|                         '%s %s 5 - %s',
  1496|                         round($row['avg'], 2),
  1497|                         Translation::get('msgVoteFrom'),
  1498|                         $this->plurals->GetMsg('plmsgVotes', $row['user'])
  1499|                     );
  1500|                 }
  1501|             }
  1502|         } else {
  1503|             $output['error'] = Translation::get('err_noTopTen');
  1504|         }
  1505|         return $output;
  1506|     }
  1507|     /**
  1508|      * This function generates the Top Ten data with the most viewed records.
  1509|      *
  1510|      * @param int  $count Number of records
  1511|      * @param int  $categoryId Entity ID
  1512|      * @param string|null $language Language
  1513|      */
  1514|     public function getTopTenData(
  1515|         int $count = PMF_NUMBER_RECORDS_TOPTEN,
  1516|         int $categoryId = 0,
  1517|         string $language = null
  1518|     ): array {
  1519|         global $sids;
  1520|         $now = date('YmdHis');
  1521|         $query =
  1522|             'SELECT
  1523|                 fd.id AS id,
  1524|                 fd.lang AS lang,
  1525|                 fd.thema AS question,
  1526|                 fd.content AS answer,
  1527|                 fd.updated AS updated,
  1528|                 fcr.category_id AS category_id,
  1529|                 fv.visits AS visits,
  1530|                 fv.last_visit AS last_visit,
  1531|                 fdg.group_id AS group_id,
  1532|                 fdu.user_id AS user_id
  1533|             FROM
  1534|                 ' . Database::getTablePrefix() . 'faqvisits fv,
  1535|                 ' . Database::getTablePrefix() . 'faqdata fd
  1536|             LEFT JOIN
  1537|                 ' . Database::getTablePrefix() . 'faqcategoryrelations fcr
  1538|             ON
  1539|                 fd.id = fcr.record_id
  1540|             AND
  1541|                 fd.lang = fcr.record_lang
  1542|             LEFT JOIN
  1543|                 ' . Database::getTablePrefix() . 'faqdata_group AS fdg
  1544|             ON
  1545|                 fd.id = fdg.record_id
  1546|             LEFT JOIN
  1547|                 ' . Database::getTablePrefix() . 'faqdata_user AS fdu
  1548|             ON
  1549|                 fd.id = fdu.record_id
  1550|             WHERE
  1551|                     fd.date_start <= \'' . $now . '\'
  1552|                 AND fd.date_end   >= \'' . $now . '\'
  1553|                 AND fd.id = fv.id
  1554|                 AND fd.lang = fv.lang
  1555|                 AND fd.active = \'yes\'';
  1556|         if (isset($categoryId) && is_numeric($categoryId) && ($categoryId != 0)) {
  1557|             $query .= '
  1558|             AND
  1559|                 fcr.category_id = \'' . $categoryId . '\'';
  1560|         }
  1561|         if (isset($language) && Language::isASupportedLanguage($language)) {
  1562|             $query .= '
  1563|             AND
  1564|                 fd.lang = \'' . $this->config->getDb()->escape($language) . '\'';
  1565|         }
  1566|         $query .= '
  1567|                 ' . $this->queryPermission($this->groupSupport) . '
  1568|             GROUP BY
  1569|                 fd.id,fd.lang,fcr.category_id,fv.visits,fv.last_visit,fdg.group_id,fdu.user_id
  1570|             ORDER BY
  1571|                 fv.visits DESC';
  1572|         $result = $this->config->getDb()->query($query);
  1573|         $topTen = [];
  1574|         $data = [];
  1575|         if ($result) {
  1576|             while ($row = $this->config->getDb()->fetchObject($result)) {
  1577|                 if ($this->groupSupport) {
  1578|                     if (!in_array($row->user_id, [-1, $this->user]) || !in_array($row->group_id, $this->groups)) {
  1579|                         continue;
  1580|                     }
  1581|                 } else {
  1582|                     if (!in_array($row->user_id, [-1, $this->user])) {
  1583|                         continue;
  1584|                     }
  1585|                 }
  1586|                 $data['visits'] = (int)$row->visits;
  1587|                 $data['question'] = Filter::filterVar($row->question, FILTER_SANITIZE_SPECIAL_CHARS);
  1588|                 $data['answer'] = $row->answer;
  1589|                 $data['date'] = Date::createIsoDate($row->updated, DATE_ISO8601, true);
  1590|                 $data['last_visit'] = date('c', $row->last_visit);
  1591|                 $title = $row->question;
  1592|                 $url = sprintf(
  1593|                     '%sindex.php?%saction=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
  1594|                     $this->config->getDefaultUrl(),
  1595|                     $sids,
  1596|                     $row->category_id,
  1597|                     $row->id,
  1598|                     $row->lang
  1599|                 );
  1600|                 $oLink = new Link($url, $this->config);
  1601|                 $oLink->itemTitle = $row->question;
  1602|                 $oLink->tooltip = $title;
  1603|                 $data['url'] = $oLink->toString();
  1604|                 $topTen[$row->id] = $data;
  1605|                 if (count($topTen) === $count) {
  1606|                     break;
  1607|                 }
  1608|             }
  1609|             array_multisort($topTen, SORT_DESC);
  1610|         }
  1611|         return $topTen;
  1612|     }
  1613|     /**
  1614|      * This function generates a data-set with the most voted FAQs.
  1615|      *
  1616|      * @param int    $count    Number of records
  1617|      * @param string|null $language Language
  1618|      */
  1619|     public function getTopVotedData(int $count = PMF_NUMBER_RECORDS_TOPTEN, string $language = null): array
  1620|     {
  1621|         global $sids;
  1622|         $topten = $data = [];
  1623|         $now = date('YmdHis');
  1624|         $query =
  1625|             '            SELECT
  1626|                 fd.id AS id,
  1627|                 fd.lang AS lang,
  1628|                 fd.thema AS thema,
  1629|                 fd.updated AS updated,
  1630|                 fcr.category_id AS category_id,
  1631|                 (fv.vote/fv.usr) AS avg,
  1632|                 fv.usr AS user
  1633|             FROM
  1634|                 ' . Database::getTablePrefix() . 'faqvoting fv,
  1635|                 ' . Database::getTablePrefix() . 'faqdata fd
  1636|             LEFT JOIN
  1637|                 ' . Database::getTablePrefix() . 'faqcategoryrelations fcr
  1638|             ON
  1639|                 fd.id = fcr.record_id
  1640|             AND
  1641|                 fd.lang = fcr.record_lang
  1642|             LEFT JOIN
  1643|                 ' . Database::getTablePrefix() . 'faqdata_group AS fdg
  1644|             ON
  1645|                 fd.id = fdg.record_id
  1646|             LEFT JOIN
  1647|                 ' . Database::getTablePrefix() . 'faqdata_user AS fdu
  1648|             ON
  1649|                 fd.id = fdu.record_id
  1650|             WHERE
  1651|                     fd.date_start <= \'' . $now . '\'
  1652|                 AND fd.date_end   >= \'' . $now . '\'
  1653|                 AND fd.id = fv.artikel
  1654|                 AND fd.active = \'yes\'';
  1655|         if (isset($categoryId) && is_numeric($categoryId) && ($categoryId != 0)) {
  1656|             $query .= '
  1657|             AND
  1658|                 fcr.category_id = \'' . $categoryId . '\'';
  1659|         }
  1660|         if (isset($language) && Language::isASupportedLanguage($language)) {
  1661|             $query .= '
  1662|             AND
  1663|                 fd.lang = \'' . $this->config->getDb()->escape($language) . '\'';
  1664|         }
  1665|         $query .= '
  1666|                 ' . $this->queryPermission($this->groupSupport) . '
  1667|             ORDER BY
  1668|                 avg DESC';
  1669|         $result = $this->config->getDb()->query($query);
  1670|         $i = 1;
  1671|         $oldId = 0;
  1672|         while (($row = $this->config->getDb()->fetchObject($result)) && $i <= $count) {
  1673|             if ($oldId != $row->id) {
  1674|                 $data['avg'] = $row->avg;
  1675|                 $data['question'] = $row->thema;
  1676|                 $data['date'] = $row->updated;
  1677|                 $data['user'] = $row->user;
  1678|                 $title = $row->thema;
  1679|                 $url = sprintf(
  1680|                     '%sindex.php?%saction=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
  1681|                     $this->config->getDefaultUrl(),
  1682|                     $sids,
  1683|                     $row->category_id,
  1684|                     $row->id,
  1685|                     $row->lang
  1686|                 );
  1687|                 $oLink = new Link($url, $this->config);
  1688|                 $oLink->itemTitle = $row->thema;
  1689|                 $oLink->tooltip = $title;
  1690|                 $data['url'] = $oLink->toString();
  1691|                 $topten[] = $data;
  1692|                 ++$i;
  1693|             }
  1694|             $oldId = $row->id;
  1695|         }
  1696|         return $topten;
  1697|     }
  1698|     /**
  1699|      * This function generates the list with the latest published records.
  1700|      *
  1701|      * @throws Exception
  1702|      */
  1703|     public function getLatest(): array
  1704|     {
  1705|         $date = new Date($this->config);
  1706|         $result = $this->getLatestData(PMF_NUMBER_RECORDS_LATEST, $this->config->getLanguage()->getLanguage());
  1707|         $output = [];
  1708|         if (count($result) > 0) {
  1709|             foreach ($result as $row) {
  1710|                 $output['url'][] = Strings::htmlentities($row['url']);
  1711|                 $output['title'][] = Strings::htmlentities(Utils::makeShorterText($row['question'], 8));
  1712|                 $output['preview'][] = Strings::htmlentities($row['question']);
  1713|                 $output['date'][] = $date->format($row['date']);
  1714|             }
  1715|         } else {
  1716|             $output['error'] = Translation::get('err_noArticles');
  1717|         }
  1718|         return $output;
  1719|     }
  1720|     /**
  1721|      * This function generates an array with a specified number of most recent
  1722|      * published records.
  1723|      *
  1724|      * @param int    $count    Number of records
  1725|      * @param string $language Language
  1726|      */
  1727|     public function getLatestData(int $count = PMF_NUMBER_RECORDS_LATEST, $language = null): array
  1728|     {
  1729|         global $sids;
  1730|         $now = date('YmdHis');
  1731|         $query =
  1732|             '            SELECT
  1733|                 fd.id AS id,
  1734|                 fd.lang AS lang,
  1735|                 fcr.category_id AS category_id,
  1736|                 fd.thema AS question,
  1737|                 fd.content AS content,
  1738|                 fd.updated AS updated,
  1739|                 fv.visits AS visits,
  1740|                 fdg.group_id AS group_id,
  1741|                 fdu.user_id AS user_id
  1742|             FROM
  1743|                 ' . Database::getTablePrefix() . 'faqvisits fv,
  1744|                 ' . Database::getTablePrefix() . 'faqdata fd
  1745|             LEFT JOIN
  1746|                 ' . Database::getTablePrefix() . 'faqcategoryrelations fcr
  1747|             ON
  1748|                 fd.id = fcr.record_id
  1749|             AND
  1750|                 fd.lang = fcr.record_lang
  1751|             LEFT JOIN
  1752|                 ' . Database::getTablePrefix() . 'faqdata_group AS fdg
  1753|             ON
  1754|                 fd.id = fdg.record_id
  1755|             LEFT JOIN
  1756|                 ' . Database::getTablePrefix() . 'faqdata_user AS fdu
  1757|             ON
  1758|                 fd.id = fdu.record_id
  1759|             WHERE
  1760|                     fd.date_start <= \'' . $now . '\'
  1761|                 AND fd.date_end   >= \'' . $now . '\'
  1762|                 AND fd.id = fv.id
  1763|                 AND fd.lang = fv.lang
  1764|                 AND fd.active = \'yes\'';
  1765|         if (isset($language) && Language::isASupportedLanguage($language)) {
  1766|             $query .= '
  1767|             AND
  1768|                 fd.lang = \'' . $this->config->getDb()->escape($language) . '\'';
  1769|         }
  1770|         $query .= '
  1771|                 ' . $this->queryPermission($this->groupSupport) . '
  1772|             GROUP BY
  1773|                 fd.id,fd.lang,fcr.category_id,fv.visits,fdg.group_id,fdu.user_id
  1774|             ORDER BY
  1775|                 fd.updated DESC';
  1776|         $result = $this->config->getDb()->query($query);
  1777|         $latest = [];
  1778|         $data = [];
  1779|         if ($result) {
  1780|             while (($row = $this->config->getDb()->fetchObject($result))) {
  1781|                 if ($this->groupSupport) {
  1782|                     if (!in_array($row->user_id, [-1, $this->user]) || !in_array($row->group_id, $this->groups)) {
  1783|                         continue;
  1784|                     }
  1785|                 } else {
  1786|                     if (!in_array($row->user_id, [-1, $this->user])) {
  1787|                         continue;
  1788|                     }
  1789|                 }
  1790|                 $data['date'] = Date::createIsoDate($row->updated, DATE_ISO8601, true);
  1791|                 $data['question'] = Filter::filterVar($row->question, FILTER_SANITIZE_SPECIAL_CHARS);
  1792|                 $data['answer'] = $row->content;
  1793|                 $data['visits'] = (int)$row->visits;
  1794|                 $title = $row->question;
  1795|                 $url = sprintf(
  1796|                     '%sindex.php?%saction=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
  1797|                     $this->config->getDefaultUrl(),
  1798|                     $sids,
  1799|                     $row->category_id,
  1800|                     $row->id,
  1801|                     $row->lang
  1802|                 );
  1803|                 $oLink = new Link($url, $this->config);
  1804|                 $oLink->itemTitle = $title;
  1805|                 $oLink->tooltip = $title;
  1806|                 $data['url'] = $oLink->toString();
  1807|                 $latest[$row->id] = $data;
  1808|                 if (count($latest) === $count) {
  1809|                     break;
  1810|                 }
  1811|             }
  1812|         }
  1813|         return $latest;
  1814|     }
  1815|     /**
  1816|      * Retrieve faq records according to the constraints provided.
  1817|      */
  1818|     public function get(
  1819|         string $queryType = FAQ_QUERY_TYPE_DEFAULT,
  1820|         int $nCatid = 0,
  1821|         bool $bDownwards = true,
  1822|         string $lang = '',
  1823|         string $date = ''
  1824|     ): array {
  1825|         $faqs = [];
  1826|         $result = $this->config->getDb()->query($this->getSQLQuery($queryType, $nCatid, $bDownwards, $lang, $date));
  1827|         if ($this->config->getDb()->numRows($result) > 0) {
  1828|             $i = 0;
  1829|             while ($row = $this->config->getDb()->fetchObject($result)) {
  1830|                 $faq = [];
  1831|                 $faq['id'] = $row->id;
  1832|                 $faq['solution_id'] = $row->solution_id;
  1833|                 $faq['revision_id'] = $row->revision_id;
  1834|                 $faq['lang'] = $row->lang;
  1835|                 $faq['category_id'] = $row->category_id;
  1836|                 $faq['active'] = $row->active;
  1837|                 $faq['sticky'] = $row->sticky;
  1838|                 $faq['keywords'] = $row->keywords;
  1839|                 $faq['topic'] = $row->thema;
  1840|                 $faq['content'] = $row->content;
  1841|                 $faq['author_name'] = $row->author;
  1842|                 $faq['author_email'] = $row->email;
  1843|                 $faq['comment_enable'] = $row->comment;
  1844|                 $faq['lastmodified'] = $row->updated;
  1845|                 $faq['hits'] = $row->visits;
  1846|                 $faq['hits_last'] = $row->last_visit;
  1847|                 $faq['notes'] = $row->notes;
  1848|                 $faqs[$i] = $faq;
  1849|                 ++$i;
  1850|             }
  1851|         }
  1852|         return $faqs;
  1853|     }
  1854|     /**
  1855|      * Build the SQL query for retrieving faq records according to the constraints provided.
  1856|      */
  1857|     private function getSQLQuery(
  1858|         string $queryType,
  1859|         int $categoryId,
  1860|         bool $bDownwards,
  1861|         string $lang,
  1862|         string $date,
  1863|         int $faqId = 0
  1864|     ): string {
  1865|         $now = date('YmdHis');
  1866|         $query = sprintf(
  1867|             "
  1868|             SELECT
  1869|                 fd.id AS id,
  1870|                 fd.solution_id AS solution_id,
  1871|                 fd.revision_id AS revision_id,
  1872|                 fd.lang AS lang,
  1873|                 fcr.category_id AS category_id,
  1874|                 fd.active AS active,
  1875|                 fd.sticky AS sticky,
  1876|                 fd.keywords AS keywords,
  1877|                 fd.thema AS thema,
  1878|                 fd.content AS content,
  1879|                 fd.author AS author,
  1880|                 fd.email AS email,
  1881|                 fd.comment AS comment,
  1882|                 fd.updated AS updated,
  1883|                 fd.notes AS notes,
  1884|                 fv.visits AS visits,
  1885|                 fv.last_visit AS last_visit
  1886|             FROM
  1887|                 %sfaqdata fd,
  1888|                 %sfaqvisits fv,
  1889|                 %sfaqcategoryrelations fcr
  1890|             WHERE
  1891|                 fd.id = fcr.record_id
  1892|             AND
  1893|                 fd.lang = fcr.record_lang
  1894|             AND
  1895|                 fd.date_start <= '%s'
  1896|             AND
  1897|                 fd.date_end   >= '%s'
  1898|             AND ",
  1899|             Database::getTablePrefix(),
  1900|             Database::getTablePrefix(),
  1901|             Database::getTablePrefix(),
  1902|             $now,
  1903|             $now
  1904|         );
  1905|         if (!empty($faqId)) {
  1906|             $query .= "fd.id = '" . $faqId . "' AND ";
  1907|         }
  1908|         $query .= 'fd.id = fv.id
  1909|             AND
  1910|                 fd.lang = fv.lang';
  1911|         $needAndOp = true;
  1912|         if ((!empty($categoryId)) && $categoryId > 0) {
  1913|             $query .= ' AND';
  1914|             $query .= ' (fcr.category_id = ' . $categoryId;
  1915|             if ($bDownwards) {
  1916|                 $query .= $this->getCatidWhereSequence($categoryId, 'OR');
  1917|             }
  1918|             $query .= ')';
  1919|             $needAndOp = true;
  1920|         }
  1921|         if ((!empty($date)) && Utils::isLikeOnPMFDate($date)) {
  1922|             $query .= ' AND';
  1923|             $query .= " fd.updated LIKE '" . $date . "'";
  1924|             $needAndOp = true;
  1925|         }
  1926|         if ((!empty($lang)) && Utils::isLanguage($lang)) {
  1927|             $query .= ' AND';
  1928|             $query .= " fd.lang = '" . $this->config->getDb()->escape($lang) . "'";
  1929|             $needAndOp = true;
  1930|         }
  1931|         switch ($queryType) {
  1932|             case FAQ_QUERY_TYPE_APPROVAL:
  1933|                 $query .= ' AND';
  1934|                 $query .= " fd.active = '" . FAQ_SQL_ACTIVE_NO . "'";
  1935|                 break;
  1936|             case FAQ_QUERY_TYPE_EXPORT_PDF:
  1937|             case FAQ_QUERY_TYPE_EXPORT_XHTML:
  1938|             case FAQ_QUERY_TYPE_EXPORT_XML:
  1939|             default:
  1940|                 $query .= ' AND';
  1941|                 $query .= " fd.active = '" . FAQ_SQL_ACTIVE_YES . "'";
  1942|                 break;
  1943|         }
  1944|         match ($queryType) {
  1945|             FAQ_QUERY_TYPE_EXPORT_PDF,
  1946|             FAQ_QUERY_TYPE_EXPORT_XHTML,
  1947|             FAQ_QUERY_TYPE_EXPORT_XML => $query .= "\nORDER BY fcr.category_id, fd.id",
  1948|             default => $query .= "\nORDER BY fcr.category_id, fd.id",
  1949|         };
  1950|         return $query;
  1951|     }
  1952|     /**
  1953|      * Build a logic sequence, for a WHERE statement, of those category IDs
  1954|      * children of the provided category ID, if any.
  1955|      *
  1956|      * @param Category|null $oCat
  1957|      */
  1958|     private function getCatidWhereSequence(int $nCatid, string $logicOp = 'OR', Category $oCat = null): string
  1959|     {
  1960|         $sqlWhereFilter = '';
  1961|         if (!isset($oCat)) {
  1962|             $oCat = new Category($this->config);
  1963|         }
  1964|         $aChildren = array_values($oCat->getChildren($nCatid));
  1965|         foreach ($aChildren as $catid) {
  1966|             $sqlWhereFilter .= ' ' . $logicOp . ' fcr.category_id = ' . $catid;
  1967|             $sqlWhereFilter .= $this->getCatidWhereSequence($catid, 'OR', $oCat);
  1968|         }
  1969|         return $sqlWhereFilter;
  1970|     }
  1971|     /**
  1972|      * Returns all records of one category.
  1973|      *
  1974|      *
  1975|      */
  1976|     public function getRecordsWithoutPagingByCategoryId(int $categoryId): string
  1977|     {
  1978|         global $sids;
  1979|         $output = '';
  1980|         $now = date('YmdHis');
  1981|         $query = sprintf(
  1982|             "
  1983|             SELECT
  1984|                 fd.id AS id,
  1985|                 fd.lang AS lang,
  1986|                 fd.thema AS thema,
  1987|                 fcr.category_id AS category_id,
  1988|                 fv.visits AS visits
  1989|             FROM
  1990|                 %sfaqdata fd
  1991|             LEFT JOIN
  1992|                 %sfaqcategoryrelations fcr
  1993|             ON
  1994|                 fd.id = fcr.record_id
  1995|             AND
  1996|                 fd.lang = fcr.record_lang
  1997|             LEFT JOIN
  1998|                 %sfaqvisits fv
  1999|             ON
  2000|                 fd.id = fv.id
  2001|             AND
  2002|                 fv.lang = fd.lang
  2003|             LEFT JOIN
  2004|                 %sfaqdata_group fdg
  2005|             ON
  2006|                 fd.id = fdg.record_id
  2007|             LEFT JOIN
  2008|                 %sfaqdata_user fdu
  2009|             ON
  2010|                 fd.id = fdu.record_id
  2011|             WHERE
  2012|                 fd.date_start <= '%s'
  2013|             AND
  2014|                 fd.date_end   >= '%s'
  2015|             AND
  2016|                 fd.active = 'yes'
  2017|             AND
  2018|                 fcr.category_id = %d
  2019|             AND
  2020|                 fd.lang = '%s'
  2021|                 %s
  2022|             GROUP BY
  2023|                 fd.id,fd.lang,fd.thema,fcr.category_id,fv.visits
  2024|             ORDER BY
  2025|                 %s %s",
  2026|             Database::getTablePrefix(),
  2027|             Database::getTablePrefix(),
  2028|             Database::getTablePrefix(),
  2029|             Database::getTablePrefix(),
  2030|             Database::getTablePrefix(),
  2031|             $now,
  2032|             $now,
  2033|             $categoryId,
  2034|             $this->config->getLanguage()->getLanguage(),
  2035|             $this->queryPermission($this->groupSupport),
  2036|             $this->config->get('records.orderby'),
  2037|             $this->config->get('records.sortby')
  2038|         );
  2039|         $result = $this->config->getDb()->query($query);
  2040|         if ($result) {
  2041|             $output = '<ul>';
  2042|             while (($row = $this->config->getDb()->fetchObject($result))) {
  2043|                 $title = $row->thema;
  2044|                 $url = sprintf(
  2045|                     '%sindex.php?%saction=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
  2046|                     $this->config->getDefaultUrl(),
  2047|                     $sids,
  2048|                     $row->category_id,
  2049|                     $row->id,
  2050|                     $row->lang
  2051|                 );
  2052|                 $oLink = new Link($url, $this->config);
  2053|                 $oLink->itemTitle = $row->thema;
  2054|                 $oLink->text = $title;
  2055|                 $oLink->tooltip = $title;
  2056|                 $listItem = '<li>' . $oLink->toHtmlAnchor() . '</li>';
  2057|                 $output .= $listItem;
  2058|             }
  2059|             $output .= '</ul>';
  2060|         }
  2061|         return $output;
  2062|     }
  2063|     /**
  2064|      * Prints the open questions as a HTML table.
  2065|      *
  2066|      * @todo   needs to be moved to a QuestionHelper class
  2067|      * @throws Exception
  2068|      */
  2069|     public function renderOpenQuestions(): string
  2070|     {
  2071|         global $sids, $category;
  2072|         $date = new Date($this->config);
  2073|         $mail = new Mail($this->config);
  2074|         $query = sprintf(
  2075|             "SELECT COUNT(id) AS num FROM %sfaqquestions WHERE lang = '%s' AND is_visible != 'Y'",
  2076|             Database::getTablePrefix(),
  2077|             $this->config->getLanguage()->getLanguage()
  2078|         );
  2079|         $result = $this->config->getDb()->query($query);
  2080|         $row = $this->config->getDb()->fetchObject($result);
  2081|         $numOfInvisibles = $row->num;
  2082|         if ($numOfInvisibles > 0) {
  2083|             $extraout = sprintf(
  2084|                 '<tr><td colspan="3"><small>%s %s</small></td></tr>',
  2085|                 Translation::get('msgQuestionsWaiting'),
  2086|                 $numOfInvisibles
  2087|             );
  2088|         } else {
  2089|             $extraout = '';
  2090|         }
  2091|         $query = sprintf(
  2092|             "SELECT * FROM %sfaqquestions WHERE lang = '%s' AND is_visible = 'Y' ORDER BY created ASC",
  2093|             Database::getTablePrefix(),
  2094|             $this->config->getLanguage()->getLanguage()
  2095|         );
  2096|         $result = $this->config->getDb()->query($query);
  2097|         $output = '';
  2098|         if ($result && $this->config->getDb()->numRows($result) > 0) {
  2099|             while ($row = $this->config->getDb()->fetchObject($result)) {
  2100|                 $output .= '<tr class="openquestions">';
  2101|                 $output .= sprintf(
  2102|                     '<td><small>%s</small><br><a href="mailto:%s">%s</a></td>',
  2103|                     $date->format(Date::createIsoDate($row->created)),
  2104|                     $mail->safeEmail($row->email),
  2105|                     Strings::htmlentities($row->username)
  2106|                 );
  2107|                 $output .= sprintf(
  2108|                     '<td><strong>%s:</strong><br>%s</td>',
  2109|                     isset($category->categoryName[$row->category_id]['name']) ?
  2110|                         Strings::htmlentities($category->categoryName[$row->category_id]['name']) :
  2111|                         '',
  2112|                     Strings::htmlentities($row->question)
  2113|                 );
  2114|                 if ($this->config->get('records.enableCloseQuestion') && $row->answer_id) {
  2115|                     $output .= sprintf(
  2116|                         '<td><a id="PMF_openQuestionAnswered" href="?%saction=faq&amp;cat=%d&amp;id=%d">%s</a></td>',
  2117|                         $sids,
  2118|                         $row->category_id,
  2119|                         $row->answer_id,
  2120|                         Translation::get('msg2answerFAQ')
  2121|                     );
  2122|                 } else {
  2123|                     $output .= sprintf(
  2124|                         '<td class="text-end">' .
  2125|                         '<a class="btn btn-primary" href="?%saction=add&amp;question=%d&amp;cat=%d">%s</a></td>',
  2126|                         $sids,
  2127|                         $row->id,
  2128|                         $row->category_id,
  2129|                         Translation::get('msg2answer')
  2130|                     );
  2131|                 }
  2132|                 $output .= '</tr>';
  2133|             }
  2134|         } else {
  2135|             $output = sprintf(
  2136|                 '<tr><td colspan="3">%s</td></tr>',
  2137|                 Translation::get('msgNoQuestionsAvailable')
  2138|             );
  2139|         }
  2140|         return $output . $extraout;
  2141|     }
  2142|     /**
  2143|      * Set or unset a faq item flag.
  2144|      *
  2145|      * @param int    $faqId       FAQ id
  2146|      * @param string $faqLanguage Language code which is valid with Language::isASupportedLanguage
  2147|      * @param bool   $flag        FAQ is set to sticky or not
  2148|      * @param string $type        Type of the flag to set, use the column name
  2149|      */
  2150|     public function updateRecordFlag(int $faqId, string $faqLanguage, bool $flag, string $type): bool
  2151|     {
  2152|         $flag = match ($type) {
  2153|             'sticky' => $flag ? 1 : 0,
  2154|             'active' => $flag ? "'yes'" : "'no'",
  2155|             default => null,
  2156|         };
  2157|         if (null !== $flag) {
  2158|             $update = sprintf(
  2159|                 "
  2160|                 UPDATE 
  2161|                     %sfaqdata 
  2162|                 SET 
  2163|                     %s = %s 
  2164|                 WHERE 
  2165|                     id = %d 
  2166|                 AND 
  2167|                     lang = '%s'",
  2168|                 Database::getTablePrefix(),
  2169|                 $type,
  2170|                 $flag,
  2171|                 $faqId,
  2172|                 $this->config->getDb()->escape($faqLanguage)
  2173|             );
  2174|             return (bool)$this->config->getDb()->query($update);
  2175|         }
  2176|         return false;
  2177|     }
  2178|     /**
  2179|      * Prepares and returns the sticky records for the frontend.
  2180|      */
  2181|     public function getStickyRecords(): array
  2182|     {
  2183|         $result = $this->getStickyRecordsData();
  2184|         $output = [];
  2185|         if (count($result) > 0) {
  2186|             foreach ($result as $row) {
  2187|                 $output['title'][] = Utils::makeShorterText(Strings::htmlentities($row['question']), 8);
  2188|                 $output['preview'][] = Strings::htmlentities($row['question']);
  2189|                 $output['url'][] = Strings::htmlentities($row['url']);
  2190|             }
  2191|         } else {
  2192|             $output['error'] = sprintf('<li>%s</li>', Translation::get('err_noTopTen'));
  2193|         }
  2194|         return $output;
  2195|     }
  2196|     /**
  2197|      * Returns the sticky records with URL and Title.
  2198|      */
  2199|     public function getStickyRecordsData(): array
  2200|     {
  2201|         global $sids;
  2202|         $now = date('YmdHis');
  2203|         $query = sprintf(
  2204|             "
  2205|             SELECT
  2206|                 fd.id AS id,
  2207|                 fd.lang AS lang,
  2208|                 fd.thema AS thema,
  2209|                 fcr.category_id AS category_id,
  2210|                 fv.visits AS visits
  2211|             FROM
  2212|                 %sfaqvisits fv,
  2213|                 %sfaqdata fd
  2214|             LEFT JOIN
  2215|                 %sfaqcategoryrelations fcr
  2216|             ON
  2217|                 fd.id = fcr.record_id
  2218|             AND
  2219|                 fd.lang = fcr.record_lang
  2220|             LEFT JOIN
  2221|                 %sfaqdata_group AS fdg
  2222|             ON
  2223|                 fd.id = fdg.record_id
  2224|             LEFT JOIN
  2225|                 %sfaqdata_user AS fdu
  2226|             ON
  2227|                 fd.id = fdu.record_id
  2228|             WHERE
  2229|                 fd.lang = '%s'
  2230|             AND 
  2231|                 fd.date_start <= '%s'
  2232|             AND 
  2233|                 fd.date_end   >= '%s'
  2234|             AND 
  2235|                 fd.active = 'yes'
  2236|             AND 
  2237|                 fd.sticky = 1
  2238|             AND
  2239|                 fd.id = fv.id
  2240|             AND 
  2241|                 fd.lang = fv.lang
  2242|             %s
  2243|             GROUP BY
  2244|                 fd.id, fd.lang, fd.thema, fcr.category_id, fv.visits
  2245|             ORDER BY
  2246|                 fv.visits DESC",
  2247|             Database::getTablePrefix(),
  2248|             Database::getTablePrefix(),
  2249|             Database::getTablePrefix(),
  2250|             Database::getTablePrefix(),
  2251|             Database::getTablePrefix(),
  2252|             $this->config->getLanguage()->getLanguage(),
  2253|             $now,
  2254|             $now,
  2255|             $this->queryPermission($this->groupSupport)
  2256|         );
  2257|         $result = $this->config->getDb()->query($query);
  2258|         $sticky = [];
  2259|         $data = [];
  2260|         $oldId = 0;
  2261|         while (($row = $this->config->getDb()->fetchObject($result))) {
  2262|             if ($oldId != $row->id) {
  2263|                 $data['question'] = $row->thema;
  2264|                 $title = $row->thema;
  2265|                 $url = sprintf(
  2266|                     '%sindex.php?%saction=faq&amp;cat=%d&amp;id=%d&amp;artlang=%s',
  2267|                     $this->config->getDefaultUrl(),
  2268|                     $sids,
  2269|                     $row->category_id,
  2270|                     $row->id,
  2271|                     $row->lang
  2272|                 );
  2273|                 $oLink = new Link($url, $this->config);
  2274|                 $oLink->itemTitle = $row->thema;
  2275|                 $oLink->tooltip = $title;
  2276|                 $data['url'] = $oLink->toString();
  2277|                 $sticky[] = $data;
  2278|             }
  2279|             $oldId = $row->id;
  2280|         }
  2281|         return $sticky;
  2282|     }
  2283|     /**
  2284|      * Returns the inactive records with admin URL to edit the FAQ and title.
  2285|      */
  2286|     public function getInactiveFaqsData(): array
  2287|     {
  2288|         $query = sprintf(
  2289|             "
  2290|             SELECT
  2291|                 fd.id AS id,
  2292|                 fd.lang AS lang,
  2293|                 fd.thema AS thema
  2294|             FROM
  2295|                 %sfaqdata fd
  2296|             WHERE
  2297|                 fd.lang = '%s'
  2298|             AND 
  2299|                 fd.active = 'no'
  2300|             GROUP BY
  2301|                 fd.id, fd.lang, fd.thema
  2302|             ORDER BY
  2303|                 fd.id DESC",
  2304|             Database::getTablePrefix(),
  2305|             $this->config->getLanguage()->getLanguage()
  2306|         );
  2307|         $result = $this->config->getDb()->query($query);
  2308|         $inactive = [];
  2309|         $data = [];
  2310|         $oldId = 0;
  2311|         while (($row = $this->config->getDb()->fetchObject($result))) {
  2312|             if ($oldId != $row->id) {
  2313|                 $data['question'] = $row->thema;
  2314|                 $data['url'] = sprintf(
  2315|                     '%sadmin/?action=editentry&id=%d&lang=%s',
  2316|                     $this->config->getDefaultUrl(),
  2317|                     $row->id,
  2318|                     $row->lang
  2319|                 );
  2320|                 $inactive[] = $data;
  2321|             }
  2322|             $oldId = $row->id;
  2323|         }
  2324|         return $inactive;
  2325|     }
  2326| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Faq/FaqPermission.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-140 ---
     1| <?php
     2| /**
     3|  * FAQ permissions class for phpMyFAQ.
     4|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     5|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     6|  * obtain one at https://mozilla.org/MPL/2.0/.
     7|  *
     8|  * @package   phpMyFAQ
     9|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    10|  * @copyright 2020-2023 phpMyFAQ Team
    11|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    12|  * @link      https://www.phpmyfaq.de
    13|  * @since     2020-11-04
    14|  */
    15| namespace phpMyFAQ\Faq;
    16| use phpMyFAQ\Configuration;
    17| use phpMyFAQ\Database;
    18| use phpMyFAQ\Filter;
    19| /**
    20|  * Class FaqPermission
    21|  *
    22|  * @package phpMyFAQ\Faq
    23|  */
    24| class FaqPermission
    25| {
    26|     /** @var string */
    27|     final public const USER = 'user';
    28|     /** @var string */
    29|     final public const GROUP = 'group';
    30|     /**
    31|      * FaqPermission constructor.
    32|      */
    33|     public function __construct(private readonly Configuration $config)
    34|     {
    35|     }
    36|     /**
    37|      * Adds the record permissions for users and groups.
    38|      *
    39|      * @param string $mode 'group' or 'user'
    40|      * @param int    $faqId ID of the current record
    41|      * @param int[]  $ids Array of group or user IDs
    42|      */
    43|     public function add(string $mode, int $faqId, array $ids): bool
    44|     {
    45|         if (self::USER !== $mode && self::GROUP !== $mode) {
    46|             return false;
    47|         }
    48|         foreach ($ids as $id) {
    49|             $query = sprintf(
    50|                 'INSERT INTO %sfaqdata_%s (record_id, %s_id) VALUES (%d, %d)',
    51|                 Database::getTablePrefix(),
    52|                 $mode,
    53|                 $mode,
    54|                 $faqId,
    55|                 $id
    56|             );
    57|             $this->config->getDb()->query($query);
    58|         }
    59|         return true;
    60|     }
    61|     /**
    62|      * Deletes the record permissions for users and groups.
    63|      *
    64|      * @param string $mode 'group' or 'user'
    65|      * @param int    $faqId ID of the current record
    66|      */
    67|     public function delete(string $mode, int $faqId): bool
    68|     {
    69|         if (self::USER !== $mode && self::GROUP !== $mode) {
    70|             return false;
    71|         }
    72|         $query = sprintf(
    73|             'DELETE FROM %sfaqdata_%s WHERE record_id = %d',
    74|             Database::getTablePrefix(),
    75|             $mode,
    76|             $faqId
    77|         );
    78|         return (bool) $this->config->getDb()->query($query);
    79|     }
    80|     /**
    81|      * Returns the record permissions for users and groups.
    82|      *
    83|      * @param string $mode 'group' or 'user'
    84|      */
    85|     public function get(string $mode, int $faqId): array
    86|     {
    87|         $permissions = [];
    88|         if (self::USER !== $mode && self::GROUP !== $mode) {
    89|             return $permissions;
    90|         }
    91|         if (0 === $faqId) {
    92|             return [-1];
    93|         }
    94|         $query = sprintf(
    95|             'SELECT %s_id AS permission FROM %sfaqdata_%s WHERE record_id = %d',
    96|             $mode,
    97|             Database::getTablePrefix(),
    98|             $mode,
    99|             $faqId
   100|         );
   101|         $result = $this->config->getDb()->query($query);
   102|         if ($this->config->getDb()->numRows($result) > 0) {
   103|             while (($row = $this->config->getDb()->fetchObject($result))) {
   104|                 $permissions[] = (int)$row->permission;
   105|             }
   106|         }
   107|         return $permissions;
   108|     }
   109|     public function createPermissionArray(): array
   110|     {
   111|         $permissions = [];
   112|         if ('all' === Filter::filterInput(INPUT_POST, 'userpermission', FILTER_SANITIZE_SPECIAL_CHARS)) {
   113|             $permissions += [
   114|                 'restricted_user' => [-1],
   115|             ];
   116|         } else {
   117|             $permissions += [
   118|                 'restricted_user' => [
   119|                     Filter::filterInput(INPUT_POST, 'restricted_users', FILTER_VALIDATE_INT),
   120|                 ],
   121|             ];
   122|         }
   123|         if ('all' === Filter::filterInput(INPUT_POST, 'grouppermission', FILTER_SANITIZE_SPECIAL_CHARS)) {
   124|             $permissions += [
   125|                 'restricted_groups' => [-1],
   126|             ];
   127|         } else {
   128|             $permissions += Filter::filterInputArray(
   129|                 INPUT_POST,
   130|                 [
   131|                     'restricted_groups' => [
   132|                         'filter' => FILTER_VALIDATE_INT,
   133|                         'flags' => FILTER_REQUIRE_ARRAY,
   134|                     ],
   135|                 ]
   136|             );
   137|         }
   138|         return $permissions;
   139|     }
   140| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Ldap.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-265 ---
     1| <?php
     2| /**
     3|  * The Ldap class provides methods and functions for LDAP and/or Active Directory.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Adam Greene <phpmyfaq@skippy.fastmail.fm>
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @author    Alberto Cabello Sanchez <alberto@unex.es>
    13|  * @author    Lars Scheithauer <larsscheithauer@googlemail.com>
    14|  * @copyright 2004-2023 phpMyFAQ Team
    15|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    16|  * @link      https://www.phpmyfaq.de
    17|  * @since     2004-12-16
    18|  */
    19| namespace phpMyFAQ;
    20| use LDAP\Connection;
    21| /**
    22|  * Class Ldap
    23|  *
    24|  * @package phpMyFAQ
    25|  */
    26| class Ldap
    27| {
    28|     /**
    29|      * Error.
    30|      */
    31|     public ?string $error = null;
    32|     /**
    33|      * LDAP error number.
    34|      */
    35|     public ?int $errno = null;
    36|     private readonly array $ldapConfig;
    37|     /**
    38|      * An LDAP link identifier, returned by ldap_connect()
    39|      *
    40|      * @var resource|false
    41|      */
    42|     private Connection|bool|null $ds = null;
    43|     /**
    44|      * The LDAP base.
    45|      */
    46|     private ?string $base = null;
    47|     /**
    48|      * Constructor.
    49|      */
    50|     public function __construct(private readonly Configuration $config)
    51|     {
    52|         $this->ldapConfig = $this->config->getLdapConfig();
    53|     }
    54|     /**
    55|      * Connects to given LDAP server with given credentials.
    56|      */
    57|     public function connect(
    58|         string $ldapServer,
    59|         int $ldapPort,
    60|         string $ldapBase,
    61|         string $ldapUser = '',
    62|         string $ldapPassword = ''
    63|     ): bool {
    64|         if ('' === $ldapServer || '' === $ldapBase) {
    65|             return false;
    66|         }
    67|         $this->base = $ldapBase;
    68|         $this->ds = ldap_connect($ldapServer . ':' . $ldapPort);
    69|         if (!$this->ds) {
    70|             $this->error = 'Unable to connect to LDAP server';
    71|             return false;
    72|         }
    73|         foreach ($this->config->getLdapOptions() as $key => $value) {
    74|             if (!ldap_set_option($this->ds, constant($key), $value)) {
    75|                 $this->errno = ldap_errno($this->ds);
    76|                 $this->error = sprintf(
    77|                     'Unable to set LDAP option "%s" to "%s" (Error: %s).',
    78|                     $key,
    79|                     $value,
    80|                     ldap_error($this->ds)
    81|                 );
    82|                 return false;
    83|             }
    84|         }
    85|         if ($this->config->get('ldap.ldap_use_dynamic_login')) {
    86|             $ldapRdn = $this->config->get('ldap.ldap_dynamic_login_attribute') . '=' . $ldapUser . ',' . $ldapBase;
    87|             $ldapBind = $this->bind($ldapRdn, $ldapPassword);
    88|         } elseif ($this->config->get('ldap.ldap_use_anonymous_login')) {
    89|             $ldapBind = $this->bind();
    90|         } else {
    91|             $ldapBind = $this->bind($ldapUser, $ldapPassword);
    92|         }
    93|         if (false === $ldapBind) {
    94|             $this->errno = ldap_errno($this->ds);
    95|             $this->error = sprintf(
    96|                 'Unable to bind to LDAP server (Error: %s).',
    97|                 ldap_error($this->ds)
    98|             );
    99|             $this->ds = false;
   100|             return false;
   101|         }
   102|         return true;
   103|     }
   104|     /**
   105|      * Binds to the LDAP directory with specified RDN and password.
   106|      */
   107|     public function bind(string $rdn = '', string $password = ''): bool
   108|     {
   109|         if ($this->ds === false) {
   110|             $this->error = 'The LDAP connection handler is not a valid resource.';
   111|             return false;
   112|         }
   113|         if ('' === $rdn && '' === $password) {
   114|             return ldap_bind($this->ds);
   115|         } else {
   116|             return ldap_bind($this->ds, $rdn, $password);
   117|         }
   118|     }
   119|     /**
   120|      * Returns the user's email address from LDAP.
   121|      *
   122|      * @param string $username Username
   123|      */
   124|     public function getMail(string $username): bool|string
   125|     {
   126|         return $this->getLdapData($username, 'mail');
   127|     }
   128|     /**
   129|      * Returns specific data from LDAP.
   130|      *
   131|      * @param string $username Username
   132|      * @param string $data     MapKey
   133|      */
   134|     private function getLdapData(string $username, string $data): bool|string
   135|     {
   136|         if ($this->ds === false) {
   137|             $this->error = 'The LDAP connection handler is not a valid resource.';
   138|             return false;
   139|         }
   140|         if (!array_key_exists($data, $this->ldapConfig['ldap_mapping'])) {
   141|             $this->error = sprintf(
   142|                 'The requested data field "%s" does not exist in LDAP mapping configuration.',
   143|                 $data
   144|             );
   145|             return false;
   146|         }
   147|         $filter = sprintf(
   148|             '(%s=%s)',
   149|             $this->config->get('ldap.ldap_mapping.username'),
   150|             $this->quote($username)
   151|         );
   152|         if ($this->config->get('ldap.ldap_use_memberOf')) {
   153|             $filter = sprintf(
   154|                 '(&%s(memberOf:1.2.840.113556.1.4.1941:=%s))',
   155|                 $filter,
   156|                 $this->config->get('ldap.ldap_mapping.memberOf')
   157|             );
   158|         }
   159|         $fields = [$this->ldapConfig['ldap_mapping'][$data]];
   160|         $searchResult = ldap_search($this->ds, $this->base, $filter, $fields);
   161|         if (!$searchResult) {
   162|             $this->errno = ldap_errno($this->ds);
   163|             $this->error = sprintf(
   164|                 'Unable to search for "%s" (Error: %s)',
   165|                 $username,
   166|                 ldap_error($this->ds)
   167|             );
   168|             return false;
   169|         }
   170|         $entryId = ldap_first_entry($this->ds, $searchResult);
   171|         if (!$entryId) {
   172|             $this->errno = ldap_errno($this->ds);
   173|             $this->error = sprintf(
   174|                 'Cannot get the value(s). Error: %s',
   175|                 ldap_error($this->ds)
   176|             );
   177|             return false;
   178|         }
   179|         $entries = ldap_get_entries($this->ds, $searchResult);
   180|         for ($i = 0; $i < $entries['count']; $i++) {
   181|             if (isset($entries[$i][$fields[0]][0])) {
   182|                 return $entries[$i][$fields[0]][0];
   183|             }
   184|         }
   185|         return false;
   186|     }
   187|     /**
   188|      * Quotes LDAP strings in accordance with the RFC 2254.
   189|      */
   190|     public function quote(string $string): string
   191|     {
   192|         return str_replace(
   193|             ['\\', ' ', '*', '(', ')'],
   194|             ['\\5c', '\\20', '\\2a', '\\28', '\\29'],
   195|             $string
   196|         );
   197|     }
   198|     /**
   199|      * Returns the user's DN.
   200|      *
   201|      * @param string $username Username
   202|      */
   203|     public function getDn(string $username): bool|string
   204|     {
   205|         return $this->getLdapDn($username);
   206|     }
   207|     /**
   208|      * Returns the DN from LDAP.
   209|      *
   210|      * @param string $username Username
   211|      */
   212|     private function getLdapDn(string $username): string|false
   213|     {
   214|         if ($this->ds === false) {
   215|             $this->error = 'The LDAP connection handler is not a valid resource.';
   216|             return false;
   217|         }
   218|         $filter = sprintf(
   219|             '(%s=%s)',
   220|             $this->config->get('ldap.ldap_mapping.username'),
   221|             $this->quote($username)
   222|         );
   223|         $sr = ldap_search($this->ds, $this->base, $filter);
   224|         if (false === $sr) {
   225|             $this->errno = ldap_errno($this->ds);
   226|             $this->error = sprintf(
   227|                 'Unable to search for "%s" (Error: %s)',
   228|                 $username,
   229|                 ldap_error($this->ds)
   230|             );
   231|             return false;
   232|         }
   233|         $entryId = ldap_first_entry($this->ds, $sr);
   234|         if (false === $entryId) {
   235|             $this->errno = ldap_errno($this->ds);
   236|             $this->error = sprintf(
   237|                 'Cannot get the value(s). Error: %s',
   238|                 ldap_error($this->ds)
   239|             );
   240|             return false;
   241|         }
   242|         return ldap_get_dn($this->ds, $entryId);
   243|     }
   244|     /**
   245|      * Returns the user's full name from LDAP.
   246|      *
   247|      * @param string $username Username
   248|      */
   249|     public function getCompleteName(string $username): bool|string
   250|     {
   251|         return $this->getLdapData($username, 'name');
   252|     }
   253|     /**
   254|      * Returns the LDAP error message of the last LDAP command.
   255|      *
   256|      * @param resource $ds LDAP resource
   257|      */
   258|     public function error($ds = null): string
   259|     {
   260|         if ($ds === null) {
   261|             $ds = $this->ds;
   262|         }
   263|         return ldap_error($ds);
   264|     }
   265| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Mail/SMTP.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-71 ---
     1| <?php
     2| /**
     3|  * MUA (Mail User Agent) implementation using the Symfony Mailer class.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2022-2023 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2022-01-23
    15|  */
    16| namespace phpMyFAQ\Mail;
    17| use Symfony\Component\Mailer\Exception\TransportExceptionInterface;
    18| use Symfony\Component\Mailer\Mailer;
    19| use Symfony\Component\Mailer\MailerInterface;
    20| use Symfony\Component\Mailer\Transport;
    21| use Symfony\Component\Mime\Email;
    22| /**
    23|  * Class SMTP
    24|  */
    25| class SMTP implements MailUserAgentInterface
    26| {
    27|     private string $user;
    28|     private MailerInterface $mailer;
    29|     public function setAuthConfig(
    30|         string $server,
    31|         string $user = '',
    32|         string $password = '',
    33|         int $port = 25,
    34|         bool $disableTlsPeerVerification = false
    35|     ): void {
    36|         $dsn = sprintf('smtp://%s:%s@%s:%d', $this->user = $user, urlencode($password), $server, $port);
    37|         if ($disableTlsPeerVerification) {
    38|             $dsn .= '?verify_peer=0';
    39|         }
    40|         $this->mailer = new Mailer(Transport::fromDsn($dsn));
    41|     }
    42|     /**
    43|      * @param string[] $headers
    44|      * @throws TransportExceptionInterface
    45|      */
    46|     public function send(string $recipients, array $headers, string $body): int
    47|     {
    48|         $sender = '';
    49|         if (('WIN' !== strtoupper(substr(PHP_OS, 0, 3))) && !ini_get('safe_mode')) {
    50|             $sender = str_replace(['<', '>'], '', $headers['Return-Path']);
    51|             unset($headers['Return-Path']);
    52|         }
    53|         $email = (new Email())
    54|             ->from(empty($sender) ? $this->user : $sender)
    55|             ->to($recipients)
    56|             ->subject($headers['Subject'])
    57|             ->text($body)
    58|             ->html($body);
    59|         if (isset($headers['CC'])) {
    60|             $email->cc($headers['CC']);
    61|         }
    62|         if (isset($headers['Bcc'])) {
    63|             $email->bcc($headers['Bcc']);
    64|         }
    65|         if (isset($headers['Reply-To'])) {
    66|             $email->replyTo($headers['Reply-To']);
    67|         }
    68|         $this->mailer->send($email);
    69|         return 1;
    70|     }
    71| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/System.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-369 ---
     1| <?php
     2| /**
     3|  * Class for checking system requirements.
     4|  *
     5|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     6|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     7|  * obtain one at https://mozilla.org/MPL/2.0/.
     8|  *
     9|  * @package   phpMyFAQ
    10|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    11|  * @copyright 2010-2023 phpMyFAQ Team
    12|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    13|  * @link      https://www.phpmyfaq.de
    14|  * @since     2010-01-13
    15|  */
    16| namespace phpMyFAQ;
    17| use DateTime;
    18| use DirectoryIterator;
    19| use Exception;
    20| use phpMyFAQ\Database\DatabaseDriver;
    21| use RecursiveDirectoryIterator;
    22| use RecursiveIteratorIterator;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use UnexpectedValueException;
    25| /**
    26|  * Class System
    27|  *
    28|  * @package phpMyFAQ
    29|  */
    30| class System
    31| {
    32|     /**
    33|      * Major version.
    34|      */
    35|     private const VERSION_MAJOR = 3;
    36|     /**
    37|      * Minor version.
    38|      */
    39|     private const VERSION_MINOR = 2;
    40|     /**
    41|      * Patch level.
    42|      */
    43|     private const VERSION_PATCH_LEVEL = 10;
    44|     /**
    45|      * Pre-release version.
    46|      */
    47|     private const VERSION_PRE_RELEASE = '';
    48|     /**
    49|      * API version.
    50|      */
    51|     private const VERSION_API = '2.2';
    52|     /**
    53|      * Minimum required PHP version.
    54|      */
    55|     final public const VERSION_MINIMUM_PHP = '8.1.0';
    56|     /**
    57|      * phpMyFAQ homepage URL
    58|      */
    59|     final public const PHPMYFAQ_URL = 'https://www.phpmyfaq.de/';
    60|     /**
    61|      * Array of required PHP extensions.
    62|      *
    63|      * @var array<string>
    64|      */
    65|     private array $requiredExtensions = [
    66|         'curl',
    67|         'fileinfo',
    68|         'filter',
    69|         'gd',
    70|         'json',
    71|         'sodium',
    72|         'xml',
    73|         'zip',
    74|     ];
    75|     /**
    76|      * Array of missing PHP extensions.
    77|      *
    78|      * @var array<string>
    79|      */
    80|     private array $missingExtensions = [];
    81|     /**
    82|      * Supported databases for phpMyFAQ.
    83|      *
    84|      * @var array<string, array<int, string>>
    85|      */
    86|     private array $supportedDatabases = [
    87|         'mysqli' => [
    88|             self::VERSION_MINIMUM_PHP,
    89|             'MySQL v8 / MariaDB v10 / Percona Server v8 / Galera Cluster v4 for MySQL'
    90|         ],
    91|         'pgsql' => [
    92|             self::VERSION_MINIMUM_PHP,
    93|             'PostgreSQL v10 or later'
    94|         ],
    95|         'sqlite3' => [
    96|             self::VERSION_MINIMUM_PHP,
    97|             'SQLite 3'
    98|         ],
    99|         'sqlsrv' => [
   100|             self::VERSION_MINIMUM_PHP,
   101|             'MS SQL Server 2016 or later'
   102|         ]
   103|     ];
   104|     /**
   105|      * Database handle.
   106|      */
   107|     private ?DatabaseDriver $database = null;
   108|     /**
   109|      * Returns the current version of phpMyFAQ for installation and
   110|      * version in the database.
   111|      * Releases will be numbered with the follow format:
   112|      * <major>.<minor>.<patch>[-<prerelease>]
   113|      */
   114|     public static function getVersion(): string
   115|     {
   116|         $version = sprintf('%d.%d.%d', self::VERSION_MAJOR, self::VERSION_MINOR, self::VERSION_PATCH_LEVEL);
   117|         return $version . (self::isDevelopmentVersion() ? '-' . self::VERSION_PRE_RELEASE : '');
   118|     }
   119|     /**
   120|      * Returns the current API version of phpMyFAQ for installation and
   121|      * version in the database.
   122|      */
   123|     public static function getApiVersion(): string
   124|     {
   125|         return self::VERSION_API;
   126|     }
   127|     public static function getPoweredByString(bool $withLink = false): string
   128|     {
   129|         if ($withLink) {
   130|             return sprintf(
   131|                 'powered with  and  by <a class="%s" target="_blank" href="%s">phpMyFAQ</a> %s',
   132|                 'link-light text-decoration-none',
   133|                 self::PHPMYFAQ_URL,
   134|                 self::getVersion()
   135|             );
   136|         } else {
   137|             return sprintf('powered with  and  by phpMyFAQ %s', self::getVersion());
   138|         }
   139|     }
   140|     /**
   141|      * Returns the URL of the documentation
   142|      * @return string
   143|      */
   144|     public static function getDocumentationUrl(): string
   145|     {
   146|         return sprintf('%sdocs/%s', self::PHPMYFAQ_URL, substr(self::getVersion(), 0, 3));
   147|     }
   148|     /**
   149|      * Returns true or false on SQLite3.
   150|      *
   151|      * @static
   152|      */
   153|     public static function isSqlite(string $dbType): bool
   154|     {
   155|         return 'sqlite3' === $dbType;
   156|     }
   157|     public static function isDevelopmentVersion(): bool
   158|     {
   159|         return strlen(self::VERSION_PRE_RELEASE) > 0;
   160|     }
   161|     /**
   162|      * Print out the HTML5 Footer.
   163|      */
   164|     public static function renderFooter(bool $onePageBack = false): never
   165|     {
   166|         if (true === $onePageBack) {
   167|             printf(
   168|                 '<p><a href="./index.php">%s</a></p>',
   169|                 'Back to the Setup page'
   170|             );
   171|         }
   172|         printf(
   173|             '</div></section></main><footer class="setup-footer container"><p class="text-end">%s</p></footer>' .
   174|             '</body></html>',
   175|             '&copy; 2001-2023 <a target="_blank" href="https://www.phpmyfaq.de/">phpMyFAQ Team</a>'
   176|         );
   177|         exit();
   178|     }
   179|     public function getDatabase(): ?DatabaseDriver
   180|     {
   181|         return $this->database;
   182|     }
   183|     public function setDatabase(DatabaseDriver $database): System
   184|     {
   185|         $this->database = $database;
   186|         return $this;
   187|     }
   188|     /**
   189|      * Returns all available templates as array.
   190|      *
   191|      * @return array<string, bool>
   192|      */
   193|     public function getAvailableTemplates(): array
   194|     {
   195|         $templates = [];
   196|         foreach (new DirectoryIterator(PMF_ROOT_DIR . '/assets/themes/') as $item) {
   197|             $basename = $item->getBasename();
   198|             if (!$item->isDot() && $item->isDir()) {
   199|                 $templates[$basename] = Template::getTplSetName() === $basename;
   200|             }
   201|         }
   202|         return $templates;
   203|     }
   204|     /**
   205|      * Returns the locally supported databases.
   206|      *
   207|      * @return array<string, string>
   208|      */
   209|     public function getSupportedSafeDatabases(bool $returnAsHtml = false): array
   210|     {
   211|         $retVal = [];
   212|         foreach ($this->getSupportedDatabases() as $extension => $database) {
   213|             if (extension_loaded($extension) && version_compare(PHP_VERSION, $database[0]) >= 0) {
   214|                 if ($returnAsHtml) {
   215|                     $retVal[] = sprintf('<option value="%s">%s</option>', $extension, $database[1]);
   216|                 } else {
   217|                     $retVal[$extension] = $database;
   218|                 }
   219|             }
   220|         }
   221|         return $retVal;
   222|     }
   223|     /**
   224|      * Returns the supported databases.
   225|      *
   226|      * @return array<string, array<int, string>>
   227|      */
   228|     public function getSupportedDatabases(): array
   229|     {
   230|         return $this->supportedDatabases;
   231|     }
   232|     /**
   233|      * Checks if the system URI is running with http or https.
   234|      */
   235|     public function getSystemUri(Configuration $faqConfig): string
   236|     {
   237|         $mainUrl = $faqConfig->getDefaultUrl();
   238|         if (isset($_ENV['REQUEST_SCHEME']) && 'https' === $_ENV['REQUEST_SCHEME']) {
   239|             if (!str_contains($mainUrl, 'https')) {
   240|                 $mainUrl = str_replace('http://', 'https://', $mainUrl);
   241|             }
   242|         }
   243|         if (!str_ends_with($mainUrl, '/')) {
   244|             $mainUrl .= '/';
   245|         }
   246|         return $mainUrl;
   247|     }
   248|     /**
   249|      * Returns true, if phpMyFAQ is running on HTTPS
   250|      */
   251|     public function getHttpsStatus(): bool
   252|     {
   253|         return Request::createFromGlobals()->isSecure();
   254|     }
   255|     /**
   256|      * Checks for installed database extensions, if the first supported
   257|      * extension is enabled, return true.
   258|      */
   259|     public function checkDatabase(): bool
   260|     {
   261|         foreach ($this->supportedDatabases as $extension => $database) {
   262|             if (extension_loaded($extension)) {
   263|                 return true;
   264|             }
   265|         }
   266|         return false;
   267|     }
   268|     /**
   269|      * Checks for required PHP extensions.
   270|      */
   271|     public function checkRequiredExtensions(): bool
   272|     {
   273|         foreach ($this->requiredExtensions as $extension) {
   274|             if (!extension_loaded($extension)) {
   275|                 $this->missingExtensions[] = $extension;
   276|             }
   277|         }
   278|         if (count($this->missingExtensions) > 0) {
   279|             return false;
   280|         }
   281|         return true;
   282|     }
   283|     /**
   284|      * Checks for an installed phpMyFAQ version
   285|      */
   286|     public function checkInstallation(): bool
   287|     {
   288|         return !is_file(PMF_ROOT_DIR . '/config/database.php');
   289|     }
   290|     /**
   291|      * Returns all missing extensions.
   292|      *
   293|      * @return array<string>
   294|      */
   295|     public function getMissingExtensions(): array
   296|     {
   297|         return $this->missingExtensions;
   298|     }
   299|     /**
   300|      * Creates a JSON object with all .php files of phpMyFAQ with their sha1 hashes.
   301|      *
   302|      * @throws Exception
   303|      */
   304|     public function createHashes(): string
   305|     {
   306|         $created = new DateTime();
   307|         $files = new RecursiveIteratorIterator(
   308|             new RecursiveDirectoryIterator(PMF_ROOT_DIR),
   309|             RecursiveIteratorIterator::SELF_FIRST
   310|         );
   311|         $hashes = [
   312|             'created' => $created->format('Y-m-d H:i:sP'),
   313|         ];
   314|         $ignoredFiles = [
   315|             '/config/constants.php' => false,
   316|             '/config/constants_elasticsearch.php' => false,
   317|             '/config/database.php' => false,
   318|             '/config/elasticsearch.php' => false,
   319|             '/config/ldap.php' => false,
   320|         ];
   321|         $current = '';
   322|         try {
   323|             foreach ($files as $file) {
   324|                 if (
   325|                     'php' === pathinfo((string) $file->getFilename(), PATHINFO_EXTENSION) && !preg_match(
   326|                         '#/tests/#',
   327|                         (string) $file->getPath()
   328|                     )
   329|                 ) {
   330|                     $current = str_replace(PMF_ROOT_DIR, '', (string) $file->getPathname());
   331|                     if (isset($ignoredFiles[$current])) {
   332|                         continue;
   333|                     }
   334|                     $hashes[$current] = sha1(file_get_contents($file->getPathname()));
   335|                 }
   336|             }
   337|         } catch (UnexpectedValueException $e) {
   338|             $hashes[$current . ' failed'] = $e->getMessage();
   339|         }
   340|         return json_encode($hashes, JSON_THROW_ON_ERROR);
   341|     }
   342|     /**
   343|      * Drops all given tables
   344|      *
   345|      * @param array<string> $queries
   346|      */
   347|     public function dropTables(array $queries): void
   348|     {
   349|         if ($this->database instanceof DatabaseDriver) {
   350|             foreach ($queries as $query) {
   351|                 $this->database->query($query);
   352|             }
   353|         }
   354|     }
   355|     /**
   356|      * Removes the database.php and the ldap.php if an installation failed.
   357|      *
   358|      * @todo have to be moved to the Installer class
   359|      */
   360|     public function cleanFailedInstallationFiles(): void
   361|     {
   362|         if (file_exists(PMF_ROOT_DIR . '/config/database.php')) {
   363|             unlink(PMF_ROOT_DIR . '/config/database.php');
   364|         }
   365|         if (file_exists(PMF_ROOT_DIR . '/config/ldap.php')) {
   366|             unlink(PMF_ROOT_DIR . '/config/ldap.php');
   367|         }
   368|     }
   369| }


# ====================================================================
# FILE: scripts/version.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| if [ "x${PMF_VERSION}" = "x" ]; then
     2|     PMF_VERSION="3.2.10"
     3| fi

