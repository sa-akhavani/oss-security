# ====================================================================
# FILE: phpmyfaq/admin/category.add.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-36 ---
     1| <?php
     2| /**
     3|  * Adds a new (sub-)category, a new sub-category inherits the permissions from
     4|  * its parent category.
     5|  *
     6|  * This Source Code Form is subject to the terms of the Mozilla Public License,
     7|  * v. 2.0. If a copy of the MPL was not distributed with this file, You can
     8|  * obtain one at https://mozilla.org/MPL/2.0/.
     9|  *
    10|  * @package   phpMyFAQ
    11|  * @author    Thorsten Rinne <thorsten@phpmyfaq.de>
    12|  * @copyright 2003-2024 phpMyFAQ Team
    13|  * @license   https://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0
    14|  * @link      https://www.phpmyfaq.de
    15|  * @since     2003-12-20
    16|  */
    17| use phpMyFAQ\Category\Permission;
    18| use phpMyFAQ\Enums\PermissionType;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Helper\UserHelper;
    21| use phpMyFAQ\Language\LanguageCodes;
    22| use phpMyFAQ\Session\Token;
    23| use phpMyFAQ\Translation;
    24| use phpMyFAQ\Template\TwigWrapper;
    25| if (!defined('IS_VALID_PHPMYFAQ')) {
    26|     http_response_code(400);
    27|     exit();
    28| }
    29| $faqConfig = $container->get('phpmyfaq.configuration');
    30| $currentUser = $container->get('phpmyfaq.user.current_user');
    31| if ($currentUser->perm->hasPermission($currentUser->getUserId(), PermissionType::CATEGORY_ADD->value)) {
    32|     $category = $container->get('phpmyfaq.admin.category');
    33|     $category->setUser($currentUser->getUserId());
    34|     $category->setGroups($currentAdminGroups);
    35|     $category->setLanguage($faqConfig->getLanguage()->getLanguage());
    36|     $category->loadCategories();

# --- HUNK 2: Lines 49-90 ---
    49|         'ad_categ_desc' => Translation::get('ad_categ_desc'),
    50|         'ad_category_image' => Translation::get('ad_category_image'),
    51|         'ad_user_active' => Translation::get('ad_user_active'),
    52|         'ad_user_show_home' => Translation::get('ad_user_show_home'),
    53|         'permLevel' => $faqConfig->get('security.permLevel'),
    54|         'ad_entry_all_users' => Translation::get('ad_entry_all_users'),
    55|         'ad_entry_restricted_users' => Translation::get('ad_entry_restricted_users'),
    56|         'ad_entry_userpermission' => Translation::get('ad_entry_userpermission'),
    57|         'ad_categ_add' => Translation::get('ad_categ_add'),
    58|         'ad_entry_grouppermission' => Translation::get('ad_entry_grouppermission'),
    59|         'ad_entry_all_groups' => Translation::get('ad_entry_all_groups'),
    60|         'ad_entry_restricted_groups' => Translation::get('ad_entry_restricted_groups'),
    61|         'msgSerpTitle' => Translation::get('msgSerpTitle'),
    62|         'msgSerpDescription' => Translation::get('msgSerpDescription'),
    63|         'restricted_groups' => ($faqConfig->get('security.permLevel') === 'medium') ?
    64|             $currentUser->perm->getAllGroupsOptions([], $user) : '',
    65|     ];
    66|     if ($parentId > 0) {
    67|         $userAllowed = $categoryPermission->get(Permission::USER, [$parentId]);
    68|         $groupsAllowed = $categoryPermission->get(Permission::GROUP, [$parentId]);
    69|         $templateVars = [
    70|             ...$templateVars,
    71|             'categoryNameLangCode' => LanguageCodes::get($category->categoryName[$parentId]['lang']),
    72|             'userAllowed' => $categoryPermission->get(Permission::USER, [$parentId])[0],
    73|             'groupsAllowed' => $categoryPermission->get(Permission::GROUP, [$parentId]),
    74|             'categoryName' => $category->categoryName[$parentId]['name'],
    75|             'msgMainCategory' => Translation::get('msgMainCategory'),
    76|         ];
    77|     }
    78|     if ($faqConfig->get('security.permLevel') !== 'basic') {
    79|         $templateVars = [
    80|             ...$templateVars,
    81|             'groupsOptions' => $currentUser->perm->getAllGroupsOptions([], $currentUser),
    82|             'ad_categ_moderator' => Translation::get('ad_categ_moderator')
    83|         ];
    84|     }
    85|     $twig = new TwigWrapper(PMF_ROOT_DIR . '/assets/templates');
    86|     $template = $twig->loadTemplate('@admin/content/category.add.twig');
    87|     echo $template->render($templateVars);
    88| } else {
    89|     require __DIR__ . '/no-permission.php';
    90| }


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Configuration.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 382-422 ---
   382|      */
   383|     public function update(array $newConfigs): bool
   384|     {
   385|         $runtimeConfigs = [
   386|             'core.database', // phpMyFAQ\Database\DatabaseDriver
   387|             'core.instance', // Instance
   388|             'core.language', // Language
   389|             'core.ldapServer', // Ldap
   390|             'core.ldapConfig', // $LDAP
   391|             'core.elasticsearch', // Elasticsearch\Client
   392|             'core.elasticsearchConfig', // $ES
   393|             'core.pluginManager', // PluginManager
   394|         ];
   395|         foreach ($newConfigs as $name => $value) {
   396|             if ($name != 'main.phpMyFAQToken' && !in_array($name, $runtimeConfigs)) {
   397|                 $update = sprintf(
   398|                     "UPDATE %s%s SET config_value = '%s' WHERE config_name = '%s'",
   399|                     Database::getTablePrefix(),
   400|                     $this->tableName,
   401|                     $this->getDb()->escape(trim($value)),
   402|                     $name
   403|                 );
   404|                 $this->getDb()->query($update);
   405|                 if (isset($this->config[$name])) {
   406|                     unset($this->config[$name]);
   407|                 }
   408|             }
   409|         }
   410|         return true;
   411|     }
   412|     /**
   413|      * Updates main.referenceUrl in media objects in faqs.
   414|      *
   415|      * @param string $oldUrl Old main.referenceUrl
   416|      * @param string $newUrl New main.referenceUrl
   417|      * @return bool true|false
   418|      */
   419|     public function replaceMainReferenceUrl(string $oldUrl, string $newUrl): bool
   420|     {
   421|         $query = sprintf("SELECT content FROM %sfaqdata", Database::getTablePrefix());
   422|         $response = $this->getDb()->query($query);


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Controller/Administration/UserController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 214-254 ---
   214|             $category->moveOwnership((int) $userId, 1);
   215|             if ('basic' !== $this->configuration->get('security.permLevel')) {
   216|                 $permissions = Permission::createPermission('medium', $this->configuration);
   217|                 $permissions->removeFromAllGroups($userId);
   218|             }
   219|             return $this->json(['success' => Translation::get('ad_user_deleted')], Response::HTTP_OK);
   220|         }
   221|     }
   222|     /**
   223|      * @throws Exception
   224|      */
   225|     public function addUser(Request $request): JsonResponse
   226|     {
   227|         $this->userHasUserPermission();
   228|         $data = json_decode($request->getContent());
   229|         if (!Token::getInstance()->verifyToken('add-user', $data->csrf)) {
   230|             return $this->json(['error' => Translation::get('err_NotAuth')], Response::HTTP_UNAUTHORIZED);
   231|         }
   232|         $errorMessage = [];
   233|         $userName = Filter::filterVar($data->userName, FILTER_SANITIZE_SPECIAL_CHARS);
   234|         $userRealName = Filter::filterVar($data->realName, FILTER_SANITIZE_SPECIAL_CHARS);
   235|         $userEmail = Filter::filterVar($data->email, FILTER_VALIDATE_EMAIL);
   236|         $automaticPassword = Filter::filterVar($data->automaticPassword, FILTER_VALIDATE_BOOLEAN);
   237|         $userPassword = Filter::filterVar($data->password, FILTER_SANITIZE_SPECIAL_CHARS);
   238|         $userPasswordConfirm = Filter::filterVar($data->passwordConfirm, FILTER_SANITIZE_SPECIAL_CHARS);
   239|         $userIsSuperAdmin = Filter::filterVar($data->isSuperAdmin, FILTER_VALIDATE_BOOLEAN);
   240|         $newUser = new User($this->configuration);
   241|         if (!$newUser->isValidLogin($userName)) {
   242|             $errorMessage[] = Translation::get('ad_user_error_loginInvalid');
   243|         }
   244|         if ($newUser->getUserByLogin($userName, false)) {
   245|             $errorMessage[] = Translation::get('ad_adus_exerr');
   246|         }
   247|         if ($userRealName === '') {
   248|             $errorMessage[] = Translation::get('ad_user_error_noRealName');
   249|         }
   250|         if (is_null($userEmail)) {
   251|             $errorMessage[] = Translation::get('ad_user_error_noEmail');
   252|         }
   253|         if (!$automaticPassword) {
   254|             if (strlen((string) $userPassword) <= 7 || strlen((string) $userPasswordConfirm) <= 7) {

# --- HUNK 2: Lines 269-309 ---
   269|                     $mailHelper->sendMailToNewUser($newUser, $userPassword);
   270|                 } catch (Exception | TransportExceptionInterface) {
   271|                 }
   272|                 return $this->json(['success' => Translation::get('ad_adus_suc')], Response::HTTP_OK);
   273|             }
   274|         }
   275|         return $this->json($errorMessage, Response::HTTP_BAD_REQUEST);
   276|     }
   277|     public function editUser(Request $request): JsonResponse
   278|     {
   279|         $this->userHasPermission(PermissionType::USER_EDIT);
   280|         $data = json_decode($request->getContent());
   281|         if (!Token::getInstance()->verifyToken('update-user-data', $data->csrfToken)) {
   282|             return $this->json(['error' => Translation::get('err_NotAuth')], Response::HTTP_UNAUTHORIZED);
   283|         }
   284|         $userId = Filter::filterVar($data->userId, FILTER_VALIDATE_INT, 0);
   285|         if ($userId === 0) {
   286|             return $this->json(['error' => Translation::get('ad_user_error_noId')], Response::HTTP_BAD_REQUEST);
   287|         } else {
   288|             $userData = [];
   289|             $userData['display_name'] = Filter::filterVar($data->display_name, FILTER_SANITIZE_SPECIAL_CHARS);
   290|             $userData['email'] = Filter::filterVar($data->email, FILTER_VALIDATE_EMAIL);
   291|             $userData['last_modified'] = Filter::filterVar($data->last_modified, FILTER_SANITIZE_SPECIAL_CHARS);
   292|             $userStatus = Filter::filterVar($data->user_status, FILTER_SANITIZE_SPECIAL_CHARS, 'active');
   293|             $isSuperAdmin = Filter::filterVar($data->is_superadmin, FILTER_SANITIZE_SPECIAL_CHARS);
   294|             $deleteTwoFactor = Filter::filterVar($data->overwrite_twofactor, FILTER_SANITIZE_SPECIAL_CHARS);
   295|             $deleteTwoFactor = $deleteTwoFactor === 'on';
   296|             $user = new User($this->configuration);
   297|             $user->getUserById($userId, true);
   298|             $stats = $user->getStatus();
   299|             if ($deleteTwoFactor) {
   300|                 $user->setUserData(['secret' => '', 'twofactor_enabled' => 0]);
   301|             }
   302|             if ($stats == 'blocked' && $userStatus == 'active') {
   303|                 if (!$user->activateUser()) {
   304|                     $userStatus = 'invalid_status';
   305|                 }
   306|             }
   307|             $user->setSuperAdmin($isSuperAdmin);
   308|             if (
   309|                 !$user->userdata->set(array_keys($userData), array_values($userData)) || !$user->setStatus(


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Controller/Frontend/RegistrationController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 16-56 ---
    16| namespace phpMyFAQ\Controller\Frontend;
    17| use phpMyFAQ\Controller\AbstractController;
    18| use phpMyFAQ\Core\Exception;
    19| use phpMyFAQ\Filter;
    20| use phpMyFAQ\Helper\RegistrationHelper;
    21| use phpMyFAQ\Translation;
    22| use Symfony\Component\HttpFoundation\JsonResponse;
    23| use Symfony\Component\HttpFoundation\Request;
    24| use Symfony\Component\HttpFoundation\Response;
    25| use Symfony\Component\Mailer\Exception\TransportExceptionInterface;
    26| class RegistrationController extends AbstractController
    27| {
    28|     /**
    29|      * @throws \JsonException
    30|      * @throws Exception
    31|      */
    32|     public function create(Request $request): JsonResponse
    33|     {
    34|         $registration = new RegistrationHelper($this->configuration);
    35|         $data = json_decode($request->getContent(), false, 512, JSON_THROW_ON_ERROR);
    36|         $fullName = trim((string) Filter::filterVar($data->realname, FILTER_SANITIZE_SPECIAL_CHARS));
    37|         $userName = trim((string) Filter::filterVar($data->name, FILTER_SANITIZE_SPECIAL_CHARS));
    38|         $email = trim((string) Filter::filterVar($data->email, FILTER_VALIDATE_EMAIL));
    39|         $isVisible = Filter::filterVar($data->isVisible, FILTER_SANITIZE_SPECIAL_CHARS) ?? false;
    40|         if (!$this->captchaCodeIsValid($request)) {
    41|             return $this->json(['error' => Translation::get('msgCaptcha')], Response::HTTP_BAD_REQUEST);
    42|         }
    43|         if (!$registration->isDomainAllowed($email)) {
    44|             return $this->json(['error' => 'The domain is not allowed.'], Response::HTTP_BAD_REQUEST);
    45|         }
    46|         if (!empty($userName) && !empty($email) && !empty($fullName)) {
    47|             try {
    48|                 return $this->json(
    49|                     $registration->createUser($userName, $fullName, $email, $isVisible),
    50|                     Response::HTTP_CREATED
    51|                 );
    52|             } catch (Exception | TransportExceptionInterface $exception) {
    53|                 return $this->json(['error' => $exception->getMessage()], Response::HTTP_BAD_REQUEST);
    54|             }
    55|         } else {
    56|             return $this->json(['error' => Translation::get('err_sendMail')], Response::HTTP_BAD_REQUEST);


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Controller/Frontend/UserController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 27-67 ---
    27| use Symfony\Component\HttpFoundation\JsonResponse;
    28| use Symfony\Component\HttpFoundation\Request;
    29| use Symfony\Component\HttpFoundation\Response;
    30| use Symfony\Component\Mailer\Exception\TransportExceptionInterface;
    31| use Symfony\Component\Routing\Attribute\Route;
    32| class UserController extends AbstractController
    33| {
    34|     /**
    35|      * @throws Exception
    36|      */
    37|     public function updateData(Request $request): JsonResponse
    38|     {
    39|         $this->userIsAuthenticated();
    40|         $user = CurrentUser::getCurrentUser($this->configuration);
    41|         $data = json_decode($request->getContent());
    42|         $csrfToken = Filter::filterVar($data->{'pmf-csrf-token'}, FILTER_SANITIZE_SPECIAL_CHARS);
    43|         if (!Token::getInstance()->verifyToken('ucp', $csrfToken)) {
    44|             return $this->json(['error' => Translation::get('ad_msg_noauth')], Response::HTTP_UNAUTHORIZED);
    45|         }
    46|         $userId = Filter::filterVar($data->userid, FILTER_VALIDATE_INT);
    47|         $userName = trim((string) Filter::filterVar($data->name, FILTER_SANITIZE_SPECIAL_CHARS));
    48|         $email = Filter::filterVar($data->email, FILTER_VALIDATE_EMAIL);
    49|         $isVisible = Filter::filterVar($data->{'is_visible'}, FILTER_SANITIZE_SPECIAL_CHARS);
    50|         $password = trim((string) Filter::filterVar($data->faqpassword, FILTER_SANITIZE_SPECIAL_CHARS));
    51|         $confirm = trim((string) Filter::filterVar($data->faqpassword_confirm, FILTER_SANITIZE_SPECIAL_CHARS));
    52|         $twoFactorEnabled = Filter::filterVar($data->twofactor_enabled ?? 'off', FILTER_SANITIZE_SPECIAL_CHARS);
    53|         $isAzureAdUser = $user->getUserAuthSource() === 'azure';
    54|         $isWebAuthnUser = $user->getUserAuthSource() === 'webauthn';
    55|         if ($userId !== $user->getUserId()) {
    56|             return $this->json(['error' => 'User ID mismatch!'], Response::HTTP_BAD_REQUEST);
    57|         }
    58|         if (!$isAzureAdUser) {
    59|             if ($password !== $confirm) {
    60|                 return $this->json(
    61|                     ['error' => Translation::get('ad_user_error_passwordsDontMatch')],
    62|                     Response::HTTP_CONFLICT
    63|                 );
    64|             }
    65|             if ((strlen($password) <= 7 || strlen($confirm) <= 7) && !$isWebAuthnUser) {
    66|                 return $this->json(['error' => Translation::get('ad_passwd_fail')], Response::HTTP_CONFLICT);
    67|             } else {


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/Mail.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 212-261 ---
   212|      * @throws Exception
   213|      */
   214|     private function setEmailTo(array &$target, string $targetAlias, string $address, ?string $name = null): bool
   215|     {
   216|         if (count($target) > 2) {
   217|             $keys = array_keys($target);
   218|             throw new Exception(
   219|                 sprintf('<strong>Mail Class</strong>: too many e-mail addresses, %s, ', $keys[0]) .
   220|                 sprintf('have been already added as \'%s\'!', $targetAlias)
   221|             );
   222|         }
   223|         return $this->addEmailTo($target, $targetAlias, $address, $name);
   224|     }
   225|     /**
   226|      * Add an e-mail address to an array.
   227|      *
   228|      * @param array<string> $target Target array.
   229|      * @param string        $targetAlias Alias Target alias.
   230|      * @param string        $address User e-mail address.
   231|      * @param string|null   $name Username (optional).
   232|      * @throws Exception
   233|      * @return bool True if successful, false otherwise.
   234|      */
   235|     private function addEmailTo(array &$target, string $targetAlias, string $address, ?string $name = null): bool
   236|     {
   237|         if (!self::validateEmail($address)) {
   238|             throw new Exception('"' . $address . '" is not a valid email address!');
   239|         }
   240|         if (array_key_exists($address, $target)) {
   241|             throw new Exception('"' . $address . '" has been already added in ' . $targetAlias . '!');
   242|         }
   243|         if (isset($name)) {
   244|             $name = str_replace(["\n", "\r"], '', $name);
   245|             $name = iconv_mime_encode($targetAlias, $name);
   246|             $name = '"' . str_replace('"', '\"', $name) . '"';
   247|         }
   248|         $target[$address] = $name;
   249|         if ('WIN' !== strtoupper(substr(PHP_OS, 0, 3))) {
   250|             return true;
   251|         }
   252|         if ('built-in' != $this->agent) {
   253|             return true;
   254|         }
   255|         $target[$address] = null;
   256|         return true;
   257|     }
   258|     /**
   259|      * Validate an address as an e-mail address.
   260|      *
   261|      * @param string $address E-Mail address


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/System.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 24-64 ---
    24| use Symfony\Component\HttpFoundation\Request;
    25| use UnexpectedValueException;
    26| /**
    27|  * Class System
    28|  *
    29|  * @package phpMyFAQ
    30|  */
    31| class System
    32| {
    33|     /**
    34|      * Major version.
    35|      */
    36|     private const VERSION_MAJOR = 4;
    37|     /**
    38|      * Minor version.
    39|      */
    40|     private const VERSION_MINOR = 0;
    41|     /**
    42|      * Patch level.
    43|      */
    44|     private const VERSION_PATCH_LEVEL = 13;
    45|     /**
    46|      * Pre-release version.
    47|      */
    48|     private const VERSION_PRE_RELEASE = '';
    49|     /**
    50|      * API version.
    51|      */
    52|     private const VERSION_API = '3.0';
    53|     /**
    54|      * Plugin version.
    55|      */
    56|     private const PLUGIN_VERSION = '0.1.0';
    57|     /**
    58|      * Minimum required PHP version.
    59|      */
    60|     final public const VERSION_MINIMUM_PHP = '8.2.0';
    61|     /**
    62|      * phpMyFAQ homepage URL
    63|      */
    64|     final public const PHPMYFAQ_URL = 'https://www.phpmyfaq.de/';


# ====================================================================
# FILE: phpmyfaq/src/phpMyFAQ/User/UserData.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 49-88 ---
    49|      * Returns the field $field of the user data. If $field is an
    50|      * array, an associative array will be returned.
    51|      *
    52|      * @param mixed $field Field(s)
    53|      */
    54|     public function get(mixed $field): mixed
    55|     {
    56|         $singleReturn = !is_array($field);
    57|         $fields = $singleReturn ? $field : implode(', ', $field);
    58|         $select = sprintf(
    59|             'SELECT %s FROM %sfaquserdata WHERE user_id = %d',
    60|             $fields,
    61|             Database::getTablePrefix(),
    62|             $this->userId
    63|         );
    64|         $res = $this->configuration->getDb()->query($select);
    65|         if ($this->configuration->getDb()->numRows($res) != 1) {
    66|             return false;
    67|         }
    68|         $array = $this->configuration->getDb()->fetchArray($res);
    69|         return $singleReturn && $field != '*' ? $array[$field] : $array;
    70|     }
    71|     /**
    72|      * Returns the first result of the given key.
    73|      */
    74|     public function fetch(string $key, string $value): ?string
    75|     {
    76|         $select = sprintf(
    77|             "SELECT %s FROM %sfaquserdata WHERE %s = '%s'",
    78|             $key,
    79|             Database::getTablePrefix(),
    80|             $key,
    81|             $this->configuration->getDb()->escape($value)
    82|         );
    83|         $res = $this->configuration->getDb()->query($select);
    84|         if (0 === $this->configuration->getDb()->numRows($res)) {
    85|             return null;
    86|         }
    87|         return $this->configuration->getDb()->fetchObject($res)->$key;
    88|     }


# ====================================================================
# FILE: scripts/version.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-3 ---
     1| if [ -z "${PMF_VERSION}" ]; then
     2|     PMF_VERSION="4.0.13"
     3| fi

