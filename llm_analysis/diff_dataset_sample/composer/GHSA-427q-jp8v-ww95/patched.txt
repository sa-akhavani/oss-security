# ====================================================================
# FILE: src/Constants.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| <?php
     2| /*
     3|  * This file is part of the Kimai time-tracking app.
     4|  *
     5|  * For the full copyright and license information, please view the LICENSE
     6|  * file that was distributed with this source code.
     7|  */
     8| namespace App;
     9| /**
    10|  * Some "very" global constants for Kimai.
    11|  */
    12| class Constants
    13| {
    14|     /**
    15|      * The current release version
    16|      */
    17|     public const VERSION = '1.16.2';
    18|     /**
    19|      * The current release: major * 10000 + minor * 100 + patch
    20|      */
    21|     public const VERSION_ID = 11602;
    22|     /**
    23|      * The current release status, either "stable" or "dev"
    24|      */
    25|     public const STATUS = 'prod';
    26|     /**
    27|      * The software name
    28|      */
    29|     public const SOFTWARE = 'Kimai';
    30|     /**
    31|      * The release name, will only change for new major version
    32|      */
    33|     public const NAME = 'Ayumi';
    34|     /**
    35|      * Used in multiple views
    36|      */
    37|     public const GITHUB = 'https://github.com/kevinpapst/kimai2/';
    38|     /**
    39|      * Homepage, used in multiple views
    40|      */
    41|     public const HOMEPAGE = 'https://www.kimai.org';


# ====================================================================
# FILE: src/Controller/ProjectController.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 339-390 ---
   339|      */
   340|     public function editAction(Project $project, Request $request)
   341|     {
   342|         $editForm = $this->createEditForm($project);
   343|         $editForm->handleRequest($request);
   344|         if ($editForm->isSubmitted() && $editForm->isValid()) {
   345|             try {
   346|                 $this->projectService->updateProject($project);
   347|                 $this->flashSuccess('action.update.success');
   348|                 return $this->redirectToRoute('project_details', ['id' => $project->getId()]);
   349|             } catch (\Exception $ex) {
   350|                 $this->flashUpdateException($ex);
   351|             }
   352|         }
   353|         return $this->render('project/edit.html.twig', [
   354|             'project' => $project,
   355|             'form' => $editForm->createView()
   356|         ]);
   357|     }
   358|     /**
   359|      * @Route(path="/{id}/duplicate/{token}", name="admin_project_duplicate", methods={"GET", "POST"})
   360|      * @Security("is_granted('edit', project)")
   361|      */
   362|     public function duplicateAction(Project $project, string $token, ProjectDuplicationService $projectDuplicationService, CsrfTokenManagerInterface $csrfTokenManager)
   363|     {
   364|         if (!$csrfTokenManager->isTokenValid(new CsrfToken('project.duplicate', $token))) {
   365|             $this->flashError('action.csrf.error');
   366|             return $this->redirectToRoute('project_details', ['id' => $project->getId()]);
   367|         }
   368|         $csrfTokenManager->refreshToken($token);
   369|         $newProject = $projectDuplicationService->duplicate($project, $project->getName() . ' [COPY]');
   370|         $this->flashSuccess('action.update.success');
   371|         return $this->redirectToRoute('project_details', ['id' => $newProject->getId()]);
   372|     }
   373|     /**
   374|      * @Route(path="/{id}/delete", name="admin_project_delete", methods={"GET", "POST"})
   375|      * @Security("is_granted('delete', project)")
   376|      */
   377|     public function deleteAction(Project $project, Request $request, ProjectStatisticService $statisticService)
   378|     {
   379|         $stats = $statisticService->getProjectStatistics($project);
   380|         $deleteForm = $this->createFormBuilder(null, [
   381|                 'attr' => [
   382|                     'data-form-event' => 'kimai.projectDelete',
   383|                     'data-msg-success' => 'action.delete.success',
   384|                     'data-msg-error' => 'action.delete.error',
   385|                 ]
   386|             ])
   387|             ->add('project', ProjectType::class, [
   388|                 'ignore_project' => $project,
   389|                 'customers' => $project->getCustomer(),
   390|                 'query_builder_for_user' => true,


# ====================================================================
# FILE: src/Controller/TeamController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 2-43 ---
     2| /*
     3|  * This file is part of the Kimai time-tracking app.
     4|  *
     5|  * For the full copyright and license information, please view the LICENSE
     6|  * file that was distributed with this source code.
     7|  */
     8| namespace App\Controller;
     9| use App\Entity\Team;
    10| use App\Form\TeamCustomerForm;
    11| use App\Form\TeamEditForm;
    12| use App\Form\TeamProjectForm;
    13| use App\Form\Toolbar\TeamToolbarForm;
    14| use App\Repository\Query\TeamQuery;
    15| use App\Repository\TeamRepository;
    16| use Sensio\Bundle\FrameworkExtraBundle\Configuration\Security;
    17| use Symfony\Component\Form\FormInterface;
    18| use Symfony\Component\HttpFoundation\RedirectResponse;
    19| use Symfony\Component\HttpFoundation\Request;
    20| use Symfony\Component\HttpFoundation\Response;
    21| use Symfony\Component\Routing\Annotation\Route;
    22| use Symfony\Component\Security\Csrf\CsrfToken;
    23| use Symfony\Component\Security\Csrf\CsrfTokenManagerInterface;
    24| /**
    25|  * @Route(path="/admin/teams")
    26|  * @Security("is_granted('view_team')")
    27|  */
    28| final class TeamController extends AbstractController
    29| {
    30|     /**
    31|      * @var TeamRepository
    32|      */
    33|     private $repository;
    34|     public function __construct(TeamRepository $repository)
    35|     {
    36|         $this->repository = $repository;
    37|     }
    38|     /**
    39|      * @Route(path="/", defaults={"page": 1}, name="admin_team", methods={"GET"})
    40|      * @Route(path="/page/{page}", requirements={"page": "[1-9]\d*"}, name="admin_team_paginated", methods={"GET"})
    41|      *
    42|      * @param TeamRepository $repository
    43|      * @param Request $request

# --- HUNK 2: Lines 55-104 ---
    55|         }
    56|         $teams = $repository->getPagerfantaForQuery($query);
    57|         return $this->render('team/index.html.twig', [
    58|             'teams' => $teams,
    59|             'query' => $query,
    60|             'toolbarForm' => $form->createView(),
    61|         ]);
    62|     }
    63|     /**
    64|      * @Route(path="/create", name="admin_team_create", methods={"GET", "POST"})
    65|      * @Security("is_granted('create_team')")
    66|      *
    67|      * @param Request $request
    68|      * @return RedirectResponse|Response
    69|      */
    70|     public function createTeam(Request $request)
    71|     {
    72|         return $this->renderEditScreen(new Team(), $request);
    73|     }
    74|     /**
    75|      * @Route(path="/{id}/duplicate/{token}", name="team_duplicate", methods={"GET", "POST"})
    76|      * @Security("is_granted('edit', team) and is_granted('create_team')")
    77|      */
    78|     public function duplicateTeam(Team $team, string $token, CsrfTokenManagerInterface $csrfTokenManager)
    79|     {
    80|         if (!$csrfTokenManager->isTokenValid(new CsrfToken('team.duplicate', $token))) {
    81|             $this->flashError('action.csrf.error');
    82|             return $this->redirectToRoute('admin_team_edit', ['id' => $team->getId()]);
    83|         }
    84|         $csrfTokenManager->refreshToken($token);
    85|         $newTeam = clone $team;
    86|         $newTeam->setName($team->getName() . ' [COPY]');
    87|         try {
    88|             $this->repository->saveTeam($newTeam);
    89|             $this->flashSuccess('action.update.success');
    90|             return $this->redirectToRoute('admin_team_edit', ['id' => $newTeam->getId()]);
    91|         } catch (\Exception $ex) {
    92|             $this->flashUpdateException($ex);
    93|         }
    94|         return $this->redirectToRoute('admin_team');
    95|     }
    96|     /**
    97|      * @Route(path="/{id}/edit", name="admin_team_edit", methods={"GET", "POST"})
    98|      * @Security("is_granted('edit', team)")
    99|      */
   100|     public function editAction(Team $team, Request $request)
   101|     {
   102|         return $this->renderEditScreen($team, $request);
   103|     }
   104|     /**


# ====================================================================
# FILE: src/Controller/TimesheetAbstractController.php
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 164-209 ---
   164|                 $entry->addTag($tag);
   165|             }
   166|         }
   167|         $this->service->prepareNewTimesheet($entry, $request);
   168|         $createForm = $this->getCreateForm($entry);
   169|         $createForm->handleRequest($request);
   170|         if ($createForm->isSubmitted() && $createForm->isValid()) {
   171|             try {
   172|                 $this->service->saveNewTimesheet($entry);
   173|                 $this->flashSuccess('action.update.success');
   174|                 return $this->redirectToRoute($this->getTimesheetRoute());
   175|             } catch (\Exception $ex) {
   176|                 $this->flashUpdateException($ex);
   177|             }
   178|         }
   179|         return $this->render($renderTemplate, [
   180|             'timesheet' => $entry,
   181|             'form' => $createForm->createView(),
   182|         ]);
   183|     }
   184|     protected function duplicate(Timesheet $timesheet, Request $request, string $renderTemplate, string $token): Response
   185|     {
   186|         $copyTimesheet = clone $timesheet;
   187|         $event = new TimesheetMetaDefinitionEvent($copyTimesheet);
   188|         $this->dispatcher->dispatch($event);
   189|         $form = $this->getDuplicateForm($copyTimesheet, $timesheet, $token);
   190|         $form->handleRequest($request);
   191|         if ($form->isSubmitted() && $form->isValid()) {
   192|             try {
   193|                 $this->dispatcher->dispatch(new TimesheetDuplicatePreEvent($copyTimesheet, $timesheet));
   194|                 $this->service->saveNewTimesheet($copyTimesheet);
   195|                 $this->dispatcher->dispatch(new TimesheetDuplicatePostEvent($copyTimesheet, $timesheet));
   196|                 $this->flashSuccess('action.update.success');
   197|                 return $this->redirectToRoute($this->getTimesheetRoute());
   198|             } catch (\Exception $ex) {
   199|                 $this->flashUpdateException($ex);
   200|             }
   201|         }
   202|         return $this->render($renderTemplate, [
   203|             'timesheet' => $copyTimesheet,
   204|             'form' => $form->createView(),
   205|         ]);
   206|     }
   207|     protected function export(Request $request, ServiceExport $serviceExport): Response
   208|     {
   209|         $query = $this->createDefaultQuery();

# --- HUNK 2: Lines 500-522 ---
   500|         return 'timesheet_multi_delete';
   501|     }
   502|     protected function getExportRoute(): string
   503|     {
   504|         return 'timesheet_export';
   505|     }
   506|     protected function canSeeStartEndTime(): bool
   507|     {
   508|         return $this->getTrackingMode()->canSeeBeginAndEndTimes();
   509|     }
   510|     protected function getQueryNamePrefix(): string
   511|     {
   512|         return 'MyTimes';
   513|     }
   514|     protected function createDefaultQuery(string $suffix = 'Listing'): TimesheetQuery
   515|     {
   516|         $query = new TimesheetQuery();
   517|         $query->setName($this->getQueryNamePrefix() . $suffix);
   518|         return $query;
   519|     }
   520|     abstract protected function getDuplicateForm(Timesheet $entry, Timesheet $original, string $token): FormInterface;
   521|     abstract protected function getCreateForm(Timesheet $entry): FormInterface;
   522| }


# ====================================================================
# FILE: src/Controller/TimesheetController.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-101 ---
     1| <?php
     2| /*
     3|  * This file is part of the Kimai time-tracking app.
     4|  *
     5|  * For the full copyright and license information, please view the LICENSE
     6|  * file that was distributed with this source code.
     7|  */
     8| namespace App\Controller;
     9| use App\Entity\Timesheet;
    10| use App\Event\TimesheetMetaDisplayEvent;
    11| use App\Export\ServiceExport;
    12| use App\Form\TimesheetEditForm;
    13| use App\Repository\ActivityRepository;
    14| use App\Repository\ProjectRepository;
    15| use App\Repository\TagRepository;
    16| use Sensio\Bundle\FrameworkExtraBundle\Configuration\Security;
    17| use Symfony\Component\Form\FormInterface;
    18| use Symfony\Component\HttpFoundation\Request;
    19| use Symfony\Component\HttpFoundation\Response;
    20| use Symfony\Component\Routing\Annotation\Route;
    21| use Symfony\Component\Security\Csrf\CsrfToken;
    22| use Symfony\Component\Security\Csrf\CsrfTokenManagerInterface;
    23| /**
    24|  * @Route(path="/timesheet")
    25|  * @Security("is_granted('view_own_timesheet')")
    26|  */
    27| class TimesheetController extends TimesheetAbstractController
    28| {
    29|     /**
    30|      * @Route(path="/", defaults={"page": 1}, name="timesheet", methods={"GET"})
    31|      * @Route(path="/page/{page}", requirements={"page": "[1-9]\d*"}, name="timesheet_paginated", methods={"GET"})
    32|      * @Security("is_granted('view_own_timesheet')")
    33|      */
    34|     public function indexAction(int $page, Request $request): Response
    35|     {
    36|         $query = $this->createDefaultQuery();
    37|         $query->setPage($page);
    38|         return $this->index($query, $request, 'timesheet', 'timesheet/index.html.twig', TimesheetMetaDisplayEvent::TIMESHEET);
    39|     }
    40|     /**
    41|      * @Route(path="/export/", name="timesheet_export", methods={"GET", "POST"})
    42|      * @Security("is_granted('export_own_timesheet')")
    43|      */
    44|     public function exportAction(Request $request, ServiceExport $serviceExport): Response
    45|     {
    46|         return $this->export($request, $serviceExport);
    47|     }
    48|     /**
    49|      * @Route(path="/{id}/edit", name="timesheet_edit", methods={"GET", "POST"})
    50|      * @Security("is_granted('edit', entry)")
    51|      */
    52|     public function editAction(Timesheet $entry, Request $request): Response
    53|     {
    54|         return $this->edit($entry, $request, 'timesheet/edit.html.twig');
    55|     }
    56|     /**
    57|      * @Route(path="/{id}/duplicate/{token}", name="timesheet_duplicate", methods={"GET", "POST"})
    58|      * @Security("is_granted('duplicate', entry)")
    59|      */
    60|     public function duplicateAction(Timesheet $entry, Request $request, string $token, CsrfTokenManagerInterface $csrfTokenManager): Response
    61|     {
    62|         if (!$csrfTokenManager->isTokenValid(new CsrfToken('timesheet.duplicate', $token))) {
    63|             $this->flashError('action.csrf.error');
    64|             return $this->redirectToRoute('timesheet');
    65|         }
    66|         $csrfTokenManager->refreshToken($token);
    67|         return $this->duplicate($entry, $request, 'timesheet/edit.html.twig', $token);
    68|     }
    69|     /**
    70|      * @Route(path="/multi-update", name="timesheet_multi_update", methods={"POST"})
    71|      * @Security("is_granted('edit_own_timesheet')")
    72|      */
    73|     public function multiUpdateAction(Request $request): Response
    74|     {
    75|         return $this->multiUpdate($request, 'timesheet/multi-update.html.twig');
    76|     }
    77|     /**
    78|      * @Route(path="/multi-delete", name="timesheet_multi_delete", methods={"POST"})
    79|      * @Security("is_granted('delete_own_timesheet')")
    80|      */
    81|     public function multiDeleteAction(Request $request): Response
    82|     {
    83|         return $this->multiDelete($request);
    84|     }
    85|     /**
    86|      * @Route(path="/create", name="timesheet_create", methods={"GET", "POST"})
    87|      * @Security("is_granted('create_own_timesheet')")
    88|      */
    89|     public function createAction(Request $request, ProjectRepository $projectRepository, ActivityRepository $activityRepository, TagRepository $tagRepository): Response
    90|     {
    91|         return $this->create($request, 'timesheet/edit.html.twig', $projectRepository, $activityRepository, $tagRepository);
    92|     }
    93|     protected function getCreateForm(Timesheet $entry): FormInterface
    94|     {
    95|         return $this->generateCreateForm($entry, TimesheetEditForm::class, $this->generateUrl('timesheet_create'));
    96|     }
    97|     protected function getDuplicateForm(Timesheet $entry, Timesheet $original, string $token): FormInterface
    98|     {
    99|         return $this->generateCreateForm($entry, TimesheetEditForm::class, $this->generateUrl('timesheet_duplicate', ['id' => $original->getId(), 'token' => $token]));
   100|     }
   101| }


# ====================================================================
# FILE: src/Controller/TimesheetTeamController.php
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 8-98 ---
     8| namespace App\Controller;
     9| use App\Entity\Tag;
    10| use App\Entity\Team;
    11| use App\Entity\Timesheet;
    12| use App\Entity\User;
    13| use App\Event\TimesheetMetaDisplayEvent;
    14| use App\Export\ServiceExport;
    15| use App\Form\Model\MultiUserTimesheet;
    16| use App\Form\TimesheetAdminEditForm;
    17| use App\Form\TimesheetMultiUserEditForm;
    18| use App\Repository\ActivityRepository;
    19| use App\Repository\ProjectRepository;
    20| use App\Repository\Query\TimesheetQuery;
    21| use App\Repository\TagRepository;
    22| use Doctrine\Common\Collections\ArrayCollection;
    23| use Sensio\Bundle\FrameworkExtraBundle\Configuration\Security;
    24| use Symfony\Component\Form\FormInterface;
    25| use Symfony\Component\HttpFoundation\Request;
    26| use Symfony\Component\HttpFoundation\Response;
    27| use Symfony\Component\Routing\Annotation\Route;
    28| use Symfony\Component\Security\Csrf\CsrfToken;
    29| use Symfony\Component\Security\Csrf\CsrfTokenManagerInterface;
    30| /**
    31|  * @Route(path="/team/timesheet")
    32|  * @Security("is_granted('view_other_timesheet')")
    33|  */
    34| class TimesheetTeamController extends TimesheetAbstractController
    35| {
    36|     /**
    37|      * @Route(path="/", defaults={"page": 1}, name="admin_timesheet", methods={"GET"})
    38|      * @Route(path="/page/{page}", requirements={"page": "[1-9]\d*"}, name="admin_timesheet_paginated", methods={"GET"})
    39|      * @Security("is_granted('view_other_timesheet')")
    40|      *
    41|      * @param int $page
    42|      * @param Request $request
    43|      * @return Response
    44|      */
    45|     public function indexAction(int $page, Request $request): Response
    46|     {
    47|         $query = $this->createDefaultQuery();
    48|         $query->setPage($page);
    49|         return $this->index($query, $request, 'admin_timesheet', 'timesheet-team/index.html.twig', TimesheetMetaDisplayEvent::TEAM_TIMESHEET);
    50|     }
    51|     /**
    52|      * @Route(path="/export/", name="admin_timesheet_export", methods={"GET", "POST"})
    53|      * @Security("is_granted('export_other_timesheet')")
    54|      */
    55|     public function exportAction(Request $request, ServiceExport $serviceExport): Response
    56|     {
    57|         return $this->export($request, $serviceExport);
    58|     }
    59|     /**
    60|      * @Route(path="/{id}/edit", name="admin_timesheet_edit", methods={"GET", "POST"})
    61|      * @Security("is_granted('edit', entry)")
    62|      */
    63|     public function editAction(Timesheet $entry, Request $request): Response
    64|     {
    65|         return $this->edit($entry, $request, 'timesheet-team/edit.html.twig');
    66|     }
    67|     /**
    68|      * @Route(path="/{id}/duplicate/{token}", name="admin_timesheet_duplicate", methods={"GET", "POST"})
    69|      * @Security("is_granted('duplicate', entry)")
    70|      */
    71|     public function duplicateAction(Timesheet $entry, Request $request, string $token, CsrfTokenManagerInterface $csrfTokenManager): Response
    72|     {
    73|         if (!$csrfTokenManager->isTokenValid(new CsrfToken('admin_timesheet.duplicate', $token))) {
    74|             $this->flashError('action.csrf.error');
    75|             return $this->redirectToRoute('admin_timesheet');
    76|         }
    77|         $csrfTokenManager->refreshToken($token);
    78|         return $this->duplicate($entry, $request, 'timesheet-team/edit.html.twig', $token);
    79|     }
    80|     /**
    81|      * @Route(path="/create", name="admin_timesheet_create", methods={"GET", "POST"})
    82|      * @Security("is_granted('create_other_timesheet')")
    83|      */
    84|     public function createAction(Request $request, ProjectRepository $projectRepository, ActivityRepository $activityRepository, TagRepository $tagRepository): Response
    85|     {
    86|         return $this->create($request, 'timesheet-team/edit.html.twig', $projectRepository, $activityRepository, $tagRepository);
    87|     }
    88|     /**
    89|      * @Route(path="/create_mu", name="admin_timesheet_create_multiuser", methods={"GET", "POST"})
    90|      * @Security("is_granted('create_other_timesheet')")
    91|      */
    92|     public function createForMultiUserAction(Request $request): Response
    93|     {
    94|         $entry = new MultiUserTimesheet();
    95|         $entry->setUser($this->getUser());
    96|         $this->service->prepareNewTimesheet($entry, $request);
    97|         $createForm = $this->getMultiUserCreateForm($entry);
    98|         $createForm->handleRequest($request);

# --- HUNK 2: Lines 160-202 ---
   160|     public function multiUpdateAction(Request $request): Response
   161|     {
   162|         return $this->multiUpdate($request, 'timesheet-team/multi-update.html.twig');
   163|     }
   164|     /**
   165|      * @Route(path="/multi-delete", name="admin_timesheet_multi_delete", methods={"POST"})
   166|      * @Security("is_granted('delete_other_timesheet')")
   167|      */
   168|     public function multiDeleteAction(Request $request): Response
   169|     {
   170|         return $this->multiDelete($request);
   171|     }
   172|     protected function prepareQuery(TimesheetQuery $query)
   173|     {
   174|         $query->setCurrentUser($this->getUser());
   175|     }
   176|     protected function getCreateForm(Timesheet $entry): FormInterface
   177|     {
   178|         return $this->generateCreateForm($entry, TimesheetAdminEditForm::class, $this->generateUrl('admin_timesheet_create'));
   179|     }
   180|     protected function getDuplicateForm(Timesheet $entry, Timesheet $original, string $token): FormInterface
   181|     {
   182|         return $this->generateCreateForm($entry, TimesheetAdminEditForm::class, $this->generateUrl('admin_timesheet_duplicate', ['id' => $original->getId(), 'token' => $token]));
   183|     }
   184|     protected function getPermissionEditExport(): string
   185|     {
   186|         return 'edit_export_other_timesheet';
   187|     }
   188|     protected function getPermissionEditRate(): string
   189|     {
   190|         return 'edit_rate_other_timesheet';
   191|     }
   192|     protected function getEditFormClassName(): string
   193|     {
   194|         return TimesheetAdminEditForm::class;
   195|     }
   196|     protected function includeUserInForms(string $formName): bool
   197|     {
   198|         if ($formName === 'toolbar') {
   199|             return true;
   200|         }
   201|         return $this->isGranted('edit_other_timesheet');
   202|     }


# ====================================================================
# FILE: src/EventSubscriber/Actions/AbstractTimesheetSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 14-54 ---
    14| abstract class AbstractTimesheetSubscriber extends AbstractActionsSubscriber
    15| {
    16|     protected function timesheetActions(PageActionsEvent $event, string $routeEdit, string $routeDuplicate): void
    17|     {
    18|         $payload = $event->getPayload();
    19|         /** @var Timesheet $timesheet */
    20|         $timesheet = $payload['timesheet'];
    21|         if ($timesheet->getId() !== null) {
    22|             if ($timesheet->isRunning() && $this->isGranted('stop', $timesheet)) {
    23|                 $event->addAction('stop', ['url' => $this->path('stop_timesheet', ['id' => $timesheet->getId()]), 'class' => 'api-link', 'attr' => ['data-event' => 'kimai.timesheetStop kimai.timesheetUpdate', 'data-method' => 'PATCH', 'data-msg-error' => 'timesheet.stop.error', 'data-msg-success' => 'timesheet.stop.success']]);
    24|             }
    25|             if (!$timesheet->isRunning() && $this->isGranted('start', $timesheet)) {
    26|                 $event->addAction('repeat', ['url' => $this->path('restart_timesheet', ['id' => $timesheet->getId()]), 'class' => 'api-link', 'attr' => ['data-payload' => '{"copy": "all"}', 'data-event' => 'kimai.timesheetStart kimai.timesheetUpdate', 'data-method' => 'PATCH', 'data-msg-error' => 'timesheet.start.error', 'data-msg-success' => 'timesheet.start.success']]);
    27|             }
    28|             if ($this->isGranted('edit', $timesheet)) {
    29|                 $class = $event->isView('edit') ? '' : 'modal-ajax-form';
    30|                 $event->addAction('edit', ['url' => $this->path($routeEdit, ['id' => $timesheet->getId()]), 'class' => $class]);
    31|             }
    32|             if ($this->isGranted('duplicate', $timesheet)) {
    33|                 $class = $event->isView('edit') ? '' : 'modal-ajax-form';
    34|                 $event->addAction('copy', ['url' => $this->path($routeDuplicate, ['id' => $timesheet->getId(), 'token' => $payload['token']]), 'class' => $class]);
    35|             }
    36|             if ($event->countActions() > 0) {
    37|                 $event->addDivider();
    38|             }
    39|             if ($event->isIndexView() && $this->isGranted('delete', $timesheet)) {
    40|                 $event->addAction('trash', [
    41|                     'url' => $this->path('delete_timesheet', ['id' => $timesheet->getId()]),
    42|                     'class' => 'api-link',
    43|                     'attr' => [
    44|                         'data-event' => 'kimai.timesheetDelete',
    45|                         'data-method' => 'DELETE',
    46|                         'data-question' => 'confirm.delete',
    47|                         'data-msg-error' => 'action.delete.error',
    48|                         'data-msg-success' => 'action.delete.success'
    49|                     ]
    50|                 ]);
    51|             }
    52|         }
    53|         if (!$event->isIndexView()) {
    54|             $event->addHelp($this->documentationLink('timesheet.html'));


# ====================================================================
# FILE: src/EventSubscriber/Actions/ProjectSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 40-70 ---
    40|             $event->addActionToSubmenu('filter', 'activity', ['title' => 'activity', 'translation_domain' => 'actions', 'url' => $this->path('admin_activity', ['customers[]' => $project->getCustomer()->getId(), 'projects[]' => $project->getId()])]);
    41|         }
    42|         if ($this->isGranted('view_other_timesheet')) {
    43|             $event->addActionToSubmenu('filter', 'timesheet', ['title' => 'timesheet', 'translation_domain' => 'actions', 'url' => $this->path('admin_timesheet', ['customers[]' => $project->getCustomer()->getId(), 'projects[]' => $project->getId()])]);
    44|         }
    45|         if ($event->hasSubmenu('filter')) {
    46|             $event->addDivider();
    47|         }
    48|         if (!$event->isView('project_details')) {
    49|             if ($project->isVisible() && $project->getCustomer()->isVisible() && $this->isGranted('create_activity')) {
    50|                 $event->addAction('create-activity', [
    51|                     'icon' => 'create',
    52|                     'url' => $this->path('admin_activity_create_with_project', ['project' => $project->getId()]),
    53|                     'class' => 'modal-ajax-form'
    54|                 ]);
    55|             }
    56|         }
    57|         if ($this->isGranted('edit', $project) && $this->isGranted('create_project')) {
    58|             $event->addAction(
    59|                 'copy',
    60|                 ['url' => $this->path('admin_project_duplicate', ['id' => $project->getId(), 'token' => $payload['token']])]
    61|             );
    62|         }
    63|         if (($event->isIndexView() || $event->isView('customer_details')) && $this->isGranted('delete', $project)) {
    64|             $event->addDelete($this->path('admin_project_delete', ['id' => $project->getId()]));
    65|         }
    66|         if ($project->isVisible() && $this->isGranted('view_reporting') && $this->isGranted('details', $project)) {
    67|             $event->addAction('report_project_details', ['url' => $this->path('report_project_details', ['project' => $project->getId()]), 'icon' => 'reporting', 'translation_domain' => 'reporting']);
    68|         }
    69|     }
    70| }


# ====================================================================
# FILE: src/EventSubscriber/Actions/TeamSubscriber.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-45 ---
     8| namespace App\EventSubscriber\Actions;
     9| use App\Entity\Team;
    10| use App\Event\PageActionsEvent;
    11| class TeamSubscriber extends AbstractActionsSubscriber
    12| {
    13|     public static function getActionName(): string
    14|     {
    15|         return 'team';
    16|     }
    17|     public function onActions(PageActionsEvent $event): void
    18|     {
    19|         $payload = $event->getPayload();
    20|         /** @var Team $team */
    21|         $team = $payload['team'];
    22|         if ($team->getId() === null) {
    23|             return;
    24|         }
    25|         if ($this->isGranted('edit', $team)) {
    26|             $event->addAction('edit', ['url' => $this->path('admin_team_edit', ['id' => $team->getId()])]);
    27|             if ($this->isGranted('create_team')) {
    28|                 $event->addAction('copy', ['url' => $this->path('team_duplicate', ['id' => $team->getId(), 'token' => $payload['token']])]);
    29|             }
    30|         }
    31|         if ($event->isIndexView() && $this->isGranted('delete', $team)) {
    32|             $event->addAction('trash', [
    33|                 'url' => $this->path('delete_team', ['id' => $team->getId()]),
    34|                 'class' => 'api-link',
    35|                 'attr' => [
    36|                     'data-event' => 'kimai.teamDelete kimai.teamUpdate',
    37|                     'data-method' => 'DELETE',
    38|                     'data-question' => 'confirm.delete',
    39|                     'data-msg-error' => 'action.delete.error',
    40|                     'data-msg-success' => 'action.delete.success'
    41|                 ]
    42|             ]);
    43|         }
    44|     }
    45| }


# ====================================================================
# FILE: src/Migrations/Version20180701120000.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-43 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * This file is part of the Kimai time-tracking app.
     5|  *
     6|  * For the full copyright and license information, please view the LICENSE
     7|  * file that was distributed with this source code.
     8|  */
     9| namespace DoctrineMigrations;
    10| use App\Doctrine\AbstractMigration;
    11| use Doctrine\DBAL\Schema\Schema;
    12| /**
    13|  * Initial database structure of Kimai 2.
    14|  * This file is mainly required for testing the migrations.
    15|  */
    16| final class Version20180701120000 extends AbstractMigration
    17| {
    18|     public function up(Schema $schema): void
    19|     {
    20|         $this->addSql('CREATE TABLE kimai2_users (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(60) NOT NULL, mail VARCHAR(160) NOT NULL, password VARCHAR(254) DEFAULT NULL, alias VARCHAR(60) DEFAULT NULL, active TINYINT(1) NOT NULL, registration_date DATETIME DEFAULT NULL, title VARCHAR(50) DEFAULT NULL, avatar VARCHAR(255) DEFAULT NULL, roles LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', UNIQUE INDEX UNIQ_B9AC5BCE5E237E06 (name), UNIQUE INDEX UNIQ_B9AC5BCE5126AC48 (mail), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB');
    21|         $this->addSql('CREATE TABLE kimai2_user_preferences (id INT AUTO_INCREMENT NOT NULL, user_id INT DEFAULT NULL, name VARCHAR(50) NOT NULL, value VARCHAR(255) DEFAULT NULL, INDEX IDX_8D08F631A76ED395 (user_id), UNIQUE INDEX UNIQ_8D08F631A76ED3955E237E06 (user_id, name), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB');
    22|         $this->addSql('CREATE TABLE kimai2_customers (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(150) NOT NULL, number VARCHAR(50) DEFAULT NULL, comment TEXT DEFAULT NULL, visible TINYINT(1) NOT NULL, company VARCHAR(255) DEFAULT NULL, contact VARCHAR(255) DEFAULT NULL, address TEXT DEFAULT NULL, country VARCHAR(2) NOT NULL, currency VARCHAR(3) NOT NULL, phone VARCHAR(255) DEFAULT NULL, fax VARCHAR(255) DEFAULT NULL, mobile VARCHAR(255) DEFAULT NULL, mail VARCHAR(255) DEFAULT NULL, homepage VARCHAR(255) DEFAULT NULL, timezone VARCHAR(255) NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB');
    23|         $this->addSql('CREATE TABLE kimai2_projects (id INT AUTO_INCREMENT NOT NULL, customer_id INT DEFAULT NULL, name VARCHAR(150) NOT NULL, order_number TINYTEXT DEFAULT NULL, comment TEXT DEFAULT NULL, visible TINYINT(1) NOT NULL, budget NUMERIC(10, 2) NOT NULL, INDEX IDX_407F12069395C3F3 (customer_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB');
    24|         $this->addSql('CREATE TABLE kimai2_activities (id INT AUTO_INCREMENT NOT NULL, project_id INT DEFAULT NULL, name VARCHAR(150) NOT NULL, comment TEXT DEFAULT NULL, visible TINYINT(1) NOT NULL, INDEX IDX_8811FE1C166D1F9C (project_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB');
    25|         $this->addSql('CREATE TABLE kimai2_timesheet (id INT AUTO_INCREMENT NOT NULL, user INT DEFAULT NULL, activity_id INT DEFAULT NULL, start_time DATETIME NOT NULL, end_time DATETIME DEFAULT NULL, duration INT DEFAULT NULL, description TEXT DEFAULT NULL, rate NUMERIC(10, 2) NOT NULL, INDEX IDX_4F60C6B18D93D649 (user), INDEX IDX_4F60C6B181C06096 (activity_id), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB');
    26|         $this->addSql('CREATE TABLE kimai2_invoice_templates (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(60) NOT NULL, title VARCHAR(255) NOT NULL, company VARCHAR(255) NOT NULL, address TEXT DEFAULT NULL, due_days INT NOT NULL, vat INT DEFAULT NULL, calculator VARCHAR(20) NOT NULL, number_generator VARCHAR(20) NOT NULL, renderer VARCHAR(20) NOT NULL, payment_terms TEXT DEFAULT NULL, UNIQUE INDEX UNIQ_1626CFE95E237E06 (name), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB');
    27|         $this->addSql('ALTER TABLE kimai2_user_preferences ADD CONSTRAINT FK_8D08F631A76ED395 FOREIGN KEY (user_id) REFERENCES kimai2_users (id) ON DELETE CASCADE');
    28|         $this->addSql('ALTER TABLE kimai2_projects ADD CONSTRAINT FK_407F12069395C3F3 FOREIGN KEY (customer_id) REFERENCES kimai2_customers (id) ON DELETE CASCADE');
    29|         $this->addSql('ALTER TABLE kimai2_activities ADD CONSTRAINT FK_8811FE1C166D1F9C FOREIGN KEY (project_id) REFERENCES kimai2_projects (id) ON DELETE CASCADE');
    30|         $this->addSql('ALTER TABLE kimai2_timesheet ADD CONSTRAINT FK_4F60C6B18D93D649 FOREIGN KEY (user) REFERENCES kimai2_users (id)');
    31|         $this->addSql('ALTER TABLE kimai2_timesheet ADD CONSTRAINT FK_4F60C6B181C06096 FOREIGN KEY (activity_id) REFERENCES kimai2_activities (id) ON DELETE CASCADE');
    32|     }
    33|     public function down(Schema $schema): void
    34|     {
    35|         $schema->dropTable('kimai2_invoice_templates');
    36|         $schema->dropTable('kimai2_timesheet');
    37|         $schema->dropTable('kimai2_user_preferences');
    38|         $schema->dropTable('kimai2_users');
    39|         $schema->dropTable('kimai2_activities');
    40|         $schema->dropTable('kimai2_projects');
    41|         $schema->dropTable('kimai2_customers');
    42|     }
    43| }


# ====================================================================
# FILE: src/Migrations/Version20180715160326.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 14-79 ---
    14|  * Migration for FOSUserBundle
    15|  *
    16|  * Changes the table structure of "users" table and migrates from json_array type to serialized array,
    17|  * probably also fixing the higher required MariaDB version.
    18|  *
    19|  * This was fixed in earlier migrations for new installations, but it is still in here for users migrating up from a lower version.
    20|  */
    21| final class Version20180715160326 extends AbstractMigration
    22| {
    23|     /**
    24|      * @var Index[]
    25|      */
    26|     protected $indexesOld = [];
    27|     /**
    28|      * @param Schema $schema
    29|      * @throws \Doctrine\DBAL\DBALException
    30|      * @throws \Doctrine\DBAL\Schema\SchemaException
    31|      */
    32|     public function up(Schema $schema): void
    33|     {
    34|         $indexesOld = $schema->getTable('kimai2_users')->getIndexes();
    35|         foreach ($indexesOld as $index) {
    36|             if (\in_array('name', $index->getColumns()) || \in_array('mail', $index->getColumns())) {
    37|                 $this->indexesOld[] = $index;
    38|                 $this->addSql('DROP INDEX ' . $index->getName() . ' ON kimai2_users');
    39|             }
    40|         }
    41|         $this->addSql('ALTER TABLE kimai2_users CHANGE name username VARCHAR(180) NOT NULL, ADD username_canonical VARCHAR(180) NOT NULL, CHANGE mail email VARCHAR(180) NOT NULL, ADD email_canonical VARCHAR(180) NOT NULL, ADD salt VARCHAR(255) DEFAULT NULL, ADD last_login DATETIME DEFAULT NULL, ADD confirmation_token VARCHAR(180) DEFAULT NULL, ADD password_requested_at DATETIME DEFAULT NULL, CHANGE password password VARCHAR(255) NOT NULL, CHANGE alias alias VARCHAR(60) DEFAULT NULL, CHANGE registration_date registration_date DATETIME DEFAULT NULL, CHANGE title title VARCHAR(50) DEFAULT NULL, CHANGE avatar avatar VARCHAR(255) DEFAULT NULL, CHANGE roles roles LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', CHANGE active enabled TINYINT(1) NOT NULL');
    42|         $this->addSql('UPDATE kimai2_users set username_canonical = username');
    43|         $this->addSql('UPDATE kimai2_users set email_canonical = email');
    44|         $this->addSql('UPDATE kimai2_users SET roles = \'a:1:{i:0;s:16:"ROLE_SUPER_ADMIN";}\' WHERE roles LIKE \'%ROLE_SUPER_ADMIN%\'');
    45|         $this->addSql('UPDATE kimai2_users SET roles = \'a:1:{i:0;s:10:"ROLE_ADMIN";}\' WHERE roles LIKE \'%ROLE_ADMIN%\'');
    46|         $this->addSql('UPDATE kimai2_users SET roles = \'a:1:{i:0;s:13:"ROLE_TEAMLEAD";}\' WHERE roles LIKE \'%ROLE_TEAMLEAD%\'');
    47|         $this->addSql('UPDATE kimai2_users SET roles = \'a:0:{}\' WHERE roles LIKE \'%ROLE_USER%\'');
    48|         $this->addSql('UPDATE kimai2_users SET roles = \'a:1:{i:0;s:13:"ROLE_CUSTOMER";}\' WHERE roles LIKE \'%ROLE_CUSTOMER%\'');
    49|         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCE92FC23A8 ON kimai2_users (username_canonical)');
    50|         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEA0D96FBF ON kimai2_users (email_canonical)');
    51|         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEC05FB297 ON kimai2_users (confirmation_token)');
    52|         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEF85E0677 ON kimai2_users (username)');
    53|         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEE7927C74 ON kimai2_users (email)');
    54|     }
    55|     /**
    56|      * @param Schema $schema
    57|      * @throws \Doctrine\DBAL\DBALException
    58|      * @throws \Doctrine\DBAL\Schema\SchemaException
    59|      */
    60|     public function down(Schema $schema): void
    61|     {
    62|         $indexToDelete = ['UNIQ_B9AC5BCE92FC23A8', 'UNIQ_B9AC5BCEA0D96FBF', 'UNIQ_B9AC5BCEC05FB297', 'UNIQ_B9AC5BCEF85E0677', 'UNIQ_B9AC5BCEE7927C74'];
    63|         foreach ($indexToDelete as $indexName) {
    64|             $this->addSql('DROP INDEX ' . $indexName . ' ON kimai2_users');
    65|         }
    66|         $this->addSql('ALTER TABLE kimai2_users CHANGE username name VARCHAR(60) NOT NULL COLLATE utf8mb4_unicode_ci, CHANGE email mail VARCHAR(160) NOT NULL COLLATE utf8mb4_unicode_ci, DROP username_canonical, DROP email_canonical, DROP salt, DROP last_login, DROP confirmation_token, DROP password_requested_at, CHANGE password password VARCHAR(254) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE roles roles LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', CHANGE alias alias VARCHAR(60) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE registration_date registration_date DATETIME DEFAULT NULL, CHANGE title title VARCHAR(50) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE avatar avatar VARCHAR(255) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE enabled active TINYINT(1) NOT NULL');
    67|         $this->addSql('UPDATE kimai2_users SET roles = \'["ROLE_SUPER_ADMIN"]\' WHERE roles LIKE \'%ROLE_SUPER_ADMIN%\'');
    68|         $this->addSql('UPDATE kimai2_users SET roles = \'["ROLE_ADMIN"]\' WHERE roles LIKE \'%ROLE_ADMIN%\'');
    69|         $this->addSql('UPDATE kimai2_users SET roles = \'["ROLE_TEAMLEAD"]\' WHERE roles LIKE \'%ROLE_TEAMLEAD%\'');
    70|         $this->addSql('UPDATE kimai2_users SET roles = \'["ROLE_USER"]\' WHERE roles LIKE \'%ROLE_USER%\'');
    71|         $this->addSql('UPDATE kimai2_users SET roles = \'["ROLE_CUSTOMER"]\' WHERE roles LIKE \'%ROLE_CUSTOMER%\'');
    72|         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCE5E237E06 ON kimai2_users (name)');
    73|         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCE5126AC48 ON kimai2_users (mail)');
    74|         $usersTable = $schema->getTable('kimai2_users');
    75|         foreach ($this->indexesOld as $index) {
    76|             $usersTable->addIndex($index->getColumns(), $index->getName(), $index->getFlags(), $index->getOptions());
    77|         }
    78|     }
    79| }


# ====================================================================
# FILE: src/Migrations/Version20180730044139.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-42 ---
    10| use App\Doctrine\AbstractMigration;
    11| use Doctrine\DBAL\Schema\Index;
    12| use Doctrine\DBAL\Schema\Schema;
    13| /**
    14|  * Migrations fot the "delete user" feature.
    15|  *
    16|  * Adds constraints to the timesheet table, so all timesheet entries will be deleted when a user is deleted.
    17|  */
    18| final class Version20180730044139 extends AbstractMigration
    19| {
    20|     /**
    21|      * @var Index[]
    22|      */
    23|     protected $indexesOld = [];
    24|     /**
    25|      * @param Schema $schema
    26|      * @throws \Doctrine\DBAL\DBALException
    27|      */
    28|     public function up(Schema $schema): void
    29|     {
    30|         $this->addSql('ALTER TABLE kimai2_timesheet DROP FOREIGN KEY FK_4F60C6B18D93D649');
    31|         $this->addSql('ALTER TABLE kimai2_timesheet ADD CONSTRAINT FK_4F60C6B18D93D649 FOREIGN KEY (user) REFERENCES kimai2_users (id) ON DELETE CASCADE');
    32|     }
    33|     /**
    34|      * @param Schema $schema
    35|      * @throws \Doctrine\DBAL\DBALException
    36|      */
    37|     public function down(Schema $schema): void
    38|     {
    39|         $this->addSql('ALTER TABLE kimai2_timesheet DROP FOREIGN KEY FK_4F60C6B18D93D649');
    40|         $this->addSql('ALTER TABLE kimai2_timesheet ADD CONSTRAINT FK_4F60C6B18D93D649 FOREIGN KEY (user) REFERENCES kimai2_users (id)');
    41|     }
    42| }


# ====================================================================
# FILE: src/Migrations/Version20180924111853.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * This file is part of the Kimai time-tracking app.
     5|  *
     6|  * For the full copyright and license information, please view the LICENSE
     7|  * file that was distributed with this source code.
     8|  */
     9| namespace DoctrineMigrations;
    10| use App\Doctrine\AbstractMigration;
    11| use Doctrine\DBAL\Schema\Schema;
    12| /**
    13|  * Changes the invoice templates table for:
    14|  * - shorter template name and proper index name
    15|  * - VAT supporting percentages
    16|  */
    17| final class Version20180924111853 extends AbstractMigration
    18| {
    19|     public function up(Schema $schema): void
    20|     {
    21|         $this->addSql('UPDATE kimai2_invoice_templates SET name=SUBSTRING(name, 1, 60)');
    22|         $this->addSql('ALTER TABLE kimai2_invoice_templates CHANGE name name VARCHAR(60) NOT NULL, CHANGE vat vat DOUBLE PRECISION DEFAULT 0');
    23|     }
    24|     public function down(Schema $schema): void
    25|     {
    26|         $this->addSql('ALTER TABLE kimai2_invoice_templates CHANGE name name VARCHAR(255) NOT NULL COLLATE utf8mb4_unicode_ci, CHANGE vat vat INT DEFAULT NULL');
    27|     }
    28| }


# ====================================================================
# FILE: src/Migrations/Version20181031220003.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-42 ---
     1| <?php
     2| declare(strict_types=1);
     3| /*
     4|  * This file is part of the Kimai time-tracking app.
     5|  *
     6|  * For the full copyright and license information, please view the LICENSE
     7|  * file that was distributed with this source code.
     8|  */
     9| namespace DoctrineMigrations;
    10| use App\Doctrine\AbstractMigration;
    11| use Doctrine\DBAL\Schema\Schema;
    12| /**
    13|  * Migration that adds the project column to timesheets table, to allow global activities.
    14|  * It also fixes foreign-key columns on timesheet and projects table, which are not allowed.
    15|  */
    16| final class Version20181031220003 extends AbstractMigration
    17| {
    18|     public function up(Schema $schema): void
    19|     {
    20|         $this->addSql('ALTER TABLE kimai2_projects DROP FOREIGN KEY FK_407F12069395C3F3');
    21|         $this->addSql('ALTER TABLE kimai2_projects CHANGE customer_id customer_id INT NOT NULL');
    22|         $this->addSql('ALTER TABLE kimai2_projects ADD CONSTRAINT FK_407F12069395C3F3 FOREIGN KEY (customer_id) REFERENCES kimai2_customers (id) ON DELETE CASCADE');
    23|         $this->addSql('ALTER TABLE kimai2_timesheet ADD project_id INT DEFAULT NULL AFTER activity_id');
    24|         $this->addSql('CREATE INDEX IDX_4F60C6B1166D1F9C ON kimai2_timesheet (project_id)');
    25|         $this->addSql('UPDATE kimai2_timesheet SET project_id = (SELECT project_id FROM kimai2_activities WHERE id = activity_id)');
    26|         $this->addSql('ALTER TABLE kimai2_timesheet DROP FOREIGN KEY FK_4F60C6B18D93D649');
    27|         $this->addSql('ALTER TABLE kimai2_timesheet DROP FOREIGN KEY FK_4F60C6B181C06096');
    28|         $this->addSql('ALTER TABLE kimai2_timesheet CHANGE project_id project_id INT NOT NULL, CHANGE user user INT NOT NULL, CHANGE activity_id activity_id INT NOT NULL');
    29|         $this->addSql('ALTER TABLE kimai2_timesheet ADD CONSTRAINT FK_4F60C6B1166D1F9C FOREIGN KEY (project_id) REFERENCES kimai2_projects (id) ON DELETE CASCADE');
    30|         $this->addSql('ALTER TABLE kimai2_timesheet ADD CONSTRAINT FK_4F60C6B18D93D649 FOREIGN KEY (user) REFERENCES kimai2_users (id) ON DELETE CASCADE');
    31|         $this->addSql('ALTER TABLE kimai2_timesheet ADD CONSTRAINT FK_4F60C6B181C06096 FOREIGN KEY (activity_id) REFERENCES kimai2_activities (id) ON DELETE CASCADE');
    32|     }
    33|     public function down(Schema $schema): void
    34|     {
    35|         $this->addSql('ALTER TABLE kimai2_projects DROP FOREIGN KEY FK_407F12069395C3F3');
    36|         $this->addSql('ALTER TABLE kimai2_projects CHANGE customer_id customer_id INT DEFAULT NULL');
    37|         $this->addSql('ALTER TABLE kimai2_projects ADD CONSTRAINT FK_407F12069395C3F3 FOREIGN KEY (customer_id) REFERENCES kimai2_customers (id) ON DELETE CASCADE');
    38|         $this->addSql('ALTER TABLE kimai2_timesheet DROP FOREIGN KEY FK_4F60C6B1166D1F9C');
    39|         $this->addSql('DROP INDEX IDX_4F60C6B1166D1F9C ON kimai2_timesheet');
    40|         $this->addSql('ALTER TABLE kimai2_timesheet DROP project_id, CHANGE user user INT DEFAULT NULL, CHANGE activity_id activity_id INT DEFAULT NULL');
    41|     }
    42| }


# ====================================================================
# FILE: src/Migrations/Version20190305152308.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-35 ---
     3| /*
     4|  * This file is part of the Kimai time-tracking app.
     5|  *
     6|  * For the full copyright and license information, please view the LICENSE
     7|  * file that was distributed with this source code.
     8|  */
     9| namespace DoctrineMigrations;
    10| use App\Doctrine\AbstractMigration;
    11| use Doctrine\DBAL\Schema\Schema;
    12| /**
    13|  * - rename mail to email in customer table
    14|  * - converts all decimal to float values, as decimals are treated as string in PHP:
    15|  *   https://www.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/types.html#decimal
    16|  *
    17|  * @version 0.9
    18|  */
    19| final class Version20190305152308 extends AbstractMigration
    20| {
    21|     public function up(Schema $schema): void
    22|     {
    23|         $this->addSql('ALTER TABLE kimai2_activities CHANGE fixed_rate fixed_rate DOUBLE PRECISION DEFAULT NULL, CHANGE hourly_rate hourly_rate DOUBLE PRECISION DEFAULT NULL');
    24|         $this->addSql('ALTER TABLE kimai2_customers CHANGE mail email VARCHAR(255) DEFAULT NULL, CHANGE fixed_rate fixed_rate DOUBLE PRECISION DEFAULT NULL, CHANGE hourly_rate hourly_rate DOUBLE PRECISION DEFAULT NULL');
    25|         $this->addSql('ALTER TABLE kimai2_projects CHANGE budget budget DOUBLE PRECISION NOT NULL, CHANGE fixed_rate fixed_rate DOUBLE PRECISION DEFAULT NULL, CHANGE hourly_rate hourly_rate DOUBLE PRECISION DEFAULT NULL');
    26|         $this->addSql('ALTER TABLE kimai2_timesheet CHANGE rate rate DOUBLE PRECISION NOT NULL, CHANGE fixed_rate fixed_rate DOUBLE PRECISION DEFAULT NULL, CHANGE hourly_rate hourly_rate DOUBLE PRECISION DEFAULT NULL');
    27|     }
    28|     public function down(Schema $schema): void
    29|     {
    30|         $this->addSql('ALTER TABLE kimai2_activities CHANGE fixed_rate fixed_rate NUMERIC(10, 2) DEFAULT NULL, CHANGE hourly_rate hourly_rate NUMERIC(10, 2) DEFAULT NULL');
    31|         $this->addSql('ALTER TABLE kimai2_customers CHANGE email mail VARCHAR(255) DEFAULT NULL, CHANGE fixed_rate fixed_rate NUMERIC(10, 2) DEFAULT NULL, CHANGE hourly_rate hourly_rate NUMERIC(10, 2) DEFAULT NULL');
    32|         $this->addSql('ALTER TABLE kimai2_projects CHANGE budget budget NUMERIC(10, 2) NOT NULL, CHANGE fixed_rate fixed_rate NUMERIC(10, 2) DEFAULT NULL, CHANGE hourly_rate hourly_rate NUMERIC(10, 2) DEFAULT NULL');
    33|         $this->addSql('ALTER TABLE kimai2_timesheet CHANGE rate rate NUMERIC(10, 2) NOT NULL, CHANGE fixed_rate fixed_rate NUMERIC(10, 2) DEFAULT NULL, CHANGE hourly_rate hourly_rate NUMERIC(10, 2) DEFAULT NULL');
    34|     }
    35| }


# ====================================================================
# FILE: src/Migrations/Version20210802152814.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 17-45 ---
    17|     public function getDescription(): string
    18|     {
    19|         return 'Fills the new date column in the timesheet table';
    20|     }
    21|     public function up(Schema $schema): void
    22|     {
    23|         $fetch = $this->connection->prepare('SELECT id, start_time, timezone FROM kimai2_timesheet WHERE date_tz IS NULL');
    24|         $timezones = [];
    25|         foreach (\DateTimeZone::listIdentifiers() as $tz) {
    26|             $timezones[$tz] = new \DateTimeZone($tz);
    27|         }
    28|         foreach ($fetch->executeQuery()->iterateAssociative() as $row) {
    29|             if (!isset($timezones[$row['timezone']])) {
    30|                 $timezones[$row['timezone']] = new \DateTimeZone($row['timezone']);
    31|             }
    32|             $date = new \DateTime($row['start_time'], $timezones['UTC']);
    33|             $date->setTimezone($timezones[$row['timezone']]);
    34|             $this->addSql('UPDATE kimai2_timesheet SET date_tz = ? WHERE id = ?', [$date->format('Y-m-d'), $row['id']]);
    35|         }
    36|         $fetch->free();
    37|         $this->addSql('ALTER TABLE kimai2_timesheet ALTER date_tz DROP DEFAULT');
    38|     }
    39|     public function down(Schema $schema): void
    40|     {
    41|         $timesheet = $schema->getTable('kimai2_timesheet');
    42|         $timesheet->changeColumn('date_tz', ['notnull' => false]);
    43|         $this->preventEmptyMigrationWarning();
    44|     }
    45| }


# ====================================================================
# FILE: src/Migrations/Version20211008092010.php
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-34 ---
     6|  * For the full copyright and license information, please view the LICENSE
     7|  * file that was distributed with this source code.
     8|  */
     9| namespace DoctrineMigrations;
    10| use App\Doctrine\AbstractMigration;
    11| use Doctrine\DBAL\Schema\Schema;
    12| /**
    13|  * @version 1.16
    14|  */
    15| final class Version20211008092010 extends AbstractMigration
    16| {
    17|     public function getDescription(): string
    18|     {
    19|         return 'Extend field orderNumber from 20 to 50 characters.';
    20|     }
    21|     public function up(Schema $schema): void
    22|     {
    23|         $projects = $schema->getTable('kimai2_projects');
    24|         $column = $projects->getColumn('order_number');
    25|         $column->setOptions(['length' => 50]);
    26|         $this->preventEmptyMigrationWarning();
    27|     }
    28|     public function down(Schema $schema): void
    29|     {
    30|         $projects = $schema->getTable('kimai2_projects');
    31|         $column = $projects->getColumn('order_number');
    32|         $column->setOptions(['length' => 20]);
    33|     }
    34| }

