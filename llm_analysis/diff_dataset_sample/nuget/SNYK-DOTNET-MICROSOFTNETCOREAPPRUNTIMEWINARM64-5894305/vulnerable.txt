# ====================================================================
# FILE: eng/actions/backport/index.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-116 ---
     1| function BackportException(message, postToGitHub = true) {
     2|   this.message = message;
     3|   this.postToGitHub = postToGitHub;
     4| }
     5| async function run() {
     6|   const util = require("util");
     7|   const jsExec = util.promisify(require("child_process").exec);
     8|   console.log("Installing npm dependencies");
     9|   const { stdout, stderr } = await jsExec("npm install @actions/core @actions/github @actions/exec");
    10|   console.log("npm-install stderr:\n\n" + stderr);
    11|   console.log("npm-install stdout:\n\n" + stdout);
    12|   console.log("Finished installing npm dependencies");
    13|   const core = require("@actions/core");
    14|   const github = require("@actions/github");
    15|   const exec = require("@actions/exec");
    16|   const repo_owner = github.context.payload.repository.owner.login;
    17|   const repo_name = github.context.payload.repository.name;
    18|   const pr_number = github.context.payload.issue.number;
    19|   const comment_user = github.context.payload.comment.user.login;
    20|   let octokit = github.getOctokit(core.getInput("auth_token", { required: true }));
    21|   let target_branch = core.getInput("target_branch", { required: true });
    22|   try {
    23|     try {
    24|       await octokit.rest.repos.checkCollaborator({
    25|         owner: repo_owner,
    26|         repo: repo_name,
    27|         username: comment_user
    28|       });
    29|       console.log(`Verified ${comment_user} is a repo collaborator.`);
    30|     } catch (error) {
    31|       console.log(error);
    32|       throw new BackportException(`Error: @${comment_user} is not a repo collaborator, backporting is not allowed.`);
    33|     }
    34|     try { await exec.exec(`git ls-remote --exit-code --heads origin ${target_branch}`) } catch { throw new BackportException(`Error: The specified backport target branch ${target_branch} wasn't found in the repo.`); }
    35|     console.log(`Backport target branch: ${target_branch}`);
    36|     console.log("Applying backport patch");
    37|     await exec.exec(`git checkout ${target_branch}`);
    38|     await exec.exec(`git clean -xdff`);
    39|     await exec.exec(`git config user.name "github-actions"`);
    40|     await exec.exec(`git config user.email "github-actions@github.com"`);
    41|     const temp_branch = `backport/pr-${pr_number}-to-${target_branch}`;
    42|     await exec.exec(`git checkout -b ${temp_branch}`);
    43|     let should_open_pull_request = true;
    44|     try {
    45|       await exec.exec(`git ls-remote --exit-code --heads origin ${temp_branch}`);
    46|       should_open_pull_request = false;
    47|     } catch { }
    48|     await exec.exec(`curl -sSL "${github.context.payload.issue.pull_request.patch_url}" --output changes.patch`);
    49|     const git_am_command = "git am --3way --ignore-whitespace --keep-non-patch changes.patch";
    50|     let git_am_output = `$ ${git_am_command}\n\n`;
    51|     let git_am_failed = false;
    52|     try {
    53|       await exec.exec(git_am_command, [], {
    54|         listeners: {
    55|           stdout: function stdout(data) { git_am_output += data; },
    56|           stderr: function stderr(data) { git_am_output += data; }
    57|         }
    58|       });
    59|     } catch (error) {
    60|       git_am_output += error;
    61|       git_am_failed = true;
    62|     }
    63|     if (git_am_failed) {
    64|       const git_am_failed_body = `@${github.context.payload.comment.user.login} backporting to ${target_branch} failed, the patch most likely resulted in conflicts:\n\n\`\`\`shell\n${git_am_output}\n\`\`\`\n\nPlease backport manually!`;
    65|       await octokit.rest.issues.createComment({
    66|         owner: repo_owner,
    67|         repo: repo_name,
    68|         issue_number: pr_number,
    69|         body: git_am_failed_body
    70|       });
    71|       throw new BackportException("Error: git am failed, most likely due to a merge conflict.", false);
    72|     }
    73|     else {
    74|       await exec.exec(`git push --force --set-upstream origin HEAD:${temp_branch}`);
    75|     }
    76|     if (!should_open_pull_request) {
    77|       console.log("Backport temp branch already exists, skipping opening a PR.");
    78|       return;
    79|     }
    80|     let backport_pr_title = core.getInput("pr_title_template");
    81|     let backport_pr_description = core.getInput("pr_description_template");
    82|     let cc_users = `@${comment_user}`;
    83|     if (comment_user != github.context.payload.issue.user.login) cc_users += ` @${github.context.payload.issue.user.login}`;
    84|     backport_pr_title = backport_pr_title
    85|       .replace(/%target_branch%/g, target_branch)
    86|       .replace(/%source_pr_title%/g, github.context.payload.issue.title)
    87|       .replace(/%source_pr_number%/g, github.context.payload.issue.number)
    88|       .replace(/%cc_users%/g, cc_users);
    89|     backport_pr_description = backport_pr_description
    90|       .replace(/%target_branch%/g, target_branch)
    91|       .replace(/%source_pr_title%/g, github.context.payload.issue.title)
    92|       .replace(/%source_pr_number%/g, github.context.payload.issue.number)
    93|       .replace(/%cc_users%/g, cc_users);
    94|     await octokit.rest.pulls.create({
    95|       owner: repo_owner,
    96|       repo: repo_name,
    97|       title: backport_pr_title,
    98|       body: backport_pr_description,
    99|       head: temp_branch,
   100|       base: target_branch
   101|     });
   102|     console.log("Successfully opened the GitHub PR.");
   103|   } catch (error) {
   104|     core.setFailed(error);
   105|     if (error.postToGitHub === undefined || error.postToGitHub == true) {
   106|       const unknown_error_body = `@${comment_user} an error occurred while backporting to ${target_branch}, please check the run log for details!\n\n${error.message}`;
   107|       await octokit.rest.issues.createComment({
   108|         owner: repo_owner,
   109|         repo: repo_name,
   110|         issue_number: pr_number,
   111|         body: unknown_error_body
   112|       });
   113|     }
   114|   }
   115| }
   116| run();


# ====================================================================
# FILE: eng/build.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-419 ---
     1| set -ue
     2| source="${BASH_SOURCE[0]}"
     3| while [[ -h "$source" ]]; do
     4|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     5|   source="$(readlink "$source")"
     6|   [[ $source != /* ]] && source="$scriptroot/$source"
     7| done
     8| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     9| usage()
    10| {
    11|   echo "Common settings:"
    12|   echo "  --arch (-a)                     Target platform: x86, x64, arm, armel, arm64, s390x or wasm."
    13|   echo "                                  [Default: Your machine's architecture.]"
    14|   echo "  --binaryLog (-bl)               Output binary log."
    15|   echo "  --cross                         Optional argument to signify cross compilation."
    16|   echo "  --configuration (-c)            Build configuration: Debug, Release or Checked."
    17|   echo "                                  Checked is exclusive to the CLR subset. It is the same as Debug, except code is"
    18|   echo "                                  compiled with optimizations enabled."
    19|   echo "                                  [Default: Debug]"
    20|   echo "  --help (-h)                     Print help and exit."
    21|   echo "  --librariesConfiguration (-lc)  Libraries build configuration: Debug or Release."
    22|   echo "                                  [Default: Debug]"
    23|   echo "  --os                            Target operating system: windows, Linux, FreeBSD, OSX, MacCatalyst, tvOS,"
    24|   echo "                                  tvOSSimulator, iOS, iOSSimulator, Android, Browser, NetBSD, illumos or Solaris."
    25|   echo "                                  [Default: Your machine's OS.]"
    26|   echo "  --projects <value>              Project or solution file(s) to build."
    27|   echo "  --runtimeConfiguration (-rc)    Runtime build configuration: Debug, Release or Checked."
    28|   echo "                                  Checked is exclusive to the CLR runtime. It is the same as Debug, except code is"
    29|   echo "                                  compiled with optimizations enabled."
    30|   echo "                                  [Default: Debug]"
    31|   echo "  -runtimeFlavor (-rf)            Runtime flavor: CoreCLR or Mono."
    32|   echo "                                  [Default: CoreCLR]"
    33|   echo "  --subset (-s)                   Build a subset, print available subsets with -subset help."
    34|   echo "                                 '--subset' can be omitted if the subset is given as the first argument."
    35|   echo "                                  [Default: Builds the entire repo.]"
    36|   echo "  --verbosity (-v)                MSBuild verbosity: q[uiet], m[inimal], n[ormal], d[etailed], and diag[nostic]."
    37|   echo "                                  [Default: Minimal]"
    38|   echo ""
    39|   echo "Actions (defaults to --restore --build):"
    40|   echo "  --build (-b)               Build all source projects."
    41|   echo "                             This assumes --restore has been run already."
    42|   echo "  --clean                    Clean the solution."
    43|   echo "  --pack                     Package build outputs into NuGet packages."
    44|   echo "  --publish                  Publish artifacts (e.g. symbols)."
    45|   echo "                             This assumes --build has been run already."
    46|   echo "  --rebuild                  Rebuild all source projects."
    47|   echo "  --restore (-r)             Restore dependencies."
    48|   echo "  --sign                     Sign build outputs."
    49|   echo "  --test (-t)                Incrementally builds and runs tests."
    50|   echo "                             Use in conjuction with --testnobuild to only run tests."
    51|   echo ""
    52|   echo "Libraries settings:"
    53|   echo "  --allconfigurations        Build packages for all build configurations."
    54|   echo "  --coverage                 Collect code coverage when testing."
    55|   echo "  --framework (-f)           Build framework: net6.0 or net48."
    56|   echo "                             [Default: net6.0]"
    57|   echo "  --testnobuild              Skip building tests when invoking -test."
    58|   echo "  --testscope                Test scope, allowed values: innerloop, outerloop, all."
    59|   echo ""
    60|   echo "Native build settings:"
    61|   echo "  --clang                    Optional argument to build using clang in PATH (default)."
    62|   echo "  --clangx                   Optional argument to build using clang version x (used for Clang 7 and newer)."
    63|   echo "  --clangx.y                 Optional argument to build using clang version x.y (used for Clang 6 and older)."
    64|   echo "  --cmakeargs                User-settable additional arguments passed to CMake."
    65|   echo "  --gcc                      Optional argument to build using gcc in PATH (default)."
    66|   echo "  --gccx.y                   Optional argument to build using gcc version x.y."
    67|   echo "  --portablebuild            Optional argument: set to false to force a non-portable build."
    68|   echo "  --keepnativesymbols        Optional argument: set to true to keep native symbols/debuginfo in generated binaries."
    69|   echo "  --ninja                    Optional argument: set to true to use Ninja instead of Make to run the native build."
    70|   echo "  --pgoinstrument            Optional argument: build PGO-instrumented runtime"
    71|   echo ""
    72|   echo "Command line arguments starting with '/p:' are passed through to MSBuild."
    73|   echo "Arguments can also be passed in with a single hyphen."
    74|   echo ""
    75|   echo "Here are some quick examples. These assume you are on a Linux x64 machine:"
    76|   echo ""
    77|   echo "* Build CoreCLR for Linux x64 on Release configuration:"
    78|   echo "./build.sh clr -c release"
    79|   echo ""
    80|   echo "* Build Debug libraries with a Release runtime for Linux x64."
    81|   echo "./build.sh clr+libs -rc release"
    82|   echo ""
    83|   echo "* Build Release libraries and their tests with a Checked runtime for Linux x64, and run the tests."
    84|   echo "./build.sh clr+libs+libs.tests -rc checked -lc release -test"
    85|   echo ""
    86|   echo "* Build CoreCLR for Linux x64 on Debug configuration using Clang 9."
    87|   echo "./build.sh clr -clang9"
    88|   echo ""
    89|   echo "* Build CoreCLR for Linux x64 on Debug configuration using GCC 8.4."
    90|   echo "./build.sh clr -gcc8.4"
    91|   echo ""
    92|   echo "* Build CoreCLR for Linux x64 using extra compiler flags (-fstack-clash-protection)."
    93|   echo "EXTRA_CFLAGS=-fstack-clash-protection EXTRA_CXXFLAGS=-fstack-clash-protection ./build.sh clr"
    94|   echo ""
    95|   echo "* Cross-compile CoreCLR runtime for Linux ARM64 on Release configuration."
    96|   echo "./build.sh clr.runtime -arch arm64 -c release -cross"
    97|   echo ""
    98|   echo "However, for this example, you need to already have ROOTFS_DIR set up."
    99|   echo "Further information on this can be found here:"
   100|   echo "https://github.com/dotnet/runtime/blob/main/docs/workflow/building/coreclr/linux-instructions.md"
   101|   echo ""
   102|   echo "* Build Mono runtime for Linux x64 on Release configuration."
   103|   echo "./build.sh mono -c release"
   104|   echo ""
   105|   echo "* Build Release coreclr corelib, crossgen corelib and update Debug libraries testhost to run test on an updated corelib."
   106|   echo "./build.sh clr.corelib+clr.nativecorelib+libs.pretest -rc release"
   107|   echo ""
   108|   echo "* Build Debug mono corelib and update Release libraries testhost to run test on an updated corelib."
   109|   echo "./build.sh mono.corelib+libs.pretest -rc debug -c release"
   110|   echo ""
   111|   echo ""
   112|   echo "For more general information, check out https://github.com/dotnet/runtime/blob/main/docs/workflow/README.md"
   113| }
   114| initDistroRid()
   115| {
   116|     source "$scriptroot"/native/init-distro-rid.sh
   117|     local passedRootfsDir=""
   118|     local targetOs="$1"
   119|     local buildArch="$2"
   120|     local isCrossBuild="$3"
   121|     local isPortableBuild="$4"
   122|     if [[ $isCrossBuild == 1 && "$targetOs" != "OSX" ]]; then
   123|         passedRootfsDir=${ROOTFS_DIR}
   124|     fi
   125|     initDistroRidGlobal ${targetOs} ${buildArch} ${isPortableBuild} ${passedRootfsDir}
   126| }
   127| showSubsetHelp()
   128| {
   129|   "$scriptroot/common/build.sh" "-restore" "-build" "/p:Subset=help" "/clp:nosummary"
   130| }
   131| arguments=''
   132| cmakeargs=''
   133| extraargs=''
   134| crossBuild=0
   135| portableBuild=1
   136| source $scriptroot/native/init-os-and-arch.sh
   137| hostArch=$arch
   138| declare -a actions=("b" "build" "r" "restore" "rebuild" "testnobuild" "sign" "publish" "clean")
   139| actInt=($(comm -12 <(printf '%s\n' "${actions[@]/#/-}" | sort) <(printf '%s\n' "${@/#--/-}" | sort)))
   140| firstArgumentChecked=0
   141| while [[ $# > 0 ]]; do
   142|   opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
   143|   if [[ $firstArgumentChecked -eq 0 && $opt =~ ^[a-zA-Z.+]+$ ]]; then
   144|     if [ $opt == "help" ]; then
   145|       showSubsetHelp
   146|       exit 0
   147|     fi
   148|     arguments="$arguments /p:Subset=$1"
   149|     shift 1
   150|     continue
   151|   fi
   152|   firstArgumentChecked=1
   153|   case "$opt" in
   154|      -help|-h|-\?|/?)
   155|       usage
   156|       exit 0
   157|       ;;
   158|      -subset|-s)
   159|       if [ -z ${2+x} ]; then
   160|         showSubsetHelp
   161|         exit 0
   162|       else
   163|         passedSubset="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   164|         if [ $passedSubset == "help" ]; then
   165|           showSubsetHelp
   166|           exit 0
   167|         fi
   168|         arguments="$arguments /p:Subset=$2"
   169|         shift 2
   170|       fi
   171|       ;;
   172|      -arch|-a)
   173|       if [ -z ${2+x} ]; then
   174|         echo "No architecture supplied. See help (--help) for supported architectures." 1>&2
   175|         exit 1
   176|       fi
   177|       passedArch="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   178|       case "$passedArch" in
   179|         x64|x86|arm|armel|arm64|s390x|wasm)
   180|           arch=$passedArch
   181|           ;;
   182|         *)
   183|           echo "Unsupported target architecture '$2'."
   184|           echo "The allowed values are x86, x64, arm, armel, arm64, s390x, and wasm."
   185|           exit 1
   186|           ;;
   187|       esac
   188|       shift 2
   189|       ;;
   190|      -configuration|-c)
   191|       if [ -z ${2+x} ]; then
   192|         echo "No configuration supplied. See help (--help) for supported configurations." 1>&2
   193|         exit 1
   194|       fi
   195|       passedConfig="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   196|       case "$passedConfig" in
   197|         debug|release|checked)
   198|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedConfig:0:1})${passedConfig:1}"
   199|           ;;
   200|         *)
   201|           echo "Unsupported target configuration '$2'."
   202|           echo "The allowed values are Debug, Release, and Checked."
   203|           exit 1
   204|           ;;
   205|       esac
   206|       arguments="$arguments -configuration $val"
   207|       shift 2
   208|       ;;
   209|      -framework|-f)
   210|       if [ -z ${2+x} ]; then
   211|         echo "No framework supplied. See help (--help) for supported frameworks." 1>&2
   212|         exit 1
   213|       fi
   214|       val="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   215|       arguments="$arguments /p:BuildTargetFramework=$val"
   216|       shift 2
   217|       ;;
   218|      -os)
   219|       if [ -z ${2+x} ]; then
   220|         echo "No target operating system supplied. See help (--help) for supported target operating systems." 1>&2
   221|         exit 1
   222|       fi
   223|       passedOS="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   224|       case "$passedOS" in
   225|         windows)
   226|           os="windows" ;;
   227|         linux)
   228|           os="Linux" ;;
   229|         freebsd)
   230|           os="FreeBSD" ;;
   231|         osx)
   232|           os="OSX" ;;
   233|         maccatalyst)
   234|           os="MacCatalyst" ;;
   235|         tvos)
   236|           os="tvOS" ;;
   237|         tvossimulator)
   238|           os="tvOSSimulator" ;;
   239|         ios)
   240|           os="iOS" ;;
   241|         iossimulator)
   242|           os="iOSSimulator" ;;
   243|         android)
   244|           os="Android" ;;
   245|         browser)
   246|           os="Browser" ;;
   247|         illumos)
   248|           os="illumos" ;;
   249|         solaris)
   250|           os="Solaris" ;;
   251|         *)
   252|           echo "Unsupported target OS '$2'."
   253|           echo "The allowed values are windows, Linux, FreeBSD, OSX, MacCatalyst, tvOS, tvOSSimulator, iOS, iOSSimulator, Android, Browser, illumos and Solaris."
   254|           exit 1
   255|           ;;
   256|       esac
   257|       arguments="$arguments /p:TargetOS=$os"
   258|       shift 2
   259|       ;;
   260|      -allconfigurations)
   261|       arguments="$arguments /p:BuildAllConfigurations=true"
   262|       shift 1
   263|       ;;
   264|      -testscope)
   265|       if [ -z ${2+x} ]; then
   266|         echo "No test scope supplied. See help (--help) for supported test scope values." 1>&2
   267|         exit 1
   268|       fi
   269|       arguments="$arguments /p:TestScope=$2"
   270|       shift 2
   271|       ;;
   272|      -testnobuild)
   273|       arguments="$arguments /p:TestNoBuild=true"
   274|       shift 1
   275|       ;;
   276|      -coverage)
   277|       arguments="$arguments /p:Coverage=true"
   278|       shift 1
   279|       ;;
   280|      -runtimeconfiguration|-rc)
   281|       if [ -z ${2+x} ]; then
   282|         echo "No runtime configuration supplied. See help (--help) for supported runtime configurations." 1>&2
   283|         exit 1
   284|       fi
   285|       passedRuntimeConf="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   286|       case "$passedRuntimeConf" in
   287|         debug|release|checked)
   288|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedRuntimeConf:0:1})${passedRuntimeConf:1}"
   289|           ;;
   290|         *)
   291|           echo "Unsupported runtime configuration '$2'."
   292|           echo "The allowed values are Debug, Release, and Checked."
   293|           exit 1
   294|           ;;
   295|       esac
   296|       arguments="$arguments /p:RuntimeConfiguration=$val"
   297|       shift 2
   298|       ;;
   299|      -runtimeflavor|-rf)
   300|       if [ -z ${2+x} ]; then
   301|         echo "No runtime flavor supplied. See help (--help) for supported runtime flavors." 1>&2
   302|         exit 1
   303|       fi
   304|       passedRuntimeFlav="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   305|       case "$passedRuntimeFlav" in
   306|         coreclr|mono)
   307|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedRuntimeFlav:0:1})${passedRuntimeFlav:1}"
   308|           ;;
   309|         *)
   310|           echo "Unsupported runtime flavor '$2'."
   311|           echo "The allowed values are CoreCLR and Mono."
   312|           exit 1
   313|           ;;
   314|       esac
   315|       arguments="$arguments /p:RuntimeFlavor=$val"
   316|       shift 2
   317|       ;;
   318|      -librariesconfiguration|-lc)
   319|       if [ -z ${2+x} ]; then
   320|         echo "No libraries configuration supplied. See help (--help) for supported libraries configurations." 1>&2
   321|         exit 1
   322|       fi
   323|       passedLibConf="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   324|       case "$passedLibConf" in
   325|         debug|release)
   326|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedLibConf:0:1})${passedLibConf:1}"
   327|           ;;
   328|         *)
   329|           echo "Unsupported libraries configuration '$2'."
   330|           echo "The allowed values are Debug and Release."
   331|           exit 1
   332|           ;;
   333|       esac
   334|       arguments="$arguments /p:LibrariesConfiguration=$val"
   335|       shift 2
   336|       ;;
   337|      -cross)
   338|       crossBuild=1
   339|       arguments="$arguments /p:CrossBuild=True"
   340|       shift 1
   341|       ;;
   342|      -clang*)
   343|       arguments="$arguments /p:Compiler=$opt"
   344|       shift 1
   345|       ;;
   346|      -cmakeargs)
   347|       if [ -z ${2+x} ]; then
   348|         echo "No cmake args supplied." 1>&2
   349|         exit 1
   350|       fi
   351|       cmakeargs="${cmakeargs} ${opt} $2"
   352|       shift 2
   353|       ;;
   354|      -gcc*)
   355|       arguments="$arguments /p:Compiler=$opt"
   356|       shift 1
   357|       ;;
   358|      -portablebuild)
   359|       if [ -z ${2+x} ]; then
   360|         echo "No value for portablebuild is supplied. See help (--help) for supported values." 1>&2
   361|         exit 1
   362|       fi
   363|       passedPortable="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   364|       if [ "$passedPortable" = false ]; then
   365|         portableBuild=0
   366|         arguments="$arguments /p:PortableBuild=false"
   367|       fi
   368|       shift 2
   369|       ;;
   370|      -keepnativesymbols)
   371|       if [ -z ${2+x} ]; then
   372|         echo "No value for keepNativeSymbols is supplied. See help (--help) for supported values." 1>&2
   373|         exit 1
   374|       fi
   375|       passedKeepNativeSymbols="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   376|       if [ "$passedKeepNativeSymbols" = true ]; then
   377|         arguments="$arguments /p:KeepNativeSymbols=true"
   378|       fi
   379|       shift 2
   380|       ;;
   381|       -ninja)
   382|       if [ -z ${2+x} ]; then
   383|         arguments="$arguments /p:Ninja=true"
   384|         shift 1
   385|       else
   386|         ninja="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   387|         if [ "$ninja" = true ]; then
   388|           arguments="$arguments /p:Ninja=true"
   389|           shift 2
   390|         elif [ "$ninja" = false ]; then
   391|           arguments="$arguments /p:Ninja=false"
   392|           shift 2
   393|         else
   394|           arguments="$arguments /p:Ninja=true"
   395|           shift 1
   396|         fi
   397|       fi
   398|       ;;
   399|       -pgoinstrument)
   400|       arguments="$arguments /p:PgoInstrument=true"
   401|       shift 1
   402|       ;;
   403|       *)
   404|       extraargs="$extraargs $1"
   405|       shift 1
   406|       ;;
   407|   esac
   408| done
   409| if [ ${#actInt[@]} -eq 0 ]; then
   410|     arguments="-restore -build $arguments"
   411| fi
   412| if [ "$os" = "Browser" ] && [ "$arch" != "wasm" ]; then
   413|     arch=wasm
   414| fi
   415| initDistroRid $os $arch $crossBuild $portableBuild
   416| cmakeargs="${cmakeargs// /%20}"
   417| arguments="$arguments /p:TargetArchitecture=$arch /p:BuildArchitecture=$hostArch"
   418| arguments="$arguments /p:CMakeArgs=\"$cmakeargs\" $extraargs"
   419| "$scriptroot/common/build.sh" $arguments


# ====================================================================
# FILE: eng/common/SetupNugetSources.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-125 ---
     1| ConfigFile=$1
     2| CredToken=$2
     3| NL='\n'
     4| TB='    '
     5| source="${BASH_SOURCE[0]}"
     6| while [[ -h "$source" ]]; do
     7|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     8|   source="$(readlink "$source")"
     9|   [[ $source != /* ]] && source="$scriptroot/$source"
    10| done
    11| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    12| . "$scriptroot/tools.sh"
    13| if [ ! -f "$ConfigFile" ]; then
    14|     Write-PipelineTelemetryError -Category 'Build' "Error: Eng/common/SetupNugetSources.sh returned a non-zero exit code. Couldn't find the NuGet config file: $ConfigFile"
    15|     ExitWithExitCode 1
    16| fi
    17| if [ -z "$CredToken" ]; then
    18|     Write-PipelineTelemetryError -category 'Build' "Error: Eng/common/SetupNugetSources.sh returned a non-zero exit code. Please supply a valid PAT"
    19|     ExitWithExitCode 1
    20| fi
    21| if [[ `uname -s` == "Darwin" ]]; then
    22|     NL=$'\\\n'
    23|     TB=''
    24| fi
    25| grep -i "<packageSources>" $ConfigFile
    26| if [ "$?" != "0" ]; then
    27|     echo "Adding <packageSources>...</packageSources> section."
    28|     ConfigNodeHeader="<configuration>"
    29|     PackageSourcesTemplate="${TB}<packageSources>${NL}${TB}</packageSources>"
    30|     sed -i.bak "s|$ConfigNodeHeader|$ConfigNodeHeader${NL}$PackageSourcesTemplate|" $ConfigFile
    31| fi
    32| grep -i "<packageSourceCredentials>" $ConfigFile
    33| if [ "$?" != "0" ]; then
    34|     echo "Adding <packageSourceCredentials>...</packageSourceCredentials> section."
    35|     PackageSourcesNodeFooter="</packageSources>"
    36|     PackageSourceCredentialsTemplate="${TB}<packageSourceCredentials>${NL}${TB}</packageSourceCredentials>"
    37|     sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourcesNodeFooter${NL}$PackageSourceCredentialsTemplate|" $ConfigFile
    38| fi
    39| PackageSources=()
    40| grep -i "<add key=\"dotnet3.1\"" $ConfigFile
    41| if [ "$?" == "0" ]; then
    42|     grep -i "<add key=\"dotnet3.1-internal\"" $ConfigFile
    43|     if [ "$?" != "0" ]; then
    44|         echo "Adding dotnet3.1-internal to the packageSources."
    45|         PackageSourcesNodeFooter="</packageSources>"
    46|         PackageSourceTemplate="${TB}<add key=\"dotnet3.1-internal\" value=\"https://pkgs.dev.azure.com/dnceng/_packaging/dotnet3.1-internal/nuget/v2\" />"
    47|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    48|     fi
    49|     PackageSources+=('dotnet3.1-internal')
    50|     grep -i "<add key=\"dotnet3.1-internal-transport\">" $ConfigFile
    51|     if [ "$?" != "0" ]; then
    52|         echo "Adding dotnet3.1-internal-transport to the packageSources."
    53|         PackageSourcesNodeFooter="</packageSources>"
    54|         PackageSourceTemplate="${TB}<add key=\"dotnet3.1-internal-transport\" value=\"https://pkgs.dev.azure.com/dnceng/_packaging/dotnet3.1-internal-transport/nuget/v2\" />"
    55|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    56|     fi
    57|     PackageSources+=('dotnet3.1-internal-transport')
    58| fi
    59| grep -i "<add key=\"dotnet5\"" $ConfigFile
    60| if [ "$?" == "0" ]; then
    61|     grep -i "<add key=\"dotnet5-internal\"" $ConfigFile
    62|     if [ "$?" != "0" ]; then
    63|         echo "Adding dotnet5-internal to the packageSources."
    64|         PackageSourcesNodeFooter="</packageSources>"
    65|         PackageSourceTemplate="${TB}<add key=\"dotnet5-internal\" value=\"https://pkgs.dev.azure.com/dnceng/internal/_packaging/dotnet5-internal/nuget/v2\" />"
    66|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    67|     fi
    68|     PackageSources+=('dotnet5-internal')
    69|     grep -i "<add key=\"dotnet5-internal-transport\">" $ConfigFile
    70|     if [ "$?" != "0" ]; then
    71|         echo "Adding dotnet5-internal-transport to the packageSources."
    72|         PackageSourcesNodeFooter="</packageSources>"
    73|         PackageSourceTemplate="${TB}<add key=\"dotnet5-internal-transport\" value=\"https://pkgs.dev.azure.com/dnceng/internal/_packaging/dotnet5-internal-transport/nuget/v2\" />"
    74|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    75|     fi
    76|     PackageSources+=('dotnet5-internal-transport')
    77| fi
    78| grep -i "<add key=\"dotnet6\"" $ConfigFile
    79| if [ "$?" == "0" ]; then
    80|     grep -i "<add key=\"dotnet6-internal\"" $ConfigFile
    81|     if [ "$?" != "0" ]; then
    82|         echo "Adding dotnet6-internal to the packageSources."
    83|         PackageSourcesNodeFooter="</packageSources>"
    84|         PackageSourceTemplate="${TB}<add key=\"dotnet6-internal\" value=\"https://pkgs.dev.azure.com/dnceng/internal/_packaging/dotnet6-internal/nuget/v2\" />"
    85|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    86|     fi
    87|     PackageSources+=('dotnet6-internal')
    88|     grep -i "<add key=\"dotnet6-internal-transport\">" $ConfigFile
    89|     if [ "$?" != "0" ]; then
    90|         echo "Adding dotnet6-internal-transport to the packageSources."
    91|         PackageSourcesNodeFooter="</packageSources>"
    92|         PackageSourceTemplate="${TB}<add key=\"dotnet6-internal-transport\" value=\"https://pkgs.dev.azure.com/dnceng/internal/_packaging/dotnet6-internal-transport/nuget/v2\" />"
    93|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    94|     fi
    95|     PackageSources+=('dotnet6-internal-transport')
    96| fi
    97| PrevIFS=$IFS
    98| IFS=$'\n'
    99| PackageSources+="$IFS"
   100| PackageSources+=$(grep -oh '"darc-int-[^"]*"' $ConfigFile | tr -d '"')
   101| IFS=$PrevIFS
   102| for FeedName in ${PackageSources[@]} ; do
   103|     grep -i "<$FeedName>" $ConfigFile 
   104|     if [ "$?" != "0" ]; then
   105|         echo "Adding credentials for $FeedName."
   106|         PackageSourceCredentialsNodeFooter="</packageSourceCredentials>"
   107|         NewCredential="${TB}${TB}<$FeedName>${NL}<add key=\"Username\" value=\"dn-bot\" />${NL}<add key=\"ClearTextPassword\" value=\"$CredToken\" />${NL}</$FeedName>"
   108|         sed -i.bak "s|$PackageSourceCredentialsNodeFooter|$NewCredential${NL}$PackageSourceCredentialsNodeFooter|" $ConfigFile
   109|     fi
   110| done
   111| grep -i "<disabledPackageSources>" $ConfigFile
   112| if [ "$?" == "0" ]; then
   113|     DisabledDarcIntSources=()
   114|     echo "Re-enabling any disabled \"darc-int\" package sources in $ConfigFile"
   115|     DisabledDarcIntSources+=$(grep -oh '"darc-int-[^"]*" value="true"' $ConfigFile  | tr -d '"')
   116|     for DisabledSourceName in ${DisabledDarcIntSources[@]} ; do
   117|         if [[ $DisabledSourceName == darc-int* ]]
   118|             then
   119|                 OldDisableValue="<add key=\"$DisabledSourceName\" value=\"true\" />"
   120|                 NewDisableValue="<!-- Reenabled for build : $DisabledSourceName -->"
   121|                 sed -i.bak "s|$OldDisableValue|$NewDisableValue|" $ConfigFile
   122|                 echo "Neutralized disablePackageSources entry for '$DisabledSourceName'"
   123|         fi
   124|     done
   125| fi


# ====================================================================
# FILE: eng/common/build.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-204 ---
     1| set -u
     2| set -e
     3| usage()
     4| {
     5|   echo "Common settings:"
     6|   echo "  --configuration <value>    Build configuration: 'Debug' or 'Release' (short: -c)"
     7|   echo "  --verbosity <value>        Msbuild verbosity: q[uiet], m[inimal], n[ormal], d[etailed], and diag[nostic] (short: -v)"
     8|   echo "  --binaryLog                Create MSBuild binary log (short: -bl)"
     9|   echo "  --help                     Print help and exit (short: -h)"
    10|   echo ""
    11|   echo "Actions:"
    12|   echo "  --restore                  Restore dependencies (short: -r)"
    13|   echo "  --build                    Build solution (short: -b)"
    14|   echo "  --rebuild                  Rebuild solution"
    15|   echo "  --test                     Run all unit tests in the solution (short: -t)"
    16|   echo "  --integrationTest          Run all integration tests in the solution"
    17|   echo "  --performanceTest          Run all performance tests in the solution"
    18|   echo "  --pack                     Package build outputs into NuGet packages and Willow components"
    19|   echo "  --sign                     Sign build outputs"
    20|   echo "  --publish                  Publish artifacts (e.g. symbols)"
    21|   echo "  --clean                    Clean the solution"
    22|   echo ""
    23|   echo "Advanced settings:"
    24|   echo "  --projects <value>       Project or solution file(s) to build"
    25|   echo "  --ci                     Set when running on CI server"
    26|   echo "  --excludeCIBinarylog     Don't output binary log (short: -nobl)"
    27|   echo "  --prepareMachine         Prepare machine for CI run, clean up processes after build"
    28|   echo "  --nodeReuse <value>      Sets nodereuse msbuild parameter ('true' or 'false')"
    29|   echo "  --warnAsError <value>    Sets warnaserror msbuild parameter ('true' or 'false')"
    30|   echo ""
    31|   echo "Command line arguments not listed above are passed thru to msbuild."
    32|   echo "Arguments can also be passed in with a single hyphen."
    33| }
    34| source="${BASH_SOURCE[0]}"
    35| while [[ -h "$source" ]]; do
    36|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    37|   source="$(readlink "$source")"
    38|   [[ $source != /* ]] && source="$scriptroot/$source"
    39| done
    40| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    41| restore=false
    42| build=false
    43| rebuild=false
    44| test=false
    45| integration_test=false
    46| performance_test=false
    47| pack=false
    48| publish=false
    49| sign=false
    50| public=false
    51| ci=false
    52| clean=false
    53| warn_as_error=true
    54| node_reuse=true
    55| binary_log=false
    56| exclude_ci_binary_log=false
    57| pipelines_log=false
    58| projects=''
    59| configuration='Debug'
    60| prepare_machine=false
    61| verbosity='minimal'
    62| runtime_source_feed=''
    63| runtime_source_feed_key=''
    64| properties=''
    65| while [[ $# > 0 ]]; do
    66|   opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
    67|   case "$opt" in
    68|     -help|-h)
    69|       usage
    70|       exit 0
    71|       ;;
    72|     -clean)
    73|       clean=true
    74|       ;;
    75|     -configuration|-c)
    76|       configuration=$2
    77|       shift
    78|       ;;
    79|     -verbosity|-v)
    80|       verbosity=$2
    81|       shift
    82|       ;;
    83|     -binarylog|-bl)
    84|       binary_log=true
    85|       ;;
    86|     -excludeCIBinarylog|-nobl)
    87|       exclude_ci_binary_log=true
    88|       ;;
    89|     -pipelineslog|-pl)
    90|       pipelines_log=true
    91|       ;;
    92|     -restore|-r)
    93|       restore=true
    94|       ;;
    95|     -build|-b)
    96|       build=true
    97|       ;;
    98|     -rebuild)
    99|       rebuild=true
   100|       ;;
   101|     -pack)
   102|       pack=true
   103|       ;;
   104|     -test|-t)
   105|       test=true
   106|       ;;
   107|     -integrationtest)
   108|       integration_test=true
   109|       ;;
   110|     -performancetest)
   111|       performance_test=true
   112|       ;;
   113|     -sign)
   114|       sign=true
   115|       ;;
   116|     -publish)
   117|       publish=true
   118|       ;;
   119|     -preparemachine)
   120|       prepare_machine=true
   121|       ;;
   122|     -projects)
   123|       projects=$2
   124|       shift
   125|       ;;
   126|     -ci)
   127|       ci=true
   128|       ;;
   129|     -warnaserror)
   130|       warn_as_error=$2
   131|       shift
   132|       ;;
   133|     -nodereuse)
   134|       node_reuse=$2
   135|       shift
   136|       ;;
   137|     -runtimesourcefeed)
   138|       runtime_source_feed=$2
   139|       shift
   140|       ;;
   141|      -runtimesourcefeedkey)
   142|       runtime_source_feed_key=$2
   143|       shift
   144|       ;;
   145|     *)
   146|       properties="$properties $1"
   147|       ;;
   148|   esac
   149|   shift
   150| done
   151| if [[ "$ci" == true ]]; then
   152|   pipelines_log=true
   153|   node_reuse=false
   154|   if [[ "$exclude_ci_binary_log" == false ]]; then
   155|     binary_log=true
   156|   fi
   157| fi
   158| . "$scriptroot/tools.sh"
   159| function InitializeCustomToolset {
   160|   local script="$eng_root/restore-toolset.sh"
   161|   if [[ -a "$script" ]]; then
   162|     . "$script"
   163|   fi
   164| }
   165| function Build {
   166|   if [[ "$ci" == true ]]; then
   167|     TryLogClientIpAddress
   168|   fi
   169|   InitializeToolset
   170|   InitializeCustomToolset
   171|   if [[ ! -z "$projects" ]]; then
   172|     properties="$properties /p:Projects=$projects"
   173|   fi
   174|   local bl=""
   175|   if [[ "$binary_log" == true ]]; then
   176|     bl="/bl:\"$log_dir/Build.binlog\""
   177|   fi
   178|   MSBuild $_InitializeToolset \
   179|     $bl \
   180|     /p:Configuration=$configuration \
   181|     /p:RepoRoot="$repo_root" \
   182|     /p:Restore=$restore \
   183|     /p:Build=$build \
   184|     /p:Rebuild=$rebuild \
   185|     /p:Test=$test \
   186|     /p:Pack=$pack \
   187|     /p:IntegrationTest=$integration_test \
   188|     /p:PerformanceTest=$performance_test \
   189|     /p:Sign=$sign \
   190|     /p:Publish=$publish \
   191|     $properties
   192|   ExitWithExitCode 0
   193| }
   194| if [[ "$clean" == true ]]; then
   195|   if [ -d "$artifacts_dir" ]; then
   196|     rm -rf $artifacts_dir
   197|     echo "Artifacts directory deleted."
   198|   fi
   199|   exit 0
   200| fi
   201| if [[ "$restore" == true ]]; then
   202|   InitializeNativeTools
   203| fi
   204| Build


# ====================================================================
# FILE: eng/common/cross/arm64/tizen-build-rootfs.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| set -e
     2| __CrossDir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
     3| __TIZEN_CROSSDIR="$__CrossDir/tizen"
     4| if [[ -z "$ROOTFS_DIR" ]]; then
     5|     echo "ROOTFS_DIR is not defined."
     6|     exit 1;
     7| fi
     8| TIZEN_TMP_DIR=$ROOTFS_DIR/tizen_tmp
     9| mkdir -p $TIZEN_TMP_DIR
    10| echo ">>Start downloading files"
    11| VERBOSE=1 $__CrossDir/tizen-fetch.sh $TIZEN_TMP_DIR
    12| echo "<<Finish downloading files"
    13| echo ">>Start constructing Tizen rootfs"
    14| TIZEN_RPM_FILES=`ls $TIZEN_TMP_DIR/*.rpm`
    15| cd $ROOTFS_DIR
    16| for f in $TIZEN_RPM_FILES; do
    17|     rpm2cpio $f  | cpio -idm --quiet
    18| done
    19| echo "<<Finish constructing Tizen rootfs"
    20| rm -rf $TIZEN_TMP_DIR
    21| echo ">>Start configuring Tizen rootfs"
    22| ln -sfn asm-arm64 ./usr/include/asm
    23| patch -p1 < $__TIZEN_CROSSDIR/tizen.patch
    24| echo "<<Finish configuring Tizen rootfs"


# ====================================================================
# FILE: eng/common/cross/arm64/tizen-fetch.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-134 ---
     1| set -e
     2| if [[ -z "${VERBOSE// }" ]] || [ "$VERBOSE" -ne "$VERBOSE" ] 2>/dev/null; then
     3| 	VERBOSE=0
     4| fi
     5| Log()
     6| {
     7| 	if [ $VERBOSE -ge $1 ]; then
     8| 		echo ${@:2}
     9| 	fi
    10| }
    11| Inform()
    12| {
    13| 	Log 1 -e "\x1B[0;34m$@\x1B[m"
    14| }
    15| Debug()
    16| {
    17| 	Log 2 -e "\x1B[0;32m$@\x1B[m"
    18| }
    19| Error()
    20| {
    21| 	>&2 Log 0 -e "\x1B[0;31m$@\x1B[m"
    22| }
    23| Fetch()
    24| {
    25| 	URL=$1
    26| 	FILE=$2
    27| 	PROGRESS=$3
    28| 	if [ $VERBOSE -ge 1 ] && [ $PROGRESS ]; then
    29| 		CURL_OPT="--progress-bar"
    30| 	else
    31| 		CURL_OPT="--silent"
    32| 	fi
    33| 	curl $CURL_OPT $URL > $FILE
    34| }
    35| hash curl 2> /dev/null || { Error "Require 'curl' Aborting."; exit 1; }
    36| hash xmllint 2> /dev/null || { Error "Require 'xmllint' Aborting."; exit 1; }
    37| hash sha256sum 2> /dev/null || { Error "Require 'sha256sum' Aborting."; exit 1; }
    38| TMPDIR=$1
    39| if [ ! -d $TMPDIR ]; then
    40| 	TMPDIR=./tizen_tmp
    41| 	Debug "Create temporary directory : $TMPDIR"
    42| 	mkdir -p $TMPDIR
    43| fi
    44| TIZEN_URL=http://download.tizen.org/snapshots/tizen/
    45| BUILD_XML=build.xml
    46| REPOMD_XML=repomd.xml
    47| PRIMARY_XML=primary.xml
    48| TARGET_URL="http://__not_initialized"
    49| Xpath_get()
    50| {
    51| 	XPATH_RESULT=''
    52| 	XPATH=$1
    53| 	XML_FILE=$2
    54| 	RESULT=$(xmllint --xpath $XPATH $XML_FILE)
    55| 	if [[ -z ${RESULT// } ]]; then
    56| 		Error "Can not find target from $XML_FILE"
    57| 		Debug "Xpath = $XPATH"
    58| 		exit 1
    59| 	fi
    60| 	XPATH_RESULT=$RESULT
    61| }
    62| fetch_tizen_pkgs_init()
    63| {
    64| 	TARGET=$1
    65| 	PROFILE=$2
    66| 	Debug "Initialize TARGET=$TARGET, PROFILE=$PROFILE"
    67| 	TMP_PKG_DIR=$TMPDIR/tizen_${PROFILE}_pkgs
    68| 	if [ -d $TMP_PKG_DIR ]; then rm -rf $TMP_PKG_DIR; fi
    69| 	mkdir -p $TMP_PKG_DIR
    70| 	PKG_URL=$TIZEN_URL/$PROFILE/latest
    71| 	BUILD_XML_URL=$PKG_URL/$BUILD_XML
    72| 	TMP_BUILD=$TMP_PKG_DIR/$BUILD_XML
    73| 	TMP_REPOMD=$TMP_PKG_DIR/$REPOMD_XML
    74| 	TMP_PRIMARY=$TMP_PKG_DIR/$PRIMARY_XML
    75| 	TMP_PRIMARYGZ=${TMP_PRIMARY}.gz
    76| 	Fetch $BUILD_XML_URL $TMP_BUILD
    77| 	Debug "fetch $BUILD_XML_URL to $TMP_BUILD"
    78| 	TARGET_XPATH="//build/buildtargets/buildtarget[@name=\"$TARGET\"]/repo[@type=\"binary\"]/text()"
    79| 	Xpath_get $TARGET_XPATH $TMP_BUILD
    80| 	TARGET_PATH=$XPATH_RESULT
    81| 	TARGET_URL=$PKG_URL/$TARGET_PATH
    82| 	REPOMD_URL=$TARGET_URL/repodata/repomd.xml
    83| 	PRIMARY_XPATH='string(//*[local-name()="data"][@type="primary"]/*[local-name()="location"]/@href)'
    84| 	Fetch $REPOMD_URL $TMP_REPOMD
    85| 	Debug "fetch $REPOMD_URL to $TMP_REPOMD"
    86| 	Xpath_get $PRIMARY_XPATH $TMP_REPOMD
    87| 	PRIMARY_XML_PATH=$XPATH_RESULT
    88| 	PRIMARY_URL=$TARGET_URL/$PRIMARY_XML_PATH
    89| 	Fetch $PRIMARY_URL $TMP_PRIMARYGZ
    90| 	Debug "fetch $PRIMARY_URL to $TMP_PRIMARYGZ"
    91| 	gunzip $TMP_PRIMARYGZ
    92| 	Debug "unzip $TMP_PRIMARYGZ to $TMP_PRIMARY"
    93| }
    94| fetch_tizen_pkgs()
    95| {
    96| 	ARCH=$1
    97| 	PACKAGE_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="location"]/@href)'
    98| 	PACKAGE_CHECKSUM_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="checksum"]/text())'
    99| 	for pkg in ${@:2}
   100| 	do
   101| 		Inform "Fetching... $pkg"
   102| 		XPATH=${PACKAGE_XPATH_TPL/_PKG_/$pkg}
   103| 		XPATH=${XPATH/_ARCH_/$ARCH}
   104| 		Xpath_get $XPATH $TMP_PRIMARY
   105| 		PKG_PATH=$XPATH_RESULT
   106| 		XPATH=${PACKAGE_CHECKSUM_XPATH_TPL/_PKG_/$pkg}
   107| 		XPATH=${XPATH/_ARCH_/$ARCH}
   108| 		Xpath_get $XPATH $TMP_PRIMARY
   109| 		CHECKSUM=$XPATH_RESULT
   110| 		PKG_URL=$TARGET_URL/$PKG_PATH
   111| 		PKG_FILE=$(basename $PKG_PATH)
   112| 		PKG_PATH=$TMPDIR/$PKG_FILE
   113| 		Debug "Download $PKG_URL to $PKG_PATH"
   114| 		Fetch $PKG_URL $PKG_PATH true
   115| 		echo "$CHECKSUM $PKG_PATH" | sha256sum -c - > /dev/null
   116| 		if [ $? -ne 0 ]; then
   117| 			Error "Fail to fetch $PKG_URL to $PKG_PATH"
   118| 			Debug "Checksum = $CHECKSUM"
   119| 			exit 1
   120| 		fi
   121| 	done
   122| }
   123| Inform "Initialize arm base"
   124| fetch_tizen_pkgs_init standard base
   125| Inform "fetch common packages"
   126| fetch_tizen_pkgs aarch64 gcc glibc glibc-devel libicu libicu-devel libatomic linux-glibc-devel keyutils keyutils-devel libkeyutils
   127| Inform "fetch coreclr packages"
   128| fetch_tizen_pkgs aarch64 lldb lldb-devel libgcc libstdc++ libstdc++-devel libunwind libunwind-devel lttng-ust-devel lttng-ust userspace-rcu-devel userspace-rcu
   129| Inform "fetch corefx packages"
   130| fetch_tizen_pkgs aarch64 libcom_err libcom_err-devel zlib zlib-devel libopenssl11 libopenssl1.1-devel krb5 krb5-devel
   131| Inform "Initialize standard unified"
   132| fetch_tizen_pkgs_init standard unified
   133| Inform "fetch corefx packages"
   134| fetch_tizen_pkgs aarch64 gssdp gssdp-devel tizen-release


# ====================================================================
# FILE: eng/common/cross/armel/tizen-build-rootfs.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| set -e
     2| __ARM_SOFTFP_CrossDir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
     3| __TIZEN_CROSSDIR="$__ARM_SOFTFP_CrossDir/tizen"
     4| if [[ -z "$ROOTFS_DIR" ]]; then
     5|     echo "ROOTFS_DIR is not defined."
     6|     exit 1;
     7| fi
     8| TIZEN_TMP_DIR=$ROOTFS_DIR/tizen_tmp
     9| mkdir -p $TIZEN_TMP_DIR
    10| echo ">>Start downloading files"
    11| VERBOSE=1 $__ARM_SOFTFP_CrossDir/tizen-fetch.sh $TIZEN_TMP_DIR
    12| echo "<<Finish downloading files"
    13| echo ">>Start constructing Tizen rootfs"
    14| TIZEN_RPM_FILES=`ls $TIZEN_TMP_DIR/*.rpm`
    15| cd $ROOTFS_DIR
    16| for f in $TIZEN_RPM_FILES; do
    17|     rpm2cpio $f  | cpio -idm --quiet
    18| done
    19| echo "<<Finish constructing Tizen rootfs"
    20| rm -rf $TIZEN_TMP_DIR
    21| echo ">>Start configuring Tizen rootfs"
    22| ln -sfn asm-arm ./usr/include/asm
    23| patch -p1 < $__TIZEN_CROSSDIR/tizen.patch
    24| echo "<<Finish configuring Tizen rootfs"


# ====================================================================
# FILE: eng/common/cross/armel/tizen-fetch.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-134 ---
     1| set -e
     2| if [[ -z "${VERBOSE// }" ]] || [ "$VERBOSE" -ne "$VERBOSE" ] 2>/dev/null; then
     3| 	VERBOSE=0
     4| fi
     5| Log()
     6| {
     7| 	if [ $VERBOSE -ge $1 ]; then
     8| 		echo ${@:2}
     9| 	fi
    10| }
    11| Inform()
    12| {
    13| 	Log 1 -e "\x1B[0;34m$@\x1B[m"
    14| }
    15| Debug()
    16| {
    17| 	Log 2 -e "\x1B[0;32m$@\x1B[m"
    18| }
    19| Error()
    20| {
    21| 	>&2 Log 0 -e "\x1B[0;31m$@\x1B[m"
    22| }
    23| Fetch()
    24| {
    25| 	URL=$1
    26| 	FILE=$2
    27| 	PROGRESS=$3
    28| 	if [ $VERBOSE -ge 1 ] && [ $PROGRESS ]; then
    29| 		CURL_OPT="--progress-bar"
    30| 	else
    31| 		CURL_OPT="--silent"
    32| 	fi
    33| 	curl $CURL_OPT $URL > $FILE
    34| }
    35| hash curl 2> /dev/null || { Error "Require 'curl' Aborting."; exit 1; }
    36| hash xmllint 2> /dev/null || { Error "Require 'xmllint' Aborting."; exit 1; }
    37| hash sha256sum 2> /dev/null || { Error "Require 'sha256sum' Aborting."; exit 1; }
    38| TMPDIR=$1
    39| if [ ! -d $TMPDIR ]; then
    40| 	TMPDIR=./tizen_tmp
    41| 	Debug "Create temporary directory : $TMPDIR"
    42| 	mkdir -p $TMPDIR 
    43| fi
    44| TIZEN_URL=http://download.tizen.org/snapshots/tizen
    45| BUILD_XML=build.xml
    46| REPOMD_XML=repomd.xml
    47| PRIMARY_XML=primary.xml
    48| TARGET_URL="http://__not_initialized"
    49| Xpath_get()
    50| {
    51| 	XPATH_RESULT=''
    52| 	XPATH=$1
    53| 	XML_FILE=$2
    54| 	RESULT=$(xmllint --xpath $XPATH $XML_FILE)
    55| 	if [[ -z ${RESULT// } ]]; then
    56| 		Error "Can not find target from $XML_FILE"
    57| 		Debug "Xpath = $XPATH"
    58| 		exit 1
    59| 	fi
    60| 	XPATH_RESULT=$RESULT
    61| }
    62| fetch_tizen_pkgs_init()
    63| {
    64| 	TARGET=$1
    65| 	PROFILE=$2
    66| 	Debug "Initialize TARGET=$TARGET, PROFILE=$PROFILE"
    67| 	TMP_PKG_DIR=$TMPDIR/tizen_${PROFILE}_pkgs
    68| 	if [ -d $TMP_PKG_DIR ]; then rm -rf $TMP_PKG_DIR; fi
    69| 	mkdir -p $TMP_PKG_DIR
    70| 	PKG_URL=$TIZEN_URL/$PROFILE/latest
    71| 	BUILD_XML_URL=$PKG_URL/$BUILD_XML
    72| 	TMP_BUILD=$TMP_PKG_DIR/$BUILD_XML
    73| 	TMP_REPOMD=$TMP_PKG_DIR/$REPOMD_XML
    74| 	TMP_PRIMARY=$TMP_PKG_DIR/$PRIMARY_XML
    75| 	TMP_PRIMARYGZ=${TMP_PRIMARY}.gz
    76| 	Fetch $BUILD_XML_URL $TMP_BUILD
    77| 	Debug "fetch $BUILD_XML_URL to $TMP_BUILD"
    78| 	TARGET_XPATH="//build/buildtargets/buildtarget[@name=\"$TARGET\"]/repo[@type=\"binary\"]/text()"
    79| 	Xpath_get $TARGET_XPATH $TMP_BUILD
    80| 	TARGET_PATH=$XPATH_RESULT
    81| 	TARGET_URL=$PKG_URL/$TARGET_PATH
    82| 	REPOMD_URL=$TARGET_URL/repodata/repomd.xml
    83| 	PRIMARY_XPATH='string(//*[local-name()="data"][@type="primary"]/*[local-name()="location"]/@href)'
    84| 	Fetch $REPOMD_URL $TMP_REPOMD
    85| 	Debug "fetch $REPOMD_URL to $TMP_REPOMD"
    86| 	Xpath_get $PRIMARY_XPATH $TMP_REPOMD
    87| 	PRIMARY_XML_PATH=$XPATH_RESULT
    88| 	PRIMARY_URL=$TARGET_URL/$PRIMARY_XML_PATH
    89| 	Fetch $PRIMARY_URL $TMP_PRIMARYGZ
    90| 	Debug "fetch $PRIMARY_URL to $TMP_PRIMARYGZ"
    91| 	gunzip $TMP_PRIMARYGZ 
    92| 	Debug "unzip $TMP_PRIMARYGZ to $TMP_PRIMARY" 
    93| }
    94| fetch_tizen_pkgs()
    95| {
    96| 	ARCH=$1
    97| 	PACKAGE_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="location"]/@href)'
    98| 	PACKAGE_CHECKSUM_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="checksum"]/text())'
    99| 	for pkg in ${@:2}
   100| 	do
   101| 		Inform "Fetching... $pkg"
   102| 		XPATH=${PACKAGE_XPATH_TPL/_PKG_/$pkg}
   103| 		XPATH=${XPATH/_ARCH_/$ARCH}
   104| 		Xpath_get $XPATH $TMP_PRIMARY
   105| 		PKG_PATH=$XPATH_RESULT
   106| 		XPATH=${PACKAGE_CHECKSUM_XPATH_TPL/_PKG_/$pkg}
   107| 		XPATH=${XPATH/_ARCH_/$ARCH}
   108| 		Xpath_get $XPATH $TMP_PRIMARY
   109| 		CHECKSUM=$XPATH_RESULT
   110| 		PKG_URL=$TARGET_URL/$PKG_PATH
   111| 		PKG_FILE=$(basename $PKG_PATH)
   112| 		PKG_PATH=$TMPDIR/$PKG_FILE
   113| 		Debug "Download $PKG_URL to $PKG_PATH"
   114| 		Fetch $PKG_URL $PKG_PATH true
   115| 		echo "$CHECKSUM $PKG_PATH" | sha256sum -c - > /dev/null
   116| 		if [ $? -ne 0 ]; then
   117| 			Error "Fail to fetch $PKG_URL to $PKG_PATH"
   118| 			Debug "Checksum = $CHECKSUM"
   119| 			exit 1
   120| 		fi
   121| 	done
   122| }
   123| Inform "Initialize arm base"
   124| fetch_tizen_pkgs_init standard base
   125| Inform "fetch common packages"
   126| fetch_tizen_pkgs armv7l gcc gcc-devel-static glibc glibc-devel libicu libicu-devel libatomic linux-glibc-devel keyutils keyutils-devel libkeyutils
   127| Inform "fetch coreclr packages"
   128| fetch_tizen_pkgs armv7l lldb lldb-devel libgcc libstdc++ libstdc++-devel libunwind libunwind-devel lttng-ust-devel lttng-ust userspace-rcu-devel userspace-rcu
   129| Inform "fetch corefx packages"
   130| fetch_tizen_pkgs armv7l libcom_err libcom_err-devel zlib zlib-devel libopenssl11 libopenssl1.1-devel krb5 krb5-devel
   131| Inform "Initialize standard unified"
   132| fetch_tizen_pkgs_init standard unified
   133| Inform "fetch corefx packages"
   134| fetch_tizen_pkgs armv7l gssdp gssdp-devel tizen-release


# ====================================================================
# FILE: eng/common/cross/build-android-rootfs.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-105 ---
     1| set -e
     2| __NDK_Version=r21
     3| usage()
     4| {
     5|     echo "Creates a toolchain and sysroot used for cross-compiling for Android."
     6|     echo.
     7|     echo "Usage: $0 [BuildArch] [ApiLevel]"
     8|     echo.
     9|     echo "BuildArch is the target architecture of Android. Currently only arm64 is supported."
    10|     echo "ApiLevel is the target Android API level. API levels usually match to Android releases. See https://source.android.com/source/build-numbers.html"
    11|     echo.
    12|     echo "By default, the toolchain and sysroot will be generated in cross/android-rootfs/toolchain/[BuildArch]. You can change this behavior"
    13|     echo "by setting the TOOLCHAIN_DIR environment variable"
    14|     echo.
    15|     echo "By default, the NDK will be downloaded into the cross/android-rootfs/android-ndk-$__NDK_Version directory. If you already have an NDK installation,"
    16|     echo "you can set the NDK_DIR environment variable to have this script use that installation of the NDK."
    17|     echo "By default, this script will generate a file, android_platform, in the root of the ROOTFS_DIR directory that contains the RID for the supported and tested Android build: android.28-arm64. This file is to replace '/etc/os-release', which is not available for Android."
    18|     exit 1
    19| }
    20| __ApiLevel=28 # The minimum platform for arm64 is API level 21 but the minimum version that support glob(3) is 28. See $ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/glob.h
    21| __BuildArch=arm64
    22| __AndroidArch=aarch64
    23| __AndroidToolchain=aarch64-linux-android
    24| for i in "$@"
    25|     do
    26|         lowerI="$(echo $i | tr "[:upper:]" "[:lower:]")"
    27|         case $lowerI in
    28|         -?|-h|--help)
    29|             usage
    30|             exit 1
    31|             ;;
    32|         arm64)
    33|             __BuildArch=arm64
    34|             __AndroidArch=aarch64
    35|             __AndroidToolchain=aarch64-linux-android
    36|             ;;
    37|         arm)
    38|             __BuildArch=arm
    39|             __AndroidArch=arm
    40|             __AndroidToolchain=arm-linux-androideabi
    41|             ;;
    42|         *[0-9])
    43|             __ApiLevel=$i
    44|             ;;
    45|         *)
    46|             __UnprocessedBuildArgs="$__UnprocessedBuildArgs $i"
    47|             ;;
    48|     esac
    49| done
    50| __ScriptBaseDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    51| __CrossDir="$__ScriptBaseDir/../../../.tools/android-rootfs"
    52| if [[ ! -f "$__CrossDir" ]]; then
    53|     mkdir -p "$__CrossDir"
    54| fi
    55| __CrossDir="$( cd "$__CrossDir" && pwd )"
    56| __NDK_Dir="$__CrossDir/android-ndk-$__NDK_Version"
    57| __lldb_Dir="$__CrossDir/lldb"
    58| __ToolchainDir="$__CrossDir/android-ndk-$__NDK_Version"
    59| if [[ -n "$TOOLCHAIN_DIR" ]]; then
    60|     __ToolchainDir=$TOOLCHAIN_DIR
    61| fi
    62| if [[ -n "$NDK_DIR" ]]; then
    63|     __NDK_Dir=$NDK_DIR
    64| fi
    65| echo "Target API level: $__ApiLevel"
    66| echo "Target architecture: $__BuildArch"
    67| echo "NDK location: $__NDK_Dir"
    68| echo "Target Toolchain location: $__ToolchainDir"
    69| if [ ! -d $__NDK_Dir ]; then
    70|     echo Downloading the NDK into $__NDK_Dir
    71|     mkdir -p $__NDK_Dir
    72|     wget -q --progress=bar:force:noscroll --show-progress https://dl.google.com/android/repository/android-ndk-$__NDK_Version-linux-x86_64.zip -O $__CrossDir/android-ndk-$__NDK_Version-linux-x86_64.zip
    73|     unzip -q $__CrossDir/android-ndk-$__NDK_Version-linux-x86_64.zip -d $__CrossDir
    74| fi
    75| if [ ! -d $__lldb_Dir ]; then
    76|     mkdir -p $__lldb_Dir
    77|     echo Downloading LLDB into $__lldb_Dir
    78|     wget -q --progress=bar:force:noscroll --show-progress https://dl.google.com/android/repository/lldb-2.3.3614996-linux-x86_64.zip -O $__CrossDir/lldb-2.3.3614996-linux-x86_64.zip
    79|     unzip -q $__CrossDir/lldb-2.3.3614996-linux-x86_64.zip -d $__lldb_Dir
    80| fi
    81| echo "Download dependencies..."
    82| __TmpDir=$__CrossDir/tmp/$__BuildArch/
    83| mkdir -p "$__TmpDir"
    84| __AndroidPackages="libicu"
    85| __AndroidPackages+=" libandroid-glob"
    86| __AndroidPackages+=" liblzma"
    87| __AndroidPackages+=" krb5"
    88| __AndroidPackages+=" openssl"
    89| for path in $(wget -qO- http://termux.net/dists/stable/main/binary-$__AndroidArch/Packages |\
    90|     grep -A15 "Package: \(${__AndroidPackages// /\\|}\)" | grep -v "static\|tool" | grep Filename); do
    91|     if [[ "$path" != "Filename:" ]]; then
    92|         echo "Working on: $path"
    93|         wget -qO- http://termux.net/$path | dpkg -x - "$__TmpDir"
    94|     fi
    95| done
    96| cp -R "$__TmpDir/data/data/com.termux/files/usr/"* "$__ToolchainDir/sysroot/usr/"
    97| echo "Generating platform file..."
    98| echo "RID=android.${__ApiLevel}-${__BuildArch}" > $__ToolchainDir/sysroot/android_platform
    99| echo "Now to build coreclr, libraries and installers; run:"
   100| echo ROOTFS_DIR=\$\(realpath $__ToolchainDir/sysroot\) ./build.sh --cross --arch $__BuildArch \
   101|     --subsetCategory coreclr
   102| echo ROOTFS_DIR=\$\(realpath $__ToolchainDir/sysroot\) ./build.sh --cross --arch $__BuildArch \
   103|     --subsetCategory libraries
   104| echo ROOTFS_DIR=\$\(realpath $__ToolchainDir/sysroot\) ./build.sh --cross --arch $__BuildArch \
   105|     --subsetCategory installer


# ====================================================================
# FILE: eng/common/cross/build-rootfs.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-344 ---
     1| set -e
     2| usage()
     3| {
     4|     echo "Usage: $0 [BuildArch] [CodeName] [lldbx.y] [--skipunmount] --rootfsdir <directory>]"
     5|     echo "BuildArch can be: arm(default), armel, arm64, x86"
     6|     echo "CodeName - optional, Code name for Linux, can be: xenial(default), zesty, bionic, alpine, alpine3.9 or alpine3.13. If BuildArch is armel, LinuxCodeName is jessie(default) or tizen."
     7|     echo "                              for FreeBSD can be: freebsd11, freebsd12, freebsd13"
     8|     echo "                              for illumos can be: illumos."
     9|     echo "lldbx.y - optional, LLDB version, can be: lldb3.9(default), lldb4.0, lldb5.0, lldb6.0 no-lldb. Ignored for alpine and FreeBSD"
    10|     echo "--skipunmount - optional, will skip the unmount of rootfs folder."
    11|     echo "--use-mirror - optional, use mirror URL to fetch resources, when available."
    12|     exit 1
    13| }
    14| __CodeName=xenial
    15| __CrossDir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
    16| __InitialDir=$PWD
    17| __BuildArch=arm
    18| __AlpineArch=armv7
    19| __QEMUArch=arm
    20| __UbuntuArch=armhf
    21| __UbuntuRepo="http://ports.ubuntu.com/"
    22| __LLDB_Package="liblldb-3.9-dev"
    23| __SkipUnmount=0
    24| __UbuntuPackages="build-essential"
    25| __AlpinePackages="alpine-base"
    26| __AlpinePackages+=" build-base"
    27| __AlpinePackages+=" linux-headers"
    28| __AlpinePackagesEdgeCommunity=" lldb-dev"
    29| __AlpinePackagesEdgeMain+=" python3"
    30| __AlpinePackagesEdgeMain+=" libedit"
    31| __UbuntuPackages+=" symlinks"
    32| __UbuntuPackages+=" libicu-dev"
    33| __UbuntuPackages+=" liblttng-ust-dev"
    34| __UbuntuPackages+=" libunwind8-dev"
    35| __AlpinePackages+=" gettext-dev"
    36| __AlpinePackages+=" icu-dev"
    37| __AlpinePackages+=" libunwind-dev"
    38| __AlpinePackages+=" lttng-ust-dev"
    39| __UbuntuPackages+=" libcurl4-openssl-dev"
    40| __UbuntuPackages+=" libkrb5-dev"
    41| __UbuntuPackages+=" libssl-dev"
    42| __UbuntuPackages+=" zlib1g-dev"
    43| __AlpinePackages+=" curl-dev"
    44| __AlpinePackages+=" krb5-dev"
    45| __AlpinePackages+=" openssl-dev"
    46| __AlpinePackages+=" zlib-dev"
    47| __FreeBSDBase="12.2-RELEASE"
    48| __FreeBSDPkg="1.12.0"
    49| __FreeBSDABI="12"
    50| __FreeBSDPackages="libunwind"
    51| __FreeBSDPackages+=" icu"
    52| __FreeBSDPackages+=" libinotify"
    53| __FreeBSDPackages+=" lttng-ust"
    54| __FreeBSDPackages+=" krb5"
    55| __FreeBSDPackages+=" terminfo-db"
    56| __IllumosPackages="icu-64.2nb2"
    57| __IllumosPackages+=" mit-krb5-1.16.2nb4"
    58| __IllumosPackages+=" openssl-1.1.1e"
    59| __IllumosPackages+=" zlib-1.2.11"
    60| __UbuntuPackages+=" libomp5"
    61| __UbuntuPackages+=" libomp-dev"
    62| __UseMirror=0
    63| __UnprocessedBuildArgs=
    64| while :; do
    65|     if [ $# -le 0 ]; then
    66|         break
    67|     fi
    68|     lowerI="$(echo $1 | tr "[:upper:]" "[:lower:]")"
    69|     case $lowerI in
    70|         -?|-h|--help)
    71|             usage
    72|             exit 1
    73|             ;;
    74|         arm)
    75|             __BuildArch=arm
    76|             __UbuntuArch=armhf
    77|             __AlpineArch=armv7
    78|             __QEMUArch=arm
    79|             ;;
    80|         arm64)
    81|             __BuildArch=arm64
    82|             __UbuntuArch=arm64
    83|             __AlpineArch=aarch64
    84|             __QEMUArch=aarch64
    85|             ;;
    86|         armel)
    87|             __BuildArch=armel
    88|             __UbuntuArch=armel
    89|             __UbuntuRepo="http://ftp.debian.org/debian/"
    90|             __CodeName=jessie
    91|             ;;
    92|         s390x)
    93|             __BuildArch=s390x
    94|             __UbuntuArch=s390x
    95|             __UbuntuRepo="http://ports.ubuntu.com/ubuntu-ports/"
    96|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libunwind8-dev//')
    97|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libomp-dev//')
    98|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libomp5//')
    99|             unset __LLDB_Package
   100|             ;;
   101|         x86)
   102|             __BuildArch=x86
   103|             __UbuntuArch=i386
   104|             __UbuntuRepo="http://archive.ubuntu.com/ubuntu/"
   105|             ;;
   106|         lldb3.6)
   107|             __LLDB_Package="lldb-3.6-dev"
   108|             ;;
   109|         lldb3.8)
   110|             __LLDB_Package="lldb-3.8-dev"
   111|             ;;
   112|         lldb3.9)
   113|             __LLDB_Package="liblldb-3.9-dev"
   114|             ;;
   115|         lldb4.0)
   116|             __LLDB_Package="liblldb-4.0-dev"
   117|             ;;
   118|         lldb5.0)
   119|             __LLDB_Package="liblldb-5.0-dev"
   120|             ;;
   121|         lldb6.0)
   122|             __LLDB_Package="liblldb-6.0-dev"
   123|             ;;
   124|         no-lldb)
   125|             unset __LLDB_Package
   126|             ;;
   127|         xenial) # Ubuntu 16.04
   128|             if [ "$__CodeName" != "jessie" ]; then
   129|                 __CodeName=xenial
   130|             fi
   131|             ;;
   132|         zesty) # Ubuntu 17.04
   133|             if [ "$__CodeName" != "jessie" ]; then
   134|                 __CodeName=zesty
   135|             fi
   136|             ;;
   137|         bionic) # Ubuntu 18.04
   138|             if [ "$__CodeName" != "jessie" ]; then
   139|                 __CodeName=bionic
   140|             fi
   141|             ;;
   142|         jessie) # Debian 8
   143|             __CodeName=jessie
   144|             __UbuntuRepo="http://ftp.debian.org/debian/"
   145|             ;;
   146|         stretch) # Debian 9
   147|             __CodeName=stretch
   148|             __UbuntuRepo="http://ftp.debian.org/debian/"
   149|             __LLDB_Package="liblldb-6.0-dev"
   150|             ;;
   151|         buster) # Debian 10
   152|             __CodeName=buster
   153|             __UbuntuRepo="http://ftp.debian.org/debian/"
   154|             __LLDB_Package="liblldb-6.0-dev"
   155|             ;;
   156|         tizen)
   157|             if [ "$__BuildArch" != "armel" ] && [ "$__BuildArch" != "arm64" ]; then
   158|                 echo "Tizen is available only for armel and arm64."
   159|                 usage;
   160|                 exit 1;
   161|             fi
   162|             __CodeName=
   163|             __UbuntuRepo=
   164|             __Tizen=tizen
   165|             ;;
   166|         alpine|alpine3.9)
   167|             __CodeName=alpine
   168|             __UbuntuRepo=
   169|             __AlpineVersion=3.9
   170|             __AlpinePackagesEdgeMain+=" llvm11-libs"
   171|             __AlpinePackagesEdgeMain+=" clang-libs"
   172|             ;;
   173|         alpine3.13)
   174|             __CodeName=alpine
   175|             __UbuntuRepo=
   176|             __AlpineVersion=3.13
   177|             __AlpinePackages+=$__AlpinePackagesEdgeCommunity
   178|             __AlpinePackagesEdgeCommunity=
   179|             __AlpinePackages+=$__AlpinePackagesEdgeMain
   180|             __AlpinePackagesEdgeMain=
   181|             __AlpinePackages+=" llvm10-libs"
   182|             ;;
   183|         freebsd11)
   184|             __FreeBSDBase="11.3-RELEASE"
   185|             __FreeBSDABI="11"
   186|             ;&
   187|         freebsd12)
   188|             __CodeName=freebsd
   189|             __BuildArch=x64
   190|             __SkipUnmount=1
   191|             ;;
   192|         freebsd13)
   193|             __CodeName=freebsd
   194|             __FreeBSDBase="13.0-RELEASE"
   195|             __FreeBSDABI="13"
   196|             __BuildArch=x64
   197|             __SkipUnmount=1
   198|             ;;
   199|         illumos)
   200|             __CodeName=illumos
   201|             __BuildArch=x64
   202|             __SkipUnmount=1
   203|             ;;
   204|         --skipunmount)
   205|             __SkipUnmount=1
   206|             ;;
   207|         --rootfsdir|-rootfsdir)
   208|             shift
   209|             __RootfsDir=$1
   210|             ;;
   211|         --use-mirror)
   212|             __UseMirror=1
   213|             ;;
   214|         *)
   215|             __UnprocessedBuildArgs="$__UnprocessedBuildArgs $1"
   216|             ;;
   217|     esac
   218|     shift
   219| done
   220| if [ "$__BuildArch" == "armel" ]; then
   221|     __LLDB_Package="lldb-3.5-dev"
   222| fi
   223| __UbuntuPackages+=" ${__LLDB_Package:-}"
   224| if [ -z "$__RootfsDir" ] && [ ! -z "$ROOTFS_DIR" ]; then
   225|     __RootfsDir=$ROOTFS_DIR
   226| fi
   227| if [ -z "$__RootfsDir" ]; then
   228|     __RootfsDir="$__CrossDir/../../../.tools/rootfs/$__BuildArch"
   229| fi
   230| if [ -d "$__RootfsDir" ]; then
   231|     if [ $__SkipUnmount == 0 ]; then
   232|         umount $__RootfsDir/* || true
   233|     fi
   234|     rm -rf $__RootfsDir
   235| fi
   236| mkdir -p $__RootfsDir
   237| __RootfsDir="$( cd "$__RootfsDir" && pwd )"
   238| if [[ "$__CodeName" == "alpine" ]]; then
   239|     __ApkToolsVersion=2.9.1
   240|     __ApkToolsDir=$(mktemp -d)
   241|     wget https://github.com/alpinelinux/apk-tools/releases/download/v$__ApkToolsVersion/apk-tools-$__ApkToolsVersion-x86_64-linux.tar.gz -P $__ApkToolsDir
   242|     tar -xf $__ApkToolsDir/apk-tools-$__ApkToolsVersion-x86_64-linux.tar.gz -C $__ApkToolsDir
   243|     mkdir -p $__RootfsDir/usr/bin
   244|     cp -v /usr/bin/qemu-$__QEMUArch-static $__RootfsDir/usr/bin
   245|     $__ApkToolsDir/apk-tools-$__ApkToolsVersion/apk \
   246|       -X http://dl-cdn.alpinelinux.org/alpine/v$__AlpineVersion/main \
   247|       -X http://dl-cdn.alpinelinux.org/alpine/v$__AlpineVersion/community \
   248|       -U --allow-untrusted --root $__RootfsDir --arch $__AlpineArch --initdb \
   249|       add $__AlpinePackages
   250|     if [[ -n "$__AlpinePackagesEdgeMain" ]]; then
   251|       $__ApkToolsDir/apk-tools-$__ApkToolsVersion/apk \
   252|         -X http://dl-cdn.alpinelinux.org/alpine/edge/main \
   253|         -U --allow-untrusted --root $__RootfsDir --arch $__AlpineArch --initdb \
   254|         add $__AlpinePackagesEdgeMain
   255|     fi
   256|     if [[ -n "$__AlpinePackagesEdgeCommunity" ]]; then
   257|       $__ApkToolsDir/apk-tools-$__ApkToolsVersion/apk \
   258|         -X http://dl-cdn.alpinelinux.org/alpine/edge/community \
   259|         -U --allow-untrusted --root $__RootfsDir --arch $__AlpineArch --initdb \
   260|         add $__AlpinePackagesEdgeCommunity
   261|     fi
   262|     rm -r $__ApkToolsDir
   263| elif [[ "$__CodeName" == "freebsd" ]]; then
   264|     mkdir -p $__RootfsDir/usr/local/etc
   265|     JOBS="$(getconf _NPROCESSORS_ONLN)"
   266|     wget -O - https://download.freebsd.org/ftp/releases/amd64/${__FreeBSDBase}/base.txz | tar -C $__RootfsDir -Jxf - ./lib ./usr/lib ./usr/libdata ./usr/include ./usr/share/keys ./etc ./bin/freebsd-version
   267|     echo "ABI = \"FreeBSD:${__FreeBSDABI}:amd64\"; FINGERPRINTS = \"${__RootfsDir}/usr/share/keys\"; REPOS_DIR = [\"${__RootfsDir}/etc/pkg\"]; REPO_AUTOUPDATE = NO; RUN_SCRIPTS = NO;" > ${__RootfsDir}/usr/local/etc/pkg.conf
   268|     echo "FreeBSD: { url: "pkg+http://pkg.FreeBSD.org/\${ABI}/quarterly", mirror_type: \"srv\", signature_type: \"fingerprints\", fingerprints: \"${__RootfsDir}/usr/share/keys/pkg\", enabled: yes }" > ${__RootfsDir}/etc/pkg/FreeBSD.conf
   269|     mkdir -p $__RootfsDir/tmp
   270|     wget -O -  https://github.com/freebsd/pkg/archive/${__FreeBSDPkg}.tar.gz  |  tar -C $__RootfsDir/tmp -zxf -
   271|     cd $__RootfsDir/tmp/pkg-${__FreeBSDPkg}
   272|     mkdir -p $__RootfsDir/host/etc
   273|     ./autogen.sh && ./configure --prefix=$__RootfsDir/host && make -j "$JOBS" && make install
   274|     rm -rf $__RootfsDir/tmp/pkg-${__FreeBSDPkg}
   275|     INSTALL_AS_USER=$(whoami) $__RootfsDir/host/sbin/pkg -r $__RootfsDir -C $__RootfsDir/usr/local/etc/pkg.conf update
   276|     INSTALL_AS_USER=$(whoami) $__RootfsDir/host/sbin/pkg -r $__RootfsDir -C $__RootfsDir/usr/local/etc/pkg.conf install --yes $__FreeBSDPackages
   277| elif [[ "$__CodeName" == "illumos" ]]; then
   278|     mkdir "$__RootfsDir/tmp"
   279|     pushd "$__RootfsDir/tmp"
   280|     JOBS="$(getconf _NPROCESSORS_ONLN)"
   281|     echo "Downloading sysroot."
   282|     wget -O - https://github.com/illumos/sysroot/releases/download/20181213-de6af22ae73b-v1/illumos-sysroot-i386-20181213-de6af22ae73b-v1.tar.gz | tar -C "$__RootfsDir" -xzf -
   283|     echo "Building binutils. Please wait.."
   284|     wget -O - https://ftp.gnu.org/gnu/binutils/binutils-2.33.1.tar.bz2 | tar -xjf -
   285|     mkdir build-binutils && cd build-binutils
   286|     ../binutils-2.33.1/configure --prefix="$__RootfsDir" --target="x86_64-sun-solaris2.10" --program-prefix="x86_64-illumos-" --with-sysroot="$__RootfsDir"
   287|     make -j "$JOBS" && make install && cd ..
   288|     echo "Building gcc. Please wait.."
   289|     wget -O - https://ftp.gnu.org/gnu/gcc/gcc-8.4.0/gcc-8.4.0.tar.xz | tar -xJf -
   290|     CFLAGS="-fPIC"
   291|     CXXFLAGS="-fPIC"
   292|     CXXFLAGS_FOR_TARGET="-fPIC"
   293|     CFLAGS_FOR_TARGET="-fPIC"
   294|     export CFLAGS CXXFLAGS CXXFLAGS_FOR_TARGET CFLAGS_FOR_TARGET
   295|     mkdir build-gcc && cd build-gcc
   296|     ../gcc-8.4.0/configure --prefix="$__RootfsDir" --target="x86_64-sun-solaris2.10" --program-prefix="x86_64-illumos-" --with-sysroot="$__RootfsDir" --with-gnu-as       \
   297|         --with-gnu-ld --disable-nls --disable-libgomp --disable-libquadmath --disable-libssp --disable-libvtv --disable-libcilkrts --disable-libada --disable-libsanitizer \
   298|         --disable-libquadmath-support --disable-shared --enable-tls
   299|     make -j "$JOBS" && make install && cd ..
   300|     BaseUrl=https://pkgsrc.joyent.com
   301|     if [[ "$__UseMirror" == 1 ]]; then
   302|         BaseUrl=http://pkgsrc.smartos.skylime.net
   303|     fi
   304|     BaseUrl="$BaseUrl"/packages/SmartOS/2020Q1/x86_64/All
   305|     echo "Downloading dependencies."
   306|     read -ra array <<<"$__IllumosPackages"
   307|     for package in "${array[@]}"; do
   308|        echo "Installing $package..."
   309|         wget "$BaseUrl"/"$package".tgz
   310|         ar -x "$package".tgz
   311|         tar --skip-old-files -xzf "$package".tmp.tgz -C "$__RootfsDir" 2>/dev/null
   312|     done
   313|     echo "Cleaning up temporary files."
   314|     popd
   315|     rm -rf "$__RootfsDir"/{tmp,+*}
   316|     mkdir -p "$__RootfsDir"/usr/include/net
   317|     mkdir -p "$__RootfsDir"/usr/include/netpacket
   318|     wget -P "$__RootfsDir"/usr/include/net https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/io/bpf/net/bpf.h
   319|     wget -P "$__RootfsDir"/usr/include/net https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/io/bpf/net/dlt.h
   320|     wget -P "$__RootfsDir"/usr/include/netpacket https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/inet/sockmods/netpacket/packet.h
   321|     wget -P "$__RootfsDir"/usr/include/sys https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/sys/sdt.h
   322| elif [[ -n $__CodeName ]]; then
   323|     qemu-debootstrap --arch $__UbuntuArch $__CodeName $__RootfsDir $__UbuntuRepo
   324|     cp $__CrossDir/$__BuildArch/sources.list.$__CodeName $__RootfsDir/etc/apt/sources.list
   325|     chroot $__RootfsDir apt-get update
   326|     chroot $__RootfsDir apt-get -f -y install
   327|     chroot $__RootfsDir apt-get -y install $__UbuntuPackages
   328|     chroot $__RootfsDir symlinks -cr /usr
   329|     chroot $__RootfsDir apt-get clean
   330|     if [ $__SkipUnmount == 0 ]; then
   331|         umount $__RootfsDir/* || true
   332|     fi
   333|     if [[ "$__BuildArch" == "armel" && "$__CodeName" == "jessie" ]]; then
   334|         pushd $__RootfsDir
   335|         patch -p1 < $__CrossDir/$__BuildArch/armel.jessie.patch
   336|         popd
   337|     fi
   338| elif [[ "$__Tizen" == "tizen" ]]; then
   339|     ROOTFS_DIR=$__RootfsDir $__CrossDir/$__BuildArch/tizen-build-rootfs.sh
   340| else
   341|     echo "Unsupported target platform."
   342|     usage;
   343|     exit 1
   344| fi


# ====================================================================
# FILE: eng/common/darc-init.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| source="${BASH_SOURCE[0]}"
     2| darcVersion=''
     3| versionEndpoint='https://maestro-prod.westus2.cloudapp.azure.com/api/assets/darc-version?api-version=2019-01-16'
     4| verbosity='minimal'
     5| while [[ $# > 0 ]]; do
     6|   opt="$(echo "$1" | tr "[:upper:]" "[:lower:]")"
     7|   case "$opt" in
     8|     --darcversion)
     9|       darcVersion=$2
    10|       shift
    11|       ;;
    12|     --versionendpoint)
    13|       versionEndpoint=$2
    14|       shift
    15|       ;;
    16|     --verbosity)
    17|       verbosity=$2
    18|       shift
    19|       ;;
    20|     --toolpath)
    21|       toolpath=$2
    22|       shift
    23|       ;;
    24|     *)
    25|       echo "Invalid argument: $1"
    26|       usage
    27|       exit 1
    28|       ;;
    29|   esac
    30|   shift
    31| done
    32| while [[ -h "$source" ]]; do
    33|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    34|   source="$(readlink "$source")"
    35|   [[ $source != /* ]] && source="$scriptroot/$source"
    36| done
    37| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    38| . "$scriptroot/tools.sh"
    39| if [ -z "$darcVersion" ]; then
    40|   darcVersion=$(curl -X GET "$versionEndpoint" -H "accept: text/plain")
    41| fi
    42| function InstallDarcCli {
    43|   local darc_cli_package_name="microsoft.dotnet.darc"
    44|   InitializeDotNetCli
    45|   local dotnet_root=$_InitializeDotNetCli
    46|   if [ -z "$toolpath" ]; then
    47|     local tool_list=$($dotnet_root/dotnet tool list -g)
    48|     if [[ $tool_list = *$darc_cli_package_name* ]]; then
    49|       echo $($dotnet_root/dotnet tool uninstall $darc_cli_package_name -g)
    50|     fi
    51|   else
    52|     local tool_list=$($dotnet_root/dotnet tool list --tool-path "$toolpath")
    53|     if [[ $tool_list = *$darc_cli_package_name* ]]; then
    54|       echo $($dotnet_root/dotnet tool uninstall $darc_cli_package_name --tool-path "$toolpath")
    55|     fi
    56|   fi
    57|   local arcadeServicesSource="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-tools/nuget/v3/index.json"
    58|   echo "Installing Darc CLI version $darcVersion..."
    59|   echo "You may need to restart your command shell if this is the first dotnet tool you have installed."
    60|   if [ -z "$toolpath" ]; then
    61|     echo $($dotnet_root/dotnet tool install $darc_cli_package_name --version $darcVersion --add-source "$arcadeServicesSource" -v $verbosity -g)
    62|   else
    63|     echo $($dotnet_root/dotnet tool install $darc_cli_package_name --version $darcVersion --add-source "$arcadeServicesSource" -v $verbosity --tool-path "$toolpath")
    64|   fi
    65| }
    66| InstallDarcCli


# ====================================================================
# FILE: eng/common/dotnet-install.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-72 ---
     1| source="${BASH_SOURCE[0]}"
     2| while [[ -h "$source" ]]; do
     3|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     4|   source="$(readlink "$source")"
     5|   [[ $source != /* ]] && source="$scriptroot/$source"
     6| done
     7| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     8| . "$scriptroot/tools.sh"
     9| version='Latest'
    10| architecture=''
    11| runtime='dotnet'
    12| runtimeSourceFeed=''
    13| runtimeSourceFeedKey=''
    14| while [[ $# > 0 ]]; do
    15|   opt="$(echo "$1" | tr "[:upper:]" "[:lower:]")"
    16|   case "$opt" in
    17|     -version|-v)
    18|       shift
    19|       version="$1"
    20|       ;;
    21|     -architecture|-a)
    22|       shift
    23|       architecture="$1"
    24|       ;;
    25|     -runtime|-r)
    26|       shift
    27|       runtime="$1"
    28|       ;;
    29|     -runtimesourcefeed)
    30|       shift
    31|       runtimeSourceFeed="$1"
    32|       ;;
    33|     -runtimesourcefeedkey)
    34|       shift
    35|       runtimeSourceFeedKey="$1"
    36|       ;;
    37|     *)
    38|       Write-PipelineTelemetryError -Category 'Build' -Message "Invalid argument: $1"
    39|       exit 1
    40|       ;;
    41|   esac
    42|   shift
    43| done
    44| cpuname=$(uname -m)
    45| case $cpuname in
    46|   aarch64)
    47|     buildarch=arm64
    48|     ;;
    49|   amd64|x86_64)
    50|     buildarch=x64
    51|     ;;
    52|   armv*l)
    53|     buildarch=arm
    54|     ;;
    55|   i686)
    56|     buildarch=x86
    57|     ;;
    58|   *)
    59|     echo "Unknown CPU $cpuname detected, treating it as x64"
    60|     buildarch=x64
    61|     ;;
    62| esac
    63| dotnetRoot="${repo_root}.dotnet"
    64| if [[ $architecture != "" ]] && [[ $architecture != $buildarch ]]; then
    65|   dotnetRoot="$dotnetRoot/$architecture"
    66| fi
    67| InstallDotNet $dotnetRoot $version "$architecture" $runtime true $runtimeSourceFeed $runtimeSourceFeedKey || {
    68|   local exit_code=$?
    69|   Write-PipelineTelemetryError -Category 'InitializeToolset' -Message "dotnet-install.sh failed (exit code '$exit_code')." >&2
    70|   ExitWithExitCode $exit_code
    71| }
    72| ExitWithExitCode 0


# ====================================================================
# FILE: eng/common/init-tools-native.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-192 ---
     1| source="${BASH_SOURCE[0]}"
     2| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     3| base_uri='https://netcorenativeassets.blob.core.windows.net/resource-packages/external'
     4| install_directory=''
     5| clean=false
     6| force=false
     7| download_retries=5
     8| retry_wait_time_seconds=30
     9| global_json_file="$(dirname "$(dirname "${scriptroot}")")/global.json"
    10| declare -a native_assets
    11| . $scriptroot/pipeline-logging-functions.sh
    12| . $scriptroot/native/common-library.sh
    13| while (($# > 0)); do
    14|   lowerI="$(echo $1 | tr "[:upper:]" "[:lower:]")"
    15|   case $lowerI in
    16|     --baseuri)
    17|       base_uri=$2
    18|       shift 2
    19|       ;;
    20|     --installdirectory)
    21|       install_directory=$2
    22|       shift 2
    23|       ;;
    24|     --clean)
    25|       clean=true
    26|       shift 1
    27|       ;;
    28|     --force)
    29|       force=true
    30|       shift 1
    31|       ;;
    32|     --donotabortonfailure)
    33|       donotabortonfailure=true
    34|       shift 1
    35|       ;;
    36|     --donotdisplaywarnings)
    37|       donotdisplaywarnings=true
    38|       shift 1
    39|       ;;
    40|     --downloadretries)
    41|       download_retries=$2
    42|       shift 2
    43|       ;;
    44|     --retrywaittimeseconds)
    45|       retry_wait_time_seconds=$2
    46|       shift 2
    47|       ;;
    48|     --help)
    49|       echo "Common settings:"
    50|       echo "  --installdirectory                  Directory to install native toolset."
    51|       echo "                                      This is a command-line override for the default"
    52|       echo "                                      Install directory precedence order:"
    53|       echo "                                          - InstallDirectory command-line override"
    54|       echo "                                          - NETCOREENG_INSTALL_DIRECTORY environment variable"
    55|       echo "                                          - (default) %USERPROFILE%/.netcoreeng/native"
    56|       echo ""
    57|       echo "  --clean                             Switch specifying not to install anything, but cleanup native asset folders"
    58|       echo "  --donotabortonfailure               Switch specifiying whether to abort native tools installation on failure"
    59|       echo "  --donotdisplaywarnings              Switch specifiying whether to display warnings during native tools installation on failure"
    60|       echo "  --force                             Clean and then install tools"
    61|       echo "  --help                              Print help and exit"
    62|       echo ""
    63|       echo "Advanced settings:"
    64|       echo "  --baseuri <value>                   Base URI for where to download native tools from"
    65|       echo "  --downloadretries <value>           Number of times a download should be attempted"
    66|       echo "  --retrywaittimeseconds <value>      Wait time between download attempts"
    67|       echo ""
    68|       exit 0
    69|       ;;
    70|   esac
    71| done
    72| function ReadGlobalJsonNativeTools {
    73|   if command -v jq &> /dev/null; then
    74|     while IFS= read -rd '' line; do
    75|       native_assets+=("$line")
    76|     done < <(jq -r '. |
    77|         select(has("native-tools")) |
    78|         ."native-tools" |
    79|         keys[] as $k |
    80|         @sh "KEY=\($k) VALUE=\(.[$k])\u0000"' "$global_json_file")
    81|     return
    82|   fi
    83|   if [[ ! "$(cat "$global_json_file")" =~ \"native-tools\"[[:space:]\:\{]*([^\}]+) ]]; then
    84|     return
    85|   fi
    86|   section="${BASH_REMATCH[1]}"
    87|   parseStarted=0
    88|   possibleEnd=0
    89|   escaping=0
    90|   escaped=0
    91|   isKey=1
    92|   for (( i=0; i<${#section}; i++ )); do
    93|     char="${section:$i:1}"
    94|     if ! ((parseStarted)) && [[ "$char" =~ [[:space:],:] ]]; then continue; fi
    95|     if ! ((escaping)) && [[ "$char" == "\\" ]]; then
    96|       escaping=1
    97|     elif ((escaping)) && ! ((escaped)); then
    98|       escaped=1
    99|     fi
   100|     if ! ((parseStarted)) && [[ "$char" == "\"" ]]; then
   101|       parseStarted=1
   102|       possibleEnd=0
   103|     elif [[ "$char" == "'" ]]; then
   104|       token="$token'\\\''"
   105|       possibleEnd=0
   106|     elif ((escaping)) || [[ "$char" != "\"" ]]; then
   107|       token="$token$char"
   108|       possibleEnd=1
   109|     fi
   110|     if ((possibleEnd)) && ! ((escaping)) && [[ "$char" == "\"" ]]; then
   111|       printf -v token "'$token'"
   112|       if ((isKey)); then
   113|         KEY="$token"
   114|         isKey=0
   115|       else
   116|         line="KEY=$KEY VALUE=$token"
   117|         native_assets+=("$line")
   118|         isKey=1
   119|       fi
   120|       parseStarted=0
   121|       token=
   122|     elif ((escaping)) && ((escaped)); then
   123|       escaping=0
   124|       escaped=0
   125|     fi
   126|   done
   127| }
   128| native_base_dir=$install_directory
   129| if [[ -z $install_directory ]]; then
   130|   native_base_dir=$(GetNativeInstallDirectory)
   131| fi
   132| install_bin="${native_base_dir}/bin"
   133| installed_any=false
   134| ReadGlobalJsonNativeTools
   135| if [[ ${#native_assets[@]} -eq 0 ]]; then
   136|   echo "No native tools defined in global.json"
   137|   exit 0;
   138| else
   139|   native_installer_dir="$scriptroot/native"
   140|   for index in "${!native_assets[@]}"; do
   141|     eval "${native_assets["$index"]}"
   142|     installer_path="$native_installer_dir/install-$KEY.sh"
   143|     installer_command="$installer_path"
   144|     installer_command+=" --baseuri $base_uri"
   145|     installer_command+=" --installpath $install_bin"
   146|     installer_command+=" --version $VALUE"
   147|     echo $installer_command
   148|     if [[ $force = true ]]; then
   149|       installer_command+=" --force"
   150|     fi
   151|     if [[ $clean = true ]]; then
   152|       installer_command+=" --clean"
   153|     fi
   154|     if [[ -a $installer_path ]]; then
   155|       $installer_command
   156|       if [[ $? != 0 ]]; then
   157|         if [[ $donotabortonfailure = true ]]; then
   158|           if [[ $donotdisplaywarnings != true ]]; then
   159|             Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed"
   160|           fi
   161|         else
   162|           Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed"
   163|           exit 1
   164|         fi
   165|       else
   166|         $installed_any = true
   167|       fi
   168|     else
   169|       if [[ $donotabortonfailure == true ]]; then
   170|         if [[ $donotdisplaywarnings != true ]]; then
   171|           Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed: no install script"
   172|         fi
   173|       else
   174|         Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed: no install script"
   175|         exit 1
   176|       fi
   177|     fi
   178|   done
   179| fi
   180| if [[ $clean = true ]]; then
   181|   exit 0
   182| fi
   183| if [[ -d $install_bin ]]; then
   184|   echo "Native tools are available from $install_bin"
   185|   echo "##vso[task.prependpath]$install_bin"
   186| else
   187|   if [[ $installed_any = true ]]; then
   188|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Native tools install directory does not exist, installation failed"
   189|     exit 1
   190|   fi
   191| fi
   192| exit 0


# ====================================================================
# FILE: eng/common/internal-feed-operations.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-101 ---
     1| set -e
     2| function SetupCredProvider {
     3|   local authToken=$1
     4|   echo "Setting up Cred Provider NuGet plugin in the agent..."...
     5|   echo "Getting 'installcredprovider.ps1' from 'https://github.com/microsoft/artifacts-credprovider'..."
     6|   local url="https://raw.githubusercontent.com/microsoft/artifacts-credprovider/master/helpers/installcredprovider.sh"  
     7|   echo "Writing the contents of 'installcredprovider.ps1' locally..."
     8|   local installcredproviderPath="installcredprovider.sh"
     9|   if command -v curl > /dev/null; then
    10|     curl $url > "$installcredproviderPath"
    11|   else   
    12|     wget -q -O "$installcredproviderPath" "$url"
    13|   fi
    14|   echo "Installing plugin..."
    15|   . "$installcredproviderPath"
    16|   echo "Deleting local copy of 'installcredprovider.sh'..."
    17|   rm installcredprovider.sh
    18|   if [ ! -d "$HOME/.nuget/plugins" ]; then
    19|     Write-PipelineTelemetryError -category 'Build' 'CredProvider plugin was not installed correctly!'
    20|     ExitWithExitCode 1  
    21|   else 
    22|     echo "CredProvider plugin was installed correctly!"
    23|   fi
    24|   local nugetConfigPath="{$repo_root}NuGet.config"
    25|   if [ ! "$nugetConfigPath" ]; then
    26|     Write-PipelineTelemetryError -category 'Build' "NuGet.config file not found in repo's root!"
    27|     ExitWithExitCode 1  
    28|   fi
    29|   local endpoints='['
    30|   local nugetConfigPackageValues=`cat "$nugetConfigPath" | grep "key=\"darc-int-"`
    31|   local pattern="value=\"(.*)\""
    32|   for value in $nugetConfigPackageValues 
    33|   do
    34|     if [[ $value =~ $pattern ]]; then
    35|       local endpoint="${BASH_REMATCH[1]}"  
    36|       endpoints+="{\"endpoint\": \"$endpoint\", \"password\": \"$authToken\"},"
    37|     fi
    38|   done
    39|   endpoints=${endpoints%?}
    40|   endpoints+=']'
    41|   if [ ${#endpoints} -gt 2 ]; then 
    42|       local endpointCredentials="{\"endpointCredentials\": "$endpoints"}"
    43|       echo "##vso[task.setvariable variable=VSS_NUGET_EXTERNAL_FEED_ENDPOINTS]$endpointCredentials"
    44|       echo "##vso[task.setvariable variable=NUGET_CREDENTIALPROVIDER_SESSIONTOKENCACHE_ENABLED]False"
    45|   else
    46|     echo "No internal endpoints found in NuGet.config"
    47|   fi
    48| } 
    49| function InstallDotNetSdkAndRestoreArcade {
    50|   local dotnetTempDir="$repo_root/dotnet"
    51|   local dotnetSdkVersion="2.1.507" # After experimentation we know this version works when restoring the SDK (compared to 3.0.*)
    52|   local restoreProjPath="$repo_root/eng/common/restore.proj"
    53|   echo "Installing dotnet SDK version $dotnetSdkVersion to restore Arcade SDK..."
    54|   echo "<Project Sdk=\"Microsoft.DotNet.Arcade.Sdk\"/>" > "$restoreProjPath"
    55|   InstallDotNetSdk "$dotnetTempDir" "$dotnetSdkVersion"
    56|   local res=`$dotnetTempDir/dotnet restore $restoreProjPath`
    57|   echo "Arcade SDK restored!"
    58|   if [ "$restoreProjPath" ]; then
    59|     rm "$restoreProjPath"
    60|   fi
    61|   if [ "$dotnetTempDir" ]; then
    62|     rm -r $dotnetTempDir
    63|   fi
    64| }
    65| source="${BASH_SOURCE[0]}"
    66| operation=''
    67| authToken=''
    68| repoName=''
    69| while [[ $# > 0 ]]; do
    70|   opt="$(echo "$1" | tr "[:upper:]" "[:lower:]")"
    71|   case "$opt" in
    72|     --operation)
    73|       operation=$2
    74|       shift
    75|       ;;
    76|     --authtoken)
    77|       authToken=$2
    78|       shift
    79|       ;;
    80|     *)
    81|       echo "Invalid argument: $1"
    82|       usage
    83|       exit 1
    84|       ;;
    85|   esac
    86|   shift
    87| done
    88| while [[ -h "$source" ]]; do
    89|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    90|   source="$(readlink "$source")"
    91|   [[ $source != /* ]] && source="$scriptroot/$source"
    92| done
    93| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    94| . "$scriptroot/tools.sh"
    95| if [ "$operation" = "setup" ]; then
    96|   SetupCredProvider $authToken
    97| elif [ "$operation" = "install-restore" ]; then
    98|   InstallDotNetSdkAndRestoreArcade
    99| else
   100|   echo "Unknown operation '$operation'!"
   101| fi


# ====================================================================
# FILE: eng/common/msbuild.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| source="${BASH_SOURCE[0]}"
     2| while [[ -h "$source" ]]; do
     3|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     4|   source="$(readlink "$source")"
     5|   [[ $source != /* ]] && source="$scriptroot/$source"
     6| done
     7| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     8| verbosity='minimal'
     9| warn_as_error=true
    10| node_reuse=true
    11| prepare_machine=false
    12| extra_args=''
    13| while (($# > 0)); do
    14|   lowerI="$(echo $1 | tr "[:upper:]" "[:lower:]")"
    15|   case $lowerI in
    16|     --verbosity)
    17|       verbosity=$2
    18|       shift 2
    19|       ;;
    20|     --warnaserror)
    21|       warn_as_error=$2
    22|       shift 2
    23|       ;;
    24|     --nodereuse)
    25|       node_reuse=$2
    26|       shift 2
    27|       ;;
    28|     --ci)
    29|       ci=true
    30|       shift 1
    31|       ;;
    32|     --preparemachine)
    33|       prepare_machine=true
    34|       shift 1
    35|       ;;
    36|       *)
    37|       extra_args="$extra_args $1"
    38|       shift 1
    39|       ;;
    40|   esac
    41| done
    42| . "$scriptroot/tools.sh"
    43| if [[ "$ci" == true ]]; then
    44|   node_reuse=false
    45| fi
    46| MSBuild $extra_args
    47| ExitWithExitCode 0


# ====================================================================
# FILE: eng/common/native/common-library.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-132 ---
     1| function GetNativeInstallDirectory {
     2|   local install_dir
     3|   if [[ -z $NETCOREENG_INSTALL_DIRECTORY ]]; then
     4|     install_dir=$HOME/.netcoreeng/native/
     5|   else
     6|     install_dir=$NETCOREENG_INSTALL_DIRECTORY
     7|   fi
     8|   echo $install_dir
     9|   return 0
    10| }
    11| function GetTempDirectory {
    12|   echo $(GetNativeInstallDirectory)temp/
    13|   return 0
    14| }
    15| function ExpandZip {
    16|   local zip_path=$1
    17|   local output_directory=$2
    18|   local force=${3:-false}
    19|   echo "Extracting $zip_path to $output_directory"
    20|   if [[ -d $output_directory ]] && [[ $force = false ]]; then
    21|     echo "Directory '$output_directory' already exists, skipping extract"
    22|     return 0
    23|   fi
    24|   if [[ -d $output_directory ]]; then
    25|     echo "'Force flag enabled, but '$output_directory' exists. Removing directory"
    26|     rm -rf $output_directory
    27|     if [[ $? != 0 ]]; then
    28|       Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Unable to remove '$output_directory'"
    29|       return 1
    30|     fi
    31|   fi
    32|   echo "Creating directory: '$output_directory'"
    33|   mkdir -p $output_directory
    34|   echo "Extracting archive"
    35|   tar -xf $zip_path -C $output_directory
    36|   if [[ $? != 0 ]]; then
    37|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Unable to extract '$zip_path'"
    38|     return 1
    39|   fi
    40|   return 0
    41| }
    42| function GetCurrentOS {
    43|   local unameOut="$(uname -s)"
    44|   case $unameOut in
    45|     Linux*)     echo "Linux";;
    46|     Darwin*)    echo "MacOS";;
    47|   esac
    48|   return 0
    49| }
    50| function GetFile {
    51|   local uri=$1
    52|   local path=$2
    53|   local force=${3:-false}
    54|   local download_retries=${4:-5}
    55|   local retry_wait_time_seconds=${5:-30}
    56|   if [[ -f $path ]]; then
    57|     if [[ $force = false ]]; then
    58|       echo "File '$path' already exists. Skipping download"
    59|       return 0
    60|     else
    61|       rm -rf $path
    62|     fi
    63|   fi
    64|   if [[ -f $uri ]]; then
    65|     echo "'$uri' is a file path, copying file to '$path'"
    66|     cp $uri $path
    67|     return $?
    68|   fi
    69|   echo "Downloading $uri"
    70|   if command -v curl > /dev/null; then
    71|     curl "$uri" -sSL --retry $download_retries --retry-delay $retry_wait_time_seconds --create-dirs -o "$path" --fail
    72|   else
    73|     wget -q -O "$path" "$uri" --tries="$download_retries"
    74|   fi
    75|   return $?
    76| }
    77| function GetTempPathFileName {
    78|   local path=$1
    79|   local temp_dir=$(GetTempDirectory)
    80|   local temp_file_name=$(basename $path)
    81|   echo $temp_dir$temp_file_name
    82|   return 0
    83| }
    84| function DownloadAndExtract {
    85|   local uri=$1
    86|   local installDir=$2
    87|   local force=${3:-false}
    88|   local download_retries=${4:-5}
    89|   local retry_wait_time_seconds=${5:-30}
    90|   local temp_tool_path=$(GetTempPathFileName $uri)
    91|   echo "downloading to: $temp_tool_path"
    92|   GetFile "$uri" "$temp_tool_path" $force $download_retries $retry_wait_time_seconds
    93|   if [[ $? != 0 ]]; then
    94|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Failed to download '$uri' to '$temp_tool_path'."
    95|     return 1
    96|   fi
    97|   echo "extracting from  $temp_tool_path to $installDir"
    98|   ExpandZip "$temp_tool_path" "$installDir" $force $download_retries $retry_wait_time_seconds
    99|   if [[ $? != 0 ]]; then
   100|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Failed to extract '$temp_tool_path' to '$installDir'."
   101|     return 1
   102|   fi
   103|   return 0
   104| }
   105| function NewScriptShim {
   106|   local shimpath=$1
   107|   local tool_file_path=$2
   108|   local force=${3:-false}
   109|   echo "Generating '$shimpath' shim"
   110|   if [[ -f $shimpath ]]; then
   111|     if [[ $force = false ]]; then
   112|       echo "File '$shimpath' already exists." >&2
   113|       return 1
   114|     else
   115|       rm -rf $shimpath
   116|     fi
   117|   fi
   118|   if [[ ! -f $tool_file_path ]]; then
   119|     tool_file_path="$(echo $tool_file_path | tr "[:upper:]" "[:lower:]")" 
   120|     if [[ ! -f $tool_file_path ]]; then
   121|       Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Specified tool file path:'$tool_file_path' does not exist"
   122|       return 1
   123|     fi
   124|   fi
   125|   local shim_contents=$'#!/usr/bin/env bash\n'
   126|   shim_contents+="SHIMARGS="$'$1\n'
   127|   shim_contents+="$tool_file_path"$' $SHIMARGS\n'
   128|   echo "$shim_contents" > $shimpath
   129|   chmod +x $shimpath
   130|   echo "Finished generating shim '$shimpath'"
   131|   return $?
   132| }


# ====================================================================
# FILE: eng/common/native/install-cmake.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-97 ---
     1| source="${BASH_SOURCE[0]}"
     2| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     3| . $scriptroot/common-library.sh
     4| base_uri=
     5| install_path=
     6| version=
     7| clean=false
     8| force=false
     9| download_retries=5
    10| retry_wait_time_seconds=30
    11| while (($# > 0)); do
    12|   lowerI="$(echo $1 | tr "[:upper:]" "[:lower:]")"
    13|   case $lowerI in
    14|     --baseuri)
    15|       base_uri=$2
    16|       shift 2
    17|       ;;
    18|     --installpath)
    19|       install_path=$2
    20|       shift 2
    21|       ;;
    22|     --version)
    23|       version=$2
    24|       shift 2
    25|       ;;
    26|     --clean)
    27|       clean=true
    28|       shift 1
    29|       ;;
    30|     --force)
    31|       force=true
    32|       shift 1
    33|       ;;
    34|     --downloadretries)
    35|       download_retries=$2
    36|       shift 2
    37|       ;;
    38|     --retrywaittimeseconds)
    39|       retry_wait_time_seconds=$2
    40|       shift 2
    41|       ;;
    42|     --help)
    43|       echo "Common settings:"
    44|       echo "  --baseuri <value>        Base file directory or Url wrom which to acquire tool archives"
    45|       echo "  --installpath <value>    Base directory to install native tool to"
    46|       echo "  --clean                  Don't install the tool, just clean up the current install of the tool"
    47|       echo "  --force                  Force install of tools even if they previously exist"
    48|       echo "  --help                   Print help and exit"
    49|       echo ""
    50|       echo "Advanced settings:"
    51|       echo "  --downloadretries        Total number of retry attempts"
    52|       echo "  --retrywaittimeseconds   Wait time between retry attempts in seconds"
    53|       echo ""
    54|       exit 0
    55|       ;;
    56|   esac
    57| done
    58| tool_name="cmake"
    59| tool_os=$(GetCurrentOS)
    60| tool_folder="$(echo $tool_os | tr "[:upper:]" "[:lower:]")"
    61| tool_arch="x86_64"
    62| tool_name_moniker="$tool_name-$version-$tool_os-$tool_arch"
    63| tool_install_directory="$install_path/$tool_name/$version"
    64| tool_file_path="$tool_install_directory/$tool_name_moniker/bin/$tool_name"
    65| shim_path="$install_path/$tool_name.sh"
    66| uri="${base_uri}/$tool_folder/$tool_name/$tool_name_moniker.tar.gz"
    67| if [[ $clean = true ]]; then
    68|   echo "Cleaning $tool_install_directory"
    69|   if [[ -d $tool_install_directory ]]; then
    70|     rm -rf $tool_install_directory
    71|   fi
    72|   echo "Cleaning $shim_path"
    73|   if [[ -f $shim_path ]]; then
    74|     rm -rf $shim_path
    75|   fi
    76|   tool_temp_path=$(GetTempPathFileName $uri)
    77|   echo "Cleaning $tool_temp_path"
    78|   if [[ -f $tool_temp_path ]]; then
    79|     rm -rf $tool_temp_path
    80|   fi
    81|   exit 0
    82| fi
    83| if [[ -f $tool_file_path ]] && [[ $force = false ]]; then
    84|   echo "$tool_name ($version) already exists, skipping install"
    85|   exit 0
    86| fi
    87| DownloadAndExtract $uri $tool_install_directory $force $download_retries $retry_wait_time_seconds
    88| if [[ $? != 0 ]]; then
    89|   Write-PipelineTelemetryError -category 'NativeToolsBootstrap' 'Installation failed'
    90|   exit 1
    91| fi
    92| NewScriptShim $shim_path $tool_file_path true
    93| if [[ $? != 0 ]]; then
    94|   Write-PipelineTelemetryError -category 'NativeToolsBootstrap' 'Shim generation failed'
    95|   exit 1
    96| fi
    97| exit 0


# ====================================================================
# FILE: eng/common/pipeline-logging-functions.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-178 ---
     1| function Write-PipelineTelemetryError {
     2|   local telemetry_category=''
     3|   local force=false
     4|   local function_args=()
     5|   local message=''
     6|   while [[ $# -gt 0 ]]; do
     7|     opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
     8|     case "$opt" in
     9|       -category|-c)
    10|         telemetry_category=$2
    11|         shift
    12|         ;;
    13|       -force|-f)
    14|         force=true
    15|         ;;
    16|       -*)
    17|         function_args+=("$1 $2")
    18|         shift
    19|         ;;
    20|       *)
    21|         message=$*
    22|         ;;
    23|     esac
    24|     shift
    25|   done
    26|   if [[ $force != true ]] && [[ "$ci" != true ]]; then
    27|     echo "$message" >&2
    28|     return
    29|   fi
    30|   if [[ $force == true ]]; then
    31|     function_args+=("-force")
    32|   fi
    33|   message="(NETCORE_ENGINEERING_TELEMETRY=$telemetry_category) $message"
    34|   function_args+=("$message")
    35|   Write-PipelineTaskError ${function_args[@]}
    36| }
    37| function Write-PipelineTaskError {
    38|   local message_type="error"
    39|   local sourcepath=''
    40|   local linenumber=''
    41|   local columnnumber=''
    42|   local error_code=''
    43|   local force=false
    44|   while [[ $# -gt 0 ]]; do
    45|     opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
    46|     case "$opt" in
    47|       -type|-t)
    48|         message_type=$2
    49|         shift
    50|         ;;
    51|       -sourcepath|-s)
    52|         sourcepath=$2
    53|         shift
    54|         ;;
    55|       -linenumber|-ln)
    56|         linenumber=$2
    57|         shift
    58|         ;;
    59|       -columnnumber|-cn)
    60|         columnnumber=$2
    61|         shift
    62|         ;;
    63|       -errcode|-e)
    64|         error_code=$2
    65|         shift
    66|         ;;
    67|       -force|-f)
    68|         force=true
    69|         ;;
    70|       *)
    71|         break
    72|         ;;
    73|     esac
    74|     shift
    75|   done
    76|   if [[ $force != true ]] && [[ "$ci" != true ]]; then
    77|     echo "$@" >&2
    78|     return
    79|   fi
    80|   local message="##vso[task.logissue"
    81|   message="$message type=$message_type"
    82|   if [ -n "$sourcepath" ]; then
    83|     message="$message;sourcepath=$sourcepath"
    84|   fi
    85|   if [ -n "$linenumber" ]; then
    86|     message="$message;linenumber=$linenumber"
    87|   fi
    88|   if [ -n "$columnnumber" ]; then
    89|     message="$message;columnnumber=$columnnumber"
    90|   fi
    91|   if [ -n "$error_code" ]; then
    92|     message="$message;code=$error_code"
    93|   fi
    94|   message="$message]$*"
    95|   echo "$message"
    96| }
    97| function Write-PipelineSetVariable {
    98|   if [[ "$ci" != true ]]; then
    99|     return
   100|   fi
   101|   local name=''
   102|   local value=''
   103|   local secret=false
   104|   local as_output=false
   105|   local is_multi_job_variable=true
   106|   while [[ $# -gt 0 ]]; do
   107|     opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
   108|     case "$opt" in
   109|       -name|-n)
   110|         name=$2
   111|         shift
   112|         ;;
   113|       -value|-v)
   114|         value=$2
   115|         shift
   116|         ;;
   117|       -secret|-s)
   118|         secret=true
   119|         ;;
   120|       -as_output|-a)
   121|         as_output=true
   122|         ;;
   123|       -is_multi_job_variable|-i)
   124|         is_multi_job_variable=$2
   125|         shift
   126|         ;;
   127|     esac
   128|     shift
   129|   done
   130|   value=${value/;/%3B}
   131|   value=${value/\\r/%0D}
   132|   value=${value/\\n/%0A}
   133|   value=${value/]/%5D}
   134|   local message="##vso[task.setvariable variable=$name;isSecret=$secret;isOutput=$is_multi_job_variable]$value"
   135|   if [[ "$as_output" == true ]]; then
   136|     $message
   137|   else
   138|     echo "$message"
   139|   fi
   140| }
   141| function Write-PipelinePrependPath {
   142|   local prepend_path=''
   143|   while [[ $# -gt 0 ]]; do
   144|     opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
   145|     case "$opt" in
   146|       -path|-p)
   147|         prepend_path=$2
   148|         shift
   149|         ;;
   150|     esac
   151|     shift
   152|   done
   153|   export PATH="$prepend_path:$PATH"
   154|   if [[ "$ci" == true ]]; then
   155|     echo "##vso[task.prependpath]$prepend_path"
   156|   fi
   157| }
   158| function Write-PipelineSetResult {
   159|   local result=''
   160|   local message=''
   161|   while [[ $# -gt 0 ]]; do
   162|     opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
   163|     case "$opt" in
   164|       -result|-r)
   165|         result=$2
   166|         shift
   167|         ;;
   168|       -message|-m)
   169|         message=$2
   170|         shift
   171|         ;;
   172|     esac
   173|     shift
   174|   done
   175|   if [[ "$ci" == true ]]; then
   176|     echo "##vso[task.complete result=$result;]$message"
   177|   fi
   178| }

