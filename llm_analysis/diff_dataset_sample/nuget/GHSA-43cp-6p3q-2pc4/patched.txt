# ====================================================================
# FILE: src/HtmlSanitizer/HtmlSanitizer.cs
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 152-210 ---
   152|         public string SanitizeDocument(string html, string baseUrl = "", IMarkupFormatter? outputFormatter = null)
   153|         {
   154|             var parser = HtmlParserFactory();
   155|             using var dom = parser.ParseDocument(html);
   156|             DoSanitize(dom, dom, baseUrl);
   157|             var output = dom.ToHtml(outputFormatter ?? OutputFormatter);
   158|             return output;
   159|         }
   160|         public string SanitizeDocument(Stream html, string baseUrl = "", IMarkupFormatter? outputFormatter = null)
   161|         {
   162|             var parser = HtmlParserFactory();
   163|             using var dom = parser.ParseDocument(html);
   164|             DoSanitize(dom, dom, baseUrl);
   165|             var output = dom.ToHtml(outputFormatter ?? OutputFormatter);
   166|             return output;
   167|         }
   168|         private void RemoveComments(INode context)
   169|         {
   170|             foreach (var comment in GetAllNodes(context).OfType<IComment>().ToList())
   171|             {
   172|                 var escapedText = comment.TextContent.Replace("<", "&lt;").Replace(">", "&gt;");
   173|                 if (escapedText != comment.TextContent)
   174|                     comment.TextContent = escapedText;
   175|                 var e = new RemovingCommentEventArgs(comment);
   176|                 OnRemovingComment(e);
   177|                 if (!e.Cancel)
   178|                     comment.Remove();
   179|             }
   180|         }
   181|         private void DoSanitize(IHtmlDocument dom, IParentNode context, string baseUrl = "")
   182|         {
   183|             foreach (var tag in context.QuerySelectorAll("*").Where(t => t.Flags.HasFlag(NodeFlags.LiteralText) && !string.IsNullOrWhiteSpace(t.InnerHtml)))
   184|             {
   185|                 var escapedHtml = tag.InnerHtml.Replace("<", "&lt;").Replace(">", "&gt;");
   186|                 if (escapedHtml != tag.InnerHtml)
   187|                     tag.InnerHtml = escapedHtml;
   188|                 if (tag.InnerHtml != escapedHtml) // setting InnerHtml does not work for noscript
   189|                     tag.SetInnerText(escapedHtml);
   190|             }
   191|             foreach (var tag in context.QuerySelectorAll("*").Where(t => !IsAllowedTag(t)).ToList())
   192|             {
   193|                 RemoveTag(tag, RemoveReason.NotAllowedTag);
   194|             }
   195|             SanitizeStyleSheets(dom, baseUrl);
   196|             foreach (var tag in context.QuerySelectorAll("*").ToList())
   197|             {
   198|                 foreach (var attribute in tag.Attributes.Where(a => !IsAllowedAttribute(a)).ToList())
   199|                 {
   200|                     RemoveAttribute(tag, attribute, RemoveReason.NotAllowedAttribute);
   201|                 }
   202|                 foreach (var attribute in tag.Attributes.Where(IsUriAttribute).ToList())
   203|                 {
   204|                     var url = SanitizeUrl(tag, attribute.Value, baseUrl);
   205|                     if (url == null)
   206|                         RemoveAttribute(tag, attribute, RemoveReason.NotAllowedUrlValue);
   207|                     else
   208|                         tag.SetAttribute(attribute.Name, url);
   209|                 }
   210|                 var oldStyleEmpty = string.IsNullOrEmpty(tag.GetAttribute("style"));

