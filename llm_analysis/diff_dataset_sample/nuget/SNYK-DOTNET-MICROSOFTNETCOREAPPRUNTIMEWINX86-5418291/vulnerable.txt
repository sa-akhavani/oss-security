# ====================================================================
# FILE: .devcontainer/scripts/onCreateCommand.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-8 ---
     1| set -e
     2| ./build.sh libs+clr -rc Release
     3| ./build.sh libs.tests -restore
     4| make -C src/mono/wasm provision-wasm
     5| export EMSDK_PATH=$PWD/src/mono/wasm/emsdk
     6| ./build.sh mono+libs -os Browser -c release
     7| ./dotnet.sh tool install dotnet-serve --tool-path ./.dotnet-tools-global
     8| git rev-parse HEAD > ./artifacts/prebuild.sha


# ====================================================================
# FILE: .devcontainer/scripts/postCreateCommand.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-2 ---
     1| set -e
     2| git reset --hard $(cat ./artifacts/prebuild.sha)


# ====================================================================
# FILE: docs/design/coreclr/profiling/davbr-blog-archive/samples/sigformat.cpp
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-320 ---
     1| #include "SigParse.cpp"
     2|  #define dimensionof(a) (sizeof(a)/sizeof(*(a)))
     3|  #define MAKE_CASE(__elt) case __elt: return #__elt;
     4|  #define MAKE_CASE_OR(__elt) case __elt: return #__elt "|";
     5| class SigFormat : public SigParser
     6| {
     7| private:
     8| 	UINT nIndentLevel;
     9| public:
    10| 	SigFormat() {nIndentLevel = 0; }
    11| 	UINT GetIndentLevel() { return nIndentLevel;}
    12| protected:
    13| 	LPCSTR SigIndexTypeToString(sig_index_type sit)
    14| 	{
    15| 		switch(sit)
    16| 		{
    17| 			default:
    18| 			DebugBreak();
    19| 			return "unknown index type";
    20| 			MAKE_CASE(SIG_INDEX_TYPE_TYPEDEF)
    21| 			MAKE_CASE(SIG_INDEX_TYPE_TYPEREF)
    22| 			MAKE_CASE(SIG_INDEX_TYPE_TYPESPEC)
    23| 		}
    24| 	}
    25| 	LPCSTR SigMemberTypeOptionToString(sig_elem_type set)
    26| 	{
    27| 		switch(set & 0xf0)
    28| 		{
    29| 			default:
    30| 			DebugBreak();
    31| 			return "unknown element type";
    32| 			case 0:
    33| 			return "";
    34| 			MAKE_CASE_OR(SIG_GENERIC)
    35| 			MAKE_CASE_OR(SIG_HASTHIS)
    36| 			MAKE_CASE_OR(SIG_EXPLICITTHIS)
    37| 		}
    38| 	}
    39| 	LPCSTR SigMemberTypeToString(sig_elem_type set)
    40| 	{
    41| 		switch(set & 0xf)
    42| 		{
    43| 			default:
    44| 			DebugBreak();
    45| 			return "unknown element type";
    46| 			MAKE_CASE(SIG_METHOD_DEFAULT)
    47| 			MAKE_CASE(SIG_METHOD_C)
    48| 			MAKE_CASE(SIG_METHOD_STDCALL)
    49| 			MAKE_CASE(SIG_METHOD_THISCALL)
    50| 			MAKE_CASE(SIG_METHOD_FASTCALL)
    51| 			MAKE_CASE(SIG_METHOD_VARARG)
    52| 			MAKE_CASE(SIG_FIELD)
    53| 			MAKE_CASE(SIG_LOCAL_SIG)
    54| 			MAKE_CASE(SIG_PROPERTY)
    55| 		}
    56| 	}
    57| 	LPCSTR SigElementTypeToString(sig_elem_type set)
    58| 	{
    59| 		switch(set)
    60| 		{
    61| 			default:
    62| 			DebugBreak();
    63| 			return "unknown element type";
    64| 			MAKE_CASE(ELEMENT_TYPE_END)
    65| 			MAKE_CASE(ELEMENT_TYPE_VOID)
    66| 			MAKE_CASE(ELEMENT_TYPE_BOOLEAN)
    67| 			MAKE_CASE(ELEMENT_TYPE_CHAR)
    68| 			MAKE_CASE(ELEMENT_TYPE_I1)
    69| 			MAKE_CASE(ELEMENT_TYPE_U1)
    70| 			MAKE_CASE(ELEMENT_TYPE_I2)
    71| 			MAKE_CASE(ELEMENT_TYPE_U2)
    72| 			MAKE_CASE(ELEMENT_TYPE_I4)
    73| 			MAKE_CASE(ELEMENT_TYPE_U4)
    74| 			MAKE_CASE(ELEMENT_TYPE_I8)
    75| 			MAKE_CASE(ELEMENT_TYPE_U8)
    76| 			MAKE_CASE(ELEMENT_TYPE_R4)
    77| 			MAKE_CASE(ELEMENT_TYPE_R8)
    78| 			MAKE_CASE(ELEMENT_TYPE_STRING)
    79| 			MAKE_CASE(ELEMENT_TYPE_PTR)
    80| 			MAKE_CASE(ELEMENT_TYPE_BYREF)
    81| 			MAKE_CASE(ELEMENT_TYPE_VALUETYPE)
    82| 			MAKE_CASE(ELEMENT_TYPE_CLASS)
    83| 			MAKE_CASE(ELEMENT_TYPE_VAR)
    84| 			MAKE_CASE(ELEMENT_TYPE_ARRAY)
    85| 			MAKE_CASE(ELEMENT_TYPE_GENERICINST)
    86| 			MAKE_CASE(ELEMENT_TYPE_TYPEDBYREF)
    87| 			MAKE_CASE(ELEMENT_TYPE_I)
    88| 			MAKE_CASE(ELEMENT_TYPE_U)
    89| 			MAKE_CASE(ELEMENT_TYPE_FNPTR)
    90| 			MAKE_CASE(ELEMENT_TYPE_OBJECT)
    91| 			MAKE_CASE(ELEMENT_TYPE_SZARRAY)
    92| 			MAKE_CASE(ELEMENT_TYPE_MVAR)
    93| 			MAKE_CASE(ELEMENT_TYPE_CMOD_REQD)
    94| 			MAKE_CASE(ELEMENT_TYPE_CMOD_OPT)
    95| 			MAKE_CASE(ELEMENT_TYPE_INTERNAL)
    96| 			MAKE_CASE(ELEMENT_TYPE_MODIFIER)
    97| 			MAKE_CASE(ELEMENT_TYPE_SENTINEL)
    98| 			MAKE_CASE(ELEMENT_TYPE_PINNED)
    99| 		}
   100| 	}
   101| 	void PrintIndent()
   102| 	{
   103| 		const char k_szSpaces[] = " ";
   104| 		printf(k_szSpaces + ((dimensionof(k_szSpaces)-1) - nIndentLevel));
   105| 	}
   106| 	void IncIndent()
   107| 	{
   108| 		nIndentLevel += 2;
   109| 	}
   110| 	void DecIndent()
   111| 	{
   112| 		nIndentLevel -= 2;
   113| 	}
   114| 	void Print(const char* format, ...)
   115| 	{
   116| 		va_list argList;
   117| 		va_start(argList, format);
   118| 		PrintIndent();
   119| 		vprintf(format, argList);
   120| 	}
   121| 	virtual void NotifyBeginMethod(sig_elem_type elem_type)
   122| 	{
   123| 		Print("BEGIN METHOD\n");
   124| 		IncIndent();
   125| 	}
   126| 	virtual void NotifyEndMethod()
   127| 	{
   128| 		DecIndent();
   129| 		Print("END METHOD\n");
   130| 	}
   131| 	virtual void NotifyParamCount(sig_count count)
   132| 	{
   133| 		Print("Param count = '%d'\n", count);
   134| 	}
   135| 	virtual void NotifyBeginRetType()
   136| 	{
   137| 		Print("BEGIN RET TYPE\n");
   138| 		IncIndent();
   139| 	}
   140| 	virtual void NotifyEndRetType()
   141| 	{
   142| 		DecIndent();
   143| 		Print("END RET TYPE\n");
   144| 	}
   145| 	virtual void NotifyBeginParam()
   146| 	{
   147| 		Print("BEGIN PARAM\n");
   148| 		IncIndent();
   149| 	}
   150| 	virtual void NotifyEndParam()
   151| 	{
   152| 		DecIndent();
   153| 		Print("END PARAM\n");
   154| 	}
   155| 	virtual void NotifySentinel()
   156| 	{
   157| 		Print("...\n");
   158| 	}
   159| 	virtual void NotifyGenericParamCount(sig_count count)
   160| 	{
   161| 		Print("Generic param count = '%d'\n", count);
   162| 	}
   163| 	virtual void NotifyBeginField(sig_elem_type elem_type)
   164| 	{
   165| 		Print("BEGIN FIELD: '%s%s'\n", SigMemberTypeOptionToString(elem_type), SigMemberTypeToString(elem_type));
   166| 		IncIndent();
   167| 	}
   168| 	virtual void NotifyEndField()
   169| 	{
   170| 		DecIndent();
   171| 		Print("END FIELD\n");
   172| 	}
   173| 	virtual void NotifyBeginLocals(sig_elem_type elem_type)
   174| 	{
   175| 		Print("BEGIN LOCALS: '%s%s'\n", SigMemberTypeOptionToString(elem_type), SigMemberTypeToString(elem_type));
   176| 		IncIndent();
   177| 	}
   178| 	virtual void NotifyEndLocals()
   179| 	{
   180| 		DecIndent();
   181| 		Print("END LOCALS\n");
   182| 	}
   183| 	virtual void NotifyLocalsCount(sig_count count)
   184| 	{
   185| 		Print("Locals count: '%d'\n", count);
   186| 	}
   187| 	virtual void NotifyBeginLocal()
   188| 	{
   189| 		Print("BEGIN LOCAL\n");
   190| 		IncIndent();
   191| 	}
   192| 	virtual void NotifyEndLocal()
   193| 	{
   194| 		DecIndent();
   195| 		Print("END LOCAL\n");
   196| 	}
   197| 	virtual void NotifyConstraint(sig_elem_type elem_type)
   198| 	{
   199| 		Print("Constraint: '%s%s'\n", SigMemberTypeOptionToString(elem_type), SigMemberTypeToString(elem_type));
   200| 	}
   201| 	virtual void NotifyBeginProperty(sig_elem_type elem_type)
   202| 	{
   203| 		Print("BEGIN PROPERTY: '%s%s'\n", SigMemberTypeOptionToString(elem_type), SigMemberTypeToString(elem_type));
   204| 		IncIndent();
   205| 	}
   206| 	virtual void NotifyEndProperty()
   207| 	{
   208| 		DecIndent();
   209| 		Print("END PROPERTY\n");
   210| 	}
   211| 	virtual void NotifyBeginArrayShape()
   212| 	{
   213| 		Print("BEGIN ARRAY SHAPE\n");
   214| 		IncIndent();
   215| 	}
   216| 	virtual void NotifyEndArrayShape()
   217| 	{
   218| 		DecIndent();
   219| 		Print("END ARRAY SHAPE\n");
   220| 	}
   221| 	virtual void NotifyRank(sig_count count)
   222| 	{
   223| 		Print("Rank: '%d'\n", count);
   224| 	}
   225| 	virtual void NotifyNumSizes(sig_count count)
   226| 	{
   227| 		Print("Num Sizes: '%d'\n", count);
   228| 	}
   229| 	virtual void NotifySize(sig_count count)
   230| 	{
   231| 		Print("Size: '%d'\n", count);
   232| 	}
   233| 	virtual void NotifyNumLoBounds(sig_count count)
   234| 	{
   235| 		Print("Num Low Bounds: '%d'\n", count);
   236| 	}
   237| 	virtual void NotifyLoBound(sig_count count)
   238| 	{
   239| 		Print("Low Bound: '%d'\n", count);
   240| 	}
   241| 	virtual void NotifyBeginType()
   242| 	{
   243| 		Print("BEGIN TYPE\n");
   244| 		IncIndent();
   245| 	}
   246| 	virtual void NotifyEndType()
   247| 	{
   248| 		DecIndent();
   249| 		Print("END TYPE\n");
   250| 	}
   251| 	virtual void NotifyTypedByref()
   252| 	{
   253| 		Print("Typed byref\n");
   254| 	}
   255| 	virtual void NotifyByref()
   256| 	{
   257| 		Print("Byref\n");
   258| 	}
   259| 	virtual void NotifyVoid()
   260| 	{
   261| 		Print("Void\n");
   262| 	}
   263| 	virtual void NotifyCustomMod(sig_elem_type cmod, sig_index_type indexType, sig_index index)
   264| 	{
   265| 		Print(
   266| 			"Custom modifiers: '%s', index type: '%s', index: '0x%x'\n",
   267| 			SigElementTypeToString(cmod),
   268| 			SigIndexTypeToString(indexType),
   269| 			index);
   270| 	}
   271| 	virtual void NotifyTypeSimple(sig_elem_type elem_type)
   272| 	{
   273| 		Print("Type simple: '%s'\n", SigElementTypeToString(elem_type));
   274| 	}
   275| 	virtual void NotifyTypeDefOrRef(sig_index_type indexType, int index)
   276| 	{
   277| 		Print("Type def or ref: '%s', index: '0x%x'\n", SigIndexTypeToString(indexType), index);
   278| 	}
   279| 	virtual void NotifyTypeGenericInst(sig_elem_type elem_type, sig_index_type indexType, sig_index index, sig_mem_number number)
   280| 	{
   281| 		Print(
   282| 			"Type generic instance: '%s', index type: '%s', index: '0x%x', member number: '%d'\n",
   283| 			SigElementTypeToString(elem_type),
   284| 			SigIndexTypeToString(indexType),
   285| 			index,
   286| 			number);
   287| 	}
   288| 	virtual void NotifyTypeGenericTypeVariable(sig_mem_number number)
   289| 	{
   290| 		Print("Type generic type variable: number: '%d'\n", number);
   291| 	}
   292| 	virtual void NotifyTypeGenericMemberVariable(sig_mem_number number)
   293| 	{
   294| 		Print("Type generic member variable: number: '%d'\n", number);
   295| 	}
   296| 	virtual void NotifyTypeValueType()
   297| 	{
   298| 		Print("Type value type\n");
   299| 	}
   300| 	virtual void NotifyTypeClass()
   301| 	{
   302| 		Print("Type class\n");
   303| 	}
   304| 	virtual void NotifyTypePointer()
   305| 	{
   306| 		Print("Type pointer\n");
   307| 	}
   308| 	virtual void NotifyTypeFunctionPointer()
   309| 	{
   310| 		Print("Type function pointer\n");
   311| 	}
   312| 	virtual void NotifyTypeArray()
   313| 	{
   314| 		Print("Type array\n");
   315| 	}
   316| 	virtual void NotifyTypeSzArray()
   317| 	{
   318| 		Print("Type sz array\n");
   319| 	}
   320| };


# ====================================================================
# FILE: docs/design/coreclr/profiling/davbr-blog-archive/samples/sigparse.cpp
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-680 ---
     1|  #define ELEMENT_TYPE_END 0x00 //Marks end of a list
     2|  #define ELEMENT_TYPE_VOID 0x01
     3|  #define ELEMENT_TYPE_BOOLEAN 0x02
     4|  #define ELEMENT_TYPE_CHAR 0x03
     5|  #define ELEMENT_TYPE_I1 0x04
     6|  #define ELEMENT_TYPE_U1 0x05
     7|  #define ELEMENT_TYPE_I2 0x06
     8|  #define ELEMENT_TYPE_U2 0x07
     9|  #define ELEMENT_TYPE_I4 0x08
    10|  #define ELEMENT_TYPE_U4 0x09
    11|  #define ELEMENT_TYPE_I8 0x0a
    12|  #define ELEMENT_TYPE_U8 0x0b
    13|  #define ELEMENT_TYPE_R4 0x0c
    14|  #define ELEMENT_TYPE_R8 0x0d
    15|  #define ELEMENT_TYPE_STRING 0x0e
    16|  #define ELEMENT_TYPE_PTR 0x0f // Followed by type
    17|  #define ELEMENT_TYPE_BYREF 0x10 // Followed by type
    18|  #define ELEMENT_TYPE_VALUETYPE 0x11 // Followed by TypeDef or TypeRef token
    19|  #define ELEMENT_TYPE_CLASS 0x12 // Followed by TypeDef or TypeRef token
    20|  #define ELEMENT_TYPE_VAR 0x13 // Generic parameter in a generic type definition, represented as number
    21|  #define ELEMENT_TYPE_ARRAY 0x14 // type rank boundsCount bound1 … loCount lo1 …
    22|  #define ELEMENT_TYPE_GENERICINST 0x15 // Generic type instantiation. Followed by type type-arg-count type-1 ... type-n
    23|  #define ELEMENT_TYPE_TYPEDBYREF 0x16
    24|  #define ELEMENT_TYPE_I 0x18 // System.IntPtr
    25|  #define ELEMENT_TYPE_U 0x19 // System.UIntPtr
    26|  #define ELEMENT_TYPE_FNPTR 0x1b // Followed by full method signature
    27|  #define ELEMENT_TYPE_OBJECT 0x1c // System.Object
    28|  #define ELEMENT_TYPE_SZARRAY 0x1d // Single-dim array with 0 lower bound
    29|  #define ELEMENT_TYPE_MVAR 0x1e // Generic parameter in a generic method definition,represented as number
    30|  #define ELEMENT_TYPE_CMOD_REQD 0x1f // Required modifier : followed by a TypeDef or TypeRef token
    31|  #define ELEMENT_TYPE_CMOD_OPT 0x20 // Optional modifier : followed by a TypeDef or TypeRef token
    32|  #define ELEMENT_TYPE_INTERNAL 0x21 // Implemented within the CLI
    33|  #define ELEMENT_TYPE_MODIFIER 0x40 // Or’d with following element types
    34|  #define ELEMENT_TYPE_SENTINEL 0x41 // Sentinel for vararg method signature
    35|  #define ELEMENT_TYPE_PINNED 0x45 // Denotes a local variable that points at a pinned object
    36|  #define SIG_METHOD_DEFAULT 0x0 // default calling convention
    37|  #define SIG_METHOD_C 0x1 // C calling convention
    38|  #define SIG_METHOD_STDCALL 0x2 // Stdcall calling convention
    39|  #define SIG_METHOD_THISCALL 0x3 // thiscall calling convention
    40|  #define SIG_METHOD_FASTCALL 0x4 // fastcall calling convention
    41|  #define SIG_METHOD_VARARG 0x5 // vararg calling convention
    42|  #define SIG_FIELD 0x6 // encodes a field
    43|  #define SIG_LOCAL_SIG 0x7 // used for the .locals directive
    44|  #define SIG_PROPERTY 0x8 // used to encode a property
    45|  #define SIG_GENERIC 0x10 // used to indicate that the method has one or more generic parameters.
    46|  #define SIG_HASTHIS 0x20 // used to encode the keyword instance in the calling convention
    47|  #define SIG_EXPLICITTHIS 0x40 // used to encode the keyword explicit in the calling convention
    48|  #define SIG_INDEX_TYPE_TYPEDEF 0 // ParseTypeDefOrRefEncoded returns this as the out index type for typedefs
    49|  #define SIG_INDEX_TYPE_TYPEREF 1 // ParseTypeDefOrRefEncoded returns this as the out index type for typerefs
    50|  #define SIG_INDEX_TYPE_TYPESPEC 2 // ParseTypeDefOrRefEncoded returns this as the out index type for typespecs
    51| typedef unsigned char sig_byte;
    52| typedef unsigned char sig_elem_type;
    53| typedef unsigned char sig_index_type;
    54| typedef unsigned int sig_index;
    55| typedef unsigned int sig_count;
    56| typedef unsigned int sig_mem_number;
    57| class SigParser
    58| {
    59| private:
    60| 	sig_byte *pbBase;
    61| 	sig_byte *pbCur;
    62| 	sig_byte *pbEnd;
    63| public:
    64| 	bool Parse(sig_byte *blob, sig_count len);
    65| private:
    66| 	bool ParseByte(sig_byte *pbOut);
    67| 	bool ParseNumber(sig_count *pOut);
    68| 	bool ParseTypeDefOrRefEncoded(sig_index_type *pOutIndexType, sig_index *pOutIndex);
    69| 	bool ParseMethod(sig_elem_type);
    70| 	bool ParseField(sig_elem_type);
    71| 	bool ParseProperty(sig_elem_type);
    72| 	bool ParseLocals(sig_elem_type);
    73| 	bool ParseLocal();
    74| 	bool ParseOptionalCustomMods();
    75| 	bool ParseOptionalCustomModsOrConstraint();
    76| 	bool ParseCustomMod();
    77| 	bool ParseRetType();
    78| 	bool ParseType();
    79| 	bool ParseParam();
    80| 	bool ParseArrayShape();
    81| protected:
    82| 	virtual void NotifyBeginMethod(sig_elem_type elem_type) {}
    83| 	virtual void NotifyEndMethod() {}
    84| 	virtual void NotifyParamCount(sig_count) {}
    85| 	virtual void NotifyBeginRetType() {}
    86| 	virtual void NotifyEndRetType() {}
    87| 	virtual void NotifyBeginParam() {}
    88| 	virtual void NotifyEndParam() {}
    89| 	virtual void NotifySentinel() {}
    90| 	virtual void NotifyGenericParamCount(sig_count) {}
    91| 	virtual void NotifyBeginField(sig_elem_type elem_type) {}
    92| 	virtual void NotifyEndField() {}
    93| 	virtual void NotifyBeginLocals(sig_elem_type elem_type) {}
    94| 	virtual void NotifyEndLocals() {}
    95| 	virtual void NotifyLocalsCount(sig_count) {}
    96| 	virtual void NotifyBeginLocal() {}
    97| 	virtual void NotifyEndLocal() {}
    98| 	virtual void NotifyConstraint(sig_elem_type elem_type) {}
    99| 	virtual void NotifyBeginProperty(sig_elem_type elem_type) {}
   100| 	virtual void NotifyEndProperty() {}
   101| 	virtual void NotifyBeginArrayShape() {}
   102| 	virtual void NotifyEndArrayShape() {}
   103| 	virtual void NotifyRank(sig_count) {}
   104| 	virtual void NotifyNumSizes(sig_count) {}
   105| 	virtual void NotifySize(sig_count) {}
   106| 	virtual void NotifyNumLoBounds(sig_count) {}
   107| 	virtual void NotifyLoBound(sig_count) {}
   108| 	virtual void NotifyBeginType() {};
   109| 	virtual void NotifyEndType() {};
   110| 	virtual void NotifyTypedByref() {}
   111| 	virtual void NotifyByref() {}
   112| 	virtual void NotifyVoid() {}
   113| 	virtual void NotifyCustomMod(sig_elem_type cmod, sig_index_type indexType, sig_index index) {}
   114| 	virtual void NotifyTypeSimple(sig_elem_type elem_type) {}
   115| 	virtual void NotifyTypeDefOrRef(sig_index_type indexType, int index) {}
   116| 	virtual void NotifyTypeGenericInst(sig_elem_type elem_type, sig_index_type indexType, sig_index index, sig_mem_number number) {}
   117| 	virtual void NotifyTypeGenericTypeVariable(sig_mem_number number) {}
   118| 	virtual void NotifyTypeGenericMemberVariable(sig_mem_number number) {}
   119| 	virtual void NotifyTypeValueType() {}
   120| 	virtual void NotifyTypeClass() {}
   121| 	virtual void NotifyTypePointer() {}
   122| 	virtual void NotifyTypeFunctionPointer() {}
   123| 	virtual void NotifyTypeArray() {}
   124| 	virtual void NotifyTypeSzArray() {}
   125| };
   126| bool SigParser::Parse(sig_byte *pb, sig_count cbBuffer)
   127| {
   128| 	pbBase = pb;
   129| 	pbCur = pb;
   130| 	pbEnd = pbBase + cbBuffer;
   131| 	sig_elem_type elem_type;
   132| 	if (!ParseByte(&elem_type))
   133| 		return false;
   134| 	switch (elem_type & 0xf)
   135| 	{
   136| 		case SIG_METHOD_DEFAULT: // default calling convention
   137| 		case SIG_METHOD_C: // C calling convention
   138| 		case SIG_METHOD_STDCALL: // Stdcall calling convention
   139| 		case SIG_METHOD_THISCALL: // thiscall calling convention
   140| 		case SIG_METHOD_FASTCALL: // fastcall calling convention
   141| 		case SIG_METHOD_VARARG: // vararg calling convention
   142| 			return ParseMethod(elem_type);
   143| 			break;
   144|  		case SIG_FIELD: // encodes a field
   145|  			return ParseField(elem_type);
   146|  			break;
   147|  		case SIG_LOCAL_SIG: // used for the .locals directive
   148|  			return ParseLocals(elem_type);
   149|  			break;
   150| 		case SIG_PROPERTY: // used to encode a property
   151|  			return ParseProperty(elem_type);
   152|  			break;
   153|  		default:
   154|  			break;
   155| 	}
   156| 	return false;
   157| }
   158| bool SigParser::ParseByte(sig_byte *pbOut)
   159| {
   160| 	if (pbCur < pbEnd)
   161| 	{
   162| 		*pbOut = *pbCur;
   163| 		pbCur++;
   164| 		return true;
   165| 	}
   166| 	return false;
   167| }
   168| bool SigParser::ParseMethod(sig_elem_type elem_type)
   169| {
   170| 	NotifyBeginMethod(elem_type);
   171| 	sig_count gen_param_count;
   172| 	sig_count param_count;
   173| 	if (elem_type & SIG_GENERIC)
   174| 	{
   175| 		if (!ParseNumber(&gen_param_count))
   176| 		{
   177| 			return false;
   178| 		}
   179| 		NotifyGenericParamCount(gen_param_count);
   180| 	}
   181| 	if (!ParseNumber(¶m_count))
   182| 	{
   183| 		return false;
   184| 	}
   185| 	NotifyParamCount(param_count);
   186| 	if (!ParseRetType())
   187| 	{
   188| 		return false;
   189| 	}
   190| 	bool fEncounteredSentinel = false;
   191| 	for (sig_count i = 0; i < param_count; i++)
   192| 	{
   193| 		if (pbCur >= pbEnd)
   194| 		{
   195| 			return false;
   196| 		}
   197| 		if (*pbCur == ELEMENT_TYPE_SENTINEL)
   198| 		{
   199| 			if (fEncounteredSentinel)
   200| 			{
   201| 				return false;
   202| 			}
   203| 			fEncounteredSentinel = true;
   204| 			NotifySentinel();
   205| 			pbCur++;
   206| 		}
   207| 		if (!ParseParam())
   208| 		{
   209| 			return false;
   210| 		}
   211| 	}
   212| 	NotifyEndMethod();
   213| 	return true;
   214| }
   215| bool SigParser::ParseField(sig_elem_type elem_type)
   216| {
   217| 	NotifyBeginField(elem_type);
   218| 	if (!ParseOptionalCustomMods())
   219| 	{
   220| 		return false;
   221| 	}
   222| 	if (!ParseType())
   223| 	{
   224| 		return false;
   225| 	}
   226| 	NotifyEndField();
   227| 	return true;
   228| }
   229| bool SigParser::ParseProperty(sig_elem_type elem_type)
   230| {
   231| 	NotifyBeginProperty(elem_type);
   232| 	sig_count param_count;
   233| 	if (!ParseNumber(&param_count))
   234| 	{
   235| 		return false;
   236| 	}
   237| 	NotifyParamCount(param_count);
   238| 	if (!ParseOptionalCustomMods())
   239| 	{
   240| 		return false;
   241| 	}
   242| 	if (!ParseType())
   243| 	{
   244| 		return false;
   245| 	}
   246| 	for (sig_count i = 0; i < param_count; i++)
   247| 	{
   248| 		if (!ParseParam())
   249| 		{
   250| 			return false;
   251| 		}
   252| 	}
   253| 	NotifyEndProperty();
   254| 	return true;
   255| }
   256| bool SigParser::ParseLocals(sig_elem_type elem_type)
   257| {
   258| 	NotifyBeginLocals(elem_type);
   259| 	sig_count local_count;
   260| 	if (!ParseNumber(&local_count))
   261| 	{
   262| 		return false;
   263| 	}
   264| 	NotifyLocalsCount(local_count);
   265| 	for (sig_count i = 0; i < local_count; i++)
   266| 	{
   267| 		if (!ParseLocal())
   268| 		{
   269| 			return false;
   270| 		}
   271| 	}
   272| 	NotifyEndLocals();
   273| 	return true;
   274| }
   275| bool SigParser::ParseLocal()
   276| {
   277| 	NotifyBeginLocal();
   278| 	if (pbCur >= pbEnd)
   279| 	{
   280| 		return false;
   281| 	}
   282| 	if (*pbCur == ELEMENT_TYPE_TYPEDBYREF)
   283| 	{
   284| 		NotifyTypedByref();
   285| 		pbCur++;
   286| 		goto Success;
   287| 	}
   288| 	if (!ParseOptionalCustomModsOrConstraint())
   289| 	{
   290| 		return false;
   291| 	}
   292| 	if (pbCur >= pbEnd)
   293| 	{
   294| 		return false;
   295| 	}
   296| 	if (*pbCur == ELEMENT_TYPE_BYREF)
   297| 	{
   298| 		NotifyByref();
   299| 		pbCur++;
   300| 	}
   301| 	if (!ParseType())
   302| 	{
   303| 		return false;
   304| 	}
   305| 	Success:
   306| 	NotifyEndLocal();
   307| 	return true;
   308| }
   309| bool SigParser::ParseOptionalCustomModsOrConstraint()
   310| {
   311| 	for (;;)
   312| 	{
   313| 		if (pbCur >= pbEnd)
   314| 		{
   315| 			return true;
   316| 		}
   317| 		switch (*pbCur)
   318| 		{
   319| 			case ELEMENT_TYPE_CMOD_OPT:
   320| 			case ELEMENT_TYPE_CMOD_REQD:
   321| 				if (!ParseCustomMod())
   322| 				{
   323| 					return false;
   324| 				}
   325| 			break;
   326| 			case ELEMENT_TYPE_PINNED:
   327| 				NotifyConstraint(*pbCur);
   328| 				pbCur++;
   329| 				break;
   330| 			default:
   331| 				return true;
   332| 		}
   333| 	}
   334| 	return false;
   335| }
   336| bool SigParser::ParseOptionalCustomMods()
   337| {
   338| 	for (;;)
   339| 	{
   340| 		if (pbCur >= pbEnd)
   341| 		{
   342| 			return true;
   343| 		}
   344| 		switch (*pbCur)
   345| 		{
   346| 			case ELEMENT_TYPE_CMOD_OPT:
   347| 			case ELEMENT_TYPE_CMOD_REQD:
   348| 				if (!ParseCustomMod())
   349| 				{
   350| 					return false;
   351| 				}
   352| 				break;
   353| 			default:
   354| 				return true;
   355| 		}
   356| 	}
   357| 	return false;
   358| }
   359| bool SigParser::ParseCustomMod()
   360| {
   361| 	sig_elem_type cmod = 0;
   362| 	sig_index index;
   363| 	sig_index_type indexType;
   364| 	if (!ParseByte(&cmod))
   365| 	{
   366| 		return false;
   367| 	}
   368| 	if (cmod == ELEMENT_TYPE_CMOD_OPT || cmod == ELEMENT_TYPE_CMOD_REQD)
   369| 	{
   370| 		if (!ParseTypeDefOrRefEncoded(&indexType, &index))
   371| 		{
   372| 			return false;
   373| 		}
   374| 		NotifyCustomMod(cmod, indexType, index);
   375| 		return true;
   376| 	}
   377| 	return false;
   378| }
   379| bool SigParser::ParseParam()
   380| {
   381| 	NotifyBeginParam();
   382| 	if (!ParseOptionalCustomMods())
   383| 	{
   384| 		return false;
   385| 	}
   386| 	if (pbCur >= pbEnd)
   387| 	{
   388| 		return false;
   389| 	}
   390| 	if (*pbCur == ELEMENT_TYPE_TYPEDBYREF)
   391| 	{
   392| 		NotifyTypedByref();
   393| 		pbCur++;
   394| 		goto Success;
   395| 	}
   396| 	if (*pbCur == ELEMENT_TYPE_BYREF)
   397| 	{
   398| 		NotifyByref();
   399| 		pbCur++;
   400| 	}
   401| 	if (!ParseType())
   402| 	{
   403| 		return false;
   404| 	}
   405| 	Success:
   406| 	NotifyEndParam();
   407| 	return true;
   408| }
   409| bool SigParser::ParseRetType()
   410| {
   411| 	NotifyBeginRetType();
   412| 	if (!ParseOptionalCustomMods())
   413| 	{
   414| 		return false;
   415| 	}
   416| 	if (pbCur >= pbEnd)
   417| 	{
   418| 		return false;
   419| 	}
   420| 	if (*pbCur == ELEMENT_TYPE_TYPEDBYREF)
   421| 	{
   422| 		NotifyTypedByref();
   423| 		pbCur++;
   424| 		goto Success;
   425| 	}
   426| 	if (*pbCur == ELEMENT_TYPE_VOID)
   427| 	{
   428| 		NotifyVoid();
   429| 		pbCur++;
   430| 		goto Success;
   431| 	}
   432| 	if (*pbCur == ELEMENT_TYPE_BYREF)
   433| 	{
   434| 		NotifyByref();
   435| 		pbCur++;
   436| 	}
   437| 	if (!ParseType())
   438| 	{
   439| 		return false;
   440| 	}
   441| 	Success:
   442| 	NotifyEndRetType();
   443| 	return true;
   444| }
   445| bool SigParser::ParseArrayShape()
   446| {
   447| 	sig_count rank;
   448| 	sig_count numsizes;
   449| 	sig_count size;
   450| 	NotifyBeginArrayShape();
   451| 	if (!ParseNumber(&rank))
   452| 	{
   453| 		return false;
   454| 	}
   455| 	NotifyRank(rank);
   456| 	if (!ParseNumber(&numsizes))
   457| 	{
   458| 		return false;
   459| 	}
   460| 	NotifyNumSizes(numsizes);
   461| 	for (sig_count i = 0; i < numsizes; i++)
   462| 	{
   463| 		if (!ParseNumber(&size))
   464| 		{
   465| 			return false;
   466| 		}
   467| 		NotifySize(size);
   468| 	}
   469| 	if (!ParseNumber(&numsizes))
   470| 	{
   471| 		return false;
   472| 	}
   473| 	NotifyNumLoBounds(numsizes);
   474| 	for (sig_count i = 0; i < numsizes; i++)
   475| 	{
   476| 		if (!ParseNumber(&size))
   477| 		{
   478| 			return false;
   479| 		}
   480| 		NotifyLoBound(size);
   481| 	}
   482| 	NotifyEndArrayShape();
   483| 	return true;
   484| }
   485| bool SigParser::ParseType()
   486| {
   487| 	NotifyBeginType();
   488| 	sig_elem_type elem_type;
   489| 	sig_index index;
   490| 	sig_mem_number number;
   491| 	sig_index_type indexType;
   492| 	if (!ParseByte(&elem_type))
   493| 		return false;
   494| 	switch (elem_type)
   495| 	{
   496| 		case ELEMENT_TYPE_BOOLEAN:
   497| 		case ELEMENT_TYPE_CHAR:
   498| 		case ELEMENT_TYPE_I1:
   499| 		case ELEMENT_TYPE_U1:
   500| 		case ELEMENT_TYPE_U2:
   501| 		case ELEMENT_TYPE_I2:
   502| 		case ELEMENT_TYPE_I4:
   503| 		case ELEMENT_TYPE_U4:
   504| 		case ELEMENT_TYPE_I8:
   505| 		case ELEMENT_TYPE_U8:
   506| 		case ELEMENT_TYPE_R4:
   507| 		case ELEMENT_TYPE_R8:
   508| 		case ELEMENT_TYPE_I:
   509| 		case ELEMENT_TYPE_U:
   510| 		case ELEMENT_TYPE_STRING:
   511| 		case ELEMENT_TYPE_OBJECT:
   512| 			NotifyTypeSimple(elem_type);
   513| 			break;
   514| 		case ELEMENT_TYPE_PTR:
   515| 			NotifyTypePointer();
   516| 			if (!ParseOptionalCustomMods())
   517| 			{
   518| 				return false;
   519| 			}
   520| 			if (pbCur >= pbEnd)
   521| 			{
   522| 				return false;
   523| 			}
   524| 			if (*pbCur == ELEMENT_TYPE_VOID)
   525| 			{
   526| 				pbCur++;
   527| 				NotifyVoid();
   528| 				break;
   529| 			}
   530| 			if (!ParseType())
   531| 			{
   532| 				return false;
   533| 			}
   534| 			break;
   535| 		case ELEMENT_TYPE_CLASS:
   536| 			NotifyTypeClass();
   537| 			if (!ParseTypeDefOrRefEncoded(&indexType, &index))
   538| 			{
   539| 				return false;
   540| 			}
   541| 			NotifyTypeDefOrRef(indexType, index);
   542| 			break;
   543| 		case ELEMENT_TYPE_VALUETYPE:
   544| 			NotifyTypeValueType();
   545| 			if (!ParseTypeDefOrRefEncoded(&indexType, &index))
   546| 			{
   547| 				return false;
   548| 			}
   549| 			NotifyTypeDefOrRef(indexType, index);
   550| 			break;
   551| 		case ELEMENT_TYPE_FNPTR:
   552| 			NotifyTypeFunctionPointer();
   553| 			if (!ParseByte(&elem_type))
   554| 			{
   555| 				return false;
   556| 			}
   557| 			if (!ParseMethod(elem_type))
   558| 			{
   559| 				return false;
   560| 			}
   561| 			break;
   562| 		case ELEMENT_TYPE_ARRAY:
   563| 			NotifyTypeArray();
   564| 			if (!ParseType())
   565| 			{
   566| 				return false;
   567| 			}
   568| 			if (!ParseArrayShape())
   569| 			{
   570| 				return false;
   571| 			}
   572| 			break;
   573| 		case ELEMENT_TYPE_SZARRAY:
   574| 			NotifyTypeSzArray();
   575| 			if (!ParseOptionalCustomMods())
   576| 			{
   577| 				return false;
   578| 			}
   579| 			if (!ParseType())
   580| 			{
   581| 				return false;
   582| 			}
   583| 			break;
   584| 		case ELEMENT_TYPE_GENERICINST:
   585| 			if (!ParseByte(&elem_type))
   586| 			{
   587| 				return false;
   588| 			}
   589| 			if (elem_type != ELEMENT_TYPE_CLASS && elem_type != ELEMENT_TYPE_VALUETYPE)
   590| 			{
   591| 				return false;
   592| 			}
   593| 			if (!ParseTypeDefOrRefEncoded(&indexType, &index))
   594| 			{
   595| 				return false;
   596| 			}
   597| 			if (!ParseNumber(&number))
   598| 			{
   599| 				return false;
   600| 			}
   601| 			NotifyTypeGenericInst(elem_type, indexType, index, number);
   602| 			{
   603| 				for (sig_mem_number i=0; i < number; i++)
   604| 				{
   605| 					if (!ParseType())
   606| 					{
   607| 						return false;
   608| 					}
   609| 				}
   610| 			}
   611| 			break;
   612| 		case ELEMENT_TYPE_VAR:
   613| 			if (!ParseNumber(&number))
   614| 			{
   615| 				return false;
   616| 			}
   617| 			NotifyTypeGenericTypeVariable(number);
   618| 			break;
   619| 		case ELEMENT_TYPE_MVAR:
   620| 			if (!ParseNumber(&number))
   621| 			{
   622| 				return false;
   623| 			}
   624| 			NotifyTypeGenericMemberVariable(number);
   625| 			break;
   626| 	}
   627| 	NotifyEndType();
   628| 	return true;
   629| }
   630| bool SigParser::ParseTypeDefOrRefEncoded(sig_index_type *pIndexTypeOut, sig_index *pIndexOut)
   631| {
   632| 	sig_count encoded = 0;
   633| 	if (!ParseNumber(&encoded))
   634| 	{
   635| 		return false;
   636| 	}
   637| 	*pIndexTypeOut = (sig_index_type) (encoded & 0x3);
   638| 	*pIndexOut = (encoded >> 2);
   639| 	return true;
   640| }
   641| bool SigParser::ParseNumber(sig_count *pOut)
   642| {
   643| 	sig_byte b1 = 0, b2 = 0, b3 = 0, b4 = 0;
   644| 	if (!ParseByte(&b1))
   645| 	{
   646| 		return false;
   647| 	}
   648| 	if (b1 == 0xff)
   649| 	{
   650| 		return false;
   651| 	}
   652| 	if ( (b1 & 0x80) == 0)
   653| 	{
   654| 		*pOut = (int)b1;
   655| 		return true;
   656| 	}
   657| 	if (!ParseByte(&b2))
   658| 	{
   659| 		return false;
   660| 	}
   661| 	if ( (b1 & 0x40) == 0)
   662| 	{
   663| 		*pOut = (((b1 & 0x3f) << 8) | b2);
   664| 		return true;
   665| 	}
   666| 	if ( (b1 & 0x20) != 0)
   667| 	{
   668| 		return false;
   669| 	}
   670| 	if (!ParseByte(&b3))
   671| 	{
   672| 		return false;
   673| 	}
   674| 	if (!ParseByte(&b4))
   675| 	{
   676| 		return false;
   677| 	}
   678| 	*pOut = ((b1 & 0x1f) << 24) | (b2 << 16) | (b3 << 8) | b4;
   679| 	return true;
   680| }


# ====================================================================
# FILE: eng/actions/backport/index.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-116 ---
     1| function BackportException(message, postToGitHub = true) {
     2|   this.message = message;
     3|   this.postToGitHub = postToGitHub;
     4| }
     5| async function run() {
     6|   const util = require("util");
     7|   const jsExec = util.promisify(require("child_process").exec);
     8|   console.log("Installing npm dependencies");
     9|   const { stdout, stderr } = await jsExec("npm install @actions/core @actions/github @actions/exec");
    10|   console.log("npm-install stderr:\n\n" + stderr);
    11|   console.log("npm-install stdout:\n\n" + stdout);
    12|   console.log("Finished installing npm dependencies");
    13|   const core = require("@actions/core");
    14|   const github = require("@actions/github");
    15|   const exec = require("@actions/exec");
    16|   const repo_owner = github.context.payload.repository.owner.login;
    17|   const repo_name = github.context.payload.repository.name;
    18|   const pr_number = github.context.payload.issue.number;
    19|   const comment_user = github.context.payload.comment.user.login;
    20|   let octokit = github.getOctokit(core.getInput("auth_token", { required: true }));
    21|   let target_branch = core.getInput("target_branch", { required: true });
    22|   try {
    23|     try {
    24|       await octokit.rest.repos.checkCollaborator({
    25|         owner: repo_owner,
    26|         repo: repo_name,
    27|         username: comment_user
    28|       });
    29|       console.log(`Verified ${comment_user} is a repo collaborator.`);
    30|     } catch (error) {
    31|       console.log(error);
    32|       throw new BackportException(`Error: @${comment_user} is not a repo collaborator, backporting is not allowed. If you're a collaborator please make sure your ${repo_owner} team membership visibility is set to Public on https://github.com/orgs/${repo_owner}/people?query=${comment_user}`);
    33|     }
    34|     try { await exec.exec(`git ls-remote --exit-code --heads origin ${target_branch}`) } catch { throw new BackportException(`Error: The specified backport target branch ${target_branch} wasn't found in the repo.`); }
    35|     console.log(`Backport target branch: ${target_branch}`);
    36|     console.log("Applying backport patch");
    37|     await exec.exec(`git checkout ${target_branch}`);
    38|     await exec.exec(`git clean -xdff`);
    39|     await exec.exec(`git config user.name "github-actions"`);
    40|     await exec.exec(`git config user.email "github-actions@github.com"`);
    41|     const temp_branch = `backport/pr-${pr_number}-to-${target_branch}`;
    42|     await exec.exec(`git checkout -b ${temp_branch}`);
    43|     let should_open_pull_request = true;
    44|     try {
    45|       await exec.exec(`git ls-remote --exit-code --heads origin ${temp_branch}`);
    46|       should_open_pull_request = false;
    47|     } catch { }
    48|     await exec.exec(`curl -sSL "${github.context.payload.issue.pull_request.patch_url}" --output changes.patch`);
    49|     const git_am_command = "git am --3way --ignore-whitespace --keep-non-patch changes.patch";
    50|     let git_am_output = `$ ${git_am_command}\n\n`;
    51|     let git_am_failed = false;
    52|     try {
    53|       await exec.exec(git_am_command, [], {
    54|         listeners: {
    55|           stdout: function stdout(data) { git_am_output += data; },
    56|           stderr: function stderr(data) { git_am_output += data; }
    57|         }
    58|       });
    59|     } catch (error) {
    60|       git_am_output += error;
    61|       git_am_failed = true;
    62|     }
    63|     if (git_am_failed) {
    64|       const git_am_failed_body = `@${github.context.payload.comment.user.login} backporting to ${target_branch} failed, the patch most likely resulted in conflicts:\n\n\`\`\`shell\n${git_am_output}\n\`\`\`\n\nPlease backport manually!`;
    65|       await octokit.rest.issues.createComment({
    66|         owner: repo_owner,
    67|         repo: repo_name,
    68|         issue_number: pr_number,
    69|         body: git_am_failed_body
    70|       });
    71|       throw new BackportException("Error: git am failed, most likely due to a merge conflict.", false);
    72|     }
    73|     else {
    74|       await exec.exec(`git push --force --set-upstream origin HEAD:${temp_branch}`);
    75|     }
    76|     if (!should_open_pull_request) {
    77|       console.log("Backport temp branch already exists, skipping opening a PR.");
    78|       return;
    79|     }
    80|     let backport_pr_title = core.getInput("pr_title_template");
    81|     let backport_pr_description = core.getInput("pr_description_template");
    82|     let cc_users = `@${comment_user}`;
    83|     if (comment_user != github.context.payload.issue.user.login) cc_users += ` @${github.context.payload.issue.user.login}`;
    84|     backport_pr_title = backport_pr_title
    85|       .replace(/%target_branch%/g, target_branch)
    86|       .replace(/%source_pr_title%/g, github.context.payload.issue.title)
    87|       .replace(/%source_pr_number%/g, github.context.payload.issue.number)
    88|       .replace(/%cc_users%/g, cc_users);
    89|     backport_pr_description = backport_pr_description
    90|       .replace(/%target_branch%/g, target_branch)
    91|       .replace(/%source_pr_title%/g, github.context.payload.issue.title)
    92|       .replace(/%source_pr_number%/g, github.context.payload.issue.number)
    93|       .replace(/%cc_users%/g, cc_users);
    94|     await octokit.rest.pulls.create({
    95|       owner: repo_owner,
    96|       repo: repo_name,
    97|       title: backport_pr_title,
    98|       body: backport_pr_description,
    99|       head: temp_branch,
   100|       base: target_branch
   101|     });
   102|     console.log("Successfully opened the GitHub PR.");
   103|   } catch (error) {
   104|     core.setFailed(error);
   105|     if (error.postToGitHub === undefined || error.postToGitHub == true) {
   106|       const unknown_error_body = `@${comment_user} an error occurred while backporting to ${target_branch}, please check the run log for details!\n\n${error.message}`;
   107|       await octokit.rest.issues.createComment({
   108|         owner: repo_owner,
   109|         repo: repo_name,
   110|         issue_number: pr_number,
   111|         body: unknown_error_body
   112|       });
   113|     }
   114|   }
   115| }
   116| run();


# ====================================================================
# FILE: eng/build.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-422 ---
     1| set -ue
     2| source="${BASH_SOURCE[0]}"
     3| while [[ -h "$source" ]]; do
     4|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     5|   source="$(readlink "$source")"
     6|   [[ $source != /* ]] && source="$scriptroot/$source"
     7| done
     8| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     9| usage()
    10| {
    11|   echo "Common settings:"
    12|   echo "  --arch (-a)                     Target platform: x86, x64, arm, armv6, armel, arm64, loongarch64, riscv64, s390x, ppc64le or wasm."
    13|   echo "                                  [Default: Your machine's architecture.]"
    14|   echo "  --binaryLog (-bl)               Output binary log."
    15|   echo "  --cross                         Optional argument to signify cross compilation."
    16|   echo "  --configuration (-c)            Build configuration: Debug, Release or Checked."
    17|   echo "                                  Checked is exclusive to the CLR subset. It is the same as Debug, except code is"
    18|   echo "                                  compiled with optimizations enabled."
    19|   echo "                                  [Default: Debug]"
    20|   echo "  --help (-h)                     Print help and exit."
    21|   echo "  --librariesConfiguration (-lc)  Libraries build configuration: Debug or Release."
    22|   echo "                                  [Default: Debug]"
    23|   echo "  --os                            Target operating system: windows, Linux, FreeBSD, OSX, MacCatalyst, tvOS,"
    24|   echo "                                  tvOSSimulator, iOS, iOSSimulator, Android, Browser, NetBSD, illumos or Solaris."
    25|   echo "                                  [Default: Your machine's OS.]"
    26|   echo "  --projects <value>              Project or solution file(s) to build."
    27|   echo "  --runtimeConfiguration (-rc)    Runtime build configuration: Debug, Release or Checked."
    28|   echo "                                  Checked is exclusive to the CLR runtime. It is the same as Debug, except code is"
    29|   echo "                                  compiled with optimizations enabled."
    30|   echo "                                  [Default: Debug]"
    31|   echo "  -runtimeFlavor (-rf)            Runtime flavor: CoreCLR or Mono."
    32|   echo "                                  [Default: CoreCLR]"
    33|   echo "  --subset (-s)                   Build a subset, print available subsets with -subset help."
    34|   echo "                                 '--subset' can be omitted if the subset is given as the first argument."
    35|   echo "                                  [Default: Builds the entire repo.]"
    36|   echo "  --verbosity (-v)                MSBuild verbosity: q[uiet], m[inimal], n[ormal], d[etailed], and diag[nostic]."
    37|   echo "                                  [Default: Minimal]"
    38|   echo ""
    39|   echo "Actions (defaults to --restore --build):"
    40|   echo "  --build (-b)               Build all source projects."
    41|   echo "                             This assumes --restore has been run already."
    42|   echo "  --clean                    Clean the solution."
    43|   echo "  --pack                     Package build outputs into NuGet packages."
    44|   echo "  --publish                  Publish artifacts (e.g. symbols)."
    45|   echo "                             This assumes --build has been run already."
    46|   echo "  --rebuild                  Rebuild all source projects."
    47|   echo "  --restore (-r)             Restore dependencies."
    48|   echo "  --sign                     Sign build outputs."
    49|   echo "  --test (-t)                Incrementally builds and runs tests."
    50|   echo "                             Use in conjunction with --testnobuild to only run tests."
    51|   echo ""
    52|   echo "Libraries settings:"
    53|   echo "  --allconfigurations        Build packages for all build configurations."
    54|   echo "  --coverage                 Collect code coverage when testing."
    55|   echo "  --framework (-f)           Build framework: net7.0 or net48."
    56|   echo "                             [Default: net7.0]"
    57|   echo "  --testnobuild              Skip building tests when invoking -test."
    58|   echo "  --testscope                Test scope, allowed values: innerloop, outerloop, all."
    59|   echo ""
    60|   echo "Native build settings:"
    61|   echo "  --clang                    Optional argument to build using clang in PATH (default)."
    62|   echo "  --clangx                   Optional argument to build using clang version x (used for Clang 7 and newer)."
    63|   echo "  --clangx.y                 Optional argument to build using clang version x.y (used for Clang 6 and older)."
    64|   echo "  --cmakeargs                User-settable additional arguments passed to CMake."
    65|   echo "  --gcc                      Optional argument to build using gcc in PATH (default)."
    66|   echo "  --gccx.y                   Optional argument to build using gcc version x.y."
    67|   echo "  --portablebuild            Optional argument: set to false to force a non-portable build."
    68|   echo "  --keepnativesymbols        Optional argument: set to true to keep native symbols/debuginfo in generated binaries."
    69|   echo "  --ninja                    Optional argument: set to true to use Ninja instead of Make to run the native build."
    70|   echo "  --pgoinstrument            Optional argument: build PGO-instrumented runtime"
    71|   echo ""
    72|   echo "Command line arguments starting with '/p:' are passed through to MSBuild."
    73|   echo "Arguments can also be passed in with a single hyphen."
    74|   echo ""
    75|   echo "Here are some quick examples. These assume you are on a Linux x64 machine:"
    76|   echo ""
    77|   echo "* Build CoreCLR for Linux x64 on Release configuration:"
    78|   echo "./build.sh clr -c release"
    79|   echo ""
    80|   echo "* Build Debug libraries with a Release runtime for Linux x64."
    81|   echo "./build.sh clr+libs -rc release"
    82|   echo ""
    83|   echo "* Build Release libraries and their tests with a Checked runtime for Linux x64, and run the tests."
    84|   echo "./build.sh clr+libs+libs.tests -rc checked -lc release -test"
    85|   echo ""
    86|   echo "* Build CoreCLR for Linux x64 on Debug configuration using Clang 9."
    87|   echo "./build.sh clr -clang9"
    88|   echo ""
    89|   echo "* Build CoreCLR for Linux x64 on Debug configuration using GCC 8.4."
    90|   echo "./build.sh clr -gcc8.4"
    91|   echo ""
    92|   echo "* Build CoreCLR for Linux x64 using extra compiler flags (-fstack-clash-protection)."
    93|   echo "EXTRA_CFLAGS=-fstack-clash-protection EXTRA_CXXFLAGS=-fstack-clash-protection ./build.sh clr"
    94|   echo ""
    95|   echo "* Cross-compile CoreCLR runtime for Linux ARM64 on Release configuration."
    96|   echo "./build.sh clr.runtime -arch arm64 -c release -cross"
    97|   echo ""
    98|   echo "However, for this example, you need to already have ROOTFS_DIR set up."
    99|   echo "Further information on this can be found here:"
   100|   echo "https://github.com/dotnet/runtime/blob/main/docs/workflow/building/coreclr/linux-instructions.md"
   101|   echo ""
   102|   echo "* Build Mono runtime for Linux x64 on Release configuration."
   103|   echo "./build.sh mono -c release"
   104|   echo ""
   105|   echo "* Build Release coreclr corelib, crossgen corelib and update Debug libraries testhost to run test on an updated corelib."
   106|   echo "./build.sh clr.corelib+clr.nativecorelib+libs.pretest -rc release"
   107|   echo ""
   108|   echo "* Build Debug mono corelib and update Release libraries testhost to run test on an updated corelib."
   109|   echo "./build.sh mono.corelib+libs.pretest -rc debug -c release"
   110|   echo ""
   111|   echo ""
   112|   echo "For more general information, check out https://github.com/dotnet/runtime/blob/main/docs/workflow/README.md"
   113| }
   114| initDistroRid()
   115| {
   116|     source "$scriptroot"/native/init-distro-rid.sh
   117|     local passedRootfsDir=""
   118|     local targetOs="$1"
   119|     local buildArch="$2"
   120|     local isCrossBuild="$3"
   121|     local isPortableBuild="$4"
   122|     if [[ $isCrossBuild == 1 && "$targetOs" != "OSX" ]]; then
   123|         passedRootfsDir=${ROOTFS_DIR}
   124|     fi
   125|     initDistroRidGlobal ${targetOs} ${buildArch} ${isPortableBuild} ${passedRootfsDir}
   126| }
   127| showSubsetHelp()
   128| {
   129|   "$scriptroot/common/build.sh" "-restore" "-build" "/p:Subset=help" "/clp:nosummary"
   130| }
   131| arguments=''
   132| cmakeargs=''
   133| extraargs=''
   134| crossBuild=0
   135| portableBuild=1
   136| source $scriptroot/native/init-os-and-arch.sh
   137| hostArch=$arch
   138| declare -a actions=("b" "build" "r" "restore" "rebuild" "testnobuild" "sign" "publish" "clean")
   139| actInt=($(comm -12 <(printf '%s\n' "${actions[@]/#/-}" | sort) <(printf '%s\n' "${@/#--/-}" | sort)))
   140| firstArgumentChecked=0
   141| while [[ $# > 0 ]]; do
   142|   opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
   143|   if [[ $firstArgumentChecked -eq 0 && $opt =~ ^[a-zA-Z.+]+$ ]]; then
   144|     if [[ "$opt" == "help" ]]; then
   145|       showSubsetHelp
   146|       exit 0
   147|     fi
   148|     arguments="$arguments /p:Subset=$1"
   149|     shift 1
   150|     continue
   151|   fi
   152|   firstArgumentChecked=1
   153|   case "$opt" in
   154|      -help|-h|-\?|/?)
   155|       usage
   156|       exit 0
   157|       ;;
   158|      -subset|-s)
   159|       if [ -z ${2+x} ]; then
   160|         showSubsetHelp
   161|         exit 0
   162|       else
   163|         passedSubset="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   164|         if [[ "$passedSubset" == "help" ]]; then
   165|           showSubsetHelp
   166|           exit 0
   167|         fi
   168|         arguments="$arguments /p:Subset=$2"
   169|         shift 2
   170|       fi
   171|       ;;
   172|      -arch|-a)
   173|       if [ -z ${2+x} ]; then
   174|         echo "No architecture supplied. See help (--help) for supported architectures." 1>&2
   175|         exit 1
   176|       fi
   177|       passedArch="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   178|       case "$passedArch" in
   179|         x64|x86|arm|armv6|armel|arm64|loongarch64|riscv64|s390x|ppc64le|wasm)
   180|           arch=$passedArch
   181|           ;;
   182|         *)
   183|           echo "Unsupported target architecture '$2'."
   184|           echo "The allowed values are x86, x64, arm, armv6, armel, arm64, loongarch64, riscv64, s390x, ppc64le and wasm."
   185|           exit 1
   186|           ;;
   187|       esac
   188|       shift 2
   189|       ;;
   190|      -configuration|-c)
   191|       if [ -z ${2+x} ]; then
   192|         echo "No configuration supplied. See help (--help) for supported configurations." 1>&2
   193|         exit 1
   194|       fi
   195|       passedConfig="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   196|       case "$passedConfig" in
   197|         debug|release|checked)
   198|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedConfig:0:1})${passedConfig:1}"
   199|           ;;
   200|         *)
   201|           echo "Unsupported target configuration '$2'."
   202|           echo "The allowed values are Debug, Release, and Checked."
   203|           exit 1
   204|           ;;
   205|       esac
   206|       arguments="$arguments -configuration $val"
   207|       shift 2
   208|       ;;
   209|      -framework|-f)
   210|       if [ -z ${2+x} ]; then
   211|         echo "No framework supplied. See help (--help) for supported frameworks." 1>&2
   212|         exit 1
   213|       fi
   214|       val="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   215|       arguments="$arguments /p:BuildTargetFramework=$val"
   216|       shift 2
   217|       ;;
   218|      -os)
   219|       if [ -z ${2+x} ]; then
   220|         echo "No target operating system supplied. See help (--help) for supported target operating systems." 1>&2
   221|         exit 1
   222|       fi
   223|       passedOS="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   224|       case "$passedOS" in
   225|         windows)
   226|           os="windows" ;;
   227|         linux)
   228|           os="Linux" ;;
   229|         freebsd)
   230|           os="FreeBSD" ;;
   231|         osx)
   232|           os="OSX" ;;
   233|         maccatalyst)
   234|           os="MacCatalyst" ;;
   235|         tvos)
   236|           os="tvOS" ;;
   237|         tvossimulator)
   238|           os="tvOSSimulator" ;;
   239|         ios)
   240|           os="iOS" ;;
   241|         iossimulator)
   242|           os="iOSSimulator" ;;
   243|         android)
   244|           os="Android" ;;
   245|         browser)
   246|           os="Browser" ;;
   247|         illumos)
   248|           os="illumos" ;;
   249|         solaris)
   250|           os="Solaris" ;;
   251|         *)
   252|           echo "Unsupported target OS '$2'."
   253|           echo "The allowed values are windows, Linux, FreeBSD, OSX, MacCatalyst, tvOS, tvOSSimulator, iOS, iOSSimulator, Android, Browser, illumos and Solaris."
   254|           exit 1
   255|           ;;
   256|       esac
   257|       arguments="$arguments /p:TargetOS=$os"
   258|       shift 2
   259|       ;;
   260|      -allconfigurations)
   261|       arguments="$arguments /p:BuildAllConfigurations=true"
   262|       shift 1
   263|       ;;
   264|      -testscope)
   265|       if [ -z ${2+x} ]; then
   266|         echo "No test scope supplied. See help (--help) for supported test scope values." 1>&2
   267|         exit 1
   268|       fi
   269|       arguments="$arguments /p:TestScope=$2"
   270|       shift 2
   271|       ;;
   272|      -testnobuild)
   273|       arguments="$arguments /p:TestNoBuild=true"
   274|       shift 1
   275|       ;;
   276|      -coverage)
   277|       arguments="$arguments /p:Coverage=true"
   278|       shift 1
   279|       ;;
   280|      -runtimeconfiguration|-rc)
   281|       if [ -z ${2+x} ]; then
   282|         echo "No runtime configuration supplied. See help (--help) for supported runtime configurations." 1>&2
   283|         exit 1
   284|       fi
   285|       passedRuntimeConf="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   286|       case "$passedRuntimeConf" in
   287|         debug|release|checked)
   288|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedRuntimeConf:0:1})${passedRuntimeConf:1}"
   289|           ;;
   290|         *)
   291|           echo "Unsupported runtime configuration '$2'."
   292|           echo "The allowed values are Debug, Release, and Checked."
   293|           exit 1
   294|           ;;
   295|       esac
   296|       arguments="$arguments /p:RuntimeConfiguration=$val"
   297|       shift 2
   298|       ;;
   299|      -runtimeflavor|-rf)
   300|       if [ -z ${2+x} ]; then
   301|         echo "No runtime flavor supplied. See help (--help) for supported runtime flavors." 1>&2
   302|         exit 1
   303|       fi
   304|       passedRuntimeFlav="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   305|       case "$passedRuntimeFlav" in
   306|         coreclr|mono)
   307|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedRuntimeFlav:0:1})${passedRuntimeFlav:1}"
   308|           ;;
   309|         *)
   310|           echo "Unsupported runtime flavor '$2'."
   311|           echo "The allowed values are CoreCLR and Mono."
   312|           exit 1
   313|           ;;
   314|       esac
   315|       arguments="$arguments /p:RuntimeFlavor=$val"
   316|       shift 2
   317|       ;;
   318|      -librariesconfiguration|-lc)
   319|       if [ -z ${2+x} ]; then
   320|         echo "No libraries configuration supplied. See help (--help) for supported libraries configurations." 1>&2
   321|         exit 1
   322|       fi
   323|       passedLibConf="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   324|       case "$passedLibConf" in
   325|         debug|release)
   326|           val="$(tr '[:lower:]' '[:upper:]' <<< ${passedLibConf:0:1})${passedLibConf:1}"
   327|           ;;
   328|         *)
   329|           echo "Unsupported libraries configuration '$2'."
   330|           echo "The allowed values are Debug and Release."
   331|           exit 1
   332|           ;;
   333|       esac
   334|       arguments="$arguments /p:LibrariesConfiguration=$val"
   335|       shift 2
   336|       ;;
   337|      -cross)
   338|       crossBuild=1
   339|       arguments="$arguments /p:CrossBuild=True"
   340|       shift 1
   341|       ;;
   342|      -clang*)
   343|       compiler="${opt/#-/}" # -clang-9 => clang-9 or clang-9 => (unchanged)
   344|       arguments="$arguments /p:Compiler=$compiler /p:CppCompilerAndLinker=$compiler"
   345|       shift 1
   346|       ;;
   347|      -cmakeargs)
   348|       if [ -z ${2+x} ]; then
   349|         echo "No cmake args supplied." 1>&2
   350|         exit 1
   351|       fi
   352|       cmakeargs="${cmakeargs} $2"
   353|       shift 2
   354|       ;;
   355|      -gcc*)
   356|       compiler="${opt/#-/}" # -gcc-9 => gcc-9 or gcc-9 => (unchanged)
   357|       arguments="$arguments /p:Compiler=$compiler /p:CppCompilerAndLinker=$compiler"
   358|       shift 1
   359|       ;;
   360|      -portablebuild)
   361|       if [ -z ${2+x} ]; then
   362|         echo "No value for portablebuild is supplied. See help (--help) for supported values." 1>&2
   363|         exit 1
   364|       fi
   365|       passedPortable="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   366|       if [ "$passedPortable" = false ]; then
   367|         portableBuild=0
   368|         arguments="$arguments /p:PortableBuild=false"
   369|       fi
   370|       shift 2
   371|       ;;
   372|      -keepnativesymbols)
   373|       if [ -z ${2+x} ]; then
   374|         echo "No value for keepNativeSymbols is supplied. See help (--help) for supported values." 1>&2
   375|         exit 1
   376|       fi
   377|       passedKeepNativeSymbols="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   378|       if [ "$passedKeepNativeSymbols" = true ]; then
   379|         arguments="$arguments /p:KeepNativeSymbols=true"
   380|       fi
   381|       shift 2
   382|       ;;
   383|       -ninja)
   384|       if [ -z ${2+x} ]; then
   385|         arguments="$arguments /p:Ninja=true"
   386|         shift 1
   387|       else
   388|         ninja="$(echo "$2" | tr "[:upper:]" "[:lower:]")"
   389|         if [ "$ninja" = true ]; then
   390|           arguments="$arguments /p:Ninja=true"
   391|           shift 2
   392|         elif [ "$ninja" = false ]; then
   393|           arguments="$arguments /p:Ninja=false"
   394|           shift 2
   395|         else
   396|           arguments="$arguments /p:Ninja=true"
   397|           shift 1
   398|         fi
   399|       fi
   400|       ;;
   401|       -pgoinstrument)
   402|       arguments="$arguments /p:PgoInstrument=true"
   403|       shift 1
   404|       ;;
   405|       *)
   406|       extraargs="$extraargs $1"
   407|       shift 1
   408|       ;;
   409|   esac
   410| done
   411| if [ ${#actInt[@]} -eq 0 ]; then
   412|     arguments="-restore -build $arguments"
   413| fi
   414| if [[ "$os" == "Browser" && "$arch" != "wasm" ]]; then
   415|     arch=wasm
   416| fi
   417| initDistroRid $os $arch $crossBuild $portableBuild
   418| export DOTNETSDK_ALLOW_TARGETING_PACK_CACHING=0
   419| cmakeargs="${cmakeargs// /%20}"
   420| arguments="$arguments /p:TargetArchitecture=$arch /p:BuildArchitecture=$hostArch"
   421| arguments="$arguments /p:CMakeArgs=\"$cmakeargs\" $extraargs"
   422| "$scriptroot/common/build.sh" $arguments


# ====================================================================
# FILE: eng/common/SetupNugetSources.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-110 ---
     1| ConfigFile=$1
     2| CredToken=$2
     3| NL='\n'
     4| TB='    '
     5| source="${BASH_SOURCE[0]}"
     6| while [[ -h "$source" ]]; do
     7|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     8|   source="$(readlink "$source")"
     9|   [[ $source != /* ]] && source="$scriptroot/$source"
    10| done
    11| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    12| . "$scriptroot/tools.sh"
    13| if [ ! -f "$ConfigFile" ]; then
    14|     Write-PipelineTelemetryError -Category 'Build' "Error: Eng/common/SetupNugetSources.sh returned a non-zero exit code. Couldn't find the NuGet config file: $ConfigFile"
    15|     ExitWithExitCode 1
    16| fi
    17| if [ -z "$CredToken" ]; then
    18|     Write-PipelineTelemetryError -category 'Build' "Error: Eng/common/SetupNugetSources.sh returned a non-zero exit code. Please supply a valid PAT"
    19|     ExitWithExitCode 1
    20| fi
    21| if [[ `uname -s` == "Darwin" ]]; then
    22|     NL=$'\\\n'
    23|     TB=''
    24| fi
    25| grep -i "<packageSources>" $ConfigFile
    26| if [ "$?" != "0" ]; then
    27|     echo "Adding <packageSources>...</packageSources> section."
    28|     ConfigNodeHeader="<configuration>"
    29|     PackageSourcesTemplate="${TB}<packageSources>${NL}${TB}</packageSources>"
    30|     sed -i.bak "s|$ConfigNodeHeader|$ConfigNodeHeader${NL}$PackageSourcesTemplate|" $ConfigFile
    31| fi
    32| grep -i "<packageSourceCredentials>" $ConfigFile
    33| if [ "$?" != "0" ]; then
    34|     echo "Adding <packageSourceCredentials>...</packageSourceCredentials> section."
    35|     PackageSourcesNodeFooter="</packageSources>"
    36|     PackageSourceCredentialsTemplate="${TB}<packageSourceCredentials>${NL}${TB}</packageSourceCredentials>"
    37|     sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourcesNodeFooter${NL}$PackageSourceCredentialsTemplate|" $ConfigFile
    38| fi
    39| PackageSources=()
    40| grep -i "<add key=\"dotnet3.1\"" $ConfigFile
    41| if [ "$?" == "0" ]; then
    42|     grep -i "<add key=\"dotnet3.1-internal\"" $ConfigFile
    43|     if [ "$?" != "0" ]; then
    44|         echo "Adding dotnet3.1-internal to the packageSources."
    45|         PackageSourcesNodeFooter="</packageSources>"
    46|         PackageSourceTemplate="${TB}<add key=\"dotnet3.1-internal\" value=\"https://pkgs.dev.azure.com/dnceng/_packaging/dotnet3.1-internal/nuget/v2\" />"
    47|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    48|     fi
    49|     PackageSources+=('dotnet3.1-internal')
    50|     grep -i "<add key=\"dotnet3.1-internal-transport\">" $ConfigFile
    51|     if [ "$?" != "0" ]; then
    52|         echo "Adding dotnet3.1-internal-transport to the packageSources."
    53|         PackageSourcesNodeFooter="</packageSources>"
    54|         PackageSourceTemplate="${TB}<add key=\"dotnet3.1-internal-transport\" value=\"https://pkgs.dev.azure.com/dnceng/_packaging/dotnet3.1-internal-transport/nuget/v2\" />"
    55|         sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    56|     fi
    57|     PackageSources+=('dotnet3.1-internal-transport')
    58| fi
    59| DotNetVersions=('5' '6' '7')
    60| for DotNetVersion in ${DotNetVersions[@]} ; do
    61|     FeedPrefix="dotnet${DotNetVersion}";
    62|     grep -i "<add key=\"$FeedPrefix\"" $ConfigFile
    63|     if [ "$?" == "0" ]; then
    64|         grep -i "<add key=\"$FeedPrefix-internal\"" $ConfigFile
    65|         if [ "$?" != "0" ]; then
    66|             echo "Adding $FeedPrefix-internal to the packageSources."
    67|             PackageSourcesNodeFooter="</packageSources>"
    68|             PackageSourceTemplate="${TB}<add key=\"$FeedPrefix-internal\" value=\"https://pkgs.dev.azure.com/dnceng/internal/_packaging/$FeedPrefix-internal/nuget/v2\" />"
    69|             sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    70|         fi
    71|         PackageSources+=("$FeedPrefix-internal")
    72|         grep -i "<add key=\"$FeedPrefix-internal-transport\">" $ConfigFile
    73|         if [ "$?" != "0" ]; then
    74|             echo "Adding $FeedPrefix-internal-transport to the packageSources."
    75|             PackageSourcesNodeFooter="</packageSources>"
    76|             PackageSourceTemplate="${TB}<add key=\"$FeedPrefix-internal-transport\" value=\"https://pkgs.dev.azure.com/dnceng/internal/_packaging/$FeedPrefix-internal-transport/nuget/v2\" />"
    77|             sed -i.bak "s|$PackageSourcesNodeFooter|$PackageSourceTemplate${NL}$PackageSourcesNodeFooter|" $ConfigFile
    78|         fi
    79|         PackageSources+=("$FeedPrefix-internal-transport")
    80|     fi
    81| done
    82| PrevIFS=$IFS
    83| IFS=$'\n'
    84| PackageSources+="$IFS"
    85| PackageSources+=$(grep -oh '"darc-int-[^"]*"' $ConfigFile | tr -d '"')
    86| IFS=$PrevIFS
    87| for FeedName in ${PackageSources[@]} ; do
    88|     grep -i "<$FeedName>" $ConfigFile 
    89|     if [ "$?" != "0" ]; then
    90|         echo "Adding credentials for $FeedName."
    91|         PackageSourceCredentialsNodeFooter="</packageSourceCredentials>"
    92|         NewCredential="${TB}${TB}<$FeedName>${NL}<add key=\"Username\" value=\"dn-bot\" />${NL}<add key=\"ClearTextPassword\" value=\"$CredToken\" />${NL}</$FeedName>"
    93|         sed -i.bak "s|$PackageSourceCredentialsNodeFooter|$NewCredential${NL}$PackageSourceCredentialsNodeFooter|" $ConfigFile
    94|     fi
    95| done
    96| grep -i "<disabledPackageSources>" $ConfigFile
    97| if [ "$?" == "0" ]; then
    98|     DisabledDarcIntSources=()
    99|     echo "Re-enabling any disabled \"darc-int\" package sources in $ConfigFile"
   100|     DisabledDarcIntSources+=$(grep -oh '"darc-int-[^"]*" value="true"' $ConfigFile  | tr -d '"')
   101|     for DisabledSourceName in ${DisabledDarcIntSources[@]} ; do
   102|         if [[ $DisabledSourceName == darc-int* ]]
   103|             then
   104|                 OldDisableValue="<add key=\"$DisabledSourceName\" value=\"true\" />"
   105|                 NewDisableValue="<!-- Reenabled for build : $DisabledSourceName -->"
   106|                 sed -i.bak "s|$OldDisableValue|$NewDisableValue|" $ConfigFile
   107|                 echo "Neutralized disablePackageSources entry for '$DisabledSourceName'"
   108|         fi
   109|     done
   110| fi


# ====================================================================
# FILE: eng/common/build.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-215 ---
     1| set -u
     2| set -e
     3| usage()
     4| {
     5|   echo "Common settings:"
     6|   echo "  --configuration <value>    Build configuration: 'Debug' or 'Release' (short: -c)"
     7|   echo "  --verbosity <value>        Msbuild verbosity: q[uiet], m[inimal], n[ormal], d[etailed], and diag[nostic] (short: -v)"
     8|   echo "  --binaryLog                Create MSBuild binary log (short: -bl)"
     9|   echo "  --help                     Print help and exit (short: -h)"
    10|   echo ""
    11|   echo "Actions:"
    12|   echo "  --restore                  Restore dependencies (short: -r)"
    13|   echo "  --build                    Build solution (short: -b)"
    14|   echo "  --sourceBuild              Source-build the solution (short: -sb)"
    15|   echo "                             Will additionally trigger the following actions: --restore, --build, --pack"
    16|   echo "                             If --configuration is not set explicitly, will also set it to 'Release'"
    17|   echo "  --rebuild                  Rebuild solution"
    18|   echo "  --test                     Run all unit tests in the solution (short: -t)"
    19|   echo "  --integrationTest          Run all integration tests in the solution"
    20|   echo "  --performanceTest          Run all performance tests in the solution"
    21|   echo "  --pack                     Package build outputs into NuGet packages and Willow components"
    22|   echo "  --sign                     Sign build outputs"
    23|   echo "  --publish                  Publish artifacts (e.g. symbols)"
    24|   echo "  --clean                    Clean the solution"
    25|   echo ""
    26|   echo "Advanced settings:"
    27|   echo "  --projects <value>       Project or solution file(s) to build"
    28|   echo "  --ci                     Set when running on CI server"
    29|   echo "  --excludeCIBinarylog     Don't output binary log (short: -nobl)"
    30|   echo "  --prepareMachine         Prepare machine for CI run, clean up processes after build"
    31|   echo "  --nodeReuse <value>      Sets nodereuse msbuild parameter ('true' or 'false')"
    32|   echo "  --warnAsError <value>    Sets warnaserror msbuild parameter ('true' or 'false')"
    33|   echo ""
    34|   echo "Command line arguments not listed above are passed thru to msbuild."
    35|   echo "Arguments can also be passed in with a single hyphen."
    36| }
    37| source="${BASH_SOURCE[0]}"
    38| while [[ -h "$source" ]]; do
    39|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    40|   source="$(readlink "$source")"
    41|   [[ $source != /* ]] && source="$scriptroot/$source"
    42| done
    43| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    44| restore=false
    45| build=false
    46| source_build=false
    47| rebuild=false
    48| test=false
    49| integration_test=false
    50| performance_test=false
    51| pack=false
    52| publish=false
    53| sign=false
    54| public=false
    55| ci=false
    56| clean=false
    57| warn_as_error=true
    58| node_reuse=true
    59| binary_log=false
    60| exclude_ci_binary_log=false
    61| pipelines_log=false
    62| projects=''
    63| configuration=''
    64| prepare_machine=false
    65| verbosity='minimal'
    66| runtime_source_feed=''
    67| runtime_source_feed_key=''
    68| properties=''
    69| while [[ $# > 0 ]]; do
    70|   opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
    71|   case "$opt" in
    72|     -help|-h)
    73|       usage
    74|       exit 0
    75|       ;;
    76|     -clean)
    77|       clean=true
    78|       ;;
    79|     -configuration|-c)
    80|       configuration=$2
    81|       shift
    82|       ;;
    83|     -verbosity|-v)
    84|       verbosity=$2
    85|       shift
    86|       ;;
    87|     -binarylog|-bl)
    88|       binary_log=true
    89|       ;;
    90|     -excludeCIBinarylog|-nobl)
    91|       exclude_ci_binary_log=true
    92|       ;;
    93|     -pipelineslog|-pl)
    94|       pipelines_log=true
    95|       ;;
    96|     -restore|-r)
    97|       restore=true
    98|       ;;
    99|     -build|-b)
   100|       build=true
   101|       ;;
   102|     -rebuild)
   103|       rebuild=true
   104|       ;;
   105|     -pack)
   106|       pack=true
   107|       ;;
   108|     -sourcebuild|-sb)
   109|       build=true
   110|       source_build=true
   111|       restore=true
   112|       pack=true
   113|       ;;
   114|     -test|-t)
   115|       test=true
   116|       ;;
   117|     -integrationtest)
   118|       integration_test=true
   119|       ;;
   120|     -performancetest)
   121|       performance_test=true
   122|       ;;
   123|     -sign)
   124|       sign=true
   125|       ;;
   126|     -publish)
   127|       publish=true
   128|       ;;
   129|     -preparemachine)
   130|       prepare_machine=true
   131|       ;;
   132|     -projects)
   133|       projects=$2
   134|       shift
   135|       ;;
   136|     -ci)
   137|       ci=true
   138|       ;;
   139|     -warnaserror)
   140|       warn_as_error=$2
   141|       shift
   142|       ;;
   143|     -nodereuse)
   144|       node_reuse=$2
   145|       shift
   146|       ;;
   147|     -runtimesourcefeed)
   148|       runtime_source_feed=$2
   149|       shift
   150|       ;;
   151|      -runtimesourcefeedkey)
   152|       runtime_source_feed_key=$2
   153|       shift
   154|       ;;
   155|     *)
   156|       properties="$properties $1"
   157|       ;;
   158|   esac
   159|   shift
   160| done
   161| if [[ -z "$configuration" ]]; then
   162|   if [[ "$source_build" = true ]]; then configuration="Release"; else configuration="Debug"; fi
   163| fi
   164| if [[ "$ci" == true ]]; then
   165|   pipelines_log=true
   166|   node_reuse=false
   167|   if [[ "$exclude_ci_binary_log" == false ]]; then
   168|     binary_log=true
   169|   fi
   170| fi
   171| . "$scriptroot/tools.sh"
   172| function InitializeCustomToolset {
   173|   local script="$eng_root/restore-toolset.sh"
   174|   if [[ -a "$script" ]]; then
   175|     . "$script"
   176|   fi
   177| }
   178| function Build {
   179|   InitializeToolset
   180|   InitializeCustomToolset
   181|   if [[ ! -z "$projects" ]]; then
   182|     properties="$properties /p:Projects=$projects"
   183|   fi
   184|   local bl=""
   185|   if [[ "$binary_log" == true ]]; then
   186|     bl="/bl:\"$log_dir/Build.binlog\""
   187|   fi
   188|   MSBuild $_InitializeToolset \
   189|     $bl \
   190|     /p:Configuration=$configuration \
   191|     /p:RepoRoot="$repo_root" \
   192|     /p:Restore=$restore \
   193|     /p:Build=$build \
   194|     /p:ArcadeBuildFromSource=$source_build \
   195|     /p:Rebuild=$rebuild \
   196|     /p:Test=$test \
   197|     /p:Pack=$pack \
   198|     /p:IntegrationTest=$integration_test \
   199|     /p:PerformanceTest=$performance_test \
   200|     /p:Sign=$sign \
   201|     /p:Publish=$publish \
   202|     $properties
   203|   ExitWithExitCode 0
   204| }
   205| if [[ "$clean" == true ]]; then
   206|   if [ -d "$artifacts_dir" ]; then
   207|     rm -rf $artifacts_dir
   208|     echo "Artifacts directory deleted."
   209|   fi
   210|   exit 0
   211| fi
   212| if [[ "$restore" == true ]]; then
   213|   InitializeNativeTools
   214| fi
   215| Build


# ====================================================================
# FILE: eng/common/cross/arm/tizen-build-rootfs.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| set -e
     2| __ARM_HARDFP_CrossDir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
     3| __TIZEN_CROSSDIR="$__ARM_HARDFP_CrossDir/tizen"
     4| if [[ -z "$ROOTFS_DIR" ]]; then
     5|     echo "ROOTFS_DIR is not defined."
     6|     exit 1;
     7| fi
     8| TIZEN_TMP_DIR=$ROOTFS_DIR/tizen_tmp
     9| mkdir -p $TIZEN_TMP_DIR
    10| echo ">>Start downloading files"
    11| VERBOSE=1 $__ARM_HARDFP_CrossDir/tizen-fetch.sh $TIZEN_TMP_DIR
    12| echo "<<Finish downloading files"
    13| echo ">>Start constructing Tizen rootfs"
    14| TIZEN_RPM_FILES=`ls $TIZEN_TMP_DIR/*.rpm`
    15| cd $ROOTFS_DIR
    16| for f in $TIZEN_RPM_FILES; do
    17|     rpm2cpio $f  | cpio -idm --quiet
    18| done
    19| echo "<<Finish constructing Tizen rootfs"
    20| rm -rf $TIZEN_TMP_DIR
    21| echo ">>Start configuring Tizen rootfs"
    22| ln -sfn asm-arm ./usr/include/asm
    23| patch -p1 < $__TIZEN_CROSSDIR/tizen.patch
    24| echo "<<Finish configuring Tizen rootfs"


# ====================================================================
# FILE: eng/common/cross/arm/tizen-fetch.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-134 ---
     1| set -e
     2| if [[ -z "${VERBOSE// }" ]] || [ "$VERBOSE" -ne "$VERBOSE" ] 2>/dev/null; then
     3| 	VERBOSE=0
     4| fi
     5| Log()
     6| {
     7| 	if [ $VERBOSE -ge $1 ]; then
     8| 		echo ${@:2}
     9| 	fi
    10| }
    11| Inform()
    12| {
    13| 	Log 1 -e "\x1B[0;34m$@\x1B[m"
    14| }
    15| Debug()
    16| {
    17| 	Log 2 -e "\x1B[0;32m$@\x1B[m"
    18| }
    19| Error()
    20| {
    21| 	>&2 Log 0 -e "\x1B[0;31m$@\x1B[m"
    22| }
    23| Fetch()
    24| {
    25| 	URL=$1
    26| 	FILE=$2
    27| 	PROGRESS=$3
    28| 	if [ $VERBOSE -ge 1 ] && [ $PROGRESS ]; then
    29| 		CURL_OPT="--progress-bar"
    30| 	else
    31| 		CURL_OPT="--silent"
    32| 	fi
    33| 	curl $CURL_OPT $URL > $FILE
    34| }
    35| hash curl 2> /dev/null || { Error "Require 'curl' Aborting."; exit 1; }
    36| hash xmllint 2> /dev/null || { Error "Require 'xmllint' Aborting."; exit 1; }
    37| hash sha256sum 2> /dev/null || { Error "Require 'sha256sum' Aborting."; exit 1; }
    38| TMPDIR=$1
    39| if [ ! -d $TMPDIR ]; then
    40| 	TMPDIR=./tizen_tmp
    41| 	Debug "Create temporary directory : $TMPDIR"
    42| 	mkdir -p $TMPDIR 
    43| fi
    44| TIZEN_URL=http://download.tizen.org/snapshots/tizen
    45| BUILD_XML=build.xml
    46| REPOMD_XML=repomd.xml
    47| PRIMARY_XML=primary.xml
    48| TARGET_URL="http://__not_initialized"
    49| Xpath_get()
    50| {
    51| 	XPATH_RESULT=''
    52| 	XPATH=$1
    53| 	XML_FILE=$2
    54| 	RESULT=$(xmllint --xpath $XPATH $XML_FILE)
    55| 	if [[ -z ${RESULT// } ]]; then
    56| 		Error "Can not find target from $XML_FILE"
    57| 		Debug "Xpath = $XPATH"
    58| 		exit 1
    59| 	fi
    60| 	XPATH_RESULT=$RESULT
    61| }
    62| fetch_tizen_pkgs_init()
    63| {
    64| 	TARGET=$1
    65| 	PROFILE=$2
    66| 	Debug "Initialize TARGET=$TARGET, PROFILE=$PROFILE"
    67| 	TMP_PKG_DIR=$TMPDIR/tizen_${PROFILE}_pkgs
    68| 	if [ -d $TMP_PKG_DIR ]; then rm -rf $TMP_PKG_DIR; fi
    69| 	mkdir -p $TMP_PKG_DIR
    70| 	PKG_URL=$TIZEN_URL/$PROFILE/latest
    71| 	BUILD_XML_URL=$PKG_URL/$BUILD_XML
    72| 	TMP_BUILD=$TMP_PKG_DIR/$BUILD_XML
    73| 	TMP_REPOMD=$TMP_PKG_DIR/$REPOMD_XML
    74| 	TMP_PRIMARY=$TMP_PKG_DIR/$PRIMARY_XML
    75| 	TMP_PRIMARYGZ=${TMP_PRIMARY}.gz
    76| 	Fetch $BUILD_XML_URL $TMP_BUILD
    77| 	Debug "fetch $BUILD_XML_URL to $TMP_BUILD"
    78| 	TARGET_XPATH="//build/buildtargets/buildtarget[@name=\"$TARGET\"]/repo[@type=\"binary\"]/text()"
    79| 	Xpath_get $TARGET_XPATH $TMP_BUILD
    80| 	TARGET_PATH=$XPATH_RESULT
    81| 	TARGET_URL=$PKG_URL/$TARGET_PATH
    82| 	REPOMD_URL=$TARGET_URL/repodata/repomd.xml
    83| 	PRIMARY_XPATH='string(//*[local-name()="data"][@type="primary"]/*[local-name()="location"]/@href)'
    84| 	Fetch $REPOMD_URL $TMP_REPOMD
    85| 	Debug "fetch $REPOMD_URL to $TMP_REPOMD"
    86| 	Xpath_get $PRIMARY_XPATH $TMP_REPOMD
    87| 	PRIMARY_XML_PATH=$XPATH_RESULT
    88| 	PRIMARY_URL=$TARGET_URL/$PRIMARY_XML_PATH
    89| 	Fetch $PRIMARY_URL $TMP_PRIMARYGZ
    90| 	Debug "fetch $PRIMARY_URL to $TMP_PRIMARYGZ"
    91| 	gunzip $TMP_PRIMARYGZ 
    92| 	Debug "unzip $TMP_PRIMARYGZ to $TMP_PRIMARY" 
    93| }
    94| fetch_tizen_pkgs()
    95| {
    96| 	ARCH=$1
    97| 	PACKAGE_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="location"]/@href)'
    98| 	PACKAGE_CHECKSUM_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="checksum"]/text())'
    99| 	for pkg in ${@:2}
   100| 	do
   101| 		Inform "Fetching... $pkg"
   102| 		XPATH=${PACKAGE_XPATH_TPL/_PKG_/$pkg}
   103| 		XPATH=${XPATH/_ARCH_/$ARCH}
   104| 		Xpath_get $XPATH $TMP_PRIMARY
   105| 		PKG_PATH=$XPATH_RESULT
   106| 		XPATH=${PACKAGE_CHECKSUM_XPATH_TPL/_PKG_/$pkg}
   107| 		XPATH=${XPATH/_ARCH_/$ARCH}
   108| 		Xpath_get $XPATH $TMP_PRIMARY
   109| 		CHECKSUM=$XPATH_RESULT
   110| 		PKG_URL=$TARGET_URL/$PKG_PATH
   111| 		PKG_FILE=$(basename $PKG_PATH)
   112| 		PKG_PATH=$TMPDIR/$PKG_FILE
   113| 		Debug "Download $PKG_URL to $PKG_PATH"
   114| 		Fetch $PKG_URL $PKG_PATH true
   115| 		echo "$CHECKSUM $PKG_PATH" | sha256sum -c - > /dev/null
   116| 		if [ $? -ne 0 ]; then
   117| 			Error "Fail to fetch $PKG_URL to $PKG_PATH"
   118| 			Debug "Checksum = $CHECKSUM"
   119| 			exit 1
   120| 		fi
   121| 	done
   122| }
   123| Inform "Initialize arm base"
   124| fetch_tizen_pkgs_init standard base
   125| Inform "fetch common packages"
   126| fetch_tizen_pkgs armv7hl gcc gcc-devel-static glibc glibc-devel libicu libicu-devel libatomic linux-glibc-devel keyutils keyutils-devel libkeyutils
   127| Inform "fetch coreclr packages"
   128| fetch_tizen_pkgs armv7hl lldb lldb-devel libgcc libstdc++ libstdc++-devel libunwind libunwind-devel lttng-ust-devel lttng-ust userspace-rcu-devel userspace-rcu
   129| Inform "fetch corefx packages"
   130| fetch_tizen_pkgs armv7hl libcom_err libcom_err-devel zlib zlib-devel libopenssl11 libopenssl1.1-devel krb5 krb5-devel
   131| Inform "Initialize standard unified"
   132| fetch_tizen_pkgs_init standard unified
   133| Inform "fetch corefx packages"
   134| fetch_tizen_pkgs armv7hl gssdp gssdp-devel tizen-release


# ====================================================================
# FILE: eng/common/cross/build-rootfs.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-443 ---
     1| set -e
     2| usage()
     3| {
     4|     echo "Usage: $0 [BuildArch] [CodeName] [lldbx.y] [llvmx[.y]] [--skipunmount] --rootfsdir <directory>]"
     5|     echo "BuildArch can be: arm(default), arm64, armel, armv6, ppc64le, riscv64, s390x, x64, x86"
     6|     echo "CodeName - optional, Code name for Linux, can be: xenial(default), zesty, bionic, alpine, alpine3.13 or alpine3.14. If BuildArch is armel, LinuxCodeName is jessie(default) or tizen."
     7|     echo "                              for FreeBSD can be: freebsd12, freebsd13"
     8|     echo "                              for illumos can be: illumos"
     9|     echo "                                for Haiku can be: haiku."
    10|     echo "lldbx.y - optional, LLDB version, can be: lldb3.9(default), lldb4.0, lldb5.0, lldb6.0 no-lldb. Ignored for alpine and FreeBSD"
    11|     echo "llvmx[.y] - optional, LLVM version for LLVM related packages."
    12|     echo "--skipunmount - optional, will skip the unmount of rootfs folder."
    13|     echo "--use-mirror - optional, use mirror URL to fetch resources, when available."
    14|     echo "--jobs N - optional, restrict to N jobs."
    15|     exit 1
    16| }
    17| __CodeName=xenial
    18| __CrossDir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
    19| __BuildArch=arm
    20| __AlpineArch=armv7
    21| __FreeBSDArch=arm
    22| __FreeBSDMachineArch=armv7
    23| __IllumosArch=arm7
    24| __QEMUArch=arm
    25| __UbuntuArch=armhf
    26| __UbuntuRepo="http://ports.ubuntu.com/"
    27| __LLDB_Package="liblldb-3.9-dev"
    28| __SkipUnmount=0
    29| __UbuntuPackages="build-essential"
    30| __AlpinePackages="alpine-base"
    31| __AlpinePackages+=" build-base"
    32| __AlpinePackages+=" linux-headers"
    33| __AlpinePackages+=" lldb-dev"
    34| __AlpinePackages+=" python3"
    35| __AlpinePackages+=" libedit"
    36| __UbuntuPackages+=" symlinks"
    37| __UbuntuPackages+=" libicu-dev"
    38| __UbuntuPackages+=" liblttng-ust-dev"
    39| __UbuntuPackages+=" libunwind8-dev"
    40| __AlpinePackages+=" gettext-dev"
    41| __AlpinePackages+=" icu-dev"
    42| __AlpinePackages+=" libunwind-dev"
    43| __AlpinePackages+=" lttng-ust-dev"
    44| __AlpinePackages+=" compiler-rt-static"
    45| __UbuntuPackages+=" libcurl4-openssl-dev"
    46| __UbuntuPackages+=" libkrb5-dev"
    47| __UbuntuPackages+=" libssl-dev"
    48| __UbuntuPackages+=" zlib1g-dev"
    49| __AlpinePackages+=" curl-dev"
    50| __AlpinePackages+=" krb5-dev"
    51| __AlpinePackages+=" openssl-dev"
    52| __AlpinePackages+=" zlib-dev"
    53| __FreeBSDBase="12.3-RELEASE"
    54| __FreeBSDPkg="1.17.0"
    55| __FreeBSDABI="12"
    56| __FreeBSDPackages="libunwind"
    57| __FreeBSDPackages+=" icu"
    58| __FreeBSDPackages+=" libinotify"
    59| __FreeBSDPackages+=" openssl"
    60| __FreeBSDPackages+=" krb5"
    61| __FreeBSDPackages+=" terminfo-db"
    62| __IllumosPackages="icu"
    63| __IllumosPackages+=" mit-krb5"
    64| __IllumosPackages+=" openssl"
    65| __IllumosPackages+=" zlib"
    66| __HaikuPackages="gmp"
    67| __HaikuPackages+=" gmp_devel"
    68| __HaikuPackages+=" krb5"
    69| __HaikuPackages+=" krb5_devel"
    70| __HaikuPackages+=" libiconv"
    71| __HaikuPackages+=" libiconv_devel"
    72| __HaikuPackages+=" llvm12_libunwind"
    73| __HaikuPackages+=" llvm12_libunwind_devel"
    74| __HaikuPackages+=" mpfr"
    75| __HaikuPackages+=" mpfr_devel"
    76| __UbuntuPackages+=" libomp5"
    77| __UbuntuPackages+=" libomp-dev"
    78| __Keyring=
    79| __UseMirror=0
    80| __UnprocessedBuildArgs=
    81| while :; do
    82|     if [[ "$#" -le 0 ]]; then
    83|         break
    84|     fi
    85|     lowerI="$(echo "$1" | tr "[:upper:]" "[:lower:]")"
    86|     case $lowerI in
    87|         -\?|-h|--help)
    88|             usage
    89|             exit 1
    90|             ;;
    91|         arm)
    92|             __BuildArch=arm
    93|             __UbuntuArch=armhf
    94|             __AlpineArch=armv7
    95|             __QEMUArch=arm
    96|             ;;
    97|         arm64)
    98|             __BuildArch=arm64
    99|             __UbuntuArch=arm64
   100|             __AlpineArch=aarch64
   101|             __QEMUArch=aarch64
   102|             __FreeBSDArch=arm64
   103|             __FreeBSDMachineArch=aarch64
   104|             ;;
   105|         armel)
   106|             __BuildArch=armel
   107|             __UbuntuArch=armel
   108|             __UbuntuRepo="http://ftp.debian.org/debian/"
   109|             __CodeName=jessie
   110|             ;;
   111|         armv6)
   112|             __BuildArch=armv6
   113|             __UbuntuArch=armhf
   114|             __QEMUArch=arm
   115|             __UbuntuRepo="http://raspbian.raspberrypi.org/raspbian/"
   116|             __CodeName=buster
   117|             __LLDB_Package="liblldb-6.0-dev"
   118|             if [[ -e "/usr/share/keyrings/raspbian-archive-keyring.gpg" ]]; then
   119|                 __Keyring="--keyring /usr/share/keyrings/raspbian-archive-keyring.gpg"
   120|             fi
   121|             ;;
   122|         ppc64le)
   123|             __BuildArch=ppc64le
   124|             __UbuntuArch=ppc64el
   125|             __UbuntuRepo="http://ports.ubuntu.com/ubuntu-ports/"
   126|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libunwind8-dev//')
   127|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libomp-dev//')
   128|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libomp5//')
   129|             unset __LLDB_Package
   130|             ;;
   131|         riscv64)
   132|             __BuildArch=riscv64
   133|             __UbuntuArch=riscv64
   134|             __UbuntuRepo="http://deb.debian.org/debian-ports"
   135|             __CodeName=sid
   136|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libunwind8-dev//')
   137|             unset __LLDB_Package
   138|             if [[ -e "/usr/share/keyrings/debian-ports-archive-keyring.gpg" ]]; then
   139|                 __Keyring="--keyring /usr/share/keyrings/debian-ports-archive-keyring.gpg --include=debian-ports-archive-keyring"
   140|             fi
   141|             ;;
   142|         s390x)
   143|             __BuildArch=s390x
   144|             __UbuntuArch=s390x
   145|             __UbuntuRepo="http://ports.ubuntu.com/ubuntu-ports/"
   146|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libunwind8-dev//')
   147|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libomp-dev//')
   148|             __UbuntuPackages=$(echo ${__UbuntuPackages} | sed 's/ libomp5//')
   149|             unset __LLDB_Package
   150|             ;;
   151|         x64)
   152|             __BuildArch=x64
   153|             __UbuntuArch=amd64
   154|             __FreeBSDArch=amd64
   155|             __FreeBSDMachineArch=amd64
   156|             __illumosArch=x86_64
   157|             __UbuntuRepo=
   158|             ;;
   159|         x86)
   160|             __BuildArch=x86
   161|             __UbuntuArch=i386
   162|             __UbuntuRepo="http://archive.ubuntu.com/ubuntu/"
   163|             ;;
   164|         lldb*)
   165|             version="${lowerI/lldb/}"
   166|             parts=(${version//./ })
   167|             if [[ "${parts[0]}" -gt 6 ]]; then
   168|                 version="${parts[0]}"
   169|             fi
   170|             __LLDB_Package="liblldb-${version}-dev"
   171|             ;;
   172|         no-lldb)
   173|             unset __LLDB_Package
   174|             ;;
   175|         llvm*)
   176|             version="${lowerI/llvm/}"
   177|             parts=(${version//./ })
   178|             __LLVM_MajorVersion="${parts[0]}"
   179|             __LLVM_MinorVersion="${parts[1]}"
   180|             if [[ -z "$__LLVM_MinorVersion" && "$__LLVM_MajorVersion" -le 6 ]]; then
   181|                 __LLVM_MinorVersion=0;
   182|             fi
   183|             ;;
   184|         xenial) # Ubuntu 16.04
   185|             if [[ "$__CodeName" != "jessie" ]]; then
   186|                 __CodeName=xenial
   187|             fi
   188|             ;;
   189|         zesty) # Ubuntu 17.04
   190|             if [[ "$__CodeName" != "jessie" ]]; then
   191|                 __CodeName=zesty
   192|             fi
   193|             ;;
   194|         bionic) # Ubuntu 18.04
   195|             if [[ "$__CodeName" != "jessie" ]]; then
   196|                 __CodeName=bionic
   197|             fi
   198|             ;;
   199|         focal) # Ubuntu 20.04
   200|             if [[ "$__CodeName" != "jessie" ]]; then
   201|                 __CodeName=focal
   202|             fi
   203|             ;;
   204|         jammy) # Ubuntu 22.04
   205|             if [[ "$__CodeName" != "jessie" ]]; then
   206|                 __CodeName=jammy
   207|             fi
   208|             ;;
   209|         jessie) # Debian 8
   210|             __CodeName=jessie
   211|             __UbuntuRepo="http://ftp.debian.org/debian/"
   212|             ;;
   213|         stretch) # Debian 9
   214|             __CodeName=stretch
   215|             __UbuntuRepo="http://ftp.debian.org/debian/"
   216|             __LLDB_Package="liblldb-6.0-dev"
   217|             ;;
   218|         buster) # Debian 10
   219|             __CodeName=buster
   220|             __UbuntuRepo="http://ftp.debian.org/debian/"
   221|             __LLDB_Package="liblldb-6.0-dev"
   222|             ;;
   223|         tizen)
   224|             __CodeName=
   225|             __UbuntuRepo=
   226|             __Tizen=tizen
   227|             ;;
   228|         alpine|alpine3.13)
   229|             __CodeName=alpine
   230|             __UbuntuRepo=
   231|             __AlpineVersion=3.13
   232|             __AlpinePackages+=" llvm10-libs"
   233|             ;;
   234|         alpine3.14)
   235|             __CodeName=alpine
   236|             __UbuntuRepo=
   237|             __AlpineVersion=3.14
   238|             __AlpinePackages+=" llvm11-libs"
   239|             ;;
   240|         freebsd12)
   241|             __CodeName=freebsd
   242|             __SkipUnmount=1
   243|             ;;
   244|         freebsd13)
   245|             __CodeName=freebsd
   246|             __FreeBSDBase="13.0-RELEASE"
   247|             __FreeBSDABI="13"
   248|             __SkipUnmount=1
   249|             ;;
   250|         illumos)
   251|             __CodeName=illumos
   252|             __SkipUnmount=1
   253|             ;;
   254|         haiku)
   255|             __CodeName=haiku
   256|             __BuildArch=x64
   257|             __SkipUnmount=1
   258|             ;;
   259|         --skipunmount)
   260|             __SkipUnmount=1
   261|             ;;
   262|         --rootfsdir|-rootfsdir)
   263|             shift
   264|             __RootfsDir="$1"
   265|             ;;
   266|         --use-mirror)
   267|             __UseMirror=1
   268|             ;;
   269|         --use-jobs)
   270|             shift
   271|             MAXJOBS=$1
   272|             ;;
   273|         *)
   274|             __UnprocessedBuildArgs="$__UnprocessedBuildArgs $1"
   275|             ;;
   276|     esac
   277|     shift
   278| done
   279| if [[ "$__BuildArch" == "armel" ]]; then
   280|     __LLDB_Package="lldb-3.5-dev"
   281| fi
   282| __UbuntuPackages+=" ${__LLDB_Package:-}"
   283| if [[ -n "$__LLVM_MajorVersion" ]]; then
   284|     __UbuntuPackages+=" libclang-common-${__LLVM_MajorVersion}${__LLVM_MinorVersion:+.$__LLVM_MinorVersion}-dev"
   285| fi
   286| if [[ -z "$__RootfsDir" && -n "$ROOTFS_DIR" ]]; then
   287|     __RootfsDir="$ROOTFS_DIR"
   288| fi
   289| if [[ -z "$__RootfsDir" ]]; then
   290|     __RootfsDir="$__CrossDir/../../../.tools/rootfs/$__BuildArch"
   291| fi
   292| if [[ -d "$__RootfsDir" ]]; then
   293|     if [[ "$__SkipUnmount" == "0" ]]; then
   294|         umount "$__RootfsDir"/* || true
   295|     fi
   296|     rm -rf "$__RootfsDir"
   297| fi
   298| mkdir -p "$__RootfsDir"
   299| __RootfsDir="$( cd "$__RootfsDir" && pwd )"
   300| if [[ "$__CodeName" == "alpine" ]]; then
   301|     __ApkToolsVersion=2.9.1
   302|     __ApkToolsDir="$(mktemp -d)"
   303|     wget "https://github.com/alpinelinux/apk-tools/releases/download/v$__ApkToolsVersion/apk-tools-$__ApkToolsVersion-x86_64-linux.tar.gz" -P "$__ApkToolsDir"
   304|     tar -xf "$__ApkToolsDir/apk-tools-$__ApkToolsVersion-x86_64-linux.tar.gz" -C "$__ApkToolsDir"
   305|     mkdir -p "$__RootfsDir"/usr/bin
   306|     cp -v "/usr/bin/qemu-$__QEMUArch-static" "$__RootfsDir/usr/bin"
   307|     "$__ApkToolsDir/apk-tools-$__ApkToolsVersion/apk" \
   308|       -X "http://dl-cdn.alpinelinux.org/alpine/v$__AlpineVersion/main" \
   309|       -X "http://dl-cdn.alpinelinux.org/alpine/v$__AlpineVersion/community" \
   310|       -U --allow-untrusted --root "$__RootfsDir" --arch "$__AlpineArch" --initdb \
   311|       add $__AlpinePackages
   312|     rm -r "$__ApkToolsDir"
   313| elif [[ "$__CodeName" == "freebsd" ]]; then
   314|     mkdir -p "$__RootfsDir"/usr/local/etc
   315|     JOBS=${MAXJOBS:="$(getconf _NPROCESSORS_ONLN)"}
   316|     wget -O - "https://download.freebsd.org/ftp/releases/${__FreeBSDArch}/${__FreeBSDMachineArch}/${__FreeBSDBase}/base.txz" | tar -C "$__RootfsDir" -Jxf - ./lib ./usr/lib ./usr/libdata ./usr/include ./usr/share/keys ./etc ./bin/freebsd-version
   317|     echo "ABI = \"FreeBSD:${__FreeBSDABI}:${__FreeBSDMachineArch}\"; FINGERPRINTS = \"${__RootfsDir}/usr/share/keys\"; REPOS_DIR = [\"${__RootfsDir}/etc/pkg\"]; REPO_AUTOUPDATE = NO; RUN_SCRIPTS = NO;" > "${__RootfsDir}"/usr/local/etc/pkg.conf
   318|     echo "FreeBSD: { url: \"pkg+http://pkg.FreeBSD.org/\${ABI}/quarterly\", mirror_type: \"srv\", signature_type: \"fingerprints\", fingerprints: \"${__RootfsDir}/usr/share/keys/pkg\", enabled: yes }" > "${__RootfsDir}"/etc/pkg/FreeBSD.conf
   319|     mkdir -p "$__RootfsDir"/tmp
   320|     wget -O - "https://github.com/freebsd/pkg/archive/${__FreeBSDPkg}.tar.gz" | tar -C "$__RootfsDir"/tmp -zxf -
   321|     cd "$__RootfsDir/tmp/pkg-${__FreeBSDPkg}"
   322|     mkdir -p "$__RootfsDir"/host/etc
   323|     ./autogen.sh && ./configure --prefix="$__RootfsDir"/host && make -j "$JOBS" && make install
   324|     rm -rf "$__RootfsDir/tmp/pkg-${__FreeBSDPkg}"
   325|     INSTALL_AS_USER=$(whoami) "$__RootfsDir"/host/sbin/pkg -r "$__RootfsDir" -C "$__RootfsDir"/usr/local/etc/pkg.conf update
   326|     INSTALL_AS_USER=$(whoami) "$__RootfsDir"/host/sbin/pkg -r "$__RootfsDir" -C "$__RootfsDir"/usr/local/etc/pkg.conf install --yes $__FreeBSDPackages
   327| elif [[ "$__CodeName" == "illumos" ]]; then
   328|     mkdir "$__RootfsDir/tmp"
   329|     pushd "$__RootfsDir/tmp"
   330|     JOBS=${MAXJOBS:="$(getconf _NPROCESSORS_ONLN)"}
   331|     echo "Downloading sysroot."
   332|     wget -O - https://github.com/illumos/sysroot/releases/download/20181213-de6af22ae73b-v1/illumos-sysroot-i386-20181213-de6af22ae73b-v1.tar.gz | tar -C "$__RootfsDir" -xzf -
   333|     echo "Building binutils. Please wait.."
   334|     wget -O - https://ftp.gnu.org/gnu/binutils/binutils-2.33.1.tar.bz2 | tar -xjf -
   335|     mkdir build-binutils && cd build-binutils
   336|     ../binutils-2.33.1/configure --prefix="$__RootfsDir" --target="${__illumosArch}-sun-solaris2.10" --program-prefix="${__illumosArch}-illumos-" --with-sysroot="$__RootfsDir"
   337|     make -j "$JOBS" && make install && cd ..
   338|     echo "Building gcc. Please wait.."
   339|     wget -O - https://ftp.gnu.org/gnu/gcc/gcc-8.4.0/gcc-8.4.0.tar.xz | tar -xJf -
   340|     CFLAGS="-fPIC"
   341|     CXXFLAGS="-fPIC"
   342|     CXXFLAGS_FOR_TARGET="-fPIC"
   343|     CFLAGS_FOR_TARGET="-fPIC"
   344|     export CFLAGS CXXFLAGS CXXFLAGS_FOR_TARGET CFLAGS_FOR_TARGET
   345|     mkdir build-gcc && cd build-gcc
   346|     ../gcc-8.4.0/configure --prefix="$__RootfsDir" --target="${__illumosArch}-sun-solaris2.10" --program-prefix="${__illumosArch}-illumos-" --with-sysroot="$__RootfsDir" --with-gnu-as       \
   347|         --with-gnu-ld --disable-nls --disable-libgomp --disable-libquadmath --disable-libssp --disable-libvtv --disable-libcilkrts --disable-libada --disable-libsanitizer \
   348|         --disable-libquadmath-support --disable-shared --enable-tls
   349|     make -j "$JOBS" && make install && cd ..
   350|     BaseUrl=https://pkgsrc.joyent.com
   351|     if [[ "$__UseMirror" == 1 ]]; then
   352|         BaseUrl=http://pkgsrc.smartos.skylime.net
   353|     fi
   354|     BaseUrl="$BaseUrl/packages/SmartOS/trunk/${__illumosArch}/All"
   355|     echo "Downloading manifest"
   356|     wget "$BaseUrl"
   357|     echo "Downloading dependencies."
   358|     read -ra array <<<"$__IllumosPackages"
   359|     for package in "${array[@]}"; do
   360|         echo "Installing '$package'"
   361|         package="$(grep ">$package-[0-9]" All | sed -En 's/.*href="(.*)\.tgz".*/\1/p')"
   362|         echo "Resolved name '$package'"
   363|         wget "$BaseUrl"/"$package".tgz
   364|         ar -x "$package".tgz
   365|         tar --skip-old-files -xzf "$package".tmp.tg* -C "$__RootfsDir" 2>/dev/null
   366|     done
   367|     echo "Cleaning up temporary files."
   368|     popd
   369|     rm -rf "$__RootfsDir"/{tmp,+*}
   370|     mkdir -p "$__RootfsDir"/usr/include/net
   371|     mkdir -p "$__RootfsDir"/usr/include/netpacket
   372|     wget -P "$__RootfsDir"/usr/include/net https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/io/bpf/net/bpf.h
   373|     wget -P "$__RootfsDir"/usr/include/net https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/io/bpf/net/dlt.h
   374|     wget -P "$__RootfsDir"/usr/include/netpacket https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/inet/sockmods/netpacket/packet.h
   375|     wget -P "$__RootfsDir"/usr/include/sys https://raw.githubusercontent.com/illumos/illumos-gate/master/usr/src/uts/common/sys/sdt.h
   376| elif [[ "$__CodeName" == "haiku" ]]; then
   377|     JOBS=${MAXJOBS:="$(getconf _NPROCESSORS_ONLN)"}
   378|     echo "Building Haiku sysroot for x86_64"
   379|     mkdir -p "$__RootfsDir/tmp"
   380|     cd "$__RootfsDir/tmp"
   381|     git clone -b hrev56235  https://review.haiku-os.org/haiku
   382|     git clone -b btrev43195 https://review.haiku-os.org/buildtools
   383|     cd "$__RootfsDir/tmp/buildtools" && git checkout 7487388f5110021d400b9f3b88e1a7f310dc066d
   384|     cd "$__RootfsDir/tmp/haiku"
   385|     git fetch origin refs/changes/64/4164/1 && git -c commit.gpgsign=false cherry-pick FETCH_HEAD
   386|     cd "$__RootfsDir/tmp/buildtools/jam"
   387|     make
   388|     echo "Building cross-compiler"
   389|     mkdir -p "$__RootfsDir/generated"
   390|     cd "$__RootfsDir/generated"
   391|     "$__RootfsDir/tmp/haiku/configure" -j"$JOBS" --sysroot "$__RootfsDir" --cross-tools-source "$__RootfsDir/tmp/buildtools" --build-cross-tools x86_64
   392|     echo "Building Haiku"
   393|     echo 'HAIKU_BUILD_PROFILE = "development-raw" ;' > UserProfileConfig
   394|     "$__RootfsDir/tmp/buildtools/jam/jam0" -j"$JOBS" -q '<build>package' '<repository>Haiku'
   395|     BaseUrl="https://depot.haiku-os.org/__api/v2/pkg/get-pkg"
   396|     echo "Downloading additional required packages"
   397|     read -ra array <<<"$__HaikuPackages"
   398|     for package in "${array[@]}"; do
   399|         echo "Downloading $package..."
   400|         hpkgDownloadUrl="$(wget -qO- --post-data='{"name":"'"$package"'","repositorySourceCode":"haikuports_x86_64","versionType":"LATEST","naturalLanguageCode":"en"}' \
   401|             --header='Content-Type:application/json' "$BaseUrl" | jq -r '.result.versions[].hpkgDownloadURL')"
   402|         wget -P "$__RootfsDir/generated/download" "$hpkgDownloadUrl"
   403|     done
   404|     echo "Setting up sysroot and extracting needed packages"
   405|     mkdir -p "$__RootfsDir/boot/system"
   406|     for file in "$__RootfsDir/generated/objects/haiku/x86_64/packaging/packages/"*.hpkg; do
   407|         "$__RootfsDir/generated/objects/linux/x86_64/release/tools/package/package" extract -C "$__RootfsDir/boot/system" "$file"
   408|     done
   409|     for file in "$__RootfsDir/generated/download/"*.hpkg; do
   410|         "$__RootfsDir/generated/objects/linux/x86_64/release/tools/package/package" extract -C "$__RootfsDir/boot/system" "$file"
   411|     done
   412|     echo "Cleaning up temporary files"
   413|     rm -rf "$__RootfsDir/tmp"
   414|     for name in "$__RootfsDir/generated/"*; do
   415|         if [[ "$name" =~ "cross-tools-" ]]; then
   416|             : # Keep the cross-compiler
   417|         else
   418|             rm -rf "$name"
   419|         fi
   420|     done
   421| elif [[ -n "$__CodeName" ]]; then
   422|     qemu-debootstrap $__Keyring --arch "$__UbuntuArch" "$__CodeName" "$__RootfsDir" "$__UbuntuRepo"
   423|     cp "$__CrossDir/$__BuildArch/sources.list.$__CodeName" "$__RootfsDir/etc/apt/sources.list"
   424|     chroot "$__RootfsDir" apt-get update
   425|     chroot "$__RootfsDir" apt-get -f -y install
   426|     chroot "$__RootfsDir" apt-get -y install $__UbuntuPackages
   427|     chroot "$__RootfsDir" symlinks -cr /usr
   428|     chroot "$__RootfsDir" apt-get clean
   429|     if [[ "$__SkipUnmount" == "0" ]]; then
   430|         umount "$__RootfsDir"/* || true
   431|     fi
   432|     if [[ "$__BuildArch" == "armel" && "$__CodeName" == "jessie" ]]; then
   433|         pushd "$__RootfsDir"
   434|         patch -p1 < "$__CrossDir/$__BuildArch/armel.jessie.patch"
   435|         popd
   436|     fi
   437| elif [[ "$__Tizen" == "tizen" ]]; then
   438|     ROOTFS_DIR="$__RootfsDir" "$__CrossDir/$__BuildArch/tizen-build-rootfs.sh"
   439| else
   440|     echo "Unsupported target platform."
   441|     usage;
   442|     exit 1
   443| fi


# ====================================================================
# FILE: eng/common/cross/x86/tizen-build-rootfs.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-24 ---
     1| set -e
     2| __X86_CrossDir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
     3| __TIZEN_CROSSDIR="$__X86_CrossDir/tizen"
     4| if [[ -z "$ROOTFS_DIR" ]]; then
     5|     echo "ROOTFS_DIR is not defined."
     6|     exit 1;
     7| fi
     8| TIZEN_TMP_DIR=$ROOTFS_DIR/tizen_tmp
     9| mkdir -p $TIZEN_TMP_DIR
    10| echo ">>Start downloading files"
    11| VERBOSE=1 $__X86_CrossDir/tizen-fetch.sh $TIZEN_TMP_DIR
    12| echo "<<Finish downloading files"
    13| echo ">>Start constructing Tizen rootfs"
    14| TIZEN_RPM_FILES=`ls $TIZEN_TMP_DIR/*.rpm`
    15| cd $ROOTFS_DIR
    16| for f in $TIZEN_RPM_FILES; do
    17|     rpm2cpio $f  | cpio -idm --quiet
    18| done
    19| echo "<<Finish constructing Tizen rootfs"
    20| rm -rf $TIZEN_TMP_DIR
    21| echo ">>Start configuring Tizen rootfs"
    22| ln -sfn asm-x86 ./usr/include/asm
    23| patch -p1 < $__TIZEN_CROSSDIR/tizen.patch
    24| echo "<<Finish configuring Tizen rootfs"


# ====================================================================
# FILE: eng/common/cross/x86/tizen-fetch.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-134 ---
     1| set -e
     2| if [[ -z "${VERBOSE// }" ]] || [ "$VERBOSE" -ne "$VERBOSE" ] 2>/dev/null; then
     3| 	VERBOSE=0
     4| fi
     5| Log()
     6| {
     7| 	if [ $VERBOSE -ge $1 ]; then
     8| 		echo ${@:2}
     9| 	fi
    10| }
    11| Inform()
    12| {
    13| 	Log 1 -e "\x1B[0;34m$@\x1B[m"
    14| }
    15| Debug()
    16| {
    17| 	Log 2 -e "\x1B[0;32m$@\x1B[m"
    18| }
    19| Error()
    20| {
    21| 	>&2 Log 0 -e "\x1B[0;31m$@\x1B[m"
    22| }
    23| Fetch()
    24| {
    25| 	URL=$1
    26| 	FILE=$2
    27| 	PROGRESS=$3
    28| 	if [ $VERBOSE -ge 1 ] && [ $PROGRESS ]; then
    29| 		CURL_OPT="--progress-bar"
    30| 	else
    31| 		CURL_OPT="--silent"
    32| 	fi
    33| 	curl $CURL_OPT $URL > $FILE
    34| }
    35| hash curl 2> /dev/null || { Error "Require 'curl' Aborting."; exit 1; }
    36| hash xmllint 2> /dev/null || { Error "Require 'xmllint' Aborting."; exit 1; }
    37| hash sha256sum 2> /dev/null || { Error "Require 'sha256sum' Aborting."; exit 1; }
    38| TMPDIR=$1
    39| if [ ! -d $TMPDIR ]; then
    40| 	TMPDIR=./tizen_tmp
    41| 	Debug "Create temporary directory : $TMPDIR"
    42| 	mkdir -p $TMPDIR 
    43| fi
    44| TIZEN_URL=http://download.tizen.org/snapshots/tizen
    45| BUILD_XML=build.xml
    46| REPOMD_XML=repomd.xml
    47| PRIMARY_XML=primary.xml
    48| TARGET_URL="http://__not_initialized"
    49| Xpath_get()
    50| {
    51| 	XPATH_RESULT=''
    52| 	XPATH=$1
    53| 	XML_FILE=$2
    54| 	RESULT=$(xmllint --xpath $XPATH $XML_FILE)
    55| 	if [[ -z ${RESULT// } ]]; then
    56| 		Error "Can not find target from $XML_FILE"
    57| 		Debug "Xpath = $XPATH"
    58| 		exit 1
    59| 	fi
    60| 	XPATH_RESULT=$RESULT
    61| }
    62| fetch_tizen_pkgs_init()
    63| {
    64| 	TARGET=$1
    65| 	PROFILE=$2
    66| 	Debug "Initialize TARGET=$TARGET, PROFILE=$PROFILE"
    67| 	TMP_PKG_DIR=$TMPDIR/tizen_${PROFILE}_pkgs
    68| 	if [ -d $TMP_PKG_DIR ]; then rm -rf $TMP_PKG_DIR; fi
    69| 	mkdir -p $TMP_PKG_DIR
    70| 	PKG_URL=$TIZEN_URL/$PROFILE/latest
    71| 	BUILD_XML_URL=$PKG_URL/$BUILD_XML
    72| 	TMP_BUILD=$TMP_PKG_DIR/$BUILD_XML
    73| 	TMP_REPOMD=$TMP_PKG_DIR/$REPOMD_XML
    74| 	TMP_PRIMARY=$TMP_PKG_DIR/$PRIMARY_XML
    75| 	TMP_PRIMARYGZ=${TMP_PRIMARY}.gz
    76| 	Fetch $BUILD_XML_URL $TMP_BUILD
    77| 	Debug "fetch $BUILD_XML_URL to $TMP_BUILD"
    78| 	TARGET_XPATH="//build/buildtargets/buildtarget[@name=\"$TARGET\"]/repo[@type=\"binary\"]/text()"
    79| 	Xpath_get $TARGET_XPATH $TMP_BUILD
    80| 	TARGET_PATH=$XPATH_RESULT
    81| 	TARGET_URL=$PKG_URL/$TARGET_PATH
    82| 	REPOMD_URL=$TARGET_URL/repodata/repomd.xml
    83| 	PRIMARY_XPATH='string(//*[local-name()="data"][@type="primary"]/*[local-name()="location"]/@href)'
    84| 	Fetch $REPOMD_URL $TMP_REPOMD
    85| 	Debug "fetch $REPOMD_URL to $TMP_REPOMD"
    86| 	Xpath_get $PRIMARY_XPATH $TMP_REPOMD
    87| 	PRIMARY_XML_PATH=$XPATH_RESULT
    88| 	PRIMARY_URL=$TARGET_URL/$PRIMARY_XML_PATH
    89| 	Fetch $PRIMARY_URL $TMP_PRIMARYGZ
    90| 	Debug "fetch $PRIMARY_URL to $TMP_PRIMARYGZ"
    91| 	gunzip $TMP_PRIMARYGZ 
    92| 	Debug "unzip $TMP_PRIMARYGZ to $TMP_PRIMARY" 
    93| }
    94| fetch_tizen_pkgs()
    95| {
    96| 	ARCH=$1
    97| 	PACKAGE_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="location"]/@href)'
    98| 	PACKAGE_CHECKSUM_XPATH_TPL='string(//*[local-name()="metadata"]/*[local-name()="package"][*[local-name()="name"][text()="_PKG_"]][*[local-name()="arch"][text()="_ARCH_"]]/*[local-name()="checksum"]/text())'
    99| 	for pkg in ${@:2}
   100| 	do
   101| 		Inform "Fetching... $pkg"
   102| 		XPATH=${PACKAGE_XPATH_TPL/_PKG_/$pkg}
   103| 		XPATH=${XPATH/_ARCH_/$ARCH}
   104| 		Xpath_get $XPATH $TMP_PRIMARY
   105| 		PKG_PATH=$XPATH_RESULT
   106| 		XPATH=${PACKAGE_CHECKSUM_XPATH_TPL/_PKG_/$pkg}
   107| 		XPATH=${XPATH/_ARCH_/$ARCH}
   108| 		Xpath_get $XPATH $TMP_PRIMARY
   109| 		CHECKSUM=$XPATH_RESULT
   110| 		PKG_URL=$TARGET_URL/$PKG_PATH
   111| 		PKG_FILE=$(basename $PKG_PATH)
   112| 		PKG_PATH=$TMPDIR/$PKG_FILE
   113| 		Debug "Download $PKG_URL to $PKG_PATH"
   114| 		Fetch $PKG_URL $PKG_PATH true
   115| 		echo "$CHECKSUM $PKG_PATH" | sha256sum -c - > /dev/null
   116| 		if [ $? -ne 0 ]; then
   117| 			Error "Fail to fetch $PKG_URL to $PKG_PATH"
   118| 			Debug "Checksum = $CHECKSUM"
   119| 			exit 1
   120| 		fi
   121| 	done
   122| }
   123| Inform "Initialize i686 base"
   124| fetch_tizen_pkgs_init standard base
   125| Inform "fetch common packages"
   126| fetch_tizen_pkgs i686 gcc gcc-devel-static glibc glibc-devel libicu libicu-devel libatomic linux-glibc-devel keyutils keyutils-devel libkeyutils
   127| Inform "fetch coreclr packages"
   128| fetch_tizen_pkgs i686 lldb lldb-devel libgcc libstdc++ libstdc++-devel libunwind libunwind-devel lttng-ust-devel lttng-ust userspace-rcu-devel userspace-rcu
   129| Inform "fetch corefx packages"
   130| fetch_tizen_pkgs i686 libcom_err libcom_err-devel zlib zlib-devel libopenssl11 libopenssl1.1-devel krb5 krb5-devel
   131| Inform "Initialize standard unified"
   132| fetch_tizen_pkgs_init standard unified
   133| Inform "fetch corefx packages"
   134| fetch_tizen_pkgs i686 gssdp gssdp-devel tizen-release


# ====================================================================
# FILE: eng/common/darc-init.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| source="${BASH_SOURCE[0]}"
     2| darcVersion=''
     3| versionEndpoint='https://maestro-prod.westus2.cloudapp.azure.com/api/assets/darc-version?api-version=2019-01-16'
     4| verbosity='minimal'
     5| while [[ $# > 0 ]]; do
     6|   opt="$(echo "$1" | tr "[:upper:]" "[:lower:]")"
     7|   case "$opt" in
     8|     --darcversion)
     9|       darcVersion=$2
    10|       shift
    11|       ;;
    12|     --versionendpoint)
    13|       versionEndpoint=$2
    14|       shift
    15|       ;;
    16|     --verbosity)
    17|       verbosity=$2
    18|       shift
    19|       ;;
    20|     --toolpath)
    21|       toolpath=$2
    22|       shift
    23|       ;;
    24|     *)
    25|       echo "Invalid argument: $1"
    26|       usage
    27|       exit 1
    28|       ;;
    29|   esac
    30|   shift
    31| done
    32| while [[ -h "$source" ]]; do
    33|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    34|   source="$(readlink "$source")"
    35|   [[ $source != /* ]] && source="$scriptroot/$source"
    36| done
    37| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    38| . "$scriptroot/tools.sh"
    39| if [ -z "$darcVersion" ]; then
    40|   darcVersion=$(curl -X GET "$versionEndpoint" -H "accept: text/plain")
    41| fi
    42| function InstallDarcCli {
    43|   local darc_cli_package_name="microsoft.dotnet.darc"
    44|   InitializeDotNetCli true
    45|   local dotnet_root=$_InitializeDotNetCli
    46|   if [ -z "$toolpath" ]; then
    47|     local tool_list=$($dotnet_root/dotnet tool list -g)
    48|     if [[ $tool_list = *$darc_cli_package_name* ]]; then
    49|       echo $($dotnet_root/dotnet tool uninstall $darc_cli_package_name -g)
    50|     fi
    51|   else
    52|     local tool_list=$($dotnet_root/dotnet tool list --tool-path "$toolpath")
    53|     if [[ $tool_list = *$darc_cli_package_name* ]]; then
    54|       echo $($dotnet_root/dotnet tool uninstall $darc_cli_package_name --tool-path "$toolpath")
    55|     fi
    56|   fi
    57|   local arcadeServicesSource="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-tools/nuget/v3/index.json"
    58|   echo "Installing Darc CLI version $darcVersion..."
    59|   echo "You may need to restart your command shell if this is the first dotnet tool you have installed."
    60|   if [ -z "$toolpath" ]; then
    61|     echo $($dotnet_root/dotnet tool install $darc_cli_package_name --version $darcVersion --add-source "$arcadeServicesSource" -v $verbosity -g)
    62|   else
    63|     echo $($dotnet_root/dotnet tool install $darc_cli_package_name --version $darcVersion --add-source "$arcadeServicesSource" -v $verbosity --tool-path "$toolpath")
    64|   fi
    65| }
    66| InstallDarcCli


# ====================================================================
# FILE: eng/common/dotnet-install.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-75 ---
     1| source="${BASH_SOURCE[0]}"
     2| while [[ -h "$source" ]]; do
     3|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     4|   source="$(readlink "$source")"
     5|   [[ $source != /* ]] && source="$scriptroot/$source"
     6| done
     7| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     8| . "$scriptroot/tools.sh"
     9| version='Latest'
    10| architecture=''
    11| runtime='dotnet'
    12| runtimeSourceFeed=''
    13| runtimeSourceFeedKey=''
    14| while [[ $# > 0 ]]; do
    15|   opt="$(echo "$1" | tr "[:upper:]" "[:lower:]")"
    16|   case "$opt" in
    17|     -version|-v)
    18|       shift
    19|       version="$1"
    20|       ;;
    21|     -architecture|-a)
    22|       shift
    23|       architecture="$1"
    24|       ;;
    25|     -runtime|-r)
    26|       shift
    27|       runtime="$1"
    28|       ;;
    29|     -runtimesourcefeed)
    30|       shift
    31|       runtimeSourceFeed="$1"
    32|       ;;
    33|     -runtimesourcefeedkey)
    34|       shift
    35|       runtimeSourceFeedKey="$1"
    36|       ;;
    37|     *)
    38|       Write-PipelineTelemetryError -Category 'Build' -Message "Invalid argument: $1"
    39|       exit 1
    40|       ;;
    41|   esac
    42|   shift
    43| done
    44| cpuname=$(uname -m)
    45| case $cpuname in
    46|   arm64|aarch64)
    47|     buildarch=arm64
    48|     ;;
    49|   loongarch64)
    50|     buildarch=loongarch64
    51|     ;;
    52|   amd64|x86_64)
    53|     buildarch=x64
    54|     ;;
    55|   armv*l)
    56|     buildarch=arm
    57|     ;;
    58|   i[3-6]86)
    59|     buildarch=x86
    60|     ;;
    61|   *)
    62|     echo "Unknown CPU $cpuname detected, treating it as x64"
    63|     buildarch=x64
    64|     ;;
    65| esac
    66| dotnetRoot="${repo_root}.dotnet"
    67| if [[ $architecture != "" ]] && [[ $architecture != $buildarch ]]; then
    68|   dotnetRoot="$dotnetRoot/$architecture"
    69| fi
    70| InstallDotNet $dotnetRoot $version "$architecture" $runtime true $runtimeSourceFeed $runtimeSourceFeedKey || {
    71|   local exit_code=$?
    72|   Write-PipelineTelemetryError -Category 'InitializeToolset' -Message "dotnet-install.sh failed (exit code '$exit_code')." >&2
    73|   ExitWithExitCode $exit_code
    74| }
    75| ExitWithExitCode 0


# ====================================================================
# FILE: eng/common/generate-sbom-prep.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-22 ---
     1| source="${BASH_SOURCE[0]}"
     2| while [[ -h $source ]]; do
     3|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     4|   source="$(readlink "$source")"
     5|   [[ $source != /* ]] && source="$scriptroot/$source"
     6| done
     7| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     8| . $scriptroot/pipeline-logging-functions.sh
     9| manifest_dir=$1
    10| if [ ! -d "$manifest_dir" ] ; then
    11|   mkdir -p "$manifest_dir"
    12|   echo "Sbom directory created." $manifest_dir
    13| else
    14|   Write-PipelineTelemetryError -category 'Build'  "Unable to create sbom folder."
    15| fi
    16| artifact_name=$SYSTEM_STAGENAME"_"$AGENT_JOBNAME"_SBOM"
    17| echo "Artifact name before : "$artifact_name
    18| safe_artifact_name="${artifact_name//["/:<>\\|?@*$" ]/_}"
    19| echo "Artifact name after : "$safe_artifact_name
    20| export ARTIFACT_NAME=$safe_artifact_name
    21| echo "##vso[task.setvariable variable=ARTIFACT_NAME]$safe_artifact_name"
    22| exit 0


# ====================================================================
# FILE: eng/common/init-tools-native.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-192 ---
     1| source="${BASH_SOURCE[0]}"
     2| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     3| base_uri='https://netcorenativeassets.blob.core.windows.net/resource-packages/external'
     4| install_directory=''
     5| clean=false
     6| force=false
     7| download_retries=5
     8| retry_wait_time_seconds=30
     9| global_json_file="$(dirname "$(dirname "${scriptroot}")")/global.json"
    10| declare -a native_assets
    11| . $scriptroot/pipeline-logging-functions.sh
    12| . $scriptroot/native/common-library.sh
    13| while (($# > 0)); do
    14|   lowerI="$(echo $1 | tr "[:upper:]" "[:lower:]")"
    15|   case $lowerI in
    16|     --baseuri)
    17|       base_uri=$2
    18|       shift 2
    19|       ;;
    20|     --installdirectory)
    21|       install_directory=$2
    22|       shift 2
    23|       ;;
    24|     --clean)
    25|       clean=true
    26|       shift 1
    27|       ;;
    28|     --force)
    29|       force=true
    30|       shift 1
    31|       ;;
    32|     --donotabortonfailure)
    33|       donotabortonfailure=true
    34|       shift 1
    35|       ;;
    36|     --donotdisplaywarnings)
    37|       donotdisplaywarnings=true
    38|       shift 1
    39|       ;;
    40|     --downloadretries)
    41|       download_retries=$2
    42|       shift 2
    43|       ;;
    44|     --retrywaittimeseconds)
    45|       retry_wait_time_seconds=$2
    46|       shift 2
    47|       ;;
    48|     --help)
    49|       echo "Common settings:"
    50|       echo "  --installdirectory                  Directory to install native toolset."
    51|       echo "                                      This is a command-line override for the default"
    52|       echo "                                      Install directory precedence order:"
    53|       echo "                                          - InstallDirectory command-line override"
    54|       echo "                                          - NETCOREENG_INSTALL_DIRECTORY environment variable"
    55|       echo "                                          - (default) %USERPROFILE%/.netcoreeng/native"
    56|       echo ""
    57|       echo "  --clean                             Switch specifying not to install anything, but cleanup native asset folders"
    58|       echo "  --donotabortonfailure               Switch specifiying whether to abort native tools installation on failure"
    59|       echo "  --donotdisplaywarnings              Switch specifiying whether to display warnings during native tools installation on failure"
    60|       echo "  --force                             Clean and then install tools"
    61|       echo "  --help                              Print help and exit"
    62|       echo ""
    63|       echo "Advanced settings:"
    64|       echo "  --baseuri <value>                   Base URI for where to download native tools from"
    65|       echo "  --downloadretries <value>           Number of times a download should be attempted"
    66|       echo "  --retrywaittimeseconds <value>      Wait time between download attempts"
    67|       echo ""
    68|       exit 0
    69|       ;;
    70|   esac
    71| done
    72| function ReadGlobalJsonNativeTools {
    73|   if command -v jq &> /dev/null; then
    74|     while IFS= read -rd '' line; do
    75|       native_assets+=("$line")
    76|     done < <(jq -r '. |
    77|         select(has("native-tools")) |
    78|         ."native-tools" |
    79|         keys[] as $k |
    80|         @sh "KEY=\($k) VALUE=\(.[$k])\u0000"' "$global_json_file")
    81|     return
    82|   fi
    83|   if [[ ! "$(cat "$global_json_file")" =~ \"native-tools\"[[:space:]\:\{]*([^\}]+) ]]; then
    84|     return
    85|   fi
    86|   section="${BASH_REMATCH[1]}"
    87|   parseStarted=0
    88|   possibleEnd=0
    89|   escaping=0
    90|   escaped=0
    91|   isKey=1
    92|   for (( i=0; i<${#section}; i++ )); do
    93|     char="${section:$i:1}"
    94|     if ! ((parseStarted)) && [[ "$char" =~ [[:space:],:] ]]; then continue; fi
    95|     if ! ((escaping)) && [[ "$char" == "\\" ]]; then
    96|       escaping=1
    97|     elif ((escaping)) && ! ((escaped)); then
    98|       escaped=1
    99|     fi
   100|     if ! ((parseStarted)) && [[ "$char" == "\"" ]]; then
   101|       parseStarted=1
   102|       possibleEnd=0
   103|     elif [[ "$char" == "'" ]]; then
   104|       token="$token'\\\''"
   105|       possibleEnd=0
   106|     elif ((escaping)) || [[ "$char" != "\"" ]]; then
   107|       token="$token$char"
   108|       possibleEnd=1
   109|     fi
   110|     if ((possibleEnd)) && ! ((escaping)) && [[ "$char" == "\"" ]]; then
   111|       printf -v token "'$token'"
   112|       if ((isKey)); then
   113|         KEY="$token"
   114|         isKey=0
   115|       else
   116|         line="KEY=$KEY VALUE=$token"
   117|         native_assets+=("$line")
   118|         isKey=1
   119|       fi
   120|       parseStarted=0
   121|       token=
   122|     elif ((escaping)) && ((escaped)); then
   123|       escaping=0
   124|       escaped=0
   125|     fi
   126|   done
   127| }
   128| native_base_dir=$install_directory
   129| if [[ -z $install_directory ]]; then
   130|   native_base_dir=$(GetNativeInstallDirectory)
   131| fi
   132| install_bin="${native_base_dir}/bin"
   133| installed_any=false
   134| ReadGlobalJsonNativeTools
   135| if [[ ${#native_assets[@]} -eq 0 ]]; then
   136|   echo "No native tools defined in global.json"
   137|   exit 0;
   138| else
   139|   native_installer_dir="$scriptroot/native"
   140|   for index in "${!native_assets[@]}"; do
   141|     eval "${native_assets["$index"]}"
   142|     installer_path="$native_installer_dir/install-$KEY.sh"
   143|     installer_command="$installer_path"
   144|     installer_command+=" --baseuri $base_uri"
   145|     installer_command+=" --installpath $install_bin"
   146|     installer_command+=" --version $VALUE"
   147|     echo $installer_command
   148|     if [[ $force = true ]]; then
   149|       installer_command+=" --force"
   150|     fi
   151|     if [[ $clean = true ]]; then
   152|       installer_command+=" --clean"
   153|     fi
   154|     if [[ -a $installer_path ]]; then
   155|       $installer_command
   156|       if [[ $? != 0 ]]; then
   157|         if [[ $donotabortonfailure = true ]]; then
   158|           if [[ $donotdisplaywarnings != true ]]; then
   159|             Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed"
   160|           fi
   161|         else
   162|           Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed"
   163|           exit 1
   164|         fi
   165|       else
   166|         $installed_any = true
   167|       fi
   168|     else
   169|       if [[ $donotabortonfailure == true ]]; then
   170|         if [[ $donotdisplaywarnings != true ]]; then
   171|           Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed: no install script"
   172|         fi
   173|       else
   174|         Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Execution Failed: no install script"
   175|         exit 1
   176|       fi
   177|     fi
   178|   done
   179| fi
   180| if [[ $clean = true ]]; then
   181|   exit 0
   182| fi
   183| if [[ -d $install_bin ]]; then
   184|   echo "Native tools are available from $install_bin"
   185|   echo "##vso[task.prependpath]$install_bin"
   186| else
   187|   if [[ $installed_any = true ]]; then
   188|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Native tools install directory does not exist, installation failed"
   189|     exit 1
   190|   fi
   191| fi
   192| exit 0


# ====================================================================
# FILE: eng/common/native/common-library.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-132 ---
     1| function GetNativeInstallDirectory {
     2|   local install_dir
     3|   if [[ -z $NETCOREENG_INSTALL_DIRECTORY ]]; then
     4|     install_dir=$HOME/.netcoreeng/native/
     5|   else
     6|     install_dir=$NETCOREENG_INSTALL_DIRECTORY
     7|   fi
     8|   echo $install_dir
     9|   return 0
    10| }
    11| function GetTempDirectory {
    12|   echo $(GetNativeInstallDirectory)temp/
    13|   return 0
    14| }
    15| function ExpandZip {
    16|   local zip_path=$1
    17|   local output_directory=$2
    18|   local force=${3:-false}
    19|   echo "Extracting $zip_path to $output_directory"
    20|   if [[ -d $output_directory ]] && [[ $force = false ]]; then
    21|     echo "Directory '$output_directory' already exists, skipping extract"
    22|     return 0
    23|   fi
    24|   if [[ -d $output_directory ]]; then
    25|     echo "'Force flag enabled, but '$output_directory' exists. Removing directory"
    26|     rm -rf $output_directory
    27|     if [[ $? != 0 ]]; then
    28|       Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Unable to remove '$output_directory'"
    29|       return 1
    30|     fi
    31|   fi
    32|   echo "Creating directory: '$output_directory'"
    33|   mkdir -p $output_directory
    34|   echo "Extracting archive"
    35|   tar -xf $zip_path -C $output_directory
    36|   if [[ $? != 0 ]]; then
    37|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Unable to extract '$zip_path'"
    38|     return 1
    39|   fi
    40|   return 0
    41| }
    42| function GetCurrentOS {
    43|   local unameOut="$(uname -s)"
    44|   case $unameOut in
    45|     Linux*)     echo "Linux";;
    46|     Darwin*)    echo "MacOS";;
    47|   esac
    48|   return 0
    49| }
    50| function GetFile {
    51|   local uri=$1
    52|   local path=$2
    53|   local force=${3:-false}
    54|   local download_retries=${4:-5}
    55|   local retry_wait_time_seconds=${5:-30}
    56|   if [[ -f $path ]]; then
    57|     if [[ $force = false ]]; then
    58|       echo "File '$path' already exists. Skipping download"
    59|       return 0
    60|     else
    61|       rm -rf $path
    62|     fi
    63|   fi
    64|   if [[ -f $uri ]]; then
    65|     echo "'$uri' is a file path, copying file to '$path'"
    66|     cp $uri $path
    67|     return $?
    68|   fi
    69|   echo "Downloading $uri"
    70|   if command -v curl > /dev/null; then
    71|     curl "$uri" -sSL --retry $download_retries --retry-delay $retry_wait_time_seconds --create-dirs -o "$path" --fail
    72|   else
    73|     wget -q -O "$path" "$uri" --tries="$download_retries"
    74|   fi
    75|   return $?
    76| }
    77| function GetTempPathFileName {
    78|   local path=$1
    79|   local temp_dir=$(GetTempDirectory)
    80|   local temp_file_name=$(basename $path)
    81|   echo $temp_dir$temp_file_name
    82|   return 0
    83| }
    84| function DownloadAndExtract {
    85|   local uri=$1
    86|   local installDir=$2
    87|   local force=${3:-false}
    88|   local download_retries=${4:-5}
    89|   local retry_wait_time_seconds=${5:-30}
    90|   local temp_tool_path=$(GetTempPathFileName $uri)
    91|   echo "downloading to: $temp_tool_path"
    92|   GetFile "$uri" "$temp_tool_path" $force $download_retries $retry_wait_time_seconds
    93|   if [[ $? != 0 ]]; then
    94|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Failed to download '$uri' to '$temp_tool_path'."
    95|     return 1
    96|   fi
    97|   echo "extracting from  $temp_tool_path to $installDir"
    98|   ExpandZip "$temp_tool_path" "$installDir" $force $download_retries $retry_wait_time_seconds
    99|   if [[ $? != 0 ]]; then
   100|     Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Failed to extract '$temp_tool_path' to '$installDir'."
   101|     return 1
   102|   fi
   103|   return 0
   104| }
   105| function NewScriptShim {
   106|   local shimpath=$1
   107|   local tool_file_path=$2
   108|   local force=${3:-false}
   109|   echo "Generating '$shimpath' shim"
   110|   if [[ -f $shimpath ]]; then
   111|     if [[ $force = false ]]; then
   112|       echo "File '$shimpath' already exists." >&2
   113|       return 1
   114|     else
   115|       rm -rf $shimpath
   116|     fi
   117|   fi
   118|   if [[ ! -f $tool_file_path ]]; then
   119|     tool_file_path="$(echo $tool_file_path | tr "[:upper:]" "[:lower:]")" 
   120|     if [[ ! -f $tool_file_path ]]; then
   121|       Write-PipelineTelemetryError -category 'NativeToolsBootstrap' "Specified tool file path:'$tool_file_path' does not exist"
   122|       return 1
   123|     fi
   124|   fi
   125|   local shim_contents=$'#!/usr/bin/env bash\n'
   126|   shim_contents+="SHIMARGS="$'$1\n'
   127|   shim_contents+="$tool_file_path"$' $SHIMARGS\n'
   128|   echo "$shim_contents" > $shimpath
   129|   chmod +x $shimpath
   130|   echo "Finished generating shim '$shimpath'"
   131|   return $?
   132| }


# ====================================================================
# FILE: eng/common/native/init-compiler.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-112 ---
     1| if [[ "$#" -lt 3 ]]; then
     2|   echo "Usage..."
     3|   echo "init-compiler.sh <script directory> <Architecture> <compiler>"
     4|   echo "Specify the script directory."
     5|   echo "Specify the target architecture."
     6|   echo "Specify the name of compiler (clang or gcc)."
     7|   exit 1
     8| fi
     9| nativescriptroot="$1"
    10| build_arch="$2"
    11| compiler="$3"
    12| case "$compiler" in
    13|     clang*|-clang*|--clang*)
    14|         version="$(echo "$compiler" | tr -d '[:alpha:]-=')"
    15|         parts=(${version//./ })
    16|         majorVersion="${parts[0]}"
    17|         minorVersion="${parts[1]}"
    18|         if [[ -z "$minorVersion" && "$majorVersion" -le 6 ]]; then
    19|             minorVersion=0;
    20|         fi
    21|         compiler=clang
    22|         ;;
    23|     gcc*|-gcc*|--gcc*)
    24|         version="$(echo "$compiler" | tr -d '[:alpha:]-=')"
    25|         parts=(${version//./ })
    26|         majorVersion="${parts[0]}"
    27|         minorVersion="${parts[1]}"
    28|         compiler=gcc
    29|         ;;
    30| esac
    31| cxxCompiler="$compiler++"
    32| . "$nativescriptroot"/../pipeline-logging-functions.sh
    33| CC=
    34| CXX=
    35| LDFLAGS=
    36| if [[ "$compiler" == "gcc" ]]; then cxxCompiler="g++"; fi
    37| check_version_exists() {
    38|     desired_version=-1
    39|     if command -v "$compiler-$1.$2" > /dev/null; then
    40|         desired_version="-$1.$2"
    41|     elif command -v "$compiler$1$2" > /dev/null; then
    42|         desired_version="$1$2"
    43|     elif command -v "$compiler-$1$2" > /dev/null; then
    44|         desired_version="-$1$2"
    45|     fi
    46|     echo "$desired_version"
    47| }
    48| if [[ -z "$CLR_CC" ]]; then
    49|     if [[ -z "$majorVersion" ]]; then
    50|         if [[ "$compiler" == "clang" ]]; then versions=( 15 14 13 12 11 10 9 8 7 6.0 5.0 4.0 3.9 3.8 3.7 3.6 3.5 )
    51|         elif [[ "$compiler" == "gcc" ]]; then versions=( 12 11 10 9 8 7 6 5 4.9 ); fi
    52|         for version in "${versions[@]}"; do
    53|             parts=(${version//./ })
    54|             desired_version="$(check_version_exists "${parts[0]}" "${parts[1]}")"
    55|             if [[ "$desired_version" != "-1" ]]; then majorVersion="${parts[0]}"; break; fi
    56|         done
    57|         if [[ -z "$majorVersion" ]]; then
    58|             if command -v "$compiler" > /dev/null; then
    59|                 if [[ "$(uname)" != "Darwin" ]]; then
    60|                     Write-PipelineTelemetryError -category "Build" -type "warning" "Specific version of $compiler not found, falling back to use the one in PATH."
    61|                 fi
    62|                 CC="$(command -v "$compiler")"
    63|                 CXX="$(command -v "$cxxCompiler")"
    64|             else
    65|                 Write-PipelineTelemetryError -category "Build" "No usable version of $compiler found."
    66|                 exit 1
    67|             fi
    68|         else
    69|             if [[ "$compiler" == "clang" && "$majorVersion" -lt 5 ]]; then
    70|                 if [[ "$build_arch" == "arm" || "$build_arch" == "armel" ]]; then
    71|                     if command -v "$compiler" > /dev/null; then
    72|                         Write-PipelineTelemetryError -category "Build" -type "warning" "Found clang version $majorVersion which is not supported on arm/armel architectures, falling back to use clang from PATH."
    73|                         CC="$(command -v "$compiler")"
    74|                         CXX="$(command -v "$cxxCompiler")"
    75|                     else
    76|                         Write-PipelineTelemetryError -category "Build" "Found clang version $majorVersion which is not supported on arm/armel architectures, and there is no clang in PATH."
    77|                         exit 1
    78|                     fi
    79|                 fi
    80|             fi
    81|         fi
    82|     else
    83|         desired_version="$(check_version_exists "$majorVersion" "$minorVersion")"
    84|         if [[ "$desired_version" == "-1" ]]; then
    85|             Write-PipelineTelemetryError -category "Build" "Could not find specific version of $compiler: $majorVersion $minorVersion."
    86|             exit 1
    87|         fi
    88|     fi
    89|     if [[ -z "$CC" ]]; then
    90|         CC="$(command -v "$compiler$desired_version")"
    91|         CXX="$(command -v "$cxxCompiler$desired_version")"
    92|         if [[ -z "$CXX" ]]; then CXX="$(command -v "$cxxCompiler")"; fi
    93|     fi
    94| else
    95|     if [[ ! -f "$CLR_CC" ]]; then
    96|         Write-PipelineTelemetryError -category "Build" "CLR_CC is set but path '$CLR_CC' does not exist"
    97|         exit 1
    98|     fi
    99|     CC="$CLR_CC"
   100|     CXX="$CLR_CXX"
   101| fi
   102| if [[ -z "$CC" ]]; then
   103|     Write-PipelineTelemetryError -category "Build" "Unable to find $compiler."
   104|     exit 1
   105| fi
   106| if [[ "$compiler" == "clang" && "$majorVersion" -ge 9 ]]; then
   107|     if "$CC" -fuse-ld=lld -Wl,--version >/dev/null 2>&1; then
   108|         LDFLAGS="-fuse-ld=lld"
   109|     fi
   110| fi
   111| SCAN_BUILD_COMMAND="$(command -v "scan-build$desired_version")"
   112| export CC CXX LDFLAGS SCAN_BUILD_COMMAND


# ====================================================================
# FILE: eng/common/tools.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-390 ---
     1| ci=${ci:-false}
     2| if [[ "$ci" == true ]]; then
     3|   pipelines_log=${pipelines_log:-true}
     4| else
     5|   pipelines_log=${pipelines_log:-false}
     6| fi
     7| configuration=${configuration:-'Debug'}
     8| exclude_ci_binary_log=${exclude_ci_binary_log:-false}
     9| if [[ "$ci" == true && "$exclude_ci_binary_log" == false ]]; then
    10|   binary_log_default=true
    11| else
    12|   binary_log_default=false
    13| fi
    14| binary_log=${binary_log:-$binary_log_default}
    15| prepare_machine=${prepare_machine:-false}
    16| restore=${restore:-true}
    17| verbosity=${verbosity:-'minimal'}
    18| if [[ "$ci" == true ]]; then
    19|   node_reuse=${node_reuse:-false}
    20| else
    21|   node_reuse=${node_reuse:-true}
    22| fi
    23| warn_as_error=${warn_as_error:-true}
    24| use_installed_dotnet_cli=${use_installed_dotnet_cli:-true}
    25| dotnetInstallScriptVersion=${dotnetInstallScriptVersion:-'v1'}
    26| if [[ "$ci" == true ]]; then
    27|   use_global_nuget_cache=${use_global_nuget_cache:-false}
    28| else
    29|   use_global_nuget_cache=${use_global_nuget_cache:-true}
    30| fi
    31| runtime_source_feed=${runtime_source_feed:-''}
    32| runtime_source_feed_key=${runtime_source_feed_key:-''}
    33| function ResolvePath {
    34|   local path=$1
    35|   while [[ -h $path ]]; do
    36|     local dir="$( cd -P "$( dirname "$path" )" && pwd )"
    37|     path="$(readlink "$path")"
    38|     [[ $path != /* ]] && path="$dir/$path"
    39|   done
    40|   _ResolvePath="$path"
    41| }
    42| function ReadGlobalVersion {
    43|   local key=$1
    44|   if command -v jq &> /dev/null; then
    45|     _ReadGlobalVersion="$(jq -r ".[] | select(has(\"$key\")) | .\"$key\"" "$global_json_file")"
    46|   elif [[ "$(cat "$global_json_file")" =~ \"$key\"[[:space:]\:]*\"([^\"]+) ]]; then
    47|     _ReadGlobalVersion=${BASH_REMATCH[1]}
    48|   fi
    49|   if [[ -z "$_ReadGlobalVersion" ]]; then
    50|     Write-PipelineTelemetryError -category 'Build' "Error: Cannot find \"$key\" in $global_json_file"
    51|     ExitWithExitCode 1
    52|   fi
    53| }
    54| function InitializeDotNetCli {
    55|   if [[ -n "${_InitializeDotNetCli:-}" ]]; then
    56|     return
    57|   fi
    58|   local install=$1
    59|   export DOTNET_MULTILEVEL_LOOKUP=0
    60|   export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1
    61|   if [[ $ci == true ]]; then
    62|     export DOTNET_CLI_TELEMETRY_OPTOUT=1
    63|   fi
    64|   export LTTNG_HOME="$HOME"
    65|   if [[ -n "${DotNetCoreSdkDir:-}" ]]; then
    66|     export DOTNET_INSTALL_DIR="$DotNetCoreSdkDir"
    67|   fi
    68|   if [[ "$use_installed_dotnet_cli" == true && $global_json_has_runtimes == false && -z "${DOTNET_INSTALL_DIR:-}" ]]; then
    69|     local dotnet_path=`command -v dotnet`
    70|     if [[ -n "$dotnet_path" ]]; then
    71|       ResolvePath "$dotnet_path"
    72|       export DOTNET_INSTALL_DIR=`dirname "$_ResolvePath"`
    73|     fi
    74|   fi
    75|   ReadGlobalVersion "dotnet"
    76|   local dotnet_sdk_version=$_ReadGlobalVersion
    77|   local dotnet_root=""
    78|   if [[ $global_json_has_runtimes == false && -n "${DOTNET_INSTALL_DIR:-}" && -d "$DOTNET_INSTALL_DIR/sdk/$dotnet_sdk_version" ]]; then
    79|     dotnet_root="$DOTNET_INSTALL_DIR"
    80|   else
    81|     dotnet_root="$repo_root/.dotnet"
    82|     export DOTNET_INSTALL_DIR="$dotnet_root"
    83|     if [[ ! -d "$DOTNET_INSTALL_DIR/sdk/$dotnet_sdk_version" ]]; then
    84|       if [[ "$install" == true ]]; then
    85|         InstallDotNetSdk "$dotnet_root" "$dotnet_sdk_version"
    86|       else
    87|         Write-PipelineTelemetryError -category 'InitializeToolset' "Unable to find dotnet with SDK version '$dotnet_sdk_version'"
    88|         ExitWithExitCode 1
    89|       fi
    90|     fi
    91|   fi
    92|   Write-PipelinePrependPath -path "$dotnet_root"
    93|   Write-PipelineSetVariable -name "DOTNET_MULTILEVEL_LOOKUP" -value "0"
    94|   Write-PipelineSetVariable -name "DOTNET_SKIP_FIRST_TIME_EXPERIENCE" -value "1"
    95|   _InitializeDotNetCli="$dotnet_root"
    96| }
    97| function InstallDotNetSdk {
    98|   local root=$1
    99|   local version=$2
   100|   local architecture="unset"
   101|   if [[ $# -ge 3 ]]; then
   102|     architecture=$3
   103|   fi
   104|   InstallDotNet "$root" "$version" $architecture 'sdk' 'true' $runtime_source_feed $runtime_source_feed_key
   105| }
   106| function InstallDotNet {
   107|   local root=$1
   108|   local version=$2
   109|   GetDotNetInstallScript "$root"
   110|   local install_script=$_GetDotNetInstallScript
   111|   local installParameters=(--version $version --install-dir "$root")
   112|   if [[ -n "${3:-}" ]] && [ "$3" != 'unset' ]; then
   113|     installParameters+=(--architecture $3)
   114|   fi
   115|   if [[ -n "${4:-}" ]] && [ "$4" != 'sdk' ]; then
   116|     installParameters+=(--runtime $4)
   117|   fi
   118|   if [[ "$#" -ge "5" ]] && [[ "$5" != 'false' ]]; then
   119|     installParameters+=(--skip-non-versioned-files)
   120|   fi
   121|   local variations=() # list of variable names with parameter arrays in them
   122|   local public_location=("${installParameters[@]}")
   123|   variations+=(public_location)
   124|   local dotnetbuilds=("${installParameters[@]}" --azure-feed "https://dotnetbuilds.azureedge.net/public")
   125|   variations+=(dotnetbuilds)
   126|   if [[ -n "${6:-}" ]]; then
   127|     variations+=(private_feed)
   128|     local private_feed=("${installParameters[@]}" --azure-feed $6)
   129|     if [[ -n "${7:-}" ]]; then
   130|       decodeArg="--decode"
   131|       if base64 --help 2>&1 | grep -q "BusyBox"; then
   132|           decodeArg="-d"
   133|       fi
   134|       decodedFeedKey=`echo $7 | base64 $decodeArg`
   135|       private_feed+=(--feed-credential $decodedFeedKey)
   136|     fi
   137|   fi
   138|   local installSuccess=0
   139|   for variationName in "${variations[@]}"; do
   140|     local name="$variationName[@]"
   141|     local variation=("${!name}")
   142|     echo "Attempting to install dotnet from $variationName."
   143|     bash "$install_script" "${variation[@]}" && installSuccess=1
   144|     if [[ "$installSuccess" -eq 1 ]]; then
   145|       break
   146|     fi
   147|     echo "Failed to install dotnet from $variationName."
   148|   done
   149|   if [[ "$installSuccess" -eq 0 ]]; then
   150|     Write-PipelineTelemetryError -category 'InitializeToolset' "Failed to install dotnet SDK from any of the specified locations."
   151|     ExitWithExitCode 1
   152|   fi
   153| }
   154| function with_retries {
   155|   local maxRetries=5
   156|   local retries=1
   157|   echo "Trying to run '$@' for maximum of $maxRetries attempts."
   158|   while [[ $((retries++)) -le $maxRetries ]]; do
   159|     "$@"
   160|     if [[ $? == 0 ]]; then
   161|       echo "Ran '$@' successfully."
   162|       return 0
   163|     fi
   164|     timeout=$((3**$retries-1))
   165|     echo "Failed to execute '$@'. Waiting $timeout seconds before next attempt ($retries out of $maxRetries)." 1>&2
   166|     sleep $timeout
   167|   done
   168|   echo "Failed to execute '$@' for $maxRetries times." 1>&2
   169|   return 1
   170| }
   171| function GetDotNetInstallScript {
   172|   local root=$1
   173|   local install_script="$root/dotnet-install.sh"
   174|   local install_script_url="https://dotnet.microsoft.com/download/dotnet/scripts/$dotnetInstallScriptVersion/dotnet-install.sh"
   175|   if [[ ! -a "$install_script" ]]; then
   176|     mkdir -p "$root"
   177|     echo "Downloading '$install_script_url'"
   178|     if command -v curl > /dev/null; then
   179|       curl "$install_script_url" -sSL --retry 10 --create-dirs -o "$install_script" || {
   180|         if command -v openssl &> /dev/null; then
   181|           echo "Curl failed; dumping some information about dotnet.microsoft.com for later investigation"
   182|           echo | openssl s_client -showcerts -servername dotnet.microsoft.com  -connect dotnet.microsoft.com:443
   183|         fi
   184|         echo "Will now retry the same URL with verbose logging."
   185|         with_retries curl "$install_script_url" -sSL --verbose --retry 10 --create-dirs -o "$install_script" || {
   186|           local exit_code=$?
   187|           Write-PipelineTelemetryError -category 'InitializeToolset' "Failed to acquire dotnet install script (exit code '$exit_code')."
   188|           ExitWithExitCode $exit_code
   189|         }
   190|       }
   191|     else
   192|       with_retries wget -v -O "$install_script" "$install_script_url" || {
   193|         local exit_code=$?
   194|         Write-PipelineTelemetryError -category 'InitializeToolset' "Failed to acquire dotnet install script (exit code '$exit_code')."
   195|         ExitWithExitCode $exit_code
   196|       }
   197|     fi
   198|   fi
   199|   _GetDotNetInstallScript="$install_script"
   200| }
   201| function InitializeBuildTool {
   202|   if [[ -n "${_InitializeBuildTool:-}" ]]; then
   203|     return
   204|   fi
   205|   InitializeDotNetCli $restore
   206|   _InitializeBuildTool="$_InitializeDotNetCli/dotnet"
   207|   _InitializeBuildToolCommand="msbuild"
   208|   _InitializeBuildToolFramework="net7.0"
   209| }
   210| function GetNuGetPackageCachePath {
   211|   if [[ -z ${NUGET_PACKAGES:-} ]]; then
   212|     if [[ "$use_global_nuget_cache" == true ]]; then
   213|       export NUGET_PACKAGES="$HOME/.nuget/packages"
   214|     else
   215|       export NUGET_PACKAGES="$repo_root/.packages"
   216|       export RESTORENOCACHE=true
   217|     fi
   218|   fi
   219|   _GetNuGetPackageCachePath=$NUGET_PACKAGES
   220| }
   221| function InitializeNativeTools() {
   222|   if [[ -n "${DisableNativeToolsetInstalls:-}" ]]; then
   223|     return
   224|   fi
   225|   if grep -Fq "native-tools" $global_json_file
   226|   then
   227|     local nativeArgs=""
   228|     if [[ "$ci" == true ]]; then
   229|       nativeArgs="--installDirectory $tools_dir"
   230|     fi
   231|     "$_script_dir/init-tools-native.sh" $nativeArgs
   232|   fi
   233| }
   234| function InitializeToolset {
   235|   if [[ -n "${_InitializeToolset:-}" ]]; then
   236|     return
   237|   fi
   238|   GetNuGetPackageCachePath
   239|   ReadGlobalVersion "Microsoft.DotNet.Arcade.Sdk"
   240|   local toolset_version=$_ReadGlobalVersion
   241|   local toolset_location_file="$toolset_dir/$toolset_version.txt"
   242|   if [[ -a "$toolset_location_file" ]]; then
   243|     local path=`cat "$toolset_location_file"`
   244|     if [[ -a "$path" ]]; then
   245|       _InitializeToolset="$path"
   246|       return
   247|     fi
   248|   fi
   249|   if [[ "$restore" != true ]]; then
   250|     Write-PipelineTelemetryError -category 'InitializeToolset' "Toolset version $toolset_version has not been restored."
   251|     ExitWithExitCode 2
   252|   fi
   253|   local proj="$toolset_dir/restore.proj"
   254|   local bl=""
   255|   if [[ "$binary_log" == true ]]; then
   256|     bl="/bl:$log_dir/ToolsetRestore.binlog"
   257|   fi
   258|   echo '<Project Sdk="Microsoft.DotNet.Arcade.Sdk"/>' > "$proj"
   259|   MSBuild-Core "$proj" $bl /t:__WriteToolsetLocation /clp:ErrorsOnly\;NoSummary /p:__ToolsetLocationOutputFile="$toolset_location_file"
   260|   local toolset_build_proj=`cat "$toolset_location_file"`
   261|   if [[ ! -a "$toolset_build_proj" ]]; then
   262|     Write-PipelineTelemetryError -category 'Build' "Invalid toolset path: $toolset_build_proj"
   263|     ExitWithExitCode 3
   264|   fi
   265|   _InitializeToolset="$toolset_build_proj"
   266| }
   267| function ExitWithExitCode {
   268|   if [[ "$ci" == true && "$prepare_machine" == true ]]; then
   269|     StopProcesses
   270|   fi
   271|   exit $1
   272| }
   273| function StopProcesses {
   274|   echo "Killing running build processes..."
   275|   pkill -9 "dotnet" || true
   276|   pkill -9 "vbcscompiler" || true
   277|   return 0
   278| }
   279| function MSBuild {
   280|   local args=$@
   281|   if [[ "$pipelines_log" == true ]]; then
   282|     InitializeBuildTool
   283|     InitializeToolset
   284|     if [[ "$ci" == true ]]; then
   285|       export NUGET_PLUGIN_HANDSHAKE_TIMEOUT_IN_SECONDS=20
   286|       export NUGET_PLUGIN_REQUEST_TIMEOUT_IN_SECONDS=20
   287|       Write-PipelineSetVariable -name "NUGET_PLUGIN_HANDSHAKE_TIMEOUT_IN_SECONDS" -value "20"
   288|       Write-PipelineSetVariable -name "NUGET_PLUGIN_REQUEST_TIMEOUT_IN_SECONDS" -value "20"
   289|       export NUGET_ENABLE_EXPERIMENTAL_HTTP_RETRY=true
   290|       export NUGET_EXPERIMENTAL_MAX_NETWORK_TRY_COUNT=6
   291|       export NUGET_EXPERIMENTAL_NETWORK_RETRY_DELAY_MILLISECONDS=1000
   292|       Write-PipelineSetVariable -name "NUGET_ENABLE_EXPERIMENTAL_HTTP_RETRY" -value "true"
   293|       Write-PipelineSetVariable -name "NUGET_EXPERIMENTAL_MAX_NETWORK_TRY_COUNT" -value "6"
   294|       Write-PipelineSetVariable -name "NUGET_EXPERIMENTAL_NETWORK_RETRY_DELAY_MILLISECONDS" -value "1000"
   295|     fi
   296|     local toolset_dir="${_InitializeToolset%/*}"
   297|     local selectedPath=
   298|     local possiblePaths=()
   299|     possiblePaths+=( "$toolset_dir/$_InitializeBuildToolFramework/Microsoft.DotNet.ArcadeLogging.dll" )
   300|     possiblePaths+=( "$toolset_dir/$_InitializeBuildToolFramework/Microsoft.DotNet.Arcade.Sdk.dll" )
   301|     possiblePaths+=( "$toolset_dir/netcoreapp2.1/Microsoft.DotNet.ArcadeLogging.dll" )
   302|     possiblePaths+=( "$toolset_dir/netcoreapp2.1/Microsoft.DotNet.Arcade.Sdk.dll" )
   303|     possiblePaths+=( "$toolset_dir/netcoreapp3.1/Microsoft.DotNet.ArcadeLogging.dll" )
   304|     possiblePaths+=( "$toolset_dir/netcoreapp3.1/Microsoft.DotNet.Arcade.Sdk.dll" )
   305|     for path in "${possiblePaths[@]}"; do
   306|       if [[ -f $path ]]; then
   307|         selectedPath=$path
   308|         break
   309|       fi
   310|     done
   311|     if [[ -z "$selectedPath" ]]; then
   312|       Write-PipelineTelemetryError -category 'Build'  "Unable to find arcade sdk logger assembly."
   313|       ExitWithExitCode 1
   314|     fi
   315|     args+=( "-logger:$selectedPath" )
   316|   fi
   317|   MSBuild-Core ${args[@]}
   318| }
   319| function MSBuild-Core {
   320|   if [[ "$ci" == true ]]; then
   321|     if [[ "$binary_log" != true && "$exclude_ci_binary_log" != true ]]; then
   322|       Write-PipelineTelemetryError -category 'Build'  "Binary log must be enabled in CI build, or explicitly opted-out from with the -noBinaryLog switch."
   323|       ExitWithExitCode 1
   324|     fi
   325|     if [[ "$node_reuse" == true ]]; then
   326|       Write-PipelineTelemetryError -category 'Build'  "Node reuse must be disabled in CI build."
   327|       ExitWithExitCode 1
   328|     fi
   329|   fi
   330|   InitializeBuildTool
   331|   local warnaserror_switch=""
   332|   if [[ $warn_as_error == true ]]; then
   333|     warnaserror_switch="/warnaserror"
   334|   fi
   335|   function RunBuildTool {
   336|     export ARCADE_BUILD_TOOL_COMMAND="$_InitializeBuildTool $@"
   337|     "$_InitializeBuildTool" "$@" || {
   338|       local exit_code=$?
   339|       echo "Build failed with exit code $exit_code. Check errors above."
   340|       if [[ "$ci" == "true" ]]; then
   341|         Write-PipelineSetResult -result "Failed" -message "msbuild execution failed."
   342|         ExitWithExitCode 0
   343|       else
   344|         ExitWithExitCode $exit_code
   345|       fi
   346|     }
   347|   }
   348|   RunBuildTool "$_InitializeBuildToolCommand" /m /nologo /clp:Summary /v:$verbosity /nr:$node_reuse $warnaserror_switch /p:TreatWarningsAsErrors=$warn_as_error /p:ContinuousIntegrationBuild=$ci "$@"
   349| }
   350| ResolvePath "${BASH_SOURCE[0]}"
   351| _script_dir=`dirname "$_ResolvePath"`
   352| . "$_script_dir/pipeline-logging-functions.sh"
   353| eng_root=`cd -P "$_script_dir/.." && pwd`
   354| repo_root=`cd -P "$_script_dir/../.." && pwd`
   355| repo_root="${repo_root}/"
   356| artifacts_dir="${repo_root}artifacts"
   357| toolset_dir="$artifacts_dir/toolset"
   358| tools_dir="${repo_root}.tools"
   359| log_dir="$artifacts_dir/log/$configuration"
   360| temp_dir="$artifacts_dir/tmp/$configuration"
   361| global_json_file="${repo_root}global.json"
   362| global_json_has_runtimes=false
   363| if command -v jq &> /dev/null; then
   364|   if jq -er '. | select(has("runtimes"))' "$global_json_file" &> /dev/null; then
   365|     global_json_has_runtimes=true
   366|   fi
   367| elif [[ "$(cat "$global_json_file")" =~ \"runtimes\"[[:space:]\:]*\{ ]]; then
   368|   global_json_has_runtimes=true
   369| fi
   370| if [[ -z $HOME ]]; then
   371|   export HOME="${repo_root}artifacts/.home/"
   372|   mkdir -p "$HOME"
   373| fi
   374| mkdir -p "$toolset_dir"
   375| mkdir -p "$temp_dir"
   376| mkdir -p "$log_dir"
   377| Write-PipelineSetVariable -name "Artifacts" -value "$artifacts_dir"
   378| Write-PipelineSetVariable -name "Artifacts.Toolset" -value "$toolset_dir"
   379| Write-PipelineSetVariable -name "Artifacts.Log" -value "$log_dir"
   380| Write-PipelineSetVariable -name "Temp" -value "$temp_dir"
   381| Write-PipelineSetVariable -name "TMP" -value "$temp_dir"
   382| if [ -z "${disable_configure_toolset_import:-}" ]; then
   383|   configure_toolset_script="$eng_root/configure-toolset.sh"
   384|   if [[ -a "$configure_toolset_script" ]]; then
   385|     . "$configure_toolset_script"
   386|   fi
   387| fi
   388| if [[ -n "${useInstalledDotNetCli:-}" ]]; then
   389|   use_installed_dotnet_cli="$useInstalledDotNetCli"
   390| fi


# ====================================================================
# FILE: eng/docker/build-docker-sdk.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-34 ---
     1| set -u
     2| set -e
     3| source="${BASH_SOURCE[0]}"
     4| while [[ -h "$source" ]]; do
     5|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     6|   source="$(readlink "$source")"
     7|   [[ $source != /* ]] && source="$scriptroot/$source"
     8| done
     9| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
    10| imagename="dotnet-sdk-libs-current"
    11| configuration="Release"
    12| while [[ $# > 0 ]]; do
    13|   opt="$(echo "${1/#--/-}" | tr "[:upper:]" "[:lower:]")"
    14|   case "$opt" in
    15|     -imagename|-t)
    16|       imagename=$2
    17|       shift 2
    18|       ;;
    19|     -configuration|-c)
    20|       configuration=$2
    21|       shift 2
    22|       ;;
    23|     *)
    24|       shift 1
    25|       ;;
    26|   esac
    27| done
    28| repo_root=$(git rev-parse --show-toplevel)
    29| docker_file="$scriptroot/libraries-sdk.linux.Dockerfile"
    30| docker build --tag $imagename \
    31|     --build-arg CONFIGURATION=$configuration \
    32|     --file $docker_file \
    33|     $repo_root
    34| exit $?


# ====================================================================
# FILE: eng/formatting/download-tools.sh
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-30 ---
     1| set -ue
     2| source="${BASH_SOURCE[0]}"
     3| while [[ -h "$source" ]]; do
     4|   scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     5|   source="$(readlink "$source")"
     6|   [[ $source != /* ]] && source="$scriptroot/$source"
     7| done
     8| scriptroot="$( cd -P "$( dirname "$source" )" && pwd )"
     9| function DownloadClangTool {
    10|     targetPlatform=$(dotnet --info |grep RID:)
    11|     targetPlatform=${targetPlatform##*RID:* }
    12|     toolUrl=https://clrjit.blob.core.windows.net/clang-tools/${targetPlatform}/$1
    13|     toolOutput=$2/$1
    14|     if [[ ! -x "$toolOutput" ]]; then
    15|         curl --retry 5 -o "${toolOutput}" "$toolUrl"
    16|         chmod 751 $toolOutput
    17|     fi
    18|     if [[ ! -x "$toolOutput" ]]; then
    19|         echo "Failed to download $1"
    20|         exit 1
    21|     fi
    22| }
    23| engFolder="$(cd -P "$( dirname "$scriptroot" )" && pwd )"
    24| downloadPathFolder="$(cd -P "$( dirname "$engFolder" )" && pwd )/artifacts/tools"
    25| mkdir -p "$downloadPathFolder"
    26| . "$scriptroot/../common/tools.sh"
    27| InitializeDotNetCli true
    28| DownloadClangTool "clang-format" "$downloadPathFolder"
    29| DownloadClangTool "clang-tidy" "$downloadPathFolder"
    30| export PATH=$downloadPathFolder:$PATH

