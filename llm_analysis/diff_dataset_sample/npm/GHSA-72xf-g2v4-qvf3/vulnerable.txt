# ====================================================================
# FILE: lib/memstore.js
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 21-61 ---
    21|  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
    22|  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
    23|  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
    24|  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
    25|  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
    26|  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
    27|  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
    28|  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
    29|  * POSSIBILITY OF SUCH DAMAGE.
    30|  */
    31| "use strict";
    32| const { fromCallback } = require("universalify");
    33| const Store = require("./store").Store;
    34| const permuteDomain = require("./permuteDomain").permuteDomain;
    35| const pathMatch = require("./pathMatch").pathMatch;
    36| const { getCustomInspectSymbol, getUtilInspect } = require("./utilHelper");
    37| class MemoryCookieStore extends Store {
    38|   constructor() {
    39|     super();
    40|     this.synchronous = true;
    41|     this.idx = {};
    42|     const customInspectSymbol = getCustomInspectSymbol();
    43|     if (customInspectSymbol) {
    44|       this[customInspectSymbol] = this.inspect;
    45|     }
    46|   }
    47|   inspect() {
    48|     const util = { inspect: getUtilInspect(inspectFallback) };
    49|     return `{ idx: ${util.inspect(this.idx, false, 2)} }`;
    50|   }
    51|   findCookie(domain, path, key, cb) {
    52|     if (!this.idx[domain]) {
    53|       return cb(null, undefined);
    54|     }
    55|     if (!this.idx[domain][path]) {
    56|       return cb(null, undefined);
    57|     }
    58|     return cb(null, this.idx[domain][path][key] || null);
    59|   }
    60|   findCookies(domain, path, allowSpecialUseDomain, cb) {
    61|     const results = [];

# --- HUNK 2: Lines 84-156 ---
    84|             for (const key in pathIndex) {
    85|               results.push(pathIndex[key]);
    86|             }
    87|           }
    88|         });
    89|       };
    90|     }
    91|     const domains = permuteDomain(domain, allowSpecialUseDomain) || [domain];
    92|     const idx = this.idx;
    93|     domains.forEach(curDomain => {
    94|       const domainIndex = idx[curDomain];
    95|       if (!domainIndex) {
    96|         return;
    97|       }
    98|       pathMatcher(domainIndex);
    99|     });
   100|     cb(null, results);
   101|   }
   102|   putCookie(cookie, cb) {
   103|     if (!this.idx[cookie.domain]) {
   104|       this.idx[cookie.domain] = {};
   105|     }
   106|     if (!this.idx[cookie.domain][cookie.path]) {
   107|       this.idx[cookie.domain][cookie.path] = {};
   108|     }
   109|     this.idx[cookie.domain][cookie.path][cookie.key] = cookie;
   110|     cb(null);
   111|   }
   112|   updateCookie(oldCookie, newCookie, cb) {
   113|     this.putCookie(newCookie, cb);
   114|   }
   115|   removeCookie(domain, path, key, cb) {
   116|     if (
   117|       this.idx[domain] &&
   118|       this.idx[domain][path] &&
   119|       this.idx[domain][path][key]
   120|     ) {
   121|       delete this.idx[domain][path][key];
   122|     }
   123|     cb(null);
   124|   }
   125|   removeCookies(domain, path, cb) {
   126|     if (this.idx[domain]) {
   127|       if (path) {
   128|         delete this.idx[domain][path];
   129|       } else {
   130|         delete this.idx[domain];
   131|       }
   132|     }
   133|     return cb(null);
   134|   }
   135|   removeAllCookies(cb) {
   136|     this.idx = {};
   137|     return cb(null);
   138|   }
   139|   getAllCookies(cb) {
   140|     const cookies = [];
   141|     const idx = this.idx;
   142|     const domains = Object.keys(idx);
   143|     domains.forEach(domain => {
   144|       const paths = Object.keys(idx[domain]);
   145|       paths.forEach(path => {
   146|         const keys = Object.keys(idx[domain][path]);
   147|         keys.forEach(key => {
   148|           if (key !== null) {
   149|             cookies.push(idx[domain][path][key]);
   150|           }
   151|         });
   152|       });
   153|     });
   154|     cookies.sort((a, b) => {
   155|       return (a.creationIndex || 0) - (b.creationIndex || 0);
   156|     });

# --- HUNK 3: Lines 158-218 ---
   158|   }
   159| }
   160| [
   161|   "findCookie",
   162|   "findCookies",
   163|   "putCookie",
   164|   "updateCookie",
   165|   "removeCookie",
   166|   "removeCookies",
   167|   "removeAllCookies",
   168|   "getAllCookies"
   169| ].forEach(name => {
   170|   MemoryCookieStore.prototype[name] = fromCallback(
   171|     MemoryCookieStore.prototype[name]
   172|   );
   173| });
   174| exports.MemoryCookieStore = MemoryCookieStore;
   175| function inspectFallback(val) {
   176|   const domains = Object.keys(val);
   177|   if (domains.length === 0) {
   178|     return "{}";
   179|   }
   180|   let result = "{\n";
   181|   Object.keys(val).forEach((domain, i) => {
   182|     result += formatDomain(domain, val[domain]);
   183|     if (i < domains.length - 1) {
   184|       result += ",";
   185|     }
   186|     result += "\n";
   187|   });
   188|   result += "}";
   189|   return result;
   190| }
   191| function formatDomain(domainName, domainValue) {
   192|   const indent = "  ";
   193|   let result = `${indent}'${domainName}': {\n`;
   194|   Object.keys(domainValue).forEach((path, i, paths) => {
   195|     result += formatPath(path, domainValue[path]);
   196|     if (i < paths.length - 1) {
   197|       result += ",";
   198|     }
   199|     result += "\n";
   200|   });
   201|   result += `${indent}}`;
   202|   return result;
   203| }
   204| function formatPath(pathName, pathValue) {
   205|   const indent = "    ";
   206|   let result = `${indent}'${pathName}': {\n`;
   207|   Object.keys(pathValue).forEach((cookieName, i, cookieNames) => {
   208|     const cookie = pathValue[cookieName];
   209|     result += `      ${cookieName}: ${cookie.inspect()}`;
   210|     if (i < cookieNames.length - 1) {
   211|       result += ",";
   212|     }
   213|     result += "\n";
   214|   });
   215|   result += `${indent}}`;
   216|   return result;
   217| }
   218| exports.inspectFallback = inspectFallback;


# ====================================================================
# FILE: lib/version.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| module.exports = '4.1.2'

