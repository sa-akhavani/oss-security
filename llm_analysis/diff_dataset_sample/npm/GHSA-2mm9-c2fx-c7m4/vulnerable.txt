# ====================================================================
# FILE: cypress/integration/routing/fallback.spec.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-7 ---
     1| context('config.fallbackLanguages', () => {
     2|   it('fallbacks respecting aliases', () => {
     3|     cy.visit('http://localhost:3000/#/es/');
     4|     cy.get('.sidebar-nav').contains('Changelog').click();
     5|     cy.get('#main').should('contain', 'Bug Fixes');
     6|   })
     7| });


# ====================================================================
# FILE: cypress/integration/sidebar/config.spec.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-290 ---
     1| context('sidebar.configurations', () => {
     2|   beforeEach(() => {
     3|     cy.visit('http://localhost:3000');
     4|   });
     5|   const quickStartIds = [
     6|     'initialize',
     7|     'writing-content',
     8|     'preview-your-site',
     9|     'manual-initialization',
    10|     'loading-dialog',
    11|   ];
    12|   quickStartIds.forEach(id => {
    13|     it('go to #quickstart?id=' + id, () => {
    14|       cy.get(
    15|         '.sidebar-nav > :nth-child(1) > :nth-child(1) > ul > :nth-child(1) > a'
    16|       ).click();
    17|       cy.get(`a.section-link[href='#/quickstart?id=${id}']`)
    18|         .click()
    19|         .then(() => {
    20|           cy.wait(500);
    21|           cy.matchImageSnapshot();
    22|         });
    23|     });
    24|   });
    25|   const configurationIds = [
    26|     'el',
    27|     'repo',
    28|     'maxlevel',
    29|     'loadnavbar',
    30|     'loadsidebar',
    31|     'hidesidebar',
    32|     'submaxlevel',
    33|     'auto2top',
    34|     'homepage',
    35|     'basepath',
    36|     'relativepath',
    37|     'coverpage',
    38|     'logo',
    39|     'name',
    40|     'namelink',
    41|     'markdown',
    42|     'themecolor',
    43|     'alias',
    44|     'autoheader',
    45|     'executescript',
    46|     'noemoji',
    47|     'mergenavbar',
    48|     'formatupdated',
    49|     'externallinktarget',
    50|     'cornerexternallinktarget',
    51|     'externallinkrel',
    52|     'routermode',
    53|     'nocompilelinks',
    54|     'onlycover',
    55|     'requestheaders',
    56|     'ext',
    57|     'fallbacklanguages',
    58|     'notfoundpage',
    59|   ];
    60|   configurationIds.forEach(id => {
    61|     it('go to #configuration?id=' + id, () => {
    62|       cy.get('[href="#/configuration"]').click();
    63|       cy.get(`a.section-link[href='#/configuration?id=${id}']`)
    64|         .click()
    65|         .then(() => {
    66|           cy.wait(500); // its more far from the cover
    67|           cy.matchImageSnapshot();
    68|         });
    69|     });
    70|   });
    71|   const morePagesIds = [
    72|     'sidebar',
    73|     'nested-sidebars',
    74|     'set-page-titles-from-sidebar-selection',
    75|     'table-of-contents',
    76|     'ignoring-subheaders',
    77|   ];
    78|   morePagesIds.forEach(id => {
    79|     it('go to #more-pages?id=' + id, () => {
    80|       cy.get('[href="#/more-pages"]').click();
    81|       cy.get(`a.section-link[href='#/more-pages?id=${id}']`)
    82|         .click()
    83|         .then(() => {
    84|           cy.wait(500);
    85|           cy.matchImageSnapshot();
    86|         });
    87|     });
    88|   });
    89|   const customNavbarIds = [
    90|     'html',
    91|     'markdown',
    92|     'nesting',
    93|     'combining-custom-navbars-with-the-emoji-plugin',
    94|   ];
    95|   customNavbarIds.forEach(id => {
    96|     it('go to #custom-navbar?id=' + id, () => {
    97|       cy.get('[href="#/custom-navbar"]').click();
    98|       cy.get(`a.section-link[href='#/custom-navbar?id=${id}']`)
    99|         .click()
   100|         .then(() => {
   101|           cy.wait(500);
   102|           cy.matchImageSnapshot();
   103|         });
   104|     });
   105|   });
   106|   const coverIds = [
   107|     'basic-usage',
   108|     'custom-background',
   109|     'coverpage-as-homepage',
   110|     'multiple-covers',
   111|   ];
   112|   coverIds.forEach(id => {
   113|     it('go to #cover?id=' + id, () => {
   114|       cy.get('[href="#/cover"]').click();
   115|       cy.get(`a.section-link[href='#/cover?id=${id}']`)
   116|         .click()
   117|         .then(() => {
   118|           cy.wait(500);
   119|           cy.matchImageSnapshot();
   120|         });
   121|     });
   122|   });
   123|   const themesIds = ['other-themes'];
   124|   themesIds.forEach(id => {
   125|     it('go to #themes?id=' + id, () => {
   126|       cy.get('[href="#/themes"]').click();
   127|       cy.get(`a.section-link[href='#/themes?id=${id}']`)
   128|         .click()
   129|         .then(() => {
   130|           cy.wait(500);
   131|           cy.matchImageSnapshot();
   132|         });
   133|     });
   134|   });
   135|   const pluginsIds = [
   136|     'full-text-search',
   137|     'google-analytics',
   138|     'emoji',
   139|     'external-script',
   140|     'zoom-image',
   141|     'edit-on-github',
   142|     'demo-code-with-instant-preview-and-jsfiddle-integration',
   143|     'copy-to-clipboard',
   144|     'disqus',
   145|     'gitalk',
   146|     'pagination',
   147|     'tabs',
   148|     'more-plugins',
   149|   ];
   150|   pluginsIds.forEach(id => {
   151|     it('go to #plugins?id=' + id, () => {
   152|       cy.get('[href="#/plugins"]').click();
   153|       cy.get(`a.section-link[href='#/plugins?id=${id}']`)
   154|         .click()
   155|         .then(() => {
   156|           cy.wait(500);
   157|           cy.matchImageSnapshot();
   158|         });
   159|     });
   160|   });
   161|   const writeAPluginIds = ['full-configuration', 'example', 'tips'];
   162|   writeAPluginIds.forEach(id => {
   163|     it('go to #write-a-plugin?id=' + id, () => {
   164|       cy.get('[href="#/write-a-plugin"]').click();
   165|       cy.get(`a.section-link[href='#/write-a-plugin?id=${id}']`)
   166|         .click()
   167|         .then(() => {
   168|           cy.wait(500);
   169|           cy.matchImageSnapshot();
   170|         });
   171|     });
   172|   });
   173|   const markdownIds = ['supports-mermaid'];
   174|   markdownIds.forEach(id => {
   175|     it('go to #markdown?id=' + id, () => {
   176|       cy.get('[href="#/markdown"]').click();
   177|       cy.get(`a.section-link[href='#/markdown?id=${id}']`)
   178|         .click()
   179|         .then(() => {
   180|           cy.wait(500);
   181|           cy.matchImageSnapshot();
   182|         });
   183|     });
   184|   });
   185|   it('go to #Language-highlight', () => {
   186|     cy.get('a[href="#/language-highlight"]')
   187|       .click()
   188|       .then(() => {
   189|         cy.wait(500);
   190|         cy.matchImageSnapshot();
   191|       });
   192|   });
   193|   const helpersIds = [
   194|     'important-content',
   195|     'general-tips',
   196|     'ignore-to-compile-link',
   197|     'set-target-attribute-for-link',
   198|     'disable-link',
   199|     'github-task-lists',
   200|     'customise-id-for-headings',
   201|     'markdown-in-html-tag',
   202|   ];
   203|   helpersIds.forEach(id => {
   204|     it('go to #helpers?id=' + id, () => {
   205|       cy.get('[href="#/helpers"]').click();
   206|       cy.get(`a.section-link[href='#/helpers?id=${id}']`)
   207|         .click()
   208|         .then(() => {
   209|           cy.wait(500);
   210|           cy.matchImageSnapshot();
   211|         });
   212|     });
   213|   });
   214|   const vueIds = ['basic-usage', 'combine-vuep-to-write-playground'];
   215|   vueIds.forEach(id => {
   216|     it('go to #vue?id=' + id, () => {
   217|       cy.get('[href="#/vue"]').click();
   218|       cy.get(`a.section-link[href='#/vue?id=${id}']`)
   219|         .click()
   220|         .then(() => {
   221|           cy.wait(500);
   222|           cy.matchImageSnapshot();
   223|         });
   224|     });
   225|   });
   226|   const cdnIds = [
   227|     'latest-version',
   228|     'specific-version',
   229|     'compressed-file',
   230|     'other-cdn',
   231|   ];
   232|   cdnIds.forEach(id => {
   233|     it('go to #cdn?id=' + id, () => {
   234|       cy.get('[href="#/cdn"]').click();
   235|       cy.get(`a.section-link[href='#/cdn?id=${id}']`)
   236|         .click()
   237|         .then(() => {
   238|           cy.wait(500);
   239|           cy.matchImageSnapshot();
   240|         });
   241|     });
   242|   });
   243|   const pwaIds = ['create-serviceworker', 'register', 'enjoy-it'];
   244|   pwaIds.forEach(id => {
   245|     it('go to #pwa?id=' + id, () => {
   246|       cy.get('[href="#/pwa"]').click();
   247|       cy.get(`a.section-link[href='#/pwa?id=${id}']`)
   248|         .click()
   249|         .then(() => {
   250|           cy.wait(500);
   251|           cy.matchImageSnapshot();
   252|         });
   253|     });
   254|   });
   255|   const ssrIds = [
   256|     'why-ssr',
   257|     'quick-start',
   258|     'custom-template',
   259|     'configuration',
   260|     'deploy-for-your-vps',
   261|   ];
   262|   ssrIds.forEach(id => {
   263|     it('go to #ssr?id=' + id, () => {
   264|       cy.get('[href="#/ssr"]').click();
   265|       cy.get(`a.section-link[href='#/ssr?id=${id}']`)
   266|         .click()
   267|         .then(() => {
   268|           cy.wait(500);
   269|           cy.matchImageSnapshot();
   270|         });
   271|     });
   272|   });
   273|   const embedFilesIds = [
   274|     'embedded-file-type',
   275|     'embedded-code-fragments',
   276|     'tag-attribute',
   277|     'the-code-block-highlight',
   278|   ];
   279|   embedFilesIds.forEach(id => {
   280|     it('go to #embed-files?id=' + id, () => {
   281|       cy.get('[href="#/embed-files"]').click();
   282|       cy.get(`a.section-link[href='#/embed-files?id=${id}']`)
   283|         .click()
   284|         .then(() => {
   285|           cy.wait(500);
   286|           cy.matchImageSnapshot();
   287|         });
   288|     });
   289|   });
   290| });


# ====================================================================
# FILE: cypress/live.server.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| const path = require('path')
     2| const LiveServer = require('live-server')
     3| const fixturePath = path.join(__dirname, './fixtures/docs')
     4| const args = process.argv.slice(2)
     5| console.log('[e2e tests] : args passed to live server', args)
     6| const params = {
     7|   port: args[0] || 3000,
     8|   root: args[1] || fixturePath,
     9|   open: false
    10| }
    11| LiveServer.start(params)


# ====================================================================
# FILE: cypress/plugins/index.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-4 ---
     1| const { addMatchImageSnapshotPlugin } = require('cypress-image-snapshot/plugin')
     2| module.exports = (on, config) => {
     3|   addMatchImageSnapshotPlugin(on, config)
     4| }


# ====================================================================
# FILE: cypress/setup.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-58 ---
     1| const copyDir = require('copy-dir')
     2| const path = require('path')
     3| const fs = require('fs')
     4| const { spawn } = require('child_process')
     5| const setup = async () => {
     6|   const PORT = process.env.PORT || 3000
     7|   global.__LIVESERVER__ = null
     8|   global.PORT = PORT
     9|   /**
    10|    * IN this test suite, we are going to test our docs site with all the css,js linked to our local build packages
    11|    *
    12|    *  1.1 Copy ../docs --> ./fixtures/docs
    13|    *  1.2 copy lib,themes --> ./fixtures/
    14|    *  2. change the content of fixtures/docs/index.html to use all the links from our local build
    15|    *  3. now jest runner will run to test all the *.spec.js files
    16|    *
    17|    */
    18|   const shippedDirs = ['lib', 'themes']
    19|   const docsPath = path.join(process.cwd(), './docs')
    20|   const fixtureDocsPath = path.join(__dirname, './fixtures/docs')
    21|   console.log('[cypress test docs] Copying the docs --> cypress/fixtures/docs')
    22|   copyDir.sync(docsPath, fixtureDocsPath)
    23|   shippedDirs.forEach(dir => {
    24|     const fromPath = path.join(process.cwd(), dir)
    25|     const toPath = path.join(__dirname, `./fixtures/docs/${dir}`)
    26|     console.log(
    27|       `[cypress test docs] Copying  ${dir} --> cypress/fixtures/docs/${dir}`
    28|     )
    29|     copyDir.sync(fromPath, toPath)
    30|   })
    31|   console.log(
    32|     '[cypress test docs] Replacing content the tpl/index.html --> cypress/fixtures/docs/index.html'
    33|   )
    34|   const indexHTMLtplPath = path.join(
    35|     __dirname,
    36|     './fixtures/tpl/docs.index.html'
    37|   )
    38|   const fixtureIndexPath = path.join(__dirname, './fixtures/docs/index.html')
    39|   const data = fs.readFileSync(indexHTMLtplPath, 'utf8')
    40|   const fixturePath = path.join(__dirname, './fixtures/docs')
    41|   fs.writeFileSync(fixtureIndexPath, data, 'utf8')
    42|   const child = spawn('node', [
    43|     path.join(__dirname, './live.server.js'),
    44|     PORT,
    45|     fixturePath
    46|   ])
    47|   child.on('exit', code => {
    48|     console.log(`Child process exited with code ${code}`)
    49|   })
    50|   child.stdout.on('data', data => {
    51|     console.log(`stdout: ${data}`)
    52|   })
    53|   child.stderr.on('data', data => {
    54|     console.log(`stderr: ${data}`)
    55|   })
    56|   global.__LIVESERVER__ = child
    57| }
    58| setup()


# ====================================================================
# FILE: cypress/support/commands.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-15 ---
     1| import { addMatchImageSnapshotCommand } from 'cypress-image-snapshot/command'
     2| addMatchImageSnapshotCommand({
     3|   failureThreshold: 10.0,
     4|   failureThresholdType: 'percent',
     5|   customDiffConfig: { threshold: 10.0 },
     6|   capture: 'viewport',
     7|   timeout: '60000'
     8| })
     9| Cypress.Commands.add('setResolution', size => {
    10|   if (Cypress._.isArray(size)) {
    11|     cy.viewport(size[0], size[1])
    12|   } else {
    13|     cy.viewport(size)
    14|   }
    15| })


# ====================================================================
# FILE: cypress/support/index.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| import './commands'


# ====================================================================
# FILE: packages/docsify-server-renderer/index.js
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| import { readFileSync } from 'fs';
     2| import { resolve, basename } from 'path';
     3| import resolvePathname from 'resolve-pathname';
     4| import fetch from 'node-fetch';
     5| import debug from 'debug';
     6| import DOMPurify from 'dompurify';
     7| import { AbstractHistory } from '../../src/core/router/history/abstract';
     8| import { Compiler } from '../../src/core/render/compiler';
     9| import { isAbsolutePath } from '../../src/core/router/util';
    10| import * as tpl from '../../src/core/render/tpl';
    11| import { prerenderEmbed } from '../../src/core/render/embed';
    12| function cwd(...args) {
    13|   return resolve(process.cwd(), ...args);
    14| }
    15| function isExternal(url) {
    16|   let match = url.match(
    17|     /^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/
    18|   );
    19|   if (
    20|     typeof match[1] === 'string' &&
    21|     match[1].length > 0 &&
    22|     match[1].toLowerCase() !== location.protocol
    23|   ) {
    24|     return true;
    25|   }
    26|   if (
    27|     typeof match[2] === 'string' &&
    28|     match[2].length > 0 &&
    29|     match[2].replace(
    30|       new RegExp(
    31|         ':(' + { 'http:': 80, 'https:': 443 }[location.protocol] + ')?$'
    32|       ),
    33|       ''
    34|     ) !== location.host
    35|   ) {
    36|     return true;
    37|   }

# --- HUNK 2: Lines 85-125 ---
    85|     if (loadNavbar) {
    86|       const name = loadNavbar === true ? '_navbar.md' : loadNavbar;
    87|       const navbarFile = this._getPath(resolve(url, `./${name}`));
    88|       this._renderHtml('navbar', await this._render(navbarFile, 'navbar'));
    89|     }
    90|     if (coverpage) {
    91|       let path = null;
    92|       if (typeof coverpage === 'string') {
    93|         if (url === '/') {
    94|           path = coverpage;
    95|         }
    96|       } else if (Array.isArray(coverpage)) {
    97|         path = coverpage.indexOf(url) > -1 && '_coverpage.md';
    98|       } else {
    99|         const cover = coverpage[url];
   100|         path = cover === true ? '_coverpage.md' : cover;
   101|       }
   102|       const coverFile = this._getPath(resolve(url, `./${path}`));
   103|       this._renderHtml('cover', await this._render(coverFile), 'cover');
   104|     }
   105|     const html = this.isRemoteUrl ? DOMPurify.sanitize(this.html) : this.html;
   106|     this.html = this.template;
   107|     return html;
   108|   }
   109|   _renderHtml(match, content) {
   110|     this.html = this.html.replace(new RegExp(`<!--${match}-->`, 'g'), content);
   111|     return this.html;
   112|   }
   113|   async _render(path, type) {
   114|     let html = await this._loadFile(path);
   115|     const { subMaxLevel, maxLevel } = this.config;
   116|     let tokens;
   117|     switch (type) {
   118|       case 'sidebar':
   119|         html =
   120|           this.compiler.sidebar(html, maxLevel) +
   121|           `<script>window.__SUB_SIDEBAR__ = ${JSON.stringify(
   122|             this.compiler.subSidebar(subMaxLevel)
   123|           )}</script>`;
   124|         break;
   125|       case 'cover':


# ====================================================================
# FILE: src/core/event/scroll.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-38 ---
     1| import Tweezer from 'tweezer.js';
     2| import { isMobile } from '../util/env';
     3| import * as dom from '../util/dom';
     4| import { removeParams } from '../router/util';
     5| import config from '../config';
     6| const nav = {};
     7| let hoverOver = false;
     8| let scroller = null;
     9| let enableScrollEvent = true;
    10| let coverHeight = 0;
    11| function scrollTo(el, offset = 0) {
    12|   if (scroller) {
    13|     scroller.stop();
    14|   }
    15|   enableScrollEvent = false;
    16|   scroller = new Tweezer({
    17|     start: window.pageYOffset,
    18|     end: el.getBoundingClientRect().top + window.pageYOffset - offset,
    19|     duration: 500,
    20|   })
    21|     .on('tick', v => window.scrollTo(0, v))
    22|     .on('done', () => {
    23|       enableScrollEvent = true;
    24|       scroller = null;
    25|     })
    26|     .begin();
    27| }
    28| function highlight(path) {
    29|   if (!enableScrollEvent) {
    30|     return;
    31|   }
    32|   const sidebar = dom.getNode('.sidebar');
    33|   const anchors = dom.findAll('.anchor');
    34|   const wrap = dom.find(sidebar, '.sidebar-nav');
    35|   let active = dom.find(sidebar, 'li.active');
    36|   const doc = document.documentElement;
    37|   const top = ((doc && doc.scrollTop) || document.body.scrollTop) - coverHeight;
    38|   let last;


# ====================================================================
# FILE: src/core/event/sidebar.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 54-90 ---
    54| }
    55| /**
    56|  * Get and active link
    57|  * @param  {Object} router Router
    58|  * @param  {String|Element} el Target element
    59|  * @param  {Boolean} isParent Active parent
    60|  * @param  {Boolean} autoTitle Automatically set title
    61|  * @return {Element} Active element
    62|  */
    63| export function getAndActive(router, el, isParent, autoTitle) {
    64|   el = dom.getNode(el);
    65|   let links = [];
    66|   if (el !== null && el !== undefined) {
    67|     links = dom.findAll(el, 'a');
    68|   }
    69|   const hash = decodeURI(router.toURL(router.getCurrentPath()));
    70|   let target;
    71|   links
    72|     .sort((a, b) => b.href.length - a.href.length)
    73|     .forEach(a => {
    74|       const href = a.getAttribute('href');
    75|       const node = isParent ? a.parentNode : a;
    76|       a.title = a.innerText;
    77|       if (hash.indexOf(href) === 0 && !target) {
    78|         target = a;
    79|         dom.toggleClass(node, 'add', 'active');
    80|       } else {
    81|         dom.toggleClass(node, 'remove', 'active');
    82|       }
    83|     });
    84|   if (autoTitle) {
    85|     dom.$.title = target
    86|       ? target.title || `${target.innerText} - ${title}`
    87|       : title;
    88|   }
    89|   return target;
    90| }


# ====================================================================
# FILE: src/core/fetch/index.js
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| /* eslint-disable no-unused-vars */
     2| import { callHook } from '../init/lifecycle';
     3| import { getParentPath, stringifyQuery } from '../router/util';
     4| import { noop } from '../util/core';
     5| import { getAndActive } from '../event/sidebar';
     6| import { get } from './ajax';
     7| function loadNested(path, qs, file, next, vm, first) {
     8|   path = first ? path : path.replace(/\/$/, '');
     9|   path = getParentPath(path);
    10|   if (!path) {
    11|     return;
    12|   }
    13|   get(
    14|     vm.router.getFile(path + file) + qs,
    15|     false,
    16|     vm.config.requestHeaders
    17|   ).then(next, _ => loadNested(path, qs, file, next, vm));
    18| }
    19| function isExternal(url) {
    20|   let match = url.match(
    21|     /^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/
    22|   );
    23|   if (
    24|     typeof match[1] === 'string' &&
    25|     match[1].length > 0 &&
    26|     match[1].toLowerCase() !== location.protocol
    27|   ) {
    28|     return true;
    29|   }
    30|   if (
    31|     typeof match[2] === 'string' &&
    32|     match[2].length > 0 &&
    33|     match[2].replace(
    34|       new RegExp(
    35|         ':(' + { 'http:': 80, 'https:': 443 }[location.protocol] + ')?$'
    36|       ),
    37|       ''
    38|     ) !== location.host
    39|   ) {
    40|     return true;
    41|   }

# --- HUNK 2: Lines 47-134 ---
    47|   const request = (url, hasbar, requestHeaders) => {
    48|     abort();
    49|     last = get(url, true, requestHeaders);
    50|     return last;
    51|   };
    52|   const get404Path = (path, config) => {
    53|     const { notFoundPage, ext } = config;
    54|     const defaultPath = '_404' + (ext || '.md');
    55|     let key;
    56|     let path404;
    57|     switch (typeof notFoundPage) {
    58|       case 'boolean':
    59|         path404 = defaultPath;
    60|         break;
    61|       case 'string':
    62|         path404 = notFoundPage;
    63|         break;
    64|       case 'object':
    65|         key = Object.keys(notFoundPage)
    66|           .sort((a, b) => b.length - a.length)
    67|           .find(key => path.match(new RegExp('^' + key)));
    68|         path404 = (key && notFoundPage[key]) || defaultPath;
    69|         break;
    70|       default:
    71|         break;
    72|     }
    73|     return path404;
    74|   };
    75|   proto._loadSideAndNav = function(path, qs, loadSidebar, cb) {
    76|     return () => {
    77|       if (!loadSidebar) {
    78|         return cb();
    79|       }
    80|       const fn = result => {
    81|         this._renderSidebar(result);
    82|         cb();
    83|       };
    84|       loadNested(path, qs, loadSidebar, fn, this, true);
    85|     };
    86|   };
    87|   proto._fetch = function(cb = noop) {
    88|     const { path, query } = this.route;
    89|     const qs = stringifyQuery(query, ['id']);
    90|     const { loadNavbar, requestHeaders, loadSidebar } = this.config;
    91|     const file = this.router.getFile(path);
    92|     const req = request(file + qs, true, requestHeaders);
    93|     this.isRemoteUrl = isExternal(file);
    94|     this.isHTML = /\.html$/g.test(file);
    95|     req.then(
    96|       (text, opt) =>
    97|         this._renderMain(
    98|           text,
    99|           opt,
   100|           this._loadSideAndNav(path, qs, loadSidebar, cb)
   101|         ),
   102|       _ => {
   103|         this._fetchFallbackPage(path, qs, cb) || this._fetch404(file, qs, cb);
   104|       }
   105|     );
   106|     loadNavbar &&
   107|       loadNested(
   108|         path,
   109|         qs,
   110|         loadNavbar,
   111|         text => this._renderNav(text),
   112|         this,
   113|         true
   114|       );
   115|   };
   116|   proto._fetchCover = function() {
   117|     const { coverpage, requestHeaders } = this.config;
   118|     const query = this.route.query;
   119|     const root = getParentPath(this.route.path);
   120|     if (coverpage) {
   121|       let path = null;
   122|       const routePath = this.route.path;
   123|       if (typeof coverpage === 'string') {
   124|         if (routePath === '/') {
   125|           path = coverpage;
   126|         }
   127|       } else if (Array.isArray(coverpage)) {
   128|         path = coverpage.indexOf(routePath) > -1 && '_coverpage';
   129|       } else {
   130|         const cover = coverpage[routePath];
   131|         path = cover === true ? '_coverpage' : cover;
   132|       }
   133|       const coverOnly = Boolean(path) && this.config.onlyCover;
   134|       if (path) {


# ====================================================================
# FILE: src/core/init/lifecycle.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| import { noop } from '../util/core';
     2| export function initLifecycle(vm) {
     3|   const hooks = [
     4|     'init',
     5|     'mounted',
     6|     'beforeEach',
     7|     'afterEach',
     8|     'doneEach',
     9|     'ready',
    10|   ];
    11|   vm._hooks = {};
    12|   vm._lifecycle = {};
    13|   hooks.forEach(hook => {
    14|     const arr = (vm._hooks[hook] = []);
    15|     vm._lifecycle[hook] = fn => arr.push(fn);
    16|   });
    17| }
    18| export function callHook(vm, hook, data, next = noop) {
    19|   const queue = vm._hooks[hook];
    20|   const step = function(index) {
    21|     const hook = queue[index];
    22|     if (index >= queue.length) {
    23|       next(data);
    24|     } else if (typeof hook === 'function') {
    25|       if (hook.length === 2) {
    26|         hook(data, result => {
    27|           data = result;
    28|           step(index + 1);
    29|         });
    30|       } else {
    31|         const result = hook(data);
    32|         data = result === undefined ? data : result;
    33|         step(index + 1);
    34|       }
    35|     } else {
    36|       step(index + 1);
    37|     }
    38|   };
    39|   step(0);
    40| }


# ====================================================================
# FILE: src/core/render/compiler.js
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| import marked from 'marked';
     2| import { isAbsolutePath, getPath, getParentPath } from '../router/util';
     3| import { isFn, merge, cached, isPrimitive } from '../util/core';
     4| import { tree as treeTpl } from './tpl';
     5| import { genTree } from './gen-tree';
     6| import { slugify } from './slugify';
     7| import { emojify } from './emojify';
     8| import { getAndRemoveConfig } from './utils';
     9| import { imageCompiler } from './compiler/image';
    10| import { highlightCodeCompiler } from './compiler/code';
    11| import { paragraphCompiler } from './compiler/paragraph';
    12| import { taskListCompiler } from './compiler/taskList';
    13| import { taskListItemCompiler } from './compiler/taskListItem';
    14| import { linkCompiler } from './compiler/link';
    15| const cachedLinks = {};
    16| const compileMedia = {
    17|   markdown(url) {
    18|     return {
    19|       url,
    20|     };
    21|   },
    22|   mermaid(url) {
    23|     return {
    24|       url,
    25|     };
    26|   },
    27|   iframe(url, title) {
    28|     return {

# --- HUNK 2: Lines 162-220 ---
   162|       const re = cachedLinks[n] || (cachedLinks[n] = new RegExp(`^${n}$`));
   163|       if (re.test(link)) {
   164|         return link;
   165|       }
   166|     }
   167|   }
   168|   _initRenderer() {
   169|     const renderer = new marked.Renderer();
   170|     const { linkTarget, linkRel, router, contentBase } = this;
   171|     const _self = this;
   172|     const origin = {};
   173|     /**
   174|      * Render anchor tag
   175|      * @link https://github.com/markedjs/marked#overriding-renderer-methods
   176|      * @param {String} text Text content
   177|      * @param {Number} level Type of heading (h<level> tag)
   178|      * @returns {String} Heading element
   179|      */
   180|     origin.heading = renderer.heading = function(text, level) {
   181|       let { str, config } = getAndRemoveConfig(text);
   182|       const nextToc = { level, title: str };
   183|       if (/<!-- {docsify-ignore} -->/g.test(str)) {
   184|         str = str.replace('<!-- {docsify-ignore} -->', '');
   185|         nextToc.title = str;
   186|         nextToc.ignoreSubHeading = true;
   187|       }
   188|       if (/{docsify-ignore}/g.test(str)) {
   189|         str = str.replace('{docsify-ignore}', '');
   190|         nextToc.title = str;
   191|         nextToc.ignoreSubHeading = true;
   192|       }
   193|       if (/<!-- {docsify-ignore-all} -->/g.test(str)) {
   194|         str = str.replace('<!-- {docsify-ignore-all} -->', '');
   195|         nextToc.title = str;
   196|         nextToc.ignoreAllSubs = true;
   197|       }
   198|       if (/{docsify-ignore-all}/g.test(str)) {
   199|         str = str.replace('{docsify-ignore-all}', '');
   200|         nextToc.title = str;
   201|         nextToc.ignoreAllSubs = true;
   202|       }
   203|       const slug = slugify(config.id || str);
   204|       const url = router.toURL(router.getCurrentPath(), { id: slug });
   205|       nextToc.slug = url;
   206|       _self.toc.push(nextToc);
   207|       return `<h${level} id="${slug}"><a href="${url}" data-id="${slug}" class="anchor"><span>${str}</span></a></h${level}>`;
   208|     };
   209|     origin.code = highlightCodeCompiler({ renderer });
   210|     origin.link = linkCompiler({
   211|       renderer,
   212|       router,
   213|       linkTarget,
   214|       linkRel,
   215|       compilerClass: _self,
   216|     });
   217|     origin.paragraph = paragraphCompiler({ renderer });
   218|     origin.image = imageCompiler({ renderer, contentBase, router });
   219|     origin.list = taskListCompiler({ renderer });
   220|     origin.listitem = taskListItemCompiler({ renderer });

# --- HUNK 3: Lines 223-263 ---
   223|   }
   224|   /**
   225|    * Compile sidebar
   226|    * @param {String} text Text content
   227|    * @param {Number} level Type of heading (h<level> tag)
   228|    * @returns {String} Sidebar element
   229|    */
   230|   sidebar(text, level) {
   231|     const { toc } = this;
   232|     const currentPath = this.router.getCurrentPath();
   233|     let html = '';
   234|     if (text) {
   235|       html = this.compile(text);
   236|     } else {
   237|       for (let i = 0; i < toc.length; i++) {
   238|         if (toc[i].ignoreSubHeading) {
   239|           const deletedHeaderLevel = toc[i].level;
   240|           toc.splice(i, 1);
   241|           for (
   242|             let j = i;
   243|             deletedHeaderLevel < toc[j].level && j < toc.length;
   244|             j++
   245|           ) {
   246|             toc.splice(j, 1) && j-- && i++;
   247|           }
   248|           i--;
   249|         }
   250|       }
   251|       const tree = this.cacheTree[currentPath] || genTree(toc, level);
   252|       html = treeTpl(tree, '<ul>{inner}</ul>');
   253|       this.cacheTree[currentPath] = tree;
   254|     }
   255|     return html;
   256|   }
   257|   /**
   258|    * Compile sub sidebar
   259|    * @param {Number} level Type of heading (h<level> tag)
   260|    * @returns {String} Sub-sidebar element
   261|    */
   262|   subSidebar(level) {
   263|     if (!level) {


# ====================================================================
# FILE: src/core/render/compiler/code.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-11 ---
     1| import Prism from 'prismjs';
     2| import 'prismjs/components/prism-markup-templating';
     3| export const highlightCodeCompiler = ({ renderer }) =>
     4|   (renderer.code = function(code, lang = '') {
     5|     const langOrMarkup = Prism.languages[lang] || Prism.languages.markup;
     6|     const text = Prism.highlight(
     7|       code.replace(/@DOCSIFY_QM@/g, '`'),
     8|       langOrMarkup
     9|     );
    10|     return `<pre v-pre data-lang="${lang}"><code class="lang-${lang}">${text}</code></pre>`;
    11|   });


# ====================================================================
# FILE: src/core/render/compiler/headline.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| import { getAndRemoveConfig } from '../utils';
     2| import { slugify } from './slugify';
     3| export const headingCompiler = ({ renderer, router, _self }) =>
     4|   (renderer.code = (text, level) => {
     5|     let { str, config } = getAndRemoveConfig(text);
     6|     const nextToc = { level, title: str };
     7|     if (/<!-- {docsify-ignore} -->/g.test(str)) {
     8|       str = str.replace('<!-- {docsify-ignore} -->', '');
     9|       nextToc.title = str;
    10|       nextToc.ignoreSubHeading = true;
    11|     }
    12|     if (/{docsify-ignore}/g.test(str)) {
    13|       str = str.replace('{docsify-ignore}', '');
    14|       nextToc.title = str;
    15|       nextToc.ignoreSubHeading = true;
    16|     }
    17|     if (/<!-- {docsify-ignore-all} -->/g.test(str)) {
    18|       str = str.replace('<!-- {docsify-ignore-all} -->', '');
    19|       nextToc.title = str;
    20|       nextToc.ignoreAllSubs = true;
    21|     }
    22|     if (/{docsify-ignore-all}/g.test(str)) {
    23|       str = str.replace('{docsify-ignore-all}', '');
    24|       nextToc.title = str;
    25|       nextToc.ignoreAllSubs = true;
    26|     }
    27|     const slug = slugify(config.id || str);
    28|     const url = router.toURL(router.getCurrentPath(), { id: slug });
    29|     nextToc.slug = url;
    30|     _self.toc.push(nextToc);
    31|     return `<h${level} id="${slug}"><a href="${url}" data-id="${slug}" class="anchor"><span>${str}</span></a></h${level}>`;
    32|   });


# ====================================================================
# FILE: src/core/render/compiler/link.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-49 ---
     9| }) =>
    10|   (renderer.link = (href, title = '', text) => {
    11|     let attrs = [];
    12|     const { str, config } = getAndRemoveConfig(title);
    13|     linkTarget = config.target || linkTarget;
    14|     linkRel =
    15|       linkTarget === '_blank'
    16|         ? compilerClass.config.externalLinkRel || 'noopener'
    17|         : '';
    18|     title = str;
    19|     if (
    20|       !isAbsolutePath(href) &&
    21|       !compilerClass._matchNotCompileLink(href) &&
    22|       !config.ignore
    23|     ) {
    24|       if (href === compilerClass.config.homepage) {
    25|         href = 'README';
    26|       }
    27|       href = router.toURL(href, null, router.getCurrentPath());
    28|     } else {
    29|       if (!isAbsolutePath(href) && href.startsWith('./')) {
    30|         href =
    31|           document.URL.replace(/\/(?!.*\/).*/, '/').replace('#/./', '') + href;
    32|       }
    33|       attrs.push(href.indexOf('mailto:') === 0 ? '' : `target="${linkTarget}"`);
    34|       attrs.push(
    35|         href.indexOf('mailto:') === 0
    36|           ? ''
    37|           : linkRel !== ''
    38|           ? ` rel="${linkRel}"`
    39|           : ''
    40|       );
    41|     }
    42|     if (
    43|       config.crossorgin &&
    44|       linkTarget === '_self' &&
    45|       compilerClass.config.routerMode === 'history'
    46|     ) {
    47|       if (compilerClass.config.crossOriginLinks.indexOf(href) === -1) {
    48|         compilerClass.config.crossOriginLinks.push(href);
    49|       }


# ====================================================================
# FILE: src/core/render/embed.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 3-43 ---
     3| import { merge } from '../util/core';
     4| const cached = {};
     5| function walkFetchEmbed({ embedTokens, compile, fetch }, cb) {
     6|   let token;
     7|   let step = 0;
     8|   let count = 1;
     9|   if (!embedTokens.length) {
    10|     return cb({});
    11|   }
    12|   while ((token = embedTokens[step++])) {
    13|     const next = (function(token) {
    14|       return text => {
    15|         let embedToken;
    16|         if (text) {
    17|           if (token.embed.type === 'markdown') {
    18|             let path = token.embed.url.split('/');
    19|             path.pop();
    20|             path = path.join('/');
    21|             text = text.replace(/\[([^[\]]+)\]\(([^)]+)\)/g, x => {
    22|               const linkBeginIndex = x.indexOf('(');
    23|               if (x.substring(linkBeginIndex).startsWith('(.')) {
    24|                 return (
    25|                   x.substring(0, linkBeginIndex) +
    26|                   `(${window.location.protocol}//${window.location.host}${path}/` +
    27|                   x.substring(linkBeginIndex + 1, x.length - 1) +
    28|                   ')'
    29|                 );
    30|               }
    31|               return x;
    32|             });
    33|             const frontMatterInstalled =
    34|               ($docsify.frontMatter || {}).installed || false;
    35|             if (frontMatterInstalled === true) {
    36|               text = $docsify.frontMatter.parseMarkdown(text);
    37|             }
    38|             embedToken = compile.lexer(text);
    39|           } else if (token.embed.type === 'code') {
    40|             if (token.embed.fragment) {
    41|               const fragment = token.embed.fragment;
    42|               const pattern = new RegExp(
    43|                 `(?:###|\\/\\/\\/)\\s*\\[${fragment}\\]([\\s\\S]*)(?:###|\\/\\/\\/)\\s*\\[${fragment}\\]`


# ====================================================================
# FILE: src/core/render/index.js
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-106 ---
     1| /* eslint-disable no-unused-vars */
     2| import tinydate from 'tinydate';
     3| import DOMPurify from 'dompurify';
     4| import * as dom from '../util/dom';
     5| import cssVars from '../util/polyfill/css-vars';
     6| import { callHook } from '../init/lifecycle';
     7| import { getAndActive, sticky } from '../event/sidebar';
     8| import { getPath, isAbsolutePath } from '../router/util';
     9| import { isMobile, inBrowser } from '../util/env';
    10| import { isPrimitive } from '../util/core';
    11| import { scrollActiveSidebar } from '../event/scroll';
    12| import { Compiler } from './compiler';
    13| import * as tpl from './tpl';
    14| import { prerenderEmbed } from './embed';
    15| function executeScript() {
    16|   const script = dom
    17|     .findAll('.markdown-section>script')
    18|     .filter(s => !/template/.test(s.type))[0];
    19|   if (!script) {
    20|     return false;
    21|   }
    22|   const code = script.innerText.trim();
    23|   if (!code) {
    24|     return false;
    25|   }
    26|   setTimeout(_ => {
    27|     window.__EXECUTE_RESULT__ = new Function(code)();
    28|   }, 0);
    29| }
    30| function formatUpdated(html, updated, fn) {
    31|   updated =
    32|     typeof fn === 'function'
    33|       ? fn(updated)
    34|       : typeof fn === 'string'
    35|       ? tinydate(fn)(new Date(updated))
    36|       : updated;
    37|   return html.replace(/{docsify-updated}/g, updated);
    38| }
    39| function renderMain(html) {
    40|   if (!html) {
    41|     html = '<h1>404 - Not found</h1>';
    42|   }
    43|   this._renderTo('.markdown-section', html);
    44|   !this.config.loadSidebar && this._renderSidebar();
    45|   if (
    46|     this.config.executeScript !== false &&
    47|     typeof window.Vue !== 'undefined' &&
    48|     !executeScript()
    49|   ) {
    50|     setTimeout(_ => {
    51|       const vueVM = window.__EXECUTE_RESULT__;
    52|       vueVM && vueVM.$destroy && vueVM.$destroy();
    53|       window.__EXECUTE_RESULT__ = new window.Vue().$mount('#main');
    54|     }, 0);
    55|   } else {
    56|     this.config.executeScript && executeScript();
    57|   }
    58| }
    59| function renderNameLink(vm) {
    60|   const el = dom.getNode('.app-name-link');
    61|   const nameLink = vm.config.nameLink;
    62|   const path = vm.route.path;
    63|   if (!el) {
    64|     return;
    65|   }
    66|   if (isPrimitive(vm.config.nameLink)) {
    67|     el.setAttribute('href', nameLink);
    68|   } else if (typeof nameLink === 'object') {
    69|     const match = Object.keys(nameLink).filter(
    70|       key => path.indexOf(key) > -1
    71|     )[0];
    72|     el.setAttribute('href', nameLink[match]);
    73|   }
    74| }
    75| export function renderMixin(proto) {
    76|   proto._renderTo = function(el, content, replace) {
    77|     const node = dom.getNode(el);
    78|     if (node) {
    79|       node[replace ? 'outerHTML' : 'innerHTML'] = content;
    80|     }
    81|   };
    82|   proto._renderSidebar = function(text) {
    83|     const { maxLevel, subMaxLevel, loadSidebar, hideSidebar } = this.config;
    84|     if (hideSidebar) {
    85|       document.querySelector('aside.sidebar').remove();
    86|       document.querySelector('button.sidebar-toggle').remove();
    87|       document.querySelector('section.content').style.right = 'unset';
    88|       document.querySelector('section.content').style.left = 'unset';
    89|       document.querySelector('section.content').style.position = 'relative';
    90|       document.querySelector('section.content').style.width = '100%';
    91|       return null;
    92|     }
    93|     this._renderTo('.sidebar-nav', this.compiler.sidebar(text, maxLevel));
    94|     const activeEl = getAndActive(this.router, '.sidebar-nav', true, true);
    95|     if (loadSidebar && activeEl) {
    96|       activeEl.parentNode.innerHTML +=
    97|         this.compiler.subSidebar(subMaxLevel) || '';
    98|     } else {
    99|       this.compiler.subSidebar();
   100|     }
   101|     this._bindEventOnRendered(activeEl);
   102|   };
   103|   proto._bindEventOnRendered = function(activeEl) {
   104|     const { autoHeader } = this.config;
   105|     scrollActiveSidebar(this.router);
   106|     if (autoHeader && activeEl) {

# --- HUNK 2: Lines 112-166 ---
   112|         dom.before(main, wrapper.children[0]);
   113|       }
   114|     }
   115|   };
   116|   proto._renderNav = function(text) {
   117|     text && this._renderTo('nav', this.compiler.compile(text));
   118|     if (this.config.loadNavbar) {
   119|       getAndActive(this.router, 'nav');
   120|     }
   121|   };
   122|   proto._renderMain = function(text, opt = {}, next) {
   123|     if (!text) {
   124|       return renderMain.call(this, text);
   125|     }
   126|     callHook(this, 'beforeEach', text, result => {
   127|       let html;
   128|       const callback = () => {
   129|         if (opt.updatedAt) {
   130|           html = formatUpdated(html, opt.updatedAt, this.config.formatUpdated);
   131|         }
   132|         callHook(this, 'afterEach', html, text => renderMain.call(this, text));
   133|       };
   134|       if (this.isHTML) {
   135|         html = this.result = text;
   136|         callback();
   137|         next();
   138|       } else {
   139|         prerenderEmbed(
   140|           {
   141|             compiler: this.compiler,
   142|             raw: result,
   143|           },
   144|           tokens => {
   145|             html = this.compiler.compile(tokens);
   146|             html = this.isRemoteUrl ? DOMPurify.sanitize(html) : html;
   147|             callback();
   148|             next();
   149|           }
   150|         );
   151|       }
   152|     });
   153|   };
   154|   proto._renderCover = function(text, coverOnly) {
   155|     const el = dom.getNode('.cover');
   156|     dom.toggleClass(
   157|       dom.getNode('main'),
   158|       coverOnly ? 'add' : 'remove',
   159|       'hidden'
   160|     );
   161|     if (!text) {
   162|       dom.toggleClass(el, 'remove', 'show');
   163|       return;
   164|     }
   165|     dom.toggleClass(el, 'add', 'show');
   166|     let html = this.coverIsHTML ? text : this.compiler.cover(text);

# --- HUNK 3: Lines 176-215 ---
   176|         if (!isAbsolutePath(m[1])) {
   177|           path = getPath(this.router.getBasePath(), m[1]);
   178|         }
   179|         el.style.backgroundImage = `url(${path})`;
   180|         el.style.backgroundSize = 'cover';
   181|         el.style.backgroundPosition = 'center center';
   182|       }
   183|       html = html.replace(m[0], '');
   184|     }
   185|     this._renderTo('.cover-main', html);
   186|     sticky();
   187|   };
   188|   proto._updateRender = function() {
   189|     renderNameLink(this);
   190|   };
   191| }
   192| export function initRender(vm) {
   193|   const config = vm.config;
   194|   vm.compiler = new Compiler(config, vm.router);
   195|   if (inBrowser) {
   196|     window.__current_docsify_compiler__ = vm.compiler;
   197|   }
   198|   const id = config.el || '#app';
   199|   const navEl = dom.find('nav') || dom.create('nav');
   200|   const el = dom.find(id);
   201|   let html = '';
   202|   let navAppendToTarget = dom.body;
   203|   if (el) {
   204|     if (config.repo) {
   205|       html += tpl.corner(config.repo, config.cornerExternalLinkTarge);
   206|     }
   207|     if (config.coverpage) {
   208|       html += tpl.cover();
   209|     }
   210|     if (config.logo) {
   211|       const isBase64 = /^data:image/.test(config.logo);
   212|       const isExternal = /(?:http[s]?:)?\/\//.test(config.logo);
   213|       const isRelative = /^\./.test(config.logo);
   214|       if (!isBase64 && !isExternal && !isRelative) {
   215|         config.logo = getPath(vm.router.getBasePath(), config.logo);


# ====================================================================
# FILE: src/core/render/slugify.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| import { hasOwn } from '../util/core';
     2| let cache = {};
     3| const re = /[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,./:;<=>?@[\]^`{|}~]/g;
     4| function lower(string) {
     5|   return string.toLowerCase();
     6| }
     7| export function slugify(str) {
     8|   if (typeof str !== 'string') {
     9|     return '';
    10|   }
    11|   let slug = str
    12|     .trim()
    13|     .replace(/[A-Z]+/g, lower)
    14|     .replace(/<[^>\d]+>/g, '')
    15|     .replace(re, '')
    16|     .replace(/\s/g, '-')
    17|     .replace(/-+/g, '-')
    18|     .replace(/^(\d)/, '_$1');
    19|   let count = cache[slug];
    20|   count = hasOwn.call(cache, slug) ? count + 1 : 0;
    21|   cache[slug] = count;
    22|   if (count) {
    23|     slug = slug + '-' + count;
    24|   }
    25|   return slug;
    26| }
    27| slugify.clear = function() {
    28|   cache = {};
    29| };


# ====================================================================
# FILE: src/core/render/tpl.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 64-96 ---
    64|     `hsl(${Math.floor(Math.random() * 255) + SL}) 100%)`;
    65|   return (
    66|     `<section class="cover show" style="background: ${bgc}">` +
    67|     '<div class="mask"></div>' +
    68|     '<div class="cover-main"><!--cover--></div>' +
    69|     '</section>'
    70|   );
    71| }
    72| /**
    73|  * Render tree
    74|  * @param  {Array} toc Array of TOC section links
    75|  * @param  {String} tpl TPL list
    76|  * @return {String} Rendered tree
    77|  */
    78| export function tree(toc, tpl = '<ul class="app-sub-sidebar">{inner}</ul>') {
    79|   if (!toc || !toc.length) {
    80|     return '';
    81|   }
    82|   let innerHTML = '';
    83|   toc.forEach(node => {
    84|     innerHTML += `<li><a class="section-link" href="${node.slug}" title="${node.title}">${node.title}</a></li>`;
    85|     if (node.children) {
    86|       innerHTML += tree(node.children, tpl);
    87|     }
    88|   });
    89|   return tpl.replace('{inner}', innerHTML);
    90| }
    91| export function helper(className, content) {
    92|   return `<p class="${className}">${content.slice(5).trim()}</p>`;
    93| }
    94| export function theme(color) {
    95|   return `<style>:root{--theme-color: ${color};}</style>`;
    96| }


# ====================================================================
# FILE: src/core/render/utils.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 18-37 ---
    18|  *
    19|  * @return {object}  The original string and parsed object, { str, config }.
    20|  */
    21| export function getAndRemoveConfig(str = '') {
    22|   const config = {};
    23|   if (str) {
    24|     str = str
    25|       .replace(/^'/, '')
    26|       .replace(/'$/, '')
    27|       .replace(/(?:^|\s):([\w-]+:?)=?([\w-%]+)?/g, (m, key, value) => {
    28|         if (key.indexOf(':') === -1) {
    29|           config[key] = (value && value.replace(/&quot;/g, '')) || true;
    30|           return '';
    31|         }
    32|         return m;
    33|       })
    34|       .trim();
    35|   }
    36|   return { str, config };
    37| }


# ====================================================================
# FILE: src/core/router/history/hash.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-37 ---
     1| import { noop } from '../../util/core';
     2| import { on } from '../../util/dom';
     3| import { parseQuery, cleanPath, replaceSlug } from '../util';
     4| import { History } from './base';
     5| function replaceHash(path) {
     6|   const i = location.href.indexOf('#');
     7|   location.replace(location.href.slice(0, i >= 0 ? i : 0) + '#' + path);
     8| }
     9| export class HashHistory extends History {
    10|   constructor(config) {
    11|     super(config);
    12|     this.mode = 'hash';
    13|   }
    14|   getBasePath() {
    15|     const path = window.location.pathname || '';
    16|     const base = this.config.basePath;
    17|     return /^(\/|https?:)/g.test(base) ? base : cleanPath(path + '/' + base);
    18|   }
    19|   getCurrentPath() {
    20|     const href = location.href;
    21|     const index = href.indexOf('#');
    22|     return index === -1 ? '' : href.slice(index + 1);
    23|   }
    24|   onchange(cb = noop) {
    25|     let navigating = false;
    26|     on('click', e => {
    27|       const el = e.target.tagName === 'A' ? e.target : e.target.parentNode;
    28|       if (el && el.tagName === 'A' && !/_blank/.test(el.target)) {
    29|         navigating = true;
    30|       }
    31|     });
    32|     on('hashchange', e => {
    33|       const source = navigating ? 'navigate' : 'history';
    34|       navigating = false;
    35|       cb({ event: e, source });
    36|     });
    37|   }


# ====================================================================
# FILE: src/core/router/util.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 39-64 ---
    39|   }
    40|   const matchingParts = path.match(/(\S*\/)[^/]+$/);
    41|   return matchingParts ? matchingParts[1] : '';
    42| });
    43| export const cleanPath = cached(path => {
    44|   return path.replace(/^\/+/, '/').replace(/([^:])\/{2,}/g, '$1/');
    45| });
    46| export const resolvePath = cached(path => {
    47|   const segments = path.replace(/^\//, '').split('/');
    48|   let resolved = [];
    49|   for (let i = 0, len = segments.length; i < len; i++) {
    50|     const segment = segments[i];
    51|     if (segment === '..') {
    52|       resolved.pop();
    53|     } else if (segment !== '.') {
    54|       resolved.push(segment);
    55|     }
    56|   }
    57|   return '/' + resolved.join('/');
    58| });
    59| export function getPath(...args) {
    60|   return cleanPath(args.join('/'));
    61| }
    62| export const replaceSlug = cached(path => {
    63|   return path.replace('#', '?id=');
    64| });


# ====================================================================
# FILE: src/plugins/emoji.js
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| const AllGithubEmoji = {
     2|   '100': 'unicode/1f4af',
     3|   '1234': 'unicode/1f522',
     4|   '+1': 'unicode/1f44d',
     5|   '-1': 'unicode/1f44e',
     6|   '1st_place_medal': 'unicode/1f947',
     7|   '2nd_place_medal': 'unicode/1f948',
     8|   '3rd_place_medal': 'unicode/1f949',
     9|   '8ball': 'unicode/1f3b1',
    10|   a: 'unicode/1f170',
    11|   ab: 'unicode/1f18e',
    12|   abacus: 'unicode/1f9ee',
    13|   abc: 'unicode/1f524',
    14|   abcd: 'unicode/1f521',
    15|   accept: 'unicode/1f251',
    16|   adhesive_bandage: 'unicode/1fa79',
    17|   adult: 'unicode/1f9d1',
    18|   aerial_tramway: 'unicode/1f6a1',
    19|   afghanistan: 'unicode/1f1e6-1f1eb',
    20|   airplane: 'unicode/2708',

# --- HUNK 2: Lines 1782-1810 ---
  1782|   yellow_circle: 'unicode/1f7e1',
  1783|   yellow_heart: 'unicode/1f49b',
  1784|   yellow_square: 'unicode/1f7e8',
  1785|   yemen: 'unicode/1f1fe-1f1ea',
  1786|   yen: 'unicode/1f4b4',
  1787|   yin_yang: 'unicode/262f',
  1788|   yo_yo: 'unicode/1fa80',
  1789|   yum: 'unicode/1f60b',
  1790|   zambia: 'unicode/1f1ff-1f1f2',
  1791|   zany_face: 'unicode/1f92a',
  1792|   zap: 'unicode/26a1',
  1793|   zebra: 'unicode/1f993',
  1794|   zero: 'unicode/0030-20e3',
  1795|   zimbabwe: 'unicode/1f1ff-1f1fc',
  1796|   zipper_mouth_face: 'unicode/1f910',
  1797|   zombie: 'unicode/1f9df',
  1798|   zombie_man: 'unicode/1f9df-2642',
  1799|   zombie_woman: 'unicode/1f9df-2640',
  1800|   zzz: 'unicode/1f4a4',
  1801| };
  1802| window.emojify = function(match, $1) {
  1803|   return AllGithubEmoji.hasOwnProperty($1) === false
  1804|     ? match
  1805|     : '<img class="emoji" src="https://github.githubassets.com/images/icons/emoji/' +
  1806|         AllGithubEmoji[$1] +
  1807|         '.png" alt="' +
  1808|         $1 +
  1809|         '" />';
  1810| };


# ====================================================================
# FILE: src/plugins/search/search.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 37-199 ---
    37|         path &&
    38|         paths.indexOf(path) === -1 &&
    39|         !Docsify.util.isAbsolutePath(originHref)
    40|       ) {
    41|         paths.push(path);
    42|       }
    43|     });
    44|   return paths;
    45| }
    46| function getTableData(token) {
    47|   if (!token.text && token.type === 'table') {
    48|     token.cells.unshift(token.header);
    49|     token.text = token.cells
    50|       .map(function(rows) {
    51|         return rows.join(' | ');
    52|       })
    53|       .join(' |\n ');
    54|   }
    55|   return token.text;
    56| }
    57| function saveData(maxAge, expireKey, indexKey) {
    58|   localStorage.setItem(expireKey, Date.now() + maxAge);
    59|   localStorage.setItem(indexKey, JSON.stringify(INDEXS));
    60| }
    61| export function genIndex(path, content = '', router, depth) {
    62|   const tokens = window.marked.lexer(content);
    63|   const slugify = window.Docsify.slugify;
    64|   const index = {};
    65|   let slug;
    66|   tokens.forEach(token => {
    67|     if (token.type === 'heading' && token.depth <= depth) {
    68|       const { str, config } = getAndRemoveConfig(token.text);
    69|       if (config.id) {
    70|         slug = router.toURL(path, { id: slugify(config.id) });
    71|       } else {
    72|         slug = router.toURL(path, { id: slugify(escapeHtml(token.text)) });
    73|       }
    74|       index[slug] = { slug, title: str, body: '' };
    75|     } else {
    76|       if (!slug) {
    77|         return;
    78|       }
    79|       if (!index[slug]) {
    80|         index[slug] = { slug, title: '', body: '' };
    81|       } else if (index[slug].body) {
    82|         token.text = getTableData(token);
    83|         index[slug].body += '\n' + (token.text || '');
    84|       } else {
    85|         token.text = getTableData(token);
    86|         index[slug].body = index[slug].body
    87|           ? index[slug].body + token.text
    88|           : token.text;
    89|       }
    90|     }
    91|   });
    92|   slugify.clear();
    93|   return index;
    94| }
    95| /**
    96|  * @param {String} query Search query
    97|  * @returns {Array} Array of results
    98|  */
    99| export function search(query) {
   100|   const matchingResults = [];
   101|   let data = [];
   102|   Object.keys(INDEXS).forEach(key => {
   103|     data = data.concat(Object.keys(INDEXS[key]).map(page => INDEXS[key][page]));
   104|   });
   105|   query = query.trim();
   106|   let keywords = query.split(/[\s\-\\/]+/);
   107|   if (keywords.length !== 1) {
   108|     keywords = [].concat(query, keywords);
   109|   }
   110|   for (let i = 0; i < data.length; i++) {
   111|     const post = data[i];
   112|     let matchesScore = 0;
   113|     let resultStr = '';
   114|     const postTitle = post.title && post.title.trim();
   115|     const postContent = post.body && post.body.trim();
   116|     const postUrl = post.slug || '';
   117|     if (postTitle) {
   118|       keywords.forEach(keyword => {
   119|         const regEx = new RegExp(
   120|           keyword.replace(/[|\\{}()[\]^$+*?.]/g, '\\$&'),
   121|           'gi'
   122|         );
   123|         let indexTitle = -1;
   124|         let indexContent = -1;
   125|         indexTitle = postTitle ? postTitle.search(regEx) : -1;
   126|         indexContent = postContent ? postContent.search(regEx) : -1;
   127|         if (indexTitle >= 0 || indexContent >= 0) {
   128|           matchesScore += indexTitle >= 0 ? 3 : indexContent >= 0 ? 2 : 0;
   129|           if (indexContent < 0) {
   130|             indexContent = 0;
   131|           }
   132|           let start = 0;
   133|           let end = 0;
   134|           start = indexContent < 11 ? 0 : indexContent - 10;
   135|           end = start === 0 ? 70 : indexContent + keyword.length + 60;
   136|           if (postContent && end > postContent.length) {
   137|             end = postContent.length;
   138|           }
   139|           const matchContent =
   140|             '...' +
   141|             escapeHtml(postContent)
   142|               .substring(start, end)
   143|               .replace(
   144|                 regEx,
   145|                 word => `<em class="search-keyword">${word}</em>`
   146|               ) +
   147|             '...';
   148|           resultStr += matchContent;
   149|         }
   150|       });
   151|       if (matchesScore > 0) {
   152|         const matchingPost = {
   153|           title: escapeHtml(postTitle),
   154|           content: postContent ? resultStr : '',
   155|           url: postUrl,
   156|           score: matchesScore,
   157|         };
   158|         matchingResults.push(matchingPost);
   159|       }
   160|     }
   161|   }
   162|   return matchingResults.sort((r1, r2) => r2.score - r1.score);
   163| }
   164| export function init(config, vm) {
   165|   const isAuto = config.paths === 'auto';
   166|   const paths = isAuto ? getAllPaths(vm.router) : config.paths;
   167|   let namespaceSuffix = '';
   168|   if (isAuto && config.pathNamespaces) {
   169|     const path = paths[0];
   170|     if (Array.isArray(config.pathNamespaces)) {
   171|       namespaceSuffix =
   172|         config.pathNamespaces.find(prefix => path.startsWith(prefix)) ||
   173|         namespaceSuffix;
   174|     } else if (config.pathNamespaces instanceof RegExp) {
   175|       const matches = path.match(config.pathNamespaces);
   176|       if (matches) {
   177|         namespaceSuffix = matches[0];
   178|       }
   179|     }
   180|   }
   181|   const expireKey = resolveExpireKey(config.namespace) + namespaceSuffix;
   182|   const indexKey = resolveIndexKey(config.namespace) + namespaceSuffix;
   183|   const isExpired = localStorage.getItem(expireKey) < Date.now();
   184|   INDEXS = JSON.parse(localStorage.getItem(indexKey));
   185|   if (isExpired) {
   186|     INDEXS = {};
   187|   } else if (!isAuto) {
   188|     return;
   189|   }
   190|   const len = paths.length;
   191|   let count = 0;
   192|   paths.forEach(path => {
   193|     if (INDEXS[path]) {
   194|       return count++;
   195|     }
   196|     Docsify.get(vm.router.getFile(path), false, vm.config.requestHeaders).then(
   197|       result => {
   198|         INDEXS[path] = genIndex(path, result, vm.router, config.depth);
   199|         len === ++count && saveData(config.maxAge, expireKey, indexKey);

