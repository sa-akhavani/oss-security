# ====================================================================
# FILE: clients/admin-ui/src/features/datastore-connections/system_portal_config/forms/ConnectorParametersForm.tsx
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-169 ---
     1| import {
     2|   Button,
     3|   ButtonGroup,
     4|   CircleHelpIcon,
     5|   Flex,
     6|   FormControl,
     7|   FormErrorMessage,
     8|   FormLabel,
     9|   Input,
    10|   isNumeric,
    11|   NumberDecrementStepper,
    12|   NumberIncrementStepper,
    13|   NumberInput,
    14|   NumberInputField,
    15|   NumberInputStepper,
    16|   Tooltip,
    17|   VStack,
    18| } from "@fidesui/react";
    19| import { Option } from "common/form/inputs";
    20| import {
    21|   ConnectionTypeSecretSchemaProperty,
    22|   ConnectionTypeSecretSchemaReponse,
    23| } from "connection-type/types";
    24| import { useLazyGetDatastoreConnectionStatusQuery } from "datastore-connections/datastore-connection.slice";
    25| import DSRCustomizationModal from "datastore-connections/system_portal_config/forms/DSRCustomizationForm/DSRCustomizationModal";
    26| import { Field, FieldInputProps, Form, Formik, FormikProps } from "formik";
    27| import React from "react";
    28| import { DatastoreConnectionStatus } from "src/features/datastore-connections/types";
    29| import DatasetConfigField from "~/features/datastore-connections/system_portal_config/forms/fields/DatasetConfigField/DatasetConfigField";
    30| import {
    31|   ConnectionConfigurationResponse,
    32|   ConnectionSystemTypeMap,
    33|   ConnectionType,
    34|   SystemType,
    35| } from "~/types/api";
    36| import DeleteConnectionModal from "../DeleteConnectionModal";
    37| import { ConnectionConfigFormValues } from "../types";
    38| import { fillInDefaults } from "./helpers";
    39| const FIDES_DATASET_REFERENCE = "#/definitions/FidesDatasetReference";
    40| export interface TestConnectionResponse {
    41|   data?: DatastoreConnectionStatus;
    42|   fulfilledTimeStamp?: number;
    43| }
    44| type ConnectorParametersFormProps = {
    45|   secretsSchema?: ConnectionTypeSecretSchemaReponse;
    46|   defaultValues: ConnectionConfigFormValues;
    47|   isSubmitting: boolean;
    48|   /**
    49|    * Parent callback when Save is clicked
    50|    */
    51|   onSaveClick: (values: any, actions: any) => void;
    52|   /**
    53|    * Parent callback when Test Connection is clicked
    54|    */
    55|   onTestConnectionClick: (value: TestConnectionResponse) => void;
    56|   /**
    57|    * Text for the test button. Defaults to "Test connection"
    58|    */
    59|   testButtonLabel?: string;
    60|   connectionConfig?: ConnectionConfigurationResponse;
    61|   connectionOption: ConnectionSystemTypeMap;
    62|   isCreatingConnectionConfig: boolean;
    63|   datasetDropdownOptions: Option[];
    64|   onDelete: (id: string) => void;
    65|   deleteResult: any;
    66| };
    67| const ConnectorParametersForm: React.FC<ConnectorParametersFormProps> = ({
    68|   secretsSchema,
    69|   defaultValues,
    70|   isSubmitting = false,
    71|   onSaveClick,
    72|   onTestConnectionClick,
    73|   testButtonLabel = "Test integration",
    74|   connectionOption,
    75|   connectionConfig,
    76|   datasetDropdownOptions,
    77|   isCreatingConnectionConfig,
    78|   onDelete,
    79|   deleteResult,
    80| }) => {
    81|   const [trigger, { isLoading, isFetching }] =
    82|     useLazyGetDatastoreConnectionStatusQuery();
    83|   const validateConnectionIdentifier = (value: string) => {
    84|     let error;
    85|     if (typeof value === "undefined" || value === "") {
    86|       error = "Integration Identifier is required";
    87|     }
    88|     if (value && isNumeric(value)) {
    89|       error = "Integration Identifier must be an alphanumeric value";
    90|     }
    91|     return error;
    92|   };
    93|   const validateField = (label: string, value: string, type?: string) => {
    94|     let error;
    95|     if (typeof value === "undefined" || value === "") {
    96|       error = `${label} is required`;
    97|     }
    98|     if (type === FIDES_DATASET_REFERENCE) {
    99|       if (!value.includes(".")) {
   100|         error = "Dataset reference must be dot delimited";
   101|       } else {
   102|         const parts = value.split(".");
   103|         if (parts.length < 3) {
   104|           error = "Dataset reference must include at least three parts";
   105|         }
   106|       }
   107|     }
   108|     return error;
   109|   };
   110|   const getFormLabel = (id: string, value: string): JSX.Element => (
   111|     <FormLabel
   112|       color="gray.900"
   113|       fontSize="14px"
   114|       fontWeight="semibold"
   115|       htmlFor={id}
   116|       minWidth="150px"
   117|     >
   118|       {value}
   119|     </FormLabel>
   120|   );
   121|   const getPlaceholder = (item: ConnectionTypeSecretSchemaProperty) => {
   122|     if (item.allOf?.[0].$ref === FIDES_DATASET_REFERENCE) {
   123|       return "Enter dataset.collection.field";
   124|     }
   125|     return undefined;
   126|   };
   127|   const isRequiredSecretValue = (key: string): boolean =>
   128|     secretsSchema?.required?.includes(key) ||
   129|     (secretsSchema?.properties?.[key] !== undefined &&
   130|       "default" in secretsSchema.properties[key]);
   131|   const getFormField = (
   132|     key: string,
   133|     item: ConnectionTypeSecretSchemaProperty
   134|   ): JSX.Element => (
   135|     <Field
   136|       id={key}
   137|       name={key}
   138|       key={key}
   139|       validate={
   140|         isRequiredSecretValue(key) || item.type === "integer"
   141|           ? (value: string) =>
   142|               validateField(item.title, value, item.allOf?.[0].$ref)
   143|           : false
   144|       }
   145|     >
   146|       {({ field, form }: { field: FieldInputProps<string>; form: any }) => (
   147|         <FormControl
   148|           display="flex"
   149|           isRequired={isRequiredSecretValue(key)}
   150|           isInvalid={form.errors[key] && form.touched[key]}
   151|         >
   152|           {getFormLabel(key, item.title)}
   153|           <VStack align="flex-start" w="inherit">
   154|             {item.type !== "integer" && (
   155|               <Input
   156|                 {...field}
   157|                 placeholder={getPlaceholder(item)}
   158|                 autoComplete="off"
   159|                 color="gray.700"
   160|                 size="sm"
   161|               />
   162|             )}
   163|             {item.type === "integer" && (
   164|               <NumberInput
   165|                 allowMouseWheel
   166|                 color="gray.700"
   167|                 defaultValue={0}
   168|                 min={0}
   169|                 size="sm"

# --- HUNK 2: Lines 211-339 ---
   211|   const handleSubmit = (values: any, actions: any) => {
   212|     const updatedValues = { ...values };
   213|     if (secretsSchema) {
   214|       Object.keys(secretsSchema.properties).forEach((key) => {
   215|         if (
   216|           secretsSchema.properties[key].allOf?.[0].$ref ===
   217|           FIDES_DATASET_REFERENCE
   218|         ) {
   219|           const referencePath = values[key].split(".");
   220|           updatedValues[key] = {
   221|             dataset: referencePath.shift(),
   222|             field: referencePath.join("."),
   223|             direction: "from",
   224|           };
   225|         }
   226|       });
   227|     }
   228|     onSaveClick(updatedValues, actions);
   229|   };
   230|   const handleTestConnectionClick = async () => {
   231|     const result = await trigger(connectionConfig!.key);
   232|     onTestConnectionClick(result);
   233|   };
   234|   return (
   235|     <Formik
   236|       enableReinitialize
   237|       initialValues={getInitialValues()}
   238|       onSubmit={handleSubmit}
   239|       validateOnBlur={false}
   240|       validateOnChange={false}
   241|     >
   242|       {/* @ts-ignore */}
   243|       {(props: FormikProps<Values>) => (
   244|         <Form noValidate>
   245|           <VStack align="stretch" gap="16px">
   246|             {/* Connection Identifier */}
   247|             {connectionOption.type !== SystemType.MANUAL ? (
   248|               <Field
   249|                 id="instance_key"
   250|                 name="instance_key"
   251|                 validate={validateConnectionIdentifier}
   252|               >
   253|                 {({ field }: { field: FieldInputProps<string> }) => (
   254|                   <FormControl
   255|                     display="flex"
   256|                     isRequired
   257|                     isInvalid={
   258|                       props.errors.instance_key && props.touched.instance_key
   259|                     }
   260|                   >
   261|                     {getFormLabel("instance_key", "Integration Identifier")}
   262|                     <VStack align="flex-start" w="inherit">
   263|                       <Input
   264|                         {...field}
   265|                         autoComplete="off"
   266|                         color="gray.700"
   267|                         isDisabled={!!connectionConfig?.key}
   268|                         placeholder={`A unique identifier for your new ${
   269|                           connectionOption!.human_readable
   270|                         } integration`}
   271|                         size="sm"
   272|                       />
   273|                       <FormErrorMessage>
   274|                         {props.errors.instance_key}
   275|                       </FormErrorMessage>
   276|                     </VStack>
   277|                     <Tooltip
   278|                       aria-label="The fides_key will allow fidesops to associate dataset field references appropriately. Must be a unique alphanumeric value with no spaces (underscores allowed) to represent this integration."
   279|                       hasArrow
   280|                       label="The fides_key will allow fidesops to associate dataset field references appropriately. Must be a unique alphanumeric value with no spaces (underscores allowed) to represent this integration."
   281|                       placement="right-start"
   282|                       openDelay={500}
   283|                     >
   284|                       <Flex alignItems="center" h="32px">
   285|                         <CircleHelpIcon
   286|                           marginLeft="8px"
   287|                           _hover={{ cursor: "pointer" }}
   288|                         />
   289|                       </Flex>
   290|                     </Tooltip>
   291|                   </FormControl>
   292|                 )}
   293|               </Field>
   294|             ) : null}
   295|             {/* Dynamic connector secret fields */}
   296|             {connectionOption.type !== SystemType.MANUAL && secretsSchema
   297|               ? Object.entries(secretsSchema.properties).map(([key, item]) => {
   298|                   if (key === "advanced_settings") {
   299|                     return null;
   300|                   }
   301|                   return getFormField(key, item);
   302|                 })
   303|               : null}
   304|             {SystemType.DATABASE === connectionOption.type &&
   305|             !isCreatingConnectionConfig ? (
   306|               <DatasetConfigField
   307|                 dropdownOptions={datasetDropdownOptions}
   308|                 connectionConfig={connectionConfig}
   309|               />
   310|             ) : null}
   311|             <ButtonGroup size="sm" spacing="8px" variant="outline">
   312|               <Button
   313|                 colorScheme="gray.700"
   314|                 isDisabled={
   315|                   !connectionConfig?.key ||
   316|                   isSubmitting ||
   317|                   deleteResult.isLoading
   318|                 }
   319|                 isLoading={isLoading || isFetching}
   320|                 loadingText="Testing"
   321|                 onClick={handleTestConnectionClick}
   322|                 variant="outline"
   323|               >
   324|                 {testButtonLabel}
   325|               </Button>
   326|               {connectionOption.type === SystemType.MANUAL &&
   327|               connectionConfig ? (
   328|                 <DSRCustomizationModal connectionConfig={connectionConfig} />
   329|               ) : null}
   330|               <Button
   331|                 bg="primary.800"
   332|                 color="white"
   333|                 isDisabled={deleteResult.isLoading || isSubmitting}
   334|                 isLoading={isSubmitting}
   335|                 loadingText="Submitting"
   336|                 size="sm"
   337|                 variant="solid"
   338|                 type="submit"
   339|                 _active={{ bg: "primary.500" }}


# ====================================================================
# FILE: clients/admin-ui/src/features/datastore-connections/system_portal_config/forms/fields/DatasetConfigField/DatasetConfigField.tsx
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 225-258 ---
   225|     if (allDatasets && datasetDropdownOption.value) {
   226|       const matchingDataset = allDatasets.find(
   227|         (d) => d.fides_key === datasetDropdownOption.value
   228|       );
   229|       if (matchingDataset) {
   230|         setDatasetYaml(matchingDataset);
   231|       }
   232|     }
   233|   }, [allDatasets, datasetDropdownOption.value, setDatasetYaml]);
   234|   return (
   235|     <Flex flexDirection="row">
   236|       <DatasetSelect
   237|         label="Dataset"
   238|         labelProps={{
   239|           fontWeight: "semibold",
   240|           fontSize: "sm",
   241|           minWidth: "150px",
   242|         }}
   243|         name={fieldName}
   244|         options={dropdownOptions}
   245|         onOpen={onOpen}
   246|         isLoading={isLoading}
   247|       />
   248|       <YamlEditorModal
   249|         isOpen={isOpen}
   250|         onClose={onClose}
   251|         onChange={setDatasetYaml}
   252|         isDatasetSelected={!!datasetDropdownOption.value}
   253|         dataset={datasetYaml.value}
   254|       />
   255|     </Flex>
   256|   );
   257| };
   258| export default DatasetConfigField;


# ====================================================================
# FILE: clients/admin-ui/src/features/system/system.slice.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 23-63 ---
    23|       providesTags: () => ["System"],
    24|     }),
    25|     getSystemByFidesKey: build.query<SystemResponse, string>({
    26|       query: (fides_key) => ({ url: `system/${fides_key}/` }),
    27|       providesTags: ["System"],
    28|     }),
    29|     createSystem: build.mutation<System, System | unknown>({
    30|       query: (body) => ({
    31|         url: `system/`,
    32|         method: "POST",
    33|         body,
    34|       }),
    35|       invalidatesTags: () => ["Datamap", "System", "Datastore Connection"],
    36|     }),
    37|     deleteSystem: build.mutation<SystemDeleteResponse, string>({
    38|       query: (key) => ({
    39|         url: `system/${key}`,
    40|         params: { resource_type: "system" },
    41|         method: "DELETE",
    42|       }),
    43|       invalidatesTags: ["System", "Datastore Connection", "Privacy Notices"],
    44|     }),
    45|     upsertSystems: build.mutation<UpsertResponse, System[]>({
    46|       query: (systems) => ({
    47|         url: `/system/upsert`,
    48|         method: "POST",
    49|         body: systems,
    50|       }),
    51|       invalidatesTags: ["Datamap", "System", "Datastore Connection"],
    52|     }),
    53|     updateSystem: build.mutation<
    54|       SystemResponse,
    55|       Partial<System> & Pick<System, "fides_key">
    56|     >({
    57|       query: ({ ...patch }) => ({
    58|         url: `system/`,
    59|         params: { resource_type: "system" },
    60|         method: "PUT",
    61|         body: patch,
    62|       }),
    63|       invalidatesTags: [


# ====================================================================
# FILE: clients/fides-js/src/fides.ts
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 49-103 ---
    49| import { shopify } from "./integrations/shopify";
    50| import { getConsentContext } from "./lib/consent-context";
    51| import { initOverlay } from "./lib/consent";
    52| import {
    53|   CookieKeyConsent,
    54|   CookieIdentity,
    55|   CookieMeta,
    56|   getOrMakeFidesCookie,
    57|   makeConsentDefaultsLegacy,
    58|   buildCookieConsentForExperiences,
    59|   FidesCookie,
    60|   isNewFidesCookie,
    61| } from "./lib/cookie";
    62| import {
    63|   PrivacyExperience,
    64|   FidesConfig,
    65|   FidesOptions,
    66|   UserGeolocation,
    67|   ConsentMethod,
    68|   SaveConsentPreference,
    69|   ConsentMechanism,
    70| } from "./lib/consent-types";
    71| import {
    72|   constructFidesRegionString,
    73|   debugLog,
    74|   experienceIsValid,
    75|   transformConsentToFidesUserPreference,
    76|   validateOptions,
    77| } from "./lib/consent-utils";
    78| import { dispatchFidesEvent } from "./lib/events";
    79| import { fetchExperience } from "./services/fides/api";
    80| import { getGeolocation } from "./services/external/geolocation";
    81| import { OverlayProps } from "./components/Overlay";
    82| import { updateConsentPreferences } from "./lib/preferences";
    83| import { resolveConsentValue } from "./lib/consent-value";
    84| export type Fides = {
    85|   consent: CookieKeyConsent;
    86|   experience?: PrivacyExperience;
    87|   geolocation?: UserGeolocation;
    88|   options: FidesOptions;
    89|   fides_meta: CookieMeta;
    90|   gtm: typeof gtm;
    91|   identity: CookieIdentity;
    92|   init: typeof init;
    93|   initialized: boolean;
    94|   meta: typeof meta;
    95|   shopify: typeof shopify;
    96| };
    97| declare global {
    98|   interface Window {
    99|     Fides: Fides;
   100|   }
   101| }
   102| let _Fides: Fides;
   103| const retrieveEffectiveRegionString = async (

# --- HUNK 2: Lines 105-215 ---
   105|   options: FidesOptions
   106| ) => {
   107|   const fidesRegionString = constructFidesRegionString(geolocation);
   108|   if (!fidesRegionString) {
   109|     return constructFidesRegionString(
   110|       await getGeolocation(
   111|         options.isGeolocationEnabled,
   112|         options.geolocationApiUrl,
   113|         options.debug
   114|       )
   115|     );
   116|   }
   117|   return fidesRegionString;
   118| };
   119| const automaticallyApplyGPCPreferences = (
   120|   cookie: FidesCookie,
   121|   fidesRegionString: string | null,
   122|   fidesApiUrl: string,
   123|   effectiveExperience?: PrivacyExperience | null
   124| ) => {
   125|   if (!effectiveExperience || !effectiveExperience.privacy_notices) {
   126|     return;
   127|   }
   128|   const context = getConsentContext();
   129|   if (!context.globalPrivacyControl) {
   130|     return;
   131|   }
   132|   let gpcApplied = false;
   133|   const consentPreferencesToSave = effectiveExperience.privacy_notices.map(
   134|     (notice) => {
   135|       if (
   136|         notice.has_gpc_flag &&
   137|         !notice.current_preference &&
   138|         notice.consent_mechanism !== ConsentMechanism.NOTICE_ONLY
   139|       ) {
   140|         gpcApplied = true;
   141|         return new SaveConsentPreference(
   142|           notice,
   143|           transformConsentToFidesUserPreference(false, notice.consent_mechanism)
   144|         );
   145|       }
   146|       return new SaveConsentPreference(
   147|         notice,
   148|         transformConsentToFidesUserPreference(
   149|           resolveConsentValue(notice, context),
   150|           notice.consent_mechanism
   151|         )
   152|       );
   153|     }
   154|   );
   155|   if (gpcApplied) {
   156|     updateConsentPreferences({
   157|       consentPreferencesToSave,
   158|       experienceId: effectiveExperience.id,
   159|       fidesApiUrl,
   160|       consentMethod: ConsentMethod.gpc,
   161|       userLocationString: fidesRegionString || undefined,
   162|       cookie,
   163|     });
   164|   }
   165| };
   166| /**
   167|  * Initialize the global Fides object with the given configuration values
   168|  */
   169| const init = async ({
   170|   consent,
   171|   experience,
   172|   geolocation,
   173|   options,
   174| }: FidesConfig) => {
   175|   const context = getConsentContext();
   176|   const consentDefaults = makeConsentDefaultsLegacy(
   177|     consent,
   178|     context,
   179|     options.debug
   180|   );
   181|   const cookie: FidesCookie = getOrMakeFidesCookie(
   182|     consentDefaults,
   183|     options.debug
   184|   );
   185|   const hasExistingCookie = !isNewFidesCookie(cookie);
   186|   if (hasExistingCookie) {
   187|     _Fides.consent = cookie.consent;
   188|     _Fides.fides_meta = cookie.fides_meta;
   189|     _Fides.identity = cookie.identity;
   190|     _Fides.experience = experience;
   191|     _Fides.geolocation = geolocation;
   192|     _Fides.options = options;
   193|     _Fides.initialized = true;
   194|     dispatchFidesEvent("FidesInitialized", cookie, options.debug);
   195|     dispatchFidesEvent("FidesUpdated", cookie, options.debug);
   196|   }
   197|   let shouldInitOverlay: boolean = options.isOverlayEnabled;
   198|   let effectiveExperience: PrivacyExperience | undefined | null = experience;
   199|   let fidesRegionString: string | null = null;
   200|   if (shouldInitOverlay) {
   201|     if (!validateOptions(options)) {
   202|       debugLog(
   203|         options.debug,
   204|         "Invalid overlay options. Skipping overlay initialization.",
   205|         options
   206|       );
   207|       shouldInitOverlay = false;
   208|     }
   209|     fidesRegionString = await retrieveEffectiveRegionString(
   210|       geolocation,
   211|       options
   212|     );
   213|     if (!fidesRegionString) {
   214|       debugLog(
   215|         options.debug,

# --- HUNK 3: Lines 226-284 ---
   226|     }
   227|     if (
   228|       effectiveExperience &&
   229|       experienceIsValid(effectiveExperience, options)
   230|     ) {
   231|       cookie.consent = buildCookieConsentForExperiences(
   232|         effectiveExperience,
   233|         context,
   234|         options.debug
   235|       );
   236|       if (shouldInitOverlay) {
   237|         await initOverlay(<OverlayProps>{
   238|           experience: effectiveExperience,
   239|           fidesRegionString,
   240|           cookie,
   241|           options,
   242|         }).catch(() => {});
   243|       }
   244|     }
   245|   }
   246|   if (shouldInitOverlay) {
   247|     automaticallyApplyGPCPreferences(
   248|       cookie,
   249|       fidesRegionString,
   250|       options.fidesApiUrl,
   251|       effectiveExperience
   252|     );
   253|   }
   254|   _Fides.consent = cookie.consent;
   255|   _Fides.fides_meta = cookie.fides_meta;
   256|   _Fides.identity = cookie.identity;
   257|   _Fides.experience = experience;
   258|   _Fides.geolocation = geolocation;
   259|   _Fides.options = options;
   260|   _Fides.initialized = true;
   261|   if (!hasExistingCookie) {
   262|     dispatchFidesEvent("FidesInitialized", cookie, options.debug);
   263|   }
   264|   dispatchFidesEvent("FidesUpdated", cookie, options.debug);
   265| };
   266| _Fides = {
   267|   consent: {},
   268|   experience: undefined,
   269|   geolocation: {},
   270|   options: {
   271|     debug: true,
   272|     isOverlayEnabled: false,
   273|     isGeolocationEnabled: false,
   274|     geolocationApiUrl: "",
   275|     overlayParentId: null,
   276|     modalLinkId: null,
   277|     privacyCenterUrl: "",
   278|     fidesApiUrl: "",
   279|   },
   280|   fides_meta: {},
   281|   identity: {},
   282|   gtm,
   283|   init,
   284|   initialized: false,


# ====================================================================
# FILE: clients/fides-js/src/lib/consent-types.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 132-179 ---
   132|   privacy_experience_id?: string;
   133|   user_geography?: string;
   134|   method?: ConsentMethod;
   135| };
   136| export type ConsentOptionCreate = {
   137|   privacy_notice_history_id: string;
   138|   preference: UserConsentPreference;
   139| };
   140| export type Identity = {
   141|   phone_number?: string;
   142|   email?: string;
   143|   ga_client_id?: string;
   144|   ljt_readerID?: string;
   145|   fides_user_device_id?: string;
   146| };
   147| export enum RequestOrigin {
   148|   privacy_center = "privacy_center",
   149|   overlay = "overlay",
   150|   api = "api",
   151| }
   152| export enum GpcStatus {
   153|   /** GPC is not relevant for the consent option. */
   154|   NONE = "none",
   155|   /** GPC is enabled and consent matches the configured default. */
   156|   APPLIED = "applied",
   157|   /** GPC is enabled but consent has been set to override the configured default. */
   158|   OVERRIDDEN = "overridden",
   159| }
   160| export type ConditionalValue = {
   161|   value: boolean;
   162|   globalPrivacyControl: boolean;
   163| };
   164| /**
   165|  * A consent value can be a boolean:
   166|  *  - `true`: consent/opt-in
   167|  *  - `false`: revoke/opt-out
   168|  *
   169|  * A consent value can also be context-dependent, which means it will be decided based on
   170|  * information about the user's environment (browser). The `ConditionalValue` object maps the
   171|  * context conditions to the value that should be used:
   172|  *  - `value`: The default value if no context applies.
   173|  *  - `globalPrivacyControl`: The value to use if the user's browser has Global Privacy Control
   174|  *    enabled.
   175|  */
   176| export type ConsentValue = boolean | ConditionalValue;
   177| export type ConsentOption = {
   178|   cookieKeys: string[];
   179|   default?: ConsentValue;


# ====================================================================
# FILE: clients/fides-js/src/lib/preferences.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 56-77 ---
    56|   const privacyPreferenceCreate: PrivacyPreferencesRequest = {
    57|     browser_identity: cookie.identity,
    58|     preferences: fidesUserPreferences,
    59|     privacy_experience_id: experienceId,
    60|     user_geography: userLocationString,
    61|     method: consentMethod,
    62|   };
    63|   patchUserPreferenceToFidesServer(privacyPreferenceCreate, fidesApiUrl, debug);
    64|   debugLog(debug, "Updating window.Fides");
    65|   window.Fides.consent = cookie.consent;
    66|   debugLog(debug, "Saving preferences to cookie");
    67|   saveFidesCookie(cookie);
    68|   consentPreferencesToSave
    69|     .filter(
    70|       (preference) =>
    71|         preference.consentPreference === UserConsentPreference.OPT_OUT
    72|     )
    73|     .forEach((preference) => {
    74|       removeCookiesFromBrowser(preference.notice.cookies);
    75|     });
    76|   dispatchFidesEvent("FidesUpdated", cookie, debug);
    77| };


# ====================================================================
# FILE: clients/fides-js/src/services/fides/api.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 8-56 ---
     8|   PRIVACY_EXPERIENCE = "/privacy-experience",
     9|   PRIVACY_PREFERENCES = "/privacy-preferences",
    10| }
    11| /**
    12|  * Fetch the relevant experience based on user location and user device id (if exists).
    13|  * Fetches both Privacy Center and Overlay components, because GPC needs to work regardless of component
    14|  */
    15| export const fetchExperience = async (
    16|   userLocationString: string,
    17|   fidesApiUrl: string,
    18|   fidesUserDeviceId: string,
    19|   debug: boolean
    20| ): Promise<PrivacyExperience | null> => {
    21|   debugLog(
    22|     debug,
    23|     `Fetching experience for userId: ${fidesUserDeviceId} in location: ${userLocationString}`
    24|   );
    25|   const fetchOptions: RequestInit = {
    26|     method: "GET",
    27|     mode: "cors",
    28|     headers: [["Unescape-Safestr", "true"]],
    29|   };
    30|   const params = new URLSearchParams({
    31|     show_disabled: "false",
    32|     region: userLocationString,
    33|     component: ComponentType.OVERLAY,
    34|     has_notices: "true",
    35|     has_config: "true",
    36|     systems_applicable: "true",
    37|     fides_user_device_id: fidesUserDeviceId,
    38|   });
    39|   const response = await fetch(
    40|     `${fidesApiUrl}${FidesEndpointPaths.PRIVACY_EXPERIENCE}?${params}`,
    41|     fetchOptions
    42|   );
    43|   if (!response.ok) {
    44|     debugLog(
    45|       debug,
    46|       "Error getting experience from Fides API, returning null. Response:",
    47|       response
    48|     );
    49|     return null;
    50|   }
    51|   try {
    52|     const body = await response.json();
    53|     const experience = body.items && body.items[0];
    54|     if (!experience) {
    55|       debugLog(
    56|         debug,


# ====================================================================
# FILE: clients/privacy-center/components/consent/NoticeDrivenConsent.tsx
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| import { Divider, Stack, useToast } from "@fidesui/react";
     2| import React, { useEffect, useMemo, useState } from "react";
     3| import {
     4|   ConsentContext,
     5|   CookieKeyConsent,
     6|   getConsentContext,
     7|   getOrMakeFidesCookie,
     8|   removeCookiesFromBrowser,
     9|   saveFidesCookie,
    10|   transformUserPreferenceToBoolean,
    11|   getGpcStatusFromNotice,
    12|   PrivacyNotice,
    13| } from "fides-js";
    14| import { useAppSelector } from "~/app/hooks";
    15| import {
    16|   selectCurrentConsentPreferences,
    17|   selectUserRegion,
    18|   selectPrivacyExperience,
    19|   useUpdatePrivacyPreferencesMutation,
    20| } from "~/features/consent/consent.slice";
    21| import {
    22|   ConsentMechanism,
    23|   ConsentMethod,
    24|   ConsentOptionCreate,
    25|   PrivacyNoticeResponseWithUserPreferences,
    26|   PrivacyPreferencesRequest,
    27|   UserConsentPreference,
    28| } from "~/types/api";
    29| import { useRouter } from "next/router";
    30| import { inspectForBrowserIdentities } from "~/common/browser-identities";
    31| import { NoticeHistoryIdToPreference } from "~/features/consent/types";
    32| import { ErrorToastOptions, SuccessToastOptions } from "~/common/toast-options";
    33| import { useLocalStorage } from "~/common/hooks";
    34| import ConsentItem from "./ConsentItem";
    35| import SaveCancel from "./SaveCancel";
    36| import PrivacyPolicyLink from "./PrivacyPolicyLink";
    37| const resolveConsentValue = (
    38|   notice: PrivacyNoticeResponseWithUserPreferences,
    39|   context: ConsentContext
    40| ) => {

# --- HUNK 2: Lines 75-115 ---
    75|     return newPreferences;
    76|   }, [serverPreferences, experience, consentContext]);
    77|   const [draftPreferences, setDraftPreferences] =
    78|     useState<NoticeHistoryIdToPreference>(initialDraftPreferences);
    79|   useEffect(() => {
    80|     setDraftPreferences(initialDraftPreferences);
    81|   }, [initialDraftPreferences]);
    82|   const items = useMemo(() => {
    83|     if (!experience) {
    84|       return [];
    85|     }
    86|     const { privacy_notices: notices } = experience;
    87|     if (!notices || notices.length === 0) {
    88|       return [];
    89|     }
    90|     return notices.map((notice) => {
    91|       const preference = draftPreferences[notice.privacy_notice_history_id];
    92|       const value = transformUserPreferenceToBoolean(preference);
    93|       const gpcStatus = getGpcStatusFromNotice({
    94|         value,
    95|         notice: notice as PrivacyNotice,
    96|         consentContext,
    97|       });
    98|       return {
    99|         name: notice.name || "",
   100|         description: notice.description || "",
   101|         id: notice.id,
   102|         historyId: notice.privacy_notice_history_id,
   103|         highlight: false,
   104|         url: undefined,
   105|         value,
   106|         gpcStatus,
   107|         disabled: notice.consent_mechanism === ConsentMechanism.NOTICE_ONLY,
   108|       };
   109|     });
   110|   }, [consentContext, experience, draftPreferences]);
   111|   const handleCancel = () => {
   112|     router.push("/");
   113|   };
   114|   /**
   115|    * When saving, we need to:


# ====================================================================
# FILE: clients/privacy-center/cypress/e2e/consent-banner.cy.ts
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 161-201 ---
   161|           {},
   162|           {}
   163|         );
   164|       });
   165|       it("sets Fides.consent object with default consent based on legacy consent", () => {
   166|         cy.window().its("Fides").its("consent").should("eql", {
   167|           data_sales: true,
   168|           tracking: false,
   169|         });
   170|       });
   171|       it("does not render banner", () => {
   172|         cy.get("div#fides-banner").should("not.exist");
   173|         cy.contains("button", "Accept Test").should("not.exist");
   174|       });
   175|       it("does not render modal link", () => {
   176|         cy.get("#fides-modal-link").should("not.be.visible");
   177|       });
   178|     });
   179|   });
   180|   describe("when user has no saved consent cookie", () => {
   181|     describe("when overlay is enabled", () => {
   182|       beforeEach(() => {
   183|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   184|         stubConfig({
   185|           options: {
   186|             isOverlayEnabled: true,
   187|           },
   188|         });
   189|       });
   190|       it("should render the expected HTML banner", () => {
   191|         cy.get("div#fides-banner").within(() => {
   192|           cy.get(
   193|             "div#fides-banner-description.fides-banner-description"
   194|           ).contains(
   195|             "This test website is overriding the banner description label."
   196|           );
   197|           cy.get("div#fides-button-group").within(() => {
   198|             cy.get(
   199|               "button#fides-banner-button-tertiary.fides-banner-button.fides-banner-button-tertiary"
   200|             ).contains("Manage preferences");
   201|             cy.get(

# --- HUNK 2: Lines 577-703 ---
   577|       it("stores consent in cookie", () => {
   578|         cy.waitUntilCookieExists(CONSENT_COOKIE_NAME).then(() => {
   579|           cy.getCookie(CONSENT_COOKIE_NAME).then((cookie) => {
   580|             const cookieKeyConsent: FidesCookie = JSON.parse(
   581|               decodeURIComponent(cookie!.value)
   582|             );
   583|             expect(cookieKeyConsent.consent)
   584|               .property(PRIVACY_NOTICE_KEY_1)
   585|               .is.eql(false);
   586|           });
   587|         });
   588|       });
   589|       it("updates Fides consent obj", () => {
   590|         cy.window()
   591|           .its("Fides")
   592|           .its("consent")
   593|           .should("eql", {
   594|             [PRIVACY_NOTICE_KEY_1]: false,
   595|           });
   596|       });
   597|       it("shows indicators that GPC has been applied", () => {
   598|         cy.get("div#fides-banner").within(() => {
   599|           cy.get("span").contains("Global Privacy Control Signal detected");
   600|         });
   601|         cy.get("button").contains("Manage preferences").click();
   602|         cy.get("div.fides-gpc-banner").contains(
   603|           "Global Privacy Control detected"
   604|         );
   605|         cy.get("span")
   606|           .contains("Test privacy notice with gpc enabled")
   607|           .within(() => {
   608|             cy.get("span").contains("Global Privacy Control applied");
   609|           });
   610|       });
   611|     });
   612|     describe("when GPC flag is found, and no notices apply to GPC", () => {
   613|       beforeEach(() => {
   614|         cy.on("window:before:load", (win) => {
   615|           win.navigator.globalPrivacyControl = true;
   616|         });
   617|         stubConfig({
   618|           experience: {
   619|             privacy_notices: [
   620|               mockPrivacyNotice({
   621|                 name: "Test privacy notice with GPC disabled",
   622|                 has_gpc_flag: false,
   623|               }),
   624|             ],
   625|           },
   626|         });
   627|       });
   628|       it("does not set user consent preference automatically", () => {
   629|         cy.on("fail", (error) => {
   630|           if (error.message.indexOf("Timed out retrying") !== 0) {
   631|             throw error;
   632|           }
   633|         });
   634|         cy.wait("@patchPrivacyPreference", {
   635|           requestTimeout: 500,
   636|         }).then((xhr) => {
   637|           assert.isNull(xhr?.response?.body);
   638|         });
   639|         cy.window().its("Fides").its("consent").should("eql", {});
   640|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   641|       });
   642|       it("does not show gpc indicator but does show it was detected and the info banner", () => {
   643|         cy.get("div.fides-gpc-banner").contains(
   644|           "Global Privacy Control detected"
   645|         );
   646|         cy.get("button").contains("Manage preferences").click();
   647|         cy.get("div.fides-gpc-banner").should("be.visible");
   648|         cy.get("div.fides-gpc-badge").should("not.exist");
   649|       });
   650|     });
   651|     describe("when no GPC flag is found, and notices apply to GPC", () => {
   652|       beforeEach(() => {
   653|         cy.on("window:before:load", (win) => {
   654|           win.navigator.globalPrivacyControl = undefined;
   655|         });
   656|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   657|         stubConfig({
   658|           experience: {
   659|             privacy_notices: [mockPrivacyNotice({ has_gpc_flag: true })],
   660|           },
   661|         });
   662|       });
   663|       it("does not set user consent preference automatically", () => {
   664|         cy.on("fail", (error) => {
   665|           if (error.message.indexOf("Timed out retrying") !== 0) {
   666|             throw error;
   667|           }
   668|         });
   669|         cy.wait("@patchPrivacyPreference", {
   670|           requestTimeout: 500,
   671|         }).then((xhr) => {
   672|           assert.isNull(xhr?.response?.body);
   673|         });
   674|         cy.window().its("Fides").its("consent").should("eql", {});
   675|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   676|       });
   677|       it("does not show any gpc indicators", () => {
   678|         cy.get("div#fides-banner").within(() => {
   679|           cy.get("span.fides-gpc-badge").should("not.exist");
   680|         });
   681|         cy.get("button").contains("Manage preferences").click();
   682|         cy.get("div.fides-gpc-banner").should("not.exist");
   683|         cy.get("div.fides-gpc-badge").should("not.exist");
   684|       });
   685|     });
   686|     describe("when experience component is not an overlay", () => {
   687|       beforeEach(() => {
   688|         stubConfig({
   689|           experience: {
   690|             component: ComponentType.PRIVACY_CENTER,
   691|           },
   692|         });
   693|       });
   694|       it("does not render banner", () => {
   695|         cy.get("div#fides-banner").should("not.exist");
   696|         cy.contains("button", "Accept Test").should("not.exist");
   697|       });
   698|       it("does not render modal link", () => {
   699|         cy.get("#fides-modal-link").should("not.be.visible");
   700|       });
   701|     });
   702|     describe("when experience is not provided, and valid geolocation is provided", () => {
   703|       beforeEach(() => {

# --- HUNK 3: Lines 906-956 ---
   906|         cy.waitUntilFidesInitialized().then(() => {
   907|           cy.get("div#fides-banner").should("not.exist");
   908|         });
   909|       });
   910|       it("renders modal link", () => {
   911|         cy.get("#fides-modal-link").should("be.visible");
   912|       });
   913|       it("does not set user consent preference automatically", () => {
   914|         cy.on("fail", (error) => {
   915|           if (error.message.indexOf("Timed out retrying") !== 0) {
   916|             throw error;
   917|           }
   918|         });
   919|         cy.wait("@patchPrivacyPreference", {
   920|           requestTimeout: 500,
   921|         }).then((xhr) => {
   922|           assert.isNull(xhr?.response?.body);
   923|         });
   924|         cy.window().its("Fides").its("consent").should("eql", {});
   925|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   926|       });
   927|       it("shows gpc indicators in modal", () => {
   928|         cy.get("#fides-modal-link").click();
   929|         cy.get("div.fides-gpc-banner").contains(
   930|           "Global Privacy Control detected"
   931|         );
   932|         cy.get("span")
   933|           .contains("Test privacy notice")
   934|           .within(() => {
   935|             cy.get("span").contains("Global Privacy Control overridden");
   936|           });
   937|       });
   938|     });
   939|     describe("when banner should not be shown but modal link element exists", () => {
   940|       beforeEach(() => {
   941|         stubConfig({
   942|           experience: {
   943|             show_banner: false,
   944|           },
   945|         });
   946|       });
   947|       it("does not render banner", () => {
   948|         cy.waitUntilFidesInitialized().then(() => {
   949|           cy.get("div#fides-banner").should("not.exist");
   950|         });
   951|       });
   952|       it("shows the modal link", () => {
   953|         cy.get("#fides-modal-link").should("be.visible");
   954|       });
   955|       describe("modal link click", () => {
   956|         it("should open modal", () => {

# --- HUNK 4: Lines 1353-1428 ---
  1353|           .its("firstCall.args.0.detail")
  1354|           .should("deep.equal", {
  1355|             consent: {
  1356|               data_sales: false,
  1357|               tracking: false,
  1358|               analytics: true,
  1359|             },
  1360|           });
  1361|         cy.get("@FidesUpdated")
  1362|           .its("secondCall.args.0.detail")
  1363|           .should("deep.equal", {
  1364|             consent: {
  1365|               data_sales: false,
  1366|               tracking: false,
  1367|               analytics: true,
  1368|             },
  1369|           });
  1370|       });
  1371|     });
  1372|   });
  1373|   describe("gpc indicators in the modal", () => {
  1374|     beforeEach(() => {
  1375|       cy.on("window:before:load", (win) => {
  1376|         win.navigator.globalPrivacyControl = true;
  1377|       });
  1378|     });
  1379|     it("renders the proper gpc indicator", () => {
  1380|       stubConfig({
  1381|         experience: {
  1382|           privacy_notices: [
  1383|             mockPrivacyNotice({
  1384|               name: "Applied",
  1385|               notice_key: "applied",
  1386|               has_gpc_flag: true,
  1387|               consent_mechanism: ConsentMechanism.OPT_OUT,
  1388|               default_preference: UserConsentPreference.OPT_IN,
  1389|               current_preference: undefined,
  1390|             }),
  1391|             mockPrivacyNotice({
  1392|               name: "Notice only",
  1393|               notice_key: "notice_only",
  1394|               has_gpc_flag: true,
  1395|               consent_mechanism: ConsentMechanism.NOTICE_ONLY,
  1396|               default_preference: UserConsentPreference.ACKNOWLEDGE,
  1397|               current_preference: UserConsentPreference.ACKNOWLEDGE,
  1398|             }),
  1399|             mockPrivacyNotice({
  1400|               name: "Overridden",
  1401|               notice_key: "overridden",
  1402|               has_gpc_flag: true,
  1403|               consent_mechanism: ConsentMechanism.OPT_OUT,
  1404|               default_preference: UserConsentPreference.OPT_IN,
  1405|               current_preference: UserConsentPreference.OPT_IN,
  1406|             }),
  1407|           ],
  1408|         },
  1409|       });
  1410|       cy.get("#fides-modal-link").click();
  1411|       cy.get(".fides-notice-toggle")
  1412|         .contains("Applied")
  1413|         .within(() => {
  1414|           cy.get(".fides-gpc-label").contains("applied");
  1415|         });
  1416|       cy.get(".fides-notice-toggle")
  1417|         .contains("Notice only")
  1418|         .within(() => {
  1419|           cy.get(".fides-gpc-label").should("not.exist");
  1420|         });
  1421|       cy.get(".fides-notice-toggle")
  1422|         .contains("Overridden")
  1423|         .within(() => {
  1424|           cy.get(".fides-gpc-label").contains("overridden");
  1425|         });
  1426|     });
  1427|   });
  1428| });


# ====================================================================
# FILE: clients/privacy-center/cypress/e2e/consent-notices.cy.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 91-135 ---
    91|         cy.waitUntilCookieExists(CONSENT_COOKIE_NAME).then(() => {
    92|           cy.getCookie(CONSENT_COOKIE_NAME).then((cookieJson) => {
    93|             const cookie = JSON.parse(
    94|               decodeURIComponent(cookieJson!.value)
    95|             ) as FidesCookie;
    96|             expect(body.browser_identity.fides_user_device_id).to.eql(
    97|               cookie.identity.fides_user_device_id
    98|             );
    99|             const expectedConsent = { data_sales: true, advertising: true };
   100|             const { consent } = cookie;
   101|             expect(consent).to.eql(expectedConsent);
   102|             cy.window().then((win) => {
   103|               expect(win.Fides.consent).to.eql(expectedConsent);
   104|             });
   105|           });
   106|         });
   107|       });
   108|     });
   109|     it("uses the device id found in an already existing cookie", () => {
   110|       const uuid = "4fbb6edf-34f6-4717-a6f1-541fd1e5d585";
   111|       const createdAt = "2023-04-28T12:00:00.000Z";
   112|       const updatedAt = "2023-04-29T12:00:00.000Z";
   113|       const cookie = {
   114|         identity: { fides_user_device_id: uuid },
   115|         fides_meta: { version: "0.9.0", createdAt, updatedAt },
   116|         consent: {},
   117|       };
   118|       cy.setCookie(CONSENT_COOKIE_NAME, JSON.stringify(cookie));
   119|       cy.wait("@getExperience").then((interception) => {
   120|         const { url } = interception.request;
   121|         expect(url).contains(`fides_user_device_id=${uuid}`);
   122|       });
   123|       cy.getByTestId("save-btn").click();
   124|       cy.wait("@patchPrivacyPreference").then((interception) => {
   125|         const { body } = interception.request;
   126|         cy.getCookie(CONSENT_COOKIE_NAME).then((cookieJson) => {
   127|           const savedCookie = JSON.parse(
   128|             decodeURIComponent(cookieJson!.value)
   129|           ) as FidesCookie;
   130|           expect(body.browser_identity.fides_user_device_id).to.eql(
   131|             savedCookie.identity.fides_user_device_id
   132|           );
   133|         });
   134|       });
   135|     });


# ====================================================================
# FILE: src/fides/api/main.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-57 ---
     1| """
     2| Contains the code that sets up the API.
     3| """
     4| import os
     5| import sys
     6| from datetime import datetime, timezone
     7| from logging import WARNING
     8| from typing import Callable, Optional
     9| from urllib.parse import unquote
    10| from fastapi import HTTPException, Request, Response, status
    11| from fastapi.responses import FileResponse
    12| from fideslog.sdk.python.event import AnalyticsEvent
    13| from loguru import logger
    14| from starlette.background import BackgroundTask
    15| from uvicorn import Config, Server
    16| import fides
    17| from fides.api.app_setup import (
    18|     check_redis,
    19|     create_fides_app,
    20|     log_startup,
    21|     run_database_startup,
    22| )
    23| from fides.api.common_exceptions import MalisciousUrlException
    24| from fides.api.middleware import handle_audit_log_resource
    25| from fides.api.schemas.analytics import Event, ExtraData
    26| from fides.api.service.privacy_request.email_batch_service import (
    27|     initiate_scheduled_batch_email_send,
    28| )
    29| from fides.api.tasks.scheduled.scheduler import scheduler
    30| from fides.api.ui import (
    31|     get_admin_index_as_response,
    32|     get_path_to_admin_ui_file,
    33|     get_ui_file_map,
    34|     match_route,
    35|     path_is_in_ui_directory,
    36| )
    37| from fides.api.util.endpoint_utils import API_PREFIX
    38| from fides.api.util.logger import _log_exception
    39| from fides.cli.utils import FIDES_ASCII_ART
    40| from fides.config import CONFIG, check_required_webserver_config_values
    41| IGNORED_AUDIT_LOG_RESOURCE_PATHS = {"/api/v1/login"}
    42| VERSION = fides.__version__
    43| app = create_fides_app()
    44| @app.middleware("http")
    45| async def dispatch_log_request(request: Request, call_next: Callable) -> Response:
    46|     """
    47|     HTTP Middleware that logs analytics events for each call to Fides endpoints.
    48|     :param request: Request to Fides api
    49|     :param call_next: Callable api endpoint
    50|     :return: Response
    51|     """
    52|     path = request.url.path
    53|     if (not path.startswith(API_PREFIX)) or (path.endswith("/health")):
    54|         return await call_next(request)
    55|     fides_source: Optional[str] = request.headers.get("X-Fides-Source")
    56|     now: datetime = datetime.now(tz=timezone.utc)
    57|     endpoint = f"{request.method}: {request.url}"

# --- HUNK 2: Lines 113-155 ---
   113|     handler_time = datetime.now() - start
   114|     logger.bind(
   115|         method=request.method,
   116|         status_code=response.status_code,
   117|         handler_time=f"{round(handler_time.microseconds * 0.001,3)}ms",
   118|         path=request.url.path,
   119|     ).info("Request received")
   120|     return response
   121| @app.get("/", tags=["Default"])
   122| def read_index() -> Response:
   123|     """
   124|     Return an index.html at the root path
   125|     """
   126|     return get_admin_index_as_response()
   127| def sanitise_url_path(path: str) -> str:
   128|     """Returns a URL path that does not contain any ../ or //"""
   129|     path = unquote(path)
   130|     path = os.path.normpath(path)
   131|     for token in path.split("/"):
   132|         if ".." in token:
   133|             logger.warning(
   134|                 f"Potentially dangerous use of URL hierarchy in path: {path}"
   135|             )
   136|             raise MalisciousUrlException()
   137|     return path
   138| @app.get("/{catchall:path}", response_class=Response, tags=["Default"])
   139| def read_other_paths(request: Request) -> Response:
   140|     """
   141|     Return related frontend files. Adapted from https://github.com/tiangolo/fastapi/issues/130
   142|     """
   143|     path = request.path_params["catchall"]
   144|     logger.debug(f"Catch all path detected: {path}")
   145|     try:
   146|         path = sanitise_url_path(path)
   147|     except MalisciousUrlException:
   148|         return get_admin_index_as_response()
   149|     ui_file = match_route(get_ui_file_map(), path)
   150|     if not ui_file:
   151|         ui_file = get_path_to_admin_ui_file(path)
   152|     if ui_file and ui_file.is_file():
   153|         if not path_is_in_ui_directory(ui_file):
   154|             raise HTTPException(
   155|                 status_code=status.HTTP_404_NOT_FOUND, detail="Item not found"


# ====================================================================
# FILE: src/fides/api/models/privacy_notice.py
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-133 ---
     1| from __future__ import annotations
     2| import re
     3| from collections import defaultdict
     4| from enum import Enum
     5| from html import unescape
     6| from typing import Any, Dict, Iterable, List, Optional, Tuple, Type, Union
     7| from fideslang.validation import FidesKey
     8| from sqlalchemy import Boolean, Column
     9| from sqlalchemy import Enum as EnumColumn
    10| from sqlalchemy import Float, ForeignKey, String, or_
    11| from sqlalchemy.dialects.postgresql import ARRAY
    12| from sqlalchemy.orm import Session, relationship
    13| from sqlalchemy.util import hybridproperty
    14| from fides.api.common_exceptions import ValidationError
    15| from fides.api.db.base_class import Base, FidesBase
    16| from fides.api.models.sql_models import (  # type: ignore[attr-defined]
    17|     Cookies,
    18|     PrivacyDeclaration,
    19|     System,
    20| )
    21| class UserConsentPreference(Enum):
    22|     opt_in = "opt_in"  # The user wants to opt in to the notice
    23|     opt_out = "opt_out"  # The user wants to opt out of the notice
    24|     acknowledge = "acknowledge"  # The user has acknowledged this notice
    25| PrivacyNoticeRegion = Enum(
    26|     "PrivacyNoticeRegion",
    27|     [
    28|         ("us_al", "us_al"),  # alabama
    29|         ("us_ak", "us_ak"),  # alaska
    30|         ("us_az", "us_az"),  # arizona
    31|         ("us_ar", "us_ar"),  # arkansas
    32|         ("us_ca", "us_ca"),  # california
    33|         ("us_co", "us_co"),  # colorado
    34|         ("us_ct", "us_ct"),  # connecticut
    35|         ("us_de", "us_de"),  # delaware
    36|         ("us_fl", "us_fl"),  # florida
    37|         ("us_ga", "us_ga"),  # georgia
    38|         ("us_hi", "us_hi"),  # hawaii
    39|         ("us_id", "us_id"),  # idaho
    40|         ("us_il", "us_il"),  # illinois
    41|         ("us_in", "us_in"),  # indiana
    42|         ("us_ia", "us_ia"),  # iowa
    43|         ("us_ks", "us_ks"),  # kansas
    44|         ("us_ky", "us_ky"),  # kentucky
    45|         ("us_la", "us_la"),  # louisiana
    46|         ("us_me", "us_me"),  # maine
    47|         ("us_md", "us_md"),  # maryland
    48|         ("us_ma", "us_ma"),  # massachusetts
    49|         ("us_mi", "us_mi"),  # michigan
    50|         ("us_mn", "us_mn"),  # minnesota
    51|         ("us_ms", "us_ms"),  # mississippi
    52|         ("us_mo", "us_mo"),  # missouri
    53|         ("us_mt", "us_mt"),  # montana
    54|         ("us_ne", "us_ne"),  # nebraska
    55|         ("us_nv", "us_nv"),  # nevada
    56|         ("us_nh", "us_nh"),  # new hampshire
    57|         ("us_nj", "us_nj"),  # new jersey
    58|         ("us_nm", "us_nm"),  # new mexico
    59|         ("us_ny", "us_ny"),  # new york
    60|         ("us_nc", "us_nc"),  # north carolina
    61|         ("us_nd", "us_nd"),  # north dakota
    62|         ("us_oh", "us_oh"),  # ohio
    63|         ("us_ok", "us_ok"),  # oklahoma
    64|         ("us_or", "us_or"),  # oregon
    65|         ("us_pa", "us_pa"),  # pennsylvania
    66|         ("us_ri", "us_ri"),  # rhode island
    67|         ("us_sc", "us_sc"),  # south carolina
    68|         ("us_sd", "us_sd"),  # south dakota
    69|         ("us_tn", "us_tn"),  # tennessee
    70|         ("us_tx", "us_tx"),  # texas
    71|         ("us_ut", "us_ut"),  # utah
    72|         ("us_vt", "us_vt"),  # vermont
    73|         ("us_va", "us_va"),  # virginia
    74|         ("us_wa", "us_wa"),  # washington
    75|         ("us_wv", "us_wv"),  # west virginia
    76|         ("us_wi", "us_wi"),  # wisconsin
    77|         ("us_wy", "us_wy"),  # wyoming
    78|         ("be", "be"),  # belgium
    79|         ("bg", "bg"),  # bulgaria
    80|         ("cz", "cz"),  # czechia
    81|         ("dk", "dk"),  # denmark
    82|         ("de", "de"),  # germany
    83|         ("ee", "ee"),  # estonia
    84|         ("ie", "ie"),  # ireland
    85|         ("gr", "gr"),  # greece
    86|         ("es", "es"),  # spain
    87|         ("fr", "fr"),  # france
    88|         ("hr", "hr"),  # croatia
    89|         ("it", "it"),  # italy
    90|         ("cy", "cy"),  # cyprus
    91|         ("lv", "lv"),  # latvia
    92|         ("lt", "lt"),  # lithuania
    93|         ("lu", "lu"),  # luxembourg
    94|         ("hu", "hu"),  # hungary
    95|         ("mt", "mt"),  # malta
    96|         ("nl", "nl"),  # netherlands
    97|         ("at", "at"),  # austria
    98|         ("pl", "pl"),  # poland
    99|         ("pt", "pt"),  # portugal
   100|         ("ro", "ro"),  # romania
   101|         ("si", "si"),  # slovenia
   102|         ("sk", "sk"),  # slovakia
   103|         ("fi", "fi"),  # finland
   104|         ("se", "se"),  # sweden
   105|         ("gb_eng", "gb_eng"),  # england
   106|         ("gb_sct", "gb_sct"),  # scotland
   107|         ("gb_wls", "gb_wls"),  # wales
   108|         ("gb_nir", "gb_nir"),  # northern ireland
   109|         ("is", "is"),  # iceland
   110|         ("no", "no"),  # norway
   111|         ("li", "li"),  # liechtenstein
   112|     ],
   113| )
   114| class ConsentMechanism(Enum):
   115|     opt_in = "opt_in"
   116|     opt_out = "opt_out"
   117|     notice_only = "notice_only"
   118| class EnforcementLevel(Enum):
   119|     """
   120|     Enum is not formalized in the DB because it may be subject to frequent change
   121|     """
   122|     frontend = "frontend"
   123|     system_wide = "system_wide"
   124|     not_applicable = "not_applicable"
   125| class PrivacyNoticeBase:
   126|     """
   127|     This class contains the common fields between PrivacyNoticeTemplate, PrivacyNotice, and PrivacyNoticeHistory
   128|     """
   129|     name = Column(String, nullable=False)
   130|     description = Column(String)  # User-facing description
   131|     internal_description = Column(String)  # Visible to internal users only
   132|     regions = Column(
   133|         ARRAY(EnumColumn(PrivacyNoticeRegion, native_enum=False)),

# --- HUNK 2: Lines 243-347 ---
   243|         data: dict[str, Any],
   244|         check_name: bool = False,
   245|     ) -> PrivacyNotice:
   246|         created = super().create(db=db, data=data, check_name=check_name)
   247|         data.pop("id", None)
   248|         history_data = {**data, "privacy_notice_id": created.id}
   249|         PrivacyNoticeHistory.create(db, data=history_data, check_name=False)
   250|         return created
   251|     def update(self, db: Session, *, data: dict[str, Any]) -> PrivacyNotice:
   252|         """
   253|         Overrides the base update method to automatically bump the version of the
   254|         PrivacyNotice record and also create a new PrivacyNoticeHistory entry
   255|         """
   256|         resource, updated = update_if_modified(self, db=db, data=data)
   257|         if updated:
   258|             history_data = create_historical_data_from_record(resource)
   259|             history_data["privacy_notice_id"] = resource.id
   260|             PrivacyNoticeHistory.create(db, data=history_data, check_name=False)
   261|         return resource  # type: ignore[return-value]
   262| PRIVACY_NOTICE_TYPE = Union[PrivacyNotice, PrivacyNoticeTemplate]
   263| def check_conflicting_notice_keys(
   264|     new_privacy_notices: Iterable[PRIVACY_NOTICE_TYPE],
   265|     existing_privacy_notices: Iterable[Union[PRIVACY_NOTICE_TYPE]],
   266|     ignore_disabled: bool = True,  # For PrivacyNoticeTemplates, set to False
   267| ) -> None:
   268|     """
   269|     Checks to see if new notice keys will conflict with any existing notice keys for a specific region
   270|     """
   271|     notice_keys_by_region: Dict[
   272|         PrivacyNoticeRegion, List[Tuple[str, str]]
   273|     ] = defaultdict(list)
   274|     for privacy_notice in existing_privacy_notices:
   275|         if privacy_notice.disabled and ignore_disabled:
   276|             continue
   277|         for region in privacy_notice.regions:
   278|             notice_keys_by_region[PrivacyNoticeRegion(region)].append(
   279|                 (privacy_notice.notice_key, privacy_notice.name)
   280|             )
   281|     for privacy_notice in new_privacy_notices:
   282|         if privacy_notice.disabled and ignore_disabled:
   283|             continue
   284|         for region in privacy_notice.regions:
   285|             region_notice_keys = notice_keys_by_region[PrivacyNoticeRegion(region)]
   286|             for notice_key, notice_name in region_notice_keys:
   287|                 if notice_key == privacy_notice.notice_key:
   288|                     raise ValidationError(
   289|                         message=f"Privacy Notice '{unescape(notice_name)}' has already assigned notice key '{notice_key}' to region '{region}'"
   290|                     )
   291|             region_notice_keys.append((privacy_notice.notice_key, privacy_notice.name))
   292| def check_conflicting_data_uses(
   293|     new_privacy_notices: Iterable[PRIVACY_NOTICE_TYPE],
   294|     existing_privacy_notices: Iterable[Union[PRIVACY_NOTICE_TYPE]],
   295|     ignore_disabled: bool = True,  # For PrivacyNoticeTemplates, set to False
   296| ) -> None:
   297|     """
   298|     Checks the provided lists of potential "new" (incoming) `PrivacyNotice` records
   299|     and existing `PrivacyNotice` records for conflicts (i.e. overlaps) in DataUse specifications
   300|     within `PrivacyNoticeRegion`s associated with the `PrivacyNotice` records.
   301|     Checks are effectively performed between the new records and the existing records, as well as
   302|     between the new records themselves.
   303|     A `DataUse` conflict is considered not only an exact match in `DataUse` strings, but also a
   304|     hierarchical overlap, e.g. `DataUse`s of `advertising` and `advertising.first_party` as well as
   305|     `advertising` and `advertising.first_party.contextual` would both be considered conflicts
   306|     if they occurred in `PrivacyNotice`s that are associated with the same `PrivacyNoticeRegion`.
   307|     For templates, we don't want to ignore disabled data uses.
   308|     """
   309|     uses_by_region: Dict[PrivacyNoticeRegion, List[Tuple[str, str]]] = defaultdict(list)
   310|     for privacy_notice in existing_privacy_notices:
   311|         if privacy_notice.disabled and ignore_disabled:
   312|             continue
   313|         for region in privacy_notice.regions:
   314|             for data_use in privacy_notice.data_uses:
   315|                 uses_by_region[PrivacyNoticeRegion(region)].append(
   316|                     (data_use, privacy_notice.name)
   317|                 )
   318|     for privacy_notice in new_privacy_notices:
   319|         if privacy_notice.disabled and ignore_disabled:
   320|             continue
   321|         for region in privacy_notice.regions:
   322|             region_uses = uses_by_region[PrivacyNoticeRegion(region)]
   323|             for data_use in privacy_notice.data_uses:
   324|                 for existing_use, notice_name in region_uses:
   325|                     if new_data_use_conflicts_with_existing_use(existing_use, data_use):
   326|                         raise ValidationError(
   327|                             message=f"Privacy Notice '{unescape(notice_name)}' has already assigned data use '{existing_use}' to region '{region}'"
   328|                         )
   329|                 region_uses.append((data_use, privacy_notice.name))
   330| def new_data_use_conflicts_with_existing_use(existing_use: str, new_use: str) -> bool:
   331|     """Data use check that prevents grandparent/parent/child, but allows siblings, aunt/child, etc.
   332|     Check needs to happen in both directions.
   333|     This assumes the supplied uses are on notices in the same region.
   334|     """
   335|     return existing_use.startswith(new_use) or new_use.startswith(existing_use)
   336| class PrivacyNoticeHistory(PrivacyNoticeBase, Base):
   337|     """
   338|     An "audit table" tracking outdated versions of `PrivacyNotice` records whose
   339|     "current" versions are stored in the `PrivacyNotice` table/model
   340|     """
   341|     origin = Column(
   342|         String, ForeignKey(PrivacyNoticeTemplate.id_field_path), nullable=True
   343|     )  # pointer back to the PrivacyNoticeTemplate
   344|     version = Column(Float, nullable=False, default=1.0)
   345|     privacy_notice_id = Column(
   346|         String, ForeignKey(PrivacyNotice.id_field_path), nullable=False
   347|     )


# ====================================================================
# FILE: src/fides/api/task/graph_task.py
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 19-59 ---
    19|     TraversalError,
    20| )
    21| from fides.api.graph.analytics_events import (
    22|     fideslog_graph_rerun,
    23|     prepare_rerun_graph_analytics_event,
    24| )
    25| from fides.api.graph.config import (
    26|     ROOT_COLLECTION_ADDRESS,
    27|     TERMINATOR_ADDRESS,
    28|     CollectionAddress,
    29|     Field,
    30|     FieldAddress,
    31|     FieldPath,
    32| )
    33| from fides.api.graph.graph import DatasetGraph, Edge, Node
    34| from fides.api.graph.graph_differences import format_graph_for_caching
    35| from fides.api.graph.traversal import Traversal, TraversalNode
    36| from fides.api.models.connectionconfig import AccessLevel, ConnectionConfig
    37| from fides.api.models.policy import Policy
    38| from fides.api.models.privacy_request import ExecutionLogStatus, PrivacyRequest
    39| from fides.api.models.sql_models import System  # type: ignore[attr-defined]
    40| from fides.api.schemas.policy import ActionType
    41| from fides.api.service.connectors.base_connector import BaseConnector
    42| from fides.api.task.consolidate_query_matches import consolidate_query_matches
    43| from fides.api.task.filter_element_match import filter_element_match
    44| from fides.api.task.refine_target_path import FieldPathNodeInput
    45| from fides.api.task.task_resources import TaskResources
    46| from fides.api.util.cache import get_cache
    47| from fides.api.util.collection_util import (
    48|     NodeInput,
    49|     Row,
    50|     append,
    51|     extract_key_for_address,
    52|     partition,
    53| )
    54| from fides.api.util.consent_util import add_errored_system_status_for_consent_reporting
    55| from fides.api.util.logger import Pii
    56| from fides.api.util.saas_util import FIDESOPS_GROUPED_INPUTS
    57| from fides.config import CONFIG
    58| dask.config.set(scheduler="threads")
    59| COLLECTION_FIELD_PATH_MAP = Dict[CollectionAddress, List[Tuple[FieldPath, FieldPath]]]

# --- HUNK 2: Lines 143-189 ---
   143|             )
   144|             add_errored_system_status_for_consent_reporting(
   145|                 self.resources.session,
   146|                 self.resources.request,
   147|                 self.connector.configuration,
   148|             )
   149|             raise raised_ex  # type: ignore
   150|         return result
   151|     return decorator
   152| class GraphTask(ABC):  # pylint: disable=too-many-instance-attributes
   153|     """A task that operates on one traversal_node of a traversal"""
   154|     def __init__(
   155|         self, traversal_node: TraversalNode, resources: TaskResources
   156|     ):  # cache config, log config, db store config
   157|         super().__init__()
   158|         self.traversal_node = traversal_node
   159|         self.resources = resources
   160|         self.connector: BaseConnector = resources.get_connector(
   161|             self.traversal_node.node.dataset.connection_key  # ConnectionConfig.key
   162|         )
   163|         self.data_uses: Set[str] = (
   164|             System.get_data_uses(
   165|                 [self.connector.configuration.system], include_parents=False
   166|             )
   167|             if self.connector.configuration.system
   168|             else {}
   169|         )
   170|         self.incoming_edges_by_collection: Dict[
   171|             CollectionAddress, List[Edge]
   172|         ] = partition(
   173|             self.traversal_node.incoming_edges(), lambda e: e.f1.collection_address()
   174|         )
   175|         self.input_keys: List[CollectionAddress] = sorted(
   176|             self.incoming_edges_by_collection.keys()
   177|         )
   178|         self.key = self.traversal_node.address
   179|         self.execution_log_id = None
   180|     def __repr__(self) -> str:
   181|         return f"{type(self)}:{self.key}"
   182|     @property
   183|     def grouped_fields(self) -> Set[str]:
   184|         """Convenience property - returns a set of fields that have been specified on the collection as dependent
   185|         upon one another
   186|         """
   187|         return self.traversal_node.node.collection.grouped_inputs or set()
   188|     @property
   189|     def dependent_identity_fields(self) -> bool:

# --- HUNK 3: Lines 549-606 ---
   549|         if not tn.is_root_node():
   550|             data[tn.address] = GraphTask(tn, resources).generate_dry_run_query()  # type: ignore
   551|     env: Dict[CollectionAddress, str] = {}
   552|     traversal.traverse(env, collect_queries_fn)
   553|     return env
   554| def update_mapping_from_cache(
   555|     dsk: Dict[CollectionAddress, Tuple[Any, ...]],
   556|     resources: TaskResources,
   557|     start_fn: Callable,
   558| ) -> None:
   559|     """When resuming a privacy request from a paused or failed state, update the `dsk` dictionary with results we've
   560|     already obtained from a previous run. Remove upstream dependencies for these nodes, and just return the data we've
   561|     already retrieved, rather than visiting them again.
   562|     If there's no cached data, the dsk dictionary won't change.
   563|     """
   564|     cached_results: Dict[str, Optional[List[Row]]] = resources.get_all_cached_objects()
   565|     for collection_name in cached_results:
   566|         dsk[CollectionAddress.from_string(collection_name)] = (
   567|             start_fn(cached_results[collection_name]),
   568|         )
   569| def _format_data_use_map_for_caching(
   570|     env: Dict[CollectionAddress, "GraphTask"]
   571| ) -> Dict[str, Set[str]]:
   572|     """
   573|     Create a map of `Collection`s mapped to their associated `DataUse`s
   574|     to be stored in the cache. This is done before request execution, so that we
   575|     maintain the _original_ state of the graph as it's used for request execution.
   576|     The graph is subject to change "from underneath" the request execution runtime,
   577|     but we want to avoid picking up those changes in our data use map.
   578|     `DataUse`s are associated with a `Collection` by means of the `System`
   579|     that's linked to a `Collection`'s `Connection` definition.
   580|     Example:
   581|     {
   582|        <collection1>: {"data_use_1", "data_use_2"},
   583|        <collection2>: {"data_use_1"},
   584|     }
   585|     """
   586|     return {collection.value: g_task.data_uses for collection, g_task in env.items()}
   587| def start_function(seed: List[Dict[str, Any]]) -> Callable[[], List[Dict[str, Any]]]:
   588|     """Return a function for collections with no upstream dependencies, that just start
   589|     with seed data.
   590|     This is used for root nodes or previously-visited nodes on restart."""
   591|     def g() -> List[Dict[str, Any]]:
   592|         return seed
   593|     return g
   594| async def run_access_request(
   595|     privacy_request: PrivacyRequest,
   596|     policy: Policy,
   597|     graph: DatasetGraph,
   598|     connection_configs: List[ConnectionConfig],
   599|     identity: Dict[str, Any],
   600|     session: Session,
   601| ) -> Dict[str, List[Row]]:
   602|     """Run the access request"""
   603|     traversal: Traversal = Traversal(graph, identity)
   604|     with TaskResources(
   605|         privacy_request, policy, connection_configs, session
   606|     ) as resources:

# --- HUNK 4: Lines 614-654 ---
   614|             *dependent_values: List[Row],
   615|         ) -> Dict[str, Optional[List[Row]]]:
   616|             """A termination function that just returns its inputs mapped to their source addresses.
   617|             This needs to wait for all dependent keys because this is how dask is informed to wait for
   618|             all terminating addresses before calling this."""
   619|             return resources.get_all_cached_objects()
   620|         env: Dict[CollectionAddress, Any] = {}
   621|         end_nodes = traversal.traverse(env, collect_tasks_fn)
   622|         dsk: Dict[CollectionAddress, Tuple[Any, ...]] = {
   623|             k: (t.access_request, *t.input_keys) for k, t in env.items()
   624|         }
   625|         dsk[ROOT_COLLECTION_ADDRESS] = (start_function([traversal.seed_data]),)
   626|         dsk[TERMINATOR_ADDRESS] = (termination_fn, *end_nodes)
   627|         update_mapping_from_cache(dsk, resources, start_function)
   628|         await fideslog_graph_rerun(
   629|             prepare_rerun_graph_analytics_event(
   630|                 privacy_request, env, end_nodes, resources, ActionType.access
   631|             )
   632|         )
   633|         privacy_request.cache_access_graph(format_graph_for_caching(env, end_nodes))
   634|         privacy_request.cache_data_use_map(_format_data_use_map_for_caching(env))
   635|         v = delayed(get(dsk, TERMINATOR_ADDRESS, num_workers=1))
   636|         return v.compute()
   637| def get_cached_data_for_erasures(
   638|     privacy_request_id: str,
   639| ) -> Dict[str, Any]:
   640|     """
   641|     Fetches processed access request results to be used for erasures.
   642|     Processing may have added indicators to not mask certain elements in array data.
   643|     """
   644|     cache = get_cache()
   645|     value_dict = cache.get_encoded_objects_by_prefix(
   646|         f"PLACEHOLDER_RESULTS__{privacy_request_id}"
   647|     )
   648|     number_of_leading_strings_to_exclude = 3
   649|     return {
   650|         extract_key_for_address(k, number_of_leading_strings_to_exclude): v
   651|         for k, v in value_dict.items()
   652|     }
   653| def update_erasure_mapping_from_cache(
   654|     dsk: Dict[CollectionAddress, Union[Tuple[Any, ...], int]], resources: TaskResources

