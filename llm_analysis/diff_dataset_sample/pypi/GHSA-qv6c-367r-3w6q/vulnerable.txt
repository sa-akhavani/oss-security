# ====================================================================
# FILE: drag_and_drop_v2/drag_and_drop_v2.py
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 5-45 ---
     5| import json
     6| import logging
     7| import six.moves.urllib.error  # pylint: disable=import-error
     8| import six.moves.urllib.parse  # pylint: disable=import-error
     9| import six.moves.urllib.request  # pylint: disable=import-error
    10| import six
    11| import pkg_resources
    12| import webob
    13| from django.utils import translation
    14| from xblock.core import XBlock
    15| from xblock.exceptions import JsonHandlerError
    16| from xblock.fields import Boolean, Dict, Float, Integer, Scope, String
    17| from xblock.scorable import ScorableXBlockMixin, Score
    18| from web_fragments.fragment import Fragment
    19| from xblockutils.resources import ResourceLoader
    20| from xblockutils.settings import ThemableXBlockMixin, XBlockWithSettingsMixin
    21| from .compat import get_grading_ignore_decoys_waffle_flag
    22| from .default_data import DEFAULT_DATA
    23| from .utils import (
    24|     Constants, SHOWANSWER, DummyTranslationService, FeedbackMessage,
    25|     FeedbackMessages, ItemStats, StateMigration, _clean_data, _
    26| )
    27| loader = ResourceLoader(__name__)
    28| logger = logging.getLogger(__name__)
    29| @XBlock.wants('settings')
    30| @XBlock.wants('replace_urls')
    31| @XBlock.wants('user')  # Using `needs` breaks the Course Outline page in Maple.
    32| @XBlock.needs('i18n')
    33| class DragAndDropBlock(
    34|     ScorableXBlockMixin,
    35|     XBlock,
    36|     XBlockWithSettingsMixin,
    37|     ThemableXBlockMixin
    38| ):
    39|     """
    40|     XBlock that implements a friendly Drag-and-Drop problem
    41|     """
    42|     CATEGORY = "drag-and-drop-v2"
    43|     SOLUTION_CORRECT = "correct"
    44|     SOLUTION_PARTIAL = "partial"
    45|     SOLUTION_INCORRECT = "incorrect"

# --- HUNK 2: Lines 306-365 ---
   306|     def student_view_data(self, context=None):
   307|         """
   308|         Get the configuration data for the student_view.
   309|         The configuration is all the settings defined by the author, except for correct answers
   310|         and feedback.
   311|         """
   312|         def items_without_answers():
   313|             """
   314|             Removes feedback and answer from items
   315|             """
   316|             items = copy.deepcopy(self.data.get('items', ''))
   317|             for item in items:
   318|                 del item['feedback']
   319|                 item.pop('zone', None)
   320|                 item.pop('zones', None)
   321|                 image_url = item.get('imageURL') or item.get('backgroundImage')
   322|                 if image_url:
   323|                     item['expandedImageURL'] = self._expand_static_url(image_url)
   324|                 else:
   325|                     item['expandedImageURL'] = ''
   326|             return items
   327|         return {
   328|             "block_id": six.text_type(self.scope_ids.usage_id),
   329|             "display_name": self.display_name,
   330|             "type": self.CATEGORY,
   331|             "weight": self.weight,
   332|             "mode": self.mode,
   333|             "zones": self.zones,
   334|             "max_attempts": self.max_attempts,
   335|             "graded": getattr(self, 'graded', False),
   336|             "weighted_max_score": self.max_score() * self.weight,
   337|             "max_items_per_zone": self.max_items_per_zone,
   338|             "url_name": getattr(self, 'url_name', ''),
   339|             "display_zone_labels": self.data.get('displayLabels', False),
   340|             "display_zone_borders": self.data.get('displayBorders', False),
   341|             "display_zone_borders_dragging": self.data.get('displayBordersDragging', False),
   342|             "items": items_without_answers(),
   343|             "title": self.display_name,
   344|             "show_title": self.show_title,
   345|             "problem_text": self.question_text,
   346|             "show_problem_header": self.show_question_header,
   347|             "target_img_expanded_url": self.target_img_expanded_url,
   348|             "target_img_description": self.target_img_description,
   349|             "item_background_color": self.item_background_color or None,
   350|             "item_text_color": self.item_text_color or None,
   351|             "has_deadline_passed": self.has_submission_deadline_passed,
   352|             "answer_available": self.is_answer_available,
   353|         }
   354|     def studio_view(self, context):
   355|         """
   356|         Editing view in Studio
   357|         """
   358|         js_templates = loader.load_unicode('/templates/html/js_templates.html')
   359|         id_suffix = self._get_block_id()
   360|         js_templates = js_templates.replace('{{id_suffix}}', id_suffix)
   361|         context = {
   362|             'js_templates': js_templates,
   363|             'id_suffix': id_suffix,
   364|             'fields': self.fields,
   365|             'showanswer_set': self._field_data.has(self, 'showanswer'),  # If false, we're using an inherited value.

# --- HUNK 3: Lines 529-569 ---
   529|             raise JsonHandlerError(
   530|                 400,
   531|                 self.i18n_service.gettext("show_answer handler should only be called for assessment mode")
   532|             )
   533|         if not self.is_answer_available:
   534|             raise JsonHandlerError(
   535|                 409,
   536|                 self.i18n_service.gettext("The answer is unavailable")
   537|             )
   538|         answer = self._get_correct_state()
   539|         if explanation := self.data.get('explanation', '').strip():
   540|             if replace_urls_service := self.runtime.service(self, 'replace_urls'):
   541|                 explanation = replace_urls_service.replace_urls(explanation)
   542|             else:
   543|                 try:
   544|                     explanation = self.runtime.replace_urls(explanation)
   545|                     explanation = self.runtime.replace_course_urls(explanation)
   546|                     explanation = self.runtime.replace_jump_to_id_urls(explanation)
   547|                 except (TypeError, AttributeError):
   548|                     logger.debug('Unable to perform URL substitution on the explanation: %s', explanation)
   549|             answer['explanation'] = explanation
   550|         return answer
   551|     @XBlock.json_handler
   552|     def expand_static_url(self, url, suffix=''):
   553|         """ AJAX-accessible handler for expanding URLs to static [image] files """
   554|         return {'url': self._expand_static_url(url)}
   555|     @property
   556|     def i18n_service(self):
   557|         """ Obtains translation service """
   558|         i18n_service = self.runtime.service(self, "i18n")
   559|         if i18n_service:
   560|             return i18n_service
   561|         else:
   562|             return DummyTranslationService()
   563|     @property
   564|     def target_img_expanded_url(self):
   565|         """ Get the expanded URL to the target image (the image items are dragged onto). """
   566|         if self.data.get("targetImg"):
   567|             return self._expand_static_url(self.data["targetImg"])
   568|         else:
   569|             return self.default_background_image_url

# --- HUNK 4: Lines 710-750 ---
   710|                 grade_feedback_template = FeedbackMessages.FINAL_ATTEMPT_TPL
   711|             feedback_msgs.append(FeedbackMessage(
   712|                 self.i18n_service.gettext(grade_feedback_template).format(score=self.weighted_grade()),
   713|                 grade_feedback_class)
   714|             )
   715|         problem_feedback_class = None
   716|         if self.attempts_remain and (misplaced_ids or missing_ids):
   717|             problem_feedback_message = self.data['feedback']['start']
   718|             problem_feedback_class = FeedbackMessages.MessageClasses.INITIAL_FEEDBACK
   719|         else:
   720|             problem_feedback_message = self.data['feedback']['finish']
   721|             problem_feedback_class = FeedbackMessages.MessageClasses.FINAL_FEEDBACK
   722|         feedback_msgs.append(FeedbackMessage(problem_feedback_message, problem_feedback_class))
   723|         return feedback_msgs, misplaced_ids
   724|     @staticmethod
   725|     def _present_feedback(feedback_messages):
   726|         """
   727|         Transforms feedback messages into format expected by frontend code
   728|         """
   729|         return [
   730|             {"message": msg.message, "message_class": msg.message_class}
   731|             for msg in feedback_messages
   732|             if msg.message
   733|         ]
   734|     def _drop_item_standard(self, item_attempt):
   735|         """
   736|         Handles dropping item to a zone in standard mode.
   737|         """
   738|         item = self._get_item_definition(item_attempt['val'])
   739|         is_correct = self._is_attempt_correct(item_attempt)  # Student placed item in a correct zone
   740|         if is_correct:  # In standard mode state is only updated when attempt is correct
   741|             self.item_state[str(item['id'])] = self._make_state_from_attempt(item_attempt, is_correct)
   742|         self._mark_complete_and_publish_grade()  # must happen before _get_feedback
   743|         self._publish_item_dropped_event(item_attempt, is_correct)
   744|         item_feedback_key = 'correct' if is_correct else 'incorrect'
   745|         item_feedback = FeedbackMessage(self._expand_static_url(item['feedback'][item_feedback_key]), None)
   746|         overall_feedback, __ = self._get_feedback()
   747|         return {
   748|             'correct': is_correct,
   749|             'grade': self._get_weighted_earned_if_set(),
   750|             'finished': self.is_correct,

# --- HUNK 5: Lines 943-983 ---
   943|         Returns a list of the zones that are valid options for the item.
   944|         If the item is configured with a list of zones, return that list. If
   945|         the item is configured with a single zone, encapsulate that zone's
   946|         ID in a list and return the list. If the item is not configured with
   947|         any zones, or if it's configured explicitly with no zones, return an
   948|         empty list.
   949|         """
   950|         item = self._get_item_definition(item_id)
   951|         if item.get('zones') is not None:
   952|             return item.get('zones')
   953|         elif item.get('zone') is not None and item.get('zone') != 'none':
   954|             return [item.get('zone')]
   955|         else:
   956|             return []
   957|     @property
   958|     def zones(self):
   959|         """
   960|         Get drop zone data, defined by the author.
   961|         """
   962|         migrator = StateMigration(self)
   963|         return [migrator.apply_zone_migrations(zone) for zone in self.data.get('zones', [])]
   964|     def _get_zone_by_uid(self, uid):
   965|         """
   966|         Given a zone UID, return that zone, or None.
   967|         """
   968|         for zone in self.zones:
   969|             if zone["uid"] == uid:
   970|                 return zone
   971|         return None
   972|     def _get_item_stats(self):
   973|         """
   974|         Returns a tuple representing the number of correctly placed items,
   975|         and the total number of items required (including decoy items).
   976|         """
   977|         items = self._get_item_raw_stats()
   978|         correct_count = len(items.correctly_placed)
   979|         total_count = len(items.required)
   980|         if hasattr(self.runtime, 'course_id') and \
   981|                 get_grading_ignore_decoys_waffle_flag().is_enabled(self.runtime.course_id):
   982|             return correct_count, total_count
   983|         correct_count += len(items.decoy_in_bank)


# ====================================================================
# FILE: drag_and_drop_v2/public/js/drag_and_drop_edit.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 345-386 ---
   345|                             if (_fn.build.form.zone.zoneObjects.length > 1) {
   346|                                 _fn.build.$el.zones.form.find('.remove-zone').removeClass('hidden');
   347|                             }
   348|                         },
   349|                         disableDelete: function() {
   350|                             if (_fn.build.form.zone.zoneObjects.length === 1) {
   351|                                 _fn.build.$el.zones.form.find('.remove-zone').addClass('hidden');
   352|                             }
   353|                         },
   354|                         renderZonesPreview: function() {
   355|                             _fn.build.$el.zonesPreview.html('');
   356|                             var imgWidth = _fn.build.$el.targetImage[0].naturalWidth;
   357|                             var imgHeight = _fn.build.$el.targetImage[0].naturalHeight;
   358|                             if (imgWidth == 0 || imgHeight == 0) {
   359|                                 imgWidth = imgHeight = 400;
   360|                             }
   361|                             this.zoneObjects.forEach(function(zoneObj) {
   362|                                 _fn.build.$el.zonesPreview.append(
   363|                                     _fn.tpl.zoneElement({
   364|                                         uid: zoneObj.uid,
   365|                                         title: gettext(zoneObj.title),
   366|                                         description: gettext(zoneObj.description),
   367|                                         x_percent: (+zoneObj.x) / imgWidth * 100,
   368|                                         y_percent: (+zoneObj.y) / imgHeight * 100,
   369|                                         width_percent: (+zoneObj.width) / imgWidth * 100,
   370|                                         height_percent: (+zoneObj.height) / imgHeight * 100,
   371|                                         align: zoneObj.align
   372|                                     })
   373|                                 );
   374|                             });
   375|                         },
   376|                         changedInputHandler: function(ev) {
   377|                             var $changedInput = $(ev.currentTarget);
   378|                             var $row = $changedInput.closest('.zone-row');
   379|                             var record = _fn.build.form.zone.getZoneObjByUID(String($row.data('uid')));
   380|                             if ($changedInput.hasClass('zone-title')) {
   381|                                 record.title = $changedInput.val();
   382|                             } else if ($changedInput.hasClass('zone-width')) {
   383|                                 record.width = $changedInput.val();
   384|                             } else if ($changedInput.hasClass('zone-description')) {
   385|                                 record.description = $changedInput.val();
   386|                             } else if ($changedInput.hasClass('zone-height')) {


# ====================================================================
# FILE: drag_and_drop_v2/utils.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-40 ---
     1| """ Drag and Drop v2 XBlock - Utils """
     2| from __future__ import absolute_import
     3| import copy
     4| import re
     5| from collections import namedtuple
     6| from bleach.sanitizer import Cleaner
     7| def _(text):
     8|     """ Dummy `gettext` replacement to make string extraction tools scrape strings marked for translation """
     9|     return text
    10| def ngettext_fallback(text_singular, text_plural, number):
    11|     """ Dummy `ngettext` replacement to make string extraction tools scrape strings marked for translation """
    12|     if number == 1:
    13|         return text_singular
    14|     else:
    15|         return text_plural
    16| def _clean_data(data):
    17|     """ Remove html tags and extra white spaces e.g newline, tabs etc from provided data """
    18|     cleaner = Cleaner(tags=[], strip=True)
    19|     cleaned_text = " ".join(re.split(r"\s+", cleaner.clean(data), flags=re.UNICODE)).strip()
    20|     return cleaned_text
    21| class DummyTranslationService:
    22|     """
    23|     Dummy drop-in replacement for i18n XBlock service
    24|     """
    25|     gettext = _
    26|     ngettext = ngettext_fallback
    27| class FeedbackMessages:
    28|     """
    29|     Feedback messages collection
    30|     """
    31|     class MessageClasses:
    32|         """
    33|         Namespace for message classes
    34|         """
    35|         CORRECT_SOLUTION = "correct"
    36|         PARTIAL_SOLUTION = "partial"
    37|         INCORRECT_SOLUTION = "incorrect"
    38|         CORRECTLY_PLACED = CORRECT_SOLUTION
    39|         MISPLACED = INCORRECT_SOLUTION
    40|         NOT_PLACED = INCORRECT_SOLUTION


# ====================================================================
# FILE: setup.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| import os
     2| from setuptools import setup
     3| def package_data(pkg, root_list):
     4|     """Generic function to find package_data for `pkg` under `root`."""
     5|     data = []
     6|     for root in root_list:
     7|         for dirname, _, files in os.walk(os.path.join(pkg, root)):
     8|             for fname in files:
     9|                 data.append(os.path.relpath(os.path.join(dirname, fname), pkg))
    10|     return {pkg: data}
    11| setup(
    12|     name='xblock-drag-and-drop-v2',
    13|     version='2.7.0',
    14|     description='XBlock - Drag-and-Drop v2',
    15|     packages=['drag_and_drop_v2'],
    16|     install_requires=[
    17|         'XBlock',
    18|         'xblock-utils',
    19|         'bleach',
    20|     ],
    21|     entry_points={
    22|         'xblock.v1': 'drag-and-drop-v2 = drag_and_drop_v2:DragAndDropBlock',
    23|     },
    24|     package_data=package_data("drag_and_drop_v2", ["static", "templates", "public", "translations", "locale"]),
    25| )

