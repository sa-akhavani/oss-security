# ====================================================================
# FILE: drag_and_drop_v2/drag_and_drop_v2.py
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 5-45 ---
     5| import json
     6| import logging
     7| import six.moves.urllib.error  # pylint: disable=import-error
     8| import six.moves.urllib.parse  # pylint: disable=import-error
     9| import six.moves.urllib.request  # pylint: disable=import-error
    10| import six
    11| import pkg_resources
    12| import webob
    13| from django.utils import translation
    14| from xblock.core import XBlock
    15| from xblock.exceptions import JsonHandlerError
    16| from xblock.fields import Boolean, Dict, Float, Integer, Scope, String
    17| from xblock.scorable import ScorableXBlockMixin, Score
    18| from web_fragments.fragment import Fragment
    19| from xblockutils.resources import ResourceLoader
    20| from xblockutils.settings import ThemableXBlockMixin, XBlockWithSettingsMixin
    21| from .compat import get_grading_ignore_decoys_waffle_flag
    22| from .default_data import DEFAULT_DATA
    23| from .utils import (
    24|     Constants, SHOWANSWER, DummyTranslationService, FeedbackMessage,
    25|     FeedbackMessages, ItemStats, StateMigration, _clean_data, _, sanitize_html
    26| )
    27| loader = ResourceLoader(__name__)
    28| logger = logging.getLogger(__name__)
    29| @XBlock.wants('settings')
    30| @XBlock.wants('replace_urls')
    31| @XBlock.wants('user')  # Using `needs` breaks the Course Outline page in Maple.
    32| @XBlock.needs('i18n')
    33| class DragAndDropBlock(
    34|     ScorableXBlockMixin,
    35|     XBlock,
    36|     XBlockWithSettingsMixin,
    37|     ThemableXBlockMixin
    38| ):
    39|     """
    40|     XBlock that implements a friendly Drag-and-Drop problem
    41|     """
    42|     CATEGORY = "drag-and-drop-v2"
    43|     SOLUTION_CORRECT = "correct"
    44|     SOLUTION_PARTIAL = "partial"
    45|     SOLUTION_INCORRECT = "incorrect"

# --- HUNK 2: Lines 306-366 ---
   306|     def student_view_data(self, context=None):
   307|         """
   308|         Get the configuration data for the student_view.
   309|         The configuration is all the settings defined by the author, except for correct answers
   310|         and feedback.
   311|         """
   312|         def items_without_answers():
   313|             """
   314|             Removes feedback and answer from items
   315|             """
   316|             items = copy.deepcopy(self.data.get('items', ''))
   317|             for item in items:
   318|                 del item['feedback']
   319|                 item.pop('zone', None)
   320|                 item.pop('zones', None)
   321|                 image_url = item.get('imageURL') or item.get('backgroundImage')
   322|                 if image_url:
   323|                     item['expandedImageURL'] = self._expand_static_url(image_url)
   324|                 else:
   325|                     item['expandedImageURL'] = ''
   326|                 item['displayName'] = sanitize_html(item.get('displayName', ''))
   327|             return items
   328|         return {
   329|             "block_id": six.text_type(self.scope_ids.usage_id),
   330|             "display_name": sanitize_html(self.display_name),
   331|             "type": self.CATEGORY,
   332|             "weight": self.weight,
   333|             "mode": self.mode,
   334|             "zones": self.zones,
   335|             "max_attempts": self.max_attempts,
   336|             "graded": getattr(self, 'graded', False),
   337|             "weighted_max_score": self.max_score() * self.weight,
   338|             "max_items_per_zone": self.max_items_per_zone,
   339|             "url_name": getattr(self, 'url_name', ''),
   340|             "display_zone_labels": self.data.get('displayLabels', False),
   341|             "display_zone_borders": self.data.get('displayBorders', False),
   342|             "display_zone_borders_dragging": self.data.get('displayBordersDragging', False),
   343|             "items": items_without_answers(),
   344|             "title": sanitize_html(self.display_name),
   345|             "show_title": self.show_title,
   346|             "problem_text": sanitize_html(self.question_text),
   347|             "show_problem_header": self.show_question_header,
   348|             "target_img_expanded_url": self.target_img_expanded_url,
   349|             "target_img_description": self.target_img_description,
   350|             "item_background_color": self.item_background_color or None,
   351|             "item_text_color": self.item_text_color or None,
   352|             "has_deadline_passed": self.has_submission_deadline_passed,
   353|             "answer_available": self.is_answer_available,
   354|         }
   355|     def studio_view(self, context):
   356|         """
   357|         Editing view in Studio
   358|         """
   359|         js_templates = loader.load_unicode('/templates/html/js_templates.html')
   360|         id_suffix = self._get_block_id()
   361|         js_templates = js_templates.replace('{{id_suffix}}', id_suffix)
   362|         context = {
   363|             'js_templates': js_templates,
   364|             'id_suffix': id_suffix,
   365|             'fields': self.fields,
   366|             'showanswer_set': self._field_data.has(self, 'showanswer'),  # If false, we're using an inherited value.

# --- HUNK 3: Lines 530-570 ---
   530|             raise JsonHandlerError(
   531|                 400,
   532|                 self.i18n_service.gettext("show_answer handler should only be called for assessment mode")
   533|             )
   534|         if not self.is_answer_available:
   535|             raise JsonHandlerError(
   536|                 409,
   537|                 self.i18n_service.gettext("The answer is unavailable")
   538|             )
   539|         answer = self._get_correct_state()
   540|         if explanation := self.data.get('explanation', '').strip():
   541|             if replace_urls_service := self.runtime.service(self, 'replace_urls'):
   542|                 explanation = replace_urls_service.replace_urls(explanation)
   543|             else:
   544|                 try:
   545|                     explanation = self.runtime.replace_urls(explanation)
   546|                     explanation = self.runtime.replace_course_urls(explanation)
   547|                     explanation = self.runtime.replace_jump_to_id_urls(explanation)
   548|                 except (TypeError, AttributeError):
   549|                     logger.debug('Unable to perform URL substitution on the explanation: %s', explanation)
   550|             answer['explanation'] = sanitize_html(explanation)
   551|         return answer
   552|     @XBlock.json_handler
   553|     def expand_static_url(self, url, suffix=''):
   554|         """ AJAX-accessible handler for expanding URLs to static [image] files """
   555|         return {'url': self._expand_static_url(url)}
   556|     @property
   557|     def i18n_service(self):
   558|         """ Obtains translation service """
   559|         i18n_service = self.runtime.service(self, "i18n")
   560|         if i18n_service:
   561|             return i18n_service
   562|         else:
   563|             return DummyTranslationService()
   564|     @property
   565|     def target_img_expanded_url(self):
   566|         """ Get the expanded URL to the target image (the image items are dragged onto). """
   567|         if self.data.get("targetImg"):
   568|             return self._expand_static_url(self.data["targetImg"])
   569|         else:
   570|             return self.default_background_image_url

# --- HUNK 4: Lines 711-751 ---
   711|                 grade_feedback_template = FeedbackMessages.FINAL_ATTEMPT_TPL
   712|             feedback_msgs.append(FeedbackMessage(
   713|                 self.i18n_service.gettext(grade_feedback_template).format(score=self.weighted_grade()),
   714|                 grade_feedback_class)
   715|             )
   716|         problem_feedback_class = None
   717|         if self.attempts_remain and (misplaced_ids or missing_ids):
   718|             problem_feedback_message = self.data['feedback']['start']
   719|             problem_feedback_class = FeedbackMessages.MessageClasses.INITIAL_FEEDBACK
   720|         else:
   721|             problem_feedback_message = self.data['feedback']['finish']
   722|             problem_feedback_class = FeedbackMessages.MessageClasses.FINAL_FEEDBACK
   723|         feedback_msgs.append(FeedbackMessage(problem_feedback_message, problem_feedback_class))
   724|         return feedback_msgs, misplaced_ids
   725|     @staticmethod
   726|     def _present_feedback(feedback_messages):
   727|         """
   728|         Transforms feedback messages into format expected by frontend code
   729|         """
   730|         return [
   731|             {"message": sanitize_html(msg.message), "message_class": msg.message_class}
   732|             for msg in feedback_messages
   733|             if msg.message
   734|         ]
   735|     def _drop_item_standard(self, item_attempt):
   736|         """
   737|         Handles dropping item to a zone in standard mode.
   738|         """
   739|         item = self._get_item_definition(item_attempt['val'])
   740|         is_correct = self._is_attempt_correct(item_attempt)  # Student placed item in a correct zone
   741|         if is_correct:  # In standard mode state is only updated when attempt is correct
   742|             self.item_state[str(item['id'])] = self._make_state_from_attempt(item_attempt, is_correct)
   743|         self._mark_complete_and_publish_grade()  # must happen before _get_feedback
   744|         self._publish_item_dropped_event(item_attempt, is_correct)
   745|         item_feedback_key = 'correct' if is_correct else 'incorrect'
   746|         item_feedback = FeedbackMessage(self._expand_static_url(item['feedback'][item_feedback_key]), None)
   747|         overall_feedback, __ = self._get_feedback()
   748|         return {
   749|             'correct': is_correct,
   750|             'grade': self._get_weighted_earned_if_set(),
   751|             'finished': self.is_correct,

# --- HUNK 5: Lines 944-989 ---
   944|         Returns a list of the zones that are valid options for the item.
   945|         If the item is configured with a list of zones, return that list. If
   946|         the item is configured with a single zone, encapsulate that zone's
   947|         ID in a list and return the list. If the item is not configured with
   948|         any zones, or if it's configured explicitly with no zones, return an
   949|         empty list.
   950|         """
   951|         item = self._get_item_definition(item_id)
   952|         if item.get('zones') is not None:
   953|             return item.get('zones')
   954|         elif item.get('zone') is not None and item.get('zone') != 'none':
   955|             return [item.get('zone')]
   956|         else:
   957|             return []
   958|     @property
   959|     def zones(self):
   960|         """
   961|         Get drop zone data, defined by the author.
   962|         """
   963|         migrator = StateMigration(self)
   964|         migrated_zones = []
   965|         for zone in self.data.get('zones', []):
   966|             result = migrator.apply_zone_migrations(zone)
   967|             result['title'] = sanitize_html(result.get('title', ''))
   968|             migrated_zones.append(result)
   969|         return migrated_zones
   970|     def _get_zone_by_uid(self, uid):
   971|         """
   972|         Given a zone UID, return that zone, or None.
   973|         """
   974|         for zone in self.zones:
   975|             if zone["uid"] == uid:
   976|                 return zone
   977|         return None
   978|     def _get_item_stats(self):
   979|         """
   980|         Returns a tuple representing the number of correctly placed items,
   981|         and the total number of items required (including decoy items).
   982|         """
   983|         items = self._get_item_raw_stats()
   984|         correct_count = len(items.correctly_placed)
   985|         total_count = len(items.required)
   986|         if hasattr(self.runtime, 'course_id') and \
   987|                 get_grading_ignore_decoys_waffle_flag().is_enabled(self.runtime.course_id):
   988|             return correct_count, total_count
   989|         correct_count += len(items.decoy_in_bank)


# ====================================================================
# FILE: drag_and_drop_v2/public/js/drag_and_drop_edit.js
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 345-386 ---
   345|                             if (_fn.build.form.zone.zoneObjects.length > 1) {
   346|                                 _fn.build.$el.zones.form.find('.remove-zone').removeClass('hidden');
   347|                             }
   348|                         },
   349|                         disableDelete: function() {
   350|                             if (_fn.build.form.zone.zoneObjects.length === 1) {
   351|                                 _fn.build.$el.zones.form.find('.remove-zone').addClass('hidden');
   352|                             }
   353|                         },
   354|                         renderZonesPreview: function() {
   355|                             _fn.build.$el.zonesPreview.html('');
   356|                             var imgWidth = _fn.build.$el.targetImage[0].naturalWidth;
   357|                             var imgHeight = _fn.build.$el.targetImage[0].naturalHeight;
   358|                             if (imgWidth == 0 || imgHeight == 0) {
   359|                                 imgWidth = imgHeight = 400;
   360|                             }
   361|                             this.zoneObjects.forEach(function(zoneObj) {
   362|                                 _fn.build.$el.zonesPreview.append(
   363|                                     _fn.tpl.zoneElement({
   364|                                         uid: zoneObj.uid,
   365|                                         title: Handlebars.Utils.escapeExpression(gettext(zoneObj.title)),
   366|                                         description: Handlebars.Utils.escapeExpression(gettext(zoneObj.description)),
   367|                                         x_percent: (+zoneObj.x) / imgWidth * 100,
   368|                                         y_percent: (+zoneObj.y) / imgHeight * 100,
   369|                                         width_percent: (+zoneObj.width) / imgWidth * 100,
   370|                                         height_percent: (+zoneObj.height) / imgHeight * 100,
   371|                                         align: zoneObj.align
   372|                                     })
   373|                                 );
   374|                             });
   375|                         },
   376|                         changedInputHandler: function(ev) {
   377|                             var $changedInput = $(ev.currentTarget);
   378|                             var $row = $changedInput.closest('.zone-row');
   379|                             var record = _fn.build.form.zone.getZoneObjByUID(String($row.data('uid')));
   380|                             if ($changedInput.hasClass('zone-title')) {
   381|                                 record.title = $changedInput.val();
   382|                             } else if ($changedInput.hasClass('zone-width')) {
   383|                                 record.width = $changedInput.val();
   384|                             } else if ($changedInput.hasClass('zone-description')) {
   385|                                 record.description = $changedInput.val();
   386|                             } else if ($changedInput.hasClass('zone-height')) {


# ====================================================================
# FILE: drag_and_drop_v2/utils.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-149 ---
     1| """ Drag and Drop v2 XBlock - Utils """
     2| from __future__ import absolute_import
     3| import copy
     4| import re
     5| from collections import namedtuple
     6| import bleach
     7| try:
     8|     from bleach.css_sanitizer import CSSSanitizer
     9| except (ImportError, ModuleNotFoundError):
    10|     CSSSanitizer = None
    11| def _(text):
    12|     """ Dummy `gettext` replacement to make string extraction tools scrape strings marked for translation """
    13|     return text
    14| def ngettext_fallback(text_singular, text_plural, number):
    15|     """ Dummy `ngettext` replacement to make string extraction tools scrape strings marked for translation """
    16|     if number == 1:
    17|         return text_singular
    18|     else:
    19|         return text_plural
    20| def _clean_data(data):
    21|     """ Remove html tags and extra white spaces e.g newline, tabs etc from provided data """
    22|     cleaner = bleach.Cleaner(tags=[], strip=True)
    23|     cleaned_text = " ".join(re.split(r"\s+", cleaner.clean(data), flags=re.UNICODE)).strip()
    24|     return cleaned_text
    25| ALLOWED_TAGS = bleach.ALLOWED_TAGS + [
    26|     'br',
    27|     'caption',
    28|     'dd',
    29|     'del',
    30|     'div',
    31|     'dl',
    32|     'dt',
    33|     'h1',
    34|     'h2',
    35|     'h3',
    36|     'h4',
    37|     'h5',
    38|     'h6',
    39|     'hr',
    40|     'img',
    41|     'p',
    42|     'pre',
    43|     's',
    44|     'strike',
    45|     'span',
    46|     'sub',
    47|     'sup',
    48|     'table',
    49|     'tbody',
    50|     'td',
    51|     'tfoot',
    52|     'th',
    53|     'thead',
    54|     'tr',
    55|     'u',
    56| ]
    57| ALLOWED_ATTRIBUTES = {
    58|     '*': ['class', 'style', 'id'],
    59|     'a': ['href', 'title', 'target', 'rel'],
    60|     'abbr': ['title'],
    61|     'acronym': ['title'],
    62|     'audio': ['controls', 'autobuffer', 'autoplay', 'src'],
    63|     'img': ['src', 'alt', 'title', 'width', 'height'],
    64|     'table': ['border', 'cellspacing', 'cellpadding'],
    65|     'td': ['style', 'scope'],
    66| }
    67| ALLOWED_STYLES = [
    68|     "azimuth",
    69|     "background-color",
    70|     "border-bottom-color",
    71|     "border-collapse",
    72|     "border-color",
    73|     "border-left-color",
    74|     "border-right-color",
    75|     "border-top-color",
    76|     "clear",
    77|     "color",
    78|     "cursor",
    79|     "direction",
    80|     "display",
    81|     "elevation",
    82|     "float",
    83|     "font",
    84|     "font-family",
    85|     "font-size",
    86|     "font-style",
    87|     "font-variant",
    88|     "font-weight",
    89|     "height",
    90|     "letter-spacing",
    91|     "line-height",
    92|     "overflow",
    93|     "pause",
    94|     "pause-after",
    95|     "pause-before",
    96|     "pitch",
    97|     "pitch-range",
    98|     "richness",
    99|     "speak",
   100|     "speak-header",
   101|     "speak-numeral",
   102|     "speak-punctuation",
   103|     "speech-rate",
   104|     "stress",
   105|     "text-align",
   106|     "text-decoration",
   107|     "text-indent",
   108|     "unicode-bidi",
   109|     "vertical-align",
   110|     "voice-family",
   111|     "volume",
   112|     "white-space",
   113|     "width",
   114| ]
   115| def sanitize_html(raw_body: str) -> str:
   116|     """
   117|     Remove not allowed HTML tags to mitigate XSS vulnerabilities.
   118|     """
   119|     bleach_options = dict(
   120|         tags=ALLOWED_TAGS,
   121|         protocols=bleach.ALLOWED_PROTOCOLS,
   122|         strip=True,
   123|         attributes=ALLOWED_ATTRIBUTES,
   124|     )
   125|     if CSSSanitizer:
   126|         bleach_options['css_sanitizer'] = CSSSanitizer()
   127|     else:
   128|         bleach_options['styles'] = ALLOWED_STYLES
   129|     return bleach.clean(raw_body, **bleach_options)
   130| class DummyTranslationService:
   131|     """
   132|     Dummy drop-in replacement for i18n XBlock service
   133|     """
   134|     gettext = _
   135|     ngettext = ngettext_fallback
   136| class FeedbackMessages:
   137|     """
   138|     Feedback messages collection
   139|     """
   140|     class MessageClasses:
   141|         """
   142|         Namespace for message classes
   143|         """
   144|         CORRECT_SOLUTION = "correct"
   145|         PARTIAL_SOLUTION = "partial"
   146|         INCORRECT_SOLUTION = "incorrect"
   147|         CORRECTLY_PLACED = CORRECT_SOLUTION
   148|         MISPLACED = INCORRECT_SOLUTION
   149|         NOT_PLACED = INCORRECT_SOLUTION


# ====================================================================
# FILE: setup.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| import os
     2| from setuptools import setup
     3| def package_data(pkg, root_list):
     4|     """Generic function to find package_data for `pkg` under `root`."""
     5|     data = []
     6|     for root in root_list:
     7|         for dirname, _, files in os.walk(os.path.join(pkg, root)):
     8|             for fname in files:
     9|                 data.append(os.path.relpath(os.path.join(dirname, fname), pkg))
    10|     return {pkg: data}
    11| setup(
    12|     name='xblock-drag-and-drop-v2',
    13|     version='3.0.0',
    14|     description='XBlock - Drag-and-Drop v2',
    15|     packages=['drag_and_drop_v2'],
    16|     install_requires=[
    17|         'XBlock',
    18|         'xblock-utils',
    19|         'bleach',
    20|     ],
    21|     entry_points={
    22|         'xblock.v1': 'drag-and-drop-v2 = drag_and_drop_v2:DragAndDropBlock',
    23|     },
    24|     package_data=package_data("drag_and_drop_v2", ["static", "templates", "public", "translations", "locale"]),
    25| )

