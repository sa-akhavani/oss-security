# ====================================================================
# FILE: rdiffweb/controller/page_mfa.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-32 ---
     1| import logging
     2| import cherrypy
     3| from wtforms.fields import BooleanField, StringField, SubmitField
     4| from wtforms.validators import ValidationError
     5| from rdiffweb.controller import Controller, flash
     6| from rdiffweb.controller.form import CherryForm
     7| from rdiffweb.tools.auth_form import LOGIN_PERSISTENT
     8| from rdiffweb.tools.i18n import gettext_lazy as _
     9| logger = logging.getLogger(__name__)
    10| class MfaForm(CherryForm):
    11|     code = StringField(
    12|         _('Verification code'),
    13|         render_kw={
    14|             "class": "form-control-lg",
    15|             "placeholder": _('Enter verification code here'),
    16|             "autocomplete": "off",
    17|             "autocorrect": "off",
    18|             "autofocus": "autofocus",
    19|         },
    20|     )
    21|     persistent = BooleanField(
    22|         _('Remember me'),
    23|         default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),
    24|     )
    25|     submit = SubmitField(
    26|         _('Sign in'),
    27|         render_kw={"class": "btn-primary btn-lg btn-block"},
    28|     )
    29|     resend_code = SubmitField(
    30|         _('Resend code to my email'),
    31|         render_kw={"class": "btn-link btn-sm btn-block"},
    32|     )


# ====================================================================
# FILE: rdiffweb/core/config.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 160-220 ---
   160|         '--brand-header-logo',
   161|         '--header-logo',
   162|         '--headerlogo',
   163|         dest='header_logo',
   164|         help='location of an image (preferably a .svg) to be used as a replacement for the rdiffweb header logo displayed in navigation bar.',
   165|     )
   166|     parser.add_argument(
   167|         '--brand-header-name',
   168|         '--header-name',
   169|         '--headername',
   170|         dest='header_name',
   171|         help='application name displayed in the title bar and header menu.',
   172|         default='Rdiffweb',
   173|     )
   174|     parser.add_argument(
   175|         '--brand-link-color',
   176|         '--link-color',
   177|         type=css_color,
   178|         dest='link_color',
   179|         help='define a CSS color to be used for link. e.g.: ff0000',
   180|     )
   181|     parser.add_argument(
   182|         '--brand-btn-bg-color',
   183|         '--btn-bg-color',
   184|         type=css_color,
   185|         dest='btn_bg_color',
   186|         help="define a CSS color to be used for button's background. Default to `link-color` if undefined",
   187|     )
   188|     parser.add_argument(
   189|         '--brand-btn-fg-color',
   190|         '--btn-fg-color',
   191|         type=css_color,
   192|         dest='btn_fg_color',
   193|         help="define a CSS color to be used for button's text. Default to white if undefined",
   194|     )
   195|     parser.add_argument(
   196|         '--brand-btn-rounded',
   197|         '--btn-rounded',
   198|         type=bool,
   199|         dest='btn_rounded',
   200|         help='define if the button should be rounded',
   201|     )
   202|     parser.add_argument(
   203|         '--brand-navbar-color',
   204|         '--navbar-color',
   205|         type=css_color,
   206|         dest='navbar_color',
   207|         help='define a CSS color to be used for navigation bar background e.g.: 00ff00',
   208|     )
   209|     parser.add_argument(
   210|         '--brand-font-family',
   211|         '--font-family',
   212|         type=css_font,
   213|         dest='font_family',
   214|         help='define a CSS font to be used as main font. e.g.: Roboto',
   215|     )
   216|     parser.add_argument(
   217|         '--ldap-add-missing-user',
   218|         '--addmissinguser',
   219|         action='store_true',
   220|         help='enable creation of users from LDAP when the credential are valid.',

# --- HUNK 2: Lines 480-520 ---
   480|     """
   481|     Custom config file parser to support rdiffweb config file format.
   482|     """
   483|     def get_syntax_description(self):
   484|         msg = "Configuration file syntax allows: key=value, flag=true."
   485|         return msg
   486|     def parse(self, stream):
   487|         """
   488|         Used to read the rdiffweb config file as dict.
   489|         """
   490|         result = OrderedDict()
   491|         for i, line in enumerate(stream):
   492|             line = re.compile("(.*?)#.*").sub(r'\1', line).strip()
   493|             if not line:
   494|                 continue
   495|             if '=' not in line:
   496|                 raise configargparse.ConfigFileParserException(
   497|                     "Unexpected line {} in {}: {}".format(i, getattr(stream, 'name', 'stream'), line)
   498|                 )
   499|             split_line = line.partition('=')
   500|             if len(split_line) != 3:
   501|                 raise configargparse.ConfigFileParserException(
   502|                     "Unexpected line {} in {}: {}".format(i, getattr(stream, 'name', 'stream'), line)
   503|                 )
   504|             key = split_line[0].lower().strip().replace('_', '-')
   505|             value = split_line[2].strip()
   506|             m = re.match("welcome-?msg\\[(ca|en|es|fr|ru)\\]", key.lower())
   507|             if m:
   508|                 key = "welcome-msg-" + m.group(1)
   509|                 value = m.group(1) + ":" + value
   510|             result[key] = value
   511|         return result
   512| class Option(object):
   513|     def __init__(self, key):
   514|         assert key
   515|         self.key = key
   516|     def __get__(self, instance, owner):
   517|         """
   518|         Return a property to wrap the given option.
   519|         """
   520|         return self.get(instance)


# ====================================================================
# FILE: rdiffweb/rdw_app.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 42-120 ---
    42| from rdiffweb.controller.page_status import StatusPage
    43| from rdiffweb.core import rdw_templating
    44| from rdiffweb.core.config import parse_args
    45| from rdiffweb.core.model import DbSession, UserObject
    46| logger = logging.getLogger(__name__)
    47| cherrypy.config.environments['development'] = {
    48|     'engine.autoreload.on': True,
    49|     'checker.on': False,
    50|     'tools.log_headers.on': True,
    51|     'request.show_tracebacks': True,
    52|     'request.show_mismatched_params': True,
    53|     'log.screen': False,
    54| }
    55| @cherrypy.tools.auth_form()
    56| @cherrypy.tools.auth_mfa(
    57|     mfa_enabled=lambda username: UserObject.get_user(username).mfa == UserObject.ENABLED_MFA,
    58| )
    59| @cherrypy.tools.currentuser(userobj=lambda username: UserObject.get_user(username))
    60| @cherrypy.tools.db()
    61| @cherrypy.tools.enrich_session()
    62| @cherrypy.tools.proxy(local=None, remote='X-Real-IP')
    63| @cherrypy.tools.secure_headers()
    64| class Root(LocationsPage):
    65|     def __init__(self):
    66|         self.login = LoginPage()
    67|         self.mfa = MfaPage()
    68|         self.browse = BrowsePage()
    69|         self.delete = DeletePage()
    70|         self.restore = RestorePage()
    71|         self.history = HistoryPage()
    72|         self.status = StatusPage()
    73|         self.admin = AdminPage()
    74|         self.prefs = PreferencesPage()
    75|         self.settings = SettingsPage()
    76|         self.api = ApiPage()
    77|         self.api.currentuser.sshkeys = ApiSshKeys()
    78|         self.graphs = GraphsPage()
    79|         self.logs = LogsPage()
    80|         static_dir = pkg_resources.resource_filename('rdiffweb', 'static')  # @UndefinedVariable
    81|         self.static = staticdir(static_dir)
    82|         robots_txt = pkg_resources.resource_filename('rdiffweb', 'static/robots.txt')  # @UndefinedVariable
    83|         self.robots_txt = staticfile(robots_txt)
    84|     @cherrypy.expose
    85|     @cherrypy.tools.auth_form(on=False)
    86|     @cherrypy.tools.auth_mfa(on=False)
    87|     @cherrypy.tools.ratelimit(on=False)
    88|     @cherrypy.tools.sessions(on=False)
    89|     @cherrypy.tools.secure_headers(on=False)
    90|     @cherrypy.tools.caching(on=True)
    91|     def default_css(self):
    92|         if cherrypy.request.method not in ('GET', 'HEAD'):
    93|             raise cherrypy.HTTPError(400)
    94|         cfg = self.app.cfg
    95|         param = {'font_family': 'Open Sans'}
    96|         if cfg.default_theme == 'default':
    97|             param.update({'link_color': '#35979c', 'navbar_color': '#383e45'})
    98|             for key in ['link_color', 'btn_bg_color', 'btn_fg_color', 'navbar_color', 'font_family']:
    99|                 if getattr(cfg, key, None):
   100|                     param[key] = getattr(cfg, key, None)
   101|         elif cfg.default_theme == 'blue':
   102|             param.update({'link_color': '#153a58', 'navbar_color': '#153a58'})
   103|         elif cfg.default_theme == 'orange':
   104|             param.update({'link_color': '#dd4814', 'navbar_color': '#dd4814'})
   105|         cherrypy.response.headers['Content-Type'] = 'text/css'
   106|         return self._compile_template("default.css", **param)
   107| class RdiffwebApp(Application):
   108|     """This class represent the application context."""
   109|     @classmethod
   110|     def parse_args(cls, args=None, config_file_contents=None):
   111|         return parse_args(args, config_file_contents)
   112|     def __init__(self, cfg):
   113|         self.cfg = cfg
   114|         db_uri = self.cfg.database_uri if '://' in self.cfg.database_uri else "sqlite:///" + self.cfg.database_uri
   115|         cherrypy.config.update(
   116|             {
   117|                 'environment': 'development' if cfg.debug else cfg.environment,
   118|                 'tools.db.uri': db_uri,
   119|                 'tools.db.debug': cfg.debug,
   120|                 'ldap.uri': cfg.ldap_uri,


# ====================================================================
# FILE: rdiffweb/tools/auth_form.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 49-89 ---
    49|             cookie['session_id']['expires'] = httputil.HTTPDate(time.time() + session.timeout * 60)
    50|         else:
    51|             session_idle_timeout = cherrypy.request.config.get('tools.sessions.timeout', 60)
    52|             expiration1 = session.now() + datetime.timedelta(minutes=session_idle_timeout)
    53|             expiration2 = session[LOGIN_TIME] + datetime.timedelta(minutes=absolute_timeout)
    54|             expiration = min(expiration1, expiration2)
    55|             session.timeout = int((expiration - session.now()).total_seconds() / 60)
    56|     def redirect_to_original_url(self):
    57|         raise cherrypy.HTTPRedirect(self._get_redirect_url())
    58|     def run(self, login_url='/login/', logout_url='/logout', persistent_timeout=43200, absolute_timeout=30):
    59|         """
    60|         A tool that verify if the session is associated to a user by tracking
    61|         a session key. If session is not authenticated, redirect user to login page.
    62|         """
    63|         request = cherrypy.serving.request
    64|         if request.path_info == login_url:
    65|             if self._is_login():
    66|                 raise cherrypy.HTTPRedirect('/')
    67|             return
    68|         if request.path_info == logout_url or request.path_info.startswith(logout_url):
    69|             if request.method != 'POST':
    70|                 raise cherrypy.HTTPError(405)
    71|             self.logout()
    72|             raise cherrypy.HTTPRedirect('/')
    73|         if not self._is_login():
    74|             self._set_redirect_url()
    75|             raise cherrypy.HTTPRedirect(login_url)
    76|         self._update_session_timeout()
    77|     def login(self, username, persistent=False):
    78|         """
    79|         Must be called by the page hanlder when the authentication is successful.
    80|         """
    81|         cherrypy.session[LOGIN_PERSISTENT] = persistent
    82|         cherrypy.session[SESSION_KEY] = username
    83|         cherrypy.session[LOGIN_TIME] = cherrypy.session.now()
    84|         cherrypy.session.regenerate()
    85|         self._update_session_timeout()
    86|     def logout(self):
    87|         cherrypy.session.clear()
    88|         cherrypy.session.regenerate()
    89| cherrypy.tools.auth_form = CheckAuthForm()

