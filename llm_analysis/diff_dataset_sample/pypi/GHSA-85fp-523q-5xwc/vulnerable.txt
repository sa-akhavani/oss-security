# ====================================================================
# FILE: rdiffweb/controller/page_mfa.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| import logging
     2| import cherrypy
     3| from wtforms.fields import BooleanField, StringField, SubmitField
     4| from wtforms.validators import ValidationError
     5| from rdiffweb.controller import Controller, flash
     6| from rdiffweb.controller.form import CherryForm
     7| from rdiffweb.tools.auth_form import LOGIN_PERSISTENT
     8| from rdiffweb.tools.i18n import gettext_lazy as _
     9| logger = logging.getLogger(__name__)
    10| class MfaForm(CherryForm):
    11|     code = StringField(
    12|         _('Verification code'),
    13|         description=_('Enter the code to verify your identity.'),
    14|         render_kw={
    15|             "class": "form-control-lg",
    16|             "placeholder": _('Enter verification code here'),
    17|             "autocomplete": "off",
    18|             "autocorrect": "off",
    19|             "autofocus": "autofocus",
    20|         },
    21|     )
    22|     persistent = BooleanField(
    23|         _('Remember me'),
    24|         default=lambda: cherrypy.session.get(LOGIN_PERSISTENT, False),
    25|     )
    26|     submit = SubmitField(
    27|         _('Sign in'),
    28|         render_kw={"class": "btn-primary btn-lg btn-block"},
    29|     )
    30|     resend_code = SubmitField(
    31|         _('Resend code to my email'),
    32|         render_kw={"class": "btn-link btn-sm btn-block"},
    33|     )


# ====================================================================
# FILE: rdiffweb/core/config.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 160-199 ---
   160|         '--brand-header-logo',
   161|         '--header-logo',
   162|         '--headerlogo',
   163|         dest='header_logo',
   164|         help='location of an image (preferably a .svg) to be used as a replacement for the rdiffweb header logo displayed in navigation bar.',
   165|     )
   166|     parser.add_argument(
   167|         '--brand-header-name',
   168|         '--header-name',
   169|         '--headername',
   170|         dest='header_name',
   171|         help='application name displayed in the title bar and header menu.',
   172|         default='Rdiffweb',
   173|     )
   174|     parser.add_argument(
   175|         '--brand-link-color',
   176|         '--link-color',
   177|         type=css_color,
   178|         dest='link_color',
   179|         help='define a CSS color to be used for link. e.g.: ff0000',
   180|     )
   181|     parser.add_argument(
   182|         '--brand-navbar-color',
   183|         '--navbar-color',
   184|         type=css_color,
   185|         dest='navbar_color',
   186|         help='define a CSS color to be used for navigation bar background e.g.: 00ff00',
   187|     )
   188|     parser.add_argument(
   189|         '--brand-font-family',
   190|         '--font-family',
   191|         type=css_font,
   192|         dest='font_family',
   193|         help='define a CSS font to be used as main font. e.g.: Roboto',
   194|     )
   195|     parser.add_argument(
   196|         '--ldap-add-missing-user',
   197|         '--addmissinguser',
   198|         action='store_true',
   199|         help='enable creation of users from LDAP when the credential are valid.',

# --- HUNK 2: Lines 459-499 ---
   459|     """
   460|     Custom config file parser to support rdiffweb config file format.
   461|     """
   462|     def get_syntax_description(self):
   463|         msg = "Configuration file syntax allows: key=value, flag=true."
   464|         return msg
   465|     def parse(self, stream):
   466|         """
   467|         Used to read the rdiffweb config file as dict.
   468|         """
   469|         result = OrderedDict()
   470|         for i, line in enumerate(stream):
   471|             line = re.compile("(.*?)#.*").sub(r'\1', line).strip()
   472|             if not line:
   473|                 continue
   474|             if '=' not in line:
   475|                 raise configargparse.ConfigFileParserException(
   476|                     "Unexpected line {} in {}: {}".format(i, getattr(stream, 'name', 'stream'), line)
   477|                 )
   478|             split_line = line.partition('=')
   479|             if not len(split_line) == 3:
   480|                 raise configargparse.ConfigFileParserException(
   481|                     "Unexpected line {} in {}: {}".format(i, getattr(stream, 'name', 'stream'), line)
   482|                 )
   483|             key = split_line[0].lower().strip().replace('_', '-')
   484|             value = split_line[2].strip()
   485|             m = re.match("welcome-?msg\\[(ca|en|es|fr|ru)\\]", key.lower())
   486|             if m:
   487|                 key = "welcome-msg-" + m.group(1)
   488|                 value = m.group(1) + ":" + value
   489|             result[key] = value
   490|         return result
   491| class Option(object):
   492|     def __init__(self, key):
   493|         assert key
   494|         self.key = key
   495|     def __get__(self, instance, owner):
   496|         """
   497|         Return a property to wrap the given option.
   498|         """
   499|         return self.get(instance)


# ====================================================================
# FILE: rdiffweb/rdw_app.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 42-123 ---
    42| from rdiffweb.controller.page_status import StatusPage
    43| from rdiffweb.core import rdw_templating
    44| from rdiffweb.core.config import parse_args
    45| from rdiffweb.core.model import DbSession, UserObject
    46| logger = logging.getLogger(__name__)
    47| cherrypy.config.environments['development'] = {
    48|     'engine.autoreload.on': True,
    49|     'checker.on': False,
    50|     'tools.log_headers.on': True,
    51|     'request.show_tracebacks': True,
    52|     'request.show_mismatched_params': True,
    53|     'log.screen': False,
    54| }
    55| @cherrypy.tools.auth_form()
    56| @cherrypy.tools.auth_mfa(
    57|     mfa_enabled=lambda username: UserObject.get_user(username).mfa == UserObject.ENABLED_MFA,
    58| )
    59| @cherrypy.tools.currentuser(userobj=lambda username: UserObject.get_user(username))
    60| @cherrypy.tools.db()
    61| @cherrypy.tools.enrich_session()
    62| @cherrypy.tools.proxy(remote='X-Real-IP')
    63| @cherrypy.tools.secure_headers()
    64| class Root(LocationsPage):
    65|     def __init__(self):
    66|         self.login = LoginPage()
    67|         self.mfa = MfaPage()
    68|         self.browse = BrowsePage()
    69|         self.delete = DeletePage()
    70|         self.restore = RestorePage()
    71|         self.history = HistoryPage()
    72|         self.status = StatusPage()
    73|         self.admin = AdminPage()
    74|         self.prefs = PreferencesPage()
    75|         self.settings = SettingsPage()
    76|         self.api = ApiPage()
    77|         self.api.currentuser.sshkeys = ApiSshKeys()
    78|         self.graphs = GraphsPage()
    79|         self.logs = LogsPage()
    80|         static_dir = pkg_resources.resource_filename('rdiffweb', 'static')  # @UndefinedVariable
    81|         self.static = staticdir(static_dir)
    82|         robots_txt = pkg_resources.resource_filename('rdiffweb', 'static/robots.txt')  # @UndefinedVariable
    83|         self.robots_txt = staticfile(robots_txt)
    84|     @cherrypy.expose
    85|     @cherrypy.tools.auth_form(on=False)
    86|     @cherrypy.tools.auth_mfa(on=False)
    87|     @cherrypy.tools.ratelimit(on=False)
    88|     @cherrypy.tools.sessions(on=False)
    89|     @cherrypy.tools.secure_headers(on=False)
    90|     @cherrypy.tools.caching(on=True)
    91|     def default_css(self):
    92|         if cherrypy.request.method not in ('GET', 'HEAD'):
    93|             raise cherrypy.HTTPError(400)
    94|         cfg = self.app.cfg
    95|         param = {'font_family': 'Open Sans'}
    96|         if cfg.default_theme == 'default':
    97|             param.update({'link_color': '#35979c', 'navbar_color': '#383e45'})
    98|             if cfg.link_color:
    99|                 param['link_color'] = cfg.link_color
   100|             if cfg.navbar_color:
   101|                 param['navbar_color'] = cfg.navbar_color
   102|             if cfg.font_family:
   103|                 param['font_family'] = cfg.font_family
   104|         elif cfg.default_theme == 'blue':
   105|             param.update({'link_color': '#153a58', 'navbar_color': '#153a58'})
   106|         elif cfg.default_theme == 'orange':
   107|             param.update({'link_color': '#dd4814', 'navbar_color': '#dd4814'})
   108|         cherrypy.response.headers['Content-Type'] = 'text/css'
   109|         return self._compile_template("default.css", **param)
   110| class RdiffwebApp(Application):
   111|     """This class represent the application context."""
   112|     @classmethod
   113|     def parse_args(cls, args=None, config_file_contents=None):
   114|         return parse_args(args, config_file_contents)
   115|     def __init__(self, cfg):
   116|         self.cfg = cfg
   117|         db_uri = self.cfg.database_uri if '://' in self.cfg.database_uri else "sqlite:///" + self.cfg.database_uri
   118|         cherrypy.config.update(
   119|             {
   120|                 'environment': 'development' if cfg.debug else cfg.environment,
   121|                 'tools.db.uri': db_uri,
   122|                 'tools.db.debug': cfg.debug,
   123|                 'ldap.uri': cfg.ldap_uri,


# ====================================================================
# FILE: rdiffweb/tools/auth_form.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 49-87 ---
    49|             cookie['session_id']['expires'] = httputil.HTTPDate(time.time() + session.timeout * 60)
    50|         else:
    51|             session_idle_timeout = cherrypy.request.config.get('tools.sessions.timeout', 60)
    52|             expiration1 = session.now() + datetime.timedelta(minutes=session_idle_timeout)
    53|             expiration2 = session[LOGIN_TIME] + datetime.timedelta(minutes=absolute_timeout)
    54|             expiration = min(expiration1, expiration2)
    55|             session.timeout = int((expiration - session.now()).total_seconds() / 60)
    56|     def redirect_to_original_url(self):
    57|         raise cherrypy.HTTPRedirect(self._get_redirect_url())
    58|     def run(self, login_url='/login/', logout_url='/logout', persistent_timeout=43200, absolute_timeout=30):
    59|         """
    60|         A tool that verify if the session is associated to a user by tracking
    61|         a session key. If session is not authenticated, redirect user to login page.
    62|         """
    63|         request = cherrypy.serving.request
    64|         if request.path_info == login_url:
    65|             if self._is_login():
    66|                 raise cherrypy.HTTPRedirect('/')
    67|             return
    68|         if request.path_info == logout_url or request.path_info.startswith(logout_url):
    69|             self.logout()
    70|             raise cherrypy.HTTPRedirect('/')
    71|         if not self._is_login():
    72|             self._set_redirect_url()
    73|             raise cherrypy.HTTPRedirect(login_url)
    74|         self._update_session_timeout()
    75|     def login(self, username, persistent=False):
    76|         """
    77|         Must be called by the page hanlder when the authentication is successful.
    78|         """
    79|         cherrypy.session[LOGIN_PERSISTENT] = persistent
    80|         cherrypy.session[SESSION_KEY] = username
    81|         cherrypy.session[LOGIN_TIME] = cherrypy.session.now()
    82|         cherrypy.session.regenerate()
    83|         self._update_session_timeout()
    84|     def logout(self):
    85|         cherrypy.session.clear()
    86|         cherrypy.session.regenerate()
    87| cherrypy.tools.auth_form = CheckAuthForm()

