--- a/setup.py
+++ b/setup.py
@@ -2,21 +2,21 @@
 import sys
 sys.path.insert(0, os.path.dirname(__file__))
 import setuptools  # noqa: F401,E402
 try:
     import octoprint_setuptools  # noqa: F401,E402
 except ImportError:
     octoprint_setuptools = None
 PYTHON_REQUIRES = ">=3.7, <3.13"
 SETUP_REQUIRES = []
 bundled_plugins = [
-    "OctoPrint-FileCheck>=2024.3.27",
+    "OctoPrint-FileCheck>=2021.2.23",
     "OctoPrint-FirmwareCheck>=2021.10.11",
     "OctoPrint-PiSupport>=2023.10.10",
 ]
 core_deps = [
     "argon2-cffi>=23.1.0",
     "Babel>=2.12.1,<2.13",  # breaking changes can happen on minor version increases
     "cachelib>=0.10.2,<0.11",
     "Click>=8.1.7,<9",
     "colorlog>=6.7.0,<7",
     "emoji>=2.10.1,<3",

--- a/src/octoprint/_version.py
+++ b/src/octoprint/_version.py
@@ -21,22 +21,22 @@
 """
 import errno
 import os
 import re
 import subprocess
 import sys
 BRANCH_VERSIONS = """
 maintenance 1.10.0 cd955e9a46782119b36cc22b8dea5652ebbf9774
 fix/.* 1.10.0 cd955e9a46782119b36cc22b8dea5652ebbf9774
 improve/.* 1.10.0 cd955e9a46782119b36cc22b8dea5652ebbf9774
-staging/bugfix 1.10.3 ad9ebcaa0ef91950652fb2561b7c06b79d95a455
-bug/.* 1.10.3 ad9ebcaa0ef91950652fb2561b7c06b79d95a455
+staging/bugfix 1.10.2 e18547582a7dcd381b600eb32822799c8bb238f9
+bug/.* 1.10.2 e18547582a7dcd381b600eb32822799c8bb238f9
 staging/maintenance 1.10.0rc5 https://data.octoprint.org/#achievements
 regressionfix/.* 1.10.0rc5 https://data.octoprint.org/#achievements
 staging/devel 1.4.1rc4 650d54d1885409fa1d411eb54b9e8c7ff428910f
 devel 2.0.0 2da7aa358d950b4567aaab8f18d6b5779193e077
 dev/* 2.0.0 2da7aa358d950b4567aaab8f18d6b5779193e077
 feature/* 2.0.0 2da7aa358d950b4567aaab8f18d6b5779193e077
 """
 package_root = os.path.dirname(os.path.realpath(__file__))
 package_name = os.path.basename(package_root)
 STATIC_FILE = "_static_version.py"

--- a/src/octoprint/access/users.py
+++ b/src/octoprint/access/users.py
@@ -1,18 +1,18 @@
 __license__ = "GNU Affero General Public License http://www.gnu.org/licenses/agpl.html"
 __copyright__ = "Copyright (C) 2014 The OctoPrint Project - Released under terms of the AGPLv3 License"
 import hashlib
 import logging
 import os
-import secrets
 import shutil
 import time
+import uuid
 import wrapt
 from flask_login import AnonymousUserMixin, UserMixin
 from passlib.hash import pbkdf2_sha256
 from werkzeug.local import LocalProxy
 from octoprint.access.groups import Group, GroupChangeListener
 from octoprint.access.permissions import OctoPrintPermission, Permissions
 from octoprint.settings import settings as s
 from octoprint.util import atomic_write, deprecated, generate_api_key
 from octoprint.util import get_fully_qualified_classname as fqcn
 from octoprint.util import to_bytes, yaml
@@ -1103,21 +1103,21 @@
     def check_password(self, passwordHash):
         return True
     def as_dict(self):
         from octoprint.access.permissions import OctoPrintPermission
         return {"needs": OctoPrintPermission.convert_needs_to_dict(self.needs)}
     def __repr__(self):
         return "AnonymousUser(groups=%s)" % self._groups
 class SessionUser(wrapt.ObjectProxy):
     def __init__(self, user):
         wrapt.ObjectProxy.__init__(self, user)
-        self._self_session = secrets.token_hex()
+        self._self_session = "".join("%02X" % z for z in bytes(uuid.uuid4().bytes))
         self._self_created = self._self_touched = time.monotonic()
     @property
     def session(self):
         return self._self_session
     @property
     def created(self):
         return self._self_created
     @property
     def touched(self):
         return self._self_touched

--- a/src/octoprint/filemanager/storage.py
+++ b/src/octoprint/filemanager/storage.py
@@ -429,21 +429,21 @@
             except Exception:
                 self._logger.exception("Error while loading old metadata file")
             self._list_folder(self.basefolder)
             self._old_metadata = None
             try:
                 import shutil
                 shutil.move(old_metadata_path, backup_path)
             except Exception:
                 self._logger.exception("Could not rename old metadata.yaml file")
         else:
-            self._list_folder(self.basefolder, fill_cache=False)
+            self._list_folder(self.basefolder)
         self._logger.info(
             f"... file metadata for {self.basefolder} initialized successfully."
         )
     @property
     def analysis_backlog(self):
         return self.analysis_backlog_for_path()
     def analysis_backlog_for_path(self, path=None):
         if path:
             path = self.sanitize_path(path)
         yield from self._analysis_backlog_generator(path)
@@ -1235,21 +1235,21 @@
                     metadata[name]["links"].remove(link)
                     metadata_dirty = True
         if metadata_dirty:
             self._save_metadata(path, metadata)
     @time_this(
         logtarget=__name__ + ".timings",
         message="{func}({func_args},{func_kwargs}) took {timing:.2f}ms",
         incl_func_args=True,
         log_enter=True,
     )
-    def _list_folder(self, path, base="", force_refresh=False, fill_cache=True, **kwargs):
+    def _list_folder(self, path, base="", force_refresh=False, **kwargs):
         def get_size(nodes):
             total_size = 0
             for node in nodes.values():
                 if "size" in node:
                     total_size += node["size"]
             return total_size
         def enrich_folders(nodes):
             nodes = copy.copy(nodes)
             for key, value in nodes.items():
                 if value["type"] == "folder":
@@ -1380,25 +1380,24 @@
                                 "typePath": ["folder"],
                             }
                             if entry_stat:
                                 entry_data["date"] = int(entry_stat.st_mtime)
                             result[entry_name] = entry_data
                     except Exception:
                         self._logger.exception(
                             f"Error while processing entry {entry_path}"
                         )
                         continue
-                if fill_cache:
-                    self._filelist_cache[path] = (
-                        lm,
-                        result,
-                    )
+                self._filelist_cache[path] = (
+                    lm,
+                    result,
+                )
                 return enrich_folders(result)
         finally:
             if metadata_dirty:
                 self._save_metadata(path, metadata)
     def _add_basic_metadata(
         self,
         path,
         entry,
         display_name=None,
         additional_metadata=None,

--- a/src/octoprint/plugins/appkeys/__init__.py
+++ b/src/octoprint/plugins/appkeys/__init__.py
@@ -199,21 +199,21 @@
         response = flask.make_response(
             flask.render_template(
                 "plugin_appkeys/appkeys_authdialog.jinja2",
                 app=app_id,
                 user=user_id,
                 user_token=user_token,
                 redirect_url=redirect_url,
                 theming=[],
                 request_text=gettext(
                     '"<strong>%(app)s</strong>" has requested access to control OctoPrint through the API.'
-                ),
+                ).replace("%(app)s", app_id),
             )
         )
         return add_csrf_cookie(add_non_caching_response_headers(response))
     @octoprint.plugin.BlueprintPlugin.route("/decision/<user_token>", methods=["POST"])
     @restricted_access
     def handle_decision(self, user_token):
         data = flask.request.json
         if "decision" not in data:
             flask.abort(400, description="No decision provided")
         if not Permissions.PLUGIN_APPKEYS_GRANT.can():

--- a/src/octoprint/plugins/discovery/__init__.py
+++ b/src/octoprint/plugins/discovery/__init__.py
@@ -66,33 +66,36 @@
                 "vendorUrl": None,
             },
             "addresses": None,
             "ignoredAddresses": None,
             "interfaces": None,
             "ignoredInterfaces": None,
         }
     @octoprint.plugin.BlueprintPlugin.route("/discovery.xml", methods=["GET"])
     def discovery(self):
         self._logger.debug("Rendering discovery.xml")
+        modelName = self._settings.get(["model", "name"])
+        if not modelName:
+            import octoprint.server
+            modelName = octoprint.server.DISPLAY_VERSION
         vendor = self._settings.get(["model", "vendor"])
+        vendorUrl = self._settings.get(["model", "vendorUrl"])
         if not vendor:
             vendor = "The OctoPrint Project"
-        vendorUrl = self._settings.get(["model", "vendorUrl"])
-        if not vendorUrl:
-            vendorUrl = "https://octoprint.org/"
+            vendorUrl = "http://www.octoprint.org/"
         response = flask.make_response(
             flask.render_template(
                 "discovery.xml.jinja2",
                 friendlyName=self.get_instance_name(),
                 manufacturer=vendor,
                 manufacturerUrl=vendorUrl,
-                modelName=self._settings.get(["model", "name"]),
+                modelName=modelName,
                 modelDescription=self._settings.get(["model", "description"]),
                 modelNumber=self._settings.get(["model", "number"]),
                 modelUrl=self._settings.get(["model", "url"]),
                 serialNumber=self._settings.get(["model", "serial"]),
                 uuid=self.get_uuid(),
                 presentationUrl=flask.url_for("index", _external=True),
             )
         )
         response.headers["Content-Type"] = "application/xml"
         return response

--- a/src/octoprint/plugins/errortracking/__init__.py
+++ b/src/octoprint/plugins/errortracking/__init__.py
@@ -7,24 +7,24 @@
 import tornado.websocket
 from flask import jsonify
 from flask_babel import gettext
 import octoprint.plugin
 from octoprint.util import get_fully_qualified_classname as fqcn  # noqa: F401
 from octoprint.util.version import (
     get_octoprint_version_string,
     is_released_octoprint_version,
 )
 SENTRY_URL_SERVER = (
-    "https://29b1e6277b6d466f2a54ce5ce294d53a@o118517.ingest.us.sentry.io/1373987"
+    "https://fc0e29027267843275a25ccb977fd622@o118517.ingest.us.sentry.io/1373987"
 )
 SENTRY_URL_COREUI = (
-    "https://f3ff884d1875cd4f697a7099041d29c4@o118517.ingest.us.sentry.io/1374096"
+    "https://abc2a1365195f4eac742746eff1236de@o118517.ingest.us.sentry.io/1374096"
 )
 SETTINGS_DEFAULTS = {
     "enabled": False,
     "enabled_unreleased": False,
     "unique_id": None,
     "url_server": SENTRY_URL_SERVER,
     "url_coreui": SENTRY_URL_COREUI,
 }
 IGNORED_EXCEPTIONS = [
     (

--- a/src/octoprint/plugins/gcodeviewer/__init__.py
+++ b/src/octoprint/plugins/gcodeviewer/__init__.py
@@ -1,18 +1,16 @@
 __license__ = "GNU Affero General Public License http://www.gnu.org/licenses/agpl.html"
 __copyright__ = "Copyright (C) 2020 The OctoPrint Project - Released under terms of the AGPLv3 License"
 import os
 import flask
 from flask_babel import gettext
 import octoprint.plugin
-from octoprint.access.permissions import Permissions
-from octoprint.server.util.flask import no_firstrun_access
 from octoprint.util.files import search_through_file
 class GcodeviewerPlugin(
     octoprint.plugin.AssetPlugin,
     octoprint.plugin.TemplatePlugin,
     octoprint.plugin.SettingsPlugin,
     octoprint.plugin.BlueprintPlugin,
 ):
     def get_assets(self):
         js = [
             "js/gcodeviewer.js",
@@ -63,23 +61,20 @@
                 if "mobileSizeThreshold" in config:
                     self._settings.set_int(
                         ["mobileSizeThreshold"], config["mobileSizeThreshold"]
                     )
                 if "sizeThreshold" in config:
                     self._settings.set_int(["sizeThreshold"], config["sizeThreshold"])
                 self._settings.global_remove(["gcodeViewer"])
     @octoprint.plugin.BlueprintPlugin.route(
         "/skipuntilcheck/<string:origin>/<path:filename>", methods=["GET"]
     )
-    @no_firstrun_access
-    @Permissions.GCODE_VIEWER.require(403)
-    @Permissions.FILES_DOWNLOAD.require(403)
     def check_skip_until_presence(self, origin, filename):
         try:
             path = self._file_manager.path_on_disk(origin, filename)
         except NotImplementedError:
             flask.abort(404)
         if not os.path.exists(path):
             flask.abort(404)
         skipUntilThis = self._settings.get(["skipUntilThis"])
         if not skipUntilThis:
             return flask.jsonify(present=False)

--- a/src/octoprint/plugins/pluginmanager/__init__.py
+++ b/src/octoprint/plugins/pluginmanager/__init__.py
@@ -601,29 +601,22 @@
             "cleanup": ["plugin"],
             "cleanup_all": [],
             "refresh_repository": [],
             "clear_queued_plugin": ["plugin"],
             "clear_queued_installs": [],
         }
     def on_api_command(self, command, data):
         if not Permissions.PLUGIN_PLUGINMANAGER_MANAGE.can():
             abort(403)
         if command == "clear_queued_plugin":
-            if data["plugin"]:
-                match = [
-                    x
-                    for x in self._queued_installs
-                    if x.items() >= data["plugin"].items()
-                ]
-                if match:
-                    for m in match:
-                        self._queued_installs.remove(m)
+            if data["plugin"] and data["plugin"] in self._queued_installs:
+                self._queued_installs.remove(data["plugin"])
             return (
                 jsonify({"queued_installs": self._queued_installs}),
                 202,
             )
         elif command == "clear_queued_installs":
             self._queued_installs.clear()
             return (
                 jsonify({"queued_installs": self._queued_installs}),
                 202,
             )

--- a/src/octoprint/plugins/pluginmanager/static/js/pluginmanager.js
+++ b/src/octoprint/plugins/pluginmanager/static/js/pluginmanager.js
@@ -1041,21 +1041,23 @@
                 data.title,
                 self.installed(data) ? data.id : undefined,
                 data.follow_dependency_links || self.followDependencyLinks(),
                 true
             );
         };
         self.removeFromQueue = function (plugin) {
             var data = {
                 plugin: {
                     command: self.installed(plugin) ? "reinstall" : "install",
-                    url: plugin.archive
+                    url: plugin.archive,
+                    dependency_links:
+                        plugin.follow_dependency_links || self.followDependencyLinks()
                 }
             };
             OctoPrint.simpleApiCommand("pluginmanager", "clear_queued_plugin", data).done(
                 function (response) {
                     self.queuedInstalls(response.queued_installs);
                 }
             );
         };
         self.installPlugin = function (
             url,

--- a/src/octoprint/server/__init__.py
+++ b/src/octoprint/server/__init__.py
@@ -1180,22 +1180,24 @@
         app.jinja_environment = PrefixAwareJinjaEnvironment
         app.config["TEMPLATES_AUTO_RELOAD"] = True
         app.config["REMEMBER_COOKIE_DURATION"] = 90 * 24 * 60 * 60  # 90 days
         app.config["REMEMBER_COOKIE_HTTPONLY"] = True
         app.debug = self._debug
         app.json = OctoPrintJsonProvider(app)
         app.json.compact = False
         s = settings()
         secret_key = s.get(["server", "secretKey"])
         if not secret_key:
-            import secrets
-            secret_key = secrets.token_hex()
+            import string
+            from random import choice
+            chars = string.ascii_lowercase + string.ascii_uppercase + string.digits
+            secret_key = "".join(choice(chars) for _ in range(32))
             s.set(["server", "secretKey"], secret_key)
             s.save()
         app.secret_key = secret_key
         reverse_proxied = ReverseProxiedEnvironment(
             header_prefix=s.get(["server", "reverseProxy", "prefixHeader"]),
             header_scheme=s.get(["server", "reverseProxy", "schemeHeader"]),
             header_host=s.get(["server", "reverseProxy", "hostHeader"]),
             header_server=s.get(["server", "reverseProxy", "serverHeader"]),
             header_port=s.get(["server", "reverseProxy", "portHeader"]),
             prefix=s.get(["server", "reverseProxy", "prefixFallback"]),

--- a/src/octoprint/server/api/access.py
+++ b/src/octoprint/server/api/access.py
@@ -2,21 +2,20 @@
 __license__ = "GNU Affero General Public License http://www.gnu.org/licenses/agpl.html"
 __copyright__ = "Copyright (C) 2017 The OctoPrint Project - Released under terms of the AGPLv3 License"
 from flask import abort, jsonify, request
 from flask_login import current_user
 import octoprint.access.groups as groups
 import octoprint.access.users as users
 from octoprint.access.permissions import Permissions
 from octoprint.server import SUCCESS, groupManager, userManager
 from octoprint.server.api import api, valid_boolean_trues
 from octoprint.server.util.flask import (
-    credentials_checked_recently,
     ensure_credentials_checked_recently,
     no_firstrun_access,
     require_credentials_checked_recently,
 )
 @api.route("/access/permissions", methods=["GET"])
 def get_permissions():
     return jsonify(permissions=[permission.as_dict() for permission in Permissions.all()])
 @api.route("/access/groups", methods=["GET"])
 @no_firstrun_access
 @Permissions.ADMIN.require(403)
@@ -92,25 +91,21 @@
         groupManager.remove_group(key)
         return get_groups()
     except groups.UnknownGroup:
         abort(404)
     except groups.GroupUnremovable:
         abort(403)
 @api.route("/access/users", methods=["GET"])
 @no_firstrun_access
 @Permissions.ADMIN.require(403)
 def get_users():
-    users = [u.as_dict() for u in userManager.get_all_users()]
-    if not credentials_checked_recently():
-        for u in users:
-            u["apikey"] = None
-    return jsonify(users=users)
+    return jsonify(users=list(map(lambda u: u.as_dict(), userManager.get_all_users())))
 @api.route("/access/users", methods=["POST"])
 @no_firstrun_access
 @require_credentials_checked_recently
 @Permissions.ADMIN.require(403)
 def add_user():
     data = request.get_json()
     if "name" not in data:
         abort(400, description="name is missing")
     if "password" not in data:
         abort(400, description="password is missing")
@@ -134,24 +129,21 @@
     if (
         current_user is not None
         and not current_user.is_anonymous
         and (
             current_user.get_name() == username
             or current_user.has_permission(Permissions.ADMIN)
         )
     ):
         user = userManager.find_user(username)
         if user is not None:
-            user_dict = user.as_dict()
-            if not credentials_checked_recently():
-                user_dict["apikey"] = None
-            return jsonify(user_dict)
+            return jsonify(user)
         else:
             abort(404)
     else:
         abort(403)
 @api.route("/access/users/<username>", methods=["PUT"])
 @no_firstrun_access
 @require_credentials_checked_recently
 @Permissions.ADMIN.require(403)
 def update_user(username):
     user = userManager.find_user(username)
@@ -247,42 +239,40 @@
     if current_user.get_name() != username:
         ensure_credentials_checked_recently()
     data = request.get_json()
     try:
         userManager.change_user_settings(username, data)
         return jsonify(SUCCESS)
     except users.UnknownUser:
         abort(404)
 @api.route("/access/users/<username>/apikey", methods=["DELETE"])
 @no_firstrun_access
-@require_credentials_checked_recently
 def delete_apikey_for_user(username):
     if (
         current_user is not None
         and not current_user.is_anonymous
         and (
             current_user.get_name() == username
             or current_user.has_permission(Permissions.ADMIN)
         )
     ):
         if current_user.get_name() != username:
             ensure_credentials_checked_recently()
         try:
             userManager.delete_api_key(username)
         except users.UnknownUser:
             abort(404)
         return jsonify(SUCCESS)
     else:
         abort(403)
 @api.route("/access/users/<username>/apikey", methods=["POST"])
 @no_firstrun_access
-@require_credentials_checked_recently
 def generate_apikey_for_user(username):
     if not userManager.enabled:
         return jsonify(SUCCESS)
     if (
         current_user is not None
         and not current_user.is_anonymous
         and (
             current_user.get_name() == username
             or current_user.has_permission(Permissions.ADMIN)
         )

--- a/src/octoprint/server/api/settings.py
+++ b/src/octoprint/server/api/settings.py
@@ -6,21 +6,20 @@
 from flask import abort, jsonify, request
 from flask_login import current_user
 import octoprint.plugin
 import octoprint.util
 from octoprint.access.permissions import Permissions
 from octoprint.server import pluginManager, printer, userManager
 from octoprint.server.api import NO_CONTENT, api
 from octoprint.server.util.flask import (
     credentials_checked_recently,
     no_firstrun_access,
-    require_credentials_checked_recently,
     with_revalidation_checking,
 )
 from octoprint.settings import settings, valid_boolean_trues
 from octoprint.timelapse import configure_timelapse
 from octoprint.webcams import (
     get_default_webcam,
     get_snapshot_webcam,
     get_webcams_as_dicts,
 )
 FOLDER_TYPES = ("uploads", "timelapse", "watched")
@@ -410,28 +409,26 @@
     data = request.get_json()
     if not isinstance(data, dict):
         abort(400, description="Malformed JSON body in request")
     response = _saveSettings(data)
     if response:
         return response
     return getSettings()
 @api.route("/settings/apikey", methods=["POST"])
 @no_firstrun_access
 @Permissions.ADMIN.require(403)
-@require_credentials_checked_recently
 def generateApiKey():
     apikey = settings().generateApiKey()
     return jsonify(apikey=apikey)
 @api.route("/settings/apikey", methods=["DELETE"])
 @no_firstrun_access
 @Permissions.ADMIN.require(403)
-@require_credentials_checked_recently
 def deleteApiKey():
     settings().deleteApiKey()
     return NO_CONTENT
 @api.route("/settings/templates", methods=["GET"])
 @no_firstrun_access
 @Permissions.SETTINGS.require(403)
 def fetchTemplateData():
     from octoprint.server.views import fetch_template_data
     refresh = request.values.get("refresh", "false") in valid_boolean_trues
     templates, _, _ = fetch_template_data(refresh=refresh)
@@ -491,22 +488,21 @@
                 ["accessControl", "autologinHeadsupAcknowledged"],
                 data["accessControl"]["autologinHeadsupAcknowledged"],
             )
     if "appearance" in data:
         if "name" in data["appearance"]:
             s.set(["appearance", "name"], data["appearance"]["name"])
         if "color" in data["appearance"]:
             s.set(["appearance", "color"], data["appearance"]["color"])
         if "colorTransparent" in data["appearance"]:
             s.setBoolean(
-                ["appearance", "colorTransparent"],
-                data["appearance"]["colorTransparent"],
+                ["appearance", "colorTransparent"], data["appearance"]["colorTransparent"]
             )
         if "colorIcon" in data["appearance"]:
             s.setBoolean(["appearance", "colorIcon"], data["appearance"]["colorIcon"])
         if "defaultLanguage" in data["appearance"]:
             s.set(
                 ["appearance", "defaultLanguage"], data["appearance"]["defaultLanguage"]
             )
         if "showFahrenheitAlso" in data["appearance"]:
             s.setBoolean(
                 ["appearance", "showFahrenheitAlso"],
@@ -547,24 +543,21 @@
         if "snapshotSslValidation" in data["webcam"]:
             s.setBoolean(
                 ["webcam", "snapshotSslValidation"],
                 data["webcam"]["snapshotSslValidation"],
             )
         if "ffmpegPath" in data["webcam"]:
             s.set(["webcam", "ffmpeg"], data["webcam"]["ffmpegPath"])
         if "ffmpegCommandline" in data["webcam"]:
             commandline = data["webcam"]["ffmpegCommandline"]
             if not all(
-                map(
-                    lambda x: "{" + x + "}" in commandline,
-                    ("ffmpeg", "input", "output"),
-                )
+                map(lambda x: "{" + x + "}" in commandline, ("ffmpeg", "input", "output"))
             ):
                 abort(
                     400,
                     description="Invalid webcam.ffmpegCommandline setting, lacks mandatory {ffmpeg}, {input} or {output}",
                 )
             try:
                 commandline.format(
                     ffmpeg="ffmpeg",
                     fps="fps",
                     bitrate="bitrate",
@@ -760,22 +753,21 @@
                 ["serial", "additionalBaudrates"], data["serial"]["additionalBaudrates"]
             )
         if "blacklistedPorts" in data["serial"] and isinstance(
             data["serial"]["blacklistedPorts"], (list, tuple)
         ):
             s.set(["serial", "blacklistedPorts"], data["serial"]["blacklistedPorts"])
         if "blacklistedBaudrates" in data["serial"] and isinstance(
             data["serial"]["blacklistedBaudrates"], (list, tuple)
         ):
             s.set(
-                ["serial", "blacklistedBaudrates"],
-                data["serial"]["blacklistedBaudrates"],
+                ["serial", "blacklistedBaudrates"], data["serial"]["blacklistedBaudrates"]
             )
         if "longRunningCommands" in data["serial"] and isinstance(
             data["serial"]["longRunningCommands"], (list, tuple)
         ):
             s.set(
                 ["serial", "longRunningCommands"], data["serial"]["longRunningCommands"]
             )
         if "checksumRequiringCommands" in data["serial"] and isinstance(
             data["serial"]["checksumRequiringCommands"], (list, tuple)
         ):
@@ -848,22 +840,21 @@
         if "sdRelativePath" in data["serial"]:
             s.setBoolean(["serial", "sdRelativePath"], data["serial"]["sdRelativePath"])
         if "sdAlwaysAvailable" in data["serial"]:
             s.setBoolean(
                 ["serial", "sdAlwaysAvailable"], data["serial"]["sdAlwaysAvailable"]
             )
         if "sdLowerCase" in data["serial"]:
             s.setBoolean(["serial", "sdLowerCase"], data["serial"]["sdLowerCase"])
         if "swallowOkAfterResend" in data["serial"]:
             s.setBoolean(
-                ["serial", "swallowOkAfterResend"],
-                data["serial"]["swallowOkAfterResend"],
+                ["serial", "swallowOkAfterResend"], data["serial"]["swallowOkAfterResend"]
             )
         if "repetierTargetTemp" in data["serial"]:
             s.setBoolean(
                 ["serial", "repetierTargetTemp"], data["serial"]["repetierTargetTemp"]
             )
         if "externalHeatupDetection" in data["serial"]:
             s.setBoolean(
                 ["serial", "externalHeatupDetection"],
                 data["serial"]["externalHeatupDetection"],
             )
@@ -947,35 +938,32 @@
             s.setBoolean(
                 ["serial", "capabilities", "busy_protocol"],
                 data["serial"]["capBusyProtocol"],
             )
         if "capEmergencyParser" in data["serial"]:
             s.setBoolean(
                 ["serial", "capabilities", "emergency_parser"],
                 data["serial"]["capEmergencyParser"],
             )
         if "capExtendedM20" in data["serial"]:
-            (
-                s.setBoolean(
-                    ["serial", "capabilities", "extended_m20"],
-                    data["serial"]["capExtendedM20"],
-                ),
-            )
+            s.setBoolean(
+                ["serial", "capabilities", "extended_m20"],
+                data["serial"]["capExtendedM20"],
+            ),
         if "capLfnWrite" in data["serial"]:
             s.setBoolean(
                 ["serial", "capabilities", "lfn_write"],
                 data["serial"]["capLfnWrite"],
             )
         if "resendRatioThreshold" in data["serial"]:
             s.setInt(
-                ["serial", "resendRatioThreshold"],
-                data["serial"]["resendRatioThreshold"],
+                ["serial", "resendRatioThreshold"], data["serial"]["resendRatioThreshold"]
             )
         if "resendRatioStart" in data["serial"]:
             s.setInt(["serial", "resendRatioStart"], data["serial"]["resendRatioStart"])
         if "ignoreEmptyPorts" in data["serial"]:
             s.setBoolean(
                 ["serial", "ignoreEmptyPorts"], data["serial"]["ignoreEmptyPorts"]
             )
         if "encoding" in data["serial"]:
             s.set(["serial", "encoding"], data["serial"]["encoding"])
         if "enableShutdownActionCommand" in data["serial"]:

--- a/src/octoprint/server/util/sockjs.py
+++ b/src/octoprint/server/util/sockjs.py
@@ -141,23 +141,23 @@
         self._authed = False
         self._initial_data_sent = False
         self._subscriptions_active = False
         self._subscriptions = {"state": False, "plugins": [], "events": []}
         self._keep_alive = RepeatedTimer(
             60, self._keep_alive_callback, condition=lambda: self._authed
         )
     @staticmethod
     def _get_remote_address(info):
         from octoprint.util.net import get_http_client_ip
-        trusted_proxies = settings().get(["server", "reverseProxy", "trustedDownstream"])
-        if not trusted_proxies or not isinstance(trusted_proxies, list):
-            trusted_proxies = []
+        trusted_proxies = settings().get(["server", "reverseProxy", "trustedUpstream"])
+        if not isinstance(trusted_proxies, list):
+            trusted_proxies = ["127.0.0.1"]
         return get_http_client_ip(
             info.ip, info.headers.get("X-Forwarded-For"), trusted_proxies
         )
     def _keep_alive_callback(self):
         if not self._authed:
             return
         if not isinstance(self._user, SessionUser):
             return
         self._user.touch()
     def __str__(self):

--- a/src/octoprint/static/js/app/viewmodels/access.js
+++ b/src/octoprint/static/js/app/viewmodels/access.js
@@ -24,22 +24,20 @@
                 CONFIG_USERSPERPAGE
             );
             self.emptyUser = {name: "", active: false};
             self.currentUser = ko.observable(self.emptyUser).extend({notify: "always"});
             self.isCurrentUser = (user) => {
                 return user && user.name && user.name == access.loginState.username();
             };
             self.isDeleteUserEnabled = (user) => {
                 return !self.isCurrentUser(user);
             };
-            self.apikeysVisible = ko.observable(false);
-            self.revealingApikeys = ko.observable(false);
             self.editor = {
                 name: ko.observable(undefined),
                 groups: ko.observableArray([]),
                 permissions: ko.observableArray([]),
                 password: ko.observable(undefined),
                 currentPassword: ko.observable(undefined),
                 repeatedPassword: ko.observable(undefined),
                 passwordMismatch: ko.pureComputed(function () {
                     return self.editor.password() !== self.editor.repeatedPassword();
                 }),
@@ -141,21 +139,20 @@
             self.editor.currentPassword.subscribe(function () {
                 self.editor.currentPasswordMismatch(false);
             });
             self.requestData = function () {
                 if (!CONFIG_ACCESS_CONTROL) return;
                 if (!access.loginState.hasPermissionKo(access.permissions.ADMIN)) return;
                 return OctoPrint.access.users.list().done(self.fromResponse);
             };
             self.fromResponse = function (response) {
                 self.listHelper.updateItems(response.users);
-                self.apikeysVisible(self.revealingApikeys());
             };
             self.showAddUserDialog = function () {
                 if (!CONFIG_ACCESS_CONTROL) return;
                 access.loginState.reauthenticateIfNecessary(() => {
                     self.currentUser(undefined);
                     $(
                         'ul.nav-pills a[data-toggle="tab"]:first',
                         self.userEditorDialog
                     ).tab("show");
                     self.userEditorDialog
@@ -305,62 +302,38 @@
             self.confirmGenerateApikey = function () {
                 if (!CONFIG_ACCESS_CONTROL) return;
                 access.loginState.reauthenticateIfNecessary(() => {
                     self.generateApikey(self.currentUser().name).done(function (
                         response
                     ) {
                         self._updateApikey(response.apikey);
                     });
                 });
             };
-            self.revealApikeys = () => {
-                access.loginState.reauthenticateIfNecessary(() => {
-                    self.revealingApikeys(true);
-                    self.requestData().always(() => {
-                        self.revealingApikeys(false);
-                        if (self.currentUser()) {
-                            OctoPrint.access.users
-                                .get(self.currentUser().name)
-                                .done((data) => {
-                                    self.currentUser(data);
-                                });
-                        }
-                    });
-                });
-            };
             self.copyApikey = function () {
                 copyToClipboard(self.editor.apikey());
             };
             self._updateApikey = function (apikey) {
                 self.editor.apikey(apikey);
                 self.requestData();
             };
             self.confirmDeleteApikey = function () {
                 if (!CONFIG_ACCESS_CONTROL) return;
                 access.loginState.reauthenticateIfNecessary(() => {
                     self.deleteApikey(self.currentUser().name).done(function () {
                         self._updateApikey(undefined);
                     });
                 });
             };
             self.onStartup = function () {
                 self.userEditorDialog = $("#settings-usersEditorDialog");
                 self.changePasswordDialog = $("#settings-usersDialogChangePassword");
-            };
-            self.onUserCredentialsOutdated = () => {
-                self.apikeysVisible(false);
-                self.requestData();
-                if (self.currentUser()) {
-                    OctoPrint.access.users.get(self.currentUser().name).done((data) => {
-                        self.currentUser(data);
-                    });
-                }
             };
             self.addUser = function (user) {
                 if (!user) {
                     throw OctoPrint.InvalidArgumentError("user must be set");
                 }
                 if (!access.loginState.hasPermissionKo(access.permissions.ADMIN)) {
                     return $.Deferred()
                         .reject("You are not authorized to perform this action")
                         .promise();
                 }
@@ -852,23 +825,20 @@
         access.onStartup = function () {
             access.groups.onStartup();
             access.users.onStartup();
         };
         access.onServerConnect = function () {
             access.permissions.initialize();
         };
         access.onServerReconnect = function () {
             access.permissions.initialize();
         };
-        access.onUserCredentialsOutdated = () => {
-            access.users.onUserCredentialsOutdated();
-        };
         access.onUserPermissionsChanged =
             access.onUserLoggedIn =
             access.onUserLoggedOut =
                 function (user) {
                     if (access.loginState.hasPermission(access.permissions.ADMIN)) {
                         access.groups.requestData().done(function () {
                             access.users.requestData();
                         });
                     }
                 };

--- a/src/octoprint/static/js/app/viewmodels/loginstate.js
+++ b/src/octoprint/static/js/app/viewmodels/loginstate.js
@@ -10,43 +10,20 @@
         self.loggedIn = ko.observable(undefined);
         self.username = ko.observable(undefined);
         self.userneeds = ko.observable(undefined);
         self.isAdmin = ko.observable(false);
         self.isUser = ko.observable(false);
         self.allViewModels = undefined;
         self.startupDeferred = $.Deferred();
         self.currentUser = ko.observable(undefined);
         self.currentLoginMechanism = ko.observable(undefined);
         self.credentialsSeen = ko.observable(undefined);
-        self.credentialsSeenTimeout = undefined;
-        self.credentialsSeen.subscribe(() => {
-            const credentialsSeen = self.credentialsSeen();
-            if (credentialsSeen === undefined) {
-                return;
-            }
-            if (CONFIG_REAUTHENTICATION_TIMEOUT <= 0) return;
-            if (self.credentialsSeenTimeout)
-                window.clearTimeout(self.credentialsSeenTimeout);
-            const now = new Date();
-            const seen = new Date(credentialsSeen);
-            const timeout =
-                seen.getTime() +
-                (CONFIG_REAUTHENTICATION_TIMEOUT * 60 + 10) * 1000 -
-                now.getTime();
-            if (timeout > 0) {
-                callViewModels(self.allViewModels, "onUserCredentialsRefreshed");
-                window.setTimeout(() => {
-                    callViewModels(self.allViewModels, "onUserCredentialsOutdated");
-                    self.credentialsSeenTimeout = undefined;
-                }, timeout);
-            }
-        });
         self.elementUsernameInput = undefined;
         self.elementPasswordInput = undefined;
         self.elementLoginButton = undefined;
         self.externalAddressNotification = undefined;
         self.userMenuText = ko.pureComputed(function () {
             if (self.loggedIn()) {
                 return self.username();
             } else {
                 return gettext("Login");
             }

--- a/src/octoprint/static/js/app/viewmodels/settings.js
+++ b/src/octoprint/static/js/app/viewmodels/settings.js
@@ -102,21 +102,20 @@
             [auto_locale].concat(
                 _.sortBy(_.values(AVAILABLE_LOCALES), function (n) {
                     return n.display;
                 })
             )
         );
         self.locale_languages = _.keys(AVAILABLE_LOCALES);
         self.api_key = ko.observable(undefined);
         self.api_allowCrossOrigin = ko.observable(undefined);
         self.apiKeyVisible = ko.observable(false);
-        self.revealingApiKey = ko.observable(false);
         self.appearance_name = ko.observable(undefined);
         self.appearance_color = ko.observable(undefined);
         self.appearance_colorTransparent = ko.observable();
         self.appearance_colorIcon = ko.observable();
         self.appearance_defaultLanguage = ko.observable();
         self.appearance_showFahrenheitAlso = ko.observable(undefined);
         self.appearance_fuzzyTimes = ko.observable(undefined);
         self.appearance_closeModalsWithClick = ko.observable(undefined);
         self.appearance_showInternalFilename = ko.observable(undefined);
         self.printer_defaultExtrusionLength = ko.observable(undefined);
@@ -606,55 +605,52 @@
                 .css({
                     "margin-left": function () {
                         return -($(this).width() / 2);
                     }
                 });
             return false;
         };
         self.hide = function () {
             self.settingsDialog.modal("hide");
         };
-        self.generateApiKey = () => {
+        self.generateApiKey = function () {
             if (!CONFIG_ACCESS_CONTROL) return;
             showConfirmationDialog(
                 gettext(
                     "This will generate a new API Key. The old API Key will cease to function immediately."
                 ),
-                () => {
-                    self.loginState.reauthenticateIfNecessary(() => {
-                        OctoPrint.settings.generateApiKey().done((response) => {
-                            self.api_key(response.apikey);
-                            self.requestData();
-                        });
+                function () {
+                    OctoPrint.settings.generateApiKey().done(function (response) {
+                        self.api_key(response.apikey);
+                        self.requestData();
                     });
                 }
             );
         };
         self.deleteApiKey = () => {
             if (!CONFIG_ACCESS_CONTROL) return;
             if (!self.api_key()) return;
             showConfirmationDialog(
                 gettext(
                     "This will delete the API Key. It will cease to to function immediately."
                 ),
-                () => {
-                    self.loginState.reauthenticateIfNecessary(() => {
-                        OctoPrint.settings.deleteApiKey().done(() => {
-                            self.api_key(undefined);
-                        });
+                function () {
+                    OctoPrint.settings.deleteApiKey().done(() => {
+                        self.api_key(undefined);
                     });
                 }
             );
         };
         self.copyApiKey = function () {
             copyToClipboard(self.api_key());
         };
+        self.revealingApiKey = ko.observable(false);
         self.revealApiKey = () => {
             self.loginState.reauthenticateIfNecessary(() => {
                 self.revealingApiKey(true);
                 self.requestData().always(() => {
                     self.revealingApiKey(false);
                 });
             });
         };
         self.showTranslationManager = function () {
             self.translationManagerDialog.modal();
@@ -950,20 +946,21 @@
                         result[key] = self[observable]();
                         flag = true;
                     }
                 });
                 return flag ? result : undefined;
             };
             var dataFromObservables = mapFromObservables(data, specialMappings);
             data = deepMerge(data, dataFromObservables);
             return data;
         };
+        self.reauthenticationTimeout = undefined;
         self.fromResponse = function (response, local) {
             var serverChangedData;
             var clientChangedData;
             if (local) {
                 serverChangedData = getOnlyChangedData(
                     response,
                     self.lastReceivedSettings
                 );
                 clientChangedData = getOnlyChangedData(
                     self.getLocalData(),
@@ -1108,21 +1105,27 @@
                             local && local[key] ? local[key] : undefined,
                             observable
                         );
                     } else if (!haveLocalVersion && self.hasOwnProperty(observable)) {
                         self[observable](value);
                     }
                 });
             };
             mapToObservables(serverChangedData, specialMappings, clientChangedData);
             firstRequest.resolve();
-            self.apiKeyVisible(self.revealingApiKey());
+            self.apiKeyVisible(self.loginState.checkCredentialsSeen());
+            if (self.apiKeyVisible()) {
+                self.reauthenticationTimeout =
+                    self.loginState.afterReauthenticationTimeout(() => {
+                        self.requestData();
+                    }, self.reauthenticationTimeout);
+            }
             if (
                 self.settings.accessControl &&
                 self.settings.accessControl.autologinLocal() &&
                 !self.settings.accessControl.autologinHeadsupAcknowledged()
             ) {
                 const text = gettext(
                     "<p>You have Autologin enabled. This means that you will be automatically logged in when accessing OctoPrint from a local IP.</p>" +
                         "<p>By default, OctoPrint is configured in such a way this should not pose a security risk. However, <strong>if you yourself have " +
                         "any additional reverse proxies configured</strong> in front of OctoPrint, make sure those are configured correctly.</p>" +
                         "<p><a href='%(url)s' target='_blank' rel='noopener noreferer'>Read more in the FAQ</a>.</p>"
@@ -1273,24 +1276,20 @@
         self.onServerReconnect = function () {
             self.requestData();
         };
         self.onUserPermissionsChanged =
             self.onUserLoggedIn =
             self.onUserLoggedOut =
                 function () {
                     if (!self._startupComplete) return;
                     self.requestData();
                 };
-        self.onUserCredentialsOutdated = () => {
-            self.apiKeyVisible(false);
-            self.requestData();
-        };
         self.validURL = function (str) {
             var pattern = new RegExp(
                 "^(https?:\\/\\/)?" + // protocol
                     "((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|" + // domain name
                     "((\\d{1,3}\\.){3}\\d{1,3}))" + // OR ip (v4) address
                     "(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*" + // port and path
                     "(\\?[;&a-z\\d%_.~+=-]*)?" + // query string
                     "(\\#[-a-z\\d_]*)?$",
                 "i"
             ); // fragment locator

--- a/src/octoprint/static/js/app/viewmodels/usersettings.js
+++ b/src/octoprint/static/js/app/viewmodels/usersettings.js
@@ -17,22 +17,20 @@
                 })
             )
         );
         self.locale_languages = _.keys(AVAILABLE_LOCALES);
         self.access_password = ko.observable(undefined);
         self.access_repeatedPassword = ko.observable(undefined);
         self.access_currentPassword = ko.observable(undefined);
         self.access_currentPasswordMismatch = ko.observable(false);
         self.access_apikey = ko.observable(undefined);
         self.interface_language = ko.observable(undefined);
-        self.apiKeyVisible = ko.observable(false);
-        self.revealingApiKey = ko.observable(false);
         self.currentUser = ko.observable(undefined);
         self.currentUser.subscribe(function (newUser) {
             self.access_password(undefined);
             self.access_repeatedPassword(undefined);
             self.access_currentPassword(undefined);
             self.access_currentPasswordMismatch(false);
             self.access_apikey(undefined);
             self.interface_language("_default");
             if (newUser !== undefined) {
                 self.access_apikey(newUser.apikey);
@@ -43,48 +41,40 @@
                     self.interface_language(newUser.settings.interface.language);
                 }
             }
         });
         self.access_currentPassword.subscribe(function () {
             self.access_currentPasswordMismatch(false);
         });
         self.passwordMismatch = ko.pureComputed(function () {
             return self.access_password() !== self.access_repeatedPassword();
         });
-        self.show = (user) => {
+        self.show = function (user) {
             if (!CONFIG_ACCESS_CONTROL) return;
             if (user === undefined) {
                 user = self.loginState.currentUser();
             }
-            self.requestData(user.name)
-                .done(() => {
-                    self.userSettingsDialog.modal("show");
+            var process = function (user) {
+                self.currentUser(user);
+                self.userSettingsDialog.modal("show");
+            };
+            OctoPrint.access.users
+                .get(user.name)
+                .done(function (data) {
+                    process(data);
                 })
-                .fail(() => {
+                .fail(function () {
                     log.warn(
                         "Could not fetch current user data, proceeding with client side data copy"
                     );
-                    self.fromResponse(user);
+                    process(user);
                 });
-        };
-        self.requestData = (name) => {
-            if (name === undefined && self.currentUser() === undefined) return;
-            if (name === undefined) {
-                name = self.currentUser().name;
-            }
-            return OctoPrint.access.users.get(name).done((data) => {
-                self.fromResponse(data);
-            });
-        };
-        self.fromResponse = (data) => {
-            self.currentUser(data);
-            self.apiKeyVisible(self.revealingApiKey());
         };
         self.save = function () {
             if (!CONFIG_ACCESS_CONTROL) return;
             self.userSettingsDialog.trigger("beforeSave");
             function saveSettings() {
                 var settings = {
                     interface: {
                         language: self.interface_language()
                     }
                 };
@@ -111,63 +101,51 @@
                     });
             } else {
                 saveSettings();
             }
         };
         self.copyApikey = function () {
             copyToClipboard(self.access_apikey());
         };
         self.generateApikey = function () {
             if (!CONFIG_ACCESS_CONTROL) return;
-            const generate = () => {
-                self.loginState.reauthenticateIfNecessary(() => {
-                    self.users
-                        .generateApikey(self.currentUser().name)
-                        .done((response) => {
-                            self.access_apikey(response.apikey);
-                        });
-                });
+            var generate = function () {
+                self.users
+                    .generateApikey(self.currentUser().name)
+                    .done(function (response) {
+                        self.access_apikey(response.apikey);
+                    });
             };
             if (self.access_apikey()) {
                 showConfirmationDialog(
                     gettext(
                         "This will generate a new API Key. The old API Key will cease to function immediately."
                     ),
                     generate
                 );
             } else {
                 generate();
             }
         };
         self.deleteApikey = function () {
             if (!CONFIG_ACCESS_CONTROL) return;
             if (!self.access_apikey()) return;
             showConfirmationDialog(
                 gettext(
                     "This will delete the API Key. It will cease to to function immediately."
                 ),
-                () => {
-                    self.loginState.reauthenticateIfNecessary(() => {
-                        self.users.deleteApikey(self.currentUser().name).done(() => {
-                            self.access_apikey(undefined);
-                        });
+                function () {
+                    self.users.deleteApikey(self.currentUser().name).done(function () {
+                        self.access_apikey(undefined);
                     });
                 }
             );
-        };
-        self.revealApiKey = () => {
-            self.loginState.reauthenticateIfNecessary(() => {
-                self.revealingApiKey(true);
-                self.requestData(self.currentUser().name).always(() => {
-                    self.revealingApiKey(false);
-                });
-            });
         };
         self.updateSettings = function (username, settings) {
             return OctoPrint.access.users.saveSettings(username, settings);
         };
         self.saveEnabled = function () {
             return !self.passwordMismatch();
         };
         self.onStartup = function () {
             self.userSettingsDialog = $("#usersettings_dialog");
         };
@@ -175,21 +153,17 @@
             self.userSettingsDialog.on("show", function () {
                 callViewModels(allViewModels, "onUserSettingsShown");
             });
             self.userSettingsDialog.on("hidden", function () {
                 callViewModels(allViewModels, "onUserSettingsHidden");
             });
             self.userSettingsDialog.on("beforeSave", function () {
                 callViewModels(allViewModels, "onUserSettingsBeforeSave");
             });
         };
-        self.onUserCredentialsOutdated = () => {
-            self.apiKeyVisible(false);
-            self.requestData();
-        };
     }
     OCTOPRINT_VIEWMODELS.push({
         construct: UserSettingsViewModel,
         dependencies: ["loginStateViewModel", "accessViewModel"],
         elements: ["#usersettings_dialog"]
     });
 });

--- a/src/octoprint/util/__init__.py
+++ b/src/octoprint/util/__init__.py
@@ -1278,22 +1278,22 @@
             try:
                 return f(*args, **kwargs)
             finally:
                 timing = (time.time() - start) * 1000
                 if logger.isEnabledFor(logging.DEBUG):
                     data.update(timing=timing)
                     logger.debug(message.format(**data), extra=data)
         return wrapper
     return decorator
 def generate_api_key():
-    import secrets
-    return secrets.token_urlsafe()
+    import uuid
+    return "".join("%02X" % z for z in bytes(uuid.uuid4().bytes))
 def map_boolean(value, true_text, false_text):
     return true_text if value else false_text
 def serialize(filename, data, encoding="utf-8", compressed=True):
     """
     Serializes data to a file
     In the current implementation this uses json.dumps.
     If `compressed` is True (the default), the serialized data put through zlib.compress.
     Supported data types are listed at the bottom of
     :func:`octoprint.util.comprehensive_json`, and include some data types that are not
     supported by json.dumps by default.
