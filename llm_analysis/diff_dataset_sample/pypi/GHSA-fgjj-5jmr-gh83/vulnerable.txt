# ====================================================================
# FILE: clients/admin-ui/src/features/system/SystemInformationForm.tsx
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 392-432 ---
   392|               animateOpacity
   393|             >
   394|               <SystemFormInputGroup heading="Cookie properties">
   395|                 <DictSuggestionSwitch
   396|                   name="uses_cookies"
   397|                   label="This system uses cookies"
   398|                   tooltip="Does this system use cookies?"
   399|                 />
   400|                 <DictSuggestionSwitch
   401|                   name="cookie_refresh"
   402|                   label="This system refreshes cookies"
   403|                   tooltip="Does this system automatically refresh cookies?"
   404|                 />
   405|                 <DictSuggestionSwitch
   406|                   name="uses_non_cookie_access"
   407|                   label="This system uses non-cookie trackers"
   408|                   tooltip="Does this system use other types of trackers?"
   409|                 />
   410|                 <DictSuggestionNumberInput
   411|                   name="cookie_max_age_seconds"
   412|                   label="Maximum duration (seconds)"
   413|                   tooltip="What is the maximum amount of time a cookie will live?"
   414|                 />
   415|               </SystemFormInputGroup>
   416|               <SystemFormInputGroup heading="Administrative properties">
   417|                 <CustomTextInput
   418|                   label="Data stewards"
   419|                   name="data_stewards"
   420|                   tooltip="Who are the stewards assigned to the system?"
   421|                   variant="stacked"
   422|                   disabled
   423|                 />
   424|                 <DictSuggestionTextInput
   425|                   id="privacy_policy"
   426|                   name="privacy_policy"
   427|                   label="Privacy policy URL"
   428|                   tooltip="Where can the privacy policy be located?"
   429|                 />
   430|                 <DictSuggestionTextInput
   431|                   id="legal_name"
   432|                   name="legal_name"


# ====================================================================
# FILE: clients/admin-ui/src/types/api/index.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 104-144 ---
   104| export type { DatasetTraversalDetails } from "./models/DatasetTraversalDetails";
   105| export type { DataSubject } from "./models/DataSubject";
   106| export type { DataSubjectRights } from "./models/DataSubjectRights";
   107| export { DataSubjectRightsEnum } from "./models/DataSubjectRightsEnum";
   108| export type { DataUpload } from "./models/DataUpload";
   109| export type { DataUse } from "./models/DataUse";
   110| export { DBActions } from "./models/DBActions";
   111| export type { DenyPrivacyRequests } from "./models/DenyPrivacyRequests";
   112| export type { DictionaryStatus } from "./models/DictionaryStatus";
   113| export { DrpAction } from "./models/DrpAction";
   114| export type { DrpDataRightsResponse } from "./models/DrpDataRightsResponse";
   115| export type { DrpMeta } from "./models/DrpMeta";
   116| export type { DrpPrivacyRequestCreate } from "./models/DrpPrivacyRequestCreate";
   117| export { DrpRegime } from "./models/DrpRegime";
   118| export type { DrpRevokeRequest } from "./models/DrpRevokeRequest";
   119| export type { DryRunDatasetResponse } from "./models/DryRunDatasetResponse";
   120| export type { DynamoDBDocsSchema } from "./models/DynamoDBDocsSchema";
   121| export { EdgeDirection } from "./models/EdgeDirection";
   122| export type { EmailDocsSchema } from "./models/EmailDocsSchema";
   123| export type { EmbeddedLineItem } from "./models/EmbeddedLineItem";
   124| export type { EmbeddedPurpose } from "./models/EmbeddedPurpose";
   125| export type { EmbeddedVendor } from "./models/EmbeddedVendor";
   126| export type { Endpoint } from "./models/Endpoint";
   127| export { EnforcementLevel } from "./models/EnforcementLevel";
   128| export type { Evaluation } from "./models/Evaluation";
   129| export type { ExecutionAndAuditLogResponse } from "./models/ExecutionAndAuditLogResponse";
   130| export type { ExecutionApplicationConfig } from "./models/ExecutionApplicationConfig";
   131| export type { ExecutionLogDetailResponse } from "./models/ExecutionLogDetailResponse";
   132| export { ExecutionLogStatus } from "./models/ExecutionLogStatus";
   133| export type { ExperienceConfigCreate } from "./models/ExperienceConfigCreate";
   134| export type { ExperienceConfigCreateOrUpdateResponse } from "./models/ExperienceConfigCreateOrUpdateResponse";
   135| export type { ExperienceConfigResponse } from "./models/ExperienceConfigResponse";
   136| export type { ExperienceConfigUpdate } from "./models/ExperienceConfigUpdate";
   137| export type { ExperienceMeta } from "./models/ExperienceMeta";
   138| export type { ExtendedIdentityTypes } from "./models/ExtendedIdentityTypes";
   139| export type { ExternalDatasetReference } from "./models/ExternalDatasetReference";
   140| export type { fides__api__schemas__connection_configuration__connection_secrets_bigquery__KeyfileCreds } from "./models/fides__api__schemas__connection_configuration__connection_secrets_bigquery__KeyfileCreds";
   141| export type { fides__api__schemas__policy__Policy } from "./models/fides__api__schemas__policy__Policy";
   142| export type { fides__connectors__models__KeyfileCreds } from "./models/fides__connectors__models__KeyfileCreds";
   143| export type { FidesCloudStatus } from "./models/FidesCloudStatus";
   144| export type { FidesDatasetReference } from "./models/FidesDatasetReference";


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/PrivacyPreferencesRequest.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-41 ---
     9| import type { TCFSpecialFeatureSave } from "./TCFSpecialFeatureSave";
    10| import type { TCFSpecialPurposeSave } from "./TCFSpecialPurposeSave";
    11| import type { TCFVendorSave } from "./TCFVendorSave";
    12| /**
    13|  * Request body for creating PrivacyPreferences.
    14|  *
    15|  *
    16|  * "preferences" key reserved for saving preferences against a privacy notice.
    17|  *
    18|  * New *_preferences fields are used for saving preferences against various tcf components.
    19|  */
    20| export type PrivacyPreferencesRequest = {
    21|   purpose_consent_preferences?: Array<TCFPurposeSave>;
    22|   purpose_legitimate_interests_preferences?: Array<TCFPurposeSave>;
    23|   vendor_consent_preferences?: Array<TCFVendorSave>;
    24|   vendor_legitimate_interests_preferences?: Array<TCFVendorSave>;
    25|   special_feature_preferences?: Array<TCFSpecialFeatureSave>;
    26|   browser_identity: Identity;
    27|   code?: string;
    28|   /**
    29|    * If supplied, TC strings and AC strings are decoded and preferences saved for purpose_consent, purpose_legitimate_interests, vendor_consent, vendor_legitimate_interests, and special_features
    30|    */
    31|   fides_string?: string;
    32|   preferences?: Array<ConsentOptionCreate>;
    33|   special_purpose_preferences?: Array<TCFSpecialPurposeSave>;
    34|   feature_preferences?: Array<TCFFeatureSave>;
    35|   system_consent_preferences?: Array<TCFVendorSave>;
    36|   system_legitimate_interests_preferences?: Array<TCFVendorSave>;
    37|   policy_key?: string;
    38|   privacy_experience_id?: string;
    39|   user_geography?: string;
    40|   method?: ConsentMethod;
    41| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/SavePrivacyPreferencesResponse.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { CurrentPrivacyPreferenceSchema } from "./CurrentPrivacyPreferenceSchema";
     5| import type { TCMobileData } from "./TCMobileData";
     6| /**
     7|  * Response schema when saving privacy preferences
     8|  */
     9| export type SavePrivacyPreferencesResponse = {
    10|   preferences?: Array<CurrentPrivacyPreferenceSchema>;
    11|   purpose_consent_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    12|   purpose_legitimate_interests_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    13|   special_purpose_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    14|   vendor_consent_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    15|   vendor_legitimate_interests_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    16|   feature_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    17|   special_feature_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    18|   system_consent_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    19|   system_legitimate_interests_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    20|   fides_mobile_data?: TCMobileData;
    21| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCDecode.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { TCMobileData } from "./TCMobileData";
     5| /**
     6|  * Decode response schema for returning TC Mobile Data
     7|  */
     8| export type TCDecode = {
     9|   fides_mobile_data: TCMobileData;
    10| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCFVendorConsentRecord.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { EmbeddedPurpose } from "./EmbeddedPurpose";
     5| import type { UserConsentPreference } from "./UserConsentPreference";
     6| /**
     7|  * Schema for a TCF Vendor with Consent legal basis
     8|  */
     9| export type TCFVendorConsentRecord = {
    10|   id: string;
    11|   has_vendor_id?: boolean;
    12|   name?: string;
    13|   description?: string;
    14|   default_preference?: UserConsentPreference;
    15|   current_preference?: UserConsentPreference;
    16|   outdated_preference?: UserConsentPreference;
    17|   current_served?: boolean;
    18|   outdated_served?: boolean;
    19|   purpose_consents?: Array<EmbeddedPurpose>;
    20| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCFVendorLegitimateInterestsRecord.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-20 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { EmbeddedPurpose } from "./EmbeddedPurpose";
     5| import type { UserConsentPreference } from "./UserConsentPreference";
     6| /**
     7|  * Schema for a TCF Vendor with Legitimate interests legal basis
     8|  */
     9| export type TCFVendorLegitimateInterestsRecord = {
    10|   id: string;
    11|   has_vendor_id?: boolean;
    12|   name?: string;
    13|   description?: string;
    14|   default_preference?: UserConsentPreference;
    15|   current_preference?: UserConsentPreference;
    16|   outdated_preference?: UserConsentPreference;
    17|   current_served?: boolean;
    18|   outdated_served?: boolean;
    19|   purpose_legitimate_interests?: Array<EmbeddedPurpose>;
    20| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCFVendorRelationships.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-23 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { EmbeddedLineItem } from "./EmbeddedLineItem";
     5| import type { EmbeddedPurpose } from "./EmbeddedPurpose";
     6| /**
     7|  * Collects the other relationships for a given vendor - no preferences are saved here
     8|  */
     9| export type TCFVendorRelationships = {
    10|   id: string;
    11|   has_vendor_id?: boolean;
    12|   name?: string;
    13|   description?: string;
    14|   special_purposes?: Array<EmbeddedPurpose>;
    15|   features?: Array<EmbeddedLineItem>;
    16|   special_features?: Array<EmbeddedLineItem>;
    17|   cookie_max_age_seconds?: number;
    18|   uses_cookies?: boolean;
    19|   cookie_refresh?: boolean;
    20|   uses_non_cookie_access?: boolean;
    21|   legitimate_interest_disclosure_url?: string;
    22|   privacy_policy_url?: string;
    23| };


# ====================================================================
# FILE: clients/admin-ui/src/types/dictionary-api/models/Cookie.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { CookieType } from "./CookieType";
     5| /**
     6|  * A Compass cookie record, extending a fideslang `Cookie`
     7|  */
     8| export type Cookie = {
     9|   name: string;
    10|   path?: string;
    11|   domain?: string;
    12|   type: CookieType;
    13|   /**
    14|    * Whether the cookie is refreshed after being initially set.
    15|    */
    16|   cookie_refresh?: boolean;
    17|   /**
    18|    * The maximum storage duration, in seconds, for this cookie.
    19|    */
    20|   max_age_seconds?: number;
    21|   /**
    22|    * Whether the associated Vendor record uses non-cookie methods of storage or accessing information stored on a user's device.
    23|    */
    24|   uses_non_cookie_access?: boolean;
    25|   /**
    26|    * The record's GVL purposes

# --- HUNK 2: Lines 33-57 ---
    33|   /**
    34|    * The record's GVL features
    35|    */
    36|   features?: Array<number>;
    37|   /**
    38|    * The record's GVL special features
    39|    */
    40|   special_features?: Array<number>;
    41|   /**
    42|    * The ID of the vendor that the record belongs to
    43|    */
    44|   vendor_id: string;
    45|   /**
    46|    * The name of the vendor that the record belongs to
    47|    */
    48|   vendor_name: string;
    49|   /**
    50|    * The version of GVL from which the record is derived
    51|    */
    52|   gvl_version?: string;
    53|   /**
    54|    * A unique identifier for a Cookie record to be used in the Compass data store. Combines other fields that form uniqueness criteria for a Cookie record.
    55|    */
    56|   unique_id?: string;
    57| };


# ====================================================================
# FILE: clients/admin-ui/src/types/dictionary-api/models/DataUseDeclaration.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { Cookie } from "./Cookie";
     5| import type { LegalBasisForProcessingEnum } from "./LegalBasisForProcessingEnum";
     6| import type { SpecialCategoryLegalBasisEnum } from "./SpecialCategoryLegalBasisEnum";
     7| /**
     8|  * A Compass data use declaration record, extending a fideslang `PrivacyDeclaration`
     9|  */
    10| export type DataUseDeclaration = {
    11|   /**
    12|    * The name of the privacy declaration on the system.
    13|    */
    14|   name?: string;
    15|   /**
    16|    * An array of data categories describing a system in a privacy declaration.
    17|    */
    18|   data_categories: Array<string>;
    19|   /**
    20|    * The Data Use describing a system in a privacy declaration.
    21|    */
    22|   data_use: string;
    23|   /**
    24|    * Deprecated. The fides key of the data qualifier describing a system in a privacy declaration.
    25|    */
    26|   data_qualifier?: string;
    27|   /**
    28|    * An array of data subjects describing a system in a privacy declaration.


# ====================================================================
# FILE: clients/admin-ui/src/types/dictionary-api/models/Vendor.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-33 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { ContactDetails } from "./ContactDetails";
     5| import type { Cookie } from "./Cookie";
     6| import type { DataFlow } from "./DataFlow";
     7| import type { DataProtectionImpactAssessment } from "./DataProtectionImpactAssessment";
     8| import type { DataResponsibilityTitle } from "./DataResponsibilityTitle";
     9| import type { LegalBasisForProfilingEnum } from "./LegalBasisForProfilingEnum";
    10| import type { PrivacyDeclaration } from "./PrivacyDeclaration";
    11| import type { SystemMetadata } from "./SystemMetadata";
    12| /**
    13|  * A Compass vendor record, extending a fideslang `System`
    14|  */
    15| export type Vendor = {
    16|   fides_key?: string;
    17|   /**
    18|    * Defines the Organization that this resource belongs to.
    19|    */
    20|   organization_fides_key?: string;
    21|   tags?: Array<string>;
    22|   name?: string;
    23|   /**
    24|    * A detailed description of what this resource is.
    25|    */
    26|   description?: string;
    27|   /**
    28|    * The id of the system registry, if used.
    29|    */
    30|   registry_id?: number;
    31|   /**
    32|    * An optional property to store any extra information for a resource. Data can be structured in any way: simple set of `key: value` pairs or deeply nested objects.
    33|    */


# ====================================================================
# FILE: clients/fides-js/src/components/tcf/TcfOverlay.tsx
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 16-65 ---
    16|   EnabledIds,
    17|   TCFFeatureRecord,
    18|   TCFFeatureSave,
    19|   TCFPurposeConsentRecord,
    20|   TCFPurposeLegitimateInterestsRecord,
    21|   TCFPurposeSave,
    22|   TCFSpecialFeatureSave,
    23|   TCFSpecialPurposeSave,
    24|   TCFVendorSave,
    25|   TcfSavePreferences,
    26|   TCFVendorConsentRecord,
    27|   TCFVendorLegitimateInterestsRecord,
    28|   TcfModels,
    29| } from "../../lib/tcf/types";
    30| import { updateConsentPreferences } from "../../lib/preferences";
    31| import {
    32|   ButtonType,
    33|   ConsentMethod,
    34|   PrivacyExperience,
    35| } from "../../lib/consent-types";
    36| import { generateFidesString } from "../../lib/tcf";
    37| import {
    38|   FidesCookie,
    39|   transformTcfPreferencesToCookieKeys,
    40| } from "../../lib/cookie";
    41| import InitialLayer from "./InitialLayer";
    42| import TcfTabs from "./TcfTabs";
    43| import Button from "../Button";
    44| import VendorInfoBanner from "./VendorInfoBanner";
    45| import { dispatchFidesEvent } from "../../lib/events";
    46| const resolveConsentValueFromTcfModel = (
    47|   model:
    48|     | TCFPurposeConsentRecord
    49|     | TCFPurposeLegitimateInterestsRecord
    50|     | TCFFeatureRecord
    51|     | TCFVendorConsentRecord
    52|     | TCFVendorLegitimateInterestsRecord
    53| ) => {
    54|   if (model.current_preference) {
    55|     return transformUserPreferenceToBoolean(model.current_preference);
    56|   }
    57|   return transformUserPreferenceToBoolean(model.default_preference);
    58| };
    59| type TcfSave =
    60|   | TCFPurposeSave
    61|   | TCFSpecialPurposeSave
    62|   | TCFFeatureSave
    63|   | TCFSpecialFeatureSave
    64|   | TCFVendorSave;
    65| const getEnabledIds = (modelList: TcfModels) => {

# --- HUNK 2: Lines 155-201 ---
   155|     system_legitimate_interests_preferences: transformTcfModelToTcfSave({
   156|       modelList: experience.tcf_system_legitimate_interests,
   157|       enabledIds: enabledLegintSystemIds,
   158|     }) as TCFVendorSave[],
   159|   };
   160| };
   161| const updateCookie = async (
   162|   oldCookie: FidesCookie,
   163|   /**
   164|    * `tcf` and `enabledIds` should represent the same data, where `tcf` is what is
   165|    * sent to the backend, and `enabledIds` is what the FE uses. They have diverged
   166|    * because the backend has not implemented separate vendor legint/consents yet.
   167|    * Therefore, we need both entities right now, but eventually we should be able to
   168|    * only use one. In other words, `enabledIds` has a field for `vendorsConsent` and
   169|    * `vendorsLegint` but `tcf` only has `vendors`.
   170|    */
   171|   tcf: TcfSavePreferences,
   172|   enabledIds: EnabledIds,
   173|   experience: PrivacyExperience
   174| ): Promise<FidesCookie> => {
   175|   const tcString = await generateFidesString({
   176|     tcStringPreferences: enabledIds,
   177|     experience,
   178|   });
   179|   return {
   180|     ...oldCookie,
   181|     fides_string: tcString,
   182|     tcf_consent: transformTcfPreferencesToCookieKeys(tcf),
   183|   };
   184| };
   185| const TcfOverlay: FunctionComponent<OverlayProps> = ({
   186|   fidesRegionString,
   187|   experience,
   188|   options,
   189|   cookie,
   190| }) => {
   191|   const initialEnabledIds: EnabledIds = useMemo(() => {
   192|     const {
   193|       tcf_purpose_consents: consentPurposes = [],
   194|       tcf_purpose_legitimate_interests: legintPurposes = [],
   195|       tcf_special_purposes: specialPurposes = [],
   196|       tcf_features: features = [],
   197|       tcf_special_features: specialFeatures = [],
   198|       tcf_vendor_consents: consentVendors = [],
   199|       tcf_vendor_legitimate_interests: legintVendors = [],
   200|       tcf_system_consents: consentSystems = [],
   201|       tcf_system_legitimate_interests: legintSystems = [],

# --- HUNK 3: Lines 203-247 ---
   203|     return {
   204|       purposesConsent: getEnabledIds(consentPurposes),
   205|       purposesLegint: getEnabledIds(legintPurposes),
   206|       specialPurposes: getEnabledIds(specialPurposes),
   207|       features: getEnabledIds(features),
   208|       specialFeatures: getEnabledIds(specialFeatures),
   209|       vendorsConsent: getEnabledIds([...consentVendors, ...consentSystems]),
   210|       vendorsLegint: getEnabledIds([...legintVendors, ...legintSystems]),
   211|     };
   212|   }, [experience]);
   213|   const [draftIds, setDraftIds] = useState<EnabledIds>(initialEnabledIds);
   214|   const showBanner = useMemo(
   215|     () => experience.show_banner && hasActionNeededNotices(experience),
   216|     [experience]
   217|   );
   218|   const handleUpdateAllPreferences = useCallback(
   219|     (enabledIds: EnabledIds) => {
   220|       const tcf = createTcfSavePayload({ experience, enabledIds });
   221|       updateConsentPreferences({
   222|         consentPreferencesToSave: [],
   223|         experience,
   224|         consentMethod: ConsentMethod.button,
   225|         options,
   226|         userLocationString: fidesRegionString,
   227|         cookie,
   228|         servedNotices: null, // TODO: served notices
   229|         tcf,
   230|         updateCookie: (oldCookie) =>
   231|           updateCookie(oldCookie, tcf, enabledIds, experience),
   232|       });
   233|       setDraftIds(enabledIds);
   234|     },
   235|     [cookie, experience, fidesRegionString, options]
   236|   );
   237|   const [activeTabIndex, setActiveTabIndex] = useState(0);
   238|   if (!experience.experience_config) {
   239|     debugLog(options.debug, "No experience config found");
   240|     return null;
   241|   }
   242|   const experienceConfig = experience.experience_config;
   243|   return (
   244|     <Overlay
   245|       options={options}
   246|       experience={experience}
   247|       cookie={cookie}

# --- HUNK 4: Lines 275-318 ---
   275|             <div id="fides-tcf-banner-inner">
   276|               <VendorInfoBanner
   277|                 experience={experience}
   278|                 goToVendorTab={goToVendorTab}
   279|               />
   280|               <InitialLayer experience={experience} />
   281|             </div>
   282|           </ConsentBanner>
   283|         ) : null;
   284|       }}
   285|       renderModalContent={({ onClose }) => {
   286|         const onSave = (keys: EnabledIds) => {
   287|           handleUpdateAllPreferences(keys);
   288|           onClose();
   289|         };
   290|         return (
   291|           <Fragment>
   292|             <TcfTabs
   293|               experience={experience}
   294|               enabledIds={draftIds}
   295|               onChange={(updatedIds) => {
   296|                 setDraftIds(updatedIds);
   297|                 dispatchFidesEvent("FidesUIChanged", cookie, options.debug);
   298|               }}
   299|               activeTabIndex={activeTabIndex}
   300|               onTabChange={setActiveTabIndex}
   301|             />
   302|             <div className="fides-modal-footer">
   303|               <TcfConsentButtons
   304|                 experience={experience}
   305|                 onSave={onSave}
   306|                 firstButton={
   307|                   <Button
   308|                     buttonType={ButtonType.SECONDARY}
   309|                     label={experience.experience_config?.save_button_label}
   310|                     onClick={() => onSave(draftIds)}
   311|                   />
   312|                 }
   313|               />
   314|               <PrivacyPolicyLink experience={experience.experience_config} />
   315|             </div>
   316|           </Fragment>
   317|         );
   318|       }}


# ====================================================================
# FILE: clients/fides-js/src/components/tcf/TcfVendors.tsx
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-156 ---
     1| import { VNode, h } from "preact";
     2| import { useMemo, useState } from "preact/hooks";
     3| import { Vendor } from "@iabtechlabtcf/core";
     4| import {
     5|   GvlDataCategories,
     6|   GvlDataDeclarations,
     7|   VendorRecord,
     8|   EmbeddedPurpose,
     9| } from "../../lib/tcf/types";
    10| import { PrivacyExperience } from "../../lib/consent-types";
    11| import { UpdateEnabledIds } from "./TcfOverlay";
    12| import FilterButtons from "./FilterButtons";
    13| import {
    14|   transformExperienceToVendorRecords,
    15|   vendorGvlEntry,
    16| } from "../../lib/tcf/vendors";
    17| import ExternalLink from "../ExternalLink";
    18| import DoubleToggleTable from "./DoubleToggleTable";
    19| const FILTERS = [{ name: "All vendors" }, { name: "IAB TCF vendors" }];
    20| const VendorDetails = ({
    21|   label,
    22|   lineItems,
    23| }: {
    24|   label: string;
    25|   lineItems: EmbeddedPurpose[] | undefined;
    26| }) => {
    27|   if (!lineItems || lineItems.length === 0) {
    28|     return null;
    29|   }
    30|   const hasRetentionInfo = lineItems.some((li) => li.retention_period != null);
    31|   return (
    32|     <table className="fides-vendor-details-table">
    33|       <thead>
    34|         <tr>
    35|           <th width="80%">{label}</th>
    36|           {hasRetentionInfo ? (
    37|             <th width="20%" style={{ textAlign: "right" }}>
    38|               Retention
    39|             </th>
    40|           ) : null}
    41|         </tr>
    42|       </thead>
    43|       <tbody>
    44|         {lineItems.map((item) => (
    45|           <tr key={item.id}>
    46|             <td>{item.name}</td>
    47|             {hasRetentionInfo ? (
    48|               <td style={{ textAlign: "right" }}>
    49|                 {item.retention_period
    50|                   ? `${item.retention_period} day(s)`
    51|                   : "N/A"}
    52|               </td>
    53|             ) : null}
    54|           </tr>
    55|         ))}
    56|       </tbody>
    57|     </table>
    58|   );
    59| };
    60| const PurposeVendorDetails = ({
    61|   purposes,
    62|   specialPurposes,
    63| }: {
    64|   purposes: EmbeddedPurpose[] | undefined;
    65|   specialPurposes: EmbeddedPurpose[] | undefined;
    66| }) => {
    67|   const emptyPurposes = purposes ? purposes.length === 0 : true;
    68|   const emptySpecialPurposes = specialPurposes
    69|     ? specialPurposes.length === 0
    70|     : true;
    71|   if (emptyPurposes && emptySpecialPurposes) {
    72|     return null;
    73|   }
    74|   return (
    75|     <div>
    76|       <VendorDetails label="Purposes" lineItems={purposes} />
    77|       <VendorDetails label="Special purposes" lineItems={specialPurposes} />
    78|     </div>
    79|   );
    80| };
    81| const DataCategories = ({
    82|   gvlVendor,
    83|   dataCategories,
    84| }: {
    85|   gvlVendor: Vendor | undefined;
    86|   dataCategories: GvlDataCategories | undefined;
    87| }) => {
    88|   if (!gvlVendor || !dataCategories) {
    89|     return null;
    90|   }
    91|   const declarations: GvlDataDeclarations = gvlVendor.dataDeclaration;
    92|   return (
    93|     <table className="fides-vendor-details-table">
    94|       <thead>
    95|         <tr>
    96|           <th>Data categories</th>
    97|         </tr>
    98|       </thead>
    99|       <tbody>
   100|         {declarations.map((id) => {
   101|           const category = dataCategories[id];
   102|           return (
   103|             <tr key={id}>
   104|               <td>{category.name}</td>
   105|             </tr>
   106|           );
   107|         })}
   108|       </tbody>
   109|     </table>
   110|   );
   111| };
   112| const StorageDisclosure = ({ vendor }: { vendor: VendorRecord }) => {
   113|   const {
   114|     name,
   115|     uses_cookies: usesCookies,
   116|     uses_non_cookie_access: usesNonCookieAccess,
   117|     cookie_max_age_seconds: cookieMaxAgeSeconds,
   118|     cookie_refresh: cookieRefresh,
   119|   } = vendor;
   120|   let disclosure = "";
   121|   if (usesCookies) {
   122|     const days = cookieMaxAgeSeconds
   123|       ? Math.ceil(cookieMaxAgeSeconds / 60 / 60 / 24)
   124|       : 0;
   125|     disclosure = `${name} stores cookies with a maximum duration of about ${days} Day(s).`;
   126|     if (cookieRefresh) {
   127|       disclosure = `${disclosure} These cookies may be refreshed.`;
   128|     }
   129|     if (usesNonCookieAccess) {
   130|       disclosure = `${disclosure} This vendor also uses other methods like "local storage" to store and access information on your device.`;
   131|     }
   132|   } else if (usesNonCookieAccess) {
   133|     disclosure = `${name} uses methods like "local storage" to store and access information on your device.`;
   134|   }
   135|   if (disclosure === "") {
   136|     return null;
   137|   }
   138|   return <p>{disclosure}</p>;
   139| };
   140| const TcfVendors = ({
   141|   experience,
   142|   enabledVendorConsentIds,
   143|   enabledVendorLegintIds,
   144|   onChange,
   145|   allOnOffButtons,
   146| }: {
   147|   experience: PrivacyExperience;
   148|   enabledVendorConsentIds: string[];
   149|   enabledVendorLegintIds: string[];
   150|   onChange: (payload: UpdateEnabledIds) => void;
   151|   allOnOffButtons: VNode;
   152| }) => {
   153|   const [isFiltered, setIsFiltered] = useState(false);
   154|   const vendors = useMemo(
   155|     () => transformExperienceToVendorRecords(experience),
   156|     [experience]

# --- HUNK 2: Lines 168-235 ---
   168|   const vendorsToDisplay = isFiltered
   169|     ? vendors.filter((v) => vendorGvlEntry(v.id, experience.gvl))
   170|     : vendors;
   171|   return (
   172|     <div>
   173|       <FilterButtons filters={FILTERS} onChange={handleFilter} />
   174|       {allOnOffButtons}
   175|       <DoubleToggleTable<VendorRecord>
   176|         title="Vendors"
   177|         items={vendorsToDisplay}
   178|         enabledConsentIds={enabledVendorConsentIds}
   179|         enabledLegintIds={enabledVendorLegintIds}
   180|         onToggle={onChange}
   181|         consentModelType="vendorsConsent"
   182|         legintModelType="vendorsLegint"
   183|         renderBadgeLabel={(vendor) =>
   184|           vendorGvlEntry(vendor.id, experience.gvl) ? "IAB TCF" : undefined
   185|         }
   186|         renderToggleChild={(vendor) => {
   187|           const gvlVendor = vendorGvlEntry(vendor.id, experience.gvl);
   188|           const dataCategories: GvlDataCategories | undefined =
   189|             experience.gvl?.dataCategories;
   190|           const hasUrls =
   191|             vendor.privacy_policy_url ||
   192|             vendor.legitimate_interest_disclosure_url;
   193|           return (
   194|             <div>
   195|               <StorageDisclosure vendor={vendor} />
   196|               {hasUrls ? (
   197|                 <div style={{ marginBottom: "1.1em" }}>
   198|                   {vendor.privacy_policy_url ? (
   199|                     <ExternalLink href={vendor.privacy_policy_url}>
   200|                       Privacy policy
   201|                     </ExternalLink>
   202|                   ) : null}
   203|                   {vendor.legitimate_interest_disclosure_url ? (
   204|                     <ExternalLink
   205|                       href={vendor.legitimate_interest_disclosure_url}
   206|                     >
   207|                       Legitimate interest disclosure
   208|                     </ExternalLink>
   209|                   ) : null}
   210|                 </div>
   211|               ) : null}
   212|               <PurposeVendorDetails
   213|                 purposes={[
   214|                   ...(vendor.purpose_consents || []),
   215|                   ...(vendor.purpose_legitimate_interests || []),
   216|                 ]}
   217|                 specialPurposes={vendor.special_purposes}
   218|               />
   219|               <VendorDetails label="Features" lineItems={vendor.features} />
   220|               <VendorDetails
   221|                 label="Special features"
   222|                 lineItems={vendor.special_features}
   223|               />
   224|               <DataCategories
   225|                 gvlVendor={gvlVendor}
   226|                 dataCategories={dataCategories}
   227|               />
   228|             </div>
   229|           );
   230|         }}
   231|       />
   232|     </div>
   233|   );
   234| };
   235| export default TcfVendors;


# ====================================================================
# FILE: clients/fides-js/src/fides-tcf.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 32-248 ---
    32|  *           modalLinkId: null,
    33|  *           privacyCenterUrl: "http://localhost:3000"
    34|  *         }
    35|  *   });
    36|  * </script>
    37|  * ```
    38|  *
    39|  * ...and later:
    40|  * ```
    41|  * <script>
    42|  *   // Query user consent preferences
    43|  *   if (window.Fides.consent.data_sales) {
    44|  *     // ...enable advertising scripts
    45|  *   }
    46|  * ```
    47|  */
    48| import type { TCData } from "@iabtechlabtcf/cmpapi";
    49| import { gtm } from "./integrations/gtm";
    50| import { meta } from "./integrations/meta";
    51| import { shopify } from "./integrations/shopify";
    52| import {
    53|   FidesConfig,
    54|   FidesOptionOverrides,
    55|   OverrideOptions,
    56|   PrivacyExperience,
    57|   UserConsentPreference,
    58| } from "./lib/consent-types";
    59| import { generateFidesString, initializeCmpApi } from "./lib/tcf";
    60| import {
    61|   getInitialCookie,
    62|   getInitialFides,
    63|   getOverrideFidesOptions,
    64|   initialize,
    65| } from "./lib/initialize";
    66| import type { Fides } from "./lib/initialize";
    67| import { dispatchFidesEvent } from "./lib/events";
    68| import {
    69|   debugLog,
    70|   experienceIsValid,
    71|   FidesCookie,
    72|   hasSavedTcfPreferences,
    73|   isNewFidesCookie,
    74|   isPrivacyExperience,
    75|   tcfConsentCookieObjHasSomeConsentSet,
    76|   transformTcfPreferencesToCookieKeys,
    77|   transformUserPreferenceToBoolean,
    78| } from "./fides";
    79| import { renderOverlay } from "./lib/tcf/renderOverlay";
    80| import {
    81|   EnabledIds,
    82|   TcfModelsRecord,
    83|   TcfSavePreferences,
    84| } from "./lib/tcf/types";
    85| import { TCF_KEY_MAP } from "./lib/tcf/constants";
    86| import {
    87|   generateFidesStringFromCookieTcfConsent,
    88|   transformFidesStringToCookieKeys,
    89| } from "./lib/tcf/utils";
    90| declare global {
    91|   interface Window {
    92|     Fides: Fides;
    93|     __tcfapiLocator?: Window;
    94|     __tcfapi?: (
    95|       command: string,
    96|       version: number,
    97|       callback: (tcData: TCData, success: boolean) => void,
    98|       parameter?: number | string
    99|     ) => void;
   100|     config: {
   101|       tc_info: OverrideOptions;
   102|     };
   103|   }
   104| }
   105| let _Fides: Fides;
   106| /** Helper function to determine the initial value of a TCF object */
   107| const getInitialPreference = (
   108|   tcfObject: TcfModelsRecord
   109| ): UserConsentPreference => {
   110|   if (tcfObject.current_preference) {
   111|     return tcfObject.current_preference;
   112|   }
   113|   return tcfObject.default_preference ?? UserConsentPreference.OPT_OUT;
   114| };
   115| const updateCookie = async (
   116|   oldCookie: FidesCookie,
   117|   experience: PrivacyExperience
   118| ): Promise<FidesCookie> => {
   119|   if (!hasSavedTcfPreferences(experience)) {
   120|     return { ...oldCookie, fides_string: "" };
   121|   }
   122|   const tcSavePrefs: TcfSavePreferences = {};
   123|   const enabledIds: EnabledIds = {
   124|     purposesConsent: [],
   125|     purposesLegint: [],
   126|     specialPurposes: [],
   127|     features: [],
   128|     specialFeatures: [],
   129|     vendorsConsent: [],
   130|     vendorsLegint: [],
   131|   };
   132|   TCF_KEY_MAP.forEach(({ experienceKey, cookieKey, enabledIdsKey }) => {
   133|     tcSavePrefs[cookieKey] = [];
   134|     experience[experienceKey]?.forEach((record) => {
   135|       const pref: UserConsentPreference = getInitialPreference(record);
   136|       tcSavePrefs[cookieKey]?.push({
   137|         id: record.id,
   138|         preference: pref,
   139|       });
   140|       if (transformUserPreferenceToBoolean(pref)) {
   141|         if (enabledIdsKey) {
   142|           enabledIds[enabledIdsKey].push(record.id.toString());
   143|         }
   144|       }
   145|     });
   146|   });
   147|   const fidesString = await generateFidesString({
   148|     experience,
   149|     tcStringPreferences: enabledIds,
   150|   });
   151|   const tcfConsent = transformTcfPreferencesToCookieKeys(tcSavePrefs);
   152|   return { ...oldCookie, fides_string: fidesString, tcf_consent: tcfConsent };
   153| };
   154| /**
   155|  * Initialize the global Fides object with the given configuration values
   156|  */
   157| const init = async (config: FidesConfig) => {
   158|   const overrideOptions: Partial<FidesOptionOverrides> =
   159|     getOverrideFidesOptions();
   160|   config.options = { ...config.options, ...overrideOptions };
   161|   const cookie = getInitialCookie(config);
   162|   if (config.options.fidesString) {
   163|     debugLog(
   164|       config.options.debug,
   165|       "Explicit fidesString detected. Proceeding to override all TCF preferences with given fidesString"
   166|     );
   167|     cookie.fides_string = config.options.fidesString;
   168|     cookie.tcf_consent = transformFidesStringToCookieKeys(
   169|       config.options.fidesString,
   170|       config.options.debug
   171|     );
   172|   } else if (
   173|     tcfConsentCookieObjHasSomeConsentSet(cookie.tcf_consent) &&
   174|     !cookie.fides_string &&
   175|     isPrivacyExperience(config.experience) &&
   176|     experienceIsValid(config.experience, config.options)
   177|   ) {
   178|     cookie.fides_string = await generateFidesStringFromCookieTcfConsent(
   179|       config.experience,
   180|       cookie.tcf_consent
   181|     );
   182|     debugLog(
   183|       config.options.debug,
   184|       "fides_string was missing from cookie, so it has been generated based on tcf_consent",
   185|       cookie.fides_string
   186|     );
   187|   }
   188|   const initialFides = getInitialFides({ ...config, cookie });
   189|   initializeCmpApi();
   190|   if (initialFides) {
   191|     Object.assign(_Fides, initialFides);
   192|     dispatchFidesEvent("FidesInitialized", cookie, config.options.debug);
   193|     dispatchFidesEvent("FidesUpdated", cookie, config.options.debug);
   194|   }
   195|   const experience = initialFides?.experience ?? config.experience;
   196|   const updatedFides = await initialize({
   197|     ...config,
   198|     cookie,
   199|     experience,
   200|     renderOverlay,
   201|     updateCookie,
   202|   });
   203|   Object.assign(_Fides, updatedFides);
   204|   if (isNewFidesCookie(cookie)) {
   205|     dispatchFidesEvent("FidesInitialized", cookie, config.options.debug);
   206|   }
   207|   dispatchFidesEvent("FidesUpdated", cookie, config.options.debug);
   208| };
   209| _Fides = {
   210|   consent: {},
   211|   experience: undefined,
   212|   geolocation: {},
   213|   options: {
   214|     debug: true,
   215|     isOverlayEnabled: false,
   216|     isPrefetchEnabled: false,
   217|     isGeolocationEnabled: false,
   218|     geolocationApiUrl: "",
   219|     overlayParentId: null,
   220|     modalLinkId: null,
   221|     privacyCenterUrl: "",
   222|     fidesApiUrl: "",
   223|     serverSideFidesApiUrl: "",
   224|     tcfEnabled: true,
   225|     fidesEmbed: false,
   226|     fidesDisableSaveApi: false,
   227|     fidesString: null,
   228|     apiOptions: null,
   229|   },
   230|   fides_meta: {},
   231|   identity: {},
   232|   tcf_consent: {},
   233|   gtm,
   234|   init,
   235|   initialized: false,
   236|   meta,
   237|   shopify,
   238| };
   239| if (typeof window !== "undefined") {
   240|   window.Fides = _Fides;
   241| }
   242| export * from "./components";
   243| export * from "./lib/consent";
   244| export * from "./lib/consent-context";
   245| export * from "./lib/consent-types";
   246| export * from "./lib/consent-utils";
   247| export * from "./lib/consent-value";
   248| export * from "./lib/cookie";


# ====================================================================
# FILE: clients/fides-js/src/lib/cookie.ts
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 1-162 ---
     1| import { v4 as uuidv4 } from "uuid";
     2| import { getCookie, removeCookie, setCookie, Types } from "typescript-cookie";
     3| import { ConsentContext } from "./consent-context";
     4| import {
     5|   resolveConsentValue,
     6|   resolveLegacyConsentValue,
     7| } from "./consent-value";
     8| import {
     9|   ConsentMechanism,
    10|   Cookies,
    11|   LegacyConsentConfig,
    12|   PrivacyExperience,
    13|   SaveConsentPreference,
    14| } from "./consent-types";
    15| import {
    16|   debugLog,
    17|   transformConsentToFidesUserPreference,
    18|   transformUserPreferenceToBoolean,
    19| } from "./consent-utils";
    20| import type { TcfCookieConsent, TcfSavePreferences } from "./tcf/types";
    21| import { TCF_KEY_MAP } from "./tcf/constants";
    22| import { TcfCookieKeyConsent } from "./tcf/types";
    23| /**
    24|  * Store the user's consent preferences on the cookie, as key -> boolean pairs, e.g.
    25|  * {
    26|  *   "data_sales": false,
    27|  *   "analytics": true,
    28|  *   ...
    29|  * }
    30|  */
    31| export type CookieKeyConsent = {
    32|   [cookieKey: string]: boolean | undefined;
    33| };
    34| /**
    35|  * Store the user's identity values on the cookie, e.g.
    36|  * {
    37|  *   "fides_user_device_id": "1234-",
    38|  *   "email": "jane@example.com",
    39|  *   ...
    40|  * }
    41|  */
    42| export type CookieIdentity = Record<string, string>;
    43| /**
    44|  * Store metadata about the cookie itself, e.g.
    45|  * {
    46|  *   "version": "0.9.0",
    47|  *   "createdAt": "2023-01-01T12:00:00.000Z",
    48|  *   ...
    49|  * }
    50|  */
    51| export type CookieMeta = Record<string, string>;
    52| export interface FidesCookie {
    53|   consent: CookieKeyConsent;
    54|   identity: CookieIdentity;
    55|   fides_meta: CookieMeta;
    56|   fides_string?: string;
    57|   tcf_consent: TcfCookieConsent;
    58| }
    59| /**
    60|  * Save the cookie under the name "fides_consent" for 365 days
    61|  */
    62| export const CONSENT_COOKIE_NAME = "fides_consent";
    63| export const CONSENT_COOKIE_MAX_AGE_DAYS = 365;
    64| /**
    65|  * The typescript-cookie default codec has a more conservative strategy in order to
    66|  * comply with the exact requirements of RFC 6265. For ease of use in external pages,
    67|  * we instead use encode/decodeURIComponent which are available in every browser.
    68|  *
    69|  * See: https://github.com/carhartl/typescript-cookie#encoding
    70|  */
    71| const CODEC: Types.CookieCodecConfig<string, string> = {
    72|   decodeName: decodeURIComponent,
    73|   decodeValue: decodeURIComponent,
    74|   encodeName: encodeURIComponent,
    75|   encodeValue: encodeURIComponent,
    76| };
    77| export const tcfConsentCookieObjHasSomeConsentSet = (
    78|   tcf_consent: TcfCookieConsent | undefined
    79| ): boolean => {
    80|   if (!tcf_consent) {
    81|     return false;
    82|   }
    83|   return Object.values(tcf_consent).some(
    84|     (val: TcfCookieKeyConsent) => Object.keys(val).length >= 0
    85|   );
    86| };
    87| /**
    88|  * Each cookie will be assigned an autogenerated user/device ID, to match user's
    89|  * consent preferences between the browser and the server. This is a randomly
    90|  * generated UUID to prevent it from being identifiable (without matching it to
    91|  * some other identity data!)
    92|  */
    93| export const generateFidesUserDeviceId = (): string => uuidv4();
    94| /**
    95|  * Determine whether or not the given cookie is "new" (ie. has never been saved
    96|  * to the browser).
    97|  */
    98| export const isNewFidesCookie = (cookie: FidesCookie): boolean => {
    99|   const isSaved = Boolean(cookie.fides_meta?.updatedAt);
   100|   return !isSaved;
   101| };
   102| /**
   103|  * Generate a new Fides cookie with default values for the current user.
   104|  */
   105| export const makeFidesCookie = (consent?: CookieKeyConsent): FidesCookie => {
   106|   const now = new Date();
   107|   const userDeviceId = generateFidesUserDeviceId();
   108|   return {
   109|     consent: consent || {},
   110|     identity: {
   111|       fides_user_device_id: userDeviceId,
   112|     },
   113|     fides_meta: {
   114|       version: "0.9.0",
   115|       createdAt: now.toISOString(),
   116|       updatedAt: "",
   117|     },
   118|     tcf_consent: {},
   119|   };
   120| };
   121| /**
   122|  * Retrieve cookie by name
   123|  */
   124| export const getCookieByName = (cookieName: string): string | undefined =>
   125|   getCookie(cookieName, CODEC);
   126| /**
   127|  * Attempt to read, parse, and return the current Fides cookie from the browser.
   128|  * If one doesn't exist, make a new default cookie (including generating a new
   129|  * pseudonymous ID) and return the default values.
   130|  *
   131|  * NOTE: This doesn't *save* the cookie to the browser. To do that, call
   132|  * `saveFidesCookie` with a valid cookie after editing the values.
   133|  */
   134| export const getOrMakeFidesCookie = (
   135|   defaults?: CookieKeyConsent,
   136|   debug: boolean = false
   137| ): FidesCookie => {
   138|   const defaultCookie = makeFidesCookie(defaults);
   139|   if (typeof document === "undefined") {
   140|     return defaultCookie;
   141|   }
   142|   const cookieString = getCookieByName(CONSENT_COOKIE_NAME);
   143|   if (!cookieString) {
   144|     debugLog(
   145|       debug,
   146|       `No existing Fides consent cookie found, returning defaults.`,
   147|       cookieString
   148|     );
   149|     return defaultCookie;
   150|   }
   151|   try {
   152|     let parsedCookie: FidesCookie;
   153|     const parsedJson = JSON.parse(cookieString);
   154|     if ("consent" in parsedJson && "fides_meta" in parsedJson) {
   155|       parsedCookie = parsedJson;
   156|     } else {
   157|       parsedCookie = {
   158|         ...defaultCookie,
   159|         consent: parsedJson,
   160|       };
   161|     }
   162|     const updatedConsent: CookieKeyConsent = {

# --- HUNK 2: Lines 214-329 ---
   214|  *
   215|  * Returns cookie consent that can then be changed according to the
   216|  * user's preferences.
   217|  */
   218| export const buildCookieConsentForExperiences = (
   219|   experience: PrivacyExperience,
   220|   context: ConsentContext,
   221|   debug: boolean
   222| ): CookieKeyConsent => {
   223|   const cookieConsent: CookieKeyConsent = {};
   224|   if (!experience.privacy_notices) {
   225|     return cookieConsent;
   226|   }
   227|   experience.privacy_notices.forEach((notice) => {
   228|     cookieConsent[notice.notice_key] = resolveConsentValue(notice, context);
   229|   });
   230|   debugLog(debug, `Returning cookie consent for experiences.`, cookieConsent);
   231|   return cookieConsent;
   232| };
   233| /**
   234|  * Populates TCF entities with items from cookie.tcf_consent.
   235|  * Returns TCF entities to be assigned to an experience.
   236|  */
   237| export const buildTcfEntitiesFromCookie = (
   238|   experience: PrivacyExperience,
   239|   cookie: FidesCookie
   240| ) => {
   241|   const tcfEntities = {
   242|     tcf_purpose_consents: experience.tcf_purpose_consents,
   243|     tcf_purpose_legitimate_interests:
   244|       experience.tcf_purpose_legitimate_interests,
   245|     tcf_special_purposes: experience.tcf_special_purposes,
   246|     tcf_features: experience.tcf_features,
   247|     tcf_special_features: experience.tcf_special_features,
   248|     tcf_vendor_consents: experience.tcf_vendor_consents,
   249|     tcf_vendor_legitimate_interests: experience.tcf_vendor_legitimate_interests,
   250|     tcf_system_consents: experience.tcf_system_consents,
   251|     tcf_system_legitimate_interests: experience.tcf_system_legitimate_interests,
   252|   };
   253|   if (cookie.tcf_consent) {
   254|     TCF_KEY_MAP.forEach(({ cookieKey, experienceKey }) => {
   255|       const cookieConsent = cookie.tcf_consent[cookieKey] ?? {};
   256|       tcfEntities[experienceKey] = experience[experienceKey]?.map((item) => {
   257|         const preference = Object.hasOwn(cookieConsent, item.id)
   258|           ? transformConsentToFidesUserPreference(
   259|               Boolean(cookieConsent[item.id]),
   260|               ConsentMechanism.OPT_IN
   261|             )
   262|           : // if experience contains a tcf entity not defined by tcfEntities, we override experience current pref with the default pref
   263|             item.default_preference;
   264|         return { ...item, current_preference: preference };
   265|       });
   266|     });
   267|   }
   268|   return tcfEntities;
   269| };
   270| /**
   271|  * Updates prefetched experience, based on:
   272|  * 1) experience: pre-fetched experience-based consent configuration that does not contain user preference.
   273|  * 2) cookie: cookie containing user preference.
   274|  *
   275|  * Returns updated experience with user preferences.
   276|  */
   277| export const updateExperienceFromCookieConsent = ({
   278|   experience,
   279|   cookie,
   280|   debug,
   281| }: {
   282|   experience: PrivacyExperience;
   283|   cookie: FidesCookie;
   284|   debug?: boolean;
   285| }): PrivacyExperience => {
   286|   const noticesWithConsent = experience.privacy_notices?.map((notice) => {
   287|     const preference = Object.hasOwn(cookie.consent, notice.notice_key)
   288|       ? transformConsentToFidesUserPreference(
   289|           Boolean(cookie.consent[notice.notice_key]),
   290|           notice.consent_mechanism
   291|         )
   292|       : undefined;
   293|     return { ...notice, current_preference: preference };
   294|   });
   295|   const tcfEntities = buildTcfEntitiesFromCookie(experience, cookie);
   296|   if (debug) {
   297|     debugLog(
   298|       debug,
   299|       `Returning updated pre-fetched experience with user consent.`,
   300|       experience
   301|     );
   302|   }
   303|   return { ...experience, ...tcfEntities, privacy_notices: noticesWithConsent };
   304| };
   305| export const transformTcfPreferencesToCookieKeys = (
   306|   tcfPreferences: TcfSavePreferences
   307| ): TcfCookieConsent => {
   308|   const cookieKeys: TcfCookieConsent = {};
   309|   TCF_KEY_MAP.forEach(({ cookieKey }) => {
   310|     const preferences = tcfPreferences[cookieKey] ?? [];
   311|     cookieKeys[cookieKey] = Object.fromEntries(
   312|       preferences.map((pref) => [
   313|         pref.id,
   314|         transformUserPreferenceToBoolean(pref.preference),
   315|       ])
   316|     );
   317|   });
   318|   return cookieKeys;
   319| };
   320| /**
   321|  * Generate the *default* consent preferences for this session, based on:
   322|  * 1) config: current legacy consent configuration, which defines the options and their
   323|  *    default values (e.g. "data_sales" => true)
   324|  * 2) context: browser context, which can automatically override those defaults
   325|  *    in some cases (e.g. global privacy control => false)
   326|  *
   327|  * Returns the final set of "defaults" that can then be changed according to the
   328|  * user's preferences.
   329|  */


# ====================================================================
# FILE: clients/fides-js/src/lib/initialize.ts
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 1-233 ---
     1| import { ContainerNode } from "preact";
     2| import { gtm } from "../integrations/gtm";
     3| import { meta } from "../integrations/meta";
     4| import { shopify } from "../integrations/shopify";
     5| import { getConsentContext } from "./consent-context";
     6| import {
     7|   buildTcfEntitiesFromCookie,
     8|   CookieIdentity,
     9|   CookieKeyConsent,
    10|   CookieMeta,
    11|   FidesCookie,
    12|   getCookieByName,
    13|   getOrMakeFidesCookie,
    14|   isNewFidesCookie,
    15|   makeConsentDefaultsLegacy,
    16|   updateCookieFromNoticePreferences,
    17|   updateExperienceFromCookieConsent,
    18| } from "./cookie";
    19| import {
    20|   ConsentMechanism,
    21|   ConsentMethod,
    22|   EmptyExperience,
    23|   FidesConfig,
    24|   FidesOptionOverrides,
    25|   FidesOptions,
    26|   PrivacyExperience,
    27|   SaveConsentPreference,
    28|   UserGeolocation,
    29| } from "./consent-types";
    30| import {
    31|   constructFidesRegionString,
    32|   debugLog,
    33|   experienceIsValid,
    34|   isPrivacyExperience,
    35|   transformConsentToFidesUserPreference,
    36|   validateOptions,
    37| } from "./consent-utils";
    38| import { fetchExperience } from "../services/fides/api";
    39| import { getGeolocation } from "../services/external/geolocation";
    40| import { OverlayProps } from "../components/types";
    41| import { updateConsentPreferences } from "./preferences";
    42| import { resolveConsentValue } from "./consent-value";
    43| import { initOverlay } from "./consent";
    44| import { TcfCookieConsent } from "./tcf/types";
    45| import { FIDES_OVERRIDE_OPTIONS_VALIDATOR_MAP } from "./consent-constants";
    46| export type Fides = {
    47|   consent: CookieKeyConsent;
    48|   experience?: PrivacyExperience | EmptyExperience;
    49|   geolocation?: UserGeolocation;
    50|   fides_string?: string | undefined;
    51|   options: FidesOptions;
    52|   fides_meta: CookieMeta;
    53|   tcf_consent: TcfCookieConsent;
    54|   gtm: typeof gtm;
    55|   identity: CookieIdentity;
    56|   init: (config: FidesConfig) => Promise<void>;
    57|   initialized: boolean;
    58|   meta: typeof meta;
    59|   shopify: typeof shopify;
    60| };
    61| const retrieveEffectiveRegionString = async (
    62|   geolocation: UserGeolocation | undefined,
    63|   options: FidesOptions
    64| ) => {
    65|   const fidesRegionString = constructFidesRegionString(geolocation);
    66|   if (!fidesRegionString) {
    67|     return constructFidesRegionString(
    68|       await getGeolocation(
    69|         options.isGeolocationEnabled,
    70|         options.geolocationApiUrl,
    71|         options.debug
    72|       )
    73|     );
    74|   }
    75|   return fidesRegionString;
    76| };
    77| /**
    78|  * Opt out of notices that can be opted out of automatically.
    79|  * This does not currently do anything with TCF.
    80|  */
    81| const automaticallyApplyGPCPreferences = ({
    82|   cookie,
    83|   fidesRegionString,
    84|   effectiveExperience,
    85|   fidesOptions,
    86| }: {
    87|   cookie: FidesCookie;
    88|   fidesRegionString: string | null;
    89|   effectiveExperience?: PrivacyExperience;
    90|   fidesOptions: FidesOptions;
    91| }) => {
    92|   if (!effectiveExperience || !effectiveExperience.privacy_notices) {
    93|     return;
    94|   }
    95|   const context = getConsentContext();
    96|   if (!context.globalPrivacyControl) {
    97|     return;
    98|   }
    99|   let gpcApplied = false;
   100|   const consentPreferencesToSave = effectiveExperience.privacy_notices.map(
   101|     (notice) => {
   102|       if (
   103|         notice.has_gpc_flag &&
   104|         !notice.current_preference &&
   105|         notice.consent_mechanism !== ConsentMechanism.NOTICE_ONLY
   106|       ) {
   107|         gpcApplied = true;
   108|         return new SaveConsentPreference(
   109|           notice,
   110|           transformConsentToFidesUserPreference(false, notice.consent_mechanism)
   111|         );
   112|       }
   113|       return new SaveConsentPreference(
   114|         notice,
   115|         transformConsentToFidesUserPreference(
   116|           resolveConsentValue(notice, context),
   117|           notice.consent_mechanism
   118|         )
   119|       );
   120|     }
   121|   );
   122|   if (gpcApplied) {
   123|     updateConsentPreferences({
   124|       consentPreferencesToSave,
   125|       experience: effectiveExperience,
   126|       consentMethod: ConsentMethod.gpc,
   127|       options: fidesOptions,
   128|       userLocationString: fidesRegionString || undefined,
   129|       cookie,
   130|       updateCookie: (oldCookie) =>
   131|         updateCookieFromNoticePreferences(oldCookie, consentPreferencesToSave),
   132|     });
   133|   }
   134| };
   135| /**
   136|  * Gets and validates Fides override options provided through URL query params, cookie or window obj.
   137|  *
   138|  * If the same override option is provided in multiple ways, load the value in this order:
   139|  * 1) query param  (top priority)
   140|  * 2) window obj   (second priority)
   141|  * 3) cookie value (last priority)
   142|  */
   143| export const getOverrideFidesOptions = (): Partial<FidesOptionOverrides> => {
   144|   const overrideOptions: Partial<FidesOptionOverrides> = {};
   145|   if (typeof window !== "undefined") {
   146|     const queryParams = new URLSearchParams(window.location.search);
   147|     const windowObj = window.config?.tc_info;
   148|     FIDES_OVERRIDE_OPTIONS_VALIDATOR_MAP.forEach(
   149|       ({ fidesOption, fidesOptionType, fidesOverrideKey, validationRegex }) => {
   150|         const queryParamOverride: string | null =
   151|           queryParams.get(fidesOverrideKey);
   152|         const windowObjOverride: string | boolean | undefined = windowObj
   153|           ? windowObj[fidesOverrideKey]
   154|           : undefined;
   155|         const cookieOverride: string | undefined =
   156|           getCookieByName(fidesOverrideKey);
   157|         const value = queryParamOverride || windowObjOverride || cookieOverride;
   158|         if (value && validationRegex.test(value.toString())) {
   159|           overrideOptions[fidesOption] =
   160|             fidesOptionType === "string" ? value : JSON.parse(value.toString());
   161|         }
   162|       }
   163|     );
   164|   }
   165|   return overrideOptions;
   166| };
   167| /**
   168|  * Get the initial Fides cookie based on legacy consent values
   169|  * as well as any preferences stored in existing cookies
   170|  */
   171| export const getInitialCookie = ({ consent, options }: FidesConfig) => {
   172|   const context = getConsentContext();
   173|   const consentDefaults = makeConsentDefaultsLegacy(
   174|     consent,
   175|     context,
   176|     options.debug
   177|   );
   178|   const cookie: FidesCookie = getOrMakeFidesCookie(
   179|     consentDefaults,
   180|     options.debug
   181|   );
   182|   return cookie;
   183| };
   184| /**
   185|  * If saved preferences are detected, immediately initialize from local cache
   186|  */
   187| export const getInitialFides = ({
   188|   cookie,
   189|   experience,
   190|   geolocation,
   191|   options,
   192| }: {
   193|   cookie: FidesCookie;
   194| } & FidesConfig): Partial<Fides> | null => {
   195|   const hasExistingCookie = !isNewFidesCookie(cookie);
   196|   if (!hasExistingCookie && !options.fidesString) {
   197|     return null;
   198|   }
   199|   let updatedExperience = experience;
   200|   if (isPrivacyExperience(experience)) {
   201|     updatedExperience = updateExperienceFromCookieConsent({
   202|       experience,
   203|       cookie,
   204|       debug: options.debug,
   205|     });
   206|   }
   207|   return {
   208|     consent: cookie.consent,
   209|     fides_meta: cookie.fides_meta,
   210|     identity: cookie.identity,
   211|     experience: updatedExperience,
   212|     tcf_consent: cookie.tcf_consent,
   213|     fides_string: cookie.fides_string,
   214|     geolocation,
   215|     options,
   216|     initialized: true,
   217|   };
   218| };
   219| /**
   220|  * The bulk of the initialization logic
   221|  * 1. Validates options
   222|  * 2. Retrieves geolocation
   223|  * 3. Retrieves experience
   224|  * 4. Updates cookie
   225|  * 5. Initialize overlay components
   226|  * 6. Apply GPC if necessary
   227|  */
   228| export const initialize = async ({
   229|   cookie,
   230|   options,
   231|   experience,
   232|   geolocation,
   233|   renderOverlay,

# --- HUNK 2: Lines 240-336 ---
   240|     experience: PrivacyExperience,
   241|     debug?: boolean
   242|   ) => Promise<FidesCookie>;
   243| } & FidesConfig): Promise<Partial<Fides>> => {
   244|   let shouldInitOverlay: boolean = options.isOverlayEnabled;
   245|   let effectiveExperience = experience;
   246|   let fidesRegionString: string | null = null;
   247|   if (shouldInitOverlay) {
   248|     if (!validateOptions(options)) {
   249|       debugLog(
   250|         options.debug,
   251|         "Invalid overlay options. Skipping overlay initialization.",
   252|         options
   253|       );
   254|       shouldInitOverlay = false;
   255|     }
   256|     fidesRegionString = await retrieveEffectiveRegionString(
   257|       geolocation,
   258|       options
   259|     );
   260|     let fetchedClientSideExperience = false;
   261|     if (!fidesRegionString) {
   262|       debugLog(
   263|         options.debug,
   264|         `User location could not be obtained. Skipping overlay initialization.`
   265|       );
   266|       shouldInitOverlay = false;
   267|     } else if (!isPrivacyExperience(effectiveExperience)) {
   268|       fetchedClientSideExperience = true;
   269|       effectiveExperience = await fetchExperience(
   270|         fidesRegionString,
   271|         options.fidesApiUrl,
   272|         options.debug,
   273|         cookie.identity.fides_user_device_id
   274|       );
   275|     }
   276|     if (
   277|       isPrivacyExperience(effectiveExperience) &&
   278|       experienceIsValid(effectiveExperience, options)
   279|     ) {
   280|       if (options.fidesString) {
   281|         if (fetchedClientSideExperience) {
   282|           debugLog(
   283|             options.debug,
   284|             "Overriding preferences from client-side fetched experience with cookie fides_string consent",
   285|             cookie.fides_string
   286|           );
   287|           const tcfEntities = buildTcfEntitiesFromCookie(
   288|             effectiveExperience,
   289|             cookie
   290|           );
   291|           Object.assign(effectiveExperience, tcfEntities);
   292|         }
   293|       } else {
   294|         const updatedCookie = await updateCookie(
   295|           cookie,
   296|           effectiveExperience,
   297|           options.debug
   298|         );
   299|         debugLog(
   300|           options.debug,
   301|           "Updated cookie based on experience",
   302|           updatedCookie
   303|         );
   304|         Object.assign(cookie, updatedCookie);
   305|       }
   306|       if (shouldInitOverlay) {
   307|         await initOverlay({
   308|           experience: effectiveExperience,
   309|           fidesRegionString: fidesRegionString as string,
   310|           cookie,
   311|           options,
   312|           renderOverlay,
   313|         }).catch(() => {});
   314|       }
   315|     }
   316|   }
   317|   if (shouldInitOverlay && isPrivacyExperience(effectiveExperience)) {
   318|     automaticallyApplyGPCPreferences({
   319|       cookie,
   320|       fidesRegionString,
   321|       effectiveExperience,
   322|       fidesOptions: options,
   323|     });
   324|   }
   325|   return {
   326|     consent: cookie.consent,
   327|     fides_meta: cookie.fides_meta,
   328|     identity: cookie.identity,
   329|     fides_string: cookie.fides_string,
   330|     tcf_consent: cookie.tcf_consent,
   331|     experience,
   332|     geolocation,
   333|     options,
   334|     initialized: true,
   335|   };
   336| };


# ====================================================================
# FILE: clients/fides-js/src/lib/preferences.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-141 ---
     1| import {
     2|   ConsentMethod,
     3|   ConsentOptionCreate,
     4|   FidesOptions,
     5|   LastServedConsentSchema,
     6|   PrivacyExperience,
     7|   PrivacyPreferencesRequest,
     8|   SaveConsentPreference,
     9|   UserConsentPreference,
    10| } from "./consent-types";
    11| import { debugLog } from "./consent-utils";
    12| import {
    13|   FidesCookie,
    14|   removeCookiesFromBrowser,
    15|   saveFidesCookie,
    16| } from "./cookie";
    17| import { dispatchFidesEvent } from "./events";
    18| import { patchUserPreferenceToFidesServer } from "../services/fides/api";
    19| import { TcfSavePreferences } from "./tcf/types";
    20| /**
    21|  * Helper function to save preferences to an API, either custom or internal
    22|  */
    23| async function savePreferencesApi(
    24|   options: FidesOptions,
    25|   cookie: FidesCookie,
    26|   experience: PrivacyExperience,
    27|   fidesUserPreferences: Array<ConsentOptionCreate> | undefined,
    28|   consentMethod: ConsentMethod,
    29|   tcf?: TcfSavePreferences,
    30|   userLocationString?: string
    31| ) {
    32|   if (options.apiOptions?.savePreferencesFn) {
    33|     debugLog(options.debug, "Calling custom save preferences fn");
    34|     await options.apiOptions.savePreferencesFn(
    35|       cookie.consent,
    36|       cookie.fides_string,
    37|       experience
    38|     );
    39|   } else {
    40|     const privacyPreferenceCreate: PrivacyPreferencesRequest = {
    41|       browser_identity: cookie.identity,
    42|       preferences: fidesUserPreferences,
    43|       privacy_experience_id: experience.id,
    44|       user_geography: userLocationString,
    45|       method: consentMethod,
    46|       ...(tcf ?? []),
    47|     };
    48|     debugLog(options.debug, "Saving preferences to Fides API");
    49|     await patchUserPreferenceToFidesServer(
    50|       privacyPreferenceCreate,
    51|       options.fidesApiUrl,
    52|       options.debug
    53|     );
    54|   }
    55| }
    56| /**
    57|  * Updates the user's consent preferences, going through the following steps:
    58|  * 1. Update the cookie object based on new preferences
    59|  * 2. Update the window.Fides object
    60|  * 3. Save preferences to Fides API or a custom function (`savePreferencesFn`)
    61|  * 4. Save preferences to the `fides_consent` cookie in the browser
    62|  * 5. Remove any cookies from notices that were opted-out from the browser
    63|  * 6. Dispatch a "FidesUpdated" event
    64|  */
    65| export const updateConsentPreferences = async ({
    66|   consentPreferencesToSave,
    67|   experience,
    68|   consentMethod,
    69|   options,
    70|   userLocationString,
    71|   cookie,
    72|   servedNotices,
    73|   tcf,
    74|   updateCookie,
    75| }: {
    76|   consentPreferencesToSave?: Array<SaveConsentPreference>;
    77|   experience: PrivacyExperience;
    78|   consentMethod: ConsentMethod;
    79|   options: FidesOptions;
    80|   userLocationString?: string;
    81|   cookie: FidesCookie;
    82|   servedNotices?: Array<LastServedConsentSchema> | null;
    83|   tcf?: TcfSavePreferences;
    84|   updateCookie: (oldCookie: FidesCookie) => Promise<FidesCookie>;
    85| }) => {
    86|   const fidesUserPreferences: Array<ConsentOptionCreate> | undefined =
    87|     consentPreferencesToSave
    88|       ? consentPreferencesToSave.map(({ notice, consentPreference }) => {
    89|           const servedNotice = servedNotices
    90|             ? servedNotices.find(
    91|                 (n) =>
    92|                   n.privacy_notice_history?.id ===
    93|                   notice.privacy_notice_history_id
    94|               )
    95|             : undefined;
    96|           return {
    97|             privacy_notice_history_id: notice.privacy_notice_history_id,
    98|             preference: consentPreference,
    99|             served_notice_history_id: servedNotice?.served_notice_history_id,
   100|           };
   101|         })
   102|       : undefined;
   103|   const updatedCookie = await updateCookie(cookie);
   104|   Object.assign(cookie, updatedCookie);
   105|   debugLog(options.debug, "Updating window.Fides");
   106|   window.Fides.consent = cookie.consent;
   107|   window.Fides.fides_string = cookie.fides_string;
   108|   window.Fides.tcf_consent = cookie.tcf_consent;
   109|   if (!options.fidesDisableSaveApi) {
   110|     try {
   111|       await savePreferencesApi(
   112|         options,
   113|         cookie,
   114|         experience,
   115|         fidesUserPreferences,
   116|         consentMethod,
   117|         tcf,
   118|         userLocationString
   119|       );
   120|     } catch (e) {
   121|       debugLog(
   122|         options.debug,
   123|         "Error saving updated preferences to API, continuing. Error: ",
   124|         e
   125|       );
   126|     }
   127|   }
   128|   debugLog(options.debug, "Saving preferences to cookie");
   129|   saveFidesCookie(cookie);
   130|   if (consentPreferencesToSave) {
   131|     consentPreferencesToSave
   132|       .filter(
   133|         (preference) =>
   134|           preference.consentPreference === UserConsentPreference.OPT_OUT
   135|       )
   136|       .forEach((preference) => {
   137|         removeCookiesFromBrowser(preference.notice.cookies);
   138|       });
   139|   }
   140|   dispatchFidesEvent("FidesUpdated", cookie, options.debug);
   141| };


# ====================================================================
# FILE: clients/fides-js/src/lib/tcf.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 22-69 ---
    22| const FORBIDDEN_LEGITIMATE_INTEREST_PURPOSE_IDS = [1, 3, 4, 5, 6];
    23| const AC_SPECIFICATION_VERSION = 1;
    24| /**
    25|  * Generate an AC String based on TCF-related info from privacy experience.
    26|  */
    27| const generateAcString = ({
    28|   tcStringPreferences,
    29| }: {
    30|   tcStringPreferences: Pick<EnabledIds, "vendorsConsent" | "vendorsLegint">;
    31| }) => {
    32|   const uniqueIds = Array.from(
    33|     new Set(
    34|       [
    35|         ...tcStringPreferences.vendorsConsent,
    36|         ...tcStringPreferences.vendorsLegint,
    37|       ]
    38|         .filter((id) => vendorIsAc(id))
    39|         .map((id) => decodeVendorId(id).id)
    40|     )
    41|   );
    42|   const vendorIds = uniqueIds.sort((a, b) => Number(a) - Number(b)).join(".");
    43|   return `${AC_SPECIFICATION_VERSION}~${vendorIds}`;
    44| };
    45| /**
    46|  * Generate FidesString based on TCF and AC-related info from privacy experience.
    47|  * Called when there is either a FidesInitialized or FidesUpdated event
    48|  */
    49| export const generateFidesString = async ({
    50|   experience,
    51|   tcStringPreferences,
    52| }: {
    53|   tcStringPreferences?: EnabledIds;
    54|   experience: PrivacyExperience;
    55| }): Promise<string> => {
    56|   let encodedString = "";
    57|   try {
    58|     const tcModel = new TCModel(new GVL(experience.gvl));
    59|     await tcModel.gvl.readyPromise;
    60|     tcModel.cmpId = CMP_ID;
    61|     tcModel.cmpVersion = CMP_VERSION;
    62|     tcModel.consentScreen = 1; // todo- On which 'screen' consent was captured; this is a CMP proprietary number encoded into the TC string
    63|     tcModel.gvl.narrowVendorsTo(uniqueGvlVendorIds(experience));
    64|     if (tcStringPreferences) {
    65|       tcStringPreferences.vendorsConsent.forEach((vendorId) => {
    66|         if (vendorGvlEntry(vendorId, experience.gvl)) {
    67|           const { id } = decodeVendorId(vendorId);
    68|           tcModel.vendorConsents.set(+id);
    69|         }

# --- HUNK 2: Lines 102-161 ---
   102|       });
   103|       tcStringPreferences.specialFeatures.forEach((id) => {
   104|         tcModel.specialFeatureOptins.set(+id);
   105|       });
   106|       encodedString = TCString.encode(tcModel);
   107|       const acString = generateAcString({ tcStringPreferences });
   108|       encodedString = `${encodedString}${FIDES_SEPARATOR}${acString}`;
   109|     }
   110|   } catch (e) {
   111|     console.error("Unable to instantiate GVL: ", e);
   112|     return Promise.resolve("");
   113|   }
   114|   return Promise.resolve(encodedString);
   115| };
   116| /**
   117|  * Extract just the TC string from a FidesEvent. This will also remove parts of the
   118|  * TC string that we do not want to surface with our CMP API events, such as
   119|  * `vendors_disclosed` and our own AC string addition.
   120|  */
   121| const fidesEventToTcString = (event: FidesEvent) => {
   122|   const { fides_string: cookieString } = event.detail;
   123|   if (cookieString) {
   124|     const [tcString] = cookieString.split(FIDES_SEPARATOR);
   125|     return tcString.split(".")[0];
   126|   }
   127|   return cookieString;
   128| };
   129| /**
   130|  * Initializes the CMP API, including setting up listeners on FidesEvents to update
   131|  * the CMP API accordingly.
   132|  */
   133| export const initializeCmpApi = () => {
   134|   makeStub();
   135|   const isServiceSpecific = true; // TODO: determine this from the backend?
   136|   const cmpApi = new CmpApi(CMP_ID, CMP_VERSION, isServiceSpecific, {
   137|     getTCData: (next, tcData: TCData, status) => {
   138|       /*
   139|        * If using with 'removeEventListener' command, add a check to see if tcData is not a boolean. */
   140|       if (typeof tcData !== "boolean") {
   141|         const stringSplit = window.Fides.fides_string?.split(FIDES_SEPARATOR);
   142|         const addtlConsent = stringSplit?.length === 2 ? stringSplit[1] : "";
   143|         next({ ...tcData, addtlConsent }, status);
   144|         return;
   145|       }
   146|       next(tcData, status);
   147|     },
   148|   });
   149|   window.addEventListener("FidesInitialized", (event) => {
   150|     const tcString = fidesEventToTcString(event);
   151|     cmpApi.update(tcString ?? null, false);
   152|   });
   153|   window.addEventListener("FidesUIShown", (event) => {
   154|     const tcString = fidesEventToTcString(event);
   155|     cmpApi.update(tcString ?? null, true);
   156|   });
   157|   window.addEventListener("FidesModalClosed", (event) => {
   158|     const tcString = fidesEventToTcString(event);
   159|     cmpApi.update(tcString ?? null, false);
   160|   });
   161|   window.addEventListener("FidesUpdated", (event) => {


# ====================================================================
# FILE: clients/fides-js/src/lib/tcf/constants.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-58 ---
     1| import { TCModel } from "@iabtechlabtcf/core";
     2| import { EnabledIds, TcfExperienceRecords, TcfModelType } from "./types";
     3| /**
     4|  * We store all of our preference strings (TC, AC, etc.) together as one string so that
     5|  * we can have a single-source-of-truth for offline storage & syncing. The code responsible
     6|  * for serving our standards-compliant JS API is responsible for separating out the
     7|  * preference strings for consumption.
     8|  */
     9| export const FIDES_SEPARATOR = ",";
    10| export const TCF_KEY_MAP: {
    11|   cookieKey: TcfModelType;
    12|   experienceKey: keyof TcfExperienceRecords;
    13|   tcfModelKey?: keyof TCModel;
    14|   enabledIdsKey?: keyof EnabledIds;
    15| }[] = [
    16|   {
    17|     cookieKey: "purpose_consent_preferences",
    18|     experienceKey: "tcf_purpose_consents",
    19|     tcfModelKey: "purposeConsents",
    20|     enabledIdsKey: "purposesConsent",
    21|   },
    22|   {
    23|     cookieKey: "purpose_legitimate_interests_preferences",
    24|     experienceKey: "tcf_purpose_legitimate_interests",
    25|     tcfModelKey: "purposeLegitimateInterests",
    26|     enabledIdsKey: "purposesLegint",
    27|   },
    28|   {
    29|     cookieKey: "special_feature_preferences",
    30|     experienceKey: "tcf_special_features",
    31|     tcfModelKey: "specialFeatureOptins",
    32|     enabledIdsKey: "specialFeatures",
    33|   },
    34|   {
    35|     cookieKey: "vendor_consent_preferences",
    36|     experienceKey: "tcf_vendor_consents",
    37|     tcfModelKey: "vendorConsents",
    38|     enabledIdsKey: "vendorsConsent",
    39|   },
    40|   {
    41|     cookieKey: "vendor_legitimate_interests_preferences",
    42|     experienceKey: "tcf_vendor_legitimate_interests",
    43|     tcfModelKey: "vendorLegitimateInterests",
    44|     enabledIdsKey: "vendorsLegint",
    45|   },
    46|   {
    47|     cookieKey: "system_consent_preferences",
    48|     experienceKey: "tcf_system_consents",
    49|   },
    50|   {
    51|     cookieKey: "system_legitimate_interests_preferences",
    52|     experienceKey: "tcf_system_legitimate_interests",
    53|   },
    54| ];
    55| export const EXPERIENCE_KEYS_WITH_PREFERENCES = TCF_KEY_MAP.filter(
    56|   ({ experienceKey }) =>
    57|     experienceKey !== "tcf_features" && experienceKey !== "tcf_special_purposes"
    58| ).map((key) => key.experienceKey);


# ====================================================================
# FILE: clients/fides-js/src/lib/tcf/vendors.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 27-88 ---
    27|  * @example If an id of `gvl.2` is passed in, return GVL Vendor #2
    28|  * @example If an id of `ac.2` is passed in, return undefined
    29|  * @example If an id of `2` is passed in, return GVL Vendor #2 (for backwards compatibility)
    30|  */
    31| export const vendorGvlEntry = (
    32|   vendorId: TCFVendorRelationships["id"],
    33|   gvl: GVLJson | undefined
    34| ) => {
    35|   if (!gvl) {
    36|     return undefined;
    37|   }
    38|   const { source, id } = decodeVendorId(vendorId);
    39|   if (source === VendorSources.GVL || source === undefined) {
    40|     return gvl.vendors[id];
    41|   }
    42|   return undefined;
    43| };
    44| export const vendorIsAc = (vendorId: TCFVendorRelationships["id"]) =>
    45|   decodeVendorId(vendorId).source === VendorSources.AC;
    46| export const uniqueGvlVendorIds = (experience: PrivacyExperience): number[] => {
    47|   const { tcf_vendor_relationships: vendors = [] } = experience;
    48|   const gvlIds = vendors
    49|     .map((v) => v.id)
    50|     .filter((uid) => vendorGvlEntry(uid, experience.gvl));
    51|   return gvlIds.map((uid) => +decodeVendorId(uid).id);
    52| };
    53| const transformVendorDataToVendorRecords = ({
    54|   consents,
    55|   legints,
    56|   relationships,
    57|   isFidesSystem,
    58| }: {
    59|   consents: TCFVendorConsentRecord[];
    60|   legints: TCFVendorLegitimateInterestsRecord[];
    61|   relationships: TCFVendorRelationships[];
    62|   isFidesSystem: boolean;
    63| }) => {
    64|   const records: VendorRecord[] = [];
    65|   relationships.forEach((relationship) => {
    66|     const vendorConsent = consents.find((v) => v.id === relationship.id);
    67|     const vendorLegint = legints.find((v) => v.id === relationship.id);
    68|     const record: VendorRecord = {
    69|       ...relationship,
    70|       ...vendorConsent,
    71|       ...vendorLegint,
    72|       isFidesSystem,
    73|       isConsent: !!vendorConsent,
    74|       isLegint: !!vendorLegint,
    75|     };
    76|     records.push(record);
    77|   });
    78|   return records;
    79| };
    80| export const transformExperienceToVendorRecords = (
    81|   experience: PrivacyExperience
    82| ): VendorRecord[] => {
    83|   const {
    84|     tcf_vendor_consents: consentVendors = [],
    85|     tcf_vendor_legitimate_interests: legintVendors = [],
    86|     tcf_vendor_relationships: vendorRelationships = [],
    87|     tcf_system_consents: consentSystems = [],
    88|     tcf_system_legitimate_interests: legintSystems = [],


# ====================================================================
# FILE: clients/privacy-center/cypress/e2e/consent-banner-tcf.cy.ts
# Total hunks: 16
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| /* eslint-disable no-underscore-dangle */
     2| import {
     3|   CONSENT_COOKIE_NAME,
     4|   FidesCookie,
     5|   PrivacyExperience,
     6|   UserConsentPreference,
     7| } from "fides-js";
     8| import { CookieKeyConsent } from "fides-js/src/lib/cookie";
     9| import { OVERRIDE, stubConfig } from "../support/stubs";
    10| const PURPOSE_2 = {
    11|   id: 2,
    12|   name: "Use limited data to select advertising",
    13| };
    14| const PURPOSE_4 = {
    15|   id: 4,
    16|   name: "Use profiles to select personalised advertising",
    17| };
    18| const PURPOSE_6 = {
    19|   id: 6,
    20|   name: "Use profiles to select personalised content",
    21| };
    22| const PURPOSE_7 = {
    23|   id: 7,
    24|   name: "Measure advertising performance",
    25| };
    26| const PURPOSE_9 = {
    27|   id: 9,
    28|   name: "Understand audiences through statistics or combinations of data from different sources",
    29| };

# --- HUNK 2: Lines 39-91 ---
    39|   id: "2",
    40|   name: "Captify",
    41| };
    42| const STACK_1 = {
    43|   id: 7,
    44|   name: "Selection of personalised advertising, advertising measurement, and audience research",
    45| };
    46| const FEATURE_1 = {
    47|   id: 1,
    48|   name: "Match and combine data from other data sources",
    49| };
    50| const FEATURE_2 = {
    51|   id: 2,
    52|   name: "Link different devices",
    53| };
    54| const SPECIAL_FEATURE_1 = {
    55|   id: 1,
    56|   name: "Use precise geolocation data",
    57| };
    58| describe("Fides-js TCF", () => {
    59|   describe("banner appears when it should", () => {
    60|     beforeEach(() => {
    61|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
    62|       cy.fixture("consent/experience_tcf.json").then((experience) => {
    63|         stubConfig({
    64|           options: {
    65|             isOverlayEnabled: true,
    66|             tcfEnabled: true,
    67|           },
    68|           experience: experience.items[0],
    69|         });
    70|       });
    71|     });
    72|     const setAllTcfToValue = (
    73|       experience: PrivacyExperience,
    74|       value: UserConsentPreference | undefined
    75|     ): PrivacyExperience => {
    76|       const consentPurposes = experience.tcf_purpose_consents?.map((p) => ({
    77|         ...p,
    78|         current_preference: value,
    79|       }));
    80|       const legintPurposes = experience.tcf_purpose_legitimate_interests?.map(
    81|         (p) => ({ ...p, current_preference: value })
    82|       );
    83|       const specialPurposes = experience.tcf_special_purposes?.map((p) => ({
    84|         ...p,
    85|         current_preference: value,
    86|       }));
    87|       const features = experience.tcf_features?.map((f) => ({
    88|         ...f,
    89|         current_preference: value,
    90|       }));
    91|       const specialFeatures = experience.tcf_special_features?.map((f) => ({

# --- HUNK 3: Lines 150-242 ---
   150|         const updatedExperience = setAllTcfToValue(
   151|           experience,
   152|           UserConsentPreference.OPT_IN
   153|         );
   154|         updatedExperience.tcf_purpose_consents![0].current_preference =
   155|           undefined;
   156|         stubConfig({
   157|           options: {
   158|             isOverlayEnabled: true,
   159|             tcfEnabled: true,
   160|           },
   161|           experience: updatedExperience,
   162|         });
   163|         cy.waitUntilFidesInitialized().then(() => {
   164|           cy.get("div#fides-banner");
   165|         });
   166|       });
   167|     });
   168|   });
   169|   describe("initial layer", () => {
   170|     beforeEach(() => {
   171|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   172|       cy.fixture("consent/experience_tcf.json").then((experience) => {
   173|         stubConfig({
   174|           options: {
   175|             isOverlayEnabled: true,
   176|             tcfEnabled: true,
   177|           },
   178|           experience: experience.items[0],
   179|         });
   180|       });
   181|     });
   182|     it("can render purposes in the initial layer as a stack", () => {
   183|       cy.get("div#fides-banner").within(() => {
   184|         cy.get("span").contains(STACK_1.name);
   185|         cy.get("span").contains(PURPOSE_6.name);
   186|         cy.get("span").contains(STACK_1.name).click();
   187|         [PURPOSE_4.id, PURPOSE_9.id, PURPOSE_7.id, PURPOSE_2.id].forEach(
   188|           (id) => {
   189|             cy.get("li").contains(`Purpose ${id}`);
   190|           }
   191|         );
   192|       });
   193|     });
   194|     it("can open the modal", () => {
   195|       cy.get("div#fides-banner").within(() => {
   196|         cy.get("#fides-button-group").within(() => {
   197|           cy.get("button").contains("Manage preferences").click();
   198|         });
   199|       });
   200|       cy.get("#fides-tab-Purposes");
   201|     });
   202|     it("can open the modal from vendor information", () => {
   203|       cy.get("div#fides-banner").within(() => {
   204|         cy.get("button").contains("Vendors").click();
   205|       });
   206|       cy.get("#fides-tab-Vendors");
   207|       cy.getByTestId(`toggle-${SYSTEM_1.name}`);
   208|       cy.getByTestId(`toggle-${VENDOR_1.name}-consent`);
   209|     });
   210|   });
   211|   describe("second layer", () => {
   212|     beforeEach(() => {
   213|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   214|       cy.fixture("consent/experience_tcf.json").then((experience) => {
   215|         stubConfig({
   216|           options: {
   217|             isOverlayEnabled: true,
   218|             tcfEnabled: true,
   219|           },
   220|           experience: experience.items[0],
   221|         });
   222|       });
   223|       cy.get("#fides-modal-link").click();
   224|     });
   225|     describe("rendering the TCF modal", () => {
   226|       it("can render tabs", () => {
   227|         cy.get("#fides-tab-Purposes");
   228|         cy.getByTestId("toggle-Purposes").within(() => {
   229|           cy.get("input").should("be.checked");
   230|         });
   231|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   232|           cy.get("input").should("be.checked");
   233|         });
   234|         cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
   235|           cy.get("input").should("be.checked");
   236|         });
   237|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
   238|           cy.get("input").should("be.checked");
   239|         });
   240|         cy.get(".fides-notice-toggle-header").contains("Special purposes");
   241|         cy.get(".fides-notice-toggle-title").contains(SPECIAL_PURPOSE_1.name);
   242|         cy.getByTestId("toggle-Special purposes").should("not.exist");

# --- HUNK 4: Lines 246-397 ---
   246|         cy.get(".fides-notice-toggle-title").contains(FEATURE_1.name);
   247|         cy.get(".fides-notice-toggle-title").contains(FEATURE_2.name);
   248|         cy.getByTestId(`toggle-${FEATURE_1.name}`).should("not.exist");
   249|         cy.getByTestId(`toggle-${FEATURE_2.name}`).should("not.exist");
   250|         cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
   251|           cy.get("input").should("not.be.checked");
   252|         });
   253|         cy.get("#fides-tab-Vendors").click();
   254|         cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
   255|           cy.get("input").should("be.checked");
   256|         });
   257|       });
   258|       it("can render IAB TCF badge on vendors and filter", () => {
   259|         const newVendor = {
   260|           id: "gvl.1",
   261|           name: "Exponential Interactive, Inc d/b/a VDX.tv",
   262|         };
   263|         cy.fixture("consent/experience_tcf.json").then((payload) => {
   264|           const experience = payload.items[0];
   265|           experience.tcf_vendor_consents.push(newVendor);
   266|           experience.tcf_vendor_relationships.push(newVendor);
   267|           stubConfig({
   268|             options: {
   269|               isOverlayEnabled: true,
   270|               tcfEnabled: true,
   271|             },
   272|             experience,
   273|           });
   274|         });
   275|         cy.get("#fides-modal-link").click();
   276|         cy.get("#fides-tab-Vendors").click();
   277|         cy.get("span")
   278|           .contains(SYSTEM_1.name)
   279|           .within(() => {
   280|             cy.get("span").should("not.exist");
   281|           });
   282|         cy.get("span")
   283|           .contains(VENDOR_1.name)
   284|           .within(() => {
   285|             cy.get("span").contains("IAB TCF");
   286|           });
   287|         cy.get("span")
   288|           .contains(newVendor.name)
   289|           .within(() => {
   290|             cy.get("span").contains("IAB TCF");
   291|           });
   292|         cy.get(".fides-filter-button-group").within(() => {
   293|           cy.get("button").contains("IAB TCF vendors").click();
   294|         });
   295|         cy.get("span").contains(SYSTEM_1.name).should("not.exist");
   296|         cy.get("span").contains(VENDOR_1.name);
   297|         cy.get("span").contains(newVendor.name);
   298|         cy.getByTestId("consent-modal").within(() => {
   299|           cy.get("button").contains("Opt in to all").click();
   300|         });
   301|         cy.window().then((win) => {
   302|           win.__tcfapi("getTCData", 2, cy.stub().as("getTCData"));
   303|           cy.get("@getTCData")
   304|             .should("have.been.calledOnce")
   305|             .its("lastCall.args")
   306|             .then(([tcData, success]) => {
   307|               expect(success).to.eql(true);
   308|               expect(tcData.vendor.consents).to.eql({ 1: true, 2: true });
   309|             });
   310|         });
   311|       });
   312|       it("can render extra vendor info such as cookie and retention data", () => {
   313|         cy.get("#fides-tab-Vendors").click();
   314|         cy.get(".fides-notice-toggle-title").contains(VENDOR_1.name).click();
   315|         cy.get(".fides-disclosure-visible").within(() => {
   316|           cy.get("a")
   317|             .contains("Privacy policy")
   318|             .should("have.attr", "href")
   319|             .and("contain", "https://www.example.com/privacy");
   320|           cy.get("a")
   321|             .contains("Legitimate interest disclosure")
   322|             .should("have.attr", "href")
   323|             .and(
   324|               "contain",
   325|               "https://www.example.com/legitimate_interest_disclosure"
   326|             );
   327|           [PURPOSE_4, PURPOSE_6, PURPOSE_7, PURPOSE_9].forEach((purpose) => {
   328|             cy.get("tr")
   329|               .contains(purpose.name)
   330|               .parent()
   331|               .contains(`${purpose.id} day(s)`);
   332|           });
   333|           cy.get("tr")
   334|             .contains(SPECIAL_PURPOSE_1.name)
   335|             .parent()
   336|             .contains(`${SPECIAL_PURPOSE_1.id} day(s)`);
   337|           cy.get("p").contains(
   338|             'Captify stores cookies with a maximum duration of about 5 Day(s). These cookies may be refreshed. This vendor also uses other methods like "local storage" to store and access information on your device.'
   339|           );
   340|         });
   341|         cy.get(".fides-notice-toggle-title").contains(VENDOR_1.name).click();
   342|         cy.get(".fides-notice-toggle-title").contains(SYSTEM_1.name).click();
   343|         cy.get(".fides-disclosure-visible").within(() => {
   344|           cy.get("p").contains(
   345|             "Fides System stores cookies with a maximum duration of about 5 Day(s)"
   346|           );
   347|         });
   348|       });
   349|       it("can group toggle and fire FidesUIChanged events", () => {
   350|         cy.getByTestId("toggle-Purposes").click();
   351|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
   352|           cy.get("input").should("not.be.checked");
   353|         });
   354|         cy.get("@FidesUIChanged").its("callCount").should("equal", 1);
   355|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).click();
   356|         cy.getByTestId("toggle-Purposes").within(() => {
   357|           cy.get("input").should("be.checked");
   358|         });
   359|         cy.get("@FidesUIChanged").its("callCount").should("equal", 2);
   360|         cy.getByTestId("toggle-all-Purposes-consent").click();
   361|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   362|           cy.get("input").should("not.be.checked");
   363|         });
   364|         cy.get("@FidesUIChanged").its("callCount").should("equal", 3);
   365|         cy.getByTestId("toggle-all-Purposes-consent").click();
   366|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   367|           cy.get("input").should("be.checked");
   368|         });
   369|         cy.get("@FidesUIChanged").its("callCount").should("equal", 4);
   370|         cy.get("button").contains("All off").click();
   371|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
   372|           cy.get("input").should("not.be.checked");
   373|         });
   374|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   375|           cy.get("input").should("not.be.checked");
   376|         });
   377|         cy.get("@FidesUIChanged").its("callCount").should("equal", 5);
   378|       });
   379|       it("can handle group toggle empty states", () => {
   380|         cy.fixture("consent/experience_tcf.json").then((payload) => {
   381|           const experience = payload.items[0];
   382|           const updatedExperience = { ...experience, tcf_purpose_consents: [] };
   383|           stubConfig({
   384|             options: {
   385|               isOverlayEnabled: true,
   386|               tcfEnabled: true,
   387|             },
   388|             experience: updatedExperience,
   389|           });
   390|           cy.waitUntilFidesInitialized().then(() => {
   391|             cy.get("#fides-modal-link").click();
   392|             cy.getByTestId(`toggle-all-Purposes-consent`).should("not.exist");
   393|           });
   394|         });
   395|       });
   396|       it("can handle all on/all off empty states", () => {
   397|         cy.fixture("consent/experience_tcf.json").then((payload) => {

# --- HUNK 5: Lines 430-482 ---
   430|             ...experience,
   431|             tcf_vendor_legitimate_interests,
   432|           };
   433|           stubConfig({
   434|             options: {
   435|               isOverlayEnabled: true,
   436|               tcfEnabled: true,
   437|             },
   438|             experience: updatedExperience,
   439|           });
   440|           cy.waitUntilFidesInitialized().then(() => {
   441|             cy.get("#fides-modal-link").click();
   442|             cy.get("#fides-tab-Vendors").click();
   443|             cy.getByTestId(`toggle-${VENDOR_1.name}`).click();
   444|             cy.getByTestId(`toggle-${VENDOR_1.name}`).within(() => {
   445|               cy.get("input").should("not.be.checked");
   446|             });
   447|             cy.getByTestId(`toggle-${VENDOR_1.name}-consent`).within(() => {
   448|               cy.get("input").should("not.be.checked");
   449|             });
   450|             cy.get("@FidesUIChanged").should("have.been.calledOnce");
   451|           });
   452|         });
   453|       });
   454|     });
   455|     describe("saving preferences", () => {
   456|       const expectedEndOfFidesString = ".IABE,1~";
   457|       it("can opt in to all", () => {
   458|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   459|         cy.getByTestId("consent-modal").within(() => {
   460|           cy.get("button").contains("Opt in to all").click();
   461|           cy.wait("@patchPrivacyPreference").then((interception) => {
   462|             cy.get("@FidesUIChanged").should("not.have.been.called");
   463|             const { body } = interception.request;
   464|             expect(body.purpose_consent_preferences).to.eql([
   465|               { id: PURPOSE_4.id, preference: "opt_in" },
   466|               { id: PURPOSE_6.id, preference: "opt_in" },
   467|               { id: PURPOSE_7.id, preference: "opt_in" },
   468|               { id: PURPOSE_9.id, preference: "opt_in" },
   469|             ]);
   470|             expect(body.purpose_legitimate_interests_preferences).to.eql([
   471|               { id: PURPOSE_2.id, preference: "opt_in" },
   472|             ]);
   473|             expect(body.special_purpose_preferences).to.eql(undefined);
   474|             expect(body.feature_preferences).to.eql(undefined);
   475|             expect(body.special_feature_preferences).to.eql([
   476|               { id: SPECIAL_FEATURE_1.id, preference: "opt_in" },
   477|             ]);
   478|             expect(body.vendor_consent_preferences).to.eql([
   479|               { id: VENDOR_1.id, preference: "opt_in" },
   480|             ]);
   481|             expect(body.vendor_legitimate_interests_preferences).to.eql([]);
   482|             expect(body.system_legitimate_interests_preferences).to.eql([

# --- HUNK 6: Lines 503-551 ---
   503|             .property(`${PURPOSE_2.id}`)
   504|             .is.eql(true);
   505|           expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   506|             .property(`${SPECIAL_FEATURE_1.id}`)
   507|             .is.eql(true);
   508|           expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   509|             .property(`${VENDOR_1.id}`)
   510|             .is.eql(true);
   511|           expect(
   512|             cookieKeyConsent.tcf_consent.vendor_legitimate_interests_preferences
   513|           ).to.eql({});
   514|           expect(
   515|             cookieKeyConsent.tcf_consent.system_consent_preferences
   516|           ).to.eql({});
   517|           expect(
   518|             cookieKeyConsent.tcf_consent.system_legitimate_interests_preferences
   519|           )
   520|             .property(`${SYSTEM_1.id}`)
   521|             .is.eql(true);
   522|           expect(
   523|             cookieKeyConsent.fides_string?.endsWith(expectedEndOfFidesString)
   524|           ).to.eql(true);
   525|         });
   526|       });
   527|       it("can opt out of all", () => {
   528|         cy.getByTestId("consent-modal").within(() => {
   529|           cy.get("button").contains("Opt out of all").click();
   530|           cy.wait("@patchPrivacyPreference").then((interception) => {
   531|             cy.get("@FidesUIChanged").should("not.have.been.called");
   532|             const { body } = interception.request;
   533|             expect(body.purpose_consent_preferences).to.eql([
   534|               { id: PURPOSE_4.id, preference: "opt_out" },
   535|               { id: PURPOSE_6.id, preference: "opt_out" },
   536|               { id: PURPOSE_7.id, preference: "opt_out" },
   537|               { id: PURPOSE_9.id, preference: "opt_out" },
   538|             ]);
   539|             expect(body.purpose_legitimate_interests_preferences).to.eql([
   540|               { id: PURPOSE_2.id, preference: "opt_out" },
   541|             ]);
   542|             expect(body.special_purpose_preferences).to.eql(undefined);
   543|             expect(body.feature_preferences).to.eql(undefined);
   544|             expect(body.special_feature_preferences).to.eql([
   545|               { id: SPECIAL_FEATURE_1.id, preference: "opt_out" },
   546|             ]);
   547|             expect(body.vendor_consent_preferences).to.eql([
   548|               { id: VENDOR_1.id, preference: "opt_out" },
   549|             ]);
   550|             expect(body.vendor_legitimate_interests_preferences).to.eql([]);
   551|             expect(body.system_legitimate_interests_preferences).to.eql([

# --- HUNK 7: Lines 572-624 ---
   572|             .property(`${PURPOSE_2.id}`)
   573|             .is.eql(false);
   574|           expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   575|             .property(`${SPECIAL_FEATURE_1.id}`)
   576|             .is.eql(false);
   577|           expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   578|             .property(`${VENDOR_1.id}`)
   579|             .is.eql(false);
   580|           expect(
   581|             cookieKeyConsent.tcf_consent.vendor_legitimate_interests_preferences
   582|           ).to.eql({});
   583|           expect(
   584|             cookieKeyConsent.tcf_consent.system_consent_preferences
   585|           ).to.eql({});
   586|           expect(
   587|             cookieKeyConsent.tcf_consent.system_legitimate_interests_preferences
   588|           )
   589|             .property(`${SYSTEM_1.id}`)
   590|             .is.eql(false);
   591|           expect(
   592|             cookieKeyConsent.fides_string?.endsWith(expectedEndOfFidesString)
   593|           ).to.eql(true);
   594|         });
   595|       });
   596|       it("can opt in to some and opt out of others", () => {
   597|         cy.getByTestId("consent-modal").within(() => {
   598|           cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).click();
   599|           cy.get("#fides-tab-Features").click();
   600|           cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).click();
   601|           cy.get("#fides-tab-Vendors").click();
   602|           cy.getByTestId(`toggle-${SYSTEM_1.name}`).click();
   603|           cy.get("button").contains("Save").click();
   604|           cy.get("@FidesUIChanged").its("callCount").should("equal", 3);
   605|           cy.wait("@patchPrivacyPreference").then((interception) => {
   606|             const { body } = interception.request;
   607|             expect(body.purpose_consent_preferences).to.eql([
   608|               { id: PURPOSE_4.id, preference: "opt_out" },
   609|               { id: PURPOSE_6.id, preference: "opt_in" },
   610|               { id: PURPOSE_7.id, preference: "opt_in" },
   611|               { id: PURPOSE_9.id, preference: "opt_in" },
   612|             ]);
   613|             expect(body.purpose_legitimate_interests_preferences).to.eql([
   614|               { id: PURPOSE_2.id, preference: "opt_in" },
   615|             ]);
   616|             expect(body.special_purpose_preferences).to.eql(undefined);
   617|             expect(body.feature_preferences).to.eql(undefined);
   618|             expect(body.special_feature_preferences).to.eql([
   619|               { id: SPECIAL_FEATURE_1.id, preference: "opt_in" },
   620|             ]);
   621|             expect(body.vendor_consent_preferences).to.eql([
   622|               { id: VENDOR_1.id, preference: "opt_out" },
   623|             ]);
   624|             expect(body.vendor_legitimate_interests_preferences).to.eql([]);

# --- HUNK 8: Lines 647-1120 ---
   647|             .property(`${PURPOSE_4.id}`)
   648|             .is.eql(false);
   649|           expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   650|             .property(`${SPECIAL_FEATURE_1.id}`)
   651|             .is.eql(true);
   652|           expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   653|             .property(`${VENDOR_1.id}`)
   654|             .is.eql(false);
   655|           expect(
   656|             cookieKeyConsent.tcf_consent.vendor_legitimate_interests_preferences
   657|           ).to.eql({});
   658|           expect(
   659|             cookieKeyConsent.tcf_consent.system_legitimate_interests_preferences
   660|           )
   661|             .property(`${SYSTEM_1.id}`)
   662|             .is.eql(false);
   663|           expect(
   664|             cookieKeyConsent.tcf_consent.system_consent_preferences
   665|           ).to.eql({});
   666|           expect(
   667|             cookieKeyConsent.fides_string?.endsWith(expectedEndOfFidesString)
   668|           ).to.eql(true);
   669|         });
   670|       });
   671|       it("calls custom save preferences API fn instead of internal Fides API when it is provided in Fides.init", () => {
   672|         const apiOptions = {
   673|           /* eslint-disable @typescript-eslint/no-unused-vars */
   674|           savePreferencesFn: (
   675|             consent: CookieKeyConsent,
   676|             fides_string: string | undefined,
   677|             experience: PrivacyExperience
   678|           ): Promise<void> => new Promise(() => {}),
   679|           /* eslint-enable @typescript-eslint/no-unused-vars */
   680|         };
   681|         const spyObject = cy
   682|           .spy(apiOptions, "savePreferencesFn")
   683|           .as("mockSavePreferencesFn");
   684|         cy.fixture("consent/experience_tcf.json").then((privacyExperience) => {
   685|           stubConfig({
   686|             options: {
   687|               isOverlayEnabled: true,
   688|               tcfEnabled: true,
   689|               apiOptions,
   690|             },
   691|             experience: privacyExperience.items[0],
   692|           });
   693|           cy.waitUntilFidesInitialized().then(() => {
   694|             cy.get("#fides-modal-link").click();
   695|             cy.getByTestId("consent-modal").within(() => {
   696|               cy.get("button").contains("Opt out of all").click();
   697|               cy.get("@FidesUpdated").then(() => {
   698|                 expect(spyObject).to.be.called;
   699|                 const spy = spyObject.getCalls();
   700|                 const { args } = spy[0];
   701|                 expect(args[0]).to.deep.equal({
   702|                   data_sales: true,
   703|                   tracking: false,
   704|                 });
   705|                 expect(args[1]).to.equal(
   706|                   "CP0JloAP0JloAGXABBENATEAAAAAAAAAAAAAAAAAAAAA.IABE,1~"
   707|                 );
   708|                 expect(args[2]).to.deep.equal(privacyExperience.items[0]);
   709|               });
   710|               cy.on("fail", (error) => {
   711|                 if (error.message.indexOf("Timed out retrying") !== 0) {
   712|                   throw error;
   713|                 }
   714|               });
   715|               cy.wait("@patchPrivacyPreference", {
   716|                 requestTimeout: 100,
   717|               }).then((xhr) => {
   718|                 assert.isNull(xhr?.response?.body);
   719|               });
   720|             });
   721|           });
   722|         });
   723|       });
   724|       it("skips saving preferences to API when disable save is set", () => {
   725|         cy.fixture("consent/experience_tcf.json").then((experience) => {
   726|           stubConfig({
   727|             options: {
   728|               isOverlayEnabled: true,
   729|               tcfEnabled: true,
   730|               fidesDisableSaveApi: true,
   731|             },
   732|             experience: experience.items[0],
   733|           });
   734|         });
   735|         cy.waitUntilFidesInitialized().then(() => {
   736|           cy.get("#fides-modal-link").click();
   737|           cy.getByTestId("consent-modal").within(() => {
   738|             cy.get("button").contains("Opt out of all").click();
   739|             cy.on("fail", (error) => {
   740|               if (error.message.indexOf("Timed out retrying") !== 0) {
   741|                 throw error;
   742|               }
   743|             });
   744|             cy.wait("@patchPrivacyPreference", {
   745|               requestTimeout: 100,
   746|             }).then((xhr) => {
   747|               assert.isNull(xhr?.response?.body);
   748|             });
   749|           });
   750|           cy.getCookie(CONSENT_COOKIE_NAME).then((cookie) => {
   751|             const cookieKeyConsent: FidesCookie = JSON.parse(
   752|               decodeURIComponent(cookie!.value)
   753|             );
   754|             [PURPOSE_4.id, PURPOSE_9.id, PURPOSE_6.id, PURPOSE_7.id].forEach(
   755|               (pid) => {
   756|                 expect(cookieKeyConsent.tcf_consent.purpose_consent_preferences)
   757|                   .property(`${pid}`)
   758|                   .is.eql(false);
   759|               }
   760|             );
   761|             expect(
   762|               cookieKeyConsent.tcf_consent
   763|                 .purpose_legitimate_interests_preferences
   764|             )
   765|               .property(`${PURPOSE_2.id}`)
   766|               .is.eql(false);
   767|             expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   768|               .property(`${SPECIAL_FEATURE_1.id}`)
   769|               .is.eql(false);
   770|             expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   771|               .property(`${VENDOR_1.id}`)
   772|               .is.eql(false);
   773|             expect(
   774|               cookieKeyConsent.tcf_consent
   775|                 .vendor_legitimate_interests_preferences
   776|             ).to.eql({});
   777|             expect(
   778|               cookieKeyConsent.tcf_consent.system_consent_preferences
   779|             ).to.eql({});
   780|             expect(
   781|               cookieKeyConsent.tcf_consent
   782|                 .system_legitimate_interests_preferences
   783|             )
   784|               .property(`${SYSTEM_1.id}`)
   785|               .is.eql(false);
   786|           });
   787|         });
   788|       });
   789|       it("skips saving preferences to API when disable save is set via cookie", () => {
   790|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   791|         cy.getCookie("fides_disable_save_api").should("not.exist");
   792|         cy.setCookie("fides_disable_save_api", "true");
   793|         cy.fixture("consent/experience_tcf.json").then((experience) => {
   794|           stubConfig({
   795|             options: {
   796|               isOverlayEnabled: true,
   797|               tcfEnabled: true,
   798|             },
   799|             experience: experience.items[0],
   800|           });
   801|         });
   802|         cy.waitUntilFidesInitialized().then(() => {
   803|           cy.get("#fides-modal-link").click();
   804|           cy.getByTestId("consent-modal").within(() => {
   805|             cy.get("button").contains("Opt out of all").click();
   806|             cy.on("fail", (error) => {
   807|               if (error.message.indexOf("Timed out retrying") !== 0) {
   808|                 throw error;
   809|               }
   810|             });
   811|             cy.wait("@patchPrivacyPreference", {
   812|               requestTimeout: 100,
   813|             }).then((xhr) => {
   814|               assert.isNull(xhr?.response?.body);
   815|             });
   816|           });
   817|         });
   818|       });
   819|       it("skips saving preferences to API when disable save is set via query param", () => {
   820|         cy.getCookie("fides_string").should("not.exist");
   821|         cy.fixture("consent/experience_tcf.json").then((experience) => {
   822|           stubConfig(
   823|             {
   824|               options: {
   825|                 isOverlayEnabled: true,
   826|                 tcfEnabled: true,
   827|               },
   828|               experience: experience.items[0],
   829|             },
   830|             null,
   831|             null,
   832|             { fides_disable_save_api: true }
   833|           );
   834|         });
   835|         cy.waitUntilFidesInitialized().then(() => {
   836|           cy.get("#fides-modal-link").click();
   837|           cy.getByTestId("consent-modal").within(() => {
   838|             cy.get("button").contains("Opt out of all").click();
   839|             cy.on("fail", (error) => {
   840|               if (error.message.indexOf("Timed out retrying") !== 0) {
   841|                 throw error;
   842|               }
   843|             });
   844|             cy.wait("@patchPrivacyPreference", {
   845|               requestTimeout: 100,
   846|             }).then((xhr) => {
   847|               assert.isNull(xhr?.response?.body);
   848|             });
   849|           });
   850|         });
   851|       });
   852|       it("skips saving preferences to API when disable save is set via window obj", () => {
   853|         cy.getCookie("fides_string").should("not.exist");
   854|         cy.fixture("consent/experience_tcf.json").then((experience) => {
   855|           stubConfig(
   856|             {
   857|               options: {
   858|                 isOverlayEnabled: true,
   859|                 tcfEnabled: true,
   860|               },
   861|               experience: experience.items[0],
   862|             },
   863|             null,
   864|             null,
   865|             null,
   866|             { fides_disable_save_api: true }
   867|           );
   868|         });
   869|         cy.waitUntilFidesInitialized().then(() => {
   870|           cy.get("#fides-modal-link").click();
   871|           cy.getByTestId("consent-modal").within(() => {
   872|             cy.get("button").contains("Opt out of all").click();
   873|             cy.on("fail", (error) => {
   874|               if (error.message.indexOf("Timed out retrying") !== 0) {
   875|                 throw error;
   876|               }
   877|             });
   878|             cy.wait("@patchPrivacyPreference", {
   879|               requestTimeout: 100,
   880|             }).then((xhr) => {
   881|               assert.isNull(xhr?.response?.body);
   882|             });
   883|           });
   884|         });
   885|       });
   886|     });
   887|   });
   888|   describe("second layer embedded", () => {
   889|     it("automatically renders the second layer and can render tabs", () => {
   890|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   891|       cy.fixture("consent/experience_tcf.json").then((experience) => {
   892|         stubConfig({
   893|           options: {
   894|             isOverlayEnabled: true,
   895|             tcfEnabled: true,
   896|             fidesEmbed: true,
   897|           },
   898|           experience: experience.items[0],
   899|         });
   900|       });
   901|       cy.get("#fides-tab-Purposes");
   902|       cy.getByTestId("toggle-Purposes").within(() => {
   903|         cy.get("input").should("be.checked");
   904|       });
   905|       cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   906|         cy.get("input").should("be.checked");
   907|       });
   908|       cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
   909|         cy.get("input").should("be.checked");
   910|       });
   911|       cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
   912|         cy.get("input").should("be.checked");
   913|       });
   914|       cy.get(".fides-notice-toggle-header").contains("Special purposes");
   915|       cy.get(".fides-notice-toggle-title").contains(SPECIAL_PURPOSE_1.name);
   916|       cy.getByTestId("toggle-Special purposes").should("not.exist");
   917|       cy.getByTestId(`toggle-${SPECIAL_PURPOSE_1.name}`).should("not.exist");
   918|       cy.get("#fides-tab-Features").click();
   919|       cy.get(".fides-notice-toggle-header").contains("Features");
   920|       cy.get(".fides-notice-toggle-title").contains(FEATURE_1.name);
   921|       cy.get(".fides-notice-toggle-title").contains(FEATURE_2.name);
   922|       cy.getByTestId(`toggle-${FEATURE_1.name}`).should("not.exist");
   923|       cy.getByTestId(`toggle-${FEATURE_2.name}`).should("not.exist");
   924|       cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
   925|         cy.get("input").should("not.be.checked");
   926|       });
   927|       cy.get("#fides-tab-Vendors").click();
   928|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
   929|         cy.get("input").should("be.checked");
   930|       });
   931|     });
   932|     it("can opt in to some and opt out of others", () => {
   933|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   934|       cy.fixture("consent/experience_tcf.json").then((experience) => {
   935|         stubConfig({
   936|           options: {
   937|             isOverlayEnabled: true,
   938|             tcfEnabled: true,
   939|             fidesEmbed: true,
   940|           },
   941|           experience: experience.items[0],
   942|         });
   943|       });
   944|       cy.getByTestId("consent-modal").within(() => {
   945|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).click();
   946|         cy.get("#fides-tab-Features").click();
   947|         cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).click();
   948|         cy.get("#fides-tab-Vendors").click();
   949|         cy.getByTestId(`toggle-${SYSTEM_1.name}`).click();
   950|         cy.get("button").contains("Save").click();
   951|         cy.wait("@patchPrivacyPreference").then((interception) => {
   952|           const { body } = interception.request;
   953|           expect(body.purpose_consent_preferences).to.eql([
   954|             { id: PURPOSE_4.id, preference: "opt_out" },
   955|             { id: PURPOSE_6.id, preference: "opt_in" },
   956|             { id: PURPOSE_7.id, preference: "opt_in" },
   957|             { id: PURPOSE_9.id, preference: "opt_in" },
   958|           ]);
   959|           expect(body.purpose_legitimate_interests_preferences).to.eql([
   960|             { id: PURPOSE_2.id, preference: "opt_in" },
   961|           ]);
   962|           expect(body.special_purpose_preferences).to.eql(undefined);
   963|           expect(body.feature_preferences).to.eql(undefined);
   964|           expect(body.special_feature_preferences).to.eql([
   965|             { id: SPECIAL_FEATURE_1.id, preference: "opt_in" },
   966|           ]);
   967|           expect(body.vendor_consent_preferences).to.eql([
   968|             { id: VENDOR_1.id, preference: "opt_out" },
   969|           ]);
   970|           expect(body.vendor_legitimate_interests_preferences).to.eql([]);
   971|           expect(body.system_legitimate_interests_preferences).to.eql([
   972|             { id: SYSTEM_1.id, preference: "opt_out" },
   973|           ]);
   974|           expect(body.system_consent_preferences).to.eql([]);
   975|         });
   976|       });
   977|       cy.getByTestId("consent-modal").should("exist");
   978|       cy.getCookie(CONSENT_COOKIE_NAME).then((cookie) => {
   979|         const cookieKeyConsent: FidesCookie = JSON.parse(
   980|           decodeURIComponent(cookie!.value)
   981|         );
   982|         [PURPOSE_9.id, PURPOSE_6.id, PURPOSE_7.id].forEach((pid) => {
   983|           expect(cookieKeyConsent.tcf_consent.purpose_consent_preferences)
   984|             .property(`${pid}`)
   985|             .is.eql(true);
   986|         });
   987|         expect(
   988|           cookieKeyConsent.tcf_consent.purpose_legitimate_interests_preferences
   989|         )
   990|           .property(`${PURPOSE_2.id}`)
   991|           .is.eql(true);
   992|         expect(cookieKeyConsent.tcf_consent.purpose_consent_preferences)
   993|           .property(`${PURPOSE_4.id}`)
   994|           .is.eql(false);
   995|         expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   996|           .property(`${SPECIAL_FEATURE_1.id}`)
   997|           .is.eql(true);
   998|         expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   999|           .property(`${VENDOR_1.id}`)
  1000|           .is.eql(false);
  1001|         expect(
  1002|           cookieKeyConsent.tcf_consent.vendor_legitimate_interests_preferences
  1003|         ).to.eql({});
  1004|         expect(
  1005|           cookieKeyConsent.tcf_consent.system_legitimate_interests_preferences
  1006|         )
  1007|           .property(`${SYSTEM_1.id}`)
  1008|           .is.eql(false);
  1009|         expect(cookieKeyConsent.tcf_consent.system_consent_preferences).to.eql(
  1010|           {}
  1011|         );
  1012|       });
  1013|     });
  1014|     it("automatically renders the second layer when fidesEmbed is set via cookie", () => {
  1015|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
  1016|       cy.getCookie("fides_embed").should("not.exist");
  1017|       cy.setCookie("fides_embed", "true");
  1018|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1019|         stubConfig({
  1020|           options: {
  1021|             isOverlayEnabled: true,
  1022|             tcfEnabled: true,
  1023|           },
  1024|           experience: experience.items[0],
  1025|         });
  1026|       });
  1027|       cy.get("#fides-tab-Purposes");
  1028|       cy.getByTestId("toggle-Purposes").within(() => {
  1029|         cy.get("input").should("be.checked");
  1030|       });
  1031|       cy.get("#fides-tab-Vendors").click();
  1032|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
  1033|         cy.get("input").should("be.checked");
  1034|       });
  1035|     });
  1036|     it("automatically renders the second layer when fidesEmbed is set via query param", () => {
  1037|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
  1038|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1039|         stubConfig(
  1040|           {
  1041|             options: {
  1042|               isOverlayEnabled: true,
  1043|               tcfEnabled: true,
  1044|             },
  1045|             experience: experience.items[0],
  1046|           },
  1047|           null,
  1048|           null,
  1049|           { fides_embed: true }
  1050|         );
  1051|       });
  1052|       cy.get("#fides-tab-Purposes");
  1053|       cy.getByTestId("toggle-Purposes").within(() => {
  1054|         cy.get("input").should("be.checked");
  1055|       });
  1056|       cy.get("#fides-tab-Vendors").click();
  1057|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
  1058|         cy.get("input").should("be.checked");
  1059|       });
  1060|     });
  1061|     it("automatically renders the second layer when fidesEmbed is set via window obj", () => {
  1062|       cy.getCookie("fides_string").should("not.exist");
  1063|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
  1064|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1065|         stubConfig(
  1066|           {
  1067|             options: {
  1068|               isOverlayEnabled: true,
  1069|               tcfEnabled: true,
  1070|             },
  1071|             experience: experience.items[0],
  1072|           },
  1073|           null,
  1074|           null,
  1075|           null,
  1076|           { fides_embed: true }
  1077|         );
  1078|       });
  1079|       cy.get("#fides-tab-Purposes");
  1080|       cy.getByTestId("toggle-Purposes").within(() => {
  1081|         cy.get("input").should("be.checked");
  1082|       });
  1083|       cy.get("#fides-tab-Vendors").click();
  1084|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
  1085|         cy.get("input").should("be.checked");
  1086|       });
  1087|     });
  1088|   });
  1089|   describe("CMP API", () => {
  1090|     beforeEach(() => {
  1091|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
  1092|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1093|         stubConfig({
  1094|           options: {
  1095|             isOverlayEnabled: true,
  1096|             tcfEnabled: true,
  1097|           },
  1098|           experience: experience.items[0],
  1099|         });
  1100|       });
  1101|       cy.window().then((win) => {
  1102|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1103|       });
  1104|       cy.get("#fides-modal-link").click();
  1105|     });
  1106|     it("can receive a cmpuishown event", () => {
  1107|       cy.get("@TCFEvent")
  1108|         .its("firstCall.args")
  1109|         .then(([tcData, success]) => {
  1110|           expect(success).to.eql(true);
  1111|           expect(tcData.eventStatus === "cmpuishown");
  1112|         });
  1113|     });
  1114|     describe("setting fields", () => {
  1115|       it("can opt in to all and set legitimate interests", () => {
  1116|         cy.getByTestId("consent-modal").within(() => {
  1117|           cy.get("button").contains("Opt in to all").click();
  1118|         });
  1119|         cy.get("@TCFEvent")
  1120|           .its("lastCall.args")

# --- HUNK 9: Lines 1127-1180 ---
  1127|               [PURPOSE_6.id]: true,
  1128|               [PURPOSE_7.id]: true,
  1129|               1: false,
  1130|               2: false,
  1131|               3: false,
  1132|               5: false,
  1133|               8: false,
  1134|             });
  1135|             expect(tcData.purpose.legitimateInterests).to.eql({
  1136|               [PURPOSE_2.id]: true,
  1137|               1: false,
  1138|             });
  1139|             expect(tcData.vendor.consents).to.eql({
  1140|               1: false,
  1141|               [VENDOR_1.id]: true,
  1142|             });
  1143|             expect(tcData.vendor.legitimateInterests).to.eql({});
  1144|           });
  1145|       });
  1146|       it("can handle inappropriate legint purposes", () => {
  1147|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
  1148|         cy.fixture("consent/experience_tcf.json").then((payload) => {
  1149|           const experience: PrivacyExperience = payload.items[0];
  1150|           const purpose4 = experience.tcf_purpose_consents?.find(
  1151|             (p) => p.id === 4
  1152|           )!;
  1153|           experience.tcf_purpose_legitimate_interests?.push(purpose4);
  1154|           const vendor = experience.tcf_purpose_consents![0];
  1155|           experience.tcf_vendor_legitimate_interests?.push({
  1156|             ...vendor,
  1157|             id: "test",
  1158|             purpose_legitimate_interests: [{ id: 4, name: purpose4.name }],
  1159|           });
  1160|           experience.tcf_vendor_relationships?.push({ ...vendor, id: "test" });
  1161|           stubConfig({
  1162|             options: {
  1163|               isOverlayEnabled: true,
  1164|               tcfEnabled: true,
  1165|             },
  1166|             experience,
  1167|           });
  1168|         });
  1169|         cy.window().then((win) => {
  1170|           win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent2"));
  1171|         });
  1172|         cy.get("#fides-modal-link").click();
  1173|         cy.getByTestId("consent-modal").within(() => {
  1174|           cy.get("button").contains("Opt in to all").click();
  1175|         });
  1176|         cy.get("@TCFEvent2")
  1177|           .its("lastCall.args")
  1178|           .then(([tcData, success]) => {
  1179|             expect(success).to.eql(true);
  1180|             expect(tcData.eventStatus).to.eql("useractioncomplete");

# --- HUNK 10: Lines 1185-1901 ---
  1185|               [PURPOSE_7.id]: true,
  1186|               1: false,
  1187|               2: false,
  1188|               3: false,
  1189|               5: false,
  1190|               8: false,
  1191|             });
  1192|             expect(tcData.purpose.legitimateInterests).to.eql({
  1193|               [PURPOSE_2.id]: true,
  1194|               1: false,
  1195|             });
  1196|             expect(tcData.vendor.consents).to.eql({
  1197|               1: false,
  1198|               [VENDOR_1.id]: true,
  1199|             });
  1200|             expect(tcData.vendor.legitimateInterests).to.eql({});
  1201|           });
  1202|       });
  1203|     });
  1204|   });
  1205|   /**
  1206|    * There are the following potential sources of user preferences:
  1207|    * 1) fides_string override option (via config.options.fidesString)
  1208|    * 2) DEFER: preferences API (via a custom function)
  1209|    * 3) local cookie (via fides_consent cookie)
  1210|    * 4) "prefetched" experience (via config.options.experience)
  1211|    * 5) experience API (via GET /privacy-experience)
  1212|    *
  1213|    * These specs test various combinations of those sources of truth and ensure
  1214|    * that Fides loads the correct preferences in each case.
  1215|    */
  1216|   describe("user preferences overrides", () => {
  1217|     beforeEach(() => {
  1218|       cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
  1219|     });
  1220|     /**
  1221|      * Configure a valid fides_consent cookie with previously saved preferences
  1222|      */
  1223|     const setFidesCookie = () => {
  1224|       const uuid = "4fbb6edf-34f6-4717-a6f1-541fd1e5d585";
  1225|       const CREATED_DATE = "2022-12-24T12:00:00.000Z";
  1226|       const UPDATED_DATE = "2022-12-25T12:00:00.000Z";
  1227|       const cookie: FidesCookie = {
  1228|         identity: { fides_user_device_id: uuid },
  1229|         fides_meta: {
  1230|           version: "0.9.0",
  1231|           createdAt: CREATED_DATE,
  1232|           updatedAt: UPDATED_DATE,
  1233|         },
  1234|         consent: {},
  1235|         tcf_consent: {
  1236|           purpose_consent_preferences: {
  1237|             [PURPOSE_4.id]: false,
  1238|             [PURPOSE_9.id]: true,
  1239|           },
  1240|           special_feature_preferences: { [SPECIAL_FEATURE_1.id]: true },
  1241|           system_legitimate_interests_preferences: { [SYSTEM_1.id]: false },
  1242|           vendor_consent_preferences: { [VENDOR_1.id]: true },
  1243|         },
  1244|         fides_string: "CPziCYAPziCYAGXABBENATEIAACAAAAAAAAAABEAAAAA.IABE",
  1245|       };
  1246|       cy.setCookie(CONSENT_COOKIE_NAME, JSON.stringify(cookie));
  1247|     };
  1248|     /**
  1249|      * TEST CASE #1:
  1250|      *  1) fides_string override option (via config.options.fidesString)
  1251|      *  2) DEFER: preferences API (via a custom function)
  1252|      *  3) local cookie (via fides_consent cookie)
  1253|      *  4) "prefetched" experience (via config.options.experience)
  1254|      *  5) experience API (via GET /privacy-experience)
  1255|      *
  1256|      * EXPECTED RESULT: use preferences from local cookie
  1257|      */
  1258|     it("prefers preferences from a cookie when both cookie and experience exist", () => {
  1259|       setFidesCookie();
  1260|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1261|         stubConfig({
  1262|           options: {
  1263|             isOverlayEnabled: true,
  1264|             tcfEnabled: true,
  1265|             fidesString: undefined,
  1266|           },
  1267|           experience: experience.items[0],
  1268|         });
  1269|       });
  1270|       cy.window().then((win) => {
  1271|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1272|       });
  1273|       cy.get("#fides-modal-link").click();
  1274|       cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
  1275|         cy.get("input").should("not.be.checked");
  1276|       });
  1277|       cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
  1278|         cy.get("input").should("be.checked");
  1279|       });
  1280|       cy.getByTestId(`toggle-${PURPOSE_6.name}-consent`).within(() => {
  1281|         cy.get("input").should("not.be.checked");
  1282|       });
  1283|       cy.get("#fides-tab-Features").click();
  1284|       cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
  1285|         cy.get("input").should("be.checked");
  1286|       });
  1287|       cy.get("#fides-tab-Vendors").click();
  1288|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
  1289|         cy.get("input").should("not.be.checked");
  1290|       });
  1291|       cy.getByTestId(`toggle-${VENDOR_1.name}-consent`).within(() => {
  1292|         cy.get("input").should("be.checked");
  1293|       });
  1294|       cy.get("@TCFEvent")
  1295|         .its("lastCall.args")
  1296|         .then(([tcData, success]) => {
  1297|           expect(success).to.eql(true);
  1298|           expect(tcData.eventStatus).to.eql("cmpuishown");
  1299|           expect(tcData.purpose.consents).to.eql({
  1300|             [PURPOSE_4.id]: false,
  1301|             [PURPOSE_6.id]: false,
  1302|             [PURPOSE_7.id]: false,
  1303|             2: false,
  1304|             1: false,
  1305|             3: false,
  1306|             5: false,
  1307|             8: false,
  1308|             9: true,
  1309|           });
  1310|           expect(tcData.purpose.legitimateInterests).to.eql({
  1311|             [PURPOSE_2.id]: true,
  1312|             1: false,
  1313|           });
  1314|           expect(tcData.vendor.consents).to.eql({
  1315|             1: false,
  1316|             [VENDOR_1.id]: true,
  1317|           });
  1318|           expect(tcData.vendor.legitimateInterests).to.eql({});
  1319|           expect(tcData.specialFeatureOptins).to.eql({
  1320|             [SPECIAL_FEATURE_1.id]: true,
  1321|           });
  1322|         });
  1323|     });
  1324|     /**
  1325|      * TEST CASE #2:
  1326|      *  1) fides_string override option (via config.options.fidesString)
  1327|      *  2) DEFER: preferences API (via a custom function)
  1328|      *  3) local cookie (via fides_consent cookie)
  1329|      *  4) "prefetched" experience (via config.options.experience)
  1330|      *  5) experience API (via GET /privacy-experience)
  1331|      *
  1332|      * EXPECTED RESULT: ignore all preferences, do not load TCF experience
  1333|      */
  1334|     it("does nothing when cookie exists but no experience is provided (neither prefetch nor API)", () => {
  1335|       setFidesCookie();
  1336|       stubConfig(
  1337|         {
  1338|           options: {
  1339|             isOverlayEnabled: true,
  1340|             tcfEnabled: true,
  1341|             fidesString: undefined,
  1342|           },
  1343|           experience: OVERRIDE.UNDEFINED,
  1344|         },
  1345|         OVERRIDE.UNDEFINED,
  1346|         OVERRIDE.EMPTY
  1347|       );
  1348|       cy.waitUntilFidesInitialized().then(() => {
  1349|         cy.get("#fides-modal-link").should("not.be.visible");
  1350|       });
  1351|     });
  1352|     /**
  1353|      * TEST CASE #3:
  1354|      *  1) fides_string override option (via config.options.fidesString)
  1355|      *  2) DEFER: preferences API (via a custom function)
  1356|      *  3) local cookie (via fides_consent cookie)
  1357|      *  4) "prefetched" experience (via config.options.experience)
  1358|      *  5) experience API (via GET /privacy-experience)
  1359|      *
  1360|      * EXPECTED RESULT: ignore all preferences, do not load TCF experience
  1361|      */
  1362|     it("does nothing when nothing is provided (neither cookie, nor experience, nor fides_string option)", () => {
  1363|       stubConfig(
  1364|         {
  1365|           options: {
  1366|             isOverlayEnabled: true,
  1367|             tcfEnabled: true,
  1368|             fidesString: undefined,
  1369|           },
  1370|           experience: OVERRIDE.UNDEFINED,
  1371|         },
  1372|         OVERRIDE.UNDEFINED,
  1373|         OVERRIDE.EMPTY
  1374|       );
  1375|       cy.waitUntilFidesInitialized().then(() => {
  1376|         cy.get("#fides-modal-link").should("not.be.visible");
  1377|       });
  1378|     });
  1379|     /**
  1380|      * TEST CASE #4:
  1381|      *  1) fides_string override option (via config.options.fidesString)
  1382|      *  2) DEFER: preferences API (via a custom function)
  1383|      *  3) local cookie (via fides_consent cookie)
  1384|      *  4) "prefetched" experience (via config.options.experience)
  1385|      *  5) experience API (via GET /privacy-experience)
  1386|      *
  1387|      * EXPECTED RESULT: use preferences from fides_string option
  1388|      */
  1389|     it("prefers preferences from fides_string option when fides_string, experience, and cookie exist", () => {
  1390|       setFidesCookie();
  1391|       const fidesStringOverride =
  1392|         "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA.IABE,1~";
  1393|       const expectedTCString = "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA"; // without disclosed vendors
  1394|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1395|         stubConfig({
  1396|           options: {
  1397|             isOverlayEnabled: true,
  1398|             tcfEnabled: true,
  1399|             fidesString: fidesStringOverride,
  1400|           },
  1401|           experience: experience.items[0],
  1402|         });
  1403|       });
  1404|       cy.window().then((win) => {
  1405|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1406|       });
  1407|       cy.get("#fides-modal-link").click();
  1408|       cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
  1409|         cy.get("input").should("be.checked");
  1410|       });
  1411|       cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
  1412|         cy.get("input").should("not.be.checked");
  1413|       });
  1414|       cy.getByTestId(`toggle-${PURPOSE_6.name}-consent`).within(() => {
  1415|         cy.get("input").should("not.be.checked");
  1416|       });
  1417|       cy.getByTestId(`toggle-${PURPOSE_7.name}-consent`).within(() => {
  1418|         cy.get("input").should("be.checked");
  1419|       });
  1420|       cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
  1421|         cy.get("input").should("not.be.checked");
  1422|       });
  1423|       cy.get("#fides-tab-Features").click();
  1424|       cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
  1425|         cy.get("input").should("be.checked");
  1426|       });
  1427|       cy.get("#fides-tab-Vendors").click();
  1428|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
  1429|         cy.get("input").should("be.checked");
  1430|       });
  1431|       cy.getByTestId(`toggle-${VENDOR_1.name}-consent`).within(() => {
  1432|         cy.get("input").should("not.be.checked");
  1433|       });
  1434|       cy.get("@TCFEvent")
  1435|         .its("lastCall.args")
  1436|         .then(([tcData, success]) => {
  1437|           expect(success).to.eql(true);
  1438|           expect(tcData.tcString).to.eql(expectedTCString);
  1439|           expect(tcData.eventStatus).to.eql("cmpuishown");
  1440|           expect(tcData.purpose.consents).to.eql({
  1441|             [PURPOSE_2.id]: false,
  1442|             [PURPOSE_4.id]: false,
  1443|             [PURPOSE_6.id]: false,
  1444|             [PURPOSE_7.id]: true,
  1445|             1: false,
  1446|             2: false,
  1447|             3: false,
  1448|             5: false,
  1449|           });
  1450|           expect(tcData.purpose.legitimateInterests).to.eql({});
  1451|           expect(tcData.vendor.consents).to.eql({});
  1452|           expect(tcData.vendor.legitimateInterests).to.eql({});
  1453|         });
  1454|     });
  1455|     /**
  1456|      * TEST CASE #5:
  1457|      *  1) fides_string override option (via config.options.fidesString)
  1458|      *  2) DEFER: preferences API (via a custom function)
  1459|      *  3) local cookie (via fides_consent cookie)
  1460|      *  4) "prefetched" experience (via config.options.experience)
  1461|      *  5) experience API (via GET /privacy-experience)
  1462|      *
  1463|      * EXPECTED RESULT: use preferences from fides_string option
  1464|      */
  1465|     it("prefers preferences from fides_string option when both fides_string and experience is provided and cookie does not exist", () => {
  1466|       const fidesStringOverride =
  1467|         "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA.IABE,1~";
  1468|       const expectedTCString = "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA"; // without disclosed vendors
  1469|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1470|         stubConfig({
  1471|           options: {
  1472|             isOverlayEnabled: true,
  1473|             tcfEnabled: true,
  1474|             fidesString: fidesStringOverride,
  1475|           },
  1476|           experience: experience.items[0],
  1477|         });
  1478|       });
  1479|       cy.window().then((win) => {
  1480|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1481|       });
  1482|       cy.get("#fides-modal-link").click();
  1483|       cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
  1484|         cy.get("input").should("be.checked");
  1485|       });
  1486|       cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
  1487|         cy.get("input").should("not.be.checked");
  1488|       });
  1489|       cy.getByTestId(`toggle-${PURPOSE_6.name}-consent`).within(() => {
  1490|         cy.get("input").should("not.be.checked");
  1491|       });
  1492|       cy.getByTestId(`toggle-${PURPOSE_7.name}-consent`).within(() => {
  1493|         cy.get("input").should("be.checked");
  1494|       });
  1495|       cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
  1496|         cy.get("input").should("not.be.checked");
  1497|       });
  1498|       cy.get("#fides-tab-Features").click();
  1499|       cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
  1500|         cy.get("input").should("be.checked");
  1501|       });
  1502|       cy.get("#fides-tab-Vendors").click();
  1503|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
  1504|         cy.get("input").should("be.checked");
  1505|       });
  1506|       cy.getByTestId(`toggle-${VENDOR_1.name}-consent`).within(() => {
  1507|         cy.get("input").should("not.be.checked");
  1508|       });
  1509|       cy.get("@TCFEvent")
  1510|         .its("lastCall.args")
  1511|         .then(([tcData, success]) => {
  1512|           expect(success).to.eql(true);
  1513|           expect(tcData.tcString).to.eql(expectedTCString);
  1514|           expect(tcData.eventStatus).to.eql("cmpuishown");
  1515|           expect(tcData.purpose.consents).to.eql({
  1516|             [PURPOSE_2.id]: false,
  1517|             [PURPOSE_4.id]: false,
  1518|             [PURPOSE_6.id]: false,
  1519|             [PURPOSE_7.id]: true,
  1520|             1: false,
  1521|             2: false,
  1522|             3: false,
  1523|             5: false,
  1524|           });
  1525|           expect(tcData.purpose.legitimateInterests).to.eql({});
  1526|           expect(tcData.vendor.consents).to.eql({});
  1527|           expect(tcData.vendor.legitimateInterests).to.eql({});
  1528|         });
  1529|     });
  1530|     /**
  1531|      * TEST CASE #6:
  1532|      *  1) fides_string override option (via config.options.fidesString)
  1533|      *  2) DEFER: preferences API (via a custom function)
  1534|      *  3) local cookie (via fides_consent cookie)
  1535|      *  4) "prefetched" experience (via config.options.experience)
  1536|      *  5) experience API (via GET /privacy-experience)
  1537|      *
  1538|      * EXPECTED RESULT: ignore all preferences, do not load TCF experience
  1539|      */
  1540|     it("does nothing when fides_string option when both fides_string option and cookie exist but no experience exists (neither prefetch nor API)", () => {
  1541|       const fidesStringOverride =
  1542|         "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA.IABE,1~";
  1543|       setFidesCookie();
  1544|       stubConfig(
  1545|         {
  1546|           options: {
  1547|             isOverlayEnabled: true,
  1548|             tcfEnabled: true,
  1549|             fidesString: fidesStringOverride,
  1550|           },
  1551|           experience: OVERRIDE.UNDEFINED,
  1552|         },
  1553|         OVERRIDE.UNDEFINED,
  1554|         OVERRIDE.EMPTY // return no experience
  1555|       );
  1556|       cy.waitUntilFidesInitialized().then(() => {
  1557|         cy.get("#fides-modal-link").should("not.be.visible");
  1558|       });
  1559|     });
  1560|     /**
  1561|      * TEST CASE #7:
  1562|      *  1) fides_string override option (via config.options.fidesString)
  1563|      *  2) DEFER: preferences API (via a custom function)
  1564|      *  3) local cookie (via fides_consent cookie)
  1565|      *  4) "prefetched" experience (via config.options.experience)
  1566|      *  5) experience API (via GET /privacy-experience)
  1567|      *
  1568|      * EXPECTED RESULT: use preferences from fides_string option
  1569|      */
  1570|     it("prefers preferences from fides_string option when both fides_string option and cookie exist and experience is fetched from API", () => {
  1571|       const fidesStringOverride =
  1572|         "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA.IABE,1~";
  1573|       const expectedTCString = "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA"; // without disclosed vendors
  1574|       setFidesCookie();
  1575|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1576|         cy.fixture("consent/geolocation_tcf.json").then((geo) => {
  1577|           stubConfig(
  1578|             {
  1579|               options: {
  1580|                 isOverlayEnabled: true,
  1581|                 tcfEnabled: true,
  1582|                 fidesString: fidesStringOverride,
  1583|               },
  1584|               experience: OVERRIDE.UNDEFINED,
  1585|             },
  1586|             geo,
  1587|             experience
  1588|           );
  1589|         });
  1590|       });
  1591|       cy.waitUntilFidesInitialized().then(() => {
  1592|         cy.window().then((win) => {
  1593|           win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1594|         });
  1595|       });
  1596|       cy.get("#fides-modal-link").click();
  1597|       cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
  1598|         cy.get("input").should("be.checked");
  1599|       });
  1600|       cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
  1601|         cy.get("input").should("not.be.checked");
  1602|       });
  1603|       cy.getByTestId(`toggle-${PURPOSE_6.name}-consent`).within(() => {
  1604|         cy.get("input").should("not.be.checked");
  1605|       });
  1606|       cy.getByTestId(`toggle-${PURPOSE_7.name}-consent`).within(() => {
  1607|         cy.get("input").should("be.checked");
  1608|       });
  1609|       cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
  1610|         cy.get("input").should("not.be.checked");
  1611|       });
  1612|       cy.get("#fides-tab-Features").click();
  1613|       cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
  1614|         cy.get("input").should("be.checked");
  1615|       });
  1616|       cy.get("#fides-tab-Vendors").click();
  1617|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
  1618|         cy.get("input").should("be.checked");
  1619|       });
  1620|       cy.getByTestId(`toggle-${VENDOR_1.name}-consent`).within(() => {
  1621|         cy.get("input").should("not.be.checked");
  1622|       });
  1623|       cy.get("@TCFEvent")
  1624|         .its("lastCall.args")
  1625|         .then(([tcData, success]) => {
  1626|           expect(success).to.eql(true);
  1627|           expect(tcData.tcString).to.eql(expectedTCString);
  1628|           expect(tcData.eventStatus).to.eql("cmpuishown");
  1629|           expect(tcData.purpose.consents).to.eql({
  1630|             [PURPOSE_2.id]: false,
  1631|             [PURPOSE_4.id]: false,
  1632|             [PURPOSE_6.id]: false,
  1633|             [PURPOSE_7.id]: true,
  1634|             1: false,
  1635|             2: false,
  1636|             3: false,
  1637|             5: false,
  1638|           });
  1639|           expect(tcData.purpose.legitimateInterests).to.eql({});
  1640|           expect(tcData.vendor.consents).to.eql({});
  1641|           expect(tcData.vendor.legitimateInterests).to.eql({});
  1642|         });
  1643|     });
  1644|   });
  1645|   describe("fides_string override options", () => {
  1646|     it("uses fides_string when set via cookie", () => {
  1647|       const fidesStringOverride =
  1648|         "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA.IABE,1~";
  1649|       const expectedTCString = "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA"; // without disclosed vendors
  1650|       cy.getCookie("fides_string").should("not.exist");
  1651|       cy.setCookie("fides_string", fidesStringOverride);
  1652|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1653|         stubConfig({
  1654|           options: {
  1655|             isOverlayEnabled: true,
  1656|             tcfEnabled: true,
  1657|           },
  1658|           experience: experience.items[0],
  1659|         });
  1660|       });
  1661|       cy.window().then((win) => {
  1662|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1663|       });
  1664|       cy.get("#fides-modal-link").click();
  1665|       cy.get("@TCFEvent")
  1666|         .its("lastCall.args")
  1667|         .then(([tcData, success]) => {
  1668|           expect(success).to.eql(true);
  1669|           expect(tcData.tcString).to.eql(expectedTCString);
  1670|           expect(tcData.eventStatus).to.eql("cmpuishown");
  1671|           expect(tcData.purpose.consents).to.eql({
  1672|             [PURPOSE_2.id]: false,
  1673|             [PURPOSE_4.id]: false,
  1674|             [PURPOSE_6.id]: false,
  1675|             [PURPOSE_7.id]: true,
  1676|             1: false,
  1677|             2: false,
  1678|             3: false,
  1679|             5: false,
  1680|           });
  1681|           expect(tcData.purpose.legitimateInterests).to.eql({});
  1682|           expect(tcData.vendor.consents).to.eql({});
  1683|           expect(tcData.vendor.legitimateInterests).to.eql({});
  1684|         });
  1685|     });
  1686|     it("uses fides_string when set via query param", () => {
  1687|       const fidesStringOverride =
  1688|         "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA.IABE,1~";
  1689|       const expectedTCString = "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA"; // without disclosed vendors
  1690|       cy.getCookie("fides_string").should("not.exist");
  1691|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1692|         stubConfig(
  1693|           {
  1694|             options: {
  1695|               isOverlayEnabled: true,
  1696|               tcfEnabled: true,
  1697|             },
  1698|             experience: experience.items[0],
  1699|           },
  1700|           null,
  1701|           null,
  1702|           { fides_string: fidesStringOverride }
  1703|         );
  1704|       });
  1705|       cy.window().then((win) => {
  1706|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1707|       });
  1708|       cy.get("#fides-modal-link").click();
  1709|       cy.get("@TCFEvent")
  1710|         .its("lastCall.args")
  1711|         .then(([tcData, success]) => {
  1712|           expect(success).to.eql(true);
  1713|           expect(tcData.tcString).to.eql(expectedTCString);
  1714|           expect(tcData.eventStatus).to.eql("cmpuishown");
  1715|           expect(tcData.purpose.consents).to.eql({
  1716|             [PURPOSE_2.id]: false,
  1717|             [PURPOSE_4.id]: false,
  1718|             [PURPOSE_6.id]: false,
  1719|             [PURPOSE_7.id]: true,
  1720|             1: false,
  1721|             2: false,
  1722|             3: false,
  1723|             5: false,
  1724|           });
  1725|           expect(tcData.purpose.legitimateInterests).to.eql({});
  1726|           expect(tcData.vendor.consents).to.eql({});
  1727|           expect(tcData.vendor.legitimateInterests).to.eql({});
  1728|         });
  1729|     });
  1730|     it("uses fides_string when set via window obj", () => {
  1731|       const fidesStringOverride =
  1732|         "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA.IABE,1~";
  1733|       const expectedTCString = "CPzevcAPzevcAGXABBENATEIAAIAAAAAAAAAAAAAAAAA"; // without disclosed vendors
  1734|       cy.getCookie("fides_string").should("not.exist");
  1735|       cy.fixture("consent/experience_tcf.json").then((experience) => {
  1736|         stubConfig(
  1737|           {
  1738|             options: {
  1739|               isOverlayEnabled: true,
  1740|               tcfEnabled: true,
  1741|             },
  1742|             experience: experience.items[0],
  1743|           },
  1744|           null,
  1745|           null,
  1746|           null,
  1747|           { fides_string: fidesStringOverride }
  1748|         );
  1749|       });
  1750|       cy.window().then((win) => {
  1751|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1752|       });
  1753|       cy.get("#fides-modal-link").click();
  1754|       cy.get("@TCFEvent")
  1755|         .its("lastCall.args")
  1756|         .then(([tcData, success]) => {
  1757|           expect(success).to.eql(true);
  1758|           expect(tcData.tcString).to.eql(expectedTCString);
  1759|           expect(tcData.eventStatus).to.eql("cmpuishown");
  1760|           expect(tcData.purpose.consents).to.eql({
  1761|             [PURPOSE_2.id]: false,
  1762|             [PURPOSE_4.id]: false,
  1763|             [PURPOSE_6.id]: false,
  1764|             [PURPOSE_7.id]: true,
  1765|             1: false,
  1766|             2: false,
  1767|             3: false,
  1768|             5: false,
  1769|           });
  1770|           expect(tcData.purpose.legitimateInterests).to.eql({});
  1771|           expect(tcData.vendor.consents).to.eql({});
  1772|           expect(tcData.vendor.legitimateInterests).to.eql({});
  1773|         });
  1774|     });
  1775|   });
  1776|   describe("ac string", () => {
  1777|     const AC_IDS = [42, 33, 49];
  1778|     const acceptAllAcString = `1~${AC_IDS.sort().join(".")}`;
  1779|     const rejectAllAcString = "1~";
  1780|     beforeEach(() => {
  1781|       cy.fixture("consent/experience_tcf.json").then((payload) => {
  1782|         const experience = payload.items[0];
  1783|         const baseVendor = {
  1784|           id: "2",
  1785|           has_vendor_id: true,
  1786|           name: "Test",
  1787|           description: "A longer description",
  1788|           default_preference: "opt_out",
  1789|           current_preference: null,
  1790|           outdated_preference: null,
  1791|           current_served: null,
  1792|           outdated_served: null,
  1793|           purpose_consents: [
  1794|             {
  1795|               id: 4,
  1796|               name: "Use profiles to select personalised advertising",
  1797|             },
  1798|           ],
  1799|         };
  1800|         AC_IDS.forEach((id, idx) => {
  1801|           const vendor = { ...baseVendor, id: `gacp.${id}`, name: `AC ${id}` };
  1802|           experience.tcf_vendor_consents.push({
  1803|             ...vendor,
  1804|             purpose_consents: idx % 2 === 0 ? [] : baseVendor.purpose_consents,
  1805|           });
  1806|           experience.tcf_vendor_relationships.push(vendor);
  1807|         });
  1808|         stubConfig({
  1809|           options: {
  1810|             isOverlayEnabled: true,
  1811|             tcfEnabled: true,
  1812|           },
  1813|           experience,
  1814|         });
  1815|       });
  1816|       cy.get("#fides-modal-link").click();
  1817|     });
  1818|     it("can opt in to AC vendors and generate string", () => {
  1819|       cy.get("#fides-tab-Vendors").click();
  1820|       AC_IDS.forEach((id) => {
  1821|         cy.getByTestId(`toggle-AC ${id}-consent`);
  1822|       });
  1823|       cy.get("section#fides-panel-Vendors").within(() => {
  1824|         cy.get("button").contains("All on").click();
  1825|       });
  1826|       cy.get("button").contains("Save").click();
  1827|       cy.wait("@patchPrivacyPreference").then((interception) => {
  1828|         const { body } = interception.request;
  1829|         const expected = [
  1830|           { id: VENDOR_1.id, preference: "opt_in" },
  1831|           ...AC_IDS.map((id) => ({ id: `gacp.${id}`, preference: "opt_in" })),
  1832|         ];
  1833|         expect(body.vendor_consent_preferences).to.eql(expected);
  1834|         cy.getCookie(CONSENT_COOKIE_NAME).then((cookie) => {
  1835|           const cookieKeyConsent: FidesCookie = JSON.parse(
  1836|             decodeURIComponent(cookie!.value)
  1837|           );
  1838|           const { fides_string: tcString } = cookieKeyConsent;
  1839|           const acString = tcString?.split(",")[1];
  1840|           expect(acString).to.eql(acceptAllAcString);
  1841|         });
  1842|       });
  1843|     });
  1844|     it("can opt out of AC vendors and generate string", () => {
  1845|       cy.get("#fides-tab-Vendors").click();
  1846|       cy.get("section#fides-panel-Vendors").within(() => {
  1847|         cy.get("button").contains("All off").click();
  1848|       });
  1849|       cy.get("button").contains("Save").click();
  1850|       cy.wait("@patchPrivacyPreference").then((interception) => {
  1851|         const { body } = interception.request;
  1852|         const expected = [
  1853|           { id: VENDOR_1.id, preference: "opt_out" },
  1854|           ...AC_IDS.map((id) => ({ id: `gacp.${id}`, preference: "opt_out" })),
  1855|         ];
  1856|         expect(body.vendor_consent_preferences).to.eql(expected);
  1857|         cy.getCookie(CONSENT_COOKIE_NAME).then((cookie) => {
  1858|           const cookieKeyConsent: FidesCookie = JSON.parse(
  1859|             decodeURIComponent(cookie!.value)
  1860|           );
  1861|           const { fides_string: tcString } = cookieKeyConsent;
  1862|           const acString = tcString?.split(",")[1];
  1863|           expect(acString).to.eql(rejectAllAcString);
  1864|         });
  1865|       });
  1866|     });
  1867|     it("can emit FidesEvent with composite string but CMP API without", () => {
  1868|       cy.window().then((win) => {
  1869|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
  1870|       });
  1871|       cy.get("#fides-tab-Vendors").click();
  1872|       cy.get("section#fides-panel-Vendors").within(() => {
  1873|         cy.get("button").contains("All on").click();
  1874|       });
  1875|       cy.get("button").contains("Save").click();
  1876|       cy.wait("@patchPrivacyPreference");
  1877|       cy.get("@FidesUpdated")
  1878|         .should("have.been.calledTwice")
  1879|         .its("secondCall.args.0.detail.fides_string")
  1880|         .then((fidesString) => {
  1881|           const parts = fidesString.split(",");
  1882|           expect(parts.length).to.eql(2);
  1883|           expect(parts[1]).to.eql(acceptAllAcString);
  1884|         });
  1885|       cy.get("@TCFEvent")
  1886|         .its("lastCall.args")
  1887|         .then(([tcData, success]) => {
  1888|           expect(success).to.eql(true);
  1889|           expect(tcData.eventStatus).to.eql("useractioncomplete");
  1890|           const { tcString } = tcData;
  1891|           const parts = tcString.split(",");
  1892|           expect(parts.length).to.eql(1);
  1893|           expect(parts[0]).to.not.contain("1~");
  1894|           expect(tcData.addtlConsent).to.eql(acceptAllAcString);
  1895|         });
  1896|     });
  1897|     it("can get `addtlConsents` from getTCData custom function", () => {
  1898|       cy.get("#fides-tab-Vendors").click();
  1899|       cy.get("section#fides-panel-Vendors").within(() => {
  1900|         cy.get("button").contains("All on").click();
  1901|       });


# ====================================================================
# FILE: src/fides/api/api/v1/endpoints/privacy_preference_endpoints.py
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 6-106 ---
     6| from fastapi_pagination import Page, Params
     7| from fastapi_pagination.bases import AbstractPage
     8| from fastapi_pagination.ext.sqlalchemy import paginate
     9| from loguru import logger
    10| from sqlalchemy import literal
    11| from sqlalchemy.orm import Query, Session
    12| from starlette.status import (
    13|     HTTP_200_OK,
    14|     HTTP_400_BAD_REQUEST,
    15|     HTTP_404_NOT_FOUND,
    16|     HTTP_422_UNPROCESSABLE_ENTITY,
    17| )
    18| from fides.api.api.deps import get_db
    19| from fides.api.api.v1.endpoints.consent_request_endpoints import (
    20|     _get_consent_request_and_provided_identity,
    21| )
    22| from fides.api.api.v1.endpoints.privacy_request_endpoints import (
    23|     create_privacy_request_func,
    24| )
    25| from fides.api.common_exceptions import (
    26|     DecodeFidesStringError,
    27|     IdentityNotFoundException,
    28|     PrivacyNoticeHistoryNotFound,
    29|     SystemNotFound,
    30| )
    31| from fides.api.custom_types import SafeStr
    32| from fides.api.db.seed import DEFAULT_CONSENT_POLICY
    33| from fides.api.models.fides_user import FidesUser
    34| from fides.api.models.privacy_experience import PrivacyExperience
    35| from fides.api.models.privacy_notice import (
    36|     EnforcementLevel,
    37|     PrivacyNotice,
    38|     PrivacyNoticeHistory,
    39| )
    40| from fides.api.models.privacy_preference import (
    41|     CurrentPrivacyPreference,
    42|     PrivacyPreferenceHistory,
    43|     RequestOrigin,
    44|     ServedNoticeHistory,
    45| )
    46| from fides.api.models.privacy_request import (
    47|     ConsentRequest,
    48|     PrivacyRequest,
    49|     ProvidedIdentity,
    50|     ProvidedIdentityType,
    51| )
    52| from fides.api.oauth.utils import verify_oauth_client
    53| from fides.api.schemas.privacy_preference import (
    54|     TCF_PREFERENCES_FIELD_MAPPING,
    55|     ConsentOptionCreate,
    56|     ConsentReportingSchema,
    57|     CurrentPrivacyPreferenceReportingSchema,
    58|     CurrentPrivacyPreferenceSchema,
    59|     FidesStringFidesPreferences,
    60|     PrivacyPreferencesCreate,
    61|     PrivacyPreferencesRequest,
    62|     RecordConsentServedCreate,
    63|     RecordConsentServedRequest,
    64|     SavePrivacyPreferencesResponse,
    65| )
    66| from fides.api.schemas.privacy_request import (
    67|     BulkPostPrivacyRequests,
    68|     PrivacyRequestCreate,
    69|     VerificationCode,
    70| )
    71| from fides.api.schemas.redis_cache import Identity
    72| from fides.api.schemas.tcf import (
    73|     TCFFeatureSave,
    74|     TCFPurposeSave,
    75|     TCFSpecialFeatureSave,
    76|     TCFSpecialPurposeSave,
    77|     TCFVendorSave,
    78| )
    79| from fides.api.util.api_router import APIRouter
    80| from fides.api.util.consent_util import (
    81|     get_or_create_fides_user_device_id_provided_identity,
    82| )
    83| from fides.api.util.endpoint_utils import fides_limiter, validate_start_and_end_filters
    84| from fides.api.util.tcf.ac_string import decode_ac_string_to_preferences
    85| from fides.api.util.tcf.fides_string import split_fides_string
    86| from fides.api.util.tcf.tc_mobile_data import convert_fides_str_to_mobile_data
    87| from fides.api.util.tcf.tc_string import decode_tc_string_to_preferences
    88| from fides.api.util.tcf.tcf_experience_contents import (
    89|     TCFExperienceContents,
    90|     get_tcf_contents,
    91| )
    92| from fides.common.api.scope_registry import (
    93|     CURRENT_PRIVACY_PREFERENCE_READ,
    94|     PRIVACY_PREFERENCE_HISTORY_READ,
    95| )
    96| from fides.common.api.v1.urn_registry import (
    97|     CONSENT_REQUEST_PRIVACY_PREFERENCES_VERIFY,
    98|     CONSENT_REQUEST_PRIVACY_PREFERENCES_WITH_ID,
    99|     CURRENT_PRIVACY_PREFERENCES_REPORT,
   100|     HISTORICAL_PRIVACY_PREFERENCES_REPORT,
   101|     PRIVACY_PREFERENCES,
   102|     V1_URL_PREFIX,
   103| )
   104| from fides.config import CONFIG
   105| from fides.config.config_proxy import ConfigProxy
   106| router = APIRouter(tags=["Privacy Preference"], prefix=V1_URL_PREFIX)

# --- HUNK 2: Lines 273-355 ---
   273| @router.patch(
   274|     CONSENT_REQUEST_PRIVACY_PREFERENCES_WITH_ID,
   275|     status_code=HTTP_200_OK,
   276|     response_model=SavePrivacyPreferencesResponse,
   277| )
   278| def save_privacy_preferences_with_verified_identity(
   279|     *,
   280|     consent_request_id: str,
   281|     db: Session = Depends(get_db),
   282|     data: PrivacyPreferencesRequest,
   283|     request: Request,
   284| ) -> SavePrivacyPreferencesResponse:
   285|     """Saves privacy preferences in the privacy center.
   286|     The ConsentRequest may have been created under an email, phone number, *or* fides user device id.
   287|     Preferences can be saved under both an email *and* a fides user device id, if the email was persisted
   288|     with the ConsentRequest and the fides user device id is passed in with this secondary request.
   289|     Creates historical records for these preferences for record keeping, and also updates current preferences.
   290|     Creates a privacy request to propagate preferences to third party systems where applicable.
   291|     """
   292|     fides_string: Optional[str] = data.fides_string
   293|     data = update_request_with_decoded_fides_string_fields(data, db)
   294|     verify_privacy_notice_and_historical_records(
   295|         db=db,
   296|         notice_history_list=[
   297|             consent_option.privacy_notice_history_id
   298|             for consent_option in data.preferences
   299|         ],
   300|     )
   301|     verify_previously_served_records(db, data)
   302|     consent_request, provided_identity = _get_consent_request_and_provided_identity(
   303|         db=db,
   304|         consent_request_id=consent_request_id,
   305|         verification_code=data.code,
   306|     )
   307|     (
   308|         provided_identity_verified,
   309|         fides_user_provided_identity,
   310|     ) = classify_identity_type_for_privacy_center_consent_reporting(
   311|         db=db,
   312|         provided_identity=provided_identity,
   313|         browser_identity=data.browser_identity,
   314|     )
   315|     logger.info("Saving privacy preferences")
   316|     try:
   317|         saved_preferences_response: SavePrivacyPreferencesResponse = (
   318|             save_privacy_preferences_for_identities(
   319|                 db=db,
   320|                 consent_request=consent_request,
   321|                 verified_provided_identity=provided_identity_verified,
   322|                 fides_user_provided_identity=fides_user_provided_identity,
   323|                 request=request,
   324|                 original_request_data=data,
   325|             )
   326|         )
   327|         saved_preferences_response.fides_mobile_data = convert_fides_str_to_mobile_data(
   328|             fides_string
   329|         )
   330|         return saved_preferences_response
   331|     except (
   332|         IdentityNotFoundException,
   333|         PrivacyNoticeHistoryNotFound,
   334|         SystemNotFound,
   335|         DecodeFidesStringError,
   336|     ) as exc:
   337|         raise HTTPException(status_code=400, detail=exc.args[0])
   338| def persist_tcf_preferences(
   339|     db: Session,
   340|     user_data: Dict[str, str],
   341|     request_data: PrivacyPreferencesRequest,
   342|     saved_preferences_response: SavePrivacyPreferencesResponse,
   343| ) -> None:
   344|     """Save TCF preferences with respect to individual TCF components if applicable.
   345|     All TCF Preferences have frontend-only enforcement at the moment, so no Privacy Requests
   346|     are created to propagate consent. The "upserted_current_preferences" list is updated in place.
   347|     """
   348|     if not CONFIG.consent.tcf_enabled:
   349|         return
   350|     def save_tcf_preference(
   351|         component_type: str,
   352|         preference_request: Union[
   353|             TCFPurposeSave,
   354|             TCFSpecialPurposeSave,
   355|             TCFVendorSave,

# --- HUNK 3: Lines 580-706 ---
   580|         ):
   581|             raise HTTPException(
   582|                 status_code=HTTP_422_UNPROCESSABLE_ENTITY,
   583|                 detail=f"The ServedNoticeHistory record '{served_notice_history.id}' did not serve the {name_for_log} '{getattr(preference_record, saved_preference_field)}'.",
   584|             )
   585|     for preference in data.preferences:
   586|         validate_served_record(
   587|             preference_record=preference,
   588|             served_record_field="privacy_notice_history_id",
   589|             saved_preference_field="privacy_notice_history_id",
   590|             name_for_log="privacy notice history",
   591|         )
   592|     for tcf_preference_type, field_name in TCF_PREFERENCES_FIELD_MAPPING.items():
   593|         for preference in getattr(data, tcf_preference_type):
   594|             validate_served_record(
   595|                 preference_record=preference,
   596|                 served_record_field=field_name,
   597|                 saved_preference_field="id",
   598|                 name_for_log=field_name,
   599|             )
   600| def update_request_with_decoded_fides_string_fields(
   601|     request_body: PrivacyPreferencesRequest, db: Session
   602| ) -> PrivacyPreferencesRequest:
   603|     """Update the request body with the decoded values of the TC string and AC strings if applicable"""
   604|     if request_body.fides_string:
   605|         tcf_contents: TCFExperienceContents = get_tcf_contents(
   606|             db
   607|         )  # TODO cache this so we're not building each time privacy preference is saved
   608|         try:
   609|             tc_str, ac_str = split_fides_string(request_body.fides_string)
   610|             if tc_str and not CONFIG.consent.tcf_enabled:
   611|                 raise DecodeFidesStringError("TCF must be enabled to decode TC String")
   612|             if ac_str and not CONFIG.consent.ac_enabled:
   613|                 raise DecodeFidesStringError("AC must be enabled to decode AC String")
   614|             decoded_tc_str_request_body: FidesStringFidesPreferences = (
   615|                 decode_tc_string_to_preferences(tc_str, tcf_contents)
   616|             )
   617|             decoded_ac_str_request_body: FidesStringFidesPreferences = (
   618|                 decode_ac_string_to_preferences(ac_str, tcf_contents)
   619|             )
   620|             decoded_tc_str_request_body.vendor_consent_preferences = (
   621|                 decoded_tc_str_request_body.vendor_consent_preferences
   622|                 + decoded_ac_str_request_body.vendor_consent_preferences
   623|             )
   624|         except DecodeFidesStringError as exc:
   625|             raise HTTPException(status_code=HTTP_400_BAD_REQUEST, detail=exc.args[0])
   626|         request_body.fides_string = None
   627|         for decoded_tcf_section in decoded_tc_str_request_body.__fields__:
   628|             setattr(
   629|                 request_body,
   630|                 decoded_tcf_section,
   631|                 getattr(decoded_tc_str_request_body, decoded_tcf_section),
   632|             )
   633|     return request_body
   634| @router.patch(
   635|     PRIVACY_PREFERENCES,
   636|     status_code=HTTP_200_OK,
   637|     response_model=SavePrivacyPreferencesResponse,
   638| )
   639| @fides_limiter.limit(CONFIG.security.public_request_rate_limit)
   640| def save_privacy_preferences(
   641|     *,
   642|     db: Session = Depends(get_db),
   643|     data: PrivacyPreferencesRequest,
   644|     request: Request,
   645|     response: Response,  # required for rate limiting
   646| ) -> SavePrivacyPreferencesResponse:
   647|     """Saves privacy preferences with respect to a fides user device id.
   648|     Creates historical records for these preferences for record keeping, and also updates current preferences.
   649|     Creates a privacy request to propagate preferences to third party systems if applicable.
   650|     """
   651|     fides_string: Optional[str] = data.fides_string
   652|     data = update_request_with_decoded_fides_string_fields(data, db)
   653|     verify_privacy_notice_and_historical_records(
   654|         db=db,
   655|         notice_history_list=[
   656|             consent_option.privacy_notice_history_id
   657|             for consent_option in data.preferences
   658|         ],
   659|     )
   660|     verify_previously_served_records(db, data)
   661|     fides_user_provided_identity: ProvidedIdentity = (
   662|         get_or_create_fides_user_device_id_provided_identity(
   663|             db=db, identity_data=data.browser_identity
   664|         )
   665|     )
   666|     logger.info("Saving privacy preferences with respect to fides user device id")
   667|     try:
   668|         saved_preferences_response: SavePrivacyPreferencesResponse = (
   669|             save_privacy_preferences_for_identities(
   670|                 db=db,
   671|                 consent_request=None,
   672|                 verified_provided_identity=None,
   673|                 fides_user_provided_identity=fides_user_provided_identity,
   674|                 request=request,
   675|                 original_request_data=data,
   676|             )
   677|         )
   678|         saved_preferences_response.fides_mobile_data = convert_fides_str_to_mobile_data(
   679|             fides_string
   680|         )
   681|         return saved_preferences_response
   682|     except (
   683|         IdentityNotFoundException,
   684|         PrivacyNoticeHistoryNotFound,
   685|         SystemNotFound,
   686|         DecodeFidesStringError,
   687|     ) as exc:
   688|         raise HTTPException(status_code=400, detail=exc.args[0])
   689| @router.get(
   690|     CURRENT_PRIVACY_PREFERENCES_REPORT,
   691|     status_code=HTTP_200_OK,
   692|     dependencies=[
   693|         Security(verify_oauth_client, scopes=[CURRENT_PRIVACY_PREFERENCE_READ])
   694|     ],
   695|     response_model=Page[CurrentPrivacyPreferenceReportingSchema],
   696| )
   697| def get_current_privacy_preferences_report(
   698|     *,
   699|     params: Params = Depends(),
   700|     db: Session = Depends(get_db),
   701|     updated_lt: Optional[datetime] = None,
   702|     updated_gt: Optional[datetime] = None,
   703| ) -> AbstractPage[CurrentPrivacyPreference]:
   704|     """Returns the most recently saved privacy preferences for a particular consent item"""
   705|     validate_start_and_end_filters([(updated_lt, updated_gt, "updated")])
   706|     query: Query[CurrentPrivacyPreference] = db.query(CurrentPrivacyPreference)


# ====================================================================
# FILE: src/fides/api/schemas/privacy_preference.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 62-148 ---
    62|     )
    63|     feature: Optional[int] = Field(
    64|         title="The TCF feature that was served or saved against"
    65|     )
    66|     special_feature: Optional[int] = Field(
    67|         title="The TCF special feature that was served or saved against"
    68|     )
    69|     system_consent: Optional[str] = Field(
    70|         title="The System id with a legal basis of consent that was served or saved against. Used when we don't know what vendor "
    71|         "corresponds to the system, so we save preferences against the system directly"
    72|     )
    73|     system_legitimate_interests: Optional[str] = Field(
    74|         title="The System id with a legal basis of legitimate interests that consent was served or saved against. "
    75|         "Used when we don't know what vendor corresponds to the system, so we save preferences against the system directly"
    76|     )
    77| class ConsentOptionCreate(FidesSchema):
    78|     """Schema for saving the user's preference for a given notice"""
    79|     privacy_notice_history_id: str
    80|     preference: UserConsentPreference
    81|     served_notice_history_id: Optional[str]
    82| class FidesStringFidesPreferences(FidesSchema):
    83|     """TCF Preferences that can be unpacked from TC and AC Strings"""
    84|     purpose_consent_preferences: conlist(TCFPurposeSave, max_items=200) = []  # type: ignore
    85|     purpose_legitimate_interests_preferences: conlist(TCFPurposeSave, max_items=200) = []  # type: ignore
    86|     vendor_consent_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
    87|     vendor_legitimate_interests_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
    88|     special_feature_preferences: conlist(TCFSpecialFeatureSave, max_items=200) = []  # type: ignore
    89| class PrivacyPreferencesRequest(FidesStringFidesPreferences):
    90|     """Request body for creating PrivacyPreferences.
    91|     "preferences" key reserved for saving preferences against a privacy notice.
    92|     New *_preferences fields are used for saving preferences against various tcf components.
    93|     """
    94|     browser_identity: Identity
    95|     code: Optional[SafeStr]
    96|     fides_string: Optional[str] = Field(
    97|         description="If supplied, TC strings and AC strings are decoded and preferences saved for purpose_consent, "
    98|         "purpose_legitimate_interests, vendor_consent, vendor_legitimate_interests, and special_features"
    99|     )
   100|     preferences: conlist(ConsentOptionCreate, max_items=200) = []  # type: ignore
   101|     special_purpose_preferences: conlist(TCFSpecialPurposeSave, max_items=200) = []  # type: ignore
   102|     feature_preferences: conlist(TCFFeatureSave, max_items=200) = []  # type: ignore
   103|     system_consent_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
   104|     system_legitimate_interests_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
   105|     policy_key: Optional[FidesKey]  # Will use default consent policy if not supplied
   106|     privacy_experience_id: Optional[SafeStr]
   107|     user_geography: Optional[SafeStr]
   108|     method: Optional[ConsentMethod]
   109|     @root_validator()
   110|     @classmethod
   111|     def validate_tcf_attributes(cls, values: Dict[str, Any]) -> Dict[str, Any]:
   112|         """
   113|         Run a few validation checks related to saving privacy preferences against TCF attributes.
   114|         - Check that there are no duplicates preferences against TCF components
   115|         to avoid confusing responses
   116|         - Make sure that if a TC string is supplied, we're not also supplying values for the related
   117|         TC sections individually, because the TC string will override everything here.
   118|         """
   119|         def tcf_duplicates_detected(preference_list: List) -> bool:
   120|             identifiers = [preference.id for preference in preference_list]
   121|             return len(identifiers) != len(set(identifiers))
   122|         for field_name in TCF_PREFERENCES_FIELD_MAPPING:
   123|             if tcf_duplicates_detected(values.get(field_name, [])):
   124|                 raise ValueError(
   125|                     f"Duplicate preferences saved against TCF component: '{field_name}'"
   126|                 )
   127|         if values.get("fides_string"):
   128|             for field in FidesStringFidesPreferences.__fields__:
   129|                 if values.get(field):
   130|                     raise ValueError(
   131|                         f"Cannot supply value for '{field}' and 'fides_string' simultaneously when saving privacy preferences."
   132|                     )
   133|         return values
   134| class PrivacyPreferencesCreate(PrivacyPreferencesRequest):
   135|     """Schema for creating privacy preferences that is supplemented with information
   136|     from the request headers and the experience"""
   137|     anonymized_ip_address: Optional[str]
   138|     experience_config_history_id: Optional[SafeStr]
   139|     request_origin: Optional[RequestOrigin]
   140|     url_recorded: Optional[SafeStr]
   141|     user_agent: Optional[SafeStr]
   142| class MinimalPrivacyPreferenceHistorySchema(FidesSchema):
   143|     """Minimal privacy preference history schema for building consent emails"""
   144|     preference: UserConsentPreference
   145|     privacy_notice_history: PrivacyNoticeHistorySchema
   146| class RecordConsentServedRequest(FidesSchema):
   147|     """Request body to use when saving that consent was served"""
   148|     browser_identity: Identity


# ====================================================================
# FILE: src/fides/api/schemas/tcf.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-103 ---
    26|         """Default preference for purposes with legal basis of consent is opt-out"""
    27|         values["default_preference"] = UserConsentPreference.opt_out
    28|         return values
    29| class TCFPurposeLegitimateInterestsRecord(NonVendorSection, MappedPurpose):
    30|     """Schema for a TCF Purpose with Legitimate Interests Legal Basis returned in the TCF Overlay Experience"""
    31|     @root_validator
    32|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    33|         """Default preference for purposes with legal basis of legitimate interests is opt-in"""
    34|         values["default_preference"] = UserConsentPreference.opt_in
    35|         return values
    36| class TCFSpecialPurposeRecord(NonVendorSection, MappedPurpose):
    37|     @root_validator
    38|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    39|         """Default preference for special purposes is acknowledge"""
    40|         values["default_preference"] = UserConsentPreference.acknowledge
    41|         return values
    42| class EmbeddedLineItem(FidesSchema):
    43|     """Sparse details for an embedded TCF line item within another TCF component. Read-only."""
    44|     id: int
    45|     name: str
    46| class EmbeddedPurpose(EmbeddedLineItem):
    47|     """Sparse details for an embedded purpose beneath a system or vendor section.  Read-only."""
    48|     retention_period: Optional[str]
    49| class CommonVendorFields(FidesSchema):
    50|     """Fields shared between the three vendor sections of the TCF Experience"""
    51|     id: str
    52|     has_vendor_id: Optional[bool]
    53|     name: Optional[str]
    54|     description: Optional[str]
    55| class TCFVendorConsentRecord(UserSpecificConsentDetails, CommonVendorFields):
    56|     """Schema for a TCF Vendor with Consent legal basis"""
    57|     purpose_consents: List[EmbeddedPurpose] = []
    58|     @root_validator
    59|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    60|         """Default preference for vendor with legal basis of consent is opt-out"""
    61|         values["default_preference"] = UserConsentPreference.opt_out
    62|         return values
    63| class TCFVendorLegitimateInterestsRecord(
    64|     UserSpecificConsentDetails, CommonVendorFields
    65| ):
    66|     """Schema for a TCF Vendor with Legitimate interests legal basis"""
    67|     purpose_legitimate_interests: List[EmbeddedPurpose] = []
    68|     @root_validator
    69|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    70|         """Default preference for vendor with legal basis of leg interests is opt-in"""
    71|         values["default_preference"] = UserConsentPreference.opt_in
    72|         return values
    73| class TCFVendorRelationships(CommonVendorFields):
    74|     """Collects the other relationships for a given vendor - no preferences are saved here"""
    75|     special_purposes: List[EmbeddedPurpose] = []
    76|     features: List[EmbeddedLineItem] = []
    77|     special_features: List[EmbeddedLineItem] = []
    78|     cookie_max_age_seconds: Optional[int]
    79|     uses_cookies: Optional[bool]
    80|     cookie_refresh: Optional[bool]
    81|     uses_non_cookie_access: Optional[bool]
    82|     legitimate_interest_disclosure_url: Optional[AnyUrl]
    83|     privacy_policy_url: Optional[AnyUrl]
    84| class TCFFeatureRecord(NonVendorSection, Feature):
    85|     """Schema for a TCF Feature: returned in the TCF Overlay Experience"""
    86|     @root_validator
    87|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    88|         """Default preference for features is acknowledge"""
    89|         values["default_preference"] = UserConsentPreference.acknowledge
    90|         return values
    91| class TCFSpecialFeatureRecord(NonVendorSection, Feature):
    92|     """Schema for a TCF Special Feature: returned in the TCF Overlay Experience"""
    93|     @root_validator
    94|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    95|         """Default preference for special features is acknowledge"""
    96|         values["default_preference"] = UserConsentPreference.opt_out
    97|         return values
    98| class TCFPreferenceSaveBase(FidesSchema):
    99|     """Base schema for saving individual TCF component preferences"""
   100|     id: int
   101|     preference: UserConsentPreference
   102|     served_notice_history_id: Optional[str]
   103| class TCFPurposeSave(TCFPreferenceSaveBase):


# ====================================================================
# FILE: src/fides/api/util/tcf/experience_meta.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-29 ---
     1| import hashlib
     2| import json
     3| from typing import Dict, List
     4| from pydantic import Extra, root_validator
     5| from fides.api.models.privacy_notice import UserConsentPreference
     6| from fides.api.schemas.base_class import FidesSchema
     7| from fides.api.schemas.privacy_experience import ExperienceMeta
     8| from fides.api.schemas.tcf import TCMobileData
     9| from fides.api.util.tcf.fides_string import build_fides_string
    10| from fides.api.util.tcf.tc_mobile_data import build_tc_data_for_mobile
    11| from fides.api.util.tcf.tc_model import TCModel, convert_tcf_contents_to_tc_model
    12| from fides.api.util.tcf.tcf_experience_contents import TCFExperienceContents
    13| class TCFVersionHash(FidesSchema):
    14|     """Minimal subset of the TCF experience details that capture when consent should be resurfaced"""
    15|     policy_version: int
    16|     purpose_consents: List[int]
    17|     purpose_legitimate_interests: List[int]
    18|     special_feature_optins: List[int]
    19|     vendor_consents: List[int]
    20|     vendor_legitimate_interests: List[int]
    21|     @root_validator()
    22|     @classmethod
    23|     def sort_lists(cls, values: Dict) -> Dict:
    24|         """Verify lists are sorted ascending for repeatability"""
    25|         for field, val in values.items():
    26|             if isinstance(val, list):
    27|                 values[field] = sorted(val)
    28|         return values
    29|     class Config:

# --- HUNK 2: Lines 46-76 ---
    46|     if there are updates to vendors, purposes, and special features sections or legal basis.
    47|     This hash can be used to determine if the TCF Experience needs to be resurfaced to the customer,
    48|     because the experience has changed in a meaningful way.
    49|     """
    50|     tcf_version_hash_model: TCFVersionHash = _build_tcf_version_hash_model(tcf_contents)
    51|     json_str: str = json.dumps(tcf_version_hash_model.dict(), sort_keys=True)
    52|     hashed_val: str = hashlib.sha256(json_str.encode()).hexdigest()
    53|     return hashed_val[:12]  # Shortening string for usability, collision risk is low
    54| def build_experience_tcf_meta(tcf_contents: TCFExperienceContents) -> Dict:
    55|     """Build TCF Meta information to supplement a TCF Privacy Experience at runtime"""
    56|     accept_all_tc_model: TCModel = convert_tcf_contents_to_tc_model(
    57|         tcf_contents, UserConsentPreference.opt_in
    58|     )
    59|     reject_all_tc_model: TCModel = convert_tcf_contents_to_tc_model(
    60|         tcf_contents, UserConsentPreference.opt_out
    61|     )
    62|     accept_all_mobile_data: TCMobileData = build_tc_data_for_mobile(accept_all_tc_model)
    63|     reject_all_mobile_data: TCMobileData = build_tc_data_for_mobile(reject_all_tc_model)
    64|     return ExperienceMeta(
    65|         version_hash=build_tcf_version_hash(tcf_contents),
    66|         accept_all_fides_string=build_fides_string(
    67|             accept_all_mobile_data.IABTCF_TCString,
    68|             accept_all_mobile_data.IABTCF_AddtlConsent,
    69|         ),
    70|         reject_all_fides_string=build_fides_string(
    71|             reject_all_mobile_data.IABTCF_TCString,
    72|             reject_all_mobile_data.IABTCF_AddtlConsent,
    73|         ),
    74|         accept_all_fides_mobile_data=accept_all_mobile_data,
    75|         reject_all_fides_mobile_data=reject_all_mobile_data,
    76|     ).dict()


# ====================================================================
# FILE: src/fides/api/util/tcf/tc_model.py
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-56 ---
     1| import re
     2| from datetime import datetime
     3| from typing import Dict, List, Optional, Tuple
     4| from pydantic import Field, NonNegativeInt, PositiveInt, root_validator, validator
     5| from fides.api.models.privacy_notice import UserConsentPreference
     6| from fides.api.schemas.base_class import FidesSchema
     7| from fides.api.schemas.tcf import (
     8|     TCFSpecialFeatureRecord,
     9|     TCFVendorConsentRecord,
    10|     TCFVendorLegitimateInterestsRecord,
    11| )
    12| from fides.api.util.tcf.ac_string import build_ac_vendor_consents
    13| from fides.api.util.tcf.tcf_experience_contents import (
    14|     AC_PREFIX,
    15|     GVL_PREFIX,
    16|     TCFExperienceContents,
    17|     load_gvl,
    18| )
    19| CMP_ID: int = 407
    20| CMP_VERSION = 1
    21| CONSENT_SCREEN = 1  # TODO On which 'screen' consent was captured; this is a CMP proprietary number encoded into the TC string
    22| FORBIDDEN_LEGITIMATE_INTEREST_PURPOSE_IDS = [1, 3, 4, 5, 6]
    23| gvl: Dict = load_gvl()
    24| def universal_vendor_id_to_gvl_id(universal_vendor_id: str) -> int:
    25|     """Converts a universal gvl vendor id to a vendor id
    26|     For example, converts "gvl.42" to integer 42.
    27|     Throws a ValueError if the id cannot be converted to an integer or if this is an AC Vendor ID
    28|     We store vendor ids as a universal vendor id internally, but need to strip this off when building TC strings.
    29|     """
    30|     if universal_vendor_id.startswith(AC_PREFIX):
    31|         raise ValueError("Skipping AC Vendor ID")
    32|     return int(universal_vendor_id.lstrip(GVL_PREFIX))
    33| class TCModel(FidesSchema):
    34|     """Base internal TCF schema to store and validate key details from which to later build the TC String
    35|     and AC Strings
    36|     """
    37|     _gvl: Dict = {}
    38|     is_service_specific: bool = Field(
    39|         default=False,
    40|         description="Whether the signals encoded in this TC String were from site-specific storage `true` versus "
    41|         "global consensu.org shared storage `false`. A string intended to be stored in global/shared "
    42|         "scope but the CMP is unable to store due to a user agent not accepting third-party cookies "
    43|         "would be considered site-specific `true`.",
    44|     )
    45|     support_oob: bool = Field(
    46|         default=True,
    47|         description="Whether or not this publisher supports OOB signaling.  On Global TC String OOB Vendors Disclosed "
    48|         "will be included if the publish wishes to not allow these vendors they should set this to false.",
    49|     )
    50|     use_non_standard_texts: bool = Field(
    51|         default=False,
    52|         description="Non-standard stacks means that a CMP is using publisher-customized stack descriptions. Stacks "
    53|         "(in terms of purposes in a stack) are pre-set by the IAB. As are titles. Descriptions are pre-set, "
    54|         "but publishers can customize them. If they do, they need to set this bit to indicate that they've "
    55|         "customized descriptions.",
    56|     )

# --- HUNK 2: Lines 145-189 ---
   145|         description="Each Vendor is keyed by id. Whether their Legitimate Interests Disclosures have been "
   146|         "established is stored as boolean.",
   147|     )
   148|     vendors_disclosed: List = Field(
   149|         default=[],
   150|         description=" The value included for disclosed vendors signals which vendors have been disclosed to the user "
   151|         "in the interface surfaced by the CMP. This section content is required when writing a TC string "
   152|         "to the global (consensu) scope. When a CMP has read from and is updating a TC string from the "
   153|         "global consensu.org storage, the CMP MUST retain the existing disclosure information and only"
   154|         " add information for vendors that it has disclosed that had not been disclosed by other CMPs in "
   155|         "prior interactions with this device/user agent.",
   156|     )
   157|     vendors_allowed: List = Field(
   158|         default=[],
   159|         description="Signals which vendors the publisher permits to use OOB legal bases.",
   160|     )
   161|     publisher_restrictions: List = Field(
   162|         default=[],
   163|     )
   164|     num_pub_restrictions: int = 0  # Hardcoded here for now
   165|     ac_vendor_consents: List[int] = Field(
   166|         default=[],
   167|         description="A list of Google's Additional Consent Vendors for which the customer has opted in. These "
   168|         "are consented Google Ad Tech Providers that are not registered with IAB",
   169|     )
   170|     @validator("publisher_country_code")
   171|     def check_publisher_country_code(cls, publisher_country_code: str) -> str:
   172|         """Validates that a publisher_country_code is an upper-cased two letter string"""
   173|         upper_case_country_code: str = publisher_country_code.upper()
   174|         pattern = r"^[A-Z]{2}$"
   175|         if not re.match(pattern, upper_case_country_code):
   176|             raise ValueError(
   177|                 "publisher_country_code must be a length-2 string of alpha characters"
   178|             )
   179|         return upper_case_country_code
   180|     @validator("consent_language")
   181|     def check_consent_language(cls, consent_language: str) -> str:
   182|         """Forces consent language to be upper cased and no longer than 2 characters"""
   183|         consent_language = consent_language.upper()[:2]
   184|         if len(consent_language) < 2:
   185|             raise ValueError("Consent language is less than two characters")
   186|         return consent_language
   187|     @validator("purpose_legitimate_interests")
   188|     def filter_purpose_legitimate_interests(
   189|         cls, purpose_legitimate_interests: List[int]

# --- HUNK 3: Lines 306-365 ---
   306|             if vendor_id in all_vendor_ids:
   307|                 vendors_disclosed.add(vendor_id)
   308|     return sorted(list(vendors_disclosed))
   309| def _get_epoch_time() -> int:
   310|     """Calculate the epoch time to be used for both created and updated_at
   311|     Matches this: Math.round(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate())/100)
   312|     Had to add an extra "0" to get it to match.
   313|     """
   314|     return int(datetime.utcnow().date().strftime("%s") + "0")
   315| def transform_user_preference_to_boolean(preference: UserConsentPreference) -> bool:
   316|     """Convert opt_in/acknowledge preferences to True and opt_out/other preferences to False"""
   317|     return preference in [
   318|         UserConsentPreference.opt_in,
   319|         UserConsentPreference.acknowledge,
   320|     ]
   321| def convert_tcf_contents_to_tc_model(
   322|     tcf_contents: TCFExperienceContents, preference: Optional[UserConsentPreference]
   323| ) -> TCModel:
   324|     """
   325|     Helper for building a TCModel from TCFExperienceContents that contains the prerequisite information to build
   326|     an accept-all or reject-all fides string, with TC and AC sections, depending on the supplied preference.
   327|     """
   328|     if not preference:
   329|         raise Exception(
   330|             "Overall preference must be specified. Only accept or reject-all strings are currently supported."
   331|         )
   332|     consented: bool = transform_user_preference_to_boolean(preference)
   333|     (
   334|         vendor_consents,
   335|         vendor_legitimate_interests,
   336|     ) = _build_vendor_consents_and_legitimate_interests(
   337|         tcf_contents.tcf_vendor_consents, tcf_contents.tcf_vendor_legitimate_interests
   338|     )
   339|     purpose_consents: List[int] = [
   340|         purpose.id for purpose in tcf_contents.tcf_purpose_consents
   341|     ]
   342|     purpose_legitimate_interests: List[int] = [
   343|         purpose.id for purpose in tcf_contents.tcf_purpose_legitimate_interests
   344|     ]
   345|     special_feature_opt_ins: List[int] = _build_special_feature_opt_ins(
   346|         tcf_contents.tcf_special_features
   347|     )
   348|     current_time: int = _get_epoch_time()
   349|     tc_model = TCModel(
   350|         created=current_time,
   351|         last_updated=current_time,
   352|         cmp_id=CMP_ID,
   353|         cmp_version=CMP_VERSION,
   354|         consent_screen=CONSENT_SCREEN,
   355|         vendor_list_version=gvl.get("vendorListVersion"),
   356|         policy_version=gvl.get("tcfPolicyVersion"),
   357|         special_feature_optins=special_feature_opt_ins if consented else [],
   358|         purpose_consents=purpose_consents if consented else [],
   359|         purpose_legitimate_interests=purpose_legitimate_interests if consented else [],
   360|         vendor_consents=vendor_consents if consented else [],
   361|         vendor_legitimate_interests=vendor_legitimate_interests if consented else [],
   362|         vendors_disclosed=_build_vendors_disclosed(tcf_contents),
   363|         ac_vendor_consents=build_ac_vendor_consents(tcf_contents, preference),
   364|     )
   365|     return tc_model


# ====================================================================
# FILE: src/fides/api/util/tcf/tc_string.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| import base64
     2| import binascii
     3| from typing import Any, Dict, List, Optional, Type, Union
     4| from iab_tcf import ConsentV2, decode_v2  # type: ignore[import]
     5| from pydantic import Field
     6| from fides.api.common_exceptions import DecodeFidesStringError
     7| from fides.api.models.privacy_notice import UserConsentPreference
     8| from fides.api.schemas.base_class import FidesSchema
     9| from fides.api.schemas.privacy_preference import FidesStringFidesPreferences
    10| from fides.api.schemas.tcf import TCFPurposeSave, TCFSpecialFeatureSave, TCFVendorSave
    11| from fides.api.util.tcf.tc_model import TCModel, convert_tcf_contents_to_tc_model
    12| from fides.api.util.tcf.tcf_experience_contents import GVL_PREFIX, TCFExperienceContents
    13| USE_NON_STANDARD_TEXT_BITS = 1
    14| SPECIAL_FEATURE_BITS = 12
    15| PURPOSE_CONSENTS_BITS = 24
    16| PURPOSE_LEGITIMATE_INTERESTS_BITS = 24
    17| def add_gvl_prefix(vendor_id: str) -> str:
    18|     """Add gvl prefix to create a universal gvl identifier for the given vendor id"""
    19|     return GVL_PREFIX + vendor_id
    20| class TCField(FidesSchema):
    21|     """Schema to represent a field within a TC string segment"""
    22|     name: str = Field(description="Field name")
    23|     bits: int = Field(
    24|         description="The number of bits that should be used to represent this value"
    25|     )
    26|     value_override: Optional[Any] = Field(
    27|         description="The value that should be used instead of the field on the TC model"
    28|     )
    29| def get_bits_for_section(fields: List[TCField], tc_model: TCModel) -> str:
    30|     """Construct a representation of the fields supplied in bits for a given section."""
    31|     def _convert_val_to_bitstring(val: Union[str, list, int], num_bits: int) -> str:
    32|         """Internal helper to take a string, list of integers, or integer, and convert it to a bitstring"""
    33|         bit_components: str = ""
    34|         if isinstance(val, str):
    35|             bit_allocation = int(num_bits / len(val))
    36|             for char in val:
    37|                 converted_num: int = _convert_letter_to_number(char)
    38|                 bit_components += format(converted_num, f"0{bit_allocation}b")
    39|             return bit_components

# --- HUNK 2: Lines 150-209 ---
   150|         Type[TCFPurposeSave], Type[TCFVendorSave], Type[TCFSpecialFeatureSave]
   151|     ],
   152| ) -> List[FidesPreferenceType]:
   153|     """For a field in the TC string, convert to a list of preferences where we opt-in if it is included in the string,
   154|     and opt-out if it is not in the string, but in the datamap"""
   155|     preferences_array: List[FidesPreferenceType] = []
   156|     for identifier in datamap_options:
   157|         preference: bool = tc_string_preferences.get(identifier, False)
   158|         if preference_class == TCFVendorSave:
   159|             vendor_id: str = add_gvl_prefix(str(identifier))
   160|             fides_preference: FidesPreferenceType = preference_class(
   161|                 id=vendor_id, preference=boolean_to_user_consent_preference(preference)
   162|             )
   163|         else:
   164|             fides_preference = preference_class(
   165|                 id=identifier, preference=boolean_to_user_consent_preference(preference)
   166|             )
   167|         preferences_array.append(fides_preference)
   168|     return preferences_array
   169| def decode_tc_string_to_preferences(
   170|     tc_string: Optional[str], tcf_contents: TCFExperienceContents
   171| ) -> FidesStringFidesPreferences:
   172|     """Method to convert a TC String into a TCStringFidesPreferences object, which is a format from which
   173|     preferences can be saved into the Fides database"""
   174|     if not tc_string:
   175|         return FidesStringFidesPreferences()
   176|     try:
   177|         decoded: ConsentV2 = decode_v2(tc_string)
   178|         tc_str_p_c: Dict[int, bool] = decoded.purposes_consent
   179|         tc_str_p_li: Dict[int, bool] = decoded.purposes_legitimate_interests
   180|         tc_str_v_c: Dict[int, bool] = decoded.consented_vendors
   181|         tc_str_v_li: Dict[int, bool] = decoded.interests_vendors
   182|         tc_str_sf: Dict[int, bool] = decoded.special_features_optin
   183|     except (binascii.Error, AttributeError):
   184|         raise DecodeFidesStringError("Invalid base64-encoded TC string")
   185|     all_options_tc_model: TCModel = convert_tcf_contents_to_tc_model(
   186|         tcf_contents, UserConsentPreference.opt_in
   187|     )
   188|     datamap_p_c: List[int] = all_options_tc_model.purpose_consents
   189|     datamap_p_li: List[int] = all_options_tc_model.purpose_legitimate_interests
   190|     datamap_v_c: List[int] = all_options_tc_model.vendor_consents
   191|     datamap_v_li: List[int] = all_options_tc_model.vendor_legitimate_interests
   192|     datamap_sf: List[int] = all_options_tc_model.special_feature_optins
   193|     return FidesStringFidesPreferences(
   194|         purpose_consent_preferences=convert_to_fides_preference(
   195|             datamap_p_c, tc_str_p_c, TCFPurposeSave
   196|         ),
   197|         purpose_legitimate_interests_preferences=convert_to_fides_preference(
   198|             datamap_p_li, tc_str_p_li, TCFPurposeSave
   199|         ),
   200|         vendor_consent_preferences=convert_to_fides_preference(
   201|             datamap_v_c, tc_str_v_c, TCFVendorSave
   202|         ),
   203|         vendor_legitimate_interests_preferences=convert_to_fides_preference(
   204|             datamap_v_li, tc_str_v_li, TCFVendorSave
   205|         ),
   206|         special_feature_preferences=convert_to_fides_preference(
   207|             datamap_sf, tc_str_sf, TCFSpecialFeatureSave
   208|         ),
   209|     )


# ====================================================================
# FILE: src/fides/api/util/tcf/tcf_experience_contents.py
# Total hunks: 9
# ====================================================================
# --- HUNK 1: Lines 1-121 ---
     1| import json
     2| from enum import Enum
     3| from os.path import dirname, join
     4| from typing import Callable, Dict, List, Optional, Set, Tuple, Type, Union
     5| from fideslang.gvl import (
     6|     GVL_FEATURES,
     7|     GVL_SPECIAL_FEATURES,
     8|     MAPPED_PURPOSES,
     9|     MAPPED_SPECIAL_PURPOSES,
    10|     data_use_to_purpose,
    11|     feature_id_to_feature_name,
    12|     feature_name_to_feature,
    13|     purpose_to_data_use,
    14| )
    15| from fideslang.gvl.models import Feature, Purpose
    16| from fideslang.models import LegalBasisForProcessingEnum
    17| from fideslang.validation import FidesKey
    18| from loguru import logger
    19| from sqlalchemy import and_, not_, or_
    20| from sqlalchemy.engine.row import Row  # type:ignore[import]
    21| from sqlalchemy.orm import Query, Session
    22| from sqlalchemy.sql.elements import BinaryExpression, BooleanClauseList
    23| from fides.api.models.sql_models import (  # type:ignore[attr-defined]
    24|     PrivacyDeclaration,
    25|     System,
    26| )
    27| from fides.api.schemas.base_class import FidesSchema
    28| from fides.api.schemas.tcf import (
    29|     EmbeddedPurpose,
    30|     EmbeddedVendor,
    31|     TCFFeatureRecord,
    32|     TCFPurposeConsentRecord,
    33|     TCFPurposeLegitimateInterestsRecord,
    34|     TCFSpecialFeatureRecord,
    35|     TCFSpecialPurposeRecord,
    36|     TCFVendorConsentRecord,
    37|     TCFVendorLegitimateInterestsRecord,
    38|     TCFVendorRelationships,
    39| )
    40| from fides.config import CONFIG
    41| from fides.config.helpers import load_file
    42| _gvl: Optional[Dict] = None
    43| GVL_PATH = join(
    44|     dirname(__file__),
    45|     "../../../data",
    46|     "gvl.json",
    47| )
    48| AC_PREFIX = "gacp."
    49| GVL_PREFIX = "gvl."
    50| PURPOSE_DATA_USES: List[str] = []
    51| for purpose in MAPPED_PURPOSES.values():
    52|     PURPOSE_DATA_USES.extend(purpose.data_uses)
    53| SPECIAL_PURPOSE_DATA_USES: List[str] = []
    54| for special_purpose in MAPPED_SPECIAL_PURPOSES.values():
    55|     SPECIAL_PURPOSE_DATA_USES.extend(special_purpose.data_uses)
    56| ALL_GVL_DATA_USES = list(set(PURPOSE_DATA_USES) | set(SPECIAL_PURPOSE_DATA_USES))
    57| NonVendorSectionType = Union[
    58|     Type[TCFPurposeConsentRecord],
    59|     Type[TCFPurposeLegitimateInterestsRecord],
    60|     Type[TCFSpecialPurposeRecord],
    61|     Type[TCFFeatureRecord],
    62|     Type[TCFSpecialFeatureRecord],
    63| ]
    64| NonVendorRecord = Union[
    65|     TCFPurposeConsentRecord,
    66|     TCFPurposeLegitimateInterestsRecord,
    67|     TCFSpecialPurposeRecord,
    68|     TCFFeatureRecord,
    69|     TCFSpecialFeatureRecord,
    70| ]
    71| VendorSectionType = Union[
    72|     Type[TCFVendorConsentRecord],
    73|     Type[TCFVendorLegitimateInterestsRecord],
    74|     Type[TCFVendorRelationships],
    75| ]
    76| VendorRecord = Union[
    77|     TCFVendorConsentRecord, TCFVendorLegitimateInterestsRecord, TCFVendorRelationships
    78| ]
    79| SystemSubSections = Union[
    80|     List[TCFPurposeConsentRecord],
    81|     List[TCFPurposeLegitimateInterestsRecord],
    82|     List[TCFSpecialPurposeRecord],
    83|     List[TCFFeatureRecord],
    84|     List[TCFSpecialFeatureRecord],
    85| ]
    86| AC_SYSTEM_NO_PRIVACY_DECL_FILTER: BooleanClauseList = and_(
    87|     System.vendor_id.startswith(AC_PREFIX), PrivacyDeclaration.id.is_(None)
    88| )
    89| NOT_AC_SYSTEM_FILTER: BooleanClauseList = or_(
    90|     not_(System.vendor_id.startswith(AC_PREFIX)), System.vendor_id.is_(None)
    91| )
    92| CONSENT_LEGAL_BASIS_FILTER: BinaryExpression = (
    93|     PrivacyDeclaration.legal_basis_for_processing == LegalBasisForProcessingEnum.CONSENT
    94| )
    95| LEGITIMATE_INTEREST_LEGAL_BASIS_FILTER: BinaryExpression = (
    96|     PrivacyDeclaration.legal_basis_for_processing
    97|     == LegalBasisForProcessingEnum.LEGITIMATE_INTEREST
    98| )
    99| GVL_DATA_USE_FILTER: BinaryExpression = PrivacyDeclaration.data_use.in_(
   100|     ALL_GVL_DATA_USES
   101| )
   102| class ConsentRecordType(Enum):
   103|     """*ALL* of the relevant consent items that can be served or have preferences saved against.
   104|     Includes two privacy notices fields, and then everything in TCFComponentType
   105|     """
   106|     privacy_notice_id = "privacy_notice_id"
   107|     privacy_notice_history_id = "privacy_notice_history_id"
   108|     purpose_consent = "purpose_consent"
   109|     purpose_legitimate_interests = "purpose_legitimate_interests"
   110|     special_purpose = "special_purpose"
   111|     vendor_consent = "vendor_consent"
   112|     vendor_legitimate_interests = "vendor_legitimate_interests"
   113|     system_consent = "system_consent"
   114|     system_legitimate_interests = "system_legitimate_interests"
   115|     feature = "feature"
   116|     special_feature = "special_feature"
   117| TCF_SECTION_MAPPING: Dict[str, Optional[ConsentRecordType]] = {
   118|     "tcf_purpose_consents": ConsentRecordType.purpose_consent,
   119|     "tcf_purpose_legitimate_interests": ConsentRecordType.purpose_legitimate_interests,
   120|     "tcf_special_purposes": ConsentRecordType.special_purpose,
   121|     "tcf_features": ConsentRecordType.feature,

# --- HUNK 2: Lines 158-310 ---
   158|     tcf_system_legitimate_interests: List[TCFVendorLegitimateInterestsRecord] = []
   159|     tcf_system_relationships: List[TCFVendorRelationships] = []
   160| def get_matching_privacy_declarations(db: Session) -> Query:
   161|     """Returns flattened system/privacy declaration records where we have a matching gvl data use AND the
   162|     legal basis for processing is "Consent" or "Legitimate interests"
   163|     Only systems that meet this criteria should show up in the TCF overlay.
   164|     """
   165|     matching_privacy_declarations: Query = (
   166|         db.query(
   167|             System.id.label("system_id"),
   168|             System.fides_key.label("system_fides_key"),
   169|             System.name.label("system_name"),
   170|             System.description.label("system_description"),
   171|             System.cookie_max_age_seconds.label("system_cookie_max_age_seconds"),
   172|             System.uses_cookies.label("system_uses_cookies"),
   173|             System.cookie_refresh.label("system_cookie_refresh"),
   174|             System.uses_non_cookie_access.label("system_uses_non_cookie_access"),
   175|             System.legitimate_interest_disclosure_url.label(
   176|                 "system_legitimate_interest_disclosure_url"
   177|             ),
   178|             System.privacy_policy.label("system_privacy_policy"),
   179|             System.vendor_id,
   180|             PrivacyDeclaration.data_use,
   181|             PrivacyDeclaration.legal_basis_for_processing,
   182|             PrivacyDeclaration.features,
   183|             PrivacyDeclaration.retention_period,
   184|         )
   185|         .outerjoin(PrivacyDeclaration, System.id == PrivacyDeclaration.system_id)
   186|         .filter(
   187|             or_(
   188|                 and_(
   189|                     GVL_DATA_USE_FILTER,
   190|                     PrivacyDeclaration.legal_basis_for_processing
   191|                     == LegalBasisForProcessingEnum.CONSENT,
   192|                 ),
   193|                 and_(
   194|                     GVL_DATA_USE_FILTER,
   195|                     PrivacyDeclaration.legal_basis_for_processing
   196|                     == LegalBasisForProcessingEnum.LEGITIMATE_INTEREST,
   197|                     NOT_AC_SYSTEM_FILTER,
   198|                 ),
   199|                 AC_SYSTEM_NO_PRIVACY_DECL_FILTER,
   200|             )
   201|         )
   202|         .order_by(
   203|             PrivacyDeclaration.created_at.desc()
   204|         )  # Order to get repeatable results when collapsing information
   205|     )
   206|     if not CONFIG.consent.ac_enabled:
   207|         matching_privacy_declarations = matching_privacy_declarations.filter(
   208|             NOT_AC_SYSTEM_FILTER
   209|         )
   210|     return matching_privacy_declarations
   211| def get_system_identifiers(
   212|     privacy_declaration_row: Row,
   213| ) -> Tuple[Optional[str], str]:
   214|     """Return the vendor id and overall system identifier (which is either the vendor OR system id)
   215|     If a vendor exists, that's how we'll identify the system, and we'll consolidate information
   216|     from multiple matching systems under that single vendor id.  If we don't have a vendor id, we don't know the
   217|     "type" of system, so we'll surface information under that system id itself.
   218|     """
   219|     system_id: str = privacy_declaration_row["system_id"]
   220|     vendor_id: Optional[str] = privacy_declaration_row["vendor_id"]
   221|     system_identifier: str = vendor_id if vendor_id else system_id
   222|     return vendor_id, system_identifier
   223| def get_matching_data_uses_or_features(
   224|     record: Row, relevant_uses_or_features: List[str], is_purpose_type: bool
   225| ) -> Set[str]:
   226|     """
   227|     Determine the set of relevant uses or features depending on whether we're building a
   228|     purpose or feature section
   229|     """
   230|     if is_purpose_type:
   231|         return (
   232|             {record.data_use} if record.data_use in relevant_uses_or_features else set()
   233|         )
   234|     unique_features: Set[str] = set()
   235|     for feature_name in record.features or []:
   236|         if feature_name in relevant_uses_or_features:
   237|             unique_features.add(feature_name)
   238|     return unique_features
   239| def _add_top_level_record_to_purpose_or_feature_section(
   240|     tcf_component_type: NonVendorSectionType,
   241|     non_vendor_record_map: Dict[int, NonVendorRecord],
   242|     is_purpose_type: bool,
   243|     use_or_feature: str,
   244| ) -> Optional[NonVendorRecord]:
   245|     """
   246|     Create a purpose or feature record and add to the top-level sections.
   247|     "non_vendor_record_map" is updated here, in-place.
   248|     """
   249|     get_gvl_record: Callable = (
   250|         data_use_to_purpose if is_purpose_type else feature_name_to_feature
   251|     )
   252|     fideslang_gvl_record: Union[Purpose, Feature] = get_gvl_record(use_or_feature)
   253|     if not fideslang_gvl_record:
   254|         return None
   255|     top_level_tcf_record: NonVendorRecord = tcf_component_type(
   256|         **fideslang_gvl_record.dict()
   257|     )
   258|     if top_level_tcf_record.id not in non_vendor_record_map:
   259|         non_vendor_record_map[top_level_tcf_record.id] = top_level_tcf_record
   260|     return non_vendor_record_map[top_level_tcf_record.id]
   261| def _embed_purpose_or_feature_under_system(
   262|     embedded_tcf_record: NonVendorRecord,
   263|     system_section: SystemSubSections,
   264|     retention_period: Optional[str],
   265|     is_purpose_section: bool,
   266| ) -> None:
   267|     """
   268|     Embed a second-level TCF purpose/feature under the systems section.
   269|     The systems section is updated in-place.
   270|     """
   271|     embedded_non_vendor_record: Optional[NonVendorRecord] = next(
   272|         (
   273|             tcf_sub_record
   274|             for tcf_sub_record in system_section
   275|             if tcf_sub_record.id == embedded_tcf_record.id
   276|         ),
   277|         None,
   278|     )
   279|     if embedded_non_vendor_record:
   280|         return
   281|     if is_purpose_section:
   282|         system_section.append(
   283|             EmbeddedPurpose(  # type: ignore[arg-type]
   284|                 id=embedded_tcf_record.id,
   285|                 name=embedded_tcf_record.name,
   286|                 retention_period=retention_period,
   287|             )
   288|         )
   289|     else:
   290|         system_section.append(embedded_tcf_record)
   291| def _embed_system_under_purpose_or_feature(
   292|     top_level_tcf_record: NonVendorRecord,
   293|     non_vendor_record_map: Dict[int, NonVendorRecord],
   294|     privacy_declaration_row: Row,
   295| ) -> None:
   296|     """
   297|     Embed system/vendor information beneath the corresponding top-level purpose or feature section.
   298|     """
   299|     vendor_id, system_identifier = get_system_identifiers(privacy_declaration_row)
   300|     embedded_system_section: List[EmbeddedVendor] = (
   301|         non_vendor_record_map[top_level_tcf_record.id].vendors
   302|         if vendor_id
   303|         else non_vendor_record_map[top_level_tcf_record.id].systems
   304|     )
   305|     if system_identifier not in [
   306|         embedded_system_record.id for embedded_system_record in embedded_system_section
   307|     ]:
   308|         embedded_system_section.extend(
   309|             [
   310|                 EmbeddedVendor(

# --- HUNK 3: Lines 355-512 ---
   355|             )
   356|             if not top_level_tcf_record:
   357|                 continue
   358|             vendor_id, system_identifier = get_system_identifiers(
   359|                 privacy_declaration_row
   360|             )
   361|             if system_identifier not in vendor_map:
   362|                 vendor_map[system_identifier] = tcf_vendor_component_type(
   363|                     id=system_identifier,  # Identify system by vendor id if it exists, otherwise use system id.
   364|                     name=privacy_declaration_row.system_name,
   365|                     description=privacy_declaration_row.system_description,
   366|                     has_vendor_id=bool(
   367|                         vendor_id
   368|                     ),  # Has_vendor_id will let us separate data between systems and vendors
   369|                 )
   370|             _embed_purpose_or_feature_under_system(
   371|                 embedded_tcf_record=top_level_tcf_record.copy(),
   372|                 system_section=getattr(
   373|                     vendor_map[system_identifier], vendor_subsection_name
   374|                 ),
   375|                 retention_period=privacy_declaration_row.retention_period,
   376|                 is_purpose_section=is_purpose_section,
   377|             )
   378|             _embed_system_under_purpose_or_feature(
   379|                 top_level_tcf_record=top_level_tcf_record,
   380|                 non_vendor_record_map=non_vendor_record_map,
   381|                 privacy_declaration_row=privacy_declaration_row,
   382|             )
   383|         add_ac_vendor_to_vendor_consent_map(
   384|             vendor_map=vendor_map,
   385|             tcf_vendor_component_type=tcf_vendor_component_type,
   386|             privacy_declaration_row=privacy_declaration_row,
   387|         )
   388|     return non_vendor_record_map, vendor_map
   389| def add_ac_vendor_to_vendor_consent_map(
   390|     vendor_map: Dict[str, VendorRecord],
   391|     tcf_vendor_component_type: VendorSectionType,
   392|     privacy_declaration_row: Row,
   393| ) -> None:
   394|     """
   395|     Add systems with ac.*-prefixed vendor records to the Vendor Consent section if applicable.
   396|     FE shows Consent toggle only for AC vendors, and they are not required to have Privacy Declarations
   397|     """
   398|     vendor_id, _ = get_system_identifiers(privacy_declaration_row)
   399|     if not (vendor_id and vendor_id.startswith(AC_PREFIX)):
   400|         return
   401|     if not tcf_vendor_component_type == TCFVendorConsentRecord:
   402|         return
   403|     if vendor_id in vendor_map:
   404|         return
   405|     vendor_map[vendor_id] = TCFVendorConsentRecord(
   406|         id=vendor_id,
   407|         name=privacy_declaration_row.system_name,
   408|         description=privacy_declaration_row.system_description,
   409|         has_vendor_id=True,
   410|     )
   411| def populate_vendor_relationships_basic_attributes(
   412|     vendor_map: Dict[str, TCFVendorRelationships],
   413|     matching_privacy_declarations: Query,
   414| ) -> Dict[str, TCFVendorRelationships]:
   415|     """Populates TCFVendorRelationships records for all vendors that we're displaying in the overlay.
   416|     Ensures that these TCFVendorRelationships records have the "basic" TCF attributes populated.
   417|     """
   418|     for privacy_declaration_row in matching_privacy_declarations:
   419|         vendor_id, system_identifier = get_system_identifiers(privacy_declaration_row)
   420|         vendor_relationship_record = vendor_map.get(system_identifier)
   421|         if not vendor_relationship_record:
   422|             vendor_relationship_record = TCFVendorRelationships(
   423|                 id=system_identifier,  # Identify system by vendor id if it exists, otherwise use system id.
   424|                 name=privacy_declaration_row.system_name,
   425|                 description=privacy_declaration_row.system_description,
   426|                 has_vendor_id=bool(
   427|                     vendor_id  # This will let us separate data between systems and vendors later
   428|                 ),
   429|             )
   430|             vendor_map[system_identifier] = vendor_relationship_record
   431|         vendor_relationship_record.cookie_max_age_seconds = (
   432|             privacy_declaration_row.system_cookie_max_age_seconds
   433|         )
   434|         vendor_relationship_record.uses_cookies = (
   435|             privacy_declaration_row.system_uses_cookies
   436|         )
   437|         vendor_relationship_record.cookie_refresh = (
   438|             privacy_declaration_row.system_cookie_refresh
   439|         )
   440|         vendor_relationship_record.uses_non_cookie_access = (
   441|             privacy_declaration_row.system_uses_non_cookie_access
   442|         )
   443|         vendor_relationship_record.legitimate_interest_disclosure_url = (
   444|             privacy_declaration_row.system_legitimate_interest_disclosure_url
   445|         )
   446|         vendor_relationship_record.privacy_policy_url = (
   447|             privacy_declaration_row.system_privacy_policy
   448|         )
   449|     return vendor_map
   450| def get_tcf_contents(
   451|     db: Session,
   452| ) -> TCFExperienceContents:
   453|     """
   454|     Returns the base contents of the TCF overlay.
   455|     Queries for systems/privacy declarations that have a relevant GVL data use and a legal basis of Consent or Legitimate interests,
   456|     and builds the TCF Overlay from these systems and privacy declarations.
   457|     TCF Overlay has Consent Purpose, Legitimate Interest Purpose, Special Purpose, Feature, and Special Feature Sections,
   458|     that have relevant systems and vendors embedded underneath.
   459|     We also have Consent Vendor, Legitimate Interests Vendor, and Vendor Relationships sections (same for systems),
   460|     which are almost a reverse representation, and have their own purposes and features embedded underneath.
   461|     """
   462|     vendor_consent_map: Dict[str, TCFVendorConsentRecord] = {}
   463|     vendor_legitimate_interests_map: Dict[str, TCFVendorLegitimateInterestsRecord] = {}
   464|     vendor_relationships_map: Dict[str, TCFVendorRelationships] = {}
   465|     matching_privacy_declarations: Query = get_matching_privacy_declarations(db)
   466|     (
   467|         purpose_consent_map,
   468|         updated_vendor_consent_map,
   469|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   470|         PURPOSE_DATA_USES,
   471|         tcf_component_type=TCFPurposeConsentRecord,
   472|         tcf_vendor_component_type=TCFVendorConsentRecord,
   473|         vendor_subsection_name="purpose_consents",
   474|         vendor_map=vendor_consent_map,
   475|         matching_privacy_declaration_query=matching_privacy_declarations.filter(
   476|             or_(
   477|                 CONSENT_LEGAL_BASIS_FILTER,
   478|                 AC_SYSTEM_NO_PRIVACY_DECL_FILTER,
   479|             )
   480|         ),
   481|     )
   482|     (
   483|         purpose_legitimate_interests_map,
   484|         updated_vendor_legitimate_interests_map,
   485|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   486|         PURPOSE_DATA_USES,
   487|         tcf_component_type=TCFPurposeLegitimateInterestsRecord,
   488|         tcf_vendor_component_type=TCFVendorLegitimateInterestsRecord,
   489|         vendor_subsection_name="purpose_legitimate_interests",
   490|         vendor_map=vendor_legitimate_interests_map,
   491|         matching_privacy_declaration_query=matching_privacy_declarations.filter(
   492|             LEGITIMATE_INTEREST_LEGAL_BASIS_FILTER
   493|         ),
   494|     )
   495|     (
   496|         special_purpose_map,
   497|         updated_vendor_relationships_map,
   498|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   499|         SPECIAL_PURPOSE_DATA_USES,
   500|         tcf_component_type=TCFSpecialPurposeRecord,
   501|         tcf_vendor_component_type=TCFVendorRelationships,
   502|         vendor_subsection_name="special_purposes",
   503|         vendor_map=vendor_relationships_map,
   504|         matching_privacy_declaration_query=matching_privacy_declarations,
   505|     )
   506|     (
   507|         feature_map,
   508|         updated_vendor_relationships_map,
   509|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   510|         [feature.name for feature in GVL_FEATURES.values()],
   511|         tcf_component_type=TCFFeatureRecord,
   512|         tcf_vendor_component_type=TCFVendorRelationships,

# --- HUNK 4: Lines 621-710 ---
   621|     db: Session,
   622|     tcf_field: Optional[str],
   623|     tcf_value: Union[Optional[str], Optional[int]],
   624| ) -> List[FidesKey]:
   625|     """Return a list of the system fides keys that match the given TCF attribute,
   626|     provided the system is relevant for TCF.
   627|     Used for consent reporting, to take a snapshot of the systems that are relevant at that point in time
   628|     """
   629|     starting_privacy_declarations: Query = get_matching_privacy_declarations(db)
   630|     purpose_data_uses: List[str] = []
   631|     if tcf_field in [
   632|         TCFComponentType.purpose_consent.value,
   633|         TCFComponentType.purpose_legitimate_interests.value,
   634|         TCFComponentType.special_purpose.value,
   635|     ]:
   636|         purpose_data_uses = purpose_to_data_use(
   637|             tcf_value, special_purpose="special" in tcf_field
   638|         )
   639|     if tcf_field == TCFComponentType.purpose_consent.value:
   640|         return systems_that_match_tcf_data_uses(
   641|             starting_privacy_declarations.filter(CONSENT_LEGAL_BASIS_FILTER),
   642|             purpose_data_uses,
   643|         )
   644|     if tcf_field == TCFComponentType.purpose_legitimate_interests.value:
   645|         return systems_that_match_tcf_data_uses(
   646|             starting_privacy_declarations.filter(
   647|                 LEGITIMATE_INTEREST_LEGAL_BASIS_FILTER
   648|             ),
   649|             purpose_data_uses,
   650|         )
   651|     if tcf_field == TCFComponentType.special_purpose.value:
   652|         return systems_that_match_tcf_data_uses(
   653|             starting_privacy_declarations, purpose_data_uses
   654|         )
   655|     if tcf_field in [
   656|         TCFComponentType.feature.value,
   657|         TCFComponentType.special_feature.value,
   658|     ]:
   659|         return systems_that_match_tcf_feature(
   660|             starting_privacy_declarations,
   661|             feature_id_to_feature_name(
   662|                 feature_id=tcf_value, special_feature="special" in tcf_field  # type: ignore[arg-type]
   663|             ),
   664|         )
   665|     if tcf_field == TCFComponentType.vendor_consent.value:
   666|         return systems_that_match_vendor_string(
   667|             starting_privacy_declarations.filter(
   668|                 or_(
   669|                     CONSENT_LEGAL_BASIS_FILTER,
   670|                     AC_SYSTEM_NO_PRIVACY_DECL_FILTER,
   671|                 )
   672|             ),
   673|             tcf_value,  # type: ignore[arg-type]
   674|         )
   675|     if tcf_field == TCFComponentType.vendor_legitimate_interests.value:
   676|         return systems_that_match_vendor_string(
   677|             starting_privacy_declarations.filter(
   678|                 LEGITIMATE_INTEREST_LEGAL_BASIS_FILTER
   679|             ),
   680|             tcf_value,  # type: ignore[arg-type]
   681|         )
   682|     if tcf_field == TCFComponentType.system_consent.value:
   683|         return systems_that_match_system_id(
   684|             starting_privacy_declarations.filter(CONSENT_LEGAL_BASIS_FILTER),
   685|             tcf_value
   686|         )
   687|     if tcf_field == TCFComponentType.system_legitimate_interests.value:
   688|         return systems_that_match_system_id(
   689|             starting_privacy_declarations.filter(
   690|                 LEGITIMATE_INTEREST_LEGAL_BASIS_FILTER
   691|             ),
   692|             tcf_value,  # type: ignore[arg-type]
   693|         )
   694|     return []
   695| def systems_that_match_tcf_feature(
   696|     matching_privacy_declarations: Query, feature: Optional[str]
   697| ) -> List[FidesKey]:
   698|     """Check which systems have these data uses directly and are also relevant for TCF.
   699|     This is used for determining relevant systems for TCF features and special features. Unlike
   700|     determining relevant systems for Privacy Notices where we use a hierarchy-type matching,
   701|     for TCF, we're looking for an exact match on feature."""
   702|     if not feature:
   703|         return []
   704|     return list(
   705|         {
   706|             privacy_declaration_record.system_fides_key
   707|             for privacy_declaration_record in matching_privacy_declarations.filter(
   708|                 PrivacyDeclaration.features.any(feature)
   709|             )
   710|         }

