# ====================================================================
# FILE: clients/admin-ui/src/features/system/SystemInformationForm.tsx
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 392-432 ---
   392|               animateOpacity
   393|             >
   394|               <SystemFormInputGroup heading="Cookie properties">
   395|                 <DictSuggestionSwitch
   396|                   name="uses_cookies"
   397|                   label="This system uses cookies"
   398|                   tooltip="Does this system use cookies?"
   399|                 />
   400|                 <DictSuggestionSwitch
   401|                   name="cookie_refresh"
   402|                   label="This system refreshes cookies"
   403|                   tooltip="Does this system automatically refresh cookies?"
   404|                 />
   405|                 <DictSuggestionSwitch
   406|                   name="uses_non_cookie_access"
   407|                   label="This system uses non-cookie trackers"
   408|                   tooltip="Does this system use other types of trackers?"
   409|                 />
   410|                 <DictSuggestionNumberInput
   411|                   name="cookie_max_age_seconds"
   412|                   label="Maximum duration"
   413|                   tooltip="What is the maximum amount of time a cookie will live?"
   414|                 />
   415|               </SystemFormInputGroup>
   416|               <SystemFormInputGroup heading="Administrative properties">
   417|                 <CustomTextInput
   418|                   label="Data stewards"
   419|                   name="data_stewards"
   420|                   tooltip="Who are the stewards assigned to the system?"
   421|                   variant="stacked"
   422|                   disabled
   423|                 />
   424|                 <DictSuggestionTextInput
   425|                   id="privacy_policy"
   426|                   name="privacy_policy"
   427|                   label="Privacy policy URL"
   428|                   tooltip="Where can the privacy policy be located?"
   429|                 />
   430|                 <DictSuggestionTextInput
   431|                   id="legal_name"
   432|                   name="legal_name"


# ====================================================================
# FILE: clients/admin-ui/src/types/api/index.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 104-143 ---
   104| export type { DatasetTraversalDetails } from "./models/DatasetTraversalDetails";
   105| export type { DataSubject } from "./models/DataSubject";
   106| export type { DataSubjectRights } from "./models/DataSubjectRights";
   107| export { DataSubjectRightsEnum } from "./models/DataSubjectRightsEnum";
   108| export type { DataUpload } from "./models/DataUpload";
   109| export type { DataUse } from "./models/DataUse";
   110| export { DBActions } from "./models/DBActions";
   111| export type { DenyPrivacyRequests } from "./models/DenyPrivacyRequests";
   112| export type { DictionaryStatus } from "./models/DictionaryStatus";
   113| export { DrpAction } from "./models/DrpAction";
   114| export type { DrpDataRightsResponse } from "./models/DrpDataRightsResponse";
   115| export type { DrpMeta } from "./models/DrpMeta";
   116| export type { DrpPrivacyRequestCreate } from "./models/DrpPrivacyRequestCreate";
   117| export { DrpRegime } from "./models/DrpRegime";
   118| export type { DrpRevokeRequest } from "./models/DrpRevokeRequest";
   119| export type { DryRunDatasetResponse } from "./models/DryRunDatasetResponse";
   120| export type { DynamoDBDocsSchema } from "./models/DynamoDBDocsSchema";
   121| export { EdgeDirection } from "./models/EdgeDirection";
   122| export type { EmailDocsSchema } from "./models/EmailDocsSchema";
   123| export type { EmbeddedLineItem } from "./models/EmbeddedLineItem";
   124| export type { EmbeddedVendor } from "./models/EmbeddedVendor";
   125| export type { Endpoint } from "./models/Endpoint";
   126| export { EnforcementLevel } from "./models/EnforcementLevel";
   127| export type { Evaluation } from "./models/Evaluation";
   128| export type { ExecutionAndAuditLogResponse } from "./models/ExecutionAndAuditLogResponse";
   129| export type { ExecutionApplicationConfig } from "./models/ExecutionApplicationConfig";
   130| export type { ExecutionLogDetailResponse } from "./models/ExecutionLogDetailResponse";
   131| export { ExecutionLogStatus } from "./models/ExecutionLogStatus";
   132| export type { ExperienceConfigCreate } from "./models/ExperienceConfigCreate";
   133| export type { ExperienceConfigCreateOrUpdateResponse } from "./models/ExperienceConfigCreateOrUpdateResponse";
   134| export type { ExperienceConfigResponse } from "./models/ExperienceConfigResponse";
   135| export type { ExperienceConfigUpdate } from "./models/ExperienceConfigUpdate";
   136| export type { ExperienceMeta } from "./models/ExperienceMeta";
   137| export type { ExtendedIdentityTypes } from "./models/ExtendedIdentityTypes";
   138| export type { ExternalDatasetReference } from "./models/ExternalDatasetReference";
   139| export type { fides__api__schemas__connection_configuration__connection_secrets_bigquery__KeyfileCreds } from "./models/fides__api__schemas__connection_configuration__connection_secrets_bigquery__KeyfileCreds";
   140| export type { fides__api__schemas__policy__Policy } from "./models/fides__api__schemas__policy__Policy";
   141| export type { fides__connectors__models__KeyfileCreds } from "./models/fides__connectors__models__KeyfileCreds";
   142| export type { FidesCloudStatus } from "./models/FidesCloudStatus";
   143| export type { FidesDatasetReference } from "./models/FidesDatasetReference";


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/PrivacyPreferencesRequest.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 9-41 ---
     9| import type { TCFSpecialFeatureSave } from "./TCFSpecialFeatureSave";
    10| import type { TCFSpecialPurposeSave } from "./TCFSpecialPurposeSave";
    11| import type { TCFVendorSave } from "./TCFVendorSave";
    12| /**
    13|  * Request body for creating PrivacyPreferences.
    14|  *
    15|  *
    16|  * "preferences" key reserved for saving preferences against a privacy notice.
    17|  *
    18|  * New *_preferences fields are used for saving preferences against various tcf components.
    19|  */
    20| export type PrivacyPreferencesRequest = {
    21|   purpose_consent_preferences?: Array<TCFPurposeSave>;
    22|   purpose_legitimate_interests_preferences?: Array<TCFPurposeSave>;
    23|   vendor_consent_preferences?: Array<TCFVendorSave>;
    24|   vendor_legitimate_interests_preferences?: Array<TCFVendorSave>;
    25|   special_feature_preferences?: Array<TCFSpecialFeatureSave>;
    26|   browser_identity: Identity;
    27|   code?: string;
    28|   /**
    29|    * If supplied, TC string is decoded and preferences saved for purpose_consent, purpose_legitimate_interests, vendor_consent, vendor_legitimate_interests, and special_features
    30|    */
    31|   tc_string?: string;
    32|   preferences?: Array<ConsentOptionCreate>;
    33|   special_purpose_preferences?: Array<TCFSpecialPurposeSave>;
    34|   feature_preferences?: Array<TCFFeatureSave>;
    35|   system_consent_preferences?: Array<TCFVendorSave>;
    36|   system_legitimate_interests_preferences?: Array<TCFVendorSave>;
    37|   policy_key?: string;
    38|   privacy_experience_id?: string;
    39|   user_geography?: string;
    40|   method?: ConsentMethod;
    41| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/SavePrivacyPreferencesResponse.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { CurrentPrivacyPreferenceSchema } from "./CurrentPrivacyPreferenceSchema";
     5| import type { TCMobileData } from "./TCMobileData";
     6| /**
     7|  * Response schema when saving privacy preferences
     8|  */
     9| export type SavePrivacyPreferencesResponse = {
    10|   preferences?: Array<CurrentPrivacyPreferenceSchema>;
    11|   purpose_consent_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    12|   purpose_legitimate_interests_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    13|   special_purpose_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    14|   vendor_consent_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    15|   vendor_legitimate_interests_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    16|   feature_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    17|   special_feature_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    18|   system_consent_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    19|   system_legitimate_interests_preferences?: Array<CurrentPrivacyPreferenceSchema>;
    20|   tc_mobile_data?: TCMobileData;
    21| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCDecode.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-10 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { TCMobileData } from "./TCMobileData";
     5| /**
     6|  * Decode response schema for returning TC Mobile Data
     7|  */
     8| export type TCDecode = {
     9|   tc_mobile_data: TCMobileData;
    10| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCFVendorConsentRecord.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { EmbeddedLineItem } from "./EmbeddedLineItem";
     5| import type { UserConsentPreference } from "./UserConsentPreference";
     6| /**
     7|  * Schema for a TCF Vendor with Consent legal basis
     8|  */
     9| export type TCFVendorConsentRecord = {
    10|   id: string;
    11|   has_vendor_id?: boolean;
    12|   name?: string;
    13|   description?: string;
    14|   cookie_max_age_seconds?: number;
    15|   uses_cookies?: boolean;
    16|   cookie_refresh?: boolean;
    17|   uses_non_cookie_access?: boolean;
    18|   legitimate_interest_disclosure_url?: string;
    19|   default_preference?: UserConsentPreference;
    20|   current_preference?: UserConsentPreference;
    21|   outdated_preference?: UserConsentPreference;
    22|   current_served?: boolean;
    23|   outdated_served?: boolean;
    24|   purpose_consents?: Array<EmbeddedLineItem>;
    25| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCFVendorLegitimateInterestsRecord.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-25 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { EmbeddedLineItem } from "./EmbeddedLineItem";
     5| import type { UserConsentPreference } from "./UserConsentPreference";
     6| /**
     7|  * Schema for a TCF Vendor with Legitimate interests legal basis
     8|  */
     9| export type TCFVendorLegitimateInterestsRecord = {
    10|   id: string;
    11|   has_vendor_id?: boolean;
    12|   name?: string;
    13|   description?: string;
    14|   cookie_max_age_seconds?: number;
    15|   uses_cookies?: boolean;
    16|   cookie_refresh?: boolean;
    17|   uses_non_cookie_access?: boolean;
    18|   legitimate_interest_disclosure_url?: string;
    19|   default_preference?: UserConsentPreference;
    20|   current_preference?: UserConsentPreference;
    21|   outdated_preference?: UserConsentPreference;
    22|   current_served?: boolean;
    23|   outdated_served?: boolean;
    24|   purpose_legitimate_interests?: Array<EmbeddedLineItem>;
    25| };


# ====================================================================
# FILE: clients/admin-ui/src/types/api/models/TCFVendorRelationships.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-21 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { EmbeddedLineItem } from "./EmbeddedLineItem";
     5| /**
     6|  * Collects the other relationships for a given vendor - no preferences are saved here
     7|  */
     8| export type TCFVendorRelationships = {
     9|   id: string;
    10|   has_vendor_id?: boolean;
    11|   name?: string;
    12|   description?: string;
    13|   cookie_max_age_seconds?: number;
    14|   uses_cookies?: boolean;
    15|   cookie_refresh?: boolean;
    16|   uses_non_cookie_access?: boolean;
    17|   legitimate_interest_disclosure_url?: string;
    18|   special_purposes?: Array<EmbeddedLineItem>;
    19|   features?: Array<EmbeddedLineItem>;
    20|   special_features?: Array<EmbeddedLineItem>;
    21| };


# ====================================================================
# FILE: clients/admin-ui/src/types/dictionary-api/models/Cookie.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-26 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { CookieType } from "./CookieType";
     5| /**
     6|  * The Cookies resource model
     7|  */
     8| export type Cookie = {
     9|   name: string;
    10|   path?: string;
    11|   domain?: string;
    12|   type: CookieType;
    13|   /**
    14|    * Whether the cookie is refreshed after being initially set.
    15|    */
    16|   cookie_refresh?: boolean;
    17|   /**
    18|    * The maximum storage duration, in seconds, for this cookie.
    19|    */
    20|   max_age_seconds?: number;
    21|   /**
    22|    * Whether the associated Vendor record uses non-cookie methods of storage or accessing information stored on a user's device.
    23|    */
    24|   uses_non_cookie_access?: boolean;
    25|   /**
    26|    * The record's GVL purposes

# --- HUNK 2: Lines 33-53 ---
    33|   /**
    34|    * The record's GVL features
    35|    */
    36|   features?: Array<number>;
    37|   /**
    38|    * The record's GVL special features
    39|    */
    40|   special_features?: Array<number>;
    41|   /**
    42|    * The ID of the vendor that the record belongs to
    43|    */
    44|   vendor_id: string;
    45|   /**
    46|    * The name of the vendor that the record belongs to
    47|    */
    48|   vendor_name: string;
    49|   /**
    50|    * The version of GVL from which the record is derived
    51|    */
    52|   gvl_version?: string;
    53| };


# ====================================================================
# FILE: clients/admin-ui/src/types/dictionary-api/models/DataUseDeclaration.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { Cookie } from "./Cookie";
     5| import type { LegalBasisForProcessingEnum } from "./LegalBasisForProcessingEnum";
     6| import type { SpecialCategoryLegalBasisEnum } from "./SpecialCategoryLegalBasisEnum";
     7| /**
     8|  * The PrivacyDeclaration resource model.
     9|  *
    10|  * States a function of a system, and describes how it relates
    11|  * to the privacy data types.
    12|  */
    13| export type DataUseDeclaration = {
    14|   /**
    15|    * The name of the privacy declaration on the system.
    16|    */
    17|   name?: string;
    18|   /**
    19|    * An array of data categories describing a system in a privacy declaration.
    20|    */
    21|   data_categories: Array<string>;
    22|   /**
    23|    * The Data Use describing a system in a privacy declaration.
    24|    */
    25|   data_use: string;
    26|   /**
    27|    * Deprecated. The fides key of the data qualifier describing a system in a privacy declaration.
    28|    */
    29|   data_qualifier?: string;
    30|   /**
    31|    * An array of data subjects describing a system in a privacy declaration.


# ====================================================================
# FILE: clients/admin-ui/src/types/dictionary-api/models/Vendor.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-35 ---
     1| /* istanbul ignore file */
     2| /* tslint:disable */
     3| /* eslint-disable */
     4| import type { ContactDetails } from "./ContactDetails";
     5| import type { Cookie } from "./Cookie";
     6| import type { DataFlow } from "./DataFlow";
     7| import type { DataProtectionImpactAssessment } from "./DataProtectionImpactAssessment";
     8| import type { DataResponsibilityTitle } from "./DataResponsibilityTitle";
     9| import type { LegalBasisForProfilingEnum } from "./LegalBasisForProfilingEnum";
    10| import type { PrivacyDeclaration } from "./PrivacyDeclaration";
    11| import type { SystemMetadata } from "./SystemMetadata";
    12| /**
    13|  * The System resource model.
    14|  *
    15|  * Describes an application and includes a list of PrivacyDeclaration resources.
    16|  */
    17| export type Vendor = {
    18|   fides_key?: string;
    19|   /**
    20|    * Defines the Organization that this resource belongs to.
    21|    */
    22|   organization_fides_key?: string;
    23|   tags?: Array<string>;
    24|   name?: string;
    25|   /**
    26|    * A detailed description of what this resource is.
    27|    */
    28|   description?: string;
    29|   /**
    30|    * The id of the system registry, if used.
    31|    */
    32|   registry_id?: number;
    33|   /**
    34|    * An optional property to store any extra information for a resource. Data can be structured in any way: simple set of `key: value` pairs or deeply nested objects.
    35|    */


# ====================================================================
# FILE: clients/fides-js/src/components/tcf/TcfOverlay.tsx
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 16-64 ---
    16|   EnabledIds,
    17|   TCFFeatureRecord,
    18|   TCFFeatureSave,
    19|   TCFPurposeConsentRecord,
    20|   TCFPurposeLegitimateInterestsRecord,
    21|   TCFPurposeSave,
    22|   TCFSpecialFeatureSave,
    23|   TCFSpecialPurposeSave,
    24|   TCFVendorSave,
    25|   TcfSavePreferences,
    26|   TCFVendorConsentRecord,
    27|   TCFVendorLegitimateInterestsRecord,
    28|   TcfModels,
    29| } from "../../lib/tcf/types";
    30| import { updateConsentPreferences } from "../../lib/preferences";
    31| import {
    32|   ButtonType,
    33|   ConsentMethod,
    34|   PrivacyExperience,
    35| } from "../../lib/consent-types";
    36| import { generateTcString } from "../../lib/tcf";
    37| import {
    38|   FidesCookie,
    39|   transformTcfPreferencesToCookieKeys,
    40| } from "../../lib/cookie";
    41| import InitialLayer from "./InitialLayer";
    42| import TcfTabs from "./TcfTabs";
    43| import Button from "../Button";
    44| import VendorInfoBanner from "./VendorInfoBanner";
    45| const resolveConsentValueFromTcfModel = (
    46|   model:
    47|     | TCFPurposeConsentRecord
    48|     | TCFPurposeLegitimateInterestsRecord
    49|     | TCFFeatureRecord
    50|     | TCFVendorConsentRecord
    51|     | TCFVendorLegitimateInterestsRecord
    52| ) => {
    53|   if (model.current_preference) {
    54|     return transformUserPreferenceToBoolean(model.current_preference);
    55|   }
    56|   return transformUserPreferenceToBoolean(model.default_preference);
    57| };
    58| type TcfSave =
    59|   | TCFPurposeSave
    60|   | TCFSpecialPurposeSave
    61|   | TCFFeatureSave
    62|   | TCFSpecialFeatureSave
    63|   | TCFVendorSave;
    64| const getEnabledIds = (modelList: TcfModels) => {

# --- HUNK 2: Lines 154-200 ---
   154|     system_legitimate_interests_preferences: transformTcfModelToTcfSave({
   155|       modelList: experience.tcf_system_legitimate_interests,
   156|       enabledIds: enabledLegintSystemIds,
   157|     }) as TCFVendorSave[],
   158|   };
   159| };
   160| const updateCookie = async (
   161|   oldCookie: FidesCookie,
   162|   /**
   163|    * `tcf` and `enabledIds` should represent the same data, where `tcf` is what is
   164|    * sent to the backend, and `enabledIds` is what the FE uses. They have diverged
   165|    * because the backend has not implemented separate vendor legint/consents yet.
   166|    * Therefore, we need both entities right now, but eventually we should be able to
   167|    * only use one. In other words, `enabledIds` has a field for `vendorsConsent` and
   168|    * `vendorsLegint` but `tcf` only has `vendors`.
   169|    */
   170|   tcf: TcfSavePreferences,
   171|   enabledIds: EnabledIds,
   172|   experience: PrivacyExperience
   173| ): Promise<FidesCookie> => {
   174|   const tcString = await generateTcString({
   175|     tcStringPreferences: enabledIds,
   176|     experience,
   177|   });
   178|   return {
   179|     ...oldCookie,
   180|     fides_tc_string: tcString,
   181|     tcf_consent: transformTcfPreferencesToCookieKeys(tcf),
   182|   };
   183| };
   184| const TcfOverlay: FunctionComponent<OverlayProps> = ({
   185|   fidesRegionString,
   186|   experience,
   187|   options,
   188|   cookie,
   189| }) => {
   190|   const initialEnabledIds: EnabledIds = useMemo(() => {
   191|     const {
   192|       tcf_purpose_consents: consentPurposes = [],
   193|       tcf_purpose_legitimate_interests: legintPurposes = [],
   194|       tcf_special_purposes: specialPurposes = [],
   195|       tcf_features: features = [],
   196|       tcf_special_features: specialFeatures = [],
   197|       tcf_vendor_consents: consentVendors = [],
   198|       tcf_vendor_legitimate_interests: legintVendors = [],
   199|       tcf_system_consents: consentSystems = [],
   200|       tcf_system_legitimate_interests: legintSystems = [],

# --- HUNK 3: Lines 202-247 ---
   202|     return {
   203|       purposesConsent: getEnabledIds(consentPurposes),
   204|       purposesLegint: getEnabledIds(legintPurposes),
   205|       specialPurposes: getEnabledIds(specialPurposes),
   206|       features: getEnabledIds(features),
   207|       specialFeatures: getEnabledIds(specialFeatures),
   208|       vendorsConsent: getEnabledIds([...consentVendors, ...consentSystems]),
   209|       vendorsLegint: getEnabledIds([...legintVendors, ...legintSystems]),
   210|     };
   211|   }, [experience]);
   212|   const [draftIds, setDraftIds] = useState<EnabledIds>(initialEnabledIds);
   213|   const showBanner = useMemo(
   214|     () => experience.show_banner && hasActionNeededNotices(experience),
   215|     [experience]
   216|   );
   217|   const handleUpdateAllPreferences = useCallback(
   218|     (enabledIds: EnabledIds) => {
   219|       const tcf = createTcfSavePayload({ experience, enabledIds });
   220|       updateConsentPreferences({
   221|         consentPreferencesToSave: [],
   222|         experienceId: experience.id,
   223|         fidesApiUrl: options.fidesApiUrl,
   224|         consentMethod: ConsentMethod.button,
   225|         userLocationString: fidesRegionString,
   226|         cookie,
   227|         debug: options.debug,
   228|         servedNotices: null, // TODO: served notices
   229|         tcf,
   230|         updateCookie: (oldCookie) =>
   231|           updateCookie(oldCookie, tcf, enabledIds, experience),
   232|       });
   233|       setDraftIds(enabledIds);
   234|     },
   235|     [cookie, experience, fidesRegionString, options]
   236|   );
   237|   const [activeTabIndex, setActiveTabIndex] = useState(0);
   238|   if (!experience.experience_config) {
   239|     debugLog(options.debug, "No experience config found");
   240|     return null;
   241|   }
   242|   const experienceConfig = experience.experience_config;
   243|   return (
   244|     <Overlay
   245|       options={options}
   246|       experience={experience}
   247|       cookie={cookie}

# --- HUNK 4: Lines 275-315 ---
   275|             <div id="fides-tcf-banner-inner">
   276|               <VendorInfoBanner
   277|                 experience={experience}
   278|                 goToVendorTab={goToVendorTab}
   279|               />
   280|               <InitialLayer experience={experience} />
   281|             </div>
   282|           </ConsentBanner>
   283|         ) : null;
   284|       }}
   285|       renderModalContent={({ onClose }) => {
   286|         const onSave = (keys: EnabledIds) => {
   287|           handleUpdateAllPreferences(keys);
   288|           onClose();
   289|         };
   290|         return (
   291|           <Fragment>
   292|             <TcfTabs
   293|               experience={experience}
   294|               enabledIds={draftIds}
   295|               onChange={setDraftIds}
   296|               activeTabIndex={activeTabIndex}
   297|               onTabChange={setActiveTabIndex}
   298|             />
   299|             <div className="fides-modal-footer">
   300|               <TcfConsentButtons
   301|                 experience={experience}
   302|                 onSave={onSave}
   303|                 firstButton={
   304|                   <Button
   305|                     buttonType={ButtonType.SECONDARY}
   306|                     label={experience.experience_config?.save_button_label}
   307|                     onClick={() => onSave(draftIds)}
   308|                   />
   309|                 }
   310|               />
   311|               <PrivacyPolicyLink experience={experience.experience_config} />
   312|             </div>
   313|           </Fragment>
   314|         );
   315|       }}


# ====================================================================
# FILE: clients/fides-js/src/components/tcf/TcfVendors.tsx
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 1-187 ---
     1| import { VNode, h } from "preact";
     2| import { useMemo, useState } from "preact/hooks";
     3| import { Vendor } from "@iabtechlabtcf/core";
     4| import {
     5|   GvlDataRetention,
     6|   EmbeddedLineItem,
     7|   GvlDataCategories,
     8|   GvlVendorUrl,
     9|   GvlDataDeclarations,
    10|   VendorRecord,
    11| } from "../../lib/tcf/types";
    12| import { PrivacyExperience } from "../../lib/consent-types";
    13| import { UpdateEnabledIds } from "./TcfOverlay";
    14| import FilterButtons from "./FilterButtons";
    15| import {
    16|   transformExperienceToVendorRecords,
    17|   vendorGvlEntry,
    18| } from "../../lib/tcf/vendors";
    19| import ExternalLink from "../ExternalLink";
    20| import DoubleToggleTable from "./DoubleToggleTable";
    21| const FILTERS = [{ name: "All vendors" }, { name: "IAB TCF vendors" }];
    22| interface Retention {
    23|   mapping: Record<number, number>;
    24|   default: number;
    25| }
    26| const VendorDetails = ({
    27|   label,
    28|   lineItems,
    29|   dataRetention,
    30| }: {
    31|   label: string;
    32|   lineItems: EmbeddedLineItem[] | undefined;
    33|   dataRetention?: Retention;
    34| }) => {
    35|   if (!lineItems || lineItems.length === 0) {
    36|     return null;
    37|   }
    38|   return (
    39|     <table className="fides-vendor-details-table">
    40|       <thead>
    41|         <tr>
    42|           <th width="80%">{label}</th>
    43|           {dataRetention ? (
    44|             <th width="20%" style={{ textAlign: "right" }}>
    45|               Retention
    46|             </th>
    47|           ) : null}
    48|         </tr>
    49|       </thead>
    50|       <tbody>
    51|         {lineItems.map((item) => {
    52|           let retention: string | number = "N/A";
    53|           if (dataRetention) {
    54|             retention = dataRetention.mapping[item.id] ?? dataRetention.default;
    55|           }
    56|           return (
    57|             <tr key={item.id}>
    58|               <td>{item.name}</td>
    59|               {dataRetention ? (
    60|                 <td style={{ textAlign: "right" }}>
    61|                   {retention == null ? "N/A" : `${retention} day(s)`}
    62|                 </td>
    63|               ) : null}
    64|             </tr>
    65|           );
    66|         })}
    67|       </tbody>
    68|     </table>
    69|   );
    70| };
    71| const PurposeVendorDetails = ({
    72|   purposes,
    73|   specialPurposes,
    74|   gvlVendor,
    75| }: {
    76|   purposes: EmbeddedLineItem[] | undefined;
    77|   specialPurposes: EmbeddedLineItem[] | undefined;
    78|   gvlVendor: Vendor | undefined;
    79| }) => {
    80|   const emptyPurposes = purposes ? purposes.length === 0 : true;
    81|   const emptySpecialPurposes = specialPurposes
    82|     ? specialPurposes.length === 0
    83|     : true;
    84|   if (emptyPurposes && emptySpecialPurposes) {
    85|     return null;
    86|   }
    87|   const dataRetention: GvlDataRetention | undefined = gvlVendor?.dataRetention;
    88|   return (
    89|     <div>
    90|       <VendorDetails
    91|         label="Purposes"
    92|         lineItems={purposes as EmbeddedLineItem[]}
    93|         dataRetention={
    94|           dataRetention
    95|             ? {
    96|                 mapping: dataRetention.purposes,
    97|                 default: dataRetention.stdRetention,
    98|               }
    99|             : undefined
   100|         }
   101|       />
   102|       <VendorDetails
   103|         label="Special purposes"
   104|         lineItems={specialPurposes as EmbeddedLineItem[]}
   105|         dataRetention={
   106|           dataRetention
   107|             ? {
   108|                 mapping: dataRetention.specialPurposes,
   109|                 default: dataRetention.stdRetention,
   110|               }
   111|             : undefined
   112|         }
   113|       />
   114|     </div>
   115|   );
   116| };
   117| const DataCategories = ({
   118|   gvlVendor,
   119|   dataCategories,
   120| }: {
   121|   gvlVendor: Vendor | undefined;
   122|   dataCategories: GvlDataCategories | undefined;
   123| }) => {
   124|   if (!gvlVendor || !dataCategories) {
   125|     return null;
   126|   }
   127|   const declarations: GvlDataDeclarations = gvlVendor.dataDeclaration;
   128|   return (
   129|     <table className="fides-vendor-details-table">
   130|       <thead>
   131|         <tr>
   132|           <th>Data categories</th>
   133|         </tr>
   134|       </thead>
   135|       <tbody>
   136|         {declarations.map((id) => {
   137|           const category = dataCategories[id];
   138|           return (
   139|             <tr key={id}>
   140|               <td>{category.name}</td>
   141|             </tr>
   142|           );
   143|         })}
   144|       </tbody>
   145|     </table>
   146|   );
   147| };
   148| const StorageDisclosure = ({ vendor }: { vendor: Vendor }) => {
   149|   const {
   150|     name,
   151|     usesCookies,
   152|     usesNonCookieAccess,
   153|     cookieMaxAgeSeconds,
   154|     cookieRefresh,
   155|   } = vendor;
   156|   let disclosure = "";
   157|   if (usesCookies) {
   158|     const days = cookieMaxAgeSeconds
   159|       ? Math.ceil(cookieMaxAgeSeconds / 60 / 60 / 24)
   160|       : 0;
   161|     disclosure = `${name} stores cookies with a maximum duration of about ${days} Day(s).`;
   162|   }
   163|   if (cookieRefresh) {
   164|     disclosure = `${disclosure} These cookies may be refreshed.`;
   165|   }
   166|   if (usesNonCookieAccess) {
   167|     disclosure = `${disclosure} This vendor also uses other methods like "local storage" to store and access information on your device.`;
   168|   }
   169|   return <p>{disclosure}</p>;
   170| };
   171| const TcfVendors = ({
   172|   experience,
   173|   enabledVendorConsentIds,
   174|   enabledVendorLegintIds,
   175|   onChange,
   176|   allOnOffButtons,
   177| }: {
   178|   experience: PrivacyExperience;
   179|   enabledVendorConsentIds: string[];
   180|   enabledVendorLegintIds: string[];
   181|   onChange: (payload: UpdateEnabledIds) => void;
   182|   allOnOffButtons: VNode;
   183| }) => {
   184|   const [isFiltered, setIsFiltered] = useState(false);
   185|   const vendors = useMemo(
   186|     () => transformExperienceToVendorRecords(experience),
   187|     [experience]

# --- HUNK 2: Lines 199-261 ---
   199|   const vendorsToDisplay = isFiltered
   200|     ? vendors.filter((v) => vendorGvlEntry(v.id, experience.gvl))
   201|     : vendors;
   202|   return (
   203|     <div>
   204|       <FilterButtons filters={FILTERS} onChange={handleFilter} />
   205|       {allOnOffButtons}
   206|       <DoubleToggleTable<VendorRecord>
   207|         title="Vendors"
   208|         items={vendorsToDisplay}
   209|         enabledConsentIds={enabledVendorConsentIds}
   210|         enabledLegintIds={enabledVendorLegintIds}
   211|         onToggle={onChange}
   212|         consentModelType="vendorsConsent"
   213|         legintModelType="vendorsLegint"
   214|         renderBadgeLabel={(vendor) =>
   215|           vendorGvlEntry(vendor.id, experience.gvl) ? "IAB TCF" : undefined
   216|         }
   217|         renderToggleChild={(vendor) => {
   218|           const gvlVendor = vendorGvlEntry(vendor.id, experience.gvl);
   219|           const url: GvlVendorUrl | undefined = gvlVendor?.urls.find(
   220|             (u: GvlVendorUrl) => u.langId === "en"
   221|           );
   222|           const dataCategories: GvlDataCategories | undefined =
   223|             experience.gvl?.dataCategories;
   224|           return (
   225|             <div>
   226|               {gvlVendor ? <StorageDisclosure vendor={gvlVendor} /> : null}
   227|               <div style={{ marginBottom: "1.1em" }}>
   228|                 {url?.privacy ? (
   229|                   <ExternalLink href={url.privacy}>Privacy policy</ExternalLink>
   230|                 ) : null}
   231|                 {url?.legIntClaim ? (
   232|                   <ExternalLink href={url.legIntClaim}>
   233|                     Legitimate interest disclosure
   234|                   </ExternalLink>
   235|                 ) : null}
   236|               </div>
   237|               <PurposeVendorDetails
   238|                 purposes={[
   239|                   ...(vendor.purpose_consents || []),
   240|                   ...(vendor.purpose_legitimate_interests || []),
   241|                 ]}
   242|                 specialPurposes={vendor.special_purposes}
   243|                 gvlVendor={gvlVendor}
   244|               />
   245|               <VendorDetails label="Features" lineItems={vendor.features} />
   246|               <VendorDetails
   247|                 label="Special features"
   248|                 lineItems={vendor.special_features}
   249|               />
   250|               <DataCategories
   251|                 gvlVendor={gvlVendor}
   252|                 dataCategories={dataCategories}
   253|               />
   254|             </div>
   255|           );
   256|         }}
   257|       />
   258|     </div>
   259|   );
   260| };
   261| export default TcfVendors;


# ====================================================================
# FILE: clients/fides-js/src/fides-tcf.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 32-146 ---
    32|  *           modalLinkId: null,
    33|  *           privacyCenterUrl: "http://localhost:3000"
    34|  *         }
    35|  *   });
    36|  * </script>
    37|  * ```
    38|  *
    39|  * ...and later:
    40|  * ```
    41|  * <script>
    42|  *   // Query user consent preferences
    43|  *   if (window.Fides.consent.data_sales) {
    44|  *     // ...enable advertising scripts
    45|  *   }
    46|  * ```
    47|  */
    48| import type { TCData } from "@iabtechlabtcf/cmpapi";
    49| import { gtm } from "./integrations/gtm";
    50| import { meta } from "./integrations/meta";
    51| import { shopify } from "./integrations/shopify";
    52| import { FidesConfig, PrivacyExperience } from "./lib/consent-types";
    53| import { initializeCmpApi } from "./lib/tcf";
    54| import {
    55|   getInitialCookie,
    56|   getInitialFides,
    57|   initialize,
    58| } from "./lib/initialize";
    59| import type { Fides } from "./lib/initialize";
    60| import { dispatchFidesEvent } from "./lib/events";
    61| import { FidesCookie, hasSavedTcfPreferences, isNewFidesCookie } from "./fides";
    62| import { renderOverlay } from "./lib/tcf/renderOverlay";
    63| declare global {
    64|   interface Window {
    65|     Fides: Fides;
    66|     __tcfapiLocator?: Window;
    67|     __tcfapi?: (
    68|       command: string,
    69|       version: number,
    70|       callback: (tcData: TCData, success: boolean) => void,
    71|       parameter?: number | string
    72|     ) => void;
    73|   }
    74| }
    75| let _Fides: Fides;
    76| const updateCookie = async (
    77|   oldCookie: FidesCookie,
    78|   experience: PrivacyExperience
    79| ): Promise<FidesCookie> => {
    80|   if (!hasSavedTcfPreferences(experience)) {
    81|     return { ...oldCookie, fides_tc_string: "" };
    82|   }
    83|   return oldCookie;
    84| };
    85| /**
    86|  * Initialize the global Fides object with the given configuration values
    87|  */
    88| const init = async (config: FidesConfig) => {
    89|   const cookie = getInitialCookie(config);
    90|   const initialFides = getInitialFides({ ...config, cookie });
    91|   initializeCmpApi();
    92|   if (initialFides) {
    93|     Object.assign(_Fides, initialFides);
    94|     dispatchFidesEvent("FidesInitialized", cookie, config.options.debug);
    95|     dispatchFidesEvent("FidesUpdated", cookie, config.options.debug);
    96|   }
    97|   const experience = initialFides?.experience ?? config.experience;
    98|   const updatedFides = await initialize({
    99|     ...config,
   100|     experience,
   101|     cookie,
   102|     renderOverlay,
   103|     updateCookie,
   104|   });
   105|   Object.assign(_Fides, updatedFides);
   106|   if (isNewFidesCookie(cookie)) {
   107|     dispatchFidesEvent("FidesInitialized", cookie, config.options.debug);
   108|   }
   109|   dispatchFidesEvent("FidesUpdated", cookie, config.options.debug);
   110| };
   111| _Fides = {
   112|   consent: {},
   113|   experience: undefined,
   114|   geolocation: {},
   115|   options: {
   116|     debug: true,
   117|     isOverlayEnabled: false,
   118|     isPrefetchEnabled: false,
   119|     isGeolocationEnabled: false,
   120|     geolocationApiUrl: "",
   121|     overlayParentId: null,
   122|     modalLinkId: null,
   123|     privacyCenterUrl: "",
   124|     fidesApiUrl: "",
   125|     serverSideFidesApiUrl: "",
   126|     tcfEnabled: true,
   127|   },
   128|   fides_meta: {},
   129|   identity: {},
   130|   tcf_consent: {},
   131|   gtm,
   132|   init,
   133|   initialized: false,
   134|   meta,
   135|   shopify,
   136| };
   137| if (typeof window !== "undefined") {
   138|   window.Fides = _Fides;
   139| }
   140| export * from "./components";
   141| export * from "./lib/consent";
   142| export * from "./lib/consent-context";
   143| export * from "./lib/consent-types";
   144| export * from "./lib/consent-utils";
   145| export * from "./lib/consent-value";
   146| export * from "./lib/cookie";


# ====================================================================
# FILE: clients/fides-js/src/lib/cookie.ts
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 1-146 ---
     1| import { v4 as uuidv4 } from "uuid";
     2| import { getCookie, removeCookie, setCookie, Types } from "typescript-cookie";
     3| import { ConsentContext } from "./consent-context";
     4| import {
     5|   resolveConsentValue,
     6|   resolveLegacyConsentValue,
     7| } from "./consent-value";
     8| import {
     9|   ConsentMechanism,
    10|   Cookies,
    11|   LegacyConsentConfig,
    12|   PrivacyExperience,
    13|   SaveConsentPreference,
    14| } from "./consent-types";
    15| import {
    16|   debugLog,
    17|   transformConsentToFidesUserPreference,
    18|   transformUserPreferenceToBoolean,
    19| } from "./consent-utils";
    20| import type { TcfCookieConsent, TcfSavePreferences } from "./tcf/types";
    21| import { TCF_COOKIE_KEY_TO_EXPERIENCE_KEY } from "./tcf/constants";
    22| /**
    23|  * Store the user's consent preferences on the cookie, as key -> boolean pairs, e.g.
    24|  * {
    25|  *   "data_sales": false,
    26|  *   "analytics": true,
    27|  *   ...
    28|  * }
    29|  */
    30| export type CookieKeyConsent = {
    31|   [cookieKey: string]: boolean | undefined;
    32| };
    33| /**
    34|  * Store the user's identity values on the cookie, e.g.
    35|  * {
    36|  *   "fides_user_device_id": "1234-",
    37|  *   "email": "jane@example.com",
    38|  *   ...
    39|  * }
    40|  */
    41| export type CookieIdentity = Record<string, string>;
    42| /**
    43|  * Store metadata about the cookie itself, e.g.
    44|  * {
    45|  *   "version": "0.9.0",
    46|  *   "createdAt": "2023-01-01T12:00:00.000Z",
    47|  *   ...
    48|  * }
    49|  */
    50| export type CookieMeta = Record<string, string>;
    51| export interface FidesCookie {
    52|   consent: CookieKeyConsent;
    53|   identity: CookieIdentity;
    54|   fides_meta: CookieMeta;
    55|   fides_tc_string?: string;
    56|   tcf_consent: TcfCookieConsent;
    57| }
    58| /**
    59|  * Save the cookie under the name "fides_consent" for 365 days
    60|  */
    61| export const CONSENT_COOKIE_NAME = "fides_consent";
    62| export const CONSENT_COOKIE_MAX_AGE_DAYS = 365;
    63| /**
    64|  * The typescript-cookie default codec has a more conservative strategy in order to
    65|  * comply with the exact requirements of RFC 6265. For ease of use in external pages,
    66|  * we instead use encode/decodeURIComponent which are available in every browser.
    67|  *
    68|  * See: https://github.com/carhartl/typescript-cookie#encoding
    69|  */
    70| const CODEC: Types.CookieCodecConfig<string, string> = {
    71|   decodeName: decodeURIComponent,
    72|   decodeValue: decodeURIComponent,
    73|   encodeName: encodeURIComponent,
    74|   encodeValue: encodeURIComponent,
    75| };
    76| /**
    77|  * Each cookie will be assigned an autogenerated user/device ID, to match user's
    78|  * consent preferences between the browser and the server. This is a randomly
    79|  * generated UUID to prevent it from being identifiable (without matching it to
    80|  * some other identity data!)
    81|  */
    82| export const generateFidesUserDeviceId = (): string => uuidv4();
    83| /**
    84|  * Determine whether or not the given cookie is "new" (ie. has never been saved
    85|  * to the browser).
    86|  */
    87| export const isNewFidesCookie = (cookie: FidesCookie): boolean => {
    88|   const isSaved = Boolean(cookie.fides_meta?.updatedAt);
    89|   return !isSaved;
    90| };
    91| /**
    92|  * Generate a new Fides cookie with default values for the current user.
    93|  */
    94| export const makeFidesCookie = (consent?: CookieKeyConsent): FidesCookie => {
    95|   const now = new Date();
    96|   const userDeviceId = generateFidesUserDeviceId();
    97|   return {
    98|     consent: consent || {},
    99|     identity: {
   100|       fides_user_device_id: userDeviceId,
   101|     },
   102|     fides_meta: {
   103|       version: "0.9.0",
   104|       createdAt: now.toISOString(),
   105|       updatedAt: "",
   106|     },
   107|     tcf_consent: {},
   108|   };
   109| };
   110| /**
   111|  * Attempt to read, parse, and return the current Fides cookie from the browser.
   112|  * If one doesn't exist, make a new default cookie (including generating a new
   113|  * pseudonymous ID) and return the default values.
   114|  *
   115|  * NOTE: This doesn't *save* the cookie to the browser. To do that, call
   116|  * `saveFidesCookie` with a valid cookie after editing the values.
   117|  */
   118| export const getOrMakeFidesCookie = (
   119|   defaults?: CookieKeyConsent,
   120|   debug: boolean = false
   121| ): FidesCookie => {
   122|   const defaultCookie = makeFidesCookie(defaults);
   123|   if (typeof document === "undefined") {
   124|     return defaultCookie;
   125|   }
   126|   const cookieString = getCookie(CONSENT_COOKIE_NAME, CODEC);
   127|   if (!cookieString) {
   128|     debugLog(
   129|       debug,
   130|       `No existing Fides consent cookie found, returning defaults.`,
   131|       cookieString
   132|     );
   133|     return defaultCookie;
   134|   }
   135|   try {
   136|     let parsedCookie: FidesCookie;
   137|     const parsedJson = JSON.parse(cookieString);
   138|     if ("consent" in parsedJson && "fides_meta" in parsedJson) {
   139|       parsedCookie = parsedJson;
   140|     } else {
   141|       parsedCookie = {
   142|         ...defaultCookie,
   143|         consent: parsedJson,
   144|       };
   145|     }
   146|     const updatedConsent: CookieKeyConsent = {

# --- HUNK 2: Lines 198-301 ---
   198|  *
   199|  * Returns cookie consent that can then be changed according to the
   200|  * user's preferences.
   201|  */
   202| export const buildCookieConsentForExperiences = (
   203|   experience: PrivacyExperience,
   204|   context: ConsentContext,
   205|   debug: boolean
   206| ): CookieKeyConsent => {
   207|   const cookieConsent: CookieKeyConsent = {};
   208|   if (!experience.privacy_notices) {
   209|     return cookieConsent;
   210|   }
   211|   experience.privacy_notices.forEach((notice) => {
   212|     cookieConsent[notice.notice_key] = resolveConsentValue(notice, context);
   213|   });
   214|   debugLog(debug, `Returning cookie consent for experiences.`, cookieConsent);
   215|   return cookieConsent;
   216| };
   217| /**
   218|  * Updates prefetched experience, based on:
   219|  * 1) experience: pre-fetched experience-based consent configuration that does not contain user preference.
   220|  * 2) cookie: cookie containing user preference.
   221|  *
   222|  * Returns updated experience with user preferences.
   223|  */
   224| export const updateExperienceFromCookieConsent = ({
   225|   experience,
   226|   cookie,
   227|   debug,
   228| }: {
   229|   experience: PrivacyExperience;
   230|   cookie: FidesCookie;
   231|   debug?: boolean;
   232| }): PrivacyExperience => {
   233|   const noticesWithConsent = experience.privacy_notices?.map((notice) => {
   234|     const preference = Object.hasOwn(cookie.consent, notice.notice_key)
   235|       ? transformConsentToFidesUserPreference(
   236|           Boolean(cookie.consent[notice.notice_key]),
   237|           notice.consent_mechanism
   238|         )
   239|       : undefined;
   240|     return { ...notice, current_preference: preference };
   241|   });
   242|   const tcfEntities: Partial<PrivacyExperience> = {
   243|     tcf_purpose_consents: experience.tcf_purpose_consents,
   244|     tcf_purpose_legitimate_interests:
   245|       experience.tcf_purpose_legitimate_interests,
   246|     tcf_special_purposes: experience.tcf_special_purposes,
   247|     tcf_features: experience.tcf_features,
   248|     tcf_special_features: experience.tcf_special_features,
   249|     tcf_vendor_consents: experience.tcf_vendor_consents,
   250|     tcf_vendor_legitimate_interests: experience.tcf_vendor_legitimate_interests,
   251|     tcf_system_consents: experience.tcf_system_consents,
   252|     tcf_system_legitimate_interests: experience.tcf_system_legitimate_interests,
   253|   };
   254|   if (cookie.tcf_consent) {
   255|     TCF_COOKIE_KEY_TO_EXPERIENCE_KEY.forEach(({ cookieKey, experienceKey }) => {
   256|       const cookieConsent = cookie.tcf_consent[cookieKey] ?? {};
   257|       tcfEntities[experienceKey] = experience[experienceKey]?.map((item) => {
   258|         const preference = Object.hasOwn(cookieConsent, item.id)
   259|           ? transformConsentToFidesUserPreference(
   260|               Boolean(cookieConsent[item.id]),
   261|               ConsentMechanism.OPT_IN
   262|             )
   263|           : undefined;
   264|         return { ...item, current_preference: preference };
   265|       });
   266|     });
   267|   }
   268|   if (debug) {
   269|     debugLog(
   270|       debug,
   271|       `Returning updated pre-fetched experience with user consent.`,
   272|       experience
   273|     );
   274|   }
   275|   return { ...experience, ...tcfEntities, privacy_notices: noticesWithConsent };
   276| };
   277| export const transformTcfPreferencesToCookieKeys = (
   278|   tcfPreferences: TcfSavePreferences
   279| ): TcfCookieConsent => {
   280|   const cookieKeys: TcfCookieConsent = {};
   281|   TCF_COOKIE_KEY_TO_EXPERIENCE_KEY.forEach(({ cookieKey }) => {
   282|     const preferences = tcfPreferences[cookieKey] ?? [];
   283|     cookieKeys[cookieKey] = Object.fromEntries(
   284|       preferences.map((pref) => [
   285|         pref.id,
   286|         transformUserPreferenceToBoolean(pref.preference),
   287|       ])
   288|     );
   289|   });
   290|   return cookieKeys;
   291| };
   292| /**
   293|  * Generate the *default* consent preferences for this session, based on:
   294|  * 1) config: current legacy consent configuration, which defines the options and their
   295|  *    default values (e.g. "data_sales" => true)
   296|  * 2) context: browser context, which can automatically override those defaults
   297|  *    in some cases (e.g. global privacy control => false)
   298|  *
   299|  * Returns the final set of "defaults" that can then be changed according to the
   300|  * user's preferences.
   301|  */


# ====================================================================
# FILE: clients/fides-js/src/lib/initialize.ts
# Total hunks: 5
# ====================================================================
# --- HUNK 1: Lines 1-197 ---
     1| import { ContainerNode } from "preact";
     2| import { gtm } from "../integrations/gtm";
     3| import { meta } from "../integrations/meta";
     4| import { shopify } from "../integrations/shopify";
     5| import { getConsentContext } from "./consent-context";
     6| import {
     7|   CookieIdentity,
     8|   CookieKeyConsent,
     9|   CookieMeta,
    10|   FidesCookie,
    11|   getOrMakeFidesCookie,
    12|   isNewFidesCookie,
    13|   makeConsentDefaultsLegacy,
    14|   updateCookieFromNoticePreferences,
    15|   updateExperienceFromCookieConsent,
    16| } from "./cookie";
    17| import {
    18|   ConsentMechanism,
    19|   ConsentMethod,
    20|   EmptyExperience,
    21|   FidesConfig,
    22|   FidesOptions,
    23|   PrivacyExperience,
    24|   SaveConsentPreference,
    25|   UserGeolocation,
    26| } from "./consent-types";
    27| import {
    28|   constructFidesRegionString,
    29|   debugLog,
    30|   experienceIsValid,
    31|   isPrivacyExperience,
    32|   transformConsentToFidesUserPreference,
    33|   validateOptions,
    34| } from "./consent-utils";
    35| import { fetchExperience } from "../services/fides/api";
    36| import { getGeolocation } from "../services/external/geolocation";
    37| import { OverlayProps } from "../components/types";
    38| import { updateConsentPreferences } from "./preferences";
    39| import { resolveConsentValue } from "./consent-value";
    40| import { initOverlay } from "./consent";
    41| import { TcfCookieConsent } from "./tcf/types";
    42| export type Fides = {
    43|   consent: CookieKeyConsent;
    44|   experience?: PrivacyExperience | EmptyExperience;
    45|   geolocation?: UserGeolocation;
    46|   fides_tc_string?: string | undefined;
    47|   options: FidesOptions;
    48|   fides_meta: CookieMeta;
    49|   tcf_consent: TcfCookieConsent;
    50|   gtm: typeof gtm;
    51|   identity: CookieIdentity;
    52|   init: (config: FidesConfig) => Promise<void>;
    53|   initialized: boolean;
    54|   meta: typeof meta;
    55|   shopify: typeof shopify;
    56| };
    57| const retrieveEffectiveRegionString = async (
    58|   geolocation: UserGeolocation | undefined,
    59|   options: FidesOptions
    60| ) => {
    61|   const fidesRegionString = constructFidesRegionString(geolocation);
    62|   if (!fidesRegionString) {
    63|     return constructFidesRegionString(
    64|       await getGeolocation(
    65|         options.isGeolocationEnabled,
    66|         options.geolocationApiUrl,
    67|         options.debug
    68|       )
    69|     );
    70|   }
    71|   return fidesRegionString;
    72| };
    73| /**
    74|  * Opt out of notices that can be opted out of automatically.
    75|  * This does not currently do anything with TCF.
    76|  */
    77| const automaticallyApplyGPCPreferences = ({
    78|   cookie,
    79|   fidesRegionString,
    80|   fidesApiUrl,
    81|   effectiveExperience,
    82| }: {
    83|   cookie: FidesCookie;
    84|   fidesRegionString: string | null;
    85|   fidesApiUrl: string;
    86|   effectiveExperience?: PrivacyExperience;
    87| }) => {
    88|   if (!effectiveExperience || !effectiveExperience.privacy_notices) {
    89|     return;
    90|   }
    91|   const context = getConsentContext();
    92|   if (!context.globalPrivacyControl) {
    93|     return;
    94|   }
    95|   let gpcApplied = false;
    96|   const consentPreferencesToSave = effectiveExperience.privacy_notices.map(
    97|     (notice) => {
    98|       if (
    99|         notice.has_gpc_flag &&
   100|         !notice.current_preference &&
   101|         notice.consent_mechanism !== ConsentMechanism.NOTICE_ONLY
   102|       ) {
   103|         gpcApplied = true;
   104|         return new SaveConsentPreference(
   105|           notice,
   106|           transformConsentToFidesUserPreference(false, notice.consent_mechanism)
   107|         );
   108|       }
   109|       return new SaveConsentPreference(
   110|         notice,
   111|         transformConsentToFidesUserPreference(
   112|           resolveConsentValue(notice, context),
   113|           notice.consent_mechanism
   114|         )
   115|       );
   116|     }
   117|   );
   118|   if (gpcApplied) {
   119|     updateConsentPreferences({
   120|       consentPreferencesToSave,
   121|       experienceId: effectiveExperience.id,
   122|       fidesApiUrl,
   123|       consentMethod: ConsentMethod.gpc,
   124|       userLocationString: fidesRegionString || undefined,
   125|       cookie,
   126|       updateCookie: (oldCookie) =>
   127|         updateCookieFromNoticePreferences(oldCookie, consentPreferencesToSave),
   128|     });
   129|   }
   130| };
   131| /**
   132|  * Get the initial Fides cookie based on legacy consent values
   133|  * as well as any preferences stored in existing cookies
   134|  */
   135| export const getInitialCookie = ({ consent, options }: FidesConfig) => {
   136|   const context = getConsentContext();
   137|   const consentDefaults = makeConsentDefaultsLegacy(
   138|     consent,
   139|     context,
   140|     options.debug
   141|   );
   142|   const cookie: FidesCookie = getOrMakeFidesCookie(
   143|     consentDefaults,
   144|     options.debug
   145|   );
   146|   return cookie;
   147| };
   148| /**
   149|  * If saved preferences are detected, immediately initialize from local cache
   150|  */
   151| export const getInitialFides = ({
   152|   cookie,
   153|   experience,
   154|   geolocation,
   155|   options,
   156| }: {
   157|   cookie: FidesCookie;
   158| } & FidesConfig): Partial<Fides> | null => {
   159|   const hasExistingCookie = !isNewFidesCookie(cookie);
   160|   if (!hasExistingCookie) {
   161|     return null;
   162|   }
   163|   let updatedExperience = experience;
   164|   if (isPrivacyExperience(experience)) {
   165|     updatedExperience = updateExperienceFromCookieConsent({
   166|       experience,
   167|       cookie,
   168|       debug: options.debug,
   169|     });
   170|   }
   171|   return {
   172|     consent: cookie.consent,
   173|     fides_meta: cookie.fides_meta,
   174|     identity: cookie.identity,
   175|     experience: updatedExperience,
   176|     tcf_consent: cookie.tcf_consent,
   177|     fides_tc_string: cookie.fides_tc_string,
   178|     geolocation,
   179|     options,
   180|     initialized: true,
   181|   };
   182| };
   183| /**
   184|  * The bulk of the initialization logic
   185|  * 1. Validates options
   186|  * 2. Retrieves geolocation
   187|  * 3. Retrieves experience
   188|  * 4. Updates cookie
   189|  * 5. Initialize overlay components
   190|  * 6. Apply GPC if necessary
   191|  */
   192| export const initialize = async ({
   193|   cookie,
   194|   options,
   195|   experience,
   196|   geolocation,
   197|   renderOverlay,

# --- HUNK 2: Lines 204-278 ---
   204|     experience: PrivacyExperience,
   205|     debug?: boolean
   206|   ) => Promise<FidesCookie>;
   207| } & FidesConfig): Promise<Partial<Fides>> => {
   208|   let shouldInitOverlay: boolean = options.isOverlayEnabled;
   209|   let effectiveExperience = experience;
   210|   let fidesRegionString: string | null = null;
   211|   if (shouldInitOverlay) {
   212|     if (!validateOptions(options)) {
   213|       debugLog(
   214|         options.debug,
   215|         "Invalid overlay options. Skipping overlay initialization.",
   216|         options
   217|       );
   218|       shouldInitOverlay = false;
   219|     }
   220|     fidesRegionString = await retrieveEffectiveRegionString(
   221|       geolocation,
   222|       options
   223|     );
   224|     if (!fidesRegionString) {
   225|       debugLog(
   226|         options.debug,
   227|         `User location could not be obtained. Skipping overlay initialization.`
   228|       );
   229|       shouldInitOverlay = false;
   230|     } else if (!isPrivacyExperience(effectiveExperience)) {
   231|       effectiveExperience = await fetchExperience(
   232|         fidesRegionString,
   233|         options.fidesApiUrl,
   234|         options.debug,
   235|         cookie.identity.fides_user_device_id
   236|       );
   237|     }
   238|     if (
   239|       isPrivacyExperience(effectiveExperience) &&
   240|       experienceIsValid(effectiveExperience, options)
   241|     ) {
   242|       const updatedCookie = await updateCookie(
   243|         cookie,
   244|         effectiveExperience,
   245|         options.debug
   246|       );
   247|       Object.assign(cookie, updatedCookie);
   248|       if (shouldInitOverlay) {
   249|         await initOverlay({
   250|           experience: effectiveExperience,
   251|           fidesRegionString: fidesRegionString as string,
   252|           cookie,
   253|           options,
   254|           renderOverlay,
   255|         }).catch(() => {});
   256|       }
   257|     }
   258|   }
   259|   if (shouldInitOverlay && isPrivacyExperience(effectiveExperience)) {
   260|     automaticallyApplyGPCPreferences({
   261|       cookie,
   262|       fidesRegionString,
   263|       fidesApiUrl: options.fidesApiUrl,
   264|       effectiveExperience,
   265|     });
   266|   }
   267|   return {
   268|     consent: cookie.consent,
   269|     fides_meta: cookie.fides_meta,
   270|     identity: cookie.identity,
   271|     fides_tc_string: cookie.fides_tc_string,
   272|     tcf_consent: cookie.tcf_consent,
   273|     experience,
   274|     geolocation,
   275|     options,
   276|     initialized: true,
   277|   };
   278| };


# ====================================================================
# FILE: clients/fides-js/src/lib/preferences.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-95 ---
     1| import {
     2|   ConsentMethod,
     3|   ConsentOptionCreate,
     4|   LastServedConsentSchema,
     5|   PrivacyPreferencesRequest,
     6|   SaveConsentPreference,
     7|   UserConsentPreference,
     8| } from "./consent-types";
     9| import { debugLog } from "./consent-utils";
    10| import {
    11|   FidesCookie,
    12|   removeCookiesFromBrowser,
    13|   saveFidesCookie,
    14| } from "./cookie";
    15| import { dispatchFidesEvent } from "./events";
    16| import { patchUserPreferenceToFidesServer } from "../services/fides/api";
    17| import { TcfSavePreferences } from "./tcf/types";
    18| /**
    19|  * Updates the user's consent preferences, going through the following steps:
    20|  * 1. Save preferences to Fides API
    21|  * 2. Update the window.Fides.consent object
    22|  * 3. Save preferences to the `fides_consent` cookie in the browser
    23|  * 4. Remove any cookies from notices that were opted-out from the browser
    24|  * 5. Dispatch a "FidesUpdated" event
    25|  */
    26| export const updateConsentPreferences = async ({
    27|   consentPreferencesToSave,
    28|   experienceId,
    29|   fidesApiUrl,
    30|   consentMethod,
    31|   userLocationString,
    32|   cookie,
    33|   debug = false,
    34|   servedNotices,
    35|   tcf,
    36|   updateCookie,
    37| }: {
    38|   consentPreferencesToSave?: Array<SaveConsentPreference>;
    39|   experienceId: string;
    40|   fidesApiUrl: string;
    41|   consentMethod: ConsentMethod;
    42|   userLocationString?: string;
    43|   cookie: FidesCookie;
    44|   debug?: boolean;
    45|   servedNotices?: Array<LastServedConsentSchema> | null;
    46|   tcf?: TcfSavePreferences;
    47|   updateCookie: (oldCookie: FidesCookie) => Promise<FidesCookie>;
    48| }) => {
    49|   const fidesUserPreferences: Array<ConsentOptionCreate> | undefined =
    50|     consentPreferencesToSave
    51|       ? consentPreferencesToSave.map(({ notice, consentPreference }) => {
    52|           const servedNotice = servedNotices
    53|             ? servedNotices.find(
    54|                 (n) =>
    55|                   n.privacy_notice_history?.id ===
    56|                   notice.privacy_notice_history_id
    57|               )
    58|             : undefined;
    59|           return {
    60|             privacy_notice_history_id: notice.privacy_notice_history_id,
    61|             preference: consentPreference,
    62|             served_notice_history_id: servedNotice?.served_notice_history_id,
    63|           };
    64|         })
    65|       : undefined;
    66|   debugLog(debug, "Saving preferences to Fides API");
    67|   const privacyPreferenceCreate: PrivacyPreferencesRequest = {
    68|     browser_identity: cookie.identity,
    69|     preferences: fidesUserPreferences,
    70|     privacy_experience_id: experienceId,
    71|     user_geography: userLocationString,
    72|     method: consentMethod,
    73|     ...(tcf ?? []),
    74|   };
    75|   patchUserPreferenceToFidesServer(privacyPreferenceCreate, fidesApiUrl, debug);
    76|   const updatedCookie = await updateCookie(cookie);
    77|   Object.assign(cookie, updatedCookie);
    78|   debugLog(debug, "Updating window.Fides");
    79|   window.Fides.consent = cookie.consent;
    80|   window.Fides.fides_tc_string = cookie.fides_tc_string;
    81|   window.Fides.tcf_consent = cookie.tcf_consent;
    82|   debugLog(debug, "Saving preferences to cookie");
    83|   saveFidesCookie(cookie);
    84|   if (consentPreferencesToSave) {
    85|     consentPreferencesToSave
    86|       .filter(
    87|         (preference) =>
    88|           preference.consentPreference === UserConsentPreference.OPT_OUT
    89|       )
    90|       .forEach((preference) => {
    91|         removeCookiesFromBrowser(preference.notice.cookies);
    92|       });
    93|   }
    94|   dispatchFidesEvent("FidesUpdated", cookie, debug);
    95| };


# ====================================================================
# FILE: clients/fides-js/src/lib/tcf.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 22-69 ---
    22| const FORBIDDEN_LEGITIMATE_INTEREST_PURPOSE_IDS = [1, 3, 4, 5, 6];
    23| const AC_SPECIFICATION_VERSION = 1;
    24| /**
    25|  * Generate an AC String based on TCF-related info from privacy experience.
    26|  */
    27| const generateAcString = ({
    28|   tcStringPreferences,
    29| }: {
    30|   tcStringPreferences: Pick<EnabledIds, "vendorsConsent" | "vendorsLegint">;
    31| }) => {
    32|   const uniqueIds = Array.from(
    33|     new Set(
    34|       [
    35|         ...tcStringPreferences.vendorsConsent,
    36|         ...tcStringPreferences.vendorsLegint,
    37|       ]
    38|         .filter((id) => vendorIsAc(id))
    39|         .map((id) => decodeVendorId(id).id)
    40|     )
    41|   );
    42|   const vendorIds = uniqueIds.sort().join(".");
    43|   return `${AC_SPECIFICATION_VERSION}~${vendorIds}`;
    44| };
    45| /**
    46|  * Generate TC String based on TCF-related info from privacy experience.
    47|  * Called when there is either a FidesInitialized or FidesUpdated event
    48|  */
    49| export const generateTcString = async ({
    50|   experience,
    51|   tcStringPreferences,
    52| }: {
    53|   tcStringPreferences?: EnabledIds;
    54|   experience: PrivacyExperience;
    55| }): Promise<string> => {
    56|   let encodedString = "";
    57|   try {
    58|     const tcModel = new TCModel(new GVL(experience.gvl));
    59|     await tcModel.gvl.readyPromise;
    60|     tcModel.cmpId = CMP_ID;
    61|     tcModel.cmpVersion = CMP_VERSION;
    62|     tcModel.consentScreen = 1; // todo- On which 'screen' consent was captured; this is a CMP proprietary number encoded into the TC string
    63|     tcModel.gvl.narrowVendorsTo(uniqueGvlVendorIds(experience));
    64|     if (tcStringPreferences) {
    65|       tcStringPreferences.vendorsConsent.forEach((vendorId) => {
    66|         if (vendorGvlEntry(vendorId, experience.gvl)) {
    67|           const { id } = decodeVendorId(vendorId);
    68|           tcModel.vendorConsents.set(+id);
    69|         }

# --- HUNK 2: Lines 102-162 ---
   102|       });
   103|       tcStringPreferences.specialFeatures.forEach((id) => {
   104|         tcModel.specialFeatureOptins.set(+id);
   105|       });
   106|       encodedString = TCString.encode(tcModel);
   107|       const acString = generateAcString({ tcStringPreferences });
   108|       encodedString = `${encodedString}${FIDES_SEPARATOR}${acString}`;
   109|     }
   110|   } catch (e) {
   111|     console.error("Unable to instantiate GVL: ", e);
   112|     return Promise.resolve("");
   113|   }
   114|   return Promise.resolve(encodedString);
   115| };
   116| /**
   117|  * Extract just the TC string from a FidesEvent. This will also remove parts of the
   118|  * TC string that we do not want to surface with our CMP API events, such as
   119|  * `vendors_disclosed` and our own AC string addition.
   120|  */
   121| const fidesEventToTcString = (event: FidesEvent) => {
   122|   const { fides_tc_string: cookieString } = event.detail;
   123|   if (cookieString) {
   124|     const [tcString] = cookieString.split(FIDES_SEPARATOR);
   125|     return tcString.split(".")[0];
   126|   }
   127|   return cookieString;
   128| };
   129| /**
   130|  * Initializes the CMP API, including setting up listeners on FidesEvents to update
   131|  * the CMP API accordingly.
   132|  */
   133| export const initializeCmpApi = () => {
   134|   makeStub();
   135|   const isServiceSpecific = true; // TODO: determine this from the backend?
   136|   const cmpApi = new CmpApi(CMP_ID, CMP_VERSION, isServiceSpecific, {
   137|     getTCData: (next, tcData: TCData, status) => {
   138|       /*
   139|        * If using with 'removeEventListener' command, add a check to see if tcData is not a boolean. */
   140|       if (typeof tcData !== "boolean") {
   141|         const stringSplit =
   142|           window.Fides.fides_tc_string?.split(FIDES_SEPARATOR);
   143|         const addtlConsent = stringSplit?.length === 2 ? stringSplit[1] : "";
   144|         next({ ...tcData, addtlConsent }, status);
   145|         return;
   146|       }
   147|       next(tcData, status);
   148|     },
   149|   });
   150|   window.addEventListener("FidesInitialized", (event) => {
   151|     const tcString = fidesEventToTcString(event);
   152|     cmpApi.update(tcString ?? null, false);
   153|   });
   154|   window.addEventListener("FidesUIShown", (event) => {
   155|     const tcString = fidesEventToTcString(event);
   156|     cmpApi.update(tcString ?? null, true);
   157|   });
   158|   window.addEventListener("FidesModalClosed", (event) => {
   159|     const tcString = fidesEventToTcString(event);
   160|     cmpApi.update(tcString ?? null, false);
   161|   });
   162|   window.addEventListener("FidesUpdated", (event) => {


# ====================================================================
# FILE: clients/fides-js/src/lib/tcf/constants.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-47 ---
     1| import { TcfExperienceRecords, TcfModelType } from "./types";
     2| /**
     3|  * We store all of our preference strings (TC, AC, etc.) together as one string so that
     4|  * we can have a single-source-of-truth for offline storage & syncing. The code responsible
     5|  * for serving our standards-compliant JS API is responsible for separating out the
     6|  * preference strings for consumption.
     7|  */
     8| export const FIDES_SEPARATOR = ",";
     9| export const TCF_COOKIE_KEY_TO_EXPERIENCE_KEY: {
    10|   cookieKey: TcfModelType;
    11|   experienceKey: keyof TcfExperienceRecords;
    12| }[] = [
    13|   {
    14|     cookieKey: "purpose_consent_preferences",
    15|     experienceKey: "tcf_purpose_consents",
    16|   },
    17|   {
    18|     cookieKey: "purpose_legitimate_interests_preferences",
    19|     experienceKey: "tcf_purpose_legitimate_interests",
    20|   },
    21|   {
    22|     cookieKey: "special_feature_preferences",
    23|     experienceKey: "tcf_special_features",
    24|   },
    25|   {
    26|     cookieKey: "vendor_consent_preferences",
    27|     experienceKey: "tcf_vendor_consents",
    28|   },
    29|   {
    30|     cookieKey: "vendor_legitimate_interests_preferences",
    31|     experienceKey: "tcf_vendor_legitimate_interests",
    32|   },
    33|   {
    34|     cookieKey: "system_consent_preferences",
    35|     experienceKey: "tcf_system_consents",
    36|   },
    37|   {
    38|     cookieKey: "system_legitimate_interests_preferences",
    39|     experienceKey: "tcf_system_legitimate_interests",
    40|   },
    41| ];
    42| export const EXPERIENCE_KEYS_WITH_PREFERENCES =
    43|   TCF_COOKIE_KEY_TO_EXPERIENCE_KEY.filter(
    44|     ({ experienceKey }) =>
    45|       experienceKey !== "tcf_features" &&
    46|       experienceKey !== "tcf_special_purposes"
    47|   ).map((key) => key.experienceKey);


# ====================================================================
# FILE: clients/fides-js/src/lib/tcf/vendors.ts
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 27-102 ---
    27|  * @example If an id of `gvl.2` is passed in, return GVL Vendor #2
    28|  * @example If an id of `ac.2` is passed in, return undefined
    29|  * @example If an id of `2` is passed in, return GVL Vendor #2 (for backwards compatibility)
    30|  */
    31| export const vendorGvlEntry = (
    32|   vendorId: TCFVendorRelationships["id"],
    33|   gvl: GVLJson | undefined
    34| ) => {
    35|   if (!gvl) {
    36|     return undefined;
    37|   }
    38|   const { source, id } = decodeVendorId(vendorId);
    39|   if (source === VendorSources.GVL || source === undefined) {
    40|     return gvl.vendors[id];
    41|   }
    42|   return undefined;
    43| };
    44| export const vendorIsAc = (vendorId: TCFVendorRelationships["id"]) =>
    45|   decodeVendorId(vendorId).source === VendorSources.AC;
    46| export const uniqueGvlVendorIds = (experience: PrivacyExperience): number[] => {
    47|   const {
    48|     tcf_vendor_consents: vendorConsents = [],
    49|     tcf_vendor_legitimate_interests: vendorLegints = [],
    50|   } = experience;
    51|   const universalIds = Array.from(
    52|     new Set([
    53|       ...vendorConsents.map((v) => v.id),
    54|       ...vendorLegints.map((v) => v.id),
    55|     ])
    56|   );
    57|   const gvlIds = universalIds.filter((uid) =>
    58|     vendorGvlEntry(uid, experience.gvl)
    59|   );
    60|   return gvlIds.map((uid) => +decodeVendorId(uid).id);
    61| };
    62| const transformVendorDataToVendorRecords = ({
    63|   consents,
    64|   legints,
    65|   relationships,
    66|   isFidesSystem,
    67| }: {
    68|   consents: TCFVendorConsentRecord[];
    69|   legints: TCFVendorLegitimateInterestsRecord[];
    70|   relationships: TCFVendorRelationships[];
    71|   isFidesSystem: boolean;
    72| }) => {
    73|   const records: VendorRecord[] = [];
    74|   const uniqueVendorIds = Array.from(
    75|     new Set([...consents.map((c) => c.id), ...legints.map((l) => l.id)])
    76|   );
    77|   uniqueVendorIds.forEach((id) => {
    78|     const vendorConsent = consents.find((v) => v.id === id);
    79|     const vendorLegint = legints.find((v) => v.id === id);
    80|     const relationship = relationships.find((r) => r.id === id);
    81|     const record: VendorRecord = {
    82|       id,
    83|       ...relationship,
    84|       ...vendorConsent,
    85|       ...vendorLegint,
    86|       isFidesSystem,
    87|       isConsent: !!vendorConsent,
    88|       isLegint: !!vendorLegint,
    89|     };
    90|     records.push(record);
    91|   });
    92|   return records;
    93| };
    94| export const transformExperienceToVendorRecords = (
    95|   experience: PrivacyExperience
    96| ): VendorRecord[] => {
    97|   const {
    98|     tcf_vendor_consents: consentVendors = [],
    99|     tcf_vendor_legitimate_interests: legintVendors = [],
   100|     tcf_vendor_relationships: vendorRelationships = [],
   101|     tcf_system_consents: consentSystems = [],
   102|     tcf_system_legitimate_interests: legintSystems = [],


# ====================================================================
# FILE: clients/privacy-center/cypress/e2e/consent-banner-tcf.cy.ts
# Total hunks: 16
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| /* eslint-disable no-underscore-dangle */
     2| import {
     3|   CONSENT_COOKIE_NAME,
     4|   FidesCookie,
     5|   PrivacyExperience,
     6|   UserConsentPreference,
     7| } from "fides-js";
     8| import { stubConfig } from "../support/stubs";
     9| const PURPOSE_2 = {
    10|   id: 2,
    11|   name: "Use limited data to select advertising",
    12| };
    13| const PURPOSE_4 = {
    14|   id: 4,
    15|   name: "Use profiles to select personalised advertising",
    16| };
    17| const PURPOSE_6 = {
    18|   id: 6,
    19|   name: "Use profiles to select personalised content",
    20| };
    21| const PURPOSE_7 = {
    22|   id: 7,
    23|   name: "Measure advertising performance",
    24| };
    25| const PURPOSE_9 = {
    26|   id: 9,
    27|   name: "Understand audiences through statistics or combinations of data from different sources",
    28| };

# --- HUNK 2: Lines 38-90 ---
    38|   id: "2",
    39|   name: "Captify",
    40| };
    41| const STACK_1 = {
    42|   id: 7,
    43|   name: "Selection of personalised advertising, advertising measurement, and audience research",
    44| };
    45| const FEATURE_1 = {
    46|   id: 1,
    47|   name: "Match and combine data from other data sources",
    48| };
    49| const FEATURE_2 = {
    50|   id: 2,
    51|   name: "Link different devices",
    52| };
    53| const SPECIAL_FEATURE_1 = {
    54|   id: 1,
    55|   name: "Use precise geolocation data",
    56| };
    57| describe("Fides-js TCF", () => {
    58|   beforeEach(() => {
    59|     cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
    60|     cy.fixture("consent/experience_tcf.json").then((experience) => {
    61|       stubConfig({
    62|         options: {
    63|           isOverlayEnabled: true,
    64|           tcfEnabled: true,
    65|         },
    66|         experience: experience.items[0],
    67|       });
    68|     });
    69|   });
    70|   describe("banner appears when it should", () => {
    71|     const setAllTcfToValue = (
    72|       experience: PrivacyExperience,
    73|       value: UserConsentPreference | undefined
    74|     ): PrivacyExperience => {
    75|       const consentPurposes = experience.tcf_purpose_consents?.map((p) => ({
    76|         ...p,
    77|         current_preference: value,
    78|       }));
    79|       const legintPurposes = experience.tcf_purpose_legitimate_interests?.map(
    80|         (p) => ({ ...p, current_preference: value })
    81|       );
    82|       const specialPurposes = experience.tcf_special_purposes?.map((p) => ({
    83|         ...p,
    84|         current_preference: value,
    85|       }));
    86|       const features = experience.tcf_features?.map((f) => ({
    87|         ...f,
    88|         current_preference: value,
    89|       }));
    90|       const specialFeatures = experience.tcf_special_features?.map((f) => ({

# --- HUNK 3: Lines 149-219 ---
   149|         const updatedExperience = setAllTcfToValue(
   150|           experience,
   151|           UserConsentPreference.OPT_IN
   152|         );
   153|         updatedExperience.tcf_purpose_consents![0].current_preference =
   154|           undefined;
   155|         stubConfig({
   156|           options: {
   157|             isOverlayEnabled: true,
   158|             tcfEnabled: true,
   159|           },
   160|           experience: updatedExperience,
   161|         });
   162|         cy.waitUntilFidesInitialized().then(() => {
   163|           cy.get("div#fides-banner");
   164|         });
   165|       });
   166|     });
   167|   });
   168|   describe("initial layer", () => {
   169|     it("can render purposes in the initial layer as a stack", () => {
   170|       cy.get("div#fides-banner").within(() => {
   171|         cy.get("span").contains(STACK_1.name);
   172|         cy.get("span").contains(PURPOSE_6.name);
   173|         cy.get("span").contains(STACK_1.name).click();
   174|         [PURPOSE_4.id, PURPOSE_9.id, PURPOSE_7.id, PURPOSE_2.id].forEach(
   175|           (id) => {
   176|             cy.get("li").contains(`Purpose ${id}`);
   177|           }
   178|         );
   179|       });
   180|     });
   181|     it("can open the modal", () => {
   182|       cy.get("div#fides-banner").within(() => {
   183|         cy.get("#fides-button-group").within(() => {
   184|           cy.get("button").contains("Manage preferences").click();
   185|         });
   186|       });
   187|       cy.get("#fides-tab-Purposes");
   188|     });
   189|     it("can open the modal from vendor information", () => {
   190|       cy.get("div#fides-banner").within(() => {
   191|         cy.get("button").contains("Vendors").click();
   192|       });
   193|       cy.get("#fides-tab-Vendors");
   194|       cy.getByTestId(`toggle-${SYSTEM_1.name}`);
   195|       cy.getByTestId(`toggle-${VENDOR_1.name}-consent`);
   196|     });
   197|   });
   198|   describe("second layer", () => {
   199|     beforeEach(() => {
   200|       cy.get("#fides-modal-link").click();
   201|     });
   202|     describe("rendering the TCF modal", () => {
   203|       it("can render tabs", () => {
   204|         cy.get("#fides-tab-Purposes");
   205|         cy.getByTestId("toggle-Purposes").within(() => {
   206|           cy.get("input").should("be.checked");
   207|         });
   208|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   209|           cy.get("input").should("be.checked");
   210|         });
   211|         cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
   212|           cy.get("input").should("be.checked");
   213|         });
   214|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
   215|           cy.get("input").should("be.checked");
   216|         });
   217|         cy.get(".fides-notice-toggle-header").contains("Special purposes");
   218|         cy.get(".fides-notice-toggle-title").contains(SPECIAL_PURPOSE_1.name);
   219|         cy.getByTestId("toggle-Special purposes").should("not.exist");

# --- HUNK 4: Lines 223-331 ---
   223|         cy.get(".fides-notice-toggle-title").contains(FEATURE_1.name);
   224|         cy.get(".fides-notice-toggle-title").contains(FEATURE_2.name);
   225|         cy.getByTestId(`toggle-${FEATURE_1.name}`).should("not.exist");
   226|         cy.getByTestId(`toggle-${FEATURE_2.name}`).should("not.exist");
   227|         cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
   228|           cy.get("input").should("not.be.checked");
   229|         });
   230|         cy.get("#fides-tab-Vendors").click();
   231|         cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
   232|           cy.get("input").should("be.checked");
   233|         });
   234|       });
   235|       it("can render IAB TCF badge on vendors and filter", () => {
   236|         const newVendor = {
   237|           id: "gvl.1",
   238|           name: "Exponential Interactive, Inc d/b/a VDX.tv",
   239|         };
   240|         cy.fixture("consent/experience_tcf.json").then((payload) => {
   241|           const experience = payload.items[0];
   242|           experience.tcf_vendor_consents.push(newVendor);
   243|           stubConfig({
   244|             options: {
   245|               isOverlayEnabled: true,
   246|               tcfEnabled: true,
   247|             },
   248|             experience,
   249|           });
   250|         });
   251|         cy.get("#fides-modal-link").click();
   252|         cy.get("#fides-tab-Vendors").click();
   253|         cy.get("span")
   254|           .contains(SYSTEM_1.name)
   255|           .within(() => {
   256|             cy.get("span").should("not.exist");
   257|           });
   258|         cy.get("span")
   259|           .contains(VENDOR_1.name)
   260|           .within(() => {
   261|             cy.get("span").contains("IAB TCF");
   262|           });
   263|         cy.get("span")
   264|           .contains(newVendor.name)
   265|           .within(() => {
   266|             cy.get("span").contains("IAB TCF");
   267|           });
   268|         cy.get(".fides-filter-button-group").within(() => {
   269|           cy.get("button").contains("IAB TCF vendors").click();
   270|         });
   271|         cy.get("span").contains(SYSTEM_1.name).should("not.exist");
   272|         cy.get("span").contains(VENDOR_1.name);
   273|         cy.get("span").contains(newVendor.name);
   274|         cy.getByTestId("consent-modal").within(() => {
   275|           cy.get("button").contains("Opt in to all").click();
   276|         });
   277|         cy.window().then((win) => {
   278|           win.__tcfapi("getTCData", 2, cy.stub().as("getTCData"));
   279|         });
   280|         cy.get("@getTCData")
   281|           .should("have.been.calledOnce")
   282|           .its("lastCall.args")
   283|           .then(([tcData, success]) => {
   284|             expect(success).to.eql(true);
   285|             expect(tcData.vendor.consents).to.eql({ 1: true, 2: true });
   286|           });
   287|       });
   288|       it("can group toggle", () => {
   289|         cy.getByTestId("toggle-Purposes").click();
   290|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
   291|           cy.get("input").should("not.be.checked");
   292|         });
   293|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).click();
   294|         cy.getByTestId("toggle-Purposes").within(() => {
   295|           cy.get("input").should("be.checked");
   296|         });
   297|         cy.getByTestId("toggle-all-Purposes-consent").click();
   298|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   299|           cy.get("input").should("not.be.checked");
   300|         });
   301|         cy.getByTestId("toggle-all-Purposes-consent").click();
   302|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   303|           cy.get("input").should("be.checked");
   304|         });
   305|         cy.get("button").contains("All off").click();
   306|         cy.getByTestId(`toggle-${PURPOSE_2.name}`).within(() => {
   307|           cy.get("input").should("not.be.checked");
   308|         });
   309|         cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   310|           cy.get("input").should("not.be.checked");
   311|         });
   312|       });
   313|       it("can handle group toggle empty states", () => {
   314|         cy.fixture("consent/experience_tcf.json").then((payload) => {
   315|           const experience = payload.items[0];
   316|           const updatedExperience = { ...experience, tcf_purpose_consents: [] };
   317|           stubConfig({
   318|             options: {
   319|               isOverlayEnabled: true,
   320|               tcfEnabled: true,
   321|             },
   322|             experience: updatedExperience,
   323|           });
   324|           cy.waitUntilFidesInitialized().then(() => {
   325|             cy.get("#fides-modal-link").click();
   326|             cy.getByTestId(`toggle-all-Purposes-consent`).should("not.exist");
   327|           });
   328|         });
   329|       });
   330|       it("can handle all on/all off empty states", () => {
   331|         cy.fixture("consent/experience_tcf.json").then((payload) => {

# --- HUNK 5: Lines 364-414 ---
   364|             ...experience,
   365|             tcf_vendor_legitimate_interests,
   366|           };
   367|           stubConfig({
   368|             options: {
   369|               isOverlayEnabled: true,
   370|               tcfEnabled: true,
   371|             },
   372|             experience: updatedExperience,
   373|           });
   374|           cy.waitUntilFidesInitialized().then(() => {
   375|             cy.get("#fides-modal-link").click();
   376|             cy.get("#fides-tab-Vendors").click();
   377|             cy.getByTestId(`toggle-${VENDOR_1.name}`).click();
   378|             cy.getByTestId(`toggle-${VENDOR_1.name}`).within(() => {
   379|               cy.get("input").should("not.be.checked");
   380|             });
   381|             cy.getByTestId(`toggle-${VENDOR_1.name}-consent`).within(() => {
   382|               cy.get("input").should("not.be.checked");
   383|             });
   384|           });
   385|         });
   386|       });
   387|     });
   388|     describe("saving preferences", () => {
   389|       const expectedEndOfFidesString = ".IABE,1~";
   390|       it("can opt in to all", () => {
   391|         cy.getCookie(CONSENT_COOKIE_NAME).should("not.exist");
   392|         cy.getByTestId("consent-modal").within(() => {
   393|           cy.get("button").contains("Opt in to all").click();
   394|           cy.wait("@patchPrivacyPreference").then((interception) => {
   395|             const { body } = interception.request;
   396|             expect(body.purpose_consent_preferences).to.eql([
   397|               { id: PURPOSE_4.id, preference: "opt_in" },
   398|               { id: PURPOSE_6.id, preference: "opt_in" },
   399|               { id: PURPOSE_7.id, preference: "opt_in" },
   400|               { id: PURPOSE_9.id, preference: "opt_in" },
   401|             ]);
   402|             expect(body.purpose_legitimate_interests_preferences).to.eql([
   403|               { id: PURPOSE_2.id, preference: "opt_in" },
   404|             ]);
   405|             expect(body.special_purpose_preferences).to.eql(undefined);
   406|             expect(body.feature_preferences).to.eql(undefined);
   407|             expect(body.special_feature_preferences).to.eql([
   408|               { id: SPECIAL_FEATURE_1.id, preference: "opt_in" },
   409|             ]);
   410|             expect(body.vendor_consent_preferences).to.eql([
   411|               { id: VENDOR_1.id, preference: "opt_in" },
   412|             ]);
   413|             expect(body.vendor_legitimate_interests_preferences).to.eql([]);
   414|             expect(body.system_legitimate_interests_preferences).to.eql([

# --- HUNK 6: Lines 435-482 ---
   435|             .property(`${PURPOSE_2.id}`)
   436|             .is.eql(true);
   437|           expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   438|             .property(`${SPECIAL_FEATURE_1.id}`)
   439|             .is.eql(true);
   440|           expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   441|             .property(`${VENDOR_1.id}`)
   442|             .is.eql(true);
   443|           expect(
   444|             cookieKeyConsent.tcf_consent.vendor_legitimate_interests_preferences
   445|           ).to.eql({});
   446|           expect(
   447|             cookieKeyConsent.tcf_consent.system_consent_preferences
   448|           ).to.eql({});
   449|           expect(
   450|             cookieKeyConsent.tcf_consent.system_legitimate_interests_preferences
   451|           )
   452|             .property(`${SYSTEM_1.id}`)
   453|             .is.eql(true);
   454|           expect(
   455|             cookieKeyConsent.fides_tc_string?.endsWith(expectedEndOfFidesString)
   456|           ).to.eql(true);
   457|         });
   458|       });
   459|       it("can opt out of all", () => {
   460|         cy.getByTestId("consent-modal").within(() => {
   461|           cy.get("button").contains("Opt out of all").click();
   462|           cy.wait("@patchPrivacyPreference").then((interception) => {
   463|             const { body } = interception.request;
   464|             expect(body.purpose_consent_preferences).to.eql([
   465|               { id: PURPOSE_4.id, preference: "opt_out" },
   466|               { id: PURPOSE_6.id, preference: "opt_out" },
   467|               { id: PURPOSE_7.id, preference: "opt_out" },
   468|               { id: PURPOSE_9.id, preference: "opt_out" },
   469|             ]);
   470|             expect(body.purpose_legitimate_interests_preferences).to.eql([
   471|               { id: PURPOSE_2.id, preference: "opt_out" },
   472|             ]);
   473|             expect(body.special_purpose_preferences).to.eql(undefined);
   474|             expect(body.feature_preferences).to.eql(undefined);
   475|             expect(body.special_feature_preferences).to.eql([
   476|               { id: SPECIAL_FEATURE_1.id, preference: "opt_out" },
   477|             ]);
   478|             expect(body.vendor_consent_preferences).to.eql([
   479|               { id: VENDOR_1.id, preference: "opt_out" },
   480|             ]);
   481|             expect(body.vendor_legitimate_interests_preferences).to.eql([]);
   482|             expect(body.system_legitimate_interests_preferences).to.eql([

# --- HUNK 7: Lines 503-554 ---
   503|             .property(`${PURPOSE_2.id}`)
   504|             .is.eql(false);
   505|           expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   506|             .property(`${SPECIAL_FEATURE_1.id}`)
   507|             .is.eql(false);
   508|           expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   509|             .property(`${VENDOR_1.id}`)
   510|             .is.eql(false);
   511|           expect(
   512|             cookieKeyConsent.tcf_consent.vendor_legitimate_interests_preferences
   513|           ).to.eql({});
   514|           expect(
   515|             cookieKeyConsent.tcf_consent.system_consent_preferences
   516|           ).to.eql({});
   517|           expect(
   518|             cookieKeyConsent.tcf_consent.system_legitimate_interests_preferences
   519|           )
   520|             .property(`${SYSTEM_1.id}`)
   521|             .is.eql(false);
   522|           expect(
   523|             cookieKeyConsent.fides_tc_string?.endsWith(expectedEndOfFidesString)
   524|           ).to.eql(true);
   525|         });
   526|       });
   527|       it("can opt in to some and opt out of others", () => {
   528|         cy.getByTestId("consent-modal").within(() => {
   529|           cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).click();
   530|           cy.get("#fides-tab-Features").click();
   531|           cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).click();
   532|           cy.get("#fides-tab-Vendors").click();
   533|           cy.getByTestId(`toggle-${SYSTEM_1.name}`).click();
   534|           cy.get("button").contains("Save").click();
   535|           cy.wait("@patchPrivacyPreference").then((interception) => {
   536|             const { body } = interception.request;
   537|             expect(body.purpose_consent_preferences).to.eql([
   538|               { id: PURPOSE_4.id, preference: "opt_out" },
   539|               { id: PURPOSE_6.id, preference: "opt_in" },
   540|               { id: PURPOSE_7.id, preference: "opt_in" },
   541|               { id: PURPOSE_9.id, preference: "opt_in" },
   542|             ]);
   543|             expect(body.purpose_legitimate_interests_preferences).to.eql([
   544|               { id: PURPOSE_2.id, preference: "opt_in" },
   545|             ]);
   546|             expect(body.special_purpose_preferences).to.eql(undefined);
   547|             expect(body.feature_preferences).to.eql(undefined);
   548|             expect(body.special_feature_preferences).to.eql([
   549|               { id: SPECIAL_FEATURE_1.id, preference: "opt_in" },
   550|             ]);
   551|             expect(body.vendor_consent_preferences).to.eql([
   552|               { id: VENDOR_1.id, preference: "opt_out" },
   553|             ]);
   554|             expect(body.vendor_legitimate_interests_preferences).to.eql([]);

# --- HUNK 8: Lines 577-624 ---
   577|             .property(`${PURPOSE_4.id}`)
   578|             .is.eql(false);
   579|           expect(cookieKeyConsent.tcf_consent.special_feature_preferences)
   580|             .property(`${SPECIAL_FEATURE_1.id}`)
   581|             .is.eql(true);
   582|           expect(cookieKeyConsent.tcf_consent.vendor_consent_preferences)
   583|             .property(`${VENDOR_1.id}`)
   584|             .is.eql(false);
   585|           expect(
   586|             cookieKeyConsent.tcf_consent.vendor_legitimate_interests_preferences
   587|           ).to.eql({});
   588|           expect(
   589|             cookieKeyConsent.tcf_consent.system_legitimate_interests_preferences
   590|           )
   591|             .property(`${SYSTEM_1.id}`)
   592|             .is.eql(false);
   593|           expect(
   594|             cookieKeyConsent.tcf_consent.system_consent_preferences
   595|           ).to.eql({});
   596|           expect(
   597|             cookieKeyConsent.fides_tc_string?.endsWith(expectedEndOfFidesString)
   598|           ).to.eql(true);
   599|         });
   600|       });
   601|     });
   602|   });
   603|   describe("cmp api", () => {
   604|     beforeEach(() => {
   605|       cy.window().then((win) => {
   606|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
   607|       });
   608|       cy.get("#fides-modal-link").click();
   609|     });
   610|     it("can receive a cmpuishown event", () => {
   611|       cy.get("@TCFEvent")
   612|         .its("firstCall.args")
   613|         .then(([tcData, success]) => {
   614|           expect(success).to.eql(true);
   615|           expect(tcData.eventStatus === "cmpuishown");
   616|         });
   617|     });
   618|     describe("setting fields", () => {
   619|       it("can opt in to all and set legitimate interests", () => {
   620|         cy.getByTestId("consent-modal").within(() => {
   621|           cy.get("button").contains("Opt in to all").click();
   622|         });
   623|         cy.get("@TCFEvent")
   624|           .its("lastCall.args")

# --- HUNK 9: Lines 631-682 ---
   631|               [PURPOSE_6.id]: true,
   632|               [PURPOSE_7.id]: true,
   633|               1: false,
   634|               2: false,
   635|               3: false,
   636|               5: false,
   637|               8: false,
   638|             });
   639|             expect(tcData.purpose.legitimateInterests).to.eql({
   640|               [PURPOSE_2.id]: true,
   641|               1: false,
   642|             });
   643|             expect(tcData.vendor.consents).to.eql({
   644|               1: false,
   645|               [VENDOR_1.id]: true,
   646|             });
   647|             expect(tcData.vendor.legitimateInterests).to.eql({});
   648|           });
   649|       });
   650|       it("can handle inappropriate legint purposes", () => {
   651|         cy.fixture("consent/experience_tcf.json").then((payload) => {
   652|           const experience: PrivacyExperience = payload.items[0];
   653|           const purpose4 = experience.tcf_purpose_consents?.find(
   654|             (p) => p.id === 4
   655|           )!;
   656|           experience.tcf_purpose_legitimate_interests?.push(purpose4);
   657|           const vendor = experience.tcf_purpose_consents![0];
   658|           experience.tcf_vendor_legitimate_interests?.push({
   659|             ...vendor,
   660|             id: "test",
   661|             purpose_legitimate_interests: [{ id: 4, name: purpose4.name }],
   662|           });
   663|           stubConfig({
   664|             options: {
   665|               isOverlayEnabled: true,
   666|               tcfEnabled: true,
   667|             },
   668|             experience,
   669|           });
   670|         });
   671|         cy.window().then((win) => {
   672|           win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent2"));
   673|         });
   674|         cy.get("#fides-modal-link").click();
   675|         cy.getByTestId("consent-modal").within(() => {
   676|           cy.get("button").contains("Opt in to all").click();
   677|         });
   678|         cy.get("@TCFEvent2")
   679|           .its("lastCall.args")
   680|           .then(([tcData, success]) => {
   681|             expect(success).to.eql(true);
   682|             expect(tcData.eventStatus).to.eql("useractioncomplete");

# --- HUNK 10: Lines 687-898 ---
   687|               [PURPOSE_7.id]: true,
   688|               1: false,
   689|               2: false,
   690|               3: false,
   691|               5: false,
   692|               8: false,
   693|             });
   694|             expect(tcData.purpose.legitimateInterests).to.eql({
   695|               [PURPOSE_2.id]: true,
   696|               1: false,
   697|             });
   698|             expect(tcData.vendor.consents).to.eql({
   699|               1: false,
   700|               [VENDOR_1.id]: true,
   701|             });
   702|             expect(tcData.vendor.legitimateInterests).to.eql({});
   703|           });
   704|       });
   705|     });
   706|   });
   707|   describe("cookie interactions", () => {
   708|     it("can initialize preferences from a cookie", () => {
   709|       /**
   710|        * The default from the fixture is that
   711|        *   - all purposes are opted in
   712|        *   - all special purposes are opted in
   713|        *   - feature 1 is opted out, feature 2 has no preference
   714|        *   - all vendors are opted in
   715|        *   - all systems are opted in
   716|        *
   717|        * We'll change at least one value from each entity type in the cookie
   718|        */
   719|       const uuid = "4fbb6edf-34f6-4717-a6f1-541fd1e5d585";
   720|       const CREATED_DATE = "2022-12-24T12:00:00.000Z";
   721|       const UPDATED_DATE = "2022-12-25T12:00:00.000Z";
   722|       const cookie = {
   723|         identity: { fides_user_device_id: uuid },
   724|         fides_meta: {
   725|           version: "0.9.0",
   726|           createdAt: CREATED_DATE,
   727|           updatedAt: UPDATED_DATE,
   728|         },
   729|         consent: {},
   730|         tcf_consent: {
   731|           purpose_consent_preferences: {
   732|             [PURPOSE_4.id]: false,
   733|             [PURPOSE_9.id]: true,
   734|           },
   735|           special_feature_preferences: { [SPECIAL_FEATURE_1.id]: true },
   736|           system_legitimate_interests_preferences: { [SYSTEM_1.id]: false },
   737|           vendor_consent_preferences: { [VENDOR_1.id]: true },
   738|         },
   739|       };
   740|       cy.setCookie(CONSENT_COOKIE_NAME, JSON.stringify(cookie));
   741|       cy.fixture("consent/experience_tcf.json").then((experience) => {
   742|         stubConfig({
   743|           options: {
   744|             isOverlayEnabled: true,
   745|             tcfEnabled: true,
   746|           },
   747|           experience: experience.items[0],
   748|         });
   749|       });
   750|       cy.get("#fides-modal-link").click();
   751|       cy.getByTestId(`toggle-${PURPOSE_4.name}-consent`).within(() => {
   752|         cy.get("input").should("not.be.checked");
   753|       });
   754|       cy.getByTestId(`toggle-${PURPOSE_9.name}-consent`).within(() => {
   755|         cy.get("input").should("be.checked");
   756|       });
   757|       cy.getByTestId(`toggle-${PURPOSE_6.name}-consent`).within(() => {
   758|         cy.get("input").should("not.be.checked");
   759|       });
   760|       cy.get("#fides-tab-Features").click();
   761|       cy.getByTestId(`toggle-${SPECIAL_FEATURE_1.name}`).within(() => {
   762|         cy.get("input").should("be.checked");
   763|       });
   764|       cy.get("#fides-tab-Vendors").click();
   765|       cy.getByTestId(`toggle-${SYSTEM_1.name}`).within(() => {
   766|         cy.get("input").should("not.be.checked");
   767|       });
   768|       cy.getByTestId(`toggle-${VENDOR_1.name}-consent`).within(() => {
   769|         cy.get("input").should("be.checked");
   770|       });
   771|     });
   772|   });
   773|   describe("ac string", () => {
   774|     const AC_IDS = [42, 33, 49];
   775|     const acceptAllAcString = `1~${AC_IDS.sort().join(".")}`;
   776|     const rejectAllAcString = "1~";
   777|     beforeEach(() => {
   778|       cy.fixture("consent/experience_tcf.json").then((payload) => {
   779|         const experience = payload.items[0];
   780|         const baseVendor = {
   781|           id: "2",
   782|           has_vendor_id: true,
   783|           name: "Test",
   784|           description: "A longer description",
   785|           default_preference: "opt_out",
   786|           current_preference: null,
   787|           outdated_preference: null,
   788|           current_served: null,
   789|           outdated_served: null,
   790|           purpose_consents: [
   791|             {
   792|               id: 4,
   793|               name: "Use profiles to select personalised advertising",
   794|             },
   795|           ],
   796|         };
   797|         AC_IDS.forEach((id, idx) => {
   798|           experience.tcf_vendor_consents.push({
   799|             ...baseVendor,
   800|             id: `gacp.${id}`,
   801|             name: `AC ${id}`,
   802|             purpose_consents: idx % 2 === 0 ? [] : baseVendor.purpose_consents,
   803|           });
   804|         });
   805|         stubConfig({
   806|           options: {
   807|             isOverlayEnabled: true,
   808|             tcfEnabled: true,
   809|           },
   810|           experience,
   811|         });
   812|       });
   813|       cy.get("#fides-modal-link").click();
   814|     });
   815|     it("can opt in to AC vendors and generate string", () => {
   816|       cy.get("#fides-tab-Vendors").click();
   817|       AC_IDS.forEach((id) => {
   818|         cy.getByTestId(`toggle-AC ${id}-consent`);
   819|       });
   820|       cy.get("section#fides-panel-Vendors").within(() => {
   821|         cy.get("button").contains("All on").click();
   822|       });
   823|       cy.get("button").contains("Save").click();
   824|       cy.wait("@patchPrivacyPreference").then((interception) => {
   825|         const { body } = interception.request;
   826|         const expected = [
   827|           { id: VENDOR_1.id, preference: "opt_in" },
   828|           ...AC_IDS.map((id) => ({ id: `gacp.${id}`, preference: "opt_in" })),
   829|         ];
   830|         expect(body.vendor_consent_preferences).to.eql(expected);
   831|         cy.getCookie(CONSENT_COOKIE_NAME).then((cookie) => {
   832|           const cookieKeyConsent: FidesCookie = JSON.parse(
   833|             decodeURIComponent(cookie!.value)
   834|           );
   835|           const { fides_tc_string: tcString } = cookieKeyConsent;
   836|           const acString = tcString?.split(",")[1];
   837|           expect(acString).to.eql(acceptAllAcString);
   838|         });
   839|       });
   840|     });
   841|     it("can opt out of AC vendors and generate string", () => {
   842|       cy.get("#fides-tab-Vendors").click();
   843|       cy.get("section#fides-panel-Vendors").within(() => {
   844|         cy.get("button").contains("All off").click();
   845|       });
   846|       cy.get("button").contains("Save").click();
   847|       cy.wait("@patchPrivacyPreference").then((interception) => {
   848|         const { body } = interception.request;
   849|         const expected = [
   850|           { id: VENDOR_1.id, preference: "opt_out" },
   851|           ...AC_IDS.map((id) => ({ id: `gacp.${id}`, preference: "opt_out" })),
   852|         ];
   853|         expect(body.vendor_consent_preferences).to.eql(expected);
   854|         cy.getCookie(CONSENT_COOKIE_NAME).then((cookie) => {
   855|           const cookieKeyConsent: FidesCookie = JSON.parse(
   856|             decodeURIComponent(cookie!.value)
   857|           );
   858|           const { fides_tc_string: tcString } = cookieKeyConsent;
   859|           const acString = tcString?.split(",")[1];
   860|           expect(acString).to.eql(rejectAllAcString);
   861|         });
   862|       });
   863|     });
   864|     it("can emit FidesEvent with composite string but CMP API without", () => {
   865|       cy.window().then((win) => {
   866|         win.__tcfapi("addEventListener", 2, cy.stub().as("TCFEvent"));
   867|       });
   868|       cy.get("#fides-tab-Vendors").click();
   869|       cy.get("section#fides-panel-Vendors").within(() => {
   870|         cy.get("button").contains("All on").click();
   871|       });
   872|       cy.get("button").contains("Save").click();
   873|       cy.wait("@patchPrivacyPreference");
   874|       cy.get("@FidesUpdated")
   875|         .should("have.been.calledTwice")
   876|         .its("secondCall.args.0.detail.fides_tc_string")
   877|         .then((fidesTcString) => {
   878|           const parts = fidesTcString.split(",");
   879|           expect(parts.length).to.eql(2);
   880|           expect(parts[1]).to.eql(acceptAllAcString);
   881|         });
   882|       cy.get("@TCFEvent")
   883|         .its("lastCall.args")
   884|         .then(([tcData, success]) => {
   885|           expect(success).to.eql(true);
   886|           expect(tcData.eventStatus).to.eql("useractioncomplete");
   887|           const { tcString } = tcData;
   888|           const parts = tcString.split(",");
   889|           expect(parts.length).to.eql(1);
   890|           expect(parts[0]).to.not.contain("1~");
   891|           expect(tcData.addtlConsent).to.eql(acceptAllAcString);
   892|         });
   893|     });
   894|     it("can get `addtlConsents` from getTCData custom function", () => {
   895|       cy.get("#fides-tab-Vendors").click();
   896|       cy.get("section#fides-panel-Vendors").within(() => {
   897|         cy.get("button").contains("All on").click();
   898|       });


# ====================================================================
# FILE: src/fides/api/api/v1/endpoints/privacy_preference_endpoints.py
# Total hunks: 6
# ====================================================================
# --- HUNK 1: Lines 6-104 ---
     6| from fastapi_pagination import Page, Params
     7| from fastapi_pagination.bases import AbstractPage
     8| from fastapi_pagination.ext.sqlalchemy import paginate
     9| from loguru import logger
    10| from sqlalchemy import literal
    11| from sqlalchemy.orm import Query, Session
    12| from starlette.status import (
    13|     HTTP_200_OK,
    14|     HTTP_400_BAD_REQUEST,
    15|     HTTP_404_NOT_FOUND,
    16|     HTTP_422_UNPROCESSABLE_ENTITY,
    17| )
    18| from fides.api.api.deps import get_db
    19| from fides.api.api.v1.endpoints.consent_request_endpoints import (
    20|     _get_consent_request_and_provided_identity,
    21| )
    22| from fides.api.api.v1.endpoints.privacy_request_endpoints import (
    23|     create_privacy_request_func,
    24| )
    25| from fides.api.common_exceptions import (
    26|     DecodeTCStringError,
    27|     IdentityNotFoundException,
    28|     PrivacyNoticeHistoryNotFound,
    29|     SystemNotFound,
    30| )
    31| from fides.api.custom_types import SafeStr
    32| from fides.api.db.seed import DEFAULT_CONSENT_POLICY
    33| from fides.api.models.fides_user import FidesUser
    34| from fides.api.models.privacy_experience import PrivacyExperience
    35| from fides.api.models.privacy_notice import (
    36|     EnforcementLevel,
    37|     PrivacyNotice,
    38|     PrivacyNoticeHistory,
    39| )
    40| from fides.api.models.privacy_preference import (
    41|     CurrentPrivacyPreference,
    42|     PrivacyPreferenceHistory,
    43|     RequestOrigin,
    44|     ServedNoticeHistory,
    45| )
    46| from fides.api.models.privacy_request import (
    47|     ConsentRequest,
    48|     PrivacyRequest,
    49|     ProvidedIdentity,
    50|     ProvidedIdentityType,
    51| )
    52| from fides.api.oauth.utils import verify_oauth_client
    53| from fides.api.schemas.privacy_preference import (
    54|     TCF_PREFERENCES_FIELD_MAPPING,
    55|     ConsentOptionCreate,
    56|     ConsentReportingSchema,
    57|     CurrentPrivacyPreferenceReportingSchema,
    58|     CurrentPrivacyPreferenceSchema,
    59|     PrivacyPreferencesCreate,
    60|     PrivacyPreferencesRequest,
    61|     RecordConsentServedCreate,
    62|     RecordConsentServedRequest,
    63|     SavePrivacyPreferencesResponse,
    64|     TCStringFidesPreferences,
    65| )
    66| from fides.api.schemas.privacy_request import (
    67|     BulkPostPrivacyRequests,
    68|     PrivacyRequestCreate,
    69|     VerificationCode,
    70| )
    71| from fides.api.schemas.redis_cache import Identity
    72| from fides.api.schemas.tcf import (
    73|     TCFFeatureSave,
    74|     TCFPurposeSave,
    75|     TCFSpecialFeatureSave,
    76|     TCFSpecialPurposeSave,
    77|     TCFVendorSave,
    78| )
    79| from fides.api.util.api_router import APIRouter
    80| from fides.api.util.consent_util import (
    81|     get_or_create_fides_user_device_id_provided_identity,
    82| )
    83| from fides.api.util.endpoint_utils import fides_limiter, validate_start_and_end_filters
    84| from fides.api.util.tcf.tc_mobile_data import convert_tc_string_to_mobile_data
    85| from fides.api.util.tcf.tc_string import decode_tc_string_to_preferences
    86| from fides.api.util.tcf.tcf_experience_contents import (
    87|     TCFExperienceContents,
    88|     get_tcf_contents,
    89| )
    90| from fides.common.api.scope_registry import (
    91|     CURRENT_PRIVACY_PREFERENCE_READ,
    92|     PRIVACY_PREFERENCE_HISTORY_READ,
    93| )
    94| from fides.common.api.v1.urn_registry import (
    95|     CONSENT_REQUEST_PRIVACY_PREFERENCES_VERIFY,
    96|     CONSENT_REQUEST_PRIVACY_PREFERENCES_WITH_ID,
    97|     CURRENT_PRIVACY_PREFERENCES_REPORT,
    98|     HISTORICAL_PRIVACY_PREFERENCES_REPORT,
    99|     PRIVACY_PREFERENCES,
   100|     V1_URL_PREFIX,
   101| )
   102| from fides.config import CONFIG
   103| from fides.config.config_proxy import ConfigProxy
   104| router = APIRouter(tags=["Privacy Preference"], prefix=V1_URL_PREFIX)

# --- HUNK 2: Lines 271-353 ---
   271| @router.patch(
   272|     CONSENT_REQUEST_PRIVACY_PREFERENCES_WITH_ID,
   273|     status_code=HTTP_200_OK,
   274|     response_model=SavePrivacyPreferencesResponse,
   275| )
   276| def save_privacy_preferences_with_verified_identity(
   277|     *,
   278|     consent_request_id: str,
   279|     db: Session = Depends(get_db),
   280|     data: PrivacyPreferencesRequest,
   281|     request: Request,
   282| ) -> SavePrivacyPreferencesResponse:
   283|     """Saves privacy preferences in the privacy center.
   284|     The ConsentRequest may have been created under an email, phone number, *or* fides user device id.
   285|     Preferences can be saved under both an email *and* a fides user device id, if the email was persisted
   286|     with the ConsentRequest and the fides user device id is passed in with this secondary request.
   287|     Creates historical records for these preferences for record keeping, and also updates current preferences.
   288|     Creates a privacy request to propagate preferences to third party systems where applicable.
   289|     """
   290|     fides_string: Optional[str] = data.fides_string
   291|     data = update_request_with_decoded_tc_string_fields(data, db)
   292|     verify_privacy_notice_and_historical_records(
   293|         db=db,
   294|         notice_history_list=[
   295|             consent_option.privacy_notice_history_id
   296|             for consent_option in data.preferences
   297|         ],
   298|     )
   299|     verify_previously_served_records(db, data)
   300|     consent_request, provided_identity = _get_consent_request_and_provided_identity(
   301|         db=db,
   302|         consent_request_id=consent_request_id,
   303|         verification_code=data.code,
   304|     )
   305|     (
   306|         provided_identity_verified,
   307|         fides_user_provided_identity,
   308|     ) = classify_identity_type_for_privacy_center_consent_reporting(
   309|         db=db,
   310|         provided_identity=provided_identity,
   311|         browser_identity=data.browser_identity,
   312|     )
   313|     logger.info("Saving privacy preferences")
   314|     try:
   315|         saved_preferences_response: SavePrivacyPreferencesResponse = (
   316|             save_privacy_preferences_for_identities(
   317|                 db=db,
   318|                 consent_request=consent_request,
   319|                 verified_provided_identity=provided_identity_verified,
   320|                 fides_user_provided_identity=fides_user_provided_identity,
   321|                 request=request,
   322|                 original_request_data=data,
   323|             )
   324|         )
   325|         saved_preferences_response.fides_mobile_data = convert_tc_string_to_mobile_data(
   326|             fides_string
   327|         )
   328|         return saved_preferences_response
   329|     except (
   330|         IdentityNotFoundException,
   331|         PrivacyNoticeHistoryNotFound,
   332|         SystemNotFound,
   333|         DecodeTCStringError,
   334|     ) as exc:
   335|         raise HTTPException(status_code=400, detail=exc.args[0])
   336| def persist_tcf_preferences(
   337|     db: Session,
   338|     user_data: Dict[str, str],
   339|     request_data: PrivacyPreferencesRequest,
   340|     saved_preferences_response: SavePrivacyPreferencesResponse,
   341| ) -> None:
   342|     """Save TCF preferences with respect to individual TCF components if applicable.
   343|     All TCF Preferences have frontend-only enforcement at the moment, so no Privacy Requests
   344|     are created to propagate consent. The "upserted_current_preferences" list is updated in place.
   345|     """
   346|     if not CONFIG.consent.tcf_enabled:
   347|         return
   348|     def save_tcf_preference(
   349|         component_type: str,
   350|         preference_request: Union[
   351|             TCFPurposeSave,
   352|             TCFSpecialPurposeSave,
   353|             TCFVendorSave,

# --- HUNK 3: Lines 578-692 ---
   578|         ):
   579|             raise HTTPException(
   580|                 status_code=HTTP_422_UNPROCESSABLE_ENTITY,
   581|                 detail=f"The ServedNoticeHistory record '{served_notice_history.id}' did not serve the {name_for_log} '{getattr(preference_record, saved_preference_field)}'.",
   582|             )
   583|     for preference in data.preferences:
   584|         validate_served_record(
   585|             preference_record=preference,
   586|             served_record_field="privacy_notice_history_id",
   587|             saved_preference_field="privacy_notice_history_id",
   588|             name_for_log="privacy notice history",
   589|         )
   590|     for tcf_preference_type, field_name in TCF_PREFERENCES_FIELD_MAPPING.items():
   591|         for preference in getattr(data, tcf_preference_type):
   592|             validate_served_record(
   593|                 preference_record=preference,
   594|                 served_record_field=field_name,
   595|                 saved_preference_field="id",
   596|                 name_for_log=field_name,
   597|             )
   598| def update_request_with_decoded_tc_string_fields(
   599|     request_body: PrivacyPreferencesRequest, db: Session
   600| ) -> PrivacyPreferencesRequest:
   601|     """Update the request body with the decoded values of the TC string if applicable"""
   602|     if request_body.fides_string:
   603|         tcf_contents: TCFExperienceContents = get_tcf_contents(
   604|             db
   605|         )  # TODO cache this so we're not building each time privacy preference is saved
   606|         try:
   607|             decoded_preference_request_body: TCStringFidesPreferences = (
   608|                 decode_tc_string_to_preferences(request_body.fides_string, tcf_contents)
   609|             )
   610|         except DecodeTCStringError as exc:
   611|             raise HTTPException(status_code=HTTP_400_BAD_REQUEST, detail=exc.args[0])
   612|         request_body.fides_string = None
   613|         for decoded_tcf_section in decoded_preference_request_body.__fields__:
   614|             setattr(
   615|                 request_body,
   616|                 decoded_tcf_section,
   617|                 getattr(decoded_preference_request_body, decoded_tcf_section),
   618|             )
   619|     return request_body
   620| @router.patch(
   621|     PRIVACY_PREFERENCES,
   622|     status_code=HTTP_200_OK,
   623|     response_model=SavePrivacyPreferencesResponse,
   624| )
   625| @fides_limiter.limit(CONFIG.security.public_request_rate_limit)
   626| def save_privacy_preferences(
   627|     *,
   628|     db: Session = Depends(get_db),
   629|     data: PrivacyPreferencesRequest,
   630|     request: Request,
   631|     response: Response,  # required for rate limiting
   632| ) -> SavePrivacyPreferencesResponse:
   633|     """Saves privacy preferences with respect to a fides user device id.
   634|     Creates historical records for these preferences for record keeping, and also updates current preferences.
   635|     Creates a privacy request to propagate preferences to third party systems if applicable.
   636|     """
   637|     fides_string: Optional[str] = data.fides_string
   638|     data = update_request_with_decoded_tc_string_fields(data, db)
   639|     verify_privacy_notice_and_historical_records(
   640|         db=db,
   641|         notice_history_list=[
   642|             consent_option.privacy_notice_history_id
   643|             for consent_option in data.preferences
   644|         ],
   645|     )
   646|     verify_previously_served_records(db, data)
   647|     fides_user_provided_identity: ProvidedIdentity = (
   648|         get_or_create_fides_user_device_id_provided_identity(
   649|             db=db, identity_data=data.browser_identity
   650|         )
   651|     )
   652|     logger.info("Saving privacy preferences with respect to fides user device id")
   653|     try:
   654|         saved_preferences_response: SavePrivacyPreferencesResponse = (
   655|             save_privacy_preferences_for_identities(
   656|                 db=db,
   657|                 consent_request=None,
   658|                 verified_provided_identity=None,
   659|                 fides_user_provided_identity=fides_user_provided_identity,
   660|                 request=request,
   661|                 original_request_data=data,
   662|             )
   663|         )
   664|         saved_preferences_response.fides_mobile_data = convert_tc_string_to_mobile_data(
   665|             fides_string
   666|         )
   667|         return saved_preferences_response
   668|     except (
   669|         IdentityNotFoundException,
   670|         PrivacyNoticeHistoryNotFound,
   671|         SystemNotFound,
   672|         DecodeTCStringError,
   673|     ) as exc:
   674|         raise HTTPException(status_code=400, detail=exc.args[0])
   675| @router.get(
   676|     CURRENT_PRIVACY_PREFERENCES_REPORT,
   677|     status_code=HTTP_200_OK,
   678|     dependencies=[
   679|         Security(verify_oauth_client, scopes=[CURRENT_PRIVACY_PREFERENCE_READ])
   680|     ],
   681|     response_model=Page[CurrentPrivacyPreferenceReportingSchema],
   682| )
   683| def get_current_privacy_preferences_report(
   684|     *,
   685|     params: Params = Depends(),
   686|     db: Session = Depends(get_db),
   687|     updated_lt: Optional[datetime] = None,
   688|     updated_gt: Optional[datetime] = None,
   689| ) -> AbstractPage[CurrentPrivacyPreference]:
   690|     """Returns the most recently saved privacy preferences for a particular consent item"""
   691|     validate_start_and_end_filters([(updated_lt, updated_gt, "updated")])
   692|     query: Query[CurrentPrivacyPreference] = db.query(CurrentPrivacyPreference)


# ====================================================================
# FILE: src/fides/api/schemas/privacy_preference.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 62-148 ---
    62|     )
    63|     feature: Optional[int] = Field(
    64|         title="The TCF feature that was served or saved against"
    65|     )
    66|     special_feature: Optional[int] = Field(
    67|         title="The TCF special feature that was served or saved against"
    68|     )
    69|     system_consent: Optional[str] = Field(
    70|         title="The System id with a legal basis of consent that was served or saved against. Used when we don't know what vendor "
    71|         "corresponds to the system, so we save preferences against the system directly"
    72|     )
    73|     system_legitimate_interests: Optional[str] = Field(
    74|         title="The System id with a legal basis of legitimate interests that consent was served or saved against. "
    75|         "Used when we don't know what vendor corresponds to the system, so we save preferences against the system directly"
    76|     )
    77| class ConsentOptionCreate(FidesSchema):
    78|     """Schema for saving the user's preference for a given notice"""
    79|     privacy_notice_history_id: str
    80|     preference: UserConsentPreference
    81|     served_notice_history_id: Optional[str]
    82| class TCStringFidesPreferences(FidesSchema):
    83|     """TCF Preferences that can be unpacked from a TC string"""
    84|     purpose_consent_preferences: conlist(TCFPurposeSave, max_items=200) = []  # type: ignore
    85|     purpose_legitimate_interests_preferences: conlist(TCFPurposeSave, max_items=200) = []  # type: ignore
    86|     vendor_consent_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
    87|     vendor_legitimate_interests_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
    88|     special_feature_preferences: conlist(TCFSpecialFeatureSave, max_items=200) = []  # type: ignore
    89| class PrivacyPreferencesRequest(TCStringFidesPreferences):
    90|     """Request body for creating PrivacyPreferences.
    91|     "preferences" key reserved for saving preferences against a privacy notice.
    92|     New *_preferences fields are used for saving preferences against various tcf components.
    93|     """
    94|     browser_identity: Identity
    95|     code: Optional[SafeStr]
    96|     fides_string: Optional[str] = Field(
    97|         description="If supplied, TC strings and AC strings are decoded and preferences saved for purpose_consent, "
    98|         "purpose_legitimate_interests, vendor_consent, vendor_legitimate_interests, and special_features"
    99|     )
   100|     preferences: conlist(ConsentOptionCreate, max_items=200) = []  # type: ignore
   101|     special_purpose_preferences: conlist(TCFSpecialPurposeSave, max_items=200) = []  # type: ignore
   102|     feature_preferences: conlist(TCFFeatureSave, max_items=200) = []  # type: ignore
   103|     system_consent_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
   104|     system_legitimate_interests_preferences: conlist(TCFVendorSave, max_items=200) = []  # type: ignore
   105|     policy_key: Optional[FidesKey]  # Will use default consent policy if not supplied
   106|     privacy_experience_id: Optional[SafeStr]
   107|     user_geography: Optional[SafeStr]
   108|     method: Optional[ConsentMethod]
   109|     @root_validator()
   110|     @classmethod
   111|     def validate_tcf_attributes(cls, values: Dict[str, Any]) -> Dict[str, Any]:
   112|         """
   113|         Run a few validation checks related to saving privacy preferences against TCF attributes.
   114|         - Check that there are no duplicates preferences against TCF components
   115|         to avoid confusing responses
   116|         - Make sure that if a TC string is supplied, we're not also supplying values for the related
   117|         TC sections individually, because the TC string will override everything here.
   118|         """
   119|         def tcf_duplicates_detected(preference_list: List) -> bool:
   120|             identifiers = [preference.id for preference in preference_list]
   121|             return len(identifiers) != len(set(identifiers))
   122|         for field_name in TCF_PREFERENCES_FIELD_MAPPING:
   123|             if tcf_duplicates_detected(values.get(field_name, [])):
   124|                 raise ValueError(
   125|                     f"Duplicate preferences saved against TCF component: '{field_name}'"
   126|                 )
   127|         if values.get("fides_string"):
   128|             for field in TCStringFidesPreferences.__fields__:
   129|                 if values.get(field):
   130|                     raise ValueError(
   131|                         f"Cannot supply value for '{field}' and 'fides_string' simultaneously when saving privacy preferences."
   132|                     )
   133|         return values
   134| class PrivacyPreferencesCreate(PrivacyPreferencesRequest):
   135|     """Schema for creating privacy preferences that is supplemented with information
   136|     from the request headers and the experience"""
   137|     anonymized_ip_address: Optional[str]
   138|     experience_config_history_id: Optional[SafeStr]
   139|     request_origin: Optional[RequestOrigin]
   140|     url_recorded: Optional[SafeStr]
   141|     user_agent: Optional[SafeStr]
   142| class MinimalPrivacyPreferenceHistorySchema(FidesSchema):
   143|     """Minimal privacy preference history schema for building consent emails"""
   144|     preference: UserConsentPreference
   145|     privacy_notice_history: PrivacyNoticeHistorySchema
   146| class RecordConsentServedRequest(FidesSchema):
   147|     """Request body to use when saving that consent was served"""
   148|     browser_identity: Identity


# ====================================================================
# FILE: src/fides/api/schemas/tcf.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 26-99 ---
    26|         """Default preference for purposes with legal basis of consent is opt-out"""
    27|         values["default_preference"] = UserConsentPreference.opt_out
    28|         return values
    29| class TCFPurposeLegitimateInterestsRecord(NonVendorSection, MappedPurpose):
    30|     """Schema for a TCF Purpose with Legitimate Interests Legal Basis returned in the TCF Overlay Experience"""
    31|     @root_validator
    32|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    33|         """Default preference for purposes with legal basis of legitimate interests is opt-in"""
    34|         values["default_preference"] = UserConsentPreference.opt_in
    35|         return values
    36| class TCFSpecialPurposeRecord(NonVendorSection, MappedPurpose):
    37|     @root_validator
    38|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    39|         """Default preference for special purposes is acknowledge"""
    40|         values["default_preference"] = UserConsentPreference.acknowledge
    41|         return values
    42| class EmbeddedLineItem(FidesSchema):
    43|     """Sparse details for an embedded TCF line item within another TCF component. Read-only."""
    44|     id: int
    45|     name: str
    46| class CommonVendorFields(FidesSchema):
    47|     """Fields shared between the three vendor sections of the TCF Experience"""
    48|     id: str
    49|     has_vendor_id: Optional[bool]
    50|     name: Optional[str]
    51|     description: Optional[str]
    52| class TCFVendorConsentRecord(UserSpecificConsentDetails, CommonVendorFields):
    53|     """Schema for a TCF Vendor with Consent legal basis"""
    54|     purpose_consents: List[EmbeddedLineItem] = []
    55|     @root_validator
    56|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    57|         """Default preference for vendor with legal basis of consent is opt-out"""
    58|         values["default_preference"] = UserConsentPreference.opt_out
    59|         return values
    60| class TCFVendorLegitimateInterestsRecord(
    61|     UserSpecificConsentDetails, CommonVendorFields
    62| ):
    63|     """Schema for a TCF Vendor with Legitimate interests legal basis"""
    64|     purpose_legitimate_interests: List[EmbeddedLineItem] = []
    65|     @root_validator
    66|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    67|         """Default preference for vendor with legal basis of leg interests is opt-in"""
    68|         values["default_preference"] = UserConsentPreference.opt_in
    69|         return values
    70| class TCFVendorRelationships(CommonVendorFields):
    71|     """Collects the other relationships for a given vendor - no preferences are saved here"""
    72|     special_purposes: List[EmbeddedLineItem] = []
    73|     features: List[EmbeddedLineItem] = []
    74|     special_features: List[EmbeddedLineItem] = []
    75|     cookie_max_age_seconds: Optional[int]
    76|     uses_cookies: Optional[bool]
    77|     cookie_refresh: Optional[bool]
    78|     uses_non_cookie_access: Optional[bool]
    79|     legitimate_interest_disclosure_url: Optional[AnyUrl]
    80| class TCFFeatureRecord(NonVendorSection, Feature):
    81|     """Schema for a TCF Feature: returned in the TCF Overlay Experience"""
    82|     @root_validator
    83|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    84|         """Default preference for features is acknowledge"""
    85|         values["default_preference"] = UserConsentPreference.acknowledge
    86|         return values
    87| class TCFSpecialFeatureRecord(NonVendorSection, Feature):
    88|     """Schema for a TCF Special Feature: returned in the TCF Overlay Experience"""
    89|     @root_validator
    90|     def add_default_preference(cls, values: Dict[str, Any]) -> Dict[str, Any]:
    91|         """Default preference for special features is acknowledge"""
    92|         values["default_preference"] = UserConsentPreference.opt_out
    93|         return values
    94| class TCFPreferenceSaveBase(FidesSchema):
    95|     """Base schema for saving individual TCF component preferences"""
    96|     id: int
    97|     preference: UserConsentPreference
    98|     served_notice_history_id: Optional[str]
    99| class TCFPurposeSave(TCFPreferenceSaveBase):


# ====================================================================
# FILE: src/fides/api/util/tcf/experience_meta.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-28 ---
     1| import hashlib
     2| import json
     3| from typing import Dict, List
     4| from pydantic import Extra, root_validator
     5| from fides.api.models.privacy_notice import UserConsentPreference
     6| from fides.api.schemas.base_class import FidesSchema
     7| from fides.api.schemas.privacy_experience import ExperienceMeta
     8| from fides.api.schemas.tcf import TCMobileData
     9| from fides.api.util.tcf.tc_mobile_data import build_tc_data_for_mobile
    10| from fides.api.util.tcf.tc_model import TCModel, convert_tcf_contents_to_tc_model
    11| from fides.api.util.tcf.tcf_experience_contents import TCFExperienceContents
    12| class TCFVersionHash(FidesSchema):
    13|     """Minimal subset of the TCF experience details that capture when consent should be resurfaced"""
    14|     policy_version: int
    15|     purpose_consents: List[int]
    16|     purpose_legitimate_interests: List[int]
    17|     special_feature_optins: List[int]
    18|     vendor_consents: List[int]
    19|     vendor_legitimate_interests: List[int]
    20|     @root_validator()
    21|     @classmethod
    22|     def sort_lists(cls, values: Dict) -> Dict:
    23|         """Verify lists are sorted ascending for repeatability"""
    24|         for field, val in values.items():
    25|             if isinstance(val, list):
    26|                 values[field] = sorted(val)
    27|         return values
    28|     class Config:

# --- HUNK 2: Lines 45-69 ---
    45|     if there are updates to vendors, purposes, and special features sections or legal basis.
    46|     This hash can be used to determine if the TCF Experience needs to be resurfaced to the customer,
    47|     because the experience has changed in a meaningful way.
    48|     """
    49|     tcf_version_hash_model: TCFVersionHash = _build_tcf_version_hash_model(tcf_contents)
    50|     json_str: str = json.dumps(tcf_version_hash_model.dict(), sort_keys=True)
    51|     hashed_val: str = hashlib.sha256(json_str.encode()).hexdigest()
    52|     return hashed_val[:12]  # Shortening string for usability, collision risk is low
    53| def build_experience_tcf_meta(tcf_contents: TCFExperienceContents) -> Dict:
    54|     """Build TCF Meta information to supplement a TCF Privacy Experience at runtime"""
    55|     accept_all_tc_model: TCModel = convert_tcf_contents_to_tc_model(
    56|         tcf_contents, UserConsentPreference.opt_in
    57|     )
    58|     reject_all_tc_model: TCModel = convert_tcf_contents_to_tc_model(
    59|         tcf_contents, UserConsentPreference.opt_out
    60|     )
    61|     accept_all_mobile_data: TCMobileData = build_tc_data_for_mobile(accept_all_tc_model)
    62|     reject_all_mobile_data: TCMobileData = build_tc_data_for_mobile(reject_all_tc_model)
    63|     return ExperienceMeta(
    64|         version_hash=build_tcf_version_hash(tcf_contents),
    65|         accept_all_fides_string=accept_all_mobile_data.IABTCF_TCString,
    66|         reject_all_fides_string=reject_all_mobile_data.IABTCF_TCString,
    67|         accept_all_fides_mobile_data=accept_all_mobile_data,
    68|         reject_all_fides_mobile_data=reject_all_mobile_data,
    69|     ).dict()


# ====================================================================
# FILE: src/fides/api/util/tcf/tc_model.py
# Total hunks: 4
# ====================================================================
# --- HUNK 1: Lines 1-49 ---
     1| import re
     2| from datetime import datetime
     3| from typing import Dict, List, Optional, Tuple
     4| from pydantic import Field, NonNegativeInt, PositiveInt, root_validator, validator
     5| from fides.api.models.privacy_notice import UserConsentPreference
     6| from fides.api.schemas.base_class import FidesSchema
     7| from fides.api.schemas.tcf import (
     8|     TCFSpecialFeatureRecord,
     9|     TCFVendorConsentRecord,
    10|     TCFVendorLegitimateInterestsRecord,
    11| )
    12| from fides.api.util.tcf.tcf_experience_contents import TCFExperienceContents, load_gvl
    13| CMP_ID: int = 407
    14| CMP_VERSION = 1
    15| CONSENT_SCREEN = 1  # TODO On which 'screen' consent was captured; this is a CMP proprietary number encoded into the TC string
    16| FORBIDDEN_LEGITIMATE_INTEREST_PURPOSE_IDS = [1, 3, 4, 5, 6]
    17| gvl: Dict = load_gvl()
    18| ac_prefix = "gacp."
    19| def universal_vendor_id_to_gvl_id(universal_vendor_id: str) -> int:
    20|     """Converts a universal gvl vendor id to a vendor id
    21|     For example, converts "gvl.42" to integer 42.
    22|     Throws a ValueError if the id cannot be converted to an integer or if this is an AC Vendor ID
    23|     We store vendor ids as a universal vendor id internally, but need to strip this off when building TC strings.
    24|     """
    25|     if universal_vendor_id.startswith(ac_prefix):
    26|         raise ValueError("Skipping AC Vendor ID")
    27|     return int(universal_vendor_id.lstrip("gvl."))
    28| class TCModel(FidesSchema):
    29|     """Base internal TC schema to store and validate key details from which to later build the TC String"""
    30|     _gvl: Dict = {}
    31|     is_service_specific: bool = Field(
    32|         default=False,
    33|         description="Whether the signals encoded in this TC String were from site-specific storage `true` versus "
    34|         "global consensu.org shared storage `false`. A string intended to be stored in global/shared "
    35|         "scope but the CMP is unable to store due to a user agent not accepting third-party cookies "
    36|         "would be considered site-specific `true`.",
    37|     )
    38|     support_oob: bool = Field(
    39|         default=True,
    40|         description="Whether or not this publisher supports OOB signaling.  On Global TC String OOB Vendors Disclosed "
    41|         "will be included if the publish wishes to not allow these vendors they should set this to false.",
    42|     )
    43|     use_non_standard_texts: bool = Field(
    44|         default=False,
    45|         description="Non-standard stacks means that a CMP is using publisher-customized stack descriptions. Stacks "
    46|         "(in terms of purposes in a stack) are pre-set by the IAB. As are titles. Descriptions are pre-set, "
    47|         "but publishers can customize them. If they do, they need to set this bit to indicate that they've "
    48|         "customized descriptions.",
    49|     )

# --- HUNK 2: Lines 138-177 ---
   138|         description="Each Vendor is keyed by id. Whether their Legitimate Interests Disclosures have been "
   139|         "established is stored as boolean.",
   140|     )
   141|     vendors_disclosed: List = Field(
   142|         default=[],
   143|         description=" The value included for disclosed vendors signals which vendors have been disclosed to the user "
   144|         "in the interface surfaced by the CMP. This section content is required when writing a TC string "
   145|         "to the global (consensu) scope. When a CMP has read from and is updating a TC string from the "
   146|         "global consensu.org storage, the CMP MUST retain the existing disclosure information and only"
   147|         " add information for vendors that it has disclosed that had not been disclosed by other CMPs in "
   148|         "prior interactions with this device/user agent.",
   149|     )
   150|     vendors_allowed: List = Field(
   151|         default=[],
   152|         description="Signals which vendors the publisher permits to use OOB legal bases.",
   153|     )
   154|     publisher_restrictions: List = Field(
   155|         default=[],
   156|     )
   157|     num_pub_restrictions: int = 0  # Hardcoded here for now
   158|     @validator("publisher_country_code")
   159|     def check_publisher_country_code(cls, publisher_country_code: str) -> str:
   160|         """Validates that a publisher_country_code is an upper-cased two letter string"""
   161|         upper_case_country_code: str = publisher_country_code.upper()
   162|         pattern = r"^[A-Z]{2}$"
   163|         if not re.match(pattern, upper_case_country_code):
   164|             raise ValueError(
   165|                 "publisher_country_code must be a length-2 string of alpha characters"
   166|             )
   167|         return upper_case_country_code
   168|     @validator("consent_language")
   169|     def check_consent_language(cls, consent_language: str) -> str:
   170|         """Forces consent language to be upper cased and no longer than 2 characters"""
   171|         consent_language = consent_language.upper()[:2]
   172|         if len(consent_language) < 2:
   173|             raise ValueError("Consent language is less than two characters")
   174|         return consent_language
   175|     @validator("purpose_legitimate_interests")
   176|     def filter_purpose_legitimate_interests(
   177|         cls, purpose_legitimate_interests: List[int]

# --- HUNK 3: Lines 294-352 ---
   294|             if vendor_id in all_vendor_ids:
   295|                 vendors_disclosed.add(vendor_id)
   296|     return sorted(list(vendors_disclosed))
   297| def _get_epoch_time() -> int:
   298|     """Calculate the epoch time to be used for both created and updated_at
   299|     Matches this: Math.round(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate())/100)
   300|     Had to add an extra "0" to get it to match.
   301|     """
   302|     return int(datetime.utcnow().date().strftime("%s") + "0")
   303| def transform_user_preference_to_boolean(preference: UserConsentPreference) -> bool:
   304|     """Convert opt_in/acknowledge preferences to True and opt_out/other preferences to False"""
   305|     return preference in [
   306|         UserConsentPreference.opt_in,
   307|         UserConsentPreference.acknowledge,
   308|     ]
   309| def convert_tcf_contents_to_tc_model(
   310|     tcf_contents: TCFExperienceContents, preference: Optional[UserConsentPreference]
   311| ) -> TCModel:
   312|     """
   313|     Helper for building a TCModel from TCFExperienceContents that contains the prerequisite information to build
   314|     an accept-all or reject-all string, depending on the supplied preference.
   315|     """
   316|     if not preference:
   317|         raise Exception(
   318|             "Overall preference must be specified. Only accept or reject-all strings are currently supported."
   319|         )
   320|     consented: bool = transform_user_preference_to_boolean(preference)
   321|     (
   322|         vendor_consents,
   323|         vendor_legitimate_interests,
   324|     ) = _build_vendor_consents_and_legitimate_interests(
   325|         tcf_contents.tcf_vendor_consents, tcf_contents.tcf_vendor_legitimate_interests
   326|     )
   327|     purpose_consents: List[int] = [
   328|         purpose.id for purpose in tcf_contents.tcf_purpose_consents
   329|     ]
   330|     purpose_legitimate_interests: List[int] = [
   331|         purpose.id for purpose in tcf_contents.tcf_purpose_legitimate_interests
   332|     ]
   333|     special_feature_opt_ins: List[int] = _build_special_feature_opt_ins(
   334|         tcf_contents.tcf_special_features
   335|     )
   336|     current_time: int = _get_epoch_time()
   337|     tc_model = TCModel(
   338|         created=current_time,
   339|         last_updated=current_time,
   340|         cmp_id=CMP_ID,
   341|         cmp_version=CMP_VERSION,
   342|         consent_screen=CONSENT_SCREEN,
   343|         vendor_list_version=gvl.get("vendorListVersion"),
   344|         policy_version=gvl.get("tcfPolicyVersion"),
   345|         special_feature_optins=special_feature_opt_ins if consented else [],
   346|         purpose_consents=purpose_consents if consented else [],
   347|         purpose_legitimate_interests=purpose_legitimate_interests if consented else [],
   348|         vendor_consents=vendor_consents if consented else [],
   349|         vendor_legitimate_interests=vendor_legitimate_interests if consented else [],
   350|         vendors_disclosed=_build_vendors_disclosed(tcf_contents),
   351|     )
   352|     return tc_model


# ====================================================================
# FILE: src/fides/api/util/tcf/tc_string.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-39 ---
     1| import base64
     2| import binascii
     3| from typing import Any, Dict, List, Optional, Type, Union
     4| from iab_tcf import ConsentV2, decode_v2  # type: ignore[import]
     5| from pydantic import Field
     6| from fides.api.common_exceptions import DecodeTCStringError
     7| from fides.api.models.privacy_notice import UserConsentPreference
     8| from fides.api.schemas.base_class import FidesSchema
     9| from fides.api.schemas.privacy_preference import TCStringFidesPreferences
    10| from fides.api.schemas.tcf import TCFPurposeSave, TCFSpecialFeatureSave, TCFVendorSave
    11| from fides.api.util.tcf.tc_model import TCModel, convert_tcf_contents_to_tc_model
    12| from fides.api.util.tcf.tcf_experience_contents import TCFExperienceContents
    13| USE_NON_STANDARD_TEXT_BITS = 1
    14| SPECIAL_FEATURE_BITS = 12
    15| PURPOSE_CONSENTS_BITS = 24
    16| PURPOSE_LEGITIMATE_INTERESTS_BITS = 24
    17| def add_gvl_prefix(vendor_id: str) -> str:
    18|     """Add gvl prefix to create a universal gvl identifier for the given vendor id"""
    19|     return "gvl." + vendor_id
    20| class TCField(FidesSchema):
    21|     """Schema to represent a field within a TC string segment"""
    22|     name: str = Field(description="Field name")
    23|     bits: int = Field(
    24|         description="The number of bits that should be used to represent this value"
    25|     )
    26|     value_override: Optional[Any] = Field(
    27|         description="The value that should be used instead of the field on the TC model"
    28|     )
    29| def get_bits_for_section(fields: List[TCField], tc_model: TCModel) -> str:
    30|     """Construct a representation of the fields supplied in bits for a given section."""
    31|     def _convert_val_to_bitstring(val: Union[str, list, int], num_bits: int) -> str:
    32|         """Internal helper to take a string, list of integers, or integer, and convert it to a bitstring"""
    33|         bit_components: str = ""
    34|         if isinstance(val, str):
    35|             bit_allocation = int(num_bits / len(val))
    36|             for char in val:
    37|                 converted_num: int = _convert_letter_to_number(char)
    38|                 bit_components += format(converted_num, f"0{bit_allocation}b")
    39|             return bit_components

# --- HUNK 2: Lines 150-207 ---
   150|         Type[TCFPurposeSave], Type[TCFVendorSave], Type[TCFSpecialFeatureSave]
   151|     ],
   152| ) -> List[FidesPreferenceType]:
   153|     """For a field in the TC string, convert to a list of preferences where we opt-in if it is included in the string,
   154|     and opt-out if it is not in the string, but in the datamap"""
   155|     preferences_array: List[FidesPreferenceType] = []
   156|     for identifier in datamap_options:
   157|         preference: bool = tc_string_preferences.get(identifier, False)
   158|         if preference_class == TCFVendorSave:
   159|             vendor_id: str = add_gvl_prefix(str(identifier))
   160|             fides_preference: FidesPreferenceType = preference_class(
   161|                 id=vendor_id, preference=boolean_to_user_consent_preference(preference)
   162|             )
   163|         else:
   164|             fides_preference = preference_class(
   165|                 id=identifier, preference=boolean_to_user_consent_preference(preference)
   166|             )
   167|         preferences_array.append(fides_preference)
   168|     return preferences_array
   169| def decode_tc_string_to_preferences(
   170|     tc_string: str, tcf_contents: TCFExperienceContents
   171| ) -> TCStringFidesPreferences:
   172|     """Method to convert a TC String into a TCStringFidesPreferences object, which is a format from which
   173|     preferences can be saved into the Fides database"""
   174|     try:
   175|         decoded: ConsentV2 = decode_v2(tc_string)
   176|         tc_str_p_c: Dict[int, bool] = decoded.purposes_consent
   177|         tc_str_p_li: Dict[int, bool] = decoded.purposes_legitimate_interests
   178|         tc_str_v_c: Dict[int, bool] = decoded.consented_vendors
   179|         tc_str_v_li: Dict[int, bool] = decoded.interests_vendors
   180|         tc_str_sf: Dict[int, bool] = decoded.special_features_optin
   181|     except (binascii.Error, AttributeError):
   182|         raise DecodeTCStringError("Invalid base64-encoded TC string")
   183|     all_options_tc_model: TCModel = convert_tcf_contents_to_tc_model(
   184|         tcf_contents, UserConsentPreference.opt_in
   185|     )
   186|     datamap_p_c: List[int] = all_options_tc_model.purpose_consents
   187|     datamap_p_li: List[int] = all_options_tc_model.purpose_legitimate_interests
   188|     datamap_v_c: List[int] = all_options_tc_model.vendor_consents
   189|     datamap_v_li: List[int] = all_options_tc_model.vendor_legitimate_interests
   190|     datamap_sf: List[int] = all_options_tc_model.special_feature_optins
   191|     return TCStringFidesPreferences(
   192|         purpose_consent_preferences=convert_to_fides_preference(
   193|             datamap_p_c, tc_str_p_c, TCFPurposeSave
   194|         ),
   195|         purpose_legitimate_interests_preferences=convert_to_fides_preference(
   196|             datamap_p_li, tc_str_p_li, TCFPurposeSave
   197|         ),
   198|         vendor_consent_preferences=convert_to_fides_preference(
   199|             datamap_v_c, tc_str_v_c, TCFVendorSave
   200|         ),
   201|         vendor_legitimate_interests_preferences=convert_to_fides_preference(
   202|             datamap_v_li, tc_str_v_li, TCFVendorSave
   203|         ),
   204|         special_feature_preferences=convert_to_fides_preference(
   205|             datamap_sf, tc_str_sf, TCFSpecialFeatureSave
   206|         ),
   207|     )


# ====================================================================
# FILE: src/fides/api/util/tcf/tcf_experience_contents.py
# Total hunks: 9
# ====================================================================
# --- HUNK 1: Lines 1-99 ---
     1| import json
     2| from enum import Enum
     3| from os.path import dirname, join
     4| from typing import Callable, Dict, List, Optional, Set, Tuple, Type, Union
     5| from fideslang.gvl import (
     6|     GVL_FEATURES,
     7|     GVL_SPECIAL_FEATURES,
     8|     MAPPED_PURPOSES,
     9|     MAPPED_SPECIAL_PURPOSES,
    10|     data_use_to_purpose,
    11|     feature_id_to_feature_name,
    12|     feature_name_to_feature,
    13|     purpose_to_data_use,
    14| )
    15| from fideslang.gvl.models import Feature, Purpose
    16| from fideslang.models import LegalBasisForProcessingEnum
    17| from fideslang.validation import FidesKey
    18| from loguru import logger
    19| from sqlalchemy.engine.row import Row  # type:ignore[import]
    20| from sqlalchemy.orm import Query, Session
    21| from fides.api.models.sql_models import (  # type:ignore[attr-defined]
    22|     PrivacyDeclaration,
    23|     System,
    24| )
    25| from fides.api.schemas.base_class import FidesSchema
    26| from fides.api.schemas.tcf import (
    27|     EmbeddedVendor,
    28|     TCFFeatureRecord,
    29|     TCFPurposeConsentRecord,
    30|     TCFPurposeLegitimateInterestsRecord,
    31|     TCFSpecialFeatureRecord,
    32|     TCFSpecialPurposeRecord,
    33|     TCFVendorConsentRecord,
    34|     TCFVendorLegitimateInterestsRecord,
    35|     TCFVendorRelationships,
    36| )
    37| from fides.config.helpers import load_file
    38| _gvl: Optional[Dict] = None
    39| GVL_PATH = join(
    40|     dirname(__file__),
    41|     "../../../data",
    42|     "gvl.json",
    43| )
    44| PURPOSE_DATA_USES: List[str] = []
    45| for purpose in MAPPED_PURPOSES.values():
    46|     PURPOSE_DATA_USES.extend(purpose.data_uses)
    47| SPECIAL_PURPOSE_DATA_USES: List[str] = []
    48| for special_purpose in MAPPED_SPECIAL_PURPOSES.values():
    49|     SPECIAL_PURPOSE_DATA_USES.extend(special_purpose.data_uses)
    50| ALL_GVL_DATA_USES = list(set(PURPOSE_DATA_USES) | set(SPECIAL_PURPOSE_DATA_USES))
    51| NonVendorSectionType = Union[
    52|     Type[TCFPurposeConsentRecord],
    53|     Type[TCFPurposeLegitimateInterestsRecord],
    54|     Type[TCFSpecialPurposeRecord],
    55|     Type[TCFFeatureRecord],
    56|     Type[TCFSpecialFeatureRecord],
    57| ]
    58| NonVendorRecord = Union[
    59|     TCFPurposeConsentRecord,
    60|     TCFPurposeLegitimateInterestsRecord,
    61|     TCFSpecialPurposeRecord,
    62|     TCFFeatureRecord,
    63|     TCFSpecialFeatureRecord,
    64| ]
    65| VendorSectionType = Union[
    66|     Type[TCFVendorConsentRecord],
    67|     Type[TCFVendorLegitimateInterestsRecord],
    68|     Type[TCFVendorRelationships],
    69| ]
    70| VendorRecord = Union[
    71|     TCFVendorConsentRecord, TCFVendorLegitimateInterestsRecord, TCFVendorRelationships
    72| ]
    73| SystemSubSections = Union[
    74|     List[TCFPurposeConsentRecord],
    75|     List[TCFPurposeLegitimateInterestsRecord],
    76|     List[TCFSpecialPurposeRecord],
    77|     List[TCFFeatureRecord],
    78|     List[TCFSpecialFeatureRecord],
    79| ]
    80| class ConsentRecordType(Enum):
    81|     """*ALL* of the relevant consent items that can be served or have preferences saved against.
    82|     Includes two privacy notices fields, and then everything in TCFComponentType
    83|     """
    84|     privacy_notice_id = "privacy_notice_id"
    85|     privacy_notice_history_id = "privacy_notice_history_id"
    86|     purpose_consent = "purpose_consent"
    87|     purpose_legitimate_interests = "purpose_legitimate_interests"
    88|     special_purpose = "special_purpose"
    89|     vendor_consent = "vendor_consent"
    90|     vendor_legitimate_interests = "vendor_legitimate_interests"
    91|     system_consent = "system_consent"
    92|     system_legitimate_interests = "system_legitimate_interests"
    93|     feature = "feature"
    94|     special_feature = "special_feature"
    95| TCF_SECTION_MAPPING: Dict[str, Optional[ConsentRecordType]] = {
    96|     "tcf_purpose_consents": ConsentRecordType.purpose_consent,
    97|     "tcf_purpose_legitimate_interests": ConsentRecordType.purpose_legitimate_interests,
    98|     "tcf_special_purposes": ConsentRecordType.special_purpose,
    99|     "tcf_features": ConsentRecordType.feature,

# --- HUNK 2: Lines 136-264 ---
   136|     tcf_system_legitimate_interests: List[TCFVendorLegitimateInterestsRecord] = []
   137|     tcf_system_relationships: List[TCFVendorRelationships] = []
   138| def get_matching_privacy_declarations(db: Session) -> Query:
   139|     """Returns flattened system/privacy declaration records where we have a matching gvl data use AND the
   140|     legal basis for processing is "Consent" or "Legitimate interests"
   141|     Only systems that meet this criteria should show up in the TCF overlay.
   142|     """
   143|     matching_privacy_declarations: Query = (
   144|         db.query(
   145|             System.id.label("system_id"),
   146|             System.fides_key.label("system_fides_key"),
   147|             System.name.label("system_name"),
   148|             System.description.label("system_description"),
   149|             System.cookie_max_age_seconds.label("system_cookie_max_age_seconds"),
   150|             System.uses_cookies.label("system_uses_cookies"),
   151|             System.cookie_refresh.label("system_cookie_refresh"),
   152|             System.uses_non_cookie_access.label("system_uses_non_cookie_access"),
   153|             System.legitimate_interest_disclosure_url.label(
   154|                 "system_legitimate_interest_disclosure_url"
   155|             ),
   156|             System.vendor_id,
   157|             PrivacyDeclaration.data_use,
   158|             PrivacyDeclaration.legal_basis_for_processing,
   159|             PrivacyDeclaration.features,
   160|         )
   161|         .join(PrivacyDeclaration, System.id == PrivacyDeclaration.system_id)
   162|         .filter(
   163|             PrivacyDeclaration.data_use.in_(ALL_GVL_DATA_USES),
   164|             PrivacyDeclaration.legal_basis_for_processing.in_(
   165|                 [
   166|                     LegalBasisForProcessingEnum.CONSENT,
   167|                     LegalBasisForProcessingEnum.LEGITIMATE_INTEREST,
   168|                 ]
   169|             ),
   170|         )
   171|         .order_by(
   172|             PrivacyDeclaration.created_at.desc()
   173|         )  # Order to get repeatable results when collapsing information
   174|     )
   175|     return matching_privacy_declarations
   176| def get_system_identifiers(
   177|     privacy_declaration_row: Row,
   178| ) -> Tuple[Optional[str], str]:
   179|     """Return the vendor id and overall system identifier (which is either the vendor OR system id)
   180|     If a vendor exists, that's how we'll identify the system, and we'll consolidate information
   181|     from multiple matching systems under that single vendor id.  If we don't have a vendor id, we don't know the
   182|     "type" of system, so we'll surface information under that system id itself.
   183|     """
   184|     system_id: str = privacy_declaration_row["system_id"]
   185|     vendor_id: Optional[str] = privacy_declaration_row["vendor_id"]
   186|     system_identifier: str = vendor_id if vendor_id else system_id
   187|     return vendor_id, system_identifier
   188| def get_matching_data_uses_or_features(
   189|     record: Row, relevant_uses_or_features: List[str], is_purpose_type: bool
   190| ) -> Set[str]:
   191|     """
   192|     Determine the set of relevant uses or features depending on whether we're building a
   193|     purpose or feature section
   194|     """
   195|     if is_purpose_type:
   196|         return (
   197|             {record.data_use} if record.data_use in relevant_uses_or_features else set()
   198|         )
   199|     unique_features: Set[str] = set()
   200|     for feature_name in record.features:
   201|         if feature_name in relevant_uses_or_features:
   202|             unique_features.add(feature_name)
   203|     return unique_features
   204| def _add_top_level_record_to_purpose_or_feature_section(
   205|     tcf_component_type: NonVendorSectionType,
   206|     non_vendor_record_map: Dict[int, NonVendorRecord],
   207|     is_purpose_type: bool,
   208|     use_or_feature: str,
   209| ) -> Optional[NonVendorRecord]:
   210|     """
   211|     Create a purpose or feature record and add to the top-level sections.
   212|     "non_vendor_record_map" is updated here, in-place.
   213|     """
   214|     get_gvl_record: Callable = (
   215|         data_use_to_purpose if is_purpose_type else feature_name_to_feature
   216|     )
   217|     fideslang_gvl_record: Union[Purpose, Feature] = get_gvl_record(use_or_feature)
   218|     if not fideslang_gvl_record:
   219|         return None
   220|     top_level_tcf_record: NonVendorRecord = tcf_component_type(
   221|         **fideslang_gvl_record.dict()
   222|     )
   223|     if top_level_tcf_record.id not in non_vendor_record_map:
   224|         non_vendor_record_map[top_level_tcf_record.id] = top_level_tcf_record
   225|     return non_vendor_record_map[top_level_tcf_record.id]
   226| def _embed_purpose_or_feature_under_system(
   227|     embedded_tcf_record: NonVendorRecord,
   228|     system_section: SystemSubSections,
   229| ) -> None:
   230|     """
   231|     Embed a second-level TCF purpose/feature under the systems section.
   232|     The systems section is updated in-place.
   233|     """
   234|     embedded_non_vendor_record: Optional[NonVendorRecord] = next(
   235|         (
   236|             tcf_sub_record
   237|             for tcf_sub_record in system_section
   238|             if tcf_sub_record.id == embedded_tcf_record.id
   239|         ),
   240|         None,
   241|     )
   242|     if embedded_non_vendor_record:
   243|         return
   244|     system_section.append(embedded_tcf_record)  # type: ignore[arg-type]
   245| def _embed_system_under_purpose_or_feature(
   246|     top_level_tcf_record: NonVendorRecord,
   247|     non_vendor_record_map: Dict[int, NonVendorRecord],
   248|     privacy_declaration_row: Row,
   249| ) -> None:
   250|     """
   251|     Embed system/vendor information beneath the corresponding top-level purpose or feature section.
   252|     """
   253|     vendor_id, system_identifier = get_system_identifiers(privacy_declaration_row)
   254|     embedded_system_section: List[EmbeddedVendor] = (
   255|         non_vendor_record_map[top_level_tcf_record.id].vendors
   256|         if vendor_id
   257|         else non_vendor_record_map[top_level_tcf_record.id].systems
   258|     )
   259|     if system_identifier not in [
   260|         embedded_system_record.id for embedded_system_record in embedded_system_section
   261|     ]:
   262|         embedded_system_section.extend(
   263|             [
   264|                 EmbeddedVendor(

# --- HUNK 3: Lines 309-433 ---
   309|             )
   310|             if not top_level_tcf_record:
   311|                 continue
   312|             vendor_id, system_identifier = get_system_identifiers(
   313|                 privacy_declaration_row
   314|             )
   315|             if system_identifier not in vendor_map:
   316|                 vendor_map[system_identifier] = tcf_vendor_component_type(
   317|                     id=system_identifier,  # Identify system by vendor id if it exists, otherwise use system id.
   318|                     name=privacy_declaration_row.system_name,
   319|                     description=privacy_declaration_row.system_description,
   320|                     has_vendor_id=bool(
   321|                         vendor_id
   322|                     ),  # Has_vendor_id will let us separate data between systems and vendors
   323|                 )
   324|             _embed_purpose_or_feature_under_system(
   325|                 embedded_tcf_record=top_level_tcf_record.copy(),
   326|                 system_section=getattr(
   327|                     vendor_map[system_identifier], vendor_subsection_name
   328|                 ),
   329|             )
   330|             _embed_system_under_purpose_or_feature(
   331|                 top_level_tcf_record=top_level_tcf_record,
   332|                 non_vendor_record_map=non_vendor_record_map,
   333|                 privacy_declaration_row=privacy_declaration_row,
   334|             )
   335|     return non_vendor_record_map, vendor_map
   336| def populate_vendor_relationships_basic_attributes(
   337|     vendor_map: Dict[str, TCFVendorRelationships],
   338|     matching_privacy_declarations: Query,
   339| ) -> Dict[str, TCFVendorRelationships]:
   340|     """Populates TCFVendorRelationships records for all vendors that we're displaying in the overlay.
   341|     Ensures that these TCFVendorRelationships records have the "basic" TCF attributes populated.
   342|     """
   343|     for privacy_declaration_row in matching_privacy_declarations:
   344|         vendor_id, system_identifier = get_system_identifiers(privacy_declaration_row)
   345|         vendor_relationship_record = vendor_map.get(system_identifier)
   346|         if not vendor_relationship_record:
   347|             vendor_relationship_record = TCFVendorRelationships(
   348|                 id=system_identifier,  # Identify system by vendor id if it exists, otherwise use system id.
   349|                 name=privacy_declaration_row.system_name,
   350|                 description=privacy_declaration_row.system_description,
   351|                 has_vendor_id=bool(
   352|                     vendor_id  # This will let us separate data between systems and vendors later
   353|                 ),
   354|             )
   355|             vendor_map[system_identifier] = vendor_relationship_record
   356|         vendor_relationship_record.cookie_max_age_seconds = (
   357|             privacy_declaration_row.system_cookie_max_age_seconds
   358|         )
   359|         vendor_relationship_record.uses_cookies = (
   360|             privacy_declaration_row.system_uses_cookies
   361|         )
   362|         vendor_relationship_record.cookie_refresh = (
   363|             privacy_declaration_row.system_cookie_refresh
   364|         )
   365|         vendor_relationship_record.uses_non_cookie_access = (
   366|             privacy_declaration_row.system_uses_non_cookie_access
   367|         )
   368|         vendor_relationship_record.legitimate_interest_disclosure_url = (
   369|             privacy_declaration_row.system_legitimate_interest_disclosure_url
   370|         )
   371|     return vendor_map
   372| def get_tcf_contents(
   373|     db: Session,
   374| ) -> TCFExperienceContents:
   375|     """
   376|     Returns the base contents of the TCF overlay.
   377|     Queries for systems/privacy declarations that have a relevant GVL data use and a legal basis of Consent or Legitimate interests,
   378|     and builds the TCF Overlay from these systems and privacy declarations.
   379|     TCF Overlay has Consent Purpose, Legitimate Interest Purpose, Special Purpose, Feature, and Special Feature Sections,
   380|     that have relevant systems and vendors embedded underneath.
   381|     We also have Consent Vendor, Legitimate Interests Vendor, and Vendor Relationships sections (same for systems),
   382|     which are almost a reverse representation, and have their own purposes and features embedded underneath.
   383|     """
   384|     vendor_consent_map: Dict[str, TCFVendorConsentRecord] = {}
   385|     vendor_legitimate_interests_map: Dict[str, TCFVendorLegitimateInterestsRecord] = {}
   386|     vendor_relationships_map: Dict[str, TCFVendorRelationships] = {}
   387|     matching_privacy_declarations: Query = get_matching_privacy_declarations(db)
   388|     (
   389|         purpose_consent_map,
   390|         updated_vendor_consent_map,
   391|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   392|         PURPOSE_DATA_USES,
   393|         tcf_component_type=TCFPurposeConsentRecord,
   394|         tcf_vendor_component_type=TCFVendorConsentRecord,
   395|         vendor_subsection_name="purpose_consents",
   396|         vendor_map=vendor_consent_map,
   397|         matching_privacy_declaration_query=matching_privacy_declarations.filter(
   398|             PrivacyDeclaration.legal_basis_for_processing
   399|             == LegalBasisForProcessingEnum.CONSENT
   400|         ),
   401|     )
   402|     (
   403|         purpose_legitimate_interests_map,
   404|         updated_vendor_legitimate_interests_map,
   405|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   406|         PURPOSE_DATA_USES,
   407|         tcf_component_type=TCFPurposeLegitimateInterestsRecord,
   408|         tcf_vendor_component_type=TCFVendorLegitimateInterestsRecord,
   409|         vendor_subsection_name="purpose_legitimate_interests",
   410|         vendor_map=vendor_legitimate_interests_map,
   411|         matching_privacy_declaration_query=matching_privacy_declarations.filter(
   412|             PrivacyDeclaration.legal_basis_for_processing
   413|             == LegalBasisForProcessingEnum.LEGITIMATE_INTEREST
   414|         ),
   415|     )
   416|     (
   417|         special_purpose_map,
   418|         updated_vendor_relationships_map,
   419|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   420|         SPECIAL_PURPOSE_DATA_USES,
   421|         tcf_component_type=TCFSpecialPurposeRecord,
   422|         tcf_vendor_component_type=TCFVendorRelationships,
   423|         vendor_subsection_name="special_purposes",
   424|         vendor_map=vendor_relationships_map,
   425|         matching_privacy_declaration_query=matching_privacy_declarations,
   426|     )
   427|     (
   428|         feature_map,
   429|         updated_vendor_relationships_map,
   430|     ) = build_purpose_or_feature_section_and_update_vendor_map(
   431|         [feature.name for feature in GVL_FEATURES.values()],
   432|         tcf_component_type=TCFFeatureRecord,
   433|         tcf_vendor_component_type=TCFVendorRelationships,

# --- HUNK 4: Lines 542-638 ---
   542|     db: Session,
   543|     tcf_field: Optional[str],
   544|     tcf_value: Union[Optional[str], Optional[int]],
   545| ) -> List[FidesKey]:
   546|     """Return a list of the system fides keys that match the given TCF attribute,
   547|     provided the system is relevant for TCF.
   548|     Used for consent reporting, to take a snapshot of the systems that are relevant at that point in time
   549|     """
   550|     starting_privacy_declarations: Query = get_matching_privacy_declarations(db)
   551|     purpose_data_uses: List[str] = []
   552|     if tcf_field in [
   553|         TCFComponentType.purpose_consent.value,
   554|         TCFComponentType.purpose_legitimate_interests.value,
   555|         TCFComponentType.special_purpose.value,
   556|     ]:
   557|         purpose_data_uses = purpose_to_data_use(
   558|             tcf_value, special_purpose="special" in tcf_field
   559|         )
   560|     if tcf_field == TCFComponentType.purpose_consent.value:
   561|         return systems_that_match_tcf_data_uses(
   562|             starting_privacy_declarations.filter(
   563|                 PrivacyDeclaration.legal_basis_for_processing
   564|                 == LegalBasisForProcessingEnum.CONSENT
   565|             ),
   566|             purpose_data_uses,
   567|         )
   568|     if tcf_field == TCFComponentType.purpose_legitimate_interests.value:
   569|         return systems_that_match_tcf_data_uses(
   570|             starting_privacy_declarations.filter(
   571|                 PrivacyDeclaration.legal_basis_for_processing
   572|                 == LegalBasisForProcessingEnum.LEGITIMATE_INTEREST
   573|             ),
   574|             purpose_data_uses,
   575|         )
   576|     if tcf_field == TCFComponentType.special_purpose.value:
   577|         return systems_that_match_tcf_data_uses(
   578|             starting_privacy_declarations, purpose_data_uses
   579|         )
   580|     if tcf_field in [
   581|         TCFComponentType.feature.value,
   582|         TCFComponentType.special_feature.value,
   583|     ]:
   584|         return systems_that_match_tcf_feature(
   585|             starting_privacy_declarations,
   586|             feature_id_to_feature_name(
   587|                 feature_id=tcf_value, special_feature="special" in tcf_field  # type: ignore[arg-type]
   588|             ),
   589|         )
   590|     if tcf_field == TCFComponentType.vendor_consent.value:
   591|         return systems_that_match_vendor_string(
   592|             starting_privacy_declarations.filter(
   593|                 PrivacyDeclaration.legal_basis_for_processing
   594|                 == LegalBasisForProcessingEnum.CONSENT
   595|             ),
   596|             tcf_value,  # type: ignore[arg-type]
   597|         )
   598|     if tcf_field == TCFComponentType.vendor_legitimate_interests.value:
   599|         return systems_that_match_vendor_string(
   600|             starting_privacy_declarations.filter(
   601|                 PrivacyDeclaration.legal_basis_for_processing
   602|                 == LegalBasisForProcessingEnum.LEGITIMATE_INTEREST
   603|             ),
   604|             tcf_value,  # type: ignore[arg-type]
   605|         )
   606|     if tcf_field == TCFComponentType.system_consent.value:
   607|         return systems_that_match_system_id(
   608|             starting_privacy_declarations.filter(
   609|                 PrivacyDeclaration.legal_basis_for_processing
   610|                 == LegalBasisForProcessingEnum.CONSENT
   611|             ),
   612|             tcf_value
   613|         )
   614|     if tcf_field == TCFComponentType.system_legitimate_interests.value:
   615|         return systems_that_match_system_id(
   616|             starting_privacy_declarations.filter(
   617|                 PrivacyDeclaration.legal_basis_for_processing
   618|                 == LegalBasisForProcessingEnum.LEGITIMATE_INTEREST
   619|             ),
   620|             tcf_value,  # type: ignore[arg-type]
   621|         )
   622|     return []
   623| def systems_that_match_tcf_feature(
   624|     matching_privacy_declarations: Query, feature: Optional[str]
   625| ) -> List[FidesKey]:
   626|     """Check which systems have these data uses directly and are also relevant for TCF.
   627|     This is used for determining relevant systems for TCF features and special features. Unlike
   628|     determining relevant systems for Privacy Notices where we use a hierarchy-type matching,
   629|     for TCF, we're looking for an exact match on feature."""
   630|     if not feature:
   631|         return []
   632|     return list(
   633|         {
   634|             privacy_declaration_record.system_fides_key
   635|             for privacy_declaration_record in matching_privacy_declarations.filter(
   636|                 PrivacyDeclaration.features.any(feature)
   637|             )
   638|         }

