# ====================================================================
# FILE: sanic/__version__.py
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-1 ---
     1| __version__ = "20.12.7"


# ====================================================================
# FILE: sanic/static.py
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-73 ---
     1| from functools import partial, wraps
     2| from mimetypes import guess_type
     3| from os import path, sep
     4| from pathlib import Path
     5| from time import gmtime, strftime
     6| from urllib.parse import unquote
     7| from sanic.compat import stat_async
     8| from sanic.exceptions import (
     9|     ContentRangeError,
    10|     FileNotFound,
    11|     HeaderNotFound,
    12|     InvalidUsage,
    13| )
    14| from sanic.handlers import ContentRangeHandler
    15| from sanic.log import error_logger
    16| from sanic.response import HTTPResponse, file, file_stream
    17| async def _static_request_handler(
    18|     file_or_directory,
    19|     use_modified_since,
    20|     use_content_range,
    21|     stream_large_files,
    22|     request,
    23|     content_type=None,
    24|     file_uri=None,
    25| ):
    26|     file_path_raw = Path(unquote(file_or_directory))
    27|     root_path = file_path = file_path_raw.resolve()
    28|     not_found = FileNotFound(
    29|         "File not found",
    30|         path=file_or_directory,
    31|         relative_url=file_uri,
    32|     )
    33|     if file_uri:
    34|         unquoted_file_uri = unquote(file_uri).lstrip("/")
    35|         file_path_raw = Path(file_or_directory, unquoted_file_uri)
    36|         file_path = file_path_raw.resolve()
    37|         if (
    38|             file_path < root_path and not file_path_raw.is_symlink()
    39|         ) or ".." in file_path_raw.parts:
    40|             error_logger.exception(
    41|                 f"File not found: path={file_or_directory}, "
    42|                 f"relative_url={file_uri}"
    43|             )
    44|             raise not_found
    45|     try:
    46|         file_path.relative_to(root_path)
    47|     except ValueError:
    48|         if not file_path_raw.is_symlink():
    49|             error_logger.exception(
    50|                 f"File not found: path={file_or_directory}, "
    51|                 f"relative_url={file_uri}"
    52|             )
    53|             raise not_found
    54|     try:
    55|         headers = {}
    56|         stats = None
    57|         if use_modified_since:
    58|             stats = await stat_async(file_path)
    59|             modified_since = strftime(
    60|                 "%a, %d %b %Y %H:%M:%S GMT", gmtime(stats.st_mtime)
    61|             )
    62|             if request.headers.get("If-Modified-Since") == modified_since:
    63|                 return HTTPResponse(status=304)
    64|             headers["Last-Modified"] = modified_since
    65|         _range = None
    66|         if use_content_range:
    67|             _range = None
    68|             if not stats:
    69|                 stats = await stat_async(file_path)
    70|             headers["Accept-Ranges"] = "bytes"
    71|             headers["Content-Length"] = str(stats.st_size)
    72|             if request.method != "HEAD":
    73|                 try:

