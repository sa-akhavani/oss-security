# ====================================================================
# FILE: core/src/main/scala/com/softwaremill/session/CsrfDirectives.scala
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-41 ---
     1| package com.softwaremill.session
     2| import akka.http.scaladsl.server.Directives._
     3| import akka.http.scaladsl.server.{Directive0, Directive1}
     4| import akka.stream.Materializer
     5| trait CsrfDirectives {
     6|   /**
     7|     * Protects against CSRF attacks using a double-submit cookie. The cookie will be set on any `GET` request which
     8|     * doesn't have the token set in the header. For all other requests, the value of the token from the CSRF cookie must
     9|     * match the value in the custom header (or request body, if `checkFormBody` is `true`).
    10|     *
    11|     * Note that this scheme can be broken when not all subdomains are protected or not using HTTPS and secure cookies,
    12|     * and the token is placed in the request body (not in the header).
    13|     *
    14|     * See the documentation for more details.
    15|     */
    16|   def randomTokenCsrfProtection[T](checkMode: CsrfCheckMode[T]): Directive0 = {
    17|     csrfTokenFromCookie(checkMode).flatMap {
    18|       case Some(cookie) =>
    19|         get.recover { _ =>
    20|           submittedCsrfToken(checkMode).flatMap { submitted =>
    21|             if (submitted == cookie) {
    22|               pass
    23|             } else {
    24|               reject(checkMode.csrfManager.tokenInvalidRejection).toDirective[Unit]
    25|             }
    26|           }
    27|         }
    28|       case None =>
    29|         (get & setNewCsrfToken(checkMode)).recover(_ => reject(checkMode.csrfManager.tokenInvalidRejection))
    30|     }
    31|   }
    32|   def submittedCsrfToken[T](checkMode: CsrfCheckMode[T]): Directive1[String] = {
    33|     headerValueByName(checkMode.manager.config.csrfSubmittedName).recover { rejections =>
    34|       checkMode match {
    35|         case c: CheckHeaderAndForm[T] =>
    36|           import c.materializer
    37|           formField(checkMode.manager.config.csrfSubmittedName)
    38|         case _ => reject(rejections: _*)
    39|       }
    40|     }
    41|   }

