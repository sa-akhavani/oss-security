# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/lookup/adapters/CSVFileDataAdapter.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 41-81 ---
    41| import javax.validation.constraints.Min;
    42| import javax.validation.constraints.NotEmpty;
    43| import javax.validation.constraints.Size;
    44| import java.io.IOException;
    45| import java.io.InputStream;
    46| import java.io.InputStreamReader;
    47| import java.nio.charset.StandardCharsets;
    48| import java.nio.file.Files;
    49| import java.nio.file.Path;
    50| import java.nio.file.Paths;
    51| import java.util.Locale;
    52| import java.util.Map;
    53| import java.util.Optional;
    54| import java.util.concurrent.atomic.AtomicReference;
    55| import static com.google.common.base.Strings.isNullOrEmpty;
    56| public class CSVFileDataAdapter extends LookupDataAdapter {
    57|     private static final Logger LOG = LoggerFactory.getLogger(CSVFileDataAdapter.class);
    58|     public static final String NAME = "csvfile";
    59|     private final Config config;
    60|     private final AtomicReference<Map<String, String>> lookupRef = new AtomicReference<>(ImmutableMap.of());
    61|     private FileInfo fileInfo;
    62|     @Inject
    63|     public CSVFileDataAdapter(@Assisted("id") String id,
    64|                               @Assisted("name") String name,
    65|                               @Assisted LookupDataAdapterConfiguration config,
    66|                               MetricRegistry metricRegistry) {
    67|         super(id, name, config, metricRegistry);
    68|         this.config = (Config) config;
    69|     }
    70|     @Override
    71|     public void doStart() throws Exception {
    72|         LOG.debug("Starting CSV data adapter for file: {}", config.path());
    73|         if (isNullOrEmpty(config.path())) {
    74|             throw new IllegalStateException("File path needs to be set");
    75|         }
    76|         if (config.checkInterval() < 1) {
    77|             throw new IllegalStateException("Check interval setting cannot be smaller than 1");
    78|         }
    79|         fileInfo = FileInfo.forPath(Paths.get(config.path()));
    80|         lookupRef.set(parseCSVFile());
    81|     }


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/periodical/ThrottleStateUpdaterThread.java
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 2-88 ---
     2|  * This file is part of Graylog.
     3|  *
     4|  * Graylog is free software: you can redistribute it and/or modify
     5|  * it under the terms of the GNU General Public License as published by
     6|  * the Free Software Foundation, either version 3 of the License, or
     7|  * (at your option) any later version.
     8|  *
     9|  * Graylog is distributed in the hope that it will be useful,
    10|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    11|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    12|  * GNU General Public License for more details.
    13|  *
    14|  * You should have received a copy of the GNU General Public License
    15|  * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.
    16|  */
    17| package org.graylog2.periodical;
    18| import com.codahale.metrics.Gauge;
    19| import com.codahale.metrics.MetricRegistry;
    20| import com.codahale.metrics.RatioGauge;
    21| import com.github.joschi.jadconfig.util.Size;
    22| import org.graylog2.notifications.Notification;
    23| import org.graylog2.notifications.NotificationService;
    24| import org.graylog2.plugin.GlobalMetricNames;
    25| import org.graylog2.plugin.ServerStatus;
    26| import org.graylog2.plugin.ThrottleState;
    27| import org.graylog2.plugin.periodical.Periodical;
    28| import org.graylog2.shared.buffers.ProcessBuffer;
    29| import org.graylog2.shared.journal.Journal;
    30| import org.graylog2.shared.journal.KafkaJournal;
    31| import org.slf4j.Logger;
    32| import org.slf4j.LoggerFactory;
    33| import javax.inject.Inject;
    34| import javax.inject.Named;
    35| import static org.graylog2.shared.metrics.MetricUtils.safelyRegister;
    36| /**
    37|  * The ThrottleStateUpdater publishes the current state buffer state of the journal to other interested parties,
    38|  * chiefly the ThrottleableTransports.
    39|  * <p/>
    40|  * <p>
    41|  * It only includes the necessary information to make a decision about whether to throttle parts of the system,
    42|  * but does not send "throttle" commands. This allows for a flexible approach in picking a throttling strategy.
    43|  * </p>
    44|  * <p>
    45|  * The implementation expects to be called once per second to have a rough estimate about the events per second,
    46|  * over the last second.
    47|  * </p>
    48|  */
    49| public class ThrottleStateUpdaterThread extends Periodical {
    50|     private static final Logger log = LoggerFactory.getLogger(ThrottleStateUpdaterThread.class);
    51|     private final KafkaJournal journal;
    52|     private final ProcessBuffer processBuffer;
    53|     private final Size retentionSize;
    54|     private final NotificationService notificationService;
    55|     private final ServerStatus serverStatus;
    56|     private boolean firstRun = true;
    57|     private long logEndOffset;
    58|     private long currentReadOffset;
    59|     private long currentTs;
    60|     private ThrottleState throttleState;
    61|     @Inject
    62|     public ThrottleStateUpdaterThread(final Journal journal,
    63|                                       ProcessBuffer processBuffer,
    64|                                       NotificationService notificationService,
    65|                                       ServerStatus serverStatus,
    66|                                       MetricRegistry metricRegistry,
    67|                                       @Named("message_journal_max_size") Size retentionSize) {
    68|         this.processBuffer = processBuffer;
    69|         this.retentionSize = retentionSize;
    70|         this.notificationService = notificationService;
    71|         this.serverStatus = serverStatus;
    72|         if (journal instanceof KafkaJournal) {
    73|             this.journal = (KafkaJournal) journal;
    74|         } else {
    75|             this.journal = null;
    76|         }
    77|         throttleState = new ThrottleState();
    78|         safelyRegister(metricRegistry,
    79|                        GlobalMetricNames.JOURNAL_APPEND_RATE,
    80|                        new Gauge<Long>() {
    81|                            @Override
    82|                            public Long getValue() {
    83|                                return throttleState.appendEventsPerSec;
    84|                            }
    85|                        });
    86|         safelyRegister(metricRegistry,
    87|                        GlobalMetricNames.JOURNAL_READ_RATE,
    88|                        new Gauge<Long>() {

# --- HUNK 2: Lines 178-215 ---
   178|         long previousReadOffset = currentReadOffset;
   179|         long logStartOffset = journal.getLogStartOffset();
   180|         logEndOffset = journal.getLogEndOffset() - 1; // -1 because getLogEndOffset is the next offset that gets assigned
   181|         currentReadOffset = journal.getNextReadOffset() - 1; // just to make it clear which field we read
   182|         if (firstRun) {
   183|             firstRun = false;
   184|             return;
   185|         }
   186|         throttleState.appendEventsPerSec = (long) Math.floor((logEndOffset - previousLogEndOffset) / ((currentTs - prevTs) / 1.0E09));
   187|         throttleState.readEventsPerSec = (long) Math.floor((currentReadOffset - previousReadOffset) / ((currentTs - prevTs) / 1.0E09));
   188|         throttleState.journalSize = journal.size();
   189|         throttleState.journalSizeLimit = retentionSize.toBytes();
   190|         throttleState.processBufferCapacity = processBuffer.getRemainingCapacity();
   191|         if (committedOffset == KafkaJournal.DEFAULT_COMMITTED_OFFSET) {
   192|             throttleState.uncommittedJournalEntries = journal.size() == 0 ? 0 : logEndOffset - logStartOffset;
   193|         } else {
   194|             throttleState.uncommittedJournalEntries = logEndOffset - committedOffset;
   195|         }
   196|         log.debug("ThrottleState: {}", throttleState);
   197|         journal.setThrottleState(throttleState);
   198|         final double journalUtilizationPercentage = throttleState.journalSizeLimit > 0 ? (throttleState.journalSize * 100) / throttleState.journalSizeLimit : 0.0;
   199|         if (journalUtilizationPercentage > KafkaJournal.NOTIFY_ON_UTILIZATION_PERCENTAGE) {
   200|             Notification notification = notificationService.buildNow()
   201|                     .addNode(serverStatus.getNodeId().toString())
   202|                     .addType(Notification.Type.JOURNAL_UTILIZATION_TOO_HIGH)
   203|                     .addSeverity(Notification.Severity.URGENT)
   204|                     .addDetail("journal_utilization_percentage", journalUtilizationPercentage);
   205|             notificationService.publishIfFirst(notification);
   206|         }
   207|         if (journal.getPurgedSegmentsInLastRetention() > 0) {
   208|             Notification notification = notificationService.buildNow()
   209|                     .addNode(serverStatus.getNodeId().toString())
   210|                     .addType(Notification.Type.JOURNAL_UNCOMMITTED_MESSAGES_DELETED)
   211|                     .addSeverity(Notification.Severity.URGENT);
   212|             notificationService.publishIfFirst(notification);
   213|         }
   214|     }
   215| }


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/plugin/BaseConfiguration.java
# Total hunks: 3
# ====================================================================
# --- HUNK 1: Lines 12-51 ---
    12|  * GNU General Public License for more details.
    13|  *
    14|  * You should have received a copy of the GNU General Public License
    15|  * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.
    16|  */
    17| package org.graylog2.plugin;
    18| import com.github.joschi.jadconfig.Parameter;
    19| import com.github.joschi.jadconfig.ValidationException;
    20| import com.github.joschi.jadconfig.ValidatorMethod;
    21| import com.github.joschi.jadconfig.util.Duration;
    22| import com.github.joschi.jadconfig.validators.PositiveDurationValidator;
    23| import com.github.joschi.jadconfig.validators.PositiveIntegerValidator;
    24| import com.github.joschi.jadconfig.validators.StringNotBlankValidator;
    25| import com.github.joschi.jadconfig.validators.URIAbsoluteValidator;
    26| import com.google.common.annotations.VisibleForTesting;
    27| import com.lmax.disruptor.BlockingWaitStrategy;
    28| import com.lmax.disruptor.BusySpinWaitStrategy;
    29| import com.lmax.disruptor.SleepingWaitStrategy;
    30| import com.lmax.disruptor.WaitStrategy;
    31| import com.lmax.disruptor.YieldingWaitStrategy;
    32| import org.slf4j.Logger;
    33| import org.slf4j.LoggerFactory;
    34| import java.net.InetAddress;
    35| import java.net.URI;
    36| import java.net.URISyntaxException;
    37| import java.net.UnknownHostException;
    38| import java.nio.file.Files;
    39| import java.nio.file.Path;
    40| @SuppressWarnings("FieldMayBeFinal")
    41| public abstract class BaseConfiguration {
    42|     private static final Logger LOG = LoggerFactory.getLogger(BaseConfiguration.class);
    43|     protected static final String WILDCARD_IP_ADDRESS = "0.0.0.0";
    44|     protected static final int GRAYLOG_DEFAULT_PORT = 9000;
    45|     protected static final int GRAYLOG_DEFAULT_WEB_PORT = 9000;
    46|     @Parameter(value = "shutdown_timeout", validator = PositiveIntegerValidator.class)
    47|     protected int shutdownTimeout = 30000;
    48|     @Parameter(value = "rest_transport_uri", validator = URIAbsoluteValidator.class)
    49|     private URI restTransportUri;
    50|     @Parameter(value = "processbuffer_processors", required = true, validator = PositiveIntegerValidator.class)
    51|     private int processBufferProcessors = 5;

# --- HUNK 2: Lines 74-113 ---
    74|     @Parameter(value = "rest_tls_key_file")
    75|     private Path restTlsKeyFile;
    76|     @Parameter(value = "rest_tls_key_password")
    77|     private String restTlsKeyPassword;
    78|     @Parameter(value = "plugin_dir")
    79|     private String pluginDir = "plugin";
    80|     @Parameter(value = "async_eventbus_processors")
    81|     private int asyncEventbusProcessors = 2;
    82|     @Parameter(value = "udp_recvbuffer_sizes", required = true, validator = PositiveIntegerValidator.class)
    83|     private int udpRecvBufferSizes = 1048576;
    84|     @Parameter("message_journal_enabled")
    85|     private boolean messageJournalEnabled = true;
    86|     @Parameter("inputbuffer_processors")
    87|     private int inputbufferProcessors = 2;
    88|     @Parameter("message_recordings_enable")
    89|     private boolean messageRecordingsEnable = false;
    90|     @Parameter("disable_sigar")
    91|     private boolean disableSigar = false;
    92|     @Parameter(value = "http_proxy_uri")
    93|     private URI httpProxyUri;
    94|     @Parameter(value = "http_connect_timeout", validator = PositiveDurationValidator.class)
    95|     private Duration httpConnectTimeout = Duration.seconds(5L);
    96|     @Parameter(value = "http_write_timeout", validator = PositiveDurationValidator.class)
    97|     private Duration httpWriteTimeout = Duration.seconds(10L);
    98|     @Parameter(value = "http_read_timeout", validator = PositiveDurationValidator.class)
    99|     private Duration httpReadTimeout = Duration.seconds(10L);
   100|     @Parameter(value = "installation_source", validator = StringNotBlankValidator.class)
   101|     private String installationSource = "unknown";
   102|     @Parameter(value = "web_enable")
   103|     private boolean webEnable = true;
   104|     @Parameter(value = "web_endpoint_uri")
   105|     private URI webEndpointUri;
   106|     @Parameter(value = "web_enable_cors")
   107|     private boolean webEnableCors = false;
   108|     @Parameter(value = "web_enable_gzip")
   109|     private boolean webEnableGzip = true;
   110|     @Parameter(value = "web_max_header_size", required = true, validator = PositiveIntegerValidator.class)
   111|     private int webMaxHeaderSize = 8192;
   112|     @Parameter(value = "web_enable_tls")
   113|     private boolean webEnableTls = false;

# --- HUNK 3: Lines 254-293 ---
   254|         this.messageJournalEnabled = messageJournalEnabled;
   255|     }
   256|     public int getInputbufferProcessors() {
   257|         return inputbufferProcessors;
   258|     }
   259|     public int getShutdownTimeout() {
   260|         return shutdownTimeout;
   261|     }
   262|     public int getUdpRecvBufferSizes() {
   263|         return udpRecvBufferSizes;
   264|     }
   265|     public boolean isMessageRecordingsEnabled() {
   266|         return messageRecordingsEnable;
   267|     }
   268|     public boolean isDisableSigar() {
   269|         return disableSigar;
   270|     }
   271|     public URI getHttpProxyUri() {
   272|         return httpProxyUri;
   273|     }
   274|     public Duration getHttpConnectTimeout() {
   275|         return httpConnectTimeout;
   276|     }
   277|     public Duration getHttpWriteTimeout() {
   278|         return httpWriteTimeout;
   279|     }
   280|     public Duration getHttpReadTimeout() {
   281|         return httpReadTimeout;
   282|     }
   283|     public String getInstallationSource() {
   284|         return installationSource;
   285|     }
   286|     public boolean isWebEnable() {
   287|         return webEnable;
   288|     }
   289|     public boolean isRestAndWebOnSamePort() {
   290|         final URI restListenUri = getRestListenUri();
   291|         final URI webListenUri = getWebListenUri();
   292|         try {
   293|             final InetAddress restAddress = InetAddress.getByName(restListenUri.getHost());


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/plugin/utilities/FileInfo.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-89 ---
     1| /**
     2|  * This file is part of Graylog.
     3|  *
     4|  * Graylog is free software: you can redistribute it and/or modify
     5|  * it under the terms of the GNU General Public License as published by
     6|  * the Free Software Foundation, either version 3 of the License, or
     7|  * (at your option) any later version.
     8|  *
     9|  * Graylog is distributed in the hope that it will be useful,
    10|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    11|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    12|  * GNU General Public License for more details.
    13|  *
    14|  * You should have received a copy of the GNU General Public License
    15|  * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.
    16|  */
    17| package org.graylog2.plugin.utilities;
    18| import com.google.auto.value.AutoValue;
    19| import javax.annotation.Nullable;
    20| import javax.validation.constraints.NotNull;
    21| import java.io.IOException;
    22| import java.nio.file.Files;
    23| import java.nio.file.Path;
    24| import java.nio.file.attribute.BasicFileAttributes;
    25| import java.nio.file.attribute.FileTime;
    26| import java.util.Objects;
    27| /**
    28|  * A {@code FileInfo} presents a concise way of checking for file modification based on its file system attributes.
    29|  * <p>
    30|  *     Construct it via its {@link FileInfo#forPath(Path)} method and later use the {@link #checkForChange()} method
    31|  *     whenever you want to act if a modification has occurred. The returned {@link Change} object contains whether
    32|  *     the file has actually changed and the new file info object to use in future checks.
    33|  * </p>
    34|  */
    35| @AutoValue
    36| public abstract class FileInfo {
    37|     @Nullable
    38|     public abstract Object key();
    39|     public abstract long size();
    40|     @Nullable
    41|     public abstract FileTime modificationTime();
    42|     public abstract Path path();
    43|     public static Builder builder() {
    44|         return new AutoValue_FileInfo.Builder();
    45|     }
    46|     /**
    47|      * Create a file info for the given path.
    48|      *
    49|      * @param path the path must exist, otherwise an IllegalArgumentException is thrown
    50|      * @return the file info object
    51|      */
    52|     @NotNull
    53|     public static FileInfo forPath(Path path) {
    54|         try {
    55|             final BasicFileAttributes attributes = Files.readAttributes(path, BasicFileAttributes.class);
    56|             return FileInfo.builder()
    57|                     .path(path)
    58|                     .key(attributes.fileKey())
    59|                     .size(attributes.size())
    60|                     .modificationTime(attributes.lastModifiedTime())
    61|                     .build();
    62|         } catch (IOException e) {
    63|             return FileInfo.builder()
    64|                     .key(null)
    65|                     .modificationTime(null)
    66|                     .size(-1L)
    67|                     .path(path)
    68|                     .build();
    69|         }
    70|     }
    71|     @NotNull
    72|     public FileInfo.Change checkForChange() {
    73|         final FileInfo newFileInfo = forPath(path());
    74|         if (newFileInfo.equals(this)) {
    75|             return Change.none();
    76|         }
    77|         return new Change(newFileInfo);
    78|     }
    79|     @AutoValue.Builder
    80|     public abstract static class Builder {
    81|         public abstract Builder key(@Nullable Object key);
    82|         public abstract Builder size(long size);
    83|         public abstract Builder modificationTime(@Nullable FileTime modificationTime);
    84|         public abstract Builder path(Path path);
    85|         public abstract FileInfo build();
    86|     }
    87|     public static class Change {
    88|         private static final Change NONE = new Change(null);
    89|         private final FileInfo info;


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/rest/resources/system/inputs/InputsResource.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 123-162 ---
   123|                     .path("{inputId}")
   124|                     .build(newId);
   125|             return Response.created(inputUri).entity(InputCreated.create(newId)).build();
   126|         } catch (NoSuchInputTypeException e) {
   127|             LOG.error("There is no such input type registered.", e);
   128|             throw new NotFoundException("There is no such input type registered.", e);
   129|         } catch (ConfigurationException e) {
   130|             LOG.error("Missing or invalid input configuration.", e);
   131|             throw new BadRequestException("Missing or invalid input configuration.", e);
   132|         }
   133|     }
   134|     @DELETE
   135|     @Timed
   136|     @Path("/{inputId}")
   137|     @ApiOperation(value = "Terminate input on this node")
   138|     @ApiResponses(value = {
   139|             @ApiResponse(code = 404, message = "No such input on this node.")
   140|     })
   141|     @AuditEvent(type = AuditEventTypes.MESSAGE_INPUT_DELETE)
   142|     public void terminate(@ApiParam(name = "inputId", required = true) @PathParam("inputId") String inputId) throws org.graylog2.database.NotFoundException {
   143|         final Input input = inputService.find(inputId);
   144|         inputService.destroy(input);
   145|     }
   146|     @PUT
   147|     @Timed
   148|     @Path("/{inputId}")
   149|     @ApiOperation(
   150|             value = "Update input on this node",
   151|             response = InputCreated.class
   152|     )
   153|     @ApiResponses(value = {
   154|             @ApiResponse(code = 404, message = "No such input on this node."),
   155|             @ApiResponse(code = 400, message = "Missing or invalid input configuration.")
   156|     })
   157|     @AuditEvent(type = AuditEventTypes.MESSAGE_INPUT_UPDATE)
   158|     public Response update(@ApiParam(name = "JSON body", required = true) @Valid @NotNull InputCreateRequest lr,
   159|                            @ApiParam(name = "inputId", required = true) @PathParam("inputId") String inputId) throws org.graylog2.database.NotFoundException, NoSuchInputTypeException, ConfigurationException, ValidationException {
   160|         checkPermission(RestPermissions.INPUTS_EDIT, inputId);
   161|         final Input input = inputService.find(inputId);
   162|         final Map<String, Object> mergedInput = input.getFields();


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/rest/resources/system/logs/LoggersResource.java
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 17-56 ---
    17| package org.graylog2.rest.resources.system.logs;
    18| import com.codahale.metrics.annotation.Timed;
    19| import com.google.common.annotations.VisibleForTesting;
    20| import com.google.common.collect.ImmutableMap;
    21| import com.google.common.collect.Maps;
    22| import io.swagger.annotations.Api;
    23| import io.swagger.annotations.ApiOperation;
    24| import io.swagger.annotations.ApiParam;
    25| import io.swagger.annotations.ApiResponse;
    26| import io.swagger.annotations.ApiResponses;
    27| import org.apache.logging.log4j.Level;
    28| import org.apache.logging.log4j.LogManager;
    29| import org.apache.logging.log4j.Marker;
    30| import org.apache.logging.log4j.core.Appender;
    31| import org.apache.logging.log4j.core.LogEvent;
    32| import org.apache.logging.log4j.core.LoggerContext;
    33| import org.apache.logging.log4j.core.config.Configuration;
    34| import org.apache.logging.log4j.core.config.LoggerConfig;
    35| import org.apache.logging.log4j.core.impl.ThrowableProxy;
    36| import org.apache.shiro.authz.annotation.RequiresAuthentication;
    37| import org.graylog2.audit.AuditEventTypes;
    38| import org.graylog2.audit.jersey.AuditEvent;
    39| import org.graylog2.log4j.MemoryAppender;
    40| import org.graylog2.rest.models.system.loggers.responses.InternalLogMessage;
    41| import org.graylog2.rest.models.system.loggers.responses.LogMessagesSummary;
    42| import org.graylog2.rest.models.system.loggers.responses.LoggersSummary;
    43| import org.graylog2.rest.models.system.loggers.responses.SingleLoggerSummary;
    44| import org.graylog2.rest.models.system.loggers.responses.SingleSubsystemSummary;
    45| import org.graylog2.rest.models.system.loggers.responses.SubsystemSummary;
    46| import org.graylog2.shared.rest.resources.RestResource;
    47| import org.graylog2.shared.security.RestPermissions;
    48| import org.joda.time.DateTime;
    49| import org.joda.time.DateTimeZone;
    50| import org.slf4j.LoggerFactory;
    51| import javax.validation.constraints.Min;
    52| import javax.validation.constraints.NotEmpty;
    53| import javax.ws.rs.DefaultValue;
    54| import javax.ws.rs.GET;
    55| import javax.ws.rs.InternalServerErrorException;
    56| import javax.ws.rs.NotFoundException;

# --- HUNK 2: Lines 175-214 ---
   175|             notes = "Provided level is falling back to DEBUG if it does not exist")
   176|     @Path("/{loggerName}/level/{level}")
   177|     @AuditEvent(type = AuditEventTypes.LOG_LEVEL_UPDATE)
   178|     public void setSingleLoggerLevel(
   179|         @ApiParam(name = "loggerName", required = true) @PathParam("loggerName") @NotEmpty String loggerName,
   180|         @ApiParam(name = "level", required = true) @NotEmpty @PathParam("level") String level) {
   181|         checkPermission(RestPermissions.LOGGERS_EDIT, loggerName);
   182|         final Level newLevel = Level.toLevel(level.toUpperCase(Locale.ENGLISH));
   183|         setLoggerLevel(loggerName, newLevel);
   184|         LOG.debug("Successfully set log level for logger \"{}\" to \"{}\"", loggerName, newLevel);
   185|     }
   186|     @GET
   187|     @Timed
   188|     @ApiOperation(value = "Get recent internal log messages")
   189|     @ApiResponses(value = {
   190|             @ApiResponse(code = 404, message = "Memory appender is disabled."),
   191|             @ApiResponse(code = 500, message = "Memory appender is broken.")
   192|     })
   193|     @Path("/messages/recent")
   194|     @Produces(MediaType.APPLICATION_JSON)
   195|     public LogMessagesSummary messages(@ApiParam(name = "limit", value = "How many log messages should be returned", defaultValue = "500", allowableValues = "range[0, infinity]")
   196|                                        @QueryParam("limit") @DefaultValue("500") @Min(0L) int limit,
   197|                                        @ApiParam(name = "level", value = "Which log level (or higher) should the messages have", defaultValue = "ALL", allowableValues = "[OFF, FATAL, ERROR, WARN, INFO, DEBUG, TRACE, ALL]")
   198|                                        @QueryParam("level") @DefaultValue("ALL") @NotEmpty String level) {
   199|         final Appender appender = getAppender(MEMORY_APPENDER_NAME);
   200|         if (appender == null) {
   201|             throw new NotFoundException("Memory appender is disabled. Please refer to the example log4j.xml file.");
   202|         }
   203|         if (!(appender instanceof MemoryAppender)) {
   204|             throw new InternalServerErrorException("Memory appender is not an instance of MemoryAppender. Please refer to the example log4j.xml file.");
   205|         }
   206|         final Level logLevel = Level.toLevel(level, Level.ALL);
   207|         final MemoryAppender memoryAppender = (MemoryAppender) appender;
   208|         final List<InternalLogMessage> messages = new ArrayList<>(limit);
   209|         for (LogEvent event : memoryAppender.getLogMessages(limit)) {
   210|             final Level eventLevel = event.getLevel();
   211|             if (!eventLevel.isMoreSpecificThan(logLevel)) {
   212|                 continue;
   213|             }
   214|             final ThrowableProxy thrownProxy = event.getThrownProxy();


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/shared/bindings/providers/OkHttpClientProvider.java
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 8-110 ---
     8|  *
     9|  * Graylog is distributed in the hope that it will be useful,
    10|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    11|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    12|  * GNU General Public License for more details.
    13|  *
    14|  * You should have received a copy of the GNU General Public License
    15|  * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.
    16|  */
    17| package org.graylog2.shared.bindings.providers;
    18| import com.github.joschi.jadconfig.util.Duration;
    19| import com.google.common.base.Splitter;
    20| import com.google.common.collect.ImmutableList;
    21| import okhttp3.Authenticator;
    22| import okhttp3.Challenge;
    23| import okhttp3.Credentials;
    24| import okhttp3.OkHttpClient;
    25| import okhttp3.Request;
    26| import okhttp3.Response;
    27| import okhttp3.Route;
    28| import org.slf4j.Logger;
    29| import org.slf4j.LoggerFactory;
    30| import javax.annotation.Nonnull;
    31| import javax.annotation.Nullable;
    32| import javax.inject.Inject;
    33| import javax.inject.Named;
    34| import javax.inject.Provider;
    35| import javax.inject.Singleton;
    36| import java.io.IOException;
    37| import java.net.InetAddress;
    38| import java.net.InetSocketAddress;
    39| import java.net.Proxy;
    40| import java.net.ProxySelector;
    41| import java.net.SocketAddress;
    42| import java.net.URI;
    43| import java.net.UnknownHostException;
    44| import java.util.List;
    45| import java.util.Locale;
    46| import java.util.Set;
    47| import java.util.stream.Collectors;
    48| import static com.google.common.base.Strings.isNullOrEmpty;
    49| import static com.google.common.net.HttpHeaders.PROXY_AUTHORIZATION;
    50| import static java.util.Objects.requireNonNull;
    51| /**
    52|  * Provider for a configured {@link okhttp3.OkHttpClient}.
    53|  *
    54|  * @see org.graylog2.plugin.BaseConfiguration#getHttpConnectTimeout()
    55|  * @see org.graylog2.plugin.BaseConfiguration#getHttpReadTimeout()
    56|  * @see org.graylog2.plugin.BaseConfiguration#getHttpWriteTimeout()
    57|  * @see org.graylog2.plugin.BaseConfiguration#getHttpProxyUri()
    58|  */
    59| @Singleton
    60| public class OkHttpClientProvider implements Provider<OkHttpClient> {
    61|     private static final Logger LOG = LoggerFactory.getLogger(OkHttpClientProvider.class);
    62|     protected final Duration connectTimeout;
    63|     protected final Duration readTimeout;
    64|     protected final Duration writeTimeout;
    65|     protected final URI httpProxyUri;
    66|     @Inject
    67|     public OkHttpClientProvider(@Named("http_connect_timeout") Duration connectTimeout,
    68|                                 @Named("http_read_timeout") Duration readTimeout,
    69|                                 @Named("http_write_timeout") Duration writeTimeout,
    70|                                 @Named("http_proxy_uri") @Nullable URI httpProxyUri) {
    71|         this.connectTimeout = requireNonNull(connectTimeout);
    72|         this.readTimeout = requireNonNull(readTimeout);
    73|         this.writeTimeout = requireNonNull(writeTimeout);
    74|         this.httpProxyUri = httpProxyUri;
    75|     }
    76|     @Override
    77|     public OkHttpClient get() {
    78|         final OkHttpClient.Builder clientBuilder = new OkHttpClient.Builder()
    79|                 .retryOnConnectionFailure(true)
    80|                 .connectTimeout(connectTimeout.getQuantity(), connectTimeout.getUnit())
    81|                 .writeTimeout(writeTimeout.getQuantity(), writeTimeout.getUnit())
    82|                 .readTimeout(readTimeout.getQuantity(), readTimeout.getUnit());
    83|         if (httpProxyUri != null) {
    84|             final Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress(httpProxyUri.getHost(), httpProxyUri.getPort()));
    85|             final ProxySelector proxySelector = new ProxySelector() {
    86|                 @Override
    87|                 public List<Proxy> select(URI uri) {
    88|                     try {
    89|                         final InetAddress targetAddress = InetAddress.getByName(uri.getHost());
    90|                         if (targetAddress.isLoopbackAddress()) {
    91|                             return ImmutableList.of(Proxy.NO_PROXY);
    92|                         }
    93|                     } catch (UnknownHostException e) {
    94|                         LOG.debug("Unable to resolve host name for proxy selection: ", e);
    95|                     }
    96|                     return ImmutableList.of(proxy);
    97|                 }
    98|                 @Override
    99|                 public void connectFailed(URI uri, SocketAddress sa, IOException ioe) {
   100|                     LOG.warn("Unable to connect to proxy: ", ioe);
   101|                 }
   102|             };
   103|             clientBuilder.proxySelector(proxySelector);
   104|             if (!isNullOrEmpty(httpProxyUri.getUserInfo())) {
   105|                 final List<String> list = Splitter.on(":")
   106|                         .limit(2)
   107|                         .splitToList(httpProxyUri.getUserInfo());
   108|                 if (list.size() == 2) {
   109|                     clientBuilder.proxyAuthenticator(new ProxyAuthenticator(list.get(0), list.get(1)));
   110|                 }


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/shared/bindings/providers/SystemOkHttpClientProvider.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 10-32 ---
    10|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    11|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    12|  * GNU General Public License for more details.
    13|  *
    14|  * You should have received a copy of the GNU General Public License
    15|  * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.
    16|  */
    17| package org.graylog2.shared.bindings.providers;
    18| import com.github.joschi.jadconfig.util.Duration;
    19| import javax.inject.Singleton;
    20| /**
    21|  * Provider for a configured {@link com.squareup.okhttp.OkHttpClient} used for system-level tasks.
    22|  */
    23| @Singleton
    24| public class SystemOkHttpClientProvider extends OkHttpClientProvider {
    25|     public SystemOkHttpClientProvider() {
    26|         super(
    27|                 Duration.seconds(2L),
    28|                 Duration.seconds(5L),
    29|                 Duration.seconds(5L),
    30|                 null);
    31|     }
    32| }


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/shared/events/DeadEventLoggingListener.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 6-30 ---
     6|  * the Free Software Foundation, either version 3 of the License, or
     7|  * (at your option) any later version.
     8|  *
     9|  * Graylog is distributed in the hope that it will be useful,
    10|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    11|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    12|  * GNU General Public License for more details.
    13|  *
    14|  * You should have received a copy of the GNU General Public License
    15|  * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.
    16|  */
    17| package org.graylog2.shared.events;
    18| import com.google.common.eventbus.DeadEvent;
    19| import com.google.common.eventbus.Subscribe;
    20| import org.slf4j.Logger;
    21| import org.slf4j.LoggerFactory;
    22| public class DeadEventLoggingListener {
    23|     private static final Logger LOGGER = LoggerFactory.getLogger(DeadEventLoggingListener.class);
    24|     @Subscribe
    25|     public void handleDeadEvent(DeadEvent event) {
    26|         LOGGER.warn("Received unhandled event of type <{}> from event bus <{}>", event.getEvent().getClass().getCanonicalName(),
    27|                 event.getSource().toString());
    28|         LOGGER.debug("Dead event contents: {}", event.getEvent());
    29|     }
    30| }


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/shared/rest/resources/system/SystemPluginResource.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 2-56 ---
     2|  * This file is part of Graylog.
     3|  *
     4|  * Graylog is free software: you can redistribute it and/or modify
     5|  * it under the terms of the GNU General Public License as published by
     6|  * the Free Software Foundation, either version 3 of the License, or
     7|  * (at your option) any later version.
     8|  *
     9|  * Graylog is distributed in the hope that it will be useful,
    10|  * but WITHOUT ANY WARRANTY; without even the implied warranty of
    11|  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    12|  * GNU General Public License for more details.
    13|  *
    14|  * You should have received a copy of the GNU General Public License
    15|  * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.
    16|  */
    17| package org.graylog2.shared.rest.resources.system;
    18| import com.codahale.metrics.annotation.Timed;
    19| import com.google.common.collect.Lists;
    20| import io.swagger.annotations.Api;
    21| import io.swagger.annotations.ApiOperation;
    22| import org.graylog2.plugin.Capabilities;
    23| import org.graylog2.plugin.PluginMetaData;
    24| import org.graylog2.rest.models.system.plugins.responses.PluginList;
    25| import org.graylog2.rest.models.system.plugins.responses.PluginMetaDataValue;
    26| import org.graylog2.shared.rest.resources.RestResource;
    27| import javax.inject.Inject;
    28| import javax.ws.rs.GET;
    29| import javax.ws.rs.Path;
    30| import javax.ws.rs.Produces;
    31| import javax.ws.rs.core.MediaType;
    32| import java.util.List;
    33| import java.util.Set;
    34| @Api(value = "System/Plugins", description = "Plugin information")
    35| @Path("/system/plugins")
    36| @Produces(MediaType.APPLICATION_JSON)
    37| public class SystemPluginResource extends RestResource {
    38|     private final Set<PluginMetaData> pluginMetaDataSet;
    39|     @Inject
    40|     public SystemPluginResource(Set<PluginMetaData> pluginMetaDataSet) {
    41|         this.pluginMetaDataSet = pluginMetaDataSet;
    42|     }
    43|     @GET
    44|     @Timed
    45|     @ApiOperation(value = "List all installed plugins on this node.")
    46|     public PluginList list() {
    47|         final List<PluginMetaDataValue> pluginMetaDataValues = Lists.newArrayList();
    48|         for (PluginMetaData pluginMetaData : pluginMetaDataSet) {
    49|             pluginMetaDataValues.add(PluginMetaDataValue.create(
    50|                     pluginMetaData.getUniqueId(),
    51|                     pluginMetaData.getName(),
    52|                     pluginMetaData.getAuthor(),
    53|                     pluginMetaData.getURL(),
    54|                     pluginMetaData.getVersion().toString(),
    55|                     pluginMetaData.getDescription(),
    56|                     pluginMetaData.getRequiredVersion().toString(),


# ====================================================================
# FILE: graylog2-server/src/main/java/org/graylog2/shared/security/RestPermissions.java
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 66-105 ---
    66|     public static final String INPUTS_CHANGESTATE = "inputs:changestate";
    67|     public static final String INPUTS_CREATE = "inputs:create";
    68|     public static final String INPUTS_EDIT = "inputs:edit";
    69|     public static final String INPUTS_READ = "inputs:read";
    70|     public static final String INPUTS_TERMINATE = "inputs:terminate";
    71|     public static final String JOURNAL_EDIT = "journal:edit";
    72|     public static final String JOURNAL_READ = "journal:read";
    73|     public static final String JVMSTATS_READ = "jvmstats:read";
    74|     public static final String LBSTATUS_CHANGE = "lbstatus:change";
    75|     public static final String LDAP_EDIT = "ldap:edit";
    76|     public static final String LDAPGROUPS_EDIT = "ldapgroups:edit";
    77|     public static final String LDAPGROUPS_READ = "ldapgroups:read";
    78|     public static final String LOOKUP_TABLES_CREATE = "lookuptables:create";
    79|     public static final String LOOKUP_TABLES_DELETE = "lookuptables:delete";
    80|     public static final String LOOKUP_TABLES_EDIT = "lookuptables:edit";
    81|     public static final String LOOKUP_TABLES_READ = "lookuptables:read";
    82|     public static final String LOGGERS_EDIT = "loggers:edit";
    83|     public static final String LOGGERS_EDITSUBSYSTEM = "loggers:editsubsystem";
    84|     public static final String LOGGERS_READ = "loggers:read";
    85|     public static final String LOGGERS_READSUBSYSTEM = "loggers:readsubsystem";
    86|     public static final String MESSAGECOUNT_READ = "messagecount:read";
    87|     public static final String MESSAGES_ANALYZE = "messages:analyze";
    88|     public static final String MESSAGES_READ = "messages:read";
    89|     public static final String METRICS_ALLKEYS = "metrics:allkeys";
    90|     public static final String METRICS_READ = "metrics:read";
    91|     public static final String METRICS_READALL = "metrics:readall";
    92|     public static final String METRICS_READHISTORY = "metrics:readhistory";
    93|     public static final String NODE_SHUTDOWN = "node:shutdown";
    94|     public static final String NOTIFICATIONS_DELETE = "notifications:delete";
    95|     public static final String NOTIFICATIONS_READ = "notifications:read";
    96|     public static final String OUTPUTS_CREATE = "outputs:create";
    97|     public static final String OUTPUTS_EDIT = "outputs:edit";
    98|     public static final String OUTPUTS_READ = "outputs:read";
    99|     public static final String OUTPUTS_TERMINATE = "outputs:terminate";
   100|     public static final String PROCESSING_CHANGESTATE = "processing:changestate";
   101|     public static final String ROLES_CREATE = "roles:create";
   102|     public static final String ROLES_DELETE = "roles:delete";
   103|     public static final String ROLES_EDIT = "roles:edit";
   104|     public static final String ROLES_READ = "roles:read";
   105|     public static final String SAVEDSEARCHES_CREATE = "savedsearches:create";

# --- HUNK 2: Lines 173-212 ---
   173|         .add(create(INPUTS_CHANGESTATE, ""))
   174|         .add(create(INPUTS_CREATE, ""))
   175|         .add(create(INPUTS_EDIT, ""))
   176|         .add(create(INPUTS_READ, ""))
   177|         .add(create(INPUTS_TERMINATE, ""))
   178|         .add(create(JOURNAL_EDIT, ""))
   179|         .add(create(JOURNAL_READ, ""))
   180|         .add(create(JVMSTATS_READ, ""))
   181|         .add(create(LBSTATUS_CHANGE, ""))
   182|         .add(create(LDAP_EDIT, ""))
   183|         .add(create(LDAPGROUPS_EDIT, ""))
   184|         .add(create(LDAPGROUPS_READ, ""))
   185|         .add(create(LOOKUP_TABLES_CREATE, ""))
   186|         .add(create(LOOKUP_TABLES_DELETE, ""))
   187|         .add(create(LOOKUP_TABLES_EDIT, ""))
   188|         .add(create(LOOKUP_TABLES_READ, ""))
   189|         .add(create(LOGGERS_EDIT, ""))
   190|         .add(create(LOGGERS_EDITSUBSYSTEM, ""))
   191|         .add(create(LOGGERS_READ, ""))
   192|         .add(create(LOGGERS_READSUBSYSTEM, ""))
   193|         .add(create(MESSAGECOUNT_READ, ""))
   194|         .add(create(MESSAGES_ANALYZE, ""))
   195|         .add(create(MESSAGES_READ, ""))
   196|         .add(create(METRICS_ALLKEYS, ""))
   197|         .add(create(METRICS_READ, ""))
   198|         .add(create(METRICS_READALL, ""))
   199|         .add(create(METRICS_READHISTORY, ""))
   200|         .add(create(NODE_SHUTDOWN, ""))
   201|         .add(create(NOTIFICATIONS_DELETE, ""))
   202|         .add(create(NOTIFICATIONS_READ, ""))
   203|         .add(create(OUTPUTS_CREATE, ""))
   204|         .add(create(OUTPUTS_EDIT, ""))
   205|         .add(create(OUTPUTS_READ, ""))
   206|         .add(create(OUTPUTS_TERMINATE, ""))
   207|         .add(create(PROCESSING_CHANGESTATE, ""))
   208|         .add(create(ROLES_CREATE, ""))
   209|         .add(create(ROLES_DELETE, ""))
   210|         .add(create(ROLES_EDIT, ""))
   211|         .add(create(ROLES_READ, ""))
   212|         .add(create(SAVEDSEARCHES_CREATE, ""))


# ====================================================================
# FILE: graylog2-web-interface/src/components/common/Select.jsx
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 77-106 ---
    77|   _formatInputValue(value) {
    78|     const { options, displayKey, valueKey, delimiter } = this.props;
    79|     return value.split(delimiter).map((v) => {
    80|       const predicate = {};
    81|       predicate[valueKey] = v;
    82|       const option = lodash.find(options, predicate);
    83|       predicate[displayKey] = v;
    84|       return option || predicate;
    85|     });
    86|   },
    87|   render() {
    88|     const { allowCreate, size, onReactSelectChange, multi } = this.props;
    89|     const value = this.state.value;
    90|     const reactSelectProps = lodash.pick(this.props, acceptedReactSelectProps);
    91|     const SelectComponent = allowCreate ? ReactSelect.Creatable : ReactSelect;
    92|     let formattedValue = value;
    93|     if (value && multi && allowCreate) {
    94|       formattedValue = this._formatInputValue(value);
    95|     }
    96|     return (
    97|       <div className={size === 'small' ? 'select-sm' : ''}>
    98|         <SelectComponent ref={(c) => { this._select = c; }}
    99|                          onChange={onReactSelectChange || this._onChange}
   100|                          {...reactSelectProps}
   101|                          value={formattedValue} />
   102|       </div>
   103|     );
   104|   },
   105| });
   106| export default Select;


# ====================================================================
# FILE: graylog2-web-interface/src/components/common/TypeAheadInput.jsx
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-77 ---
     1| import PropTypes from 'prop-types';
     2| import React from 'react';
     3| import ReactDOM from 'react-dom';
     4| import { Input } from 'components/bootstrap';
     5| import UniversalSearch from 'logic/search/UniversalSearch';
     6| import $ from 'jquery';
     7| import Typeahead from 'typeahead.js';
     8| const TypeAheadInput = React.createClass({
     9|   propTypes: {
    10|     label: PropTypes.string.isRequired,
    11|     onKeyPress: PropTypes.func,
    12|     displayKey: PropTypes.string,
    13|     suggestions: PropTypes.array, // [ "some string", "otherstring" ]
    14|     suggestionText: PropTypes.string,
    15|     onTypeaheadLoaded: PropTypes.func,
    16|     onSuggestionSelected: PropTypes.func,
    17|   },
    18|   componentDidMount() {
    19|     this._updateTypeahead(this.props);
    20|   },
    21|   componentWillReceiveProps(newProps) {
    22|     this._destroyTypeahead();
    23|     this._updateTypeahead(newProps);
    24|   },
    25|   componentWillUnmount() {
    26|     this._destroyTypeahead();
    27|   },
    28|   getValue() {
    29|     return $(this.fieldInput).typeahead('val');
    30|   },
    31|   clear() {
    32|     $(this.fieldInput).typeahead('val', '');
    33|   },
    34|   _destroyTypeahead() {
    35|     $(this.fieldInput).typeahead('destroy');
    36|     $(this.fieldFormGroup).off('typeahead:select typeahead:autocomplete');
    37|   },
    38|   _updateTypeahead(props) {
    39|     this.fieldInput = this.refs.fieldInput.getInputDOMNode();
    40|     this.fieldFormGroup = ReactDOM.findDOMNode(this.refs.fieldInput);
    41|     const $fieldInput = $(this.fieldInput);
    42|     $fieldInput.typeahead({
    43|       hint: true,
    44|       highlight: true,
    45|       minLength: 1,
    46|     },
    47|       {
    48|         name: 'dataset-name',
    49|         displayKey: props.displayKey,
    50|         source: UniversalSearch.substringMatcher(props.suggestions, props.displayKey, 6),
    51|         templates: {
    52|           suggestion: (value) => {
    53|             if (props.suggestionText) {
    54|               return `<div><strong>${props.suggestionText}</strong> ${value[props.displayKey]}</div>`;
    55|             }
    56|             return `<div>${value.value}</div>`;
    57|           },
    58|         },
    59|       });
    60|     if (typeof props.onTypeaheadLoaded === 'function') {
    61|       props.onTypeaheadLoaded();
    62|       $fieldInput.typeahead('close');
    63|     }
    64|     $(this.fieldFormGroup).on('typeahead:select typeahead:autocomplete', (event, suggestion) => {
    65|       if (props.onSuggestionSelected) {
    66|         props.onSuggestionSelected(event, suggestion);
    67|       }
    68|     });
    69|   },
    70|   render() {
    71|     return (<Input type="text" ref="fieldInput"
    72|                    wrapperClassName="typeahead-wrapper"
    73|                    label={this.props.label}
    74|                    onKeyPress={this.props.onKeyPress} />);
    75|   },
    76| });
    77| export default TypeAheadInput;


# ====================================================================
# FILE: graylog2-web-interface/src/components/search/QueryInput.ts
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 1-66 ---
     1| 'use strict';
     2| const StoreProvider = require('injection/StoreProvider');
     3| const FieldsStore = StoreProvider.getStore('Fields');
     4| import queryParser = require('../../logic/search/queryParser');
     5| import SerializeVisitor = require('../../logic/search/visitors/SerializeVisitor');
     6| import DumpVisitor = require('../../logic/search/visitors/DumpVisitor');
     7| const $ = require('jquery');
     8| const Typeahead = require('typeahead.js');
     9| interface Match {
    10|     match: string;
    11|     currentSegment: string;
    12|     prefix: string;
    13|     value: string;
    14| }
    15| interface SplitQuery {
    16|     current: string;
    17|     prefix: string;
    18| }
    19| class QueryInput {
    20|     private typeAheadConfig: any;
    21|     private typeAheadSource: any;
    22|     private fields: string[];
    23|     private fieldsPromise: Promise<string[]>;
    24|     private limit: number;
    25|     private displayKey: string;
    26|     constructor(private queryInputContainer: Element) {
    27|         this.fieldsPromise = FieldsStore.loadFields();
    28|         this.limit = 10;
    29|         this.displayKey = 'value';
    30|         this.typeAheadConfig = {
    31|             hint: true,
    32|             highlight: true,
    33|             minLength: 1
    34|         };
    35|         this.typeAheadSource = {
    36|             name: 'fields',
    37|             displayKey: this.displayKey,
    38|             source: this.codeCompletionProvider.bind(this),
    39|             templates: {
    40|                 suggestion: (match: Match) => {
    41|                     var previousTerms = match.prefix;
    42|                     var matchPrefix = match.match.substring(0, match.match.indexOf(match.currentSegment));
    43|                     var currentMatch = match.currentSegment;
    44|                     var matchSuffix = match.match.substring(match.match.indexOf(match.currentSegment) + match.currentSegment.length);
    45|                     return '<p><strong>' + previousTerms + '</strong>' + matchPrefix + '<strong>' + currentMatch + '</strong>' + matchSuffix + '</p>';
    46|                 }
    47|             }
    48|         };
    49|     }
    50|     display() {
    51|         this.fieldsPromise.then((fields) => {
    52|             this.fields = fields;
    53|             $(this.queryInputContainer).typeahead(this.typeAheadConfig, this.typeAheadSource);
    54|         });
    55|     }
    56|     _value() {
    57|         return $(this.queryInputContainer).typeahead('val');
    58|     }
    59|     update(newValue) {
    60|         if (this._value() !== newValue) {
    61|             $(this.queryInputContainer).typeahead('val', newValue);
    62|         }
    63|     }
    64|     private codeCompletionProvider(query: string, callback: (matches: Array<any>) => void) {
    65|         var prefix = "";
    66|         var matches: Array<any> = [];

