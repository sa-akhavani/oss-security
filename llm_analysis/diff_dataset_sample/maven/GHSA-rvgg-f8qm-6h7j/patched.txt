# ====================================================================
# FILE: vertx-web-api-contract/src/main/java/io/vertx/ext/web/api/contract/openapi3/impl/OpenAPI3PathResolver.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 61-179 ---
    61|             | matrix | false   | ;color | ;color=blue | ;color=blue,black,brown             | ;color=R,100,G,200,B,150 |
    62|             +--------+---------+--------+-------------+-------------------------------------+--------------------------+
    63|             | matrix | true    | ;color | ;color=blue | ;color=blue;color=black;color=brown | ;R=100;G=200;B=150       |
    64|             +--------+---------+--------+-------------+-------------------------------------+--------------------------+
    65|             | label  | false   | .      | .blue       | .blue.black.brown                   | .R.100.G.200.B.150       |
    66|             +--------+---------+--------+-------------+-------------------------------------+--------------------------+
    67|             | label  | true    | .      | .blue       | .blue.black.brown                   | .R=100.G=200.B=150       |
    68|             +--------+---------+--------+-------------+-------------------------------------+--------------------------+
    69|             | simple | false   | n/a    | blue        | blue,black,brown                    | R,100,G,200,B,150        |
    70|             +--------+---------+--------+-------------+-------------------------------------+--------------------------+
    71|             | simple | true    | n/a    | blue        | blue,black,brown                    | R=100,G=200,B=150        |
    72|             +--------+---------+--------+-------------+-------------------------------------+--------------------------+
    73|             RFC 3986 section 2.2 Reserved Characters (January 2005)
    74|             !	*	'	(	)	;	:	@	&	=	+	$	,	/	?	#	[	]
    75|            */
    76|           if (style.equals("simple")) {
    77|             regex.append(
    78|               RegexBuilder.create().namedGroup(
    79|                 groupName,
    80|                 RegexBuilder.create().notCharactersClass(
    81|                   "!",	"*",	"'", "(",	")",	";",	"@",	"&",	"+",	"$",	"/",	"?",	"#",	"[",	"]", (shouldThreatDotAsReserved) ? "." : null
    82|                 ).zeroOrMore()
    83|               ).zeroOrOne()
    84|             );
    85|             mappedGroups.put(groupName, paramName);
    86|           } else if (style.equals("label")) {
    87|             if (isObject && explode) {
    88|               Map<String, OpenApi3Utils.ObjectField> properties = OpenApi3Utils.solveObjectParameters(parameter.getSchema());
    89|               for (Map.Entry<String, OpenApi3Utils.ObjectField> entry : properties.entrySet()) {
    90|                 groupName = "p" + i;
    91|                 regex.append(
    92|                   RegexBuilder.create().optionalGroup(
    93|                     RegexBuilder.create()
    94|                       .escapeCharacter(".").zeroOrOne().quote(entry.getKey()).append("=")
    95|                       .namedGroup(groupName,
    96|                         RegexBuilder.create().notCharactersClass(
    97|                           "!",	"*",	"'", "(",	")",	";",	"@",	"&",	"+",	"$",	"/",	"?",	"#",	"[",	"]", ".", "="
    98|                         ).zeroOrMore()
    99|                       )
   100|                   )
   101|                 );
   102|                 mappedGroups.put(groupName, entry.getKey());
   103|                 i++;
   104|               }
   105|             } else {
   106|               regex.append(
   107|                 RegexBuilder.create()
   108|                   .escapeCharacter(".").zeroOrOne()
   109|                   .namedGroup(groupName,
   110|                     RegexBuilder.create().notCharactersClass(
   111|                       "!",	"*",	"'",	"(",	")",	";",	"@",	"&",	"=",	"+",	"$",	",",	"/",	"?",	"#",	"[",	"]"
   112|                     ).zeroOrMore()
   113|                   ).zeroOrOne()
   114|               );
   115|               mappedGroups.put(groupName, paramName);
   116|             }
   117|           } else if (style.equals("matrix")) {
   118|             if (isObject && explode) {
   119|               Map<String, OpenApi3Utils.ObjectField> properties = OpenApi3Utils.solveObjectParameters(parameter.getSchema());
   120|               for (Map.Entry<String, OpenApi3Utils.ObjectField> entry : properties.entrySet()) {
   121|                 groupName = "p" + i;
   122|                 regex.append(
   123|                   RegexBuilder.create().optionalGroup(
   124|                     RegexBuilder.create()
   125|                       .escapeCharacter(";").quote(entry.getKey()).append("=")
   126|                       .namedGroup(groupName,
   127|                         RegexBuilder.create().notCharactersClass(
   128|                           "!",	"*",	"'",	"(",	")",	";",	"@",	"&",	"=",	"+",	"$",	",",	"/",	"?",	"#",	"[",	"]",
   129|                           (shouldThreatDotAsReserved) ? "." : null
   130|                         ).zeroOrMore()
   131|                       )
   132|                   )
   133|                 );
   134|                 mappedGroups.put(groupName, entry.getKey());
   135|                 i++;
   136|               }
   137|             } else if (isArray && explode) {
   138|               regex.append(
   139|                 RegexBuilder.create().namedGroup(
   140|                   groupName,
   141|                   RegexBuilder.create().atomicGroup(
   142|                     RegexBuilder.create()
   143|                       .append(";").quote(paramName).append("=")
   144|                       .notCharactersClass(
   145|                         "!",	"*",	"'",	"(",	")",	";",	"@",	"&",	"=",	"+",	"$",	",",	"/",	"?",	"#",	"[",	"]",
   146|                         (shouldThreatDotAsReserved) ? "." : null
   147|                     ).zeroOrMore()
   148|                   ).oneOrMore()
   149|                 )
   150|               );
   151|               mappedGroups.put(groupName, paramName);
   152|             } else {
   153|               regex.append(
   154|                 RegexBuilder.create()
   155|                   .append(";").quote(paramName).append("=")
   156|                   .namedGroup(
   157|                     groupName,
   158|                     RegexBuilder.create().notCharactersClass(
   159|                       "!",	"*",	"'",	"(",	")",	";",	"@",	"&",	"=",	"+",	"$",	"/",	"?",	"#",	"[",	"]",
   160|                       (shouldThreatDotAsReserved) ? "." : null
   161|                     ).zeroOrMore()
   162|                   ).zeroOrOne()
   163|               );
   164|               mappedGroups.put(groupName, paramName);
   165|             }
   166|           }
   167|         } else {
   168|           throw RouterFactoryException.createSpecInvalidException("Missing parameter description for parameter name: " + paramName);
   169|         }
   170|         i++;
   171|       }
   172|       String toAppendQuoted = oasPath.substring(lastMatchEnd, (endSlash) ? oasPath.length() - 1 : oasPath.length());
   173|       if (toAppendQuoted.length() != 0)
   174|         regex.append(Pattern.quote(toAppendQuoted));
   175|       if (endSlash)
   176|         regex.append("\\/");
   177|       return Optional.of(Pattern.compile(regex.toString()));
   178|     } else {
   179|       return Optional.empty();


# ====================================================================
# FILE: vertx-web-api-contract/src/main/java/io/vertx/ext/web/api/contract/openapi3/impl/OpenAPI3RouterFactoryImpl.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 160-207 ---
   160|   public OpenAPI3RouterFactory addFailureHandler(HttpMethod method, String path, Handler failureHandler) {
   161|     addFailureHandlerByOperationId(resolveOperationId(method, path), failureHandler);
   162|     return this;
   163|   }
   164|   @Override
   165|   public Router getRouter() {
   166|     Router router = Router.router(vertx);
   167|     Route globalRoute = router.route();
   168|     globalRoute.handler(options.getBodyHandler());
   169|     List<Handler<RoutingContext>> globalHandlers = this.getOptions().getGlobalHandlers();
   170|     for (Handler<RoutingContext> globalHandler: globalHandlers) {
   171|       globalRoute.handler(globalHandler);
   172|     }
   173|     List<Handler<RoutingContext>> globalSecurityHandlers = securityHandlers
   174|       .solveSecurityHandlers(spec.getSecurity(), this.getOptions().isRequireSecurityHandlers());
   175|     for (OperationValue operation : operations.values()) {
   176|       if (!options.isMountNotImplementedHandler() && !operation.isConfigured())
   177|         continue;
   178|       List<Handler> handlersToLoad = new ArrayList<>();
   179|       List<Handler> failureHandlersToLoad = new ArrayList<>();
   180|       if (operation.getOperationModel().getSecurity() != null) {
   181|         handlersToLoad.addAll(securityHandlers.solveSecurityHandlers(
   182|           operation.getOperationModel().getSecurity(),
   183|           this.getOptions().isRequireSecurityHandlers()
   184|         ));
   185|       } else {
   186|         handlersToLoad.addAll(globalSecurityHandlers);
   187|       }
   188|       Handler<RoutingContext> validationHandler = new OpenAPI3RequestValidationHandlerImpl(operation
   189|         .getOperationModel(), operation.getParameters(), this.spec, refsCache);
   190|       handlersToLoad.add(validationHandler);
   191|       if (this.options.isMountValidationFailureHandler()) failureHandlersToLoad.add(this.options.getValidationFailureHandler());
   192|       if (operation.isConfigured()) {
   193|         handlersToLoad.addAll(operation.getUserHandlers());
   194|         failureHandlersToLoad.addAll(operation.getUserFailureHandlers());
   195|       } else {
   196|         handlersToLoad.add(this.options.getNotImplementedFailureHandler());
   197|       }
   198|       OpenAPI3PathResolver pathResolver = new OpenAPI3PathResolver(operation.getPath(), operation.getParameters());
   199|       Route route = pathResolver
   200|         .solve() // If this optional is empty, this route doesn't need regex
   201|         .map(solvedRegex -> router.routeWithRegex(operation.getMethod(), solvedRegex.toString()))
   202|         .orElseGet(() -> router.route(operation.getMethod(), operation.getPath()));
   203|       Set<String> consumes = new HashSet<>();
   204|       Set<String> produces = new HashSet<>();
   205|       if (operation.getOperationModel().getRequestBody() != null &&
   206|         operation.getOperationModel().getRequestBody().getContent() != null)
   207|         consumes.addAll(operation.getOperationModel().getRequestBody().getContent().keySet());


# ====================================================================
# FILE: vertx-web-api-contract/src/main/java/io/vertx/ext/web/api/validation/impl/RegularExpressions.java
# Total hunks: 1
# ====================================================================
# --- HUNK 1: Lines 1-31 ---
     1| package io.vertx.ext.web.api.validation.impl;
     2| /**
     3|  * @author Francesco Guardiani @slinkydeveloper
     4|  */
     5| public class RegularExpressions {
     6|   public static final String EMAIL = "^(?:[\\w!#\\$%&'\\*\\+\\-/=\\?\\^`\\{\\|\\}~]+\\.)" +
     7|     "*[\\w!#\\$%&'\\*\\+\\-/=\\?\\^`\\{\\|\\}~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\\-](?!\\.)){0,61}[a-zA-Z0-9]?\\.)"
     8|     + "+[a-zA-Z0-9](?:[a-zA-Z0-9\\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\\[(?:(?:[01]?\\d{1,2}|2[0-4]\\d|25[0-5])\\.){3}" +
     9|     "(?:[01]?\\d{1,2}|2[0-4]\\d|25[0-5])\\]))$";
    10|   public static final String URI = "^[a-zA-Z][a-zA-Z0-9+-.]*:[^\\s]*$";
    11|   public static final String DATE = "^\\d{4}-(?:0[0-9]|1[0-2])-[0-9]{2}$";
    12|   public static final String DATETIME = "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])T([01]\\d|2[0-3]):([0-5]\\d):([0-5]\\d|60)(\\.\\d+)?(Z|(\\+|-)([01]\\d|2[0-3]):([0-5]\\d))$";
    13|   public static final String TIME = "^\\d{2}:\\d{2}:\\d{2}$";
    14|   public static final String BASE64 = "^([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{4}|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)$";
    15|   public static final String IPV4 = "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}" + "" +
    16|     "(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$";
    17|   public static final String IPV6 = "^\\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}" + "" +
    18|     "(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(" +
    19|     "([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\." + "" +
    20|     "(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|(" + "" +
    21|     "(:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|" +
    22|     "(" + "([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:(" + "" +
    23|     "(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:)" +
    24|     "{2}" + "(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\." + "" +
    25|     "(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|(" + "" +
    26|     "(:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))"
    27|     + "|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\." + "" +
    28|     "(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:)))(%.+)?\\s*$";
    29|   public static final String HOSTNAME = "^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\\-]*[a-zA-Z0-9])\\.)*" + "" +
    30|     "([A-Za-z]|[A-Za-z][A-Za-z0-9\\-]*[A-Za-z0-9])$";
    31| }


# ====================================================================
# FILE: vertx-web/src/main/java/io/vertx/ext/web/handler/impl/CSRFHandlerImpl.java
# Total hunks: 2
# ====================================================================
# --- HUNK 1: Lines 70-111 ---
    70|     this.timeout = timeout;
    71|     return this;
    72|   }
    73|   @Override
    74|   public CSRFHandler setNagHttps(boolean nag) {
    75|     this.nagHttps = nag;
    76|     return this;
    77|   }
    78|   @Override
    79|   public CSRFHandler setResponseBody(String responseBody) {
    80|     this.responseBody = responseBody;
    81|     return this;
    82|   }
    83|   private String generateToken() {
    84|     byte[] salt = new byte[32];
    85|     RAND.nextBytes(salt);
    86|     String saltPlusToken = BASE64.encodeToString(salt) + "." + Long.toString(System.currentTimeMillis());
    87|     String signature = BASE64.encodeToString(mac.doFinal(saltPlusToken.getBytes()));
    88|     return saltPlusToken + "." + signature;
    89|   }
    90|   private boolean validateToken(String header, Cookie cookie) {
    91|     if (header == null || cookie == null || !header.equals(cookie.getValue())) {
    92|       return false;
    93|     }
    94|     String[] tokens = header.split("\\.");
    95|     if (tokens.length != 3) {
    96|       return false;
    97|     }
    98|     String saltPlusToken = tokens[0] + "." + tokens[1];
    99|     String signature = BASE64.encodeToString(mac.doFinal(saltPlusToken.getBytes()));
   100|     if(!signature.equals(tokens[2])) {
   101|       return false;
   102|     }
   103|     try {
   104|       return !(System.currentTimeMillis() > Long.parseLong(tokens[1]) + timeout);
   105|     } catch (NumberFormatException e) {
   106|       return false;
   107|     }
   108|   }
   109|   protected void forbidden(RoutingContext ctx) {
   110|     final int statusCode = 403;
   111|     if (responseBody != null) {

# --- HUNK 2: Lines 120-152 ---
   120|   public void handle(RoutingContext ctx) {
   121|     if (nagHttps) {
   122|       String uri = ctx.request().absoluteURI();
   123|       if (uri != null && !uri.startsWith("https:")) {
   124|         log.warn("Using session cookies without https could make you susceptible to session hijacking: " + uri);
   125|       }
   126|     }
   127|     HttpMethod method = ctx.request().method();
   128|     switch (method) {
   129|       case GET:
   130|         final String token = generateToken();
   131|         ctx.put(headerName, token);
   132|         ctx.addCookie(Cookie.cookie(cookieName, token).setPath(cookiePath));
   133|         ctx.next();
   134|         break;
   135|       case POST:
   136|       case PUT:
   137|       case DELETE:
   138|       case PATCH:
   139|         final String header = ctx.request().getHeader(headerName);
   140|         final Cookie cookie = ctx.getCookie(cookieName);
   141|         if (validateToken(header == null ? ctx.request().getFormAttribute(headerName) : header, cookie)) {
   142|           ctx.next();
   143|         } else {
   144|           forbidden(ctx);
   145|         }
   146|         break;
   147|       default:
   148|         ctx.next();
   149|         break;
   150|     }
   151|   }
   152| }

